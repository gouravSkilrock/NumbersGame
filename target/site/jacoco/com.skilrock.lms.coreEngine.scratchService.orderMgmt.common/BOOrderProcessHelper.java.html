<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BOOrderProcessHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lms</a> &gt; <a href="index.source.html" class="el_package">com.skilrock.lms.coreEngine.scratchService.orderMgmt.common</a> &gt; <span class="el_source">BOOrderProcessHelper.java</span></div><h1>BOOrderProcessHelper.java</h1><pre class="source lang-java linenums">/*
 * ï¿½ copyright 2007, SkilRock Technologies, A division of Sugal &amp; Damani Lottery Agency Pvt. Ltd.
 * All Rights Reserved
 * The contents of this file are the property of Sugal &amp; Damani Lottery Agency Pvt. Ltd.
 * and are subject to a License agreement with Sugal &amp; Damani Lottery Agency Pvt. Ltd.; you may
 * not use this file except in compliance with that License.  You may obtain a
 * copy of that license from:
 * Legal Department
 * Sugal &amp; Damani Lottery Agency Pvt. Ltd.
 * 6/35,WEA, Karol Bagh,
 * New Delhi
 * India - 110005
 * This software is distributed under the License and is provided on an ï¿½AS ISï¿½
 * basis, without warranty of any kind, either express or implied, unless
 * otherwise provided in the License.  See the License for governing rights and
 * limitations under the License.
 */

package com.skilrock.lms.coreEngine.scratchService.orderMgmt.common;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.text.DateFormat;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Set;

import com.skilrock.lms.GameContants;
import com.skilrock.lms.beans.BookBean;
import com.skilrock.lms.beans.GameBean;
import com.skilrock.lms.beans.InvOrderBean;
import com.skilrock.lms.beans.OrderBean;
import com.skilrock.lms.beans.OrderedGameBean;
import com.skilrock.lms.beans.OrgAddressBean;
import com.skilrock.lms.beans.OrgBean;
import com.skilrock.lms.beans.PackBean;
import com.skilrock.lms.beans.UserInfoBean;
import com.skilrock.lms.common.db.DBConnect;
import com.skilrock.lms.common.db.QueryManager;
import com.skilrock.lms.common.db.TableConstants;
import com.skilrock.lms.common.exception.LMSException;
import com.skilrock.lms.common.utility.CommonMethods;
import com.skilrock.lms.common.utility.GenerateRecieptNo;
import com.skilrock.lms.scratchService.dataMgmt.daoImpl.ScratchGameDataDaoImpl;
import com.skilrock.lms.web.drawGames.common.Util;

/**
 * This is a helper class providing methods for creating BO initiated orders
 * 
 * @author Skilrock Technologies
 * 
 */
<span class="nc" id="L61">public class BOOrderProcessHelper {</span>

	// INVENTORY ORDER PROCESS HELPER OF LMS15MAY
	private int gameID;

	private int totalOrderedBooks;

	/*
	 * public int getRetailerOrgId(List&lt;OrgBean&gt; retOrgList, String retOrgName) {
	 * 
	 * 
	 * if(retOrgList != null){ OrgBean bean = null; for(int i=0; i&lt;retOrgList.size();
	 * i++ ){ bean = retOrgList.get(i);
	 * if(&quot;retOrgName&quot;.equals(bean.getOrgName())){ return bean.getOrgId(); } } }
	 * return -1; }
	 */

	/**
	 * This method is used for dispatching the agent order
	 * 
	 * @param invOrderList
	 * @param orderId
	 * @param agentOrgId
	 * @param rootPath
	 * @throws LMSException
	 */
	/*public void dispatchOrder(List&lt;InvOrderBean&gt; invOrderList, int total,
			int orderId, String boOrgName, int userOrgID, int agentOrgId,
			String rootPath, HttpSession session, int userId)
			throws LMSException {
		System.out.println(&quot;Start to Dispach&quot;);
		InvOrderBean invOrderBean = null;
		OrderedGameBean gameBean = null;

		if (invOrderList != null) {

			Connection connection = null;
			PreparedStatement boMasterStmt = null;
			PreparedStatement LMSMasterStmt = null;
			PreparedStatement boAgentStmt = null;
			PreparedStatement boOrdGameStmt = null;
			PreparedStatement boReceiptStmt = null;
			PreparedStatement boReceiptNoGenStmt = null;

			PreparedStatement boReceiptMappingStmt = null;
			PreparedStatement boOrderStmt = null;

			PreparedStatement boReceiptGenMappingStmt = null;
			PreparedStatement boInvoiceDCMappingStmt = null;

			PreparedStatement gameInvStatusStmt = null;
			PreparedStatement gameInvDetailStmt = null;
			PreparedStatement orderInvoicesPrtSt = null;
			Statement totalDispatch = null;
			ResultSet totalDispatchResult = null;

			ResultSet rsMaster = null;

			String boMasterQuery = null;
			String LMSMasterQuery = null;
			String boAgentQuery = null;
			String boOrdGamesQuery = null;
			String boReceiptQuery = null;
			String boReceiptMappingQuery = null;
			String boOrderQuery = null;
			String gameInvStatusQuery = null;
			String invQuery = null;
			String orderInvoicesQuery = null;

			String gameInvDetailQuery = null;
			String bookQuery = null;

			// added by yogehs to inser vat details into game master
			String gameMasterQuery = null;
			PreparedStatement gameMasterStmt = null;

			// String countDispatchedTotal = &quot;select nbr_of_books_dlvrd from
			// st_se_bo_ordered_games where order_id=&quot;+orderId;
			String countDispatchedTotal = QueryManager
					.getST5ToatlDispatchQuery()
					+ orderId;
			List&lt;Integer&gt; trnIdList = new ArrayList&lt;Integer&gt;();
			int masterTrnId = -1;
			int totalDispatchedForOrder = 0;

			try {

				 
				connection = DBConnect.getConnection();
				connection.setAutoCommit(false);

				totalDispatch = connection.createStatement();

				totalDispatchResult = totalDispatch
						.executeQuery(countDispatchedTotal);
				*//**
				 * ///Checking that wheather total books have been dispatched or
				 * not .On the basis of that Order would be Processed or
				 * SemiProcessed
				 *//*

				while (totalDispatchResult.next()) {
					totalDispatchedForOrder = totalDispatchedForOrder
							+ totalDispatchResult.getInt(&quot;nbr_of_books_dlvrd&quot;);
					if (totalDispatchedForOrder == total) {
						break;

					}
				}
				System.out.println(&quot;--------totalDispatchedForOrder&quot;
						+ totalDispatchedForOrder + &quot;-------&quot;);

				boMasterQuery = QueryManager.insertInBOTransactionMaster();
				boMasterStmt = connection.prepareStatement(boMasterQuery);

				LMSMasterQuery = QueryManager.insertInLMSTransactionMaster();
				LMSMasterStmt = connection.prepareStatement(LMSMasterQuery);

				boAgentQuery = QueryManager.getST1BOAgentQuery();
				boAgentStmt = connection.prepareStatement(boAgentQuery);

				boOrdGamesQuery = QueryManager.getST1BOOrdGamesUpdQuery();
				boOrdGameStmt = connection.prepareStatement(boOrdGamesQuery);

				java.sql.Timestamp currentDate = new java.sql.Timestamp(
						new Date().getTime());

				// boReceiptQuery = QueryManager.getST1BOReceiptsQuery();
				// boReceiptStmt = connection.prepareStatement(boReceiptQuery);

				boReceiptMappingQuery = QueryManager
						.insertBOReceiptTrnMapping();
				boReceiptMappingStmt = connection
						.prepareStatement(boReceiptMappingQuery);

				boOrderQuery = QueryManager.getST1BOOrdUpdQuery();
				boOrderStmt = connection.prepareStatement(boOrderQuery);

				gameInvStatusQuery = QueryManager
						.getST1BOUpdGameInvStatusQuery();

				gameInvDetailQuery = QueryManager.getST1InvDetailInsertQuery();
				gameInvDetailStmt = connection
						.prepareStatement(gameInvDetailQuery);

				orderInvoicesQuery = QueryManager.getST1OrderInInsertQuery();
				orderInvoicesPrtSt = connection
						.prepareStatement(orderInvoicesQuery);

				gameMasterQuery = QueryManager.insertVatDetailsintoGameMaster();
				gameMasterStmt = connection.prepareStatement(gameMasterQuery);

				String detHistoryInsQuery = &quot;insert into st_se_game_ticket_inv_history(game_id, book_nbr, &quot;
						+ &quot; current_owner, current_owner_id, date, done_by_oid, done_by_uid, cur_rem_tickets, &quot;
						+ &quot; active_tickets_upto, sold_tickets, status) values (?,?,?,?,?,?,?,?,?,?,?)&quot;;
				PreparedStatement detHistoryInsPstmt = connection
						.prepareStatement(detHistoryInsQuery);

				double mrpAmt = 0.0;
				double commAmt = 0.0;
				double netAmt = 0.0;
				double creditAmt = 0.0;
				double vatAmt = 0.0;
				double taxableSale = 0.0;
				double agtSaleCommRate = 0.0;
				int nbrOfbooksApp = 0;
				int nbrBooksalreadyDispatched = 0;
				int nbrOfBooksDispatched = 0;
				int totalDispatched = 0;

				double govtComm = 0.0;

				int gameId = -1;
				List&lt;PackBean&gt; packList = null;
				List&lt;BookBean&gt; bookList = null;
				PackBean packBean = null;
				BookBean bookBean = null;

				// get auto generated treciept number
				// String getLatestRecieptNumber=&quot;SELECT * from
				// st_bo_receipt_gen_mapping where receipt_type=? ORDER BY
				// generated_id DESC LIMIT 1 &quot;;
				boReceiptNoGenStmt = connection.prepareStatement(QueryManager
						.getBOLatestReceiptNb());
				boReceiptNoGenStmt.setString(1, &quot;INVOICE&quot;);
				ResultSet recieptRs = boReceiptNoGenStmt.executeQuery();
				String lastRecieptNoGenerated = null;

				while (recieptRs.next()) {
					lastRecieptNoGenerated = recieptRs
							.getString(&quot;generated_id&quot;);
				}

				String autoGeneRecieptNo = null;
				autoGeneRecieptNo = GenerateRecieptNo.getRecieptNo(&quot;INVOICE&quot;,
						lastRecieptNoGenerated, &quot;BO&quot;);

				// get auto generated delivery Challan number
				// String getLatestDCNumber=&quot;SELECT * from
				// st_bo_receipt_gen_mapping where receipt_type=? ORDER BY
				// generated_id DESC LIMIT 1 &quot;;
				boReceiptNoGenStmt = connection.prepareStatement(QueryManager
						.getBOLatestReceiptNb());
				boReceiptNoGenStmt.setString(1, &quot;DLCHALLAN&quot;);
				ResultSet DCRs = boReceiptNoGenStmt.executeQuery();
				String lastDCNoGenerated = null;

				while (DCRs.next()) {
					lastDCNoGenerated = DCRs.getString(&quot;generated_id&quot;);
				}

				String autoGeneDCNo = null;
				autoGeneDCNo = GenerateRecieptNo.getRecieptNo(&quot;DLCHALLAN&quot;,
						lastDCNoGenerated, &quot;BO&quot;);
				System.out.println(&quot;lastDCNoGenerated &quot; + lastDCNoGenerated
						+ &quot;autoGeneDCNo &quot; + autoGeneDCNo);

				// insert in receipt transaction master for invoice
				boReceiptStmt = connection.prepareStatement(QueryManager
						.insertInReceiptMaster());
				boReceiptStmt.setString(1, &quot;BO&quot;);
				boReceiptStmt.executeUpdate();

				ResultSet rs = boReceiptStmt.getGeneratedKeys();
				int invoiceId = -1;
				while (rs.next()) {
					invoiceId = rs.getInt(1);
				}

				// insert in bo receipts

				boReceiptStmt = connection.prepareStatement(QueryManager
						.insertInBOReceipts());

				boReceiptStmt.setInt(1, invoiceId);
				boReceiptStmt.setString(2, &quot;INVOICE&quot;);
				boReceiptStmt.setInt(3, agentOrgId);
				boReceiptStmt.setString(4, &quot;AGENT&quot;);
				boReceiptStmt.setString(5, autoGeneRecieptNo);
				boReceiptStmt.setTimestamp(6, Util.getCurrentTimeStamp());
				// System.out.println(&quot;hhhhhhhhhhhhhhhhhhhhhhhhhhh : &quot; +
				// boReceiptStmt );
				// boReceiptStmt.setString(1,autoGeneRecieptNo);
				
				 * boReceiptStmt.setString(1,&quot;INVOICE&quot;);
				 * boReceiptStmt.setInt(2,agentOrgId);
				 

				boReceiptStmt.execute();

				// insert in receipt transaction master for delivery challan
				boReceiptStmt = connection.prepareStatement(QueryManager
						.insertInReceiptMaster());
				boReceiptStmt.setString(1, &quot;BO&quot;);
				boReceiptStmt.executeUpdate();

				ResultSet rsDC = boReceiptStmt.getGeneratedKeys();
				int DCId = -1;
				while (rsDC.next()) {
					DCId = rsDC.getInt(1);
				}

				// insert bo reciept id for delivery challan

				boReceiptStmt = connection.prepareStatement(QueryManager
						.insertInBOReceipts());

				boReceiptStmt.setInt(1, DCId);
				boReceiptStmt.setString(2, &quot;DLCHALLAN&quot;);
				boReceiptStmt.setInt(3, agentOrgId);
				boReceiptStmt.setString(4, &quot;AGENT&quot;);
				boReceiptStmt.setString(5, autoGeneDCNo);
				boReceiptStmt.setTimestamp(6, Util.getCurrentTimeStamp());

				
				 * boReceiptStmt.setString(1,&quot;DLCHALLAN&quot;);
				 * boReceiptStmt.setInt(2,agentOrgId);
				 

				boReceiptStmt.execute();

				for (int i = 0; i &lt; invOrderList.size(); i++) {

					invOrderBean = invOrderList.get(i);

					gameBean = invOrderBean.getOrderedGameBean();
					gameId = gameBean.getGameId();
					nbrOfbooksApp = gameBean.getNbrOfBooksApp();
					nbrBooksalreadyDispatched = gameBean.getNbrOfBooksDlvrd();

					int nbrOfBooksPerPack = gameBean.getNbrOfBooksPerPack();

					nbrOfBooksDispatched = nbrBooksalreadyDispatched
							+ getDispatchedNbrOfBooks(invOrderBean,
									nbrOfBooksPerPack);
					totalDispatchedForOrder = totalDispatchedForOrder
							+ getDispatchedNbrOfBooks(invOrderBean,
									nbrOfBooksPerPack);
					int currentlyDispatched = getDispatchedNbrOfBooks(
							invOrderBean, nbrOfBooksPerPack);
					if (currentlyDispatched &gt; 0) {
						// totalDispatched=nbrBooksalreadyDispatched+nbrOfBooksDispatched+totalDispatchedForOrder;

						// fetch game details from game master
						String fetchGameDetQuery = &quot;select nbr_of_tickets_per_book from st_se_game_master where game_id =&quot;
								+ gameId;
						Statement fetchGameDetStmt = connection
								.createStatement();
						ResultSet fetchGameDetRs = fetchGameDetStmt
								.executeQuery(fetchGameDetQuery);
						int noOfTktPerBooks = -1;
						if (fetchGameDetRs.next()) {
							noOfTktPerBooks = fetchGameDetRs
									.getInt(&quot;nbr_of_tickets_per_book&quot;);
						}

						// insert in LMS transaction master
						LMSMasterStmt.setString(1, &quot;BO&quot;);
						LMSMasterStmt.executeUpdate();
						rsMaster = null;
						rsMaster = LMSMasterStmt.getGeneratedKeys();

						while (rsMaster.next()) {
							masterTrnId = rsMaster.getInt(1);
							trnIdList.add(masterTrnId);
						}

						// insert in bo transaction master

						boMasterStmt.setInt(1, masterTrnId);
						boMasterStmt.setInt(2, userId);
						boMasterStmt.setInt(3, userOrgID);
						boMasterStmt.setString(4, &quot;AGENT&quot;);
						boMasterStmt.setInt(5, agentOrgId);
						boMasterStmt.setTimestamp(6, currentDate);
						boMasterStmt.setString(7, &quot;SALE&quot;);

						
						 * boMasterStmt.setString(1,&quot;AGENT&quot;);
						 * boMasterStmt.setInt(2,agentOrgId);
						 * boMasterStmt.setTimestamp(3,currentDate);
						 * boMasterStmt.setString(4,&quot;SALE&quot;);
						 

						boMasterStmt.execute();

						boAgentStmt.setInt(1, masterTrnId);
						boAgentStmt.setInt(2, currentlyDispatched);
						boAgentStmt.setInt(3, gameId);
						boAgentStmt.setInt(4, agentOrgId);

						mrpAmt = currentlyDispatched * gameBean.getBookPrice();
						boAgentStmt.setDouble(5, mrpAmt);

						govtComm = mrpAmt * gameBean.getGovtComm() * .01;

						agtSaleCommRate = gameBean.getAgtSaleCommRate()
								+ gameBean.getAgtGameCommVariance();
						commAmt = mrpAmt * agtSaleCommRate * 0.01;
						boAgentStmt.setDouble(6, commAmt);

						netAmt = mrpAmt - commAmt;
						creditAmt += netAmt;

						// added by yogesh to calculate vat amount
						vatAmt = CommonMethods.calculateVat(mrpAmt,
								agtSaleCommRate,
								gameBean.getPrizePayOutRatio(), gameBean
										.getGovtComm(), gameBean.getVat(),
								gameBean.getGovtCommRule(), gameBean
										.getFixedAmt(), gameBean
										.getTicketsInScheme());
						
						 * double
						 * deducted_sale=(100-(gameBean.getAgtSaleCommRate() +
						 * gameBean.getPrizePayOutRatio()
						 * +gameBean.getGovtComm())); double
						 * vat_plus_taxablesale = (mrpAmt*deducted_sale)/100;
						 * double
						 * new_taxable_sale=(vat_plus_taxablesale*100)/(100+gameBean.getVat());
						 * double
						 * new_vat=(vat_plus_taxablesale*gameBean.getVat())/(100+gameBean.getVat());
						 
						System.out.println(&quot;mrp :: &quot; + mrpAmt + &quot;ppr :: &quot;
								+ gameBean.getPrizePayOutRatio()
								+ &quot;gov comm ::&quot; + gameBean.getGovtComm()
								+ &quot;agt net comm :: &quot; + agtSaleCommRate);

						// vatAmt=(mrpAmt-(mrpAmt
						// *((gameBean.getAgtSaleCommRate() +
						// gameBean.getPrizePayOutRatio()
						// +gameBean.getGovtComm())/100))) * ((gameBean.getVat()
						// * 0.01)/(1+(gameBean.getVat() * 0.01)));
						// taxableSale=(mrpAmt-(mrpAmt
						// *((gameBean.getAgtSaleCommRate() +
						// gameBean.getPrizePayOutRatio()
						// +gameBean.getGovtComm())/100))) *
						// (1/(1+(gameBean.getVat() * 0.01)));
						
						 * taxableSale = (((mrpAmt * (100 - (agtSaleCommRate +
						 * gameBean.getPrizePayOutRatio() + gameBean
						 * .getGovtComm()))) / 100) * 100) / (100 +
						 * gameBean.getVat());
						 
						// taxableSale=vatAmt/(gameBean.getVat() * 0.01);
						taxableSale = CommonMethods.calTaxableSale(mrpAmt,
								agtSaleCommRate,
								gameBean.getPrizePayOutRatio(), gameBean
										.getGovtComm(), gameBean.getVat());
						System.out
								.println(&quot;vat anount is by yogesh  &quot; + vatAmt);
						System.out.println(&quot;taxable sale is  by yogesh &quot;
								+ taxableSale);

						boAgentStmt.setDouble(7, netAmt);
						boAgentStmt.setString(8, &quot;SALE&quot;);

						boAgentStmt.setDouble(9, vatAmt);
						boAgentStmt.setDouble(10, taxableSale);
						boAgentStmt.setDouble(11, govtComm);

						boAgentStmt.execute();

						gameMasterStmt.setDouble(1, gameBean.getVatBalance()
								+ vatAmt);
						gameMasterStmt.setDouble(2, gameId);

						gameMasterStmt.execute();

						boOrdGameStmt.setInt(1, nbrOfBooksDispatched);
						boOrdGameStmt.setInt(2, orderId);
						boOrdGameStmt.setInt(3, gameId);

						boOrdGameStmt.execute();

						packList = invOrderBean.getPackList();

						// check book Status on dispatch
						String newBookStatus = &quot;ACTIVE&quot;;

						if (packList != null) {
							invQuery = gameInvStatusQuery
									+ &quot; and pack_nbr = ? &quot;;
							gameInvStatusStmt = connection
									.prepareStatement(invQuery);
							String packNbr = null;

							for (int j = 0; j &lt; packList.size(); j++) {
								packBean = packList.get(j);
								packNbr = packBean.getPackNumber();

								gameInvStatusStmt.setString(1, &quot;AGENT&quot;);
								gameInvStatusStmt.setInt(2, agentOrgId);
								gameInvStatusStmt.setString(3, newBookStatus);

								// Added by arun on update status table
								gameInvStatusStmt.setInt(4, noOfTktPerBooks);
								if (&quot;ACTIVE&quot;.equalsIgnoreCase(newBookStatus
										.trim())) {
									gameInvStatusStmt
											.setInt(5, noOfTktPerBooks);
								} else {
									gameInvStatusStmt.setInt(5, 0);
								}
								// ----------------

								gameInvStatusStmt.setInt(6, gameId);
								gameInvStatusStmt.setString(7, packNbr);
								gameInvStatusStmt.execute();

								List&lt;String&gt; books = getBooksForPack(
										connection, gameId, packNbr);

								for (int k = 0; k &lt; books.size(); k++) {
									gameInvDetailStmt.setInt(1, masterTrnId);
									gameInvDetailStmt.setInt(2, gameId);
									gameInvDetailStmt.setString(3, packNbr);
									gameInvDetailStmt
											.setString(4, books.get(k));
									gameInvDetailStmt.setString(5, &quot;AGENT&quot;);
									gameInvDetailStmt.setInt(6, agentOrgId);
									gameInvDetailStmt.setTimestamp(7,
											currentDate);
									gameInvDetailStmt.setString(8, &quot;BO&quot;);
									gameInvDetailStmt.setDouble(9,
											agtSaleCommRate);
									gameInvDetailStmt.setDouble(10, gameBean
											.getGovtComm());
									gameInvDetailStmt.setObject(11, null);
									gameInvDetailStmt.execute();

									// insert into detail history table Added by
									// arun
									detHistoryInsPstmt.setInt(1, gameId);
									detHistoryInsPstmt.setString(2, books
											.get(k));
									detHistoryInsPstmt.setString(3, &quot;AGENT&quot;);
									detHistoryInsPstmt.setInt(4, agentOrgId);
									detHistoryInsPstmt.setTimestamp(5,
											currentDate);
									detHistoryInsPstmt.setInt(6, userOrgID);
									detHistoryInsPstmt.setInt(7, userId);
									detHistoryInsPstmt.setInt(8,
											noOfTktPerBooks);
									// System.out.println(&quot;detHistoryInsPstmt ==
									// &quot;+detHistoryInsPstmt);
									if (&quot;ACTIVE&quot;.equalsIgnoreCase(newBookStatus
											.trim())) {
										detHistoryInsPstmt.setInt(9,
												noOfTktPerBooks);
									} else {
										detHistoryInsPstmt.setInt(9, 0);
									}
									detHistoryInsPstmt.setInt(10, 0);
									detHistoryInsPstmt.setString(11,
											newBookStatus);

									detHistoryInsPstmt.execute();
									// ---------------------
								}

							}
						}

						bookList = invOrderBean.getBookList();
						if (bookList != null) {
							invQuery = gameInvStatusQuery
									+ &quot; and book_nbr = ? &quot;;
							gameInvStatusStmt = connection
									.prepareStatement(invQuery);
							String bookNbr = null;
							String packNbr = null;
							for (int j = 0; j &lt; bookList.size(); j++) {
								bookBean = bookList.get(j);
								bookNbr = bookBean.getBookNumber();
								gameInvStatusStmt.setString(1, &quot;AGENT&quot;);
								gameInvStatusStmt.setInt(2, agentOrgId);
								gameInvStatusStmt.setString(3, newBookStatus);

								// Added by arun on update status table
								gameInvStatusStmt.setInt(4, noOfTktPerBooks);
								if (&quot;ACTIVE&quot;.equalsIgnoreCase(newBookStatus
										.trim())) {
									gameInvStatusStmt
											.setInt(5, noOfTktPerBooks);
								} else {
									gameInvStatusStmt.setInt(5, 0);
								}
								// ----------------
								gameInvStatusStmt.setInt(6, gameId);
								gameInvStatusStmt.setString(7, bookNbr);
								gameInvStatusStmt.execute();

								packNbr = getPackNbrForBook(connection, gameId,
										bookNbr);

								gameInvDetailStmt.setInt(1, masterTrnId);
								gameInvDetailStmt.setInt(2, gameId);
								gameInvDetailStmt.setString(3, packNbr);
								gameInvDetailStmt.setString(4, bookNbr);
								gameInvDetailStmt.setString(5, &quot;AGENT&quot;);
								gameInvDetailStmt.setInt(6, agentOrgId);
								gameInvDetailStmt.setTimestamp(7, currentDate);
								gameInvDetailStmt.setString(8, &quot;BO&quot;);
								gameInvDetailStmt.setDouble(9, agtSaleCommRate);
								gameInvDetailStmt.setDouble(10, gameBean
										.getGovtComm());
								gameInvDetailStmt.setObject(11, null);
								gameInvDetailStmt.execute();

								// insert into detail history table Added by
								// arun
								detHistoryInsPstmt.setInt(1, gameId);
								detHistoryInsPstmt.setString(2, bookNbr);
								detHistoryInsPstmt.setString(3, &quot;AGENT&quot;);
								detHistoryInsPstmt.setInt(4, agentOrgId);
								detHistoryInsPstmt.setTimestamp(5, currentDate);
								detHistoryInsPstmt.setInt(6, userOrgID);
								detHistoryInsPstmt.setInt(7, userId);
								detHistoryInsPstmt.setInt(8, noOfTktPerBooks);
								if (&quot;ACTIVE&quot;.equalsIgnoreCase(newBookStatus
										.trim())) {
									detHistoryInsPstmt.setInt(9,
											noOfTktPerBooks);
								} else {
									detHistoryInsPstmt.setInt(9, 0);
								}
								detHistoryInsPstmt.setInt(10, 0);
								detHistoryInsPstmt.setString(11, newBookStatus);
								// System.out.println(&quot;detHistoryInsPstmt ==
								// &quot;+detHistoryInsPstmt);
								detHistoryInsPstmt.execute();
								// ---------------------

							}
						}
						if (total == totalDispatchedForOrder) {
							boOrderStmt.setString(1, &quot;PROCESSED&quot;);
							boOrderStmt.setInt(2, orderId);

							boOrderStmt.execute();
							System.out
									.println(&quot;Total aaproved and total dispatched are equal&quot;);
							orderInvoicesPrtSt.setInt(1, orderId);
							orderInvoicesPrtSt.setInt(2, invoiceId);
							orderInvoicesPrtSt.setInt(3, agentOrgId);
							orderInvoicesPrtSt.setInt(4, gameId);
							orderInvoicesPrtSt.setString(5, &quot;PROCESSED&quot;);
							orderInvoicesPrtSt.setInt(6, nbrOfBooksDispatched);
							orderInvoicesPrtSt.execute();

						} else {
							boOrderStmt.setString(1, &quot;SEMI_PROCESSED&quot;);
							boOrderStmt.setInt(2, orderId);
							boOrderStmt.execute();

							orderInvoicesPrtSt.setInt(1, orderId);
							orderInvoicesPrtSt.setInt(2, invoiceId);
							orderInvoicesPrtSt.setInt(3, agentOrgId);
							orderInvoicesPrtSt.setInt(4, gameId);
							orderInvoicesPrtSt.setString(5, &quot;SEMI_PROCESSED&quot;);
							orderInvoicesPrtSt.setInt(6, nbrOfBooksDispatched);
							orderInvoicesPrtSt.execute();
						}
					}
				}
				for (int i = 0; i &lt; trnIdList.size(); i++) {
					boReceiptMappingStmt.setInt(1, invoiceId);
					boReceiptMappingStmt.setInt(2, trnIdList.get(i));
					boReceiptMappingStmt.execute();

				}

				// insert for receipt and transaction mapping table for delivery
				// challan
				for (int i = 0; i &lt; trnIdList.size(); i++) {
					boReceiptMappingStmt.setInt(1, DCId);
					boReceiptMappingStmt.setInt(2, trnIdList.get(i));
					boReceiptMappingStmt.execute();

				}

				
				 * //insert into recipt gen reciept mapping String
				 * updateBoRecieptGenMapping=QueryManager.updateST5BOReceiptGenMapping();
				 * boReceiptGenMappingStmt=connection.prepareStatement(updateBoRecieptGenMapping);
				 * boReceiptGenMappingStmt.setInt(1,invoiceId);
				 * boReceiptGenMappingStmt.setString(2,autoGeneRecieptNo);
				 * boReceiptGenMappingStmt.setString(3,&quot;INVOICE&quot;);
				 * boReceiptGenMappingStmt.executeUpdate();
				 * 
				 * 
				 * //insert for delivery challan into receipt_gen_mapping
				 * //String
				 * updateBoRecieptGenMapping=QueryManager.updateST5BOReceiptGenMapping();
				 * boReceiptGenMappingStmt=connection.prepareStatement(updateBoRecieptGenMapping);
				 * boReceiptGenMappingStmt.setInt(1,DCId);
				 * boReceiptGenMappingStmt.setString(2,autoGeneDCNo);
				 * boReceiptGenMappingStmt.setString(3,&quot;DLCHALLAN&quot;);
				 * boReceiptGenMappingStmt.executeUpdate();
				 

				// insert into invoice and delivery challan mapping table
				String insertInvoiceDCMapping = &quot;insert into st_se_bo_invoice_delchallan_mapping(id,generated_invoice_id,generated_del_challan_id) values(?,?,?)&quot;;
				boInvoiceDCMappingStmt = connection
						.prepareStatement(insertInvoiceDCMapping);
				boInvoiceDCMappingStmt.setInt(1, invoiceId);
				boInvoiceDCMappingStmt.setString(2, autoGeneRecieptNo);
				boInvoiceDCMappingStmt.setString(3, autoGeneDCNo);
				boInvoiceDCMappingStmt.executeUpdate();

				// for org credit updation
				System.out.println(&quot;Org Id For Credit Update:&quot; + agentOrgId
						+ &quot;:&quot; + creditAmt);
				
				boolean isValid=OrgCreditUpdation.updateOrganizationBalWithValidate(creditAmt, &quot;TRANSACTION&quot;, &quot;SALE&quot;, agentOrgId,
						0, &quot;AGENT&quot;, 0, connection);
				
				if(!isValid)
					throw new LMSException();
				
				boolean isUpdateDone = OrgCreditUpdation
						.updateCreditLimitForAgent(agentOrgId, &quot;SALE&quot;,
								creditAmt, connection);

				connection.commit();

				session.setAttribute(&quot;DEL_CHALLAN_ID&quot;, DCId);
				if (invoiceId &gt; -1) {
					GraphReportHelper graphReportHelper = new GraphReportHelper();
					graphReportHelper.createTextReportBO(invoiceId, boOrgName,
							userOrgID, rootPath);
				}

			} catch (SQLException se) {
				try {
					connection.rollback();
				} catch (SQLException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
					throw new LMSException(&quot;Error During Rollback&quot;, e);
				}
				se.printStackTrace();
				throw new LMSException(se);
			} finally {
				try {
					if (connection != null) {
						connection.close();
					}
				} catch (SQLException se) {
					se.printStackTrace();
				}
			}

		}

	}*/
	
	public int assignOrder(List&lt;InvOrderBean&gt; invOrderList, int total, int orderId, String boOrgName, int userOrgID, int agentOrgId, String rootPath, int userId) throws LMSException {
<span class="nc" id="L780">		System.out.println(&quot;Start to Dispach&quot;);</span>

<span class="nc" id="L782">		int DCId = -1;</span>
<span class="nc" id="L783">		int warehouseId = -1;</span>
<span class="nc" id="L784">		InvOrderBean invOrderBean = null;</span>
<span class="nc" id="L785">		OrderedGameBean gameBean = null;</span>
<span class="nc bnc" id="L786" title="All 2 branches missed.">		if (invOrderList != null) {</span>

<span class="nc" id="L788">			Connection connection = null;			</span>
<span class="nc" id="L789">			PreparedStatement boOrdGameStmt = null;</span>
<span class="nc" id="L790">			PreparedStatement boReceiptStmt = null;</span>
<span class="nc" id="L791">			PreparedStatement boReceiptNoGenStmt = null;		</span>
<span class="nc" id="L792">			PreparedStatement boOrderStmt = null;		</span>
<span class="nc" id="L793">			PreparedStatement gameInvStatusStmt = null;</span>
<span class="nc" id="L794">			PreparedStatement gameInvDetailStmt = null;</span>
<span class="nc" id="L795">			PreparedStatement orderInvoicesPrtSt = null;</span>
<span class="nc" id="L796">			Statement totalDispatch = null;</span>
<span class="nc" id="L797">			ResultSet totalDispatchResult = null;</span>

			//String boMasterQuery = null;
			//String LMSMasterQuery = null;
			//String boAgentQuery = null;
<span class="nc" id="L802">			String boOrdGamesQuery = null;</span>
			//String boReceiptQuery = null;
			//String boReceiptMappingQuery = null;
<span class="nc" id="L805">			String boOrderQuery = null;</span>
<span class="nc" id="L806">			String gameInvStatusQuery = null;</span>
<span class="nc" id="L807">			String invQuery = null;</span>
<span class="nc" id="L808">			String orderInvoicesQuery = null;</span>

<span class="nc" id="L810">			String gameInvDetailQuery = null;</span>
<span class="nc" id="L811">			String bookQuery = null;</span>

			// added by yogehs to inser vat details into game master
<span class="nc" id="L814">			String gameMasterQuery = null;</span>
<span class="nc" id="L815">			PreparedStatement gameMasterStmt = null;</span>

			// String countDispatchedTotal = &quot;select nbr_of_books_dlvrd from
			// st_se_bo_ordered_games where order_id=&quot;+orderId;
<span class="nc" id="L819">			String countDispatchedTotal = QueryManager</span>
					.getST5ToatlDispatchQuery()
					+ orderId;
			//List&lt;Integer&gt; trnIdList = new ArrayList&lt;Integer&gt;();
			//int masterTrnId = -1;
<span class="nc" id="L824">			int totalDispatchedForOrder = 0;</span>

			try {

				 
<span class="nc" id="L829">				connection = DBConnect.getConnection();</span>
<span class="nc" id="L830">				connection.setAutoCommit(false);</span>

<span class="nc" id="L832">				totalDispatch = connection.createStatement();</span>

<span class="nc" id="L834">				totalDispatchResult = totalDispatch</span>
						.executeQuery(countDispatchedTotal);
				/**
				 * ///Checking that wheather total books have been dispatched or
				 * not .On the basis of that Order would be Processed or
				 * SemiProcessed
				 */

<span class="nc bnc" id="L842" title="All 2 branches missed.">				while (totalDispatchResult.next()) {</span>
<span class="nc" id="L843">					totalDispatchedForOrder = totalDispatchedForOrder</span>
							+ totalDispatchResult.getInt(&quot;nbr_of_books_dlvrd&quot;);
<span class="nc bnc" id="L845" title="All 2 branches missed.">					if (totalDispatchedForOrder == total) {</span>
<span class="nc" id="L846">						break;</span>

					}
				}
<span class="nc" id="L850">				System.out.println(&quot;--------totalDispatchedForOrder&quot;</span>
						+ totalDispatchedForOrder + &quot;-------&quot;);

				
<span class="nc" id="L854">				boOrdGamesQuery = QueryManager.getST1BOOrdGamesUpdQuery();</span>
<span class="nc" id="L855">				boOrdGameStmt = connection.prepareStatement(boOrdGamesQuery);</span>

<span class="nc" id="L857">				java.sql.Timestamp currentDate = new java.sql.Timestamp(</span>
						new Date().getTime());

<span class="nc" id="L860">				boOrderQuery = QueryManager.getST1BOOrdUpdQuery();</span>
<span class="nc" id="L861">				boOrderStmt = connection.prepareStatement(boOrderQuery);</span>

<span class="nc" id="L863">				gameInvStatusQuery = QueryManager</span>
						.getST1BOUpdGameInvStatusQuery();

<span class="nc" id="L866">				gameInvDetailQuery = QueryManager.getST1InvDetailWithWarehouseInsertQuery();</span>
<span class="nc" id="L867">				gameInvDetailStmt = connection</span>
						.prepareStatement(gameInvDetailQuery);

<span class="nc" id="L870">				orderInvoicesQuery = QueryManager.getST1OrderInInsertQuery();</span>
<span class="nc" id="L871">				orderInvoicesPrtSt = connection</span>
						.prepareStatement(orderInvoicesQuery);

				/*gameMasterQuery = QueryManager.insertVatDetailsintoGameMaster();
				gameMasterStmt = connection.prepareStatement(gameMasterQuery);*/

<span class="nc" id="L877">				String detHistoryInsQuery = &quot;insert into st_se_game_ticket_inv_history(game_id, book_nbr, &quot;</span>
						+ &quot; current_owner, current_owner_id, date, done_by_oid, done_by_uid, cur_rem_tickets, &quot;
						+ &quot; active_tickets_upto, sold_tickets, status) values (?,?,?,?,?,?,?,?,?,?,?)&quot;;
<span class="nc" id="L880">				PreparedStatement detHistoryInsPstmt = connection</span>
						.prepareStatement(detHistoryInsQuery);
				//int nbrOfbooksApp = 0;
<span class="nc" id="L883">				int nbrBooksalreadyDispatched = 0;</span>
<span class="nc" id="L884">				int nbrOfBooksDispatched = 0;</span>
				//int totalDispatched = 0;

			

<span class="nc" id="L889">				int gameId = -1;</span>
<span class="nc" id="L890">				List&lt;PackBean&gt; packList = null;</span>
<span class="nc" id="L891">				List&lt;BookBean&gt; bookList = null;</span>
<span class="nc" id="L892">				PackBean packBean = null;</span>
<span class="nc" id="L893">				BookBean bookBean = null;</span>

				
<span class="nc" id="L896">				boReceiptNoGenStmt = connection.prepareStatement(QueryManager</span>
						.getBOLatestReceiptNb());
<span class="nc" id="L898">				boReceiptNoGenStmt.setString(1, &quot;DLCHALLAN&quot;);</span>
<span class="nc" id="L899">				ResultSet DCRs = boReceiptNoGenStmt.executeQuery();</span>
<span class="nc" id="L900">				String lastDCNoGenerated = null;</span>

<span class="nc bnc" id="L902" title="All 2 branches missed.">				while (DCRs.next()) {</span>
<span class="nc" id="L903">					lastDCNoGenerated = DCRs.getString(&quot;generated_id&quot;);</span>
				}

<span class="nc" id="L906">				String autoGeneDCNo = null;</span>
<span class="nc" id="L907">				autoGeneDCNo = GenerateRecieptNo.getRecieptNo(&quot;DLCHALLAN&quot;,</span>
						lastDCNoGenerated, &quot;BO&quot;);
<span class="nc" id="L909">				System.out.println(&quot;lastDCNoGenerated &quot; + lastDCNoGenerated</span>
						+ &quot;autoGeneDCNo &quot; + autoGeneDCNo);

				

				// insert in receipt transaction master for delivery challan
<span class="nc" id="L915">				boReceiptStmt = connection.prepareStatement(QueryManager</span>
						.insertInReceiptMaster());
<span class="nc" id="L917">				boReceiptStmt.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L918">				boReceiptStmt.executeUpdate();</span>

<span class="nc" id="L920">				ResultSet rsDC = boReceiptStmt.getGeneratedKeys();</span>
<span class="nc bnc" id="L921" title="All 2 branches missed.">				while (rsDC.next()) {</span>
<span class="nc" id="L922">					DCId = rsDC.getInt(1);</span>
				}

				// insert bo reciept id for delivery challan

<span class="nc" id="L927">				boReceiptStmt = connection.prepareStatement(QueryManager</span>
						.insertInBOReceipts());

<span class="nc" id="L930">				boReceiptStmt.setInt(1, DCId);</span>
<span class="nc" id="L931">				boReceiptStmt.setString(2, &quot;DLCHALLAN&quot;);</span>
<span class="nc" id="L932">				boReceiptStmt.setInt(3, agentOrgId);</span>
<span class="nc" id="L933">				boReceiptStmt.setString(4, &quot;AGENT&quot;);</span>
<span class="nc" id="L934">				boReceiptStmt.setString(5, autoGeneDCNo);</span>
<span class="nc" id="L935">				boReceiptStmt.setTimestamp(6, Util.getCurrentTimeStamp());</span>

				/*
				 * boReceiptStmt.setString(1,&quot;DLCHALLAN&quot;);
				 * boReceiptStmt.setInt(2,agentOrgId);
				 */

<span class="nc" id="L942">				boReceiptStmt.execute();</span>

<span class="nc bnc" id="L944" title="All 2 branches missed.">				for (int i = 0; i &lt; invOrderList.size(); i++) {</span>

<span class="nc" id="L946">					invOrderBean = invOrderList.get(i);</span>

<span class="nc" id="L948">					gameBean = invOrderBean.getOrderedGameBean();</span>
<span class="nc" id="L949">					gameId = gameBean.getGameId();</span>
					//nbrOfbooksApp = gameBean.getNbrOfBooksApp();
<span class="nc" id="L951">					nbrBooksalreadyDispatched = gameBean.getNbrOfBooksDlvrd();</span>

<span class="nc" id="L953">					int nbrOfBooksPerPack = gameBean.getNbrOfBooksPerPack();</span>

<span class="nc" id="L955">					nbrOfBooksDispatched = nbrBooksalreadyDispatched</span>
							+ getDispatchedNbrOfBooks(invOrderBean,
									nbrOfBooksPerPack);
<span class="nc" id="L958">					totalDispatchedForOrder = totalDispatchedForOrder</span>
							+ getDispatchedNbrOfBooks(invOrderBean,
									nbrOfBooksPerPack);
<span class="nc" id="L961">					int currentlyDispatched = getDispatchedNbrOfBooks(</span>
							invOrderBean, nbrOfBooksPerPack);
<span class="nc bnc" id="L963" title="All 2 branches missed.">					if (currentlyDispatched &gt; 0) {</span>
						// totalDispatched=nbrBooksalreadyDispatched+nbrOfBooksDispatched+totalDispatchedForOrder;

						// fetch game details from game master
<span class="nc" id="L967">						String fetchGameDetQuery = &quot;select nbr_of_tickets_per_book from st_se_game_master where game_id =&quot;</span>
								+ gameId;
<span class="nc" id="L969">						Statement fetchGameDetStmt = connection</span>
								.createStatement();
<span class="nc" id="L971">						ResultSet fetchGameDetRs = fetchGameDetStmt</span>
								.executeQuery(fetchGameDetQuery);
<span class="nc" id="L973">						int noOfTktPerBooks = -1;</span>
<span class="nc bnc" id="L974" title="All 2 branches missed.">						if (fetchGameDetRs.next()) {</span>
<span class="nc" id="L975">							noOfTktPerBooks = fetchGameDetRs</span>
									.getInt(&quot;nbr_of_tickets_per_book&quot;);
						}

<span class="nc" id="L979">						boOrdGameStmt.setInt(1, nbrOfBooksDispatched);</span>
<span class="nc" id="L980">						boOrdGameStmt.setInt(2, orderId);</span>
<span class="nc" id="L981">						boOrdGameStmt.setInt(3, gameId);</span>

<span class="nc" id="L983">						boOrdGameStmt.execute();</span>

<span class="nc" id="L985">						packList = invOrderBean.getPackList();</span>

<span class="nc bnc" id="L987" title="All 2 branches missed.">						if (total == totalDispatchedForOrder) {</span>
<span class="nc" id="L988">							boOrderStmt.setString(1, &quot;ASSIGNED&quot;);</span>
<span class="nc" id="L989">							boOrderStmt.setInt(2, orderId);</span>

<span class="nc" id="L991">							boOrderStmt.execute();</span>
<span class="nc" id="L992">							System.out</span>
									.println(&quot;Total aaproved and total dispatched are equal&quot;);	
							
<span class="nc" id="L995">							orderInvoicesPrtSt.setInt(1, orderId);</span>
<span class="nc" id="L996">							orderInvoicesPrtSt.setString(2, null);</span>
<span class="nc" id="L997">							orderInvoicesPrtSt.setInt(3, agentOrgId);</span>
<span class="nc" id="L998">							orderInvoicesPrtSt.setInt(4, gameId);</span>
<span class="nc" id="L999">							orderInvoicesPrtSt.setString(5, &quot;ASSIGNED&quot;);</span>
<span class="nc" id="L1000">							orderInvoicesPrtSt.setInt(6, nbrOfBooksDispatched);</span>
<span class="nc" id="L1001">							orderInvoicesPrtSt.setInt(7, DCId);</span>
<span class="nc" id="L1002">							orderInvoicesPrtSt.execute();</span>

						} else {
							//boOrderStmt.setString(1, &quot;SEMI_PROCESSED&quot;);
<span class="nc" id="L1006">							boOrderStmt.setString(1, &quot;SEMI_ASSIGNED&quot;);</span>
<span class="nc" id="L1007">							boOrderStmt.setInt(2, orderId);</span>
<span class="nc" id="L1008">							boOrderStmt.execute();		</span>
							
<span class="nc" id="L1010">							orderInvoicesPrtSt.setInt(1, orderId);</span>
<span class="nc" id="L1011">							orderInvoicesPrtSt.setString(2, null);</span>
<span class="nc" id="L1012">							orderInvoicesPrtSt.setInt(3, agentOrgId);</span>
<span class="nc" id="L1013">							orderInvoicesPrtSt.setInt(4, gameId);</span>
<span class="nc" id="L1014">							orderInvoicesPrtSt.setString(5, &quot;SEMI_ASSIGNED&quot;);</span>
<span class="nc" id="L1015">							orderInvoicesPrtSt.setInt(6, nbrOfBooksDispatched);</span>
<span class="nc" id="L1016">							orderInvoicesPrtSt.setInt(7, DCId);</span>
<span class="nc" id="L1017">							orderInvoicesPrtSt.execute();</span>
						}

<span class="nc" id="L1020">						ResultSet rs = orderInvoicesPrtSt.getGeneratedKeys();</span>
<span class="nc" id="L1021">						int orderInvoiceDCId = -1;</span>
<span class="nc bnc" id="L1022" title="All 2 branches missed.">						while (rs.next()) {</span>
<span class="nc" id="L1023">							orderInvoiceDCId = rs.getInt(1);</span>
						}

<span class="nc" id="L1026">						String newBookStatus = &quot;ASSIGNED&quot;;</span>
<span class="nc bnc" id="L1027" title="All 2 branches missed.">						if (packList != null) {</span>
<span class="nc" id="L1028">							invQuery = gameInvStatusQuery</span>
									+ &quot; and pack_nbr = ? &quot;;
<span class="nc" id="L1030">							gameInvStatusStmt = connection</span>
									.prepareStatement(invQuery);
<span class="nc" id="L1032">							String packNbr = null;</span>

<span class="nc bnc" id="L1034" title="All 2 branches missed.">							for (int j = 0; j &lt; packList.size(); j++) {</span>
<span class="nc" id="L1035">								packBean = packList.get(j);</span>
<span class="nc" id="L1036">								packNbr = packBean.getPackNumber();</span>

<span class="nc" id="L1038">								gameInvStatusStmt.setString(1, &quot;AGENT&quot;);</span>
<span class="nc" id="L1039">								gameInvStatusStmt.setInt(2, agentOrgId);</span>
<span class="nc" id="L1040">								gameInvStatusStmt.setString(3, newBookStatus);</span>
								// Added by arun on update status table
<span class="nc" id="L1042">								gameInvStatusStmt.setInt(4, noOfTktPerBooks);</span>
<span class="nc bnc" id="L1043" title="All 2 branches missed.">								if (&quot;ACTIVE&quot;.equalsIgnoreCase(newBookStatus.trim())) {</span>
<span class="nc" id="L1044">									gameInvStatusStmt.setInt(5, noOfTktPerBooks);</span>
								} else {
<span class="nc" id="L1046">									gameInvStatusStmt.setInt(5, 0);</span>
								}
<span class="nc" id="L1048">								gameInvStatusStmt.setString(6, String.valueOf(DCId));</span>
<span class="nc" id="L1049">								gameInvStatusStmt.setInt(7, gameId);</span>
<span class="nc" id="L1050">								gameInvStatusStmt.setString(8, packNbr);</span>
<span class="nc" id="L1051">								gameInvStatusStmt.execute();</span>

<span class="nc" id="L1053">								List&lt;String&gt; books = getBooksForPack(</span>
										connection, gameId, packNbr);

<span class="nc bnc" id="L1056" title="All 2 branches missed.">								for (int k = 0; k &lt; books.size(); k++) {</span>
<span class="nc" id="L1057">									warehouseId = ScratchGameDataDaoImpl.getSingleInstance().getWarehouseNbrForBook(connection, gameId, books.get(k));</span>
<span class="nc" id="L1058">									gameInvDetailStmt.setString(1, null);</span>
<span class="nc" id="L1059">									gameInvDetailStmt.setInt(2, gameId);</span>
<span class="nc" id="L1060">									gameInvDetailStmt.setString(3, packNbr);</span>
<span class="nc" id="L1061">									gameInvDetailStmt</span>
											.setString(4, books.get(k));
<span class="nc" id="L1063">									gameInvDetailStmt.setString(5, &quot;AGENT&quot;);</span>
<span class="nc" id="L1064">									gameInvDetailStmt.setInt(6, agentOrgId);</span>
<span class="nc" id="L1065">									gameInvDetailStmt.setTimestamp(7,</span>
											currentDate);
<span class="nc" id="L1067">									gameInvDetailStmt.setString(8, &quot;BO&quot;);</span>
<span class="nc" id="L1068">									gameInvDetailStmt.setString(9, newBookStatus);</span>
<span class="nc" id="L1069">									gameInvDetailStmt.setInt(10, orderInvoiceDCId);</span>
<span class="nc" id="L1070">									gameInvDetailStmt.setInt(11, warehouseId);</span>
									/*gameInvDetailStmt.setDouble(9,
											agtSaleCommRate);
									gameInvDetailStmt.setDouble(10, gameBean
											.getGovtComm());*/
									//gameInvDetailStmt.setObject(9, null);
<span class="nc" id="L1076">									gameInvDetailStmt.execute();</span>

									// insert into detail history table Added by
									// arun
<span class="nc" id="L1080">									detHistoryInsPstmt.setInt(1, gameId);</span>
<span class="nc" id="L1081">									detHistoryInsPstmt.setString(2, books</span>
											.get(k));
<span class="nc" id="L1083">									detHistoryInsPstmt.setString(3, &quot;AGENT&quot;);</span>
<span class="nc" id="L1084">									detHistoryInsPstmt.setInt(4, agentOrgId);</span>
<span class="nc" id="L1085">									detHistoryInsPstmt.setTimestamp(5,</span>
											currentDate);
<span class="nc" id="L1087">									detHistoryInsPstmt.setInt(6, userOrgID);</span>
<span class="nc" id="L1088">									detHistoryInsPstmt.setInt(7, userId);</span>
<span class="nc" id="L1089">									detHistoryInsPstmt.setInt(8,</span>
											noOfTktPerBooks);
									// System.out.println(&quot;detHistoryInsPstmt ==
									// &quot;+detHistoryInsPstmt);
<span class="nc bnc" id="L1093" title="All 2 branches missed.">									if (&quot;ACTIVE&quot;.equalsIgnoreCase(newBookStatus.trim())) {</span>
<span class="nc" id="L1094">										detHistoryInsPstmt.setInt(9, noOfTktPerBooks);</span>
									} else {
<span class="nc" id="L1096">										detHistoryInsPstmt.setInt(9, 0);</span>
									}
<span class="nc" id="L1098">									detHistoryInsPstmt.setInt(10, 0);</span>
<span class="nc" id="L1099">									detHistoryInsPstmt.setString(11, newBookStatus);</span>
<span class="nc" id="L1100">									detHistoryInsPstmt.execute();</span>
								}
							}
						}

<span class="nc" id="L1105">						bookList = invOrderBean.getBookList();</span>
<span class="nc bnc" id="L1106" title="All 2 branches missed.">						if (bookList != null) {</span>
<span class="nc" id="L1107">							invQuery = gameInvStatusQuery</span>
									+ &quot; and book_nbr = ? &quot;;
<span class="nc" id="L1109">							gameInvStatusStmt = connection</span>
									.prepareStatement(invQuery);
<span class="nc" id="L1111">							String bookNbr = null;</span>
<span class="nc" id="L1112">							String packNbr = null;</span>
<span class="nc bnc" id="L1113" title="All 2 branches missed.">							for (int j = 0; j &lt; bookList.size(); j++) {</span>
<span class="nc" id="L1114">								bookBean = bookList.get(j);</span>
<span class="nc" id="L1115">								bookNbr = bookBean.getBookNumber();</span>
<span class="nc" id="L1116">								gameInvStatusStmt.setString(1, &quot;AGENT&quot;);</span>
<span class="nc" id="L1117">								gameInvStatusStmt.setInt(2, agentOrgId);</span>
<span class="nc" id="L1118">								gameInvStatusStmt.setString(3, newBookStatus);</span>

								// Added by arun on update status table
<span class="nc" id="L1121">								gameInvStatusStmt.setInt(4, noOfTktPerBooks);</span>
<span class="nc bnc" id="L1122" title="All 2 branches missed.">								if (&quot;ACTIVE&quot;.equalsIgnoreCase(newBookStatus.trim())) {</span>
<span class="nc" id="L1123">									gameInvStatusStmt.setInt(5, noOfTktPerBooks);</span>
								} else {
<span class="nc" id="L1125">									gameInvStatusStmt.setInt(5, 0);</span>
								}
<span class="nc" id="L1127">								gameInvStatusStmt.setString(6, String.valueOf(DCId));</span>
<span class="nc" id="L1128">								gameInvStatusStmt.setInt(7, gameId);</span>
<span class="nc" id="L1129">								gameInvStatusStmt.setString(8, bookNbr);</span>
<span class="nc" id="L1130">								gameInvStatusStmt.execute();</span>

<span class="nc" id="L1132">								packNbr = getPackNbrForBook(connection, gameId,</span>
										bookNbr);
								
<span class="nc" id="L1135">								warehouseId = ScratchGameDataDaoImpl.getSingleInstance().getWarehouseNbrForBook(connection, gameId, bookNbr);</span>
<span class="nc" id="L1136">								gameInvDetailStmt.setString(1, null);</span>
<span class="nc" id="L1137">								gameInvDetailStmt.setInt(2, gameId);</span>
<span class="nc" id="L1138">								gameInvDetailStmt.setString(3, packNbr);</span>
<span class="nc" id="L1139">								gameInvDetailStmt.setString(4, bookNbr);</span>
<span class="nc" id="L1140">								gameInvDetailStmt.setString(5, &quot;AGENT&quot;);</span>
<span class="nc" id="L1141">								gameInvDetailStmt.setInt(6, agentOrgId);</span>
<span class="nc" id="L1142">								gameInvDetailStmt.setTimestamp(7, currentDate);</span>
<span class="nc" id="L1143">								gameInvDetailStmt.setString(8, &quot;BO&quot;);</span>
<span class="nc" id="L1144">								gameInvDetailStmt.setString(9, newBookStatus);</span>
<span class="nc" id="L1145">								gameInvDetailStmt.setInt(10, orderInvoiceDCId);</span>
<span class="nc" id="L1146">								gameInvDetailStmt.setInt(11, warehouseId);</span>
								/*gameInvDetailStmt.setDouble(9, agtSaleCommRate);
								gameInvDetailStmt.setDouble(10, gameBean
										.getGovtComm());*/
								//gameInvDetailStmt.setObject(11, null);
<span class="nc" id="L1151">								gameInvDetailStmt.execute();</span>

								// insert into detail history table Added by
								// arun
<span class="nc" id="L1155">								detHistoryInsPstmt.setInt(1, gameId);</span>
<span class="nc" id="L1156">								detHistoryInsPstmt.setString(2, bookNbr);</span>
<span class="nc" id="L1157">								detHistoryInsPstmt.setString(3, &quot;AGENT&quot;);</span>
<span class="nc" id="L1158">								detHistoryInsPstmt.setInt(4, agentOrgId);</span>
<span class="nc" id="L1159">								detHistoryInsPstmt.setTimestamp(5, currentDate);</span>
<span class="nc" id="L1160">								detHistoryInsPstmt.setInt(6, userOrgID);</span>
<span class="nc" id="L1161">								detHistoryInsPstmt.setInt(7, userId);</span>
<span class="nc" id="L1162">								detHistoryInsPstmt.setInt(8, noOfTktPerBooks);</span>
<span class="nc bnc" id="L1163" title="All 2 branches missed.">								if (&quot;ACTIVE&quot;.equalsIgnoreCase(newBookStatus</span>
										.trim())) {
<span class="nc" id="L1165">									detHistoryInsPstmt.setInt(9,</span>
											noOfTktPerBooks);
								} else {
<span class="nc" id="L1168">									detHistoryInsPstmt.setInt(9, 0);</span>
								}
<span class="nc" id="L1170">								detHistoryInsPstmt.setInt(10, 0);</span>
<span class="nc" id="L1171">								detHistoryInsPstmt.setString(11, newBookStatus);</span>
								// System.out.println(&quot;detHistoryInsPstmt ==
								// &quot;+detHistoryInsPstmt);
<span class="nc" id="L1174">								detHistoryInsPstmt.execute();</span>
								// ---------------------

							}
						}
					}
				}
<span class="nc" id="L1181">				connection.commit();</span>

				/*if (invoiceId &gt; -1) {
					GraphReportHelper graphReportHelper = new GraphReportHelper();
					graphReportHelper.createTextReportBO(invoiceId, boOrgName,
							userOrgID, rootPath);
				}*/

<span class="nc" id="L1189">			} catch (SQLException se) {</span>
				try {
<span class="nc" id="L1191">					connection.rollback();</span>
<span class="nc" id="L1192">				} catch (SQLException e) {</span>
					// TODO Auto-generated catch block
<span class="nc" id="L1194">					e.printStackTrace();</span>
<span class="nc" id="L1195">					throw new LMSException(&quot;Error During Rollback&quot;, e);</span>
<span class="nc" id="L1196">				}</span>
<span class="nc" id="L1197">				se.printStackTrace();</span>
<span class="nc" id="L1198">				throw new LMSException(se);</span>
			} finally {
<span class="nc" id="L1200">				try {</span>
<span class="nc bnc" id="L1201" title="All 4 branches missed.">					if (connection != null) {</span>
<span class="nc" id="L1202">						connection.close();</span>
					}
<span class="nc" id="L1204">				} catch (SQLException se) {</span>
<span class="nc" id="L1205">					se.printStackTrace();</span>
<span class="nc" id="L1206">				}</span>
<span class="nc" id="L1207">			}</span>

		}

<span class="nc" id="L1211">		return DCId;</span>
	}

	/**
	 * This method returns the address of the organization
	 * 
	 * @param orgId
	 * @return OrgAddressBean
	 * @throws LMSException
	 */
	public OrgAddressBean fetchAddress(int orgId) throws LMSException {

<span class="nc" id="L1223">		Connection connection = null;</span>
<span class="nc" id="L1224">		PreparedStatement statement = null;</span>
<span class="nc" id="L1225">		ResultSet resultSet = null;</span>

		try {

<span class="nc" id="L1229">			OrgAddressBean orgAddrBean = null;</span>

			 
<span class="nc" id="L1232">			connection = DBConnect.getConnection();</span>

<span class="nc" id="L1234">			String query = QueryManager.getST1OrgAddrQuery();</span>
<span class="nc" id="L1235">			statement = connection.prepareStatement(query);</span>

<span class="nc" id="L1237">			statement.setInt(1, orgId);</span>

<span class="nc" id="L1239">			System.out.println(&quot;-----Query----::&quot; + query);</span>

<span class="nc" id="L1241">			resultSet = statement.executeQuery();</span>

<span class="nc bnc" id="L1243" title="All 2 branches missed.">			while (resultSet.next()) {</span>
<span class="nc" id="L1244">				orgAddrBean = new OrgAddressBean();</span>

<span class="nc" id="L1246">				orgAddrBean.setOrgId(orgId);</span>
<span class="nc" id="L1247">				orgAddrBean.setAddrLine1(resultSet</span>
						.getString(TableConstants.SOM_ADDR_LINE1));
<span class="nc" id="L1249">				orgAddrBean.setAddrLine2(resultSet</span>
						.getString(TableConstants.SOM_ADDR_LINE2));
<span class="nc" id="L1251">				orgAddrBean.setCity(resultSet</span>
						.getString(TableConstants.SOM_CITY));
<span class="nc" id="L1253">				orgAddrBean.setState(resultSet.getString(TableConstants.STATE));</span>
<span class="nc" id="L1254">				orgAddrBean.setCountry(resultSet</span>
						.getString(TableConstants.COUNTRY));

			}

<span class="nc" id="L1259">			return orgAddrBean;</span>

<span class="nc" id="L1261">		} catch (SQLException e) {</span>

<span class="nc" id="L1263">			e.printStackTrace();</span>
<span class="nc" id="L1264">			throw new LMSException(e);</span>
		} finally {

<span class="nc" id="L1267">			try {</span>

<span class="nc bnc" id="L1269" title="All 4 branches missed.">				if (statement != null) {</span>
<span class="nc" id="L1270">					statement.close();</span>
				}
<span class="nc bnc" id="L1272" title="All 4 branches missed.">				if (connection != null) {</span>
<span class="nc" id="L1273">					connection.close();</span>
				}
<span class="nc" id="L1275">			} catch (SQLException se) {</span>
<span class="nc" id="L1276">				se.printStackTrace();</span>
<span class="nc" id="L1277">			}</span>
		}

		// return null;

	}

	/**
	 * This method returns the list of games for the passed order number
	 * 
	 * @param orderId
	 * @return List
	 * @throws LMSException
	 */
	public List fetchOrderDetails(int orderId, int agtOrgId)
			throws LMSException {
<span class="nc" id="L1293">		int totalApprovedBooks = 0;</span>
<span class="nc" id="L1294">		Connection connection = null;</span>
<span class="nc" id="L1295">		Statement statement = null;</span>
<span class="nc" id="L1296">		Statement statementCommVariance = null;</span>
<span class="nc" id="L1297">		ResultSet resultSet = null;</span>
<span class="nc" id="L1298">		ResultSet resultSetCommVariance = null;</span>
		try {

<span class="nc" id="L1301">			OrderedGameBean orderedGameBean = null;</span>
<span class="nc" id="L1302">			List&lt;OrderedGameBean&gt; searchResults = new ArrayList&lt;OrderedGameBean&gt;();</span>

			 
<span class="nc" id="L1305">			connection = DBConnect.getConnection();</span>
<span class="nc" id="L1306">			statement = connection.createStatement();</span>

<span class="nc" id="L1308">			String query = QueryManager.getST1AppOrderGamesQuery();</span>
<span class="nc" id="L1309">			query = query + orderId;</span>

<span class="nc" id="L1311">			System.out.println(&quot;-----Query11111----::&quot; + query);</span>

<span class="nc" id="L1313">			resultSet = statement.executeQuery(query);</span>
<span class="nc" id="L1314">			int nbrBooksToDispatch = 0;</span>
<span class="nc" id="L1315">			double bookPrice = 0.0;</span>
<span class="nc bnc" id="L1316" title="All 2 branches missed.">			while (resultSet.next()) {</span>

<span class="nc" id="L1318">				orderedGameBean = new OrderedGameBean();</span>

<span class="nc" id="L1320">				orderedGameBean.setOrderId(resultSet</span>
						.getInt(TableConstants.SBOG_ORDER_ID));
<span class="nc" id="L1322">				orderedGameBean.setGameId(resultSet</span>
						.getInt(TableConstants.SBOG_GAME_ID));
<span class="nc" id="L1324">				orderedGameBean.setGameName(resultSet</span>
						.getString(TableConstants.SGM_GAME_NAME));
<span class="nc" id="L1326">				orderedGameBean.setGameNbr(resultSet</span>
						.getInt(TableConstants.SGM_GAME_NBR));
<span class="nc" id="L1328">				orderedGameBean.setNbrOfBooksApp(resultSet</span>
						.getInt(TableConstants.SBOG_NBR_OF_BOOKS_APP));

				// here added by yogesh
				// added by yogesh to get agent commission variance for every
				// game
<span class="nc" id="L1334">				double agtGameCommVariace = 0.0;</span>
<span class="nc" id="L1335">				String getAgtCommVariance = &quot;select sale_comm_variance from st_se_bo_agent_sale_pwt_comm_variance where agent_org_id=&quot;</span>
						+ agtOrgId
						+ &quot; and game_id=&quot;
						+ resultSet.getInt(TableConstants.SBOG_GAME_ID);
<span class="nc" id="L1339">				statementCommVariance = connection.createStatement();</span>
<span class="nc" id="L1340">				resultSetCommVariance = statementCommVariance</span>
						.executeQuery(getAgtCommVariance);
<span class="nc bnc" id="L1342" title="All 2 branches missed.">				while (resultSetCommVariance.next()) {</span>
<span class="nc" id="L1343">					agtGameCommVariace = resultSetCommVariance</span>
							.getDouble(&quot;sale_comm_variance&quot;);

				}
<span class="nc" id="L1347">				orderedGameBean.setAgtGameCommVariance(agtGameCommVariace);</span>

<span class="nc" id="L1349">				orderedGameBean.setPrizePayOutRatio(resultSet</span>
						.getDouble(&quot;prize_payout_ratio&quot;));
<span class="nc" id="L1351">				orderedGameBean.setVat(resultSet.getDouble(&quot;vat_amt&quot;));</span>
<span class="nc" id="L1352">				orderedGameBean.setGovtComm(resultSet</span>
						.getDouble(&quot;govt_comm_rate&quot;));
<span class="nc" id="L1354">				orderedGameBean.setVatBalance(resultSet</span>
						.getDouble(&quot;vat_balance&quot;));
<span class="nc" id="L1356">				orderedGameBean.setGovtCommRule(resultSet</span>
						.getString(&quot;govt_comm_type&quot;));
<span class="nc" id="L1358">				orderedGameBean.setFixedAmt(resultSet.getDouble(&quot;fixed_amt&quot;));</span>
<span class="nc" id="L1359">				orderedGameBean.setTicketsInScheme(resultSet</span>
						.getLong(&quot;tickets_in_scheme&quot;));

<span class="nc" id="L1362">				orderedGameBean.setGameNbrDigits(resultSet</span>
						.getInt(TableConstants.SGTNF_GAME_NBR_DIGITS));
<span class="nc" id="L1364">				orderedGameBean.setPackDigits(resultSet</span>
						.getInt(TableConstants.SGTNF_PACK_DIGITS));
<span class="nc" id="L1366">				orderedGameBean.setBookDigits(resultSet</span>
						.getInt(TableConstants.SGTNF_BOOK_DIGITS));

<span class="nc" id="L1369">				totalApprovedBooks = totalApprovedBooks</span>
						+ resultSet
								.getInt(TableConstants.SBOG_NBR_OF_BOOKS_APP);
<span class="nc" id="L1372">				orderedGameBean.setNbrOfBooksDlvrd(resultSet</span>
						.getInt(TableConstants.SBOG_NBR_OF_BOOKS_DLVRD));

<span class="nc" id="L1375">				nbrBooksToDispatch = resultSet</span>
						.getInt(TableConstants.SBOG_NBR_OF_BOOKS_APP)
						- resultSet
								.getInt(TableConstants.SBOG_NBR_OF_BOOKS_DLVRD);

<span class="nc" id="L1380">				orderedGameBean.setRemainingBooksToDispatch(nbrBooksToDispatch);</span>

<span class="nc" id="L1382">				orderedGameBean.setNbrOfBooksPerPack(resultSet</span>
						.getInt(TableConstants.SGM_NBR_OF_BOOKS_PER_PACK));
<span class="nc" id="L1384">				bookPrice = resultSet</span>
						.getInt(TableConstants.SGM_NBR_OF_TICKETS_PER_BOOK)
						* resultSet.getDouble(TableConstants.SGM_TICKET_PRICE);
<span class="nc" id="L1387">				orderedGameBean.setBookPrice(bookPrice);</span>
<span class="nc" id="L1388">				orderedGameBean.setAgtSaleCommRate(resultSet</span>
						.getDouble(TableConstants.SGM_AGT_SALE_RATE));
<span class="nc bnc" id="L1390" title="All 2 branches missed.">				if (!(nbrBooksToDispatch == 0)) {</span>
<span class="nc" id="L1391">					searchResults.add(orderedGameBean);</span>
				}
<span class="nc" id="L1393">			}</span>
<span class="nc" id="L1394">			this.setTotalOrderedBooks(totalApprovedBooks);</span>
<span class="nc" id="L1395">			System.out.println(&quot;----total  approved for order&quot;</span>
					+ totalApprovedBooks + &quot;---------&quot;);
<span class="nc" id="L1397">			return searchResults;</span>

<span class="nc" id="L1399">		} catch (SQLException e) {</span>

<span class="nc" id="L1401">			e.printStackTrace();</span>
<span class="nc" id="L1402">			throw new LMSException(e);</span>
		} finally {

<span class="nc" id="L1405">			try {</span>

<span class="nc bnc" id="L1407" title="All 4 branches missed.">				if (statement != null) {</span>
<span class="nc" id="L1408">					statement.close();</span>
				}
<span class="nc bnc" id="L1410" title="All 4 branches missed.">				if (connection != null) {</span>
<span class="nc" id="L1411">					connection.close();</span>
				}
<span class="nc" id="L1413">			} catch (SQLException se) {</span>
<span class="nc" id="L1414">				se.printStackTrace();</span>
<span class="nc" id="L1415">			}</span>
		}

		// return null;

	}

	/*
	 * This method generates the BO initiated order for the agent. Returns true
	 * if successfully generated @param cartList @param agtOrgList @param
	 * agtOrgName @return boolean @throws LMSException
	 */
	public int generateOrder(List&lt;GameBean&gt; cartList,
			List&lt;OrgBean&gt; agtOrgList, String agtOrgName) throws LMSException {

<span class="nc" id="L1430">		int agtOrgId = -1;</span>
<span class="nc" id="L1431">		int agtId = -1;</span>
<span class="nc bnc" id="L1432" title="All 2 branches missed.">		if (agtOrgList != null) {</span>
<span class="nc" id="L1433">			OrgBean bean = null;</span>
<span class="nc bnc" id="L1434" title="All 2 branches missed.">			for (int i = 0; i &lt; agtOrgList.size(); i++) {</span>
<span class="nc" id="L1435">				bean = agtOrgList.get(i);</span>
<span class="nc" id="L1436">				System.out.println(&quot;---OrG Name::&quot; + bean.getOrgName());</span>
<span class="nc bnc" id="L1437" title="All 2 branches missed.">				if (agtOrgName.equals(bean.getOrgName())) {</span>
<span class="nc" id="L1438">					agtOrgId = bean.getOrgId();</span>
<span class="nc" id="L1439">					agtId = bean.getUserId();</span>

<span class="nc" id="L1441">					break;</span>
				}
			}
		}

<span class="nc" id="L1446">		Connection connection = null;</span>
<span class="nc" id="L1447">		PreparedStatement orderPstmt = null;</span>
<span class="nc" id="L1448">		PreparedStatement gamePstmt = null;</span>

<span class="nc" id="L1450">		ResultSet resultSet = null;</span>
<span class="nc" id="L1451">		int orderId = -1;</span>

<span class="nc bnc" id="L1453" title="All 2 branches missed.">		if (cartList != null) {</span>
<span class="nc" id="L1454">			int size = cartList.size();</span>
<span class="nc" id="L1455">			QueryManager queryManager = null;</span>
<span class="nc" id="L1456">			GameBean gameBean = null;</span>

<span class="nc" id="L1458">			String orderQuery = null;</span>
<span class="nc" id="L1459">			String gameQuery = null;</span>

<span class="nc bnc" id="L1461" title="All 2 branches missed.">			if (size &gt; 0) {</span>
				try {

					// create database connection
					 
<span class="nc" id="L1466">					connection = DBConnect.getConnection();</span>
<span class="nc" id="L1467">					connection.setAutoCommit(false);</span>

<span class="nc" id="L1469">					orderQuery = QueryManager.getST1InsertBOOrderQuery();</span>
<span class="nc" id="L1470">					orderPstmt = connection.prepareStatement(orderQuery);</span>

<span class="nc" id="L1472">					gameQuery = QueryManager</span>
							.getST1AutoInsertBOOrderedGamesQuery();
<span class="nc" id="L1474">					gamePstmt = connection.prepareStatement(gameQuery);</span>

					// set parameters for insert into order table

<span class="nc" id="L1478">					orderPstmt.setInt(1, agtId);</span>
<span class="nc" id="L1479">					orderPstmt.setInt(2, agtOrgId);</span>
<span class="nc" id="L1480">					orderPstmt.setDate(3, new java.sql.Date(new Date()</span>
							.getTime()));

<span class="nc" id="L1483">					orderPstmt.setString(4, &quot;APPROVED&quot;);</span>
<span class="nc" id="L1484">					orderPstmt.setString(5, &quot;Y&quot;);</span>

<span class="nc" id="L1486">					orderPstmt.execute();</span>
<span class="nc" id="L1487">					resultSet = orderPstmt.getGeneratedKeys();</span>

<span class="nc bnc" id="L1489" title="All 2 branches missed.">					while (resultSet.next()) {</span>
<span class="nc" id="L1490">						orderId = resultSet.getInt(1);</span>
					}

<span class="nc" id="L1493">					System.out.println(&quot;OrderId::&quot; + orderId);</span>

					// set parameters for insert into ordered games table

<span class="nc bnc" id="L1497" title="All 2 branches missed.">					for (int i = 0; i &lt; size; i++) {</span>
<span class="nc" id="L1498">						gameBean = cartList.get(i);</span>

<span class="nc" id="L1500">						System.out.println(&quot;1:&quot; + gameBean.getGameId());</span>
<span class="nc" id="L1501">						System.out.println(&quot;2:&quot; + gameBean.getOrderedQty());</span>

<span class="nc" id="L1503">						gamePstmt.setInt(1, orderId);</span>
<span class="nc" id="L1504">						gamePstmt.setInt(2, gameBean.getGameId());</span>
<span class="nc" id="L1505">						gamePstmt.setInt(3, gameBean.getOrderedQty());</span>
<span class="nc" id="L1506">						gamePstmt.setInt(4, gameBean.getOrderedQty());</span>
<span class="nc" id="L1507">						gamePstmt.execute();</span>

					}

					// commit the connection

<span class="nc" id="L1513">					connection.commit();</span>
<span class="nc" id="L1514">					return orderId;</span>

<span class="nc" id="L1516">				} catch (SQLException e) {</span>

					try {
<span class="nc" id="L1519">						connection.rollback();</span>
<span class="nc" id="L1520">					} catch (SQLException e1) {</span>

<span class="nc" id="L1522">						e1.printStackTrace();</span>
<span class="nc" id="L1523">						throw new LMSException(&quot;Exception During Rollback&quot;, e1);</span>
<span class="nc" id="L1524">					}</span>
<span class="nc" id="L1525">					e.printStackTrace();</span>
<span class="nc" id="L1526">					throw new LMSException(e);</span>
				} finally {

<span class="nc" id="L1529">					try {</span>
<span class="nc bnc" id="L1530" title="All 4 branches missed.">						if (orderPstmt != null) {</span>
<span class="nc" id="L1531">							orderPstmt.close();</span>
						}
<span class="nc bnc" id="L1533" title="All 4 branches missed.">						if (gamePstmt != null) {</span>
<span class="nc" id="L1534">							gamePstmt.close();</span>
						}
<span class="nc bnc" id="L1536" title="All 4 branches missed.">						if (connection != null) {</span>
<span class="nc" id="L1537">							connection.close();</span>
						}
<span class="nc" id="L1539">					} catch (SQLException se) {</span>
<span class="nc" id="L1540">						se.printStackTrace();</span>
<span class="nc" id="L1541">					}</span>
				}

			}
		}
<span class="nc" id="L1546">		return orderId;</span>
	}

	/*
	 * This method returns the agent list for BO @return String @throws
	 * LMSException
	 */
	public List&lt;OrgBean&gt; getAgents(UserInfoBean userInfo) throws LMSException {

<span class="nc" id="L1555">		Connection connection = null;</span>
<span class="nc" id="L1556">		PreparedStatement statement = null;</span>
<span class="nc" id="L1557">		ResultSet resultSet = null;</span>
<span class="nc" id="L1558">		String delimiter = new String(&quot;-&quot;);</span>

		try {

<span class="nc" id="L1562">			OrgBean agentOrgBean = null;</span>
<span class="nc" id="L1563">			List&lt;OrgBean&gt; searchResults = new ArrayList&lt;OrgBean&gt;();</span>

			// create database connection
			 
<span class="nc" id="L1567">			connection = DBConnect.getConnection();</span>

			// fetch agents for BO
<span class="nc" id="L1570">			String query = QueryManager.getST1AgtOrgQuery(); // + &quot; group by</span>
			// name &quot;;

<span class="nc" id="L1573">			statement = connection.prepareStatement(query);</span>
<span class="nc" id="L1574">			statement.setInt(1, userInfo.getUserOrgId());</span>
<span class="nc" id="L1575">			System.out</span>
					.println(userInfo.getUserOrgId() + &quot;========&quot; + statement);
<span class="nc" id="L1577">			resultSet = statement.executeQuery();</span>

<span class="nc bnc" id="L1579" title="All 2 branches missed.">			while (resultSet.next()) {</span>

<span class="nc" id="L1581">				agentOrgBean = new OrgBean();</span>
<span class="nc" id="L1582">				agentOrgBean.setOrgId(resultSet</span>
						.getInt(TableConstants.SOM_ORG_ID));
<span class="nc" id="L1584">				agentOrgBean.setOrgName(resultSet</span>
						.getString(TableConstants.SOM_ORG_NAME));
<span class="nc" id="L1586">				agentOrgBean.setUserId(resultSet</span>
						.getInt(TableConstants.SUM_USER_ID));
<span class="nc" id="L1588">				System.out.println(agentOrgBean.getOrgName());</span>
<span class="nc" id="L1589">				searchResults.add(agentOrgBean);</span>

			}
<span class="nc" id="L1592">			System.out.println(&quot;=============&quot; + searchResults);</span>
<span class="nc" id="L1593">			return searchResults;</span>

<span class="nc" id="L1595">		} catch (SQLException e) {</span>

<span class="nc" id="L1597">			e.printStackTrace();</span>
<span class="nc" id="L1598">			throw new LMSException(e);</span>
		} finally {

<span class="nc" id="L1601">			try {</span>

<span class="nc bnc" id="L1603" title="All 4 branches missed.">				if (statement != null) {</span>
<span class="nc" id="L1604">					statement.close();</span>
				}
<span class="nc bnc" id="L1606" title="All 4 branches missed.">				if (connection != null) {</span>
<span class="nc" id="L1607">					connection.close();</span>
				}
<span class="nc" id="L1609">			} catch (SQLException se) {</span>
<span class="nc" id="L1610">				se.printStackTrace();</span>
<span class="nc" id="L1611">			}</span>
		}

		// return null;

	}

	/**
	 * This method returns a list of approved orders
	 * 
	 * @return List
	 * @throws LMSException
	 */
	public List getApprovedOrders() throws LMSException {

<span class="nc" id="L1626">		Connection connection = null;</span>
<span class="nc" id="L1627">		Statement statement = null;</span>
<span class="nc" id="L1628">		ResultSet resultSet = null;</span>
		try {

<span class="nc" id="L1631">			OrderBean orderBean = null;</span>
<span class="nc" id="L1632">			List&lt;OrderBean&gt; searchResults = new ArrayList&lt;OrderBean&gt;();</span>

			 
<span class="nc" id="L1635">			connection = DBConnect.getConnection();</span>
<span class="nc" id="L1636">			statement = connection.createStatement();</span>

<span class="nc" id="L1638">			String query = QueryManager.getST1AppOrderQuery();</span>

<span class="nc" id="L1640">			System.out.println(&quot;-----Query----::&quot; + query);</span>

<span class="nc" id="L1642">			resultSet = statement.executeQuery(query);</span>

<span class="nc bnc" id="L1644" title="All 2 branches missed.">			while (resultSet.next()) {</span>

<span class="nc" id="L1646">				orderBean = new OrderBean();</span>
<span class="nc" id="L1647">				orderBean.setOrderId(resultSet</span>
						.getInt(TableConstants.SBO_ORDER_ID));
<span class="nc" id="L1649">				orderBean.setAgentOrgId(resultSet</span>
						.getInt(TableConstants.SBO_AGENT_ORG_ID));
<span class="nc" id="L1651">				orderBean.setAgentOrgName(resultSet</span>
						.getString(TableConstants.SOM_ORG_NAME));
<span class="nc" id="L1653">				orderBean.setOrderDate(resultSet</span>
						.getDate(TableConstants.SBO_ORDER_DATE));

<span class="nc" id="L1656">				searchResults.add(orderBean);</span>

			}

<span class="nc" id="L1660">			return searchResults;</span>

<span class="nc" id="L1662">		} catch (SQLException e) {</span>

<span class="nc" id="L1664">			e.printStackTrace();</span>
<span class="nc" id="L1665">			throw new LMSException(e);</span>
		} finally {

<span class="nc" id="L1668">			try {</span>

<span class="nc bnc" id="L1670" title="All 4 branches missed.">				if (statement != null) {</span>
<span class="nc" id="L1671">					statement.close();</span>
				}
<span class="nc bnc" id="L1673" title="All 4 branches missed.">				if (connection != null) {</span>
<span class="nc" id="L1674">					connection.close();</span>
				}
<span class="nc" id="L1676">			} catch (SQLException se) {</span>
<span class="nc" id="L1677">				se.printStackTrace();</span>
<span class="nc" id="L1678">			}</span>
		}

		// return null;

	}

	private List&lt;String&gt; getBooksForPack(Connection connection, int gameId,
			String packNbr) throws SQLException {

<span class="nc" id="L1688">		String packQuery = null;</span>
<span class="nc" id="L1689">		PreparedStatement packStmt = null;</span>
<span class="nc" id="L1690">		List&lt;String&gt; bookList = new ArrayList&lt;String&gt;();</span>

<span class="nc" id="L1692">		packQuery = QueryManager.getST1BooksForPack();</span>
<span class="nc" id="L1693">		packStmt = connection.prepareStatement(packQuery);</span>

<span class="nc" id="L1695">		packStmt.setInt(1, gameId);</span>
<span class="nc" id="L1696">		packStmt.setString(2, packNbr);</span>

<span class="nc" id="L1698">		ResultSet rs = packStmt.executeQuery();</span>
<span class="nc bnc" id="L1699" title="All 2 branches missed.">		while (rs.next()) {</span>
<span class="nc" id="L1700">			bookList.add(rs.getString(TableConstants.SGIS_BOOK_NBR));</span>
		}

<span class="nc" id="L1703">		return bookList;</span>
	}

	private java.sql.Date getDate(String date) {

<span class="nc" id="L1708">		System.out.println(&quot;Passed date::&quot; + date);</span>
<span class="nc" id="L1709">		String format = &quot;yyyy-MM-dd&quot;;</span>
<span class="nc" id="L1710">		DateFormat dateFormat = new SimpleDateFormat(format);</span>
		try {

<span class="nc" id="L1713">			Date parsedDate = dateFormat.parse(date);</span>
<span class="nc" id="L1714">			System.out.println(&quot;Parsed date::&quot; + parsedDate);</span>
<span class="nc" id="L1715">			System.out.println(new java.sql.Date(parsedDate.getTime()));</span>
<span class="nc" id="L1716">			return new java.sql.Date(parsedDate.getTime());</span>

<span class="nc" id="L1718">		} catch (ParseException e) {</span>

<span class="nc" id="L1720">			e.printStackTrace();</span>
		}
<span class="nc" id="L1722">		return null;</span>
	}

	private int getDispatchedNbrOfBooks(InvOrderBean invOrderBean,
			int nbrOfBooksPerPack) {

<span class="nc" id="L1728">		List&lt;PackBean&gt; packList = invOrderBean.getPackList();</span>
<span class="nc" id="L1729">		List&lt;BookBean&gt; bookList = invOrderBean.getBookList();</span>

<span class="nc" id="L1731">		PackBean packBean = null;</span>
<span class="nc" id="L1732">		BookBean bookBean = null;</span>

<span class="nc" id="L1734">		int packCount = 0;</span>
<span class="nc" id="L1735">		int bookCount = 0;</span>

<span class="nc bnc" id="L1737" title="All 2 branches missed.">		if (packList != null) {</span>
<span class="nc bnc" id="L1738" title="All 2 branches missed.">			for (int i = 0; i &lt; packList.size(); i++) {</span>
<span class="nc" id="L1739">				packBean = packList.get(i);</span>
<span class="nc bnc" id="L1740" title="All 2 branches missed.">				if (packBean.getIsValid()) {</span>
<span class="nc" id="L1741">					packCount++;</span>
				}
			}
		}
<span class="nc bnc" id="L1745" title="All 2 branches missed.">		if (bookList != null) {</span>
<span class="nc bnc" id="L1746" title="All 2 branches missed.">			for (int i = 0; i &lt; bookList.size(); i++) {</span>
<span class="nc" id="L1747">				bookBean = bookList.get(i);</span>
<span class="nc bnc" id="L1748" title="All 2 branches missed.">				if (bookBean.getIsValid()) {</span>
<span class="nc" id="L1749">					bookCount++;</span>
				}
			}
		}

<span class="nc" id="L1754">		int totalBooks = bookCount + packCount * nbrOfBooksPerPack;</span>
<span class="nc" id="L1755">		return totalBooks;</span>
	}

	public int getGameID() {

<span class="nc" id="L1760">		return gameID;</span>
	}

	private String getPackNbrForBook(Connection connection, int gameId,
			String bookNbr) throws SQLException {

<span class="nc" id="L1766">		String bookQuery = null;</span>
<span class="nc" id="L1767">		PreparedStatement bookStmt = null;</span>
<span class="nc" id="L1768">		String packNbr = null;</span>

<span class="nc" id="L1770">		bookQuery = QueryManager.getST1PackForBook();</span>
<span class="nc" id="L1771">		bookStmt = connection.prepareStatement(bookQuery);</span>

<span class="nc" id="L1773">		bookStmt.setInt(1, gameId);</span>
<span class="nc" id="L1774">		bookStmt.setString(2, bookNbr);</span>

<span class="nc" id="L1776">		ResultSet rs = bookStmt.executeQuery();</span>
<span class="nc bnc" id="L1777" title="All 2 branches missed.">		while (rs.next()) {</span>
<span class="nc" id="L1778">			packNbr = rs.getString(TableConstants.SGIS_PACK_NBR);</span>
		}
<span class="nc" id="L1780">		return packNbr;</span>

	}

	public int getTotalOrderedBooks() {
<span class="nc" id="L1785">		return totalOrderedBooks;</span>
	}

	private String getWhereClause(Map searchMap) {
<span class="nc" id="L1789">		Set keySet = null;</span>
<span class="nc" id="L1790">		StringBuffer whereClause = new StringBuffer();</span>

<span class="nc bnc" id="L1792" title="All 2 branches missed.">		if (searchMap != null) {</span>
<span class="nc" id="L1793">			keySet = searchMap.keySet();</span>

<span class="nc" id="L1795">			Iterator itr = keySet.iterator();</span>
<span class="nc" id="L1796">			String key = null;</span>
			String strValue;

<span class="nc" id="L1799">			int fieldAdded = 1;</span>

<span class="nc bnc" id="L1801" title="All 2 branches missed.">			while (itr.hasNext()) {</span>
<span class="nc" id="L1802">				key = (String) itr.next();</span>
<span class="nc bnc" id="L1803" title="All 2 branches missed.">				if (key.equals(GameContants.GAME_NAME)) {</span>
<span class="nc" id="L1804">					strValue = (String) searchMap.get(key);</span>

<span class="nc bnc" id="L1806" title="All 4 branches missed.">					if (strValue != null &amp;&amp; !strValue.equals(&quot;&quot;)) {</span>
<span class="nc bnc" id="L1807" title="All 2 branches missed.">						if (fieldAdded &gt; 0) {</span>
<span class="nc" id="L1808">							whereClause.append(&quot; And &quot;);</span>
						}

<span class="nc" id="L1811">						whereClause.append(TableConstants.SGM_GAME_NAME);</span>
<span class="nc" id="L1812">						whereClause.append(&quot; like '&quot;);</span>
<span class="nc" id="L1813">						whereClause.append(strValue.trim());</span>
<span class="nc" id="L1814">						whereClause.append(&quot;%' &quot;);</span>

<span class="nc" id="L1816">						fieldAdded++;</span>
					}
				}

<span class="nc bnc" id="L1820" title="All 2 branches missed.">				else if (key.equals(GameContants.GAME_NBR)) {</span>

<span class="nc" id="L1822">					strValue = (String) searchMap.get(key);</span>
<span class="nc bnc" id="L1823" title="All 4 branches missed.">					if (strValue != null &amp;&amp; !strValue.equals(&quot;&quot;)) {</span>

<span class="nc bnc" id="L1825" title="All 2 branches missed.">						if (fieldAdded &gt; 0) {</span>
<span class="nc" id="L1826">							whereClause.append(&quot; And &quot;);</span>
						}

<span class="nc" id="L1829">						whereClause.append(TableConstants.SGM_GAME_NBR);</span>
<span class="nc" id="L1830">						whereClause.append(&quot; = '&quot;);</span>
<span class="nc" id="L1831">						whereClause.append(strValue.trim());</span>
<span class="nc" id="L1832">						whereClause.append(&quot;'&quot;);</span>
<span class="nc" id="L1833">						fieldAdded++;</span>

					}

<span class="nc bnc" id="L1837" title="All 2 branches missed.">				} else if (key.equals(TableConstants.ORG_NAME)) {</span>

<span class="nc" id="L1839">					strValue = (String) searchMap.get(key);</span>
<span class="nc" id="L1840">					System.out.println(strValue + &quot;...............Status&quot;);</span>
<span class="nc bnc" id="L1841" title="All 4 branches missed.">					if (strValue != null &amp;&amp; !strValue.equals(&quot;&quot;)) {</span>

<span class="nc bnc" id="L1843" title="All 2 branches missed.">						if (fieldAdded &gt; 0) {</span>
<span class="nc" id="L1844">							whereClause.append(&quot; And &quot;);</span>
						}

<span class="nc" id="L1847">						whereClause.append(TableConstants.ORG_NAME);</span>
<span class="nc" id="L1848">						whereClause.append(&quot; like '&quot;);</span>
<span class="nc" id="L1849">						whereClause.append(strValue.trim());</span>
<span class="nc" id="L1850">						whereClause.append(&quot;%'&quot;);</span>

<span class="nc" id="L1852">						fieldAdded++;</span>

					}
				}

<span class="nc bnc" id="L1857" title="All 2 branches missed.">				else if (key.equals(TableConstants.SBO_ORDER_STATUS)) {</span>

<span class="nc" id="L1859">					strValue = (String) searchMap.get(key);</span>

<span class="nc bnc" id="L1861" title="All 4 branches missed.">					if (strValue != null &amp;&amp; !strValue.equals(&quot;&quot;)) {</span>

<span class="nc bnc" id="L1863" title="All 2 branches missed.">						if (fieldAdded &gt; 0) {</span>
<span class="nc" id="L1864">							whereClause.append(&quot; And &quot;);</span>
						}

<span class="nc" id="L1867">						whereClause.append(TableConstants.SBO_ORDER_STATUS);</span>
<span class="nc" id="L1868">						whereClause.append(&quot; = '&quot;);</span>
<span class="nc" id="L1869">						whereClause.append(strValue.trim());</span>
<span class="nc" id="L1870">						whereClause.append(&quot;' &quot;);</span>

<span class="nc" id="L1872">						fieldAdded++;</span>
					}
				}

<span class="nc bnc" id="L1876" title="All 2 branches missed.">				else if (key.equals(GameContants.ORDER_ID)) {</span>
<span class="nc" id="L1877">					String str1 = &quot;-1&quot;;</span>
<span class="nc" id="L1878">					str1 = (String) searchMap.get(key);</span>

<span class="nc bnc" id="L1880" title="All 4 branches missed.">					if (str1 != null &amp;&amp; !str1.equals(&quot;&quot;)) {</span>

<span class="nc bnc" id="L1882" title="All 2 branches missed.">						if (fieldAdded &gt; 0) {</span>
<span class="nc" id="L1883">							whereClause.append(&quot; And &quot;);</span>
						}

<span class="nc" id="L1886">						whereClause.append(&quot;sbo.&quot; + GameContants.ORDER_ID);</span>
<span class="nc" id="L1887">						whereClause.append(&quot; = '&quot;);</span>
<span class="nc" id="L1888">						whereClause.append(str1.trim());</span>
<span class="nc" id="L1889">						whereClause.append(&quot;' &quot;);</span>

<span class="nc" id="L1891">						fieldAdded++;</span>
					}
<span class="nc" id="L1893">				}</span>

			}
<span class="nc bnc" id="L1896" title="All 2 branches missed.">			if (fieldAdded == 1) {</span>
<span class="nc" id="L1897">				whereClause.append(&quot; and 1=1 &quot;);</span>
			}

		}

<span class="nc" id="L1902">		return whereClause.toString();</span>
	}

	/**
	 * This method returns the list of order based on the search parameters
	 * passed
	 * 
	 * @param searchMap
	 * @return List
	 * @throws LMSException
	 */
	public List SearchOrder(Map searchMap, int roleId) throws LMSException {

<span class="nc" id="L1915">		Connection connection = null;</span>
<span class="nc" id="L1916">		Statement statement = null;</span>
<span class="nc" id="L1917">		ResultSet resultSet = null;</span>
<span class="nc" id="L1918">		Statement statement1 = null;</span>
<span class="nc" id="L1919">		ResultSet resultSet1 = null;</span>
		try {

<span class="nc" id="L1922">			OrderBean orderBean = null;</span>
<span class="nc" id="L1923">			List&lt;OrderBean&gt; searchResults = new ArrayList&lt;OrderBean&gt;();</span>

			 
<span class="nc" id="L1926">			connection = DBConnect.getConnection();</span>
<span class="nc" id="L1927">			statement = connection.createStatement();</span>
<span class="nc" id="L1928">			statement1 = connection.createStatement();</span>

<span class="nc" id="L1930">			String query = CommonMethods.appendRoleAgentMappingQuery(QueryManager.getST1AppOrderQuery(), &quot;agent_org_id&quot;,roleId)</span>
					+ getWhereClause(searchMap) + &quot; group by order_id&quot;;

<span class="nc" id="L1933">			System.out.println(&quot;-----Query----::&quot; + query);</span>
<span class="nc" id="L1934">			resultSet = statement.executeQuery(query);</span>

<span class="nc bnc" id="L1936" title="All 2 branches missed.">			while (resultSet.next()) {</span>

<span class="nc" id="L1938">				orderBean = new OrderBean();</span>
<span class="nc" id="L1939">				orderBean.setOrderId(resultSet</span>
						.getInt(TableConstants.SBO_ORDER_ID));
<span class="nc" id="L1941">				orderBean.setAgentOrgId(resultSet</span>
						.getInt(TableConstants.SBO_AGENT_ORG_ID));
<span class="nc" id="L1943">				orderBean.setAgentOrgName(resultSet</span>
						.getString(TableConstants.SOM_ORG_NAME));

<span class="nc" id="L1946">				orderBean.setOrderDate(resultSet</span>
						.getDate(TableConstants.SBO_ORDER_DATE));

<span class="nc bnc" id="L1949" title="All 2 branches missed.">				if (resultSet.getString(TableConstants.SBO_ORDER_STATUS)</span>
						.equalsIgnoreCase(&quot;APPROVED&quot;)) {
<span class="nc" id="L1951">					orderBean.setOrderStatus(&quot;Approved&quot;);</span>

				}
<span class="nc bnc" id="L1954" title="All 2 branches missed.">				if (resultSet.getString(TableConstants.SBO_ORDER_STATUS)</span>
						.equalsIgnoreCase(&quot;PROCESSED&quot;)) {
<span class="nc" id="L1956">					orderBean.setOrderStatus(&quot;Processed&quot;);</span>

				}
<span class="nc bnc" id="L1959" title="All 2 branches missed.">				if (resultSet.getString(TableConstants.SBO_ORDER_STATUS)</span>
						.equalsIgnoreCase(&quot;SEMI_PROCESSED&quot;)) {
<span class="nc" id="L1961">					orderBean.setOrderStatus(&quot;Semi Processed&quot;);</span>

				}

<span class="nc" id="L1965">				searchResults.add(orderBean);</span>

			}

<span class="nc" id="L1969">			return searchResults;</span>

<span class="nc" id="L1971">		} catch (SQLException e) {</span>

<span class="nc" id="L1973">			e.printStackTrace();</span>
<span class="nc" id="L1974">			throw new LMSException(e);</span>

		} finally {

<span class="nc" id="L1978">			try {</span>

<span class="nc bnc" id="L1980" title="All 4 branches missed.">				if (statement != null) {</span>
<span class="nc" id="L1981">					statement.close();</span>
				}
<span class="nc bnc" id="L1983" title="All 4 branches missed.">				if (connection != null) {</span>
<span class="nc" id="L1984">					connection.close();</span>
				}
<span class="nc" id="L1986">			} catch (SQLException se) {</span>
<span class="nc" id="L1987">				se.printStackTrace();</span>
<span class="nc" id="L1988">			}</span>
		}

		// return null;

	}

	public void setGameID(int gameID) {
<span class="nc" id="L1996">		this.gameID = gameID;</span>
<span class="nc" id="L1997">	}</span>

	public void setTotalOrderedBooks(int totalOrderedBooks) {
<span class="nc" id="L2000">		this.totalOrderedBooks = totalOrderedBooks;</span>
<span class="nc" id="L2001">	}</span>

	/**
	 * This method is used to Close the Status of the Order.
	 * 
	 * @param oderId
	 * @param status
	 * @return
	 * @throws LMSException
	 */

	public boolean SuccessStatusUpdate(int oderId, String status)
			throws LMSException {

<span class="nc" id="L2015">		Connection connection = null;</span>
<span class="nc" id="L2016">		PreparedStatement statement = null;</span>
<span class="nc" id="L2017">		PreparedStatement statement1 = null;</span>
<span class="nc" id="L2018">		ResultSet resultSet = null;</span>
		try {

<span class="nc" id="L2021">			OrderBean orderBean = null;</span>
<span class="nc" id="L2022">			List&lt;OrderBean&gt; searchResults = new ArrayList&lt;OrderBean&gt;();</span>

			 
<span class="nc" id="L2025">			connection = DBConnect.getConnection();</span>
<span class="nc" id="L2026">			String query = QueryManager.getST1AppOrderQuery();</span>
			// String query1=&quot;update st_se_bo_order set order_status=? where
			// order_id=?&quot;;
<span class="nc" id="L2029">			String query1 = QueryManager.getST5UpdateBOorderQuery();</span>
<span class="nc" id="L2030">			String query2 = QueryManager.getST5UpdateBOorderInvoicesQuery();</span>
			// String query2=&quot;update st_se_bo_order_invoices set order_status=?
			// where order_id=?&quot;;
<span class="nc" id="L2033">			System.out.println(&quot;-----Query----::&quot; + query);</span>
<span class="nc" id="L2034">			statement = connection.prepareStatement(query1);</span>
<span class="nc" id="L2035">			statement1 = connection.prepareStatement(query2);</span>

<span class="nc" id="L2037">			statement.setString(1, status);</span>
<span class="nc" id="L2038">			statement.setInt(2, oderId);</span>
<span class="nc" id="L2039">			int ii = statement.executeUpdate();</span>

<span class="nc" id="L2041">			statement1.setString(1, status);</span>
<span class="nc" id="L2042">			statement1.setInt(2, oderId);</span>
<span class="nc" id="L2043">			int i = statement1.executeUpdate();</span>
<span class="nc bnc" id="L2044" title="All 4 branches missed.">			if (i &gt; 0 || ii &gt; 0) {</span>

<span class="nc" id="L2046">				return true;</span>
			} else {
<span class="nc" id="L2048">				return false;</span>
			}

<span class="nc" id="L2051">		} catch (SQLException e) {</span>

<span class="nc" id="L2053">			e.printStackTrace();</span>
<span class="nc" id="L2054">			throw new LMSException(e);</span>
		} finally {

<span class="nc" id="L2057">			try {</span>

<span class="nc bnc" id="L2059" title="All 6 branches missed.">				if (statement != null) {</span>
<span class="nc" id="L2060">					statement.close();</span>
				}
<span class="nc bnc" id="L2062" title="All 6 branches missed.">				if (connection != null) {</span>
<span class="nc" id="L2063">					connection.close();</span>
				}
<span class="nc" id="L2065">			} catch (SQLException se) {</span>
<span class="nc" id="L2066">				se.printStackTrace();</span>
<span class="nc" id="L2067">			}</span>
		}

		// return null;

	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>