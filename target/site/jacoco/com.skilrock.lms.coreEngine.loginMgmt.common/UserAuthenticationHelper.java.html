<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UserAuthenticationHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lms</a> &gt; <a href="index.source.html" class="el_package">com.skilrock.lms.coreEngine.loginMgmt.common</a> &gt; <span class="el_source">UserAuthenticationHelper.java</span></div><h1>UserAuthenticationHelper.java</h1><pre class="source lang-java linenums">package com.skilrock.lms.coreEngine.loginMgmt.common;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.sql.Time;
import java.sql.Timestamp;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Locale;

import javax.servlet.ServletContext;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.apache.struts2.ServletActionContext;

import com.skilrock.lms.beans.LoginBean;
import com.skilrock.lms.beans.PriviledgeBean;
import com.skilrock.lms.beans.ServicesBean;
import com.skilrock.lms.beans.UserInfoBean;
import com.skilrock.lms.common.ConfigurationVariables;
import com.skilrock.lms.common.Utility;
import com.skilrock.lms.common.db.DBConnect;
import com.skilrock.lms.common.db.TableConstants;
import com.skilrock.lms.common.exception.LMSErrors;
import com.skilrock.lms.common.exception.LMSException;
import com.skilrock.lms.common.filter.LMSFilterDispatcher;
import com.skilrock.lms.common.utility.CommonMethods;
import com.skilrock.lms.common.utility.LMSUtility;
import com.skilrock.lms.common.utility.MD5Encoder;
import com.skilrock.lms.web.drawGames.common.Util;

<span class="nc" id="L40">public class UserAuthenticationHelper {</span>
<span class="nc" id="L41">	static Log logger = LogFactory.getLog(UserAuthenticationHelper.class);</span>

	public static String fetchOrgMasterUserEmail(int orgId) {
<span class="nc" id="L44">		String email = null;</span>
<span class="nc" id="L45">		Connection con = DBConnect.getConnection();</span>
		try {
<span class="nc" id="L47">			PreparedStatement ps = con</span>
					.prepareStatement(&quot;select email_id, first_name, last_name from st_lms_user_contact_details slucd,(select user_id from st_lms_user_master slum, st_lms_role_master slrm where slum.organization_id = ? and slum.isrolehead = 'Y' and slum.role_id = slrm.role_id and slrm.is_master = 'Y' )sub where sub.user_id = slucd.user_id&quot;);
<span class="nc" id="L49">			ps.setInt(1, orgId);</span>
<span class="nc" id="L50">			ResultSet rs = ps.executeQuery();</span>
<span class="nc bnc" id="L51" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L52">				email = rs.getString(&quot;email_id&quot;);</span>
			}
<span class="nc" id="L54">		} catch (SQLException e) {</span>
<span class="nc" id="L55">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L57">			try {</span>
<span class="nc" id="L58">				con.close();</span>
<span class="nc" id="L59">			} catch (SQLException e) {</span>
<span class="nc" id="L60">				e.printStackTrace();</span>
<span class="nc" id="L61">			}</span>
<span class="nc" id="L62">		}</span>
<span class="nc" id="L63">		return email;</span>
	}

	public static String fetchUserFirstLastName(int userId) {
<span class="nc" id="L67">		String name = null;</span>
<span class="nc" id="L68">		Connection con = DBConnect.getConnection();</span>
		try {
<span class="nc" id="L70">			PreparedStatement ps = con</span>
					.prepareStatement(&quot;select first_name, last_name from st_lms_user_contact_details where user_id = ?&quot;);
<span class="nc" id="L72">			ps.setInt(1, userId);</span>
<span class="nc" id="L73">			ResultSet rs = ps.executeQuery();</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L75">				name = rs.getString(&quot;first_name&quot;) + &quot; &quot;</span>
						+ rs.getString(&quot;last_name&quot;);
			}
<span class="nc" id="L78">		} catch (SQLException e) {</span>
<span class="nc" id="L79">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L81">			try {</span>
<span class="nc" id="L82">				con.close();</span>
<span class="nc" id="L83">			} catch (SQLException e) {</span>
<span class="nc" id="L84">				e.printStackTrace();</span>
<span class="nc" id="L85">			}</span>
<span class="nc" id="L86">		}</span>
<span class="nc" id="L87">		return name;</span>
	}

	/*public static void main(String[] args) {
		LoginBean lb = new UserAuthenticationHelper().loginAuthentication(&quot;va&quot;,
				&quot;12345678&quot;, &quot;WEB&quot;, 3 + &quot;&quot;,&quot;EWQQW12123113ASDADSDA&quot;,true);
		System.out.println(lb.getActionServiceMap());
	}*/

	
<span class="nc" id="L97">	boolean loggedInResult = false;</span>

<span class="nc" id="L99">	LoginBean loginBean = new LoginBean();</span>


<span class="nc" id="L102">	ArrayList&lt;String&gt; userActionList = new ArrayList&lt;String&gt;();</span>

	private UserInfoBean userInfo;

	public boolean loggedInUser(String user) {
		if (!ConfigurationVariables.USER_RELOGIN_SESSION_TERMINATE) {
			ServletContext sc = ServletActionContext.getServletContext();
			List&lt;String&gt; currentUserList = (List&lt;String&gt;) sc
					.getAttribute(&quot;LOGGED_IN_USERS&quot;);
			if (currentUserList == null) {
				currentUserList = new ArrayList&lt;String&gt;();
				sc.setAttribute(&quot;LOGGED_IN_USERS&quot;, currentUserList);
				currentUserList.add(user);
			} else {
				if (currentUserList.contains(user)) {
					return false;
				} else {
					currentUserList.add(user);
				}
			}
		}
<span class="nc" id="L123">		return true;</span>
	}

	
	public LoginBean loginAuthentication(String username, String password,
			String interface_type, String loginLimit,Connection con,String sessionId,boolean isIpTimingCheck) throws LMSException {
		//Connection con=null;
<span class="nc" id="L130">		PreparedStatement pstmt=null;</span>
<span class="nc" id="L131">		PreparedStatement pstmtPriv=null;</span>
<span class="nc" id="L132">		PreparedStatement pstmtPriv1=null;</span>
<span class="nc" id="L133">		ResultSet rs=null;</span>
<span class="nc" id="L134">		ResultSet rsPriv=null;</span>
		try {
			//con = DBConnect.getConnection();
            //here check the terminal staus on this server
<span class="nc" id="L138">			String dbPass = &quot;&quot;; // stores the password retrieved from the</span>
			// database.
<span class="nc" id="L140">			int autoGenerate = 0;</span>
<span class="nc" id="L141">			String role = &quot;&quot;;</span>
<span class="nc" id="L142">			int roleId = 0;</span>
<span class="nc" id="L143">			String roleName = &quot;&quot;;</span>
<span class="nc" id="L144">			String unam = &quot;&quot;;</span>
<span class="nc" id="L145">			String status = &quot;&quot;;</span>
<span class="nc" id="L146">			int uid = -1;</span>
<span class="nc" id="L147">			int userMapid = 0;</span>
<span class="nc" id="L148">			String orgStatus = &quot;&quot;;</span>
<span class="nc" id="L149">			String orgName = &quot;&quot;;</span>
<span class="nc" id="L150">			String orgId = &quot;&quot;;</span>
<span class="nc" id="L151">			int parentOrgId = 0;</span>
<span class="nc" id="L152">			int tierId = 0;</span>
<span class="nc" id="L153">			String parentOrgName = &quot;&quot;;</span>
<span class="nc" id="L154">			String parentOrgCode=&quot;&quot;;</span>
<span class="nc" id="L155">			logger.debug(&quot;inside Auth Helper&quot;);</span>
<span class="nc" id="L156">			String orgCodeQry = &quot;  bb.name orgCode &quot;;</span>

			
<span class="nc bnc" id="L159" title="All 2 branches missed.">			if ((LMSFilterDispatcher.orgFieldType).equalsIgnoreCase(&quot;CODE&quot;)) {</span>
<span class="nc" id="L160">				orgCodeQry = &quot;  bb.org_code orgCode  &quot;;</span>


<span class="nc bnc" id="L163" title="All 2 branches missed.">			} else if ((LMSFilterDispatcher.orgFieldType)</span>
					.equalsIgnoreCase(&quot;CODE_NAME&quot;)) {
<span class="nc" id="L165">				orgCodeQry = &quot; concat(bb.org_code,'_',bb.name)  orgCode  &quot;;</span>
			

<span class="nc bnc" id="L168" title="All 2 branches missed.">			} else if ((LMSFilterDispatcher.orgFieldType)</span>
					.equalsIgnoreCase(&quot;NAME_CODE&quot;)) {
<span class="nc" id="L170">				orgCodeQry = &quot; concat(bb.name,'_',bb.org_code)  orgCode &quot;;</span>
			

			}
<span class="nc" id="L174">			String getUserDetailsQuery = &quot;select user_session , if(aa.organization_type = 'RETAILER' , (select user_mapping_id from st_lms_user_random_id_mapping where user_id = aa.user_id) , 0) user_mapping_id, aa.user_id, aa.organization_id,aa.isrolehead,cc.is_master, aa.role_id,cc.tier_id, aa.user_name, aa.password, aa.status, aa.organization_type,bb.organization_status , aa.auto_password, aa.login_attempts&quot;</span>
				+ &quot;, bb.name,bb.org_code,&quot;+orgCodeQry+&quot; , bb.organization_status, bb.current_credit_amt, bb.available_credit, bb.claimable_bal, bb.unclaimable_bal, bb.parent_id, bb.pwt_scrap, cc.role_name,if(login_attempts&lt;&quot;
				+ loginLimit
				+ &quot;,'ALLOW','BLOCK') logginAttempt ,bb.tp_organization istp &quot;
				+ &quot;from st_lms_user_master aa, st_lms_organization_master bb, st_lms_role_master cc &quot;
				+ &quot;where aa.organization_id = bb.organization_id	and aa.user_name =? and aa.role_id = cc.role_id&quot;;

			// UPDATE SESSION FOR USER
<span class="nc" id="L182">			Statement stmt = con.createStatement();</span>
<span class="nc" id="L183">			int count = stmt.executeUpdate(&quot;update st_lms_user_master set user_session = '&quot;+sessionId +&quot;' where user_name = '&quot;+username.trim()+&quot;'&quot;);</span>
<span class="nc" id="L184">			logger.info(count + &quot; Rows updated&quot;);</span>
			
			
<span class="nc" id="L187">			pstmt = con.prepareStatement(getUserDetailsQuery);</span>
<span class="nc" id="L188">			pstmt.setString(1, username.trim());</span>

<span class="nc" id="L190">			rs = pstmt.executeQuery();</span>
<span class="nc" id="L191">			logger.debug(pstmt);</span>

			// check More Then One Users Exist in the Database or not with Same
			// user_name
<span class="nc bnc" id="L195" title="All 2 branches missed.">			if (rs.getFetchSize() &gt; 1) {</span>
<span class="nc" id="L196">				logger</span>
						.debug(&quot;More Then One User Exist in the Database with Same  user_name&quot;
								+ username);
<span class="nc" id="L199">				loginBean.setStatus(&quot;ERROR&quot;);</span>
<span class="nc" id="L200">				return loginBean;</span>
			}

			// getting the user details from database
<span class="nc bnc" id="L204" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L205">				dbPass = rs.getString(TableConstants.USER_PASSWORD);</span>
<span class="nc" id="L206">				role = rs.getString(TableConstants.ORG_TYPE);// This is tier</span>
				// Code
<span class="nc" id="L208">				tierId = rs.getInt(TableConstants.TIER_ID);</span>
<span class="nc" id="L209">				roleId = rs.getInt(TableConstants.ROLE_ID);</span>
<span class="nc" id="L210">				status = rs.getString(TableConstants.USER_STATUS);</span>
<span class="nc" id="L211">				unam = rs.getString(TableConstants.USER_NAME);</span>
<span class="nc" id="L212">				uid = rs.getInt(TableConstants.USER_ID);</span>
<span class="nc" id="L213">				userMapid = rs.getInt(TableConstants.MAPPING_ID);</span>
<span class="nc" id="L214">				orgId = rs.getString(TableConstants.ORG_ID);</span>
<span class="nc" id="L215">				orgName = rs.getString(TableConstants.ORGANIZATION_NAME);</span>
<span class="nc" id="L216">				roleName = rs.getString(TableConstants.ROLE_NAME);</span>
<span class="nc" id="L217">				autoGenerate = rs.getInt(&quot;auto_password&quot;);</span>
<span class="nc" id="L218">				parentOrgId = rs.getInt(&quot;parent_id&quot;);</span>
<span class="nc" id="L219">				orgStatus = rs.getString(&quot;organization_status&quot;);</span>

<span class="nc" id="L221">				userInfo = new UserInfoBean();</span>
<span class="nc" id="L222">				userInfo.setRoleName(rs.getString(TableConstants.ROLE_NAME));</span>
<span class="nc" id="L223">				userInfo.setRoleId(roleId);</span>
<span class="nc" id="L224">				userInfo.setUserId(uid);</span>
<span class="nc" id="L225">				userInfo.setCurrentUserMappingId(userMapid);</span>
<span class="nc" id="L226">				userInfo.setUserName(username);</span>
<span class="nc" id="L227">				userInfo.setUserOrgId(rs.getInt(TableConstants.ORG_ID));</span>
<span class="nc" id="L228">				userInfo.setUserType(role);</span>
<span class="nc" id="L229">				userInfo.setTierId(tierId);</span>
<span class="nc" id="L230">				userInfo.setOrgName(orgName);</span>
<span class="nc" id="L231">				userInfo.setOrgCode(rs.getString(&quot;orgCode&quot;));</span>
<span class="nc" id="L232">				userInfo.setUserOrgCode(rs.getString(&quot;org_code&quot;));</span>
<span class="nc" id="L233">				userInfo.setAvailableCreditLimit(rs</span>
						.getDouble(TableConstants.SOM_AVAILABLE_CREDIT));
<span class="nc" id="L235">				userInfo.setClaimableBal(rs.getDouble(&quot;claimable_bal&quot;));</span>
<span class="nc" id="L236">				userInfo.setUnclaimableBal(rs.getDouble(&quot;unclaimable_bal&quot;));</span>
<span class="nc" id="L237">				userInfo.setCurrentCreditAmt(rs</span>
						.getDouble(TableConstants.CURRENT_CREDIT_AMT));
<span class="nc" id="L239">				userInfo.setStatus(status);</span>
<span class="nc" id="L240">				userInfo.setOrgStatus(rs.getString(TableConstants.ORG_STATUS));</span>
<span class="nc" id="L241">				userInfo.setPwtSacrap(rs.getString(&quot;pwt_scrap&quot;));</span>
<span class="nc" id="L242">				userInfo.setParentOrgId(parentOrgId);</span>
<span class="nc" id="L243">				userInfo.setIsMasterRole(rs.getString(&quot;is_master&quot;));</span>
<span class="nc" id="L244">				userInfo.setIsRoleHeadUser(rs.getString(&quot;isrolehead&quot;));</span>
<span class="nc" id="L245">				userInfo.setTPUser(&quot;YES&quot;.equalsIgnoreCase(rs.getString(&quot;istp&quot;)));</span>
<span class="nc" id="L246">				userInfo.setLoginChannel(interface_type);</span>
<span class="nc" id="L247">				userInfo.setUserSession(rs.getString(&quot;user_session&quot;));</span>
			}
			// check the user's info before login
			else {
<span class="nc" id="L251">				loginBean.setStatus(&quot;USER_NAME_NOT_MATCH&quot;);</span>
<span class="nc" id="L252">				return loginBean;</span>
			}

<span class="nc bnc" id="L255" title="All 2 branches missed.">			if (&quot;BLOCK&quot;.equals(rs.getString(&quot;logginAttempt&quot;))) {</span>
<span class="nc" id="L256">				loginBean.setStatus(&quot;LOGIN_LIMIT_REACHED&quot;);</span>
<span class="nc" id="L257">				return loginBean;</span>
			}
			
			//Here matching Time of Login 		
<span class="nc bnc" id="L261" title="All 4 branches missed.">			if(isIpTimingCheck &amp;&amp; !getTimeLimitStatus(uid,con))</span>
			{
<span class="nc" id="L263">				logger.info(&quot;TIME LIMIT STATUS - Time Limit is exceeded for this user&quot;);</span>
<span class="nc" id="L264">				loginBean.setStatus(&quot;ERROR_TIME_LIMIT&quot;);</span>
<span class="nc" id="L265">				return loginBean;</span>
			}

<span class="nc" id="L268">			String reason = null;</span>
<span class="nc" id="L269">			con.setAutoCommit(false);</span>
			// Matching Password
<span class="nc bnc" id="L271" title="All 4 branches missed.">			if (MD5Encoder.encode(password).equals(dbPass) || userInfo.isTPUser()) {</span>
				// checking the user status
<span class="nc bnc" id="L273" title="All 8 branches missed.">				if (status.equals(&quot;BLOCK&quot;) || status.equals(&quot;TERMINATE&quot;)</span>
						|| orgStatus.equals(&quot;TERMINATE&quot;) || orgStatus.equals(&quot;BLOCK&quot;) ) {
					
				/*	if(&quot;TERMINATE&quot;.equals(orgStatus)){
						
						loginBean.setStatus(&quot;TERMINAT_WRAPPER&quot;);
						return loginBean;
					}*/
					
<span class="nc" id="L282">					loginBean.setStatus(&quot;ERRORINACTIVE&quot;);</span>
<span class="nc" id="L283">					return loginBean;</span>
				}
				
<span class="nc bnc" id="L286" title="All 2 branches missed.">				if(&quot;RETAILER&quot;.equalsIgnoreCase(userInfo.getUserType())){			</span>
<span class="nc" id="L287">					String parentOrgStatus = null;</span>
<span class="nc" id="L288">					pstmt = con.prepareStatement(&quot;select organization_status from st_lms_organization_master where organization_id=?&quot;);</span>
<span class="nc" id="L289">					pstmt.setInt(1, parentOrgId);</span>
<span class="nc" id="L290">					rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">					if(rs.next()){</span>
<span class="nc" id="L292">						parentOrgStatus = rs.getString(&quot;organization_status&quot;);</span>
<span class="nc" id="L293">						userInfo.setParentOrgStatus(parentOrgStatus);</span>
					}
<span class="nc bnc" id="L295" title="All 4 branches missed.">					if (&quot;BLOCK&quot;.equals(parentOrgStatus) || &quot;TERMINATE&quot;.equals(parentOrgStatus)) {</span>
						
<span class="nc" id="L297">						loginBean.setStatus(&quot;ERRORINACTIVE&quot;);</span>
<span class="nc" id="L298">						return loginBean;</span>
					}
				}
				
			/*	if (&quot;INACTIVE&quot;.equalsIgnoreCase(orgStatus)) {
					PreparedStatement pstmt2 = con
							.prepareStatement(&quot;select reason from st_lms_organization_master_history where organization_status='INACTIVE' and organization_id=? order by date_changed desc limit 1&quot;);
					pstmt2.setString(1, orgId);
					ResultSet rs2 = pstmt2.executeQuery();

					if (rs2.next()) {
						reason = rs2.getString(&quot;reason&quot;);
					}

					//if (!&quot;INACTIVE_AUTO_ACT&quot;.equalsIgnoreCase(reason)) {
						if(&quot;INACTIVE_MANUAL_BO&quot;.equalsIgnoreCase(reason)){
						loginBean.setStatus(&quot;ERRORINACTIVE&quot;);
						return loginBean;
						//}
					}
				}*/
               //update login attempts and last_login_date together and where condition user_id is used in stead of user_name
<span class="nc" id="L320">				pstmt = con</span>
						.prepareStatement(&quot;update st_lms_user_master set login_attempts = 0,last_login_date=? where user_id = ?&quot;);
<span class="nc" id="L322">				pstmt.setTimestamp(1, Util.getCurrentTimeStamp());</span>
<span class="nc" id="L323">				pstmt.setInt(2, uid);</span>
<span class="nc" id="L324">				pstmt.executeUpdate();</span>

				
				
<span class="nc" id="L328">				rs.close();</span>
<span class="nc" id="L329">				pstmt.close();</span>
<span class="nc" id="L330">				LinkedHashMap actionServiceMap = new LinkedHashMap();</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">				if(!&quot;TERMINAL&quot;.equals(interface_type)){</span>
				
<span class="nc" id="L333">				PriviledgeBean privBean = null;</span>
				// String getService = &quot;select
				// srm.id,role_id,service_display_name,ref_merchant_id,privilege_rep_table,menu_master_table,service_deligate_url
				// from st_lms_service_role_mapping srm,st_lms_service_master sm
				// where srm.status='ACTIVE' and srm.role_id=? and
				// sm.status='ACTIVE' and srm.service_id=sm.service_id and
				// srm.interface='WEB'&quot;;
<span class="nc" id="L340">				String getService = &quot;select srm.id,role_id,interface,service_display_name,service_code,ref_merchant_id,priv_rep_table,menu_master_table,service_deligate_url from st_lms_service_role_mapping srm,st_lms_service_master sm,st_lms_service_delivery_master sdm where srm.role_id=? and organization_id=? and srm.status='ACTIVE' and sm.status='ACTIVE' and sdm.status='ACTIVE' and srm.id=sdm.service_delivery_master_id and sdm.service_id=sm.service_id and sdm.interface=?&quot;;</span>
<span class="nc" id="L341">				String getPrivId = &quot;select distinct(upm.priv_id) from st_lms_role_priv_mapping rpm,st_lms_user_priv_mapping upm where upm.user_id=? and upm.role_id=? and rpm.status='ACTIVE' and upm.status='ACTIVE'and upm.role_id=rpm.role_id and upm.service_mapping_id=?&quot;;</span>
<span class="nc" id="L342">				String getAction = null;</span>
<span class="nc" id="L343">				String getMenuTitle = null;</span>
<span class="nc" id="L344">				pstmt = con.prepareStatement(getService);</span>
<span class="nc" id="L345">				pstmt.setInt(1, roleId);</span>
<span class="nc" id="L346">				pstmt.setInt(2, Integer.parseInt(orgId));</span>
<span class="nc" id="L347">				pstmt.setString(3, interface_type);</span>
<span class="nc" id="L348">				logger.debug(pstmt);</span>
<span class="nc" id="L349">				rs = pstmt.executeQuery();</span>
<span class="nc" id="L350">				String localeName = CommonMethods.getSelectedLocale();</span>
<span class="nc" id="L351">				String menuColumnName = &quot;menu_disp_name&quot;;</span>
<span class="nc bnc" id="L352" title="All 4 branches missed.">				if(&quot;en&quot;.equalsIgnoreCase(localeName) || &quot;fr&quot;.equalsIgnoreCase(localeName)){</span>
<span class="nc" id="L353">						menuColumnName = &quot;menu_disp_name_&quot;+localeName;</span>
				}
<span class="nc bnc" id="L355" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc bnc" id="L356" title="All 2 branches missed.">					if(&quot;st_sle_priviledge_rep&quot;.equals(rs.getString(&quot;priv_rep_table&quot;))) {</span>
<span class="nc" id="L357">						continue;</span>
					}
<span class="nc" id="L359">					ArrayList&lt;PriviledgeBean&gt; privList = new ArrayList&lt;PriviledgeBean&gt;();</span>
<span class="nc" id="L360">					getAction = &quot;select distinct(action_mapping) from &quot;</span>
							+ rs.getString(&quot;priv_rep_table&quot;)
							+ &quot; pr,(&quot;
							+ getPrivId
							+ &quot;) result where pr.priv_id=result.priv_id and pr.status='ACTIVE'&quot;;
<span class="nc" id="L365">					getMenuTitle = &quot;select &quot;+menuColumnName+&quot; menu_disp_name,item_order,related_to,action_mapping from &quot;</span>
							+ rs.getString(&quot;menu_master_table&quot;)
							+ &quot; smm,&quot;
							+ rs.getString(&quot;priv_rep_table&quot;)
							+ &quot; pr,(&quot;
							+ getPrivId
							+ &quot;) result where  pr.priv_id=result.priv_id and pr.status='ACTIVE' and smm.action_id=pr.action_id order by related_to,item_order,menu_disp_name&quot;;
<span class="nc" id="L372">					pstmtPriv = con.prepareStatement(getAction);</span>
<span class="nc" id="L373">					pstmtPriv.setInt(1, uid);</span>
<span class="nc" id="L374">					pstmtPriv.setInt(2, roleId);</span>
<span class="nc" id="L375">					pstmtPriv.setInt(3, rs.getInt(&quot;id&quot;));</span>
					// logger.debug(pstmtPriv);
<span class="nc" id="L377">					rsPriv = pstmtPriv.executeQuery();</span>
<span class="nc bnc" id="L378" title="All 2 branches missed.">					while (rsPriv.next()) {</span>
<span class="nc" id="L379">						userActionList.add(rsPriv.getString(&quot;action_mapping&quot;));</span>
					}
<span class="nc" id="L381">					pstmtPriv1 = con.prepareStatement(getMenuTitle);</span>
<span class="nc" id="L382">					pstmtPriv1.setInt(1, uid);</span>
<span class="nc" id="L383">					pstmtPriv1.setInt(2, roleId);</span>
<span class="nc" id="L384">					pstmtPriv1.setInt(3, rs.getInt(&quot;id&quot;));</span>
<span class="nc" id="L385">					logger.debug(pstmtPriv1);</span>
<span class="nc" id="L386">					rsPriv = pstmtPriv1.executeQuery();</span>
<span class="nc bnc" id="L387" title="All 2 branches missed.">					while (rsPriv.next()) {</span>
<span class="nc" id="L388">						privBean = new PriviledgeBean();</span>
<span class="nc" id="L389">						privBean.setPrivTitle(rsPriv</span>
								.getString(&quot;menu_disp_name&quot;));
<span class="nc" id="L391">						privBean.setActionMapping(rsPriv</span>
								.getString(&quot;action_mapping&quot;));
<span class="nc" id="L393">						privBean.setRelatedTo(rsPriv.getString(&quot;related_to&quot;));</span>
<span class="nc" id="L394">						privList.add(privBean);</span>
					}
<span class="nc bnc" id="L396" title="All 2 branches missed.">					if (privList.size() &gt; 0) {</span>
<span class="nc" id="L397">						actionServiceMap.put(rs</span>
								.getString(&quot;service_display_name&quot;)
								+ &quot;-&quot; + rs.getString(&quot;service_code&quot;), privList);
					}
<span class="nc" id="L401">				}</span>
				
<span class="nc bnc" id="L403" title="All 6 branches missed.">				if(ServicesBean.isSLE() &amp;&amp; (&quot;BO&quot;.equalsIgnoreCase(userInfo.getUserType()) || &quot;RETAILER&quot;.equalsIgnoreCase(userInfo.getUserType()))) {</span>
<span class="nc" id="L404">					actionServiceMap.put(&quot;Sports Lottery-sle&quot;, new ArrayList&lt;PriviledgeBean&gt;());</span>
				}
<span class="nc bnc" id="L406" title="All 4 branches missed.">				if(ServicesBean.isVS() &amp;&amp; (&quot;RETAILER&quot;.equalsIgnoreCase(userInfo.getUserType()))) {</span>
<span class="nc" id="L407">					actionServiceMap.put(&quot;Virtual Sports-vs&quot;, new ArrayList&lt;PriviledgeBean&gt;());</span>
				}
<span class="nc bnc" id="L409" title="All 4 branches missed.">				if(ServicesBean.isIW() &amp;&amp; (&quot;RETAILER&quot;.equalsIgnoreCase(userInfo.getUserType()))) {</span>
<span class="nc" id="L410">					actionServiceMap.put(&quot;Instant Win-iw&quot;, new ArrayList&lt;PriviledgeBean&gt;());</span>
				}
				}

<span class="nc" id="L414">				loginBean.setActionServiceMap(actionServiceMap);</span>
				
<span class="nc" id="L416">				loginBean.setUserActionList(userActionList);</span>
<span class="nc" id="L417">				loginBean.setUserInfo(userInfo);</span>
				/*String insertLoginDate = QueryManager.insertST3LoginDate()
						+ &quot; where user_name='&quot; + username + &quot;'&quot;;
				pstmt = con.prepareStatement(insertLoginDate);
				pstmt.setTimestamp(1, new java.sql.Timestamp(new Date()
						.getTime()));
				pstmt.executeUpdate();*/

<span class="nc bnc" id="L425" title="All 4 branches missed.">				if (&quot;AGENT&quot;.equalsIgnoreCase(userInfo.getUserType())</span>
						|| &quot;RETAILER&quot;.equalsIgnoreCase(userInfo.getUserType())) {
<span class="nc" id="L427">					PreparedStatement ps = con</span>
							.prepareStatement(&quot;select name,org_code from st_lms_organization_master where organization_id = ?&quot;);
<span class="nc" id="L429">					ps.setInt(1, parentOrgId);</span>
<span class="nc" id="L430">					rs = ps.executeQuery();</span>

<span class="nc bnc" id="L432" title="All 2 branches missed.">					if (rs.next()) {</span>
<span class="nc" id="L433">						parentOrgName = rs.getString(&quot;name&quot;);</span>
<span class="nc" id="L434">						parentOrgCode=rs.getString(&quot;org_code&quot;);</span>
					}

<span class="nc" id="L437">					userInfo.setParentOrgName(parentOrgName);</span>
<span class="nc" id="L438">					userInfo.setParentOrgCode(parentOrgCode);</span>
				     
					// added to reflect web users last login in ret offline master 
<span class="nc bnc" id="L441" title="All 4 branches missed.">					if(&quot;RETAILER&quot;.equalsIgnoreCase(userInfo.getUserType()) &amp;&amp; interface_type.equalsIgnoreCase(&quot;WEB&quot;)){</span>
						
						
<span class="nc" id="L444">						String updateRetOfflineQuery = &quot;update st_lms_ret_offline_master set login_status=?,last_login_time=?,last_HBT_time=? where user_id = ?&quot;;</span>
<span class="nc" id="L445">						pstmt = con.prepareStatement(updateRetOfflineQuery);</span>
<span class="nc" id="L446">						pstmt.setString(1,&quot;LOGIN&quot;);</span>
<span class="nc" id="L447">						pstmt.setTimestamp(2, new Timestamp(new Date().getTime()));</span>
<span class="nc" id="L448">						pstmt.setTimestamp(3, new Timestamp(new Date().getTime()));</span>
<span class="nc" id="L449">						pstmt.setInt(4, userInfo.getUserId());</span>
<span class="nc" id="L450">						logger.info(&quot;updateRetOfflineQuery&quot;+pstmt);</span>
<span class="nc" id="L451">						int update=pstmt.executeUpdate();</span>
<span class="nc" id="L452">						logger.info(&quot;updated updateRetOffline &quot;+update);</span>
					}
						
				}
				
				

<span class="nc bnc" id="L459" title="All 2 branches missed.">				if (autoGenerate == 1) {</span>
<span class="nc" id="L460">					loginBean.setStatus(&quot;FirstTime&quot;);</span>
<span class="nc" id="L461">					con.commit();</span>
<span class="nc" id="L462">					return loginBean;</span>
				}

<span class="nc bnc" id="L465" title="All 2 branches missed.">				if (!loggedInUser(username)) {</span>

				}
<span class="nc" id="L468">			} else {</span>
<span class="nc" id="L469">				loginBean.setStatus(&quot;PASS_NOT_MATCH&quot;);</span>
<span class="nc" id="L470">				pstmt = con</span>
						.prepareStatement(&quot;update st_lms_user_master set login_attempts = login_attempts+1 where user_name = ?&quot;);
<span class="nc" id="L472">				pstmt.setString(1, username);</span>
<span class="nc" id="L473">				pstmt.executeUpdate();</span>
<span class="nc" id="L474">				con.commit();</span>
<span class="nc" id="L475">				return loginBean;</span>
				
			}
<span class="nc" id="L478">			con.commit();</span>
			
			//double userBal = userInfo.getAvailableCreditLimit()- userInfo.getClaimableBal();
			/*if (userBal &lt; 0 &amp;&amp; !&quot;BO&quot;.equals(userInfo.getUserType())) {
				if (!&quot;INACTIVE_AUTO_ACT&quot;.equalsIgnoreCase(reason)) {
					loginBean.setStatus(&quot;BALANCE_NOT_POSITIVE&quot;);
					return loginBean;
				} else {
					loginBean.setStatus(&quot;success&quot;);
				}
				;
				return loginBean;
			}*/
<span class="nc" id="L491">		} catch (SQLException e) {</span>
<span class="nc" id="L492">			logger.error(&quot;SQl Error: &quot; + e);</span>
<span class="nc" id="L493">			throw new LMSException();</span>
			//	e.printStackTrace();

<span class="nc" id="L496">		} catch (Exception e) {</span>
<span class="nc" id="L497">			logger.error(&quot; Error: &quot; + e);</span>
<span class="nc" id="L498">			throw new LMSException();</span>
			//e.printStackTrace();

		}finally {
<span class="nc" id="L502">			try {</span>
				/*if (con != null) {
					con.close();
				}*/
<span class="nc bnc" id="L506" title="All 20 branches missed.">				if (pstmt != null) {</span>
<span class="nc" id="L507">					pstmt.close();</span>
				}
<span class="nc bnc" id="L509" title="All 20 branches missed.">				if (pstmtPriv != null) {</span>
<span class="nc" id="L510">					pstmtPriv.close();</span>
				}
<span class="nc bnc" id="L512" title="All 20 branches missed.">				if (pstmtPriv1 != null) {</span>
<span class="nc" id="L513">					pstmtPriv1.close();</span>
				}
<span class="nc bnc" id="L515" title="All 20 branches missed.">				if (rs != null) {</span>
<span class="nc" id="L516">					rs.close();</span>
				}
<span class="nc bnc" id="L518" title="All 20 branches missed.">				if (rsPriv != null) {</span>
<span class="nc" id="L519">					rsPriv .close();</span>
				}
<span class="nc" id="L521">			} catch (SQLException e) {</span>
<span class="nc" id="L522">				logger.error(&quot;SQl Error: &quot; + e);</span>
<span class="nc" id="L523">				e.printStackTrace();</span>
<span class="nc" id="L524">			}</span>
<span class="nc" id="L525">		}</span>
<span class="nc" id="L526">		loginBean.setStatus(&quot;success&quot;);</span>
<span class="nc" id="L527">		return loginBean;</span>
	}
	
	
	
	public LoginBean loginAuthentication(String username, String password,
			String interface_type, String loginLimit,String sessionId,boolean isIpTimingCheck) {
<span class="nc" id="L534">		Connection con=null;</span>
	/*	PreparedStatement pstmt=null;
		PreparedStatement pstmtPriv=null;
		PreparedStatement pstmtPriv1=null;
		ResultSet rs=null;
		ResultSet rsPriv=null;*/
		try {
<span class="nc" id="L541">			con = DBConnect.getConnection();</span>
<span class="nc" id="L542">			loginAuthentication(username, password, interface_type, loginLimit, con , sessionId,isIpTimingCheck);</span>
<span class="nc" id="L543">		}catch(Exception e){</span>
<span class="nc" id="L544">			logger.error(&quot;Error: &quot; + e);</span>
		}finally{
<span class="nc" id="L546">			DBConnect.closeCon(con);</span>
<span class="nc" id="L547">		}</span>
			
            /*//here check the terminal staus on this server
			String dbPass = &quot;&quot;; // stores the password retrieved from the
			// database.
			int autoGenerate = 0;
			String role = &quot;&quot;;
			int roleId = 0;
			String roleName = &quot;&quot;;
			String unam = &quot;&quot;;
			String status = &quot;&quot;;
			int uid = -1;
			String orgStatus = &quot;&quot;;
			int userMapid = 0;
			String orgName = &quot;&quot;;
			String orgId = &quot;&quot;;
			int parentOrgId = 0;
			int tierId = 0;
			String parentOrgName = &quot;&quot;;
			String parentOrgCode=&quot;&quot;;
			logger.debug(&quot;inside Auth Helper&quot;);
			String orgCodeQry = &quot;  bb.name orgCode &quot;;

			
			if ((LMSFilterDispatcher.orgFieldType).equalsIgnoreCase(&quot;CODE&quot;)) {
				orgCodeQry = &quot;  bb.org_code orgCode  &quot;;


			} else if ((LMSFilterDispatcher.orgFieldType)
					.equalsIgnoreCase(&quot;CODE_NAME&quot;)) {
				orgCodeQry = &quot; concat(bb.org_code,'_',bb.name)  orgCode  &quot;;
			

			} else if ((LMSFilterDispatcher.orgFieldType)
					.equalsIgnoreCase(&quot;NAME_CODE&quot;)) {
				orgCodeQry = &quot; concat(bb.name,'_',bb.org_code)  orgCode &quot;;
			

			}
			String getUserDetailsQuery = &quot;select if(aa.organization_type = 'RETAILER' , (select user_mapping_id from st_lms_user_random_id_mapping where user_id = aa.user_id) , 0) user_mapping_id, aa.user_id, aa.organization_id,aa.isrolehead,cc.is_master, aa.role_id,cc.tier_id, aa.user_name, aa.password, aa.status, aa.organization_type,bb.organization_status , aa.auto_password, aa.login_attempts&quot;
					+ &quot;, bb.name,bb.org_code,&quot;+orgCodeQry+&quot; , bb.organization_status, bb.current_credit_amt, bb.available_credit, bb.claimable_bal, bb.unclaimable_bal, bb.parent_id, bb.pwt_scrap, cc.role_name,if(login_attempts&lt;&quot;
					+ loginLimit
					+ &quot;,'ALLOW','BLOCK') logginAttempt ,bb.tp_organization istp &quot;
					+ &quot;from st_lms_user_master aa, st_lms_organization_master bb, st_lms_role_master cc &quot;
					+ &quot;where aa.organization_id = bb.organization_id	and aa.user_name =? and aa.role_id = cc.role_id&quot;;

			pstmt = con.prepareStatement(getUserDetailsQuery);
			pstmt.setString(1, username.trim());

			rs = pstmt.executeQuery();
			logger.debug(pstmt);

			// check More Then One Users Exist in the Database or not with Same
			// user_name
			if (rs.getFetchSize() &gt; 1) {
				logger
						.debug(&quot;More Then One User Exist in the Database with Same  user_name&quot;
								+ username);
				loginBean.setStatus(&quot;ERROR&quot;);
				return loginBean;
			}

			// getting the user details from database
			if (rs.next()) {
				dbPass = rs.getString(TableConstants.USER_PASSWORD);
				role = rs.getString(TableConstants.ORG_TYPE);// This is tier
				// Code
				tierId = rs.getInt(TableConstants.TIER_ID);
				roleId = rs.getInt(TableConstants.ROLE_ID);
				status = rs.getString(TableConstants.USER_STATUS);
				unam = rs.getString(TableConstants.USER_NAME);
				uid = rs.getInt(TableConstants.USER_ID);
				orgId = rs.getString(TableConstants.ORG_ID);
				userMapid =  rs.getInt(TableConstants.MAPPING_ID);
				orgName = rs.getString(TableConstants.ORGANIZATION_NAME);
				roleName = rs.getString(TableConstants.ROLE_NAME);
				autoGenerate = rs.getInt(&quot;auto_password&quot;);
				parentOrgId = rs.getInt(&quot;parent_id&quot;);
				orgStatus = rs.getString(&quot;organization_status&quot;);

				userInfo = new UserInfoBean();
				userInfo.setRoleName(rs.getString(TableConstants.ROLE_NAME));
				userInfo.setRoleId(roleId);
				userInfo.setUserId(uid);
				userInfo.setUserName(username);
				userInfo.setUserOrgId(rs.getInt(TableConstants.ORG_ID));
				userInfo.setUserType(role);
				userInfo.setTierId(tierId);
				userInfo.setOrgName(orgName);
				userInfo.setOrgCode(rs.getString(&quot;orgCode&quot;));
				userInfo.setUserOrgCode(rs.getString(&quot;org_code&quot;));
				userInfo.setAvailableCreditLimit(rs
						.getDouble(TableConstants.SOM_AVAILABLE_CREDIT));
				userInfo.setClaimableBal(rs.getDouble(&quot;claimable_bal&quot;));
				userInfo.setUnclaimableBal(rs.getDouble(&quot;unclaimable_bal&quot;));
				userInfo.setCurrentCreditAmt(rs
						.getDouble(TableConstants.CURRENT_CREDIT_AMT));
				userInfo.setStatus(status);
				userInfo.setOrgStatus(rs.getString(TableConstants.ORG_STATUS));
				userInfo.setPwtSacrap(rs.getString(&quot;pwt_scrap&quot;));
				userInfo.setParentOrgId(parentOrgId);
				userInfo.setCurrentUserMappingId(userMapid);
				userInfo.setIsMasterRole(rs.getString(&quot;is_master&quot;));
				userInfo.setIsRoleHeadUser(rs.getString(&quot;isrolehead&quot;));
				userInfo.setTPUser(&quot;YES&quot;.equalsIgnoreCase(rs.getString(&quot;istp&quot;)));
				userInfo.setLoginChannel(interface_type);
			}
			// check the user's info before login
			else {
				loginBean.setStatus(&quot;USER_NAME_NOT_MATCH&quot;);
				return loginBean;
			}

			if (&quot;BLOCK&quot;.equals(rs.getString(&quot;logginAttempt&quot;))) {
				loginBean.setStatus(&quot;LOGIN_LIMIT_REACHED&quot;);
				return loginBean;
			}
			
			//Here matching Time of Login			
			if(!getTimeLimitStatus(uid,con))
			{
				logger.info(&quot;TIME LIMIT STATUS - Time Limit is exceeded for this user&quot;);
				loginBean.setStatus(&quot;ERROR_TIME_LIMIT&quot;);
				return loginBean;
			}

			String reason = null;
			con.setAutoCommit(false);
			// Matching Password
			if (MD5Encoder.encode(password).equals(dbPass) || userInfo.isTPUser()) {
				// checking the user status
				if (status.equals(&quot;BLOCK&quot;) || status.equals(&quot;TERMINATE&quot;)
						|| orgStatus.equals(&quot;TERMINATE&quot;) || orgStatus.equals(&quot;BLOCK&quot;)) {
					
					if(&quot;TERMINATE&quot;.equals(orgStatus)){
						
						loginBean.setStatus(&quot;TERMINAT_WRAPPER&quot;);
						return loginBean;
					}
					
					loginBean.setStatus(&quot;ERRORINACTIVE&quot;);
					return loginBean;
				}

	/*			if (&quot;INACTIVE&quot;.equalsIgnoreCase(orgStatus)) {
					PreparedStatement pstmt2 = con
							.prepareStatement(&quot;select reason from st_lms_organization_master_history where organization_status='INACTIVE' and organization_id=? order by date_changed desc limit 1&quot;);
					pstmt2.setString(1, orgId);
					ResultSet rs2 = pstmt2.executeQuery();

					if (rs2.next()) {
						reason = rs2.getString(&quot;reason&quot;);
					}

					//if (!&quot;INACTIVE_AUTO_ACT&quot;.equalsIgnoreCase(reason)) {
						if(&quot;INACTIVE_MANUAL_BO&quot;.equalsIgnoreCase(reason)){
						loginBean.setStatus(&quot;ERRORINACTIVE&quot;);
						return loginBean;
						//}
					}
				}
               //update login attempts and last_login_date together and where condition user_id is used in stead of user_name
				pstmt = con
						.prepareStatement(&quot;update st_lms_user_master set login_attempts = 0,last_login_date=? where user_id = ?&quot;);
				pstmt.setTimestamp(1, Util.getCurrentTimeStamp());
				pstmt.setInt(2, uid);
				pstmt.executeUpdate();

				
				
				rs.close();
				pstmt.close();
				LinkedHashMap actionServiceMap = new LinkedHashMap();
				if(!&quot;TERMINAL&quot;.equals(interface_type)){
				
				PriviledgeBean privBean = null;
				// String getService = &quot;select
				// srm.id,role_id,service_display_name,ref_merchant_id,privilege_rep_table,menu_master_table,service_deligate_url
				// from st_lms_service_role_mapping srm,st_lms_service_master sm
				// where srm.status='ACTIVE' and srm.role_id=? and
				// sm.status='ACTIVE' and srm.service_id=sm.service_id and
				// srm.interface='WEB'&quot;;
				String getService = &quot;select srm.id,role_id,interface,service_display_name,service_code,ref_merchant_id,priv_rep_table,menu_master_table,service_deligate_url from st_lms_service_role_mapping srm,st_lms_service_master sm,st_lms_service_delivery_master sdm where srm.role_id=? and organization_id=? and srm.status='ACTIVE' and sm.status='ACTIVE' and sdm.status='ACTIVE' and srm.id=sdm.service_delivery_master_id and sdm.service_id=sm.service_id and sdm.interface=?&quot;;
				String getPrivId = &quot;select distinct(upm.priv_id) from st_lms_role_priv_mapping rpm,st_lms_user_priv_mapping upm where upm.user_id=? and upm.role_id=? and rpm.status='ACTIVE' and upm.status='ACTIVE'and upm.role_id=rpm.role_id and upm.service_mapping_id=?&quot;;
				String getAction = null;
				String getMenuTitle = null;
				pstmt = con.prepareStatement(getService);
				pstmt.setInt(1, roleId);
				pstmt.setInt(2, Integer.parseInt(orgId));
				pstmt.setString(3, interface_type);
				logger.debug(pstmt);
				rs = pstmt.executeQuery();
				while (rs.next()) {
					ArrayList&lt;PriviledgeBean&gt; privList = new ArrayList&lt;PriviledgeBean&gt;();
					getAction = &quot;select distinct(action_mapping) from &quot;
							+ rs.getString(&quot;priv_rep_table&quot;)
							+ &quot; pr,(&quot;
							+ getPrivId
							+ &quot;) result where pr.priv_id=result.priv_id and pr.status='ACTIVE'&quot;;
					getMenuTitle = &quot;select menu_disp_name,item_order,related_to,action_mapping from &quot;
							+ rs.getString(&quot;menu_master_table&quot;)
							+ &quot; smm,&quot;
							+ rs.getString(&quot;priv_rep_table&quot;)
							+ &quot; pr,(&quot;
							+ getPrivId
							+ &quot;) result where  pr.priv_id=result.priv_id and pr.status='ACTIVE' and smm.action_id=pr.action_id order by related_to,item_order,menu_disp_name&quot;;
					pstmtPriv = con.prepareStatement(getAction);
					pstmtPriv.setInt(1, uid);
					pstmtPriv.setInt(2, roleId);
					pstmtPriv.setInt(3, rs.getInt(&quot;id&quot;));
					// logger.debug(pstmtPriv);
					rsPriv = pstmtPriv.executeQuery();
					while (rsPriv.next()) {
						userActionList.add(rsPriv.getString(&quot;action_mapping&quot;));
					}
					pstmtPriv1 = con.prepareStatement(getMenuTitle);
					pstmtPriv1.setInt(1, uid);
					pstmtPriv1.setInt(2, roleId);
					pstmtPriv1.setInt(3, rs.getInt(&quot;id&quot;));
					logger.debug(pstmtPriv1);
					rsPriv = pstmtPriv1.executeQuery();
					while (rsPriv.next()) {
						privBean = new PriviledgeBean();
						privBean.setPrivTitle(rsPriv
								.getString(&quot;menu_disp_name&quot;));
						privBean.setActionMapping(rsPriv
								.getString(&quot;action_mapping&quot;));
						privBean.setRelatedTo(rsPriv.getString(&quot;related_to&quot;));
						privList.add(privBean);
					}
					if (privList.size() &gt; 0) {
						actionServiceMap.put(rs
								.getString(&quot;service_display_name&quot;)
								+ &quot;-&quot; + rs.getString(&quot;service_code&quot;), privList);
					}
				}
				
				}
				loginBean.setActionServiceMap(actionServiceMap);
				
				loginBean.setUserActionList(userActionList);
				loginBean.setUserInfo(userInfo);
				String insertLoginDate = QueryManager.insertST3LoginDate()
						+ &quot; where user_name='&quot; + username + &quot;'&quot;;
				pstmt = con.prepareStatement(insertLoginDate);
				pstmt.setTimestamp(1, new java.sql.Timestamp(new Date()
						.getTime()));
				pstmt.executeUpdate();

				if (&quot;AGENT&quot;.equalsIgnoreCase(userInfo.getUserType())
						|| &quot;RETAILER&quot;.equalsIgnoreCase(userInfo.getUserType())) {
					PreparedStatement ps = con
							.prepareStatement(&quot;select name,org_code from st_lms_organization_master where organization_id = ?&quot;);
					ps.setInt(1, parentOrgId);
					rs = ps.executeQuery();

					if (rs.next()) {
						parentOrgName = rs.getString(&quot;name&quot;);
						parentOrgCode=rs.getString(&quot;org_code&quot;);
					}

					userInfo.setParentOrgName(parentOrgName);
					userInfo.setParentOrgCode(parentOrgCode);
				     
					// added to reflect web users last login in ret offline master 
					if(&quot;RETAILER&quot;.equalsIgnoreCase(userInfo.getUserType()) &amp;&amp; interface_type.equalsIgnoreCase(&quot;WEB&quot;)){
						
						
						String updateRetOfflineQuery = &quot;update st_lms_ret_offline_master set login_status=?,last_login_time=?,last_HBT_time=? where user_id = ?&quot;;
						pstmt = con.prepareStatement(updateRetOfflineQuery);
						pstmt.setString(1,&quot;LOGIN&quot;);
						pstmt.setTimestamp(2, new Timestamp(new Date().getTime()));
						pstmt.setTimestamp(3, new Timestamp(new Date().getTime()));
						pstmt.setInt(4, userInfo.getUserId());
						logger.info(&quot;updateRetOfflineQuery&quot;+pstmt);
						int update=pstmt.executeUpdate();
						logger.info(&quot;updated updateRetOffline &quot;+update);
					}
						
				}
				
				

				if (autoGenerate == 1) {
					loginBean.setStatus(&quot;FirstTime&quot;);
					con.commit();
					return loginBean;
				}

				if (!loggedInUser(username)) {

				}
			} else {
				loginBean.setStatus(&quot;PASS_NOT_MATCH&quot;);
				pstmt = con
						.prepareStatement(&quot;update st_lms_user_master set login_attempts = login_attempts+1 where user_name = ?&quot;);
				pstmt.setString(1, username);
				pstmt.executeUpdate();
				con.commit();
				return loginBean;
				
			}
			con.commit();
			
			double userBal = userInfo.getAvailableCreditLimit()- userInfo.getClaimableBal();
			if (userBal &lt; 0 &amp;&amp; !&quot;BO&quot;.equals(userInfo.getUserType())) {
				if (!&quot;INACTIVE_AUTO_ACT&quot;.equalsIgnoreCase(reason)) {
					loginBean.setStatus(&quot;BALANCE_NOT_POSITIVE&quot;);
					return loginBean;
				} else {
					loginBean.setStatus(&quot;success&quot;);
				}
				;
				return loginBean;
			}
		} catch (SQLException e) {
			logger.error(&quot;SQl Error: &quot; + e);
			//	e.printStackTrace();

		} catch (Exception e) {
			logger.error(&quot; Error: &quot; + e);
			//e.printStackTrace();

		}finally {
			try {
				if (con != null) {
					con.close();
				}
				if (pstmt != null) {
					pstmt.close();
				}
				if (pstmtPriv != null) {
					pstmtPriv.close();
				}
				if (pstmtPriv1 != null) {
					pstmtPriv1.close();
				}
				if (rs != null) {
					rs.close();
				}
				if (rsPriv != null) {
					rsPriv .close();
				}
			} catch (SQLException e) {
				logger.error(&quot;SQl Error: &quot; + e);
				e.printStackTrace();
			}
		}*/
		//loginBean.setStatus(&quot;success&quot;);
<span class="nc" id="L896">		return loginBean;</span>
	}
/**This Method validate terminal id for user 
 * @deprecated Use validateTerminalId(int userId, String terminalId,String deviceType,Connection con)
 * @param userId 
 * @param terminalId
 * @param deviceType
 * @return true/false 
 */
	public boolean validateTerminalId(int userId, String terminalId,String deviceType) {
<span class="nc" id="L906">		Connection con = DBConnect.getConnection();</span>
		try {
<span class="nc" id="L908">			PreparedStatement ps = con</span>
					.prepareStatement(&quot;select serial_number from st_lms_ret_offline_master where user_id = ?&quot;);
<span class="nc" id="L910">			ps.setInt(1, userId);</span>
<span class="nc" id="L911">			ResultSet rs = ps.executeQuery();</span>
<span class="nc" id="L912">			System.out.println(&quot;Validate Terminal Query &quot;+ps+&quot; deviceType: &quot;+deviceType);	</span>
<span class="nc" id="L913">			String dbTerminalId = &quot;&quot;;</span>

<span class="nc bnc" id="L915" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L916">				dbTerminalId = rs.getString(&quot;serial_number&quot;);</span>
			}
		
<span class="nc bnc" id="L919" title="All 6 branches missed.">			if(deviceType.equalsIgnoreCase(&quot;TPS&quot;) || &quot;TPS300&quot;.equals(deviceType) || &quot;TPS800&quot;.equals(deviceType)){</span>
<span class="nc bnc" id="L920" title="All 2 branches missed.">				if(dbTerminalId.length()&gt;15){</span>
<span class="nc" id="L921">					dbTerminalId = dbTerminalId.substring(</span>
							dbTerminalId.length() - 15, dbTerminalId.length());
							}
			}
			else{
<span class="nc bnc" id="L926" title="All 2 branches missed.">				if (dbTerminalId.length() &gt; 8) {</span>
<span class="nc" id="L927">					dbTerminalId = dbTerminalId.substring(</span>
							dbTerminalId.length() - 8, dbTerminalId.length());
				}
			}
			

<span class="nc bnc" id="L933" title="All 2 branches missed.">			if (terminalId.equalsIgnoreCase(dbTerminalId)) {</span>
<span class="nc" id="L934">				return true;</span>
			}
<span class="nc" id="L936">		} catch (SQLException e) {</span>
<span class="nc" id="L937">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L939">			try {</span>
<span class="nc" id="L940">				con.close();</span>
<span class="nc" id="L941">			} catch (SQLException e) {</span>
<span class="nc" id="L942">				e.printStackTrace();</span>
<span class="nc" id="L943">			}</span>
<span class="nc" id="L944">		}</span>
<span class="nc" id="L945">		return false;</span>
	}

	public boolean checkTerminalId(String terminalId,Connection con) throws LMSException {
<span class="nc" id="L949">		PreparedStatement ps =null;</span>
<span class="nc" id="L950">		ResultSet rs =null;</span>
		try {
			
<span class="nc" id="L953">			ps = con</span>
					.prepareStatement(&quot;select current_owner_type from st_lms_inv_status where serial_no like ? and current_owner_type != 'REMOVED'&quot;);
<span class="nc" id="L955">			ps.setString(1,&quot;%&quot;+terminalId);</span>
<span class="nc" id="L956">			logger.info(&quot;checkTerminalId Query:&quot;+ps);</span>
<span class="nc" id="L957">			rs = ps.executeQuery();</span>

<span class="nc bnc" id="L959" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L960">				return true;</span>
			}
			
<span class="nc" id="L963">		} catch (SQLException e) {</span>
<span class="nc" id="L964">			logger.error(&quot;SQL Exception&quot;,e);</span>
<span class="nc" id="L965">			throw new LMSException(LMSErrors.SQL_EXCEPTION_ERROR_CODE,LMSErrors.SQL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="nc" id="L966">		} catch (Exception e) {</span>
<span class="nc" id="L967">			logger.error(&quot; Exception&quot;,e);</span>
<span class="nc" id="L968">			throw new LMSException(LMSErrors.GENERAL_EXCEPTION_ERROR_CODE,LMSErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
		} finally {
<span class="nc" id="L970">			try {</span>
<span class="nc bnc" id="L971" title="All 6 branches missed.">				if(ps!=null){</span>
<span class="nc" id="L972">					ps.close();</span>
				}
<span class="nc bnc" id="L974" title="All 6 branches missed.">				if(rs!=null){</span>
<span class="nc" id="L975">					rs.close();</span>
				}
<span class="nc" id="L977">			} catch (SQLException e) {</span>
<span class="nc" id="L978">				logger.error(&quot;SQL Exception&quot;,e);</span>
<span class="nc" id="L979">			}</span>
<span class="nc" id="L980">		}</span>
<span class="nc" id="L981">		return false;</span>
	}
	
	
	public boolean validateUser(String userName, String password) {
<span class="nc" id="L986">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L987">		boolean bRet = false;</span>
		try {
<span class="nc" id="L989">			System.out.println(&quot;******&quot; + userName + &quot;******&quot; + password);</span>
<span class="nc" id="L990">			PreparedStatement pstmt = con</span>
					.prepareStatement(&quot;select user_name from st_lms_user_master where user_name = ? and password = ?&quot;);
<span class="nc" id="L992">			pstmt.setString(1, userName);</span>
<span class="nc" id="L993">			pstmt.setString(2, MD5Encoder.encode(password));</span>
<span class="nc" id="L994">			ResultSet rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L996" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L997">				bRet = true;</span>
			}
<span class="nc" id="L999">		} catch (SQLException ex) {</span>
<span class="nc" id="L1000">			System.out.println(ex);</span>
		} finally {
<span class="nc" id="L1002">			try {</span>
<span class="nc" id="L1003">				con.close();</span>
<span class="nc" id="L1004">			} catch (SQLException e) {</span>
<span class="nc" id="L1005">				e.printStackTrace();</span>
<span class="nc" id="L1006">			}</span>
<span class="nc" id="L1007">		}</span>

<span class="nc" id="L1009">		return bRet;</span>
	}

	public static void resetAll() throws LMSException {
<span class="nc" id="L1013">		Connection con = DBConnect.getConnection();</span>
		try {
<span class="nc" id="L1015">			PreparedStatement pstmt = null;</span>
<span class="nc" id="L1016">			pstmt = con</span>
					.prepareStatement(&quot;update st_lms_user_master set login_attempts = 0&quot;);
<span class="nc" id="L1018">			pstmt.executeUpdate();</span>
<span class="nc" id="L1019">		}catch (SQLException e) {</span>
<span class="nc" id="L1020">			logger.info(&quot;SQL Exception &quot;,e);</span>
<span class="nc" id="L1021">			throw new LMSException(&quot;SQL Exception &quot;+e.getMessage());</span>
<span class="nc" id="L1022">		}catch (Exception e) {</span>
<span class="nc" id="L1023">			logger.info(&quot;Exception &quot;,e);</span>
<span class="nc" id="L1024">			throw new LMSException(&quot;Exception&quot;+e.getMessage());</span>
		} finally {
<span class="nc" id="L1026">			DBConnect.closeCon(con);</span>
<span class="nc" id="L1027">		}</span>
<span class="nc" id="L1028">	}</span>

/**
 * @deprecated Use newTerminalInfo(String deviceType, String profile,
				boolean isCs, boolean isDownload, double version, int userId,Connection con)	
 * @param deviceType
 * @param profile
 * @param isCs
 * @param isDownload
 * @param version
 * @param userId
 * @return
 */
	public static String newTerminalInfo(String deviceType, String profile,
			boolean isCs, boolean isDownload, double version, int userId) {
<span class="nc" id="L1043">		StringBuilder returnData = new StringBuilder(&quot;&quot;);</span>
<span class="nc" id="L1044">		String expVersion = null;</span>
<span class="nc" id="L1045">		Connection con = DBConnect.getConnection();</span>
		try {
<span class="nc" id="L1047">			boolean isKenya = &quot;Kenya&quot;.equalsIgnoreCase((String)LMSUtility.sc.getAttribute(&quot;COUNTRY_DEPLOYED&quot;));</span>
<span class="nc" id="L1048">			Statement st = con.createStatement();</span>
<span class="nc" id="L1049">			ResultSet innerRS = st.executeQuery(&quot;select expected_version from st_lms_ret_offline_master where user_id = &quot; + userId);</span>
<span class="nc bnc" id="L1050" title="All 2 branches missed.">			if(innerRS.next()){</span>
<span class="nc" id="L1051">				expVersion = innerRS.getString(&quot;expected_version&quot;);</span>
			}
<span class="nc" id="L1053">			PreparedStatement pstmt = con</span>
					.prepareStatement(&quot;SELECT item_name,isMandatory,fileSize,fileSize_adf FROM st_lms_htpos_download hd,  st_lms_htpos_device_master dm WHERE status='ACTIVE' AND hd.device_id = dm.device_id AND device_type=? AND profile=? AND version=? LIMIT 4&quot;);
<span class="nc" id="L1055">			pstmt.setString(1, deviceType);</span>
<span class="nc" id="L1056">			pstmt.setString(2, profile);</span>
<span class="nc" id="L1057">			pstmt.setString(3, &quot;&quot;+expVersion);</span>
<span class="nc" id="L1058">			ResultSet rs = pstmt.executeQuery();</span>
			
<span class="nc bnc" id="L1060" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc bnc" id="L1061" title="All 2 branches missed.">				if(isDownload){</span>
<span class="nc" id="L1062">					returnData.append(rs.getString(&quot;item_name&quot;) + &quot;:&quot;</span>
							+ expVersion + &quot;,&quot;
							+ rs.getString(&quot;isMandatory&quot;) + &quot;,&quot;
							+ rs.getString(&quot;fileSize_adf&quot;)+&quot;,&quot;
							+ rs.getString(&quot;fileSize&quot;) +
					&quot;|&quot;);
				} else{
<span class="nc" id="L1069">					returnData.append(rs.getString(&quot;item_name&quot;) + &quot;:&quot;</span>
							+ version + &quot;,&quot;
							+ &quot;NO&quot; + &quot;,&quot;
							+ -1 +&quot;,&quot;+ 0 + &quot;|&quot;);
				}
				
<span class="nc bnc" id="L1075" title="All 2 branches missed.">				if (!isCs)</span>
<span class="nc" id="L1076">					break;</span>
				
<span class="nc bnc" id="L1078" title="All 2 branches missed.">				if(!isKenya)</span>
<span class="nc" id="L1079">					break;</span>
			}
<span class="nc" id="L1081">		} catch (Exception e) {</span>
<span class="nc" id="L1082">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L1084">			DBConnect.closeCon(con);</span>
<span class="nc" id="L1085">		}</span>

<span class="nc" id="L1087">		return returnData.toString();</span>
	}

	
/**
 * @deprecated Use terminalInfo(String deviceType, String profile,
	            boolean isCs, boolean isDownload, double version, int userId,Connection con)	
 * @param deviceType
 * @param profile
 * @param isCs
 * @param isDownload
 * @param version
 * @param userId
 * @return
 */
	
	public static String terminalInfo(String deviceType, String profile,
            boolean isCs, boolean isDownload, double version, int userId) {
<span class="nc" id="L1105">        StringBuilder returnData = new StringBuilder(&quot;&quot;);</span>
<span class="nc" id="L1106">        String expVersion = null;</span>
<span class="nc" id="L1107">        Connection con = DBConnect.getConnection();</span>
        try {
<span class="nc" id="L1109">            boolean isKenya = &quot;Kenya&quot;.equalsIgnoreCase((String)LMSUtility.sc.getAttribute(&quot;COUNTRY_DEPLOYED&quot;));</span>
<span class="nc" id="L1110">            Statement st = con.createStatement();</span>
<span class="nc" id="L1111">            ResultSet innerRS = st.executeQuery(&quot;select expected_version from st_lms_ret_offline_master where user_id = &quot; + userId);</span>
<span class="nc bnc" id="L1112" title="All 2 branches missed.">            if(innerRS.next()){</span>
<span class="nc" id="L1113">                expVersion = innerRS.getString(&quot;expected_version&quot;);</span>
            }
<span class="nc" id="L1115">            PreparedStatement pstmt = con</span>
                    .prepareStatement(&quot;SELECT item_name,isMandatory,fileSize FROM st_lms_htpos_download hd,  st_lms_htpos_device_master dm WHERE status='ACTIVE' AND hd.device_id = dm.device_id AND device_type=? AND profile=? AND version=? LIMIT 4&quot;);
<span class="nc" id="L1117">            pstmt.setString(1, deviceType);</span>
<span class="nc" id="L1118">            pstmt.setString(2, profile);</span>
<span class="nc" id="L1119">            pstmt.setString(3, &quot;&quot;+expVersion);</span>
<span class="nc" id="L1120">            ResultSet rs = pstmt.executeQuery();</span>
            
<span class="nc bnc" id="L1122" title="All 2 branches missed.">            while (rs.next()) {</span>
<span class="nc bnc" id="L1123" title="All 2 branches missed.">                if(isDownload){</span>
<span class="nc" id="L1124">                    returnData.append(rs.getString(&quot;item_name&quot;) + &quot;:&quot;</span>
                            + expVersion + &quot;,&quot;
                            + rs.getString(&quot;isMandatory&quot;) + &quot;,&quot;
                            + rs.getString(&quot;fileSize&quot;) + &quot;|&quot;);
                } else{
<span class="nc" id="L1129">                    returnData.append(rs.getString(&quot;item_name&quot;) + &quot;:&quot;</span>
                            + version + &quot;,&quot;
                            + &quot;NO&quot; + &quot;,&quot;
                            + 0 + &quot;|&quot;);
                }
                
<span class="nc bnc" id="L1135" title="All 2 branches missed.">                if (!isCs)</span>
<span class="nc" id="L1136">                    break;</span>
                
<span class="nc bnc" id="L1138" title="All 2 branches missed.">                if(!isKenya)</span>
<span class="nc" id="L1139">                    break;</span>
            }
<span class="nc" id="L1141">        } catch (Exception e) {</span>
<span class="nc" id="L1142">            e.printStackTrace();</span>
        } finally {
<span class="nc" id="L1144">            DBConnect.closeCon(con);</span>
<span class="nc" id="L1145">        }</span>

<span class="nc" id="L1147">        return returnData.toString();</span>
    }
/**
 * @deprecated Use terminalInfoForLessVersion(String deviceType, String profile, boolean isDownload, double version, int userId,Connection con)
 * @param deviceType
 * @param profile
 * @param isDownload
 * @param version
 * @param userId
 * @return
 */
	public static String terminalInfoForLessVersion(String deviceType, String profile, boolean isDownload, double version, int userId) {
<span class="nc" id="L1159">		StringBuilder returnData = new StringBuilder(&quot;&quot;);</span>
<span class="nc" id="L1160">		String expVersion = null;</span>
<span class="nc bnc" id="L1161" title="All 2 branches missed.">		if(isDownload){</span>
<span class="nc" id="L1162">			Connection con = DBConnect.getConnection();</span>
			try {
<span class="nc" id="L1164">			Statement st = con.createStatement();</span>
<span class="nc" id="L1165">			ResultSet innerRS = st.executeQuery(&quot;select expected_version from st_lms_ret_offline_master where user_id = &quot; + userId);</span>
<span class="nc bnc" id="L1166" title="All 2 branches missed.">			if(innerRS.next()){</span>
<span class="nc" id="L1167">				expVersion = innerRS.getString(&quot;expected_version&quot;);</span>
			}
			
<span class="nc" id="L1170">				PreparedStatement pstmt = con.prepareStatement(&quot;SELECT item_name,isMandatory,fileSize FROM st_lms_htpos_download hd,  st_lms_htpos_device_master dm WHERE status='ACTIVE' AND hd.device_id = dm.device_id AND device_type=? AND profile=? AND item_name=? AND version=?&quot;);</span>
<span class="nc" id="L1171">				pstmt.setString(1, deviceType);</span>
<span class="nc" id="L1172">				pstmt.setString(2, profile);</span>
<span class="nc" id="L1173">				pstmt.setString(3, &quot;SApp&quot;);</span>
<span class="nc" id="L1174">				pstmt.setString(4, &quot;&quot;+expVersion);</span>
<span class="nc" id="L1175">				ResultSet rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1176" title="All 2 branches missed.">				if (rs.next()) {</span>
<span class="nc" id="L1177">					returnData.append(&quot;version:&quot; + expVersion</span>
							+ &quot;|is mandatory:&quot; + rs.getString(&quot;isMandatory&quot;) + &quot;|fSize:&quot; + rs.getString(&quot;fileSize&quot;) + &quot;|&quot;);
				}
<span class="nc" id="L1180">			} catch (Exception e) {</span>
<span class="nc" id="L1181">				e.printStackTrace();</span>
			} finally {
<span class="nc" id="L1183">				DBConnect.closeCon(con);</span>
<span class="nc" id="L1184">			}</span>
<span class="nc" id="L1185">		} else {</span>
<span class="nc" id="L1186">			returnData.append(&quot;version:&quot; + version</span>
					+ &quot;|is mandatory:&quot; + &quot;NO&quot; + &quot;|fSize:&quot; + 0 + &quot;|&quot;);
		}
<span class="nc" id="L1189">		return returnData.toString();</span>
	}
	
	public boolean isValidMacId(int userId, String macId) {
<span class="nc bnc" id="L1193" title="All 2 branches missed.">		if (macId == null) {</span>
<span class="nc" id="L1194">			return false;</span>
		}
<span class="nc" id="L1196">		macId = macId.trim();</span>
<span class="nc" id="L1197">		String terminalId = null;</span>

<span class="nc" id="L1199">		Connection con = DBConnect.getConnection();</span>
		try {
<span class="nc" id="L1201">			PreparedStatement pstmt = con</span>
					.prepareStatement(&quot;select serial_number from st_lms_ret_offline_master where user_id=?&quot;);
<span class="nc" id="L1203">			pstmt.setInt(1, userId);</span>
<span class="nc" id="L1204">			System.out.println(&quot;pstmt:&quot; + pstmt);</span>
<span class="nc" id="L1205">			ResultSet rs = pstmt.executeQuery();</span>
			
<span class="nc bnc" id="L1207" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L1208">				terminalId = rs.getString(&quot;serial_number&quot;);</span>
			}

<span class="nc bnc" id="L1211" title="All 2 branches missed.">			if (terminalId == null) {</span>
<span class="nc" id="L1212">				System.out.println(&quot;return false&quot;);</span>
<span class="nc" id="L1213">				return false;</span>
			}
			
<span class="nc" id="L1216">			System.out.println(&quot;macId:&quot; + macId);</span>
<span class="nc" id="L1217">			System.out.println(&quot;terminalId:&quot; + terminalId + &quot;*****&quot;);</span>

<span class="nc bnc" id="L1219" title="All 2 branches missed.">			if (macId.equalsIgnoreCase(terminalId.trim())) {</span>
<span class="nc" id="L1220">				System.out.println(&quot;return true&quot;);</span>
<span class="nc" id="L1221">				return true;</span>
			}
<span class="nc" id="L1223">		} catch (SQLException e) {</span>
<span class="nc" id="L1224">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L1226">			DBConnect.closeCon(con);</span>
<span class="nc" id="L1227">		}</span>

<span class="nc" id="L1229">		return false;</span>
	}
/**
 * @deprecated Use chkDownloadAvailable(int userId,Connection con)	
 * @param userId
 * @return
 */
	public static boolean chkDownloadAvailable(int userId){
<span class="nc" id="L1237">		boolean flag = false;</span>
<span class="nc" id="L1238">		String qry = &quot;select current_version, expected_version, is_download_available from st_lms_ret_offline_master where user_id = &quot; + userId;</span>
<span class="nc" id="L1239">		Connection con = DBConnect.getConnection();</span>
		try {
<span class="nc" id="L1241">			Statement st = con.createStatement();</span>
<span class="nc" id="L1242">			ResultSet rs = st.executeQuery(qry);</span>
<span class="nc bnc" id="L1243" title="All 2 branches missed.">			while(rs.next()){</span>
<span class="nc bnc" id="L1244" title="All 4 branches missed.">				flag = (&quot;YES&quot;.equalsIgnoreCase(rs.getString(&quot;is_download_available&quot;)) </span>
							&amp;&amp; !rs.getString(&quot;current_version&quot;).equalsIgnoreCase(rs.getString(&quot;expected_version&quot;)));
			}
<span class="nc" id="L1247">		} catch (SQLException e) {</span>
<span class="nc" id="L1248">			e.printStackTrace();</span>
		} finally{
<span class="nc" id="L1250">			DBConnect.closeCon(con);</span>
<span class="nc" id="L1251">		}</span>
<span class="nc" id="L1252">		return flag;</span>
	}
/**
 * @deprecated	 Use updateDownloadDetails(int userId, double version,Connection con)
 * @param userId
 * @param version
 */
	public static void updateDownloadDetails(int userId, double version){
		
<span class="nc" id="L1261">		String selectQry=&quot;select is_download_available from st_lms_ret_offline_master where user_id = &quot;+userId+&quot; and expected_version = &quot;+version;</span>
	
<span class="nc" id="L1263">	    String qry = &quot;update st_lms_ret_offline_master set is_download_available = 'NO', downloaded_on = '&quot; </span>
		              + (new Timestamp(new Date().getTime()).toString()).split(&quot;\\.&quot;)[0] + &quot;' where user_id = &quot; + userId + &quot; and&quot; 
		              + &quot; expected_version = &quot; + version ; 
<span class="nc" id="L1266">	    Connection con = DBConnect.getConnection();</span>
	   try {
<span class="nc" id="L1268">		    Statement st = con.createStatement();</span>
		
<span class="nc" id="L1270">		    ResultSet rs=st.executeQuery(selectQry);</span>
<span class="nc bnc" id="L1271" title="All 2 branches missed.">		   if(rs.next()){</span>
<span class="nc bnc" id="L1272" title="All 2 branches missed.">			             if(&quot;YES&quot;.equalsIgnoreCase(rs.getString(&quot;is_download_available&quot;))){</span>
<span class="nc" id="L1273">				                        int i = st.executeUpdate(qry);</span>
<span class="nc bnc" id="L1274" title="All 2 branches missed.">				                        if(i &gt; 0){</span>
<span class="nc" id="L1275">				                                  System.out.println(&quot;Updated download details for userId &quot; + userId);</span>
				                         }
			              }
		  }
								
            /*			if(i &gt; 0){
			            System.out.println(&quot;Updated download details for userId &quot; + userId);
		                }
		    */
<span class="nc" id="L1284">	       } catch (SQLException e) {</span>
<span class="nc" id="L1285">		     e.printStackTrace();</span>
	       } finally{
<span class="nc" id="L1287">		     DBConnect.closeCon(con);</span>
<span class="nc" id="L1288">	       }</span>
<span class="nc" id="L1289">	   }</span>
	
	public static void updateLoginStatus(int userId, String status){
<span class="nc" id="L1292">		Connection con = DBConnect.getConnection();</span>
		//PreparedStatement pstmt = null;
		try {
<span class="nc" id="L1295">			con.setAutoCommit(false);</span>
<span class="nc" id="L1296">			updateLoginStatus( userId, status,con);</span>
<span class="nc" id="L1297">			con.commit();</span>
		/*pstmt = con.prepareStatement(&quot;update st_lms_ret_offline_master set login_status=?,last_login_time=? where user_id=?&quot;);
		pstmt.setString(1, status);
		pstmt.setTimestamp(2, new Timestamp(new Date().getTime()));
		pstmt.setInt(3, userId);
		pstmt.executeUpdate();*/
<span class="nc" id="L1303">		} catch (Exception e) {</span>
<span class="nc" id="L1304">			e.printStackTrace();</span>
		} finally{
<span class="nc" id="L1306">			DBConnect.closeCon(con);</span>
<span class="nc" id="L1307">		}		</span>
<span class="nc" id="L1308">	}</span>
	
	public boolean getTimeLimitStatus(int userId,Connection con) {

		//Connection con = null;
<span class="nc" id="L1313">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L1314">		ResultSet set = null;</span>

<span class="nc" id="L1316">		Time nowTime = null;</span>
<span class="nc" id="L1317">		Time startTime = null;</span>
<span class="nc" id="L1318">		Time endTime = null;</span>
<span class="nc" id="L1319">		String status = null;</span>

<span class="nc" id="L1321">		String[] days = new String[]{&quot;sunday&quot;, &quot;monday&quot;, &quot;tuesday&quot;, &quot;wednesday&quot;, &quot;thursday&quot;, &quot;friday&quot;,&quot;saturday&quot;};</span>
<span class="nc" id="L1322">		Calendar calendar = Calendar.getInstance();</span>
<span class="nc" id="L1323">		String day = days[calendar.get(Calendar.DAY_OF_WEEK)-1];</span>

		try
		{
			//con = DBConnect.getConnection();
<span class="nc" id="L1328">			nowTime = new Time(new SimpleDateFormat(&quot;HH:mm:ss&quot;).parse(calendar.get(Calendar.HOUR_OF_DAY)+&quot;:&quot;+calendar.get(Calendar.MINUTE)+&quot;:00&quot;).getTime());</span>

<span class="nc" id="L1330">			pstmt = con.prepareStatement(&quot;SELECT &quot;+day+&quot;_start_time as startTime, &quot;+day+&quot;_end_time as endTime, status FROM st_lms_user_ip_time_mapping WHERE user_id=?;&quot;);</span>
<span class="nc" id="L1331">			pstmt.setInt(1, userId);</span>
<span class="nc" id="L1332">			set = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1333" title="All 2 branches missed.">			if(set.next())</span>
			{
<span class="nc" id="L1335">				status = set.getString(&quot;status&quot;);</span>
<span class="nc" id="L1336">				startTime = set.getTime(&quot;startTime&quot;);</span>
<span class="nc" id="L1337">				endTime = set.getTime(&quot;endTime&quot;);</span>
			}
			else
<span class="nc" id="L1340">				return true;</span>
		}
<span class="nc" id="L1342">		catch (SQLException e) {</span>
<span class="nc" id="L1343">			e.printStackTrace();</span>
		}
<span class="nc" id="L1345">		catch (Exception e) {</span>
<span class="nc" id="L1346">			e.printStackTrace();</span>
<span class="nc" id="L1347">		}finally{</span>
			//DBConnect.closeCon(con);
<span class="nc" id="L1349">		}</span>

<span class="nc bnc" id="L1351" title="All 2 branches missed.">		if(&quot;INACTIVE&quot;.equals(status))</span>
<span class="nc" id="L1352">			return true;</span>
<span class="nc bnc" id="L1353" title="All 4 branches missed.">		if(nowTime.getTime()&gt;=startTime.getTime() &amp;&amp; nowTime.getTime()&lt;=endTime.getTime())</span>
<span class="nc" id="L1354">			return true;</span>
			
<span class="nc" id="L1356">		return false;</span>
	}
	
	/**This Method validate terminal id for user 
	 * @param userId 
	 * @param terminalId
	 * @param deviceType
	 * @param con 
	 * @return true/false 
	 */
		public boolean validateTerminalId(String dbTerminalId,String terminalId,String deviceType, int binding_length) {
			//PreparedStatement ps =null;
			//ResultSet rs =null;
			try {
				//ps= con.prepareStatement(&quot;select serial_number from st_lms_ret_offline_master where user_id = ?&quot;);
				//ps.setInt(1, userId);
				//rs= ps.executeQuery();
				//logger.info(&quot;Validate Terminal Query &quot;+ps+&quot; deviceType: &quot;+deviceType);	
				//String dbTerminalId = &quot;&quot;;

				//if (rs.next()) {
				//	dbTerminalId = rs.getString(&quot;serial_number&quot;);
				////}
			
				//if(deviceType.equalsIgnoreCase(&quot;TPS&quot;) || &quot;TPS300&quot;.equals(deviceType) || &quot;TPS800&quot;.equals(deviceType)){
					//if(dbTerminalId.length()&gt;15){
<span class="nc" id="L1382">						dbTerminalId = dbTerminalId.substring(dbTerminalId.length() - binding_length, dbTerminalId.length());</span>
				/*}
				}else{
					if (dbTerminalId.length() &gt; 8) {
						dbTerminalId = dbTerminalId.substring(
								dbTerminalId.length() - 8, dbTerminalId.length());
					}*/
						
<span class="nc bnc" id="L1390" title="All 2 branches missed.">				if (terminalId.equalsIgnoreCase(dbTerminalId)) {</span>
<span class="nc" id="L1391">					return true;</span>
				}
			//} catch (SQLException e) {
				//logger.error(&quot;SQL Exception &quot;, e);
<span class="nc" id="L1395">			}catch(Exception e){</span>
<span class="nc" id="L1396">				logger.error(&quot;Exception &quot;,e);</span>
<span class="nc" id="L1397">			} </span>
			//finally {
			//	DBConnect.closeRs(rs);
			//	DBConnect.closePstmt(ps);
			//}
<span class="nc" id="L1402">			return false;</span>
		}	
		public static void updateDownloadDetails(int userId, double version,double expectedVersion,String isDownloadAvailable,Connection con) throws LMSException {
			
			//String selectQry=&quot;select is_download_available from st_lms_ret_offline_master where user_id = &quot;+userId+&quot; and expected_version = &quot;+version;
		
		   /* String qry = &quot;update st_lms_ret_offline_master set is_download_available = 'NO', downloaded_on = '&quot; 
			              + (new Timestamp(new Date().getTime()).toString()).split(&quot;\\.&quot;)[0] + &quot;' where user_id = &quot; + userId + &quot; and&quot; 
			              + &quot; expected_version = &quot; + version ; */
<span class="nc" id="L1411">		    PreparedStatement pstmt=null;</span>
		    //ResultSet rs=null;
		  
		   try {
			   	//st = con.createStatement();
			   // logger.info(&quot;Update Download Details selectQry&quot;+selectQry);
			  //  logger.info(&quot;Update Download Details updateQry&quot;+qry);
			   // rs=st.executeQuery(selectQry);
<span class="nc bnc" id="L1419" title="All 4 branches missed.">			    if(&quot;YES&quot;.equalsIgnoreCase(isDownloadAvailable) &amp;&amp; version == expectedVersion){</span>
				             //if(&quot;YES&quot;.equalsIgnoreCase(isDownloadAvailable)){
<span class="nc" id="L1421">				            	 pstmt=con.prepareStatement(&quot;update st_lms_ret_offline_master set is_download_available = 'NO', downloaded_on = ? where user_id = ? and  expected_version = ?&quot;);</span>
<span class="nc" id="L1422">				            	 pstmt.setTimestamp(1, Util.getCurrentTimeStamp());</span>
<span class="nc" id="L1423">				            	 pstmt.setInt(2, userId);</span>
<span class="nc" id="L1424">				            	 pstmt.setDouble(3, version);</span>
				            	// st = con.createStatement();
<span class="nc" id="L1426">					                        int i = pstmt.executeUpdate();</span>
<span class="nc bnc" id="L1427" title="All 2 branches missed.">					                        if(i &gt; 0){</span>
<span class="nc" id="L1428">					                                  System.out.println(&quot;Updated download details for userId &quot; + userId);</span>
					                         }
				              //}
			   			}
									
	            /*			if(i &gt; 0){
				            System.out.println(&quot;Updated download details for userId &quot; + userId);
			                }
			    */
<span class="nc" id="L1437">			   con.commit();</span>
<span class="nc" id="L1438">		       } catch (SQLException e) {</span>
<span class="nc" id="L1439">			     logger.error(&quot;SQL Exception &quot;+e);</span>
<span class="nc" id="L1440">			     throw new LMSException(LMSErrors.SQL_EXCEPTION_ERROR_CODE,LMSErrors.SQL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="nc" id="L1441">		       }catch(Exception e){</span>
<span class="nc" id="L1442">		    	   logger.error(&quot; Exception &quot;+e);</span>
<span class="nc" id="L1443">		    	   throw new LMSException(LMSErrors.GENERAL_EXCEPTION_ERROR_CODE,LMSErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
		       } finally{
		    	  // DBConnect.closeRs(rs);
<span class="nc" id="L1446">		    	   DBConnect.closePstmt(pstmt);</span>
<span class="nc" id="L1447">		       }</span>
<span class="nc" id="L1448">		   }</span>
		
		
		public static boolean chkDownloadAvailable(int userId,Connection con){
<span class="nc" id="L1452">			boolean flag = false;</span>
<span class="nc" id="L1453">			String qry = &quot;select current_version, expected_version, is_download_available from st_lms_ret_offline_master where user_id = &quot; + userId;</span>
<span class="nc" id="L1454">			Statement st=null;</span>
<span class="nc" id="L1455">			ResultSet rs =null;</span>
			try {
<span class="nc" id="L1457">				 st = con.createStatement();</span>
<span class="nc" id="L1458">				 rs = st.executeQuery(qry);</span>
<span class="nc bnc" id="L1459" title="All 2 branches missed.">				while(rs.next()){</span>
<span class="nc bnc" id="L1460" title="All 4 branches missed.">					flag = (&quot;YES&quot;.equalsIgnoreCase(rs.getString(&quot;is_download_available&quot;)) </span>
								&amp;&amp; !rs.getString(&quot;current_version&quot;).equalsIgnoreCase(rs.getString(&quot;expected_version&quot;)));
				}
<span class="nc" id="L1463">			} catch (SQLException e) {</span>
<span class="nc" id="L1464">				logger.error(&quot;SQL Exception &quot;,e);</span>
<span class="nc" id="L1465">			}catch(Exception e){</span>
<span class="nc" id="L1466">				logger.error(&quot;Exception &quot;,e);</span>
			} finally{
<span class="nc" id="L1468">				DBConnect.closeRs(rs);</span>
<span class="nc" id="L1469">				DBConnect.closeStmt(st);</span>
<span class="nc" id="L1470">			}</span>
<span class="nc" id="L1471">			return flag;</span>
		}
		
		public static String terminalInfo(String deviceType, String profile,
	            boolean isCs, boolean isDownload, double version, int userId,Connection con) {
<span class="nc" id="L1476">	        StringBuilder returnData = new StringBuilder(&quot;&quot;);</span>
<span class="nc" id="L1477">	        String expVersion = null;</span>
	      
	        try {
<span class="nc" id="L1480">	            boolean isKenya = &quot;KENYA&quot;.equalsIgnoreCase(Utility.getPropertyValue(&quot;COUNTRY_DEPLOYED&quot;));</span>
<span class="nc" id="L1481">	            Statement st = con.createStatement();</span>
<span class="nc" id="L1482">	            ResultSet innerRS = st.executeQuery(&quot;select expected_version from st_lms_ret_offline_master where user_id = &quot; + userId);</span>
<span class="nc bnc" id="L1483" title="All 2 branches missed.">	            if(innerRS.next()){</span>
<span class="nc" id="L1484">	                expVersion = innerRS.getString(&quot;expected_version&quot;);</span>
	            }
<span class="nc" id="L1486">	            PreparedStatement pstmt = con</span>
	                    .prepareStatement(&quot;SELECT item_name,isMandatory,fileSize FROM st_lms_htpos_download hd,  st_lms_htpos_device_master dm WHERE status='ACTIVE' AND hd.device_id = dm.device_id AND device_type=? AND profile=? AND version=? LIMIT 4&quot;);
<span class="nc" id="L1488">	            pstmt.setString(1, deviceType);</span>
<span class="nc" id="L1489">	            pstmt.setString(2, profile);</span>
<span class="nc" id="L1490">	            pstmt.setString(3, &quot;&quot;+expVersion);</span>
<span class="nc" id="L1491">	            ResultSet rs = pstmt.executeQuery();</span>
	            
<span class="nc bnc" id="L1493" title="All 2 branches missed.">	            while (rs.next()) {</span>
<span class="nc bnc" id="L1494" title="All 2 branches missed.">	                if(isDownload){</span>
<span class="nc" id="L1495">	                    returnData.append(rs.getString(&quot;item_name&quot;) + &quot;:&quot;</span>
	                            + expVersion + &quot;,&quot;
	                            + rs.getString(&quot;isMandatory&quot;) + &quot;,&quot;
	                            + rs.getString(&quot;fileSize&quot;) + &quot;|&quot;);
	                } else{
<span class="nc" id="L1500">	                    returnData.append(rs.getString(&quot;item_name&quot;) + &quot;:&quot;</span>
	                            + version + &quot;,&quot;
	                            + &quot;NO&quot; + &quot;,&quot;
	                            + 0 + &quot;|&quot;);
	                }
	                
<span class="nc bnc" id="L1506" title="All 2 branches missed.">	                if (!isCs)</span>
<span class="nc" id="L1507">	                    break;</span>
	                
<span class="nc bnc" id="L1509" title="All 2 branches missed.">	                if(!isKenya)</span>
<span class="nc" id="L1510">	                    break;</span>
	            }
<span class="nc" id="L1512">	        } catch (Exception e) {</span>
<span class="nc" id="L1513">	            e.printStackTrace();</span>
<span class="nc" id="L1514">	        } finally {</span>
	            //DBConnect.closeCon(con);
<span class="nc" id="L1516">	        }</span>

<span class="nc" id="L1518">	        return returnData.toString();</span>
	    }
		public static String newTerminalInfo(String deviceType, String profile,
				boolean isCs, boolean isDownload, double version,String expectedVersion, int userId,Connection con) throws LMSException {
<span class="nc" id="L1522">			StringBuilder returnData = new StringBuilder(&quot;&quot;);</span>
			//String expVersion = null;
			//Statement st =null;
<span class="nc" id="L1525">			ResultSet innerRS =null;</span>
<span class="nc" id="L1526">			PreparedStatement pstmt =null;</span>
<span class="nc" id="L1527">			ResultSet rs =null;</span>
		//	Connection con = DBConnect.getConnection();
			try {
<span class="nc" id="L1530">				boolean isKenya = &quot;KENYA&quot;.equalsIgnoreCase(Utility.getPropertyValue(&quot;COUNTRY_DEPLOYED&quot;));</span>
				/*st = con.createStatement();
				innerRS = st.executeQuery(&quot;select expected_version from st_lms_ret_offline_master where user_id = &quot; + userId);
				if(innerRS.next()){
					expVersion = innerRS.getString(&quot;expected_version&quot;);
				}*/
<span class="nc" id="L1536">				pstmt = con.prepareStatement(&quot;SELECT item_name,isMandatory,fileSize,fileSize_adf FROM st_lms_htpos_download hd,  st_lms_htpos_device_master dm WHERE status='ACTIVE' AND hd.device_id = dm.device_id AND device_type=? AND profile=? AND version=? LIMIT 4&quot;);</span>
<span class="nc" id="L1537">				pstmt.setString(1, deviceType);</span>
<span class="nc" id="L1538">				pstmt.setString(2, profile);</span>
<span class="nc" id="L1539">				pstmt.setString(3, &quot;&quot;+expectedVersion);</span>
<span class="nc" id="L1540">				rs = pstmt.executeQuery();</span>
				
<span class="nc bnc" id="L1542" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc bnc" id="L1543" title="All 2 branches missed.">					if(isDownload){</span>
<span class="nc" id="L1544">						returnData.append(rs.getString(&quot;item_name&quot;) + &quot;:&quot;</span>
								+ expectedVersion + &quot;,&quot;
								+ rs.getString(&quot;isMandatory&quot;) + &quot;,&quot;
								+ rs.getString(&quot;fileSize_adf&quot;)+&quot;,&quot;
								+ rs.getString(&quot;fileSize&quot;) +
						&quot;|&quot;);
					} else{
<span class="nc" id="L1551">						returnData.append(rs.getString(&quot;item_name&quot;) + &quot;:&quot;</span>
								+ version + &quot;,&quot;
								+ &quot;NO&quot; + &quot;,&quot;
								+ -1 +&quot;,&quot;+ 0 + &quot;|&quot;);
					}
					
<span class="nc bnc" id="L1557" title="All 2 branches missed.">					if (!isCs)</span>
<span class="nc" id="L1558">						break;</span>
					
<span class="nc bnc" id="L1560" title="All 2 branches missed.">					if(!isKenya)</span>
<span class="nc" id="L1561">						break;</span>
				}
<span class="nc" id="L1563">			} catch (SQLException e) {</span>
<span class="nc" id="L1564">			     logger.error(&quot;SQL Exception &quot;+e);</span>
<span class="nc" id="L1565">			     throw new LMSException(LMSErrors.SQL_EXCEPTION_ERROR_CODE,LMSErrors.SQL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="nc" id="L1566">		    }catch(Exception e){</span>
<span class="nc" id="L1567">		    	   logger.error(&quot; Exception &quot;+e);</span>
<span class="nc" id="L1568">		    	   throw new LMSException(LMSErrors.GENERAL_EXCEPTION_ERROR_CODE,LMSErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
		    } finally{
<span class="nc" id="L1570">				DBConnect.closeRs(rs);</span>
<span class="nc" id="L1571">				DBConnect.closeRs(innerRS);</span>
				//DBConnect.closeStmt(st);
<span class="nc" id="L1573">				DBConnect.closePstmt(pstmt);</span>
<span class="nc" id="L1574">			}</span>

<span class="nc" id="L1576">			return returnData.toString();</span>
		}	
		public static String terminalInfoForLessVersion(String deviceType, String profile, boolean isDownload, double version, int userId,Connection con) {
<span class="nc" id="L1579">			StringBuilder returnData = new StringBuilder(&quot;&quot;);</span>
<span class="nc" id="L1580">			String expVersion = null;</span>
<span class="nc bnc" id="L1581" title="All 2 branches missed.">			if(isDownload){</span>
				//Connection con = DBConnect.getConnection();
				try {
<span class="nc" id="L1584">				Statement st = con.createStatement();</span>
<span class="nc" id="L1585">				ResultSet innerRS = st.executeQuery(&quot;select expected_version from st_lms_ret_offline_master where user_id = &quot; + userId);</span>
<span class="nc bnc" id="L1586" title="All 2 branches missed.">				if(innerRS.next()){</span>
<span class="nc" id="L1587">					expVersion = innerRS.getString(&quot;expected_version&quot;);</span>
				}
				
<span class="nc" id="L1590">					PreparedStatement pstmt = con.prepareStatement(&quot;SELECT item_name,isMandatory,fileSize FROM st_lms_htpos_download hd,  st_lms_htpos_device_master dm WHERE status='ACTIVE' AND hd.device_id = dm.device_id AND device_type=? AND profile=? AND item_name=? AND version=?&quot;);</span>
<span class="nc" id="L1591">					pstmt.setString(1, deviceType);</span>
<span class="nc" id="L1592">					pstmt.setString(2, profile);</span>
<span class="nc" id="L1593">					pstmt.setString(3, &quot;SApp&quot;);</span>
<span class="nc" id="L1594">					pstmt.setString(4, &quot;&quot;+expVersion);</span>
<span class="nc" id="L1595">					ResultSet rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1596" title="All 2 branches missed.">					if (rs.next()) {</span>
<span class="nc" id="L1597">						returnData.append(&quot;version:&quot; + expVersion</span>
								+ &quot;|is mandatory:&quot; + rs.getString(&quot;isMandatory&quot;) + &quot;|fSize:&quot; + rs.getString(&quot;fileSize&quot;) + &quot;|&quot;);
					}
<span class="nc" id="L1600">				} catch (Exception e) {</span>
<span class="nc" id="L1601">					e.printStackTrace();</span>
<span class="nc" id="L1602">				} finally {</span>
					//DBConnect.closeCon(con);
<span class="nc" id="L1604">				}</span>
			} else {
<span class="nc" id="L1606">				returnData.append(&quot;version:&quot; + version</span>
						+ &quot;|is mandatory:&quot; + &quot;NO&quot; + &quot;|fSize:&quot; + 0 + &quot;|&quot;);
			}
<span class="nc" id="L1609">			return returnData.toString();</span>
		}
		
		public static void updateLoginStatus(int userId, String status,Connection con) throws LMSException{
			//Connection con = DBConnect.getConnection();
<span class="nc" id="L1614">			PreparedStatement pstmt = null;</span>
			try {
<span class="nc" id="L1616">			pstmt = con.prepareStatement(&quot;update st_lms_ret_offline_master set login_status=?,last_login_time=? where user_id=?&quot;);</span>
<span class="nc" id="L1617">			pstmt.setString(1, status);</span>
<span class="nc" id="L1618">			pstmt.setTimestamp(2, new Timestamp(new Date().getTime()));</span>
<span class="nc" id="L1619">			pstmt.setInt(3, userId);</span>
<span class="nc" id="L1620">			pstmt.executeUpdate();</span>
			// con.commit();
<span class="nc" id="L1622">			}catch (Exception e) {	</span>
<span class="nc" id="L1623">				logger.error(&quot;Exception &quot;,e);</span>
				 //e.printStackTrace();
			
				try {
<span class="nc" id="L1627">					con.rollback();</span>
<span class="nc" id="L1628">				} catch (SQLException er) {</span>
<span class="nc" id="L1629">					logger.error(&quot;SQLException &quot;,er);</span>
					//er.printStackTrace();
<span class="nc" id="L1631">				}</span>
<span class="nc" id="L1632">				throw new LMSException(&quot;SQL_ERROR&quot;);</span>
			}finally{
				
<span class="nc" id="L1635">				DBConnect.closePstmt(pstmt);</span>
				
<span class="nc" id="L1637">			}		</span>
<span class="nc" id="L1638">		}</span>
		
		public static void updateUserSession(String userName , String userSession , Connection con) throws LMSException{
<span class="nc" id="L1641">			Statement stmt = null;</span>
			try {
<span class="nc" id="L1643">				stmt = con.createStatement();</span>
<span class="nc" id="L1644">				logger.info(stmt.executeUpdate(&quot;update st_lms_user_master set user_session = '&quot;+userSession+&quot;' where user_name = '&quot;+userName+&quot;'&quot;));</span>
<span class="nc" id="L1645">			}catch (Exception e) {	</span>
<span class="nc" id="L1646">				e.printStackTrace();</span>
<span class="nc" id="L1647">				throw new LMSException(&quot;SQL_ERROR&quot;);</span>
			}finally{
<span class="nc" id="L1649">				DBConnect.closeStmt(stmt);</span>
<span class="nc" id="L1650">			}		</span>
<span class="nc" id="L1651">		}</span>
		
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>