<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CommonFunctionsHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lms</a> &gt; <a href="index.source.html" class="el_package">com.skilrock.lms.coreEngine.ola.common</a> &gt; <span class="el_source">CommonFunctionsHelper.java</span></div><h1>CommonFunctionsHelper.java</h1><pre class="source lang-java linenums">package com.skilrock.lms.coreEngine.ola.common;

import java.io.IOException;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.TreeMap;

import javax.xml.parsers.ParserConfigurationException;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.xml.sax.SAXException;


import com.skilrock.lms.beans.ClmDrawSaleBean;
import com.skilrock.lms.beans.ClmPwtBean;
import com.skilrock.lms.beans.OlaNetGamingRetailerData;
import com.skilrock.lms.beans.OlaNetGamingRowList;
import com.skilrock.lms.beans.OrgPwtLimitBean;
import com.skilrock.lms.beans.TicketBean;
import com.skilrock.lms.beans.UserInfoBean;
import com.skilrock.lms.common.db.DBConnect;
import com.skilrock.lms.common.db.QueryManager;
import com.skilrock.lms.common.exception.LMSException;
import com.skilrock.lms.common.exception.handler.LMSExceptionInterceptor;
import com.skilrock.lms.common.utility.GenerateRecieptNo;
import com.skilrock.lms.web.drawGames.common.Util;

<span class="nc" id="L40">public class CommonFunctionsHelper {</span>
<span class="nc" id="L41">	static Log logger = LogFactory.getLog(CommonFunctionsHelper.class);</span>

	public static String checkPlrAffiliateMapping(Connection con, String plrId,int walletId)
			throws LMSException {
		try {
<span class="nc" id="L46">			String getMappingQry = &quot;select * from st_ola_affiliate_plr_mapping where player_id =? and wallet_id=?&quot;;</span>
<span class="nc" id="L47">			System.out.println(getMappingQry);</span>
<span class="nc" id="L48">			PreparedStatement getMappingPstmt = con</span>
					.prepareStatement(getMappingQry);
<span class="nc" id="L50">			getMappingPstmt.setString(1, plrId);</span>
<span class="nc" id="L51">			getMappingPstmt.setInt(2, walletId);</span>
<span class="nc" id="L52">			ResultSet rs = getMappingPstmt.executeQuery();</span>
<span class="nc bnc" id="L53" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L54">				return rs.getString(&quot;ref_user_id&quot;);</span>
			} else {
<span class="nc" id="L56">				return null;</span>
			}
<span class="nc" id="L58">		} catch (SQLException e) {</span>
<span class="nc" id="L59">			e.printStackTrace();</span>
<span class="nc" id="L60">			throw new LMSException(&quot;ERROR:::::::&quot;);</span>
		}
	}
/**
 * @deprecated on 03June2013
 * @param con
 * @param plrId
 * @param affiliateId
 * @param affiliateOrgId
 * @param walletId
 * @throws LMSException
 */
	public static void bindPlrNAffiliate(Connection con, String plrId,
			String affiliateId,int affiliateOrgId,int walletId) throws LMSException {
		try {
<span class="nc" id="L75">			String mappingQry = &quot;insert into st_ola_affiliate_plr_mapping values(?,?,?,?)&quot;;</span>
<span class="nc" id="L76">			PreparedStatement mappingPstmt = con.prepareStatement(mappingQry);</span>
<span class="nc" id="L77">			mappingPstmt.setString(1, plrId);</span>
<span class="nc" id="L78">			mappingPstmt.setString(2, affiliateId);</span>
<span class="nc" id="L79">			mappingPstmt.setInt(3, affiliateOrgId);</span>
<span class="nc" id="L80">			mappingPstmt.setInt(4, walletId);</span>
<span class="nc" id="L81">			int isUpdate = mappingPstmt.executeUpdate();</span>
			//insert into st_ola_rummy_plr_deposit_status @change to  st_ola_rummy_plr_deposit_comm_status 
<span class="nc" id="L83">			String walletName = OLAUtility.getWalletName(walletId);</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">		if(walletName.equalsIgnoreCase(&quot;Rummy&quot;)){</span>
				
<span class="nc" id="L86">				String query =&quot;insert into st_ola_rummy_plr_deposit_comm_status(plr_id,till_date,settlement_upto_date,status) select ?,?,max(settlement_upto_date),? from st_ola_rummy_plr_deposit_comm_status &quot;;</span>
				//	String query =&quot;insert into st_ola_rummy_plr_deposit_comm_status(plr_id,till_date,settlement_upto_date,status) values(?,?,?,?)&quot;;
<span class="nc" id="L88">				Calendar cal = Calendar.getInstance();</span>
<span class="nc" id="L89">				java.sql.Date tillDate = new java.sql.Date(cal.getTime().getTime());			</span>
<span class="nc" id="L90">				PreparedStatement ps =con.prepareStatement(query);</span>
<span class="nc" id="L91">				ps.setString(1,plrId);	</span>
<span class="nc" id="L92">				ps.setDate(2,tillDate);</span>
				//ps.setDate(3,tillDate);
<span class="nc" id="L94">				ps.setString(3,&quot;DONE&quot;);</span>
<span class="nc" id="L95">				ps.executeUpdate();	</span>
			}
		

<span class="nc" id="L99">		} catch (SQLException e) {</span>
<span class="nc" id="L100">			e.printStackTrace();</span>
<span class="nc" id="L101">			throw new LMSException(</span>
					&quot;ERROR occured during inserting entry in plr affiliate binding table&quot;);
<span class="nc" id="L103">		}</span>
<span class="nc" id="L104">	}</span>

	public static double fetchOLACommOfOrganization(int walletId, int orgId,
			String commType, String orgType, Connection con)
			throws SQLException {
<span class="nc" id="L109">		String fetCommAmount = &quot;&quot;;</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">		if (&quot;NETGAMING&quot;.equalsIgnoreCase(commType)) {</span>

<span class="nc bnc" id="L112" title="All 2 branches missed.">			if (&quot;RETAILER&quot;.equalsIgnoreCase(orgType)) {</span>
<span class="nc" id="L113">				fetCommAmount = &quot;select a.wallet_id, a.default_ret_net_gaming_comm, b.net_gaming_comm_variance , &quot;</span>
						+ &quot;(ifnull(b.net_gaming_comm_variance, 0)+ a.default_ret_net_gaming_comm) 'total_comm' from&quot;
						+ &quot; ( select wallet_id ,ret_net_gaming_comm as default_ret_net_gaming_comm from st_ola_wallet_master&quot;
						+ &quot; where wallet_id = ?) a left join  ( select retailer_org_id, net_gaming_comm_variance,&quot;
						+ &quot; wallet_id  from st_ola_agent_retailer_comm_variance where wallet_id = ? and  &quot;
						+ &quot;retailer_org_id = ?)   b on a.wallet_id = b.wallet_id &quot;;
<span class="nc" id="L119">				logger.debug(&quot;NetGaming Ret Commision Variance.&quot;);</span>
				// tem.out.println(&quot;PWT Commission Variance.&quot;);
<span class="nc bnc" id="L121" title="All 2 branches missed.">			} else if (&quot;AGENT&quot;.equalsIgnoreCase(orgType)) {</span>
<span class="nc" id="L122">				fetCommAmount = &quot;select a.wallet_id, a.default_agt_net_gaming_comm, b.net_gaming_comm_variance ,&quot;</span>
						+ &quot; (ifnull(b.net_gaming_comm_variance, 0)+ a.default_agt_net_gaming_comm) 'total_comm' &quot;
						+ &quot;from (select wallet_id ,agt_net_gaming_comm as default_agt_net_gaming_comm &quot;
						+ &quot;from st_ola_wallet_master where wallet_id = ?) a  left join &quot;
						+ &quot;( select agent_org_id, net_gaming_comm_variance, wallet_id  &quot;
						+ &quot;from st_ola_bo_agent_comm_variance where wallet_id = ? and  agent_org_id = ?)&quot;
						+ &quot; b on a.wallet_id = b.wallet_id&quot;;
<span class="nc" id="L129">				logger.debug(&quot;NetGaming Agt Commision Variance.&quot;);</span>
				// tem.out.println(&quot;PWT Commision Variance.&quot;);
			} else {
<span class="nc" id="L132">				logger.error(&quot;ERROR:: Org type is not Defined properly :: &quot;</span>
						+ orgType);

			}

		}
<span class="nc bnc" id="L138" title="All 2 branches missed.">		if (&quot;DEPOSIT&quot;.equalsIgnoreCase(commType)) {</span>

<span class="nc bnc" id="L140" title="All 2 branches missed.">			if (&quot;RETAILER&quot;.equalsIgnoreCase(orgType)) {</span>
<span class="nc" id="L141">				fetCommAmount = &quot;select a.wallet_id, a.default_ret_deposit_comm, b.deposit_comm_variance , &quot;</span>
						+ &quot;(ifnull(b.deposit_comm_variance, 0)+ a.default_ret_deposit_comm) 'total_comm' from&quot;
						+ &quot; ( select wallet_id ,ret_deposit_comm as default_ret_deposit_comm from st_ola_wallet_master&quot;
						+ &quot; where wallet_id = ?) a left join  ( select retailer_org_id, deposit_comm_variance,&quot;
						+ &quot; wallet_id  from st_ola_agent_retailer_comm_variance where wallet_id = ? and  &quot;
						+ &quot;retailer_org_id = ?)   b on a.wallet_id = b.wallet_id &quot;;
<span class="nc" id="L147">				logger.debug(&quot;OLA Deposit Ret Commision Variance.&quot;);</span>
				// tem.out.println(&quot;PWT Commission Variance.&quot;);
<span class="nc bnc" id="L149" title="All 2 branches missed.">			} else if (&quot;AGENT&quot;.equalsIgnoreCase(orgType)) {</span>
<span class="nc" id="L150">				fetCommAmount = &quot;select a.wallet_id, a.default_agt_deposit_comm, b.deposit_comm_variance ,&quot;</span>
						+ &quot; (ifnull(b.deposit_comm_variance, 0)+ a.default_agt_deposit_comm) 'total_comm' &quot;
						+ &quot;from (select wallet_id ,agt_deposit_comm as default_agt_deposit_comm &quot;
						+ &quot;from st_ola_wallet_master where wallet_id = ?) a  left join &quot;
						+ &quot;( select agent_org_id, deposit_comm_variance, wallet_id  &quot;
						+ &quot;from st_ola_bo_agent_comm_variance where wallet_id = ? and  agent_org_id = ?)&quot;
						+ &quot; b on a.wallet_id = b.wallet_id&quot;;
<span class="nc" id="L157">				logger.debug(&quot;NetGaming Agt Commision Variance.&quot;);</span>
				// tem.out.println(&quot;PWT Commision Variance.&quot;);
			} else {
<span class="nc" id="L160">				logger.error(&quot;ERROR:: Org type is not Defined properly :: &quot;</span>
						+ orgType);

			}

		}
<span class="nc bnc" id="L166" title="All 2 branches missed.">		if (&quot;WITHDRAWAL&quot;.equalsIgnoreCase(commType)) {</span>

<span class="nc bnc" id="L168" title="All 2 branches missed.">			if (&quot;RETAILER&quot;.equalsIgnoreCase(orgType)) {</span>
<span class="nc" id="L169">				fetCommAmount = &quot;select a.wallet_id, a.default_ret_withdrawl_comm, b.withdrawl_comm_variance , &quot;</span>
						+ &quot;(ifnull(b.withdrawl_comm_variance, 0)+ a.default_ret_withdrawl_comm) 'total_comm' from&quot;
						+ &quot; ( select wallet_id ,ret_withdrawl_comm as default_ret_withdrawl_comm from st_ola_wallet_master&quot;
						+ &quot; where wallet_id = ?) a left join  ( select retailer_org_id, withdrawl_comm_variance,&quot;
						+ &quot; wallet_id  from st_ola_agent_retailer_comm_variance where wallet_id = ? and  &quot;
						+ &quot;retailer_org_id = ?)   b on a.wallet_id = b.wallet_id &quot;;
<span class="nc" id="L175">				logger.debug(&quot;NetGaming Ret Commision Variance.&quot;);</span>
				// tem.out.println(&quot;PWT Commission Variance.&quot;);
<span class="nc bnc" id="L177" title="All 2 branches missed.">			} else if (&quot;AGENT&quot;.equalsIgnoreCase(orgType)) {</span>
<span class="nc" id="L178">				fetCommAmount = &quot;select a.wallet_id, a.default_agt_withdrawl_comm, b.withdrawl_comm_variance ,&quot;</span>
						+ &quot; (ifnull(b.withdrawl_comm_variance, 0)+ a.default_agt_withdrawl_comm) 'total_comm' &quot;
						+ &quot;from (select wallet_id ,agt_withdrawl_comm as default_agt_withdrawl_comm &quot;
						+ &quot;from st_ola_wallet_master where wallet_id = ?) a  left join &quot;
						+ &quot;( select agent_org_id, withdrawl_comm_variance, wallet_id  &quot;
						+ &quot;from st_ola_bo_agent_comm_variance where wallet_id = ? and  agent_org_id = ?)&quot;
						+ &quot; b on a.wallet_id = b.wallet_id&quot;;
<span class="nc" id="L185">				logger.debug(&quot;NetGaming Agt Commision Variance.&quot;);</span>
				// tem.out.println(&quot;PWT Commision Variance.&quot;);
			} else {
<span class="nc" id="L188">				logger.error(&quot;ERROR:: Org type is not Defined properly :: &quot;</span>
						+ orgType);

			}

		}

<span class="nc" id="L195">		PreparedStatement fetCommAmountPstmt = con</span>
				.prepareStatement(fetCommAmount);
<span class="nc" id="L197">		fetCommAmountPstmt.setInt(1, walletId);</span>
<span class="nc" id="L198">		fetCommAmountPstmt.setInt(2, walletId);</span>
<span class="nc" id="L199">		fetCommAmountPstmt.setInt(3, orgId);</span>
<span class="nc" id="L200">		ResultSet rs = fetCommAmountPstmt.executeQuery();</span>
<span class="nc" id="L201">		double commAmt = 0.0;</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">		if (rs.next()) {</span>
<span class="nc" id="L203">			commAmt = rs.getDouble(&quot;total_comm&quot;);</span>
		}
		// logger.debug(&quot; commAmt = &quot; + commAmt + &quot; ,   fetCommAmountPStmt = &quot;
		// + fetCommAmountPstmt);
		// tem.out.println(&quot; commAmt = &quot; + commAmt + &quot; , fetCommAmountPStmt = &quot;
		// + fetCommAmountPstmt);
<span class="nc" id="L209">		return commAmt;</span>

	}

	public static void getNUpdatePlrCommForAllRetailers(String rootPath)
			throws ParserConfigurationException, SAXException, IOException,
			ParseException {

		try {
<span class="nc" id="L218">			Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L219">			String walletQry = &quot;select wallet_id, wallet_name from st_ola_wallet_master&quot;;</span>
<span class="nc" id="L220">			PreparedStatement walletPstmt = con.prepareStatement(walletQry);</span>
<span class="nc" id="L221">			ResultSet rsWallet = walletPstmt.executeQuery();</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">			while (rsWallet.next()) {</span>
<span class="nc" id="L223">				int walletId = rsWallet.getInt(&quot;wallet_id&quot;);</span>

			// first get the list of all the retailers and ref_user_id map
<span class="nc" id="L226">			Calendar calStart = Calendar.getInstance();</span>
<span class="nc" id="L227">			Calendar calEnd = Calendar.getInstance();</span>
			// cal.add(Calendar.DAY_OF_MONTH, -1);
			
<span class="nc" id="L230">			con.setAutoCommit(false);</span>
<span class="nc" id="L231">			PreparedStatement getLatestDtPstmt = null;</span>
<span class="nc" id="L232">			ResultSet rsLatestDt = null;</span>
<span class="nc" id="L233">			String getRetailers = &quot;select * from st_ola_org_affiliate_mapping&quot;;</span>
<span class="nc" id="L234">			PreparedStatement getRetailersPstmt = con</span>
					.prepareStatement(getRetailers);
<span class="nc" id="L236">			ResultSet rs = getRetailersPstmt.executeQuery();</span>
<span class="nc" id="L237">			String getLatestDate = &quot;   select date from st_ola_daily_retailer_commission_&quot;</span>
					+ walletId + &quot; order by date desc limit 1&quot;;
<span class="nc" id="L239">			getLatestDtPstmt = con.prepareStatement(getLatestDate);</span>
<span class="nc" id="L240">			rsLatestDt = getLatestDtPstmt.executeQuery();</span>
<span class="nc" id="L241">			java.util.Date currDate = new java.util.Date(calStart</span>
					.getTimeInMillis());
<span class="nc" id="L243">			SimpleDateFormat frmt = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span>
<span class="nc" id="L244">			Date endDate = frmt.parse(new java.sql.Date(new Date().getTime())</span>
					+ &quot;&quot;);
<span class="nc bnc" id="L246" title="All 2 branches missed.">			if (rsLatestDt.next()) {</span>
<span class="nc" id="L247">				calStart.setTime(rsLatestDt.getDate(&quot;date&quot;));</span>
<span class="nc" id="L248">				calStart.add(Calendar.DAY_OF_MONTH, 1);</span>
			} else {
<span class="nc" id="L250">				calStart.setTime(currDate);</span>
<span class="nc" id="L251">				calStart.add(Calendar.DAY_OF_MONTH, -3);</span>
			}
<span class="nc" id="L253">			calEnd.setTime(endDate);</span>
<span class="nc" id="L254">			calEnd.add(Calendar.DAY_OF_MONTH,-2);</span>
<span class="nc" id="L255">			Date devDate = calStart.getTime();</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L257">				int retOrgId = rs.getInt(&quot;organization_id&quot;);</span>
<span class="nc" id="L258">				String refUserId = rs.getString(&quot;ref_user_id&quot;);</span>
<span class="nc" id="L259">				calStart.setTime(devDate);</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">				while (calStart.compareTo(calEnd) &lt; 0) {</span>
<span class="nc" id="L261">					java.sql.Date date = new java.sql.Date(calStart.getTime()</span>
							.getTime());
<span class="nc" id="L263">					String date1 = frmt.format(date);</span>
<span class="nc" id="L264">					List&lt;OlaNetGamingRowList&gt; plrCommBealList = OLAUtility</span>
							.getPlrsCommissionOfRetailer(refUserId, date1,
									date1, rootPath);
<span class="nc bnc" id="L267" title="All 2 branches missed.">					if (plrCommBealList != null) {</span>
<span class="nc" id="L268">						insertPlrCommInOLA(plrCommBealList, con,retOrgId, walletId, date);</span>
					} else {
<span class="nc" id="L270">						System.out</span>
								.println(&quot;There are no details of Retailer Name &quot;
										+ refUserId + &quot; in Playtech System&quot;);
					}
<span class="nc" id="L274">					con.commit();</span>
<span class="nc" id="L275">					calStart.add(Calendar.DAY_OF_MONTH, 1);</span>
<span class="nc" id="L276">				}</span>
<span class="nc" id="L277">			}</span>
<span class="nc" id="L278">			}</span>
<span class="nc" id="L279">		} catch (SQLException e) {</span>
<span class="nc" id="L280">			e.printStackTrace();</span>
<span class="nc" id="L281">		}</span>
<span class="nc" id="L282">	}</span>

	public static void insertPlrCommInOLA(
			List&lt;OlaNetGamingRowList&gt; plrCommBealList, Connection con, int retOrgId,int walletId, Date startDate) {
		try {
<span class="nc" id="L287">			Statement getLatestDtStmt = null;</span>
<span class="nc" id="L288">			String insertQry = null;</span>
<span class="nc" id="L289">			String playerUserName = null;</span>
<span class="nc" id="L290">			String advertiserName = null;</span>
<span class="nc" id="L291">			Double playerNetGaming = 0.0;</span>
<span class="nc" id="L292">			Double thirdPartycommission = 0.0;</span>
<span class="nc" id="L293">			getLatestDtStmt = con.createStatement();</span>

<span class="nc bnc" id="L295" title="All 2 branches missed.">			for (OlaNetGamingRowList playerCommissionBean : plrCommBealList) {</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">				for (OlaNetGamingRetailerData retailerCommissionBean : playerCommissionBean</span>
						.getColumnList()) {
<span class="nc" id="L298">					String tagName = retailerCommissionBean.getName();</span>
<span class="nc" id="L299">					String tagValue = retailerCommissionBean.getColumn();</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">					if (tagName.equalsIgnoreCase(&quot;Player username&quot;)) {</span>
<span class="nc" id="L301">						playerUserName = tagValue;</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">					} else if (tagName.equalsIgnoreCase(&quot;Advertiser username&quot;)) {</span>
<span class="nc" id="L303">						advertiserName = tagValue;</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">					} else if (tagName.equalsIgnoreCase(&quot;Player net gaming&quot;)) {</span>
<span class="nc" id="L305">						playerNetGaming = Double.parseDouble(tagValue);</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">					} else if (tagName.equalsIgnoreCase(&quot;Earned commission&quot;)) {</span>
<span class="nc" id="L307">						thirdPartycommission = Double.parseDouble(tagValue);</span>
					}
<span class="nc" id="L309">				}</span>
<span class="nc" id="L310">				insertQry = &quot;insert into st_ola_daily_retailer_commission_&quot;+walletId+ &quot;(ret_org_id, plr_id, plr_net_gaming, date, status,commission_TP) values(&quot;+retOrgId+ &quot;,'&quot;+playerUserName+&quot;', &quot;+ String.format(&quot;%.2f&quot;, playerNetGaming) + &quot;,'&quot; + startDate + &quot;', 'PENDING', &quot;+String.format(&quot;%.2f&quot;, thirdPartycommission)+&quot;) &quot;;</span>
<span class="nc" id="L311">				getLatestDtStmt.executeUpdate(insertQry);</span>
<span class="nc" id="L312">				}</span>

<span class="nc" id="L314">		} catch (SQLException e) {</span>
<span class="nc" id="L315">			e.printStackTrace();</span>
<span class="nc" id="L316">		}</span>
<span class="nc" id="L317">	}</span>

	/**
	 * This method is used to get the commission of all player of supplied
	 * retailer for given date
	 * 
	 * @param retOrgId
	 *            retailers organization id
	 * @param retRefUserId
	 *            retailers ref_user_id used to communicate with 3rd Party
	 * @param date
	 *            commission date
	 */
	/*
	 * public static void getPlrsCommOfRetailer(int retOrgId,String
	 * retRefUserId,Date date){ //here communicate with playtech and get the
	 * response string String plrCommString =
	 * OLAUtility.gatPlrCommission(retRefUserId, date.toString(),
	 * date.toString()); //here parse the string and build the list of
	 * playercommiissiobean }
	 */

	public static double fetchDGCommOfOrganization(int gameId, int orgId,
			String commType, String orgType, Connection con)
			throws SQLException {
<span class="nc" id="L342">		String fetCommAmount = &quot;&quot;;</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">		if (&quot;PWT&quot;.equalsIgnoreCase(commType)) {</span>

<span class="nc bnc" id="L345" title="All 2 branches missed.">			if (&quot;RETAILER&quot;.equalsIgnoreCase(orgType)) {</span>
<span class="nc" id="L346">				fetCommAmount = &quot;select a.game_id, a.default_pwt_comm_rate, b.pwt_comm_variance , &quot;</span>
						+ &quot; (ifnull(b.pwt_comm_variance, 0)+ a.default_pwt_comm_rate) 'total_comm' from&quot;
						+ &quot; (select game_id ,retailer_pwt_comm_rate as default_pwt_comm_rate from st_dg_game_master&quot;
						+ &quot; where game_id = ?) a  left join ( select retailer_org_id, pwt_comm_variance, game_id &quot;
						+ &quot; from st_dg_agent_retailer_sale_pwt_comm_variance where game_id = ? and  retailer_org_id = ?)&quot;
						+ &quot; b on a.game_id = b.game_id &quot;;
<span class="nc" id="L352">				logger.debug(&quot;PWT Ret Commision Variance.&quot;);</span>
				// tem.out.println(&quot;PWT Commission Variance.&quot;);
<span class="nc bnc" id="L354" title="All 2 branches missed.">			} else if (&quot;AGENT&quot;.equalsIgnoreCase(orgType)) {</span>
<span class="nc" id="L355">				fetCommAmount = &quot;select a.game_id, a.default_pwt_comm_rate, b.pwt_comm_variance , &quot;</span>
						+ &quot; (ifnull(b.pwt_comm_variance, 0)+ a.default_pwt_comm_rate) 'total_comm' from &quot;
						+ &quot; (select game_id ,agent_pwt_comm_rate as default_pwt_comm_rate from st_dg_game_master&quot;
						+ &quot; where game_id = ?) a  left join ( select agent_org_id, pwt_comm_variance, game_id &quot;
						+ &quot; from st_dg_bo_agent_sale_pwt_comm_variance where game_id = ? and  agent_org_id = ?)&quot;
						+ &quot; b on a.game_id = b.game_id &quot;;
<span class="nc" id="L361">				logger.debug(&quot;PWT Agt Commision Variance.&quot;);</span>
				// tem.out.println(&quot;PWT Commision Variance.&quot;);
			} else {
<span class="nc" id="L364">				logger.error(&quot;ERROR:: Org type is not Defined properly :: &quot;</span>
						+ orgType);

			}

		} else { // sale commission variance
<span class="nc bnc" id="L370" title="All 2 branches missed.">			if (&quot;RETAILER&quot;.equalsIgnoreCase(orgType)) {</span>
<span class="nc" id="L371">				fetCommAmount = &quot;select a.game_id, a.default_sale_comm_rate, b.sale_comm_variance , &quot;</span>
						+ &quot;(ifnull(b.sale_comm_variance, 0)+ a.default_sale_comm_rate) 'total_comm' from &quot;
						+ &quot;(select game_id ,retailer_sale_comm_rate as default_sale_comm_rate from st_dg_game_master&quot;
						+ &quot; where game_id = ?) a  left join (select retailer_org_id, sale_comm_variance, game_id &quot;
						+ &quot; from st_dg_agent_retailer_sale_pwt_comm_variance where game_id = ? and  retailer_org_id = ?)&quot;
						+ &quot; b on a.game_id = b.game_id &quot;;
				// logger.info(&quot;RET Sale Commision Variance.&quot;);
				// tem.out.println(&quot;RET Sale Commision Variance.&quot;);
<span class="nc bnc" id="L379" title="All 2 branches missed.">			} else if (&quot;AGENT&quot;.equalsIgnoreCase(orgType)) {</span>
<span class="nc" id="L380">				fetCommAmount = &quot;select a.game_id, a.default_sale_comm_rate, b.sale_comm_variance ,&quot;</span>
						+ &quot; (ifnull(b.sale_comm_variance, 0)+ a.default_sale_comm_rate) 'total_comm' from &quot;
						+ &quot; (select game_id ,agent_sale_comm_rate as default_sale_comm_rate from st_dg_game_master &quot;
						+ &quot; where game_id = ?) a  left join ( select agent_org_id, sale_comm_variance, game_id &quot;
						+ &quot; from st_dg_bo_agent_sale_pwt_comm_variance where game_id = ? and  agent_org_id = ?)&quot;
						+ &quot; b on a.game_id = b.game_id &quot;;
				// logger.info(&quot;Agent Sale Commision Variance.&quot;);
				// tem.out.println(&quot;Agent Sale Commision Variance.&quot;);
			} else {
<span class="nc" id="L389">				logger.error(&quot;ERROR:: Org type is not Defined properly :: &quot;</span>
						+ orgType);
<span class="nc" id="L391">				logger.debug(&quot;ERROR:: Org type is not Defined properly :: &quot;</span>
						+ orgType);
			}
		}
<span class="nc" id="L395">		PreparedStatement fetCommAmountPstmt = con</span>
				.prepareStatement(fetCommAmount);
<span class="nc" id="L397">		fetCommAmountPstmt.setInt(1, gameId);</span>
<span class="nc" id="L398">		fetCommAmountPstmt.setInt(2, gameId);</span>
<span class="nc" id="L399">		fetCommAmountPstmt.setInt(3, orgId);</span>
<span class="nc" id="L400">		ResultSet rs = fetCommAmountPstmt.executeQuery();</span>
<span class="nc" id="L401">		double commAmt = 0.0;</span>
<span class="nc bnc" id="L402" title="All 2 branches missed.">		if (rs.next()) {</span>
<span class="nc" id="L403">			commAmt = rs.getDouble(&quot;total_comm&quot;);</span>
		}
		// logger.debug(&quot; commAmt = &quot; + commAmt + &quot; ,   fetCommAmountPStmt = &quot;
		// + fetCommAmountPstmt);
		// tem.out.println(&quot; commAmt = &quot; + commAmt + &quot; , fetCommAmountPStmt = &quot;
		// + fetCommAmountPstmt);
<span class="nc" id="L409">		return commAmt;</span>

	}

	public static void main(String[] args) {
		try {

			//getNUpdatePlrCommForAllRetailers(2, &quot;AUTO&quot;, &quot;AUTO&quot;);
		} catch (Exception e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
<span class="nc" id="L420">		}</span>
<span class="nc" id="L421">	}</span>

	private Connection connection;

	private PreparedStatement pstmt;

	private ResultSet result;

	/**
	 * this method is depricated and not used commented on 10 july 2013 by sumit
	 * 
	 * @param pwtList
	 * @param gameId
	 * @param agentUserId
	 * @param agtOrgId
	 * @param partyId
	 * @param partyUserId
	 * @param partyPwtCommRate
	 * @param agtPwtCommRate
	 * @param gameNbr
	 * @param orgPwtLimit
	 * @param connection
	 * @param partyType
	 * @param requestDetailsBean
	 * @return
	 * @throws SQLException
	 * @throws LMSException
	 */
/*	public long agtEndPWTPaymentProcess(List&lt;PwtBean&gt; pwtList, int gameId,
			int agentUserId, int agtOrgId, int partyId, int partyUserId,
			double partyPwtCommRate, double agtPwtCommRate, int gameNbr,
			OrgPwtLimitBean orgPwtLimit, Connection connection,
			String partyType, PlayerPWTBean requestDetailsBean)
			throws SQLException, LMSException {

		PwtBean pwtBean;
		int pwtListSize = pwtList.size();
		double pwtAmt = 0.0;
		double commAmt = 0.0;
		double retNetAmt = 0.0;
		double retCreditAmt = 0.0;
		double totalClmBal = 0.0;
		double totalUnClmBal = 0.0;
		double retTotalUnclmBal = 0.0;
		long  transId = 0;
		boolean isClaimmable;

		// insert data into main transaction master
		logger.debug(&quot;insert data into transaction master &quot; + &quot;type  is&quot;
				+ partyType);
		// tem.out.println(&quot;insert data into transaction master &quot; + &quot;type is&quot; +
		// partyType);
		String transMasQuery = QueryManager.insertInLMSTransactionMaster();
		PreparedStatement pstmt = connection.prepareStatement(transMasQuery);
		pstmt.setString(1, &quot;AGENT&quot;);
		pstmt.executeUpdate();
		ResultSet rs = pstmt.getGeneratedKeys();
		if (rs.next()) {
			transId = rs.getLong(1);

			// insert into agent transaction master
			// String retTransMasterQuery = &quot;insert into
			// st_lms_retailer_transaction_master ( transaction_id ,
			// retailer_user_id , retailer_org_id , transaction_date ,
			// transaction_type ) values (?,?,?,?,?)&quot;;
			String agtTransMasterQuery = QueryManager
					.insertInAgentTransactionMaster();
			logger.debug(&quot;agtTransMasterQuery = &quot; + agtTransMasterQuery);
			// tem.out.println(&quot;agtTransMasterQuery = &quot; +
			// agtTransMasterQuery);
			pstmt = connection.prepareStatement(agtTransMasterQuery);
			pstmt.setLong(1, transId);
			pstmt.setInt(2, agentUserId);
			pstmt.setInt(3, agtOrgId);

			if (&quot;RETAILER&quot;.equals(partyType)) {
				pstmt.setString(4, &quot;RETAILER&quot;);
				pstmt.setInt(5, partyId);
				pstmt.setString(6, &quot;PWT&quot;);
			} else if (&quot;PLAYER&quot;.equals(partyType)) {
				pstmt.setString(4, &quot;PLAYER&quot;);
				pstmt.setInt(5, partyId);
				pstmt.setString(6, &quot;PWT_PLR&quot;);
			}

			pstmt.setTimestamp(7, new java.sql.Timestamp(new java.util.Date()
					.getTime()));
			pstmt.executeUpdate();
			logger.debug(&quot;insert into agent transaction master = &quot; + pstmt);
			// tem.out.println(&quot;insert into agent transaction master = &quot; +
			// pstmt);

			// insert into st_agent_pwt when comes pwtAmt is in payment and
			// approval limit
			String agtPwtEntry = &quot;insert into  st_se_agent_pwt ( virn_code, transaction_id ,game_id,agent_user_id,retailer_user_id,retailer_org_id,pwt_amt,comm_amt,net_amt,agent_org_id,status,claim_comm ) values ( ?, ?, ?, ?, ?, ?, ?, ?, ?, ?,?,?)&quot;;
			pstmt = connection.prepareStatement(agtPwtEntry);

			// update st_retailer_pwt in case if retailer brings unclaimed PWTs
			// to agent
			String retPwtUpdateQuery = &quot;update  st_retailer_pwt set status=? where game_id = ? and virn_code = ? and retailer_org_id = ? &quot;;
			PreparedStatement retPwtUpdatePstmt = connection
					.prepareStatement(retPwtUpdateQuery);

			// insert in st direct player table in case of player
			String insertAgtDirectPlr = &quot;insert into st_agt_direct_player_pwt(task_id,agent_user_id,agent_org_id,ticket_nbr,virn_code,transaction_id,game_id,player_id,pwt_amt,tax_amt,net_amt,payment_type,cheque_nbr,cheque_date,drawee_bank,issuing_party_name,pwt_claim_status,claim_comm,transaction_date) values(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)&quot;;
			PreparedStatement dirPlrPstmt = connection
					.prepareStatement(insertAgtDirectPlr);

			String updateVirnInvQuery = &quot;update st_pwt_inv_? set status = ? where game_id = ? and virn_code = ?&quot;;
			PreparedStatement invPstmt = connection
					.prepareStatement(updateVirnInvQuery);

			for (int i = 0; i &lt; pwtListSize; i++) {
				pwtBean = (PwtBean) pwtList.get(i);

				if (pwtBean.getIsValid()
						&amp;&amp; Double.parseDouble(pwtBean.getPwtAmount()) &gt; orgPwtLimit
								.getPayLimit()) {
					pwtBean.setValid(false);
					pwtBean.setMessage(&quot;Pwt Amount is not agents Pay Limit&quot;);
					pwtBean.setVerificationStatus(&quot;Invalid&quot;);
				} else if (pwtBean.getIsValid()) {
					pwtAmt = Double.parseDouble(pwtBean.getPwtAmount());
					String encodedVirn = pwtBean.getEncVirnCode();
					// pwtAmt = Double.parseDouble(pwtBean.getPwtAmount());
					if (&quot;YES&quot;.equalsIgnoreCase(orgPwtLimit.getIsPwtAutoScrap())
							&amp;&amp; pwtAmt &lt;= orgPwtLimit.getScrapLimit()) {
						isClaimmable = true;
					} else {
						isClaimmable = false;
					}

					if (&quot;RETAILER&quot;.equals(partyType)) {
						pstmt.setString(1, encodedVirn);
						pstmt.setLong(2, transId);
						pstmt.setInt(3, gameId);
						pstmt.setInt(4, agentUserId);
						pstmt.setInt(5, partyUserId);
						pstmt.setInt(6, partyId);

						// pwtAmt = Double.parseDouble(pwtBean.getPwtAmount());
						commAmt = pwtAmt * partyPwtCommRate * 0.01;
						retNetAmt = pwtAmt + commAmt;

						// for creditUpdation
						retCreditAmt += retNetAmt;

						if (!&quot;NONE&quot;.equalsIgnoreCase(pwtBean.getInUnclmed())) {
							// update retailer pwt status for unclaimed pwt as
							// done
							retPwtUpdatePstmt.setString(1, &quot;DONE_UNCLM&quot;);
							retPwtUpdatePstmt.setInt(2, gameId);
							retPwtUpdatePstmt.setString(3, encodedVirn);
							retPwtUpdatePstmt.setInt(4, partyId);
							int row = retPwtUpdatePstmt.executeUpdate();
							if (row == 1) {
								retTotalUnclmBal += pwtAmt;
							}

						}
						pstmt.setDouble(7, pwtAmt);
						pstmt.setDouble(8, commAmt);
						pstmt.setDouble(9, retNetAmt);
						pstmt.setInt(10, agtOrgId);

						if (isClaimmable) {
							pstmt.setString(11, &quot;CLAIM_BAL&quot;);
							totalClmBal += pwtAmt + pwtAmt * .01
									* agtPwtCommRate;
						} else {
							pstmt.setString(11, &quot;UNCLAIM_BAL&quot;);
							totalUnClmBal += pwtAmt;
						}
						pstmt.setDouble(12, agtPwtCommRate);

						pstmt.executeUpdate();
					} else if (&quot;PLAYER&quot;.equals(partyType)) {
						dirPlrPstmt.setInt(1, requestDetailsBean.getTaskId());
						dirPlrPstmt.setInt(2, agentUserId);
						dirPlrPstmt.setInt(3, agtOrgId);
						dirPlrPstmt.setString(4, requestDetailsBean
								.getTicketNbr());
						dirPlrPstmt.setString(5, requestDetailsBean
								.getVirnCode());
						dirPlrPstmt.setLong(6, transId);
						dirPlrPstmt.setInt(7, gameId);
						dirPlrPstmt.setInt(8, partyId);
						dirPlrPstmt.setDouble(9, pwtAmt);
						dirPlrPstmt.setDouble(10, requestDetailsBean.getTax());
						dirPlrPstmt.setDouble(11, requestDetailsBean
								.getNetAmt());
						dirPlrPstmt.setString(12, requestDetailsBean
								.getPaymentType());
						dirPlrPstmt.setTimestamp(13, new java.sql.Timestamp(
								new java.util.Date().getTime()));

						if (&quot;cash&quot;.equalsIgnoreCase(requestDetailsBean
								.getPaymentType())
								|| &quot;TPT&quot;.equalsIgnoreCase(requestDetailsBean
										.getPaymentType())) {
							dirPlrPstmt.setObject(13, null);
							dirPlrPstmt.setObject(14, null);
							dirPlrPstmt.setObject(15, null);
							dirPlrPstmt.setObject(16, null);
						} else if (&quot;CHEQUE&quot;.equalsIgnoreCase(requestDetailsBean
								.getPaymentType())) {
							DateFormat dateFormat = new SimpleDateFormat(
									&quot;dd-MM-yyyy&quot;);
							java.sql.Date chqDate = null;
							try {
								if (!&quot;&quot;.equalsIgnoreCase(requestDetailsBean
										.getChequeDate())
										&amp;&amp; requestDetailsBean.getChequeDate() != null) {
									chqDate = new java.sql.Date(dateFormat
											.parse(
													requestDetailsBean
															.getChequeDate())
											.getTime());
								}
							} catch (ParseException e) {
								e.printStackTrace();
								throw new LMSException(
										&quot;Exception date parsing  while pwt payments at Agent end &quot;,
										e);
							}

							dirPlrPstmt.setString(13, requestDetailsBean
									.getChequeNbr());
							dirPlrPstmt.setDate(14, chqDate);
							dirPlrPstmt.setString(15, requestDetailsBean
									.getDraweeBank());
							dirPlrPstmt.setString(16, requestDetailsBean
									.getIssuingPartyName());
						} else {
							throw new LMSException(
									&quot;Exception or Error No payment type specified &quot;
											+ requestDetailsBean
													.getPaymentType());
						}

						if (isClaimmable) {
							dirPlrPstmt.setString(17, &quot;CLAIM_BAL&quot;);
							// pstmt.setString(11, &quot;CLAIM_BAL&quot;);
							totalClmBal += pwtAmt + pwtAmt * .01
									* agtPwtCommRate;
						} else {
							dirPlrPstmt.setString(17, &quot;UNCLAIM_BAL&quot;);
							// pstmt.setString(11, &quot;UNCLAIM_BAL&quot;);
							totalUnClmBal += pwtAmt;
						}
						dirPlrPstmt.setDouble(18, agtPwtCommRate);
						dirPlrPstmt.setDate(19, new java.sql.Date(new Date()
								.getTime()));
						dirPlrPstmt.executeUpdate();
						logger.debug(&quot;insert in direct player table &quot;
								+ dirPlrPstmt);
						// tem.out.println(&quot;insert in direct player table &quot; +
						// dirPlrPstmt); // update status of of requested id
						// entries into
						// st_pwt_approval_request_master
						String updateAppTable = &quot;update  st_pwt_approval_request_master  set req_status ='PAID', &quot;
								+ &quot;remarks ='Payment Done', payment_done_by_type =?, payment_done_by =?, transaction_id=? where  task_id = ?&quot;;
						pstmt = connection.prepareStatement(updateAppTable);
						pstmt.setString(1, &quot;AGENT&quot;);
						pstmt.setInt(2, agtOrgId);
						pstmt.setLong(3, transId);
						pstmt.setInt(4, requestDetailsBean.getTaskId());
						int j = pstmt.executeUpdate();
						logger.debug(&quot;total row updated = &quot; + j
								+ &quot; ,  requested id &quot;
								+ requestDetailsBean.getTaskId()
								+ &quot; status updated = &quot; + pstmt);
						// tem.out.println(&quot;total row updated = &quot; + j + &quot; ,
						// requested id &quot; + requestDetailsBean.getTaskId() + &quot;
						// status updated = &quot; + pstmt);
						if (j &lt; 1) {
							throw new LMSException(
									&quot;st_pwt_approval_request_master table not updated.&quot;);
						}

					}

					// insert in ticket table
					if (&quot;RETAILER&quot;.equals(partyType)
							&amp;&amp; requestDetailsBean != null) {
						// update the ticket_inv_detail table
						CommonFunctionsHelper commHelper = new CommonFunctionsHelper();
						commHelper.updateTicketInvTable(requestDetailsBean
								.getTicketNbr(), requestDetailsBean
								.getBookNbr(), gameNbr, gameId,
								(isClaimmable ? &quot;CLAIM_RET_CLM&quot;
										: &quot;CLAIM_RET_UNCLM&quot;), agentUserId,
								agtOrgId, &quot;UPDATE&quot;, connection);
					} else if (&quot;PLAYER&quot;.equals(partyType)) {
						CommonFunctionsHelper commHelper = new CommonFunctionsHelper();
						commHelper.updateTicketInvTable(requestDetailsBean
								.getTicketNbr(), requestDetailsBean
								.getBookNbr(), gameNbr, gameId,
								(isClaimmable ? &quot;CLAIM_PLR_AGT_CLM_DIR&quot;
										: &quot;CLAIM_PLR_AGT_UNCLM_DIR&quot;),
								agentUserId, agtOrgId, &quot;UPDATE&quot;, connection);
					}

					String pwtStatus = &quot;&quot;;
					if (&quot;RETAILER&quot;.equals(partyType) &amp;&amp; isClaimmable) {
						pwtStatus = &quot;CLAIM_RET_CLM&quot;;
					} else if (&quot;RETAILER&quot;.equals(partyType) &amp;&amp; !isClaimmable) {
						pwtStatus = &quot;CLAIM_RET_UNCLM&quot;;
					} else if (&quot;PLAYER&quot;.equals(partyType) &amp;&amp; isClaimmable) {
						pwtStatus = &quot;CLAIM_PLR_AGT_CLM_DIR&quot;;
					} else if (&quot;PLAYER&quot;.equals(partyType) &amp;&amp; !isClaimmable) {
						pwtStatus = &quot;CLAIM_PLR_AGT_UNCLM_DIR&quot;;
					}

					// update the remaining prize list
					GameUtilityHelper.updateNoOfPrizeRem(gameId, pwtAmt,
							pwtStatus, encodedVirn, connection, gameNbr);

					// update VIRN status
					updateVirnStatus(gameNbr, pwtStatus, gameId, pwtBean
							.getEncVirnCode(), connection);

				}
			}
			logger.debug(&quot;insert into st_agent_pwt = &quot; + pstmt);
			// tem.out.println(&quot;insert into st_agent_pwt = &quot; + pstmt);

			// update agent CLAIM_BAL payment
			CommonFunctionsHelper commHelper = new CommonFunctionsHelper();
			if (totalClmBal &gt; 0.0) {
				// commHelper.updateOrgBalance(&quot;CLAIM_BAL&quot;, totalClmBal,
				// agtOrgId,&quot;CREDIT&quot;, connection);
				// changed by ARUN when draw game sale come in picture
				commHelper.updateOrgBalance(&quot;CLAIM_BAL&quot;, totalClmBal, agtOrgId,
						&quot;DEBIT&quot;, connection);
			}

			// update agent UNCLAIM_BAL payment
			if (totalUnClmBal &gt; 0.0) {
				commHelper.updateOrgBalance(&quot;UNCLAIM_BAL&quot;, totalUnClmBal,
						agtOrgId, &quot;CREDIT&quot;, connection);
			}

			// for retailer credit update
			if (&quot;RETAILER&quot;.equals(partyType)) {
				OrgCreditUpdation.updateCreditLimitForRetailer(partyId, &quot;PWT&quot;,
						retCreditAmt, connection);
				// update retailer UNCLAIM_BAL payment
				logger.debug(&quot;inside retailer yogesh &quot; + retTotalUnclmBal);
				if (retTotalUnclmBal &gt; 0.0) {
					commHelper.updateOrgBalance(&quot;UNCLAIM_BAL&quot;,
							retTotalUnclmBal, partyId, &quot;DEBIT&quot;, connection);
				}
			}

			// receipt entries are required to be inserted into receipt table

			return transId;

		} else {
			throw new LMSException(
					&quot;no data insert into main transaction master&quot;);
		}

	}*/

	/**
	 * this method is depricated and not used commented on 26 april 2013 by sumit
	 * @param pwtList
	 * @param gameId
	 * @param boOrgName
	 * @param userOrgID
	 * @param agentOrgId
	 * @param agtUserId
	 * @param rootPath
	 * @param userId
	 * @param gameNbr
	 * @return
	 * @throws LMSException
	 */
	/*public String boEndAgtPWTPaymentProcess(List&lt;PwtBean&gt; pwtList, int gameId,
			String boOrgName, int userOrgID, int agentOrgId, int agtUserId,
			String rootPath, int userId, int gameNbr) throws LMSException {

		Connection connection = null;
		PreparedStatement masterPstmt = null;
		PreparedStatement LMSMasterPstmt = null;
		PreparedStatement detailPstmt = null;
		PreparedStatement invPstmt = null;
		PreparedStatement agtPwtUpdatePstmt = null;

		ResultSet resultSet = null;

		long trnId = -1;
		int boReceiptId = -1;
		// String receiptArr []=null;
		String receipts = null;
		try {
			if (pwtList != null) {
				int size = pwtList.size();
				PwtBean pwtBean = null;

				String masterQuery = null;
				String LMSMasterQuery = null;
				String detailQuery = null;
				String invQuery = null;

				double pwtAmt = 0.0;
				double commAmt = 0.0;
				double netAmt = 0.0;
				double creditAmt = 0.0;
				double debitUnclaim = 0.0;

				if (size &gt; 0) {

					connection = DBConnect.getConnection();
					connection.setAutoCommit(false);

					// get agents game pwtCommRate
					CommonFunctionsHelper commonHelper = new CommonFunctionsHelper();
					double agtPwtCommRate = commonHelper
							.fetchCommOfOrganization(gameId, agentOrgId, &quot;PWT&quot;,
									&quot;AGENT&quot;, connection);

					masterQuery = QueryManager.insertInBOTransactionMaster();
					masterPstmt = connection.prepareStatement(masterQuery);

					detailQuery = QueryManager.getST1PwtBODetailQuery();
					detailPstmt = connection.prepareStatement(detailQuery);

					invQuery = QueryManager.getST1PWTBOUpdateQuery();
					invPstmt = connection.prepareStatement(invQuery);

					// update st_agent_pwt in case if agent brings uncalimed
					// PWTs to BO
					String agtPwtUpdateQuery = &quot;update  st_agent_pwt set status=? where game_id = ? and virn_code = ? and agent_org_id = ? &quot;;
					agtPwtUpdatePstmt = connection
							.prepareStatement(agtPwtUpdateQuery);

					// insert into transaction master
					LMSMasterQuery = QueryManager
							.insertInLMSTransactionMaster();
					LMSMasterPstmt = connection
							.prepareStatement(LMSMasterQuery);
					LMSMasterPstmt.setString(1, &quot;BO&quot;);
					LMSMasterPstmt.executeUpdate();
					resultSet = LMSMasterPstmt.getGeneratedKeys();
					if (resultSet.next()) {
						trnId = resultSet.getLong(1);
					} else {
						throw new LMSException(
								&quot;Transaction id is not generated&quot;);
					}

					// insert into BO transaction master
					masterPstmt.setLong(1, trnId);
					masterPstmt.setInt(2, userId);
					masterPstmt.setInt(3, userOrgID);
					masterPstmt.setString(4, &quot;AGENT&quot;);
					masterPstmt.setInt(5, agentOrgId);
					masterPstmt.setTimestamp(6, new java.sql.Timestamp(
							new java.util.Date().getTime()));
					masterPstmt.setString(7, &quot;PWT&quot;);
					masterPstmt.execute();
					// tem.out.println(&quot;transaction Id::&quot; + trnId);

					for (int i = 0; i &lt; size; i++) {
						pwtBean = (PwtBean) pwtList.get(i);

						if (pwtBean.getIsValid()) {

							String encodedVirn = pwtBean.getEncVirnCode();
							detailPstmt.setString(1, encodedVirn);
							detailPstmt.setLong(2, trnId);
							detailPstmt.setInt(3, gameId);
							detailPstmt.setInt(4, agtUserId);
							detailPstmt.setInt(5, agentOrgId);

							pwtAmt = Double.parseDouble(pwtBean.getPwtAmount());
							commAmt = pwtAmt * agtPwtCommRate * 0.01;
							netAmt = pwtAmt + commAmt;
							// for current credit amount update
							creditAmt += netAmt;

							detailPstmt.setDouble(6, pwtAmt);
							detailPstmt.setDouble(7, commAmt);
							detailPstmt.setDouble(8, netAmt);
							detailPstmt.execute();

							if (&quot;IN_PLR_UNCLM&quot;.equalsIgnoreCase(pwtBean
									.getInUnclmed())
									|| &quot;IN_AGENT_UNCLM&quot;
											.equalsIgnoreCase(pwtBean
													.getInUnclmed())) {
								String tableType;
								if (&quot;IN_PLR_UNCLM&quot;.equalsIgnoreCase(pwtBean
										.getInUnclmed())) {
									tableType = &quot;PLAYER&quot;;
								} else {
									tableType = &quot;AGENT&quot;;
								}

								commonHelper.updateOrgForUnClaimedVirn(
										agentOrgId, &quot;AGENT&quot;, encodedVirn,
										&quot;DONE_UNCLM&quot;, gameId, tableType,
										connection);
								debitUnclaim += pwtAmt;
							}

							// update the remaining prize list
							GameUtilityHelper.updateNoOfPrizeRem(gameId,
									pwtAmt, &quot;CLAIM_AGT&quot;, encodedVirn,
									connection, gameNbr);

							invPstmt.setInt(1, gameNbr);
							invPstmt.setInt(2, gameId);
							invPstmt.setString(3, encodedVirn);
							invPstmt.execute();

						}

					}

					// for current credit amount update
					boolean isUpdateDone = OrgCreditUpdation
							.updateCreditLimitForAgent(agentOrgId, &quot;PWT&quot;,
									creditAmt, connection);

					// update AGENT's UNCLAIM_BAL Balance
					if (creditAmt &gt; 0.0) {
						commonHelper.updateOrgBalance(&quot;UNCLAIM_BAL&quot;,
								debitUnclaim, agentOrgId, &quot;DEBIT&quot;, connection);
					}

					// generate receipt for BO
					ArrayList&lt;Long&gt; transList = new ArrayList&lt;Long&gt;();
					transList.add(trnId);
					receipts = generateReceiptBo(connection, agentOrgId,
							&quot;AGENT&quot;, transList);
					// receiptArr = receipts.split(&quot;-&quot;);

					boReceiptId = Integer.parseInt(receipts.split(&quot;-&quot;)[0]);
					if (boReceiptId &gt; 0) {
						connection.commit();
						GraphReportHelper graphReportHelper = new GraphReportHelper();
						graphReportHelper.createTextReportBO(boReceiptId,
								boOrgName, userOrgID, rootPath);
					}

				}
			}
			return receipts;
		} catch (SQLException e) {
			try {
				connection.rollback();
			} catch (SQLException e1) {
				e1.printStackTrace();
				throw new LMSException(e);
			}
			e.printStackTrace();
			throw new LMSException(e);
		} finally {
			try {
				if (masterPstmt != null) {
					masterPstmt.close();
				}
				if (detailPstmt != null) {
					detailPstmt.close();
				}
				if (connection != null) {
					connection.close();
				}
			} catch (SQLException se) {
				se.printStackTrace();
				throw new LMSException(se);
			}
		}
	}*/

	public double fetchCommOfOrganization(int gameId, int orgId,
			String commType, String orgType, Connection con)
			throws SQLException {
<span class="nc" id="L1003">		String fetCommAmount = &quot;&quot;;</span>
<span class="nc bnc" id="L1004" title="All 2 branches missed.">		if (&quot;PWT&quot;.equalsIgnoreCase(commType)) {</span>

<span class="nc bnc" id="L1006" title="All 2 branches missed.">			if (&quot;RETAILER&quot;.equalsIgnoreCase(orgType)) {</span>
<span class="nc" id="L1007">				fetCommAmount = &quot;select a.game_id, a.retailer_pwt_comm_rate, b.pwt_comm_variance , &quot;</span>
						+ &quot;(ifnull(b.pwt_comm_variance, 0)+ a.retailer_pwt_comm_rate) 'total_comm' from &quot;
						+ &quot; (select game_id ,retailer_pwt_comm_rate from st_se_game_master where game_id = ?) a &quot;
						+ &quot; left join (select retailer_org_id, pwt_comm_variance, game_id from &quot;
						+ &quot; st_se_agent_retailer_sale_pwt_comm_variance where game_id = ? and  retailer_org_id = ?) b &quot;
						+ &quot;on a.game_id = b.game_id &quot;;
<span class="nc" id="L1013">				logger.debug(&quot;PWT Commision Variance.&quot;);</span>
				// tem.out.println(&quot;PWT Commision Variance.&quot;);
<span class="nc bnc" id="L1015" title="All 2 branches missed.">			} else if (&quot;AGENT&quot;.equalsIgnoreCase(orgType)) {</span>
<span class="nc" id="L1016">				fetCommAmount = &quot;select (a.agent_pwt_comm_rate+ifnull(b.pwt_comm_variance,0)) total_comm from(&quot;</span>
						+ &quot;select agent_pwt_comm_rate,game_id from st_se_game_master  where game_id=?)a left join&quot;
						+ &quot;(select pwt_comm_variance,game_id from st_se_bo_agent_sale_pwt_comm_variance &quot;
						+ &quot;where  game_id=? and agent_org_id=?) b on a.game_id=b.game_id&quot;;
<span class="nc" id="L1020">				logger.debug(&quot;PWT Commision Variance.&quot;);</span>
				// tem.out.println(&quot;PWT Commision Variance.&quot;);
			} else {
<span class="nc" id="L1023">				logger.error(&quot;ERROR:: Org type is not Defined properly :: &quot;</span>
						+ orgType);
			}

		} else {
			// tem.out.println(&quot;SALE Commision Variance.&quot;);
		}
<span class="nc" id="L1030">		PreparedStatement fetCommAmountPstmt = con</span>
				.prepareStatement(fetCommAmount);
<span class="nc" id="L1032">		fetCommAmountPstmt.setInt(1, gameId);</span>
<span class="nc" id="L1033">		fetCommAmountPstmt.setInt(2, gameId);</span>
<span class="nc" id="L1034">		fetCommAmountPstmt.setInt(3, orgId);</span>
<span class="nc" id="L1035">		ResultSet rs = fetCommAmountPstmt.executeQuery();</span>
<span class="nc" id="L1036">		double commAmt = 0.0;</span>
<span class="nc bnc" id="L1037" title="All 2 branches missed.">		if (rs.next()) {</span>
<span class="nc" id="L1038">			commAmt = rs.getDouble(&quot;total_comm&quot;);</span>
		}
		// tem.out.println(&quot; commAmt = &quot; + commAmt + &quot; , fetCommAmount = &quot; +
		// fetCommAmountPstmt);
<span class="nc" id="L1042">		return commAmt;</span>

	}

	public Map fetchDrawSaleDetailsOfOrg(int userOrgId, String orgType,
			String status, Connection con) throws LMSException {

<span class="nc" id="L1049">		Map map = new TreeMap();</span>
<span class="nc" id="L1050">		ClmDrawSaleBean darwSaleBean = null;</span>
<span class="nc" id="L1051">		PreparedStatement pstmtRefund = null;</span>
<span class="nc" id="L1052">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L1053">		PreparedStatement pstmtGameNbr = null;</span>
		try {
<span class="nc" id="L1055">			String fetchClmBalOfOrgQuery = &quot;&quot;;</span>
<span class="nc" id="L1056">			String fetchDrawRefundClmBal = &quot;&quot;;</span>
<span class="nc" id="L1057">			String getGameNbrFromGameMaster = &quot;&quot;;</span>

<span class="nc" id="L1059">			Map&lt;String, List&lt;ClmDrawSaleBean&gt;&gt; clmDrawSaleDetailMap = new TreeMap();</span>
<span class="nc" id="L1060">			Map&lt;String, List&lt;ClmDrawSaleBean&gt;&gt; clmDrawSaleRefundDetailMap = new TreeMap();</span>

<span class="nc bnc" id="L1062" title="All 2 branches missed.">			if (&quot;RETAILER&quot;.equalsIgnoreCase(orgType)) {</span>
<span class="nc" id="L1063">				fetchClmBalOfOrgQuery = &quot;select transaction_id ,mrp_amt ,ret_comm,agent_comm,good_cause_amt,&quot;</span>
						+ &quot;vat_amt,taxable_sale,game_id,(ret_comm*100/mrp_amt) ret_comm_rate,(agent_comm*100/mrp_amt)&quot;
						+ &quot; agt_comm_rate,(good_cause_amt*100/mrp_amt) good_cause_rate from st_ret_draw_game_sale_? &quot;
						+ &quot;where ret_org_id=? and claim_status=? order by game_id,ret_comm_rate,agt_comm_rate,&quot;
						+ &quot;good_cause_rate&quot;;

<span class="nc" id="L1069">				fetchDrawRefundClmBal = &quot;select transaction_id ,mrp_amt ,ret_comm,agent_comm,good_cause_amt,&quot;</span>
						+ &quot;vat_amt,taxable_sale,game_id,(ret_comm*100/mrp_amt) ret_comm_rate,(agent_comm*100/mrp_amt) &quot;
						+ &quot;agt_comm_rate,(good_cause_amt*100/mrp_amt) good_cause_rate from st_ret_draw_game_sale_refund_? &quot;
						+ &quot;where ret_org_id=? and claim_status=? order by game_id,ret_comm_rate,agt_comm_rate,&quot;
						+ &quot;good_cause_rate&quot;;

<span class="nc" id="L1075">				getGameNbrFromGameMaster = &quot;select game_nbr,prize_payout_ratio,vat_amt from st_dg_game_master&quot;;</span>
<span class="nc" id="L1076">				pstmtGameNbr = con.prepareStatement(fetchClmBalOfOrgQuery);</span>
<span class="nc" id="L1077">				ResultSet resultGameNbr = pstmtGameNbr.executeQuery();</span>
<span class="nc" id="L1078">				int gameNbr = 0;</span>
<span class="nc" id="L1079">				double ppr = 0.0;</span>
<span class="nc" id="L1080">				double vatAmt = 0.0;</span>
<span class="nc bnc" id="L1081" title="All 2 branches missed.">				while (resultGameNbr.next()) {</span>

<span class="nc" id="L1083">					gameNbr = resultGameNbr.getInt(&quot;game_nbr&quot;);</span>
<span class="nc" id="L1084">					ppr = resultGameNbr.getInt(&quot;prize_payout_ratio&quot;);</span>
<span class="nc" id="L1085">					vatAmt = resultGameNbr.getDouble(&quot;vat_amt&quot;);</span>

<span class="nc" id="L1087">					pstmt = con.prepareStatement(fetchClmBalOfOrgQuery);</span>
<span class="nc" id="L1088">					pstmt.setInt(1, gameNbr);</span>
<span class="nc" id="L1089">					pstmt.setInt(2, userOrgId);</span>
<span class="nc" id="L1090">					pstmt.setString(3, status);</span>
<span class="nc" id="L1091">					ResultSet result = pstmt.executeQuery();</span>
<span class="nc" id="L1092">					List&lt;ClmDrawSaleBean&gt; beanList = new ArrayList&lt;ClmDrawSaleBean&gt;();</span>

					// String key=&quot;-1&quot;;
<span class="nc bnc" id="L1095" title="All 2 branches missed.">					while (result.next()) {</span>
<span class="nc" id="L1096">						darwSaleBean = new ClmDrawSaleBean();</span>
<span class="nc" id="L1097">						double mrpAmt = result.getDouble(&quot;mrp_amt&quot;);</span>
<span class="nc" id="L1098">						double retComm = result.getDouble(&quot;ret_comm&quot;);</span>
<span class="nc" id="L1099">						double agentComm = result.getDouble(&quot;agent_comm&quot;);</span>
<span class="nc" id="L1100">						double goodCauseAmt = result</span>
								.getDouble(&quot;good_cause_amt&quot;);
<span class="nc" id="L1102">						int game_id = result.getInt(&quot;game_id&quot;);</span>

<span class="nc bnc" id="L1104" title="All 2 branches missed.">						if (mrpAmt != 0) {</span>
<span class="nc" id="L1105">							String keyGen = game_id + &quot;:&quot; + retComm * 100</span>
									/ mrpAmt + &quot;:&quot; + agentComm * 100 / mrpAmt
									+ &quot;:&quot; + goodCauseAmt * 100 / mrpAmt;
<span class="nc" id="L1108">							darwSaleBean.setPricePayRatio(ppr);</span>
<span class="nc" id="L1109">							darwSaleBean.setVatAmt(vatAmt);</span>
<span class="nc" id="L1110">							darwSaleBean.setMrpAmt(mrpAmt);</span>
<span class="nc" id="L1111">							darwSaleBean.setRetComm(retComm);</span>
<span class="nc" id="L1112">							darwSaleBean.setAgtComm(agentComm);</span>
<span class="nc" id="L1113">							darwSaleBean.setAgtGoodCauseAmt(goodCauseAmt);</span>
<span class="nc" id="L1114">							darwSaleBean.setGameId(game_id);</span>
<span class="nc" id="L1115">							darwSaleBean.setTransactinId(result</span>
									.getLong(&quot;transaction_id&quot;));

							// modify the below code so as to improve
							// readability . Use map.contains method
							// remove duplicacy in variable declaration
							// modified by yogesh as suggested by reviewer
							// vinnet

<span class="nc bnc" id="L1124" title="All 2 branches missed.">							if (clmDrawSaleDetailMap.containsKey(keyGen)) {</span>
<span class="nc" id="L1125">								beanList = clmDrawSaleDetailMap.get(keyGen);</span>
<span class="nc" id="L1126">								beanList.add(darwSaleBean);</span>
<span class="nc" id="L1127">								clmDrawSaleDetailMap.put(keyGen, beanList);</span>
							} else {
<span class="nc" id="L1129">								beanList = new ArrayList&lt;ClmDrawSaleBean&gt;();</span>
<span class="nc" id="L1130">								beanList.add(darwSaleBean);</span>
<span class="nc" id="L1131">								clmDrawSaleDetailMap.put(keyGen, beanList);</span>
							}
						}

<span class="nc" id="L1135">					}</span>

					// get data from draw sale refund table
<span class="nc" id="L1138">					pstmtRefund = con.prepareStatement(fetchDrawRefundClmBal);</span>
<span class="nc" id="L1139">					pstmtRefund.setInt(1, gameNbr);</span>
<span class="nc" id="L1140">					pstmtRefund.setInt(2, userOrgId);</span>
<span class="nc" id="L1141">					pstmtRefund.setString(3, &quot;CLAIM_BAL_REFUND&quot;);</span>
<span class="nc" id="L1142">					ResultSet resultRefund = pstmtRefund.executeQuery();</span>
<span class="nc" id="L1143">					List&lt;ClmDrawSaleBean&gt; beanRefundList = new ArrayList&lt;ClmDrawSaleBean&gt;();</span>
					// Map clmDrawSaleRefundDetailMap = new TreeMap();

					// String keyRefund=&quot;-1&quot;;
<span class="nc bnc" id="L1147" title="All 2 branches missed.">					while (resultRefund.next()) {</span>
<span class="nc" id="L1148">						darwSaleBean = new ClmDrawSaleBean();</span>
<span class="nc" id="L1149">						double mrpAmt = resultRefund.getDouble(&quot;mrp_amt&quot;);</span>
<span class="nc" id="L1150">						double retComm = resultRefund.getDouble(&quot;ret_comm&quot;);</span>
<span class="nc" id="L1151">						double agentComm = resultRefund.getDouble(&quot;agent_comm&quot;);</span>
<span class="nc" id="L1152">						double goodCauseAmt = resultRefund</span>
								.getDouble(&quot;good_cause_amt&quot;);
<span class="nc" id="L1154">						int game_id = resultRefund.getInt(&quot;game_id&quot;);</span>
<span class="nc bnc" id="L1155" title="All 2 branches missed.">						if (mrpAmt != 0) {</span>
<span class="nc" id="L1156">							String keyGenRefund = game_id + &quot;:&quot; + retComm * 100</span>
									/ mrpAmt + &quot;:&quot; + agentComm * 100 / mrpAmt
									+ &quot;:&quot; + goodCauseAmt * 100 / mrpAmt;
<span class="nc" id="L1159">							darwSaleBean.setPricePayRatio(ppr);</span>
<span class="nc" id="L1160">							darwSaleBean.setVatAmt(vatAmt);</span>
<span class="nc" id="L1161">							darwSaleBean.setMrpAmt(mrpAmt);</span>
<span class="nc" id="L1162">							darwSaleBean.setRetComm(retComm);</span>
<span class="nc" id="L1163">							darwSaleBean.setAgtComm(agentComm);</span>
<span class="nc" id="L1164">							darwSaleBean.setAgtGoodCauseAmt(goodCauseAmt);</span>
<span class="nc" id="L1165">							darwSaleBean.setGameId(game_id);</span>
<span class="nc" id="L1166">							darwSaleBean.setTransactinId(resultRefund</span>
									.getLong(&quot;transaction_id&quot;));
							// modify same as sale

<span class="nc bnc" id="L1170" title="All 2 branches missed.">							if (clmDrawSaleRefundDetailMap</span>
									.containsKey(keyGenRefund)) {
<span class="nc" id="L1172">								beanRefundList = clmDrawSaleRefundDetailMap</span>
										.get(keyGenRefund);
<span class="nc" id="L1174">								beanRefundList.add(darwSaleBean);</span>
<span class="nc" id="L1175">								clmDrawSaleRefundDetailMap.put(keyGenRefund,</span>
										beanRefundList);
							} else {
<span class="nc" id="L1178">								beanRefundList = new ArrayList&lt;ClmDrawSaleBean&gt;();</span>
<span class="nc" id="L1179">								beanRefundList.add(darwSaleBean);</span>
<span class="nc" id="L1180">								clmDrawSaleRefundDetailMap.put(keyGenRefund,</span>
										beanRefundList);
							}
						}
<span class="nc" id="L1184">					}</span>
<span class="nc" id="L1185">				}</span>
<span class="nc bnc" id="L1186" title="All 2 branches missed.">			} else if (&quot;AGENT&quot;.equalsIgnoreCase(orgType)) {</span>
<span class="nc" id="L1187">				fetchClmBalOfOrgQuery = &quot;select transaction_id ,mrp_amt ,ret_comm,agt_comm,govt_comm,&quot;</span>
						+ &quot;vat_amt,taxable_sale,game_id,(agt_comm*100/mrp_amt) agt_comm_rate,(govt_comm*100/mrp_amt) &quot;
						+ &quot;good_cause_rate from st_agt_draw_game_sale where agt_org_id=? and claim_status=? &quot;
						+ &quot;order by game_id,agt_comm_rate,good_cause_rate&quot;;

<span class="nc" id="L1192">				fetchDrawRefundClmBal = &quot;select transaction_id ,mrp_amt ,ret_comm,agt_comm,govt_comm,vat_amt,&quot;</span>
						+ &quot;taxable_sale,game_id,(agt_comm*100/mrp_amt) agt_comm_rate,(govt_comm*100/mrp_amt) &quot;
						+ &quot;good_cause_rate from st_agt_draw_game_sale_refund where agt_org_id=? and claim_status=? &quot;
						+ &quot;order by game_id,agt_comm_rate,good_cause_rate&quot;;

<span class="nc" id="L1197">				pstmt = con.prepareStatement(fetchClmBalOfOrgQuery);</span>
<span class="nc" id="L1198">				pstmt.setInt(1, userOrgId);</span>
<span class="nc" id="L1199">				pstmt.setString(2, status);</span>
<span class="nc" id="L1200">				ResultSet result = pstmt.executeQuery();</span>
<span class="nc" id="L1201">				List&lt;ClmDrawSaleBean&gt; beanList = new ArrayList&lt;ClmDrawSaleBean&gt;();</span>
				// String key=&quot;-1&quot;;
<span class="nc bnc" id="L1203" title="All 2 branches missed.">				while (result.next()) {</span>
<span class="nc" id="L1204">					darwSaleBean = new ClmDrawSaleBean();</span>
<span class="nc" id="L1205">					double mrpAmt = result.getDouble(&quot;mrp_amt&quot;);</span>
<span class="nc" id="L1206">					double agentComm = result.getDouble(&quot;agt_comm&quot;);</span>
<span class="nc" id="L1207">					double goodCauseAmt = result.getDouble(&quot;govt_comm&quot;);</span>
<span class="nc" id="L1208">					int game_id = result.getInt(&quot;game_id&quot;);</span>
<span class="nc bnc" id="L1209" title="All 2 branches missed.">					if (mrpAmt != 0) {</span>
<span class="nc" id="L1210">						String keyGen = game_id + &quot;:&quot; + agentComm * 100</span>
								/ mrpAmt + &quot;:&quot; + goodCauseAmt * 100 / mrpAmt;

<span class="nc" id="L1213">						darwSaleBean.setMrpAmt(mrpAmt);</span>
<span class="nc" id="L1214">						darwSaleBean.setAgtComm(agentComm);</span>
<span class="nc" id="L1215">						darwSaleBean.setAgtGoodCauseAmt(goodCauseAmt);</span>
<span class="nc" id="L1216">						darwSaleBean.setGameId(game_id);</span>
<span class="nc" id="L1217">						darwSaleBean.setTransactinId(result</span>
								.getLong(&quot;transaction_id&quot;));

						// modify same as retailer

<span class="nc bnc" id="L1222" title="All 2 branches missed.">						if (clmDrawSaleDetailMap.containsKey(keyGen)) {</span>
<span class="nc" id="L1223">							beanList = clmDrawSaleDetailMap.get(keyGen);</span>
<span class="nc" id="L1224">							beanList.add(darwSaleBean);</span>
<span class="nc" id="L1225">							clmDrawSaleDetailMap.put(keyGen, beanList);</span>
						} else {
<span class="nc" id="L1227">							beanList = new ArrayList&lt;ClmDrawSaleBean&gt;();</span>
<span class="nc" id="L1228">							beanList.add(darwSaleBean);</span>
<span class="nc" id="L1229">							clmDrawSaleDetailMap.put(keyGen, beanList);</span>
						}
					}

<span class="nc" id="L1233">				}</span>

				// get data from draw sale refund table
<span class="nc" id="L1236">				pstmtRefund = con.prepareStatement(fetchDrawRefundClmBal);</span>
<span class="nc" id="L1237">				pstmtRefund.setInt(1, userOrgId);</span>
<span class="nc" id="L1238">				pstmtRefund.setString(2, &quot;CLAIM_BAL_REFUND&quot;);</span>
<span class="nc" id="L1239">				ResultSet resultRefund = pstmtRefund.executeQuery();</span>
<span class="nc" id="L1240">				List&lt;ClmDrawSaleBean&gt; beanRefundList = new ArrayList&lt;ClmDrawSaleBean&gt;();</span>

				// String keyRefund=&quot;-1&quot;;
<span class="nc bnc" id="L1243" title="All 2 branches missed.">				while (resultRefund.next()) {</span>
<span class="nc" id="L1244">					darwSaleBean = new ClmDrawSaleBean();</span>
<span class="nc" id="L1245">					double mrpAmt = resultRefund.getDouble(&quot;mrp_amt&quot;);</span>
<span class="nc" id="L1246">					double agentComm = resultRefund.getDouble(&quot;agt_comm&quot;);</span>
<span class="nc" id="L1247">					double goodCauseAmt = resultRefund.getDouble(&quot;govt_comm&quot;);</span>
<span class="nc" id="L1248">					int game_id = resultRefund.getInt(&quot;game_id&quot;);</span>
<span class="nc bnc" id="L1249" title="All 2 branches missed.">					if (mrpAmt != 0) {</span>
<span class="nc" id="L1250">						String keyGenRefund = game_id + &quot;:&quot; + agentComm * 100</span>
								/ mrpAmt + &quot;:&quot; + goodCauseAmt * 100 / mrpAmt;

<span class="nc" id="L1253">						darwSaleBean.setMrpAmt(mrpAmt);</span>
<span class="nc" id="L1254">						darwSaleBean.setAgtComm(agentComm);</span>
<span class="nc" id="L1255">						darwSaleBean.setAgtGoodCauseAmt(goodCauseAmt);</span>
<span class="nc" id="L1256">						darwSaleBean.setGameId(game_id);</span>
<span class="nc" id="L1257">						darwSaleBean.setTransactinId(resultRefund</span>
								.getLong(&quot;transaction_id&quot;));

						// modify same as retailer

<span class="nc bnc" id="L1262" title="All 2 branches missed.">						if (clmDrawSaleRefundDetailMap</span>
								.containsKey(keyGenRefund)) {
<span class="nc" id="L1264">							beanRefundList = clmDrawSaleRefundDetailMap</span>
									.get(keyGenRefund);
<span class="nc" id="L1266">							beanRefundList.add(darwSaleBean);</span>
<span class="nc" id="L1267">							clmDrawSaleRefundDetailMap.put(keyGenRefund,</span>
									beanRefundList);
						} else {
<span class="nc" id="L1270">							beanRefundList = new ArrayList&lt;ClmDrawSaleBean&gt;();</span>
<span class="nc" id="L1271">							beanRefundList.add(darwSaleBean);</span>
<span class="nc" id="L1272">							clmDrawSaleRefundDetailMap.put(keyGenRefund,</span>
									beanRefundList);
						}
					}

<span class="nc" id="L1277">				}</span>

			}

<span class="nc bnc" id="L1281" title="All 4 branches missed.">			if (clmDrawSaleDetailMap != null &amp;&amp; !clmDrawSaleDetailMap.isEmpty()) {</span>
<span class="nc" id="L1282">				map.put(&quot;drawSaleMap&quot;, clmDrawSaleDetailMap);</span>
			}
<span class="nc bnc" id="L1284" title="All 4 branches missed.">			if (clmDrawSaleRefundDetailMap != null</span>
					&amp;&amp; !clmDrawSaleRefundDetailMap.isEmpty()) {
<span class="nc" id="L1286">				map.put(&quot;drawSaleRefundMap&quot;, clmDrawSaleRefundDetailMap);</span>
			}

<span class="nc" id="L1289">			return map;</span>

<span class="nc" id="L1291">		} catch (SQLException e) {</span>
<span class="nc" id="L1292">			e.printStackTrace();</span>
<span class="nc" id="L1293">			throw new LMSException(e);</span>
		}
	}

	public Map fetchPwtDetailsOfOrg(int retOrgId, String orgType,
			String status, Connection con) throws LMSException {

<span class="nc" id="L1300">		Map map = new TreeMap();</span>
<span class="nc" id="L1301">		Map clmPwtDetailMap = new TreeMap();</span>
<span class="nc" id="L1302">		ClmPwtBean pwtBean = null;</span>
		try {
<span class="nc" id="L1304">			String fetchClmBalOfOrgQuery = &quot;&quot;;</span>
<span class="nc bnc" id="L1305" title="All 2 branches missed.">			if (&quot;RETAILER&quot;.equalsIgnoreCase(orgType)) {</span>
<span class="nc" id="L1306">				fetchClmBalOfOrgQuery = &quot;select  aaa.game_id, bbb.game_nbr, bbb.game_name, ticket_nbr, aaa.agt_claim_comm , &quot;</span>
						+ &quot;aaa.virn_code, aaa.pwt_amt,  aaa.pwt_type, aaa.claim_comm, aaa.name from((select &quot;
						+ &quot;virn_code, ticket_nbr, pwt_amt, 'Anonymous' as  'pwt_type' , game_id, claim_comm , agt_claim_comm , &quot;
						+ &quot; 'Anonymous' as name from st_retailer_pwt where status = ?  and  retailer_org_id = ?) &quot;
						+ &quot;union (select  aa.virn_code, aa.ticket_nbr, aa.pwt_amt , 'direct_plr' as  'pwt_type', &quot;
						+ &quot;aa.game_id,  aa.claim_comm, agt_claim_comm , concat(bb.first_name, ' ', bb.last_name) 'name' from  &quot;
						+ &quot;st_retailer_direct_player_pwt aa, st_lms_player_master bb where  pwt_claim_status = ? &quot;
						+ &quot;and retailer_org_id = ? and aa.player_id = bb.player_id ))aaa, st_game_master bbb &quot;
						+ &quot;where aaa.game_id = bbb.game_id order by aaa.game_id&quot;;
<span class="nc bnc" id="L1315" title="All 2 branches missed.">			} else if (&quot;AGENT&quot;.equalsIgnoreCase(orgType)) {</span>
<span class="nc bnc" id="L1316" title="All 4 branches missed.">				fetchClmBalOfOrgQuery = &quot;select  aa.game_id, bb.game_nbr, 'No Tkt' as 'ticket_nbr', bb.game_name,&quot;</span>
						+ &quot; aa.virn_code, aa.pwt_amt, aa.pwt_type, aa.claim_comm, aa.name from((select a.virn_code,&quot;
						+ &quot; a.pwt_amt, 'Anonymous' as 'pwt_type' ,  a.game_id, a.claim_comm, b.name  from &quot;
						+ &quot;st_agent_pwt a, st_lms_organization_master b where a.retailer_org_id = b.organization_id &quot;
						+ &quot;and ( a.status = ? &quot;
						+ (&quot;UNCLAIM_BAL&quot;.equalsIgnoreCase(status) ? &quot; or a.status ='BULK_BO' &quot;
								: &quot;&quot;)
						+ &quot; )and a.agent_org_id = ?) union (select virn_code, pwt_amt 'dir_pwt_amt', &quot;
						+ &quot;'direct_plr' as 'pwt_type', game_id, claim_comm, concat(b.first_name, ' ', b.last_name) 'name'&quot;
						+ &quot;  from  st_agt_direct_player_pwt a, st_lms_player_master b  where a.player_id = b.player_id and &quot;
						+ &quot; ( pwt_claim_status = ? &quot;
						+ (&quot;UNCLAIM_BAL&quot;.equalsIgnoreCase(status) ? &quot; or pwt_claim_status ='BULK_BO' &quot;
								: &quot;&quot;)
						+ &quot; )and agent_org_id = ?))aa, st_game_master bb where aa.game_id = bb.game_id  order by aa.game_id&quot;;

			}
<span class="nc" id="L1332">			logger.debug(&quot;Query:  &quot; + fetchClmBalOfOrgQuery);</span>
			// tem.out.println(fetchClmBalOfOrgQuery);
<span class="nc" id="L1334">			PreparedStatement pstmt = con</span>
					.prepareStatement(fetchClmBalOfOrgQuery);
<span class="nc" id="L1336">			pstmt.setString(1, status);</span>
<span class="nc" id="L1337">			pstmt.setInt(2, retOrgId);</span>
<span class="nc" id="L1338">			pstmt.setString(3, status);</span>
<span class="nc" id="L1339">			pstmt.setInt(4, retOrgId);</span>
<span class="nc" id="L1340">			logger.debug(&quot;Fetch &quot; + status + &quot; PWT details for &quot; + orgType</span>
					+ &quot; and orgId is &quot; + retOrgId + &quot; query is &quot; + pstmt);
			// tem.out.println(&quot;Fetch &quot; + status + &quot; PWT details for &quot; + orgType
			// + &quot; and orgId is &quot; + retOrgId + &quot; query is &quot; + pstmt);
<span class="nc" id="L1344">			ResultSet result = pstmt.executeQuery();</span>
<span class="nc" id="L1345">			List&lt;ClmPwtBean&gt; beanList = new ArrayList&lt;ClmPwtBean&gt;();</span>
<span class="nc" id="L1346">			int gameId = -1;</span>
<span class="nc" id="L1347">			double totalClmBal = 0.0;</span>
<span class="nc" id="L1348">			int count = 0;</span>
<span class="nc bnc" id="L1349" title="All 2 branches missed.">			while (result.next()) {</span>
<span class="nc" id="L1350">				count = count + 1;</span>
<span class="nc" id="L1351">				pwtBean = new ClmPwtBean();</span>

<span class="nc" id="L1353">				double pwtAmt = result.getDouble(&quot;pwt_amt&quot;);</span>
<span class="nc" id="L1354">				int game_id = result.getInt(&quot;game_id&quot;);</span>

<span class="nc" id="L1356">				totalClmBal = totalClmBal + pwtAmt;</span>

<span class="nc" id="L1358">				pwtBean.setVirnCode(result.getString(&quot;virn_code&quot;));</span>
<span class="nc" id="L1359">				pwtBean.setTktNbr(result.getString(&quot;ticket_nbr&quot;));</span>
<span class="nc" id="L1360">				pwtBean.setPwtAmt(result.getDouble(&quot;pwt_amt&quot;));</span>
<span class="nc" id="L1361">				pwtBean.setPwtType(result.getString(&quot;pwt_type&quot;));</span>
<span class="nc" id="L1362">				pwtBean.setClaimComm(result.getDouble(&quot;claim_comm&quot;));</span>
<span class="nc" id="L1363">				pwtBean.setGameId(result.getInt(&quot;game_id&quot;));</span>
<span class="nc" id="L1364">				pwtBean.setGameName(result.getString(&quot;game_name&quot;));</span>
<span class="nc" id="L1365">				pwtBean.setGameNbr(result.getInt(&quot;game_nbr&quot;));</span>
<span class="nc" id="L1366">				pwtBean.setClaimedBy(result.getString(&quot;name&quot;));</span>
<span class="nc bnc" id="L1367" title="All 2 branches missed.">				if (&quot;RETAILER&quot;.equalsIgnoreCase(orgType)) {</span>
<span class="nc" id="L1368">					pwtBean.setAgtClaimComm(result.getDouble(&quot;agt_claim_comm&quot;));</span>
				}

<span class="nc bnc" id="L1371" title="All 2 branches missed.">				if (gameId != game_id) {</span>
<span class="nc bnc" id="L1372" title="All 2 branches missed.">					if (gameId == -1) {</span>
<span class="nc" id="L1373">						beanList.add(pwtBean);</span>
					} else {
						// // tem.out.println(&quot;inside else game_id =
						// &quot;+gameId+&quot;
						// and list size = &quot;+beanList.size());
<span class="nc" id="L1378">						clmPwtDetailMap.put(gameId, beanList);</span>
<span class="nc" id="L1379">						beanList = new ArrayList&lt;ClmPwtBean&gt;();</span>
<span class="nc" id="L1380">						gameId = game_id;</span>
<span class="nc" id="L1381">						beanList.add(pwtBean);</span>
					}
<span class="nc" id="L1383">					gameId = game_id;</span>
				} else {
<span class="nc" id="L1385">					beanList.add(pwtBean);</span>
<span class="nc" id="L1386">					gameId = game_id;</span>
				}

				// if result set row is last
<span class="nc bnc" id="L1390" title="All 2 branches missed.">				if (result.isLast()) {</span>
					// // tem.out.println(&quot;inside if when result is last
					// game_id
					// = &quot;+gameId+&quot; and list size = &quot;+beanList.size());
<span class="nc" id="L1394">					clmPwtDetailMap.put(gameId, beanList);</span>
				}

<span class="nc" id="L1397">			}</span>
			// // tem.out.println(&quot;result row size = &quot;+count);
<span class="nc bnc" id="L1399" title="All 2 branches missed.">			if (!clmPwtDetailMap.isEmpty()) {</span>
<span class="nc" id="L1400">				map.put(&quot;clmPwtDetails&quot;, clmPwtDetailMap);</span>
<span class="nc" id="L1401">				map.put(&quot;totalClmBal&quot;, totalClmBal);</span>
			}
<span class="nc" id="L1403">			return map;</span>

<span class="nc" id="L1405">		} catch (SQLException e) {</span>
<span class="nc" id="L1406">			e.printStackTrace();</span>
<span class="nc" id="L1407">			throw new LMSException(e);</span>
		}
	}

	// common method for all organization to get the organizations various
	// limits
	public OrgPwtLimitBean fetchPwtLimitsOfOrgnization(int organizationId,
			Connection connection) throws SQLException {

<span class="nc" id="L1416">		OrgPwtLimitBean bean = null;</span>
<span class="nc" id="L1417">		String query = &quot;select aa.organization_id, verification_limit, approval_limit, pay_limit, scrap_limit,ola_deposit_limit ,ola_withdrawal_limit, bb.pwt_scrap from st_lms_oranization_limits aa, st_lms_organization_master bb where  aa.organization_id = bb.organization_id and  aa.organization_id = ?&quot;;</span>
<span class="nc" id="L1418">		pstmt = connection.prepareStatement(query);</span>
<span class="nc" id="L1419">		pstmt.setInt(1, organizationId);</span>
<span class="nc" id="L1420">		result = pstmt.executeQuery();</span>
<span class="nc" id="L1421">		logger.debug(&quot;query that fetch limit details = &quot; + pstmt);</span>
		// tem.out.println(&quot;query that fetch limit details = &quot; + pstmt);
<span class="nc bnc" id="L1423" title="All 2 branches missed.">		if (result.next()) {</span>
<span class="nc" id="L1424">			bean = new OrgPwtLimitBean();</span>
<span class="nc" id="L1425">			bean.setOrganizationId(organizationId);</span>
<span class="nc" id="L1426">			bean.setVerificationLimit(result.getDouble(&quot;verification_limit&quot;));</span>
<span class="nc" id="L1427">			bean.setApprovalLimit(result.getDouble(&quot;approval_limit&quot;));</span>
<span class="nc" id="L1428">			bean.setPayLimit(result.getDouble(&quot;pay_limit&quot;));</span>
<span class="nc" id="L1429">			bean.setScrapLimit(result.getDouble(&quot;scrap_limit&quot;));</span>
<span class="nc" id="L1430">			bean.setOlaDepositLimit(result.getDouble(&quot;ola_deposit_limit&quot;));</span>
<span class="nc" id="L1431">			bean.setOlaWithdrawlLimit(result.getDouble(&quot;ola_withdrawal_limit&quot;));</span>
<span class="nc" id="L1432">			bean.setIsPwtAutoScrap(result.getString(&quot;pwt_scrap&quot;));</span>
		}
<span class="nc" id="L1434">		return bean;</span>
	}

	public Map fetchUnCLMPwtDetailsOfOrg(int userOrgId, String orgType,
			String status) throws LMSException {
<span class="nc" id="L1439">		Connection connection = DBConnect.getConnection();</span>
		try {
			// tem.out.println(&quot; user org id = &quot; + userOrgId + &quot; , orgType = &quot; +
			// orgType + &quot; , status = &quot; + status);
<span class="nc" id="L1443">			Map map = fetchPwtDetailsOfOrg(userOrgId, orgType, status,</span>
					connection);
<span class="nc" id="L1445">			Map detailMap = (Map) map.get(&quot;clmPwtDetails&quot;);</span>

			// create game details map game name wise
<span class="nc" id="L1448">			Map newDetailMap = new TreeMap();</span>
<span class="nc" id="L1449">			Map newGameWiseTotAmt = new TreeMap();</span>
<span class="nc bnc" id="L1450" title="All 4 branches missed.">			if (detailMap != null &amp;&amp; !detailMap.isEmpty()) {</span>
<span class="nc" id="L1451">				Set gameIdSet = detailMap.keySet();</span>
<span class="nc bnc" id="L1452" title="All 2 branches missed.">				for (Object gameId : gameIdSet) {</span>
<span class="nc" id="L1453">					List&lt;ClmPwtBean&gt; clmBeanList = (List&lt;ClmPwtBean&gt;) detailMap</span>
							.get(gameId);
<span class="nc" id="L1455">					String gameName = &quot;&quot;;</span>
<span class="nc" id="L1456">					double pwtAmtSum = 0.0;</span>
<span class="nc bnc" id="L1457" title="All 2 branches missed.">					for (ClmPwtBean clmPwtBean : clmBeanList) {</span>
<span class="nc" id="L1458">						gameName = clmPwtBean.getGameNbr() + &quot;-&quot;</span>
								+ clmPwtBean.getGameName();
<span class="nc" id="L1460">						pwtAmtSum = pwtAmtSum + clmPwtBean.getPwtAmt();</span>
<span class="nc" id="L1461">					}</span>
<span class="nc" id="L1462">					newDetailMap.put(gameName, clmBeanList);</span>
<span class="nc" id="L1463">					newGameWiseTotAmt.put(gameName, pwtAmtSum);</span>
<span class="nc" id="L1464">				}</span>
			}
<span class="nc" id="L1466">			map = new TreeMap();</span>
<span class="nc" id="L1467">			map.put(&quot;unclmPwtDet&quot;, newDetailMap);</span>
<span class="nc" id="L1468">			map.put(&quot;totalUnclmBal&quot;, newGameWiseTotAmt);</span>
<span class="nc" id="L1469">			return map;</span>

<span class="nc" id="L1471">		} catch (Exception e) {</span>
<span class="nc" id="L1472">			e.printStackTrace();</span>
<span class="nc" id="L1473">			throw new LMSException(e);</span>
		} finally {
<span class="nc" id="L1475">			try {</span>
<span class="nc bnc" id="L1476" title="All 4 branches missed.">				if (connection != null) {</span>
<span class="nc" id="L1477">					connection.close();</span>
				}
<span class="nc" id="L1479">			} catch (SQLException se) {</span>
<span class="nc" id="L1480">				se.printStackTrace();</span>
<span class="nc" id="L1481">				throw new LMSException(se);</span>
<span class="nc" id="L1482">			}</span>
		}
	}

	public String generateReceiptBo(Connection connection, int partyId,
			String partyType, List&lt;Long&gt; transIdList) throws SQLException {

		// get latest generated receipt number
<span class="nc" id="L1490">		PreparedStatement autoGenRecptPstmtBO = connection</span>
				.prepareStatement(QueryManager.getBOLatestReceiptNb());
<span class="nc" id="L1492">		autoGenRecptPstmtBO.setString(1, &quot;RECEIPT&quot;);</span>
<span class="nc" id="L1493">		ResultSet recieptRsBO = autoGenRecptPstmtBO.executeQuery();</span>

<span class="nc" id="L1495">		String autoGeneRecieptNoBO = null;</span>
<span class="nc bnc" id="L1496" title="All 2 branches missed.">		if (recieptRsBO.next()) {</span>
<span class="nc" id="L1497">			String lastRecieptNoGeneratedBO = recieptRsBO</span>
					.getString(&quot;generated_id&quot;);
<span class="nc" id="L1499">			autoGeneRecieptNoBO = GenerateRecieptNo.getRecieptNo(&quot;RECEIPT&quot;,</span>
					lastRecieptNoGeneratedBO, &quot;BO&quot;);
<span class="nc" id="L1501">		} else {</span>
<span class="nc" id="L1502">			autoGeneRecieptNoBO = GenerateRecieptNo.getRecieptNo(&quot;RECEIPT&quot;,</span>
					null, &quot;BO&quot;);
		}

		// for generating receipt********************

<span class="nc" id="L1508">		PreparedStatement boReceiptPstmt = connection</span>
				.prepareStatement(QueryManager.insertInReceiptMaster());
<span class="nc" id="L1510">		boReceiptPstmt.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L1511">		boReceiptPstmt.executeUpdate();</span>
<span class="nc" id="L1512">		int boReceiptId = -1;</span>
<span class="nc" id="L1513">		ResultSet boRSet = boReceiptPstmt.getGeneratedKeys();</span>
<span class="nc bnc" id="L1514" title="All 2 branches missed.">		if (boRSet.next()) {</span>
<span class="nc" id="L1515">			boReceiptId = boRSet.getInt(1);</span>

<span class="nc" id="L1517">			boReceiptPstmt = connection.prepareStatement(QueryManager</span>
					.insertInBOReceipts());
<span class="nc" id="L1519">			boReceiptPstmt.setInt(1, boReceiptId);</span>
<span class="nc" id="L1520">			boReceiptPstmt.setString(2, &quot;RECEIPT&quot;);</span>
<span class="nc" id="L1521">			boReceiptPstmt.setInt(3, partyId);</span>
<span class="nc" id="L1522">			boReceiptPstmt.setString(4, partyType);</span>
<span class="nc" id="L1523">			boReceiptPstmt.setString(5, autoGeneRecieptNoBO);</span>
<span class="nc" id="L1524">			boReceiptPstmt.setTimestamp(6, Util.getCurrentTimeStamp());</span>
<span class="nc" id="L1525">			boReceiptPstmt.execute();</span>

<span class="nc" id="L1527">			PreparedStatement boReceiptMappingPstmt = connection</span>
					.prepareStatement(QueryManager.insertBOReceiptTrnMapping());
<span class="nc bnc" id="L1529" title="All 2 branches missed.">			for (Long transId : transIdList) {</span>
<span class="nc" id="L1530">				boReceiptMappingPstmt.setInt(1, boReceiptId);</span>
<span class="nc" id="L1531">				boReceiptMappingPstmt.setLong(2, transId);</span>
<span class="nc" id="L1532">				boReceiptMappingPstmt.execute();</span>
<span class="nc" id="L1533">			}</span>

		}

<span class="nc" id="L1537">		return boReceiptId + &quot;-&quot; + autoGeneRecieptNoBO;</span>
	}

	public List&lt;UserInfoBean&gt; getOrgIdNClmAmtList(Connection con)
			throws SQLException {
<span class="nc" id="L1542">		List&lt;UserInfoBean&gt; orgList = new ArrayList&lt;UserInfoBean&gt;();</span>
<span class="nc" id="L1543">		String getOrgIdNClmListQuery = &quot;select aa.organization_id, aa.organization_type, aa.parent_id, aa.name, &quot;</span>
				+ &quot; aa.claimable_bal, bb.user_id from st_lms_organization_master aa, st_user_master bb where &quot;
				+ &quot; aa.organization_id = bb.organization_id and bb.isrolehead = 'Y' and &quot;
				+ &quot; (aa.organization_type = 'AGENT' or aa.organization_type = 'RETAILER') and &quot;
				+ &quot; aa.claimable_bal&gt;0 and aa.organization_status!='TERMINATE' order by organization_type desc&quot;;
<span class="nc" id="L1548">		PreparedStatement pstmt = con.prepareStatement(getOrgIdNClmListQuery);</span>
<span class="nc" id="L1549">		ResultSet rs = pstmt.executeQuery();</span>
<span class="nc" id="L1550">		logger.debug(&quot;getOrgIdNClmAmtListQuery is = &quot; + pstmt);</span>
		// tem.out.println(&quot;getOrgIdNClmAmtListQuery is = &quot; + pstmt);
<span class="nc" id="L1552">		UserInfoBean userBean = null;</span>
<span class="nc bnc" id="L1553" title="All 2 branches missed.">		while (rs.next()) {</span>
<span class="nc" id="L1554">			userBean = new UserInfoBean();</span>
<span class="nc" id="L1555">			userBean.setUserOrgId(rs.getInt(&quot;organization_id&quot;));</span>
<span class="nc" id="L1556">			userBean.setUserId(rs.getInt(&quot;user_id&quot;));</span>
<span class="nc" id="L1557">			userBean.setClaimableBal(rs.getDouble(&quot;claimable_bal&quot;));</span>
<span class="nc" id="L1558">			userBean.setUserType(rs.getString(&quot;organization_type&quot;));</span>
<span class="nc" id="L1559">			userBean.setOrgName(rs.getString(&quot;name&quot;));</span>
<span class="nc" id="L1560">			userBean.setParentOrgId(rs.getInt(&quot;parent_id&quot;));</span>
<span class="nc" id="L1561">			orgList.add(userBean);</span>
		}
<span class="nc" id="L1563">		return orgList;</span>
	}

	public ClmDrawSaleBean getVatAndPpr(Connection con,
			ClmDrawSaleBean saleBean, int gameId) throws SQLException {
<span class="nc" id="L1568">		String getGameNbrFromGameMaster = &quot;select game_nbr,prize_payout_ratio,vat_amt from st_dg_game_master where game_id =&quot;</span>
				+ gameId;
<span class="nc" id="L1570">		PreparedStatement pstmtGameNbr = con</span>
				.prepareStatement(getGameNbrFromGameMaster);
<span class="nc" id="L1572">		ResultSet resultGameNbr = pstmtGameNbr.executeQuery();</span>
<span class="nc bnc" id="L1573" title="All 2 branches missed.">		while (resultGameNbr.next()) {</span>
<span class="nc" id="L1574">			saleBean.setPricePayRatio(resultGameNbr</span>
					.getDouble(&quot;prize_payout_ratio&quot;));
<span class="nc" id="L1576">			saleBean.setVatAmt(resultGameNbr.getDouble(&quot;vat_amt&quot;));</span>
		}
<span class="nc" id="L1578">		return saleBean;</span>
	}

	public List&lt;TicketBean&gt; isTicketFormatValid(List&lt;String&gt; ticketNbrList,
			int gameNbr, Connection connection) throws SQLException {
<span class="nc" id="L1583">		List&lt;TicketBean&gt; tktBeanList = new ArrayList&lt;TicketBean&gt;();</span>
<span class="nc" id="L1584">		TicketBean bean = new TicketBean();</span>
<span class="nc" id="L1585">		String getTicketFormatQuery = &quot;select a.nbr_of_tickets_per_book, b.ticket_nbr_digits, b.pack_nbr_digits, &quot;</span>
				+ &quot; b.book_nbr_digits, b.game_nbr_digits, game_virn_digits, game_rank_digits, a.game_id  from st_game_master a, &quot;
				+ &quot; st_game_ticket_nbr_format b where a.game_nbr=? and a.game_id=b.game_id&quot;;
<span class="nc" id="L1588">		pstmt = connection.prepareStatement(getTicketFormatQuery);</span>
<span class="nc" id="L1589">		pstmt.setInt(1, gameNbr);</span>
<span class="nc" id="L1590">		result = pstmt.executeQuery();</span>
<span class="nc" id="L1591">		logger.debug(&quot;getTicketFormatQuery = &quot; + pstmt);</span>
		// tem.out.println(&quot;getTicketFormatQuery = &quot; + pstmt);
<span class="nc bnc" id="L1593" title="All 2 branches missed.">		if (result.next()) {</span>
<span class="nc" id="L1594">			int noOfTktPerBook = result.getInt(&quot;nbr_of_tickets_per_book&quot;);</span>
<span class="nc" id="L1595">			int tktNoDigit = result.getInt(&quot;ticket_nbr_digits&quot;);</span>
<span class="nc" id="L1596">			int gameNbrDigits = result.getInt(&quot;game_nbr_digits&quot;);</span>
<span class="nc" id="L1597">			int packNbrDigits = result.getInt(&quot;pack_nbr_digits&quot;);</span>
<span class="nc" id="L1598">			int bookNbrDigits = result.getInt(&quot;book_nbr_digits&quot;);</span>
<span class="nc" id="L1599">			int gameId = result.getInt(&quot;game_id&quot;);</span>

<span class="nc bnc" id="L1601" title="All 2 branches missed.">			for (String ticketNbr : ticketNbrList) {</span>
<span class="nc" id="L1602">				bean = new TicketBean();</span>
<span class="nc bnc" id="L1603" title="All 4 branches missed.">				if (ticketNbr.indexOf(&quot;-&quot;) == -1</span>
						&amp;&amp; ticketNbr.length() == gameNbrDigits + packNbrDigits
								+ bookNbrDigits + tktNoDigit) {
<span class="nc" id="L1606">					ticketNbr = ticketNbr.substring(0, gameNbrDigits) + &quot;-&quot;</span>
							+ ticketNbr.substring(gameNbrDigits);
<span class="nc" id="L1608">					ticketNbr = ticketNbr.substring(0, gameNbrDigits</span>
							+ packNbrDigits + bookNbrDigits + 1)
							+ &quot;-&quot;
							+ ticketNbr.substring(gameNbrDigits + packNbrDigits
									+ bookNbrDigits + 1);
<span class="nc bnc" id="L1613" title="All 2 branches missed.">				} else if (ticketNbr.split(&quot;-&quot;).length &lt; 3) {</span>
<span class="nc" id="L1614">					bean.setValid(false);</span>
<span class="nc" id="L1615">					bean.setTicketGameId(gameId);</span>
<span class="nc" id="L1616">					bean.setTicketNumber(ticketNbr);// added by yogesh</span>
<span class="nc" id="L1617">					bean</span>
							.setStatus(&quot;Number Format Error/Out of Range Please Check&quot;);
<span class="nc" id="L1619">					bean.setMessageCode(&quot;221001&quot;);</span>
<span class="nc" id="L1620">					bean.setValidity(&quot;InValid Ticket&quot;);</span>
<span class="nc" id="L1621">					logger</span>
							.error(&quot;Ticket number is fake or not in valid format.&quot;);
<span class="nc" id="L1623">					logger</span>
							.debug(&quot;Ticket number is fake or not in valid format.&quot;);
<span class="nc" id="L1625">					tktBeanList.add(bean);</span>
<span class="nc" id="L1626">					continue;</span>
				}

<span class="nc" id="L1629">				String tktArr[] = ticketNbr.split(&quot;-&quot;);</span>
<span class="nc bnc" id="L1630" title="All 6 branches missed.">				if (noOfTktPerBook &lt; Integer.parseInt(tktArr[2])</span>
						|| Integer.parseInt(tktArr[2]) == 0
						|| tktNoDigit != tktArr[2].length()) {
<span class="nc" id="L1633">					bean.setValid(false);</span>
<span class="nc" id="L1634">					bean.setTicketGameId(gameId);</span>
<span class="nc" id="L1635">					bean.setTicketNumber(ticketNbr);// added by yogesh</span>
<span class="nc" id="L1636">					bean</span>
							.setStatus(&quot;Number Format Error/Out of Range Please Check&quot;);
<span class="nc" id="L1638">					bean.setMessageCode(&quot;222001&quot;);</span>
<span class="nc" id="L1639">					bean.setValidity(&quot;InValid Ticket&quot;);</span>
<span class="nc" id="L1640">					logger</span>
							.error(&quot;Ticket number is fake or not in valid format.&quot;);
<span class="nc" id="L1642">					logger</span>
							.debug(&quot;Ticket number is fake or not in valid format.&quot;);
<span class="nc" id="L1644">					tktBeanList.add(bean);</span>
<span class="nc" id="L1645">					continue;</span>
				}
<span class="nc" id="L1647">				bean.setValid(true);</span>
<span class="nc" id="L1648">				bean.setTicketGameId(gameId);</span>
<span class="nc" id="L1649">				bean.setTicketNumber(ticketNbr);</span>
<span class="nc" id="L1650">				tktBeanList.add(bean);</span>
<span class="nc" id="L1651">				logger.info(&quot;Ticket Format is Valid.&quot;);</span>
				// tem.out.println(&quot;Ticket Format is Valid.&quot;);
<span class="nc" id="L1653">			}</span>

<span class="nc" id="L1655">		} else {</span>
<span class="nc bnc" id="L1656" title="All 2 branches missed.">			for (String ticketNbr : ticketNbrList) {</span>
<span class="nc" id="L1657">				bean = new TicketBean();</span>
<span class="nc" id="L1658">				bean.setTicketNumber(ticketNbr);</span>
<span class="nc" id="L1659">				bean.setValid(false);</span>
<span class="nc" id="L1660">				bean.setStatus(&quot;Game Not Found.&quot;);</span>
<span class="nc" id="L1661">				bean.setMessageCode(&quot;221001&quot;);</span>
<span class="nc" id="L1662">				bean.setValidity(&quot;InValid Ticket&quot;);</span>
<span class="nc" id="L1663">				tktBeanList.add(bean);</span>
<span class="nc" id="L1664">				logger</span>
						.error(&quot;Ticket IS Not valid for pwt. (Game Not found. Here query not return any result)&quot;);
<span class="nc" id="L1666">				logger</span>
						.debug(&quot;Ticket IS Not valid for pwt. (Game Not found. Here query not return any result)&quot;);
<span class="nc" id="L1668">			}</span>
		}
<span class="nc" id="L1670">		result.close();</span>
<span class="nc" id="L1671">		pstmt.close();</span>
<span class="nc" id="L1672">		return tktBeanList;</span>
	}

	public TicketBean isTicketFormatValid(String ticketNbr, int gameId,
			Connection connection) throws SQLException {
<span class="nc" id="L1677">		TicketBean bean = new TicketBean();</span>
<span class="nc" id="L1678">		String getTicketFormatQuery = QueryManager</span>
				.getST4GameTicketDetailsUsingGameId();
<span class="nc" id="L1680">		pstmt = connection.prepareStatement(getTicketFormatQuery);</span>
<span class="nc" id="L1681">		pstmt.setInt(1, gameId);</span>
<span class="nc" id="L1682">		result = pstmt.executeQuery();</span>
<span class="nc" id="L1683">		logger.debug(&quot;getTicketFormatQuery = &quot; + pstmt);</span>
		// tem.out.println(&quot;getTicketFormatQuery = &quot; + pstmt);
<span class="nc bnc" id="L1685" title="All 2 branches missed.">		if (result.next()) {</span>
<span class="nc" id="L1686">			int noOfTktPerBook = result.getInt(&quot;nbr_of_tickets_per_book&quot;);</span>
<span class="nc" id="L1687">			int tktNoDigit = result.getInt(&quot;ticket_nbr_digits&quot;);</span>
<span class="nc" id="L1688">			int gameNbrDigits = result.getInt(&quot;game_nbr_digits&quot;);</span>
<span class="nc" id="L1689">			int packNbrDigits = result.getInt(&quot;pack_nbr_digits&quot;);</span>
<span class="nc" id="L1690">			int bookNbrDigits = result.getInt(&quot;book_nbr_digits&quot;);</span>

<span class="nc bnc" id="L1692" title="All 4 branches missed.">			if (ticketNbr.indexOf(&quot;-&quot;) == -1</span>
					&amp;&amp; ticketNbr.length() == gameNbrDigits + packNbrDigits
							+ bookNbrDigits + tktNoDigit) {
<span class="nc" id="L1695">				ticketNbr = ticketNbr.substring(0, gameNbrDigits) + &quot;-&quot;</span>
						+ ticketNbr.substring(gameNbrDigits);
<span class="nc" id="L1697">				ticketNbr = ticketNbr.substring(0, gameNbrDigits</span>
						+ packNbrDigits + bookNbrDigits + 1)
						+ &quot;-&quot;
						+ ticketNbr.substring(gameNbrDigits + packNbrDigits
								+ bookNbrDigits + 1);
<span class="nc bnc" id="L1702" title="All 2 branches missed.">			} else if (ticketNbr.split(&quot;-&quot;).length &lt; 3) {</span>
<span class="nc" id="L1703">				bean.setValid(false);</span>
<span class="nc" id="L1704">				bean.setStatus(&quot;Number Format Error/Out of Range Please Check&quot;);</span>
<span class="nc" id="L1705">				bean.setMessageCode(&quot;221001&quot;);</span>
<span class="nc" id="L1706">				bean.setValidity(&quot;InValid Ticket&quot;);</span>
<span class="nc" id="L1707">				logger.error(&quot;Ticket number is fake or not in valid format.&quot;);</span>

<span class="nc" id="L1709">				logger.debug(&quot;Ticket number is fake or not in valid format.&quot;);</span>
<span class="nc" id="L1710">				return bean;</span>
			}

<span class="nc" id="L1713">			String tktArr[] = ticketNbr.split(&quot;-&quot;);</span>
<span class="nc bnc" id="L1714" title="All 6 branches missed.">			if (noOfTktPerBook &lt; Integer.parseInt(tktArr[2])</span>
					|| Integer.parseInt(tktArr[2]) == 0
					|| tktNoDigit != tktArr[2].length()) {
<span class="nc" id="L1717">				bean.setValid(false);</span>
<span class="nc" id="L1718">				bean.setStatus(&quot;Number Format Error/Out of Range Please Check&quot;);</span>
<span class="nc" id="L1719">				bean.setMessageCode(&quot;222001&quot;);</span>
<span class="nc" id="L1720">				bean.setValidity(&quot;InValid Ticket&quot;);</span>
<span class="nc" id="L1721">				logger.error(&quot;Ticket number is fake or not in valid format.&quot;);</span>
<span class="nc" id="L1722">				logger.debug(&quot;Ticket number is fake or not in valid format.&quot;);</span>
<span class="nc" id="L1723">				return bean;</span>
			}
<span class="nc" id="L1725">			bean.setValid(true);</span>
<span class="nc" id="L1726">			bean.setTicketNumber(ticketNbr);</span>
<span class="nc" id="L1727">			logger.info(&quot;Ticket Format is Valid.&quot;);</span>
			// tem.out.println(&quot;Ticket Format is Valid.&quot;);

<span class="nc" id="L1730">		} else {</span>
<span class="nc" id="L1731">			bean.setValid(false);</span>
<span class="nc" id="L1732">			bean.setStatus(&quot;Game Not Found.&quot;);</span>
<span class="nc" id="L1733">			bean.setMessageCode(&quot;221001&quot;);</span>
<span class="nc" id="L1734">			bean.setValidity(&quot;InValid Ticket&quot;);</span>
<span class="nc" id="L1735">			logger</span>
					.error(&quot;Ticket IS Not valid for pwt. (Game Not found. Here query not return any result)&quot;);
<span class="nc" id="L1737">			logger</span>
					.debug(&quot;Ticket IS Not valid for pwt. (Game Not found. Here query not return any result)&quot;);
		}
<span class="nc" id="L1740">		result.close();</span>
<span class="nc" id="L1741">		pstmt.close();</span>
<span class="nc" id="L1742">		return bean;</span>
	}

	public boolean updateBookStatus(int gameId, String bookNbr, Connection con,
			String status) throws SQLException {
<span class="nc" id="L1747">		String updateBookStatus = &quot;update st_game_inv_status set book_status = ? where game_id = ? and book_nbr=?&quot;;</span>
<span class="nc" id="L1748">		PreparedStatement updateBookStatusPstmt = con</span>
				.prepareStatement(updateBookStatus);
<span class="nc" id="L1750">		updateBookStatusPstmt.setString(1, status);</span>
<span class="nc" id="L1751">		updateBookStatusPstmt.setInt(2, gameId);</span>
<span class="nc" id="L1752">		updateBookStatusPstmt.setString(3, bookNbr);</span>
<span class="nc" id="L1753">		int retBalRow = updateBookStatusPstmt.executeUpdate();</span>
<span class="nc" id="L1754">		logger.debug(retBalRow + &quot; row updated,  updateBookStatus = &quot;</span>
				+ updateBookStatusPstmt);
		// tem.out.println(retBalRow + &quot; row updated, updateBookStatus = &quot; +
		// updateBookStatusPstmt);
<span class="nc bnc" id="L1758" title="All 2 branches missed.">		return retBalRow &gt; 0;</span>

	}

	/**
	 * this method is depricated and not used commented on 26 april 2013 by sumit
	 * @param drawMap
	 * @param agtOrgId
	 * @param agtParentUserId
	 * @param agtParentOrgId
	 * @param con
	 * @return
	 * @throws LMSException
	 */
	/*public String updateClaimableForDrawSaleAgt(Map drawMap, int agtOrgId,
			int agtParentUserId, int agtParentOrgId, Connection con)
			throws LMSException {
		logger.info(&quot;Inside updateClaimableForDrawSaleAgt&quot;);

		// tem.out.println(&quot;insideeeeeeeeeeeeeeeeeeeee agt updation &quot;);
		double agtDebitAmount = 0.0;// total amount of retailer that would be
		// deducted from retailers ACA
		List&lt;Long&gt; trnIdListInvoice = new ArrayList&lt;Long&gt;();
		List&lt;Long&gt; trnIdListCRNote = new ArrayList&lt;Long&gt;();
		try {

			Map&lt;String, List&lt;ClmDrawSaleBean&gt;&gt; drawSaleMap = (Map) drawMap
					.get(&quot;drawSaleMap&quot;);
			Map&lt;String, List&lt;ClmDrawSaleBean&gt;&gt; drawSaleRefundMap = (Map) drawMap
					.get(&quot;drawSaleRefundMap&quot;);
			List&lt;ClmDrawSaleBean&gt; drawSaleBeanList = null;
			if (drawSaleMap != null) {
				Set keySet = drawSaleMap.keySet();
				for (Object key : keySet) {
					drawSaleBeanList = drawSaleMap.get(key);
					double totalMrpAmt = 0.0;
					double totalAgtComm = 0.0;
					double totalAgtNetAmt = 0.0;
					double totalGoodCauseAmt = 0.0;
					double ppr = 0.0;
					double vatAmt = 0.0;
					if (!drawSaleBeanList.isEmpty()) {
						getVatAndPpr(con, drawSaleBeanList.get(0), Integer
								.parseInt(((String) key).split(&quot;:&quot;)[0]));
						ppr = drawSaleBeanList.get(0).getPricePayRatio();
						vatAmt = drawSaleBeanList.get(0).getVatAmt();
					}
					for (ClmDrawSaleBean clmDrawSaleBean : drawSaleBeanList) {
						totalMrpAmt += clmDrawSaleBean.getMrpAmt();
						totalAgtComm += clmDrawSaleBean.getAgtComm();
						totalGoodCauseAmt += clmDrawSaleBean
								.getAgtGoodCauseAmt();
					}

					totalAgtNetAmt = totalMrpAmt - totalAgtComm;

					// calculate agt vat , agt taxable sale and agt good cause
					double agtCommRate = Double.parseDouble(((String) key)
							.split(&quot;:&quot;)[1]);
					double goodcauseRate = Double.parseDouble(((String) key)
							.split(&quot;:&quot;)[2]);
					double totalAgtVat = CommonMethods.calculateDrawGameVatAgt(
							totalMrpAmt, agtCommRate, ppr, goodcauseRate,
							vatAmt);
					double tatalAgtTaxableSale = CommonMethods.calTaxableSale(
							totalMrpAmt, agtCommRate, ppr, goodcauseRate,
							vatAmt);

					agtDebitAmount += totalAgtNetAmt;

					// insert in main transaction table
					PreparedStatement pstmt = con.prepareStatement(QueryManager
							.insertInLMSTransactionMaster());
					pstmt.setString(1, &quot;BO&quot;);
					pstmt.executeUpdate();
					ResultSet rsTrns = pstmt.getGeneratedKeys();
					if (rsTrns.next()) {
						long transId = rsTrns.getLong(1);
						trnIdListInvoice.add(transId);
						// insert in bo transaction master
						pstmt = con.prepareStatement(QueryManager
								.insertInBOTransactionMaster());
						pstmt.setLong(1, transId);
						pstmt.setInt(2, agtParentUserId);
						pstmt.setInt(3, agtParentOrgId);
						pstmt.setString(4, &quot;AGENT&quot;);
						pstmt.setInt(5, agtOrgId);
						pstmt.setTimestamp(6, new java.sql.Timestamp(new Date()
								.getTime()));
						pstmt.setString(7, &quot;DRAW_GAME_SALE&quot;);
						pstmt.executeUpdate();

						// insert in bo draw game sale table
						pstmt = con
								.prepareStatement(&quot;insert into st_bo_draw_game_sale(transaction_id,agt_org_id,game_id,mrp_amt,agt_comm,net_amt,vat_amt,taxable_sale,govt_comm) values(?,?,?,?,?,?,?,?,?)&quot;);
						pstmt.setLong(1, transId);
						pstmt.setInt(2, agtOrgId);
						pstmt.setInt(3, Integer.parseInt(((String) key)
								.split(&quot;:&quot;)[0]));
						pstmt.setDouble(4, totalMrpAmt);
						pstmt.setDouble(5, totalAgtComm);
						pstmt.setDouble(6, totalAgtNetAmt);
						pstmt.setDouble(7, totalAgtVat);
						pstmt.setDouble(8, tatalAgtTaxableSale);
						pstmt.setDouble(9, totalGoodCauseAmt);
						pstmt.executeUpdate();

						// update retailer draw table for claim_done
						for (ClmDrawSaleBean clmDrawSaleBean : drawSaleBeanList) {
							pstmt = con
									.prepareStatement(&quot;update st_agt_draw_game_sale set claim_status=?,bo_ref_tid=? where transaction_id=?&quot;);
							pstmt.setString(1, &quot;DONE_CLAIM&quot;);
							pstmt.setLong(2, transId);
							pstmt.setLong(3, clmDrawSaleBean.getTransactinId());
							pstmt.executeUpdate();

						}
					}
				}
			}
			// update for refund sale
			if (drawSaleRefundMap != null) {
				Set keySetRefund = drawSaleRefundMap.keySet();
				for (Object key : keySetRefund) {
					drawSaleBeanList = drawSaleRefundMap.get(key);
					double totalMrpAmt = 0.0;
					double totalAgtComm = 0.0;
					double totalAgtNetAmt = 0.0;
					double totalGoodCauseAmt = 0.0;
					double ppr = 0.0;
					double vatAmt = 0.0;
					if (!drawSaleBeanList.isEmpty()) {
						ppr = drawSaleBeanList.get(0).getPricePayRatio();
						vatAmt = drawSaleBeanList.get(0).getVatAmt();
					}
					for (ClmDrawSaleBean clmDrawSaleBean : drawSaleBeanList) {
						totalMrpAmt += clmDrawSaleBean.getMrpAmt();
						totalAgtComm += clmDrawSaleBean.getAgtComm();
						totalGoodCauseAmt += clmDrawSaleBean
								.getAgtGoodCauseAmt();
					}

					totalAgtNetAmt = totalMrpAmt - totalAgtComm;

					// calculate agt vat , agt taxable sale and agt good cause
					double agtCommRate = Double.parseDouble(((String) key)
							.split(&quot;:&quot;)[1]);
					double goodcauseRate = Double.parseDouble(((String) key)
							.split(&quot;:&quot;)[2]);
					double totalAgtVat = CommonMethods.calculateDrawGameVatAgt(
							totalMrpAmt, agtCommRate, ppr, goodcauseRate,
							vatAmt);
					// double tatalAgtTaxableSale =
					// (((totalMrpAmt*(100-(Double.parseDouble(((String)key).split(&quot;:&quot;)[1])*100/totalMrpAmt
					// + 50
					// +Double.parseDouble(((String)key).split(&quot;:&quot;)[2])*100/totalMrpAmt)))/100)*100)/(100+16);
					double tatalAgtTaxableSale = CommonMethods.calTaxableSale(
							totalMrpAmt, agtCommRate, ppr, goodcauseRate,
							vatAmt);
					agtDebitAmount -= totalAgtNetAmt;

					// insert in main transaction table
					PreparedStatement pstmt = con.prepareStatement(QueryManager
							.insertInLMSTransactionMaster());
					pstmt.setString(1, &quot;BO&quot;);
					pstmt.executeUpdate();
					ResultSet rsTrns = pstmt.getGeneratedKeys();
					if (rsTrns.next()) {
						long transId = rsTrns.getLong(1);
						trnIdListCRNote.add(transId);
						// insert in bo transaction master
						pstmt = con.prepareStatement(QueryManager
								.insertInBOTransactionMaster());
						pstmt.setLong(1, transId);
						pstmt.setInt(2, agtParentUserId);
						pstmt.setInt(3, agtParentOrgId);
						pstmt.setString(4, &quot;AGENT&quot;);
						pstmt.setInt(5, agtOrgId);
						pstmt.setTimestamp(6, new java.sql.Timestamp(new Date()
								.getTime()));
						pstmt.setString(7, &quot;DRAW_GAME_REFUND&quot;);
						pstmt.executeUpdate();

						// insert in bo draw game sale table
						pstmt = con
								.prepareStatement(&quot;insert into st_bo_draw_game_sale_refund(transaction_id,agt_org_id,game_id,mrp_amt,agt_comm,net_amt,vat_amt,taxable_sale,govt_comm) values(?,?,?,?,?,?,?,?,?)&quot;);
						pstmt.setLong(1, transId);
						pstmt.setInt(2, agtOrgId);
						pstmt.setInt(3, Integer.parseInt(((String) key)
								.split(&quot;:&quot;)[0]));
						pstmt.setDouble(4, totalMrpAmt);
						pstmt.setDouble(5, totalAgtComm);
						pstmt.setDouble(6, totalAgtNetAmt);
						pstmt.setDouble(7, totalAgtVat);
						pstmt.setDouble(8, tatalAgtTaxableSale);
						pstmt.setDouble(9, totalGoodCauseAmt);
						pstmt.executeUpdate();
						logger.info(&quot;%%%%%insert &quot; + pstmt);
						// tem.out.println(&quot;%%%%%insert &quot; + pstmt);

						// update retailer draw table for claim_done
						for (ClmDrawSaleBean clmDrawSaleBean : drawSaleBeanList) {
							pstmt = con
									.prepareStatement(&quot;update st_agt_draw_game_sale_refund set claim_status=?,bo_ref_tid=? where transaction_id=?&quot;);
							pstmt.setString(1, &quot;DONE_CLAIM&quot;);
							pstmt.setLong(2, transId);
							pstmt.setLong(3, clmDrawSaleBean.getTransactinId());
							pstmt.executeUpdate();

						}
					}
				}
			}

			// genarate INVOICE at BO End here
			// int invoiceId = -1;
			String autoGeneRecieptNo = null;
			if (trnIdListInvoice.size() &gt; 0 &amp;&amp; trnIdListInvoice != null) {
				PreparedStatement boReceiptNoGenStmt = connection
						.prepareStatement(QueryManager.getBOLatestReceiptNb());
				boReceiptNoGenStmt.setString(1, &quot;INVOICE&quot;);
				ResultSet recieptRs = boReceiptNoGenStmt.executeQuery();
				String lastRecieptNoGenerated = null;

				while (recieptRs.next()) {
					lastRecieptNoGenerated = recieptRs
							.getString(&quot;generated_id&quot;);
				}

				// String autoGeneRecieptNo = null;
				autoGeneRecieptNo = GenerateRecieptNo.getRecieptNo(&quot;INVOICE&quot;,
						lastRecieptNoGenerated, &quot;BO&quot;);

				boReceiptNoGenStmt = connection.prepareStatement(QueryManager
						.insertInReceiptMaster());
				boReceiptNoGenStmt.setString(1, &quot;BO&quot;);
				boReceiptNoGenStmt.executeUpdate();

				ResultSet rs = boReceiptNoGenStmt.getGeneratedKeys();
				int invoiceId = -1;
				while (rs.next()) {
					invoiceId = rs.getInt(1);
				}

				// insert in bo receipts
				boReceiptNoGenStmt = connection.prepareStatement(QueryManager
						.insertInBOReceipts());
				boReceiptNoGenStmt.setInt(1, invoiceId);
				boReceiptNoGenStmt.setString(2, &quot;INVOICE&quot;);
				boReceiptNoGenStmt.setInt(3, agtOrgId);
				boReceiptNoGenStmt.setString(4, &quot;AGENT&quot;);
				boReceiptNoGenStmt.setString(5, autoGeneRecieptNo);
				boReceiptNoGenStmt.setTimestamp(6, Util.getCurrentTimeStamp());
				boReceiptNoGenStmt.execute();

				boReceiptNoGenStmt = connection.prepareStatement(QueryManager
						.insertBOReceiptTrnMapping());

				for (int i = 0; i &lt; trnIdListInvoice.size(); i++) {
					boReceiptNoGenStmt.setInt(1, invoiceId);
					boReceiptNoGenStmt.setLong(2, trnIdListInvoice.get(i));
					boReceiptNoGenStmt.execute();

				}
			}
			logger.info(&quot;Agent Debit Amount &quot; + agtDebitAmount);
			// tem.out.println(&quot;Agent Debit Amount &quot; + agtDebitAmount);
			// update organization claimable balance
			OrgCreditUpdation.updateCreditLimitForAgent(agtOrgId,
					&quot;DRAW_GAME_SALE&quot;, agtDebitAmount, connection);
			updateOrgBalance(&quot;CLAIM_BAL&quot;, agtDebitAmount, agtOrgId, &quot;DEBIT&quot;,
					connection);
			return autoGeneRecieptNo;
		} catch (SQLException e) {
			e.printStackTrace();
			throw new LMSException();
		}

	}*/

/**
 * this method is depricated and not used commented on 26 april 2013 by sumit
 */
	/*public String updateClaimableForDrawSaleRet(Map drawMap, int retOrgId,
			int retParentUserId, int retParentOrgId, Connection con)
			throws LMSException {
		logger.debug(&quot;Inside updateClaimableForDrawSaleRet&quot;);
		// tem.out.println(&quot;insideeeeeeeeeeeeeeeeeeeee&quot;);
		double retDebitAmount = 0.0;// total amount of retailer that would be
		// deducted from retailers ACA
		List&lt;Long&gt; trnIdListInvoice = new ArrayList&lt;Long&gt;();
		List&lt;Long&gt; trnIdListCRNote= new ArrayList&lt;Long&gt;();
		try {

			Map&lt;String, List&lt;ClmDrawSaleBean&gt;&gt; drawSaleMap = (Map) drawMap
					.get(&quot;drawSaleMap&quot;);
			Map&lt;String, List&lt;ClmDrawSaleBean&gt;&gt; drawSaleRefundMap = (Map) drawMap
					.get(&quot;drawSaleRefundMap&quot;);
			List&lt;ClmDrawSaleBean&gt; drawSaleBeanList = null;

			if (drawSaleMap != null) {
				Set keySet = drawSaleMap.keySet();
				for (Object key : keySet) {
					drawSaleBeanList = drawSaleMap.get(key);
					double totalMrpAmt = 0.0;
					double totalRetComm = 0.0;
					double totalAgtComm = 0.0;
					double totalretNetAmt = 0.0;
					double totalAgtNetAmt = 0.0;
					double totalGoodCauseAmt = 0.0;
					double ppr = 0.0;
					double vatAmt = 0.0;
					if (!drawSaleBeanList.isEmpty()) {
						ppr = drawSaleBeanList.get(0).getPricePayRatio();
						vatAmt = drawSaleBeanList.get(0).getVatAmt();
					}
					for (ClmDrawSaleBean clmDrawSaleBean : drawSaleBeanList) {
						totalMrpAmt = totalMrpAmt + clmDrawSaleBean.getMrpAmt();
						totalRetComm = totalRetComm
								+ clmDrawSaleBean.getRetComm();
						totalAgtComm = totalAgtComm
								+ clmDrawSaleBean.getAgtComm();
						totalGoodCauseAmt = totalGoodCauseAmt
								+ clmDrawSaleBean.getAgtGoodCauseAmt();
					}
					totalretNetAmt = totalMrpAmt - totalRetComm;
					totalAgtNetAmt = totalMrpAmt - totalAgtComm;

					// calculate agt vat , agt taxable sale and agt good cause
					double retCommRate = Double.parseDouble(((String) key)
							.split(&quot;:&quot;)[1]);
					double goodCauserate = Double.parseDouble(((String) key)
							.split(&quot;:&quot;)[3]);

					double totalAgtVat = CommonMethods.calculateDrawGameVatRet(
							totalMrpAmt, retCommRate, ppr, goodCauserate,
							vatAmt);
					double tatalAgtTaxableSale = CommonMethods.calTaxableSale(
							totalMrpAmt, retCommRate, ppr, goodCauserate,
							vatAmt);

					retDebitAmount = retDebitAmount + totalretNetAmt;

					// insert in main transaction table
					PreparedStatement pstmt = con.prepareStatement(QueryManager
							.insertInLMSTransactionMaster());
					pstmt.setString(1, &quot;AGENT&quot;);
					pstmt.executeUpdate();
					ResultSet rsTrns = pstmt.getGeneratedKeys();
					if (rsTrns.next()) {
						long transId = rsTrns.getLong(1);
						trnIdListInvoice.add(transId);
						// insert in agent transaction master
						pstmt = con.prepareStatement(QueryManager
								.insertInAgentTransactionMaster());
						pstmt.setLong(1, transId);
						pstmt.setInt(2, retParentUserId);
						pstmt.setInt(3, retParentOrgId);
						pstmt.setString(4, &quot;RETAILER&quot;);
						pstmt.setInt(5, retOrgId);
						pstmt.setString(6, &quot;DRAW_GAME_SALE&quot;);
						pstmt.setTimestamp(7, new java.sql.Timestamp(new Date()
								.getTime()));
						pstmt.executeUpdate();

						// insert in agent draw game sale table
						pstmt = con
								.prepareStatement(&quot;insert into st_agt_draw_game_sale(transaction_id,agt_org_id,ret_org_id,game_id,mrp_amt,ret_comm,net_amt,agt_comm,bo_net_amt,claim_status,vat_amt,taxable_sale,govt_comm) values(?,?,?,?,?,?,?,?,?,?,?,?,?)&quot;);
						pstmt.setLong(1, transId);
						pstmt.setInt(2, retParentOrgId);
						pstmt.setInt(3, retOrgId);
						pstmt.setInt(4, Integer.parseInt(((String) key)
								.split(&quot;:&quot;)[0]));
						pstmt.setDouble(5, totalMrpAmt);
						pstmt.setDouble(6, totalRetComm);
						pstmt.setDouble(7, totalretNetAmt);
						pstmt.setDouble(8, totalAgtComm);
						pstmt.setDouble(9, totalAgtNetAmt);
						pstmt.setString(10, &quot;CLAIM_BAL&quot;);
						pstmt.setDouble(11, totalAgtVat);
						pstmt.setDouble(12, tatalAgtTaxableSale);
						pstmt.setDouble(13, totalGoodCauseAmt);
						pstmt.executeUpdate();

						// update retailer draw table for claim_done
						for (ClmDrawSaleBean clmDrawSaleBean : drawSaleBeanList) {
							pstmt = con
									.prepareStatement(&quot;update st_ret_draw_game_sale set claim_status=?,agt_ref_tid=? where transaction_id=?&quot;);
							pstmt.setString(1, &quot;DONE_CLAIM&quot;);
							pstmt.setLong(2, transId);
							pstmt.setLong(3, clmDrawSaleBean.getTransactinId());
							pstmt.executeUpdate();

						}
					}
				}
			}
			// update for refund sale
			if (drawSaleRefundMap != null) {
				Set keySetRefund = drawSaleRefundMap.keySet();
				for (Object key : keySetRefund) {
					drawSaleBeanList = drawSaleRefundMap.get(key);
					double totalMrpAmt = 0.0;
					double totalRetComm = 0.0;
					double totalAgtComm = 0.0;
					double totalretNetAmt = 0.0;
					double totalAgtNetAmt = 0.0;
					double totalGoodCauseAmt = 0.0;
					double ppr = 0.0;
					double vatAmt = 0.0;
					if (!drawSaleBeanList.isEmpty()) {
						ppr = drawSaleBeanList.get(0).getPricePayRatio();
						vatAmt = drawSaleBeanList.get(0).getVatAmt();
					}
					for (ClmDrawSaleBean clmDrawSaleBean : drawSaleBeanList) {

						// totalMrpAmt=clmDrawSaleBean.getMrpAmt();
						totalMrpAmt += clmDrawSaleBean.getMrpAmt();

						// totalRetComm=clmDrawSaleBean.getRetComm();
						totalRetComm += clmDrawSaleBean.getRetComm();

						// totalAgtComm = clmDrawSaleBean.getAgtComm();
						totalAgtComm += clmDrawSaleBean.getAgtComm();

						// totalGoodCauseAmt =
						// clmDrawSaleBean.getAgtGoodCauseAmt();
						totalGoodCauseAmt += clmDrawSaleBean
								.getAgtGoodCauseAmt();

					}
					totalretNetAmt = totalMrpAmt - totalRetComm;
					totalAgtNetAmt = totalMrpAmt - totalAgtComm;

					// calculate agt vat , agt taxable sale and agt good cause

					double totalAgtVat = CommonMethods.calculateDrawGameVatAgt(
							totalMrpAmt, Double.parseDouble(((String) key)
									.split(&quot;:&quot;)[1]), ppr, Double
									.parseDouble(((String) key).split(&quot;:&quot;)[3]),
							vatAmt);
					double tatalAgtTaxableSale = CommonMethods.calTaxableSale(
							totalMrpAmt, Double.parseDouble(((String) key)
									.split(&quot;:&quot;)[1]), ppr, Double
									.parseDouble(((String) key).split(&quot;:&quot;)[3]),
							vatAmt);

					retDebitAmount = retDebitAmount - totalretNetAmt;

					// insert in main transaction master
					// insert in main transaction table
					PreparedStatement pstmt = con.prepareStatement(QueryManager
							.insertInLMSTransactionMaster());
					pstmt.setString(1, &quot;AGENT&quot;);
					pstmt.executeUpdate();
					ResultSet rsTrns = pstmt.getGeneratedKeys();
					if (rsTrns.next()) {
						long transId = rsTrns.getLong(1);
						trnIdListCRNote.add(transId);
						// insert in agent transaction master
						pstmt = con.prepareStatement(QueryManager
								.insertInAgentTransactionMaster());
						pstmt.setLong(1, transId);
						pstmt.setInt(2, retParentUserId);
						pstmt.setInt(3, retParentOrgId);
						pstmt.setString(4, &quot;RETAILER&quot;);
						pstmt.setInt(5, retOrgId);
						pstmt.setString(6, &quot;DRAW_GAME_REFUND&quot;);
						pstmt.setTimestamp(7, new java.sql.Timestamp(new Date()
								.getTime()));
						pstmt.executeUpdate();

						// insert in agent draw game sale table
						// double retNetAmt=clmDrawSaleBean.getMrpAmt() -
						// clmDrawSaleBean.getRetComm();
						// retDebitAmount+=retNetAmt;
						pstmt = con
								.prepareStatement(&quot;insert into st_agt_draw_game_sale_refund(transaction_id,agt_org_id,ret_org_id,game_id,mrp_amt,ret_comm,net_amt,agt_comm,bo_net_amt,claim_status,vat_amt,taxable_sale,govt_comm) values(?,?,?,?,?,?,?,?,?,?,?,?,?)&quot;);
						pstmt.setLong(1, transId);
						pstmt.setInt(2, retParentOrgId);
						pstmt.setInt(3, retOrgId);
						pstmt.setInt(4, Integer.parseInt(((String) key)
								.split(&quot;:&quot;)[0]));
						pstmt.setDouble(5, totalMrpAmt);
						pstmt.setDouble(6, totalRetComm);
						pstmt.setDouble(7, totalretNetAmt);
						pstmt.setDouble(8, totalAgtComm);
						pstmt.setDouble(9, totalAgtNetAmt);
						pstmt.setString(10, &quot;CLAIM_BAL_REFUND&quot;);
						pstmt.setDouble(11, totalAgtVat);
						pstmt.setDouble(12, tatalAgtTaxableSale);
						pstmt.setDouble(13, totalGoodCauseAmt);
						pstmt.executeUpdate();
						logger.debug(&quot;%%%%%insert &quot; + pstmt);

						// tem.out.println(&quot;%%%%%insert &quot; + pstmt);

						// update retailer draw table for claim_done
						for (ClmDrawSaleBean clmDrawSaleBean : drawSaleBeanList) {
							pstmt = con
									.prepareStatement(&quot;update st_ret_draw_game_sale_refund set claim_status=?,agt_ref_tid=? where transaction_id=?&quot;);
							pstmt.setString(1, &quot;DONE_CLAIM&quot;);
							pstmt.setLong(2, transId);
							pstmt.setLong(3, clmDrawSaleBean.getTransactinId());
							pstmt.executeUpdate();

						}
					}
				}
			}
			// genarate receipt here
			// int invoiceId = -1;
			String autoGeneRecieptNo = null;
			if (trnIdListInvoice.size() &gt; 0 &amp;&amp; trnIdListInvoice != null) {
				PreparedStatement agtReceiptNoGenStmt = connection
						.prepareStatement(QueryManager
								.getAGENTLatestReceiptNb());
				agtReceiptNoGenStmt.setString(1, &quot;INVOICE&quot;);
				agtReceiptNoGenStmt.setInt(2, retParentOrgId);
				ResultSet recieptRs = agtReceiptNoGenStmt.executeQuery();
				String lastRecieptNoGenerated = null;
				while (recieptRs.next()) {
					lastRecieptNoGenerated = recieptRs
							.getString(&quot;generated_id&quot;);
				}

				// String autoGeneRecieptNo=null;
				autoGeneRecieptNo = GenerateRecieptNo.getRecieptNoAgt(
						&quot;INVOICE&quot;, lastRecieptNoGenerated, &quot;AGENT&quot;,
						retParentOrgId);

				// insert in receipt master for invoice

				agtReceiptNoGenStmt = connection.prepareStatement(QueryManager
						.insertInReceiptMaster());
				agtReceiptNoGenStmt.setString(1, &quot;AGENT&quot;);
				agtReceiptNoGenStmt.executeUpdate();

				ResultSet rs = agtReceiptNoGenStmt.getGeneratedKeys();
				int invoiceId = -1;
				while (rs.next()) {
					invoiceId = rs.getInt(1);
				}

				// insert into agent receipt table

				agtReceiptNoGenStmt = connection.prepareStatement(QueryManager
						.insertInAgentReceipts());
				agtReceiptNoGenStmt.setInt(1, invoiceId);
				agtReceiptNoGenStmt.setString(2, &quot;INVOICE&quot;);
				agtReceiptNoGenStmt.setInt(3, retParentOrgId);
				agtReceiptNoGenStmt.setInt(4, retOrgId);
				agtReceiptNoGenStmt.setString(5, &quot;RETAILER&quot;);
				agtReceiptNoGenStmt.setString(6, autoGeneRecieptNo);
				agtReceiptNoGenStmt.setTimestamp(7, Util.getCurrentTimeStamp());
				agtReceiptNoGenStmt.execute();

				agtReceiptNoGenStmt = connection.prepareStatement(QueryManager
						.insertAgentReceiptTrnMapping());
				for (int i = 0; i &lt; trnIdListInvoice.size(); i++) {
					agtReceiptNoGenStmt.setInt(1, invoiceId);
					agtReceiptNoGenStmt.setLong(2, trnIdListInvoice.get(i));
					agtReceiptNoGenStmt.execute();

				}

			}
			logger.debug(&quot;&amp;&amp;&amp;&amp;&amp;77777777 &quot; + retDebitAmount);
			// tem.out.println(&quot;&amp;&amp;&amp;&amp;&amp;77777777 &quot; + retDebitAmount);
			// update organization claimable balance
			OrgCreditUpdation.updateCreditLimitForRetailer(retOrgId,
					&quot;DRAW_GAME_SALE&quot;, retDebitAmount, connection);
			updateOrgBalance(&quot;CLAIM_BAL&quot;, retDebitAmount, retOrgId, &quot;DEBIT&quot;,
					connection);
			return autoGeneRecieptNo;
		} catch (SQLException e) {
			e.printStackTrace();
			throw new LMSException();
		}

	}*/

	public boolean updateOrgBalance(String claimType, double amount, int orgId,
			String amtUpdateType, Connection connection) throws SQLException {

		// check whether amount type is debit or credit
<span class="nc bnc" id="L2344" title="All 2 branches missed.">		amount = &quot;DEBIT&quot;.equals(amtUpdateType) ? -1 * amount : amount;</span>
<span class="nc" id="L2345">		logger.debug(&quot;claimType &quot; + claimType + &quot; ::amtUpdateType &quot;</span>
				+ amtUpdateType);
		// tem.out.println(&quot;claimType &quot; + claimType + &quot; ::amtUpdateType &quot; +
		// amtUpdateType);
<span class="nc" id="L2349">		String updateRetBalQuery = null;</span>
<span class="nc bnc" id="L2350" title="All 2 branches missed.">		if (&quot;UNCLAIM_BAL&quot;.equalsIgnoreCase(claimType)) {</span>
<span class="nc" id="L2351">			updateRetBalQuery = &quot;update st_lms_organization_master set unclaimable_bal = (unclaimable_bal+?) where organization_id = ?&quot;;</span>
<span class="nc bnc" id="L2352" title="All 2 branches missed.">		} else if (&quot;CLAIM_BAL&quot;.equalsIgnoreCase(claimType)) {</span>
<span class="nc" id="L2353">			updateRetBalQuery = &quot;update st_lms_organization_master set claimable_bal = (claimable_bal+?) &quot;</span>
					+ &quot; , organization_status = if((available_credit-claimable_bal)&gt;0, 'ACTIVE', 'INACTIVE')&quot;
					+ &quot; where organization_id = ?&quot;;
			// updateRetBalQuery = &quot;update st_lms_organization_master set
			// claimable_bal = (claimable_bal+?) where organization_id = ?&quot;;
<span class="nc bnc" id="L2358" title="All 2 branches missed.">		} else if (&quot;ACA_N_CLAIM_BAL&quot;.equalsIgnoreCase(claimType)) {</span>
<span class="nc" id="L2359">			updateRetBalQuery = &quot;update st_lms_organization_master set claimable_bal = (claimable_bal-?),&quot;</span>
					+ &quot; available_credit=(available_credit+?) where organization_id = ?&quot;;
<span class="nc bnc" id="L2361" title="All 2 branches missed.">		} else if (&quot;ACA_N_UNCLAIM_BAL&quot;.equalsIgnoreCase(claimType)) {</span>
<span class="nc" id="L2362">			updateRetBalQuery = &quot;update st_lms_organization_master set unclaimable_bal = (unclaimable_bal-?),&quot;</span>
					+ &quot; available_credit=(available_credit+?) where organization_id = ?&quot;;
		}
<span class="nc" id="L2365">		PreparedStatement updateRetBal = connection</span>
				.prepareStatement(updateRetBalQuery);
<span class="nc" id="L2367">		updateRetBal.setDouble(1, amount);</span>
<span class="nc bnc" id="L2368" title="All 2 branches missed.">		if (&quot;ACA_N_CLAIM_BAL&quot;.equalsIgnoreCase(claimType)) {</span>
<span class="nc" id="L2369">			updateRetBal.setDouble(2, amount);</span>
<span class="nc" id="L2370">			updateRetBal.setInt(3, orgId);</span>
		} else {
<span class="nc" id="L2372">			updateRetBal.setInt(2, orgId);</span>
		}
<span class="nc" id="L2374">		int retBalRow = updateRetBal.executeUpdate();</span>
<span class="nc" id="L2375">		logger.debug(retBalRow + &quot; row updated,  updateRetBalQuery = &quot;</span>
				+ updateRetBal);
		// tem.out.println(retBalRow + &quot; row updated, updateRetBalQuery = &quot; +
		// updateRetBal);
<span class="nc bnc" id="L2379" title="All 2 branches missed.">		return retBalRow &gt; 0;</span>
	}

	public boolean updateOrgForUnClaimedVirn(int orgId, String orgType,
			String enVirnCode, String virnStatus, int gameId, String tableType,
			Connection connection) throws SQLException, LMSException {
<span class="nc" id="L2385">		boolean flag = false;</span>
<span class="nc" id="L2386">		String fetchVirnDetailQuery = &quot;&quot;;</span>
<span class="nc" id="L2387">		String updateVirnDetailQuery = &quot;&quot;;</span>
<span class="nc bnc" id="L2388" title="All 2 branches missed.">		if (&quot;RETAILER&quot;.equalsIgnoreCase(orgType)) {</span>

			// update according to the retailer

<span class="nc bnc" id="L2392" title="All 2 branches missed.">		} else if (&quot;AGENT&quot;.equalsIgnoreCase(orgType)) {</span>
<span class="nc bnc" id="L2393" title="All 2 branches missed.">			if (&quot;AGENT&quot;.equalsIgnoreCase(tableType)) {</span>
<span class="nc" id="L2394">				updateVirnDetailQuery = &quot;update st_agent_pwt set status=? where game_id = ? and virn_code = ? and agent_org_id = ?&quot;;</span>
<span class="nc bnc" id="L2395" title="All 2 branches missed.">			} else if (&quot;PLAYER&quot;.equalsIgnoreCase(tableType)) {</span>
<span class="nc" id="L2396">				updateVirnDetailQuery = &quot;update st_agt_direct_player_pwt set pwt_claim_status=? where game_id = ? and virn_code = ? and agent_org_id = ?&quot;;</span>
			} else {
<span class="nc" id="L2398">				throw new LMSException(</span>
						&quot;ERROR OCCURED while updating status in AGENT or PLR table for UNCLAIMMABLE balance  for this tableType is &quot;
								+ tableType);
				// fetchVirnDetailQuery = &quot;select * from st_agent_pwt where
				// game_id
				// = ? and virn_code = ? and agent_org_id = ? and status = ?&quot;;
				// fetchVirnDetailQuery = &quot;select * from st_agent_pwt where
				// game_id
				// = ? and virn_code = ? and agent_org_id = ? and status = ?&quot;;
			}
		}
<span class="nc" id="L2409">		pstmt = connection.prepareStatement(updateVirnDetailQuery);</span>
<span class="nc" id="L2410">		pstmt.setString(1, virnStatus);</span>
<span class="nc" id="L2411">		pstmt.setInt(2, gameId);</span>
<span class="nc" id="L2412">		pstmt.setString(3, enVirnCode);</span>
<span class="nc" id="L2413">		pstmt.setInt(4, orgId);</span>
<span class="nc" id="L2414">		int isupdate = pstmt.executeUpdate();</span>
<span class="nc" id="L2415">		logger.debug(&quot; update  virn for &quot; + orgType + &quot; pwt table pstmt = &quot;</span>
				+ pstmt);
		// tem.out.println(&quot; update virn for &quot; + orgType + &quot; pwt table pstmt = &quot;
		// + pstmt);
<span class="nc bnc" id="L2419" title="All 2 branches missed.">		if (isupdate == 1) {</span>
<span class="nc" id="L2420">			flag = true;</span>
		} else {
<span class="nc" id="L2422">			throw new LMSException(</span>
					&quot;ERROR OCCURED PWT NOT Found for this status &quot; + virnStatus);
		}
<span class="nc" id="L2425">		return flag;</span>
	}

	public int updateTicketInvTable(String tktNo, String bookNo, int gameNbr,
			int gameId, String status, int userId, int userOrgId,
			String updateType, Connection connection) throws SQLException,
			LMSException {

<span class="nc" id="L2433">		int tktRow = 0;</span>
		// updated by yogesh now not to execute select query

<span class="nc bnc" id="L2436" title="All 2 branches missed.">		if (&quot;update&quot;.equalsIgnoreCase(updateType)) { // ticket already exist</span>
			// in st_pwt_tickets_inv
			// table
<span class="nc" id="L2439">			String updateTktInvQuery = &quot;update st_pwt_tickets_inv_? set status = ?, verify_by_user=?, verify_by_org=? where game_id = ? and ticket_nbr = ?&quot;;</span>
<span class="nc" id="L2440">			PreparedStatement upTktInvPstmt = connection</span>
					.prepareStatement(updateTktInvQuery);
<span class="nc" id="L2442">			upTktInvPstmt.setInt(1, gameNbr);</span>
<span class="nc" id="L2443">			upTktInvPstmt.setString(2, status);</span>
<span class="nc" id="L2444">			upTktInvPstmt.setInt(3, userId);</span>
<span class="nc" id="L2445">			upTktInvPstmt.setInt(4, userOrgId);</span>
<span class="nc" id="L2446">			upTktInvPstmt.setInt(5, gameId);</span>
<span class="nc" id="L2447">			upTktInvPstmt.setString(6, tktNo);</span>
<span class="nc" id="L2448">			tktRow = upTktInvPstmt.executeUpdate();</span>
<span class="nc" id="L2449">			logger.debug(&quot;total row = &quot; + tktRow</span>
					+ &quot;   ,update ticket inventory status table = &quot;
					+ upTktInvPstmt);
			// tem.out.println(&quot;total row = &quot; + tktRow+ &quot; ,update ticket
			// inventory status table = &quot;+ upTktInvPstmt);
<span class="nc bnc" id="L2454" title="All 2 branches missed.">			if (tktRow &lt; 1) {</span>
<span class="nc" id="L2455">				throw new LMSException(&quot;ticket Number &quot; + tktNo</span>
						+ &quot; status not updated in st_pwt_tickets_inv table.&quot;);
			}
<span class="nc bnc" id="L2458" title="All 2 branches missed.">			if (tktRow &gt; 1) {</span>
<span class="nc" id="L2459">				LMSExceptionInterceptor.sendMail(&quot;Ticket Number &quot; + tktNo</span>
						+ &quot;is duplicate in DATABASE&quot;);
<span class="nc" id="L2461">				throw new LMSException(&quot;Ticket Number &quot; + tktNo</span>
						+ &quot;is duplicate in DATABASE&quot;);
			}
<span class="nc bnc" id="L2464" title="All 2 branches missed.">		} else if (&quot;insert&quot;.equalsIgnoreCase(updateType)) { // if ticket not</span>
			// exist in
			// st_pwt_tickets_inv
			// table
<span class="nc" id="L2468">			String updateTktInvQuery = &quot;insert into  st_pwt_tickets_inv_? ( ticket_nbr , game_id , book_nbr , status , verify_by_user , verify_by_org ) values (?,?,?,?,?,?)&quot;;</span>
<span class="nc" id="L2469">			PreparedStatement inTktInvPstmt = connection</span>
					.prepareStatement(updateTktInvQuery);
<span class="nc" id="L2471">			inTktInvPstmt.setInt(1, gameNbr);</span>
<span class="nc" id="L2472">			inTktInvPstmt.setString(2, tktNo);</span>
<span class="nc" id="L2473">			inTktInvPstmt.setInt(3, gameId);</span>
<span class="nc" id="L2474">			inTktInvPstmt.setString(4, bookNo);</span>
<span class="nc" id="L2475">			inTktInvPstmt.setString(5, status);</span>
<span class="nc" id="L2476">			inTktInvPstmt.setInt(6, userId);</span>
<span class="nc" id="L2477">			inTktInvPstmt.setInt(7, userOrgId);</span>
<span class="nc" id="L2478">			tktRow = inTktInvPstmt.executeUpdate();</span>
<span class="nc" id="L2479">			logger.debug(&quot;total row = &quot; + tktRow</span>
					+ &quot;   ,insert ticket inventory details into table = &quot;
					+ inTktInvPstmt);
			// tem.out.println(&quot;total row = &quot; + tktRow+ &quot; ,insert ticket
			// inventory details into table = &quot; + inTktInvPstmt);
<span class="nc bnc" id="L2484" title="All 2 branches missed.">			if (tktRow &lt; 1) {</span>
<span class="nc" id="L2485">				throw new LMSException(&quot;ticket Number &quot; + tktNo</span>
						+ &quot; is not inserted in st_pwt_tickets_inv table.&quot;);
			}
<span class="nc bnc" id="L2488" title="All 2 branches missed.">		} else if (&quot;delete&quot;.equalsIgnoreCase(updateType)) { // in case of ticket</span>
			// temporary
			// cancellation
<span class="nc" id="L2491">			String updateTktInvQuery = &quot;delete from st_pwt_tickets_inv_? where game_id=? and ticket_nbr=? &quot;;</span>
<span class="nc" id="L2492">			PreparedStatement inTktInvPstmt = connection</span>
					.prepareStatement(updateTktInvQuery);
<span class="nc" id="L2494">			inTktInvPstmt.setInt(1, gameNbr);</span>
<span class="nc" id="L2495">			inTktInvPstmt.setInt(2, gameId);</span>
<span class="nc" id="L2496">			inTktInvPstmt.setString(3, tktNo);</span>
<span class="nc" id="L2497">			tktRow = inTktInvPstmt.executeUpdate();</span>
<span class="nc" id="L2498">			logger.debug(&quot;total row = &quot; + tktRow</span>
					+ &quot;   ,delete form ticket inventory  table = &quot;
					+ inTktInvPstmt);
			// tem.out.println(&quot;total row = &quot; + tktRow + &quot; ,delete form ticket
			// inventory table = &quot; + inTktInvPstmt);
<span class="nc bnc" id="L2503" title="All 2 branches missed.">			if (tktRow &lt; 1) {</span>
<span class="nc" id="L2504">				throw new LMSException(&quot;ticket Number &quot; + tktNo</span>
						+ &quot; is not deleted from st_pwt_tickets_inv table.&quot;);
			}
<span class="nc" id="L2507">		} else {</span>
<span class="nc" id="L2508">			throw new LMSException(</span>
					&quot;Exception occured while updating ticket inventory table updation type is :: &quot;
							+ updateType);
		}

<span class="nc" id="L2513">		return tktRow;</span>

	}

	public Boolean updateVirnStatus(int gameNbr, String pwtStatus, int gameId,
			String encVirnCode, Connection con) throws SQLException,
			LMSException {
<span class="nc" id="L2520">		String updateVirnInvQuery = &quot;update st_pwt_inv_? set status = ? where game_id = ? and virn_code = ?&quot;;</span>
<span class="nc" id="L2521">		PreparedStatement invPstmt = con.prepareStatement(updateVirnInvQuery);</span>
<span class="nc" id="L2522">		invPstmt.setInt(1, gameNbr);</span>
<span class="nc" id="L2523">		invPstmt.setString(2, pwtStatus);</span>
<span class="nc" id="L2524">		invPstmt.setInt(3, gameId);</span>
<span class="nc" id="L2525">		invPstmt.setString(4, encVirnCode);</span>
<span class="nc" id="L2526">		int virnRow = invPstmt.executeUpdate();</span>
<span class="nc" id="L2527">		logger.debug(&quot;total row = &quot; + virnRow</span>
				+ &quot;   ,update ticket inventory status table = &quot; + invPstmt);
		// tem.out.println(&quot;total row = &quot; + virnRow + &quot; ,update ticket inventory
		// status table = &quot; + invPstmt);
<span class="nc bnc" id="L2531" title="All 2 branches missed.">		if (virnRow &lt; 1) {</span>
<span class="nc" id="L2532">			throw new LMSException(</span>
					&quot;update ticket inventory status table not updated.&quot;);
		}
<span class="nc bnc" id="L2535" title="All 2 branches missed.">		return virnRow &gt; 0;</span>
	}

	public String verifyOrgForUnClaimedVirn(int orgId, String orgType,
			String enVirnCode, String virnStatus, int gameId,
			Connection connection) throws SQLException {
<span class="nc" id="L2541">		String flag = &quot;NONE&quot;;</span>
<span class="nc" id="L2542">		String fetchVirnDetailQuery = &quot;&quot;;</span>
<span class="nc bnc" id="L2543" title="All 2 branches missed.">		if (&quot;RETAILER&quot;.equalsIgnoreCase(orgType)) {</span>
<span class="nc" id="L2544">			fetchVirnDetailQuery = &quot;select virn_code,'RETAILER' as tableType from st_retailer_pwt where game_id = ? and virn_code = ? and retailer_org_id = ? and status = ? UNION select virn_code, 'PLAYER' as tableType from st_retailer_direct_player_pwt where game_id = ? and virn_code = ? and retailer_org_id = ? and pwt_claim_status = ?&quot;;</span>
			// fetchVirnDetailQuery = &quot;select * from st_retailer_pwt where
			// game_id = ? and virn_code = ? and retailer_org_id = ? and status
			// = ?&quot;;
<span class="nc bnc" id="L2548" title="All 2 branches missed.">		} else if (&quot;AGENT&quot;.equalsIgnoreCase(orgType)) {</span>

<span class="nc" id="L2550">			fetchVirnDetailQuery = &quot;select virn_code,'AGENT' as tableType from st_agent_pwt where game_id = ? and virn_code = ? and agent_org_id = ? and status = ? UNION select virn_code, 'PLAYER' as tableType from st_agt_direct_player_pwt where game_id = ? and virn_code = ? and agent_org_id = ? and pwt_claim_status=?&quot;;</span>
			// fetchVirnDetailQuery = &quot;select * from st_agent_pwt where game_id
			// = ? and virn_code = ? and agent_org_id = ? and status = ?&quot;;
		}
<span class="nc" id="L2554">		pstmt = connection.prepareStatement(fetchVirnDetailQuery);</span>
<span class="nc" id="L2555">		pstmt.setInt(1, gameId);</span>
<span class="nc" id="L2556">		pstmt.setString(2, enVirnCode);</span>
<span class="nc" id="L2557">		pstmt.setInt(3, orgId);</span>
<span class="nc" id="L2558">		pstmt.setString(4, virnStatus);</span>
<span class="nc" id="L2559">		pstmt.setInt(5, gameId);</span>
<span class="nc" id="L2560">		pstmt.setString(6, enVirnCode);</span>
<span class="nc" id="L2561">		pstmt.setInt(7, orgId);</span>
<span class="nc" id="L2562">		pstmt.setString(8, virnStatus);</span>
<span class="nc" id="L2563">		result = pstmt.executeQuery();</span>
<span class="nc" id="L2564">		logger.debug(&quot; get detail of virn from &quot; + orgType</span>
				+ &quot; pwt table pstmt = &quot; + pstmt);
		// tem.out.println(&quot; get detail of virn from &quot; + orgType + &quot; pwt table
		// pstmt = &quot; + pstmt);
<span class="nc bnc" id="L2568" title="All 2 branches missed.">		if (result.next()) {</span>
<span class="nc bnc" id="L2569" title="All 2 branches missed.">			if (&quot;PLAYER&quot;.equalsIgnoreCase(result.getString(&quot;tableType&quot;))) {</span>
<span class="nc" id="L2570">				flag = &quot;IN_PLR_UNCLM&quot;;</span>
			} else {
<span class="nc" id="L2572">				flag = &quot;IN_&quot; + orgType + &quot;_UNCLM&quot;;</span>
			}
		} else {
			// we require to shoot a mail
			// // tem.out.println(&quot;status not matched in &quot;+orgType+&quot; pwt
			// table
			// and st_pwt_inv table for virn = &quot;+enVirnCode);
			// CommonMethods.sendMail(&quot;status not matched in &quot;+orgType+&quot; pwt
			// table and st_pwt_inv table for virn = &quot;+enVirnCode);
		}
<span class="nc" id="L2582">		return flag;</span>
	}
/**
 * this method is depricated and not used commented on 26 april 2013 by sumit
 * @param gameType
 * @return
 */
	/*public List&lt;PromoGameBean&gt; getAvailablePromoGames(String gameType) {
		List&lt;PromoGameBean&gt; promoGameslist = new ArrayList&lt;PromoGameBean&gt;();
		PromoGameBean promobean = null;

		if (&quot;Fortune&quot;.equalsIgnoreCase(gameType)) {
			promobean = new PromoGameBean();
			promobean.setPromoGameNo(Util.getGameNumber(&quot;RaffleGame&quot;));
			promobean.setPromoGametype(&quot;RAFFLE&quot;);
			promobean.setPromoTicketType(&quot;REFERENCE&quot;);
			promoGameslist.add(promobean);
		}
		
		 * if(&quot;Lotto&quot;.equalsIgnoreCase(gameType)){ promobean = new
		 * PromoGameBean();
		 * promobean.setPromoGameNo(Util.getGameNumber(&quot;RaffleGame1&quot;));
		 * promobean.setPromoGametype(&quot;RAFFLE&quot;);
		 * promobean.setPromoTicketType(&quot;ORIGINAL&quot;);
		 * promoGameslist.add(promobean); }
		 
		if (&quot;Keno&quot;.equalsIgnoreCase(gameType)) {
			promobean = new PromoGameBean();
			promobean.setPromoGameNo(Util.getGameNumber(gameType));
			promobean.setPromoGametype(&quot;RAFFLE&quot;);
			promobean.setPromoTicketType(&quot;ORIGINAL&quot;);
			promoGameslist.add(promobean);
		}

		
		 * if(parentGameNo==4){ promobean = new PromoGameBean();
		 * promobean.setPromoGameNo(9); promobean.setPromoGametype(&quot;RAFFLE&quot;);
		 * promobean.setPromoTicketType(&quot;ORIGINAL&quot;);
		 * promoGameslist.add(promobean); }
		 
		return promoGameslist;

	}*/

	/**
	 * this method is depricated and not used commented on 26 april 2013 by sumit
	 */
	/*public List&lt;PromoGameBean&gt; getAvailablePromoGamesNew(String gameName,
			double totalPurchAmt, List&lt;String&gt; drawNamePurchList) {
		List&lt;PromoGameBean&gt; promoGameslist = new ArrayList&lt;PromoGameBean&gt;();
		PromoGameBean promobean = null;

		if (&quot;Fortune&quot;.equalsIgnoreCase(gameName)) {
			promobean = new PromoGameBean();
			promobean.setPromoGameNo(Util.getGameNumber(&quot;RaffleGame&quot;));
			promobean.setPromoGametype(&quot;RAFFLE&quot;);
			promobean.setPromoTicketType(&quot;REFERENCE&quot;);
			promoGameslist.add(promobean);
		}
		
		 * if (&quot;Zimlotto&quot;.equalsIgnoreCase(gameName)) { promobean = new
		 * PromoGameBean();
		 * promobean.setPromoGameNo(Util.getGameNumber(&quot;RaffleGame&quot;));
		 * promobean.setPromoGametype(&quot;RAFFLE&quot;);
		 * promobean.setPromoTicketType(&quot;ORIGINAL&quot;);
		 * promoGameslist.add(promobean); }
		 
		if (&quot;Zimlottotwo&quot;.equalsIgnoreCase(gameName)) {
			promobean = new PromoGameBean();
			promobean.setPromoGameNo(Util.getGameNumber(&quot;RaffleGame1&quot;));
			promobean.setPromoGametype(&quot;RAFFLE&quot;);
			promobean.setPromoTicketType(&quot;ORIGINAL&quot;);
			promoGameslist.add(promobean);
		}

		if (&quot;Keno&quot;.equalsIgnoreCase(gameName)) {
			boolean isPromoDraw = false;
			List&lt;String&gt; KenoIndoorGamelist = KenoConstants.KENO_INDOORDRAWNAME_LIST;
			for (String drawNamePurch : drawNamePurchList) {
				if (KenoIndoorGamelist.contains(drawNamePurch)) {
					isPromoDraw = true;
					break;
				}

			}
			if (totalPurchAmt &gt;= 50 &amp;&amp; isPromoDraw) {
				promobean = new PromoGameBean();
				promobean.setPromoGameNo(Util.getGameNumber(&quot;Zerotonine&quot;));
				promobean.setPromoGametype(&quot;Zerotonine&quot;);
				promobean.setPromoTicketType(&quot;ORIGINAL&quot;);
				promoGameslist.add(promobean);
			}

		}

		
		 * if (&quot;Keno&quot;.equalsIgnoreCase(gameName)) { promobean = new
		 * PromoGameBean();
		 * promobean.setPromoGameNo(Util.getGameNumber(&quot;RaffleGame&quot;));
		 * promobean.setPromoGametype(&quot;RAFFLE&quot;);
		 * promobean.setPromoTicketType(&quot;ORIGINAL&quot;);
		 * promoGameslist.add(promobean); }
		 

		// if(&quot;KenoTwo&quot;.equalsIgnoreCase(gameName) &amp;&amp; totalPurchAmt &gt; 50){
		// promobean = new PromoGameBean();
		// promobean.setPromoGameNo(Util.getGameNumber(&quot;Zerotonine&quot;));
		// promobean.setPromoGametype(&quot;Zerotonine&quot;);
		// promobean.setPromoTicketType(&quot;ORIGINAL&quot;);
		// promoGameslist.add(promobean);
		// }

		return promoGameslist;

	}*/

	public static UserInfoBean getAgentDetails(int retOrgId, Connection con) {
<span class="nc" id="L2699">		UserInfoBean userBean = new UserInfoBean();</span>
		try {
<span class="nc" id="L2701">			PreparedStatement pStatement = con</span>
					.prepareStatement(&quot;select parent_id from st_lms_organization_master where organization_id=&quot;
							+ retOrgId + &quot;&quot;);
<span class="nc" id="L2704">			ResultSet resultSet = pStatement.executeQuery();</span>
<span class="nc bnc" id="L2705" title="All 2 branches missed.">			while (resultSet.next()) {</span>
<span class="nc" id="L2706">				int userOrgId = resultSet.getInt(&quot;parent_id&quot;);</span>
<span class="nc" id="L2707">				userBean.setUserOrgId(userOrgId);</span>
<span class="nc" id="L2708">				PreparedStatement pStatement2 = con</span>
						.prepareStatement(&quot;select user_id from st_lms_user_master where organization_id=&quot;
								+ userOrgId + &quot;&quot;);
<span class="nc" id="L2711">				ResultSet resultSet2 = pStatement2.executeQuery();</span>
<span class="nc bnc" id="L2712" title="All 2 branches missed.">				while (resultSet2.next()) {</span>
<span class="nc" id="L2713">					userBean.setUserId(resultSet2.getInt(&quot;user_id&quot;));</span>
				}
<span class="nc" id="L2715">			}</span>
<span class="nc" id="L2716">		} catch (Exception e) {</span>
<span class="nc" id="L2717">			e.printStackTrace();</span>
<span class="nc" id="L2718">		}</span>
<span class="nc" id="L2719">		return userBean;</span>
	}
	public static void bindPlrNAffiliate(Connection con, String plrId,UserInfoBean userBean,int walletId) throws LMSException {
		try {
<span class="nc" id="L2723">			String mappingQry = &quot;insert into st_ola_affiliate_plr_mapping values(?,?,?,?,?)&quot;;</span>
<span class="nc" id="L2724">			PreparedStatement mappingPstmt = con.prepareStatement(mappingQry);</span>
<span class="nc" id="L2725">			mappingPstmt.setString(1, plrId);</span>
<span class="nc" id="L2726">			mappingPstmt.setString(2, userBean.getUserName());</span>
<span class="nc" id="L2727">			mappingPstmt.setString(3, userBean.getUserType());</span>
<span class="nc" id="L2728">			mappingPstmt.setInt(4, userBean.getUserOrgId());</span>
<span class="nc" id="L2729">			mappingPstmt.setInt(5, walletId);</span>
<span class="nc" id="L2730">			int isUpdate = mappingPstmt.executeUpdate();</span>
<span class="nc" id="L2731">			logger.info(&quot;st_ola_affiliate_plr_mapping is update&quot;+isUpdate);</span>
			//insert into st_ola_rummy_plr_deposit_status @change to  st_ola_rummy_plr_deposit_comm_status 
<span class="nc" id="L2733">			String walletName = OLAUtility.getWalletName(walletId);</span>
<span class="nc bnc" id="L2734" title="All 4 branches missed.">		if(walletName.equalsIgnoreCase(&quot;Rummy&quot;)||walletName.equalsIgnoreCase(&quot;KhelPlayRummy&quot;)){</span>
				
<span class="nc" id="L2736">				String query =&quot;insert into st_ola_rummy_plr_deposit_comm_status(plr_id,dep_wallet_id,till_date,settlement_upto_date,status) select ?,?,?,max(settlement_upto_date),? from st_ola_rummy_plr_deposit_comm_status &quot;;</span>
				//	String query =&quot;insert into st_ola_rummy_plr_deposit_comm_status(plr_id,till_date,settlement_upto_date,status) values(?,?,?,?)&quot;;
<span class="nc" id="L2738">				Calendar cal = Calendar.getInstance();</span>
<span class="nc" id="L2739">				java.sql.Date tillDate = new java.sql.Date(cal.getTime().getTime());			</span>
<span class="nc" id="L2740">				PreparedStatement ps =con.prepareStatement(query);</span>
<span class="nc" id="L2741">				ps.setString(1,plrId);	</span>
<span class="nc" id="L2742">				ps.setInt(2,walletId);</span>
<span class="nc" id="L2743">				ps.setDate(3,tillDate);</span>
				//ps.setDate(3,tillDate);
<span class="nc" id="L2745">				ps.setString(4,&quot;DONE&quot;);</span>
<span class="nc" id="L2746">				ps.executeUpdate();	</span>
			}
		

<span class="nc" id="L2750">		} catch (SQLException e) {</span>
<span class="nc" id="L2751">			e.printStackTrace();</span>
<span class="nc" id="L2752">			throw new LMSException(</span>
					&quot;ERROR occured during inserting entry in plr affiliate binding table&quot;);
<span class="nc" id="L2754">		}</span>
<span class="nc" id="L2755">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>