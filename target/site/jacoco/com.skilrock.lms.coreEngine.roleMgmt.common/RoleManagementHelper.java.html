<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RoleManagementHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lms</a> &gt; <a href="index.source.html" class="el_package">com.skilrock.lms.coreEngine.roleMgmt.common</a> &gt; <span class="el_source">RoleManagementHelper.java</span></div><h1>RoleManagementHelper.java</h1><pre class="source lang-java linenums">package com.skilrock.lms.coreEngine.roleMgmt.common;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.TreeMap;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.apache.struts2.ServletActionContext;

import com.skilrock.lms.beans.ServicesBean;
import com.skilrock.lms.beans.UserDetailsBean;
import com.skilrock.lms.beans.UserInfoBean;
import com.skilrock.lms.common.db.DBConnect;
import com.skilrock.lms.common.exception.LMSException;
import com.skilrock.lms.common.filter.LMSFilterDispatcher;
import com.skilrock.lms.common.utility.AutoGenerate;
import com.skilrock.lms.common.utility.MD5Encoder;
import com.skilrock.lms.common.utility.MailSend;
import com.skilrock.lms.rolemgmt.beans.userListBean;
import com.skilrock.lms.rolemgmt.beans.userPrivBean;
import com.skilrock.lms.sportsLottery.common.NotifySLE;
import com.skilrock.lms.sportsLottery.common.SLE;
import com.skilrock.lms.sportsLottery.userMgmt.javaBeans.MenuDataBean;
import com.skilrock.lms.sportsLottery.userMgmt.javaBeans.MenuItemDataBean;
import com.skilrock.lms.sportsLottery.userMgmt.javaBeans.PrivilegeDataBean;
import com.skilrock.lms.sportsLottery.userMgmt.javaBeans.RolePrivilegeBean;
import com.skilrock.lms.web.drawGames.common.Util;

<span class="nc" id="L38">public class RoleManagementHelper</span>

{
<span class="nc" id="L41">	static Log logger = LogFactory.getLog(RoleManagementHelper.class);</span>

	/*
	 * public void createSuperUser(String superUser,String firstName,String
	 * lastName,String secQues,String secAns,Date dateOfBirth,String
	 * gender,String email,String addr1, String addr2,String city,long
	 * phone,long mobile) { int userId; short x=1; long postalCode=321601; Date
	 * dd= new Date(new java.util.Date().getTime()); //Date ddd=new
	 * Date(dateOfBirth.getTime()); Set igsInfo = new HashSet();
	 * 
	 * 
	 * Session session=HibernateSessionFactory.getSession(); Transaction
	 * tx=null; tx=session.beginTransaction();
	 * 
	 * IgsRoleMaster roleMas=new IgsRoleMaster(); // entry into igs role master
	 * roleMas.setRoleName(&quot;SUP_USER&quot;); session.save(roleMas);
	 * logger.debug(roleMas.getRoleId()); // insert into igs user master
	 * 
	 * IgsUserMaster ium=new IgsUserMaster(); ium.setIsrolehead(x);
	 * ium.setPassword(MD5Encoder.encode(AutoGenerate.autoPassword()));
	 * ium.setRegistrationDate(new java.sql.Timestamp(dd.getTime()));
	 * ium.setSecAns(secAns); ium.setSecQues(secQues); ium.setStatus(&quot;ACTIVE&quot;);
	 * ium.setUserName(superUser); // insert into user info table
	 * 
	 * IgsUserInfo iui=new IgsUserInfo(); IgsUserInfoId iuiId=new
	 * IgsUserInfoId(); ium.setRoleId(roleMas.getRoleId()); /// this is added
	 * later iuiId.setIgsUserMaster(ium);
	 * 
	 * iuiId.setAddressLine1(addr1); iuiId.setAddressLine2(addr2);
	 * iuiId.setCity(city); iuiId.setCountryCode(&quot;1&quot;);
	 * iuiId.setDateOfBirth(dateOfBirth); iuiId.setEmailId(email);
	 * iuiId.setFirstName(firstName); iuiId.setLastName(lastName);
	 * iuiId.setGender(gender); iuiId.setMobileNum(mobile);
	 * iuiId.setPhoneNum(phone); iuiId.setPostalCode(postalCode);
	 * iuiId.setStateCode(&quot;fr&quot;);
	 * 
	 * iui.setId(iuiId); igsInfo.add(iui); ium.setIgsUserInfos(igsInfo);
	 * iui.setIgsUserMaster(ium);
	 * 
	 * 
	 * 
	 * 
	 * session.save(ium); session.save(iui); userId=ium.getUserId(); /* // entry
	 * into user role mapping userRoleMap.setRoleId(roleMas.getRoleId());
	 * userRoleMap.setRoleHead(&quot;YES&quot;); userRoleMap.setUserId(userId);
	 * userRoleMap.setUserName(&quot;superUser&quot;); session.save(userRoleMap);
	 */
	/*
	 * String query=&quot;select new &quot;+PriviledgeBeanRole.class.getName()+&quot;(pr.pid)
	 * from PriviledgeRep as pr&quot;; Query q=session.createQuery(query); List&lt;PriviledgeBeanRole&gt;
	 * list =q.list(); // insert into role priviledges table
	 * 
	 * RolePrivlMapping rolePrivMap=new RolePrivlMapping(); //IgsRoleMaster
	 * irm=new IgsRoleMaster(); RolePrivlMappingId rpmId=new
	 * RolePrivlMappingId();
	 * 
	 * for(int i=0;i&lt;list.size();i++) { // irm.setRoleId(roleMas.getRoleId());
	 * rpmId.setIgsRoleMaster(roleMas); logger.debug(&quot;inside for&quot;);
	 * rpmId.setPid(list.get(i).getPid());
	 * 
	 * rolePrivMap.setId(rpmId); // rolePrivMap.setRoleId(roleMas.getRoleId()); //
	 * rolePrivMap.setPid(list.get(i).getPid()); //
	 * rolePrivMap.setRoleId(roleMas.getRoleId());
	 * logger.debug(&quot;111111111111111111111111111111111111111&quot;);
	 * session.save(rolePrivMap); // session.flush(); //session.clear();
	 * logger.debug(&quot;1111111111111111111111111111111111&quot;); }
	 * logger.debug(&quot;22222222222222&quot;); // insert into user priv master table
	 * UserPrivMaster upm=new UserPrivMaster(); UserPrivMasterId upmId=new
	 * UserPrivMasterId(); for(int i=0;i&lt;list.size();i++) {
	 * 
	 * logger.debug(&quot;inside for&quot;);
	 * 
	 * 
	 * upmId.setPid(list.get(i).getPid()); upmId.setRoleId(roleMas.getRoleId()) ;
	 * upmId.setStatus(&quot;ACTIVE&quot;); upmId.setUserId(userId);
	 * 
	 * upm.setId(upmId); session.save(upm); //session.flush(); //
	 * session.clear(); }
	 * 
	 * tx.commit(); }
	 */

	public static void main(String[] args) throws SQLException, LMSException {
<span class="nc" id="L124">		RoleManagementHelper rmh = new RoleManagementHelper();</span>
<span class="nc" id="L125">		String isNewService=&quot;No&quot;;</span>
		/*
		 * rmh.newPrivForMaster(&quot;AGENT&quot;); rmh.newPrivForMaster(&quot;BO&quot;);
		 * rmh.newPrivForMaster(&quot;RETAILER&quot;);
		 */
		// logger.debug(rmh.getHeadsGroupNames(1,1,1));
		// logger.debug(rmh.fetchRoles(1, &quot;BO&quot;,1));
		// logger.debug(rmh.fetchRolePriv(1,&quot;BO&quot;,1,1));
		/*
		 * String rolePriv[]={&quot;Close Games&quot;,&quot;Game Details&quot;,&quot;New Game&quot;}; int
		 * mappingId[]={7,1}; int privCount[]={3,0};
		 */
		// rmh.createRole(&quot;TEST&quot;, &quot;TEST ROLE&quot;,&quot;BO&quot;, rolePriv, mappingId,
		// privCount, 1, 1, 1);
		// rmh.deletePriv();
<span class="nc" id="L140">		rmh.managePriv(&quot;BO&quot;, &quot;&quot;,isNewService);</span>
<span class="nc" id="L141">		rmh.managePriv(&quot;AGENT&quot;, &quot;&quot;,isNewService);</span>
<span class="nc" id="L142">		rmh.managePriv(&quot;RETAILER&quot;, &quot;&quot;,isNewService);</span>
		// new menuBuilder().createMenu();
<span class="nc" id="L144">		logger.info(&quot;Done---------&quot;);</span>

<span class="nc" id="L146">	}</span>

	public void assignPriviledges(String userName, int[] rolePid,
			ArrayList&lt;userPrivBean&gt; headPrivList, int roleId,
			UserDetailsBean usrdetBean) throws SQLException {
<span class="nc" id="L151">		String projectName = ServletActionContext.getServletContext()</span>
				.getContextPath();
<span class="nc" id="L153">		logger.debug(&quot;user name and pids are &quot; + userName + rolePid);</span>
		 
<span class="nc" id="L155">		Connection con = DBConnect.getConnection();</span>

		// int userId=getUserIdByuserName(userName);
<span class="nc" id="L158">		int userId = 0;</span>
<span class="nc" id="L159">		String password = AutoGenerate.autoPassword();</span>
<span class="nc" id="L160">		String status = null;</span>

<span class="nc" id="L162">		Statement stmt = con.createStatement();</span>
<span class="nc" id="L163">		Statement stmt1 = con.createStatement();</span>
<span class="nc" id="L164">		con.setAutoCommit(false);</span>

		// insert data into st user master

<span class="nc" id="L168">		stmt1</span>
				.executeUpdate(&quot;insert into st_user_master(organization_id,role_id,organization_type,registration_date,auto_password,user_name,password,status,secret_ques,secret_ans,isrolehead) values(&quot;
						+ usrdetBean.getOrgId()
						+ &quot;,&quot;
						+ usrdetBean.getRoleId()
						+ &quot;,'&quot;
						+ usrdetBean.getOrgType()
						+ &quot;',CURRENT_DATE,1,'&quot;
						+ usrdetBean.getUserName().trim()
						+ &quot;','&quot;
						+ MD5Encoder.encode(password)
						+ &quot;','&quot;
						+ usrdetBean.getStatus()
						+ &quot;','&quot;
						+ usrdetBean.getSecQues()
						+ &quot;','&quot;
						+ usrdetBean.getSecAns() + &quot;','N')&quot;);
<span class="nc" id="L185">		ResultSet rs = stmt1.getGeneratedKeys();</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">		while (rs.next()) {</span>
<span class="nc" id="L187">			userId = rs.getInt(1);</span>

		}
<span class="nc" id="L190">		stmt1</span>
				.executeUpdate(&quot;INSERT into st_user_contact_details(user_id,first_name,last_name,email_id,phone_nbr) VALUES('&quot;
						+ userId
						+ &quot;','&quot;
						+ usrdetBean.getFirstName()
						+ &quot;','&quot;
						+ usrdetBean.getLastName()
						+ &quot;','&quot;
						+ usrdetBean.getEmailId()
						+ &quot;','&quot;
						+ usrdetBean.getPhoneNbr() + &quot;')&quot;);
<span class="nc" id="L201">		stmt1</span>
				.executeUpdate(&quot;INSERT into st_lms_password_history (user_id,password,date_changed,type)VALUES('&quot;
						+ userId
						+ &quot;','&quot;
						+ MD5Encoder.encode(password)
						+ &quot;',CURRENT_DATE,'1')&quot;);

<span class="nc" id="L208">		logger.debug(&quot;array length is &quot; + rolePid.length + &quot;value is  &quot;</span>
				+ rolePid[0]);

		// insert data into user priviledges master
<span class="nc" id="L212">		String insertintoUserPrivMapQuery = null;</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">		for (int i = 0; i &lt; headPrivList.size(); i++) {</span>
<span class="nc" id="L214">			int headPid = headPrivList.get(i).getPid();</span>
<span class="nc" id="L215">			status = &quot;INACTIVE&quot;;</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">			for (int element : rolePid) {</span>
				// logger.debug(rolePid[j] + &quot;gggggg&quot;+
				// headPrivList.get(i).getPid());
<span class="nc bnc" id="L219" title="All 2 branches missed.">				if (element == headPid) {</span>
<span class="nc" id="L220">					status = &quot;ACTIVE&quot;;</span>
<span class="nc" id="L221">					break;</span>
				}

			}

<span class="nc" id="L226">			insertintoUserPrivMapQuery = &quot;insert into st_lms_user_priv_mapping values(&quot;</span>
					+ userId
					+ &quot;,&quot;
					+ roleId
					+ &quot;,&quot;
					+ headPrivList.get(i).getPid() + &quot;,'&quot; + status + &quot;')&quot;;

			// logger.debug(&quot;query to insert is : &quot; + &quot;insert into
			// st_lms_user_priv_mapping
			// values(&quot;+userId+&quot;,&quot;+roleId+&quot;,&quot;+headPrivList.get(i).getPid()+&quot;,'&quot;+status+&quot;')&quot;);
<span class="nc" id="L236">			stmt.executeUpdate(insertintoUserPrivMapQuery);</span>

			// con.commit();
		}
<span class="nc" id="L240">		con.commit();</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">		if (con != null) {</span>
<span class="nc" id="L242">			con.close();</span>
		}
<span class="nc" id="L244">		String msgFor = &quot;Thanks for registration to our gaming system  Your Login details are&quot;;</span>
		// MailSend.sendMailToUser(usrdetBean.getEmailId(),
		// password,usrdetBean.getUserName());
<span class="nc" id="L247">		String emailMsgTxt = &quot;&lt;html&gt;&lt;table&gt;&lt;tr&gt;&lt;td&gt;Hi &quot;</span>
				+ usrdetBean.getFirstName() + &quot; &quot; + usrdetBean.getLastName()
				+ &quot;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&quot; + msgFor
				+ &quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;table&gt;&lt;tr&gt;&lt;td&gt;User Name :: &lt;/td&gt;&lt;td&gt;&quot;
				+ usrdetBean.getUserName()
				+ &quot;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;password :: &lt;/td&gt;&lt;td&gt;&quot;
				+ password.toString() + &quot;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;log on &lt;/td&gt;&lt;td&gt;&quot;
				+ LMSFilterDispatcher.webLink + &quot;/&quot;
				+ LMSFilterDispatcher.mailProjName
				+ &quot;/&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/html&gt;&quot;;
<span class="nc" id="L257">		MailSend mailSend = new MailSend(usrdetBean.getEmailId(), emailMsgTxt);</span>
<span class="nc" id="L258">		mailSend.setDaemon(true);</span>
<span class="nc" id="L259">		mailSend.start();</span>
		// MailSend.sendMailToUser(usrdetBean.getEmailId(),
		// password,usrdetBean.getUserName(),usrdetBean.getFirstName(),usrdetBean.getLastName(),msgFor);
<span class="nc" id="L262">	}</span>

	public void chintanInsertQueryForHeadDeployment(String tierCode) {
		 
<span class="nc" id="L266">		Connection con = DBConnect.getConnection();</span>
		try {
<span class="nc" id="L268">			con.setAutoCommit(false);</span>

<span class="nc" id="L270">			Statement tierStmt = con.createStatement();</span>
<span class="nc" id="L271">			Statement serDelStmt = con.createStatement();</span>
<span class="nc" id="L272">			Statement privStmt = con.createStatement();</span>
<span class="nc" id="L273">			Statement insRPMStmt = con.createStatement();</span>
<span class="nc" id="L274">			Statement orgStmt = con.createStatement();</span>
<span class="nc" id="L275">			Statement userStmt = con.createStatement();</span>
<span class="nc" id="L276">			Statement srmStmt = con.createStatement();</span>

<span class="nc" id="L278">			ResultSet rsTier = null;</span>
<span class="nc" id="L279">			ResultSet rsServDel = null;</span>
<span class="nc" id="L280">			ResultSet rsPriv = null;</span>
<span class="nc" id="L281">			ResultSet rsOrg = null;</span>

<span class="nc" id="L283">			String selTier = &quot;select tier_id as tierId,tier_status as tierStatus,role_id as roleId  from st_lms_tier_master tm, st_lms_role_master  rm where tm.tier_code='&quot;</span>
					+ tierCode
					+ &quot;' and tm.tier_id = rm.tier_id and rm.is_master = 'Y'&quot;;
<span class="nc" id="L286">			String selServDel = null;</span>
<span class="nc" id="L287">			String selPriv = null;</span>
<span class="nc" id="L288">			String selOrg = &quot;select organization_id from st_lms_organization_master where organization_type = '&quot;</span>
					+ tierCode + &quot;'&quot;;
<span class="nc" id="L290">			String insSRM = null;</span>
<span class="nc" id="L291">			String selUser = null;</span>
<span class="nc" id="L292">			logger.debug(&quot;Org -- &quot; + selOrg);</span>
<span class="nc" id="L293">			rsOrg = orgStmt.executeQuery(selOrg);</span>

<span class="nc" id="L295">			rsTier = tierStmt.executeQuery(selTier);</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">			while (rsTier.next()) {</span>
<span class="nc" id="L297">				int tierId = rsTier.getInt(&quot;tierId&quot;);</span>
<span class="nc" id="L298">				String tierStatus = rsTier.getString(&quot;tierStatus&quot;);</span>
<span class="nc" id="L299">				int roleId = rsTier.getInt(&quot;roleId&quot;);</span>

<span class="nc" id="L301">				selServDel = &quot;select  dm.service_delivery_master_id as mapId, dm.status as delStatus, dm.priv_rep_table, sm.service_id as servId, sm.status as serStatus from st_lms_service_delivery_master dm, st_lms_service_master sm where dm.tier_id = &quot;</span>
						+ tierId + &quot; and dm.service_id = sm.service_id&quot;;
<span class="nc" id="L303">				rsServDel = serDelStmt.executeQuery(selServDel);</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">				while (rsServDel.next()) {</span>
<span class="nc" id="L305">					int mapId = rsServDel.getInt(&quot;mapId&quot;);</span>
<span class="nc" id="L306">					int serId = rsServDel.getInt(&quot;servId&quot;);</span>
<span class="nc" id="L307">					String delStatus = rsServDel.getString(&quot;delStatus&quot;);</span>
<span class="nc" id="L308">					String servStatus = rsServDel.getString(&quot;serStatus&quot;);</span>
<span class="nc" id="L309">					String privTable = rsServDel</span>
							.getString(&quot;privilege_rep_table&quot;);
<span class="nc" id="L311">					StringBuilder insRPM = new StringBuilder(</span>
							&quot;insert into st_lms_role_priv_mapping values &quot;);
<span class="nc" id="L313">					selPriv = &quot;select distinct(priv_id), status as privStatus from &quot;</span>
							+ privTable
							+ &quot; where priv_owner = '&quot;
							+ tierCode
							+ &quot;'&quot;;
					// selPriv=&quot;select distinct(pid), status as privStatus from
					// &quot;+privTable+&quot; where priv_owner = '&quot;+tierCode+&quot;' and pid
					// not in (select pid from st_lms_role_priv_mapping where
					// service_mapping_id=&quot;+mapId+&quot; and role_id=&quot;+roleId+&quot;)&quot;;

<span class="nc" id="L323">					rsPriv = privStmt.executeQuery(selPriv);</span>
<span class="nc bnc" id="L324" title="All 6 branches missed.">					boolean status = tierStatus.equals(&quot;ACTIVE&quot;)</span>
							&amp;&amp; delStatus.equals(&quot;ACTIVE&quot;)
							&amp;&amp; servStatus.equals(&quot;ACTIVE&quot;);
<span class="nc" id="L327">					boolean flag = false;</span>
<span class="nc bnc" id="L328" title="All 2 branches missed.">					while (rsPriv.next()) {</span>
<span class="nc" id="L329">						String privStatus = rsPriv.getString(&quot;privStatus&quot;);</span>
<span class="nc" id="L330">						int pid = rsPriv.getInt(&quot;priv_id&quot;);</span>
<span class="nc" id="L331">						String insStatus = &quot;INACTIVE&quot;;</span>
<span class="nc bnc" id="L332" title="All 4 branches missed.">						if (status &amp;&amp; privStatus.equals(&quot;ACTIVE&quot;)) {</span>
<span class="nc" id="L333">							insStatus = &quot;ACTIVE&quot;;</span>
						}
<span class="nc" id="L335">						flag = true;</span>
<span class="nc" id="L336">						insRPM.append(&quot;(&quot; + roleId + &quot;,&quot; + pid + &quot;,&quot; + mapId</span>
								+ &quot;,'&quot; + insStatus + &quot;'),&quot;);
<span class="nc" id="L338">					}</span>
<span class="nc" id="L339">					logger.debug(&quot;************&quot; + insRPM);</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">					if (flag) {</span>
<span class="nc" id="L341">						insRPMStmt.executeUpdate(insRPM.substring(0, insRPM</span>
								.length() - 1));

<span class="nc bnc" id="L344" title="All 2 branches missed.">						while (rsOrg.next()) {</span>
							// logger.debug(&quot;ORG*********&quot;+&quot;insert into
							// st_lms_service_role_mapping values
							// (&quot;+mapId+&quot;,&quot;+roleId+&quot;,&quot;+rsOrg.getInt(&quot;organization_id&quot;)+&quot;,&quot;+(status?&quot;ACTIVE&quot;:&quot;INACTIVE&quot;)+&quot;)&quot;);
<span class="nc bnc" id="L348" title="All 2 branches missed.">							srmStmt</span>
									.executeUpdate(&quot;insert into st_lms_service_role_mapping values (&quot;
											+ mapId
											+ &quot;,&quot;
											+ roleId
											+ &quot;,&quot;
											+ rsOrg.getInt(&quot;organization_id&quot;)
											+ &quot;,&quot;
											+ (status ? &quot;'ACTIVE'&quot;
													: &quot;'INACTIVE'&quot;) + &quot;)&quot;);
						}
<span class="nc" id="L359">						rsOrg.beforeFirst();</span>
					}
<span class="nc" id="L361">				}</span>

<span class="nc" id="L363">				selUser = &quot;insert into st_lms_user_priv_mapping select user_id,rpm.role_id,priv_id,service_mapping_id,rpm.status from st_lms_role_priv_mapping rpm,st_lms_user_master um where um.role_id=&quot;</span>
						+ roleId
						+ &quot; and um.organization_type='&quot;
						+ tierCode
						+ &quot;' and isrolehead='Y' and rpm.role_id=&quot; + roleId + &quot;&quot;;
<span class="nc" id="L368">				userStmt.executeUpdate(selUser);</span>
<span class="nc" id="L369">			}</span>
<span class="nc" id="L370">			con.commit();</span>

<span class="nc" id="L372">		} catch (SQLException e) {</span>
<span class="nc" id="L373">			logger.error(&quot;Exception: &quot; + e);</span>
			// TODO Auto-generated catch block
<span class="nc" id="L375">			e.printStackTrace();</span>
<span class="nc" id="L376">		}</span>
<span class="nc" id="L377">	}</span>

	public void createRole(String roleName, String roleDesc, UserInfoBean userBean, String[] rolePriv,
			int[] mappingId, int[] privCount, List&lt;PrivilegeDataBean&gt; privilegeListSLE) throws SQLException {
<span class="nc" id="L381">		String userType = userBean.getUserType();</span>
<span class="nc" id="L382">		int creatorRoleId = userBean.getRoleId();</span>
<span class="nc" id="L383">		int tierId = userBean.getTierId();</span>
<span class="nc" id="L384">		int ownerOrgId = userBean.getUserOrgId();</span>
		
<span class="nc" id="L386">		logger.debug(&quot;role name is : &quot; + roleName);</span>
<span class="nc" id="L387">		String activeMapIds = &quot;&quot;;</span>
<span class="nc" id="L388">		StringBuilder grpName = null;</span>
		// Miscellaneous will give all the Miscellaneous privileges
<span class="nc" id="L390">		String grpNameStr = null;</span>
<span class="nc" id="L391">		int privIdFrm = 0;</span>
<span class="nc" id="L392">		int privIdTo = 0;</span>
<span class="nc" id="L393">		String updateRolePriv = null;</span>
<span class="nc" id="L394">		HashMap&lt;Integer, String&gt; privMap = new HashMap&lt;Integer, String&gt;();</span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">		for (int i = 0; i &lt; mappingId.length; i++) {</span>
<span class="nc bnc" id="L396" title="All 2 branches missed.">			if (privCount[i] != 0) {</span>
<span class="nc" id="L397">				grpName = new StringBuilder(&quot;'Miscellaneous',&quot;);</span>
<span class="nc" id="L398">				privIdTo = privIdTo + privCount[i];</span>
<span class="nc bnc" id="L399" title="All 2 branches missed.">				for (int j = privIdFrm; j &lt; privIdTo; j++) {</span>
<span class="nc" id="L400">					grpName.append(&quot;'&quot; + rolePriv[j] + &quot;',&quot;);</span>
<span class="nc" id="L401">					privIdFrm++;</span>
				}
<span class="nc" id="L403">				grpNameStr = grpName.substring(0, grpName.length() - 1);</span>
<span class="nc" id="L404">				activeMapIds = activeMapIds + mappingId[i] + &quot;,&quot;;</span>
<span class="nc" id="L405">				privMap.put(mappingId[i], grpNameStr);</span>
			}
		}

		 
<span class="nc" id="L410">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L411">		Statement stmt = con.createStatement();</span>
<span class="nc" id="L412">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L413">		ResultSet rs1 =null;</span>
<span class="nc" id="L414">		Statement stmtUpdate = con.createStatement();</span>
<span class="nc" id="L415">		con.setAutoCommit(false);</span>
<span class="nc" id="L416">		String query1 =&quot;select role_name from st_lms_role_master  where  role_name=? or role_description=?&quot;;</span>
<span class="nc" id="L417">		pstmt=con.prepareStatement(query1);</span>
<span class="nc" id="L418">		pstmt.setString(1,roleName);</span>
<span class="nc" id="L419">		pstmt.setString(2,roleDesc);</span>
<span class="nc" id="L420">		logger.info(&quot;check role query is ---&quot; + pstmt);</span>
<span class="nc" id="L421">		rs1=pstmt.executeQuery();</span>
<span class="nc bnc" id="L422" title="All 2 branches missed.">		if(rs1.next()){</span>
<span class="nc" id="L423">			logger.debug(&quot;Role  Alrady Exists&quot;);</span>
<span class="nc" id="L424">			throw new SQLException(&quot;Role  Alrady Exists With These Details&quot;);</span>
		}
<span class="nc" id="L426">		String query = &quot;insert into st_lms_role_master(role_name,role_description,tier_id,owner_org_id,is_master) values('&quot;</span>
				+ roleName
				+ &quot;','&quot;
				+ roleDesc
				+ &quot;','&quot;
				+ tierId
				+ &quot;',&quot;
				+ ownerOrgId + &quot;,'N')&quot;;
<span class="nc" id="L434">		logger.info(&quot;query is ---&quot; + query);</span>
<span class="nc" id="L435">		stmt.executeUpdate(query);</span>

<span class="nc" id="L437">		int roleId = 0;</span>
<span class="nc" id="L438">		ResultSet rs = stmt.getGeneratedKeys();</span>
<span class="nc bnc" id="L439" title="All 2 branches missed.">		while (rs.next()) {</span>
<span class="nc" id="L440">			roleId = rs.getInt(1);</span>
		}
<span class="nc" id="L442">		String insertSerRolePriv = &quot;insert into st_lms_service_role_mapping(id,role_id,organization_id,status) (select service_delivery_master_id,&quot;</span>
				+ roleId
				+ &quot;,&quot;
				+ ownerOrgId
				+ &quot;,'INACTIVE' from st_lms_service_delivery_master where  tier_id=&quot;
				+ tierId + &quot;)&quot;;
<span class="nc" id="L448">		stmt.executeUpdate(insertSerRolePriv);</span>

<span class="nc" id="L450">		String updateService = &quot;update st_lms_service_role_mapping set status='ACTIVE' where id in (&quot;</span>
				+ activeMapIds.substring(0, activeMapIds.length() - 1) + &quot;)&quot;;
<span class="nc" id="L452">		stmt.executeUpdate(updateService);</span>

<span class="nc" id="L454">		String insRolePriv = &quot;insert into st_lms_role_priv_mapping(role_id,priv_id,service_mapping_id,status) select &quot;</span>
				+ roleId
				+ &quot;,priv_id,service_mapping_id,'INACTIVE' from st_lms_role_priv_mapping where role_id=&quot;
				+ creatorRoleId + &quot;&quot;;
<span class="nc" id="L458">		stmt.executeUpdate(insRolePriv);</span>

<span class="nc" id="L460">		String fetchPrivTable = &quot;select service_delivery_master_id,priv_rep_table from st_lms_service_delivery_master where tier_id =&quot;</span>
				+ tierId + &quot;&quot;;
<span class="nc" id="L462">		ResultSet fetchPrivTabRS = stmt.executeQuery(fetchPrivTable);</span>
<span class="nc bnc" id="L463" title="All 2 branches missed.">		while (fetchPrivTabRS.next()) {</span>
<span class="nc" id="L464">			updateRolePriv = &quot;update st_lms_role_priv_mapping set status='ACTIVE' where role_id=&quot;</span>
					+ roleId
					+ &quot; and service_mapping_id=&quot;
					+ fetchPrivTabRS.getInt(&quot;service_delivery_master_id&quot;)
					+ &quot; and priv_id in (select distinct(priv_id) from &quot;
					+ fetchPrivTabRS.getString(&quot;priv_rep_table&quot;)
					+ &quot; pr where group_name in (&quot;
					+ privMap.get(fetchPrivTabRS
							.getInt(&quot;service_delivery_master_id&quot;))
					+ &quot;) and pr.status='ACTIVE') &quot;;
<span class="nc" id="L474">			logger.debug(&quot;updateRolePriv: &quot; + updateRolePriv);</span>
<span class="nc" id="L475">			stmtUpdate.executeUpdate(updateRolePriv);</span>
		}

<span class="nc" id="L478">		boolean flag = true;</span>
<span class="nc bnc" id="L479" title="All 2 branches missed.">		if(ServicesBean.isSLE()) {</span>
<span class="nc bnc" id="L480" title="All 4 branches missed.">			if(privilegeListSLE != null &amp;&amp; privilegeListSLE.size() &gt; 0) {</span>
<span class="nc" id="L481">				flag = false;</span>
<span class="nc bnc" id="L482" title="All 2 branches missed.">				for(PrivilegeDataBean privilegeBean : privilegeListSLE) {</span>
<span class="nc bnc" id="L483" title="All 2 branches missed.">					for(MenuDataBean menuBean : privilegeBean.getMenuList()) {</span>
<span class="nc bnc" id="L484" title="All 2 branches missed.">						for(MenuItemDataBean menuItemBean : menuBean.getMenuItems()) {</span>
<span class="nc" id="L485">							menuItemBean.setIsAssign(false);</span>
<span class="nc bnc" id="L486" title="All 2 branches missed.">							for(String privilege : rolePriv) {</span>
<span class="nc bnc" id="L487" title="All 2 branches missed.">								if(privilege.equals(menuItemBean.getMenuItemName())) {</span>
<span class="nc" id="L488">									menuItemBean.setIsAssign(true);</span>
								}
							}
<span class="nc" id="L491">						}</span>
<span class="nc" id="L492">					}</span>
<span class="nc" id="L493">				}</span>

				try {
<span class="nc" id="L496">					RolePrivilegeBean roleBean = new RolePrivilegeBean();</span>
<span class="nc" id="L497">					roleBean.setCreatorUserId(userBean.getUserId());</span>
<span class="nc" id="L498">					roleBean.setRoleId(roleId);</span>
<span class="nc" id="L499">					roleBean.setRoleName(roleName);</span>
<span class="nc" id="L500">					roleBean.setRoleDescription(roleDesc);</span>
<span class="nc" id="L501">					roleBean.setPrivilegeList(privilegeListSLE);</span>
<span class="nc" id="L502">					NotifySLE notifySLE = new NotifySLE(SLE.Activity.ROLE_REGISTRATION, roleBean);</span>
<span class="nc" id="L503">					notifySLE.asyncCall(notifySLE);</span>
<span class="nc" id="L504">					flag = true;</span>
<span class="nc" id="L505">				} catch (Exception ex) {</span>
<span class="nc" id="L506">					ex.printStackTrace();</span>
<span class="nc" id="L507">					flag = false;</span>
<span class="nc" id="L508">					logger.debug(&quot;Error in Creating Role.&quot;);</span>
<span class="nc" id="L509">					throw new SQLException(&quot;Error in Creating Role.&quot;);</span>
<span class="nc" id="L510">				}</span>
			} else {
<span class="nc" id="L512">				logger.debug(&quot;privilegeListSLE is Not Applicable.&quot;);</span>
<span class="nc" id="L513">				throw new SQLException(&quot;Error in Creating Role.&quot;);</span>
			}
		}

<span class="nc bnc" id="L517" title="All 2 branches missed.">		if(flag) {</span>
<span class="nc" id="L518">			con.commit();</span>
		} else {
<span class="nc" id="L520">			con.rollback();</span>
		}
<span class="nc" id="L522">		DBConnect.closeCon(con);</span>

<span class="nc" id="L524">	}</span>

	public void deletePriv() {
		 
<span class="nc" id="L528">		Connection con = DBConnect.getConnection();</span>
		try {
			// con.setAutoCommit(false);

<span class="nc" id="L532">			Statement tierStmt = con.createStatement();</span>
<span class="nc" id="L533">			tierStmt.execute(&quot;delete from st_lms_role_priv_mapping&quot;);</span>
<span class="nc" id="L534">			tierStmt.execute(&quot;delete from st_lms_service_role_mapping&quot;);</span>
<span class="nc" id="L535">			tierStmt.execute(&quot;delete from st_lms_user_priv_mapping&quot;);</span>
<span class="nc" id="L536">			con.close();</span>
<span class="nc" id="L537">		} catch (SQLException e) {</span>
<span class="nc" id="L538">			logger.error(&quot;Exception: &quot; + e);</span>
			// TODO Auto-generated catch block
<span class="nc" id="L540">			e.printStackTrace();</span>
<span class="nc" id="L541">		}</span>
<span class="nc" id="L542">	}</span>

	public void editRolePriv(int roleId, String[] rolePriv, int[] mappingId,
			int[] privCount, UserInfoBean userBean, List&lt;PrivilegeDataBean&gt; privilegeListSLE, String requestIp)
			throws SQLException {

<span class="nc" id="L548">		int creatorRoleId = userBean.getRoleId();</span>
<span class="nc" id="L549">		int tierId = userBean.getTierId();</span>
<span class="nc" id="L550">		int ownerOrgId = userBean.getUserOrgId();</span>

<span class="nc" id="L552">		String activeMapIds = &quot;&quot;;</span>
<span class="nc" id="L553">		StringBuilder grpName = null;</span>
		// Miscellaneous will give all the Miscellaneous privileges
<span class="nc" id="L555">		String grpNameStr = null;</span>
<span class="nc" id="L556">		int privIdFrm = 0;</span>
<span class="nc" id="L557">		int privIdTo = 0;</span>
<span class="nc" id="L558">		String updateRolePriv = null;</span>
<span class="nc" id="L559">		HashMap&lt;Integer, String&gt; privMap = new HashMap&lt;Integer, String&gt;();</span>
<span class="nc bnc" id="L560" title="All 2 branches missed.">		for (int i = 0; i &lt; mappingId.length; i++) {</span>
<span class="nc bnc" id="L561" title="All 2 branches missed.">			if (privCount[i] != 0) {</span>
<span class="nc" id="L562">				grpName = new StringBuilder(&quot;'Miscellaneous',&quot;);</span>
<span class="nc" id="L563">				privIdTo = privIdTo + privCount[i];</span>
<span class="nc bnc" id="L564" title="All 2 branches missed.">				for (int j = privIdFrm; j &lt; privIdTo; j++) {</span>
<span class="nc" id="L565">					grpName.append(&quot;'&quot; + rolePriv[j] + &quot;',&quot;);</span>
<span class="nc" id="L566">					privIdFrm++;</span>
				}
<span class="nc" id="L568">				grpNameStr = grpName.substring(0, grpName.length() - 1);</span>
<span class="nc" id="L569">				activeMapIds = activeMapIds + mappingId[i] + &quot;,&quot;;</span>
<span class="nc" id="L570">				privMap.put(mappingId[i], grpNameStr);</span>

			}
		}

		 
<span class="nc" id="L576">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L577">		Statement stmt = con.createStatement();</span>
<span class="nc" id="L578">		Statement stmtUpdate = con.createStatement();</span>
<span class="nc" id="L579">		con.setAutoCommit(false);</span>

		// logger.debug(tierId+&quot;==tier******activeid*&quot;+activeMapIds);
<span class="nc" id="L582">		String updService = &quot;update st_lms_service_role_mapping set status ='INACTIVE' where role_id=&quot;</span>
				+ roleId + &quot; and organization_id=&quot; + ownerOrgId + &quot;&quot;;
<span class="nc" id="L584">		stmt.executeUpdate(updService);</span>

<span class="nc" id="L586">		String updateService = &quot;update st_lms_service_role_mapping set status='ACTIVE' where role_id=&quot;</span>
				+ roleId
				+ &quot; and organization_id=&quot;
				+ ownerOrgId
				+ &quot; and id in (&quot;
				+ activeMapIds.substring(0, activeMapIds.length() - 1) + &quot;)&quot;;
<span class="nc" id="L592">		stmt.executeUpdate(updateService);</span>

<span class="nc" id="L594">		String updRolePriv = &quot;update st_lms_role_priv_mapping set status ='INACTIVE' where role_id=&quot;</span>
				+ roleId + &quot;&quot;;
<span class="nc" id="L596">		stmt.executeUpdate(updRolePriv);</span>

<span class="nc" id="L598">		String fetchPrivTable = &quot;select service_delivery_master_id,priv_rep_table from st_lms_service_delivery_master where tier_id =&quot;</span>
				+ tierId + &quot; and status='ACTIVE'&quot;;
<span class="nc" id="L600">		ResultSet fetchPrivTabRS = stmt.executeQuery(fetchPrivTable);</span>
<span class="nc bnc" id="L601" title="All 2 branches missed.">		while (fetchPrivTabRS.next()) {</span>
<span class="nc bnc" id="L602" title="All 2 branches missed.">			if (privMap</span>
					.get(fetchPrivTabRS.getInt(&quot;service_delivery_master_id&quot;)) != null) {
<span class="nc" id="L604">				updateRolePriv = &quot;update st_lms_role_priv_mapping set status='ACTIVE' where role_id=&quot;</span>
						+ roleId
						+ &quot; and service_mapping_id=&quot;
						+ fetchPrivTabRS.getInt(&quot;service_delivery_master_id&quot;)
						+ &quot; and priv_id in (select distinct(priv_id) from &quot;
						+ fetchPrivTabRS.getString(&quot;priv_rep_table&quot;)
						+ &quot; pr where group_name in (&quot;
						+ privMap.get(fetchPrivTabRS
								.getInt(&quot;service_delivery_master_id&quot;))
						+ &quot;) and pr.status='ACTIVE') &quot;;
<span class="nc" id="L614">				stmtUpdate.executeUpdate(updateRolePriv);</span>
			}
		}

		/*	Insert User Priviledge Data in History Start	*/
<span class="nc" id="L619">		String insertHistoryData = &quot;INSERT INTO st_lms_user_priv_history (user_id, priv_id, service_mapping_id, status, change_date, change_by, request_ip) SELECT user_id, priv_id, service_mapping_id, status, change_date, change_by, request_ip FROM st_lms_user_priv_mapping WHERE role_id=&quot;+roleId+&quot;;&quot;;</span>
<span class="nc" id="L620">		logger.info(&quot;insertHistoryData - &quot;+insertHistoryData);</span>
<span class="nc" id="L621">		stmt.executeUpdate(insertHistoryData);</span>
		/*	Insert User Priviledge Data in History End		*/

<span class="nc" id="L624">		String currentTime = Util.getCurrentTimeString();</span>
<span class="nc" id="L625">		String updRolePrivInActive = &quot;update st_lms_user_priv_mapping upm,st_lms_role_priv_mapping rpm set upm.status='INACTIVE', change_date='&quot;+currentTime+&quot;', change_by=&quot;+userBean.getUserId()+&quot;, request_ip='&quot;+requestIp+&quot;' where upm.role_id=&quot;</span>
				+ roleId
				+ &quot; and upm.role_id=rpm.role_id and upm.service_mapping_id=rpm.service_mapping_id and upm.priv_id=rpm.priv_id and  rpm.status='INACTIVE'&quot;;
<span class="nc" id="L628">		stmt.executeUpdate(updRolePrivInActive);</span>

<span class="nc" id="L630">		String updRoleHeadPrivActive = &quot;update st_lms_user_priv_mapping upm,st_lms_role_priv_mapping rpm set upm.status='ACTIVE', change_date='&quot;+currentTime+&quot;', change_by=&quot;+userBean.getUserId()+&quot;, request_ip='&quot;+requestIp+&quot;' where upm.role_id=&quot;</span>
				+ roleId
				+ &quot; and upm.user_id in (select user_id from st_lms_user_master where isrolehead='Y') and upm.role_id=rpm.role_id and upm.service_mapping_id=rpm.service_mapping_id and upm.priv_id=rpm.priv_id and  rpm.status='ACTIVE'&quot;;
<span class="nc" id="L633">		stmt.executeUpdate(updRoleHeadPrivActive);</span>

<span class="nc" id="L635">		boolean flag = true;</span>
<span class="nc bnc" id="L636" title="All 2 branches missed.">		if(ServicesBean.isSLE()) {</span>
<span class="nc bnc" id="L637" title="All 4 branches missed.">			if(privilegeListSLE != null &amp;&amp; privilegeListSLE.size() &gt; 0) {</span>
<span class="nc" id="L638">				flag = false;</span>
<span class="nc bnc" id="L639" title="All 2 branches missed.">				for(PrivilegeDataBean privilegeBean : privilegeListSLE) {</span>
<span class="nc bnc" id="L640" title="All 2 branches missed.">					for(MenuDataBean menuBean : privilegeBean.getMenuList()) {</span>
<span class="nc bnc" id="L641" title="All 2 branches missed.">						for(MenuItemDataBean menuItemBean : menuBean.getMenuItems()) {</span>
<span class="nc" id="L642">							menuItemBean.setIsAssign(false);</span>
<span class="nc bnc" id="L643" title="All 2 branches missed.">							for(String privilege : rolePriv) {</span>
<span class="nc bnc" id="L644" title="All 2 branches missed.">								if(privilege.equals(menuItemBean.getMenuItemName())) {</span>
<span class="nc" id="L645">									menuItemBean.setIsAssign(true);</span>
								}
							}
<span class="nc" id="L648">						}</span>
<span class="nc" id="L649">					}</span>
<span class="nc" id="L650">				}</span>

				try {
<span class="nc" id="L653">					RolePrivilegeBean roleBean = new RolePrivilegeBean();</span>
<span class="nc" id="L654">					roleBean.setRoleId(roleId);</span>
<span class="nc" id="L655">					roleBean.setCreatorUserId(userBean.getUserId());</span>
<span class="nc" id="L656">					roleBean.setRequestIp(requestIp);</span>
<span class="nc" id="L657">					roleBean.setPrivilegeList(privilegeListSLE);</span>
<span class="nc" id="L658">					NotifySLE notifySLE = new NotifySLE(SLE.Activity.ROLE_EDIT, roleBean);</span>
<span class="nc" id="L659">					notifySLE.asyncCall(notifySLE);</span>
<span class="nc" id="L660">					flag = true;</span>
<span class="nc" id="L661">				} catch (Exception ex) {</span>
<span class="nc" id="L662">					ex.printStackTrace();</span>
<span class="nc" id="L663">					flag = false;</span>
<span class="nc" id="L664">					logger.debug(&quot;Error in Edit Role.&quot;);</span>
<span class="nc" id="L665">					throw new SQLException(&quot;Error in Edit Role.&quot;);</span>
<span class="nc" id="L666">				}</span>
			} else {
<span class="nc" id="L668">				logger.debug(&quot;privilegeListSLE is Not Applicable.&quot;);</span>
<span class="nc" id="L669">				throw new SQLException(&quot;Error in Creating Role.&quot;);</span>
			}
		}

<span class="nc bnc" id="L673" title="All 2 branches missed.">		if(flag) {</span>
<span class="nc" id="L674">			con.commit();</span>
		} else {
<span class="nc" id="L676">			con.rollback();</span>
		}

<span class="nc" id="L679">		DBConnect.closeCon(con);</span>
<span class="nc" id="L680">	}</span>

	public void editUserPriv(String userName, int roleId, int[] rolePriv)
			throws LMSException {
		// logger.debug(&quot;priv id is &quot; + rolePriv[0] );

		 
<span class="nc" id="L687">		Connection con = DBConnect.getConnection();</span>
		try {
<span class="nc" id="L689">			con.setAutoCommit(false);</span>
<span class="nc" id="L690">			int userId = getUserIdByuserName(userName);</span>
<span class="nc" id="L691">			Statement stmt = con.createStatement();</span>
<span class="nc" id="L692">			Statement stmt1 = con.createStatement();</span>
<span class="nc" id="L693">			ArrayList pidList = new ArrayList();</span>

<span class="nc" id="L695">			String getHeadsPidsQuery = &quot;select pid from role_privl_mapping where role_id=&quot;</span>
					+ roleId + &quot;&quot;;
<span class="nc" id="L697">			ResultSet rs = stmt.executeQuery(getHeadsPidsQuery);</span>
<span class="nc bnc" id="L698" title="All 2 branches missed.">			while (rs.next()) {</span>
				// logger.debug(&quot;helllo&quot;);
<span class="nc" id="L700">				pidList.add(rs.getInt(&quot;pid&quot;));</span>

			}
<span class="nc" id="L703">			String status = null;</span>
<span class="nc bnc" id="L704" title="All 2 branches missed.">			for (int i = 0; i &lt; pidList.size(); i++) {</span>
<span class="nc" id="L705">				int headPid = (Integer) pidList.get(i);</span>
<span class="nc" id="L706">				status = &quot;INACTIVE&quot;;</span>
<span class="nc bnc" id="L707" title="All 2 branches missed.">				for (int element : rolePriv) {</span>
<span class="nc bnc" id="L708" title="All 2 branches missed.">					if (element == headPid) {</span>
						// logger.debug(&quot;from jsp is &quot; + rolePriv[j] + &quot;from
						// back is &quot;+ (Integer)pidList.get(i));

<span class="nc" id="L712">						status = &quot;ACTIVE&quot;;</span>
<span class="nc" id="L713">						break;</span>

					}
				}
				// logger.debug(&quot;from jsp is &quot; + rolePriv[j] + &quot;from back is &quot;+
				// (Integer)pidList.get(i));
				// logger.debug(&quot;status is &quot; + status);
<span class="nc" id="L720">				String updateUserPrivMapQuery = &quot;update st_lms_user_priv_mapping set status='&quot;</span>
						+ status
						+ &quot;' where user_id=&quot;
						+ userId
						+ &quot; and role_id=&quot;
						+ roleId
						+ &quot; and priv_id=&quot;
						+ (Integer) pidList.get(i) + &quot;&quot;;
				// logger.debug(&quot;query is &quot; +updateUserPrivMapQuery );
<span class="nc" id="L729">				stmt.executeUpdate(updateUserPrivMapQuery);</span>

			}
<span class="nc" id="L732">			con.commit();</span>
<span class="nc" id="L733">		} catch (SQLException e) {</span>

<span class="nc" id="L735">			logger.error(&quot;Exception: &quot; + e);</span>
			try {
<span class="nc bnc" id="L737" title="All 2 branches missed.">				if (con != null) {</span>
<span class="nc" id="L738">					con.rollback();</span>
				}
<span class="nc" id="L740">			} catch (SQLException se) {</span>
<span class="nc" id="L741">				logger.error(&quot;Exception: &quot; + se);</span>
				// TODO Auto-generated catch block
<span class="nc" id="L743">				se.printStackTrace();</span>
<span class="nc" id="L744">				throw new LMSException(&quot;Error During Rollback&quot;, se);</span>

<span class="nc" id="L746">			}</span>
<span class="nc" id="L747">			e.printStackTrace();</span>
<span class="nc" id="L748">			throw new LMSException(e);</span>
		} finally {
<span class="nc" id="L750">			try {</span>
<span class="nc bnc" id="L751" title="All 4 branches missed.">				if (con != null) {</span>
<span class="nc" id="L752">					con.close();</span>
				}
<span class="nc" id="L754">			} catch (SQLException see) {</span>
<span class="nc" id="L755">				logger.error(&quot;Exception: &quot; + see);</span>
<span class="nc" id="L756">				see.printStackTrace();</span>
<span class="nc" id="L757">				throw new LMSException(&quot;Error During closing connection&quot;, see);</span>
<span class="nc" id="L758">			}</span>
		}
<span class="nc" id="L760">	}</span>

	public Map&lt;String, TreeMap&lt;String, TreeMap&lt;String, List&lt;userPrivBean&gt;&gt;&gt;&gt; fetchRolePriv(
			int roleId, String userType, int userOrgId, int userId)
			throws LMSException {

<span class="nc" id="L766">		Map&lt;String, TreeMap&lt;String, TreeMap&lt;String, List&lt;userPrivBean&gt;&gt;&gt;&gt; headPriviledgeMap = new TreeMap&lt;String, TreeMap&lt;String, TreeMap&lt;String, List&lt;userPrivBean&gt;&gt;&gt;&gt;();</span>

		 
<span class="nc" id="L769">		Connection con = DBConnect.getConnection();</span>
		try {
<span class="nc" id="L771">			Statement privStmt = con.createStatement();</span>
<span class="nc" id="L772">			Statement serviceStmt = con.createStatement();</span>
			// get heads priviledges from role_priv_mapping table
<span class="nc" id="L774">			String rolePrivQuery = null;</span>
			// String fetchService = &quot;select
			// srm.id,role_id,service_display_name,privilege_rep_table,interface
			// from st_lms_service_role_mapping srm,st_lms_service_master sm
			// where srm.status='ACTIVE' and srm.role_id=&quot;+roleId+&quot; and
			// sm.status='ACTIVE' and srm.service_id=sm.service_id&quot;;
<span class="nc" id="L780">			String fetchService = &quot;select srm.id,role_id,interface,service_display_name,priv_rep_table,srm.status from st_lms_service_role_mapping srm,st_lms_service_master sm,st_lms_service_delivery_master sdm where srm.role_id=&quot;</span>
					+ roleId
					+ &quot; and organization_id=&quot;
					+ userOrgId
					+ &quot; and srm.id=sdm.service_delivery_master_id and sdm.service_id=sm.service_id and sdm.status='ACTIVE'&quot;;

<span class="nc" id="L786">			ResultSet serviceRS = serviceStmt.executeQuery(fetchService);</span>
<span class="nc" id="L787">			ResultSet privRS = null;</span>
<span class="nc" id="L788">			TreeMap&lt;String, TreeMap&lt;String, List&lt;userPrivBean&gt;&gt;&gt; interfaceMap = null;</span>
<span class="nc bnc" id="L789" title="All 2 branches missed.">			while (serviceRS.next()) {</span>
<span class="nc" id="L790">				rolePrivQuery = &quot;select distinct(group_name),rpm.status,pr.related_to from &quot;</span>
						+ serviceRS.getString(&quot;priv_rep_table&quot;)
						+ &quot; as pr ,st_lms_role_priv_mapping as rpm, st_lms_user_priv_mapping upm where upm.user_id=&quot;
						+ userId
						+ &quot; and  upm.status='ACTIVE' and upm.priv_id=rpm.priv_id and rpm.service_mapping_id=&quot;
						+ serviceRS.getString(&quot;id&quot;)
						+ &quot; and rpm.role_id=&quot;
						+ roleId
						+ &quot; and  rpm.priv_id=pr.priv_id  and pr.status='ACTIVE'  order by related_to,group_name&quot;;
				// logger.debug(rolePrivQuery);
<span class="nc" id="L800">				privRS = privStmt.executeQuery(rolePrivQuery);</span>
<span class="nc" id="L801">				String relatedTo = &quot;&quot;;</span>
				userPrivBean privBean;
<span class="nc" id="L803">				String oldRelatedTo = &quot;&quot;;</span>
<span class="nc" id="L804">				List&lt;userPrivBean&gt; groupNameList = null;</span>
<span class="nc bnc" id="L805" title="All 2 branches missed.">				if (!headPriviledgeMap.containsKey(serviceRS</span>
						.getString(&quot;service_display_name&quot;))) {
<span class="nc" id="L807">					interfaceMap = new TreeMap&lt;String, TreeMap&lt;String, List&lt;userPrivBean&gt;&gt;&gt;();</span>
				}
<span class="nc" id="L809">				TreeMap&lt;String, List&lt;userPrivBean&gt;&gt; privMap = new TreeMap&lt;String, List&lt;userPrivBean&gt;&gt;();</span>
				// logger.debug(rolePrivQuery);
<span class="nc bnc" id="L811" title="All 2 branches missed.">				while (privRS.next()) {</span>
<span class="nc bnc" id="L812" title="All 16 branches missed.">					if (!privRS.getString(&quot;group_name&quot;).equals(&quot;Miscellaneous&quot;)</span>
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;Create Role&quot;)
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;Edit Role&quot;)
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;BO User Registration&quot;)
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;BO: Edit Role&quot;)
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;BO: Create Role&quot;)
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;BO: Role Head Registration&quot;)
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;Role Head Registration&quot;)		) {
<span class="nc" id="L827">						relatedTo = privRS.getString(&quot;related_to&quot;);</span>
<span class="nc" id="L828">						privBean = new userPrivBean();</span>
						// privBean.setPid(Privrs.getInt(&quot;pid&quot;));
<span class="nc" id="L830">						privBean.setPrivTitle(privRS.getString(&quot;group_name&quot;));</span>
<span class="nc" id="L831">						privBean.setStatus(privRS.getString(&quot;status&quot;));</span>
<span class="nc" id="L832">						privBean.setPrivRelatedTo(relatedTo);</span>
						// logger.debug(privRS.getString(&quot;group_name&quot;)+&quot;***&quot;+privRS.getString(&quot;status&quot;));
<span class="nc bnc" id="L834" title="All 2 branches missed.">						if (!relatedTo.equals(oldRelatedTo)) {</span>
<span class="nc" id="L835">							groupNameList = new ArrayList&lt;userPrivBean&gt;();</span>
<span class="nc" id="L836">							oldRelatedTo = relatedTo;</span>
<span class="nc" id="L837">							privMap.put(oldRelatedTo, groupNameList);</span>

						}
<span class="nc" id="L840">						groupNameList.add(privBean);</span>
					}
				}
<span class="nc" id="L843">				interfaceMap.put(serviceRS.getString(&quot;interface&quot;) + &quot;-&quot;</span>
						+ serviceRS.getString(&quot;id&quot;), privMap);
<span class="nc" id="L845">				headPriviledgeMap.put(serviceRS</span>
						.getString(&quot;service_display_name&quot;), interfaceMap);
<span class="nc" id="L847">			}</span>
<span class="nc" id="L848">			logger.debug(&quot;*****headPriviledgeMap****\n&quot; + headPriviledgeMap</span>
					+ &quot;\n********&quot;);
<span class="nc" id="L850">			return headPriviledgeMap;</span>

<span class="nc" id="L852">		} catch (SQLException e) {</span>
<span class="nc" id="L853">			logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L854">			e.printStackTrace();</span>
<span class="nc" id="L855">			throw new LMSException(&quot;sqlException&quot;, e);</span>
		} finally {
<span class="nc bnc" id="L857" title="All 4 branches missed.">			if (con != null) {</span>
				try {
<span class="nc" id="L859">					con.close();</span>
<span class="nc" id="L860">				} catch (SQLException e) {</span>
<span class="nc" id="L861">					logger.error(&quot;Exception: &quot; + e);</span>
					// TODO Auto-generated catch block
<span class="nc" id="L863">					e.printStackTrace();</span>
<span class="nc" id="L864">				}</span>
			}
		}
	}

	public Map&lt;Integer, String&gt; fetchRoles(int roleId, String userType,
			int userOrgId) throws LMSException {
<span class="nc" id="L871">		Map&lt;Integer, String&gt; roleMap = new TreeMap&lt;Integer, String&gt;();</span>

		 
<span class="nc" id="L874">		Connection con = DBConnect.getConnection();</span>
		try {
<span class="nc" id="L876">			Statement privStmt = con.createStatement();</span>

			// get heads priviledges from role_priv_mapping table
<span class="nc" id="L879">			String rolePrivQuery = &quot;select role_id,role_name from st_lms_role_master where owner_org_id=&quot;</span>
					+ userOrgId
					+ &quot; and is_master='N' and role_id !=&quot;
					+ roleId
					+ &quot;&quot;;
<span class="nc" id="L884">			ResultSet privRS = privStmt.executeQuery(rolePrivQuery);</span>

<span class="nc bnc" id="L886" title="All 2 branches missed.">			while (privRS.next()) {</span>
<span class="nc" id="L887">				roleMap.put(privRS.getInt(&quot;role_id&quot;), privRS</span>
						.getString(&quot;role_name&quot;));

			}

<span class="nc" id="L892">			return roleMap;</span>

<span class="nc" id="L894">		} catch (SQLException e) {</span>
<span class="nc" id="L895">			logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L896">			e.printStackTrace();</span>
<span class="nc" id="L897">			throw new LMSException(&quot;sqlException&quot;, e);</span>
		} finally {
<span class="nc bnc" id="L899" title="All 4 branches missed.">			if (con != null) {</span>
				try {
<span class="nc" id="L901">					con.close();</span>
<span class="nc" id="L902">				} catch (SQLException e) {</span>
<span class="nc" id="L903">					logger.error(&quot;Exception: &quot; + e);</span>
					// TODO Auto-generated catch block
<span class="nc" id="L905">					e.printStackTrace();</span>
<span class="nc" id="L906">				}</span>
			}
		}

	}

	public Map&lt;String, TreeMap&lt;String, TreeMap&lt;String, List&lt;String&gt;&gt;&gt;&gt; getHeadsGroupNames(
			int userId, int roleId, int userOrgId) throws LMSException {

<span class="nc" id="L915">		Map&lt;String, TreeMap&lt;String, TreeMap&lt;String, List&lt;String&gt;&gt;&gt;&gt; headPriviledgeMap = new TreeMap&lt;String, TreeMap&lt;String, TreeMap&lt;String, List&lt;String&gt;&gt;&gt;&gt;();</span>

		 
<span class="nc" id="L918">		Connection con = DBConnect.getConnection();</span>
		try {
<span class="nc" id="L920">			Statement privStmt = con.createStatement();</span>
<span class="nc" id="L921">			Statement serviceStmt = con.createStatement();</span>
			// get heads priviledges from role_priv_mapping table
<span class="nc" id="L923">			String rolePrivQuery = null;</span>
			// String fetchService = &quot;select
			// srm.id,role_id,service_display_name,privilege_rep_table,interface
			// from st_lms_service_role_mapping srm,st_lms_service_master sm
			// where srm.status='ACTIVE' and srm.role_id=&quot;+roleId+&quot; and
			// sm.status='ACTIVE' and srm.service_id=sm.service_id&quot;;
<span class="nc" id="L929">			String fetchService = &quot;select srm.id,role_id,interface,service_display_name,priv_rep_table from st_lms_service_role_mapping srm,st_lms_service_master sm,st_lms_service_delivery_master sdm where srm.role_id=&quot;</span>
					+ roleId
					+ &quot; and organization_id=&quot;
					+ userOrgId
					+ &quot; and srm.status='ACTIVE' and sm.status='ACTIVE' and sdm.status='ACTIVE' and srm.id=sdm.service_delivery_master_id and sdm.service_id=sm.service_id&quot;;
<span class="nc" id="L934">			ResultSet serviceRS = serviceStmt.executeQuery(fetchService);</span>
<span class="nc" id="L935">			ResultSet privRS = null;</span>
<span class="nc" id="L936">			TreeMap&lt;String, TreeMap&lt;String, List&lt;String&gt;&gt;&gt; interfaceMap = null;</span>
<span class="nc bnc" id="L937" title="All 2 branches missed.">			while (serviceRS.next()) {</span>
<span class="nc" id="L938">				rolePrivQuery = &quot;select distinct(pr.group_name),pr.related_to from st_lms_user_priv_mapping upm,&quot;</span>
						+ serviceRS.getString(&quot;priv_rep_table&quot;)
						+ &quot; as pr,(select distinct(upm.priv_id) from st_lms_role_priv_mapping rpm,st_lms_user_priv_mapping upm where upm.user_id=&quot;
						+ userId
						+ &quot; and upm.role_id=&quot;
						+ roleId
						+ &quot; and rpm.status='ACTIVE' and upm.status='ACTIVE'and upm.role_id=rpm.role_id and upm.service_mapping_id=&quot;
						+ serviceRS.getInt(&quot;id&quot;)
						+ &quot;) result where upm.user_id=&quot;
						+ userId
						+ &quot; and upm.priv_id=pr.priv_id and pr.status='ACTIVE' and result.priv_id=pr.priv_id order by related_to,group_name&quot;;
				// logger.debug(rolePrivQuery);
<span class="nc" id="L950">				privRS = privStmt.executeQuery(rolePrivQuery);</span>
<span class="nc" id="L951">				String relatedTo = &quot;&quot;;</span>
<span class="nc" id="L952">				List&lt;String&gt; groupNameList = null;</span>
<span class="nc bnc" id="L953" title="All 2 branches missed.">				if (!headPriviledgeMap.containsKey(serviceRS</span>
						.getString(&quot;service_display_name&quot;))) {
<span class="nc" id="L955">					interfaceMap = new TreeMap&lt;String, TreeMap&lt;String, List&lt;String&gt;&gt;&gt;();</span>
				}
<span class="nc" id="L957">				TreeMap&lt;String, List&lt;String&gt;&gt; privMap = new TreeMap&lt;String, List&lt;String&gt;&gt;();</span>
<span class="nc bnc" id="L958" title="All 2 branches missed.">				while (privRS.next()) {</span>
<span class="nc bnc" id="L959" title="All 16 branches missed.">					if (!privRS.getString(&quot;group_name&quot;).equals(&quot;Miscellaneous&quot;)</span>
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;Create Role&quot;)
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;Edit Role&quot;)
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;BO User Registration&quot;)
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;BO: Edit Role&quot;)
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;BO: Create Role&quot;)
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;BO: Role Head Registration&quot;)
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;Role Head Registration&quot;)		) {
<span class="nc bnc" id="L974" title="All 2 branches missed.">						if (!relatedTo.equals(privRS.getString(&quot;related_to&quot;))) {</span>
<span class="nc" id="L975">							groupNameList = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L976">							relatedTo = privRS.getString(&quot;related_to&quot;);</span>
<span class="nc" id="L977">							privMap.put(relatedTo, groupNameList);</span>
						}
<span class="nc" id="L979">						groupNameList.add(privRS.getString(&quot;group_name&quot;));</span>
					}
				}
<span class="nc" id="L982">				interfaceMap.put(serviceRS.getString(&quot;interface&quot;) + &quot;-&quot;</span>
						+ serviceRS.getString(&quot;id&quot;), privMap);
<span class="nc" id="L984">				headPriviledgeMap.put(serviceRS</span>
						.getString(&quot;service_display_name&quot;), interfaceMap);
<span class="nc" id="L986">			}</span>

<span class="nc" id="L988">			return headPriviledgeMap;</span>

<span class="nc" id="L990">		} catch (SQLException e) {</span>
<span class="nc" id="L991">			logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L992">			e.printStackTrace();</span>
<span class="nc" id="L993">			throw new LMSException(&quot;sqlException&quot;, e);</span>
		} finally {
<span class="nc bnc" id="L995" title="All 4 branches missed.">			if (con != null) {</span>
				try {
<span class="nc" id="L997">					con.close();</span>
<span class="nc" id="L998">				} catch (SQLException e) {</span>
<span class="nc" id="L999">					logger.error(&quot;Exception: &quot; + e);</span>
					// TODO Auto-generated catch block
<span class="nc" id="L1001">					e.printStackTrace();</span>
<span class="nc" id="L1002">				}</span>
			}
		}

	}

	/*
	 * public List createRoleHead() { //logger.debug(&quot;role name is : &quot;+
	 * roleName); Session session=HibernateSessionFactory.getSession();
	 * Transaction tx=null; tx=session.beginTransaction();
	 * 
	 * IgsUserMaster igsUserMas= new IgsUserMaster();
	 * 
	 * String query =&quot;select new
	 * &quot;+PriviledgeBeanRole.class.getName()+&quot;(ium.userName) from IgsUserMaster
	 * as ium &quot;; Query q=session.createQuery(query); List&lt;PriviledgeBeanRole&gt;
	 * userList=new ArrayList&lt;PriviledgeBeanRole&gt;(); userList =q.list();
	 * logger.debug(&quot;hello &quot;+ userList.get(0).getUserName()); //ArrayList&lt;PriviledgeBeanRole&gt;
	 * userList =q.list(); List userRoleList=new ArrayList();
	 * userRoleList.add(userList);
	 * 
	 * String roleQuery =&quot;select new
	 * &quot;+PriviledgeBeanRole.class.getName()+&quot;(irm.roleName,irm.roleId) from
	 * IgsRoleMaster as irm &quot;; Query q1=session.createQuery(roleQuery);
	 * 
	 * List&lt;PriviledgeBeanRole&gt; roleList=new ArrayList&lt;PriviledgeBeanRole&gt;(); //
	 * List&lt;PriviledgeBeanRole&gt; roleList =q1.list();
	 * 
	 * roleList =q1.list(); logger.debug(&quot;role list is :&quot;+roleList );
	 * 
	 * 
	 * userRoleList.add(roleList); //List&lt;PriviledgeBeanRole&gt; userList
	 * =q.list(); logger.debug(&quot;inside helper class create role head method&quot;);
	 * 
	 * logger.debug(&quot;user role list is &quot;+ userRoleList); return userRoleList; }
	 * 
	 * public void insertRoleHeadInsideDb(int roleId,int userId,String userName) {
	 * Session session=HibernateSessionFactory.getSession(); Transaction
	 * tx=null; tx=session.beginTransaction(); logger.debug(&quot;rolr id is &quot; +
	 * roleId); RolePrivlMapping rolePrivMap=new RolePrivlMapping(); String
	 * rolePrivQuery=&quot;select rpm from RolePrivlMapping as rpm where
	 * rpm.id.igsRoleMaster.roleId=?&quot;; Query
	 * q=session.createQuery(rolePrivQuery); q.setParameter(0, roleId);
	 * logger.debug(((RolePrivlMapping)(q.list().get(0))).getId().getPid());
	 * 
	 * UserPrivMaster upm= new UserPrivMaster(); UserPrivMasterId upmId=new
	 * UserPrivMasterId(); for(int i=0;i&lt;q.list().size();i++) {
	 * 
	 * 
	 * upmId.setUserId(userId); upmId.setRoleId(roleId);
	 * upmId.setPid(((RolePrivlMapping)(q.list().get(i))).getId().getPid());
	 * upmId.setStatus(&quot;ACTIVE&quot;); upm.setId(upmId); session.save(upm);
	 * session.flush(); session.clear(); }
	 * 
	 * 
	 * tx.commit(); }
	 * 
	 */
	public List getHeadsPriv(int roleId, int userId) throws SQLException {

<span class="nc" id="L1062">		logger.debug(&quot;role id and user id is &quot; + roleId + userId);</span>
		 
<span class="nc" id="L1064">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L1065">		Statement stmt = con.createStatement();</span>
<span class="nc" id="L1066">		Statement stmt1 = con.createStatement();</span>
<span class="nc" id="L1067">		con.setAutoCommit(false);</span>

<span class="nc" id="L1069">		String getUsersQuery = &quot;select user_name,user_Id  from st_user_master where role_id=&quot;</span>
				+ roleId
				+ &quot; and isrolehead='N' and  user_id not in(select user_id from st_lms_user_priv_mapping)&quot;;
<span class="nc" id="L1072">		ResultSet rs = stmt.executeQuery(getUsersQuery);</span>
<span class="nc" id="L1073">		ArrayList&lt;userListBean&gt; userList = new ArrayList&lt;userListBean&gt;();</span>
		userListBean userBean;
<span class="nc bnc" id="L1075" title="All 2 branches missed.">		while (rs.next()) {</span>

<span class="nc" id="L1077">			userBean = new userListBean();</span>
<span class="nc" id="L1078">			userBean.setUserName(rs.getString(&quot;user_name&quot;));</span>
<span class="nc" id="L1079">			userList.add(userBean);</span>

		}

		// get heads priviledges from role_priv_mapping table

<span class="nc" id="L1085">		String rolePrivQuery = &quot;select pr.pid,pr.priv_title from st_lms_user_priv_mapping upm,priviledge_rep as pr where upm.user_id=&quot;</span>
				+ userId + &quot; and upm.priv_id=pr.pid and pr.status='ACTIVE'&quot;;
<span class="nc" id="L1087">		ResultSet rs1 = stmt1.executeQuery(rolePrivQuery);</span>

		userPrivBean privBean;
<span class="nc" id="L1090">		ArrayList&lt;userPrivBean&gt; userPrivList = new ArrayList&lt;userPrivBean&gt;();</span>
<span class="nc bnc" id="L1091" title="All 2 branches missed.">		while (rs1.next()) {</span>
			// logger.debug(&quot;priv title is-----:: &quot;+rs1.getString(&quot;Priv_title&quot;)
			// );
<span class="nc bnc" id="L1094" title="All 8 branches missed.">			if (!rs1.getString(&quot;Priv_title&quot;).equals(&quot;Add Sub Users&quot;)</span>
					&amp;&amp; !rs1.getString(&quot;Priv_title&quot;).equals(
							&quot;Edit User Priviledges&quot;)
					&amp;&amp; !rs1.getString(&quot;Priv_title&quot;).equals(
							&quot;BO: Edit Sub User Privileges&quot;)
					&amp;&amp; !rs1.getString(&quot;Priv_title&quot;).equals(&quot;BO: Add Sub User&quot;)) {
				// logger.debug(&quot;#############inside if
				// loop#############################&quot;);
<span class="nc" id="L1102">				privBean = new userPrivBean();</span>
<span class="nc" id="L1103">				privBean.setPid(rs1.getInt(&quot;pid&quot;));</span>
<span class="nc" id="L1104">				privBean.setPrivTitle(rs1.getString(&quot;Priv_title&quot;));</span>
<span class="nc" id="L1105">				userPrivList.add(privBean);</span>
			}
		}

<span class="nc" id="L1109">		List userandPrivList = new ArrayList();</span>
<span class="nc" id="L1110">		userandPrivList.add(userList);</span>
<span class="nc" id="L1111">		userandPrivList.add(userPrivList);</span>

<span class="nc bnc" id="L1113" title="All 2 branches missed.">		if (con != null) {</span>
<span class="nc" id="L1114">			con.close();</span>
		}
<span class="nc" id="L1116">		return userandPrivList;</span>

	}

	public int getUserIdByuserName(String userName) throws LMSException {

		 
<span class="nc" id="L1123">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L1124">		int userId = 0;</span>
		try {
<span class="nc" id="L1126">			Statement stmt = con.createStatement();</span>

<span class="nc" id="L1128">			ResultSet rs = stmt</span>
					.executeQuery(&quot;select user_id from st_user_master where user_name='&quot;
							+ userName + &quot;'&quot;);
<span class="nc bnc" id="L1131" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1132">				userId = rs.getInt(&quot;user_id&quot;);</span>

			}
<span class="nc" id="L1135">		} catch (SQLException e) {</span>
<span class="nc" id="L1136">			logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L1137">			e.printStackTrace();</span>
<span class="nc" id="L1138">			throw new LMSException(&quot;error in sql connection&quot;, e);</span>
		} finally {
<span class="nc" id="L1140">			try {</span>
<span class="nc bnc" id="L1141" title="All 4 branches missed.">				if (con != null) {</span>
<span class="nc" id="L1142">					con.close();</span>
				}
<span class="nc" id="L1144">			} catch (SQLException se) {</span>
<span class="nc" id="L1145">				logger.error(&quot;Exception: &quot; + se);</span>
<span class="nc" id="L1146">				se.printStackTrace();</span>
<span class="nc" id="L1147">			}</span>
<span class="nc" id="L1148">		}</span>

<span class="nc" id="L1150">		return userId;</span>
	}

	public ArrayList&lt;userPrivBean&gt; getUserPriviledges(String userName)
			throws LMSException {

		 
<span class="nc" id="L1157">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L1158">		ArrayList&lt;userPrivBean&gt; userPrivList = new ArrayList&lt;userPrivBean&gt;();</span>
		try {
<span class="nc" id="L1160">			Statement stmt = con.createStatement();</span>
<span class="nc" id="L1161">			Statement stmt1 = con.createStatement();</span>
<span class="nc" id="L1162">			con.setAutoCommit(false);</span>

<span class="nc" id="L1164">			int userId = getUserIdByuserName(userName);</span>
<span class="nc" id="L1165">			logger.debug(&quot;user id is sss &quot; + userId + &quot;user name is  &quot;</span>
					+ userName);
<span class="nc" id="L1167">			String privQuery = &quot;select pr.priv_title,pr.pid,upm.status from priviledge_rep as pr ,st_lms_user_priv_mapping as upm where upm.priv_id=pr.pid and upm.user_id=&quot;</span>
					+ userId + &quot;&quot;;
<span class="nc" id="L1169">			ResultSet rs = stmt.executeQuery(privQuery);</span>
			userPrivBean privBean;

<span class="nc bnc" id="L1172" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1173">				privBean = new userPrivBean();</span>
<span class="nc" id="L1174">				privBean.setPid(rs.getInt(&quot;pid&quot;));</span>
<span class="nc" id="L1175">				privBean.setPrivTitle(rs.getString(&quot;Priv_title&quot;));</span>
<span class="nc" id="L1176">				privBean.setStatus(rs.getString(&quot;status&quot;));</span>
<span class="nc" id="L1177">				userPrivList.add(privBean);</span>

			}

<span class="nc" id="L1181">		} catch (SQLException e) {</span>
<span class="nc" id="L1182">			logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L1183">			e.printStackTrace();</span>
<span class="nc" id="L1184">			throw new LMSException(&quot;Error During Rollback&quot;, e);</span>
		} finally {
<span class="nc" id="L1186">			try {</span>
<span class="nc bnc" id="L1187" title="All 4 branches missed.">				if (con != null) {</span>
<span class="nc" id="L1188">					con.close();</span>
				}
<span class="nc" id="L1190">			} catch (SQLException se) {</span>
<span class="nc" id="L1191">				logger.error(&quot;Exception: &quot; + se);</span>
<span class="nc" id="L1192">				se.printStackTrace();</span>
<span class="nc" id="L1193">			}</span>
<span class="nc" id="L1194">		}</span>
<span class="nc" id="L1195">		return userPrivList;</span>

	}

	public List getUsers(int roleId, int userId) throws SQLException {

		 
<span class="nc" id="L1202">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L1203">		Statement stmt = con.createStatement();</span>
<span class="nc" id="L1204">		Statement stmt1 = con.createStatement();</span>
<span class="nc" id="L1205">		con.setAutoCommit(false);</span>
		// get users list for editing from user and user priv mapping table

<span class="nc" id="L1208">		String userQuery = &quot;select distinct um.user_name,um.user_id from st_user_master as um ,st_lms_user_priv_mapping as upm where upm.role_id=&quot;</span>
				+ roleId
				+ &quot; and upm.user_id=um.user_id and um.isrolehead='N' order by um.user_name&quot;;
<span class="nc" id="L1211">		ResultSet rs = stmt.executeQuery(userQuery);</span>
<span class="nc" id="L1212">		ArrayList&lt;userListBean&gt; userList = new ArrayList&lt;userListBean&gt;();</span>
		userListBean userBean;
<span class="nc bnc" id="L1214" title="All 2 branches missed.">		while (rs.next()) {</span>

<span class="nc" id="L1216">			userBean = new userListBean();</span>
<span class="nc" id="L1217">			userBean.setUserName(rs.getString(&quot;user_name&quot;));</span>
<span class="nc" id="L1218">			userList.add(userBean);</span>
		}

		// get heads priviledges list

<span class="nc" id="L1223">		String headPrivQuery = &quot;select pr.priv_title,pr.pid from priviledge_rep as pr ,role_privl_mapping as rpm where rpm.pid=pr.pid and rpm.role_id=&quot;</span>
				+ roleId + &quot;&quot;;
<span class="nc" id="L1225">		ResultSet rs1 = stmt1.executeQuery(headPrivQuery);</span>
		userPrivBean privBean;
<span class="nc" id="L1227">		ArrayList&lt;userPrivBean&gt; userPrivList = new ArrayList&lt;userPrivBean&gt;();</span>
<span class="nc bnc" id="L1228" title="All 2 branches missed.">		while (rs1.next()) {</span>
<span class="nc bnc" id="L1229" title="All 8 branches missed.">			if (!rs1.getString(&quot;Priv_title&quot;).equals(&quot;Add Sub Users&quot;)</span>
					&amp;&amp; !rs1.getString(&quot;Priv_title&quot;).equals(
							&quot;Edit User Priviledges&quot;)
					&amp;&amp; !rs1.getString(&quot;Priv_title&quot;).equals(
							&quot;BO: Edit Sub User Privileges&quot;)
					&amp;&amp; !rs1.getString(&quot;Priv_title&quot;).equals(&quot;BO: Add Sub User&quot;)) {
<span class="nc" id="L1235">				privBean = new userPrivBean();</span>
<span class="nc" id="L1236">				privBean.setPid(rs1.getInt(&quot;pid&quot;));</span>
<span class="nc" id="L1237">				privBean.setPrivTitle(rs1.getString(&quot;Priv_title&quot;));</span>
<span class="nc" id="L1238">				userPrivList.add(privBean);</span>
			}
		}

<span class="nc" id="L1242">		List userPrivListHead = new ArrayList();</span>
<span class="nc" id="L1243">		userPrivListHead.add(userList);</span>
<span class="nc" id="L1244">		userPrivListHead.add(userPrivList);</span>

<span class="nc" id="L1246">		con.close();</span>
<span class="nc" id="L1247">		return userPrivListHead;</span>

	}

	public void managePriv(String tierCode, String requestIp,String isNewService) {
		 
<span class="nc" id="L1253">		Connection con = DBConnect.getConnection();</span>
		try {
<span class="nc" id="L1255">			con.setAutoCommit(false);</span>

<span class="nc" id="L1257">			Statement tierStmt = con.createStatement();</span>
<span class="nc" id="L1258">			Statement serDelStmt = con.createStatement();</span>
<span class="nc" id="L1259">			Statement privStmt = con.createStatement();</span>
<span class="nc" id="L1260">			Statement insRPMStmt = con.createStatement();</span>
<span class="nc" id="L1261">			Statement orgStmt = con.createStatement();</span>
<span class="nc" id="L1262">			Statement userStmt = con.createStatement();</span>
<span class="nc" id="L1263">			Statement srmStmt = con.createStatement();</span>
<span class="nc" id="L1264">			Statement menuStmt = con.createStatement();</span>
<span class="nc" id="L1265">			Statement selectUser = con.createStatement();</span>

<span class="nc" id="L1267">			ResultSet rsTier = null;</span>
<span class="nc" id="L1268">			ResultSet rsServDel = null;</span>
<span class="nc" id="L1269">			ResultSet rsPriv = null;</span>
<span class="nc" id="L1270">			ResultSet rsOrg = null;</span>
<span class="nc" id="L1271">			ResultSet userRs = null;</span>

<span class="nc" id="L1273">			String currentTime = Util.getCurrentTimeString();</span>

<span class="nc bnc" id="L1275" title="All 2 branches missed.">			if(&quot;BO&quot;.equals(tierCode)) {</span>
<span class="nc" id="L1276">				String query = &quot;INSERT INTO st_lms_user_priv_history (user_id, priv_id, service_mapping_id, status, change_date, change_by, request_ip) SELECT user_id, priv_id, service_mapping_id, status, change_date, change_by, request_ip FROM st_lms_user_priv_mapping WHERE role_id=(SELECT role_id FROM st_lms_role_master WHERE tier_id=(SELECT tier_id FROM st_lms_tier_master WHERE tier_code='&quot;+tierCode+&quot;') AND is_master='Y');&quot;;</span>
<span class="nc" id="L1277">				logger.debug(&quot;Insert History Query - &quot;+query);</span>
<span class="nc" id="L1278">				con.createStatement().executeUpdate(query);</span>

<span class="nc" id="L1280">				query = &quot;UPDATE st_lms_user_priv_mapping SET change_date='&quot;+currentTime+&quot;', change_by=11001, request_ip='&quot;+requestIp+&quot;' WHERE role_id=(SELECT role_id FROM st_lms_role_master WHERE tier_id=(SELECT tier_id FROM st_lms_tier_master WHERE tier_code='BO') AND is_master='Y');&quot;;</span>
<span class="nc" id="L1281">				logger.debug(&quot;Update Mapping Table Query - &quot;+query);</span>
<span class="nc" id="L1282">				con.createStatement().executeUpdate(query);</span>
			}

<span class="nc" id="L1285">			logger.debug(&quot;Tier Code -- &quot; + tierCode);</span>

<span class="nc" id="L1287">			String selTier = &quot;select tm.tier_id as tierId,tier_status as tierStatus,role_id as roleId, rm.is_master &quot;</span>
					+ &quot; from st_lms_tier_master tm, st_lms_role_master  rm where tm.tier_code='&quot;
					+ tierCode + &quot;' and &quot; + &quot; tm.tier_id = rm.tier_id &quot;;
<span class="nc" id="L1290">			String selServDel = null;</span>
<span class="nc" id="L1291">			String selPriv = null;</span>
<span class="nc" id="L1292">			String selOrg = &quot;select organization_id from st_lms_organization_master where &quot;</span>
					+ &quot; organization_type = '&quot; + tierCode + &quot;'&quot;;
<span class="nc" id="L1294">			String insSRM = null;</span>
<span class="nc" id="L1295">			String selUser = null;</span>

<span class="nc" id="L1297">			logger.debug(&quot;Org -- &quot; + selOrg);</span>
<span class="nc" id="L1298">			rsOrg = orgStmt.executeQuery(selOrg);</span>

<span class="nc" id="L1300">			logger.debug(&quot;Tier and Roles-- &quot; + selTier);</span>
<span class="nc" id="L1301">			rsTier = tierStmt.executeQuery(selTier);</span>
<span class="nc bnc" id="L1302" title="All 2 branches missed.">			while (rsTier.next()) {</span>
<span class="nc" id="L1303">				logger.info(&quot;TIER - ROLE LOOP &quot;);</span>

<span class="nc" id="L1305">				int tierId = rsTier.getInt(&quot;tierId&quot;);</span>
<span class="nc" id="L1306">				String tierStatus = rsTier.getString(&quot;tierStatus&quot;);</span>
<span class="nc" id="L1307">				int roleId = rsTier.getInt(&quot;roleId&quot;);</span>
<span class="nc" id="L1308">				String isRoleMaster = rsTier.getString(&quot;is_master&quot;);</span>

<span class="nc" id="L1310">				selServDel = &quot;select  dm.service_delivery_master_id as mapId, dm.status as delStatus, dm.priv_rep_table, dm.menu_master_table, &quot;</span>
						+ &quot; sm.service_id as servId, sm.status as serStatus, interface from st_lms_service_delivery_master dm, &quot;
						+ &quot; st_lms_service_master sm where dm.tier_id = &quot;
						+ tierId + &quot; and &quot; + &quot; dm.service_id = sm.service_id&quot;;
<span class="nc" id="L1314">				logger.debug(&quot;Service Delivery ===&quot; + selServDel);</span>

<span class="nc" id="L1316">				rsServDel = serDelStmt.executeQuery(selServDel);</span>
<span class="nc bnc" id="L1317" title="All 2 branches missed.">				while (rsServDel.next()) {</span>
<span class="nc" id="L1318">					logger.debug(&quot;SERVICE DELIVERY LOOP&quot;);</span>
<span class="nc" id="L1319">					int mapId = rsServDel.getInt(&quot;mapId&quot;);</span>
<span class="nc" id="L1320">					int serId = rsServDel.getInt(&quot;servId&quot;);</span>
<span class="nc" id="L1321">					String delStatus = rsServDel.getString(&quot;delStatus&quot;);</span>
<span class="nc" id="L1322">					String servStatus = rsServDel.getString(&quot;serStatus&quot;);</span>
<span class="nc" id="L1323">					String privTable = rsServDel.getString(&quot;priv_rep_table&quot;);</span>
<span class="nc" id="L1324">					String menuTable = rsServDel.getString(&quot;menu_master_table&quot;);</span>
<span class="nc" id="L1325">					String userInterface = rsServDel.getString(&quot;interface&quot;);</span>
<span class="nc" id="L1326">					StringBuilder insRPM = new StringBuilder(</span>
							&quot;insert into st_lms_role_priv_mapping values &quot;);
<span class="nc" id="L1328">					selPriv = &quot;select distinct(priv_id), status as privStatus from &quot;</span>
							+ privTable
							+ &quot; where &quot;
							+ &quot; priv_owner = '&quot;
							+ tierCode
							+ &quot;' and channel = '&quot;
							+ userInterface
							+ &quot;' and priv_id not in (select distinct(priv_id) from &quot;
							+ &quot; st_lms_role_priv_mapping where role_id = &quot;
							+ roleId
							+ &quot; and service_mapping_id = &quot;
							+ mapId
							+ &quot;)&quot;;
					// selPriv=&quot;select distinct(pid), status as privStatus from
					// &quot;+privTable+&quot; where priv_owner = '&quot;+tierCode+&quot;' and pid
					// not in (select pid from st_lms_role_priv_mapping where
					// service_mapping_id=&quot;+mapId+&quot; and role_id=&quot;+roleId+&quot;)&quot;;

<span class="nc" id="L1346">					String menuInsert = &quot;insert into &quot;</span>
							+ menuTable
							+ &quot; (action_id,menu_name,menu_disp_name,menu_disp_name_en,menu_disp_name_fr,parent_menu_id,item_order) select action_id,group_name ,group_name,group_name_en,group_name_fr,0,0 from &quot;
							+ privTable
							+ &quot; where is_start='Y' and action_id not in (select action_id from &quot;
							+ menuTable + &quot;)&quot;;
<span class="nc" id="L1352">					logger.debug(&quot;menu insert -- &quot; + menuInsert);</span>
<span class="nc" id="L1353">					menuStmt.executeUpdate(menuInsert);</span>

<span class="nc" id="L1355">					rsPriv = privStmt.executeQuery(selPriv);</span>
<span class="nc bnc" id="L1356" title="All 6 branches missed.">					boolean status = tierStatus.equals(&quot;ACTIVE&quot;)</span>
							&amp;&amp; delStatus.equals(&quot;ACTIVE&quot;)
							&amp;&amp; servStatus.equals(&quot;ACTIVE&quot;);
<span class="nc" id="L1359">					boolean flag = false;</span>
<span class="nc" id="L1360">					logger.debug(selPriv);</span>
<span class="nc bnc" id="L1361" title="All 2 branches missed.">					while (rsPriv.next()) {</span>
<span class="nc" id="L1362">						String privStatus = rsPriv.getString(&quot;privStatus&quot;);</span>
<span class="nc" id="L1363">						int pid = rsPriv.getInt(&quot;priv_id&quot;);</span>
<span class="nc" id="L1364">						String insStatus = &quot;INACTIVE&quot;;</span>
<span class="nc bnc" id="L1365" title="All 6 branches missed.">						if (status &amp;&amp; privStatus.equals(&quot;ACTIVE&quot;)</span>
								&amp;&amp; isRoleMaster.equalsIgnoreCase(&quot;Y&quot;)) {
<span class="nc" id="L1367">							insStatus = &quot;ACTIVE&quot;;</span>
						}
<span class="nc" id="L1369">						flag = true;</span>
<span class="nc" id="L1370">						insRPM.append(&quot;(&quot; + roleId + &quot;,&quot; + pid + &quot;,&quot; + mapId</span>
								+ &quot;,'&quot; + insStatus + &quot;'),&quot;);
<span class="nc" id="L1372">					}</span>

<span class="nc" id="L1374">					logger.debug(roleId + &quot;Role Priv MapTest************&quot;</span>
							+ insRPM);

<span class="nc bnc" id="L1377" title="All 2 branches missed.">					if (flag) {</span>

<span class="nc" id="L1379">						insRPMStmt.executeUpdate(insRPM.substring(0, insRPM</span>
								.length() - 1));

					}
<span class="nc" id="L1383">					String userSelect = null;</span>

<span class="nc bnc" id="L1385" title="All 2 branches missed.">					while (rsOrg.next()) {</span>
<span class="nc" id="L1386">						logger.info(&quot;USER PRIV LOP - org loop&quot;);</span>
<span class="nc" id="L1387">						String userStatus = &quot;INACTIVE&quot;;</span>
<span class="nc" id="L1388">						userSelect = &quot;select user_id,isrolehead from st_lms_user_master um where um.role_id=&quot;</span>
								+ roleId
								+ &quot; and &quot;
								+ &quot; um.organization_type='&quot;
								+ tierCode
								+ &quot;' and um.organization_id=&quot;
								+ rsOrg.getInt(&quot;organization_id&quot;);

<span class="nc" id="L1396">						logger.debug(&quot;USer id -- &quot; + userSelect);</span>
<span class="nc" id="L1397">						userRs = selectUser.executeQuery(userSelect);</span>
<span class="nc bnc" id="L1398" title="All 2 branches missed.">						while (userRs.next()) {</span>
<span class="nc bnc" id="L1399" title="All 2 branches missed.">							if (userRs.getString(&quot;isrolehead&quot;)</span>
									.equalsIgnoreCase(&quot;N&quot;)) {
<span class="nc" id="L1401">								selUser = &quot;insert into st_lms_user_priv_mapping (user_id, role_id, priv_id, service_mapping_id, status, change_date, change_by, request_ip) select &quot;</span>
										+ userRs.getString(&quot;user_id&quot;)
										+ &quot;, &quot;
										+ roleId
										+ &quot;, priv_id, &quot;
										+ mapId
										+ &quot;, 'INACTIVE', '&quot;+currentTime+&quot;', 11001, '&quot;+requestIp+&quot;' from st_lms_role_priv_mapping where role_id = &quot;
										+ roleId
										+ &quot; and service_mapping_id = &quot;
										+ mapId
										+ &quot;  and&quot;
										+ &quot;  priv_id not in (select distinct(priv_id) from st_lms_user_priv_mapping where role_id = &quot;
										+ roleId
										+ &quot; and service_mapping_id = &quot;
										+ mapId
										+ &quot; and user_id = &quot;
										+ userRs.getString(&quot;user_id&quot;) + &quot; )&quot;;

<span class="nc" id="L1419">								logger.debug(&quot;user insert -- &quot; + selUser);</span>
							} else {
<span class="nc" id="L1421">								selUser = &quot;insert into st_lms_user_priv_mapping (user_id, role_id, priv_id, service_mapping_id, status, change_date, change_by, request_ip) select &quot;</span>
										+ userRs.getString(&quot;user_id&quot;)
										+ &quot;, &quot;
										+ roleId
										+ &quot;, priv_id, &quot;
										+ mapId
										+ &quot;, status, '&quot;+currentTime+&quot;', 11001, '&quot;+requestIp+&quot;' from st_lms_role_priv_mapping where role_id = &quot;
										+ roleId
										+ &quot; and service_mapping_id = &quot;
										+ mapId
										+ &quot;  and&quot;
										+ &quot;  priv_id not in (select distinct(priv_id) from st_lms_user_priv_mapping where role_id = &quot;
										+ roleId
										+ &quot; and service_mapping_id = &quot;
										+ mapId
										+ &quot; and user_id = &quot;
										+ userRs.getString(&quot;user_id&quot;) + &quot; )&quot;;
<span class="nc" id="L1438">								logger.debug(&quot;user insert -- &quot; + selUser);</span>

							}

<span class="nc" id="L1442">							userStmt.executeUpdate(selUser);</span>

						}
					
<span class="nc bnc" id="L1446" title="All 2 branches missed.">						if (isNewService.equalsIgnoreCase(&quot;Yes&quot;)){</span>
<span class="nc bnc" id="L1447" title="All 2 branches missed.">						userStmt .executeUpdate(&quot;insert into st_lms_service_role_mapping values (&quot; + mapId + &quot;,&quot; +</span>
						roleId + &quot;,&quot; + rsOrg.getInt(&quot;organization_id&quot;) + &quot;,&quot; +
						(status ? &quot;'ACTIVE'&quot; : &quot;'INACTIVE'&quot;) + &quot;)&quot;);
						}
						
<span class="nc" id="L1452">					}</span>
<span class="nc" id="L1453">					rsOrg.beforeFirst();</span>

<span class="nc" id="L1455">				}</span>
<span class="nc" id="L1456">			}</span>

<span class="nc" id="L1458">			con.commit();</span>

<span class="nc" id="L1460">		} catch (SQLException e) {</span>
<span class="nc" id="L1461">			logger.error(&quot;Exception: &quot; + e);</span>
			// TODO Auto-generated catch block
<span class="nc" id="L1463">			e.printStackTrace();</span>
<span class="nc" id="L1464">		}</span>
<span class="nc" id="L1465">	}</span>

	public void newPrivForMaster(String ownerType) throws SQLException {
		 
<span class="nc" id="L1469">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L1470">		con.setAutoCommit(false);</span>
<span class="nc" id="L1471">		Statement stmt = con.createStatement();</span>
<span class="nc" id="L1472">		Statement stmtUser = con.createStatement();</span>
<span class="nc" id="L1473">		Statement insertStmt = con.createStatement();</span>
<span class="nc" id="L1474">		ResultSet rs = null;</span>
<span class="nc" id="L1475">		ResultSet rsRole = null;</span>
<span class="nc" id="L1476">		int tierId = 0;</span>
<span class="nc" id="L1477">		int roleId = 0;</span>
<span class="nc" id="L1478">		List&lt;Integer&gt; nonRoleHeadId = new ArrayList&lt;Integer&gt;();</span>
<span class="nc" id="L1479">		StringBuilder activePrivilege = new StringBuilder(&quot;&quot;);</span>
<span class="nc" id="L1480">		StringBuilder inActivePrivilege = new StringBuilder(&quot;&quot;);</span>

		// ROLE PRIVILEGE STARTS

		// This Query will fetch role_id of (BO,Agent,Retailer)
<span class="nc" id="L1485">		String fetchOwnerRoleId = &quot;select role_id,is_master,tier_id from st_lms_role_master where tier_id = (select tier_id from&quot;</span>
				+ &quot; st_lms_tier_master where tier_code = '&quot; + ownerType + &quot;'&quot;;
<span class="nc" id="L1487">		rs = stmt.executeQuery(fetchOwnerRoleId);</span>
<span class="nc bnc" id="L1488" title="All 2 branches missed.">		while (rs.next()) {</span>
<span class="nc bnc" id="L1489" title="All 2 branches missed.">			if (rs.getString(&quot;is_master&quot;).equals(&quot;Y&quot;)) {</span>
<span class="nc" id="L1490">				roleId = rs.getInt(&quot;role_id&quot;);</span>
<span class="nc" id="L1491">				tierId = rs.getInt(&quot;tier_id&quot;);</span>
			} else {
<span class="nc" id="L1493">				nonRoleHeadId.add(rs.getInt(&quot;role_id&quot;));</span>
			}
		}
		/*----------- Assumption -------------*/
		// SERVICES ARE INSERTED IN SERVICE MASTER
		// SERVICE_DELIVERY_MAPPING HAS ENOUGH ENTRY
<span class="nc" id="L1499">		Statement insertSerRoleStmt = con.createStatement();</span>
<span class="nc" id="L1500">		ResultSet rsdelivery = null;</span>
<span class="nc" id="L1501">		Statement stmt2 = con.createStatement();</span>
<span class="nc" id="L1502">		ResultSet rs2 = null;</span>

<span class="nc" id="L1504">		String fetchDeliverdId = &quot;select dm.service_delivery_master_id,dm.priv_rep_table,dm.status as dmstatus, sm.status as smstatus &quot;</span>
				+ &quot;from st_lms_service_delivery_master dm ,st_lms_service_master sm where tier_id = '&quot;
				+ tierId + &quot;' and&quot; + &quot; dm.service_id =  sm.service_id &quot;;
<span class="nc" id="L1507">		String fetchRoleOrg = &quot;select organization_id from st_lms_organization_master om where &quot;</span>
				+ &quot;organization_type = '&quot; + ownerType + &quot;'&quot;;
<span class="nc" id="L1509">		rs2 = stmt2.executeQuery(fetchRoleOrg);</span>
<span class="nc" id="L1510">		rsdelivery = insertSerRoleStmt.executeQuery(fetchDeliverdId);</span>
<span class="nc" id="L1511">		int orgId = 0;</span>
<span class="nc bnc" id="L1512" title="All 2 branches missed.">		while (rs2.next()) {</span>
<span class="nc" id="L1513">			orgId = rs2.getInt(&quot;organization_id&quot;);</span>
<span class="nc bnc" id="L1514" title="All 2 branches missed.">			while (rsdelivery.next()) {</span>
<span class="nc" id="L1515">				String status = null;</span>
				// status =
				// ((&quot;&quot;.equalsIgnoreCase(rsdelivery.getString(&quot;smstatus&quot;))),&quot;ACTIVE&quot;,&quot;INACTIVE&quot;);

<span class="nc" id="L1519">			}</span>

		}

		// This Query will fetch all the active privileges from
		// priviledge_rep which are not present in role_mapping for
		// role_head_owner and will Insert into role mapping as Active which are
		// not matched

<span class="nc" id="L1528">		String insertActivePriv = &quot;insert into role_privl_mapping (pid,role_id,status) select distinct(pid),&quot;</span>
				+ roleId
				+ &quot;,'ACTIVE' from priviledge_rep where priv_owner='&quot;
				+ ownerType
				+ &quot;' and status='ACTIVE' and pid not in (select distinct(pid) from role_privl_mapping where role_id=&quot;
				+ roleId + &quot;)&quot;;
<span class="nc" id="L1534">		logger.debug(&quot;Active**&quot; + insertActivePriv + &quot;***\n&quot; + roleId);</span>
<span class="nc" id="L1535">		stmt.execute(insertActivePriv);</span>

		// This query will update the inactive privilege to active in
		// role_mapping for master role.
<span class="nc" id="L1539">		String updateActivePriv = &quot;update role_privl_mapping set status = 'ACTIVE' where role_id=&quot;</span>
				+ roleId
				+ &quot; and pid in (select distinct(pid) from priviledge_rep where priv_owner='&quot;
				+ ownerType + &quot;' and status='ACTIVE')&quot;;

<span class="nc" id="L1544">		stmt.execute(updateActivePriv);</span>

<span class="nc" id="L1546">		Iterator&lt;Integer&gt; nonroleHeadItr = nonRoleHeadId.iterator();</span>
<span class="nc bnc" id="L1547" title="All 2 branches missed.">		while (nonroleHeadItr.hasNext()) {</span>
			// This query will insert privileges as Inactive to the non head
			// roles.
<span class="nc" id="L1550">			int nonHeadId = nonroleHeadItr.next();</span>
<span class="nc" id="L1551">			String insertRolePriv = &quot;insert into role_privl_mapping (pid,role_id,status) select distinct(pid),&quot;</span>
					+ nonHeadId
					+ &quot;,'INACTIVE' from priviledge_rep where priv_owner='&quot;
					+ ownerType
					+ &quot;' and status='ACTIVE' and pid not in (select distinct(pid) from role_privl_mapping where role_id =&quot;
					+ nonHeadId + &quot;)&quot;;
<span class="nc" id="L1557">			logger.debug(&quot;InActive**&quot; + insertRolePriv + &quot;***\n&quot;);</span>
<span class="nc" id="L1558">			stmt.execute(insertRolePriv);</span>
<span class="nc" id="L1559">		}</span>

		// This query wil fetch inactive privileges from priviledge_rep and
		// set inactive in all the roles of the owner.
<span class="nc" id="L1563">		String updateInactivePriv = &quot;update role_privl_mapping set status='INACTIVE' where role_id in (select role_id from st_lms_role_master where role_owner='&quot;</span>
				+ ownerType
				+ &quot;') and pid in (select distinct(pid) from priviledge_rep where priv_owner='&quot;
				+ ownerType + &quot;' and status='INACTIVE')&quot;;

<span class="nc" id="L1568">		stmt.execute(updateInactivePriv);</span>
		// ROLE PRIVILEGE ENDS

		// User Privilege Starts

		// This Query will fetch role_id of (BO,Agent,Retailer)
<span class="nc" id="L1574">		String fetchRoleId = &quot;select role_id from st_lms_role_master where role_owner='&quot;</span>
				+ ownerType + &quot;'&quot;;
<span class="nc" id="L1576">		rsRole = stmt.executeQuery(fetchRoleId);</span>
<span class="nc bnc" id="L1577" title="All 2 branches missed.">		while (rsRole.next()) {</span>
<span class="nc" id="L1578">			int roleName = rsRole.getInt(&quot;role_id&quot;);</span>

<span class="nc" id="L1580">			logger.debug(roleName + &quot;*********&quot;);</span>
			// This Query updates the user's privilege id to Active those are
			// Role Head
<span class="nc" id="L1583">			String updRoleHeadPrivActive = &quot;update st_lms_user_priv_mapping set status='ACTIVE' where role_id=&quot;</span>
					+ roleName
					+ &quot; and user_id in (select user_id from st_user_master where role_id=&quot;
					+ roleName
					+ &quot; and isrolehead='Y') and pid in (select pid from role_privl_mapping where role_id=&quot;
					+ roleName + &quot; and status='ACTIVE')&quot;;

			// This query check for any new Privilege id to be added to the role
<span class="nc" id="L1591">			String fetchActivePriv = &quot;select pid from role_privl_mapping where role_id=&quot;</span>
					+ roleName
					+ &quot; and status='ACTIVE' and pid not in (select distinct(priv_id) from st_lms_user_priv_mapping where user_id in (select user_id from st_user_master where role_id=&quot;
					+ roleName + &quot; and isrolehead='Y'))&quot;;
<span class="nc" id="L1595">			ResultSet rsUser = stmtUser.executeQuery(fetchActivePriv);</span>
<span class="nc bnc" id="L1596" title="All 2 branches missed.">			while (rsUser.next()) {</span>
				// This query insert new privilege which is added to the role
				// into the st_lms_user_priv_mapping
<span class="nc" id="L1599">				insertStmt</span>
						.execute(&quot;insert into st_lms_user_priv_mapping (user_id,role_id,priv_id,status) select user_id,&quot;
								+ roleName
								+ &quot;,&quot;
								+ rsUser.getInt(&quot;pid&quot;)
								+ &quot;,'ACTIVE' from st_user_master where role_id=&quot;
								+ roleName + &quot; and isrolehead='Y'&quot;);
<span class="nc" id="L1606">				insertStmt</span>
						.execute(&quot;insert into st_lms_user_priv_mapping (user_id,role_id,priv_id,status) select user_id,&quot;
								+ roleName
								+ &quot;,&quot;
								+ rsUser.getInt(&quot;pid&quot;)
								+ &quot;,'INACTIVE' from st_user_master where role_id=&quot;
								+ roleName + &quot; and isrolehead='N'&quot;);

			}

<span class="nc" id="L1616">			String updUserPrivInActive = &quot;update st_lms_user_priv_mapping set status='INACTIVE' where role_id=&quot;</span>
					+ roleName
					+ &quot; and priv_id in (select pid from role_privl_mapping where role_id=&quot;
					+ roleName + &quot; and status='INACTIVE')&quot;;

<span class="nc" id="L1621">			stmtUser.executeUpdate(updRoleHeadPrivActive);</span>
<span class="nc" id="L1622">			stmtUser.executeUpdate(updUserPrivInActive);</span>

<span class="nc" id="L1624">		}</span>
<span class="nc" id="L1625">		con.commit();</span>

		// User Privilege Ends
<span class="nc" id="L1628">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>