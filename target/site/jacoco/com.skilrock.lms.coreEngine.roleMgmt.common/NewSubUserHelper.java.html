<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NewSubUserHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lms</a> &gt; <a href="index.source.html" class="el_package">com.skilrock.lms.coreEngine.roleMgmt.common</a> &gt; <span class="el_source">NewSubUserHelper.java</span></div><h1>NewSubUserHelper.java</h1><pre class="source lang-java linenums">package com.skilrock.lms.coreEngine.roleMgmt.common;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.TreeMap;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.apache.struts2.ServletActionContext;

import com.skilrock.lms.admin.SetResetUserPasswordAction;
import com.skilrock.lms.beans.ServicesBean;
import com.skilrock.lms.beans.UserDetailsBean;
import com.skilrock.lms.common.db.DBConnect;
import com.skilrock.lms.common.exception.LMSException;
import com.skilrock.lms.common.filter.LMSFilterDispatcher;
import com.skilrock.lms.common.utility.MD5Encoder;
import com.skilrock.lms.common.utility.MailSend;
import com.skilrock.lms.coreEngine.userMgmt.common.LoginTimeIPValidationHelper;
import com.skilrock.lms.coreEngine.userMgmt.daoImpl.MessageInboxDaoImpl;
import com.skilrock.lms.rolemgmt.beans.userListBean;
import com.skilrock.lms.rolemgmt.beans.userPrivBean;
import com.skilrock.lms.sportsLottery.common.NotifySLE;
import com.skilrock.lms.sportsLottery.common.SLE;
import com.skilrock.lms.sportsLottery.common.SLEUtils;
import com.skilrock.lms.sportsLottery.userMgmt.javaBeans.MenuDataBean;
import com.skilrock.lms.sportsLottery.userMgmt.javaBeans.MenuItemDataBean;
import com.skilrock.lms.sportsLottery.userMgmt.javaBeans.PrivilegeDataBean;
import com.skilrock.lms.sportsLottery.userMgmt.javaBeans.RolePrivilegeBean;
import com.skilrock.lms.sportsLottery.userMgmt.javaBeans.SubUserDataBean;
import com.skilrock.lms.web.drawGames.common.Util;

<span class="nc" id="L42">public class NewSubUserHelper {</span>
<span class="nc" id="L43">	static Log logger = LogFactory.getLog(NewSubUserHelper.class);</span>

	public static void main(String[] args) throws Exception {
<span class="nc" id="L46">		NewSubUserHelper x = new NewSubUserHelper();</span>
<span class="nc" id="L47">		x.test();</span>
<span class="nc" id="L48">	}</span>

	public String assignGroups(int userOrgId, String[] groupNames,
			int parentUserId, int roleId, UserDetailsBean usrdetBean,
			int[] mappingId, int[] privCount) throws LMSException {
<span class="nc" id="L53">		return assignGroups(userOrgId, groupNames, parentUserId, roleId, usrdetBean, mappingId, privCount, null, &quot;&quot;);</span>
	}
	public String assignGroups(int userOrgId, String[] groupNames,
			int parentUserId, int roleId, UserDetailsBean usrdetBean,
			int[] mappingId, int[] privCount, List&lt;PrivilegeDataBean&gt; privilegeListSLE, String requestIp) throws LMSException {

		
<span class="nc" id="L60">		Connection con = DBConnect.getConnection();</span>

		// int userId=getUserIdByuserName(userName);
<span class="nc" id="L63">		int userId = 0;</span>
<span class="nc" id="L64">		String password = null;</span>
<span class="nc" id="L65">		String orgType = usrdetBean.getOrgType();</span>
<span class="nc" id="L66">		password = com.skilrock.lms.web.loginMgmt.AutoGenerate.autoPassword();</span>

<span class="nc" id="L68">		String status = null;</span>
		try {
<span class="nc" id="L70">			Statement stmt = con.createStatement();</span>
<span class="nc" id="L71">			Statement stmt1 = con.createStatement();</span>
<span class="nc" id="L72">			con.setAutoCommit(false);</span>

			// insert data into st user master

<span class="nc" id="L76">			stmt1</span>
					.executeUpdate(&quot;insert into st_lms_user_master(organization_id,role_id,parent_user_id,organization_type,registration_date,auto_password,user_name,password,status,secret_ques,secret_ans,isrolehead, register_by_id) values(&quot;
							+ usrdetBean.getOrgId()
							+ &quot;,&quot;
							+ usrdetBean.getRoleId()
							+ &quot;,&quot;
							+ parentUserId
							+ &quot;,'&quot;
							+ usrdetBean.getOrgType()
							+ &quot;','&quot;
							+ new java.sql.Timestamp(new Date().getTime())
							+ &quot;',1,'&quot;
							+ usrdetBean.getUserName().trim().toLowerCase()
							+ &quot;','&quot;
							+ MD5Encoder.encode(password)
							+ &quot;','&quot;
							+ usrdetBean.getStatus()
							+ &quot;','&quot;
							+ usrdetBean.getSecQues()
							+ &quot;','&quot;
							+ usrdetBean.getSecAns() + &quot;','N', &quot;+usrdetBean.getRegisterByUserId()+&quot;)&quot;);
<span class="nc" id="L97">			ResultSet rs = stmt1.getGeneratedKeys();</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L99">				userId = rs.getInt(1);</span>

			}
<span class="nc" id="L102">			stmt1</span>
					.executeUpdate(&quot;INSERT into st_lms_user_contact_details(user_id,first_name,last_name,email_id,phone_nbr) VALUES('&quot;
							+ userId
							+ &quot;','&quot;
							+ usrdetBean.getFirstName()
							+ &quot;','&quot;
							+ usrdetBean.getLastName()
							+ &quot;','&quot;
							+ usrdetBean.getEmailId()
							+ &quot;','&quot;
							+ usrdetBean.getPhoneNbr() + &quot;')&quot;);
<span class="nc" id="L113">			stmt1</span>
					.executeUpdate(&quot;INSERT into st_lms_password_history (user_id,password,date_changed,type)VALUES('&quot;
							+ userId
							+ &quot;','&quot;
							+ MD5Encoder.encode(password)
							+ &quot;','&quot;
							+ new java.sql.Timestamp(new Date().getTime())
							+ &quot;','1')&quot;);

			//	Insert Data In st_lms_user_ip_time_mapping Table.
<span class="nc" id="L123">			LoginTimeIPValidationHelper helper = new LoginTimeIPValidationHelper();</span>
<span class="nc" id="L124">			helper.insertUserTimeLimitData(userId, con);</span>

			// insert data into user priviledges master

<span class="nc" id="L128">			System.out</span>
					.println(&quot;***Start Insertion into st_lms_user_priv_mapping***&quot;);

<span class="nc" id="L131">			Statement serviceStmt = con.createStatement();</span>

<span class="nc" id="L133">			String fetchService = &quot;select srm.id,role_id,interface,service_display_name,priv_rep_table from st_lms_service_role_mapping srm,st_lms_service_master sm,st_lms_service_delivery_master sdm where srm.role_id=&quot;</span>
					+ roleId
					+ &quot; and organization_id=&quot;
					+ userOrgId
					+ &quot; and sm.status='ACTIVE' and srm.id=sdm.service_delivery_master_id and sdm.service_id=sm.service_id&quot;;
<span class="nc" id="L138">			logger.debug(&quot;fetchService====&quot; + fetchService);</span>
<span class="nc" id="L139">			ResultSet serviceRS = serviceStmt.executeQuery(fetchService);</span>

<span class="nc" id="L141">			String currentTime = Util.getCurrentTimeString();</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">			while (serviceRS.next()) {</span>
<span class="nc" id="L143">				String insertintoUserPrivMapQuery = &quot;insert into st_lms_user_priv_mapping (user_id, role_id, priv_id, service_mapping_id, status, change_date, change_by, request_ip) &quot;</span>
						+ &quot;select &quot;
						+ userId
						+ &quot;,&quot;
						+ roleId
						+ &quot;,pr.priv_id,&quot;
						+ serviceRS.getInt(&quot;id&quot;)
						+ &quot;,'NA', '&quot;+currentTime+&quot;', &quot;+parentUserId+&quot;, '&quot;+requestIp+&quot;' from st_lms_user_priv_mapping upm,&quot;
						+ serviceRS.getString(&quot;priv_rep_table&quot;)
						+ &quot; as pr,st_lms_role_priv_mapping rpm where upm.user_id=&quot;
						+ parentUserId
						+ &quot; and upm.role_id=&quot;
						+ roleId
						+ &quot;  and upm.service_mapping_id=&quot;
						+ serviceRS.getInt(&quot;id&quot;)
						+ &quot; and upm.role_id=rpm.role_id and upm.priv_id = rpm.priv_id  and upm.service_mapping_id = rpm.service_mapping_id and upm.priv_id=pr.priv_id group by pr.priv_id&quot;;
<span class="nc" id="L159">				logger.debug(insertintoUserPrivMapQuery);</span>
<span class="nc" id="L160">				stmt.executeUpdate(insertintoUserPrivMapQuery);</span>
<span class="nc" id="L161">			}</span>
<span class="nc" id="L162">			System.out</span>
					.println(&quot;***End Insertion into st_lms_user_priv_mapping***&quot;);
<span class="nc" id="L164">			logger.debug(&quot;MAPPING ID********************&quot; + mappingId);</span>
<span class="nc" id="L165">			HashMap&lt;Integer, String&gt; headUserPrivMap = new HashMap&lt;Integer, String&gt;();</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">			for (int element : mappingId) {</span>
<span class="nc" id="L167">				String selectQuery = &quot;select distinct(priv_id) from st_lms_user_priv_mapping where user_id=&quot;</span>
						+ parentUserId
						+ &quot; and role_id=&quot;
						+ roleId
						+ &quot; and status='ACTIVE' and service_mapping_id=&quot;
						+ element;
<span class="nc" id="L173">				logger.debug(&quot;*****&quot; + selectQuery);</span>
<span class="nc" id="L174">				PreparedStatement pstmt = con.prepareStatement(selectQuery);</span>
<span class="nc" id="L175">				ResultSet selectQueryRS = pstmt.executeQuery();</span>
<span class="nc" id="L176">				StringBuilder str = new StringBuilder(&quot;&quot;);</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">				while (selectQueryRS.next()) {</span>
<span class="nc" id="L178">					str.append(selectQueryRS.getString(&quot;priv_id&quot;));</span>
<span class="nc" id="L179">					str.append(&quot;,&quot;);</span>
				}
<span class="nc bnc" id="L181" title="All 2 branches missed.">				if(str.length() &gt; 0){</span>
<span class="nc" id="L182">					str.deleteCharAt(str.length() - 1);</span>
<span class="nc" id="L183">					headUserPrivMap.put(element, str.toString());</span>
				}
			}

<span class="nc bnc" id="L187" title="All 2 branches missed.">			for (int element : mappingId) {</span>
<span class="nc" id="L188">				String updateUserPriv = &quot;update st_lms_user_priv_mapping set status='INACTIVE' where user_id=&quot;</span>
						+ userId
						+ &quot; and role_id=&quot;
						+ roleId
						+ &quot; and service_mapping_id=&quot;
						+ element
						+ &quot; and priv_id in (&quot;
						+ headUserPrivMap.get(element)
						+ &quot;)&quot;;
<span class="nc" id="L197">				logger.debug(&quot;INACTIVE UPDATE::&quot; + updateUserPriv);</span>
<span class="nc" id="L198">				int rowsEffected = stmt.executeUpdate(updateUserPriv);</span>
<span class="nc" id="L199">				System.out.println(&quot;**rowsEffected*****&quot;+rowsEffected+&quot;*****&quot;);</span>
			}

<span class="nc" id="L202">			StringBuilder grpName = null;</span>
<span class="nc" id="L203">			StringBuilder strMappingId = new StringBuilder(&quot;&quot;);</span>
<span class="nc" id="L204">			String grpNameStr = null;</span>
<span class="nc" id="L205">			int privIdFrm = 0;</span>
<span class="nc" id="L206">			int privIdTo = 0;</span>
<span class="nc" id="L207">			String activeMapIds = &quot;&quot;;</span>
<span class="nc" id="L208">			HashMap&lt;Integer, String&gt; privMap = new HashMap&lt;Integer, String&gt;();</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">			for (int i = 0; i &lt; mappingId.length; i++) {</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">				if (privCount[i] != 0) {</span>
<span class="nc" id="L211">					grpName = new StringBuilder(&quot;'Miscellaneous',&quot;);</span>
<span class="nc" id="L212">					privIdTo = privIdTo + privCount[i];</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">					for (int j = privIdFrm; j &lt; privIdTo; j++) {</span>
						
<span class="nc bnc" id="L215" title="All 2 branches missed.">						grpName.append(groupNames[j].contains(&quot;|&quot;) ? &quot;'&quot; + groupNames[j].substring(0, groupNames[j].lastIndexOf(&quot;|&quot;)) + &quot;',&quot; : &quot;'&quot; + groupNames[j] + &quot;',&quot; ); </span>
						
<span class="nc" id="L217">						privIdFrm++;</span>
					}
<span class="nc" id="L219">					grpNameStr = grpName.substring(0, grpName.length() - 1);</span>
<span class="nc" id="L220">					activeMapIds = activeMapIds + mappingId[i] + &quot;,&quot;;</span>
<span class="nc" id="L221">					privMap.put(mappingId[i], grpNameStr);</span>
				}
<span class="nc" id="L223">				logger.debug(&quot;**&quot; + privCount[i]);</span>
<span class="nc" id="L224">				strMappingId.append(mappingId[i] + &quot;,&quot;);</span>

			}
<span class="nc" id="L227">			strMappingId.deleteCharAt(strMappingId.length() - 1);</span>

<span class="nc" id="L229">			logger.debug(&quot;privMap*****&quot; + privMap);</span>

<span class="nc" id="L231">			String fetchPrivTable = null;</span>
<span class="nc" id="L232">			ResultSet fetchPrivTabRS = null;</span>
<span class="nc" id="L233">			String updateRolePriv = null;</span>
<span class="nc" id="L234">			Statement stmtMappingId = con.createStatement();</span>

<span class="nc" id="L236">			fetchPrivTable = &quot;select service_delivery_master_id,priv_rep_table from st_lms_service_delivery_master where service_delivery_master_id in(&quot;</span>
					+ strMappingId.toString() + &quot;)&quot;;
<span class="nc" id="L238">			logger.debug(&quot;*****&quot; + fetchPrivTable);</span>
<span class="nc" id="L239">			fetchPrivTabRS = stmtMappingId.executeQuery(fetchPrivTable);</span>

<span class="nc bnc" id="L241" title="All 2 branches missed.">			while (fetchPrivTabRS.next()) {</span>
<span class="nc" id="L242">				updateRolePriv = &quot;update st_lms_user_priv_mapping set status='ACTIVE' where user_id=&quot;</span>
						+ userId
						+ &quot; and role_id=&quot;
						+ roleId
						+ &quot; and service_mapping_id=&quot;
						+ fetchPrivTabRS.getInt(&quot;service_delivery_master_id&quot;)
						+ &quot; and priv_id in (select distinct(priv_id) from &quot;
						+ fetchPrivTabRS.getString(&quot;priv_rep_table&quot;)
						+ &quot; pr where group_name in (&quot;
						+ privMap.get(fetchPrivTabRS
								.getInt(&quot;service_delivery_master_id&quot;))
						+ &quot;) and pr.status='ACTIVE') &quot;;
<span class="nc" id="L254">				logger.debug(&quot;ACTIVE UPDATE::&quot; + updateRolePriv);</span>
<span class="nc" id="L255">				stmt.executeUpdate(updateRolePriv);</span>
			}

			//	Insert Registration Messages
<span class="nc" id="L259">			MessageInboxDaoImpl.getSingleInstance().addRegistrationMessage(userId, usrdetBean.getOrgType(), &quot;WEB&quot;, con);</span>

<span class="nc" id="L261">			boolean flag = true;</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">			if(ServicesBean.isSLE()) {</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">				if(privilegeListSLE != null) {</span>
<span class="nc" id="L264">					flag = false;</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">					for(PrivilegeDataBean privilegeBean : privilegeListSLE) {</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">						for(MenuDataBean menuBean : privilegeBean.getMenuList()) {</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">							for(MenuItemDataBean menuItemBean : menuBean.getMenuItems()) {</span>
<span class="nc" id="L268">								menuItemBean.setIsAssign(false);</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">								for(String privilege : groupNames) {</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">									if(privilege.contains(&quot;Sports Lottery&quot;))</span>
									{
<span class="nc bnc" id="L272" title="All 2 branches missed.">									if(privilege.substring(0, privilege.lastIndexOf(&quot;|&quot;)).equals(menuItemBean.getMenuItemName())) {</span>
<span class="nc" id="L273">										menuItemBean.setIsAssign(true);</span>
									}
									}
								}
<span class="nc" id="L277">							}</span>
<span class="nc" id="L278">						}</span>
<span class="nc" id="L279">					}</span>

					try {
<span class="nc" id="L282">						SubUserDataBean userDataBean = new SubUserDataBean();</span>
<span class="nc" id="L283">						userDataBean.setCreatorUserId(parentUserId);</span>
<span class="nc" id="L284">						userDataBean.setRoleId(roleId);</span>
<span class="nc" id="L285">						userDataBean.setUserId(userId);</span>
<span class="nc" id="L286">						userDataBean.setUserName(usrdetBean.getUserName().trim().toLowerCase());</span>
<span class="nc" id="L287">						userDataBean.setUserType(usrdetBean.getOrgType());</span>
<span class="nc" id="L288">						userDataBean.setFirstName(usrdetBean.getFirstName());</span>
<span class="nc" id="L289">						userDataBean.setLastName(usrdetBean.getLastName());</span>
<span class="nc" id="L290">						userDataBean.setMobileNbr(String.valueOf(usrdetBean.getPhoneNbr()));</span>
<span class="nc" id="L291">						userDataBean.setEmailId(usrdetBean.getEmailId());</span>
<span class="nc" id="L292">						userDataBean.setSecretQues(usrdetBean.getSecQues());</span>
<span class="nc" id="L293">						userDataBean.setSecretAns(usrdetBean.getSecAns());</span>
<span class="nc" id="L294">						userDataBean.setRequestIp(requestIp);</span>
<span class="nc" id="L295">						userDataBean.setPrivilegeList(privilegeListSLE);</span>
	
<span class="nc" id="L297">						NotifySLE notifySLE = new NotifySLE(SLE.Activity.SUB_USER_REGISTRATION, userDataBean);</span>
<span class="nc" id="L298">						notifySLE.asyncCall(notifySLE);</span>
<span class="nc" id="L299">						flag = true;</span>
<span class="nc" id="L300">					} catch (Exception ex) {</span>
<span class="nc" id="L301">						ex.printStackTrace();</span>
<span class="nc" id="L302">						flag = false;</span>
<span class="nc" id="L303">					}</span>
				}
			}

<span class="nc bnc" id="L307" title="All 2 branches missed.">			if(flag) {</span>
<span class="nc" id="L308">			con.commit();</span>
<span class="nc bnc" id="L309" title="All 2 branches missed.">			if (usrdetBean.isMailSend()) {</span>
<span class="nc" id="L310">				String msgFor = &quot;Thanks for registration to our gaming system  Your Login details are&quot;;</span>
<span class="nc" id="L311">				String emailMsgTxt = &quot;&lt;html&gt;&lt;table&gt;&lt;tr&gt;&lt;td&gt;Hi &quot;</span>
						+ usrdetBean.getFirstName() + &quot; &quot;
						+ usrdetBean.getLastName() + &quot;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&quot; + msgFor
						+ &quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;table&gt;&lt;tr&gt;&lt;td&gt;User Name :: &lt;/td&gt;&lt;td&gt;&quot;
						+ usrdetBean.getUserName()
						+ &quot;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;password :: &lt;/td&gt;&lt;td&gt;&quot;
						+ password.toString()
						+ &quot;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;log on &lt;/td&gt;&lt;td&gt;&quot;
						+ LMSFilterDispatcher.webLink + &quot;/&quot;
						+ LMSFilterDispatcher.mailProjName
						+ &quot;/&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/html&gt;&quot;;
<span class="nc" id="L322">				MailSend mailSend = new MailSend(usrdetBean.getEmailId(),</span>
						emailMsgTxt);
<span class="nc" id="L324">				mailSend.setDaemon(true);</span>
<span class="nc" id="L325">				mailSend.start();</span>
<span class="nc" id="L326">				}</span>
			} else {
<span class="nc" id="L328">				con.rollback();</span>
<span class="nc" id="L329">				throw new LMSException(&quot;exception occured&quot;);</span>
			}
<span class="nc" id="L331">		} catch (SQLException e) {</span>
<span class="nc" id="L332">			logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L333">			e.printStackTrace();</span>
<span class="nc" id="L334">			throw new LMSException(&quot;sql exception &quot;, e);</span>
		} finally {
<span class="nc" id="L336">			DBConnect.closeCon(con);</span>
<span class="nc" id="L337">		}</span>
<span class="nc" id="L338">		return password;</span>
	}

	public String assignPriviledges(String userName, int[] rolePid,
			ArrayList&lt;userPrivBean&gt; headPrivList, int roleId,
			UserDetailsBean usrdetBean) throws LMSException {
<span class="nc" id="L344">		String projectName = ServletActionContext.getServletContext()</span>
				.getContextPath();
<span class="nc" id="L346">		logger.debug(&quot;user name and pids are &quot; + userName + rolePid);</span>
		 
<span class="nc" id="L348">		Connection con = DBConnect.getConnection();</span>

		// int userId=getUserIdByuserName(userName);
<span class="nc" id="L351">		int userId = 0;</span>
<span class="nc" id="L352">		String password = password = com.skilrock.lms.web.loginMgmt.AutoGenerate</span>
				.autoPassword();
		;
<span class="nc" id="L355">		String orgType = usrdetBean.getOrgType();</span>
<span class="nc" id="L356">		logger.debug(&quot;Org Type : &quot; + orgType);</span>

<span class="nc" id="L358">		logger.debug(&quot;Generated Password is :*************************&quot;</span>
				+ password);
<span class="nc" id="L360">		String status = null;</span>
		try {
<span class="nc" id="L362">			Statement stmt = con.createStatement();</span>
<span class="nc" id="L363">			Statement stmt1 = con.createStatement();</span>
<span class="nc" id="L364">			con.setAutoCommit(false);</span>

			// insert data into st user master

<span class="nc" id="L368">			stmt1</span>
					.executeUpdate(&quot;insert into st_lms_user_master(organization_id,role_id,organization_type,registration_date,auto_password,user_name,password,status,secret_ques,secret_ans,isrolehead) values(&quot;
							+ usrdetBean.getOrgId()
							+ &quot;,&quot;
							+ usrdetBean.getRoleId()
							+ &quot;,'&quot;
							+ usrdetBean.getOrgType()
							+ &quot;','&quot;
							+ new java.sql.Timestamp(new Date().getTime())
							+ &quot;',1,'&quot;
							+ usrdetBean.getUserName().trim().toLowerCase()
							+ &quot;','&quot;
							+ MD5Encoder.encode(password)
							+ &quot;','&quot;
							+ usrdetBean.getStatus()
							+ &quot;','&quot;
							+ usrdetBean.getSecQues()
							+ &quot;','&quot;
							+ usrdetBean.getSecAns() + &quot;','N')&quot;);
<span class="nc" id="L387">			ResultSet rs = stmt1.getGeneratedKeys();</span>
<span class="nc bnc" id="L388" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L389">				userId = rs.getInt(1);</span>

			}
<span class="nc" id="L392">			logger.info(&quot;************insert 1*************&quot;);</span>
<span class="nc" id="L393">			stmt1</span>
					.executeUpdate(&quot;INSERT into st_lms_user_contact_details(user_id,first_name,last_name,email_id,phone_nbr) VALUES('&quot;
							+ userId
							+ &quot;','&quot;
							+ usrdetBean.getFirstName()
							+ &quot;','&quot;
							+ usrdetBean.getLastName()
							+ &quot;','&quot;
							+ usrdetBean.getEmailId()
							+ &quot;','&quot;
							+ usrdetBean.getPhoneNbr() + &quot;')&quot;);
<span class="nc" id="L404">			logger.info(&quot;************insert 2*************&quot;);</span>
<span class="nc" id="L405">			stmt1</span>
					.executeUpdate(&quot;INSERT into st_lms_password_history (user_id,password,date_changed,type)VALUES('&quot;
							+ userId
							+ &quot;','&quot;
							+ MD5Encoder.encode(password)
							+ &quot;','&quot;
							+ new java.sql.Timestamp(new Date().getTime())
							+ &quot;','1')&quot;);
<span class="nc" id="L413">			logger.info(&quot;************insert 3*************&quot;);</span>
<span class="nc" id="L414">			logger.debug(&quot;array length is &quot; + rolePid.length + &quot;value is  &quot;</span>
					+ rolePid[0]);

			// insert data into user priviledges master
<span class="nc" id="L418">			String insertintoUserPrivMapQuery = null;</span>
<span class="nc bnc" id="L419" title="All 2 branches missed.">			for (int i = 0; i &lt; headPrivList.size(); i++) {</span>
<span class="nc" id="L420">				int headPid = headPrivList.get(i).getPid();</span>
<span class="nc" id="L421">				status = &quot;INACTIVE&quot;;</span>
<span class="nc bnc" id="L422" title="All 2 branches missed.">				for (int element : rolePid) {</span>
					// logger.debug(rolePid[j] + &quot;gggggg&quot;+
					// headPrivList.get(i).getPid());
<span class="nc bnc" id="L425" title="All 2 branches missed.">					if (element == headPid) {</span>
<span class="nc" id="L426">						status = &quot;ACTIVE&quot;;</span>
<span class="nc" id="L427">						break;</span>
					}

				}

<span class="nc" id="L432">				insertintoUserPrivMapQuery = &quot;insert into user_priv_master values(&quot;</span>
						+ userId
						+ &quot;,&quot;
						+ roleId
						+ &quot;,&quot;
						+ headPrivList.get(i).getPid() + &quot;,'&quot; + status + &quot;')&quot;;
				// logger.debug(&quot;query to insert is : &quot; + &quot;insert into
				// user_priv_master
				// values(&quot;+userId+&quot;,&quot;+roleId+&quot;,&quot;+headPrivList.get(i).getPid()+&quot;,'&quot;+status+&quot;')&quot;);
<span class="nc" id="L441">				stmt.executeUpdate(insertintoUserPrivMapQuery);</span>

				// con.commit();
			}
<span class="nc" id="L445">			con.commit();</span>
<span class="nc" id="L446">			String msgFor = &quot;Thanks for registration to our gaming system  Your Login details are *********************neeraj Wadhwa..............&quot;;</span>
			// MailSend.sendMailToUser(usrdetBean.getEmailId(),
			// password,usrdetBean.getUserName());
<span class="nc" id="L449">			String emailMsgTxt = &quot;&lt;html&gt;&lt;table&gt;&lt;tr&gt;&lt;td&gt;Hi &quot;</span>
					+ usrdetBean.getFirstName() + &quot; &quot;
					+ usrdetBean.getLastName() + &quot;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&quot; + msgFor
					+ &quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;table&gt;&lt;tr&gt;&lt;td&gt;User Name :: &lt;/td&gt;&lt;td&gt;&quot;
					+ usrdetBean.getUserName()
					+ &quot;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;password :: &lt;/td&gt;&lt;td&gt;&quot;
					+ password.toString()
					+ &quot;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;log on &lt;/td&gt;&lt;td&gt;&quot;
					+ LMSFilterDispatcher.webLink + &quot;/&quot;
					+ LMSFilterDispatcher.mailProjName
					+ &quot;/&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/html&gt;&quot;;
<span class="nc" id="L460">			MailSend mailSend = new MailSend(usrdetBean.getEmailId(),</span>
					emailMsgTxt);
<span class="nc" id="L462">			mailSend.setDaemon(true);</span>
<span class="nc" id="L463">			mailSend.start();</span>
			// MailSend.sendMailToUser(usrdetBean.getEmailId(),
			// password,usrdetBean.getUserName(),usrdetBean.getFirstName(),usrdetBean.getLastName(),msgFor);

<span class="nc" id="L467">		} catch (SQLException e) {</span>
<span class="nc" id="L468">			logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L469">			e.printStackTrace();</span>
<span class="nc" id="L470">			throw new LMSException(&quot;sql exception &quot;, e);</span>
		} finally {
<span class="nc bnc" id="L472" title="All 4 branches missed.">			if (con != null) {</span>
				try {
<span class="nc" id="L474">					con.close();</span>
<span class="nc" id="L475">				} catch (SQLException e) {</span>
<span class="nc" id="L476">					logger.error(&quot;Exception: &quot; + e);</span>
					// TODO Auto-generated catch block
<span class="nc" id="L478">					e.printStackTrace();</span>
<span class="nc" id="L479">				}</span>
			}
		}
<span class="nc" id="L482">		return password;</span>
	}

	public Map createPrivMap() throws LMSException {
<span class="nc" id="L486">		Map relate_to_Map = new HashMap();</span>
<span class="nc" id="L487">		Map parentPrivMap = null;</span>

<span class="nc" id="L489">		Iterator relMapItr = relate_to_Map.entrySet().iterator();</span>

		 
<span class="nc" id="L492">		Connection con = DBConnect.getConnection();</span>
		try {
<span class="nc" id="L494">			con.setAutoCommit(false);</span>

<span class="nc" id="L496">			Statement stmt = con.createStatement();</span>
<span class="nc" id="L497">			String relatedTo = &quot;&quot;;</span>
<span class="nc" id="L498">			String getParentPriv = &quot;select distinct(group_name),related_to from priviledge_rep where priv_owner='BO' order by related_to,group_name&quot;;</span>
<span class="nc" id="L499">			ResultSet rs = stmt.executeQuery(getParentPriv);</span>

<span class="nc bnc" id="L501" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc bnc" id="L502" title="All 2 branches missed.">				if (!relatedTo.equals(rs.getString(&quot;related_to&quot;))) {</span>
<span class="nc" id="L503">					parentPrivMap = new HashMap();</span>
<span class="nc" id="L504">					relatedTo = rs.getString(&quot;related_to&quot;);</span>
<span class="nc" id="L505">					relate_to_Map.put(relatedTo, parentPrivMap);</span>

				}
<span class="nc" id="L508">				String groupName = rs.getString(&quot;group_name&quot;);</span>
<span class="nc" id="L509">				parentPrivMap.put(groupName, fetchGroupPriv(groupName, con));</span>

<span class="nc" id="L511">			}</span>

<span class="nc" id="L513">		} catch (SQLException e) {</span>
<span class="nc" id="L514">			logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L515">			e.printStackTrace();</span>
<span class="nc" id="L516">			throw new LMSException(&quot;Error During Privilege Fetching&quot;, e);</span>
		} finally {
<span class="nc" id="L518">			try {</span>
<span class="nc bnc" id="L519" title="All 4 branches missed.">				if (con != null) {</span>
<span class="nc" id="L520">					con.close();</span>
				}
<span class="nc" id="L522">			} catch (SQLException se) {</span>
<span class="nc" id="L523">				logger.error(&quot;Exception: &quot; + se);</span>
<span class="nc" id="L524">				se.printStackTrace();</span>
<span class="nc" id="L525">			}</span>
<span class="nc" id="L526">		}</span>

<span class="nc" id="L528">		return relate_to_Map;</span>
	}

	public void editBOPriv(String userName, String[] groupNames,
			int[] mappingId, int[] privCount, List&lt;PrivilegeDataBean&gt; privilegeListSLE) throws LMSException {

		 
<span class="nc" id="L535">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L536">		int userId = 0, roleId = 0, userOrgId = 0;</span>
		try {
<span class="nc" id="L538">			con.setAutoCommit(false);</span>

<span class="nc" id="L540">			Statement stmt = con.createStatement();</span>
<span class="nc" id="L541">			ResultSet userRs = stmt</span>
					.executeQuery(&quot;select user_id,role_id,organization_id,organization_type from st_lms_user_master where user_name='&quot;
							+ userName + &quot;'&quot;);
<span class="nc bnc" id="L544" title="All 2 branches missed.">			while (userRs.next()) {</span>
<span class="nc" id="L545">				userId = userRs.getInt(&quot;user_id&quot;);</span>
<span class="nc" id="L546">				roleId = userRs.getInt(&quot;role_id&quot;);</span>
<span class="nc" id="L547">				userOrgId = userRs.getInt(&quot;organization_id&quot;);</span>
			}

<span class="nc bnc" id="L550" title="All 2 branches missed.">			for (int element : mappingId) {</span>
<span class="nc" id="L551">				String updateUserPriv = &quot;update st_lms_user_priv_mapping set status='INACTIVE' where user_id=&quot;</span>
						+ userId
						+ &quot; and role_id=&quot;
						+ roleId
						+ &quot; and status!='NA' and service_mapping_id=&quot; + element;
<span class="nc" id="L556">				stmt.executeUpdate(updateUserPriv);</span>
			}

<span class="nc" id="L559">			StringBuilder grpName = null;</span>
<span class="nc" id="L560">			StringBuilder strMappingId = new StringBuilder(&quot;&quot;);</span>
<span class="nc" id="L561">			String grpNameStr = null;</span>
<span class="nc" id="L562">			int privIdFrm = 0;</span>
<span class="nc" id="L563">			int privIdTo = 0;</span>
<span class="nc" id="L564">			String activeMapIds = &quot;&quot;;</span>
<span class="nc" id="L565">			HashMap&lt;Integer, String&gt; privMap = new HashMap&lt;Integer, String&gt;();</span>
<span class="nc bnc" id="L566" title="All 2 branches missed.">			for (int i = 0; i &lt; mappingId.length; i++) {</span>
<span class="nc bnc" id="L567" title="All 2 branches missed.">				if (privCount[i] != 0) {</span>
<span class="nc" id="L568">					grpName = new StringBuilder(&quot;'Miscellaneous',&quot;);</span>
<span class="nc" id="L569">					privIdTo = privIdTo + privCount[i];</span>
<span class="nc bnc" id="L570" title="All 2 branches missed.">					for (int j = privIdFrm; j &lt; privIdTo; j++) {</span>
<span class="nc bnc" id="L571" title="All 2 branches missed.">						grpName.append(groupNames[j].contains(&quot;|&quot;) ? &quot;'&quot; + groupNames[j].substring(0, groupNames[j].lastIndexOf(&quot;|&quot;)) + &quot;',&quot; : &quot;'&quot; + groupNames[j] + &quot;',&quot; );</span>
						//grpName.append(&quot;'&quot; + groupNames[j].substring(0, groupNames[j].lastIndexOf(&quot;|&quot;)) + &quot;',&quot;);
<span class="nc" id="L573">						privIdFrm++;</span>
					}
<span class="nc" id="L575">					grpNameStr = grpName.substring(0, grpName.length() - 1);</span>
<span class="nc" id="L576">					activeMapIds = activeMapIds + mappingId[i] + &quot;,&quot;;</span>
<span class="nc" id="L577">					privMap.put(mappingId[i], grpNameStr);</span>
				}
<span class="nc" id="L579">				logger.debug(&quot;**&quot; + privCount[i]);</span>
<span class="nc" id="L580">				strMappingId.append(mappingId[i] + &quot;,&quot;);</span>

			}
<span class="nc" id="L583">			strMappingId.deleteCharAt(strMappingId.length() - 1);</span>

<span class="nc" id="L585">			logger.debug(&quot;privMap*****&quot; + privMap);</span>

<span class="nc" id="L587">			String fetchPrivTable = null;</span>
<span class="nc" id="L588">			ResultSet fetchPrivTabRS = null;</span>
<span class="nc" id="L589">			String updateRolePriv = null;</span>
<span class="nc" id="L590">			Statement stmtMappingId = con.createStatement();</span>

<span class="nc" id="L592">			fetchPrivTable = &quot;select service_delivery_master_id,priv_rep_table from st_lms_service_delivery_master where service_delivery_master_id in(&quot;</span>
					+ strMappingId.toString() + &quot;)&quot;;
<span class="nc" id="L594">			logger.debug(&quot;*****&quot; + fetchPrivTable);</span>
<span class="nc" id="L595">			fetchPrivTabRS = stmtMappingId.executeQuery(fetchPrivTable);</span>

<span class="nc bnc" id="L597" title="All 2 branches missed.">			while (fetchPrivTabRS.next()) {</span>
<span class="nc" id="L598">				updateRolePriv = &quot;update st_lms_user_priv_mapping set status='ACTIVE' where user_id=&quot;</span>
						+ userId
						+ &quot; and role_id=&quot;
						+ roleId
						+ &quot; and service_mapping_id=&quot;
						+ fetchPrivTabRS.getInt(&quot;service_delivery_master_id&quot;)
						+ &quot; and priv_id in (select distinct(priv_id) from &quot;
						+ fetchPrivTabRS.getString(&quot;priv_rep_table&quot;)
						+ &quot; pr where group_name in (&quot;
						+ privMap.get(fetchPrivTabRS
								.getInt(&quot;service_delivery_master_id&quot;))
						+ &quot;) and pr.status='ACTIVE') &quot;;
<span class="nc" id="L610">				logger.debug(updateRolePriv);</span>
<span class="nc" id="L611">				stmt.executeUpdate(updateRolePriv);</span>
<span class="nc" id="L612">				stmt</span>
						.executeUpdate(&quot;update st_lms_user_priv_mapping set status='NA' where user_id!=&quot;
								+ userId
								+ &quot; and role_id=&quot;
								+ roleId
								+ &quot; and service_mapping_id=&quot;
								+ fetchPrivTabRS
										.getInt(&quot;service_delivery_master_id&quot;)
								+ &quot; and priv_id in (select a.priv_id from (select inTab.priv_id from st_lms_user_priv_mapping as inTab where inTab.user_id=&quot;
								+ userId
								+ &quot; and inTab.status='INACTIVE' and service_mapping_id=&quot;
								+ fetchPrivTabRS
										.getInt(&quot;service_delivery_master_id&quot;)
								+ &quot; ) a )&quot;);
<span class="nc" id="L626">				stmt</span>
						.executeUpdate(&quot;update st_lms_user_priv_mapping set status='INACTIVE' where user_id!=&quot;
								+ userId
								+ &quot; and role_id=&quot;
								+ roleId
								+ &quot; and service_mapping_id=&quot;
								+ fetchPrivTabRS
										.getInt(&quot;service_delivery_master_id&quot;)
								+ &quot; and status='NA' and priv_id in (select a.priv_id from (select inTab.priv_id from st_lms_user_priv_mapping as inTab where inTab.user_id=&quot;
								+ userId
								+ &quot; and inTab.status='ACTIVE' and service_mapping_id=&quot;
								+ fetchPrivTabRS
										.getInt(&quot;service_delivery_master_id&quot;)
								+ &quot; ) a )&quot;);
			}

<span class="nc" id="L642">			boolean flag = true;</span>
<span class="nc bnc" id="L643" title="All 2 branches missed.">			if(ServicesBean.isSLE()) {</span>
<span class="nc bnc" id="L644" title="All 4 branches missed.">				if(privilegeListSLE != null &amp;&amp; privilegeListSLE.size() &gt; 0) {</span>
<span class="nc" id="L645">					flag = false;</span>
<span class="nc bnc" id="L646" title="All 2 branches missed.">					for(PrivilegeDataBean privilegeBean : privilegeListSLE) {</span>
<span class="nc bnc" id="L647" title="All 2 branches missed.">						for(MenuDataBean menuBean : privilegeBean.getMenuList()) {</span>
<span class="nc bnc" id="L648" title="All 2 branches missed.">							for(MenuItemDataBean menuItemBean : menuBean.getMenuItems()) {</span>
<span class="nc" id="L649">								menuItemBean.setIsAssign(false);</span>
<span class="nc bnc" id="L650" title="All 2 branches missed.">								for(String privilege : groupNames) {</span>
<span class="nc bnc" id="L651" title="All 2 branches missed.">									if(privilege.contains(&quot;Sports Lottery&quot;))</span>
									{
<span class="nc bnc" id="L653" title="All 2 branches missed.">									if(privilege.substring(0, privilege.lastIndexOf(&quot;|&quot;)).equals(menuItemBean.getMenuItemName())) {</span>
<span class="nc" id="L654">										menuItemBean.setIsAssign(true);</span>
									}
									}
								}
<span class="nc" id="L658">							}</span>
<span class="nc" id="L659">						}</span>
<span class="nc" id="L660">					}</span>

					try {
<span class="nc" id="L663">						SubUserDataBean userDataBean = new SubUserDataBean();</span>
<span class="nc" id="L664">						userDataBean.setRoleId(roleId);</span>
<span class="nc" id="L665">						userDataBean.setPrivilegeList(privilegeListSLE);</span>
<span class="nc" id="L666">						NotifySLE notifySLE = new NotifySLE(SLE.Activity.SUB_USER_EDIT, userDataBean);</span>
<span class="nc" id="L667">						notifySLE.asyncCall(notifySLE);</span>
<span class="nc" id="L668">						flag = true;</span>
<span class="nc" id="L669">					} catch (Exception ex) {</span>
<span class="nc" id="L670">						ex.printStackTrace();</span>
<span class="nc" id="L671">						flag = false;</span>
<span class="nc" id="L672">						logger.debug(&quot;Error in Edit Role.&quot;);</span>
<span class="nc" id="L673">						throw new SQLException(&quot;Error in Edit Role.&quot;);</span>
<span class="nc" id="L674">					}</span>
				} else {
<span class="nc" id="L676">					logger.debug(&quot;privilegeListSLE is Not Applicable.&quot;);</span>
<span class="nc" id="L677">					throw new SQLException(&quot;Error in Creating Role.&quot;);</span>
				}
			}

<span class="nc bnc" id="L681" title="All 2 branches missed.">			if(flag) {</span>
<span class="nc" id="L682">				con.commit();</span>
			} else {
<span class="nc" id="L684">				con.rollback();</span>
			}

<span class="nc" id="L687">			con.commit();</span>
<span class="nc" id="L688">		} catch (SQLException e) {</span>
<span class="nc" id="L689">			logger.error(&quot;Exception: &quot; + e);</span>

			try {
<span class="nc bnc" id="L692" title="All 2 branches missed.">				if (con != null) {</span>
<span class="nc" id="L693">					con.rollback();</span>
				}
<span class="nc" id="L695">			} catch (SQLException se) {</span>
<span class="nc" id="L696">				logger.error(&quot;Exception: &quot; + se);</span>
				// TODO Auto-generated catch block
<span class="nc" id="L698">				se.printStackTrace();</span>
<span class="nc" id="L699">				throw new LMSException(&quot;Error During Rollback&quot;, se);</span>

<span class="nc" id="L701">			}</span>
<span class="nc" id="L702">			e.printStackTrace();</span>
<span class="nc" id="L703">			throw new LMSException(e);</span>
		} finally {
<span class="nc" id="L705">			try {</span>
<span class="nc bnc" id="L706" title="All 4 branches missed.">				if (con != null) {</span>
<span class="nc" id="L707">					con.close();</span>
				}
<span class="nc" id="L709">			} catch (SQLException see) {</span>
<span class="nc" id="L710">				logger.error(&quot;Exception: &quot; + see);</span>
<span class="nc" id="L711">				see.printStackTrace();</span>
<span class="nc" id="L712">				throw new LMSException(&quot;Error During closing connection&quot;, see);</span>
<span class="nc" id="L713">			}</span>
		}
<span class="nc" id="L715">	}</span>

	public void editOrgPriv(int orgId, String orgType, String[] groupNames, int[] mappingId, int[] privCount, RolePrivilegeBean rolePrivilegeBean, Map&lt;Integer, String&gt; sleService, List&lt;Integer&gt; serviceDeliveryList) throws LMSException {
<span class="nc" id="L718">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L719">		int roleId = 0, userId = 0, userHead = 0;</span>
<span class="nc" id="L720">		String isRoleMaster = null, isUserHead = null;</span>
<span class="nc" id="L721">		String updateQurery = null;</span>
<span class="nc" id="L722">		String userName = null;</span>
<span class="nc" id="L723">		StringBuilder grpName = null;</span>
<span class="nc" id="L724">		String grpNameStr = null;</span>
<span class="nc" id="L725">		int privIdFrm = 0;</span>
<span class="nc" id="L726">		int privIdTo = 0;</span>
<span class="nc" id="L727">		String activeMapIds = &quot;&quot;;</span>
<span class="nc" id="L728">		HashMap&lt;Integer, String&gt; privMap = null;</span>

<span class="nc" id="L730">		String fetchPrivTable = null;</span>
<span class="nc" id="L731">		ResultSet fetchPrivTabRS = null;</span>
<span class="nc" id="L732">		String updateRolePriv = null;</span>
<span class="nc" id="L733">		Statement stmtMappingId = null;</span>
<span class="nc" id="L734">		Statement fetchChildren = null;</span>
		try {
<span class="nc" id="L736">			Statement stmt = con.createStatement();</span>
<span class="nc" id="L737">			Statement stmtUpdate = con.createStatement();</span>
<span class="nc" id="L738">			Statement stmtUpdateOther = con.createStatement();</span>
<span class="nc" id="L739">			con.setAutoCommit(false);</span>

<span class="nc" id="L741">			String qurery = &quot;select roletable.role_id,roletable.is_master,usertable.user_id,usertable.user_name,usertable.isrolehead from (select user_name,user_id,isrolehead,role_id from st_lms_user_master where organization_id = &quot;</span>
					+ orgId
					+ &quot;) as usertable, (select role_id,is_master from st_lms_role_master where (tier_id=(select tier_id from st_lms_tier_master where tier_code='&quot;
					+ orgType
					+ &quot;') and is_master='Y') or (owner_org_id = &quot;
					+ orgId
					+ &quot;)) as roletable where usertable.role_id = roletable.role_id&quot;;

<span class="nc" id="L749">			ResultSet roleTierId = stmt.executeQuery(qurery);</span>

<span class="nc bnc" id="L751" title="All 2 branches missed.">			while (roleTierId.next()) {</span>
<span class="nc" id="L752">				roleId = roleTierId.getInt(&quot;role_id&quot;);</span>
<span class="nc" id="L753">				userId = roleTierId.getInt(&quot;user_id&quot;);</span>
<span class="nc" id="L754">				userName = roleTierId.getString(&quot;user_name&quot;);</span>
<span class="nc" id="L755">				isRoleMaster = roleTierId.getString(&quot;is_master&quot;);</span>
<span class="nc" id="L756">				isUserHead = roleTierId.getString(&quot;isrolehead&quot;);</span>

<span class="nc bnc" id="L758" title="All 4 branches missed.">				if (isRoleMaster.equalsIgnoreCase(&quot;Y&quot;)</span>
						&amp;&amp; isUserHead.equalsIgnoreCase(&quot;Y&quot;)) {
<span class="nc" id="L760">					userHead = userId;</span>
<span class="nc bnc" id="L761" title="All 2 branches missed.">					for (int smId : mappingId) {</span>
<span class="nc" id="L762">						String qry = &quot;select priv_rep_table from st_lms_service_delivery_master where service_delivery_master_id = &quot; + smId;</span>
<span class="nc" id="L763">						Statement st = con.createStatement();</span>
<span class="nc" id="L764">						ResultSet rs = st.executeQuery(qry);</span>
<span class="nc" id="L765">						String privTable = null;</span>
<span class="nc bnc" id="L766" title="All 2 branches missed.">						while(rs.next()){</span>
<span class="nc" id="L767">							privTable = rs.getString(&quot;priv_rep_table&quot;);</span>
						}
<span class="nc" id="L769">						updateQurery = &quot;update st_lms_user_priv_mapping set status='INACTIVE' where user_id=&quot;</span>
								+ userId
								+ &quot; and role_id=&quot;
								+ roleId
								+ &quot; and service_mapping_id=&quot; + smId
								+ &quot; and priv_id in (select distinct priv_id from &quot;
								+ privTable + &quot; where not hidden &lt;=&gt; 'Y')&quot;;
<span class="nc" id="L776">						logger.debug(&quot;for inactive  head user&quot; + updateQurery);</span>
<span class="nc" id="L777">						stmtUpdate.executeUpdate(updateQurery);</span>
					}

<span class="nc" id="L780">					privMap = new HashMap&lt;Integer, String&gt;();</span>
<span class="nc bnc" id="L781" title="All 2 branches missed.">					for (int i = 0; i &lt; mappingId.length; i++) {</span>
<span class="nc bnc" id="L782" title="All 2 branches missed.">						if (privCount[i] != 0) {</span>
<span class="nc" id="L783">							grpName = new StringBuilder(&quot;'Miscellaneous',&quot;);</span>
<span class="nc" id="L784">							privIdTo = privIdTo + privCount[i];</span>
<span class="nc bnc" id="L785" title="All 2 branches missed.">							for (int j = privIdFrm; j &lt; privIdTo; j++) {</span>
<span class="nc" id="L786">								grpName.append(&quot;'&quot; + groupNames[j] + &quot;',&quot;);</span>
<span class="nc" id="L787">								privIdFrm++;</span>
							}
<span class="nc" id="L789">							grpNameStr = grpName.substring(0,</span>
									grpName.length() - 1);
<span class="nc" id="L791">							activeMapIds = activeMapIds + mappingId[i] + &quot;,&quot;;</span>
<span class="nc" id="L792">							privMap.put(mappingId[i], grpNameStr);</span>
						}
<span class="nc" id="L794">						logger.debug(&quot;**&quot; + privCount[i]);</span>
					}
<span class="nc" id="L796">					logger.debug(&quot;privMap*****&quot; + privMap);</span>

<span class="nc" id="L798">					stmtMappingId = con.createStatement();</span>
<span class="nc bnc" id="L799" title="All 2 branches missed.">					if(!activeMapIds.equalsIgnoreCase(&quot;&quot;)){</span>
<span class="nc" id="L800">					fetchPrivTable = &quot;select service_delivery_master_id,priv_rep_table from st_lms_service_delivery_master where service_delivery_master_id in(&quot;</span>
							+ activeMapIds.substring(0,
									activeMapIds.length() - 1) + &quot;)&quot;;
<span class="nc" id="L803">					logger.debug(&quot;*****&quot; + fetchPrivTable);</span>
<span class="nc" id="L804">					fetchPrivTabRS = stmtMappingId.executeQuery(fetchPrivTable);</span>

<span class="nc bnc" id="L806" title="All 2 branches missed.">					while (fetchPrivTabRS.next()) {</span>
<span class="nc" id="L807">						updateRolePriv = &quot;update st_lms_user_priv_mapping set status='ACTIVE' where user_id=&quot;</span>
								+ userId
								+ &quot; and role_id=&quot;
								+ roleId
								+ &quot; and service_mapping_id=&quot;
								+ fetchPrivTabRS
										.getInt(&quot;service_delivery_master_id&quot;)
								+ &quot; and priv_id in (select distinct(priv_id) from &quot;
								+ fetchPrivTabRS.getString(&quot;priv_rep_table&quot;)
								+ &quot; pr where group_name in (&quot;
								+ privMap.get(fetchPrivTabRS
										.getInt(&quot;service_delivery_master_id&quot;))
								+ &quot;) and pr.status='ACTIVE') &quot;;
<span class="nc" id="L820">						logger.debug(&quot;for active  &quot; + updateRolePriv);</span>
<span class="nc" id="L821">						stmtUpdate.executeUpdate(updateRolePriv);</span>
					}
				}
				} else {
<span class="nc bnc" id="L825" title="All 2 branches missed.">					for (int smId : mappingId) {</span>
<span class="nc" id="L826">						updateQurery = &quot;update st_lms_user_priv_mapping upm, (select priv_id from st_lms_user_priv_mapping where user_id=&quot;</span>
								+ userHead
								+ &quot; and service_mapping_id=&quot;
								+ smId
								+ &quot; and status ='INACTIVE') temp set upm.status='INACTIVE' where user_id=&quot;
								+ userId
								+ &quot;  and service_mapping_id=&quot;
								+ smId
								+ &quot;  and upm.priv_id=temp.priv_id&quot;;
<span class="nc" id="L835">						logger.debug(&quot;for inactive other user &quot; + updateQurery);</span>
<span class="nc" id="L836">						stmtUpdateOther.executeUpdate(updateQurery);</span>
					}

				}
<span class="nc" id="L840">				new SetResetUserPasswordAction().logOutRet(userName);</span>
			}

<span class="nc" id="L843">			String fetchChildrensQuery = &quot;select user_id,user_name,isrolehead from st_lms_user_master where organization_id=&quot;</span>
					+ orgId;
<span class="nc" id="L845">			fetchChildren = con.createStatement();</span>
<span class="nc" id="L846">			ResultSet rsChildrenFeching = fetchChildren</span>
					.executeQuery(fetchChildrensQuery);
<span class="nc" id="L848">			Map&lt;Integer, String&gt; childIdMap = new HashMap&lt;Integer, String&gt;();</span>
<span class="nc" id="L849">			int parentUserId = 0;</span>
<span class="nc bnc" id="L850" title="All 2 branches missed.">			while (rsChildrenFeching.next()) {</span>
<span class="nc bnc" id="L851" title="All 2 branches missed.">				if (&quot;Y&quot;.equalsIgnoreCase(rsChildrenFeching</span>
						.getString(&quot;isrolehead&quot;))) {
<span class="nc" id="L853">					parentUserId = rsChildrenFeching.getInt(&quot;user_id&quot;);</span>
				} else {
<span class="nc" id="L855">					childIdMap.put(rsChildrenFeching.getInt(&quot;user_id&quot;), rsChildrenFeching.getString(&quot;user_name&quot;));</span>
				}
			}

<span class="nc" id="L859">			String fetchPriIdQuery = &quot;select priv_id,service_mapping_id,status from st_lms_user_priv_mapping &quot;</span>
					+ &quot;where user_id=&quot; + parentUserId;

<span class="nc" id="L862">			rsChildrenFeching = fetchChildren.executeQuery(fetchPriIdQuery);</span>
<span class="nc" id="L863">			Map&lt;Integer, List&lt;Integer&gt;&gt; privSerActiveMap = new HashMap&lt;Integer, List&lt;Integer&gt;&gt;();</span>
<span class="nc" id="L864">			Map&lt;Integer, List&lt;Integer&gt;&gt; privSerINActiveMap = new HashMap&lt;Integer, List&lt;Integer&gt;&gt;();</span>
<span class="nc bnc" id="L865" title="All 2 branches missed.">			while (rsChildrenFeching.next()) {</span>
<span class="nc" id="L866">				List&lt;Integer&gt; tempPrivList = null;</span>
<span class="nc bnc" id="L867" title="All 2 branches missed.">				if (&quot;ACTIVE&quot;.equalsIgnoreCase(rsChildrenFeching</span>
						.getString(&quot;status&quot;))) {
<span class="nc bnc" id="L869" title="All 2 branches missed.">					if (privSerActiveMap.containsKey(rsChildrenFeching</span>
							.getInt(&quot;service_mapping_id&quot;))) {
<span class="nc" id="L871">						tempPrivList = privSerActiveMap.get(rsChildrenFeching</span>
								.getInt(&quot;service_mapping_id&quot;));
					} else {
<span class="nc" id="L874">						tempPrivList = new ArrayList&lt;Integer&gt;();</span>
					}
<span class="nc" id="L876">					tempPrivList.add(rsChildrenFeching.getInt(&quot;priv_id&quot;));</span>
<span class="nc" id="L877">					privSerActiveMap.put(rsChildrenFeching</span>
							.getInt(&quot;service_mapping_id&quot;), tempPrivList);
<span class="nc bnc" id="L879" title="All 2 branches missed.">				} else if (&quot;INACTIVE&quot;.equalsIgnoreCase(rsChildrenFeching</span>
						.getString(&quot;status&quot;))) {
<span class="nc bnc" id="L881" title="All 2 branches missed.">					if (privSerINActiveMap.containsKey(rsChildrenFeching</span>
							.getInt(&quot;service_mapping_id&quot;))) {
<span class="nc" id="L883">						tempPrivList = privSerINActiveMap.get(rsChildrenFeching</span>
								.getInt(&quot;service_mapping_id&quot;));
					} else {
<span class="nc" id="L886">						tempPrivList = new ArrayList&lt;Integer&gt;();</span>
					}
<span class="nc" id="L888">					tempPrivList.add(rsChildrenFeching.getInt(&quot;priv_id&quot;));</span>
<span class="nc" id="L889">					privSerINActiveMap.put(rsChildrenFeching</span>
							.getInt(&quot;service_mapping_id&quot;), tempPrivList);
				}
<span class="nc" id="L892">			}</span>
<span class="nc" id="L893">			logger.debug(&quot;Active MAP   :&quot; + privSerActiveMap + &quot;\n\n\n&quot;</span>
					+ &quot;INactive MAP:  &quot; + privSerINActiveMap + &quot;\n\n&quot;);
<span class="nc bnc" id="L895" title="All 2 branches missed.">			for (int childId : childIdMap.keySet()) {</span>
				//int childId = childIdMap.get(i);
<span class="nc" id="L897">				Iterator&lt;Map.Entry&lt;Integer, List&lt;Integer&gt;&gt;&gt; iter = privSerINActiveMap</span>
						.entrySet().iterator();
<span class="nc bnc" id="L899" title="All 2 branches missed.">				while (iter.hasNext()) {</span>
<span class="nc" id="L900">					Map.Entry&lt;Integer, List&lt;Integer&gt;&gt; pair = (Map.Entry&lt;Integer, List&lt;Integer&gt;&gt;) iter</span>
							.next();
<span class="nc" id="L902">					String childStatusFetchquery = &quot;update st_lms_user_priv_mapping set status='NA' where user_id=&quot;</span>
							+ childId
							+ &quot; and role_id=&quot;
							+ roleId
							+ &quot; and priv_id in (&quot;
							+ pair.getValue().toString().replace(&quot;, &quot;, &quot;,&quot;)
									.replace(&quot;[&quot;, &quot;&quot;).replace(&quot;]&quot;, &quot;&quot;)
							+ &quot;) and service_mapping_id=&quot; + pair.getKey();

<span class="nc" id="L911">					logger.debug(&quot;NA Subret query**************&quot;</span>
							+ childStatusFetchquery);
<span class="nc" id="L913">					fetchChildren.executeUpdate(childStatusFetchquery);</span>

<span class="nc" id="L915">				}</span>

<span class="nc" id="L917">				iter = privSerActiveMap.entrySet().iterator();</span>
<span class="nc bnc" id="L918" title="All 2 branches missed.">				while (iter.hasNext()) {</span>
<span class="nc" id="L919">					Map.Entry&lt;Integer, List&lt;Integer&gt;&gt; pair = (Map.Entry&lt;Integer, List&lt;Integer&gt;&gt;) iter</span>
							.next();
<span class="nc" id="L921">					String childStatusFetchquery = &quot;update st_lms_user_priv_mapping set status='INACTIVE' where user_id=&quot;</span>
							+ childId
							+ &quot; and status='NA' and role_id=&quot;
							+ roleId
							+ &quot; and priv_id in (&quot;
							+ pair.getValue().toString().replace(&quot;, &quot;, &quot;,&quot;)
									.replace(&quot;[&quot;, &quot;&quot;).replace(&quot;]&quot;, &quot;&quot;)
							+ &quot;) and service_mapping_id=&quot; + pair.getKey();

<span class="nc" id="L930">					logger.debug(&quot;INACTIVE Subret query**************&quot;</span>
							+ childStatusFetchquery);
<span class="nc" id="L932">					fetchChildren.executeUpdate(childStatusFetchquery);</span>
<span class="nc" id="L933">				}</span>
<span class="nc" id="L934">				new SetResetUserPasswordAction().logOutRet(userName);</span>
<span class="nc" id="L935">			}</span>
			
<span class="nc" id="L937">			boolean flag = true;</span>
			
<span class="nc bnc" id="L939" title="All 4 branches missed.">			if (sleService != null &amp;&amp; sleService.size() &gt; 0) {</span>
<span class="nc" id="L940">				privIdTo = 0; privIdFrm = 0;</span>
<span class="nc" id="L941">				int iLoop = 0;</span>
<span class="nc" id="L942">				List&lt;String&gt; sleGroupName = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L943" title="All 2 branches missed.">				for (Integer iValue : serviceDeliveryList) {</span>
<span class="nc" id="L944">					privIdTo += privCount[iLoop];</span>
<span class="nc bnc" id="L945" title="All 2 branches missed.">					if (sleService.containsKey(iValue)) {</span>
<span class="nc bnc" id="L946" title="All 2 branches missed.">						for (int jLoop = privIdFrm; jLoop &lt; privIdTo; jLoop++) {</span>
<span class="nc" id="L947">							sleGroupName.add(groupNames[jLoop]);</span>
						}
<span class="nc bnc" id="L949" title="All 2 branches missed.">						for (PrivilegeDataBean privilegeDataBean : rolePrivilegeBean.getPrivilegeList()) {</span>
<span class="nc bnc" id="L950" title="All 2 branches missed.">							if (sleService.get(iValue).equals(privilegeDataBean.getInterfaceDevName())) {</span>
<span class="nc bnc" id="L951" title="All 2 branches missed.">								for (MenuDataBean menuDataBean : privilegeDataBean.getMenuList()) {</span>
<span class="nc bnc" id="L952" title="All 2 branches missed.">									for (MenuItemDataBean menuItemDataBean : menuDataBean.getMenuItems()) {</span>
<span class="nc bnc" id="L953" title="All 2 branches missed.">										if (sleGroupName.contains(menuItemDataBean.getMenuItemName())) {</span>
<span class="nc" id="L954">											menuItemDataBean.setIsAssign(true);</span>
										} else {
<span class="nc" id="L956">											menuItemDataBean.setIsAssign(false);</span>
										}
<span class="nc" id="L958">									}</span>
<span class="nc" id="L959">								}</span>
							}
<span class="nc" id="L961">						}</span>
					} else
<span class="nc" id="L963">						privIdFrm += privCount[iLoop];</span>
<span class="nc" id="L964">					iLoop++;</span>
<span class="nc" id="L965">				}</span>
				
				try {
<span class="nc" id="L968">					NotifySLE notifySLE = new NotifySLE(SLE.Activity.UPDATE_RETAILER_PRIVILEGES, rolePrivilegeBean);</span>
<span class="nc" id="L969">					notifySLE.asyncCall(notifySLE);</span>
<span class="nc" id="L970">				} catch (Exception e) {</span>
<span class="nc" id="L971">					e.printStackTrace();</span>
<span class="nc" id="L972">					flag = false;</span>
<span class="nc" id="L973">					logger.debug(&quot;Error in Edit Role.&quot;);</span>
<span class="nc" id="L974">					throw new SQLException(&quot;Error in Edit Role.&quot;);</span>
<span class="nc" id="L975">				}</span>
			}
			
<span class="nc bnc" id="L978" title="All 2 branches missed.">			if(flag)</span>
<span class="nc" id="L979">				con.commit();</span>
			else
<span class="nc" id="L981">				con.rollback();</span>
			
<span class="nc" id="L983">			con.commit();</span>
<span class="nc" id="L984">		} catch (SQLException e) {</span>
<span class="nc" id="L985">			logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L986">			e.printStackTrace();</span>
<span class="nc" id="L987">			throw new LMSException(&quot;Error During Rollback&quot;, e);</span>
<span class="nc" id="L988">		} catch (Exception e) {</span>
<span class="nc" id="L989">			logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L990">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L992">			try {</span>
<span class="nc bnc" id="L993" title="All 6 branches missed.">				if (con != null) {</span>
<span class="nc" id="L994">					con.close();</span>
				}
<span class="nc" id="L996">			} catch (SQLException see) {</span>
<span class="nc" id="L997">				logger.error(&quot;Exception: &quot; + see);</span>
<span class="nc" id="L998">				see.printStackTrace();</span>
<span class="nc" id="L999">				throw new LMSException(&quot;Error During closing connection&quot;, see);</span>
<span class="nc" id="L1000">			}</span>
		}

<span class="nc" id="L1003">	}</span>

	// changes will be made in this file
	public void editUserPriv(String userName, String[] groupNames,
			int[] mappingId, int[] privCount, List&lt;PrivilegeDataBean&gt; privilegeListSLE, int doneByUserId, String requestIp) throws LMSException {

		 
<span class="nc" id="L1010">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L1011">		int userId = 0, roleId = 0, userOrgId = 0;</span>
		try {
<span class="nc" id="L1013">			con.setAutoCommit(false);</span>

<span class="nc" id="L1015">			Statement stmt = con.createStatement();</span>
<span class="nc" id="L1016">			ResultSet userRs = stmt</span>
					.executeQuery(&quot;select user_id,role_id,organization_id,organization_type from st_lms_user_master where user_name='&quot;
							+ userName + &quot;'&quot;);
<span class="nc bnc" id="L1019" title="All 2 branches missed.">			while (userRs.next()) {</span>
<span class="nc" id="L1020">				userId = userRs.getInt(&quot;user_id&quot;);</span>
<span class="nc" id="L1021">				roleId = userRs.getInt(&quot;role_id&quot;);</span>
<span class="nc" id="L1022">				userOrgId = userRs.getInt(&quot;organization_id&quot;);</span>
			}

			/*	Insert User Priviledge Data in History Start	*/
<span class="nc" id="L1026">			String insertHistoryData = &quot;INSERT INTO st_lms_user_priv_history (user_id, priv_id, service_mapping_id, status, change_date, change_by, request_ip) SELECT user_id, priv_id, service_mapping_id, status, change_date, change_by, request_ip FROM st_lms_user_priv_mapping WHERE role_id=&quot;+roleId+&quot; AND user_id=&quot;+userId+&quot;;&quot;;</span>
<span class="nc" id="L1027">			logger.info(&quot;insertHistoryData - &quot;+insertHistoryData);</span>
<span class="nc" id="L1028">			stmt.executeUpdate(insertHistoryData);</span>
			/*	Insert User Priviledge Data in History End		*/

<span class="nc" id="L1031">			String currentTime = Util.getCurrentTimeString();</span>
<span class="nc bnc" id="L1032" title="All 2 branches missed.">			for (int element : mappingId) {</span>
<span class="nc" id="L1033">				String updateUserPriv = &quot;update st_lms_user_priv_mapping set status='INACTIVE', change_date='&quot;+currentTime+&quot;', change_by=&quot;+doneByUserId+&quot;, request_ip='&quot;+requestIp+&quot;' where user_id=&quot;</span>
						+ userId
						+ &quot; and role_id=&quot;
						+ roleId
						+ &quot; and status!='NA' and service_mapping_id=&quot; + element;
<span class="nc" id="L1038">				stmt.executeUpdate(updateUserPriv);</span>
			}

<span class="nc" id="L1041">			StringBuilder grpName = null;</span>
<span class="nc" id="L1042">			StringBuilder strMappingId = new StringBuilder(&quot;&quot;);</span>
<span class="nc" id="L1043">			String grpNameStr = null;</span>
<span class="nc" id="L1044">			int privIdFrm = 0;</span>
<span class="nc" id="L1045">			int privIdTo = 0;</span>
<span class="nc" id="L1046">			String activeMapIds = &quot;&quot;;</span>
<span class="nc" id="L1047">			HashMap&lt;Integer, String&gt; privMap = new HashMap&lt;Integer, String&gt;();</span>
<span class="nc bnc" id="L1048" title="All 2 branches missed.">			for (int i = 0; i &lt; mappingId.length; i++) {</span>
<span class="nc bnc" id="L1049" title="All 2 branches missed.">				if (privCount[i] != 0) {</span>
<span class="nc" id="L1050">					grpName = new StringBuilder(&quot;'Miscellaneous',&quot;);</span>
<span class="nc" id="L1051">					privIdTo = privIdTo + privCount[i];</span>
<span class="nc bnc" id="L1052" title="All 2 branches missed.">					for (int j = privIdFrm; j &lt; privIdTo; j++) {</span>
<span class="nc bnc" id="L1053" title="All 2 branches missed.">						grpName.append(groupNames[j].contains(&quot;|&quot;) ? &quot;'&quot; + groupNames[j].substring(0, groupNames[j].lastIndexOf(&quot;|&quot;)) + &quot;',&quot; : &quot;'&quot; + groupNames[j] + &quot;',&quot; );</span>
							//grpName.append(&quot;'&quot; + groupNames[j].substring(0, groupNames[j].lastIndexOf(&quot;|&quot;)) + &quot;',&quot;);
						
<span class="nc" id="L1056">						privIdFrm++;</span>
					}
<span class="nc" id="L1058">					grpNameStr = grpName.substring(0, grpName.length() - 1);</span>
<span class="nc" id="L1059">					activeMapIds = activeMapIds + mappingId[i] + &quot;,&quot;;</span>
<span class="nc" id="L1060">					privMap.put(mappingId[i], grpNameStr);</span>
				}
<span class="nc" id="L1062">				logger.debug(&quot;**&quot; + privCount[i]);</span>
<span class="nc" id="L1063">				strMappingId.append(mappingId[i] + &quot;,&quot;);</span>

			}
<span class="nc" id="L1066">			strMappingId.deleteCharAt(strMappingId.length() - 1);</span>

<span class="nc" id="L1068">			logger.debug(&quot;privMap*****&quot; + privMap);</span>

<span class="nc" id="L1070">			String fetchPrivTable = null;</span>
<span class="nc" id="L1071">			ResultSet fetchPrivTabRS = null;</span>
<span class="nc" id="L1072">			String updateRolePriv = null;</span>
<span class="nc" id="L1073">			Statement stmtMappingId = con.createStatement();</span>

<span class="nc" id="L1075">			fetchPrivTable = &quot;select service_delivery_master_id,priv_rep_table from st_lms_service_delivery_master where service_delivery_master_id in(&quot;</span>
					+ strMappingId.toString() + &quot;)&quot;;
<span class="nc" id="L1077">			logger.debug(&quot;*****&quot; + fetchPrivTable);</span>
<span class="nc" id="L1078">			fetchPrivTabRS = stmtMappingId.executeQuery(fetchPrivTable);</span>

<span class="nc bnc" id="L1080" title="All 2 branches missed.">			while (fetchPrivTabRS.next()) {</span>
<span class="nc" id="L1081">				updateRolePriv = &quot;update st_lms_user_priv_mapping set status='ACTIVE' where user_id=&quot;</span>
						+ userId
						+ &quot; and role_id=&quot;
						+ roleId
						+ &quot; and service_mapping_id=&quot;
						+ fetchPrivTabRS.getInt(&quot;service_delivery_master_id&quot;)
						+ &quot; and priv_id in (select distinct(priv_id) from &quot;
						+ fetchPrivTabRS.getString(&quot;priv_rep_table&quot;)
						+ &quot; pr where group_name in (&quot;
						+ privMap.get(fetchPrivTabRS
								.getInt(&quot;service_delivery_master_id&quot;))
						+ &quot;) and pr.status='ACTIVE') &quot;;
<span class="nc" id="L1093">				logger.debug(updateRolePriv);</span>
<span class="nc" id="L1094">				stmt.executeUpdate(updateRolePriv);</span>
			}

<span class="nc" id="L1097">			boolean flag = true;</span>
<span class="nc bnc" id="L1098" title="All 2 branches missed.">			if(ServicesBean.isSLE()) {</span>
<span class="nc bnc" id="L1099" title="All 4 branches missed.">				if(privilegeListSLE != null &amp;&amp; privilegeListSLE.size() &gt; 0) {</span>
<span class="nc" id="L1100">					flag = false;</span>
<span class="nc bnc" id="L1101" title="All 2 branches missed.">					for(PrivilegeDataBean privilegeBean : privilegeListSLE) {</span>
<span class="nc bnc" id="L1102" title="All 2 branches missed.">						for(MenuDataBean menuBean : privilegeBean.getMenuList()) {</span>
<span class="nc bnc" id="L1103" title="All 2 branches missed.">							for(MenuItemDataBean menuItemBean : menuBean.getMenuItems()) {</span>
<span class="nc" id="L1104">								menuItemBean.setIsAssign(false);</span>
<span class="nc bnc" id="L1105" title="All 2 branches missed.">								for(String privilege : groupNames) {</span>
<span class="nc bnc" id="L1106" title="All 2 branches missed.">									if(privilege.contains(&quot;Sports Lottery&quot;))</span>
									{
<span class="nc bnc" id="L1108" title="All 2 branches missed.">									if(privilege.substring(0, privilege.lastIndexOf(&quot;|&quot;)).equals(menuItemBean.getMenuItemName())) {</span>
<span class="nc" id="L1109">										menuItemBean.setIsAssign(true);</span>
									}
									}
								}
<span class="nc" id="L1113">							}</span>
<span class="nc" id="L1114">						}</span>
<span class="nc" id="L1115">					}</span>

					try {
<span class="nc" id="L1118">						SubUserDataBean userDataBean = new SubUserDataBean();</span>
<span class="nc" id="L1119">						userDataBean.setUserId(userId);</span>
<span class="nc" id="L1120">						userDataBean.setCreatorUserId(doneByUserId);</span>
<span class="nc" id="L1121">						userDataBean.setRequestIp(requestIp);</span>
<span class="nc" id="L1122">						userDataBean.setPrivilegeList(privilegeListSLE);</span>
<span class="nc" id="L1123">						NotifySLE notifySLE = new NotifySLE(SLE.Activity.SUB_USER_EDIT, userDataBean);</span>
<span class="nc" id="L1124">						notifySLE.asyncCall(notifySLE);</span>
<span class="nc" id="L1125">						flag = true;</span>
<span class="nc" id="L1126">					} catch (Exception ex) {</span>
<span class="nc" id="L1127">						ex.printStackTrace();</span>
<span class="nc" id="L1128">						flag = false;</span>
<span class="nc" id="L1129">						logger.debug(&quot;Error in Edit Role.&quot;);</span>
<span class="nc" id="L1130">						throw new SQLException(&quot;Error in Edit Role.&quot;);</span>
<span class="nc" id="L1131">					}</span>
				}
			}

<span class="nc bnc" id="L1135" title="All 2 branches missed.">			if(flag) {</span>
<span class="nc" id="L1136">				con.commit();</span>
			} else {
<span class="nc" id="L1138">				con.rollback();</span>
<span class="nc" id="L1139">				throw new LMSException(&quot;Error Occured.&quot;);</span>
			}
<span class="nc" id="L1141">		} catch (SQLException e) {</span>
<span class="nc" id="L1142">			logger.error(&quot;Exception: &quot; + e);</span>

			try {
<span class="nc bnc" id="L1145" title="All 2 branches missed.">				if (con != null) {</span>
<span class="nc" id="L1146">					con.rollback();</span>
				}
<span class="nc" id="L1148">			} catch (SQLException se) {</span>
<span class="nc" id="L1149">				logger.error(&quot;Exception: &quot; + se);</span>
				// TODO Auto-generated catch block
<span class="nc" id="L1151">				se.printStackTrace();</span>
<span class="nc" id="L1152">				throw new LMSException(&quot;Error During Rollback&quot;, se);</span>

<span class="nc" id="L1154">			}</span>
<span class="nc" id="L1155">			e.printStackTrace();</span>
<span class="nc" id="L1156">			throw new LMSException(e);</span>
		} finally {
<span class="nc" id="L1158">			try {</span>
<span class="nc bnc" id="L1159" title="All 4 branches missed.">				if (con != null) {</span>
<span class="nc" id="L1160">					con.close();</span>
				}
<span class="nc" id="L1162">			} catch (SQLException see) {</span>
<span class="nc" id="L1163">				logger.error(&quot;Exception: &quot; + see);</span>
<span class="nc" id="L1164">				see.printStackTrace();</span>
<span class="nc" id="L1165">				throw new LMSException(&quot;Error During closing connection&quot;, see);</span>
<span class="nc" id="L1166">			}</span>
		}
<span class="nc" id="L1168">	}</span>

	public Map fetchChildPriv(int privId, Connection con) throws SQLException {
<span class="nc" id="L1171">		Map childMap = new HashMap();</span>
<span class="nc" id="L1172">		Statement stmt = con.createStatement();</span>
<span class="nc" id="L1173">		String privTitle = null;</span>
<span class="nc" id="L1174">		String getChildPriv = &quot;select pid,priv_title from priviledge_rep where parent_priv_id=&quot;</span>
				+ privId;
<span class="nc" id="L1176">		ResultSet rs = stmt.executeQuery(getChildPriv);</span>
<span class="nc bnc" id="L1177" title="All 2 branches missed.">		while (rs.next()) {</span>
<span class="nc" id="L1178">			privId = rs.getInt(&quot;pid&quot;);</span>
<span class="nc" id="L1179">			privTitle = rs.getString(&quot;priv_title&quot;);</span>
<span class="nc" id="L1180">			childMap.put(privTitle, fetchChildPriv(privId, con));</span>

		}
<span class="nc" id="L1183">		return childMap;</span>
	}

	public Map fetchGroupPriv(String groupName, Connection con)
			throws SQLException {
<span class="nc" id="L1188">		Map groupMap = new HashMap();</span>
<span class="nc" id="L1189">		Statement stmt = con.createStatement();</span>
<span class="nc" id="L1190">		String privTitle = null;</span>
<span class="nc" id="L1191">		int privId = 0;</span>
<span class="nc" id="L1192">		String getPriv = &quot;select distinct(priv_id),priv_title,related_to from priviledge_rep where group_name='&quot;</span>
				+ groupName
				+ &quot;' and parent_priv_id=0 order by related_to,priv_id&quot;;
<span class="nc" id="L1195">		ResultSet rs = stmt.executeQuery(getPriv);</span>
<span class="nc bnc" id="L1196" title="All 2 branches missed.">		while (rs.next()) {</span>
<span class="nc" id="L1197">			privId = rs.getInt(&quot;priv_id&quot;);</span>
<span class="nc" id="L1198">			privTitle = rs.getString(&quot;priv_title&quot;);</span>

<span class="nc" id="L1200">			groupMap.put(privTitle, fetchChildPriv(privId, con));</span>

		}
<span class="nc" id="L1203">		return groupMap;</span>
	}

	public Map&lt;String, TreeMap&lt;String, TreeMap&lt;String, List&lt;userPrivBean&gt;&gt;&gt;&gt; getBOMasPriviledges(
			String userName, int roleHeadId, List&lt;PrivilegeDataBean&gt; privilegeList) throws LMSException {

		 
<span class="nc" id="L1210">		Connection con = DBConnect.getConnection();</span>
		// ArrayList&lt;userPrivBean&gt; userPrivList=new ArrayList&lt;userPrivBean&gt;();
<span class="nc" id="L1212">		Map&lt;String, TreeMap&lt;String, TreeMap&lt;String, List&lt;userPrivBean&gt;&gt;&gt;&gt; headPriviledgeMap = new TreeMap&lt;String, TreeMap&lt;String, TreeMap&lt;String, List&lt;userPrivBean&gt;&gt;&gt;&gt;();</span>
<span class="nc" id="L1213">		int roleId = 0, userOrgId = 0, userId = 0;</span>
		try {
<span class="nc" id="L1215">			Statement stmt = con.createStatement();</span>
<span class="nc" id="L1216">			Statement privStmt = con.createStatement();</span>
<span class="nc" id="L1217">			Statement serviceStmt = con.createStatement();</span>
<span class="nc" id="L1218">			String rolePrivQuery = null;</span>

<span class="nc" id="L1220">			ResultSet userRs = stmt</span>
					.executeQuery(&quot;select user_id,role_id,organization_id,organization_type from st_lms_user_master where user_name='&quot;
							+ userName + &quot;'&quot;);
<span class="nc bnc" id="L1223" title="All 2 branches missed.">			while (userRs.next()) {</span>
<span class="nc" id="L1224">				userId = userRs.getInt(&quot;user_id&quot;);</span>
<span class="nc" id="L1225">				roleId = userRs.getInt(&quot;role_id&quot;);</span>
<span class="nc" id="L1226">				userOrgId = userRs.getInt(&quot;organization_id&quot;);</span>
			}

<span class="nc" id="L1229">			String fetchService = &quot;select srm.id,role_id,interface,service_display_name,priv_rep_table,srm.status from st_lms_service_role_mapping srm,st_lms_service_master sm,st_lms_service_delivery_master sdm where srm.role_id=&quot;</span>
					+ roleId
					+ &quot; and organization_id=&quot;
					+ userOrgId
					+ &quot; and srm.status='ACTIVE' and sm.status='ACTIVE' and sdm.status='ACTIVE' and srm.id=sdm.service_delivery_master_id and sdm.service_id=sm.service_id&quot;;
<span class="nc" id="L1234">			logger.debug(&quot;fetchService====&quot; + fetchService);</span>
<span class="nc" id="L1235">			ResultSet serviceRS = serviceStmt.executeQuery(fetchService);</span>
<span class="nc" id="L1236">			ResultSet privRS = null;</span>
<span class="nc" id="L1237">			TreeMap&lt;String, TreeMap&lt;String, List&lt;userPrivBean&gt;&gt;&gt; interfaceMap = null;</span>
<span class="nc bnc" id="L1238" title="All 2 branches missed.">			while (serviceRS.next()) {</span>
<span class="nc" id="L1239">				rolePrivQuery = &quot;select distinct(group_name),upm.status,pr.related_to from &quot;</span>
						+ serviceRS.getString(&quot;priv_rep_table&quot;)
						+ &quot; as pr ,st_lms_role_priv_mapping as rpm, st_lms_user_priv_mapping upm where upm.user_id=&quot;
						+ userId
						+ &quot; and  (upm.status='ACTIVE') and upm.priv_id=rpm.priv_id and (rpm.service_mapping_id=&quot;
						+ serviceRS.getString(&quot;id&quot;)
						+ &quot; and upm.service_mapping_id=&quot;
						+ serviceRS.getString(&quot;id&quot;)
						+ &quot;) and (rpm.role_id=&quot;
						+ roleId
						+ &quot; and upm.role_id=&quot;
						+ roleId
						+ &quot;) and  rpm.priv_id=pr.priv_id order by related_to,group_name&quot;;
<span class="nc" id="L1252">				logger.debug(&quot;rolePrivQuery====&quot; + rolePrivQuery);</span>
				
				
<span class="nc" id="L1255">				String rolePrivQuery2 = &quot;select distinct(group_name),upm.status,pr.related_to from &quot;</span>
					+ serviceRS.getString(&quot;priv_rep_table&quot;)
					+ &quot; as pr ,st_lms_role_priv_mapping as rpm, st_lms_user_priv_mapping upm where upm.user_id=&quot;
					+ roleHeadId
					+ &quot; and  (upm.status='ACTIVE')  and rpm.status = 'ACTIVE' and pr.status = 'ACTIVE'  and upm.priv_id=rpm.priv_id and (rpm.service_mapping_id=&quot;
					+ serviceRS.getString(&quot;id&quot;)
					+ &quot; and upm.service_mapping_id=&quot;
					+ serviceRS.getString(&quot;id&quot;)
					+ &quot;) and (rpm.role_id=&quot;
					+ roleId
					+ &quot; and upm.role_id=&quot;
					+ roleId
					+ &quot;) and  rpm.priv_id=pr.priv_id order by related_to,group_name&quot;;
<span class="nc" id="L1268">			logger.debug(&quot;rolePrivQuery====&quot; + rolePrivQuery2);</span>
<span class="nc" id="L1269">			privRS = privStmt.executeQuery(rolePrivQuery);</span>
<span class="nc" id="L1270">			Map&lt;String,String&gt; rolePrivMap = new HashMap&lt;String, String&gt;();</span>
<span class="nc bnc" id="L1271" title="All 2 branches missed.">			while (privRS.next()) {</span>
<span class="nc" id="L1272">				rolePrivMap.put(privRS.getString(&quot;group_name&quot;), privRS.getString(&quot;status&quot;));</span>
			}
			
			
<span class="nc" id="L1276">				privRS = privStmt.executeQuery(rolePrivQuery2);</span>
<span class="nc" id="L1277">				String relatedTo = &quot;&quot;;</span>
				userPrivBean privBean;
<span class="nc" id="L1279">				String oldRelatedTo = &quot;&quot;;</span>
<span class="nc" id="L1280">				List&lt;userPrivBean&gt; groupNameList = null;</span>
<span class="nc bnc" id="L1281" title="All 2 branches missed.">				if (!headPriviledgeMap.containsKey(serviceRS</span>
						.getString(&quot;service_display_name&quot;))) {
<span class="nc" id="L1283">					interfaceMap = new TreeMap&lt;String, TreeMap&lt;String, List&lt;userPrivBean&gt;&gt;&gt;();</span>
				}
<span class="nc" id="L1285">				TreeMap&lt;String, List&lt;userPrivBean&gt;&gt; privMap = new TreeMap&lt;String, List&lt;userPrivBean&gt;&gt;();</span>
				// logger.debug(rolePrivQuery);
<span class="nc bnc" id="L1287" title="All 2 branches missed.">				while (privRS.next()) {</span>
<span class="nc" id="L1288">					relatedTo = privRS.getString(&quot;related_to&quot;);</span>
<span class="nc" id="L1289">					privBean = new userPrivBean();</span>
					// privBean.setPid(Privrs.getInt(&quot;pid&quot;));
<span class="nc" id="L1291">					String grpName = privRS.getString(&quot;group_name&quot;);</span>
<span class="nc" id="L1292">					privBean.setPrivTitle(grpName);</span>
<span class="nc" id="L1293">					logger.debug(&quot;Prin Bean*******************: &quot;</span>
							+ privBean.getPrivTitle());
					
<span class="nc" id="L1296">					String status = rolePrivMap.get(grpName);</span>
					
<span class="nc bnc" id="L1298" title="All 2 branches missed.">					if(status == null){</span>
<span class="nc" id="L1299">						privBean.setStatus(&quot;INACTIVE&quot;);</span>
					} else {
<span class="nc" id="L1301">						privBean.setStatus(privRS.getString(&quot;status&quot;));</span>
					}
<span class="nc" id="L1303">					privBean.setPrivRelatedTo(relatedTo);</span>
					// logger.debug(privRS.getString(&quot;group_name&quot;)+&quot;***&quot;+privRS.getString(&quot;status&quot;));
<span class="nc bnc" id="L1305" title="All 22 branches missed.">					if (!privRS.getString(&quot;group_name&quot;).equals(&quot;Miscellaneous&quot;)</span>
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;Create Role&quot;)
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;Edit Role&quot;)
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;BO User Registration&quot;)
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;BO: Edit Role&quot;)
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;BO: Create Role&quot;)
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;BO: Role Head Registration&quot;)
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;Role Head Registration&quot;)	
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;Add Sub User&quot;)
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;Edit Sub User Privileges&quot;)
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;User Priviledge Report&quot;)) {
						
<span class="nc bnc" id="L1327" title="All 2 branches missed.">					if (!relatedTo.equals(oldRelatedTo)) {</span>
<span class="nc" id="L1328">						groupNameList = new ArrayList&lt;userPrivBean&gt;();</span>
<span class="nc" id="L1329">						oldRelatedTo = relatedTo;</span>
<span class="nc" id="L1330">						privMap.put(oldRelatedTo, groupNameList);</span>

					}
<span class="nc" id="L1333">					groupNameList.add(privBean);</span>
					}

<span class="nc" id="L1336">				}</span>

<span class="nc" id="L1338">				interfaceMap.put(serviceRS.getString(&quot;interface&quot;) + &quot;-&quot;</span>
						+ serviceRS.getString(&quot;id&quot;), privMap);
<span class="nc" id="L1340">				headPriviledgeMap.put(serviceRS</span>
						.getString(&quot;service_display_name&quot;), interfaceMap);

<span class="nc" id="L1343">			}</span>

<span class="nc bnc" id="L1345" title="All 4 branches missed.">			if(ServicesBean.isSLE() &amp;&amp; headPriviledgeMap.get(&quot;Sports Lottery&quot;) != null) {</span>
<span class="nc" id="L1346">				RolePrivilegeBean roleBean = null;</span>
				try {
<span class="nc" id="L1348">					roleBean = new RolePrivilegeBean();</span>
<span class="nc" id="L1349">					roleBean.setUserId(userId);</span>
<span class="nc" id="L1350">					NotifySLE notifySLE = new NotifySLE(SLE.Activity.GET_USER_PRIVILEGES, roleBean);</span>
<span class="nc" id="L1351">					roleBean = (RolePrivilegeBean) notifySLE.asyncCall(notifySLE);</span>
<span class="nc" id="L1352">					List&lt;PrivilegeDataBean&gt; tempList = roleBean.getPrivilegeList();</span>
<span class="nc" id="L1353">					privilegeList.addAll(tempList);</span>
<span class="nc" id="L1354">				} catch (Exception ex) {</span>
<span class="nc" id="L1355">					ex.printStackTrace();</span>
<span class="nc" id="L1356">				}</span>

<span class="nc" id="L1358">				SLEUtils.editSLEPrivileges(headPriviledgeMap, privilegeList);</span>
			}

<span class="nc" id="L1361">			logger.debug(&quot;*****headPriviledgeMap****\n&quot; + headPriviledgeMap</span>
					+ &quot;\n********&quot;);
<span class="nc" id="L1363">			return headPriviledgeMap;</span>
<span class="nc" id="L1364">		} catch (SQLException e) {</span>
<span class="nc" id="L1365">			logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L1366">			e.printStackTrace();</span>
<span class="nc" id="L1367">			throw new LMSException(&quot;Error During Rollback&quot;, e);</span>
		} finally {
<span class="nc" id="L1369">			try {</span>
<span class="nc bnc" id="L1370" title="All 4 branches missed.">				if (con != null) {</span>
<span class="nc" id="L1371">					con.close();</span>
				}
<span class="nc" id="L1373">			} catch (SQLException se) {</span>
<span class="nc" id="L1374">				se.printStackTrace();</span>
<span class="nc" id="L1375">			}</span>
		}

	}

	public Map&lt;String, TreeMap&lt;String, TreeMap&lt;String, List&lt;String&gt;&gt;&gt;&gt; getHeadsGroupNames(
			int userId, int roleId, int userOrgId) throws LMSException {

<span class="nc" id="L1383">		Map&lt;String, TreeMap&lt;String, TreeMap&lt;String, List&lt;String&gt;&gt;&gt;&gt; headPriviledgeMap = new TreeMap&lt;String, TreeMap&lt;String, TreeMap&lt;String, List&lt;String&gt;&gt;&gt;&gt;();</span>

		 
<span class="nc" id="L1386">		Connection con = DBConnect.getConnection();</span>
		try {
<span class="nc" id="L1388">			Statement privStmt = con.createStatement();</span>
<span class="nc" id="L1389">			Statement serviceStmt = con.createStatement();</span>
			// get heads priviledges from role_priv_mapping table
<span class="nc" id="L1391">			String rolePrivQuery = null;</span>
			// String fetchService = &quot;select
			// srm.id,role_id,service_display_name,priv_rep_table,interface
			// from st_lms_service_role_mapping srm,st_lms_service_master sm
			// where srm.status='ACTIVE' and srm.role_id=&quot;+roleId+&quot; and
			// sm.status='ACTIVE' and srm.service_id=sm.service_id&quot;;
<span class="nc" id="L1397">			String fetchService = &quot;select srm.id,role_id,interface,service_display_name,priv_rep_table from st_lms_service_role_mapping srm,st_lms_service_master sm,st_lms_service_delivery_master sdm where srm.role_id=&quot;</span>
					+ roleId
					+ &quot; and organization_id=&quot;
					+ userOrgId
					+ &quot; and srm.status='ACTIVE' and sm.status='ACTIVE' and sdm.status='ACTIVE' and srm.id=sdm.service_delivery_master_id and sdm.service_id=sm.service_id&quot;;
<span class="nc" id="L1402">			logger.debug(&quot;fetchService====&quot; + fetchService);</span>
<span class="nc" id="L1403">			ResultSet serviceRS = serviceStmt.executeQuery(fetchService);</span>
<span class="nc" id="L1404">			ResultSet privRS = null;</span>
<span class="nc" id="L1405">			TreeMap&lt;String, TreeMap&lt;String, List&lt;String&gt;&gt;&gt; interfaceMap = null;</span>
<span class="nc bnc" id="L1406" title="All 2 branches missed.">			while (serviceRS.next()) {</span>
<span class="nc" id="L1407">				rolePrivQuery = &quot;select distinct(pr.group_name),pr.related_to from st_lms_user_priv_mapping upm,&quot;</span>
						+ serviceRS.getString(&quot;priv_rep_table&quot;)
						+ &quot; as pr,(select distinct(upm.priv_id) from st_lms_role_priv_mapping rpm,st_lms_user_priv_mapping upm where upm.user_id=&quot;
						+ userId
						+ &quot; and upm.role_id=&quot;
						+ roleId
						+ &quot; and rpm.status='ACTIVE' and upm.status='ACTIVE'and upm.role_id=rpm.role_id and upm.service_mapping_id=&quot;
						+ serviceRS.getInt(&quot;id&quot;)
						+ &quot;) result where upm.user_id=&quot;
						+ userId
						+ &quot; and upm.priv_id=pr.priv_id and pr.status='ACTIVE' and result.priv_id=pr.priv_id order by related_to,group_name&quot;;
<span class="nc" id="L1418">				logger.debug(&quot;rolePrivQuery====&quot; + rolePrivQuery);</span>
<span class="nc" id="L1419">				privRS = privStmt.executeQuery(rolePrivQuery);</span>
<span class="nc" id="L1420">				String relatedTo = &quot;&quot;;</span>
<span class="nc" id="L1421">				List&lt;String&gt; groupNameList = null;</span>
<span class="nc bnc" id="L1422" title="All 2 branches missed.">				if (!headPriviledgeMap.containsKey(serviceRS</span>
						.getString(&quot;service_display_name&quot;))) {
<span class="nc" id="L1424">					interfaceMap = new TreeMap&lt;String, TreeMap&lt;String, List&lt;String&gt;&gt;&gt;();</span>
				}
<span class="nc" id="L1426">				TreeMap&lt;String, List&lt;String&gt;&gt; privMap = new TreeMap&lt;String, List&lt;String&gt;&gt;();</span>
<span class="nc bnc" id="L1427" title="All 2 branches missed.">				while (privRS.next()) {</span>
<span class="nc bnc" id="L1428" title="All 22 branches missed.">					if (!privRS.getString(&quot;group_name&quot;).equals(&quot;Miscellaneous&quot;)</span>
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;Create Role&quot;)
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;Edit Role&quot;)
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;BO User Registration&quot;)
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;BO: Edit Role&quot;)
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;BO: Create Role&quot;)
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;BO: Role Head Registration&quot;)
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;Add Sub User&quot;)
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;Role Head Registration&quot;)
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;Edit Sub User Privileges&quot;)
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;User Priviledge Report&quot;)) {
<span class="nc bnc" id="L1449" title="All 2 branches missed.">						if (!relatedTo.equals(privRS.getString(&quot;related_to&quot;))) {</span>
<span class="nc" id="L1450">							groupNameList = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L1451">							relatedTo = privRS.getString(&quot;related_to&quot;);</span>
<span class="nc" id="L1452">							privMap.put(relatedTo, groupNameList);</span>
						}
<span class="nc" id="L1454">						groupNameList.add(privRS.getString(&quot;group_name&quot;));</span>
					}
				}
<span class="nc" id="L1457">				interfaceMap.put(serviceRS.getString(&quot;interface&quot;) + &quot;-&quot;</span>
						+ serviceRS.getString(&quot;id&quot;), privMap);
<span class="nc" id="L1459">				headPriviledgeMap.put(serviceRS</span>
						.getString(&quot;service_display_name&quot;), interfaceMap);
<span class="nc" id="L1461">			}</span>

<span class="nc" id="L1463">			return headPriviledgeMap;</span>

<span class="nc" id="L1465">		} catch (SQLException e) {</span>
<span class="nc" id="L1466">			logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L1467">			e.printStackTrace();</span>
<span class="nc" id="L1468">			throw new LMSException(&quot;sqlException&quot;, e);</span>
		} finally {
<span class="nc bnc" id="L1470" title="All 4 branches missed.">			if (con != null) {</span>
				try {
<span class="nc" id="L1472">					con.close();</span>
<span class="nc" id="L1473">				} catch (SQLException e) {</span>
<span class="nc" id="L1474">					logger.error(&quot;Exception: &quot; + e);</span>
					// TODO Auto-generated catch block
<span class="nc" id="L1476">					e.printStackTrace();</span>
<span class="nc" id="L1477">				}</span>
			}
		}

	}

	public Map&lt;String, List&lt;userPrivBean&gt;&gt; getHeadsPriviledges(int userId)
			throws LMSException {

<span class="nc" id="L1486">		Map&lt;String, List&lt;userPrivBean&gt;&gt; headPriviledgeMap = new HashMap&lt;String, List&lt;userPrivBean&gt;&gt;();</span>

		 
<span class="nc" id="L1489">		Connection con = DBConnect.getConnection();</span>
		try {
<span class="nc" id="L1491">			Statement privStmt = con.createStatement();</span>

			// get heads priviledges from role_priv_mapping table
<span class="nc" id="L1494">			String rolePrivQuery = &quot;select pr.pid,pr.priv_title,pr.related_to from user_priv_master upm,priviledge_rep as pr where upm.user_id=&quot;</span>
					+ userId
					+ &quot; and upm.priviledge_rep=pr.pid and upm.status='ACTIVE' order by related_to,item_order&quot;;

<span class="nc" id="L1498">			ResultSet Privrs = privStmt.executeQuery(rolePrivQuery);</span>

			userPrivBean privBean;
<span class="nc" id="L1501">			String oldRelatedTo = &quot;&quot;;</span>
<span class="nc" id="L1502">			List&lt;userPrivBean&gt; titleList = null;</span>
<span class="nc bnc" id="L1503" title="All 2 branches missed.">			while (Privrs.next()) {</span>
<span class="nc bnc" id="L1504" title="All 16 branches missed.">				if (!Privrs.getString(&quot;group_name&quot;).equals(&quot;Miscellaneous&quot;)</span>
						&amp;&amp; !Privrs.getString(&quot;group_name&quot;)
								.equals(&quot;Create Role&quot;)
						&amp;&amp; !Privrs.getString(&quot;group_name&quot;).equals(&quot;Edit Role&quot;)
						&amp;&amp; !Privrs.getString(&quot;group_name&quot;).equals(
								&quot;Add Agent Sub user&quot;)
						&amp;&amp; !Privrs.getString(&quot;group_name&quot;).equals(
								&quot;Edit Agent Sub User Priviledges&quot;)
						&amp;&amp; !Privrs.getString(&quot;Priv_title&quot;).equals(
								&quot;Add BO Sub user&quot;)
						&amp;&amp; !Privrs.getString(&quot;Priv_title&quot;).equals(
								&quot;Edit BO Sub User Priviledges&quot;)
						&amp;&amp; !Privrs.getString(&quot;Priv_title&quot;).equals(
								&quot;User Priviledge Report&quot;)) {
<span class="nc" id="L1518">					String relatedTo = Privrs.getString(&quot;related_to&quot;);</span>
<span class="nc" id="L1519">					privBean = new userPrivBean();</span>
<span class="nc" id="L1520">					privBean.setPid(Privrs.getInt(&quot;pid&quot;));</span>
<span class="nc" id="L1521">					privBean.setPrivTitle(Privrs.getString(&quot;Priv_title&quot;));</span>
<span class="nc" id="L1522">					privBean.setPrivRelatedTo(Privrs.getString(&quot;related_to&quot;));</span>

<span class="nc bnc" id="L1524" title="All 2 branches missed.">					if (&quot;&quot;.equals(oldRelatedTo)) {</span>
<span class="nc" id="L1525">						logger.info(&quot;first time &quot;);</span>
<span class="nc" id="L1526">						titleList = new ArrayList&lt;userPrivBean&gt;();</span>
<span class="nc" id="L1527">						titleList.add(privBean);</span>
<span class="nc" id="L1528">						oldRelatedTo = relatedTo;</span>
<span class="nc bnc" id="L1529" title="All 2 branches missed.">					} else if (!relatedTo.equals(oldRelatedTo)) {</span>
<span class="nc" id="L1530">						headPriviledgeMap.put(oldRelatedTo, titleList);</span>
<span class="nc" id="L1531">						logger.debug(oldRelatedTo + &quot;:: &quot; + titleList.size());</span>
<span class="nc" id="L1532">						titleList = new ArrayList&lt;userPrivBean&gt;();</span>
<span class="nc" id="L1533">						titleList.add(privBean);</span>
<span class="nc" id="L1534">						oldRelatedTo = relatedTo;</span>
					} else {
<span class="nc" id="L1536">						titleList.add(privBean);</span>
<span class="nc" id="L1537">						oldRelatedTo = relatedTo;</span>
					}
<span class="nc bnc" id="L1539" title="All 2 branches missed.">					if (Privrs.isLast()) {</span>
<span class="nc" id="L1540">						headPriviledgeMap.put(oldRelatedTo, titleList);</span>
<span class="nc" id="L1541">						logger.debug(oldRelatedTo + &quot;:: &quot; + titleList.size());</span>
					}
<span class="nc" id="L1543">				}</span>
				// headPriviledgeMap.put(oldRelatedTo, titleList);
				// logger.debug(headPriviledgeMap);
			}

<span class="nc" id="L1548">			return headPriviledgeMap;</span>

<span class="nc" id="L1550">		} catch (SQLException e) {</span>
<span class="nc" id="L1551">			logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L1552">			e.printStackTrace();</span>
<span class="nc" id="L1553">			throw new LMSException(&quot;sqlException&quot;, e);</span>
		} finally {
<span class="nc bnc" id="L1555" title="All 4 branches missed.">			if (con != null) {</span>
				try {
<span class="nc" id="L1557">					con.close();</span>
<span class="nc" id="L1558">				} catch (SQLException e) {</span>
<span class="nc" id="L1559">					logger.error(&quot;Exception: &quot; + e);</span>
					// TODO Auto-generated catch block
<span class="nc" id="L1561">					e.printStackTrace();</span>
<span class="nc" id="L1562">				}</span>
			}
		}

	}

	public Map&lt;String, TreeMap&lt;String, TreeMap&lt;String, List&lt;userPrivBean&gt;&gt;&gt;&gt; getOrgGroupNames(
			int orgId, String orgType) throws LMSException {

		 
<span class="nc" id="L1572">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L1573">		int roleId = 0, tierId = 0;</span>

		// ArrayList&lt;userPrivBean&gt; userPrivList=new ArrayList&lt;userPrivBean&gt;();
<span class="nc" id="L1576">		Map&lt;String, TreeMap&lt;String, TreeMap&lt;String, List&lt;userPrivBean&gt;&gt;&gt;&gt; headPriviledgeMap = new TreeMap&lt;String, TreeMap&lt;String, TreeMap&lt;String, List&lt;userPrivBean&gt;&gt;&gt;&gt;();</span>
		try {
<span class="nc" id="L1578">			Statement stmt = con.createStatement();</span>
			// int userId=getUserIdByuserName(userName);
			// logger.debug(&quot;user id is sss &quot; + userId + &quot;user name is &quot; +
			// userName );
<span class="nc" id="L1582">			String qurery = &quot;select role_id,tier_id from st_lms_role_master where tier_id=(select tier_id from st_lms_tier_master where tier_code='&quot;</span>
					+ orgType + &quot;') and is_master='Y'&quot;;
<span class="nc" id="L1584">			ResultSet roleTierId = stmt.executeQuery(qurery);</span>

<span class="nc bnc" id="L1586" title="All 2 branches missed.">			while (roleTierId.next()) {</span>
<span class="nc" id="L1587">				roleId = roleTierId.getInt(&quot;role_id&quot;);</span>
<span class="nc" id="L1588">				tierId = roleTierId.getInt(&quot;tier_id&quot;);</span>
			}

<span class="nc" id="L1591">			Statement privStmt = con.createStatement();</span>
<span class="nc" id="L1592">			Statement serviceStmt = con.createStatement();</span>

<span class="nc" id="L1594">			String rolePrivQuery = null;</span>
			// String fetchService = &quot;select
			// srm.id,role_id,service_display_name,priv_rep_table,interface
			// from st_lms_service_role_mapping srm,st_lms_service_master sm
			// where srm.status='ACTIVE' and srm.role_id=&quot;+roleId+&quot; and
			// sm.status='ACTIVE' and srm.service_id=sm.service_id&quot;;
<span class="nc" id="L1600">			String fetchService = &quot;select sdm.service_delivery_master_id,sdm.priv_rep_table,sdm.interface,sm.service_display_name from st_lms_service_delivery_master sdm,st_lms_service_master sm,st_lms_service_role_mapping srm where sdm.service_id=sm.service_id and sm.status='ACTIVE' and sdm.status='ACTIVE' and tier_id=&quot;</span>
					+ tierId
					+ &quot; and srm.role_id=&quot;
					+ roleId
					+ &quot; and srm.organization_id=&quot;
					+ orgId
					+ &quot; and srm.status='ACTIVE' and srm.id=sdm.service_delivery_master_id&quot;;
<span class="nc" id="L1607">			ResultSet serviceRS = serviceStmt.executeQuery(fetchService);</span>
<span class="nc" id="L1608">			ResultSet privRS = null;</span>
<span class="nc" id="L1609">			TreeMap&lt;String, TreeMap&lt;String, List&lt;userPrivBean&gt;&gt;&gt; interfaceMap = null;</span>
<span class="nc bnc" id="L1610" title="All 2 branches missed.">			while (serviceRS.next()) {</span>
<span class="nc" id="L1611">				rolePrivQuery = &quot;select distinct(group_name),upm.status,pr.related_to from &quot;</span>
						+ serviceRS.getString(&quot;priv_rep_table&quot;)
						+ &quot; as pr ,st_lms_role_priv_mapping as rpm, st_lms_user_priv_mapping upm where upm.user_id=(select user_id from st_lms_user_master where organization_id=&quot;
						+ orgId
						+ &quot; and isrolehead='Y' and role_id =&quot;
						+ roleId
						+ &quot;) and upm.priv_id=rpm.priv_id and rpm.service_mapping_id=&quot;
						+ serviceRS.getInt(&quot;service_delivery_master_id&quot;)
						+ &quot; and rpm.role_id=&quot;
						+ roleId
						+ &quot; and  rpm.priv_id=pr.priv_id and upm.service_mapping_id=&quot;
						+ serviceRS.getInt(&quot;service_delivery_master_id&quot;)
						+ &quot; and upm.role_id=&quot;
						+ roleId
						+ &quot; and pr.status='ACTIVE' and not pr.hidden &lt;=&gt; 'Y' order by related_to,group_name&quot;;
<span class="nc" id="L1626">				logger.debug(rolePrivQuery);</span>
<span class="nc" id="L1627">				privRS = privStmt.executeQuery(rolePrivQuery);</span>
<span class="nc" id="L1628">				String relatedTo = &quot;&quot;;</span>
				userPrivBean privBean;
<span class="nc" id="L1630">				String oldRelatedTo = &quot;&quot;;</span>
<span class="nc" id="L1631">				List&lt;userPrivBean&gt; groupNameList = null;</span>
<span class="nc bnc" id="L1632" title="All 2 branches missed.">				if (!headPriviledgeMap.containsKey(serviceRS</span>
						.getString(&quot;service_display_name&quot;))) {
<span class="nc" id="L1634">					interfaceMap = new TreeMap&lt;String, TreeMap&lt;String, List&lt;userPrivBean&gt;&gt;&gt;();</span>
				}
<span class="nc" id="L1636">				TreeMap&lt;String, List&lt;userPrivBean&gt;&gt; privMap = new TreeMap&lt;String, List&lt;userPrivBean&gt;&gt;();</span>
<span class="nc bnc" id="L1637" title="All 2 branches missed.">				while (privRS.next()) {</span>
<span class="nc bnc" id="L1638" title="All 14 branches missed.">					if (!privRS.getString(&quot;group_name&quot;).equals(&quot;Miscellaneous&quot;)</span>
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;Create Role&quot;)
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;Edit Role&quot;)
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;BO User Registration&quot;)
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;BO: Edit Role&quot;)
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;BO: Create Role&quot;)
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;BO: Role Head Registration&quot;)) {
<span class="nc" id="L1651">						relatedTo = privRS.getString(&quot;related_to&quot;);</span>
<span class="nc" id="L1652">						privBean = new userPrivBean();</span>
						// privBean.setPid(Privrs.getInt(&quot;pid&quot;));
<span class="nc" id="L1654">						privBean.setPrivTitle(privRS.getString(&quot;group_name&quot;));</span>
<span class="nc" id="L1655">						privBean.setStatus(privRS.getString(&quot;status&quot;));</span>
<span class="nc" id="L1656">						privBean.setPrivRelatedTo(relatedTo);</span>
						// logger.debug(privRS.getString(&quot;group_name&quot;)+&quot;***&quot;+privRS.getString(&quot;status&quot;));
<span class="nc bnc" id="L1658" title="All 2 branches missed.">						if (!relatedTo.equals(oldRelatedTo)) {</span>
<span class="nc" id="L1659">							groupNameList = new ArrayList&lt;userPrivBean&gt;();</span>
<span class="nc" id="L1660">							oldRelatedTo = relatedTo;</span>
<span class="nc" id="L1661">							privMap.put(oldRelatedTo, groupNameList);</span>

						}
<span class="nc" id="L1664">						groupNameList.add(privBean);</span>
					}
				}
<span class="nc" id="L1667">				interfaceMap.put(serviceRS.getString(&quot;interface&quot;) + &quot;-&quot;</span>
						+ serviceRS.getString(&quot;service_delivery_master_id&quot;),
						privMap);
<span class="nc" id="L1670">				headPriviledgeMap.put(serviceRS</span>
						.getString(&quot;service_display_name&quot;), interfaceMap);
<span class="nc" id="L1672">			}</span>
<span class="nc" id="L1673">			logger.debug(&quot;*****headPriviledgeMap****\n&quot; + headPriviledgeMap</span>
					+ &quot;\n********&quot;);
<span class="nc bnc" id="L1675" title="All 2 branches missed.">			if (&quot;RETAILER&quot;.equals(orgType)) {</span>
<span class="nc bnc" id="L1676" title="All 4 branches missed.">				if (ServicesBean.isSLE() &amp;&amp; headPriviledgeMap.get(&quot;Sports Lottery&quot;) != null) {</span>
<span class="nc" id="L1677">					List&lt;PrivilegeDataBean&gt; privilegeList = new ArrayList&lt;PrivilegeDataBean&gt;();</span>
<span class="nc" id="L1678">					RolePrivilegeBean roleBean = null;</span>
					try {
<span class="nc" id="L1680">						roleBean = new RolePrivilegeBean();</span>
<span class="nc" id="L1681">						roleBean.setUserId(Util.fetchUserIdFormOrgId(orgId));</span>
<span class="nc" id="L1682">						NotifySLE notifySLE = new NotifySLE(SLE.Activity.GET_RETAILER_PRIVILEGES, roleBean);</span>
<span class="nc" id="L1683">						roleBean = (RolePrivilegeBean) notifySLE.asyncCall(notifySLE);</span>
<span class="nc" id="L1684">						List&lt;PrivilegeDataBean&gt; tempList = roleBean.getPrivilegeList();</span>
<span class="nc" id="L1685">						ServletActionContext.getRequest().getSession().setAttribute(&quot;SLEPRIV&quot;, roleBean);</span>
<span class="nc" id="L1686">						privilegeList.addAll(tempList);</span>
<span class="nc" id="L1687">					} catch (Exception ex) {</span>
<span class="nc" id="L1688">						ex.printStackTrace();</span>
<span class="nc" id="L1689">					}</span>
<span class="nc" id="L1690">					SLEUtils.editSLEPrivileges(headPriviledgeMap, privilegeList);</span>
				}
			}
<span class="nc" id="L1693">			return headPriviledgeMap;</span>

<span class="nc" id="L1695">		} catch (SQLException e) {</span>
<span class="nc" id="L1696">			logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L1697">			e.printStackTrace();</span>
<span class="nc" id="L1698">			throw new LMSException(&quot;Error During Rollback&quot;, e);</span>
		} finally {
<span class="nc" id="L1700">			try {</span>
<span class="nc bnc" id="L1701" title="All 4 branches missed.">				if (con != null) {</span>
<span class="nc" id="L1702">					con.close();</span>
				}
<span class="nc" id="L1704">			} catch (SQLException se) {</span>
<span class="nc" id="L1705">				logger.error(&quot;Exception: &quot; + se);</span>
<span class="nc" id="L1706">				se.printStackTrace();</span>
<span class="nc" id="L1707">			}</span>
		}

	}

	public String getOrgName(int orgId) throws LMSException {
		 
<span class="nc" id="L1714">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L1715">		String name = null;</span>
		try {
<span class="nc" id="L1717">			PreparedStatement ps = con</span>
					.prepareStatement(&quot;select name from st_lms_organization_master where organization_id = &quot;
							+ orgId);
<span class="nc" id="L1720">			ResultSet rs = ps.executeQuery();</span>
<span class="nc bnc" id="L1721" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L1722">				name = rs.getString(&quot;name&quot;);</span>
			}
<span class="nc" id="L1724">		DBConnect.closeCon(con);</span>
<span class="nc" id="L1725">		} catch (SQLException e) {</span>
<span class="nc" id="L1726">			e.printStackTrace();</span>
<span class="nc" id="L1727">		}</span>
<span class="nc" id="L1728">		return name;</span>
	}

	public Map&lt;String, TreeMap&lt;String, TreeMap&lt;String, List&lt;userPrivBean&gt;&gt;&gt;&gt; getUserGroupNames(
			String userName) throws LMSException {

<span class="nc" id="L1734">		int roleId = 0, userOrgId = 0, userId = 0;</span>
		 
<span class="nc" id="L1736">		Connection con = DBConnect.getConnection();</span>
		// ArrayList&lt;userPrivBean&gt; userPrivList=new ArrayList&lt;userPrivBean&gt;();
<span class="nc" id="L1738">		Map&lt;String, TreeMap&lt;String, TreeMap&lt;String, List&lt;userPrivBean&gt;&gt;&gt;&gt; headPriviledgeMap = new TreeMap&lt;String, TreeMap&lt;String, TreeMap&lt;String, List&lt;userPrivBean&gt;&gt;&gt;&gt;();</span>
		try {
<span class="nc" id="L1740">			Statement stmt = con.createStatement();</span>
<span class="nc" id="L1741">			Statement privStmt = con.createStatement();</span>
<span class="nc" id="L1742">			Statement serviceStmt = con.createStatement();</span>
<span class="nc" id="L1743">			String rolePrivQuery = null;</span>

<span class="nc" id="L1745">			ResultSet userRs = stmt</span>
					.executeQuery(&quot;select user_id,role_id,organization_id,organization_type from st_lms_user_master where user_name='&quot;
							+ userName + &quot;'&quot;);
<span class="nc bnc" id="L1748" title="All 2 branches missed.">			while (userRs.next()) {</span>
<span class="nc" id="L1749">				userId = userRs.getInt(&quot;user_id&quot;);</span>
<span class="nc" id="L1750">				roleId = userRs.getInt(&quot;role_id&quot;);</span>
<span class="nc" id="L1751">				userOrgId = userRs.getInt(&quot;organization_id&quot;);</span>
			}

<span class="nc" id="L1754">			String fetchService = &quot;select srm.id,role_id,interface,service_display_name,priv_rep_table,srm.status from st_lms_service_role_mapping srm,st_lms_service_master sm,st_lms_service_delivery_master sdm where srm.role_id=&quot;</span>
					+ roleId
					+ &quot; and organization_id=&quot;
					+ userOrgId
					+ &quot; and srm.status='ACTIVE' and sm.status='ACTIVE' and sdm.status='ACTIVE' and srm.id=sdm.service_delivery_master_id and sdm.service_id=sm.service_id&quot;;
<span class="nc" id="L1759">			logger.debug(&quot;fetchService====&quot; + fetchService);</span>
<span class="nc" id="L1760">			ResultSet serviceRS = serviceStmt.executeQuery(fetchService);</span>
<span class="nc" id="L1761">			ResultSet privRS = null;</span>
<span class="nc" id="L1762">			TreeMap&lt;String, TreeMap&lt;String, List&lt;userPrivBean&gt;&gt;&gt; interfaceMap = null;</span>
<span class="nc bnc" id="L1763" title="All 2 branches missed.">			while (serviceRS.next()) {</span>
<span class="nc" id="L1764">				rolePrivQuery = &quot;select distinct(group_name),upm.status,pr.related_to from &quot;</span>
						+ serviceRS.getString(&quot;priv_rep_table&quot;)
						+ &quot; as pr ,st_lms_role_priv_mapping as rpm, st_lms_user_priv_mapping upm where upm.user_id=&quot;
						+ userId
						+ &quot; and  (upm.status='ACTIVE' or upm.status='INACTIVE') and upm.priv_id=rpm.priv_id and (rpm.service_mapping_id=&quot;
						+ serviceRS.getString(&quot;id&quot;)
						+ &quot; and upm.service_mapping_id=&quot;
						+ serviceRS.getString(&quot;id&quot;)
						+ &quot;) and (rpm.role_id=&quot;
						+ roleId
						+ &quot; and upm.role_id=&quot;
						+ roleId
						+ &quot;) and  rpm.priv_id=pr.priv_id  and pr.status='ACTIVE'  order by related_to,group_name&quot;;
<span class="nc" id="L1777">				privRS = privStmt.executeQuery(rolePrivQuery);</span>
<span class="nc" id="L1778">				String relatedTo = &quot;&quot;;</span>
				userPrivBean privBean;
<span class="nc" id="L1780">				String oldRelatedTo = &quot;&quot;;</span>
<span class="nc" id="L1781">				List&lt;userPrivBean&gt; groupNameList = null;</span>
<span class="nc bnc" id="L1782" title="All 2 branches missed.">				if (!headPriviledgeMap.containsKey(serviceRS</span>
						.getString(&quot;service_display_name&quot;))) {
<span class="nc" id="L1784">					interfaceMap = new TreeMap&lt;String, TreeMap&lt;String, List&lt;userPrivBean&gt;&gt;&gt;();</span>
				}
<span class="nc" id="L1786">				TreeMap&lt;String, List&lt;userPrivBean&gt;&gt; privMap = new TreeMap&lt;String, List&lt;userPrivBean&gt;&gt;();</span>
				// logger.debug(rolePrivQuery);
<span class="nc bnc" id="L1788" title="All 2 branches missed.">				while (privRS.next()) {</span>
<span class="nc bnc" id="L1789" title="All 14 branches missed.">					if (!privRS.getString(&quot;group_name&quot;).equals(&quot;Miscellaneous&quot;)</span>
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;Create Role&quot;)
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;Edit Role&quot;)
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;BO User Registration&quot;)
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;BO: Edit Role&quot;)
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;BO: Create Role&quot;)
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;BO: Role Head Registration&quot;)) {
<span class="nc" id="L1802">						relatedTo = privRS.getString(&quot;related_to&quot;);</span>
<span class="nc" id="L1803">						privBean = new userPrivBean();</span>
						// privBean.setPid(Privrs.getInt(&quot;pid&quot;));
<span class="nc" id="L1805">						privBean.setPrivTitle(privRS.getString(&quot;group_name&quot;));</span>
<span class="nc" id="L1806">						logger.debug(&quot;Prin Bean*******************: &quot;</span>
								+ privBean.getPrivTitle());
<span class="nc" id="L1808">						privBean.setStatus(privRS.getString(&quot;status&quot;));</span>
<span class="nc" id="L1809">						privBean.setPrivRelatedTo(relatedTo);</span>
						// logger.debug(privRS.getString(&quot;group_name&quot;)+&quot;***&quot;+privRS.getString(&quot;status&quot;));
<span class="nc bnc" id="L1811" title="All 2 branches missed.">						if (!relatedTo.equals(oldRelatedTo)) {</span>
<span class="nc" id="L1812">							groupNameList = new ArrayList&lt;userPrivBean&gt;();</span>
<span class="nc" id="L1813">							oldRelatedTo = relatedTo;</span>
<span class="nc" id="L1814">							privMap.put(oldRelatedTo, groupNameList);</span>

						}
<span class="nc" id="L1817">						groupNameList.add(privBean);</span>
					}
				}

<span class="nc" id="L1821">				interfaceMap.put(serviceRS.getString(&quot;interface&quot;) + &quot;-&quot;</span>
						+ serviceRS.getString(&quot;id&quot;), privMap);
<span class="nc" id="L1823">				headPriviledgeMap.put(serviceRS</span>
						.getString(&quot;service_display_name&quot;), interfaceMap);

<span class="nc" id="L1826">			}</span>

<span class="nc" id="L1828">			logger.debug(&quot;*****headPriviledgeMap****\n&quot; + headPriviledgeMap</span>
					+ &quot;\n********&quot;);
<span class="nc" id="L1830">			return headPriviledgeMap;</span>
<span class="nc" id="L1831">		} catch (SQLException e) {</span>
<span class="nc" id="L1832">			e.printStackTrace();</span>
<span class="nc" id="L1833">			throw new LMSException(&quot;Error During Rollback&quot;, e);</span>
		} finally {
<span class="nc" id="L1835">			try {</span>
<span class="nc bnc" id="L1836" title="All 4 branches missed.">				if (con != null) {</span>
<span class="nc" id="L1837">					con.close();</span>
				}
<span class="nc" id="L1839">			} catch (SQLException se) {</span>
<span class="nc" id="L1840">				logger.error(&quot;Exception: &quot; + se);</span>
<span class="nc" id="L1841">				se.printStackTrace();</span>
<span class="nc" id="L1842">			}</span>
		}

	}

	public Map&lt;String, TreeMap&lt;String, TreeMap&lt;String, List&lt;userPrivBean&gt;&gt;&gt;&gt; getUserPriviledges(
			String userName) throws LMSException {

		 
<span class="nc" id="L1851">		Connection con = DBConnect.getConnection();</span>
		// ArrayList&lt;userPrivBean&gt; userPrivList=new ArrayList&lt;userPrivBean&gt;();
<span class="nc" id="L1853">		Map&lt;String, TreeMap&lt;String, TreeMap&lt;String, List&lt;userPrivBean&gt;&gt;&gt;&gt; headPriviledgeMap = new TreeMap&lt;String, TreeMap&lt;String, TreeMap&lt;String, List&lt;userPrivBean&gt;&gt;&gt;&gt;();</span>
<span class="nc" id="L1854">		int roleId = 0, userOrgId = 0, userId = 0;</span>
		try {
<span class="nc" id="L1856">			Statement stmt = con.createStatement();</span>
<span class="nc" id="L1857">			Statement privStmt = con.createStatement();</span>
<span class="nc" id="L1858">			Statement serviceStmt = con.createStatement();</span>
<span class="nc" id="L1859">			String rolePrivQuery = null;</span>

<span class="nc" id="L1861">			ResultSet userRs = stmt</span>
					.executeQuery(&quot;select user_id,role_id,organization_id,organization_type from st_lms_user_master where user_name='&quot;
							+ userName + &quot;'&quot;);
<span class="nc bnc" id="L1864" title="All 2 branches missed.">			while (userRs.next()) {</span>
<span class="nc" id="L1865">				userId = userRs.getInt(&quot;user_id&quot;);</span>
<span class="nc" id="L1866">				roleId = userRs.getInt(&quot;role_id&quot;);</span>
<span class="nc" id="L1867">				userOrgId = userRs.getInt(&quot;organization_id&quot;);</span>
			}

<span class="nc" id="L1870">			String fetchService = &quot;select srm.id,role_id,interface,service_display_name,priv_rep_table,srm.status from st_lms_service_role_mapping srm,st_lms_service_master sm,st_lms_service_delivery_master sdm where srm.role_id=&quot;</span>
					+ roleId
					+ &quot; and organization_id=&quot;
					+ userOrgId
					+ &quot; and srm.status='ACTIVE' and sm.status='ACTIVE' and sdm.status='ACTIVE' and srm.id=sdm.service_delivery_master_id and sdm.service_id=sm.service_id&quot;;
<span class="nc" id="L1875">			logger.debug(&quot;fetchService====&quot; + fetchService);</span>
<span class="nc" id="L1876">			ResultSet serviceRS = serviceStmt.executeQuery(fetchService);</span>
<span class="nc" id="L1877">			ResultSet privRS = null;</span>
<span class="nc" id="L1878">			TreeMap&lt;String, TreeMap&lt;String, List&lt;userPrivBean&gt;&gt;&gt; interfaceMap = null;</span>
<span class="nc bnc" id="L1879" title="All 2 branches missed.">			while (serviceRS.next()) {</span>
<span class="nc" id="L1880">				rolePrivQuery = &quot;select distinct(group_name),upm.status,pr.related_to from &quot;</span>
						+ serviceRS.getString(&quot;priv_rep_table&quot;)
						+ &quot; as pr ,st_lms_role_priv_mapping as rpm, st_lms_user_priv_mapping upm where upm.user_id=&quot;
						+ userId
						+ &quot; and  (upm.status='ACTIVE' or upm.status='INACTIVE') and upm.priv_id=rpm.priv_id and (rpm.service_mapping_id=&quot;
						+ serviceRS.getString(&quot;id&quot;)
						+ &quot; and upm.service_mapping_id=&quot;
						+ serviceRS.getString(&quot;id&quot;)
						+ &quot;) and (rpm.role_id=&quot;
						+ roleId
						+ &quot; and upm.role_id=&quot;
						+ roleId
						+ &quot;) and  rpm.priv_id=pr.priv_id order by related_to,group_name&quot;;
<span class="nc" id="L1893">				logger.debug(&quot;rolePrivQuery====&quot; + rolePrivQuery);</span>
<span class="nc" id="L1894">				privRS = privStmt.executeQuery(rolePrivQuery);</span>
<span class="nc" id="L1895">				String relatedTo = &quot;&quot;;</span>
				userPrivBean privBean;
<span class="nc" id="L1897">				String oldRelatedTo = &quot;&quot;;</span>
<span class="nc" id="L1898">				List&lt;userPrivBean&gt; groupNameList = null;</span>
<span class="nc bnc" id="L1899" title="All 2 branches missed.">				if (!headPriviledgeMap.containsKey(serviceRS</span>
						.getString(&quot;service_display_name&quot;))) {
<span class="nc" id="L1901">					interfaceMap = new TreeMap&lt;String, TreeMap&lt;String, List&lt;userPrivBean&gt;&gt;&gt;();</span>
				}
<span class="nc" id="L1903">				TreeMap&lt;String, List&lt;userPrivBean&gt;&gt; privMap = new TreeMap&lt;String, List&lt;userPrivBean&gt;&gt;();</span>
				// logger.debug(rolePrivQuery);
<span class="nc bnc" id="L1905" title="All 2 branches missed.">				while (privRS.next()) {</span>
<span class="nc bnc" id="L1906" title="All 14 branches missed.">					if (!privRS.getString(&quot;group_name&quot;).equals(&quot;Miscellaneous&quot;)</span>
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;Create Role&quot;)
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;Edit Role&quot;)
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;BO User Registration&quot;)
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;BO: Edit Role&quot;)
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;BO: Create Role&quot;)
							&amp;&amp; !privRS.getString(&quot;group_name&quot;).equals(
									&quot;BO: Role Head Registration&quot;)) {
<span class="nc" id="L1919">						relatedTo = privRS.getString(&quot;related_to&quot;);</span>
<span class="nc" id="L1920">						privBean = new userPrivBean();</span>
						// privBean.setPid(Privrs.getInt(&quot;pid&quot;));
<span class="nc" id="L1922">						privBean.setPrivTitle(privRS.getString(&quot;group_name&quot;));</span>
<span class="nc" id="L1923">						logger.debug(&quot;Prin Bean*******************: &quot;</span>
								+ privBean.getPrivTitle());
<span class="nc" id="L1925">						privBean.setStatus(privRS.getString(&quot;status&quot;));</span>
<span class="nc" id="L1926">						privBean.setPrivRelatedTo(relatedTo);</span>
						// logger.debug(privRS.getString(&quot;group_name&quot;)+&quot;***&quot;+privRS.getString(&quot;status&quot;));
<span class="nc bnc" id="L1928" title="All 2 branches missed.">						if (!relatedTo.equals(oldRelatedTo)) {</span>
<span class="nc" id="L1929">							groupNameList = new ArrayList&lt;userPrivBean&gt;();</span>
<span class="nc" id="L1930">							oldRelatedTo = relatedTo;</span>
<span class="nc" id="L1931">							privMap.put(oldRelatedTo, groupNameList);</span>

						}
<span class="nc" id="L1934">						groupNameList.add(privBean);</span>
					}
				}

<span class="nc" id="L1938">				interfaceMap.put(serviceRS.getString(&quot;interface&quot;) + &quot;-&quot;</span>
						+ serviceRS.getString(&quot;id&quot;), privMap);
<span class="nc" id="L1940">				headPriviledgeMap.put(serviceRS</span>
						.getString(&quot;service_display_name&quot;), interfaceMap);

<span class="nc" id="L1943">			}</span>

<span class="nc" id="L1945">			logger.debug(&quot;*****headPriviledgeMap****\n&quot; + headPriviledgeMap</span>
					+ &quot;\n********&quot;);
<span class="nc" id="L1947">			return headPriviledgeMap;</span>
<span class="nc" id="L1948">		} catch (SQLException e) {</span>
<span class="nc" id="L1949">			logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L1950">			e.printStackTrace();</span>
<span class="nc" id="L1951">			throw new LMSException(&quot;Error During Rollback&quot;, e);</span>
		} finally {
<span class="nc" id="L1953">			try {</span>
<span class="nc bnc" id="L1954" title="All 4 branches missed.">				if (con != null) {</span>
<span class="nc" id="L1955">					con.close();</span>
				}
<span class="nc" id="L1957">			} catch (SQLException se) {</span>
<span class="nc" id="L1958">				se.printStackTrace();</span>
<span class="nc" id="L1959">			}</span>
		}

	}

	public List getUsers(int roleId, int userId, int orgId) throws LMSException {
		 
<span class="nc" id="L1966">		Connection con = DBConnect.getConnection();</span>
		try {
<span class="nc" id="L1968">			Statement stmt = con.createStatement();</span>
			// Statement stmt1=con.createStatement();
			// con.setAutoCommit(false);
			// get users list for editing from user and user priv mapping table

<span class="nc" id="L1973">			String userQuery = &quot;select distinct um.user_name,um.user_id from st_lms_user_master as um ,st_lms_user_priv_mapping as upm where upm.role_id=&quot;</span>
					+ roleId
					+ &quot; and upm.user_id=um.user_id and um.organization_id=&quot;
					+ orgId + &quot; and um.isrolehead='N' order by um.user_name&quot;;
<span class="nc" id="L1977">			logger.debug(&quot;userQuery: &quot; + userQuery);</span>
<span class="nc" id="L1978">			ResultSet rs = stmt.executeQuery(userQuery);</span>
<span class="nc" id="L1979">			ArrayList&lt;userListBean&gt; userList = new ArrayList&lt;userListBean&gt;();</span>
			userListBean userBean;
<span class="nc bnc" id="L1981" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1982">				userBean = new userListBean();</span>
<span class="nc" id="L1983">				userBean.setUserName(rs.getString(&quot;user_name&quot;));</span>
<span class="nc" id="L1984">				userList.add(userBean);</span>
			}

<span class="nc" id="L1987">			return userList;</span>
<span class="nc" id="L1988">		} catch (SQLException e) {</span>
<span class="nc" id="L1989">			logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L1990">			e.printStackTrace();</span>
<span class="nc" id="L1991">			throw new LMSException(&quot;sql Exception&quot;, e);</span>
		} finally {
<span class="nc bnc" id="L1993" title="All 4 branches missed.">			if (con != null) {</span>
				try {
<span class="nc" id="L1995">					con.close();</span>
<span class="nc" id="L1996">				} catch (SQLException e) {</span>
<span class="nc" id="L1997">					logger.error(&quot;Exception: &quot; + e);</span>
					// TODO Auto-generated catch block
<span class="nc" id="L1999">					e.printStackTrace();</span>
<span class="nc" id="L2000">				}</span>
			}
		}

	}

	public String newUserReg(String userName) throws LMSException {

		 
<span class="nc" id="L2009">		Connection con = DBConnect.getConnection();</span>
		try {

<span class="nc" id="L2012">			Statement stmt = con.createStatement();</span>
<span class="nc" id="L2013">			ResultSet rs = stmt</span>
					.executeQuery(&quot;select user_name from st_lms_user_master where user_name='&quot;
							+ userName + &quot;'&quot;);
<span class="nc bnc" id="L2016" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L2017">				String userNamedb = rs.getString(&quot;user_name&quot;);</span>
<span class="nc bnc" id="L2018" title="All 2 branches missed.">				if (userNamedb.equalsIgnoreCase(userName)) {</span>
<span class="nc" id="L2019">					return &quot;ERROR&quot;;</span>
				}

<span class="nc" id="L2022">			}</span>
<span class="nc bnc" id="L2023" title="All 2 branches missed.">			if(&quot;admin&quot;.equalsIgnoreCase(userName)){</span>
<span class="nc" id="L2024">				return &quot;ERROR&quot;;</span>
			}
			
<span class="nc" id="L2027">			return &quot;SUCCESS&quot;;</span>
<span class="nc" id="L2028">		} catch (SQLException e) {</span>
<span class="nc" id="L2029">			logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L2030">			e.printStackTrace();</span>
<span class="nc" id="L2031">			throw new LMSException(&quot;sqlException&quot;, e);</span>
		} finally {
<span class="nc" id="L2033">			try {</span>
<span class="nc bnc" id="L2034" title="All 8 branches missed.">				if (con != null) {</span>
<span class="nc" id="L2035">					con.close();</span>
				}
<span class="nc" id="L2037">			} catch (SQLException se) {</span>
<span class="nc" id="L2038">				logger.error(&quot;Exception: &quot; + se);</span>
<span class="nc" id="L2039">				se.printStackTrace();</span>
<span class="nc" id="L2040">				throw new LMSException(&quot;sqlException&quot;, se);</span>
<span class="nc" id="L2041">			}</span>
		}

	}
	
	public Map&lt;Integer, String&gt; fetchSLEServiceDeliveryMasterId(int[] mappingId) {
<span class="nc" id="L2047">		Map&lt;Integer, String&gt; sleServiceDeliveryMasterList = new HashMap&lt;Integer, String&gt;();</span>
<span class="nc" id="L2048">		Connection con = null;</span>
<span class="nc" id="L2049">		Statement stmt = null;</span>
<span class="nc" id="L2050">		ResultSet rs = null;</span>
<span class="nc" id="L2051">		String str = &quot;&quot;;</span>

<span class="nc bnc" id="L2053" title="All 2 branches missed.">		for (Integer i : mappingId) {</span>
<span class="nc" id="L2054">			str += i + &quot;,&quot;;</span>
		}
<span class="nc bnc" id="L2056" title="All 2 branches missed.">		if (str.length() &gt; 0)</span>
<span class="nc" id="L2057">			str = str.substring(0, str.length() - 1);</span>

		try {
<span class="nc" id="L2060">			con = DBConnect.getConnection();</span>
<span class="nc" id="L2061">			stmt = con.createStatement();</span>

<span class="nc" id="L2063">			rs = stmt.executeQuery(&quot;select sdm.service_delivery_master_id, sdm.interface from st_lms_service_delivery_master sdm inner join st_lms_service_master sm on sm.service_id = sdm.service_id where sm.service_code = 'SLE' and sdm.service_delivery_master_id in (&quot; + str + &quot;)&quot;);</span>
<span class="nc bnc" id="L2064" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L2065">				sleServiceDeliveryMasterList.put(rs.getInt(&quot;service_delivery_master_id&quot;), rs.getString(&quot;interface&quot;));</span>
			}
<span class="nc" id="L2067">		} catch (SQLException e) {</span>
<span class="nc" id="L2068">			e.printStackTrace();</span>
<span class="nc" id="L2069">		} catch (Exception e) {</span>
<span class="nc" id="L2070">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L2072">			DBConnect.closeCon(con);</span>
<span class="nc" id="L2073">		}</span>
<span class="nc" id="L2074">		return sleServiceDeliveryMasterList;</span>
	}

	public void test() throws SQLException {
		 
<span class="nc" id="L2079">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L2080">		Statement stmt = con.createStatement();</span>
<span class="nc" id="L2081">		Statement stmt1 = con.createStatement();</span>
<span class="nc" id="L2082">		String getPriv = &quot;select action_mapping,pid from priviledge_rep&quot;;</span>
<span class="nc" id="L2083">		ResultSet rs = stmt.executeQuery(getPriv);</span>
<span class="nc bnc" id="L2084" title="All 2 branches missed.">		while (rs.next()) {</span>
<span class="nc" id="L2085">			stmt1.executeUpdate(&quot;update priviledge_rep set pid =&quot;</span>
					+ rs.getInt(&quot;pid&quot;) + &quot; where action_mapping='&quot;
					+ rs.getString(&quot;action_mapping&quot;) + &quot;'&quot;);
		}

<span class="nc" id="L2090">	}</span>

	/*
	 * while (relMapItr.hasNext()) {
	 * 
	 * Map.Entry relMappair = (Map.Entry)relMapItr.next();
	 * 
	 * String related_to = (String)relMappair.getKey();
	 * 
	 * Map privMap = (HashMap)relMappair.getValue();
	 * 
	 * Iterator privMapItr = privMap.entrySet().iterator();
	 * 
	 * while (privMapItr.hasNext()) {
	 * 
	 * Map.Entry privMappair = (Map.Entry)privMapItr.next();
	 * 
	 * String parentPrivId = (String)privMappair.getKey();
	 * 
	 * List parentChildPriv = (ArrayList)privMappair.getValue();
	 * 
	 * Iterator childPrivItr = parentChildPriv.iterator();
	 * 
	 * while (childPrivItr.hasNext()) { } }
	 * 
	 * return related_to_map;
	 */

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>