<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TPBoPwtProcessHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lms</a> &gt; <a href="index.source.html" class="el_package">com.skilrock.lms.api.common</a> &gt; <span class="el_source">TPBoPwtProcessHelper.java</span></div><h1>TPBoPwtProcessHelper.java</h1><pre class="source lang-java linenums">package com.skilrock.lms.api.common;

import java.lang.reflect.Type;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Timestamp;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.List;
import java.util.Map;
import java.util.TreeMap;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import com.google.gson.Gson;
import com.google.gson.JsonElement;
import com.google.gson.reflect.TypeToken;
import com.skilrock.lms.beans.PlayerBean;
import com.skilrock.lms.beans.ServiceRequest;
import com.skilrock.lms.beans.ServiceResponse;
import com.skilrock.lms.beans.UserInfoBean;
import com.skilrock.lms.common.ConfigurationVariables;
import com.skilrock.lms.common.Utility;
import com.skilrock.lms.common.db.DBConnect;
import com.skilrock.lms.common.db.QueryManager;
import com.skilrock.lms.common.exception.LMSException;
import com.skilrock.lms.common.utility.CommonMethods;
import com.skilrock.lms.common.utility.GenerateRecieptNo;
import com.skilrock.lms.coreEngine.drawGames.playMgmt.DrawGameRPOSHelper;
import com.skilrock.lms.coreEngine.drawGames.pwtMgmt.PlayerVerifyHelperForApp;
import com.skilrock.lms.coreEngine.service.IServiceDelegate;
import com.skilrock.lms.coreEngine.service.ServiceDelegate;
import com.skilrock.lms.coreEngine.service.dge.ServiceMethodName;
import com.skilrock.lms.coreEngine.service.dge.ServiceName;
import com.skilrock.lms.dge.beans.DrawIdBean;
import com.skilrock.lms.dge.beans.MainPWTDrawBean;
import com.skilrock.lms.dge.beans.PWTDrawBean;
import com.skilrock.lms.dge.beans.PanelIdBean;
import com.skilrock.lms.web.drawGames.common.Util;

<span class="nc" id="L44">public class TPBoPwtProcessHelper {</span>
<span class="nc" id="L45">	Log logger = LogFactory.getLog(TPBoPwtProcessHelper.class);</span>
	public int getGamenoFromTktnumber(String tktNum) {

<span class="nc" id="L48">		int retIdLen = 0;</span>
<span class="nc" id="L49">		int gameNo = 0;</span>
<span class="nc" id="L50">		int tktLen = 0;</span>
<span class="nc" id="L51">		String tktBuf = null;</span>

<span class="nc bnc" id="L53" title="All 6 branches missed.">		if (tktNum != null</span>
				&amp;&amp; (tktNum.length() == ConfigurationVariables.tktLenA || tktNum
						.length() == ConfigurationVariables.tktLenB)) {
<span class="nc bnc" id="L56" title="All 2 branches missed.">			if (tktNum.length() == ConfigurationVariables.tktLenA) {</span>
<span class="nc" id="L57">				tktLen = ConfigurationVariables.tktLenA;</span>
<span class="nc" id="L58">				retIdLen = ConfigurationVariables.retIdLenA;</span>
<span class="nc" id="L59">				tktBuf = tktNum.substring(retIdLen, retIdLen</span>
						+ ConfigurationVariables.gameNoLenA);
<span class="nc bnc" id="L61" title="All 2 branches missed.">			} else if (tktNum.length() == ConfigurationVariables.tktLenB) {</span>
<span class="nc" id="L62">				tktLen = ConfigurationVariables.tktLenB;</span>
<span class="nc" id="L63">				retIdLen = ConfigurationVariables.retIdLenB;</span>
<span class="nc" id="L64">				tktBuf = tktNum.substring(retIdLen, retIdLen</span>
						+ ConfigurationVariables.gameNoLenB);
			}
<span class="nc" id="L67">			gameNo = Integer.parseInt(tktBuf);</span>
		}
<span class="nc" id="L69">		return gameNo;</span>

	}
	
	public MainPWTDrawBean verifyPwt(MainPWTDrawBean mainPwtBean,
			UserInfoBean userInfoBean, String pwtAmtForMasterApproval, String refMerchantId) {
<span class="nc" id="L75">		ArrayList&lt;PWTDrawBean&gt; winningBeanList = new ArrayList&lt;PWTDrawBean&gt;();</span>
<span class="nc" id="L76">		String ticketNumber =Util.getTicketNumber( mainPwtBean.getTicketNo(), mainPwtBean.getInpType()); </span>
<span class="nc bnc" id="L77" title="All 4 branches missed.">		if(ticketNumber.equals(&quot;ERROR&quot;) || &quot;&quot;.equals(ticketNumber)){</span>
<span class="nc" id="L78">			mainPwtBean.setStatus(&quot;ERROR_INVALID&quot;);</span>
<span class="nc" id="L79">			return mainPwtBean;</span>
		}
<span class="nc" id="L81">		double govtTaxAmount = 0.00;</span>
<span class="nc" id="L82">		double totalticketAmt=0.0;</span>
<span class="nc" id="L83">		int barCodeCount=-1;</span>
		// Get The BarCode If Reqired
<span class="nc bnc" id="L85" title="All 4 branches missed.">		if (mainPwtBean.getInpType() == 1 || mainPwtBean.getTicketNo()</span>
						.length() == com.skilrock.lms.common.ConfigurationVariables.barcodeCount) {
<span class="nc" id="L87">			barCodeCount = Integer</span>
					.parseInt(Util.getBarCodeCountFromTicketNumber(mainPwtBean
							.getTicketNo()));
		}
		// get game number from ticket number
<span class="nc" id="L92">		int gameNo = getGamenoFromTktnumber(ticketNumber);</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">		if (gameNo &lt;= 0) {</span>
<span class="nc" id="L94">			mainPwtBean.setStatus(&quot;ERROR_INVALID&quot;);</span>
<span class="nc" id="L95">			return mainPwtBean;</span>
		}
<span class="nc" id="L97">		mainPwtBean.setMainTktGameNo(gameNo);</span>
<span class="nc" id="L98">		mainPwtBean.setGameId(Util.getGameIdFromGameNumber(gameNo));</span>
		// get game type from ticket type
<span class="nc" id="L100">		String gameType = Util.getGameType(gameNo);</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">		if (gameType == null) {</span>
<span class="nc" id="L102">			mainPwtBean.setStatus(&quot;ERROR_INVALID&quot;);</span>
<span class="nc" id="L103">			return mainPwtBean;</span>
		}	
<span class="nc" id="L105">			mainPwtBean.setPwtTicketType(&quot;DRAW&quot;);</span>
<span class="nc" id="L106">			PWTDrawBean drawScheduleBean = new PWTDrawBean();</span>
<span class="nc" id="L107">			drawScheduleBean.setByPassDates(true);</span>
<span class="nc" id="L108">			drawScheduleBean.setBarCodeCount(barCodeCount);</span>
<span class="nc" id="L109">			drawScheduleBean.setTicketNo(ticketNumber);</span>
<span class="nc" id="L110">			drawScheduleBean.setPartyId(userInfoBean.getUserOrgId());</span>
<span class="nc" id="L111">			drawScheduleBean.setUserId(userInfoBean.getUserId());</span>
<span class="nc" id="L112">			drawScheduleBean.setPartyType(userInfoBean.getUserType());</span>
<span class="nc" id="L113">			drawScheduleBean.setRefMerchantId(refMerchantId);</span>
<span class="nc" id="L114">			drawScheduleBean = verifyTicket(drawScheduleBean,</span>
					userInfoBean, pwtAmtForMasterApproval);
<span class="nc" id="L116">			winningBeanList.add(drawScheduleBean);	</span>
<span class="nc" id="L117">			mainPwtBean.setStatus(drawScheduleBean.getStatus());</span>
<span class="nc" id="L118">			mainPwtBean.setWinningBeanList(winningBeanList);</span>
		// here set  total ticket amount	
<span class="nc bnc" id="L120" title="All 2 branches missed.">			for (int i = 0; i &lt; winningBeanList.size(); i++) {</span>
<span class="nc" id="L121">				PWTDrawBean pwtBean = winningBeanList.get(i);</span>
<span class="nc" id="L122">				govtTaxAmount = govtTaxAmount + pwtBean.getGovtTaxAmount();</span>
<span class="nc" id="L123">				totalticketAmt = totalticketAmt + pwtBean.getTotalAmount();</span>
			}
<span class="nc" id="L125">			mainPwtBean.setTotlticketAmount(totalticketAmt);</span>
<span class="nc" id="L126">			mainPwtBean.setGovtTaxAmount(govtTaxAmount);</span>
<span class="nc" id="L127">		return mainPwtBean;</span>
	}
	
	public PWTDrawBean verifyTicket(PWTDrawBean winningBean,
			UserInfoBean userInfoBean, String pwtAmtForMasterApproval) {
<span class="nc" id="L132">		Connection connection = DBConnect.getConnection();</span>

<span class="nc" id="L134">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L135">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L136">		sReq.setServiceName(ServiceName.PWT_MGMT);</span>
<span class="nc" id="L137">		sReq.setServiceMethod(ServiceMethodName.DRAWGAME_PRZE_WINNING_TICKET);</span>
<span class="nc" id="L138">		sReq.setServiceData(winningBean);</span>

<span class="nc" id="L140">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L141">		boolean isMasAppReq = false;</span>
		try {
<span class="nc" id="L143">			connection.setAutoCommit(false);</span>
<span class="nc" id="L144">			sRes = delegate.getResponse(sReq);</span>
<span class="nc" id="L145">			Type type = new TypeToken&lt;PWTDrawBean&gt;(){}.getType();</span>
<span class="nc" id="L146">			winningBean = (PWTDrawBean)new Gson().fromJson((JsonElement)sRes.getResponseData(), type);</span>
//			winningBean = (PWTDrawBean) sRes.getResponseData();

			//logger.debug(winningBean.isValid() + &quot;************Test***********&quot;); Check
<span class="nc bnc" id="L150" title="All 2 branches missed.">			if (sRes.getIsSuccess()) {</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">				if(Boolean.parseBoolean((String)com.skilrock.lms.common.Utility.getPropertyValue(&quot;DO_MATH_ROUNDING_FOR_PWT_AMT&quot;)))</span>
<span class="nc" id="L152">					CommonMethods.doRoundingForPwtAmt(winningBean);</span>
				// if scheme is panel wise winning
				//	String highPrizeAmt = (String) LMSUtility.sc.getAttribute(&quot;HIGH_PRIZE_AMT&quot;);
				//logger.debug(&quot;HIGH_PRIZE_AMT&quot; + highPrizeAmt); Check
<span class="nc" id="L156">				boolean isUnClaimed=false;</span>
<span class="nc" id="L157">				boolean isDrawExpired = false;</span>
<span class="nc" id="L158">				double totPwtAmt = 0.0;</span>
<span class="nc bnc" id="L159" title="All 2 branches missed."> 				for (DrawIdBean drawIdWinningBean : winningBean</span>
						.getDrawWinList()) {
					
				//	int drawId = drawIdWinningBean.getDrawId();
<span class="nc bnc" id="L163" title="All 2 branches missed.">					if (drawIdWinningBean.getPanelWinList() != null) {</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">						if(drawIdWinningBean.getStatus().equalsIgnoreCase(&quot;UNCLM_PWT&quot;)){</span>
<span class="nc" id="L165">							isUnClaimed=true;</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">						}else if(drawIdWinningBean.getStatus().equals(&quot;DRAW_EXPIRED&quot;)){</span>
<span class="nc" id="L167">							isDrawExpired= true;</span>
						}						
<span class="nc" id="L169">						totPwtAmt= totPwtAmt + Double.parseDouble(drawIdWinningBean.getWinningAmt());						</span>
						
					}
<span class="nc" id="L172">				}</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">				if(isUnClaimed){</span>
<span class="nc" id="L174">					double applicableAmount = Double.parseDouble(Utility.getPropertyValue(&quot;PLAYER_WINNING_TAX_APPLICABLE_AMOUNT&quot;));</span>
<span class="nc" id="L175">					double govtTaxAmount = 0.00;</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">					if(totPwtAmt &gt;= applicableAmount) {</span>
<span class="nc" id="L177">						double govtCommPwt = Util.getGameMasterLMSBean(winningBean.getGameId()).getGovtCommPwt();</span>
<span class="nc" id="L178">						govtTaxAmount = totPwtAmt*govtCommPwt*0.01;</span>
					}

<span class="nc bnc" id="L181" title="All 2 branches missed.">					isMasAppReq = totPwtAmt &gt; Double.parseDouble(pwtAmtForMasterApproval);</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">					if (isMasAppReq) {			</span>
<span class="nc" id="L183">						winningBean.setStatus(&quot;MAS_APP_REQ&quot;);</span>
<span class="nc" id="L184">						winningBean.setTotalAmount(totPwtAmt - govtTaxAmount);</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">					}else if(totPwtAmt&gt;0){</span>
<span class="nc" id="L186">						winningBean.setGameDispName(Util.getGameDisplayName(winningBean.getGameNo()));</span>
<span class="nc" id="L187">						winningBean.setGameId(Util.getGameIdFromGameNumber(winningBean.getGameNo()));</span>
<span class="nc" id="L188">						winningBean.setGovtTaxAmount(govtTaxAmount);</span>
<span class="nc" id="L189">						winningBean.setTotalAmount(totPwtAmt);</span>
<span class="nc" id="L190">						winningBean.setStatus(&quot;SUCCESS&quot;);</span>
					}else{
<span class="nc" id="L192">						winningBean.setGameDispName(Util.getGameDisplayName(winningBean</span>
								.getGameNo()));
<span class="nc" id="L194">						winningBean.setGameId(Util.getGameIdFromGameNumber(winningBean.getGameNo()));</span>
<span class="nc" id="L195">						winningBean.setStatus(&quot;NonWin&quot;);</span>
					}
					
<span class="nc" id="L198">				}else{</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">					if(winningBean.isResAwaited()){</span>
<span class="nc" id="L200">						winningBean.setStatus(&quot;RES_AWAITED&quot;);</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">					}else if (isDrawExpired){</span>
<span class="nc" id="L202">						winningBean.setStatus(&quot;DRAW_EXPIRED&quot;);</span>
					}else{
<span class="nc" id="L204">						winningBean.setStatus(&quot;CLAIMED&quot;);</span>
					}
				}
				

<span class="nc" id="L209">			} else {</span>
				//logger.debug(&quot;inside invalid ticket &quot;); Check
<span class="nc" id="L211">				winningBean.setStatus(&quot;ERROR&quot;);</span>
				//return error from here  Check 

			}
<span class="nc" id="L215">			DBConnect.closeCon(connection);</span>
<span class="nc" id="L216">		} catch (Exception e) {</span>
			//logger.error(&quot;Exception: &quot; + e); CHECK
<span class="nc" id="L218">			e.printStackTrace();</span>
<span class="nc" id="L219">			winningBean.setStatus(&quot;ERROR&quot;);</span>
<span class="nc" id="L220">		}</span>
<span class="nc" id="L221">		return winningBean;</span>
	}
public int playerRegistration(PlayerBean plrInfoBean,boolean isAnonymous,Connection con){
<span class="nc" id="L224">	int playerId=0;</span>
	try{
<span class="nc bnc" id="L226" title="All 4 branches missed.">		if (!isAnonymous &amp;&amp; plrInfoBean != null) {</span>
<span class="nc" id="L227">			playerId = new PlayerVerifyHelperForApp().verifyPlayer(plrInfoBean.getFirstName(),plrInfoBean.getLastName(),plrInfoBean.getIdNumber(),plrInfoBean.getIdType());</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">			if(playerId==0){</span>
				// new Player Info
<span class="nc" id="L230">				playerId = new PlayerVerifyHelperForApp().registerPlayer(</span>
						plrInfoBean, con);
			}
			
<span class="nc bnc" id="L234" title="All 2 branches missed.">		} else if (isAnonymous) {</span>
<span class="nc" id="L235">			playerId = 1; // hard coded for Anonymous player</span>
		}
<span class="nc" id="L237">	}catch(Exception e){</span>
<span class="nc" id="L238">		e.printStackTrace();</span>
		
<span class="nc" id="L240">	}</span>
	
<span class="nc" id="L242">	return playerId;</span>
}	
public MainPWTDrawBean pwtPayment(MainPWTDrawBean  mainPwtDrawBean,Connection con,UserInfoBean userInfoBean,boolean isAnonymous,int playerId,String refTransId,int tpSystemId) throws LMSException {
	try{
<span class="nc" id="L246">		Map pwtAppMap = new TreeMap();</span>
		//int pwtGameNo = 0;
		
<span class="nc" id="L249">		String playerType=null;</span>
<span class="nc" id="L250">		String recIdForApp = GenerateRecieptNo.generateRequestIdDraw(&quot;DGREQUEST&quot;);</span>
<span class="nc" id="L251">		double netPwtAmt = 0.0;</span>
<span class="nc" id="L252">		boolean ispay = false;</span>
<span class="nc" id="L253">		boolean isResAwaited = false;</span>
<span class="nc" id="L254">		PreparedStatement pstmt =null;</span>
<span class="nc" id="L255">		List&lt;Long&gt; transIdList = new ArrayList&lt;Long&gt;();</span>
		//logger.debug(&quot;inside panel wise&quot;);
<span class="nc" id="L257">		List&lt;PWTDrawBean&gt; pwtDrawBeanList = mainPwtDrawBean.getWinningBeanList();</span>

		/*	Tax Deduction	*/
<span class="nc" id="L260">		double taxPercentage = 0.00;</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">		if(mainPwtDrawBean.getGovtTaxAmount() &gt; 0) {</span>
<span class="nc" id="L262">			taxPercentage = Util.getGameMasterLMSBean(mainPwtDrawBean.getGameId()).getGovtCommPwt();</span>
		}

<span class="nc bnc" id="L265" title="All 2 branches missed.">		for (PWTDrawBean pwtDrawBean : pwtDrawBeanList) {</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">			if (pwtDrawBean.isResAwaited())</span>
<span class="nc" id="L267">				isResAwaited = true;</span>
			// pwtGameNo = pwtDrawBean.getGameNo();

<span class="nc bnc" id="L270" title="All 4 branches missed.">			if (pwtDrawBean.getDrawWinList() != null</span>
					&amp;&amp; pwtDrawBean.getDrawWinList().size() &gt; 0) {
<span class="nc bnc" id="L272" title="All 2 branches missed.">				for (DrawIdBean drawIdBean : pwtDrawBean</span>
						.getDrawWinList()) {
<span class="nc bnc" id="L274" title="All 2 branches missed.">					if (drawIdBean.getPanelWinList() != null) {</span>

<span class="nc bnc" id="L276" title="All 2 branches missed.">						for (PanelIdBean panelIdBean : drawIdBean</span>
								.getPanelWinList()) {

<span class="nc bnc" id="L279" title="All 2 branches missed.">							if (panelIdBean.isValid()) {</span>
<span class="nc" id="L280">								int reqToOrgId = 0;</span>
<span class="nc" id="L281">								String reqToOrgType = null;</span>
<span class="nc" id="L282">								String remarks = null;</span>
<span class="nc" id="L283">								String reqStatus = null;</span>
<span class="nc" id="L284">								String approvedByType = null;</span>
<span class="nc" id="L285">								int approvedByUserId = 0;</span>
<span class="nc" id="L286">								int approvedByOrgId = 0;</span>
<span class="nc" id="L287">								logger.debug(&quot;panelIdBean.isValid()====&quot;+ panelIdBean.isValid());</span>
							/*	if (panelIdBean.isAppReq()) {
									// means approval from BO master is
									// required
									// get Back office organization and
									// user id

									reqToOrgId = userInfoBean
											.getParentOrgId();
									reqToOrgType = &quot;BO&quot;;
									remarks = &quot;requested to BO master  For Approval&quot;;
									reqStatus = &quot;PND_MAS&quot;;
									System.out
											.println(&quot;inside if panelIdBean.isAppReq()===&quot;
													+ panelIdBean
															.isAppReq()
													+ remarks
													+ reqStatus);

								} else*/ 
								
<span class="nc bnc" id="L308" title="All 2 branches missed.">							if (!isAnonymous) {</span>
									// go for pending payments
<span class="nc" id="L310">									playerType = &quot;player&quot;; </span>
<span class="nc" id="L311">									reqToOrgId = userInfoBean</span>
											.getUserOrgId();
<span class="nc" id="L313">									reqToOrgType = userInfoBean</span>
											.getUserType();
<span class="nc" id="L315">									remarks = &quot;Auto Approved By BO&quot;;</span>
<span class="nc" id="L316">									reqStatus = &quot;PAID&quot;;</span>
<span class="nc" id="L317">									approvedByType = &quot;BO&quot;;</span>
<span class="nc" id="L318">									approvedByUserId = userInfoBean</span>
											.getUserId();
<span class="nc" id="L320">									approvedByOrgId = reqToOrgId;</span>
<span class="nc" id="L321">									panelIdBean.setStatus(&quot;HIGH_PRIZE&quot;);</span>
<span class="nc" id="L322">									System.out</span>
											.println(&quot;inside else panelIdBean.isAppReq()===&quot;
													+ panelIdBean
															.isAppReq()
													+ remarks
													+ reqStatus);
									
								} else {
<span class="nc" id="L330">									playerType = &quot;anonymous&quot;;</span>
<span class="nc" id="L331">									reqToOrgId = userInfoBean</span>
											.getUserOrgId();
<span class="nc" id="L333">									reqToOrgType = userInfoBean</span>
											.getUserType();
<span class="nc" id="L335">									remarks = &quot;Paid as Anonymous Player&quot;;</span>
<span class="nc" id="L336">									reqStatus = &quot;PAID&quot;;</span>
<span class="nc" id="L337">									approvedByType = &quot;BO&quot;;</span>
<span class="nc" id="L338">									approvedByUserId = userInfoBean</span>
											.getUserId();
<span class="nc" id="L340">									approvedByOrgId = reqToOrgId;</span>
<span class="nc" id="L341">									panelIdBean.setStatus(&quot;NORMAL_PAY&quot;);</span>

								}

<span class="nc" id="L345">								logger.debug(&quot;Approval requested to orgId = &quot;+ reqToOrgId+ &quot;  and user type = &quot;+ reqToOrgType);</span>

								// generate TEMP receipt for Approval
								// GenerateRecieptNo.get

<span class="nc" id="L350">								logger.debug(&quot;^^^^^^^^^***** panel wise &quot;+ panelIdBean.getWinningAmt());</span>

								// insert into Approval table
								/*if (playerType == null) {
									playerType = &quot;anonymous&quot;;
								}*/
								// code added for the case if player is
								// anonymous
								// and no high prize
<span class="nc" id="L359">								String insertAppQuery = &quot;insert into  st_dg_approval_req_master (party_type ,request_id,party_id,ticket_nbr,draw_id,panel_id,game_id,pwt_amt,tax_amt,net_amt,req_status,requester_type,requested_by_user_id,requested_by_org_id,requested_to_org_id,requested_to_type,approved_by_type, approved_by_user_id , approved_by_org_id,pay_req_for_org_type,pay_request_for_org_id,approval_date,request_date, remarks) values(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)&quot;;</span>
<span class="nc" id="L360">								logger.debug(&quot;insertAppQuery = &quot;</span>
										+ insertAppQuery
										+ &quot;@@@@@@@@@@@&quot;
										+ playerType.toUpperCase());
<span class="nc" id="L364">								pstmt = con</span>
										.prepareStatement(insertAppQuery);
<span class="nc" id="L366">								pstmt.setString(1, playerType</span>
										.toUpperCase());
<span class="nc" id="L368">								pstmt.setString(2, recIdForApp);</span>

								/*boolean isPlr = &quot;player&quot;
										.equalsIgnoreCase(playerType
												.trim());
								if (isPlr) {
									pstmt.setInt(3, playerId);
								} else {
									pstmt.setObject(3, null);
								}*/
								
<span class="nc" id="L379">								pstmt.setInt(3, playerId);</span>
								
								// ticket is entered with reprint count
								// in Approval req master on 04/04/2011
<span class="nc" id="L383">								pstmt.setObject(4,pwtDrawBean.getTicketNo()+ pwtDrawBean.getReprintCount());</span>
<span class="nc" id="L384">								pstmt.setInt(5, drawIdBean.getDrawId());</span>
<span class="nc" id="L385">								pstmt.setInt(6, panelIdBean</span>
										.getPanelId());
<span class="nc" id="L387">								pstmt</span>
										.setInt(7, pwtDrawBean
												.getGameId());
<span class="nc" id="L390">								pstmt.setDouble(8, CommonMethods</span>
										.fmtToTwoDecimal(panelIdBean
												.getWinningAmt()));
<span class="nc" id="L393">								pstmt.setDouble(9, 0.0);</span>
<span class="nc" id="L394">								pstmt.setDouble(10, panelIdBean</span>
										.getWinningAmt());
<span class="nc" id="L396">								pstmt.setString(11, reqStatus);</span>
<span class="nc" id="L397">								pstmt.setString(12, userInfoBean</span>
										.getUserType());
<span class="nc" id="L399">								pstmt.setInt(13, userInfoBean</span>
										.getUserId());
<span class="nc" id="L401">								pstmt.setInt(14, userInfoBean</span>
										.getUserOrgId());
<span class="nc" id="L403">								pstmt.setInt(15, reqToOrgId);</span>
<span class="nc" id="L404">								pstmt.setString(16, reqToOrgType);</span>
							/*	if (drawIdBean.isAppReq()) {
									pstmt.setObject(17, null);
									pstmt.setObject(18, null);
									pstmt.setObject(19, null);
									pstmt.setObject(20, null);
									pstmt.setObject(21, null);
									pstmt.setObject(22, null);
								} else {*/
<span class="nc" id="L413">									pstmt.setString(17, approvedByType);</span>
<span class="nc" id="L414">									pstmt.setInt(18, approvedByUserId);</span>
<span class="nc" id="L415">									pstmt.setInt(19, approvedByOrgId);</span>
<span class="nc" id="L416">									pstmt.setString(20, approvedByType);</span>
<span class="nc" id="L417">									pstmt.setInt(21, approvedByOrgId);</span>
<span class="nc" id="L418">								Calendar cal = Calendar.getInstance();</span>
<span class="nc" id="L419">								Timestamp currentDate = null;</span>
<span class="nc" id="L420">								currentDate = new Timestamp(cal.getTime().getTime());	</span>
									
<span class="nc" id="L422">								pstmt.setTimestamp(22,currentDate);</span>
								//}
<span class="nc" id="L424">								pstmt.setTimestamp(23,currentDate);</span>
<span class="nc" id="L425">								pstmt.setString(24, remarks);</span>
<span class="nc" id="L426">								logger.debug(&quot;insertAppQuery pppppp = &quot;</span>
										+ pstmt);
<span class="nc" id="L428">								pstmt.executeUpdate();</span>

<span class="nc" id="L430">								System.out</span>
										.println(&quot;insertion into pwt temp request  table = &quot;
												+ pstmt);
<span class="nc" id="L433">								ResultSet rs = pstmt.getGeneratedKeys();</span>
<span class="nc" id="L434">								int reqId = 0;</span>
<span class="nc bnc" id="L435" title="All 2 branches missed.">								if (rs.next()) {</span>
<span class="nc" id="L436">									reqId = rs.getInt(1);</span>
								} else {
<span class="nc" id="L438">									throw new LMSException(</span>
											&quot;NO Data Inserted in st_pwt_approval_request_master table&quot;);
								}

								// insert in draw pwt inv table
<span class="nc bnc" id="L443" title="All 2 branches missed.">								if (reqStatus!=null) {</span>
<span class="nc" id="L444">									reqStatus = &quot;CLAIM_PLR_BO&quot;;</span>
								}
<span class="nc" id="L446">								System.out.println(&quot;@@@@new status is&quot;+ reqStatus);</span>
<span class="nc" id="L447">								String insIntoDGPwtInvQuery = &quot;insert into st_dg_pwt_inv_?(ticket_nbr, draw_id,panel_id, pwt_amt, status,is_direct_plr) values (?, ?, ?, ?, ?,?)&quot;;</span>
<span class="nc" id="L448">								PreparedStatement insIntoDGPwtInvPstmt = con</span>
										.prepareStatement(insIntoDGPwtInvQuery);
<span class="nc" id="L450">								insIntoDGPwtInvPstmt.setInt(1,</span>
										pwtDrawBean.getGameId());
<span class="nc" id="L452">								insIntoDGPwtInvPstmt.setString(2,</span>
										pwtDrawBean.getTicketNo());
<span class="nc" id="L454">								insIntoDGPwtInvPstmt.setInt(3,</span>
										drawIdBean.getDrawId());
<span class="nc" id="L456">								insIntoDGPwtInvPstmt.setInt(4,</span>
										panelIdBean.getPanelId());
<span class="nc" id="L458">								insIntoDGPwtInvPstmt</span>
										.setDouble(
												5,
												CommonMethods
														.fmtToTwoDecimal(panelIdBean
																.getWinningAmt()));
<span class="nc" id="L464">								insIntoDGPwtInvPstmt.setString(6,</span>
										reqStatus);
<span class="nc" id="L466">								insIntoDGPwtInvPstmt.setString(7, &quot;Y&quot;);</span>
<span class="nc" id="L467">								insIntoDGPwtInvPstmt.executeUpdate();</span>
<span class="nc" id="L468">								netPwtAmt = netPwtAmt</span>
										+ CommonMethods
												.fmtToTwoDecimal(panelIdBean
														.getWinningAmt());

<span class="nc bnc" id="L473" title="All 2 branches missed.">								if ( reqStatus!=null) {</span>
<span class="nc" id="L474">									logger.info(&quot;is  payin as anonymous::::&quot;+isAnonymous+&quot;reqStatus &quot;+reqStatus);</span>
									// tax=0.0,chequeNbr=null,draweeBank=null,issuingParty=null,chqDate=null,paymentType=CASH
									// hard coded for anonymous player
<span class="nc" id="L477">									double tax = panelIdBean.getWinningAmt()*taxPercentage*0.01;</span>
<span class="nc" id="L478">									long transId = boDirectPlrPwtPayment(</span>
											pwtDrawBean.getTicketNo(),
											drawIdBean.getDrawId(),
											playerId,
											CommonMethods.fmtToTwoDecimal(panelIdBean.getWinningAmt()),
											tax,
											//CommonMethods.fmtToTwoDecimal(panelIdBean.getGovtCommPwt()),
											reqId,
											null,
											null,
											null,
											null,
											&quot;CASH&quot;,
											userInfoBean.getUserOrgId(),
											userInfoBean.getUserId(),
											pwtDrawBean.getGameNo(),
											pwtDrawBean.getGameId(),
											con, panelIdBean
													.getPanelId(),
											&quot;PANEL_WISE&quot;);
<span class="nc bnc" id="L498" title="All 2 branches missed.">									if (transId &gt; 0) {</span>
<span class="nc" id="L499">										String updateAppTable = &quot;update  st_dg_approval_req_master  set  payment_done_by_type =?, payment_done_by =? ,transaction_id=? where  task_id = ?&quot;;</span>
<span class="nc" id="L500">										PreparedStatement pstmt1 = con</span>
												.prepareStatement(updateAppTable);
<span class="nc" id="L502">										pstmt1.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L503">										pstmt1.setInt(2, userInfoBean</span>
												.getUserOrgId());
<span class="nc" id="L505">										pstmt1.setLong(3, transId);</span>
<span class="nc" id="L506">										pstmt1.setInt(4, reqId);</span>
<span class="nc" id="L507">										logger</span>
												.debug(&quot;update  st_dg_approval_req_master Query::::&quot;
														+ pstmt);
<span class="nc" id="L510">										pstmt1.executeUpdate();</span>
<span class="nc" id="L511">										transIdList.add(transId);</span>
										// store ref Trans Id
<span class="nc" id="L513">										TpUtilityHelper.storeTpSystemTxnId(tpSystemId,transId+&quot;&quot;, refTransId, con);</span>
<span class="nc" id="L514">										ispay=true;</span>
<span class="nc" id="L515">									}else{</span>
<span class="nc" id="L516">										logger</span>
										.debug(&quot;Error In Transaction At LMS End&quot;);
<span class="nc" id="L518">										throw new LMSException(&quot;Error At LMS End&quot;);</span>
										
									}
								}

							}

<span class="nc" id="L525">						}</span>

					}
<span class="nc" id="L528">				}</span>
				// }

<span class="nc bnc" id="L531" title="All 2 branches missed.">				if (ispay) {</span>
					// Draw Game Updation of Ticket
<span class="nc" id="L533">					ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L534">					ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L535">					sReq.setServiceName(ServiceName.PWT_MGMT);</span>
					// sReq.setServiceMethod(ServiceMethodName.DRAWGAME_PWT_UPDATE);
<span class="nc" id="L537">					IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc bnc" id="L538" title="All 2 branches missed.">					if(!isAnonymous){</span>
<span class="nc" id="L539">						pwtDrawBean.setStatus(&quot;REGISTRATION&quot;);</span>
					}else{
<span class="nc" id="L541">						pwtDrawBean.setStatus(&quot;NORMAL_PAY&quot;);</span>
					}
					
<span class="nc" id="L544">					sReq</span>
							.setServiceMethod(ServiceMethodName.DRAWGAME_PWT_UPDATE);
<span class="nc" id="L546">					sReq.setServiceData(pwtDrawBean);</span>
<span class="nc" id="L547">					sRes = delegate.getResponse(sReq);</span>
<span class="nc bnc" id="L548" title="All 2 branches missed.">					if (sRes.getIsSuccess()) {</span>
						// connection.commit();

						// generete temp receipt here
						/*
						 * GraphReportHelper graphReportHelper = new
						 * GraphReportHelper();graphReportHelper.
						 * createTextReportTempPlayerReceipt(
						 * recIdForApp, &quot;BO&quot;, rootPath, &quot;DRAW_GAME&quot;);
						 */
						// connection.close();
<span class="nc" id="L559">						pwtDrawBean.setStatus(&quot;SUCCESS&quot;);</span>
						
<span class="nc bnc" id="L561" title="All 4 branches missed.">						if (isResAwaited &amp;&amp; netPwtAmt &gt; 0) {</span>
<span class="nc" id="L562">							DrawGameRPOSHelper helper = new DrawGameRPOSHelper();</span>
<span class="nc" id="L563">							int len = mainPwtDrawBean.getTicketNo().length();</span>
<span class="nc" id="L564">							Object gameBean = helper.reprintTicket(userInfoBean, true,</span>
									mainPwtDrawBean.getTicketNo().substring(0, len - 2),
									false,null,null);
<span class="nc" id="L567">							mainPwtDrawBean.setPurchaseBean(gameBean);</span>
<span class="nc" id="L568">							mainPwtDrawBean.setReprint(true);</span>
						}
						
										
<span class="nc" id="L572">						con.commit();</span>
						// set Trnas IDs 
<span class="nc" id="L574">						mainPwtDrawBean.setTransactionIdList(transIdList);</span>
<span class="nc" id="L575">						mainPwtDrawBean.setRefNumber(recIdForApp);// set Request Id</span>
<span class="nc" id="L576">						mainPwtDrawBean.setPwtStatus(&quot;SUCCESS&quot;);</span>
<span class="nc" id="L577">						return mainPwtDrawBean;</span>
						
						
					} else {
<span class="nc" id="L581">						System.out</span>
								.println(&quot;***************************^^^^^^^^^^inside error while updating draw game &quot;);
<span class="nc" id="L583">						con.close();</span>
<span class="nc" id="L584">						mainPwtDrawBean.setPwtStatus(&quot;ERROR&quot;);</span>
<span class="nc" id="L585">						pwtDrawBean.setStatus(&quot;ERROR&quot;);</span>
<span class="nc" id="L586">						throw new LMSException(</span>
								&quot;Pwt not updated in DGE...&quot;);
					}
				}
			}
		
			
			
			
			/*pwtAppMap.put(&quot;recId&quot;, recIdForApp);
				// pwtAppMap.put(&quot;PWT_RES_BEAN&quot;, pwtDrawBean);// added by amit
			pwtAppMap.put(&quot;PWT_RES_BEAN&quot;, mainPwtDrawBean);
			pwtAppMap.put(&quot;GAME_NAME&quot;, Util.getGameName(pwtGameNo)
						.toUpperCase()
						+ &quot;_PWT&quot;);
			pwtAppMap.put(&quot;isAnonymous&quot;, isAnonymous);
			pwtAppMap.put(&quot;NET_AMOUNT_PAID&quot;, netPwtAmt);*/
				// pwtAppMap.put(&quot;reqId&quot;, reqId);
				// pwtAppMap.putAll(pwtDetails);///////tttttttttttttttttt
				// pwtAppMap.put(&quot;remarks&quot;, remarks);

				// now generate temporary receipt for player
				// GraphReportHelper graphHelpwr=new GraphReportHelper();
				// graphHelpwr.createTextReportTempPlayerReceipt(reqId,&quot;BO&quot;,
				// rootPath);
			
			
		
<span class="nc" id="L614">		}</span>
	
				
<span class="nc" id="L617">	}catch(Exception e){</span>
<span class="nc" id="L618">		e.printStackTrace();</span>
<span class="nc" id="L619">		mainPwtDrawBean.setPwtStatus(&quot;ERROR&quot;);</span>
<span class="nc" id="L620">		throw new LMSException(&quot;Error In Pwt Payment&quot;);</span>
		
<span class="nc" id="L622">	} </span>
<span class="nc" id="L623">	return mainPwtDrawBean;	</span>

}


public long boDirectPlrPwtPayment(String ticketNbr, int drawId,
		int playerId, double pwtAmt, double tax, int taskId,
		String chequeNbr, String draweeBank, String issuingParty,
		java.sql.Date chqDate, String paymentType, int userOrgId,
		int userId, int gameNbr, int gameId, Connection connection,
		Object panelId, String schemeType) throws LMSException {
	try {

		// insert data into main transaction master
<span class="nc" id="L637">		logger.debug(&quot;insert data into transaction master &quot;);</span>
<span class="nc" id="L638">		String transMasQuery = QueryManager.insertInLMSTransactionMaster();</span>
<span class="nc" id="L639">		PreparedStatement pstmt = connection</span>
				.prepareStatement(transMasQuery);
<span class="nc" id="L641">		pstmt.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L642">		pstmt.executeUpdate();</span>
<span class="nc" id="L643">		ResultSet rs = pstmt.getGeneratedKeys();</span>

<span class="nc bnc" id="L645" title="All 2 branches missed.">		if (rs.next()) {</span>
<span class="nc" id="L646">			long transId = rs.getLong(1);</span>
			// double pwtAmt = Double.parseDouble(bean.getPwtAmount());
			// DGDirectPlrPwtBean dirPlrBean = (DGDirectPlrPwtBean) bean;

			// insert in st_bo_transaction master
<span class="nc" id="L651">			pstmt = connection.prepareStatement(QueryManager</span>
					.insertInBOTransactionMaster());
<span class="nc" id="L653">			pstmt.setLong(1, transId);</span>
<span class="nc" id="L654">			pstmt.setInt(2, userId);</span>
<span class="nc" id="L655">			pstmt.setInt(3, userOrgId);	</span>
<span class="nc" id="L656">			pstmt.setString(4, &quot;PLAYER&quot;);</span>
<span class="nc" id="L657">			pstmt.setInt(5, playerId);</span>
<span class="nc" id="L658">			pstmt.setTimestamp(6, new java.sql.Timestamp(</span>
					new java.util.Date().getTime()));
<span class="nc" id="L660">			pstmt.setString(7, &quot;DG_PWT_PLR&quot;);</span>
<span class="nc" id="L661">			pstmt.executeUpdate();</span>
<span class="nc" id="L662">			logger.debug(&quot;insert into BO transaction master = &quot; + pstmt);</span>

<span class="nc" id="L664">			String directPlrPayment = &quot;insert into st_dg_bo_direct_plr_pwt (bo_user_id, &quot;</span>
					+ &quot;bo_org_id, draw_id, transaction_id, transaction_date, game_id, player_id,&quot;
					+ &quot; pwt_amt, tax_amt, net_amt, payment_type, cheque_nbr, cheque_date, drawee_bank,&quot;
					+ &quot; issuing_party_name, task_id,panel_id ) values (?, ?, ?, ?, ?,?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?,?)&quot;;
<span class="nc" id="L668">			pstmt = connection.prepareStatement(directPlrPayment);</span>
<span class="nc" id="L669">			pstmt.setInt(1, userId);</span>
<span class="nc" id="L670">			pstmt.setInt(2, userOrgId);</span>
<span class="nc" id="L671">			pstmt.setInt(3, drawId);</span>
<span class="nc" id="L672">			pstmt.setLong(4, transId);</span>
<span class="nc" id="L673">			pstmt.setTimestamp(5, new java.sql.Timestamp(</span>
					new java.util.Date().getTime()));
<span class="nc" id="L675">			pstmt.setInt(6, gameId);</span>
<span class="nc" id="L676">			pstmt.setInt(7, playerId);</span>
<span class="nc" id="L677">			pstmt.setDouble(8, pwtAmt);</span>
<span class="nc" id="L678">			pstmt.setDouble(9, tax);</span>
<span class="nc" id="L679">			pstmt.setDouble(10, pwtAmt - tax);</span>
<span class="nc" id="L680">			pstmt.setString(11, paymentType);</span>

<span class="nc bnc" id="L682" title="All 4 branches missed.">			if (&quot;cash&quot;.equalsIgnoreCase(paymentType)</span>
					|| &quot;TPT&quot;.equalsIgnoreCase(paymentType)) {
<span class="nc" id="L684">				pstmt.setObject(12, null);</span>
<span class="nc" id="L685">				pstmt.setObject(13, null);</span>
<span class="nc" id="L686">				pstmt.setObject(14, null);</span>
<span class="nc" id="L687">				pstmt.setObject(15, null);</span>
<span class="nc bnc" id="L688" title="All 2 branches missed.">			} else if (&quot;cheque&quot;.equalsIgnoreCase(paymentType)) {</span>
<span class="nc" id="L689">				pstmt.setString(12, chequeNbr);</span>
<span class="nc" id="L690">				pstmt.setDate(13, chqDate);</span>
<span class="nc" id="L691">				pstmt.setString(14, draweeBank);</span>
<span class="nc" id="L692">				pstmt.setString(15, issuingParty);</span>
			}
			// pstmt.setString(12, chequeNbr);
			// pstmt.setDate(13, chqDate);
			// pstmt.setString(14, draweeBank);
			// pstmt.setString(15, issuingParty);
<span class="nc" id="L698">			pstmt.setInt(16, taskId);</span>
<span class="nc" id="L699">			pstmt.setObject(17, panelId);</span>
<span class="nc" id="L700">			pstmt.executeUpdate();</span>
<span class="nc" id="L701">			logger.debug(&quot;insert into st_dg_bo_direct_plr_pwt = &quot; + pstmt);</span>

			// update ticket details into st_dg_pwt_inv_? table
<span class="nc" id="L704">			String insIntoDGPwtInvQuery = null;</span>
<span class="nc bnc" id="L705" title="All 2 branches missed.">			if (&quot;DRAW_WISE&quot;.equalsIgnoreCase(schemeType.trim())) {</span>
<span class="nc" id="L706">				insIntoDGPwtInvQuery = &quot;update st_dg_pwt_inv_? set status = ? ,  bo_transaction_id = ? &quot;</span>
						+ &quot; where ticket_nbr = ? and draw_id = ?&quot;;
			} else {
<span class="nc" id="L709">				insIntoDGPwtInvQuery = &quot;update st_dg_pwt_inv_? set status = ? ,  bo_transaction_id = ? &quot;</span>
						+ &quot; where ticket_nbr = ? and draw_id = ? and panel_id=&quot;
						+ panelId;
			}
<span class="nc" id="L713">			PreparedStatement insIntoDGPwtInvPstmt = connection</span>
					.prepareStatement(insIntoDGPwtInvQuery);
<span class="nc" id="L715">			insIntoDGPwtInvPstmt.setInt(1, gameNbr);</span>
<span class="nc" id="L716">			insIntoDGPwtInvPstmt.setString(2, &quot;CLAIM_PLR_BO&quot;);</span>
<span class="nc" id="L717">			insIntoDGPwtInvPstmt.setLong(3, transId);</span>
<span class="nc" id="L718">			insIntoDGPwtInvPstmt.setString(4, ticketNbr);</span>
<span class="nc" id="L719">			insIntoDGPwtInvPstmt.setInt(5, drawId);</span>
<span class="nc" id="L720">			logger.debug(&quot;insIntoDGPwtInvPstmt = &quot; + insIntoDGPwtInvPstmt);</span>
<span class="nc" id="L721">			insIntoDGPwtInvPstmt.executeUpdate();</span>

			// receipt entries are required to be inserted into receipt
			// table
<span class="nc" id="L725">			return transId;</span>

		} else {
<span class="nc" id="L728">			throw new LMSException(</span>
					&quot;no data insert into main transaction master&quot;);
		}

<span class="nc" id="L732">	} catch (SQLException e) {</span>
<span class="nc" id="L733">		logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L734">		e.printStackTrace();</span>
<span class="nc" id="L735">		throw new LMSException(e);</span>
	}

}
	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>