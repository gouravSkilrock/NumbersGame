<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ConsNNonConsInvHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lms</a> &gt; <a href="index.source.html" class="el_package">com.skilrock.lms.coreEngine.inventoryMgmt</a> &gt; <span class="el_source">ConsNNonConsInvHelper.java</span></div><h1>ConsNNonConsInvHelper.java</h1><pre class="source lang-java linenums">package com.skilrock.lms.coreEngine.inventoryMgmt;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.FileReader;
import java.io.IOException;
import java.sql.Blob;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.sql.Timestamp;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Set;
import java.util.TreeMap;
import java.util.TreeSet;

import javax.swing.text.html.HTMLDocument.HTMLReader.PreAction;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.quartz.utils.DBConnectionManager;

import com.skilrock.lms.api.lmsWrapper.common.WrapperUtility;
import com.skilrock.lms.beans.ConsNNonConsBean;
import com.skilrock.lms.beans.InvDetailBean;
import com.skilrock.lms.beans.UserInfoBean;
import com.skilrock.lms.common.db.DBConnect;
import com.skilrock.lms.common.db.QueryManager;
import com.skilrock.lms.common.db.TableConstants;
import com.skilrock.lms.common.exception.LMSException;
import com.skilrock.lms.common.filter.LMSFilterDispatcher;
import com.skilrock.lms.common.utility.GenerateRecieptNo;
import com.skilrock.lms.common.exception.LMSErrors;

<span class="nc" id="L46">public class ConsNNonConsInvHelper {</span>

<span class="nc" id="L48">	static Log logger = LogFactory.getLog(ConsNNonConsInvHelper.class);</span>

	public String addNewBrandDetails(int[] invIdForBrand,
			String[] newBrandName, String[] newBrandDesc) throws LMSException {

<span class="nc" id="L53">		StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L54">		StringBuilder sb1 = new StringBuilder();</span>
<span class="nc" id="L55">		logger.debug(&quot;\n newBrandName = &quot; + newBrandName + &quot;\n inv Id = &quot;</span>
				+ invIdForBrand + &quot;\n newBrandDesc = &quot; + newBrandDesc);

<span class="nc bnc" id="L58" title="All 6 branches missed.">		if (newBrandName != null &amp;&amp; newBrandDesc != null</span>
				&amp;&amp; invIdForBrand != null) {

<span class="nc" id="L61">			logger.debug(&quot; newBrandName size = &quot; + newBrandName.length</span>
					+ &quot;, newBrandDesc size = &quot; + newBrandDesc.length
					+ &quot;, invIdForBrand size = &quot; + invIdForBrand.length);

<span class="nc" id="L65">			Connection connection = DBConnect.getConnection();</span>
			try {
<span class="nc" id="L67">				connection.setAutoCommit(false);</span>
<span class="nc" id="L68">				String addNewInvQuery = &quot;insert into st_lms_inv_brand_master(brand_name, inv_id, brand_desc) values(?, ?, ?)&quot;;</span>
<span class="nc" id="L69">				PreparedStatement pstmt = connection</span>
						.prepareStatement(addNewInvQuery);

<span class="nc" id="L72">				PreparedStatement vpstmt = connection</span>
						.prepareStatement(&quot;select * from st_lms_inv_brand_master where inv_id=? and brand_name = ?&quot;);
<span class="nc" id="L74">				ResultSet rs = null;</span>

<span class="nc" id="L76">				int rowCount = 0;</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">				for (int i = 0, l = newBrandName.length; i &lt; l; i++) {</span>
<span class="nc" id="L78">					logger.debug(&quot;newBrandName = &quot; + newBrandName[i]</span>
							+ &quot;; newBrandDesc = &quot; + newBrandDesc[i]
							+ &quot;; inv Id = &quot; + invIdForBrand[i]);

<span class="nc bnc" id="L82" title="All 4 branches missed.">					if (!&quot;&quot;.equals(newBrandName[i].trim())</span>
							&amp;&amp; invIdForBrand[i] &gt; 0) {

<span class="nc" id="L85">						vpstmt.setInt(1, invIdForBrand[i]);</span>
<span class="nc" id="L86">						vpstmt.setString(2, newBrandName[i].trim());</span>
<span class="nc" id="L87">						rs = vpstmt.executeQuery();</span>
<span class="nc" id="L88">						rowCount = 0;</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">						if (!rs.next()) {</span>
							try {
<span class="nc" id="L91">								pstmt.setString(1, newBrandName[i].trim());</span>
<span class="nc" id="L92">								pstmt.setInt(2, invIdForBrand[i]);</span>
<span class="nc" id="L93">								pstmt.setString(3, newBrandDesc[i].trim());</span>
<span class="nc" id="L94">								rowCount = pstmt.executeUpdate();</span>
<span class="nc" id="L95">							} catch (SQLException e) {</span>
<span class="nc" id="L96">								e.printStackTrace();</span>
<span class="nc" id="L97">							}</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">							if (rowCount &gt; 0) {</span>
<span class="nc" id="L99">								logger.debug(&quot;Total row inserted is = &quot;</span>
										+ rowCount);
<span class="nc" id="L101">								sb.append(newBrandName[i].trim()).append(&quot;;&quot;);</span>
							} else {
<span class="nc" id="L103">								sb1.append(newBrandName[i].trim()).append(&quot;;&quot;);</span>
<span class="nc" id="L104">								throw new LMSException(</span>
										&quot;Row is not inserted for &quot;
												+ newBrandName[i].trim());
							}
						} else {
<span class="nc" id="L109">							sb1.append(newBrandName[i].trim()).append(&quot;;&quot;);</span>
<span class="nc" id="L110">							logger.debug(&quot;Row is not inserted for 111&quot;</span>
									+ newBrandName[i].trim());
						}

					}
				}

<span class="nc" id="L117">				connection.commit();</span>
<span class="nc" id="L118">			} catch (SQLException e) {</span>
<span class="nc" id="L119">				e.printStackTrace();</span>
<span class="nc" id="L120">				throw new LMSException(e);</span>
			} finally {
<span class="nc" id="L122">				try {</span>
<span class="nc" id="L123">					connection.close();</span>
<span class="nc" id="L124">				} catch (SQLException e) {</span>
<span class="nc" id="L125">					e.printStackTrace();</span>
<span class="nc" id="L126">					throw new LMSException(e);</span>
<span class="nc" id="L127">				}</span>
			}

		}
<span class="nc" id="L131">		String invListStr = sb.toString();</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">		if (&quot;&quot;.equals(invListStr)) {</span>
<span class="nc" id="L133">			return &quot;NO Brand &quot; + &quot;||&quot; + sb1.toString();</span>
		} else {
<span class="nc" id="L135">			return invListStr + &quot;||&quot; + sb1.toString();</span>
		}

	}

	/**
	 * This Method is Used to Add new Inventory type and Their Brand and Model.
	 * for Consumable or Non Consumable Devices.
	 */
	public String addNewInvDetails(String invType, String[] newInvName,
			String[] newInvDesc, String[] img) throws LMSException {

<span class="nc" id="L147">		StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L148">		StringBuilder sb1 = new StringBuilder();</span>
<span class="nc" id="L149">		logger.debug(&quot;invType = &quot; + invType + &quot;\n newInvName = &quot; + newInvName</span>
				+ &quot;\n newInvDesc = &quot; + newInvDesc);

<span class="nc bnc" id="L152" title="All 6 branches missed.">		if (newInvName != null &amp;&amp; newInvDesc != null &amp;&amp; img != null) {</span>
<span class="nc" id="L153">			logger.debug(&quot; newInvName size = &quot; + newInvName.length</span>
					+ &quot;, newInvDesc size = &quot; + newInvDesc.length);

<span class="nc" id="L156">			Connection connection = DBConnect.getConnection();</span>

			try {
<span class="nc" id="L159">				connection.setAutoCommit(false);</span>
<span class="nc" id="L160">				String addNewInvQuery = &quot;insert into st_lms_inv_master(inv_name, inv_type, inv_img, inv_desc) values(?, ?, ?, ?)&quot;;</span>
<span class="nc" id="L161">				PreparedStatement pstmt = connection</span>
						.prepareStatement(addNewInvQuery);
<span class="nc" id="L163">				PreparedStatement vpstmt = connection</span>
						.prepareStatement(&quot;select * from st_lms_inv_master where inv_type=? and inv_name = ?&quot;);
<span class="nc" id="L165">				ResultSet rs = null;</span>

<span class="nc" id="L167">				int rowCount = 0;</span>
<span class="nc" id="L168">				File imgFile = null;</span>
<span class="nc" id="L169">				FileInputStream fin = null;</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">				for (int i = 0, l = newInvName.length; i &lt; l; i++) {</span>
<span class="nc" id="L171">					logger.debug(&quot;newInvName = &quot; + newInvName[i]</span>
							+ &quot;; newInvDesc = &quot; + newInvDesc[i]
							+ &quot;; inv Image = &quot; + img[i]);

<span class="nc bnc" id="L175" title="All 2 branches missed.">					if (!&quot;&quot;.equals(newInvName[i].trim())) {</span>
<span class="nc" id="L176">						vpstmt.setString(1, invType.trim());</span>
<span class="nc" id="L177">						vpstmt.setString(2, newInvName[i].trim());</span>
<span class="nc" id="L178">						rs = vpstmt.executeQuery();</span>
<span class="nc" id="L179">						rowCount = 0;</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">						if (!rs.next()) {</span>
							try {
<span class="nc" id="L182">								pstmt.setString(1, newInvName[i].trim());</span>
<span class="nc" id="L183">								pstmt.setString(2, invType.trim());</span>

								// insert image into DB
								try {
<span class="nc" id="L187">									logger.debug(&quot;=============== &quot; + img[i]);</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">									if (!&quot;&quot;.equals(img[i].trim())) {</span>
<span class="nc" id="L189">										imgFile = new File(img[i]);</span>
<span class="nc" id="L190">										fin = new FileInputStream(imgFile);</span>
<span class="nc" id="L191">										pstmt.setBinaryStream(3, fin,</span>
												(int) imgFile.length());
									} else {
<span class="nc" id="L194">										pstmt.setBlob(3, (Blob) null);</span>
									}
<span class="nc" id="L196">								} catch (FileNotFoundException e) {</span>
<span class="nc" id="L197">									pstmt.setBlob(3, (Blob) null);</span>
<span class="nc" id="L198">								}</span>

<span class="nc" id="L200">								pstmt.setObject(4, newInvDesc[i].trim());</span>
<span class="nc" id="L201">								rowCount = pstmt.executeUpdate();</span>
<span class="nc" id="L202">							} catch (SQLException e) {</span>
<span class="nc" id="L203">								e.printStackTrace();</span>
<span class="nc" id="L204">							}</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">							if (rowCount &gt; 0) {</span>
<span class="nc" id="L206">								logger.debug(&quot;Total row inserted is = &quot;</span>
										+ rowCount);
<span class="nc" id="L208">								sb.append(newInvName[i].trim()).append(&quot;; &quot;);</span>
							} else {
<span class="nc" id="L210">								logger.debug(&quot;Row is not inserted for &quot;</span>
										+ newInvName[i].trim());
<span class="nc" id="L212">								sb1.append(newInvName[i].trim()).append(&quot;; &quot;);</span>
							}

						} else {
<span class="nc" id="L216">							sb1.append(newInvName[i].trim()).append(&quot;; &quot;);</span>
<span class="nc" id="L217">							logger.debug(&quot;Row is not inserted for &quot;</span>
									+ newInvName[i].trim());
						}
					}
				}
<span class="nc" id="L222">				connection.commit();</span>

<span class="nc" id="L224">			} catch (SQLException e) {</span>
<span class="nc" id="L225">				e.printStackTrace();</span>
<span class="nc" id="L226">				throw new LMSException(e);</span>
			} finally {
<span class="nc" id="L228">				try {</span>
<span class="nc" id="L229">					connection.close();</span>
<span class="nc" id="L230">				} catch (SQLException e) {</span>
<span class="nc" id="L231">					e.printStackTrace();</span>
<span class="nc" id="L232">					throw new LMSException(e);</span>
<span class="nc" id="L233">				}</span>
			}

		}

<span class="nc" id="L238">		String invListStr = sb.toString();</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">		if (&quot;&quot;.equals(invListStr)) {</span>
<span class="nc" id="L240">			return &quot;NO Inventory&quot; + &quot;||&quot; + sb1.toString();</span>
		} else {
<span class="nc" id="L242">			return invListStr + &quot;||&quot; + sb1.toString();</span>
		}
	}

	public String addNewInvSpec(int[] invIdForModSpec, String[] specType,
			String[] specUnit, String[] specValue, double[] costPerUnit,
			String[] newModSpecDesc) throws LMSException {
<span class="nc" id="L249">		logger.debug(&quot;addNewInvSpec called&quot;);</span>
<span class="nc" id="L250">		StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L251">		StringBuilder sb1 = new StringBuilder();</span>
<span class="nc" id="L252">		boolean flag = true;</span>
<span class="nc" id="L253">		logger.debug(&quot;\n specType = &quot; + specType + &quot;, costPerUnit = &quot;</span>
				+ costPerUnit + &quot;\n specValue = &quot; + specValue + &quot;\n inv Id = &quot;
				+ invIdForModSpec + &quot;specUnit = &quot; + specUnit
				+ &quot;, newModSpecDesc = &quot; + newModSpecDesc);

<span class="nc bnc" id="L258" title="All 10 branches missed.">		if (invIdForModSpec != null &amp;&amp; specType != null &amp;&amp; specValue != null</span>
				&amp;&amp; costPerUnit != null &amp;&amp; newModSpecDesc != null) {

<span class="nc" id="L261">			logger.debug(&quot;\n specType size = &quot; + specType.length</span>
					+ &quot;, costPerUnit size = &quot; + costPerUnit.length
					+ &quot;\n specValue size = &quot; + specValue.length
					+ &quot;\n inv Id size = &quot; + invIdForModSpec.length
					+ &quot;specUnit size = &quot; + specUnit.length
					+ &quot;, newModSpecDesc size = &quot; + newModSpecDesc.length);

<span class="nc" id="L268">			Connection connection = DBConnect.getConnection();</span>
			try {
<span class="nc" id="L270">				connection.setAutoCommit(false);</span>
<span class="nc" id="L271">				String checkExisting = &quot;select * from st_lms_cons_inv_specification where spec_type=? AND spec_value=? AND spec_unit=?&quot;;</span>
<span class="nc" id="L272">				ResultSet rs = null;</span>
<span class="nc" id="L273">				PreparedStatement pstmt1 = connection</span>
						.prepareStatement(checkExisting);
<span class="nc" id="L275">				String addNewInvQuery = &quot;insert into st_lms_cons_inv_specification(inv_id, spec_type, spec_value,&quot;</span>
						+ &quot; spec_unit, cost_per_unit, spec_desc) values(?,?,?,?,?,?)&quot;;
<span class="nc" id="L277">				PreparedStatement pstmt = connection</span>
						.prepareStatement(addNewInvQuery);

<span class="nc" id="L280">				int rowCount = 0;</span>
<span class="nc bnc" id="L281" title="All 2 branches missed.">				for (int i = 0, l = invIdForModSpec.length; i &lt; l; i++) {</span>
<span class="nc" id="L282">					logger.debug(&quot;\n specType = &quot; + specType[i]</span>
							+ &quot;, costPerUnit = &quot; + costPerUnit[i]
							+ &quot;\n specValue = &quot; + specValue[i] + &quot; inv Id = &quot;
							+ invIdForModSpec[i] + &quot;\nspecUnit = &quot;
							+ specUnit[i] + &quot;, newModSpecDesc = &quot;
							+ newModSpecDesc[i]);

<span class="nc bnc" id="L289" title="All 6 branches missed.">					if (!&quot;&quot;.equals(specValue[i].trim())</span>
							&amp;&amp; !&quot;&quot;.equals(specType[i].trim())
							&amp;&amp; invIdForModSpec[i] &gt; 0) {
						//
<span class="nc" id="L293">						pstmt1.clearParameters();</span>
<span class="nc" id="L294">						pstmt1.setString(1, specType[i].trim());</span>
<span class="nc" id="L295">						pstmt1.setInt(2, Integer.parseInt(specValue[i].trim()));</span>
<span class="nc" id="L296">						pstmt1.setString(3, specUnit[i].trim());</span>
<span class="nc" id="L297">						rs = pstmt1.executeQuery();</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">						if (!rs.next()) {// duplicate entry not found</span>
<span class="nc" id="L299">							pstmt.setInt(1, invIdForModSpec[i]);</span>
<span class="nc" id="L300">							pstmt.setString(2, specType[i].trim());</span>
<span class="nc" id="L301">							pstmt.setInt(3, Integer.parseInt(specValue[i]</span>
									.trim()));
<span class="nc" id="L303">							pstmt.setString(4, specUnit[i].trim());</span>
<span class="nc" id="L304">							pstmt.setDouble(5, costPerUnit[i]);</span>
<span class="nc" id="L305">							pstmt.setString(6, newModSpecDesc[i].trim());</span>
<span class="nc" id="L306">							logger.debug(pstmt);</span>
<span class="nc" id="L307">							rowCount = pstmt.executeUpdate();</span>

<span class="nc bnc" id="L309" title="All 2 branches missed.">							if (rowCount &gt; 0) {</span>
<span class="nc" id="L310">								logger.debug(&quot;Total row inserted is = &quot;</span>
										+ rowCount);
<span class="nc" id="L312">								sb.append(specValue[i].trim()).append(</span>
										&quot;-&quot; + specUnit[i]).append(
										&quot;-&quot; + specType[i]).append(&quot;;&quot;);
							} else {
<span class="nc" id="L316">								sb1.append(specValue[i].trim()).append(</span>
										&quot;-&quot; + specUnit[i]).append(
										&quot;-&quot; + specType[i]).append(&quot;;&quot;);
<span class="nc" id="L319">								throw new LMSException(&quot;Row is not inserted. &quot;);</span>
							}
						} else {
<span class="nc" id="L322">							sb1.append(specValue[i].trim()).append(</span>
									&quot;-&quot; + specUnit[i])
									.append(&quot;-&quot; + specType[i]).append(&quot;;&quot;);
						}
					}
				}

<span class="nc" id="L329">				connection.commit();</span>
<span class="nc" id="L330">			} catch (SQLException e) {</span>
<span class="nc" id="L331">				e.printStackTrace();</span>
<span class="nc" id="L332">				throw new LMSException(e);</span>
			} finally {
<span class="nc" id="L334">				try {</span>
<span class="nc" id="L335">					connection.close();</span>
<span class="nc" id="L336">				} catch (SQLException e) {</span>
<span class="nc" id="L337">					e.printStackTrace();</span>
<span class="nc" id="L338">					throw new LMSException(e);</span>
<span class="nc" id="L339">				}</span>
			}

		}

<span class="nc" id="L344">		String invListStr = sb.toString();</span>
<span class="nc bnc" id="L345" title="All 2 branches missed.">		if (&quot;&quot;.equals(invListStr)) {</span>
<span class="nc" id="L346">			return &quot;NO Specification||&quot; + sb1.toString();</span>
		} else {
<span class="nc" id="L348">			return invListStr + &quot;||&quot; + sb1.toString();</span>
		}

	}

	public String addNewModelDetails(int[] invIdForModel,
			String[] brandIdForModel, String[] newModelName,
			String[] newModelDesc, String isReqOnReg[], String[] checkBindingLength) throws LMSException {

<span class="nc" id="L357">		StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L358">		StringBuilder sb1 = new StringBuilder();</span>
<span class="nc" id="L359">		logger.debug(&quot;\n newBrandName = &quot; + newModelName + &quot;\n newBrandDesc = &quot;</span>
				+ newModelDesc + &quot;\n inv Id = &quot; + invIdForModel
				+ &quot;brandIdForModel = &quot; + brandIdForModel);

<span class="nc bnc" id="L363" title="All 8 branches missed.">		if (newModelName != null &amp;&amp; newModelDesc != null</span>
				&amp;&amp; invIdForModel != null &amp;&amp; brandIdForModel != null) {

<span class="nc" id="L366">			logger.debug(&quot; newModelName size = &quot; + newModelName.length</span>
					+ &quot;, newModelDesc size = &quot; + newModelDesc.length
					+ &quot;, invIdForModel size = &quot; + invIdForModel.length
					+ &quot;, brandIdForModel size &quot; + brandIdForModel.length);

<span class="nc" id="L371">			Connection connection = DBConnect.getConnection();</span>
			try {
<span class="nc" id="L373">				connection.setAutoCommit(false);</span>
<span class="nc" id="L374">				String addNewInvQuery = &quot;insert into st_lms_inv_model_master(brand_id, inv_id, model_name, model_desc, is_req_on_reg, check_binding_length, inv_column_name) values(?, ?, ?, ?, ?, ?, ?)&quot;;</span>
<span class="nc" id="L375">				PreparedStatement pstmt = connection</span>
						.prepareStatement(addNewInvQuery);
<span class="nc" id="L377">				PreparedStatement vpstmt = connection</span>
						.prepareStatement(&quot;select * from st_lms_inv_model_master where brand_id=? and inv_id=? and model_name = ?&quot;);
<span class="nc" id="L379">				ResultSet rs = null;</span>
<span class="nc" id="L380">				int rowCount = 0;</span>
<span class="nc" id="L381">				String[] bidArr = null;</span>
<span class="nc bnc" id="L382" title="All 2 branches missed.">				for (int i = 0, l = newModelName.length; i &lt; l; i++) {</span>
<span class="nc" id="L383">					logger.debug(&quot;newModelName = &quot; + newModelName[i]</span>
							+ &quot;; newModelDesc = &quot; + newModelDesc[i]
							+ &quot;; inv Id = &quot; + invIdForModel[i]
							+ &quot;, brandIdForModel = &quot; + brandIdForModel[i]);

<span class="nc" id="L388">					bidArr = brandIdForModel[i].trim().split(&quot;-&quot;);</span>

<span class="nc bnc" id="L390" title="All 10 branches missed.">					if (!&quot;&quot;.equals(newModelName[i].trim())</span>
							&amp;&amp; !&quot;&quot;.equals(brandIdForModel[i].trim())
							&amp;&amp; invIdForModel[i] &gt; 0 &amp;&amp; bidArr.length &gt; 1
							&amp;&amp; Integer.parseInt(bidArr[1]) == invIdForModel[i]) {

<span class="nc" id="L395">						vpstmt.setInt(1, Integer.parseInt(bidArr[0]));</span>
<span class="nc" id="L396">						vpstmt.setInt(2, invIdForModel[i]);</span>
<span class="nc" id="L397">						vpstmt.setString(3, newModelName[i].trim());</span>
<span class="nc" id="L398">						rs = vpstmt.executeQuery();</span>
<span class="nc" id="L399">						rowCount = 0;</span>
<span class="nc bnc" id="L400" title="All 2 branches missed.">						if (!rs.next()) {</span>
							try {
<span class="nc" id="L402">								pstmt.setInt(1, Integer.parseInt(bidArr[0]));</span>
<span class="nc" id="L403">								pstmt.setInt(2, invIdForModel[i]);</span>
<span class="nc" id="L404">								pstmt.setString(3, newModelName[i].trim());</span>
<span class="nc" id="L405">								pstmt.setString(4, newModelDesc[i].trim());</span>
<span class="nc" id="L406">								pstmt.setString(5, isReqOnReg[i].trim());</span>
<span class="nc" id="L407">								pstmt.setInt(6, Integer.parseInt(checkBindingLength[i].trim()));</span>
<span class="nc" id="L408">								pstmt.setString(7, &quot;serial_number&quot;);</span>
<span class="nc" id="L409">								rowCount = pstmt.executeUpdate();</span>
<span class="nc" id="L410">							} catch (SQLException e) {</span>
<span class="nc" id="L411">								e.printStackTrace();</span>
<span class="nc" id="L412">							}</span>
<span class="nc bnc" id="L413" title="All 2 branches missed.">							if (rowCount &gt; 0) {</span>
<span class="nc" id="L414">								logger.debug(&quot;Total row inserted is = &quot;</span>
										+ rowCount);
<span class="nc" id="L416">								sb.append(newModelName[i].trim()).append(&quot;;&quot;);</span>
							} else {
<span class="nc" id="L418">								logger.debug(&quot;Row is not inserted for &quot;</span>
										+ newModelName[i].trim());
<span class="nc" id="L420">								sb1.append(newModelName[i].trim()).append(&quot;;&quot;);</span>
							}
						} else {
<span class="nc" id="L423">							sb1.append(newModelName[i].trim()).append(&quot;;&quot;);</span>
<span class="nc" id="L424">							logger.debug(&quot;Row is not inserted for &quot;</span>
									+ newModelName[i].trim());
						}

					}
				}

<span class="nc" id="L431">				connection.commit();</span>
<span class="nc" id="L432">			} catch (SQLException e) {</span>
<span class="nc" id="L433">				e.printStackTrace();</span>
<span class="nc" id="L434">				throw new LMSException(e);</span>
			} finally {
<span class="nc" id="L436">				try {</span>
<span class="nc" id="L437">					connection.close();</span>
<span class="nc" id="L438">				} catch (SQLException e) {</span>
<span class="nc" id="L439">					e.printStackTrace();</span>
<span class="nc" id="L440">					throw new LMSException(e);</span>
<span class="nc" id="L441">				}</span>
			}

		}
<span class="nc" id="L445">		String invListStr = sb.toString();</span>
<span class="nc bnc" id="L446" title="All 2 branches missed.">		if (&quot;&quot;.equals(invListStr)) {</span>
<span class="nc" id="L447">			return &quot;NO Model&quot; + &quot;||&quot; + sb1.toString();</span>

		} else {
<span class="nc" id="L450">			return invListStr + &quot;||&quot; + sb1.toString();</span>
		}

	}

	public String agtNonConsInvReturnSave(int retOrgId, String invSrNo,
			int agtOrgId,String modelId, String userType, int agtId) throws LMSException {
<span class="nc" id="L457">		Connection con = null;</span>
<span class="nc" id="L458">		PreparedStatement psmt = null;</span>
<span class="nc" id="L459">		ResultSet rs = null;</span>
<span class="nc" id="L460">		String status = &quot;error&quot;;</span>
<span class="nc" id="L461">		String srNo = invSrNo;// serial no of inventory</span>

<span class="nc" id="L463">		int  model  = 0;</span>
		//String deviceType =null;
<span class="nc" id="L465">		String invColName =null;</span>
		try {
			
<span class="nc" id="L468">			model  = Integer.parseInt(modelId.split(&quot;-&quot;)[0]);// device type of inventory</span>
			
<span class="nc" id="L470">			String modelDeatials = &quot;select  inv_column_name from st_lms_inv_model_master where model_id=?  &quot; ;</span>
<span class="nc" id="L471">			String assignSerNoQuery = &quot;update st_lms_inv_status set current_owner_type = ?, current_owner_id = ? where serial_no =  ? and current_owner_id = ?  and inv_model_id = ?&quot;;</span>
<span class="nc" id="L472">			String insIntoInvDetQuery = &quot;insert into st_lms_inv_detail(user_id,user_org_type,user_org_id, inv_model_id,serial_no,date,cost_to_bo,is_new,current_owner_type,current_owner_id) select ?,?,?,inv_model_id,?,?,cost_to_bo, is_new,?,? from st_lms_inv_status where serial_no = ? and inv_model_id = ?&quot;;</span>
<span class="nc" id="L473">			con = DBConnect.getConnection();</span>
<span class="nc" id="L474">			psmt =con.prepareStatement(modelDeatials);</span>
<span class="nc" id="L475">			psmt.setInt(1, model);</span>
<span class="nc" id="L476">			rs =psmt.executeQuery();</span>
<span class="nc bnc" id="L477" title="All 2 branches missed.">			if(rs.next()){</span>
<span class="nc" id="L478">				invColName =rs.getString(&quot;inv_column_name&quot;);</span>
			}else{
				
<span class="nc" id="L481">				throw new LMSException(LMSErrors.GENERAL_EXCEPTION_ERROR_CODE,LMSErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
			}
<span class="nc" id="L483">			DBConnect.closeConnection(psmt, rs);</span>
<span class="nc" id="L484">			con.setAutoCommit(false);</span>
<span class="nc" id="L485">			psmt = con.prepareStatement(assignSerNoQuery);</span>
<span class="nc" id="L486">			psmt.setString(1, userType);</span>
<span class="nc" id="L487">			psmt.setInt(2, agtOrgId);</span>
<span class="nc" id="L488">			psmt.setString(3, srNo);</span>
<span class="nc" id="L489">			psmt.setInt(4, retOrgId);</span>
<span class="nc" id="L490">			psmt.setInt(5, model);</span>
<span class="nc" id="L491">			logger.debug(&quot;update query for inventory::::::&quot; + psmt);</span>
<span class="nc" id="L492">			psmt.executeUpdate();</span>
<span class="nc" id="L493">			PreparedStatement insIntoInvDet = con.prepareStatement(insIntoInvDetQuery);</span>
<span class="nc" id="L494">			insIntoInvDet.setInt(1, agtId);</span>
<span class="nc" id="L495">			insIntoInvDet.setString(2, userType);</span>
<span class="nc" id="L496">			insIntoInvDet.setInt(3, agtOrgId);</span>
			// insIntoInvDet.setInt(4, inv_modelId);
<span class="nc" id="L498">			insIntoInvDet.setString(4, srNo);</span>
<span class="nc" id="L499">			insIntoInvDet.setTimestamp(5, new Timestamp(new java.util.Date().getTime()));</span>
<span class="nc" id="L500">			insIntoInvDet.setString(6, userType);</span>
<span class="nc" id="L501">			insIntoInvDet.setInt(7, agtOrgId);</span>
<span class="nc" id="L502">			insIntoInvDet.setString(8, srNo);</span>
<span class="nc" id="L503">			insIntoInvDet.setInt(9, model);</span>
<span class="nc" id="L504">			logger.debug(&quot;insert query for inventory::::::&quot;+ insIntoInvDet);</span>
<span class="nc" id="L505">			insIntoInvDet.executeUpdate();</span>
<span class="nc" id="L506">			String offLoginStatus = &quot;update st_lms_ret_offline_master set &quot;+invColName+&quot; = -1 , device_type = -1 where  organization_id=?&quot;;</span>
<span class="nc" id="L507">			psmt = con.prepareStatement(offLoginStatus);</span>
<span class="nc" id="L508">			psmt.setInt(1,retOrgId );</span>
<span class="nc" id="L509">			psmt.executeUpdate();</span>
<span class="nc" id="L510">			con.commit();</span>
<span class="nc" id="L511">			status = &quot;success&quot;;</span>

<span class="nc" id="L513">		}catch (Exception e) {</span>
<span class="nc" id="L514">			logger.error(&quot;Exception&quot;,e);</span>
			try {
<span class="nc" id="L516">				con.rollback();</span>
<span class="nc" id="L517">			} catch (SQLException e1) {</span>
<span class="nc" id="L518">				logger.error(&quot;Exception&quot;,e1);</span>
<span class="nc" id="L519">			}</span>
<span class="nc" id="L520">			return &quot;error&quot;;</span>
		}finally{
			
<span class="nc" id="L523">			DBConnect.closeConnection(con, psmt);</span>
			
<span class="nc" id="L525">		}</span>
<span class="nc" id="L526">		return status;</span>
	}

	private void assignConsInv(int userOrgId, int userId, String ownerType,
			int agtOrgId, int retOrgId, int[] consInvId, int[] consModelId,
			int[] consQty, Connection conn, String userType,int DNID)
			throws SQLException {

<span class="nc" id="L534">		List&lt;String&gt; validSerNoList = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L535">		List&lt;String&gt; inValidSerNoList = new ArrayList&lt;String&gt;();</span>

<span class="nc" id="L537">		String fetchDetailsQuery = &quot;select party_org_id, aa.inv_model_id, cumm_qty_count, inv_name, &quot;</span>
				+ &quot; concat(spec_value, '-', spec_unit, '-', spec_type) 'model_name' from st_lms_cons_inv_status &quot;
				+ &quot; aa, st_lms_cons_inv_specification bb, st_lms_inv_master cc where aa.inv_model_id = &quot;
				+ &quot; bb.inv_model_id and bb.inv_id = cc.inv_id &quot;;
<span class="nc" id="L541">		PreparedStatement pstmt = conn.prepareStatement(fetchDetailsQuery);</span>
<span class="nc" id="L542">		ResultSet rs = pstmt.executeQuery();</span>
<span class="nc" id="L543">		Map&lt;String, Long&gt; partyDetMap = new TreeMap&lt;String, Long&gt;();</span>
<span class="nc" id="L544">		Map&lt;Integer, ConsNNonConsBean&gt; invDetMap = new TreeMap&lt;Integer, ConsNNonConsBean&gt;();</span>
<span class="nc bnc" id="L545" title="All 2 branches missed.">		while (rs.next()) {</span>
<span class="nc" id="L546">			partyDetMap.put(rs.getInt(&quot;party_org_id&quot;) + &quot;-&quot;</span>
					+ rs.getInt(&quot;inv_model_id&quot;), rs.getLong(&quot;cumm_qty_count&quot;));

		}

<span class="nc bnc" id="L551" title="All 2 branches missed.">		int partyOrgId = &quot;AGENT&quot;.equalsIgnoreCase(ownerType.trim()) ? agtOrgId</span>
				: retOrgId;
<span class="nc" id="L553">		int fstRowUpd = -1, scdRowUpd = -1;</span>
<span class="nc" id="L554">		ConsNNonConsBean bean = null;</span>
<span class="nc bnc" id="L555" title="All 2 branches missed.">		for (int i = 0, len = consModelId.length; i &lt; len; i = i + 1) {</span>
<span class="nc bnc" id="L556" title="All 6 branches missed.">			if (consInvId[i] &gt; 0 &amp;&amp; consModelId[i] &gt; 0 &amp;&amp; consQty[i] &gt; 0) {</span>

<span class="nc bnc" id="L558" title="All 4 branches missed.">				if (partyDetMap.get(userOrgId + &quot;-&quot; + consModelId[i]) != null</span>
						&amp;&amp; partyDetMap.get(userOrgId + &quot;-&quot; + consModelId[i]) &gt;= consQty[i]) {

					// update st_lms_cons_inv_status table to add inventory
					// quantity
<span class="nc" id="L563">					String redInvStatusQuery = &quot;update st_lms_cons_inv_status set cumm_qty_count=cumm_qty_count-?&quot;</span>
							+ &quot; where inv_model_id =? and party_org_id = ? and cumm_qty_count&gt;=?&quot;;
<span class="nc" id="L565">					pstmt = conn.prepareStatement(redInvStatusQuery);</span>
<span class="nc" id="L566">					pstmt.setLong(1, consQty[i]);</span>
<span class="nc" id="L567">					pstmt.setInt(2, consModelId[i]);</span>
<span class="nc" id="L568">					pstmt.setInt(3, userOrgId);</span>
<span class="nc" id="L569">					pstmt.setLong(4, consQty[i]);</span>
<span class="nc" id="L570">					logger.debug(pstmt);</span>
<span class="nc" id="L571">					fstRowUpd = pstmt.executeUpdate();</span>

<span class="nc bnc" id="L573" title="All 4 branches missed.">					if (partyDetMap.get(partyOrgId + &quot;-&quot; + consModelId[i]) != null</span>
							&amp;&amp; fstRowUpd &gt; 0) {

						// update st_lms_cons_inv_status table to add inventory
						// quantity
<span class="nc" id="L578">						String incInvStatusQuery = &quot;update st_lms_cons_inv_status set cumm_qty_count=cumm_qty_count+?&quot;</span>
								+ &quot; where inv_model_id =? and party_org_id = ?&quot;;
<span class="nc" id="L580">						pstmt = conn.prepareStatement(incInvStatusQuery);</span>
<span class="nc" id="L581">						pstmt.setLong(1, consQty[i]);</span>
<span class="nc" id="L582">						pstmt.setInt(2, consModelId[i]);</span>
<span class="nc" id="L583">						pstmt.setInt(3, partyOrgId);</span>
<span class="nc" id="L584">						logger.debug(pstmt);</span>
<span class="nc" id="L585">						scdRowUpd = pstmt.executeUpdate();</span>

<span class="nc" id="L587">						String insIntoUserInvDetailQuery = &quot;insert into st_lms_cons_inv_detail(user_id, user_org_id, &quot;</span>
								+ &quot; current_owner_id, inv_model_id, quantity, date, ref_transaction_id, amount) select ?, ?,&quot;
								+ &quot; ?, ?, ?, ?, ?, cost_per_unit*? from st_lms_cons_inv_specification where inv_model_id=?&quot;;
<span class="nc" id="L590">						pstmt = conn</span>
								.prepareStatement(insIntoUserInvDetailQuery);
<span class="nc" id="L592">						pstmt.setInt(1, userId);</span>
<span class="nc" id="L593">						pstmt.setInt(2, userOrgId);</span>
<span class="nc" id="L594">						pstmt.setInt(3, partyOrgId);</span>
<span class="nc" id="L595">						pstmt.setInt(4, consModelId[i]);</span>
<span class="nc" id="L596">						pstmt.setLong(5, consQty[i]);</span>
<span class="nc" id="L597">						pstmt.setTimestamp(6, new Timestamp(</span>
								new java.util.Date().getTime()));
<span class="nc" id="L599">						pstmt.setObject(7, null);</span>
<span class="nc" id="L600">						pstmt.setLong(8, consQty[i]);</span>
<span class="nc" id="L601">						pstmt.setInt(9, consModelId[i]);</span>
<span class="nc" id="L602">						logger.debug(&quot;st_lms_cons_inv_detail = &quot; + pstmt);</span>
<span class="nc" id="L603">						int rowCount = pstmt.executeUpdate();</span>
<span class="nc" id="L604">						logger.debug(&quot;Total row inserted = &quot; + rowCount);</span>
<span class="nc bnc" id="L605" title="All 2 branches missed.">						if (rowCount &gt; 0) {</span>
<span class="nc" id="L606">							ResultSet rsTask=pstmt.getGeneratedKeys();</span>
<span class="nc bnc" id="L607" title="All 2 branches missed.">							if(rsTask.next()){</span>
<span class="nc" id="L608">								int taskId=rsTask.getInt(1);</span>
<span class="nc" id="L609">								String insQuery=&quot;insert into st_lms_inv_dl_task_mapping values(&quot;+DNID+&quot;,&quot;+taskId+&quot;,'CONS')&quot;;</span>
<span class="nc" id="L610">							PreparedStatement	pstmt1=conn.prepareStatement(insQuery);</span>
<span class="nc" id="L611">								pstmt1.executeUpdate();</span>
							}
							
							
<span class="nc" id="L615">							bean = new ConsNNonConsBean();</span>
							// bean.
							// validSerNoList.add(bean);
						}

<span class="nc bnc" id="L620" title="All 2 branches missed.">					} else if (fstRowUpd &gt; 0) {</span>
						// insert into st_lms_cons_inv_status table to add
						// inventory quantity
<span class="nc" id="L623">						String insIntoInvStatusQuery = &quot;insert into st_lms_cons_inv_status(party_type, party_org_id, &quot;</span>
								+ &quot; inv_model_id, cumm_qty_count) values(?, ?, ?, ?)&quot;;
<span class="nc" id="L625">						pstmt = conn.prepareStatement(insIntoInvStatusQuery);</span>
<span class="nc" id="L626">						pstmt.setString(1, ownerType);</span>
<span class="nc" id="L627">						pstmt.setInt(2, partyOrgId);</span>
<span class="nc" id="L628">						pstmt.setInt(3, consModelId[i]);</span>
<span class="nc" id="L629">						pstmt.setLong(4, consQty[i]);</span>
<span class="nc" id="L630">						logger.debug(pstmt);</span>
<span class="nc" id="L631">						scdRowUpd = pstmt.executeUpdate();</span>
<span class="nc" id="L632">						logger.debug(&quot;Total row inserted = &quot; + scdRowUpd);</span>
						
<span class="nc" id="L634">						String insIntoUserInvDetailQuery = &quot;insert into st_lms_cons_inv_detail(user_id, user_org_id, &quot;</span>
							+ &quot; current_owner_id, inv_model_id, quantity, date, ref_transaction_id, amount) select ?, ?,&quot;
							+ &quot; ?, ?, ?, ?, ?, cost_per_unit*? from st_lms_cons_inv_specification where inv_model_id=?&quot;;
<span class="nc" id="L637">					pstmt = conn</span>
							.prepareStatement(insIntoUserInvDetailQuery);
<span class="nc" id="L639">					pstmt.setInt(1, userId);</span>
<span class="nc" id="L640">					pstmt.setInt(2, userOrgId);</span>
<span class="nc" id="L641">					pstmt.setInt(3, partyOrgId);</span>
<span class="nc" id="L642">					pstmt.setInt(4, consModelId[i]);</span>
<span class="nc" id="L643">					pstmt.setLong(5, consQty[i]);</span>
<span class="nc" id="L644">					pstmt.setTimestamp(6, new Timestamp(</span>
							new java.util.Date().getTime()));
<span class="nc" id="L646">					pstmt.setObject(7, null);</span>
<span class="nc" id="L647">					pstmt.setLong(8, consQty[i]);</span>
<span class="nc" id="L648">					pstmt.setInt(9, consModelId[i]);</span>
<span class="nc" id="L649">					logger.debug(&quot;st_lms_cons_inv_detail = &quot; + pstmt);</span>
<span class="nc" id="L650">					int rowCount = pstmt.executeUpdate();</span>
<span class="nc" id="L651">					logger.debug(&quot;Total row inserted = &quot; + rowCount);</span>
<span class="nc bnc" id="L652" title="All 2 branches missed.">					if (rowCount &gt; 0) {</span>
<span class="nc" id="L653">						ResultSet rsTask=pstmt.getGeneratedKeys();</span>
<span class="nc bnc" id="L654" title="All 2 branches missed.">						if(rsTask.next()){</span>
<span class="nc" id="L655">							int taskId=rsTask.getInt(1);</span>
<span class="nc" id="L656">							String insQuery=&quot;insert into st_lms_inv_dl_task_mapping values(&quot;+DNID+&quot;,&quot;+taskId+&quot;,'CONS')&quot;;</span>
<span class="nc" id="L657">						PreparedStatement	pstmt1=conn.prepareStatement(insQuery);</span>
<span class="nc" id="L658">							pstmt1.executeUpdate();</span>
						}
						
						
<span class="nc" id="L662">						bean = new ConsNNonConsBean();</span>
						// bean.
						// validSerNoList.add(bean);
					}
						
					}

					/*if (scdRowUpd &gt; 0 &amp;&amp; fstRowUpd &gt; 0) {
						String insIntoInvDetailQuery = &quot;insert into st_lms_cons_inv_detail(user_id, user_org_id, &quot;
								+ &quot; current_owner_id, inv_model_id, quantity, date, ref_transaction_id, amount) select ?, ?,&quot;
								+ &quot; ?, ?, ?, ?, ?, cost_per_unit*? from st_lms_cons_inv_specification where inv_model_id=?&quot;;
						pstmt = conn.prepareStatement(insIntoInvDetailQuery);
						pstmt.setInt(1, userId);
						pstmt.setInt(2, userOrgId);
						pstmt.setInt(3, partyOrgId);
						pstmt.setInt(4, consModelId[i]);
						pstmt.setLong(5, consQty[i]);
						pstmt.setTimestamp(6, new Timestamp(
								new java.util.Date().getTime()));
						pstmt.setObject(7, null);
						pstmt.setLong(8, consQty[i]);
						pstmt.setInt(9, consModelId[i]);
						logger.debug(&quot;st_lms_cons_inv_detail = &quot; + pstmt);
						int rowCount = pstmt.executeUpdate();
						logger.debug(&quot;Total row inserted = &quot; + rowCount);
						if (rowCount &gt; 0) {
							bean = new ConsNNonConsBean();
							// bean.
							// validSerNoList.add(bean);
						}
					}*/
				}

			} else {
				// values are not in valid format

			}
		}

<span class="nc" id="L701">		logger.debug(&quot;valid list = &quot; + validSerNoList);</span>
<span class="nc" id="L702">		logger.debug(&quot;invalid list = &quot; + inValidSerNoList);</span>

<span class="nc" id="L704">	}</span>

	public int assignConsNNonConsInv(int userOrgId, int userId,
			String ownerType, int agtOrgId, int retOrgId, int[] nonConsInvId,
			int[] nonConsModelId, int[] nonConsBrandId, String[] serNo,
			int[] consInvId, int[] consModelId, int[] consQty, String userType)
			throws LMSException {

<span class="nc" id="L712">		Connection conn = DBConnect.getConnection();</span>
<span class="nc" id="L713">		int DNID=0;</span>
		try {
<span class="nc" id="L715">			conn.setAutoCommit(false);</span>
			
			
<span class="nc" id="L718">			String lastDCNoGenerated = null, autoGeneDCNo = null;</span>
<span class="nc" id="L719">			PreparedStatement boReceiptNoGenStmt=null;</span>
<span class="nc" id="L720">			boReceiptNoGenStmt = conn.prepareStatement(&quot;SELECT * from st_lms_inv_dl_detail where dl_owner_type=?  ORDER BY generated_dl_id DESC LIMIT 1&quot;);</span>
<span class="nc" id="L721">			boReceiptNoGenStmt.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L722">			ResultSet DCRs = boReceiptNoGenStmt.executeQuery();</span>

<span class="nc bnc" id="L724" title="All 2 branches missed.">			while (DCRs.next()) {</span>
<span class="nc" id="L725">				lastDCNoGenerated = DCRs.getString(&quot;generated_dl_id&quot;);</span>
			}
<span class="nc" id="L727">			autoGeneDCNo = GenerateRecieptNo.getRecieptNo(&quot;DNCHALLAN&quot;,</span>
					lastDCNoGenerated, &quot;BO&quot;);
<span class="nc" id="L729">			System.out.println(&quot;lastDCNoGenerated &quot; + lastDCNoGenerated</span>
					+ &quot;autoGeneDCNo &quot; + autoGeneDCNo);
			
			// insert into lms dl inv detail table for delivery challan
<span class="nc" id="L733">			PreparedStatement boReceiptStmt = conn.prepareStatement(&quot;insert into st_lms_inv_dl_detail(dl_owner_type,generated_dl_id) values(?,?)&quot;);</span>
			
<span class="nc" id="L735">			boReceiptStmt.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L736">			boReceiptStmt.setString(2, autoGeneDCNo);</span>
<span class="nc" id="L737">			System.out.println(&quot;bo DL receipt = &quot; + boReceiptStmt);</span>
<span class="nc" id="L738">			boReceiptStmt.execute();</span>
			//find dlID
<span class="nc" id="L740">			boReceiptNoGenStmt = conn.prepareStatement(&quot;SELECT * from st_lms_inv_dl_detail where generated_dl_id=?  ORDER BY generated_dl_id DESC LIMIT 1&quot;);</span>
<span class="nc" id="L741">			boReceiptNoGenStmt.setString(1, autoGeneDCNo);</span>
<span class="nc" id="L742">			 DCRs = boReceiptNoGenStmt.executeQuery();</span>

<span class="nc bnc" id="L744" title="All 2 branches missed.">			while (DCRs.next()) {</span>
<span class="nc" id="L745">				DNID = DCRs.getInt(&quot;dl_id&quot;);</span>
			}
			
			// assign non consumable inventory
<span class="nc" id="L749">			assignNonConsInv(userOrgId, userId, ownerType, agtOrgId, retOrgId,</span>
					nonConsInvId, nonConsModelId, nonConsBrandId, serNo, conn,
					userType,DNID);
			// assign consumable inventory
<span class="nc" id="L753">			assignConsInv(userOrgId, userId, ownerType, agtOrgId, retOrgId,</span>
					consInvId, consModelId, consQty, conn, userType,DNID);

			
			//insertDlTaskMapTable(nonConsInvId,nonConsModelId,nonConsBrandId,serNo,conn,DNID);
			
<span class="nc" id="L759">			conn.commit();</span>
<span class="nc" id="L760">		} catch (SQLException e) {</span>
<span class="nc" id="L761">			e.printStackTrace();</span>
<span class="nc" id="L762">			throw new LMSException(e);</span>
		} finally {
<span class="nc" id="L764">			try {</span>
<span class="nc" id="L765">				conn.close();</span>
<span class="nc" id="L766">			} catch (SQLException e) {</span>
<span class="nc" id="L767">				e.printStackTrace();</span>
<span class="nc" id="L768">				throw new LMSException(e);</span>
<span class="nc" id="L769">			}</span>
		}

<span class="nc" id="L772">		return DNID;</span>
	}

	private void assignNonConsInv(int userOrgId, int userId, String ownerType,
			int agtOrgId, int retOrgId, int[] nonConsInvId,
			int[] nonConsModelId, int[] nonConsBrandId, String[] serNo,
			Connection conn, String userType,int DNID) throws SQLException {

<span class="nc" id="L780">		List&lt;String&gt; validSerNoList = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L781">		List&lt;String&gt; inValidSerNoList = new ArrayList&lt;String&gt;();</span>

<span class="nc" id="L783">		String assignSerNoQuery = &quot;update st_lms_inv_status set user_id = ?, user_org_type = ?, user_org_id = ?, &quot;</span>
				+ &quot;current_owner_type = ?, current_owner_id = ? where inv_model_id =? and serial_no = &quot;
				+ &quot; ? and current_owner_id = ?&quot;;
<span class="nc" id="L786">		PreparedStatement assignSerNoPstmt = conn</span>
				.prepareStatement(assignSerNoQuery);
<span class="nc" id="L788">		assignSerNoPstmt.setInt(1, userId);</span>
<span class="nc" id="L789">		assignSerNoPstmt.setString(2, userType);</span>
<span class="nc" id="L790">		assignSerNoPstmt.setInt(3, userOrgId);</span>
<span class="nc" id="L791">		assignSerNoPstmt.setString(4, ownerType);</span>
<span class="nc bnc" id="L792" title="All 2 branches missed.">		assignSerNoPstmt.setInt(5,</span>
				&quot;AGENT&quot;.equalsIgnoreCase(ownerType.trim()) ? agtOrgId
						: retOrgId);
		// assignSerNoPstmt.setInt(6, modId); inside for loop
		// assignSerNoPstmt.setString(7, sNo.trim()); inside for loop
<span class="nc" id="L797">		assignSerNoPstmt.setInt(8, userOrgId);</span>

		// insert into st_lms_inv_detail table to add inventory quantity
<span class="nc" id="L800">		String insIntoInvDetQuery = &quot;insert into st_lms_inv_detail(user_id,user_org_type,user_org_id,&quot;</span>
				+ &quot; inv_model_id,serial_no,date,cost_to_bo,is_new,current_owner_type,current_owner_id)&quot;
				+ &quot; select ?,?,?,?,?,?,cost_to_bo, is_new,?,? from st_lms_inv_status where inv_model_id =? &quot;
				+ &quot; and serial_no = ?&quot;;
<span class="nc" id="L804">		PreparedStatement insIntoInvDet = conn</span>
				.prepareStatement(insIntoInvDetQuery);
<span class="nc" id="L806">		insIntoInvDet.setInt(1, userId);</span>
<span class="nc" id="L807">		insIntoInvDet.setString(2, userType);</span>
<span class="nc" id="L808">		insIntoInvDet.setInt(3, userOrgId);</span>
		// insIntoInvDet.setInt(4, modId); inside for loop
		// insIntoInvDet.setString(5, sNo.trim()); inside for loop
<span class="nc" id="L811">		insIntoInvDet.setTimestamp(6, new Timestamp(new java.util.Date()</span>
				.getTime()));
<span class="nc" id="L813">		insIntoInvDet.setString(7, ownerType);</span>
<span class="nc bnc" id="L814" title="All 2 branches missed.">		insIntoInvDet.setInt(8,</span>
				&quot;AGENT&quot;.equalsIgnoreCase(ownerType.trim()) ? agtOrgId
						: retOrgId);
		// insIntoInvDet.setInt(9, modId); inside for loop
		// insIntoInvDet.setString(10, sNo.trim()); inside for loop

<span class="nc" id="L820">		String[] serNoArr = null;</span>
<span class="nc" id="L821">		int fstRowUpd = -1, scdRowUpd = -1;</span>
<span class="nc bnc" id="L822" title="All 2 branches missed.">		for (int i = 0, len = nonConsModelId.length; i &lt; len; i = i + 1) {</span>
<span class="nc bnc" id="L823" title="All 8 branches missed.">			if (nonConsInvId[i] &gt; 0 &amp;&amp; nonConsModelId[i] &gt; 0</span>
					&amp;&amp; nonConsBrandId[i] &gt; 0 &amp;&amp; !&quot;&quot;.equals(serNo[i].trim())) {

<span class="nc" id="L826">				assignSerNoPstmt.setInt(6, nonConsModelId[i]);</span>

<span class="nc" id="L828">				insIntoInvDet.setInt(4, nonConsModelId[i]);</span>
<span class="nc" id="L829">				insIntoInvDet.setInt(9, nonConsModelId[i]);</span>

<span class="nc" id="L831">				serNoArr = serNo[i].split(&quot;,&quot;);</span>
<span class="nc bnc" id="L832" title="All 2 branches missed.">				for (int k = 0, klen = serNoArr.length; k &lt; klen; k = k + 1) {</span>
<span class="nc" id="L833">					fstRowUpd = -1;</span>
<span class="nc" id="L834">					scdRowUpd = -1;</span>
<span class="nc bnc" id="L835" title="All 2 branches missed.">					if (!&quot;&quot;.equals(serNoArr[k].trim())) {</span>
						// update st_lms_inv_status
<span class="nc" id="L837">						assignSerNoPstmt.setString(7, serNoArr[k].trim());</span>
<span class="nc" id="L838">						logger.debug(&quot;updPstmt = &quot; + assignSerNoPstmt);</span>
<span class="nc" id="L839">						fstRowUpd = assignSerNoPstmt.executeUpdate();</span>

<span class="nc bnc" id="L841" title="All 2 branches missed.">						if (fstRowUpd == 1) {</span>
							// insert data into st_lms_inv_detail
<span class="nc" id="L843">							insIntoInvDet.setString(5, serNoArr[k].trim());</span>
<span class="nc" id="L844">							insIntoInvDet.setString(10, serNoArr[k].trim());</span>
<span class="nc" id="L845">							logger.debug(&quot;insPstmt = &quot; + insIntoInvDet);</span>
<span class="nc" id="L846">							scdRowUpd = insIntoInvDet.executeUpdate();</span>
<span class="nc bnc" id="L847" title="All 2 branches missed.">							if (scdRowUpd &gt; 0) {</span>
<span class="nc" id="L848">								ResultSet rsTask=insIntoInvDet.getGeneratedKeys();</span>
<span class="nc bnc" id="L849" title="All 2 branches missed.">								if(rsTask.next()){</span>
<span class="nc" id="L850">									int taskId=rsTask.getInt(1);</span>
<span class="nc" id="L851">									String insQuery=&quot;insert into st_lms_inv_dl_task_mapping values(&quot;+DNID+&quot;,&quot;+taskId+&quot;,'NON_CONS')&quot;;</span>
<span class="nc" id="L852">								PreparedStatement	pstmt=conn.prepareStatement(insQuery);</span>
<span class="nc" id="L853">									pstmt.executeUpdate();</span>
								}
<span class="nc" id="L855">								validSerNoList.add(serNoArr[k].trim());</span>
<span class="nc" id="L856">							}</span>
						} else {
<span class="nc" id="L858">							inValidSerNoList.add(serNoArr[k].trim());</span>
						}
					}
				}

			} else {
				// values are not in valid format
<span class="nc" id="L865">				logger.debug(&quot;inside else ==== &quot; + nonConsInvId[i] + &quot; == &quot;</span>
						+ nonConsModelId[i] + &quot; === &quot; + nonConsBrandId[i]
						+ &quot;==&quot; + serNo[i].trim());
			}
		}

<span class="nc" id="L871">		logger.debug(&quot;valid list = &quot; + validSerNoList);</span>
<span class="nc" id="L872">		logger.debug(&quot;invalid list = &quot; + inValidSerNoList);</span>

<span class="nc" id="L874">	}</span>

	public String consInvUpload(int invId, String modelId, String quantity,
			int userId, int userOrgId, String orgType) throws LMSException {

<span class="nc" id="L879">		logger.debug(&quot;invId = &quot; + invId + &quot;, modelId = &quot; + modelId</span>
				+ &quot;, quantity = &quot; + quantity);

<span class="nc" id="L882">		StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L883">		Connection connection = DBConnect.getConnection();</span>
		try {
<span class="nc" id="L885">			connection.setAutoCommit(false);</span>

<span class="nc bnc" id="L887" title="All 6 branches missed.">			if (!&quot;&quot;.equals(modelId.trim()) &amp;&amp; !&quot;&quot;.equals(quantity.trim())</span>
					&amp;&amp; invId &gt; 0) {

<span class="nc" id="L890">				String fetchDetailsQuery = &quot;select party_type, party_org_id, inv_model_id, cumm_qty_count&quot;</span>
						+ &quot; from st_lms_cons_inv_status where party_org_id =? and inv_model_id = ?&quot;;

<span class="nc" id="L893">				PreparedStatement pstmt = connection</span>
						.prepareStatement(fetchDetailsQuery);
<span class="nc" id="L895">				pstmt.setInt(1, userOrgId);</span>
<span class="nc" id="L896">				int modId = Integer.parseInt(modelId.trim().split(&quot;-&quot;)[0]);</span>
<span class="nc" id="L897">				pstmt.setInt(2, modId);</span>
<span class="nc" id="L898">				ResultSet rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L900" title="All 2 branches missed.">				if (rs.next()) {</span>
					// update st_lms_cons_inv_status table to add inventory
					// quantity
<span class="nc" id="L903">					String insIntoInvStatusQuery = &quot;update st_lms_cons_inv_status set cumm_qty_count=cumm_qty_count+?&quot;</span>
							+ &quot; where inv_model_id =? and party_org_id = ?&quot;;
<span class="nc" id="L905">					pstmt = connection.prepareStatement(insIntoInvStatusQuery);</span>
<span class="nc" id="L906">					pstmt.setLong(1, Long.parseLong(quantity.trim()));</span>
<span class="nc" id="L907">					pstmt.setInt(2, modId);</span>
<span class="nc" id="L908">					pstmt.setInt(3, userOrgId);</span>
<span class="nc" id="L909">					logger.debug(pstmt);</span>
<span class="nc" id="L910">					int rowCount = pstmt.executeUpdate();</span>
<span class="nc" id="L911">					logger.debug(&quot;Total row Updated = &quot; + rowCount);</span>

<span class="nc" id="L913">				} else {</span>
					// insert into st_lms_cons_inv_status table to add inventory
					// quantity
<span class="nc" id="L916">					String insIntoInvStatusQuery = &quot;insert into st_lms_cons_inv_status(party_type, party_org_id, &quot;</span>
							+ &quot; inv_model_id, cumm_qty_count) values(?, ?, ?, ?)&quot;;
<span class="nc" id="L918">					pstmt = connection.prepareStatement(insIntoInvStatusQuery);</span>
<span class="nc" id="L919">					pstmt.setString(1, orgType);</span>
<span class="nc" id="L920">					pstmt.setInt(2, userOrgId);</span>
<span class="nc" id="L921">					pstmt.setInt(3, modId);</span>
<span class="nc" id="L922">					pstmt.setLong(4, Long.parseLong(quantity.trim()));</span>
<span class="nc" id="L923">					logger.debug(pstmt);</span>
<span class="nc" id="L924">					int rowCount = pstmt.executeUpdate();</span>
<span class="nc" id="L925">					logger.debug(&quot;Total row inserted = &quot; + rowCount);</span>
				}

<span class="nc" id="L928">				String insIntoInvDetailQuery = &quot;insert into st_lms_cons_inv_detail(user_id, user_org_id, &quot;</span>
						+ &quot; current_owner_id, inv_model_id, quantity, date, ref_transaction_id, amount) select ?, ?,&quot;
						+ &quot; ?, ?, ?, ?, ?, cost_per_unit*? from st_lms_cons_inv_specification where inv_model_id=?&quot;;
<span class="nc" id="L931">				pstmt = connection.prepareStatement(insIntoInvDetailQuery);</span>
<span class="nc" id="L932">				pstmt.setInt(1, userId);</span>
<span class="nc" id="L933">				pstmt.setInt(2, userOrgId);</span>
<span class="nc" id="L934">				pstmt.setInt(3, userOrgId);</span>
<span class="nc" id="L935">				pstmt.setInt(4, modId);</span>
<span class="nc" id="L936">				pstmt.setLong(5, Long.parseLong(quantity.trim()));</span>
<span class="nc" id="L937">				pstmt.setTimestamp(6, new Timestamp(new java.util.Date()</span>
						.getTime()));
<span class="nc" id="L939">				pstmt.setObject(7, null);</span>
<span class="nc" id="L940">				pstmt.setLong(8, Long.parseLong(quantity.trim()));</span>
<span class="nc" id="L941">				pstmt.setInt(9, modId);</span>
<span class="nc" id="L942">				logger.debug(&quot;st_lms_cons_inv_detail = &quot; + pstmt);</span>
<span class="nc" id="L943">				int rowCount = pstmt.executeUpdate();</span>
<span class="nc" id="L944">				logger.debug(&quot;Total row inserted = &quot; + rowCount);</span>

<span class="nc" id="L946">				connection.commit();</span>
			}
<span class="nc" id="L948">		} catch (SQLException e) {</span>
<span class="nc" id="L949">			e.printStackTrace();</span>
<span class="nc" id="L950">			throw new LMSException(e);</span>
		} finally {
<span class="nc" id="L952">			try {</span>
<span class="nc" id="L953">				connection.close();</span>
<span class="nc" id="L954">			} catch (SQLException e) {</span>
<span class="nc" id="L955">				e.printStackTrace();</span>
<span class="nc" id="L956">				throw new LMSException(e);</span>
<span class="nc" id="L957">			}</span>
		}

<span class="nc" id="L960">		String invListStr = sb.toString();</span>
<span class="nc bnc" id="L961" title="All 2 branches missed.">		if (&quot;&quot;.equals(invListStr)) {</span>
<span class="nc" id="L962">			return &quot;NO Specification&quot;;</span>
		} else {
<span class="nc" id="L964">			return invListStr;</span>
		}
	}

	private String createQuery(String ownerType, String invType, int agtOrgId,
			int retOrgId, int invId, int brandId, String modelId) {

<span class="nc" id="L971">		StringBuilder strQuery = null;</span>
<span class="nc bnc" id="L972" title="All 2 branches missed.">		if (&quot;NON_CONS&quot;.equalsIgnoreCase(invType.trim())) {</span>
<span class="nc" id="L973">			strQuery = new StringBuilder(QueryManager</span>
					.getST_FETCH_NON_CONS_COUNTS_FORORG());

<span class="nc bnc" id="L976" title="All 4 branches missed.">			if (ownerType != null &amp;&amp; !&quot;ALL&quot;.equalsIgnoreCase(ownerType.trim())) {</span>
<span class="nc" id="L977">				strQuery</span>
						.append(&quot; and current_owner_type = '&quot; + ownerType + &quot;'&quot;);
			}

<span class="nc bnc" id="L981" title="All 6 branches missed.">			if (ownerType != null &amp;&amp; &quot;AGENT&quot;.equalsIgnoreCase(ownerType.trim())</span>
					&amp;&amp; agtOrgId &gt; 0) {
<span class="nc" id="L983">				strQuery.append(&quot; and current_owner_id = &quot; + agtOrgId);</span>
<span class="nc bnc" id="L984" title="All 6 branches missed.">			} else if (ownerType != null</span>
					&amp;&amp; &quot;RETAILER&quot;.equalsIgnoreCase(ownerType.trim())
					&amp;&amp; retOrgId &gt; 0) {
<span class="nc" id="L987">				strQuery.append(&quot; and current_owner_id = &quot; + retOrgId);</span>
<span class="nc bnc" id="L988" title="All 6 branches missed.">			}else if (ownerType != null</span>
					&amp;&amp; &quot;RETAILER&quot;.equalsIgnoreCase(ownerType.trim())
					&amp;&amp; retOrgId &lt; 0) {
<span class="nc" id="L991">				strQuery.append(&quot; and ee.parent_id = &quot; + agtOrgId);</span>
			}

<span class="nc bnc" id="L994" title="All 2 branches missed.">			if (invId &gt; 0) {</span>
<span class="nc" id="L995">				strQuery.append(&quot; and bb.inv_id = &quot; + invId);</span>
			}

<span class="nc bnc" id="L998" title="All 2 branches missed.">			if (brandId &gt; 0) {</span>
<span class="nc" id="L999">				strQuery.append(&quot; and bb.brand_id = &quot; + brandId);</span>
			}

<span class="nc bnc" id="L1002" title="All 6 branches missed.">			if (modelId != null &amp;&amp; !&quot;&quot;.equalsIgnoreCase(modelId.trim())</span>
					&amp;&amp; !&quot;-1&quot;.equalsIgnoreCase(modelId.trim())) {
<span class="nc" id="L1004">				strQuery.append(&quot; and aa.inv_model_id = &quot; + modelId);</span>
			}

<span class="nc" id="L1007">			strQuery</span>
					.append(&quot; group by current_owner_id, bb.inv_id  order by &quot;+QueryManager.getAppendOrgOrder());

		} else {
<span class="nc" id="L1011">			strQuery = new StringBuilder(QueryManager</span>
					.getST_FETCH_CONS_COUNTS_FORORG());

<span class="nc bnc" id="L1014" title="All 4 branches missed.">			if (ownerType != null &amp;&amp; !&quot;ALL&quot;.equalsIgnoreCase(ownerType.trim())) {</span>
<span class="nc" id="L1015">				strQuery.append(&quot; and party_type = '&quot; + ownerType + &quot;'&quot;);</span>
			}

<span class="nc bnc" id="L1018" title="All 6 branches missed.">			if (ownerType != null &amp;&amp; &quot;AGENT&quot;.equalsIgnoreCase(ownerType.trim())</span>
					&amp;&amp; agtOrgId &gt; 0) {
<span class="nc" id="L1020">				strQuery.append(&quot; and party_org_id = &quot; + agtOrgId);</span>
<span class="nc bnc" id="L1021" title="All 6 branches missed.">			} else if (ownerType != null</span>
					&amp;&amp; &quot;RETAILER&quot;.equalsIgnoreCase(ownerType.trim())
					&amp;&amp; retOrgId &gt; 0) {
<span class="nc" id="L1024">				strQuery.append(&quot; and party_org_id = &quot; + retOrgId);</span>
			}

<span class="nc bnc" id="L1027" title="All 2 branches missed.">			if (invId &gt; 0) {</span>
<span class="nc" id="L1028">				strQuery.append(&quot; and bb.inv_id = &quot; + invId);</span>
			}

<span class="nc bnc" id="L1031" title="All 6 branches missed.">			if (modelId != null &amp;&amp; !&quot;&quot;.equalsIgnoreCase(modelId.trim())</span>
					&amp;&amp; !&quot;-1&quot;.equalsIgnoreCase(modelId.trim())) {
<span class="nc" id="L1033">				strQuery.append(&quot; and aa.inv_model_id = &quot; + modelId);</span>
			}

<span class="nc" id="L1036">			strQuery.append(&quot; group by party_org_id, bb.inv_id  order by &quot;+QueryManager.getAppendOrgOrder());</span>
		}

<span class="nc" id="L1039">		logger.debug(&quot;inv query = &quot; + strQuery.toString());</span>
<span class="nc" id="L1040">		return strQuery.toString();</span>
	}
	
	private String createQueryAtAgent(String ownerType, String invType, int agtOrgId,
			int retOrgId, int invId, int brandId, String modelId) {

<span class="nc" id="L1046">		StringBuilder strQuery = null;</span>
<span class="nc bnc" id="L1047" title="All 2 branches missed.">		if (&quot;NON_CONS&quot;.equalsIgnoreCase(invType.trim())) {</span>
<span class="nc" id="L1048">			strQuery = new StringBuilder(QueryManager</span>
					.getST_FETCH_NON_CONS_COUNTS_FORORG());

<span class="nc bnc" id="L1051" title="All 4 branches missed.">			if (ownerType != null &amp;&amp; !&quot;ALL&quot;.equalsIgnoreCase(ownerType.trim())) {</span>
<span class="nc" id="L1052">				strQuery</span>
						.append(&quot; and current_owner_type = '&quot; + ownerType + &quot;' AND parent_id=&quot;+agtOrgId);
			}

<span class="nc bnc" id="L1056" title="All 6 branches missed.">			if (ownerType != null &amp;&amp; &quot;ALL&quot;.equalsIgnoreCase(ownerType.trim())</span>
					&amp;&amp; agtOrgId &gt; 0) {
<span class="nc" id="L1058">				strQuery.append(&quot; and (current_owner_id = &quot; + agtOrgId + &quot; OR (current_owner_type='RETAILER' AND parent_id=&quot;+agtOrgId+&quot;))&quot;);</span>
<span class="nc bnc" id="L1059" title="All 6 branches missed.">			} else if (ownerType != null</span>
					&amp;&amp; &quot;RETAILER&quot;.equalsIgnoreCase(ownerType.trim())
					&amp;&amp; retOrgId &gt; 0) {
<span class="nc" id="L1062">				strQuery.append(&quot; and current_owner_id = &quot; + retOrgId);</span>
			}

<span class="nc bnc" id="L1065" title="All 2 branches missed.">			if (invId &gt; 0) {</span>
<span class="nc" id="L1066">				strQuery.append(&quot; and bb.inv_id = &quot; + invId);</span>
			}

<span class="nc bnc" id="L1069" title="All 2 branches missed.">			if (brandId &gt; 0) {</span>
<span class="nc" id="L1070">				strQuery.append(&quot; and bb.brand_id = &quot; + brandId);</span>
			}

<span class="nc bnc" id="L1073" title="All 6 branches missed.">			if (modelId != null &amp;&amp; !&quot;&quot;.equalsIgnoreCase(modelId.trim())</span>
					&amp;&amp; !&quot;-1&quot;.equalsIgnoreCase(modelId.trim())) {
<span class="nc" id="L1075">				strQuery.append(&quot; and aa.inv_model_id = &quot; + modelId);</span>
			}

<span class="nc" id="L1078">			strQuery</span>
					.append(&quot; group by current_owner_id, bb.inv_id  order by &quot;+QueryManager.getAppendOrgOrder());

		} else {
<span class="nc" id="L1082">			strQuery = new StringBuilder(QueryManager</span>
					.getST_FETCH_CONS_COUNTS_FORORG());

<span class="nc bnc" id="L1085" title="All 4 branches missed.">			if (ownerType != null &amp;&amp; !&quot;ALL&quot;.equalsIgnoreCase(ownerType.trim())) {</span>
<span class="nc" id="L1086">				strQuery.append(&quot; and party_type = '&quot; + ownerType + &quot;'&quot;);</span>
			}

<span class="nc bnc" id="L1089" title="All 6 branches missed.">			if (ownerType != null &amp;&amp; &quot;ALL&quot;.equalsIgnoreCase(ownerType.trim())</span>
					&amp;&amp; agtOrgId &gt; 0) {
<span class="nc" id="L1091">				strQuery.append(&quot; and party_org_id = &quot; + agtOrgId);</span>
<span class="nc bnc" id="L1092" title="All 6 branches missed.">			} else if (ownerType != null</span>
					&amp;&amp; &quot;RETAILER&quot;.equalsIgnoreCase(ownerType.trim())
					&amp;&amp; retOrgId &gt; 0) {
<span class="nc" id="L1095">				strQuery.append(&quot; and party_org_id = &quot; + retOrgId);</span>
			}

<span class="nc bnc" id="L1098" title="All 2 branches missed.">			if (invId &gt; 0) {</span>
<span class="nc" id="L1099">				strQuery.append(&quot; and bb.inv_id = &quot; + invId);</span>
			}

<span class="nc bnc" id="L1102" title="All 6 branches missed.">			if (modelId != null &amp;&amp; !&quot;&quot;.equalsIgnoreCase(modelId.trim())</span>
					&amp;&amp; !&quot;-1&quot;.equalsIgnoreCase(modelId.trim())) {
<span class="nc" id="L1104">				strQuery.append(&quot; and aa.inv_model_id = &quot; + modelId);</span>
			}

<span class="nc" id="L1107">			strQuery.append(&quot; group by party_org_id, bb.inv_id  order by &quot;+QueryManager.getAppendOrgOrder());</span>
		}

<span class="nc" id="L1110">		logger.debug(&quot;inv query = &quot; + strQuery.toString());</span>
<span class="nc" id="L1111">		return strQuery.toString();</span>
	}

	private String createQueryToFetchDetails(int ownerId, String invType,
			int invId, int brandId, String modelId) {

<span class="nc" id="L1117">		StringBuilder strQuery = null;</span>
<span class="nc bnc" id="L1118" title="All 2 branches missed.">		if (&quot;NON_CONS&quot;.equalsIgnoreCase(invType.trim())) {</span>
<span class="nc" id="L1119">			strQuery = new StringBuilder(QueryManager</span>
					.getST_FETCH_NON_CONS_DETAIL_FORORG());
<span class="nc" id="L1121">			strQuery.append(&quot; and current_owner_type!= 'REMOVED' &quot;);</span>
<span class="nc bnc" id="L1122" title="All 2 branches missed.">			if (ownerId &gt; 0) {</span>
<span class="nc" id="L1123">				strQuery.append(&quot; and current_owner_id = &quot; + ownerId);</span>
			}
<span class="nc bnc" id="L1125" title="All 2 branches missed.">			if (invId &gt; 0) {</span>
<span class="nc" id="L1126">				strQuery.append(&quot; and bb.inv_id = &quot; + invId);</span>
			}
<span class="nc bnc" id="L1128" title="All 2 branches missed.">			if (brandId &gt; 0) {</span>
<span class="nc" id="L1129">				strQuery.append(&quot; and bb.brand_id = &quot; + brandId);</span>
			}
<span class="nc bnc" id="L1131" title="All 6 branches missed.">			if (modelId != null &amp;&amp; !&quot;&quot;.equalsIgnoreCase(modelId.trim())</span>
					&amp;&amp; !&quot;-1&quot;.equalsIgnoreCase(modelId.trim())) {
<span class="nc" id="L1133">				strQuery.append(&quot; and aa.inv_model_id = &quot; + modelId);</span>
			}
<span class="nc" id="L1135">			strQuery</span>
					.append(&quot; order by name, inv_name, brand_name, model_name, serial_no&quot;);

		} else {
<span class="nc" id="L1139">			strQuery = new StringBuilder(QueryManager</span>
					.getST_FETCH_CONS_DETAIL_FORORG());
<span class="nc bnc" id="L1141" title="All 2 branches missed.">			if (ownerId &gt; 0) {</span>
<span class="nc" id="L1142">				strQuery.append(&quot; and party_org_id = &quot; + ownerId);</span>
			}
<span class="nc bnc" id="L1144" title="All 2 branches missed.">			if (invId &gt; 0) {</span>
<span class="nc" id="L1145">				strQuery.append(&quot; and bb.inv_id = &quot; + invId);</span>
			}
<span class="nc bnc" id="L1147" title="All 6 branches missed.">			if (modelId != null &amp;&amp; !&quot;&quot;.equalsIgnoreCase(modelId.trim())</span>
					&amp;&amp; !&quot;-1&quot;.equalsIgnoreCase(modelId.trim())) {
<span class="nc" id="L1149">				strQuery.append(&quot; and aa.inv_model_id = &quot; + modelId);</span>
			}
<span class="nc" id="L1151">			strQuery</span>
					.append(&quot; order by name, inv_name, brand_name, model_name, serial_no &quot;);
		}

<span class="nc" id="L1155">		logger.debug(&quot;inv query = &quot; + strQuery.toString());</span>
<span class="nc" id="L1156">		return strQuery.toString();</span>
	}

	public Map&lt;String, HashMap&lt;String, String&gt;&gt; fetchAgentNRetList()
			throws LMSException {
<span class="nc" id="L1161">		Connection conn = null;</span>
<span class="nc" id="L1162">		PreparedStatement pstmt =null;</span>
<span class="nc" id="L1163">		ResultSet result =null;</span>
<span class="nc" id="L1164">		Map&lt;String, HashMap&lt;String, String&gt;&gt; map = new TreeMap&lt;String, HashMap&lt;String, String&gt;&gt;();</span>

<span class="nc" id="L1166">		HashMap&lt;String, String&gt; agentMap = new LinkedHashMap&lt;String, String&gt;();</span>
<span class="nc" id="L1167">		 HashMap&lt;String, String&gt; retMap = new LinkedHashMap&lt;String, String&gt;();</span>
<span class="nc" id="L1168">		HashMap&lt;String, String&gt; modelMap = new LinkedHashMap&lt;String, String&gt;();</span>
<span class="nc" id="L1169">		HashMap&lt;String, String&gt; invSpecMap = new LinkedHashMap&lt;String, String&gt;();</span>

		try {
<span class="nc" id="L1172">			conn =DBConnect.getConnection();</span>
			
			// fetch retailer list
<span class="nc" id="L1175">			 pstmt = conn.prepareStatement(&quot;select &quot;+QueryManager.getOrgCodeQuery()+&quot;,organization_id from st_lms_organization_master where organization_status !='TERMINATE' and organization_type='AGENT' order by &quot;+QueryManager.getAppendOrgOrder());</span>
<span class="nc" id="L1176">			 result = pstmt.executeQuery();</span>

<span class="nc" id="L1178">			String orgId = null, orgName = null;</span>
<span class="nc bnc" id="L1179" title="All 2 branches missed.">			while (result.next()) {</span>
<span class="nc" id="L1180">				orgId = result.getInt(TableConstants.ORG_ID) + &quot;&quot;;</span>
<span class="nc" id="L1181">				orgName = result.getString(&quot;orgCode&quot;);</span>
<span class="nc" id="L1182">				agentMap.put(orgId, orgName);</span>
			}

			// fetch retailer list
<span class="nc" id="L1186">			pstmt = conn</span>
					.prepareStatement(&quot;select &quot;+QueryManager.getOrgCodeQuery()+&quot;, organization_id, parent_id from st_lms_organization_master where organization_status !='TERMINATE' and  organization_type='RETAILER' and parent_id not in (select orgANIZATION_id from st_lms_organization_master where organization_type='AGENT' and organization_status='TERMINATE') order by &quot;+QueryManager.getAppendOrgOrder());
<span class="nc" id="L1188">			result = pstmt.executeQuery();</span>

<span class="nc" id="L1190">			orgId = null;</span>
<span class="nc" id="L1191">			orgName = null;</span>
<span class="nc bnc" id="L1192" title="All 2 branches missed.">			while (result.next()) {</span>
<span class="nc" id="L1193">				orgId = result.getInt(TableConstants.ORG_ID) + &quot;-&quot;</span>
						+ result.getInt(&quot;parent_id&quot;);
<span class="nc" id="L1195">				orgName = result.getString(&quot;orgCode&quot;);</span>
<span class="nc" id="L1196">				retMap.put(orgId, orgName);</span>
			}

			// fetch model name list from database
<span class="nc" id="L1200">			pstmt = conn</span>
					.prepareStatement(&quot;select model_id, brand_id, model_name from st_lms_inv_model_master&quot;);
<span class="nc" id="L1202">			result = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1203" title="All 2 branches missed.">			while (result.next()) {</span>
<span class="nc" id="L1204">				modelMap.put(result.getInt(&quot;model_id&quot;) + &quot;-&quot;</span>
						+ result.getInt(&quot;brand_id&quot;), result
						.getString(&quot;model_name&quot;));
			}
<span class="nc" id="L1208">			logger.debug(&quot;modelMap = &quot; + modelMap);</span>

			// fetch model specification list from database
<span class="nc" id="L1211">			pstmt = conn</span>
					.prepareStatement(&quot;select inv_model_id, inv_id, concat(spec_value, '-', spec_unit, '-', spec_type) 'model_name' from st_lms_cons_inv_specification &quot;);
<span class="nc" id="L1213">			ResultSet rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1214" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1215">				invSpecMap.put(rs.getInt(&quot;inv_model_id&quot;) + &quot;-&quot;</span>
						+ rs.getInt(&quot;inv_id&quot;), rs.getString(&quot;model_name&quot;));
			}
<span class="nc" id="L1218">			logger.debug(&quot;invSpecMap = &quot; + invSpecMap);</span>

<span class="nc" id="L1220">			map.put(&quot;agentMap&quot;, agentMap);</span>
<span class="nc" id="L1221">			map.put(&quot;retMap&quot;, retMap);</span>
<span class="nc" id="L1222">			map.put(&quot;invSpecMap&quot;, invSpecMap);</span>
<span class="nc" id="L1223">			map.put(&quot;modelMap&quot;, modelMap);</span>

<span class="nc" id="L1225">			map.putAll(fetchInvDetails());</span>

<span class="nc" id="L1227">		} catch (SQLException e) {</span>
<span class="nc" id="L1228">			e.printStackTrace();</span>
<span class="nc" id="L1229">			throw new LMSException(e);</span>
		} finally {
<span class="nc" id="L1231">			try {</span>
<span class="nc" id="L1232">				conn.close();</span>
<span class="nc" id="L1233">			} catch (SQLException e) {</span>
<span class="nc" id="L1234">				e.printStackTrace();</span>
<span class="nc" id="L1235">			}</span>
<span class="nc" id="L1236">		}</span>

<span class="nc" id="L1238">		return map;</span>
	}
	
	public Map&lt;String, Map&lt;String, String&gt;&gt; fetchAgentNRetListAtAgent(UserInfoBean userBean) throws LMSException {
<span class="nc" id="L1242">		Connection conn = null;</span>
<span class="nc" id="L1243">		Map&lt;String, Map&lt;String, String&gt;&gt; map = new TreeMap&lt;String, Map&lt;String, String&gt;&gt;();</span>
		
<span class="nc" id="L1245">		Map&lt;String, String&gt; retMap = new LinkedHashMap&lt;String, String&gt;();</span>
<span class="nc" id="L1246">		Map&lt;String, String&gt; modelMap = new LinkedHashMap&lt;String, String&gt;();</span>
<span class="nc" id="L1247">		Map&lt;String, String&gt; invSpecMap = new LinkedHashMap&lt;String, String&gt;();</span>
		
		try {
<span class="nc" id="L1250">			conn =DBConnect.getConnection();</span>
		
			// fetch retailer list
<span class="nc" id="L1253">			PreparedStatement pstmt = conn</span>
					.prepareStatement(&quot;select name, organization_id, parent_id from st_lms_organization_master where organization_status !='TERMINATE' and organization_type='RETAILER' and parent_id=?&quot;);
<span class="nc" id="L1255">			pstmt.setInt(1, userBean.getUserOrgId());</span>
<span class="nc" id="L1256">			ResultSet result = pstmt.executeQuery();</span>
		
<span class="nc" id="L1258">		String orgId = null, orgName = null;</span>
<span class="nc bnc" id="L1259" title="All 2 branches missed.">			while (result.next()) {</span>
<span class="nc" id="L1260">				orgId = result.getString(TableConstants.ORG_ID);</span>
<span class="nc" id="L1261">				orgName = result.getString(TableConstants.NAME);</span>
<span class="nc" id="L1262">				retMap.put(orgId, orgName);</span>
			}
		
			// fetch model name list from database
<span class="nc" id="L1266">			pstmt = conn</span>
					.prepareStatement(&quot;select model_id, brand_id, model_name from st_lms_inv_model_master&quot;);
<span class="nc" id="L1268">			result = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1269" title="All 2 branches missed.">			while (result.next()) {</span>
<span class="nc" id="L1270">				modelMap.put(result.getInt(&quot;model_id&quot;) + &quot;-&quot;</span>
						+ result.getInt(&quot;brand_id&quot;), result
						.getString(&quot;model_name&quot;));
			}
<span class="nc" id="L1274">			logger.debug(&quot;modelMap = &quot; + modelMap);</span>
		
			// fetch model specification list from database
<span class="nc" id="L1277">			pstmt = conn</span>
					.prepareStatement(&quot;select inv_model_id, inv_id, concat(spec_value, '-', spec_unit, '-', spec_type) 'model_name' from st_lms_cons_inv_specification &quot;);
<span class="nc" id="L1279">			ResultSet rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1280" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1281">				invSpecMap.put(rs.getInt(&quot;inv_model_id&quot;) + &quot;-&quot;</span>
						+ rs.getInt(&quot;inv_id&quot;), rs.getString(&quot;model_name&quot;));
			}
<span class="nc" id="L1284">			logger.debug(&quot;invSpecMap = &quot; + invSpecMap);</span>
		
<span class="nc" id="L1286">			map.put(&quot;retMap&quot;, retMap);</span>
<span class="nc" id="L1287">			map.put(&quot;invSpecMap&quot;, invSpecMap);</span>
<span class="nc" id="L1288">			map.put(&quot;modelMap&quot;, modelMap);</span>
		
<span class="nc" id="L1290">			map.putAll(fetchInvDetails());</span>
		
<span class="nc" id="L1292">		} catch (SQLException e) {</span>
<span class="nc" id="L1293">			e.printStackTrace();</span>
<span class="nc" id="L1294">			throw new LMSException(e);</span>
		} finally {
<span class="nc" id="L1296">			try {</span>
<span class="nc" id="L1297">				conn.close();</span>
<span class="nc" id="L1298">			} catch (SQLException e) {</span>
<span class="nc" id="L1299">				e.printStackTrace();</span>
<span class="nc" id="L1300">			}</span>
<span class="nc" id="L1301">		}</span>
		
<span class="nc" id="L1303">		return map;</span>
	}

	public Map&lt;String, Map&lt;String, String&gt;&gt; fetchConsInvNModelSpecDetail(
			String invType,String cntrlType) throws LMSException {

<span class="nc" id="L1309">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L1310">		Map&lt;String, Map&lt;String, String&gt;&gt; invDetMap = new TreeMap&lt;String, Map&lt;String, String&gt;&gt;();</span>
		try {
<span class="nc" id="L1312">			Statement stmt = con.createStatement();</span>
<span class="nc" id="L1313">			ResultSet rs = null;</span>

<span class="nc" id="L1315">			Map&lt;String, String&gt; invMap = new TreeMap&lt;String, String&gt;();</span>
<span class="nc" id="L1316">			Map&lt;String, String&gt; brandMap = new TreeMap&lt;String, String&gt;();</span>
<span class="nc" id="L1317">			Map&lt;String, String&gt; modelMap = new TreeMap&lt;String, String&gt;();</span>
<span class="nc" id="L1318">			Map&lt;String, String&gt; modelMapForBindingLength = new TreeMap&lt;String, String&gt;();</span>
<span class="nc" id="L1319">			Map&lt;String, String&gt; invSpecMap = new TreeMap&lt;String, String&gt;();</span>
<span class="nc" id="L1320">			Map&lt;String, String&gt; invCodeMap = new TreeMap&lt;String, String&gt;();</span>
			// fetch inventory name list from database
			
<span class="nc" id="L1323">			String invQry =&quot;select inv_id, inv_name, inv_type from st_lms_inv_master where inv_type = '&quot;+ invType + &quot;'&quot; ;</span>
<span class="nc bnc" id="L1324" title="All 2 branches missed.">			if(&quot;N&quot;.contentEquals(cntrlType)){</span>
<span class="nc" id="L1325">				invQry=&quot;select inv_id, inv_name, inv_type from st_lms_inv_master where inv_type = '&quot;+ invType + &quot;' and is_usr_cntrl='N'&quot; ;</span>
				
<span class="nc bnc" id="L1327" title="All 2 branches missed.">			}else if(&quot;Y&quot;.contentEquals(cntrlType)){</span>
<span class="nc" id="L1328">				invQry =&quot;select inv_id, inv_name, inv_type from st_lms_inv_master where inv_type = '&quot;+ invType + &quot;' and is_usr_cntrl='Y'&quot; ;</span>
				
			}
<span class="nc" id="L1331">			rs = stmt</span>
					.executeQuery(invQry);
<span class="nc bnc" id="L1333" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1334">				invMap.put(rs.getInt(&quot;inv_id&quot;) + &quot;&quot;, rs.getString(&quot;inv_name&quot;));</span>
			}
<span class="nc" id="L1336">			logger.debug(&quot;invMap = &quot; + invMap);</span>

<span class="nc bnc" id="L1338" title="All 2 branches missed.">			if (&quot;NON_CONS&quot;.equalsIgnoreCase(invType.trim())) {</span>

				// fetch brand name list from database
<span class="nc" id="L1341">				rs = stmt</span>
						.executeQuery(&quot;select brand_id, inv_id, brand_name from st_lms_inv_brand_master&quot;);
<span class="nc bnc" id="L1343" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L1344">					brandMap.put(rs.getInt(&quot;brand_id&quot;) + &quot;-&quot;</span>
							+ rs.getInt(&quot;inv_id&quot;), rs.getString(&quot;brand_name&quot;));
				}
<span class="nc" id="L1347">				logger.debug(&quot;brandMap = &quot; + brandMap);</span>

				// fetch model name list from database
<span class="nc" id="L1350">				rs = stmt</span>
						.executeQuery(&quot;select model_id, brand_id, model_name, check_binding_length,is_inv_code_req from st_lms_inv_model_master&quot;);
<span class="nc bnc" id="L1352" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L1353">					modelMap</span>
							.put(rs.getInt(&quot;model_id&quot;) + &quot;-&quot;
									+ rs.getInt(&quot;brand_id&quot;), rs
									.getString(&quot;model_name&quot;));
					
<span class="nc" id="L1358">					modelMapForBindingLength</span>
					.put(rs.getInt(&quot;model_id&quot;) + &quot;-&quot;
							+ rs.getInt(&quot;brand_id&quot;), rs
							.getString(&quot;check_binding_length&quot;));
<span class="nc" id="L1362">					invCodeMap.put(rs.getInt(&quot;model_id&quot;)+ &quot;-&quot;</span>
							+ rs.getInt(&quot;brand_id&quot;), rs.getString(&quot;is_inv_code_req&quot;));
					
				}
<span class="nc" id="L1366">				logger.debug(&quot;modelMap = &quot; + modelMap);</span>

			} else {
				// fetch model specification list from database
<span class="nc" id="L1370">				rs = stmt</span>
						.executeQuery(&quot;select inv_model_id, inv_id, concat(spec_value, '-', spec_unit, '-', spec_type) 'model_name' from st_lms_cons_inv_specification &quot;);
<span class="nc bnc" id="L1372" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L1373">					invSpecMap.put(rs.getInt(&quot;inv_model_id&quot;) + &quot;-&quot;</span>
							+ rs.getInt(&quot;inv_id&quot;), rs.getString(&quot;model_name&quot;));
				}
<span class="nc" id="L1376">				logger.debug(&quot;invSpecMap = &quot; + invSpecMap);</span>
			}

<span class="nc" id="L1379">			invDetMap.put(&quot;invMap&quot;, invMap);</span>
<span class="nc" id="L1380">			invDetMap.put(&quot;invSpecMap&quot;, invSpecMap);</span>
<span class="nc" id="L1381">			invDetMap.put(&quot;brandMap&quot;, brandMap);</span>
<span class="nc" id="L1382">			invDetMap.put(&quot;modelMap&quot;, modelMap);</span>
<span class="nc" id="L1383">			invDetMap.put(&quot;modelMapBindingLength&quot;, modelMapForBindingLength);</span>
<span class="nc" id="L1384">			invDetMap.put(&quot;invCodeMap&quot;, invCodeMap);</span>
<span class="nc" id="L1385">		} catch (SQLException e) {</span>
<span class="nc" id="L1386">			e.printStackTrace();</span>
<span class="nc" id="L1387">			throw new LMSException(e);</span>

		} finally {
<span class="nc" id="L1390">			try {</span>
<span class="nc" id="L1391">				con.close();</span>
<span class="nc" id="L1392">			} catch (SQLException e) {</span>
<span class="nc" id="L1393">				e.printStackTrace();</span>
<span class="nc" id="L1394">				throw new LMSException(e);</span>
<span class="nc" id="L1395">			}</span>
		}

<span class="nc" id="L1398">		return invDetMap;</span>
	}

	public Map&lt;String, HashMap&lt;String, String&gt;&gt; fetchInvDetails()
			throws LMSException {

<span class="nc" id="L1404">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L1405">		Map&lt;String, HashMap&lt;String, String&gt;&gt; invDetMap = new LinkedHashMap&lt;String, HashMap&lt;String, String&gt;&gt;();</span>
		try {
<span class="nc" id="L1407">			Statement stmt = con.createStatement();</span>
<span class="nc" id="L1408">			ResultSet rs = null;</span>

			// fetch inventory name list from database
<span class="nc" id="L1411">			rs = stmt</span>
					.executeQuery(&quot;select inv_id, inv_name, inv_type from st_lms_inv_master&quot;);
<span class="nc" id="L1413">			HashMap&lt;String, String&gt; nonConsInvMap = new LinkedHashMap&lt;String, String&gt;();</span>
<span class="nc" id="L1414">			HashMap&lt;String, String&gt; consInvMap = new LinkedHashMap&lt;String, String&gt;();</span>
<span class="nc bnc" id="L1415" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc bnc" id="L1416" title="All 2 branches missed.">				if (&quot;NON_CONS&quot;</span>
						.equalsIgnoreCase(rs.getString(&quot;inv_type&quot;).trim())) {
<span class="nc" id="L1418">					nonConsInvMap.put(rs.getInt(&quot;inv_id&quot;) + &quot;&quot;, rs</span>
							.getString(&quot;inv_name&quot;));
				} else {
<span class="nc" id="L1421">					consInvMap.put(rs.getInt(&quot;inv_id&quot;) + &quot;&quot;, rs</span>
							.getString(&quot;inv_name&quot;));
				}
			}

			// fetch inventory name list from database
<span class="nc" id="L1427">			rs = stmt</span>
					.executeQuery(&quot;select brand_id, inv_id, brand_name from st_lms_inv_brand_master&quot;);
<span class="nc" id="L1429">			HashMap&lt;String, String&gt; brandMap = new LinkedHashMap&lt;String, String&gt;();</span>
<span class="nc bnc" id="L1430" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1431">				brandMap.put(rs.getInt(&quot;brand_id&quot;) + &quot;-&quot; + rs.getInt(&quot;inv_id&quot;),</span>
						rs.getString(&quot;brand_name&quot;));
			}

<span class="nc" id="L1435">			invDetMap.put(&quot;nonConsInvMap&quot;, nonConsInvMap);</span>
<span class="nc" id="L1436">			invDetMap.put(&quot;consInvMap&quot;, consInvMap);</span>
<span class="nc" id="L1437">			invDetMap.put(&quot;brandMap&quot;, brandMap);</span>

<span class="nc" id="L1439">		} catch (SQLException e) {</span>
<span class="nc" id="L1440">			e.printStackTrace();</span>
<span class="nc" id="L1441">			throw new LMSException(e);</span>

		} finally {
<span class="nc" id="L1444">			try {</span>
<span class="nc" id="L1445">				con.close();</span>
<span class="nc" id="L1446">			} catch (SQLException e) {</span>
<span class="nc" id="L1447">				e.printStackTrace();</span>
<span class="nc" id="L1448">				throw new LMSException(e);</span>
<span class="nc" id="L1449">			}</span>
		}

<span class="nc" id="L1452">		return invDetMap;</span>
	}

	
	
	public Map&lt;String,String&gt; fetchAgentModuleSerial(String modelid,int orgId) throws LMSException {

<span class="nc" id="L1459">		Connection con = DBConnect.getConnection();</span>
		
<span class="nc" id="L1461">		Map&lt;String, String&gt; agentModelSerialMap = new LinkedHashMap&lt;String, String&gt;();</span>
				
		try {
			
<span class="nc" id="L1465">			String orgCodeQry = &quot;  name orgCode &quot;;</span>

			
<span class="nc bnc" id="L1468" title="All 2 branches missed.">			if ((LMSFilterDispatcher.orgFieldType).equalsIgnoreCase(&quot;CODE&quot;)) {</span>
<span class="nc" id="L1469">				orgCodeQry = &quot; org_code orgCode &quot;;</span>


<span class="nc bnc" id="L1472" title="All 2 branches missed.">			} else if ((LMSFilterDispatcher.orgFieldType)</span>
					.equalsIgnoreCase(&quot;CODE_NAME&quot;)) {
<span class="nc" id="L1474">				orgCodeQry = &quot; concat(org_code,'_',name)  orgCode &quot;;</span>
			

<span class="nc bnc" id="L1477" title="All 2 branches missed.">			} else if ((LMSFilterDispatcher.orgFieldType)</span>
					.equalsIgnoreCase(&quot;NAME_CODE&quot;)) {
<span class="nc" id="L1479">				orgCodeQry = &quot; concat(name,'_',org_code)  orgCode &quot;;</span>
			

			}
<span class="nc" id="L1483">			String fetchInvDetQuery=&quot;select &quot;+orgCodeQry+&quot;,organization_id,serial_no,current_owner_type, parent_id,inv_model_id &quot; +</span>
					&quot;from st_lms_organization_master inner join st_lms_inv_status on &quot; +
					&quot;current_owner_type=organization_type and current_owner_id=organization_id where&quot; +
					&quot; organization_type in('RETAILER','AGENT')and parent_id=&quot;+orgId +&quot; and inv_model_id='&quot;+modelid +&quot;' or organization_id =&quot;+orgId +&quot; and inv_model_id='&quot;+modelid +&quot;'  order by &quot;+QueryManager.getAppendOrgOrder();
<span class="nc" id="L1487">			Statement stmt = con.createStatement();</span>
<span class="nc" id="L1488">			ResultSet rs = stmt.executeQuery(fetchInvDetQuery);</span>
<span class="nc" id="L1489">			StringBuilder agentSerial=new StringBuilder();</span>
		
<span class="nc bnc" id="L1491" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc bnc" id="L1492" title="All 2 branches missed.">				if(&quot;agent&quot;.equalsIgnoreCase(rs.getString(&quot;current_owner_type&quot;))){</span>
<span class="nc" id="L1493">					agentSerial.append(rs.getString(&quot;serial_no&quot;)+&quot;, &quot;);</span>
<span class="nc" id="L1494">					agentModelSerialMap.put(rs.getString(&quot;current_owner_type&quot;)+&quot;-&quot; + rs.getString(&quot;orgCode&quot;), agentSerial.toString());</span>
				}else{
<span class="nc" id="L1496">				agentModelSerialMap.put(rs.getString(&quot;current_owner_type&quot;)+&quot;-&quot; + rs.getString(&quot;orgCode&quot;), rs.getString(&quot;serial_no&quot;));</span>
				}
				
<span class="nc" id="L1499">				logger.debug(&quot;agentModelSerialMap = &quot; + agentModelSerialMap);</span>
				
				
			}
			
			
			
<span class="nc" id="L1506">			logger.debug(&quot;agentModelSerialMap = &quot; + agentModelSerialMap);</span>
			
			
<span class="nc" id="L1509">		} catch (SQLException e) {</span>
<span class="nc" id="L1510">			e.printStackTrace();</span>
<span class="nc" id="L1511">			throw new LMSException(e);</span>

		} finally {
<span class="nc" id="L1514">			try {</span>
<span class="nc" id="L1515">				con.close();</span>
<span class="nc" id="L1516">			} catch (SQLException e) {</span>
<span class="nc" id="L1517">				e.printStackTrace();</span>
<span class="nc" id="L1518">				throw new LMSException(e);</span>
<span class="nc" id="L1519">			}</span>
		}

<span class="nc" id="L1522">		return agentModelSerialMap;</span>
	}
	
	public Map&lt;String, TreeMap&lt;String, String&gt;&gt; fetchTerminalRetailerInvntoryCount(int orgId) throws LMSException {

<span class="nc" id="L1527">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L1528">		List&lt;ConsNNonConsBean&gt; invDetList = new ArrayList&lt;ConsNNonConsBean&gt;();</span>
<span class="nc" id="L1529">		Map&lt;String, String&gt; modelMap = new TreeMap&lt;String, String&gt;();</span>
		
<span class="nc" id="L1531">		Map&lt;String,TreeMap&lt;String,String&gt;&gt; retailerCountMap = new LinkedHashMap&lt;String,TreeMap&lt;String,String&gt;&gt;();</span>
		try {
			PreparedStatement pstmt;
<span class="nc" id="L1534">			pstmt = con</span>
			.prepareStatement(&quot;select model_id, model_name from st_lms_inv_model_master where inv_id=1&quot;);
<span class="nc" id="L1536">			ResultSet rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1537" title="All 2 branches missed.">	while (rs.next()) {</span>
<span class="nc" id="L1538">		modelMap.put(rs.getString(&quot;model_id&quot;) , rs</span>
				.getString(&quot;model_name&quot;));
	}
<span class="nc" id="L1541">	logger.debug(&quot;modelMap = &quot; + modelMap);</span>
<span class="nc" id="L1542">	String orgCodeQry = &quot;  name orgCode &quot;;</span>

	
<span class="nc bnc" id="L1545" title="All 2 branches missed.">	if ((LMSFilterDispatcher.orgFieldType).equalsIgnoreCase(&quot;CODE&quot;)) {</span>
<span class="nc" id="L1546">		orgCodeQry = &quot; org_code orgCode &quot;;</span>


<span class="nc bnc" id="L1549" title="All 2 branches missed.">	} else if ((LMSFilterDispatcher.orgFieldType)</span>
			.equalsIgnoreCase(&quot;CODE_NAME&quot;)) {
<span class="nc" id="L1551">		orgCodeQry = &quot; concat(org_code,'_',name)  orgCode &quot;;</span>
	

<span class="nc bnc" id="L1554" title="All 2 branches missed.">	} else if ((LMSFilterDispatcher.orgFieldType)</span>
			.equalsIgnoreCase(&quot;NAME_CODE&quot;)) {
<span class="nc" id="L1556">		orgCodeQry = &quot; concat(name,'_',org_code)  orgCode &quot;;</span>
	

	}
			
<span class="nc" id="L1561">			String fetchInvDetQuery=&quot;select orgCode,organization_id,a.serial_no,a.model_name,a.current_owner_type,a.parent_id,a.inv_model_id,a.count from(select &quot;+orgCodeQry+&quot;,serial_no,(select model_name from st_lms_inv_model_master where model_id=inv_model_id) model_name,current_owner_type, parent_id,organization_id,inv_model_id,count(serial_no) count from st_lms_organization_master inner join st_lms_inv_status on current_owner_type=organization_type and&quot; +</span>
					&quot; current_owner_id=organization_id where organization_type in('RETAILER','AGENT')and parent_id=&quot;+orgId+&quot; &quot; +
					&quot; or current_owner_id=&quot;+orgId+&quot; group by current_owner_id,inv_model_id) a inner join st_lms_inv_model_master b on b.model_id = a.inv_model_id where b.inv_id=1 order by &quot;+QueryManager.getAppendOrgOrder();
<span class="nc" id="L1564">			Statement stmt = con.createStatement();</span>
<span class="nc" id="L1565">			 rs = stmt.executeQuery(fetchInvDetQuery);</span>
			
				
<span class="nc bnc" id="L1568" title="All 2 branches missed.">			while (rs.next()) {</span>
				
<span class="nc" id="L1570">				Map&lt;String, String&gt; modelCountMap = new TreeMap&lt;String,String&gt;();</span>
				
<span class="nc bnc" id="L1572" title="All 2 branches missed.">				for (Map.Entry&lt;String, String&gt; entry : modelMap.entrySet()) {</span>
<span class="nc" id="L1573">			        System.out.println(&quot;Key = &quot; + entry.getKey() + &quot;, Value = &quot; + entry.getValue());</span>
<span class="nc bnc" id="L1574" title="All 2 branches missed.">			        if(rs.getString(&quot;model_name&quot;).equals(entry.getValue())){       	</span>
			        	    
<span class="nc" id="L1576">			        	modelCountMap.put(rs.getString(&quot;inv_model_id&quot;),rs.getString(&quot;count&quot;));</span>
<span class="nc" id="L1577">			        	boolean agentCount=retailerCountMap.containsKey(rs.getString(&quot;orgCode&quot;));</span>
<span class="nc bnc" id="L1578" title="All 2 branches missed.">						if(!agentCount){</span>
<span class="nc" id="L1579">							retailerCountMap.put(rs.getString(&quot;orgCode&quot;), (TreeMap&lt;String, String&gt;) modelCountMap);</span>
			        	}else{
			        		
<span class="nc" id="L1582">			        		retailerCountMap.get(rs.getString(&quot;orgCode&quot;)).putAll(modelCountMap);</span>
			        	}	
			        }
			        	
<span class="nc" id="L1586">			    }</span>
<span class="nc bnc" id="L1587" title="All 2 branches missed.">				for (Map.Entry&lt;String, String&gt; entry : modelMap.entrySet()) {</span>
<span class="nc" id="L1588">			        System.out.println(&quot;Key = &quot; + entry.getKey() + &quot;, Value = &quot; + entry.getValue());</span>
<span class="nc bnc" id="L1589" title="All 2 branches missed.">			        if(!(retailerCountMap.get(rs.getString(&quot;orgCode&quot;)).containsKey(entry.getKey()))){ </span>
<span class="nc" id="L1590">			        	retailerCountMap.get(rs.getString(&quot;orgCode&quot;)).put(entry.getKey(), null);</span>
			        
			        }
<span class="nc" id="L1593">			}</span>
			
			
<span class="nc" id="L1596">			}</span>
<span class="nc" id="L1597">			logger.debug(&quot;retailerCountMap = &quot; + retailerCountMap);</span>
			
			
<span class="nc" id="L1600">		} catch (SQLException e) {</span>
<span class="nc" id="L1601">			e.printStackTrace();</span>
<span class="nc" id="L1602">			throw new LMSException(e);</span>

		} finally {
<span class="nc" id="L1605">			try {</span>
<span class="nc" id="L1606">				con.close();</span>
<span class="nc" id="L1607">			} catch (SQLException e) {</span>
<span class="nc" id="L1608">				e.printStackTrace();</span>
<span class="nc" id="L1609">				throw new LMSException(e);</span>
<span class="nc" id="L1610">			}</span>
		}

<span class="nc" id="L1613">		return retailerCountMap;</span>
	}
	
	
	public Map&lt;String,TreeMap&lt;String,String&gt;&gt; fetchTerminalInvntoryCount() throws LMSException {

<span class="nc" id="L1619">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L1620">		List&lt;ConsNNonConsBean&gt; invDetList = new ArrayList&lt;ConsNNonConsBean&gt;();</span>
<span class="nc" id="L1621">		TreeMap&lt;String, String&gt; modelMap = new TreeMap&lt;String, String&gt;();</span>
		
<span class="nc" id="L1623">		Map&lt;String,TreeMap&lt;String,String&gt;&gt; agentCountMap = new LinkedHashMap&lt;String,TreeMap&lt;String,String&gt;&gt;();</span>
		try {
			PreparedStatement pstmt;
<span class="nc" id="L1626">			pstmt = con</span>
			.prepareStatement(&quot;select model_id, model_name from st_lms_inv_model_master where inv_id = 1&quot;);
<span class="nc" id="L1628">			ResultSet rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1629" title="All 2 branches missed.">	while (rs.next()) {</span>
<span class="nc" id="L1630">		modelMap.put(rs.getString(&quot;model_id&quot;) , rs</span>
				.getString(&quot;model_name&quot;));
	}
<span class="nc" id="L1633">	logger.debug(&quot;modelMap = &quot; + modelMap);</span>
<span class="nc" id="L1634">	String orgCodeQry = &quot;  name orgCode &quot;;</span>

<span class="nc bnc" id="L1636" title="All 2 branches missed.">	if ((LMSFilterDispatcher.orgFieldType).equalsIgnoreCase(&quot;CODE&quot;)) {</span>
<span class="nc" id="L1637">		orgCodeQry = &quot; org_code orgCode &quot;;</span>

<span class="nc bnc" id="L1639" title="All 2 branches missed.">	} else if ((LMSFilterDispatcher.orgFieldType)</span>
			.equalsIgnoreCase(&quot;CODE_NAME&quot;)) {
<span class="nc" id="L1641">		orgCodeQry = &quot; concat(org_code,'_',name)  orgCode &quot;;</span>
	

<span class="nc bnc" id="L1644" title="All 2 branches missed.">	} else if ((LMSFilterDispatcher.orgFieldType)</span>
			.equalsIgnoreCase(&quot;NAME_CODE&quot;)) {
<span class="nc" id="L1646">		orgCodeQry = &quot; concat(name,'_',org_code)  orgCode &quot;;</span>
	

	}
	
	
	
<span class="nc" id="L1653">			String fetchInvBoDet=&quot;select a.orgCode,a.model_name,a.organization_id orgId,a.inv_model_id,a.count,a.current_owner_type user_org_type from(select &quot;+orgCodeQry+&quot;,(select model_name from st_lms_inv_model_master where model_id=inv_model_id) model_name, organization_id,inv_model_id,count(serial_no) count,current_owner_type from st_lms_organization_master inner join st_lms_inv_status on current_owner_type=organization_type&quot; +</span>
					&quot; and current_owner_id=organization_id where organization_type='BO' group by current_owner_id,inv_model_id) a inner join st_lms_inv_model_master b on b.model_id = a.inv_model_id where b.inv_id=1 order by &quot;+QueryManager.getAppendOrgOrder(); 
<span class="nc" id="L1655">			Statement stmt = con.createStatement();</span>
<span class="nc" id="L1656">			 rs = stmt.executeQuery(fetchInvBoDet);</span>
<span class="nc bnc" id="L1657" title="All 2 branches missed.">			 while (rs.next()) {</span>
<span class="nc" id="L1658">					TreeMap&lt;String, String&gt; modelCountMap = null;</span>
					
<span class="nc bnc" id="L1660" title="All 2 branches missed.">					for (Map.Entry&lt;String, String&gt; entry : modelMap.entrySet()) {</span>
<span class="nc" id="L1661">				        System.out.println(&quot;Key = &quot; + entry.getKey() + &quot;, Value = &quot; + entry.getValue());</span>
<span class="nc bnc" id="L1662" title="All 2 branches missed.">				        if(rs.getString(&quot;model_name&quot;).equals(entry.getValue())){       	</span>
				        	    
				        	
<span class="nc" id="L1665">				        	boolean agentCount=agentCountMap.containsKey(rs.getString(&quot;orgCode&quot;)+&quot;Nxt&quot;+rs.getString(&quot;user_org_type&quot;)+&quot;Nxt&quot;+rs.getInt(&quot;orgId&quot;));</span>
<span class="nc bnc" id="L1666" title="All 2 branches missed.">							if(!agentCount){</span>
<span class="nc" id="L1667">								modelCountMap = new TreeMap&lt;String,String&gt;();</span>
<span class="nc" id="L1668">								modelCountMap.put(rs.getString(&quot;inv_model_id&quot;),rs.getString(&quot;count&quot;));</span>
<span class="nc" id="L1669">								agentCountMap.put(((rs.getString(&quot;orgCode&quot;)+&quot;Nxt&quot;+rs.getString(&quot;user_org_type&quot;)+&quot;Nxt&quot;+rs.getInt(&quot;orgId&quot;))), modelCountMap);</span>
				        	}else{
<span class="nc" id="L1671">				        		modelCountMap=agentCountMap.get((rs.getString(&quot;orgCode&quot;)+&quot;Nxt&quot;+rs.getString(&quot;user_org_type&quot;)+&quot;Nxt&quot;+rs.getInt(&quot;orgId&quot;)));</span>
<span class="nc" id="L1672">				        		modelCountMap.put(rs.getString(&quot;inv_model_id&quot;),rs.getString(&quot;count&quot;));</span>
<span class="nc" id="L1673">				        		agentCountMap.get((rs.getString(&quot;orgCode&quot;)+&quot;Nxt&quot;+rs.getString(&quot;user_org_type&quot;)+&quot;Nxt&quot;+rs.getInt(&quot;orgId&quot;))).putAll(modelCountMap);</span>
				        	}	
				        }
				        	
<span class="nc" id="L1677">				    }</span>
<span class="nc bnc" id="L1678" title="All 2 branches missed.">					for (Map.Entry&lt;String, String&gt; entry : modelMap.entrySet()) {</span>
<span class="nc" id="L1679">				        System.out.println(&quot;Key = &quot; + entry.getKey() + &quot;, Value = &quot; + entry.getValue());</span>
<span class="nc bnc" id="L1680" title="All 2 branches missed.">				        if(!(agentCountMap.get(rs.getString(&quot;orgCode&quot;)+&quot;Nxt&quot;+rs.getString(&quot;user_org_type&quot;)+&quot;Nxt&quot;+rs.getInt(&quot;orgId&quot;)).containsKey(entry.getKey()))){ </span>
<span class="nc" id="L1681">				        	agentCountMap.get((rs.getString(&quot;orgCode&quot;)+&quot;Nxt&quot;+rs.getString(&quot;user_org_type&quot;)+&quot;Nxt&quot;+rs.getInt(&quot;orgId&quot;))).put(entry.getKey(), null);</span>
				        
				        }
<span class="nc" id="L1684">				}</span>
				 
<span class="nc" id="L1686">			 }</span>
			
			
<span class="nc" id="L1689">			String fetchInvDetQuery=&quot;select a.orgCode,a.model_name,a.organization_id orgId,a.inv_model_id,a.count,a.current_owner_type from(select (select  &quot;+orgCodeQry+&quot; from st_lms_organization_master where organization_id=invTlb.organization_id) orgCode,&quot; +</span>
					&quot;organization_id,inv_model_id,sum(count) count, (select model_name from st_lms_inv_model_master where model_id=invTlb.inv_model_id) model_name,current_owner_type &quot; +
					&quot;from (select  &quot;+orgCodeQry+&quot;, organization_id,inv_model_id,count(serial_no) count,current_owner_type from st_lms_organization_master inner join st_lms_inv_status on current_owner_type=organization_type&quot; +
					&quot; and current_owner_id=organization_id where organization_type='AGENT' group by current_owner_id,inv_model_id union all select  &quot;+orgCodeQry+&quot;, parent_id,inv_model_id,count(inv_model_id)&quot; +
					&quot; count,current_owner_type from st_lms_organization_master inner join st_lms_inv_status on current_owner_type=organization_type and current_owner_id=organization_id where organization_type='RETAILER'&quot; +
					&quot; group by current_owner_id,inv_model_id) invTlb group by organization_id,inv_model_id) a inner join st_lms_inv_model_master b on b.model_id = a.inv_model_id where b.inv_id=1 order by &quot;+QueryManager.getAppendOrgOrder();
<span class="nc" id="L1695">		 stmt = con.createStatement();</span>
<span class="nc" id="L1696">			 rs = stmt.executeQuery(fetchInvDetQuery);</span>
			
			
<span class="nc bnc" id="L1699" title="All 2 branches missed.">			while (rs.next()) {</span>
				
<span class="nc" id="L1701">				TreeMap&lt;String, String&gt; modelCountMap = null;</span>
				
<span class="nc bnc" id="L1703" title="All 2 branches missed.">				for (Map.Entry&lt;String, String&gt; entry : modelMap.entrySet()) {</span>
<span class="nc" id="L1704">			        System.out.println(&quot;Key = &quot; + entry.getKey() + &quot;, Value = &quot; + entry.getValue());</span>
<span class="nc bnc" id="L1705" title="All 2 branches missed.">			        if(rs.getString(&quot;model_name&quot;).equals(entry.getValue())){       	</span>
			        	    
			        	
<span class="nc" id="L1708">			        	boolean agentCount=agentCountMap.containsKey(rs.getString(&quot;orgCode&quot;)+&quot;Nxt&quot;+rs.getInt(&quot;orgId&quot;));</span>
<span class="nc bnc" id="L1709" title="All 2 branches missed.">						if(!agentCount){</span>
<span class="nc" id="L1710">							modelCountMap = new TreeMap&lt;String,String&gt;();</span>
<span class="nc" id="L1711">							modelCountMap.put(rs.getString(&quot;inv_model_id&quot;),rs.getString(&quot;count&quot;));</span>
<span class="nc" id="L1712">							agentCountMap.put((rs.getString(&quot;orgCode&quot;)+&quot;Nxt&quot;+rs.getInt(&quot;orgId&quot;)), modelCountMap);</span>
			        	}else{
<span class="nc" id="L1714">			        		modelCountMap=agentCountMap.get((rs.getString(&quot;orgCode&quot;)+&quot;Nxt&quot;+rs.getInt(&quot;orgId&quot;)));</span>
<span class="nc" id="L1715">			        		modelCountMap.put(rs.getString(&quot;inv_model_id&quot;),rs.getString(&quot;count&quot;));</span>
<span class="nc" id="L1716">			        		agentCountMap.get((rs.getString(&quot;orgCode&quot;)+&quot;Nxt&quot;+rs.getInt(&quot;orgId&quot;))).putAll(modelCountMap);</span>
			        	}	
			        }
			        	
<span class="nc" id="L1720">			    }</span>
<span class="nc bnc" id="L1721" title="All 2 branches missed.">				for (Map.Entry&lt;String, String&gt; entry : modelMap.entrySet()) {</span>
<span class="nc" id="L1722">			        System.out.println(&quot;Key = &quot; + entry.getKey() + &quot;, Value = &quot; + entry.getValue());</span>
<span class="nc bnc" id="L1723" title="All 2 branches missed.">			        if(!(agentCountMap.get((rs.getString(&quot;orgCode&quot;)+&quot;Nxt&quot;+rs.getInt(&quot;orgId&quot;))).containsKey(entry.getKey()))){ </span>
<span class="nc" id="L1724">			        	agentCountMap.get((rs.getString(&quot;orgCode&quot;)+&quot;Nxt&quot;+rs.getInt(&quot;orgId&quot;))).put(entry.getKey(), null);</span>
			        
			        }
<span class="nc" id="L1727">			}</span>
			
			
<span class="nc" id="L1730">			}</span>
<span class="nc" id="L1731">			logger.debug(&quot;agentCountMap = &quot; + agentCountMap);</span>
			
			
<span class="nc" id="L1734">		} catch (SQLException e) {</span>
<span class="nc" id="L1735">			e.printStackTrace();</span>
<span class="nc" id="L1736">			throw new LMSException(e);</span>

		} finally {
<span class="nc" id="L1739">			try {</span>
<span class="nc" id="L1740">				con.close();</span>
<span class="nc" id="L1741">			} catch (SQLException e) {</span>
<span class="nc" id="L1742">				e.printStackTrace();</span>
<span class="nc" id="L1743">				throw new LMSException(e);</span>
<span class="nc" id="L1744">			}</span>
		}

<span class="nc" id="L1747">		return agentCountMap;</span>
	}
	
	public TreeMap&lt;String,String&gt; fetchModelInvntory() throws LMSException {

<span class="nc" id="L1752">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L1753">		TreeMap&lt;String, String&gt; modDetMap = new TreeMap&lt;String, String&gt;();</span>

		try {
			//String fetchInvDetQuery = createQuery(ownerType, invType, agtOrgId,
				//	retOrgId, invId, brandId, modelId);
<span class="nc" id="L1758">			String fetchModelDetQuery=&quot;select model_id, model_name from st_lms_inv_model_master where inv_id = 1&quot;;</span>
<span class="nc" id="L1759">			Statement stmt = con.createStatement();</span>
<span class="nc" id="L1760">			ResultSet rs = stmt.executeQuery(fetchModelDetQuery);</span>
			String modelName;

<span class="nc bnc" id="L1763" title="All 2 branches missed.">			while (rs.next()) {</span>
			
				
<span class="nc" id="L1766">				modDetMap.put(rs.getString(&quot;model_id&quot;) , rs</span>
						.getString(&quot;model_name&quot;));
							
			}
<span class="nc" id="L1770">			logger.debug(&quot;modDetMap = &quot; + modDetMap);</span>
			

<span class="nc" id="L1773">		} catch (SQLException e) {</span>
<span class="nc" id="L1774">			e.printStackTrace();</span>
<span class="nc" id="L1775">			throw new LMSException(e);</span>

		} finally {
<span class="nc" id="L1778">			try {</span>
<span class="nc" id="L1779">				con.close();</span>
<span class="nc" id="L1780">			} catch (SQLException e) {</span>
<span class="nc" id="L1781">				e.printStackTrace();</span>
<span class="nc" id="L1782">				throw new LMSException(e);</span>
<span class="nc" id="L1783">			}</span>
		}

<span class="nc" id="L1786">		return modDetMap;</span>
	}
	public List&lt;ConsNNonConsBean&gt; fetchInvntoryCount(String ownerType,
			int agtOrgId, int retOrgId, String invType, int invId, int brandId,
			String modelId, String sign, Integer count) throws LMSException {

<span class="nc" id="L1792">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L1793">		List&lt;ConsNNonConsBean&gt; invDetList = new ArrayList&lt;ConsNNonConsBean&gt;();</span>

		try {
<span class="nc" id="L1796">			String fetchInvDetQuery = createQuery(ownerType, invType, agtOrgId,</span>
					retOrgId, invId, brandId, modelId);
<span class="nc" id="L1798">			Statement stmt = con.createStatement();</span>
<span class="nc" id="L1799">			ResultSet rs = stmt.executeQuery(fetchInvDetQuery);</span>
<span class="nc" id="L1800">			ConsNNonConsBean bean = null;</span>

<span class="nc bnc" id="L1802" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1803">				bean = new ConsNNonConsBean();</span>
<span class="nc" id="L1804">				bean.setOwnerId(rs.getInt(&quot;current_owner_id&quot;));</span>
<span class="nc" id="L1805">				bean.setOwnerName(rs.getString(&quot;orgCode&quot;));</span>
<span class="nc" id="L1806">				bean.setOwnerType(rs.getString(&quot;current_owner_type&quot;));</span>
<span class="nc" id="L1807">				bean.setInvId(rs.getInt(&quot;inv_id&quot;));</span>
<span class="nc" id="L1808">				bean.setInvName(rs.getString(&quot;inv_name&quot;));</span>
<span class="nc" id="L1809">				bean.setBrandId(brandId);</span>
<span class="nc" id="L1810">				bean.setModelId(Integer.parseInt(modelId));</span>
<span class="nc" id="L1811">				bean.setInvType(invType.trim());</span>
<span class="nc" id="L1812">				bean.setCount(rs.getInt(&quot;inv_count&quot;));</span>
<span class="nc" id="L1813">				bean.setCost(rs.getDouble(&quot;cost&quot;) * rs.getInt(&quot;inv_count&quot;));</span>
<span class="nc bnc" id="L1814" title="All 2 branches missed.">				if (isValid(sign, count, rs.getInt(&quot;inv_count&quot;))) {</span>
<span class="nc" id="L1815">					invDetList.add(bean);</span>
				}
			}
<span class="nc" id="L1818">			logger.debug(&quot;invDetList = &quot; + invDetList);</span>

<span class="nc" id="L1820">		} catch (SQLException e) {</span>
<span class="nc" id="L1821">			e.printStackTrace();</span>
<span class="nc" id="L1822">			throw new LMSException(e);</span>

		} finally {
<span class="nc" id="L1825">			try {</span>
<span class="nc" id="L1826">				con.close();</span>
<span class="nc" id="L1827">			} catch (SQLException e) {</span>
<span class="nc" id="L1828">				e.printStackTrace();</span>
<span class="nc" id="L1829">				throw new LMSException(e);</span>
<span class="nc" id="L1830">			}</span>
		}

<span class="nc" id="L1833">		return invDetList;</span>
	}
	
	public List&lt;ConsNNonConsBean&gt; fetchInvntoryCountAtAgent(String ownerType,
			int agtOrgId, int retOrgId, String invType, int invId, int brandId,
			String modelId, String sign, Integer count) throws LMSException {

<span class="nc" id="L1840">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L1841">		List&lt;ConsNNonConsBean&gt; invDetList = new ArrayList&lt;ConsNNonConsBean&gt;();</span>

		try {
<span class="nc" id="L1844">			String fetchInvDetQuery = createQueryAtAgent(ownerType, invType, agtOrgId,</span>
					retOrgId, invId, brandId, modelId);
<span class="nc" id="L1846">			Statement stmt = con.createStatement();</span>
<span class="nc" id="L1847">			ResultSet rs = stmt.executeQuery(fetchInvDetQuery);</span>
<span class="nc" id="L1848">			ConsNNonConsBean bean = null;</span>

<span class="nc bnc" id="L1850" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1851">				bean = new ConsNNonConsBean();</span>
<span class="nc" id="L1852">				bean.setOwnerId(rs.getInt(&quot;current_owner_id&quot;));</span>
<span class="nc" id="L1853">				bean.setOwnerName(rs.getString(&quot;orgCode&quot;));</span>
<span class="nc" id="L1854">				bean.setOwnerType(rs.getString(&quot;current_owner_type&quot;));</span>
<span class="nc" id="L1855">				bean.setInvId(rs.getInt(&quot;inv_id&quot;));</span>
<span class="nc" id="L1856">				bean.setInvName(rs.getString(&quot;inv_name&quot;));</span>
<span class="nc" id="L1857">				bean.setBrandId(brandId);</span>
<span class="nc" id="L1858">				bean.setModelId(Integer.parseInt(modelId));</span>
<span class="nc" id="L1859">				bean.setInvType(invType.trim());</span>
<span class="nc" id="L1860">				bean.setCount(rs.getInt(&quot;inv_count&quot;));</span>
<span class="nc" id="L1861">				bean.setCost(rs.getDouble(&quot;cost&quot;) * rs.getInt(&quot;inv_count&quot;));</span>
<span class="nc bnc" id="L1862" title="All 2 branches missed.">				if (isValid(sign, count, rs.getInt(&quot;inv_count&quot;))) {</span>
<span class="nc" id="L1863">					invDetList.add(bean);</span>
				}
			}
<span class="nc" id="L1866">			logger.debug(&quot;invDetList = &quot; + invDetList);</span>

<span class="nc" id="L1868">		} catch (SQLException e) {</span>
<span class="nc" id="L1869">			e.printStackTrace();</span>
<span class="nc" id="L1870">			throw new LMSException(e);</span>

		} finally {
<span class="nc" id="L1873">			try {</span>
<span class="nc" id="L1874">				con.close();</span>
<span class="nc" id="L1875">			} catch (SQLException e) {</span>
<span class="nc" id="L1876">				e.printStackTrace();</span>
<span class="nc" id="L1877">				throw new LMSException(e);</span>
<span class="nc" id="L1878">			}</span>
		}

<span class="nc" id="L1881">		return invDetList;</span>
	}

	public List&lt;ConsNNonConsBean&gt; fetchInvntoryWiseDetail(int ownerId,
			String invType, int invId, int brandId, String modelId)
			throws LMSException {

<span class="nc" id="L1888">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L1889">		List&lt;ConsNNonConsBean&gt; invDetList = new ArrayList&lt;ConsNNonConsBean&gt;();</span>

		try {
<span class="nc" id="L1892">			String fetchInvDetQuery = createQueryToFetchDetails(ownerId,</span>
					invType, invId, brandId, modelId);
<span class="nc" id="L1894">			Statement stmt = con.createStatement();</span>
<span class="nc" id="L1895">			ResultSet rs = stmt.executeQuery(fetchInvDetQuery);</span>
<span class="nc" id="L1896">			ConsNNonConsBean bean = null;</span>

<span class="nc bnc" id="L1898" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1899">				bean = new ConsNNonConsBean();</span>
<span class="nc" id="L1900">				bean.setOwnerName(rs.getString(&quot;name&quot;));</span>
<span class="nc" id="L1901">				bean.setOwnerType(rs.getString(&quot;owner&quot;));</span>
				// bean.setInvId(rs.getInt(&quot;inv_id&quot;));
<span class="nc" id="L1903">				bean.setInvName(rs.getString(&quot;inv_name&quot;));</span>
				// bean.setBrandId(brandId);
<span class="nc" id="L1905">				bean.setBrandName(rs.getString(&quot;brand_name&quot;));</span>
				// bean.setModelId(Integer.parseInt(modelId));
<span class="nc" id="L1907">				bean.setModelName(rs.getString(&quot;model_name&quot;));</span>
<span class="nc" id="L1908">				bean.setSerialNo(rs.getString(&quot;serial_no&quot;));</span>
<span class="nc" id="L1909">				bean.setInvType(invType.trim());</span>
<span class="nc" id="L1910">				bean.setCount(rs.getInt(&quot;count&quot;));</span>
<span class="nc" id="L1911">				bean.setCost(rs.getDouble(&quot;cost&quot;) * rs.getInt(&quot;count&quot;));</span>
<span class="nc bnc" id="L1912" title="All 2 branches missed.">				if (&quot;NON_CONS&quot;.equalsIgnoreCase(invType.trim())){</span>
<span class="nc" id="L1913">					bean.setInvCode(rs.getString(&quot;inv_code&quot;));</span>
				}
<span class="nc" id="L1915">				invDetList.add(bean);</span>

			}
<span class="nc" id="L1918">			logger.debug(&quot;invDetList = &quot; + invDetList);</span>

<span class="nc" id="L1920">		} catch (SQLException e) {</span>
<span class="nc" id="L1921">			e.printStackTrace();</span>
<span class="nc" id="L1922">			throw new LMSException(e);</span>

		} finally {
<span class="nc" id="L1925">			try {</span>
<span class="nc" id="L1926">				con.close();</span>
<span class="nc" id="L1927">			} catch (SQLException e) {</span>
<span class="nc" id="L1928">				e.printStackTrace();</span>
<span class="nc" id="L1929">				throw new LMSException(e);</span>
<span class="nc" id="L1930">			}</span>
		}

<span class="nc" id="L1933">		return invDetList;</span>
	}

	public Map&lt;String, String&gt; fetchRetList(int userOrgId) throws LMSException {
<span class="nc" id="L1937">		Connection conn =null;</span>
<span class="nc" id="L1938">		Map&lt;String, String&gt; retMap = new LinkedHashMap&lt;String, String&gt;();</span>

		try {
<span class="nc" id="L1941">			conn = DBConnect.getConnection();</span>
<span class="nc" id="L1942">			PreparedStatement pstmt = null;</span>
<span class="nc" id="L1943">			ResultSet result = null;</span>
<span class="nc" id="L1944">			String orgId = null, orgName = null;</span>

			// fetch retailer list
<span class="nc" id="L1947">			pstmt = conn</span>
					.prepareStatement(&quot;select name, organization_id from st_lms_organization_master where organization_type='RETAILER' and parent_id=&quot;
							+ userOrgId);
<span class="nc" id="L1950">			System.out.println(&quot;retailer query is :::::::&quot; + pstmt);</span>
<span class="nc" id="L1951">			result = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1952" title="All 2 branches missed.">			while (result.next()) {</span>
<span class="nc" id="L1953">				orgId = result.getInt(TableConstants.ORG_ID) + &quot;&quot;;</span>
<span class="nc" id="L1954">				orgName = result.getString(TableConstants.NAME);</span>
<span class="nc" id="L1955">				retMap.put(orgId, orgName);</span>
			}
<span class="nc" id="L1957">		} catch (SQLException e) {</span>
<span class="nc" id="L1958">			e.printStackTrace();</span>
<span class="nc" id="L1959">			throw new LMSException(e);</span>
		} finally {
<span class="nc" id="L1961">			try {</span>
<span class="nc" id="L1962">				conn.close();</span>
<span class="nc" id="L1963">			} catch (SQLException e) {</span>
<span class="nc" id="L1964">				e.printStackTrace();</span>
<span class="nc" id="L1965">			}</span>
<span class="nc" id="L1966">		}</span>

<span class="nc" id="L1968">		return retMap;</span>
	}

	// method added by amit for agent end....
	public Map&lt;String, String&gt; fetchRetListForAsnInv(int userOrgId)
			throws LMSException {
<span class="nc" id="L1974">		Connection conn =null;</span>
<span class="nc" id="L1975">		Map&lt;String, String&gt; retMap = new LinkedHashMap&lt;String, String&gt;();</span>

		try {
<span class="nc" id="L1978">			conn = DBConnect.getConnection();</span>
<span class="nc" id="L1979">			PreparedStatement pstmt = null;</span>
<span class="nc" id="L1980">			ResultSet result = null;</span>
<span class="nc" id="L1981">			String orgId = null, orgName = null;</span>

			// fetch retailer list
<span class="nc" id="L1984">			pstmt = conn</span>
					.prepareStatement(&quot;select name, organization_id from st_lms_organization_master as ret &quot;
							+ &quot; where organization_type='RETAILER' and parent_id= &quot;
							+ userOrgId
							+ &quot; and ret.organization_id in (select organization_id from st_lms_ret_offline_master where serial_number=-1 )&quot;);
<span class="nc" id="L1989">			System.out.println(&quot;retailer query is :::::::&quot; + pstmt);</span>
<span class="nc" id="L1990">			result = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1991" title="All 2 branches missed.">			while (result.next()) {</span>
<span class="nc" id="L1992">				orgId = result.getInt(TableConstants.ORG_ID) + &quot;&quot;;</span>
<span class="nc" id="L1993">				orgName = result.getString(TableConstants.NAME);</span>
<span class="nc" id="L1994">				retMap.put(orgId, orgName);</span>
			}
<span class="nc" id="L1996">		} catch (SQLException e) {</span>
<span class="nc" id="L1997">			e.printStackTrace();</span>
<span class="nc" id="L1998">			throw new LMSException(e);</span>
		} finally {
<span class="nc" id="L2000">			try {</span>
<span class="nc" id="L2001">				conn.close();</span>
<span class="nc" id="L2002">			} catch (SQLException e) {</span>
<span class="nc" id="L2003">				e.printStackTrace();</span>
<span class="nc" id="L2004">			}</span>
<span class="nc" id="L2005">		}</span>

<span class="nc" id="L2007">		return retMap;</span>
	}

	public String fetchRetailerForReassignInv(int userOrgId) throws LMSException {
<span class="nc" id="L2011">		Connection conn = null;</span>
<span class="nc" id="L2012">		StringBuilder orgList = new StringBuilder();</span>

		try {
<span class="nc" id="L2015">			conn = DBConnect.getConnection();</span>
<span class="nc" id="L2016">			PreparedStatement pstmt = null;</span>
<span class="nc" id="L2017">			ResultSet result = null;</span>
			//String orgId = null, orgName = null;
<span class="nc" id="L2019">			String orgCodeQry = &quot;  name orgCode &quot;;</span>

			
<span class="nc bnc" id="L2022" title="All 2 branches missed.">			if ((LMSFilterDispatcher.orgFieldType).equalsIgnoreCase(&quot;CODE&quot;)) {</span>
<span class="nc" id="L2023">				orgCodeQry = &quot; org_code orgCode &quot;;</span>
	

<span class="nc bnc" id="L2026" title="All 2 branches missed.">			} else if ((LMSFilterDispatcher.orgFieldType)</span>
					.equalsIgnoreCase(&quot;CODE_NAME&quot;)) {
<span class="nc" id="L2028">				orgCodeQry = &quot; concat(org_code,'_',name)  orgCode &quot;;</span>
			

<span class="nc bnc" id="L2031" title="All 2 branches missed.">			} else if ((LMSFilterDispatcher.orgFieldType)</span>
					.equalsIgnoreCase(&quot;NAME_CODE&quot;)) {
<span class="nc" id="L2033">				orgCodeQry = &quot; concat(name,'_',org_code)  orgCode  &quot;;</span>
			

			}	
			
			
			// fetch retailer list
<span class="nc" id="L2040">			pstmt = conn</span>
					.prepareStatement(&quot;select &quot;+orgCodeQry+&quot;, organization_id from st_lms_organization_master as ret &quot;
							+ &quot; where organization_type='RETAILER' and organization_status !='TERMINATE' and parent_id= &quot;
							+ userOrgId
							+ &quot; and ret.organization_id in (select organization_id from st_lms_ret_offline_master where serial_number=-1 or sim1 =-1  or sim2 =-1 or sim3 =-1 ) order by &quot;+QueryManager
							.getAppendOrgOrder());
<span class="nc" id="L2046">			System.out.println(&quot;retailer query is :::::::&quot; + pstmt);</span>
<span class="nc" id="L2047">			result = pstmt.executeQuery();</span>
<span class="nc bnc" id="L2048" title="All 2 branches missed.">			while (result.next()) {</span>
<span class="nc" id="L2049">				orgList.append(result.getString(&quot;orgCode&quot;)).append(&quot;|&quot;).append(result.getString(&quot;organization_id&quot;)).append(&quot;:&quot;); </span>
			}
<span class="nc" id="L2051">		} catch (SQLException e) {</span>
<span class="nc" id="L2052">			e.printStackTrace();</span>
<span class="nc" id="L2053">			throw new LMSException(e);</span>
		} finally {
<span class="nc" id="L2055">			try {</span>
<span class="nc" id="L2056">				conn.close();</span>
<span class="nc" id="L2057">			} catch (SQLException e) {</span>
<span class="nc" id="L2058">				e.printStackTrace();</span>
<span class="nc" id="L2059">			}</span>
<span class="nc" id="L2060">		}</span>

<span class="nc" id="L2062">		return orgList.toString();</span>
	}
	
	//public Map&lt;String,String&gt; fetchSerNoList(String[] serNo,String[] invCode, String serNoFileName,int bindLength,String modelId) throws  LMSException {
	public Map&lt;String,InvDetailBean&gt; fetchInvMap(String[] serNo,String[] invCode, String serNoFileName,int modelId,int bindLength,boolean isInvCodeReq) throws  LMSException {
		//Map&lt;String, HashSet&lt;String&gt;&gt; map = new HashMap&lt;String,HashSet&lt;String&gt;&gt;();
		// List&lt;Map&lt;String,InvDetailBean&gt;&gt; mapList = new ArrayList&lt;Map&lt;String,InvDetailBean&gt;&gt;();
<span class="nc" id="L2069">		Map&lt;String,InvDetailBean&gt;  invMap =new HashMap&lt;String,InvDetailBean&gt;();</span>
		// Map&lt;String,InvDetailBean&gt;  duplicateInvMap =null;
<span class="nc" id="L2071">		Set&lt;String&gt; dupSerNoSet = new HashSet&lt;String&gt;();</span>
<span class="nc" id="L2072">		Set&lt;String&gt; dupInvCodeSet = new HashSet&lt;String&gt;();</span>
		// insert image into DB
		
		try {
			
<span class="nc bnc" id="L2077" title="All 2 branches missed.">			for (int i=0;i&lt;serNo.length;i++ ) {</span>
<span class="nc" id="L2078">				   InvDetailBean invBean =new InvDetailBean();</span>
<span class="nc bnc" id="L2079" title="All 2 branches missed.">				if (!&quot;&quot;.equals(serNo[i].trim())) {</span>
<span class="nc bnc" id="L2080" title="All 2 branches missed.">					if(serNo[i].length() &lt; bindLength){</span>
						
<span class="nc" id="L2082">						throw new LMSException(LMSErrors.INVALID_INV_BIND_LENGTH_ERROR_CODE,LMSErrors.INVALID_INV_BIND_LENGTH_ERROR_MESSAGE );</span>
						
					}
<span class="nc bnc" id="L2085" title="All 2 branches missed.">				   if(bindLength &gt; 0){</span>
<span class="nc bnc" id="L2086" title="All 2 branches missed.">					 	if (!dupSerNoSet.add(serNo[i].substring(serNo[i].length()-bindLength, serNo[i].length()))) {</span>
					 		//dupSerNoSet.add(dupSerNoSet.substring(serNo[i].length()-bindLength,serNo[i].length()));
<span class="nc" id="L2088">					 		 throw new LMSException(LMSErrors.DUP_INV_ERROR_CODE,LMSErrors.DUP_INV_ERROR_MESSAGE);</span>
					 	}
<span class="nc bnc" id="L2090" title="All 2 branches missed.">					}else if (bindLength == 0){</span>
<span class="nc bnc" id="L2091" title="All 2 branches missed.">						if (!dupSerNoSet.add(serNo[i])) {</span>
<span class="nc" id="L2092">							 throw new LMSException(LMSErrors.DUP_INV_ERROR_CODE,LMSErrors.DUP_INV_ERROR_MESSAGE);</span>
						}
					}
<span class="nc bnc" id="L2095" title="All 2 branches missed.">				   if(isInvCodeReq){</span>
<span class="nc bnc" id="L2096" title="All 4 branches missed.">					   if(invCode[i]==null|| &quot;&quot;.equals(invCode[i].trim())){</span>
						   
<span class="nc" id="L2098">						   throw new LMSException(LMSErrors.INVALID_INV_ERROR_CODE,LMSErrors.INVALID_INV_ERROR_MESSAGE );</span>
					   }else{
						   
<span class="nc bnc" id="L2101" title="All 2 branches missed.">						   if(!dupInvCodeSet.add(invCode[i].trim())){</span>
							   
<span class="nc" id="L2103">							   throw new LMSException(LMSErrors.DUP_INV_ERROR_CODE,LMSErrors.DUP_INV_ERROR_MESSAGE);</span>
						   }
						   
					   }
					   
<span class="nc" id="L2108">					   invBean.setCode(invCode[i].trim().replaceAll(&quot;\\s+&quot;,&quot;&quot;).toUpperCase());</span>
				   }
				
<span class="nc" id="L2111">				   invBean.setSerialNo(serNo[i].trim().replaceAll(&quot;\\s+&quot;,&quot;&quot;).toUpperCase());</span>
<span class="nc" id="L2112">				   invMap.put(invBean.getSerialNo(), invBean);</span>
				}
			}
<span class="nc" id="L2115">			logger.debug(&quot;SerialNo File Name: &quot; + serNoFileName);</span>
			try{
<span class="nc bnc" id="L2117" title="All 4 branches missed.">				if (serNoFileName != null &amp;&amp; !&quot;&quot;.equals(serNoFileName.trim())) {</span>
<span class="nc" id="L2118">					File file = new File(serNoFileName);</span>
<span class="nc" id="L2119">					FileReader fstream = new FileReader(file);</span>
<span class="nc" id="L2120">					BufferedReader br = new BufferedReader(fstream);</span>
					String strLine;
<span class="nc bnc" id="L2122" title="All 2 branches missed.">					while ((strLine = br.readLine()) != null) {</span>
<span class="nc bnc" id="L2123" title="All 2 branches missed.">						if (!&quot;&quot;.equals(strLine.trim())) {</span>
<span class="nc" id="L2124">							InvDetailBean invBean =new InvDetailBean();	</span>
						//allSerNo.add(strLine.trim().replaceAll(&quot;\\s+&quot;,&quot;&quot;).toUpperCase());
<span class="nc" id="L2126">						String str[] =strLine.split(&quot; &quot;,2);</span>
<span class="nc bnc" id="L2127" title="All 2 branches missed.">							if(!&quot;&quot;.equals(str[0].trim())){</span>
<span class="nc bnc" id="L2128" title="All 2 branches missed.">								if(str[0].length() &lt; bindLength){</span>
									
<span class="nc" id="L2130">									throw new LMSException(LMSErrors.INVALID_INV_BIND_LENGTH_ERROR_CODE,LMSErrors.INVALID_INV_BIND_LENGTH_ERROR_MESSAGE );</span>
									
								}
<span class="nc bnc" id="L2133" title="All 2 branches missed.">								if(bindLength &gt; 0){</span>
<span class="nc bnc" id="L2134" title="All 2 branches missed.">								 	if (!dupSerNoSet.add(str[0].substring(str[0].length()-bindLength, str[0].length()))) {</span>
								 		//dupSerNoSet.add(dupSerNoSet.substring(serNo[i].length()-bindLength,serNo[i].length()));
<span class="nc" id="L2136">								 		 throw new LMSException(LMSErrors.DUP_INV_ERROR_CODE,LMSErrors.DUP_INV_ERROR_MESSAGE);</span>
								 	}
<span class="nc bnc" id="L2138" title="All 2 branches missed.">								}else if (bindLength == 0){</span>
<span class="nc bnc" id="L2139" title="All 2 branches missed.">									if (!dupSerNoSet.add(str[0])) {</span>
<span class="nc" id="L2140">										 throw new LMSException(LMSErrors.DUP_INV_ERROR_CODE,LMSErrors.DUP_INV_ERROR_MESSAGE);</span>
									}
								}
<span class="nc bnc" id="L2143" title="All 2 branches missed.">								   if(isInvCodeReq){</span>
<span class="nc bnc" id="L2144" title="All 4 branches missed.">									   if(str[1]==null|| &quot;&quot;.equals(str[1].trim())){</span>
										   
<span class="nc" id="L2146">										   throw new LMSException(LMSErrors.INVALID_INV_ERROR_CODE,LMSErrors.INVALID_INV_ERROR_MESSAGE );</span>
									   }else{
										   
<span class="nc bnc" id="L2149" title="All 2 branches missed.">										   if(!dupInvCodeSet.add(str[1].trim())){</span>
											   
<span class="nc" id="L2151">											   throw new LMSException(LMSErrors.DUP_INV_ERROR_CODE,LMSErrors.DUP_INV_ERROR_MESSAGE);</span>
										   }
										   
									   }
									   
<span class="nc" id="L2156">									   invBean.setCode(str[1].trim().replaceAll(&quot;\\s+&quot;,&quot;&quot;).toUpperCase());</span>
								   }
								
								
								
							}
							
						   //invMap.put(str[0].trim().replaceAll(&quot;\\s+&quot;,&quot;&quot;).toUpperCase(), str[1].trim().replaceAll(&quot;\\s+&quot;,&quot;&quot;).toUpperCase());
							
<span class="nc" id="L2165">						   invBean.setSerialNo(str[0].trim().replaceAll(&quot;\\s+&quot;,&quot;&quot;).toUpperCase());</span>
<span class="nc" id="L2166">						   invMap.put(invBean.getSerialNo(), invBean);	</span>
<span class="nc" id="L2167">						}</span>
					}
				}
<span class="nc" id="L2170">			}catch(LMSException e){</span>
<span class="nc" id="L2171">				throw  e;</span>
<span class="nc" id="L2172">			}catch (FileNotFoundException e) {</span>
				//logger.error(&quot;Exception: &quot;,e);
<span class="nc" id="L2174">			}catch (IOException e) {</span>
<span class="nc" id="L2175">				logger.error(&quot;Exception: &quot;,e);</span>
<span class="nc" id="L2176">			} catch (Exception e) {</span>
<span class="nc" id="L2177">				logger.error(&quot;Exception: &quot;,e);</span>
<span class="nc" id="L2178">			} </span>
			
<span class="nc bnc" id="L2180" title="All 2 branches missed.">			if(invMap.size() == 0){</span>
				
<span class="nc" id="L2182">				  throw new LMSException(LMSErrors.INV_LIST_EMPTY_ERROR_CODE,LMSErrors.INV_LIST_EMPTY_ERROR_MESSAGE);</span>
				
			}
		
		
			
<span class="nc" id="L2188">		}catch (LMSException e) {</span>
<span class="nc" id="L2189">			logger.error(&quot;LMSException: &quot;,e);</span>
<span class="nc" id="L2190">			throw e;</span>
<span class="nc" id="L2191">		}catch (Exception e) {</span>
<span class="nc" id="L2192">			logger.error(&quot;Exception: &quot;,e);</span>
<span class="nc" id="L2193">			throw new LMSException(LMSErrors.GENERAL_EXCEPTION_ERROR_CODE,LMSErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="nc" id="L2194">		}		</span>
<span class="nc" id="L2195">		return invMap;</span>
	}
	
	public Map&lt;String, HashSet&lt;String&gt;&gt; checkForDuplicates(List&lt;String&gt; allSerNo,int bind_len){
		
<span class="nc" id="L2200">		Map&lt;String, HashSet&lt;String&gt;&gt; map = new HashMap&lt;String, HashSet&lt;String&gt;&gt;();</span>
<span class="nc" id="L2201">		HashSet&lt;String&gt; returnedSet = null;</span>
<span class="nc" id="L2202">		returnedSet = (HashSet&lt;String&gt;)findDuplicates(allSerNo, bind_len);		</span>
<span class="nc" id="L2203">		map.put(&quot;correct&quot;, new HashSet&lt;String&gt;(allSerNo));</span>
<span class="nc" id="L2204">		map.put(&quot;duplicate&quot;, returnedSet);</span>
<span class="nc" id="L2205">		return map;</span>
	}

	public String invListForRet(int retOrgId) throws LMSException {
		//ArrayList&lt;String&gt; invList = new ArrayList&lt;String&gt;();
<span class="nc" id="L2210">		StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L2211">		Connection con = null;</span>
<span class="nc" id="L2212">		PreparedStatement psmt = null;</span>
<span class="nc" id="L2213">		ResultSet rs = null;</span>
		/*String fetchInvQry = &quot;select CONCAT_WS('-',slim.inv_name,slimm.model_name,serial_no) as terminal&quot;
				+ &quot; from st_lms_inv_status slis,st_lms_inv_master slim,st_lms_inv_model_master slimm &quot;
				+ &quot;where current_owner_type='RETAILER' and current_owner_id = &quot;
				+ retOrgId
				+ &quot; and slis.inv_model_id =slimm.model_id   and slim.inv_id= slimm.inv_id&quot;;*/
		
<span class="nc" id="L2220">		String fetchInvQry =&quot;select slimm.model_id as modelId,serial_no  srNO,model_name  from st_lms_inv_status slis,st_lms_inv_master slim,st_lms_inv_model_master slimm where current_owner_type='RETAILER' and current_owner_id =?  and slis.inv_model_id =slimm.model_id   and slim.inv_id= slimm.inv_id&quot;;</span>
		try {
<span class="nc" id="L2222">			con =DBConnect.getConnection();</span>
<span class="nc" id="L2223">			psmt = con.prepareStatement(fetchInvQry);</span>
<span class="nc" id="L2224">			psmt.setInt(1,retOrgId);</span>
<span class="nc" id="L2225">			logger.debug(&quot;fetchInvQry==&quot; + fetchInvQry);</span>
<span class="nc" id="L2226">			rs = psmt.executeQuery();</span>
<span class="nc bnc" id="L2227" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L2228">				sb.append(rs.getString(&quot;model_name&quot;)+&quot;-&quot;+rs.getString(&quot;srNO&quot;)+&quot;-&quot;+rs.getInt(&quot;modelId&quot;)+&quot;;&quot;);</span>
			}
<span class="nc" id="L2230">			logger.debug(&quot;List is==&quot; + sb.toString());</span>
			
<span class="nc" id="L2232">		}catch (SQLException e) {</span>
<span class="nc" id="L2233">			logger.error(&quot;SQL Exception&quot;,e);</span>
			 //e.printStackTrace();
<span class="nc" id="L2235">		}catch (Exception e) {</span>
<span class="nc" id="L2236">			logger.error(&quot;Exception&quot;,e);</span>
		}finally{
<span class="nc" id="L2238">			DBConnect.closeConnection(con, psmt, rs);</span>
<span class="nc" id="L2239">		}</span>
<span class="nc" id="L2240">		return sb.toString();</span>
	}

	public boolean isValid(String sign, Integer count, int invCount) {
<span class="nc" id="L2244">		boolean flag = true;</span>

<span class="nc bnc" id="L2246" title="All 6 branches missed.">		if (count != null &amp;&amp; sign != null &amp;&amp; !&quot;&quot;.equals(sign.trim())) {</span>
<span class="nc bnc" id="L2247" title="All 2 branches missed.">			if (&quot;&lt;=&quot;.equals(sign.trim())) {</span>
<span class="nc bnc" id="L2248" title="All 2 branches missed.">				if (invCount &lt;= count) {</span>
<span class="nc" id="L2249">					flag = true;</span>
				} else {
<span class="nc" id="L2251">					flag = false;</span>
				}
			}
<span class="nc bnc" id="L2254" title="All 2 branches missed.">			if (&quot;&gt;=&quot;.equals(sign.trim())) {</span>
<span class="nc bnc" id="L2255" title="All 2 branches missed.">				if (invCount &gt;= count) {</span>
<span class="nc" id="L2256">					flag = true;</span>
				} else {
<span class="nc" id="L2258">					flag = false;</span>
				}
			}
<span class="nc bnc" id="L2261" title="All 2 branches missed.">			if (&quot;==&quot;.equals(sign.trim())) {</span>
<span class="nc bnc" id="L2262" title="All 2 branches missed.">				if (invCount == count) {</span>
<span class="nc" id="L2263">					flag = true;</span>
				} else {
<span class="nc" id="L2265">					flag = false;</span>
				}
			}
		}
	
		
<span class="nc" id="L2271">		return flag;</span>
	}
/**
 * @deprecated
 * @param modelId
 * @param cost
 * @param isNew
 * @param serNoFileName
 * @param serNo
 * @param userId
 * @param userOrgId
 * @param userType
 * @return
 * @throws LMSException
 */
	public ArrayList nonConsInvUpload(String modelId, double cost,
			String isNew, String serNoFileName, String[] serNo, int userId,
			int userOrgId, String userType) throws LMSException {

<span class="nc" id="L2290">		logger.debug(&quot;cost per unit = &quot; + cost + &quot;, modelId = &quot; + modelId</span>
				+ &quot;, isNew = &quot; + isNew + &quot;\nserNoFileName = &quot; + serNoFileName
				+ &quot; serNo size = &quot; + serNo.length);
<span class="nc" id="L2293">		StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L2294">		StringBuilder sb1 = new StringBuilder();</span>

<span class="nc" id="L2296">		Connection connection = DBConnect.getConnection();</span>
<span class="nc" id="L2297">		ArrayList&lt;String&gt; returnList = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L2298">		boolean emptyFlag = true;</span>
<span class="nc" id="L2299">		boolean wrongFile = false;</span>
		try {
<span class="nc" id="L2301">			connection.setAutoCommit(false);</span>

			//Set&lt;String&gt; serNoSet = fetchSerNoList(serNo, serNoFileName);
			
<span class="nc bnc" id="L2305" title="All 8 branches missed.">			if (modelId != null &amp;&amp; !&quot;&quot;.equals(modelId.trim()) &amp;&amp; cost &gt; 0</span>
					&amp;&amp; serNo.length &gt; 0) {

<span class="nc" id="L2308">				int modId = Integer.parseInt(modelId.trim().split(&quot;-&quot;)[0]);</span>

				// insert into st_lms_inv_status table to add inventory quantity
<span class="nc" id="L2311">				String insIntoInvStatusQuery = &quot;insert into st_lms_inv_status(user_org_type, user_org_id, &quot;</span>
						+ &quot; inv_model_id, user_id, serial_no, cost_to_bo, is_new, current_owner_type, &quot;
						+ &quot; current_owner_id) values(?, ?, ?, ?, ?, ?, ?, ?, ?);&quot;;
<span class="nc" id="L2314">				String chkDupSNo = &quot;select serial_no from st_lms_inv_status where upper(serial_no)=? and inv_model_id = ?&quot;;</span>
<span class="nc" id="L2315">				ResultSet rs = null;</span>
<span class="nc" id="L2316">				PreparedStatement pstmt1 = connection</span>
						.prepareStatement(chkDupSNo);
<span class="nc" id="L2318">				PreparedStatement pstmt = connection</span>
						.prepareStatement(insIntoInvStatusQuery);
<span class="nc" id="L2320">				pstmt.setString(1, userType);</span>
<span class="nc" id="L2321">				pstmt.setInt(2, userOrgId);</span>
<span class="nc" id="L2322">				pstmt.setInt(3, modId);</span>
<span class="nc" id="L2323">				pstmt.setInt(4, userId);</span>
<span class="nc" id="L2324">				pstmt.setDouble(6, cost);</span>
<span class="nc" id="L2325">				pstmt.setString(7, isNew);</span>
<span class="nc" id="L2326">				pstmt.setString(8, userType);</span>
<span class="nc" id="L2327">				pstmt.setInt(9, userOrgId);</span>

				// insert into st_lms_inv_detail table to add inventory quantity
<span class="nc" id="L2330">				String insIntoInvDetQuery = &quot;insert into st_lms_inv_detail(user_id,user_org_type,user_org_id,&quot;</span>
						+ &quot; inv_model_id,serial_no,date,cost_to_bo,is_new,current_owner_type,current_owner_id)&quot;
						+ &quot; values(?,?,?,?,?,?,?,?,?,?)&quot;;
<span class="nc" id="L2333">				PreparedStatement pstmt2 = connection</span>
						.prepareStatement(insIntoInvDetQuery);
<span class="nc" id="L2335">				pstmt2.setInt(1, userId);</span>
<span class="nc" id="L2336">				pstmt2.setString(2, userType);</span>
<span class="nc" id="L2337">				pstmt2.setInt(3, userOrgId);</span>
<span class="nc" id="L2338">				pstmt2.setInt(4, modId);</span>
<span class="nc" id="L2339">				pstmt2.setTimestamp(6, new Timestamp(new java.util.Date()</span>
						.getTime()));
<span class="nc" id="L2341">				pstmt2.setDouble(7, cost);</span>
<span class="nc" id="L2342">				pstmt2.setString(8, isNew);</span>
<span class="nc" id="L2343">				pstmt2.setString(9, userType);</span>
<span class="nc" id="L2344">				pstmt2.setInt(10, userOrgId);</span>
		
<span class="nc" id="L2346">				int stRowUpd = 0, detRowUpd = 0;</span>
<span class="nc bnc" id="L2347" title="All 2 branches missed.">				for (String sNo : serNo) {</span>
<span class="nc bnc" id="L2348" title="All 4 branches missed.">					if (emptyFlag &amp;&amp; !sNo.trim().equals(&quot;&quot;)) {// at least one</span>
						// not empty
<span class="nc" id="L2350">						emptyFlag = false;</span>
					}
<span class="nc" id="L2352">					pstmt1.clearParameters();</span>
<span class="nc" id="L2353">					pstmt1.setString(1, sNo.trim().toUpperCase());</span>
<span class="nc" id="L2354">					pstmt1.setInt(2, modId);</span>
<span class="nc" id="L2355">					rs = pstmt1.executeQuery();</span>
<span class="nc bnc" id="L2356" title="All 2 branches missed.">					if (rs.next()) {</span>
<span class="nc" id="L2357">						sb1.append(sNo.trim() + &quot;;&quot;);</span>
					} else {
<span class="nc" id="L2359">						sb.append(sNo.trim() + &quot;;&quot;);</span>
<span class="nc" id="L2360">						pstmt.setString(5, sNo.trim());</span>
<span class="nc" id="L2361">						logger.debug(&quot;st_lms_inv_status = &quot; + pstmt);</span>
<span class="nc" id="L2362">						stRowUpd += pstmt.executeUpdate();</span>
<span class="nc" id="L2363">						pstmt2.setString(5, sNo.trim());</span>
<span class="nc" id="L2364">						logger.debug(&quot;st_inv_det = &quot; + pstmt2);</span>
<span class="nc" id="L2365">						detRowUpd += pstmt2.executeUpdate();</span>
					}
				}
<span class="nc bnc" id="L2368" title="All 4 branches missed.">				if (emptyFlag || detRowUpd == 0) {</span>
					// present and at least one non
					// duplicate is not added,ie all
					// duplicate entered
<span class="nc" id="L2372">					connection.rollback();</span>
				} else {
<span class="nc" id="L2374">					connection.commit();</span>
				}

			}
<span class="nc" id="L2378">		} catch (SQLException e) {</span>
<span class="nc" id="L2379">			e.printStackTrace();</span>
<span class="nc" id="L2380">			wrongFile = true;</span>
			// throw new LMSException(e);
		} finally {
<span class="nc" id="L2383">			try {</span>
<span class="nc" id="L2384">				connection.close();</span>
<span class="nc" id="L2385">			} catch (SQLException e) {</span>
<span class="nc" id="L2386">				e.printStackTrace();</span>
<span class="nc" id="L2387">				throw new LMSException(e);</span>
<span class="nc" id="L2388">			}</span>
		}
<span class="nc" id="L2390">		String invListStr = sb.toString();</span>
<span class="nc" id="L2391">		String notuploadedinvListStr = sb1.toString();</span>
<span class="nc" id="L2392">		logger.debug(&quot;notuploadedinvListStr &quot; + notuploadedinvListStr);</span>

<span class="nc" id="L2394">		returnList.add(0, notuploadedinvListStr);</span>
<span class="nc bnc" id="L2395" title="All 2 branches missed.">		if (emptyFlag) {</span>
<span class="nc" id="L2396">			returnList.add(1, &quot;error&quot;);</span>
<span class="nc bnc" id="L2397" title="All 2 branches missed.">		} else if (wrongFile) {</span>
<span class="nc" id="L2398">			returnList.add(1, &quot;fileError&quot;);</span>
		} else {
<span class="nc" id="L2400">			returnList.add(1, &quot;&quot;);</span>
		}

<span class="nc bnc" id="L2403" title="All 2 branches missed.">		if (&quot;&quot;.equals(invListStr)) {</span>
<span class="nc" id="L2404">			returnList.add(2, &quot;NO Specification&quot;);</span>
			// return &quot;NO Specification&quot;;
		} else {
<span class="nc" id="L2407">			returnList.add(2, invListStr);</span>
			// return invListStr;
		}

<span class="nc" id="L2411">		return returnList;</span>
	}
	public ArrayList nonConsInvUpload(String[] serNo,String[] invCode, String serNoFileName,int modelId, double cost,
			String isNew,Map&lt;String,InvDetailBean&gt; invMap, int userId,
			int userOrgId, String userType) throws LMSException {

<span class="nc" id="L2417">		logger.debug(&quot;cost per unit = &quot; + cost + &quot;, modelId = &quot; + modelId</span>
				+ &quot;, isNew = &quot; + isNew);
<span class="nc" id="L2419">		StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L2420">		StringBuilder sb1 = new StringBuilder();</span>

<span class="nc" id="L2422">		Connection con = null;</span>
<span class="nc" id="L2423">		ArrayList&lt;String&gt; returnList = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L2424">		boolean emptyFlag = true;</span>
<span class="nc" id="L2425">		boolean wrongFile = false;</span>
<span class="nc" id="L2426">		boolean isInvCodeReq = false ; // get InveCodeReq For Model</span>
<span class="nc" id="L2427">		int bindLength =0;</span>
<span class="nc" id="L2428">		ResultSet rs =null;</span>
<span class="nc" id="L2429">		Map&lt;String,InvDetailBean&gt; duplicateInvMap = null;</span>
		try {
<span class="nc" id="L2431">			con =DBConnect.getConnection();</span>
<span class="nc" id="L2432">			String query = &quot;select check_binding_length,is_inv_code_req from st_lms_inv_model_master where model_id=? &quot;;</span>
<span class="nc" id="L2433">			PreparedStatement pstmt = con.prepareStatement(query);</span>
<span class="nc" id="L2434">			pstmt.setInt(1,modelId);</span>
<span class="nc" id="L2435">			logger.info(pstmt);</span>
<span class="nc" id="L2436">			rs=pstmt.executeQuery();</span>
<span class="nc bnc" id="L2437" title="All 2 branches missed.">			if(rs.next()){</span>
<span class="nc bnc" id="L2438" title="All 2 branches missed.">				isInvCodeReq = rs.getString(&quot;is_inv_code_req&quot;).equalsIgnoreCase(&quot;Y&quot;)? true:false ;</span>
<span class="nc" id="L2439">				bindLength=rs.getInt(&quot;check_binding_length&quot;);</span>
			}else{
<span class="nc" id="L2441">				logger.debug(&quot;Inv Model Id Not Found&quot;);</span>
<span class="nc" id="L2442">				throw new LMSException(LMSErrors.GENERAL_EXCEPTION_ERROR_CODE,LMSErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
			}
			
			//Set&lt;String&gt; serNoSet = fetchSerNoList(serNo, serNoFileName);
<span class="nc" id="L2446">			invMap=  fetchInvMap(serNo,invCode, serNoFileName,modelId,bindLength,isInvCodeReq);</span>
<span class="nc" id="L2447">			duplicateInvMap=getDuplicateInvetoryMap(invMap,bindLength,modelId,isInvCodeReq,con);</span>
			///	mapList.add(invMap);
			//mapList.add(duplicateInvMap);
<span class="nc" id="L2450">			con =DBConnect.getConnection();</span>
			
<span class="nc" id="L2452">			con.setAutoCommit(false);</span>
<span class="nc bnc" id="L2453" title="All 4 branches missed.">			if (cost &gt; 0 &amp;&amp; invMap.size() &gt; 0) {</span>

				
				
				// insert into st_lms_inv_status table to add inventory quantity
<span class="nc" id="L2458">				String insIntoInvStatusQuery = &quot;insert into st_lms_inv_status(user_org_type, user_org_id, &quot;</span>
						+ &quot; inv_model_id, user_id, serial_no, cost_to_bo, is_new, current_owner_type, &quot;
						+ &quot; current_owner_id) values(?, ?, ?, ?, ?, ?, ?, ?, ?);&quot;;
				// String chkDupSNo = &quot;select invStatus.serial_no serial_no ,inv_code invCode from st_lms_inv_status invStatus  inner join st_lms_inv_mapping  invMap on invStatus.serial_no=invMap.serial_no where invStatus.inv_model_id =? and (upper(invStatus.serial_no)=? or upper(inv_code )=?)&quot;;
				// PreparedStatement pstmt1 = con.prepareStatement(chkDupSNo);
<span class="nc" id="L2463">				pstmt = con.prepareStatement(insIntoInvStatusQuery);</span>
<span class="nc" id="L2464">				pstmt.setString(1, userType);</span>
<span class="nc" id="L2465">				pstmt.setInt(2, userOrgId);</span>
<span class="nc" id="L2466">				pstmt.setInt(3, modelId);</span>
<span class="nc" id="L2467">				pstmt.setInt(4, userId);</span>
<span class="nc" id="L2468">				pstmt.setDouble(6, cost);</span>
<span class="nc" id="L2469">				pstmt.setString(7, isNew);</span>
<span class="nc" id="L2470">				pstmt.setString(8, userType);</span>
<span class="nc" id="L2471">				pstmt.setInt(9, userOrgId);</span>

				// insert into st_lms_inv_detail table to add inventory quantity
<span class="nc" id="L2474">				String insIntoInvDetQuery = &quot;insert into st_lms_inv_detail(user_id,user_org_type,user_org_id,&quot;</span>
						+ &quot; inv_model_id,serial_no,date,cost_to_bo,is_new,current_owner_type,current_owner_id)&quot;
						+ &quot; values(?,?,?,?,?,?,?,?,?,?)&quot;;
<span class="nc" id="L2477">				PreparedStatement pstmt2 = con</span>
						.prepareStatement(insIntoInvDetQuery);
<span class="nc" id="L2479">				pstmt2.setInt(1, userId);</span>
<span class="nc" id="L2480">				pstmt2.setString(2, userType);</span>
<span class="nc" id="L2481">				pstmt2.setInt(3, userOrgId);</span>
<span class="nc" id="L2482">				pstmt2.setInt(4, modelId);</span>
<span class="nc" id="L2483">				pstmt2.setTimestamp(6, new Timestamp(new java.util.Date()</span>
						.getTime()));
<span class="nc" id="L2485">				pstmt2.setDouble(7, cost);</span>
<span class="nc" id="L2486">				pstmt2.setString(8, isNew);</span>
<span class="nc" id="L2487">				pstmt2.setString(9, userType);</span>
<span class="nc" id="L2488">				pstmt2.setInt(10, userOrgId);</span>
				
				// Insert Inventory Mapping 
				
<span class="nc" id="L2492">				String insInvMapp = &quot; insert into st_lms_inv_mapping(inv_model_id,serial_no,inv_code) values(?,?,?) &quot;;</span>
<span class="nc" id="L2493">				PreparedStatement pstmt3 = con.prepareStatement(insInvMapp);</span>
<span class="nc" id="L2494">				pstmt3.setInt(1, modelId);</span>
		
		
<span class="nc" id="L2497">				int stRowUpd = 0, detRowUpd = 0,mapRowUpd=0;</span>
<span class="nc" id="L2498">				Iterator&lt;Entry&lt;String,InvDetailBean&gt;&gt; itr = invMap.entrySet().iterator();</span>
<span class="nc bnc" id="L2499" title="All 2 branches missed.">				while(itr.hasNext()){</span>
<span class="nc" id="L2500">					Entry&lt;String,InvDetailBean&gt; entry =itr.next();</span>
<span class="nc bnc" id="L2501" title="All 4 branches missed.">					if (emptyFlag &amp;&amp; !entry.getValue().getSerialNo().trim().equals(&quot;&quot;)) {// at least one</span>
						// not empty
<span class="nc" id="L2503">						emptyFlag = false;</span>
					}
<span class="nc bnc" id="L2505" title="All 2 branches missed.">					if(isInvCodeReq){</span>
<span class="nc" id="L2506">						sb.append(entry.getKey()+&quot;,&quot;+entry.getValue().getCode()+ &quot;;&quot;);</span>
					
						
					} else{
						
<span class="nc" id="L2511">						sb.append(entry.getKey()+&quot;;&quot;);</span>
					}
					//pstmt1.clearParameters();
					//pstmt1.setString(1, entry.getValue().getSerialNo().trim().toUpperCase());
					//pstmt1.setString(2, entry.getValue().getCode().trim().toUpperCase());
					//pstmt1.setInt(3, modelId);
					// rs = pstmt1.executeQuery();
				/*	if (rs.next()) {
					
						 sb1.append(entry.getKey()+&quot;,&quot;+entry.getValue() + &quot;;&quot;);
					} else {*/
						
					
<span class="nc" id="L2524">						pstmt.setString(5,  entry.getValue().getSerialNo());</span>
<span class="nc" id="L2525">						logger.debug(&quot;st_lms_inv_status = &quot; + pstmt);</span>
<span class="nc" id="L2526">						stRowUpd += pstmt.executeUpdate();</span>
<span class="nc" id="L2527">						pstmt2.setString(5, entry.getValue().getSerialNo());</span>
<span class="nc" id="L2528">						logger.debug(&quot;st_inv_det = &quot; + pstmt2);</span>
<span class="nc" id="L2529">						detRowUpd += pstmt2.executeUpdate();</span>
<span class="nc" id="L2530">						pstmt3.setString(2,entry.getValue().getSerialNo());</span>
<span class="nc" id="L2531">						pstmt3.setString(3,entry.getValue().getCode());</span>
<span class="nc" id="L2532">						logger.debug(&quot;st_inv_mapping = &quot; + pstmt3);</span>
<span class="nc" id="L2533">						mapRowUpd += pstmt3.executeUpdate();</span>
<span class="nc" id="L2534">						logger.debug(&quot;mapRowUpd&quot;+mapRowUpd);</span>
					//}
<span class="nc" id="L2536">				}</span>
				
		/*		for (String sNo : serNo) {
					if (emptyFlag &amp;&amp; !sNo.trim().equals(&quot;&quot;)) {// at least one
						// not empty
						emptyFlag = false;
					}
					pstmt1.clearParameters();
					pstmt1.setString(1, sNo.trim().toUpperCase());
					pstmt1.setInt(2, modId);
					rs = pstmt1.executeQuery();
					if (rs.next()) {
						sb1.append(sNo.trim() + &quot;;&quot;);
					} else {
						sb.append(sNo.trim() + &quot;;&quot;);
						pstmt.setString(5, sNo.trim());
						logger.debug(&quot;st_lms_inv_status = &quot; + pstmt);
						stRowUpd += pstmt.executeUpdate();
						pstmt2.setString(5, sNo.trim());
						logger.debug(&quot;st_inv_det = &quot; + pstmt2);
						detRowUpd += pstmt2.executeUpdate();
					}
				}*/
<span class="nc bnc" id="L2559" title="All 6 branches missed.">				if (emptyFlag || detRowUpd == 0 ||stRowUpd==0) {</span>
					// present and at least one non
					// duplicate is not added,ie all
					// duplicate entered
<span class="nc" id="L2563">					con.rollback();</span>
				} else {
<span class="nc" id="L2565">					con.commit();</span>
				}

			}
<span class="nc" id="L2569">		}catch(LMSException e){</span>
<span class="nc" id="L2570">			throw  e;</span>
<span class="nc" id="L2571">		}catch (SQLException e) {</span>
<span class="nc" id="L2572">			logger.error(&quot;SQL Exception &quot;, e);</span>
<span class="nc" id="L2573">		}catch (Exception e) {</span>
<span class="nc" id="L2574">			logger.error(&quot;Exception &quot;, e);</span>
<span class="nc" id="L2575">			wrongFile = true;</span>
			// throw new LMSException(e);
		} finally {
<span class="nc" id="L2578">			DBConnect.closeCon(con);</span>
<span class="nc" id="L2579">		}</span>
<span class="nc" id="L2580">		String invListStr = sb.toString();</span>
<span class="nc" id="L2581">		Iterator&lt;Entry&lt;String,InvDetailBean&gt;&gt; itr = duplicateInvMap.entrySet().iterator();</span>
<span class="nc bnc" id="L2582" title="All 2 branches missed.">		while(itr.hasNext()){</span>
<span class="nc" id="L2583">			Entry&lt;String,InvDetailBean&gt; entry =itr.next();</span>
<span class="nc bnc" id="L2584" title="All 2 branches missed.">			if(isInvCodeReq){</span>
<span class="nc" id="L2585">				sb1.append(entry.getValue().getSerialNo()+&quot;,&quot;).append(entry.getValue().getCode()+&quot;;&quot;);</span>
				
			}else{
<span class="nc" id="L2588">				sb1.append(entry.getValue().getSerialNo()+&quot;;&quot;);</span>
				
			}
			
			
<span class="nc" id="L2593">		}</span>
<span class="nc" id="L2594">		String notuploadedinvListStr = sb1.toString();</span>
<span class="nc" id="L2595">		logger.debug(&quot;notuploadedinvListStr &quot; + notuploadedinvListStr);</span>

<span class="nc" id="L2597">		returnList.add(0, notuploadedinvListStr);</span>
<span class="nc bnc" id="L2598" title="All 2 branches missed.">		if (emptyFlag) {</span>
<span class="nc" id="L2599">			returnList.add(1, &quot;error&quot;);</span>
<span class="nc bnc" id="L2600" title="All 2 branches missed.">		} else if (wrongFile) {</span>
<span class="nc" id="L2601">			returnList.add(1, &quot;fileError&quot;);</span>
		} else {
<span class="nc" id="L2603">			returnList.add(1, &quot;&quot;);</span>
		}

<span class="nc bnc" id="L2606" title="All 2 branches missed.">		if (&quot;&quot;.equals(invListStr)) {</span>
<span class="nc" id="L2607">			returnList.add(2, &quot;NO Specification&quot;);</span>
			// return &quot;NO Specification&quot;;
		} else {
<span class="nc" id="L2610">			returnList.add(2, invListStr);</span>
			// return invListStr;
		}

<span class="nc" id="L2614">		return returnList;</span>
	}
	public String reassignNonsRetSave(int retOrgId, String invSrNo,
			int agtOrgId,String modelId, String userType, int agtId) throws LMSException {

<span class="nc" id="L2619">		Connection con = null;</span>
<span class="nc" id="L2620">		PreparedStatement psmt = null;</span>
<span class="nc" id="L2621">		ResultSet rs = null;</span>
<span class="nc" id="L2622">		String status = &quot;error&quot;;</span>
<span class="nc" id="L2623">		String srNo = invSrNo;// serial no of inventory</span>
<span class="nc" id="L2624">		int  model  = 0;</span>
	
<span class="nc" id="L2626">		String invColName =null;</span>
<span class="nc" id="L2627">		String device_type = null;</span>
		
		try {
			
<span class="nc" id="L2631">			model  = Integer.parseInt(modelId.split(&quot;-&quot;)[0]);// device type of inventory</span>
		
<span class="nc" id="L2633">			String modelDeatials = &quot;select  inv_column_name, model_name  from st_lms_inv_model_master where model_id=?  &quot; ;</span>
<span class="nc" id="L2634">			String assignSerNoQuery = &quot;update st_lms_inv_status set user_org_type = '&quot;+userType+&quot;',user_org_id=?, current_owner_type = ?, current_owner_id = ? where serial_no = ? and current_owner_id = ? and inv_model_id = ?&quot;;</span>
<span class="nc" id="L2635">			String insIntoInvDetQuery = &quot;insert into st_lms_inv_detail(user_id,user_org_type,user_org_id, inv_model_id,serial_no,date,cost_to_bo,is_new,current_owner_type,current_owner_id) select ?,?,?,inv_model_id,?,?,cost_to_bo, is_new,?,? from st_lms_inv_status where serial_no = ? and inv_model_id = ?&quot;;</span>
<span class="nc" id="L2636">			con = DBConnect.getConnection();</span>

<span class="nc" id="L2638">			psmt =con.prepareStatement(modelDeatials);</span>
<span class="nc" id="L2639">			psmt.setInt(1, model);</span>
<span class="nc" id="L2640">			rs =psmt.executeQuery();</span>
<span class="nc bnc" id="L2641" title="All 2 branches missed.">			if(rs.next()){</span>
				
<span class="nc" id="L2643">				invColName =rs.getString(&quot;inv_column_name&quot;);</span>
<span class="nc" id="L2644">				device_type = rs.getString(&quot;model_name&quot;);</span>
			
			}else{
				
<span class="nc" id="L2648">				throw new LMSException(LMSErrors.GENERAL_EXCEPTION_ERROR_CODE,LMSErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
			}
<span class="nc" id="L2650">			DBConnect.closeConnection(psmt, rs);</span>
		
				// Check  Inventory Already Assgined or not
<span class="nc" id="L2653">			    String terminalCheck =&quot;select &quot;+invColName+&quot;  from st_lms_ret_offline_master  where organization_id=? &quot;;</span>
<span class="nc" id="L2654">				psmt =con.prepareStatement(terminalCheck);</span>
<span class="nc" id="L2655">				psmt.setInt(1, retOrgId);</span>
<span class="nc" id="L2656">				logger.debug(&quot;Terminal Check&quot;+psmt);</span>
<span class="nc" id="L2657">				rs =psmt.executeQuery();</span>
<span class="nc bnc" id="L2658" title="All 2 branches missed.">				if(rs.next()){</span>
<span class="nc bnc" id="L2659" title="All 2 branches missed.">					if(!rs.getString(invColName).equalsIgnoreCase(&quot;-1&quot;)){</span>
<span class="nc" id="L2660">						logger.debug(rs.getString(invColName)+&quot; Inventory Already Assigned To User &quot;);</span>
<span class="nc" id="L2661">						throw new LMSException(LMSErrors.INV_ALREADY_ASSIGNED_ERROR_CODE,LMSErrors.INV_ALREADY_ASSIGNED_ERROR_MESSAGE);	</span>
					}
				
				}
				
			
		
<span class="nc" id="L2668">			DBConnect.closeConnection(psmt, rs);</span>
			
<span class="nc" id="L2670">			con.setAutoCommit(false);</span>
<span class="nc" id="L2671">			psmt = con.prepareStatement(assignSerNoQuery);</span>
<span class="nc" id="L2672">			psmt.setInt(1, agtOrgId);</span>
<span class="nc" id="L2673">			psmt.setString(2, &quot;RETAILER&quot;);</span>
<span class="nc" id="L2674">			psmt.setInt(3, retOrgId);</span>
<span class="nc" id="L2675">			psmt.setString(4, srNo);</span>
<span class="nc" id="L2676">			psmt.setInt(5, agtOrgId);</span>
<span class="nc" id="L2677">			psmt.setInt(6, model);</span>
<span class="nc" id="L2678">			logger.info(&quot;update query for inventory::::::&quot; + psmt);</span>
<span class="nc" id="L2679">			psmt.executeUpdate();</span>
<span class="nc" id="L2680">			DBConnect.closePstmt(psmt);</span>
<span class="nc" id="L2681">			PreparedStatement insIntoInvDet = con.prepareStatement(insIntoInvDetQuery);</span>
<span class="nc" id="L2682">			insIntoInvDet.setInt(1, agtId);</span>
<span class="nc" id="L2683">			insIntoInvDet.setString(2, userType);</span>
<span class="nc" id="L2684">			insIntoInvDet.setInt(3, agtOrgId);</span>
			// insIntoInvDet.setInt(4, inv_modelId);
<span class="nc" id="L2686">			insIntoInvDet.setString(4, srNo);</span>
<span class="nc" id="L2687">			insIntoInvDet.setTimestamp(5, new Timestamp(new java.util.Date().getTime()));</span>
<span class="nc" id="L2688">			insIntoInvDet.setString(6, &quot;RETAILER&quot;);</span>
<span class="nc" id="L2689">			insIntoInvDet.setInt(7, retOrgId);</span>
<span class="nc" id="L2690">			insIntoInvDet.setString(8, srNo);</span>
<span class="nc" id="L2691">			insIntoInvDet.setInt(9, model);</span>
<span class="nc" id="L2692">			logger.info(&quot;insert query for inventory::::::&quot;+ insIntoInvDet);</span>
<span class="nc" id="L2693">			insIntoInvDet.executeUpdate();</span>
<span class="nc" id="L2694">			DBConnect.closePstmt(insIntoInvDet);</span>
<span class="nc" id="L2695">			String offLoginStatus = &quot;update st_lms_ret_offline_master set &quot;+invColName+&quot; = '&quot;+ srNo + &quot;', device_type = '&quot;+device_type+&quot;'  where organization_id= ?&quot;;</span>
<span class="nc" id="L2696">			psmt = con.prepareStatement(offLoginStatus);</span>
<span class="nc" id="L2697">			psmt.setInt(1,retOrgId );</span>
<span class="nc" id="L2698">			logger.info(&quot;ret offline master update:&quot; + offLoginStatus);</span>
<span class="nc" id="L2699">			psmt.executeUpdate();</span>
<span class="nc" id="L2700">			con.commit();</span>
<span class="nc" id="L2701">			status = &quot;success&quot;;</span>

<span class="nc" id="L2703">		} catch (LMSException e){</span>
<span class="nc" id="L2704">		  throw e ;	</span>
<span class="nc" id="L2705">		}catch (Exception e) {</span>
<span class="nc" id="L2706">			logger.error(&quot;Exception&quot;,e);</span>
			try {
<span class="nc" id="L2708">				con.rollback();</span>
<span class="nc" id="L2709">			} catch (SQLException e1) {</span>
<span class="nc" id="L2710">				logger.error(&quot;Exception&quot;,e1);</span>
<span class="nc" id="L2711">			}</span>
<span class="nc" id="L2712">			return &quot;error&quot;;</span>
		}finally{
			
<span class="nc" id="L2715">			DBConnect.closeConnection(con, psmt);</span>
			
<span class="nc" id="L2717">		}</span>
<span class="nc" id="L2718">		return status;</span>

	}

	private void returnConsInv(int userOrgId, int userId, String ownerType,
			int agtOrgId, int retOrgId, int[] consInvId, int[] consModelId,
			int[] consQty, Connection conn, String userType,int DNID)
			throws SQLException {

<span class="nc" id="L2727">		List&lt;String&gt; validSerNoList = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L2728">		List&lt;String&gt; inValidSerNoList = new ArrayList&lt;String&gt;();</span>

<span class="nc" id="L2730">		String fetchDetailsQuery = &quot;select party_org_id, aa.inv_model_id, cumm_qty_count, inv_name, &quot;</span>
				+ &quot; concat(spec_value, '-', spec_unit, '-', spec_type) 'model_name' from st_lms_cons_inv_status &quot;
				+ &quot; aa, st_lms_cons_inv_specification bb, st_lms_inv_master cc where aa.inv_model_id = &quot;
				+ &quot; bb.inv_model_id and bb.inv_id = cc.inv_id &quot;;
<span class="nc" id="L2734">		PreparedStatement pstmt = conn.prepareStatement(fetchDetailsQuery);</span>
<span class="nc" id="L2735">		ResultSet rs = pstmt.executeQuery();</span>
<span class="nc" id="L2736">		Map&lt;String, Long&gt; partyDetMap = new TreeMap&lt;String, Long&gt;();</span>
<span class="nc" id="L2737">		Map&lt;Integer, ConsNNonConsBean&gt; invDetMap = new TreeMap&lt;Integer, ConsNNonConsBean&gt;();</span>
<span class="nc bnc" id="L2738" title="All 2 branches missed.">		while (rs.next()) {</span>
<span class="nc" id="L2739">			partyDetMap.put(rs.getInt(&quot;party_org_id&quot;) + &quot;-&quot;</span>
					+ rs.getInt(&quot;inv_model_id&quot;), rs.getLong(&quot;cumm_qty_count&quot;));

		}

<span class="nc bnc" id="L2744" title="All 2 branches missed.">		int partyOrgId = &quot;AGENT&quot;.equalsIgnoreCase(ownerType.trim()) ? agtOrgId</span>
				: retOrgId;
<span class="nc" id="L2746">		int fstRowUpd = -1, scdRowUpd = -1;</span>
<span class="nc" id="L2747">		ConsNNonConsBean bean = null;</span>
<span class="nc bnc" id="L2748" title="All 2 branches missed.">		for (int i = 0, len = consModelId.length; i &lt; len; i = i + 1) {</span>
<span class="nc bnc" id="L2749" title="All 6 branches missed.">			if (consInvId[i] &gt; 0 &amp;&amp; consModelId[i] &gt; 0 &amp;&amp; consQty[i] &gt; 0) {</span>

<span class="nc bnc" id="L2751" title="All 4 branches missed.">				if (partyDetMap.get(partyOrgId + &quot;-&quot; + consModelId[i]) != null</span>
						&amp;&amp; partyDetMap.get(partyOrgId + &quot;-&quot; + consModelId[i]) &gt;= consQty[i]) {

					// update st_lms_cons_inv_status table to add inventory
					// quantity
<span class="nc" id="L2756">					String redInvStatusQuery = &quot;update st_lms_cons_inv_status set cumm_qty_count=cumm_qty_count-?&quot;</span>
							+ &quot; where inv_model_id =? and party_org_id = ? and cumm_qty_count&gt;=?&quot;;
<span class="nc" id="L2758">					pstmt = conn.prepareStatement(redInvStatusQuery);</span>
<span class="nc" id="L2759">					pstmt.setLong(1, consQty[i]);</span>
<span class="nc" id="L2760">					pstmt.setInt(2, consModelId[i]);</span>
<span class="nc" id="L2761">					pstmt.setInt(3, partyOrgId);</span>
<span class="nc" id="L2762">					pstmt.setLong(4, consQty[i]);</span>
<span class="nc" id="L2763">					logger.debug(pstmt);</span>
<span class="nc" id="L2764">					fstRowUpd = pstmt.executeUpdate();</span>

<span class="nc" id="L2766">					String insIntoUserInvDetailQuery = &quot;insert into st_lms_cons_inv_detail(user_id, user_org_id, &quot;</span>
							+ &quot; current_owner_id, inv_model_id, quantity, date, ref_transaction_id, amount) select ?, ?,&quot;
							+ &quot; ?, ?, ?, ?, ?, cost_per_unit*? from st_lms_cons_inv_specification where inv_model_id=?&quot;;
<span class="nc" id="L2769">					pstmt = conn.prepareStatement(insIntoUserInvDetailQuery);</span>
<span class="nc" id="L2770">					pstmt.setInt(1, userId);</span>
<span class="nc" id="L2771">					pstmt.setInt(2, userOrgId);</span>
<span class="nc" id="L2772">					pstmt.setInt(3, partyOrgId);</span>
<span class="nc" id="L2773">					pstmt.setInt(4, consModelId[i]);</span>
<span class="nc" id="L2774">					pstmt.setLong(5, consQty[i]);</span>
<span class="nc" id="L2775">					pstmt.setTimestamp(6, new Timestamp(new java.util.Date()</span>
							.getTime()));
<span class="nc" id="L2777">					pstmt.setObject(7, null);</span>
<span class="nc" id="L2778">					pstmt.setLong(8, consQty[i]);</span>
<span class="nc" id="L2779">					pstmt.setInt(9, consModelId[i]);</span>
<span class="nc" id="L2780">					logger.debug(&quot;st_lms_cons_inv_detail = &quot; + pstmt);</span>
<span class="nc" id="L2781">					int rowCount = pstmt.executeUpdate();</span>
<span class="nc" id="L2782">					logger.debug(&quot;Total row inserted = &quot; + rowCount);</span>
<span class="nc bnc" id="L2783" title="All 2 branches missed.">					if (rowCount &gt; 0) {</span>
<span class="nc" id="L2784">						ResultSet rsTask=pstmt.getGeneratedKeys();</span>
<span class="nc bnc" id="L2785" title="All 2 branches missed.">						if(rsTask.next()){</span>
<span class="nc" id="L2786">							int taskId=rsTask.getInt(1);</span>
<span class="nc" id="L2787">							String insQuery=&quot;insert into st_lms_inv_dl_task_mapping values(&quot;+DNID+&quot;,&quot;+taskId+&quot;,'CONS')&quot;;</span>
<span class="nc" id="L2788">						PreparedStatement	pstmt1=conn.prepareStatement(insQuery);</span>
<span class="nc" id="L2789">							pstmt1.executeUpdate();</span>
						}
						
						
<span class="nc" id="L2793">						bean = new ConsNNonConsBean();</span>
						// bean.
						// validSerNoList.add(bean);
					}

<span class="nc bnc" id="L2798" title="All 4 branches missed.">					if (fstRowUpd &gt; 0</span>
							&amp;&amp; partyDetMap
									.get(userOrgId + &quot;-&quot; + consModelId[i]) != null) {

						// update st_lms_cons_inv_status table to add inventory
						// quantity
<span class="nc" id="L2804">						String incInvStatusQuery = &quot;update st_lms_cons_inv_status set cumm_qty_count=cumm_qty_count+?&quot;</span>
								+ &quot; where inv_model_id =? and party_org_id = ?&quot;;
<span class="nc" id="L2806">						pstmt = conn.prepareStatement(incInvStatusQuery);</span>
<span class="nc" id="L2807">						pstmt.setLong(1, consQty[i]);</span>
<span class="nc" id="L2808">						pstmt.setInt(2, consModelId[i]);</span>
<span class="nc" id="L2809">						pstmt.setInt(3, userOrgId);</span>
<span class="nc" id="L2810">						logger.debug(pstmt);</span>
<span class="nc" id="L2811">						scdRowUpd = pstmt.executeUpdate();</span>

<span class="nc bnc" id="L2813" title="All 2 branches missed.">					} else if (fstRowUpd &gt; 0) {</span>
						// insert into st_lms_cons_inv_status table to add
						// inventory quantity
<span class="nc" id="L2816">						String insIntoInvStatusQuery = &quot;insert into st_lms_cons_inv_status(party_type, party_org_id, &quot;</span>
								+ &quot; inv_model_id, cumm_qty_count) values(?, ?, ?, ?)&quot;;
<span class="nc" id="L2818">						pstmt = conn.prepareStatement(insIntoInvStatusQuery);</span>
<span class="nc" id="L2819">						pstmt.setString(1, userType);</span>
<span class="nc" id="L2820">						pstmt.setInt(2, userOrgId);</span>
<span class="nc" id="L2821">						pstmt.setInt(3, consModelId[i]);</span>
<span class="nc" id="L2822">						pstmt.setLong(4, consQty[i]);</span>
<span class="nc" id="L2823">						logger.debug(pstmt);</span>
<span class="nc" id="L2824">						scdRowUpd = pstmt.executeUpdate();</span>
<span class="nc" id="L2825">						logger.debug(&quot;Total row inserted = &quot; + scdRowUpd);</span>
					}

					/*if (scdRowUpd &gt; 0 &amp;&amp; fstRowUpd &gt; 0) {
						String insIntoInvDetailQuery = &quot;insert into st_lms_cons_inv_detail(user_id, user_org_id, &quot;
								+ &quot; current_owner_id, inv_model_id, quantity, date, ref_transaction_id, amount) select ?, ?,&quot;
								+ &quot; ?, ?, ?, ?, ?, cost_per_unit*? from st_lms_cons_inv_specification where inv_model_id=?&quot;;
						pstmt = conn.prepareStatement(insIntoInvDetailQuery);
						pstmt.setInt(1, userId);
						pstmt.setInt(2, userOrgId);
						pstmt.setInt(3, userOrgId);
						pstmt.setInt(4, consModelId[i]);
						pstmt.setLong(5, consQty[i]);
						pstmt.setTimestamp(6, new Timestamp(
								new java.util.Date().getTime()));
						pstmt.setObject(7, null);
						pstmt.setLong(8, consQty[i]);
						pstmt.setInt(9, consModelId[i]);
						logger.debug(&quot;st_lms_cons_inv_detail = &quot; + pstmt);
						rowCount = pstmt.executeUpdate();
						logger.debug(&quot;Total row inserted = &quot; + rowCount);
						if (rowCount &gt; 0) {
							bean = new ConsNNonConsBean();
							// bean.
							// validSerNoList.add(bean);
						}
					}*/
				}

			} else {
				// values are not in valid format

			}
		}

<span class="nc" id="L2860">		logger.debug(&quot;valid list = &quot; + validSerNoList);</span>
<span class="nc" id="L2861">		logger.debug(&quot;invalid list = &quot; + inValidSerNoList);</span>

<span class="nc" id="L2863">	}</span>

	public int returnConsNNonConsInv(int userOrgId, int userId,
			String ownerType, int agtOrgId, int retOrgId, int[] nonConsInvId,
			int[] nonConsModelId, int[] nonConsBrandId, String[] serNo,
			int[] consInvId, int[] consModelId, int[] consQty, String userType)
			throws LMSException {

<span class="nc" id="L2871">		Connection conn = DBConnect.getConnection();</span>
<span class="nc" id="L2872">		int DNID=0;</span>
		try {
<span class="nc" id="L2874">			conn.setAutoCommit(false);</span>
			
<span class="nc" id="L2876">			String lastDCNoGenerated = null, autoGeneDCNo = null;</span>
<span class="nc" id="L2877">			PreparedStatement boReceiptNoGenStmt=null;</span>
<span class="nc" id="L2878">			boReceiptNoGenStmt = conn.prepareStatement(&quot;SELECT * from st_lms_inv_dl_detail where dl_owner_type=?  ORDER BY generated_dl_id DESC LIMIT 1&quot;);</span>
<span class="nc" id="L2879">			boReceiptNoGenStmt.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L2880">			ResultSet DCRs = boReceiptNoGenStmt.executeQuery();</span>

<span class="nc bnc" id="L2882" title="All 2 branches missed.">			while (DCRs.next()) {</span>
<span class="nc" id="L2883">				lastDCNoGenerated = DCRs.getString(&quot;generated_dl_id&quot;);</span>
			}
<span class="nc" id="L2885">			autoGeneDCNo = GenerateRecieptNo.getRecieptNo(&quot;DNCHALLAN&quot;,</span>
					lastDCNoGenerated, &quot;BO&quot;);
<span class="nc" id="L2887">			System.out.println(&quot;lastDCNoGenerated &quot; + lastDCNoGenerated</span>
					+ &quot;autoGeneDCNo &quot; + autoGeneDCNo);
			
			// insert into lms dl inv detail table for delivery challan
<span class="nc" id="L2891">			PreparedStatement boReceiptStmt = conn.prepareStatement(&quot;insert into st_lms_inv_dl_detail(dl_owner_type,generated_dl_id) values(?,?)&quot;);</span>
			
<span class="nc" id="L2893">			boReceiptStmt.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L2894">			boReceiptStmt.setString(2, autoGeneDCNo);</span>
<span class="nc" id="L2895">			System.out.println(&quot;bo DL receipt = &quot; + boReceiptStmt);</span>
<span class="nc" id="L2896">			boReceiptStmt.execute();</span>
			//find dlID
<span class="nc" id="L2898">			boReceiptNoGenStmt = conn.prepareStatement(&quot;SELECT * from st_lms_inv_dl_detail where generated_dl_id=?  ORDER BY generated_dl_id DESC LIMIT 1&quot;);</span>
<span class="nc" id="L2899">			boReceiptNoGenStmt.setString(1, autoGeneDCNo);</span>
<span class="nc" id="L2900">			 DCRs = boReceiptNoGenStmt.executeQuery();</span>

<span class="nc bnc" id="L2902" title="All 2 branches missed.">			while (DCRs.next()) {</span>
<span class="nc" id="L2903">				DNID = DCRs.getInt(&quot;dl_id&quot;);</span>
			}
			
			// assign non consumable inventory
<span class="nc" id="L2907">			returnNonConsInv(userOrgId, userId, ownerType, agtOrgId, retOrgId,</span>
					nonConsInvId, nonConsModelId, nonConsBrandId, serNo, conn,
					userType,DNID);
			// assign consumable inventory
<span class="nc" id="L2911">			returnConsInv(userOrgId, userId, ownerType, agtOrgId, retOrgId,</span>
					consInvId, consModelId, consQty, conn, userType,DNID);

<span class="nc" id="L2914">			conn.commit();</span>
<span class="nc" id="L2915">		} catch (SQLException e) {</span>
<span class="nc" id="L2916">			e.printStackTrace();</span>
<span class="nc" id="L2917">			throw new LMSException(e);</span>
		} finally {
<span class="nc" id="L2919">			try {</span>
<span class="nc" id="L2920">				conn.close();</span>
<span class="nc" id="L2921">			} catch (SQLException e) {</span>
<span class="nc" id="L2922">				e.printStackTrace();</span>
<span class="nc" id="L2923">				throw new LMSException(e);</span>
<span class="nc" id="L2924">			}</span>
		}

<span class="nc" id="L2927">		return DNID;</span>
	}

	private void returnNonConsInv(int userOrgId, int userId, String ownerType,
			int agtOrgId, int retOrgId, int[] nonConsInvId,
			int[] nonConsModelId, int[] nonConsBrandId, String[] serNo,
			Connection conn, String userType,int DNID) throws SQLException {

<span class="nc" id="L2935">		List&lt;String&gt; validSerNoList = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L2936">		List&lt;String&gt; inValidSerNoList = new ArrayList&lt;String&gt;();</span>

<span class="nc" id="L2938">		String assignSerNoQuery = &quot;update st_lms_inv_status set user_id = ?, user_org_type = ?, user_org_id = ?, &quot;</span>
				+ &quot;current_owner_type = ?, current_owner_id = ? where inv_model_id =? and serial_no = &quot;
				+ &quot; ? and current_owner_id = ?&quot;;
<span class="nc" id="L2941">		PreparedStatement assignSerNoPstmt = conn</span>
				.prepareStatement(assignSerNoQuery);
<span class="nc" id="L2943">		assignSerNoPstmt.setInt(1, userId);</span>
<span class="nc" id="L2944">		assignSerNoPstmt.setString(2, userType);</span>
<span class="nc" id="L2945">		assignSerNoPstmt.setInt(3, userOrgId);</span>
<span class="nc" id="L2946">		assignSerNoPstmt.setString(4, userType);</span>
<span class="nc" id="L2947">		assignSerNoPstmt.setInt(5, userOrgId);</span>
		// assignSerNoPstmt.setInt(6, modId); inside for loop
		// assignSerNoPstmt.setString(7, sNo.trim()); inside for loop
<span class="nc bnc" id="L2950" title="All 2 branches missed.">		assignSerNoPstmt.setInt(8,</span>
				&quot;AGENT&quot;.equalsIgnoreCase(ownerType.trim()) ? agtOrgId
						: retOrgId);		
<span class="nc" id="L2953">		logger.debug(assignSerNoQuery);</span>
		// insert into st_lms_inv_detail table to add inventory quantity
<span class="nc" id="L2955">		String insIntoInvDetQuery = &quot;insert into st_lms_inv_detail(user_id,user_org_type,user_org_id,&quot;</span>
				+ &quot; inv_model_id,serial_no,date,cost_to_bo,is_new,current_owner_type,current_owner_id)&quot;
				+ &quot; select ?,?,?,?,?,?,cost_to_bo, is_new,?,? from st_lms_inv_status where inv_model_id =? &quot;
				+ &quot; and serial_no = ?&quot;;
<span class="nc" id="L2959">		PreparedStatement insIntoInvDet = conn</span>
				.prepareStatement(insIntoInvDetQuery);
<span class="nc" id="L2961">		insIntoInvDet.setInt(1, userId);</span>
<span class="nc" id="L2962">		insIntoInvDet.setString(2, userType);</span>
<span class="nc" id="L2963">		insIntoInvDet.setInt(3, userOrgId);</span>
		// insIntoInvDet.setInt(4, modId); inside for loop
		// insIntoInvDet.setString(5, sNo.trim()); inside for loop
<span class="nc" id="L2966">		insIntoInvDet.setTimestamp(6, new Timestamp(new java.util.Date()</span>
				.getTime()));
<span class="nc" id="L2968">		insIntoInvDet.setString(7, userType);</span>
<span class="nc" id="L2969">		insIntoInvDet.setInt(8, userOrgId);</span>
		// insIntoInvDet.setInt(9, modId); inside for loop
		// insIntoInvDet.setString(10, sNo.trim()); inside for loop		
<span class="nc" id="L2972">		logger.debug(insIntoInvDetQuery);		</span>
<span class="nc" id="L2973">		String[] serNoArr = null;</span>
<span class="nc" id="L2974">		int fstRowUpd = -1, scdRowUpd = -1;</span>
<span class="nc bnc" id="L2975" title="All 2 branches missed.">		for (int i = 0, len = nonConsModelId.length; i &lt; len; i = i + 1) {</span>
<span class="nc bnc" id="L2976" title="All 8 branches missed.">			if (nonConsInvId[i] &gt; 0 &amp;&amp; nonConsModelId[i] &gt; 0</span>
					&amp;&amp; nonConsBrandId[i] &gt; 0 &amp;&amp; !&quot;&quot;.equals(serNo[i].trim())) {

<span class="nc" id="L2979">				assignSerNoPstmt.setInt(6, nonConsModelId[i]);</span>

<span class="nc" id="L2981">				insIntoInvDet.setInt(4, nonConsModelId[i]);</span>
<span class="nc" id="L2982">				insIntoInvDet.setInt(9, nonConsModelId[i]);</span>

<span class="nc" id="L2984">				serNoArr = serNo[i].split(&quot;,&quot;);</span>
<span class="nc bnc" id="L2985" title="All 2 branches missed.">				for (int k = 0, klen = serNoArr.length; k &lt; klen; k = k + 1) {</span>
<span class="nc" id="L2986">					fstRowUpd = -1;</span>
<span class="nc" id="L2987">					scdRowUpd = -1;</span>
<span class="nc bnc" id="L2988" title="All 2 branches missed.">					if (!&quot;&quot;.equals(serNoArr[k].trim())) {</span>
						// update st_lms_inv_status
<span class="nc" id="L2990">						assignSerNoPstmt.setString(7, serNoArr[k].trim());</span>
<span class="nc" id="L2991">						logger.debug(&quot;updPstmt = &quot; + assignSerNoPstmt);</span>
<span class="nc" id="L2992">						fstRowUpd = assignSerNoPstmt.executeUpdate();</span>

<span class="nc bnc" id="L2994" title="All 2 branches missed.">						if (fstRowUpd == 1) {</span>
							// insert data into st_lms_inv_detail
<span class="nc" id="L2996">							insIntoInvDet.setString(5, serNoArr[k].trim());</span>
<span class="nc" id="L2997">							insIntoInvDet.setString(10, serNoArr[k].trim());</span>
<span class="nc" id="L2998">							logger.debug(&quot;insPstmt = &quot; + insIntoInvDet);</span>
<span class="nc" id="L2999">							scdRowUpd = insIntoInvDet.executeUpdate();</span>
<span class="nc bnc" id="L3000" title="All 2 branches missed.">							if (scdRowUpd &gt; 0) {</span>
<span class="nc" id="L3001">								ResultSet rsTask=insIntoInvDet.getGeneratedKeys();</span>
<span class="nc bnc" id="L3002" title="All 2 branches missed.">								if(rsTask.next()){</span>
<span class="nc" id="L3003">									int taskId=rsTask.getInt(1);</span>
<span class="nc" id="L3004">									String insQuery=&quot;insert into st_lms_inv_dl_task_mapping values(&quot;+DNID+&quot;,&quot;+taskId+&quot;,'NON_CONS')&quot;;</span>
<span class="nc" id="L3005">								PreparedStatement	pstmt=conn.prepareStatement(insQuery);</span>
<span class="nc" id="L3006">									pstmt.executeUpdate();</span>
								}
								
<span class="nc" id="L3009">								validSerNoList.add(serNoArr[k].trim());</span>
<span class="nc" id="L3010">							}</span>
						} else {
<span class="nc" id="L3012">							inValidSerNoList.add(serNoArr[k].trim());</span>
						}
					}
				}

			} else {
				// values are not in valid format
<span class="nc" id="L3019">				logger.debug(&quot;inside else ==== &quot; + nonConsInvId[i] + &quot; == &quot;</span>
						+ nonConsModelId[i] + &quot; === &quot; + nonConsBrandId[i]
						+ &quot;==&quot; + serNo[i].trim());
			}
		}

<span class="nc" id="L3025">		logger.debug(&quot;valid list = &quot; + validSerNoList);</span>
<span class="nc" id="L3026">		logger.debug(&quot;invalid list = &quot; + inValidSerNoList);</span>

<span class="nc" id="L3028">	}</span>

	private String verifyAssignConsInv(int userOrgId, int[] consInvId,
			int[] consModelId, int[] consQty, Connection conn)
			throws SQLException {
<span class="nc" id="L3033">		logger.debug(&quot;verifyAssignConsInv called&quot;);</span>
		// List&lt;String&gt; validSerNoList = new ArrayList&lt;String&gt;();
<span class="nc" id="L3035">		List&lt;String&gt; inValidSerNoList = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L3036">		Statement stmt1 = conn.createStatement();</span>
<span class="nc" id="L3037">		int countrows = 0;</span>
<span class="nc" id="L3038">		String fetchDetailsQuery = &quot;select party_org_id, aa.inv_model_id, cumm_qty_count, inv_name, &quot;</span>
				+ &quot; concat(spec_value, '-', spec_unit, '-', spec_type) 'model_name' from st_lms_cons_inv_status&quot;
				+ &quot; aa, st_lms_cons_inv_specification bb, st_lms_inv_master cc where aa.inv_model_id =  &quot;
				+ &quot; bb.inv_model_id and bb.inv_id = cc.inv_id and aa.inv_model_id = ? and party_org_id = ?&quot;
				+ &quot; and cumm_qty_count &lt; ?&quot;;
<span class="nc" id="L3043">		PreparedStatement pstmt = conn.prepareStatement(fetchDetailsQuery);</span>
<span class="nc bnc" id="L3044" title="All 2 branches missed.">		if (consModelId != null) {</span>
<span class="nc bnc" id="L3045" title="All 2 branches missed.">			for (int i = 0, len = consModelId.length; i &lt; len; i = i + 1) {</span>
<span class="nc bnc" id="L3046" title="All 6 branches missed.">				if (consInvId[i] &gt; 0 &amp;&amp; consModelId[i] &gt; 0 &amp;&amp; consQty[i] &gt; 0) {</span>
<span class="nc bnc" id="L3047" title="All 2 branches missed.">					if (countrows == 0) {</span>
<span class="nc" id="L3048">						logger</span>
								.debug(&quot;query 111 3333&quot;
										+ &quot;select party_org_id, aa.inv_model_id, cumm_qty_count, inv_name, &quot;
										+ &quot; concat(spec_value, '-', spec_unit, '-', spec_type) 'model_name' from st_lms_cons_inv_status&quot;
										+ &quot; aa, st_lms_cons_inv_specification bb, st_lms_inv_master cc where aa.inv_model_id =  &quot;
										+ &quot; bb.inv_model_id and bb.inv_id = cc.inv_id and aa.inv_model_id = &quot;
										+ consModelId[i]
										+ &quot; and party_org_id = &quot; + userOrgId
										+ &quot;&quot; + &quot; &quot;);
<span class="nc" id="L3057">						ResultSet rs = stmt1</span>
								.executeQuery(&quot;select party_org_id, aa.inv_model_id, cumm_qty_count, inv_name, &quot;
										+ &quot; concat(spec_value, '-', spec_unit, '-', spec_type) 'model_name' from st_lms_cons_inv_status&quot;
										+ &quot; aa, st_lms_cons_inv_specification bb, st_lms_inv_master cc where aa.inv_model_id =  &quot;
										+ &quot; bb.inv_model_id and bb.inv_id = cc.inv_id and aa.inv_model_id = &quot;
										+ consModelId[i]
										+ &quot; and party_org_id = &quot;
										+ userOrgId
										+ &quot;&quot;);
<span class="nc bnc" id="L3066" title="All 2 branches missed.">						if (rs.next()) {</span>
<span class="nc" id="L3067">							countrows++;</span>
						}
					}
<span class="nc bnc" id="L3070" title="All 2 branches missed.">					if (countrows &gt; 0) {</span>
<span class="nc" id="L3071">						logger</span>
								.debug(&quot;query 111 &quot;
										+ &quot;select party_org_id, aa.inv_model_id, cumm_qty_count, inv_name, &quot;
										+ &quot; concat(spec_value, '-', spec_unit, '-', spec_type) 'model_name' from st_lms_cons_inv_status&quot;
										+ &quot; aa, st_lms_cons_inv_specification bb, st_lms_inv_master cc where aa.inv_model_id =  &quot;
										+ &quot; bb.inv_model_id and bb.inv_id = cc.inv_id and aa.inv_model_id = &quot;
										+ consModelId[i]
										+ &quot; and party_org_id = &quot; + userOrgId
										+ &quot;&quot; + &quot; and cumm_qty_count &lt; &quot;
										+ consQty[i] + &quot;&quot;);
<span class="nc" id="L3081">						pstmt.setInt(1, consModelId[i]);</span>
<span class="nc" id="L3082">						pstmt.setInt(2, userOrgId);</span>
<span class="nc" id="L3083">						pstmt.setInt(3, consQty[i]);</span>
<span class="nc" id="L3084">						ResultSet rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L3085" title="All 2 branches missed.">						while (rs.next()) {</span>
<span class="nc" id="L3086">							inValidSerNoList.add(consModelId[i] + &quot;=&quot;</span>
									+ consQty[i]);
						}
					}
				}

			}

<span class="nc bnc" id="L3094" title="All 2 branches missed.">			if (countrows == 0) {</span>
<span class="nc bnc" id="L3095" title="All 2 branches missed.">				for (int i = 0, len = consModelId.length; i &lt; len; i = i + 1) {</span>
<span class="nc bnc" id="L3096" title="All 6 branches missed.">					if (consInvId[i] &gt; 0 &amp;&amp; consModelId[i] &gt; 0</span>
							&amp;&amp; consQty[i] &gt; 0) {
<span class="nc" id="L3098">						inValidSerNoList.add(consModelId[i] + &quot;=&quot; + consQty[i]);</span>
					}
				}
			}
		}

<span class="nc" id="L3104">		logger.debug(&quot;invalid list = &quot; + inValidSerNoList);</span>
<span class="nc" id="L3105">		return inValidSerNoList.toString().replace(&quot;[&quot;, &quot;&quot;).replace(&quot;]&quot;, &quot;&quot;);</span>

	}

	private String verifyAssignNonConsInv(int userOrgId, int[] nonConsInvId,
			int[] nonConsModelId, int[] nonConsBrandId, String[] serNo,
			Connection conn) throws SQLException {
<span class="nc" id="L3112">		logger.debug(&quot;verifyAssignNonConsInv called&quot;);</span>
<span class="nc" id="L3113">		List&lt;String&gt; validSerNoList = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L3114">		List&lt;String&gt; inValidSerNoList = new ArrayList&lt;String&gt;();</span>

<span class="nc" id="L3116">		String assignSerNoQuery = null;</span>
<span class="nc" id="L3117">		Statement assignSerNoPstmt = conn.createStatement();</span>
<span class="nc" id="L3118">		ResultSet rs = null;</span>

<span class="nc" id="L3120">		String[] serNoArr = null;</span>
<span class="nc" id="L3121">		List&lt;String&gt; dbEntries = new ArrayList&lt;String&gt;();</span>

<span class="nc bnc" id="L3123" title="All 2 branches missed.">		if (nonConsModelId != null) {</span>
<span class="nc bnc" id="L3124" title="All 2 branches missed.">			for (int i = 0, len = nonConsModelId.length; i &lt; len; i = i + 1) {</span>
<span class="nc bnc" id="L3125" title="All 8 branches missed.">				if (nonConsInvId[i] &gt; 0 &amp;&amp; nonConsModelId[i] &gt; 0</span>
						&amp;&amp; nonConsBrandId[i] &gt; 0 &amp;&amp; !&quot;&quot;.equals(serNo[i].trim())) {

<span class="nc" id="L3128">					assignSerNoQuery = &quot;select serial_no from st_lms_inv_status  where inv_model_id = &quot;</span>
							+ nonConsModelId[i]
							+ &quot; and serial_no in ( &quot;
							+ &quot;'&quot;
							+ serNo[i].replace(&quot;,&quot;, &quot;','&quot;).toUpperCase()
							+ &quot;'&quot;
							+ &quot; ) and  current_owner_type !='REMOVED' and current_owner_id = &quot; + userOrgId;
<span class="nc" id="L3135">					logger.debug(&quot;fetch nonCons list1 Pstmt = &quot;</span>
							+ assignSerNoQuery);
<span class="nc" id="L3137">					rs = assignSerNoPstmt.executeQuery(assignSerNoQuery);</span>
<span class="nc" id="L3138">					dbEntries.clear();</span>
<span class="nc bnc" id="L3139" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L3140">						dbEntries.add(rs.getString(&quot;serial_no&quot;));</span>
					}

<span class="nc" id="L3143">					serNoArr = serNo[i].split(&quot;,&quot;);</span>
<span class="nc bnc" id="L3144" title="All 2 branches missed.">					for (int k = 0, klen = serNoArr.length; k &lt; klen; k = k + 1) {</span>
<span class="nc bnc" id="L3145" title="All 2 branches missed.">						if (!&quot;&quot;.equals(serNoArr[k].trim())) {</span>
<span class="nc bnc" id="L3146" title="All 2 branches missed.">							if (dbEntries.contains(serNoArr[k].trim()</span>
									.toUpperCase())) {
<span class="nc" id="L3148">								validSerNoList.add(serNoArr[k].trim());</span>
							} else {
<span class="nc" id="L3150">								inValidSerNoList.add(nonConsModelId[i] + &quot;=&quot;</span>
										+ serNoArr[k].trim());
							}
						}
					}

				} else {
					// values are not in valid format
<span class="nc" id="L3158">					logger.debug(&quot;inside else ==== &quot; + nonConsInvId[i] + &quot; == &quot;</span>
							+ nonConsModelId[i] + &quot; === &quot; + nonConsBrandId[i]
							+ &quot;==&quot; + serNo[i].trim());
				}
			}
		}

<span class="nc" id="L3165">		logger.debug(&quot;valid list = &quot; + validSerNoList);</span>
<span class="nc" id="L3166">		logger.debug(&quot;invalid list = &quot; + inValidSerNoList);</span>

<span class="nc" id="L3168">		return inValidSerNoList.toString().replace(&quot;[&quot;, &quot;&quot;).replace(&quot;]&quot;, &quot;&quot;);</span>
	}

	public String verifyConsNNonConsInv(int userOrgId, int[] nonConsInvId,
			int[] nonConsModelId, int[] nonConsBrandId, String[] serNo,
			int[] consInvId, int[] consModelId, int[] consQty, String userType)
			throws LMSException {

<span class="nc" id="L3176">		Connection conn = DBConnect.getConnection();</span>
		try {
			// conn.setAutoCommit(false);
			// assign non consumable inventory
<span class="nc" id="L3180">			String nonConsInvRes = verifyAssignNonConsInv(userOrgId,</span>
					nonConsInvId, nonConsModelId, nonConsBrandId, serNo, conn);
			// assign consumable inventory
<span class="nc" id="L3183">			String consInvRes = verifyAssignConsInv(userOrgId, consInvId,</span>
					consModelId, consQty, conn);

<span class="nc" id="L3186">			return nonConsInvRes + &quot;:&quot; + consInvRes;</span>
			// conn.commit();
<span class="nc" id="L3188">		} catch (SQLException e) {</span>
<span class="nc" id="L3189">			e.printStackTrace();</span>
<span class="nc" id="L3190">			throw new LMSException(e);</span>
		} finally {
<span class="nc" id="L3192">			try {</span>
<span class="nc" id="L3193">				conn.close();</span>
<span class="nc" id="L3194">			} catch (SQLException e) {</span>
<span class="nc" id="L3195">				e.printStackTrace();</span>
<span class="nc" id="L3196">				throw new LMSException(e);</span>
<span class="nc" id="L3197">			}</span>
		}
	}
	
	public String verifyConsNNonConsInv(int userOrgId, int[] nonConsInvId,
			int[] nonConsModelId, int[] nonConsBrandId, String[] serNo,
			int[] consInvId, int[] consModelId, int[] consQty, String userType,int agentOrgId)
			throws LMSException {

<span class="nc" id="L3206">		Connection conn = DBConnect.getConnection();</span>
		try {
			// conn.setAutoCommit(false);
			// assign non consumable inventory
<span class="nc" id="L3210">			String nonConsInvRes = verifyAssignNonConsInv(userOrgId,</span>
					nonConsInvId, nonConsModelId, nonConsBrandId, serNo, conn);
<span class="nc" id="L3212">			String consInvRes=&quot;&quot;;</span>
<span class="nc bnc" id="L3213" title="All 2 branches missed.">			if(WrapperUtility.isAgentExist(agentOrgId))</span>
			// assign consumable inventory
<span class="nc" id="L3215">			 consInvRes = verifyAssignConsInv(userOrgId, consInvId,	consModelId, consQty, conn);</span>

<span class="nc" id="L3217">			return nonConsInvRes + &quot;:&quot; + consInvRes;</span>
			// conn.commit();
<span class="nc" id="L3219">		} catch (SQLException e) {</span>
<span class="nc" id="L3220">			e.printStackTrace();</span>
<span class="nc" id="L3221">			throw new LMSException(e);</span>
		} finally {
<span class="nc" id="L3223">			try {</span>
<span class="nc" id="L3224">				conn.close();</span>
<span class="nc" id="L3225">			} catch (SQLException e) {</span>
<span class="nc" id="L3226">				e.printStackTrace();</span>
<span class="nc" id="L3227">				throw new LMSException(e);</span>
<span class="nc" id="L3228">			}</span>
		}
	}
	
	
	public List&lt;String&gt; fetchSerialNoList(String modelID) throws SQLException {
<span class="nc" id="L3234">		logger.debug(&quot;fetchSerialNoList called&quot;);		</span>
<span class="nc" id="L3235">		List&lt;String&gt; serialNoList = new ArrayList&lt;String&gt;();		</span>
<span class="nc" id="L3236">		String[] model_brand = modelID.split(&quot;-&quot;);		</span>
<span class="nc" id="L3237">		Connection con = null;		</span>
<span class="nc" id="L3238">		ResultSet rs = null;</span>
<span class="nc" id="L3239">		PreparedStatement pstmt = null;</span>
		try {
			
<span class="nc" id="L3242">				con = DBConnect.getConnection();			</span>
<span class="nc" id="L3243">				pstmt = con.prepareStatement(&quot;select serial_no from st_lms_inv_detail where inv_model_id = ?&quot;);</span>
<span class="nc" id="L3244">				pstmt.setString(1,model_brand[0]);		</span>
<span class="nc" id="L3245">				rs = pstmt.executeQuery();		</span>
<span class="nc bnc" id="L3246" title="All 2 branches missed.">				while(rs.next()){</span>
<span class="nc" id="L3247">					serialNoList.add(rs.getString(&quot;serial_no&quot;));</span>
				}	
<span class="nc" id="L3249">				logger.debug(serialNoList);</span>
<span class="nc" id="L3250">			}catch (SQLException e) {</span>
<span class="nc" id="L3251">				logger.error(&quot;Exception:&quot;+e);	</span>
<span class="nc" id="L3252">			}catch (Exception e) {</span>
<span class="nc" id="L3253">				logger.error(&quot;Exception:&quot;+e);	</span>
			} finally {
<span class="nc" id="L3255">				DBConnect.closeConnection(con, pstmt, rs);</span>
<span class="nc" id="L3256">			}</span>
<span class="nc" id="L3257">			return serialNoList;</span>
	}
	
	
	public Set&lt;String&gt; findDuplicates(List&lt;String&gt; listContainingDuplicates, int bind_len)
	{ 
<span class="nc" id="L3263">		final Set&lt;String&gt; setToReturn = new HashSet&lt;String&gt;(); </span>
<span class="nc" id="L3264">		final Set&lt;String&gt; set1 = new HashSet&lt;String&gt;();</span>
		
<span class="nc bnc" id="L3266" title="All 2 branches missed.">		for (String str : listContainingDuplicates)</span>
		{
<span class="nc bnc" id="L3268" title="All 2 branches missed.">			if(bind_len &gt; 0){</span>
<span class="nc bnc" id="L3269" title="All 2 branches missed.">			 	if (!set1.add(str.substring(str.length()-bind_len, str.length()))) {</span>
<span class="nc" id="L3270">			 		set1.add(str.substring(str.length()-bind_len, str.length()));</span>
<span class="nc" id="L3271">			 		setToReturn.add(str);</span>
			 	}
<span class="nc bnc" id="L3273" title="All 2 branches missed.">			}else if (bind_len == 0){</span>
<span class="nc bnc" id="L3274" title="All 2 branches missed.">				if (!set1.add(str)) {</span>
<span class="nc" id="L3275">				   setToReturn.add(str);</span>
				}
			}
<span class="nc" id="L3278">		}</span>
<span class="nc" id="L3279">		return setToReturn;</span>
	}

	public Map&lt;String, InvDetailBean&gt; getDuplicateInvetoryMap(Map&lt;String, InvDetailBean&gt; invMap,
			int bindLen,int modelId,boolean isInvCodeReq,Connection con) throws LMSException {

		
<span class="nc" id="L3286">		Map&lt;String,InvDetailBean&gt; duplicateInvMap = new HashMap&lt;String, InvDetailBean&gt;();</span>
<span class="nc" id="L3287">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L3288">		ResultSet rs = null;</span>
<span class="nc" id="L3289">		Map&lt;String,String&gt; getSrNoFromInvCode=new HashMap&lt;String,String&gt;();</span>
		try{
			
<span class="nc" id="L3292">			Iterator&lt;Entry&lt;String, InvDetailBean&gt;&gt; invItr =invMap.entrySet().iterator();</span>
			
<span class="nc" id="L3294">			StringBuilder snSbr = new StringBuilder();</span>
<span class="nc" id="L3295">			StringBuilder invcSbr = new StringBuilder();</span>
<span class="nc" id="L3296">			boolean isFirst =true;</span>
<span class="nc bnc" id="L3297" title="All 2 branches missed.">			while(invItr.hasNext()){</span>
<span class="nc" id="L3298">				Entry&lt;String, InvDetailBean&gt; entry=invItr.next();</span>
<span class="nc bnc" id="L3299" title="All 2 branches missed.">				if(!isFirst){</span>
					
<span class="nc" id="L3301">					snSbr.append(&quot;,&quot;);</span>
<span class="nc" id="L3302">					invcSbr.append(&quot;,&quot;);</span>
				}
<span class="nc bnc" id="L3304" title="All 2 branches missed.">				if(bindLen&gt;0){</span>
<span class="nc" id="L3305">					snSbr.append(&quot;'&quot;+entry.getValue().getSerialNo().substring(entry.getValue().getSerialNo().length()-bindLen,entry.getValue().getSerialNo().length())+&quot;'&quot;);</span>
					
				}else{
<span class="nc" id="L3308">					snSbr.append(&quot;'&quot;+entry.getValue().getSerialNo()+&quot;'&quot;);</span>
					
				}
<span class="nc" id="L3311">				invcSbr.append(&quot;'&quot;+entry.getValue().getCode()+&quot;'&quot;);</span>
<span class="nc" id="L3312">				getSrNoFromInvCode.put(entry.getValue().getCode(), entry.getValue().getSerialNo());</span>
<span class="nc" id="L3313">				isFirst=false;</span>
<span class="nc" id="L3314">			}</span>
<span class="nc" id="L3315">			con =DBConnect.getConnection();</span>
			
<span class="nc" id="L3317">			String getDuplicates =null ;</span>
<span class="nc bnc" id="L3318" title="All 2 branches missed.">			if(isInvCodeReq){</span>
<span class="nc bnc" id="L3319" title="All 2 branches missed.">				if(bindLen&gt;0){</span>
<span class="nc" id="L3320">					getDuplicates=&quot; select invStatus.serial_no srNo ,inv_code invCode from st_lms_inv_status invStatus  inner join st_lms_inv_mapping  invMap on invStatus.serial_no=invMap.serial_no where invStatus.inv_model_id =? and (SUBSTRING(invStatus.serial_no,?)  in (&quot;+snSbr.toString()+&quot;) or inv_code in (&quot;+invcSbr.toString()+&quot;))&quot;;	</span>
				}else{
					
<span class="nc" id="L3323">					getDuplicates=&quot; select invStatus.serial_no srNo ,inv_code invCode from st_lms_inv_status invStatus  inner join st_lms_inv_mapping  invMap on invStatus.serial_no=invMap.serial_no where invStatus.inv_model_id =? and (invStatus.serial_no  in (&quot;+snSbr.toString()+&quot;) or inv_code in (&quot;+invcSbr.toString()+&quot;))&quot;;</span>
					
				}
				
				
			}else{
<span class="nc bnc" id="L3329" title="All 2 branches missed.">				if(bindLen&gt;0){</span>
<span class="nc" id="L3330">					getDuplicates =&quot;select serial_no srNo from st_lms_inv_status where inv_model_id =? and SUBSTRING(serial_no,?)  in (&quot;+snSbr.toString()+&quot;)&quot;;</span>
				}else{
<span class="nc" id="L3332">					getDuplicates =&quot;select serial_no srNo from st_lms_inv_status where inv_model_id =? and serial_no in (&quot;+snSbr.toString()+&quot;)&quot;;</span>
				}
				
			}
			
<span class="nc" id="L3337">			pstmt =con.prepareStatement(getDuplicates);</span>
<span class="nc" id="L3338">			pstmt.setInt(1, modelId);</span>
<span class="nc bnc" id="L3339" title="All 2 branches missed.">			if(bindLen&gt;0){</span>
<span class="nc" id="L3340">				pstmt.setInt(2, bindLen);</span>
			}
			
<span class="nc" id="L3343">			logger.info(&quot;Inventory Check :-&quot;+pstmt);</span>
<span class="nc" id="L3344">			rs =pstmt.executeQuery();</span>
			// Get Duplicate Inventory Map And Remove Duplicate Inventory  
<span class="nc bnc" id="L3346" title="All 2 branches missed.">			if(isInvCodeReq){</span>
<span class="nc bnc" id="L3347" title="All 2 branches missed.">				while(rs.next()){</span>
<span class="nc" id="L3348">					   InvDetailBean invBean =new InvDetailBean();</span>
<span class="nc bnc" id="L3349" title="All 2 branches missed.">					   if(invMap.containsKey(rs.getString(&quot;srNo&quot;))){</span>
<span class="nc" id="L3350">						   invBean.setSerialNo(rs.getString(&quot;srNo&quot;));</span>
<span class="nc" id="L3351">						   invBean.setCode(invMap.get(rs.getString(&quot;srNo&quot;)).getCode());</span>
						  
					   	}else{
					   		
<span class="nc" id="L3355">					   	   invBean.setSerialNo(getSrNoFromInvCode.get(rs.getString(&quot;invCode&quot;)));</span>
<span class="nc" id="L3356">						   invBean.setCode(rs.getString(&quot;invCode&quot;));</span>
					   	}
<span class="nc" id="L3358">					   invMap.remove(invBean.getSerialNo());</span>
<span class="nc" id="L3359">					   duplicateInvMap.put(invBean.getSerialNo(),invBean);</span>
				
<span class="nc" id="L3361">				}</span>
				
			}else{
<span class="nc bnc" id="L3364" title="All 2 branches missed.">				while(rs.next()){</span>
<span class="nc" id="L3365">					 InvDetailBean invBean =new InvDetailBean();</span>
<span class="nc" id="L3366">					 invBean.setSerialNo(rs.getString(&quot;srNo&quot;));</span>
<span class="nc" id="L3367">					 duplicateInvMap.put(invBean.getSerialNo(),invBean);</span>
<span class="nc" id="L3368">					 invMap.remove(rs.getString(&quot;srNo&quot;));</span>
<span class="nc" id="L3369">				}</span>
			}
			
			
			
			
<span class="nc" id="L3375">		}catch(SQLException e){</span>
<span class="nc" id="L3376">			logger.error(&quot;SQL Exception : &quot;,e);</span>
<span class="nc" id="L3377">			throw new LMSException(LMSErrors.SQL_EXCEPTION_ERROR_CODE,LMSErrors.SQL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="nc" id="L3378">		}catch (Exception e) {</span>
<span class="nc" id="L3379">			logger.error(&quot;Exception: &quot;,e);</span>
<span class="nc" id="L3380">			throw new LMSException(LMSErrors.GENERAL_EXCEPTION_ERROR_CODE,LMSErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
		}finally{
<span class="nc" id="L3382">			DBConnect.closeConnection(pstmt,rs);</span>
<span class="nc" id="L3383">		}</span>
		//logger.debug(returnList);
<span class="nc" id="L3385">		return duplicateInvMap;</span>
  
	}
	
	
   }
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>