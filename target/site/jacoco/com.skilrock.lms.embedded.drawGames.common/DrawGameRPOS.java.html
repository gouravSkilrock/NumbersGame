<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DrawGameRPOS.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lms</a> &gt; <a href="index.source.html" class="el_package">com.skilrock.lms.embedded.drawGames.common</a> &gt; <span class="el_source">DrawGameRPOS.java</span></div><h1>DrawGameRPOS.java</h1><pre class="source lang-java linenums">package com.skilrock.lms.embedded.drawGames.common;

import java.io.IOException;
import java.io.PrintWriter;
import java.sql.Timestamp;
import java.text.NumberFormat;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.TreeMap;

import javax.servlet.ServletContext;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.apache.struts2.ServletActionContext;
import org.apache.struts2.interceptor.ServletRequestAware;
import org.apache.struts2.interceptor.ServletResponseAware;

import com.opensymphony.xwork2.ActionContext;
import com.opensymphony.xwork2.ActionSupport;
import com.skilrock.lms.ajax.AjaxRequestHelper;
import com.skilrock.lms.beans.UserInfoBean;
import com.skilrock.lms.common.Utility;
import com.skilrock.lms.common.exception.LMSException;
import com.skilrock.lms.common.utility.LMSUtility;
import com.skilrock.lms.coreEngine.drawGames.drawMgmt.DrawGameMgmtHelper;
import com.skilrock.lms.coreEngine.drawGames.playMgmt.DrawGameRPOSHelper;
import com.skilrock.lms.coreEngine.drawGames.playMgmt.MpesaPaymentProcessHelper;
import com.skilrock.lms.coreEngine.drawGames.playMgmt.ServerStartUpData;
import com.skilrock.lms.coreEngine.userMgmt.common.CommonFunctionsHelper;
import com.skilrock.lms.dge.beans.CancelTicketBean;
import com.skilrock.lms.dge.beans.DrawDataBean;
import com.skilrock.lms.dge.beans.DrawDetailsBean;
import com.skilrock.lms.dge.beans.DrawIdBean;
import com.skilrock.lms.dge.beans.DrawWinningReportBean;
import com.skilrock.lms.dge.beans.EmbeddedReprint;
import com.skilrock.lms.dge.beans.FortunePurchaseBean;
import com.skilrock.lms.dge.beans.FortuneThreePurchaseBean;
import com.skilrock.lms.dge.beans.FortuneTwoPurchaseBean;
import com.skilrock.lms.dge.beans.KenoPurchaseBean;
import com.skilrock.lms.dge.beans.LottoPurchaseBean;
import com.skilrock.lms.dge.beans.MainPWTDrawBean;
import com.skilrock.lms.dge.beans.PWTDrawBean;
import com.skilrock.lms.dge.beans.PanelIdBean;
import com.skilrock.lms.dge.beans.RaffleDrawIdBean;
import com.skilrock.lms.dge.beans.RafflePurchaseBean;
import com.skilrock.lms.dge.beans.ReportDrawBean;
import com.skilrock.lms.rest.common.TransactionManager;
import com.skilrock.lms.web.drawGames.common.Util;
import com.skilrock.lms.web.drawGames.common.UtilApplet;

public class DrawGameRPOS extends ActionSupport implements ServletRequestAware,
ServletResponseAware {
<span class="fc" id="L63">	static Log logger = LogFactory.getLog(DrawGameRPOS.class);</span>
	/**
	 * 
	 */
	private static final long serialVersionUID = 1L;
	
<span class="nc" id="L69">	public DrawGameRPOS() {</span>
<span class="nc" id="L70">		rposHelper = new DrawGameRPOSHelper();</span>
<span class="nc" id="L71">		reprintFactory = new ReprintFactory();</span>
<span class="nc" id="L72">	}</span>
	
<span class="fc" id="L74">	public DrawGameRPOS(DrawGameRPOSHelper rposHelper, ReprintFactory reprintFactory) {</span>
<span class="fc" id="L75">		this.rposHelper = rposHelper;</span>
<span class="fc" id="L76">		this.reprintFactory = reprintFactory;</span>
<span class="fc" id="L77">	}</span>

	public static void main(String[] args) throws Exception {
		// ServiceRequest req = new ServiceRequest();
		// DrawGameRPOS dg = new DrawGameRPOS();
		// dg.prizeWinningTicket();

<span class="nc" id="L84">		Date d = new Date(1267522200000l);</span>
<span class="nc" id="L85">		logger.debug(d);</span>
<span class="nc" id="L86">	}</span>
	
	private DrawGameRPOSHelper rposHelper;
	/*public DrawGameRPOS() {
		
	}*/

	private boolean autoCancel;
	TreeMap drawGameData;
	private String drawGameNewData;
	private String drawTime;
	private String firstName;
	private String gameName;
	private int gameNo;
	private String idNumber;
	private String idType;
	private String lastName;
	private HttpServletResponse response;
	private HttpServletRequest servletRequest;
<span class="pc" id="L105">	HttpSession session = null;</span>
	private String startDate;
	private String ticketNo;
	private String isNewURL;
	private String userName;
	private String mobileNo;
	private long LSTktNo;
	private String mPesa;
	private String endDate;
	private double version;//Terminal Version 
    private String cancelType;
    private String curDate;
    private String countryDeployed;
    private String balance;
    private String isDrawAvailable;
    private Object gameBean;
    private UserInfoBean userInfoBean;
    private String gameBeanType;
    private EmbeddedReprint embeddedReprint;
    private ServletContext servletContext;
    String finalReprintData;
    private ReprintFactory reprintFactory;
    private Map currentUserSessionMap;
	private String refernceMerchantId;
	private String actionName;
	private NumberFormat numberFormat;
	private int autoCancelHoldDays;
	private long lastPrintedTicket;
	private int gameId ;
	private double userBalance;
    
	public void cancelTicketNew() throws Exception {
<span class="nc" id="L137">		ServletContext sc = ServletActionContext.getServletContext();</span>
<span class="nc" id="L138">		String isDraw = (String) sc.getAttribute(&quot;IS_DRAW&quot;);</span>
<span class="nc" id="L139">		int barCodeCount=-1;</span>
<span class="nc" id="L140">		int inpType=Integer.parseInt((String) sc.getAttribute(&quot;InpType&quot;));</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">		if (isDraw.equalsIgnoreCase(&quot;NO&quot;)) {</span>
<span class="nc" id="L142">			response.getOutputStream().write(</span>
					(&quot;ErrorMsg:&quot; + EmbeddedErrors.DRAW_GAME_NOT_AVAILABLE+&quot;ErrorCode:&quot; + EmbeddedErrors.DRAW_GAME_NOT_AVAILABLE_ERROR_CODE+&quot;|&quot;).getBytes());
<span class="nc" id="L144">			return;</span>
		}
<span class="nc" id="L146">		Map currentUserSessionMap = (Map) sc.getAttribute(&quot;LOGGED_IN_USERS&quot;);</span>
		// logger.debug(&quot;LOGGED_IN_USERS map is: &quot; + currentUserSessionMap);
		// logger.debug(&quot;user name is: &quot; + userName);
<span class="nc" id="L149">		HttpSession session = (HttpSession) currentUserSessionMap.get(userName);</span>
<span class="nc" id="L150">		UserInfoBean userInfoBean = (UserInfoBean) session</span>
		.getAttribute(&quot;USER_INFO&quot;);
<span class="nc" id="L152">		String refMerchantId = (String) sc.getAttribute(&quot;REF_MERCHANT_ID&quot;);</span>
		/*int autoCancelHoldDays=Integer.parseInt((String) sc.getAttribute(&quot;AUTO_CANCEL_CLOSER_DAYS&quot;));
		long lastPrintedTicket=0;
		int gameId = 0;
		if(LSTktNo != 0){
			lastPrintedTicket = LSTktNo/100;
			gameId = Util.getGameIdFromGameNumber(Util.getGamenoFromTktnumber(String.valueOf(LSTktNo)));
		}
		String actionName=ActionContext.getContext().getName();
		DrawGameRPOSHelper drawGameRPOSHelper = new DrawGameRPOSHelper();
		drawGameRPOSHelper.checkLastPrintedTicketStatusAndUpdate(userInfoBean,lastPrintedTicket,&quot;TERMINAL&quot;,refMerchantId,autoCancelHoldDays,actionName, gameId);
*/
<span class="nc" id="L164">		String cancelChannel = &quot;LMS_Terminal&quot;;</span>
<span class="nc" id="L165">		CancelTicketBean cancelTicketBean = new CancelTicketBean();</span>
		/*Map&lt;Integer, Map&lt;Integer, String&gt;&gt; drawIdTableMap = (Map&lt;Integer, Map&lt;Integer, String&gt;&gt;) sc
				.getContext(&quot;/DrawGameWeb&quot;).getAttribute(&quot;drawIdTableMap&quot;);*/
<span class="nc" id="L168">		Map&lt;Integer, Map&lt;Integer, String&gt;&gt; drawIdTableMap = (Map&lt;Integer, Map&lt;Integer, String&gt;&gt;) sc.getAttribute(&quot;drawIdTableMap&quot;);</span>
		// logger.debug(&quot; ticketNo = &quot; + ticketNo + &quot; drawIdTableMap in
		// cancel ticket &quot; + drawIdTableMap);
<span class="nc" id="L171">		cancelTicketBean.setDrawIdTableMap(drawIdTableMap);</span>
<span class="nc" id="L172">		String finalCancelData = null;</span>
<span class="nc" id="L173">		DrawGameRPOSHelper helper = new DrawGameRPOSHelper();</span>
		
<span class="nc" id="L175">		cancelTicketBean.setCancelDuaraion(&quot;true&quot;.equalsIgnoreCase((String)sc.getAttribute(&quot;IS_CANCEL_DURATION&quot;)));</span>
<span class="nc" id="L176">		cancelTicketBean.setCancelDuration(Integer.parseInt((String)sc.getAttribute(&quot;CANCEL_DURATION&quot;)));</span>
<span class="nc" id="L177">		cancelTicketBean.setCancelType((String) sc.getAttribute(&quot;CANCEL_TYPE&quot;));</span>
<span class="nc bnc" id="L178" title="All 4 branches missed.">		if (&quot;LAST_SOLD_TICKET&quot;.equalsIgnoreCase((String) sc</span>
				.getAttribute(&quot;CANCEL_TYPE&quot;)) || isAutoCancel()) {
<span class="nc" id="L180">			ticketNo = helper.getLastSoldTicketNO(userInfoBean,&quot;TERMINAL&quot;);</span>
			
<span class="nc bnc" id="L182" title="All 2 branches missed.">			if (ticketNo != null) {</span>
<span class="nc" id="L183">				ticketNo = ticketNo + Util.getRpcAppenderForTickets(ticketNo.length());</span>
			}else{
<span class="nc" id="L185">				finalCancelData = &quot;ErrorMsg:&quot;+EmbeddedErrors.CANCEL_INVALID+&quot;ErrorCode:&quot; + EmbeddedErrors.CANCEL_INVALID_ERROR_CODE+&quot;|&quot;;</span>
<span class="nc" id="L186">				logger.debug(&quot;FINAL CANCEL DATA:&quot; + finalCancelData);</span>
<span class="nc" id="L187">				response.getOutputStream().write(finalCancelData.getBytes());</span>
<span class="nc" id="L188">				return;</span>
			}
			
			
			/*if(&quot;LAST_SOLD_TICKET&quot;.equalsIgnoreCase((String) sc
					.getAttribute(&quot;CANCEL_TYPE&quot;))){
				cancelTicketBean.setCancelType(&quot;LAST_SOLD_TICKET&quot;);		
			}*/
			
			
<span class="nc bnc" id="L198" title="All 2 branches missed.">			if (isAutoCancel()){</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">				if(ticketNo.equals(String.valueOf(LSTktNo))){</span>
<span class="nc" id="L200">					finalCancelData = &quot;Last request could not be processed. Try again|&quot;;</span>
<span class="nc" id="L201">					logger.debug(&quot;FINAL CANCEL DATA:&quot; + finalCancelData);</span>
<span class="nc" id="L202">					response.getOutputStream().write(finalCancelData.getBytes());</span>
<span class="nc" id="L203">					return;</span>
				}
				//cancelTicketBean.setCancelType(&quot;TICKET_NO&quot;);
			}
<span class="nc bnc" id="L207" title="All 2 branches missed.">		}else if(&quot;TICKET_NO&quot;.equalsIgnoreCase((String) sc</span>
				.getAttribute(&quot;CANCEL_TYPE&quot;))){
			// Get The BarCode From Ticket Number If Required  
<span class="nc bnc" id="L210" title="All 2 branches missed.">			if(ticketNo.length() == com.skilrock.lms.common.ConfigurationVariables.barcodeCount){</span>
<span class="nc" id="L211">				barCodeCount = Integer</span>
						.parseInt(Util.getBarCodeCountFromTicketNumber(ticketNo));
<span class="nc" id="L213">				ticketNo=Util.getTicketNumber(ticketNo, inpType);</span>
			}
		}	
<span class="nc bnc" id="L216" title="All 4 branches missed.">		if (ticketNo == null &amp;&amp; LSTktNo == 0) {</span>
<span class="nc" id="L217">			finalCancelData = &quot;ErrorMsg:&quot; + EmbeddedErrors.CANCEL_INVALID+&quot;ErrorCode:&quot; + EmbeddedErrors.CANCEL_INVALID_ERROR_CODE+&quot;|&quot;;</span>
<span class="nc" id="L218">			logger.debug(&quot;FINAL CANCEL DATA:&quot; + finalCancelData);</span>
<span class="nc" id="L219">			response.getOutputStream().write(finalCancelData.getBytes());</span>
<span class="nc" id="L220">			return;</span>
		}
		/*else if((helper.getLastSoldTicketNO(userInfoBean)).equals(LSTktNo) &amp;&amp; isAutoCancel()){
			finalCancelData = &quot;ErrorMsg:&quot; + EmbeddedErrors.CANCEL_INVALID;
			logger.debug(&quot;FINAL CANCEL DATA:&quot; + finalCancelData);
			response.getOutputStream().write(finalCancelData.getBytes());
		}*/
		else {
			/*if (isAutoCancel()){
				ticketNo = helper.getLastSoldTicketNO(userInfoBean);
				if (ticketNo != null) {
					ticketNo = ticketNo + &quot;00&quot;;
				}
				cancelTicketBean.setCancelType(&quot;TICKET_NO&quot;);
			}*/
			
<span class="nc" id="L236">			cancelTicketBean.setBarCodeCount(barCodeCount);</span>
<span class="nc" id="L237">			cancelTicketBean.setTicketNo(ticketNo);</span>
<span class="nc" id="L238">			cancelTicketBean.setPartyId(userInfoBean.getUserOrgId());</span>
<span class="nc" id="L239">			cancelTicketBean.setPartyType(userInfoBean.getUserType());</span>
<span class="nc" id="L240">			cancelTicketBean.setUserId(userInfoBean.getUserId());</span>
<span class="nc" id="L241">			cancelTicketBean.setCancelChannel(cancelChannel);</span>
<span class="nc" id="L242">			cancelTicketBean.setRefMerchantId(refMerchantId);</span>
<span class="nc" id="L243">			cancelTicketBean.setAutoCancel(isAutoCancel()); //  for manual cancel change to auto cancel</span>
			//cancelTicketBean.setAutoCancel(true);
<span class="nc" id="L245">			cancelTicketBean = helper.cancelTicket(cancelTicketBean,</span>
					userInfoBean, isAutoCancel(),cancelType);
			// logger.debug(&quot;@@@@@@@@@@@@@@@@@@@@@@&quot;+cancelTicketBean.isPerformed());
			// -----Calculation of balance for cancel ticket----------
<span class="nc" id="L249">			AjaxRequestHelper ajxHelper = new AjaxRequestHelper();</span>
<span class="nc" id="L250">			ajxHelper.getAvlblCreditAmt(userInfoBean);</span>
<span class="nc" id="L251">			double bal = userInfoBean.getAvailableCreditLimit()</span>
			- userInfoBean.getClaimableBal();
			/*String balance = bal + &quot;00&quot;;
			balance = balance.substring(0, balance.indexOf(&quot;.&quot;) + 3);*/
<span class="nc" id="L255">			NumberFormat nFormat = NumberFormat.getInstance();</span>
<span class="nc" id="L256">			nFormat.setMinimumFractionDigits(2);</span>
<span class="nc" id="L257">			String balance = nFormat.format(bal).replaceAll(&quot;,&quot;, &quot;&quot;);</span>
			// logger.debug(&quot;------reprint Count&quot; +
			// cancelTicketBean.getReprintCount());
<span class="nc bnc" id="L260" title="All 2 branches missed.">			if (cancelTicketBean.isValid()) {</span>
<span class="nc" id="L261">				String advtMsg = &quot;&quot;;</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">				if (cancelTicketBean.getRefundAmount() &gt; 0) {</span>
<span class="nc" id="L263">					StringBuilder topMsgsStr = new StringBuilder(&quot;&quot;);</span>
<span class="nc" id="L264">					StringBuilder bottomMsgsStr = new StringBuilder(&quot;&quot;);</span>
<span class="nc" id="L265">					UtilApplet.getAdvMsgs(cancelTicketBean.getAdvMsg(),</span>
							topMsgsStr, bottomMsgsStr, 10);
<span class="nc bnc" id="L267" title="All 2 branches missed.">					if (topMsgsStr.length() != 0) {</span>
<span class="nc" id="L268">						advtMsg = &quot;topAdvMsg:&quot; + topMsgsStr + &quot;|&quot;;</span>
					}
<span class="nc bnc" id="L270" title="All 2 branches missed.">					if (bottomMsgsStr.length() != 0) {</span>
<span class="nc" id="L271">						advtMsg = advtMsg + &quot;bottomAdvMsg:&quot; + bottomMsgsStr</span>
						+ &quot;|&quot;;
					}
				}
<span class="nc" id="L275">				finalCancelData = &quot;RfdA:&quot;</span>
					+ cancelTicketBean.getRefundAmount()
					+ &quot;|TktN:&quot;
					+ Util.getTktWithoutRpcNBarCodeCount(cancelTicketBean.getTicketNo(), cancelTicketBean.getTicketNo().length())
							+ cancelTicketBean.getReprintCount() + &quot;|Balance:&quot;
							+ balance + &quot;|&quot; + advtMsg;
<span class="nc bnc" id="L281" title="All 2 branches missed.">			} else if (cancelTicketBean.isError()) { // RG Limit fail</span>
<span class="nc" id="L282">				finalCancelData = &quot;ErrorMsg:&quot; + cancelTicketBean.getErrMsg()</span>
				+ &quot;|&quot;;
<span class="nc bnc" id="L284" title="All 2 branches missed.">			} else if(isAutoCancel()){</span>
<span class="nc" id="L285">				finalCancelData = &quot;Last request could not be processed. Try again|&quot;;</span>
			}
			else {
<span class="nc" id="L288">				finalCancelData = &quot;ErrorMsg:&quot; + EmbeddedErrors.CANCEL_INVALID+&quot;ErrorCode:&quot; + EmbeddedErrors.CANCEL_INVALID_ERROR_CODE+&quot;|&quot;;</span>
			}
<span class="nc" id="L290">			logger.debug(&quot;FINAL CANCEL DATA:&quot; + finalCancelData);</span>
			
<span class="nc" id="L292">			TransactionManager.setResponseData(&quot;true&quot;);</span>
			
<span class="nc" id="L294">			response.setCharacterEncoding(&quot;UTF-8&quot;);</span>
<span class="nc" id="L295">			response.setContentType(&quot;text/html&quot;);</span>
<span class="nc" id="L296">			response.getOutputStream().write(finalCancelData.getBytes());</span>
		}
<span class="nc" id="L298">	}</span>
	public void cancelTicket() throws Exception {
<span class="nc" id="L300">		ServletContext sc = ServletActionContext.getServletContext();</span>
<span class="nc" id="L301">		String isDraw = (String) sc.getAttribute(&quot;IS_DRAW&quot;);</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">		if (isDraw.equalsIgnoreCase(&quot;NO&quot;)) {</span>
<span class="nc" id="L303">			response.getOutputStream().write(</span>
					(&quot;ErrorMsg:&quot; + EmbeddedErrors.DRAW_GAME_NOT_AVAILABLE+&quot;ErrorCode:&quot; + EmbeddedErrors.DRAW_GAME_NOT_AVAILABLE_ERROR_CODE+&quot;|&quot;)
					.getBytes());
<span class="nc" id="L306">			return;</span>
		}
<span class="nc" id="L308">		Map currentUserSessionMap = (Map) sc.getAttribute(&quot;LOGGED_IN_USERS&quot;);</span>
		// logger.debug(&quot;LOGGED_IN_USERS map is: &quot; + currentUserSessionMap);
		// logger.debug(&quot;user name is: &quot; + userName);
<span class="nc" id="L311">		HttpSession session = (HttpSession) currentUserSessionMap.get(userName);</span>
<span class="nc" id="L312">		UserInfoBean userInfoBean = (UserInfoBean) session</span>
		.getAttribute(&quot;USER_INFO&quot;);
<span class="nc" id="L314">		String refMerchantId = (String) sc.getAttribute(&quot;REF_MERCHANT_ID&quot;);</span>
<span class="nc" id="L315">		String cancelChannel = &quot;LMS_Terminal&quot;;</span>
<span class="nc" id="L316">		CancelTicketBean cancelTicketBean = new CancelTicketBean();</span>
		/*Map&lt;Integer, Map&lt;Integer, String&gt;&gt; drawIdTableMap = (Map&lt;Integer, Map&lt;Integer, String&gt;&gt;) sc
				.getContext(&quot;/DrawGameWeb&quot;).getAttribute(&quot;drawIdTableMap&quot;);*/
<span class="nc" id="L319">		Map&lt;Integer, Map&lt;Integer, String&gt;&gt; drawIdTableMap = (Map&lt;Integer, Map&lt;Integer, String&gt;&gt;) sc.getAttribute(&quot;drawIdTableMap&quot;);</span>
		// logger.debug(&quot; ticketNo = &quot; + ticketNo + &quot; drawIdTableMap in
		// cancel ticket &quot; + drawIdTableMap);
<span class="nc" id="L322">		cancelTicketBean.setDrawIdTableMap(drawIdTableMap);</span>
<span class="nc" id="L323">		String finalCancelData = null;</span>
<span class="nc" id="L324">		DrawGameRPOSHelper helper = new DrawGameRPOSHelper();</span>
<span class="nc" id="L325">		cancelTicketBean.setCancelDuaraion(&quot;true&quot;.equalsIgnoreCase((String)sc.getAttribute(&quot;IS_CANCEL_DURATION&quot;)));</span>
<span class="nc" id="L326">		cancelTicketBean.setCancelDuration(Integer.parseInt((String)sc.getAttribute(&quot;CANCEL_DURATION&quot;)));</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">		if (&quot;LAST_SOLD_TICKET&quot;.equalsIgnoreCase((String) sc</span>
				.getAttribute(&quot;CANCEL_TYPE&quot;))) {
<span class="nc" id="L329">			ticketNo = helper.getLastSoldTicketNO(userInfoBean,&quot;TERMINAL&quot;);</span>
<span class="nc bnc" id="L330" title="All 2 branches missed.">			if (ticketNo != null) {</span>
<span class="nc" id="L331">				ticketNo = ticketNo + &quot;00&quot;;</span>
			}
<span class="nc" id="L333">			cancelTicketBean.setCancelType(&quot;LAST_SOLD_TICKET&quot;);</span>
		}
<span class="nc bnc" id="L335" title="All 2 branches missed.">		if (ticketNo == null) {</span>
<span class="nc" id="L336">			finalCancelData = &quot;ErrorMsg:&quot; + EmbeddedErrors.CANCEL_INVALID+&quot;ErrorCode:&quot; + EmbeddedErrors.CANCEL_INVALID_ERROR_CODE+&quot;|&quot;;</span>
<span class="nc" id="L337">			logger.debug(&quot;FINAL CANCEL DATA:&quot; + finalCancelData);</span>
<span class="nc" id="L338">			response.getOutputStream().write(finalCancelData.getBytes());</span>
		} else {
<span class="nc" id="L340">			cancelTicketBean.setTicketNo(ticketNo);</span>
<span class="nc" id="L341">			cancelTicketBean.setPartyId(userInfoBean.getUserOrgId());</span>
<span class="nc" id="L342">			cancelTicketBean.setPartyType(userInfoBean.getUserType());</span>
<span class="nc" id="L343">			cancelTicketBean.setUserId(userInfoBean.getUserId());</span>
<span class="nc" id="L344">			cancelTicketBean.setCancelChannel(cancelChannel);</span>
<span class="nc" id="L345">			cancelTicketBean.setRefMerchantId(refMerchantId);</span>
<span class="nc" id="L346">			cancelTicketBean = helper.cancelTicket(cancelTicketBean,</span>
					userInfoBean, isAutoCancel(),cancelType);
			// logger.debug(&quot;@@@@@@@@@@@@@@@@@@@@@@&quot;+cancelTicketBean.isPerformed());
			// -----Calculation of balance for cancel ticket----------
<span class="nc" id="L350">			AjaxRequestHelper ajxHelper = new AjaxRequestHelper();</span>
<span class="nc" id="L351">			ajxHelper.getAvlblCreditAmt(userInfoBean);</span>
<span class="nc" id="L352">			double bal = userInfoBean.getAvailableCreditLimit()</span>
			- userInfoBean.getClaimableBal();
			/*String balance = bal + &quot;00&quot;;
			balance = balance.substring(0, balance.indexOf(&quot;.&quot;) + 3);*/
<span class="nc" id="L356">			NumberFormat nFormat = NumberFormat.getInstance();</span>
<span class="nc" id="L357">			nFormat.setMinimumFractionDigits(2);</span>
<span class="nc" id="L358">			String balance = nFormat.format(bal).replaceAll(&quot;,&quot;, &quot;&quot;);</span>
			// logger.debug(&quot;------reprint Count&quot; +
			// cancelTicketBean.getReprintCount());
<span class="nc bnc" id="L361" title="All 2 branches missed.">			if (cancelTicketBean.isValid()) {</span>
<span class="nc" id="L362">				String advtMsg = &quot;&quot;;</span>
<span class="nc bnc" id="L363" title="All 2 branches missed.">				if (cancelTicketBean.getRefundAmount() &gt; 0) {</span>
<span class="nc" id="L364">					StringBuilder topMsgsStr = new StringBuilder(&quot;&quot;);</span>
<span class="nc" id="L365">					StringBuilder bottomMsgsStr = new StringBuilder(&quot;&quot;);</span>
<span class="nc" id="L366">					UtilApplet.getAdvMsgs(cancelTicketBean.getAdvMsg(),</span>
							topMsgsStr, bottomMsgsStr, 10);
<span class="nc bnc" id="L368" title="All 2 branches missed.">					if (topMsgsStr.length() != 0) {</span>
<span class="nc" id="L369">						advtMsg = &quot;topAdvMsg:&quot; + topMsgsStr + &quot;|&quot;;</span>
					}
<span class="nc bnc" id="L371" title="All 2 branches missed.">					if (bottomMsgsStr.length() != 0) {</span>
<span class="nc" id="L372">						advtMsg = advtMsg + &quot;bottomAdvMsg:&quot; + bottomMsgsStr</span>
						+ &quot;|&quot;;
					}
				}
<span class="nc" id="L376">				finalCancelData = &quot;RfdA:&quot;</span>
					+ cancelTicketBean.getRefundAmount()
					+ &quot;|TktN:&quot;
					+ cancelTicketBean.getTicketNo().substring(0,
							cancelTicketBean.getTicketNo().length() - 2)
							+ cancelTicketBean.getReprintCount() + &quot;|Balance:&quot;
							+ balance + &quot;|&quot; + advtMsg;
<span class="nc bnc" id="L383" title="All 2 branches missed.">			} else if (cancelTicketBean.isError()) { // RG Limit fail</span>
<span class="nc" id="L384">				finalCancelData = &quot;ErrorMsg:&quot; + cancelTicketBean.getErrMsg()</span>
				+ &quot;|&quot;;
			} else {
<span class="nc" id="L387">				finalCancelData = &quot;ErrorMsg:&quot; + EmbeddedErrors.CANCEL_INVALID+&quot;ErrorCode:&quot; + EmbeddedErrors.CANCEL_INVALID_ERROR_CODE+&quot;|&quot;;</span>
			}
<span class="nc" id="L389">			logger.debug(&quot;FINAL CANCEL DATA:&quot; + finalCancelData);</span>
<span class="nc" id="L390">			response.setCharacterEncoding(&quot;UTF-8&quot;);</span>
<span class="nc" id="L391">			response.setContentType(&quot;text/html&quot;);</span>
<span class="nc" id="L392">			response.getOutputStream().write(finalCancelData.getBytes());</span>
		}
<span class="nc" id="L394">	}</span>
	public void cancelTicketOld() throws Exception {
<span class="nc" id="L396">		logger.debug(&quot;Before--&quot; + new Date());</span>
<span class="nc" id="L397">		ServletContext sc = ServletActionContext.getServletContext();</span>
<span class="nc" id="L398">		String isDraw = (String) sc.getAttribute(&quot;IS_DRAW&quot;);</span>
<span class="nc bnc" id="L399" title="All 2 branches missed.">		if (isDraw.equalsIgnoreCase(&quot;NO&quot;)) {</span>
<span class="nc" id="L400">			response.getOutputStream().write(</span>
					&quot;Draw Game Not Avaialbe&quot;.getBytes());
<span class="nc" id="L402">			return;</span>
		}
<span class="nc" id="L404">		Map currentUserSessionMap = (Map) sc.getAttribute(&quot;LOGGED_IN_USERS&quot;);</span>
		// logger.debug(&quot; LOGGED_IN_USERS maps is &quot; +
		// currentUserSessionMap);
<span class="nc" id="L407">		logger.debug(&quot; user name is &quot; + userName);</span>
<span class="nc" id="L408">		HttpSession session = (HttpSession) currentUserSessionMap.get(userName);</span>
<span class="nc" id="L409">		UserInfoBean userInfoBean = (UserInfoBean) session</span>
		.getAttribute(&quot;USER_INFO&quot;);
<span class="nc" id="L411">		CancelTicketBean cancelTicketBean = new CancelTicketBean();</span>
		/*Map&lt;Integer, Map&lt;Integer, String&gt;&gt; drawIdTableMap = (Map&lt;Integer, Map&lt;Integer, String&gt;&gt;) sc
				.getContext(&quot;/DrawGameWeb&quot;).getAttribute(&quot;drawIdTableMap&quot;);*/
<span class="nc" id="L414">		Map&lt;Integer, Map&lt;Integer, String&gt;&gt; drawIdTableMap = (Map&lt;Integer, Map&lt;Integer, String&gt;&gt;) sc.getAttribute(&quot;drawIdTableMap&quot;);</span>
<span class="nc" id="L415">		logger.debug(&quot; ticketNo = &quot; + ticketNo</span>
				+ &quot; drawIdTableMap in cancel ticket &quot; + drawIdTableMap);
<span class="nc" id="L417">		cancelTicketBean.setDrawIdTableMap(drawIdTableMap);</span>
<span class="nc" id="L418">		cancelTicketBean.setTicketNo(ticketNo);</span>
<span class="nc" id="L419">		DrawGameRPOSHelper helper = new DrawGameRPOSHelper();</span>
<span class="nc" id="L420">		cancelTicketBean = helper.cancelTicket(cancelTicketBean, userInfoBean,</span>
				isAutoCancel(),cancelType);
<span class="nc" id="L422">		logger.debug(&quot;is valid---------&quot; + cancelTicketBean.isValid());</span>
<span class="nc bnc" id="L423" title="All 2 branches missed.">		if (cancelTicketBean.isValid()) {</span>
<span class="nc" id="L424">			response.getOutputStream().write(&quot;Ticket cancelled&quot;.getBytes());</span>
		} else {
<span class="nc" id="L426">			response.getOutputStream()</span>
			.write(&quot;Ticket Number inValid&quot;.getBytes());
		}
<span class="nc" id="L429">		logger.debug(&quot;After--&quot; + new Date());</span>
<span class="nc" id="L430">	}</span>
	public void fetchDrawGameData() throws Exception {
<span class="nc" id="L432">		ServletContext sc = ServletActionContext.getServletContext();</span>
<span class="nc" id="L433">		logger.debug(&quot;Before--&quot; + new Date());</span>
<span class="nc" id="L434">		String refMerchantId = (String) sc.getAttribute(&quot;REF_MERCHANT_ID&quot;);</span>
<span class="nc" id="L435">		int autoCancelHoldDays=Integer.parseInt((String) sc.getAttribute(&quot;AUTO_CANCEL_CLOSER_DAYS&quot;));</span>
<span class="nc" id="L436">		long lastPrintedTicket=0;</span>
<span class="nc" id="L437">		int gameId = 0;</span>
<span class="nc bnc" id="L438" title="All 2 branches missed.">		if(LSTktNo !=0){</span>
<span class="nc" id="L439">			lastPrintedTicket = LSTktNo/Util.getDivValueForLastSoldTkt(String.valueOf(LSTktNo).length());</span>
<span class="nc" id="L440">			gameId = Util.getGameIdFromGameNumber(Util.getGamenoFromTktnumber(String.valueOf(LSTktNo)));</span>
		}
<span class="nc" id="L442">		Map currentUserSessionMap = (Map) sc.getAttribute(&quot;LOGGED_IN_USERS&quot;);</span>
<span class="nc bnc" id="L443" title="All 2 branches missed.">		if (currentUserSessionMap == null) {</span>
<span class="nc" id="L444">			response.getOutputStream().write((&quot;ErrorMsg:&quot; + EmbeddedErrors.SESSION_EXPIRED + &quot;ErrorCode:01|&quot;).getBytes());</span>
<span class="nc" id="L445">			return;</span>
		}
<span class="nc" id="L447">		HttpSession session = (HttpSession) currentUserSessionMap.get(userName);</span>
<span class="nc bnc" id="L448" title="All 2 branches missed.">		if (!CommonFunctionsHelper.isSessionValid(session)) {</span>
<span class="nc" id="L449">			response.getOutputStream().write((&quot;ErrorMsg:&quot; + EmbeddedErrors.SESSION_EXPIRED + &quot;ErrorCode:01|&quot;).getBytes());</span>
<span class="nc" id="L450">			return;</span>
		}
<span class="nc" id="L452">		UserInfoBean userBean = (UserInfoBean) session.getAttribute(&quot;USER_INFO&quot;);</span>
<span class="nc" id="L453">		String actionName=ActionContext.getContext().getName();</span>
<span class="nc" id="L454">		DrawGameRPOSHelper helper = new DrawGameRPOSHelper();</span>
<span class="nc" id="L455">		helper.checkLastPrintedTicketStatusAndUpdate(userBean,lastPrintedTicket,&quot;TERMINAL&quot;,refMerchantId,autoCancelHoldDays,actionName, gameId);</span>
<span class="nc" id="L456">		setDrawGameData(helper.getDrawGameData());</span>
<span class="nc" id="L457">		sc.setAttribute(&quot;GAME_DATA&quot;, drawGameData);</span>
<span class="nc" id="L458">		logger.debug(&quot;After--&quot; + new Date() + getDrawGameData());</span>
<span class="nc" id="L459">		Set keySet = drawGameData.keySet();</span>
<span class="nc" id="L460">		Iterator iter = keySet.iterator();</span>
		// Object gameName = gameName;
<span class="nc" id="L462">		DrawWinningReportBean drawWinningReportBean = null;</span>
<span class="nc" id="L463">		List&lt;String&gt; drawResultList = null;</span>
<span class="nc" id="L464">		String[] drawResult = null;</span>
<span class="nc" id="L465">		int drawResultCount = 0;</span>
<span class="nc" id="L466">		StringBuilder sBuilder = new StringBuilder(&quot;&quot;);</span>
		// code to be changed later for multiple games
		/*
		 * while (iter.hasNext()) { gameName = iter.next(); list = (List)
		 * drawGameData.get(gameName);
		 * 
		 * drawResultList = (List&lt;String&gt;) list.get(1);
		 * 
		 * for (int i = 0; i &lt; drawResultList.size(); i++) { drawResult =
		 * drawResultList.get(i).split(&quot;=&quot;); date = new
		 * Date(Long.parseLong(drawResult[0])); sBuilder.append(&quot;DrawDate:&quot; +
		 * date.getDay() + &quot;-&quot; + date.getMonth() + &quot;-&quot; + date.getYear() +
		 * &quot;,DrawTime:&quot; + date.getHours() + &quot;:&quot; + date.getMinutes() + &quot;:&quot; +
		 * date.getSeconds() + &quot;,Sign:&quot; + drawResult[1]+&quot;|&quot;); } }
		 */
		// gameName = iter.next();
		// logger.debug(&quot; -----------------drawGameData -- &quot; +
		// drawGameData);
		// logger.debug(&quot;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~&quot;+Util.getGameNumber(gameName.toLowerCase()));
<span class="nc" id="L485">		int gameIdRep=Util.getGameId(gameName);</span>
<span class="nc" id="L486">		drawWinningReportBean = (DrawWinningReportBean) drawGameData.get(Util.getGameMap().get(gameIdRep)</span>
				.getGameId());
		// logger.debug(&quot; result list is &quot;+list);
<span class="nc bnc" id="L489" title="All 2 branches missed.">		if (drawWinningReportBean == null) {</span>
<span class="nc" id="L490">			logger.debug(&quot; game name is &quot; + gameName + &quot; not found&quot;);</span>
<span class="nc" id="L491">			response.getOutputStream().write(</span>
					(&quot;ErrorMsg:&quot; + EmbeddedErrors.RESULT_GAME_NOT_AVAILABLE+&quot;ErrorCode:&quot; + EmbeddedErrors.RESULT_GAME_NOT_AVAILABLE_ERROR_CODE+&quot;|&quot;)
					.getBytes());
<span class="nc" id="L494">			return;</span>
		}
<span class="nc" id="L496">		drawResultList = drawWinningReportBean.getWinningDataList();</span>
<span class="nc" id="L497">		List&lt;Integer&gt; indexList=new ArrayList&lt;Integer&gt;();</span>
<span class="nc" id="L498">		Iterator&lt;String&gt; drawResultListIterator=drawResultList.iterator();</span>
<span class="nc bnc" id="L499" title="All 2 branches missed.">		while (drawResultListIterator.hasNext()) {</span>
<span class="nc" id="L500">			String string = (String) drawResultListIterator.next();</span>
<span class="nc bnc" id="L501" title="All 2 branches missed.">			if(new Timestamp(Long.parseLong(string.split(&quot;=&quot;)[0])).toString().substring(0,10).equals(curDate))</span>
<span class="nc" id="L502">			indexList.add(drawResultList.indexOf(string));</span>
			
<span class="nc" id="L504">		}</span>
		
<span class="nc bnc" id="L506" title="All 2 branches missed.">		if (drawResultList != null) {</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">			drawResultCount = drawResultList.size() &gt; 5 ? 5 : drawResultList</span>
					.size();
		}
		// drawResultCount =
		/*
		 * if(drawResultList == null){ logger.debug(&quot; game name is &quot; +
		 * gameName + &quot; not found&quot;); response.getOutputStream().write(
		 * (&quot;ErrorMsg:&quot; + EmbeddedErrors.RESULT_GAME_NOT_AVAILABLE)
		 * .getBytes()); return; }
		 */
<span class="nc bnc" id="L517" title="All 4 branches missed.">		if (drawResultList != null &amp;&amp; drawResultCount == 0) {</span>
<span class="nc" id="L518">			logger.debug(&quot;No Draw Available&quot;);</span>
<span class="nc" id="L519">			response.getOutputStream().write(</span>
					(&quot;ErrorMsg:&quot; + EmbeddedErrors.RESULT_DRAW_NOT_AVAILABLE+&quot;ErrorCode:&quot; + EmbeddedErrors.RESULT_DRAW_NOT_AVAILABLE_ERROR_CODE+&quot;|&quot;)
					.getBytes());
<span class="nc" id="L522">			return;</span>
		}
<span class="nc" id="L524">		List&lt;DrawDetailsBean&gt; drawDetailsList = drawWinningReportBean.getDrawDetailsList();</span>
<span class="nc bnc" id="L525" title="All 2 branches missed.">		for (int i = 0; i &lt; drawResultCount; i++) {</span>
			
<span class="nc bnc" id="L527" title="All 2 branches missed.">			if(!&quot;-1&quot;.equals(curDate)){</span>
<span class="nc bnc" id="L528" title="All 2 branches missed.">				if(!indexList.contains(i)){</span>
<span class="nc" id="L529">					continue;</span>
				}
			}
			
<span class="nc" id="L533">			drawResult = drawResultList.get(i).split(&quot;=&quot;);</span>
<span class="nc" id="L534">			Calendar cal = Calendar.getInstance();</span>
<span class="nc" id="L535">			cal.setTimeInMillis(Long.parseLong(drawResult[0]));</span>
			// sBuilder.append(&quot;DrawDate:&quot; + date.getDay() + &quot;-&quot;
			// +( date.getMonth()+1 )+ &quot;-&quot; + date.getYear() + &quot;,DrawTime:&quot;
			// + date.getHours() + &quot;:&quot; + date.getMinutes() + &quot;:&quot;
			// + date.getSeconds() + &quot;,Sign:&quot; + drawResult[1]+&quot;|&quot;);
<span class="nc" id="L540">			DrawDetailsBean drawBean = drawDetailsList.get(i);</span>
<span class="nc" id="L541">			String drawName = drawBean.getDrawName();</span>
<span class="nc" id="L542">			String machineResult = drawBean.getMachineResult();</span>
<span class="nc bnc" id="L543" title="All 2 branches missed.">			if(&quot;null&quot;.equalsIgnoreCase(drawResult[1])){</span>
<span class="nc" id="L544">				drawResult[1] = null;</span>
			}
<span class="nc bnc" id="L546" title="All 4 branches missed.">			if(drawResult[1] == null &amp;&amp; !&quot;YES&quot;.equalsIgnoreCase(isNewURL)){</span>
<span class="nc" id="L547">				continue;</span>
			}
<span class="nc bnc" id="L549" title="All 4 branches missed.">			if(drawResult[1] != null || machineResult != null){</span>
<span class="nc" id="L550">				sBuilder.append(&quot;DrawTime:&quot;);</span>
<span class="nc bnc" id="L551" title="All 10 branches missed.">				sBuilder.append(cal.get(Calendar.YEAR)</span>
						+ &quot;-&quot;
						+ (cal.get(Calendar.MONTH) + 1 &gt; 9 ? cal
								.get(Calendar.MONTH) + 1 : &quot;0&quot;
									+ (cal.get(Calendar.MONTH) + 1))
									+ &quot;-&quot;
									+ (cal.get(Calendar.DAY_OF_MONTH) &gt; 9 ? cal
											.get(Calendar.DAY_OF_MONTH) : &quot;0&quot;
												+ cal.get(Calendar.DAY_OF_MONTH))
												+ &quot; &quot;
												+ (cal.get(Calendar.HOUR_OF_DAY) &gt; 9 ? cal
														.get(Calendar.HOUR_OF_DAY) : &quot;0&quot;
															+ cal.get(Calendar.HOUR_OF_DAY))
															+ &quot;:&quot;
															+ (cal.get(Calendar.MINUTE) &gt; 9 ? cal.get(Calendar.MINUTE)
																	: &quot;0&quot; + cal.get(Calendar.MINUTE))
																	+ &quot;:&quot;
																	+ (cal.get(Calendar.SECOND) &gt; 9 ? cal.get(Calendar.SECOND)
																			: &quot;0&quot; + cal.get(Calendar.SECOND)));
<span class="nc bnc" id="L570" title="All 2 branches missed.">				if(&quot;YES&quot;.equalsIgnoreCase(isNewURL)){</span>
<span class="nc bnc" id="L571" title="All 6 branches missed.">					if(drawName != null &amp;&amp; !&quot;null&quot;.equalsIgnoreCase(drawName.trim()) &amp;&amp; !&quot;&quot;.equalsIgnoreCase(drawName.trim())){</span>
<span class="nc" id="L572">						sBuilder.append(&quot;*&quot; + drawName);</span>
					}
				}
<span class="nc" id="L575">				sBuilder.append(&quot;,Sign:&quot;);</span>
<span class="nc bnc" id="L576" title="All 6 branches missed.">				if(drawResult[1] != null &amp;&amp; !&quot;null&quot;.equalsIgnoreCase(drawResult[1].trim()) &amp;&amp; !&quot;&quot;.equalsIgnoreCase(drawResult[1].trim())){</span>
<span class="nc bnc" id="L577" title="All 2 branches missed.">					if(&quot;FortuneTwo&quot;.equalsIgnoreCase(gameName)){</span>
<span class="nc" id="L578">						String[] winResArr = drawResult[1].split(&quot;,&quot;);</span>
<span class="nc" id="L579">						StringBuilder sbResult = new StringBuilder(&quot;&quot;);</span>
<span class="nc bnc" id="L580" title="All 2 branches missed.">						for (int j = 0; j &lt; winResArr.length; j++) {</span>
<span class="nc" id="L581">							winResArr[j] = winResArr[j].substring(0,3).toUpperCase();</span>
<span class="nc" id="L582">							sbResult.append(winResArr[j] + &quot;,&quot;);</span>
						}
<span class="nc bnc" id="L584" title="All 2 branches missed.">						if(sbResult.length() &gt; 0){</span>
<span class="nc" id="L585">							sbResult.deleteCharAt(sbResult.length() - 1);</span>
						}
<span class="nc" id="L587">						drawResult[1] = sbResult.toString();</span>
					}
<span class="nc" id="L589">					sBuilder.append(drawResult[1]);</span>
				}
<span class="nc bnc" id="L591" title="All 2 branches missed.">				if(&quot;YES&quot;.equalsIgnoreCase(isNewURL)){</span>
					
<span class="nc bnc" id="L593" title="All 6 branches missed.">					if(machineResult != null &amp;&amp; !&quot;null&quot;.equalsIgnoreCase(machineResult.trim()) &amp;&amp; !&quot;&quot;.equalsIgnoreCase(machineResult.trim())){</span>
<span class="nc" id="L594">						sBuilder.append(&quot;;&quot;);</span>
<span class="nc" id="L595">						sBuilder.append(&quot;machine:&quot; + machineResult);</span>
					}
				}
<span class="nc" id="L598">				sBuilder.append(&quot;|&quot;);</span>
			}
		}
<span class="nc bnc" id="L601" title="All 2 branches missed.">		if(sBuilder.length()==0){</span>
<span class="nc" id="L602">			logger.debug(&quot;No Result Available&quot;);</span>
<span class="nc" id="L603">			response.getOutputStream().write(</span>
					(&quot;ErrorMsg:&quot; + EmbeddedErrors.RESULT_DRAW_NOT_AVAILABLE+&quot;ErrorCode:&quot; + EmbeddedErrors.RESULT_DRAW_NOT_AVAILABLE_ERROR_CODE+&quot;|&quot;)
					.getBytes());
<span class="nc" id="L606">			return;</span>
		}else{
<span class="nc" id="L608">		logger.debug(&quot; Draw result for fortune is &quot; + sBuilder.toString());</span>
<span class="nc" id="L609">		response.getOutputStream().write(sBuilder.toString().getBytes());</span>
		}
<span class="nc" id="L611">	}</span>
	public void fetchDrawGameUpdatedData() throws Exception {
<span class="nc" id="L613">		ServletContext sc = ServletActionContext.getServletContext();</span>
<span class="nc" id="L614">		PrintWriter out = getResponse().getWriter();</span>
<span class="nc" id="L615">		StringBuilder rData = new StringBuilder(&quot;&quot;);</span>
<span class="nc" id="L616">		logger.debug(&quot;Front End Call**&quot; + sc.getAttribute(&quot;GAME_DATA&quot;));</span>
<span class="nc" id="L617">		logger.debug(sc.getAttribute(&quot;GAME_DATA&quot;));</span>
<span class="nc" id="L618">		logger.debug(sc.getAttribute(&quot;drawIdTableMap&quot;));</span>
<span class="nc" id="L619">		Iterator iter = ((TreeMap) sc.getAttribute(&quot;GAME_DATA&quot;)).entrySet()</span>
		.iterator();
<span class="nc bnc" id="L621" title="All 2 branches missed.">		while (iter.hasNext()) {</span>
<span class="nc" id="L622">			Map.Entry pair = (Map.Entry) iter.next();</span>
<span class="nc" id="L623">			List&lt;List&gt; drawList = (List&lt;List&gt;) pair.getValue();</span>
<span class="nc" id="L624">			String nxtDrwTime = drawList.get(0).toString().replace(&quot;[&quot;, &quot;&quot;)</span>
			.replace(&quot;]&quot;, &quot;&quot;);
<span class="nc" id="L626">			List&lt;String&gt; winList = (List&lt;String&gt;) drawList.get(1);</span>
<span class="nc" id="L627">			Iterator winItr = winList.iterator();</span>
<span class="nc" id="L628">			String winData = &quot;&quot;;</span>
<span class="nc bnc" id="L629" title="All 2 branches missed.">			while (winItr.hasNext()) {</span>
<span class="nc" id="L630">				winData = winData + winItr.next() + &quot; Nxt &quot;;</span>
			}
<span class="nc" id="L632">			rData.append(pair.getKey() + &quot;UPD&quot; + nxtDrwTime + &quot;UPD&quot; + winData</span>
					+ &quot;Game&quot;);
<span class="nc" id="L634">		}</span>
<span class="nc" id="L635">		logger.debug(&quot;--Updated--&quot; + rData);</span>
<span class="nc" id="L636">		out.print(rData);</span>
<span class="nc" id="L637">	}</span>
	public void fetchDrawResultData() throws Exception {
<span class="nc" id="L639">		ServletContext sc = ServletActionContext.getServletContext();</span>
<span class="nc" id="L640">		Map currentUserSessionMap = (Map) sc.getAttribute(&quot;LOGGED_IN_USERS&quot;);</span>
<span class="nc bnc" id="L641" title="All 2 branches missed.">		if (currentUserSessionMap == null) {</span>
			try {
<span class="nc" id="L643">				response</span>
				.getOutputStream()
				.write(
						(&quot;ErrorMsg:&quot; + EmbeddedErrors.SESSION_EXPIRED + &quot;ErrorCode:01|&quot;)
						.getBytes());
<span class="nc" id="L648">				return;</span>
<span class="nc" id="L649">			} catch (IOException e) {</span>
<span class="nc" id="L650">				e.printStackTrace();</span>
			}
		}
		// logger.debug(&quot; LOGGED_IN_USERS maps is &quot; + currentUserSessionMap);
<span class="nc" id="L654">		HttpSession session = (HttpSession) currentUserSessionMap.get(userName);</span>
<span class="nc bnc" id="L655" title="All 2 branches missed.">		if (!CommonFunctionsHelper.isSessionValid(session)) {</span>
<span class="nc" id="L656">			response</span>
			.getOutputStream()
			.write(
					(&quot;ErrorMsg:&quot; + EmbeddedErrors.SESSION_EXPIRED + &quot;ErrorCode:01|&quot;)
					.getBytes());
<span class="nc" id="L661">			return;</span>
		}
<span class="nc" id="L663">		int noOfDays = Integer.parseInt((String) sc</span>
				.getAttribute(&quot;EMBED_REPORT_DAYS&quot;));
<span class="nc" id="L665">		Calendar cal = Calendar.getInstance();</span>
<span class="nc" id="L666">		cal.add(Calendar.DAY_OF_YEAR, -noOfDays);</span>
<span class="nc" id="L667">		StringBuilder winningResult = new StringBuilder(&quot;&quot;);</span>
<span class="nc" id="L668">		String raffleTktType = (String) sc.getAttribute(&quot;raffle_ticket_type&quot;);</span>
<span class="nc bnc" id="L669" title="All 2 branches missed.">		if (!cal.getTime().after(</span>
				(new SimpleDateFormat(&quot;yyyy-MM-dd&quot;)).parse(startDate))) {
<span class="nc" id="L671">			DrawDataBean drawDataBean = new DrawDataBean();</span>
<span class="nc" id="L672">			drawDataBean.setGameNo(gameNo);</span>
<span class="nc" id="L673">			drawDataBean.setFromDate(startDate + &quot; 00:00:00&quot;);</span>
<span class="nc" id="L674">			drawDataBean.setToDate(startDate + &quot; 23:59:59&quot;);</span>
<span class="nc" id="L675">			DrawGameMgmtHelper helper = new DrawGameMgmtHelper();</span>
<span class="nc" id="L676">			List&lt;ReportDrawBean&gt; winningResultList = helper.fetchDrawData(</span>
					drawDataBean, raffleTktType).getRepGameBean()
					.getRepDrawBean();
<span class="nc bnc" id="L679" title="All 2 branches missed.">			for (int i = 0; i &lt; winningResultList.size(); i++) {</span>
<span class="nc" id="L680">				ReportDrawBean bean = winningResultList.get(i);</span>
<span class="nc" id="L681">				winningResult.append(bean.getDrawDateTime());</span>
<span class="nc bnc" id="L682" title="All 2 branches missed.">				if (bean.getWinningResult() == null) {</span>
<span class="nc" id="L683">					winningResult.append(&quot;-N.A.|&quot;);</span>
				} else {
<span class="nc" id="L685">					winningResult.append(&quot;-&quot;</span>
							+ bean.getWinningResult().toUpperCase() + &quot;|&quot;);
				}
			}
		}
<span class="nc bnc" id="L690" title="All 2 branches missed.">		if (winningResult.length() == 0) {</span>
<span class="nc" id="L691">			winningResult.append(&quot;|&quot;);</span>
		}
<span class="nc" id="L693">		logger.debug(&quot;Winning Result:&quot; + winningResult + &quot;|&quot;);</span>
<span class="nc" id="L694">		response.getOutputStream().write(</span>
				(&quot;Winning Result:&quot; + winningResult).getBytes());
<span class="nc" id="L696">	}</span>
	// -- This METHOD Fetches The Updated DRAW DATA 'GameNameDev Wise'
	public void fetchUpdatedDrawGameData() throws Exception {
<span class="nc" id="L699">		ServletContext sc = ServletActionContext.getServletContext();</span>
<span class="nc" id="L700">		Map currentUserSessionMap = (Map) sc.getAttribute(&quot;LOGGED_IN_USERS&quot;);</span>
<span class="nc bnc" id="L701" title="All 2 branches missed.">		if (currentUserSessionMap == null) {</span>
<span class="nc" id="L702">			response.getOutputStream().write((&quot;ErrorMsg:&quot; + EmbeddedErrors.SESSION_EXPIRED + &quot;ErrorCode:01|&quot;).getBytes());</span>
<span class="nc" id="L703">			return;</span>
		}
<span class="nc" id="L705">		HttpSession session = (HttpSession) currentUserSessionMap.get(userName);</span>
<span class="nc bnc" id="L706" title="All 2 branches missed.">		if (!CommonFunctionsHelper.isSessionValid(session)) {</span>
<span class="nc" id="L707">			response.getOutputStream().write((&quot;ErrorMsg:&quot; + EmbeddedErrors.SESSION_EXPIRED + &quot;ErrorCode:01|&quot;).getBytes());</span>
<span class="nc" id="L708">			return;</span>
		}
<span class="nc" id="L710">		UserInfoBean userBean = (UserInfoBean) session.getAttribute(&quot;USER_INFO&quot;);</span>
<span class="nc" id="L711">		String refMerchantId = (String) sc.getAttribute(&quot;REF_MERCHANT_ID&quot;);</span>
<span class="nc" id="L712">		int autoCancelHoldDays=Integer.parseInt((String) sc.getAttribute(&quot;AUTO_CANCEL_CLOSER_DAYS&quot;));</span>
<span class="nc" id="L713">		long lastPrintedTicket=0;</span>
<span class="nc" id="L714">		int gameId = 0;</span>
<span class="nc bnc" id="L715" title="All 2 branches missed.">		if(LSTktNo !=0){</span>
<span class="nc" id="L716">			lastPrintedTicket = LSTktNo/Util.getDivValueForLastSoldTkt(String.valueOf(LSTktNo).length());</span>
<span class="nc" id="L717">			gameId = Util.getGameIdFromGameNumber(Util.getGamenoFromTktnumber(String.valueOf(LSTktNo)));</span>
		}
<span class="nc" id="L719">		String actionName=ActionContext.getContext().getName();</span>
<span class="nc" id="L720">		DrawGameRPOSHelper drawGameRPOSHelper = new DrawGameRPOSHelper();</span>
<span class="nc" id="L721">		drawGameRPOSHelper.checkLastPrintedTicketStatusAndUpdate(userBean,lastPrintedTicket,&quot;TERMINAL&quot;,refMerchantId,autoCancelHoldDays,actionName, gameId);</span>
		/*
		 * Map&lt;String, Map&lt;Long, String&gt;&gt; drawIdDateMap = (TreeMap&lt;String,
		 * Map&lt;Long, String&gt;&gt;) ServletActionContext
		 * .getServletContext().getAttribute(&quot;drawIdDateMap&quot;);
		 */
<span class="nc" id="L727">		Map&lt;Integer, Map&lt;Integer, DrawDetailsBean&gt;&gt; drawDetailsMap = (Map&lt;Integer, Map&lt;Integer, DrawDetailsBean&gt;&gt;) ServletActionContext</span>
		.getServletContext().getAttribute(&quot;drawDetailsMap&quot;);
<span class="nc" id="L729">		logger.debug(&quot;**drawDetailsMap****&quot; + drawDetailsMap + &quot;**&quot;);</span>
<span class="nc" id="L730">		StringBuilder strBuild = new StringBuilder(&quot;&quot;);</span>
<span class="nc" id="L731">		int gameIdTerminal=Util.getGameId(gameName);</span>
		
<span class="nc" id="L733">		Map&lt;Integer, DrawDetailsBean&gt; innerMap = drawDetailsMap.get(gameIdTerminal);</span>
<span class="nc bnc" id="L734" title="All 4 branches missed.">		if (innerMap != null &amp;&amp; innerMap.size() &gt; 0) {</span>
<span class="nc" id="L735">			Iterator&lt;Map.Entry&lt;Integer, DrawDetailsBean&gt;&gt; innerIter = innerMap</span>
			.entrySet().iterator();
<span class="nc" id="L737">			DrawDetailsBean drawBean = null;</span>
<span class="nc" id="L738">			String currentVersion = DrawGameRPOSHelper</span>
			.fetchCurrentVersion(userName);
<span class="nc bnc" id="L740" title="All 2 branches missed.">			while (innerIter.hasNext()) {</span>
<span class="nc" id="L741">				Map.Entry&lt;Integer, DrawDetailsBean&gt; innerEntryMap = innerIter</span>
				.next();
<span class="nc" id="L743">				drawBean = innerEntryMap.getValue();</span>
<span class="nc" id="L744">				strBuild.append(drawBean.getDrawId() + &quot;,&quot;);</span>
				/*
				 * Timestamp drawTime = new Timestamp(innerEntryMap.getKey());
				 * if
				 * (&quot;keno&quot;.equalsIgnoreCase(gameName)||&quot;kenoTwo&quot;.equalsIgnoreCase
				 * (gameName)) { strBuild.append(Utility.fetchDrawName(
				 * Util.getGameNumber(gameName), drawTime) .split(&quot;\\*&quot;)[1] +
				 * &quot;,&quot;); }
				 */
<span class="nc bnc" id="L753" title="All 4 branches missed.">				if (drawBean.getDrawName() != null</span>
						&amp;&amp; !&quot;null&quot;.equalsIgnoreCase(drawBean.getDrawName())) {
<span class="nc bnc" id="L755" title="All 8 branches missed.">					if (currentVersion != null</span>
							&amp;&amp; (Double.parseDouble(currentVersion) &gt; 4.6 || (Double
									.parseDouble(currentVersion) &lt;= 4.6 &amp;&amp; &quot;Keno&quot;
									.equalsIgnoreCase(gameName)))) {
<span class="nc" id="L759">						strBuild.append(drawBean.getDrawName() + &quot;,&quot;);</span>
					}
				}
<span class="nc" id="L762">				strBuild.append(drawBean.getDrawDateTime().toString().split(</span>
				&quot;\\.&quot;)[0]
				       + &quot;,&quot;);
<span class="nc" id="L765">			}</span>
<span class="nc" id="L766">			strBuild.deleteCharAt(strBuild.length() - 1);</span>
		}
<span class="nc" id="L768">		strBuild.append(&quot;|&quot;);</span>
<span class="nc" id="L769">		logger.debug(&quot;Updated Draw Game Data: &quot; + strBuild.toString());</span>
<span class="nc" id="L770">		response.getOutputStream().write(strBuild.toString().getBytes());</span>
<span class="nc" id="L771">	}</span>
	public void fetchWinningResult() throws Exception {
<span class="nc" id="L773">		ServletContext sc = ServletActionContext.getServletContext();</span>
<span class="nc" id="L774">		Map currentUserSessionMap = (Map) sc.getAttribute(&quot;LOGGED_IN_USERS&quot;);</span>
<span class="nc bnc" id="L775" title="All 2 branches missed.">		if (currentUserSessionMap == null) {</span>
			try {
<span class="nc" id="L777">				response</span>
				.getOutputStream()
				.write(
						(&quot;ErrorMsg:&quot; + EmbeddedErrors.SESSION_EXPIRED + &quot;ErrorCode:01|&quot;)
						.getBytes());
<span class="nc" id="L782">				return;</span>
<span class="nc" id="L783">			} catch (IOException e) {</span>
<span class="nc" id="L784">				e.printStackTrace();</span>
			}
		}
		// logger.debug(&quot; LOGGED_IN_USERS maps is &quot; + currentUserSessionMap);
<span class="nc" id="L788">		HttpSession session = (HttpSession) currentUserSessionMap.get(userName);</span>
<span class="nc" id="L789">		UserInfoBean userBean = (UserInfoBean) session.getAttribute(&quot;USER_INFO&quot;);</span>
<span class="nc" id="L790">		String refMerchantId = (String) sc.getAttribute(&quot;REF_MERCHANT_ID&quot;);</span>
<span class="nc" id="L791">		int autoCancelHoldDays=Integer.parseInt((String) sc.getAttribute(&quot;AUTO_CANCEL_CLOSER_DAYS&quot;));</span>
<span class="nc" id="L792">		long lastPrintedTicket=0;</span>
<span class="nc" id="L793">		int gameId = 0;</span>
<span class="nc bnc" id="L794" title="All 2 branches missed.">		if(LSTktNo !=0){</span>
<span class="nc" id="L795">			lastPrintedTicket = LSTktNo/Util.getDivValueForLastSoldTkt(String.valueOf(LSTktNo).length());</span>
<span class="nc" id="L796">			gameId = Util.getGameIdFromGameNumber(Util.getGamenoFromTktnumber(String.valueOf(LSTktNo)));</span>
		}
<span class="nc" id="L798">		String actionName=ActionContext.getContext().getName();</span>
<span class="nc" id="L799">		DrawGameRPOSHelper drawGameRPOSHelper = new DrawGameRPOSHelper();</span>
<span class="nc" id="L800">		drawGameRPOSHelper.checkLastPrintedTicketStatusAndUpdate(userBean,lastPrintedTicket,&quot;TERMINAL&quot;,refMerchantId,autoCancelHoldDays,actionName, gameId);</span>
<span class="nc bnc" id="L801" title="All 2 branches missed.">		if (!CommonFunctionsHelper.isSessionValid(session)) {</span>
<span class="nc" id="L802">			response</span>
			.getOutputStream()
			.write(
					(&quot;ErrorMsg:&quot; + EmbeddedErrors.SESSION_EXPIRED + &quot;ErrorCode:01|&quot;)
					.getBytes());
<span class="nc" id="L807">			return;</span>
		}
		/*
		 * TreeMap&lt;Integer, List&lt;List&gt;&gt; gameData = (TreeMap&lt;Integer,
		 * List&lt;List&gt;&gt;) sc .getAttribute(&quot;GAME_DATA&quot;);
		 */
<span class="nc" id="L813">		TreeMap&lt;Integer, DrawWinningReportBean&gt; gameData = new DrawGameRPOSHelper()</span>
		.getDrawGameData();
<span class="nc" id="L815">		List&lt;String&gt; winningResultList = gameData.get(gameNo).getWinningDataList();</span>
<span class="nc" id="L816">		String winningResult = &quot;Result Awaited&quot;;</span>
<span class="nc bnc" id="L817" title="All 2 branches missed.">		for (int i = 0; i &lt; winningResultList.size(); i++) {</span>
<span class="nc" id="L818">			String[] result = winningResultList.get(i).split(&quot;=&quot;);</span>
<span class="nc" id="L819">			Long time = Long.parseLong(result[0]);</span>
<span class="nc" id="L820">			Timestamp t = new Timestamp(time);</span>
<span class="nc bnc" id="L821" title="All 2 branches missed.">			if (t.toString().split(&quot;\\.&quot;)[0].equalsIgnoreCase(drawTime)) {</span>
<span class="nc" id="L822">				winningResult = result[1];</span>
				/*
				 * if (&quot;RaffleGame&quot;.equalsIgnoreCase(Util.getGameName(gameNo)))
				 * { winningResult = new
				 * RaffleHelper().swapRaffleResult(winningResult); }
				 */
			}
		}
<span class="nc" id="L830">		logger.debug(&quot;Winning Result:&quot; + winningResult + &quot;|&quot;);</span>
<span class="nc" id="L831">		response.getOutputStream().write(</span>
				(&quot;Winning Result:&quot; + winningResult + &quot;|&quot;).getBytes());
<span class="nc" id="L833">	}</span>
	public TreeMap getDrawGameData() {
<span class="nc" id="L835">		return drawGameData;</span>
	}
	public String getDrawGameNewData() {
<span class="nc" id="L838">		return drawGameNewData;</span>
	}
	public String getDrawTime() {
<span class="nc" id="L841">		return drawTime;</span>
	}
	public String getFirstName() {
<span class="nc" id="L844">		return firstName;</span>
	}
	public String getGameName() {
<span class="nc" id="L847">		return gameName;</span>
	}
	public int getGameNo() {
<span class="nc" id="L850">		return gameNo;</span>
	}
	public String getIdNumber() {
<span class="nc" id="L853">		return idNumber;</span>
	}
	public String getIdType() {
<span class="nc" id="L856">		return idType;</span>
	}
	public String getLastName() {
<span class="nc" id="L859">		return lastName;</span>
	}
	public HttpServletResponse getResponse() {
<span class="nc" id="L862">		return response;</span>
	}
	public HttpServletRequest getServletRequest() {
<span class="nc" id="L865">		return servletRequest;</span>
	}
	public String getStartDate() {
<span class="nc" id="L868">		return startDate;</span>
	}
	public String getTicketNo() {
<span class="nc" id="L871">		return ticketNo;</span>
	}
	public String getUserName() {
<span class="nc" id="L874">		return userName;</span>
	}
	public boolean isAutoCancel() {
<span class="nc" id="L877">		return autoCancel;</span>
	}
	public void newData() {
<span class="nc" id="L880">		ServletContext sc = ServletActionContext.getServletContext();</span>
<span class="nc" id="L881">		ServerStartUpData helper = new ServerStartUpData();</span>
<span class="nc" id="L882">		helper.getUpdatedData(sc);</span>
		//sc.setAttribute(&quot;GAME_DATA&quot;,
			//	(TreeMap&lt;Integer, List&lt;List&gt;&gt;) updatedDataList.get(1));
		//sc.setAttribute(&quot;drawIdTableMap&quot;,
				//(Map&lt;Integer, Map&lt;Integer, String&gt;&gt;) updatedDataList.get(0));
		// Util.setGameMap((TreeMap&lt;String, Integer&gt;) updatedDataList.get(2));
		/*
		 * logger.debug(&quot; GAME_DATA is&lt;&lt;&lt;&lt;&lt;&lt;&gt;&gt;&gt;&gt;&gt;-----&quot; +
		 * updatedDataList.get(1));
		 * logger.debug(&quot; drawIdTableMap&lt;&lt;&lt;&lt;&lt;&lt;&gt;&gt;&gt;&gt;&gt;-----&quot; +
		 * updatedDataList.get(0));
		 * logger.debug(&quot; GAME_MAP is&lt;&lt;&lt;&lt;&lt;&lt;&gt;&gt;&gt;&gt;&gt;-----&quot; +
		 * updatedDataList.get(2));
		 */
<span class="nc" id="L896">	}</span>
	public void registerPlayer() throws Exception {
<span class="nc" id="L898">		ServletContext sc = ServletActionContext.getServletContext();</span>
<span class="nc" id="L899">		String isDraw = (String) sc.getAttribute(&quot;IS_DRAW&quot;);</span>
<span class="nc bnc" id="L900" title="All 2 branches missed.">		if (isDraw.equalsIgnoreCase(&quot;NO&quot;)) {</span>
<span class="nc" id="L901">			response.getOutputStream().write(</span>
					(&quot;ErrorMsg:&quot; + EmbeddedErrors.DRAW_GAME_NOT_AVAILABLE+&quot;ErrorCode:&quot; + EmbeddedErrors.DRAW_GAME_NOT_AVAILABLE_ERROR_CODE+&quot;|&quot;)
					.getBytes());
<span class="nc" id="L904">			return;</span>
		}
<span class="nc" id="L906">		Map currentUserSessionMap = (Map) sc.getAttribute(&quot;LOGGED_IN_USERS&quot;);</span>
<span class="nc bnc" id="L907" title="All 2 branches missed.">		if (currentUserSessionMap == null) {</span>
<span class="nc" id="L908">			response</span>
			.getOutputStream()
			.write(
					(&quot;ErrorMsg:&quot; + EmbeddedErrors.SESSION_EXPIRED + &quot;ErrorCode:01|&quot;)
					.getBytes());
<span class="nc" id="L913">			return;</span>
		}
		// logger.debug(&quot; LOGGED_IN_USERS maps is &quot; +
		// currentUserSessionMap);
<span class="nc" id="L917">		logger.debug(&quot; user name is &quot; + userName);</span>
<span class="nc" id="L918">		HttpSession session = (HttpSession) currentUserSessionMap.get(userName);</span>
<span class="nc bnc" id="L919" title="All 2 branches missed.">		if (!CommonFunctionsHelper.isSessionValid(session)) {</span>
<span class="nc" id="L920">			response</span>
			.getOutputStream()
			.write(
					(&quot;ErrorMsg:&quot; + EmbeddedErrors.SESSION_EXPIRED + &quot;ErrorCode:01|&quot;)
					.getBytes());
<span class="nc" id="L925">			return;</span>
		}
<span class="nc" id="L927">		UserInfoBean userInfoBean = (UserInfoBean) session</span>
		.getAttribute(&quot;USER_INFO&quot;);
<span class="nc" id="L929">		String refMerchantId = (String) sc.getAttribute(&quot;REF_MERCHANT_ID&quot;);</span>
<span class="nc" id="L930">		int autoCancelHoldDays=Integer.parseInt((String) sc.getAttribute(&quot;AUTO_CANCEL_CLOSER_DAYS&quot;));</span>
<span class="nc" id="L931">		long lastPrintedTicket=0;</span>
<span class="nc" id="L932">		int gameId = 0;</span>
<span class="nc bnc" id="L933" title="All 2 branches missed.">		if(LSTktNo !=0){</span>
<span class="nc" id="L934">			lastPrintedTicket = LSTktNo/Util.getDivValueForLastSoldTkt(String.valueOf(LSTktNo).length());</span>
<span class="nc" id="L935">			gameId = Util.getGameIdFromGameNumber(Util.getGamenoFromTktnumber(String.valueOf(LSTktNo)));</span>
		}
<span class="nc" id="L937">		String actionName=ActionContext.getContext().getName();</span>
<span class="nc" id="L938">		DrawGameRPOSHelper drawGameRPOSHelper = new DrawGameRPOSHelper();</span>
<span class="nc" id="L939">		drawGameRPOSHelper.checkLastPrintedTicketStatusAndUpdate(userInfoBean,lastPrintedTicket,&quot;TERMINAL&quot;,refMerchantId,autoCancelHoldDays,actionName, gameId);</span>
<span class="nc" id="L940">		DrawGameRPOSHelper helper = new DrawGameRPOSHelper();</span>
<span class="nc" id="L941">		PWTDrawBean pwtBean = helper.registerPlayer(firstName, lastName,</span>
				idNumber, idType,
				(PWTDrawBean) session.getAttribute(&quot;PWT_RES&quot;), userInfoBean);
<span class="nc bnc" id="L944" title="All 2 branches missed.">		if (pwtBean.getStatus().equals(&quot;SUCCESS&quot;)) {</span>
<span class="nc" id="L945">			response.getOutputStream().write(</span>
					&quot;Registration Successful&quot;.getBytes());
		} else {
<span class="nc" id="L948">			response.getOutputStream().write(&quot;Error&quot;.getBytes());</span>
		}
<span class="nc" id="L950">	}</span>
	public void prizeWinningTicket() throws Exception {
<span class="nc" id="L952">		ServletContext sc = ServletActionContext.getServletContext();</span>
<span class="nc" id="L953">		String isDraw = (String) sc.getAttribute(&quot;IS_DRAW&quot;);</span>
<span class="nc" id="L954">		double taxAmt=0;</span>
<span class="nc bnc" id="L955" title="All 2 branches missed.">		if (isDraw.equalsIgnoreCase(&quot;NO&quot;)) {</span>
<span class="nc" id="L956">			response.getOutputStream().write(</span>
					(&quot;ErrorMsg:&quot; + EmbeddedErrors.DRAW_GAME_NOT_AVAILABLE+&quot;ErrorCode:&quot; + EmbeddedErrors.DRAW_GAME_NOT_AVAILABLE_ERROR_CODE+&quot;|&quot;)
					.getBytes());
<span class="nc" id="L959">			return;</span>
		}
<span class="nc" id="L961">		double beepAmt=Double.parseDouble((String)sc.getAttribute(&quot;AMOUNT_FOR_LONG_BEEP&quot;));</span>
<span class="nc" id="L962">		Map currentUserSessionMap = (Map) sc.getAttribute(&quot;LOGGED_IN_USERS&quot;);</span>
<span class="nc" id="L963">		HttpSession session = (HttpSession) currentUserSessionMap.get(userName);</span>
<span class="nc" id="L964">		UserInfoBean userInfoBean = (UserInfoBean) session</span>
		.getAttribute(&quot;USER_INFO&quot;);
<span class="nc" id="L966">		String refMerchantId = (String) sc.getAttribute(&quot;REF_MERCHANT_ID&quot;);</span>
<span class="nc" id="L967">		MainPWTDrawBean mainPwtBean = new MainPWTDrawBean();</span>
<span class="nc" id="L968">		String finalPwtData = null;</span>
<span class="nc" id="L969">		mainPwtBean.setInpType(Integer.parseInt((String) sc.getAttribute(&quot;InpType&quot;)));</span>
<span class="nc" id="L970">		mainPwtBean.setTicketNo(ticketNo);</span>
<span class="nc" id="L971">		AjaxRequestHelper ajxHelper1 = new AjaxRequestHelper();</span>
<span class="nc" id="L972">		ajxHelper1.getAvlblCreditAmt(userInfoBean);</span>
<span class="nc" id="L973">		double bal1 = userInfoBean.getAvailableCreditLimit()</span>
		- userInfoBean.getClaimableBal();
<span class="nc" id="L975">		DrawGameRPOSHelper helper = new DrawGameRPOSHelper();</span>
<span class="nc" id="L976">		MainPWTDrawBean mainWinningBean = helper.prizeWinningTicket(</span>
				mainPwtBean, userInfoBean, refMerchantId);
<span class="nc" id="L978">		int autoCancelHoldDays=Integer.parseInt((String) sc.getAttribute(&quot;AUTO_CANCEL_CLOSER_DAYS&quot;));</span>
<span class="nc" id="L979">		long lastPrintedTicket=0;</span>
<span class="nc" id="L980">		int gameId = 0;</span>
<span class="nc bnc" id="L981" title="All 2 branches missed.">		if(LSTktNo !=0){</span>
<span class="nc" id="L982">			lastPrintedTicket = LSTktNo/Util.getDivValueForLastSoldTkt(String.valueOf(LSTktNo).length());</span>
<span class="nc" id="L983">			gameId = Util.getGameIdFromGameNumber(Util.getGamenoFromTktnumber(String.valueOf(LSTktNo)));</span>
		}
<span class="nc" id="L985">		String actionName=ActionContext.getContext().getName();</span>
<span class="nc" id="L986">		helper.checkLastPrintedTicketStatusAndUpdate(userInfoBean,lastPrintedTicket,&quot;TERMINAL&quot;,refMerchantId,autoCancelHoldDays,actionName, gameId);</span>
<span class="nc bnc" id="L987" title="All 2 branches missed.">		if (&quot;ERROR&quot;.equalsIgnoreCase(mainWinningBean.getStatus())) {</span>
<span class="nc" id="L988">			finalPwtData = &quot;ErrorMsg:&quot; + EmbeddedErrors.PWT_FRAUD+&quot;ErrorCode:&quot; + EmbeddedErrors.PWT_FRAUD_ERROR_CODE+&quot;|&quot;;</span>
<span class="nc" id="L989">			logger.debug(&quot;FINAL PWT DATA:&quot; + finalPwtData);</span>
<span class="nc" id="L990">			response.getOutputStream().write(finalPwtData.getBytes());</span>
<span class="nc" id="L991">			return;</span>
<span class="nc bnc" id="L992" title="All 2 branches missed.">		} else if (&quot;FRAUD&quot;.equalsIgnoreCase(mainWinningBean.getStatus())) {</span>
<span class="nc" id="L993">			finalPwtData = &quot;ErrorMsg:&quot; + EmbeddedErrors.PWT_FRAUD+&quot;ErrorCode:&quot; + EmbeddedErrors.PWT_FRAUD_ERROR_CODE+&quot;|&quot;;</span>
<span class="nc" id="L994">			logger.debug(&quot;FINAL PWT DATA:&quot; + finalPwtData);</span>
<span class="nc" id="L995">			response.getOutputStream().write(finalPwtData.getBytes());</span>
<span class="nc" id="L996">			return; // error</span>
<span class="nc bnc" id="L997" title="All 2 branches missed.">		} else if (&quot;ERROR_INVALID&quot;</span>
				.equalsIgnoreCase(mainWinningBean.getStatus())) {
<span class="nc" id="L999">			finalPwtData = &quot;ErrorMsg:&quot; + EmbeddedErrors.PWT_INVALID+&quot;ErrorCode:&quot; + EmbeddedErrors.PWT_INVALID_ERROR_CODE+&quot;|&quot;;</span>
<span class="nc" id="L1000">			logger.debug(&quot;FINAL PWT DATA:&quot; + finalPwtData);</span>
<span class="nc" id="L1001">			response.getOutputStream().write(finalPwtData.getBytes());</span>
<span class="nc" id="L1002">			return;</span>
<span class="nc bnc" id="L1003" title="All 2 branches missed.">		} else if (&quot;CANCELLED&quot;.equalsIgnoreCase(mainWinningBean.getStatus())) {</span>
<span class="nc" id="L1004">			finalPwtData = &quot;ErrorMsg:&quot; + EmbeddedErrors.PWT_INVALID+&quot;ErrorCode:&quot; + EmbeddedErrors.PWT_INVALID_ERROR_CODE+&quot;|&quot;;</span>
<span class="nc" id="L1005">			logger.debug(&quot;FINAL PWT DATA:&quot; + finalPwtData);</span>
<span class="nc" id="L1006">			response.getOutputStream().write(finalPwtData.getBytes());</span>
<span class="nc" id="L1007">			return;// &quot;error&quot;;</span>
<span class="nc bnc" id="L1008" title="All 2 branches missed.">		} else if (&quot;UN_AUTH&quot;.equalsIgnoreCase(mainWinningBean.getStatus())) {</span>
<span class="nc" id="L1009">			finalPwtData = &quot;ErrorMsg:&quot; + EmbeddedErrors.PWT_UN_AUTH+&quot;ErrorCode:&quot; + EmbeddedErrors.PWT_UN_AUTH_ERROR_CODE+&quot;|&quot;;</span>
<span class="nc" id="L1010">			logger.debug(&quot;FINAL PWT DATA:&quot; + finalPwtData);</span>
<span class="nc" id="L1011">			response.getOutputStream().write(finalPwtData.getBytes());</span>
<span class="nc" id="L1012">			return;</span>
<span class="nc bnc" id="L1013" title="All 4 branches missed.">		} else if (mainWinningBean.getStatus() != null</span>
				&amp;&amp; mainWinningBean.getStatus().equalsIgnoreCase(
				&quot;OUT_VERIFY_LIMIT&quot;)) {
<span class="nc" id="L1016">			finalPwtData = &quot;ErrorMsg:&quot; + EmbeddedErrors.PWT_OUT_VERIFY_LIMIT+&quot;ErrorCode:&quot; + EmbeddedErrors.PWT_OUT_VERIFY_LIMIT_ERROR_CODE+&quot;|&quot;;</span>
<span class="nc" id="L1017">			logger.debug(&quot;FINAL PWT DATA:&quot; + finalPwtData);</span>
<span class="nc" id="L1018">			response.getOutputStream().write(finalPwtData.getBytes());</span>
<span class="nc" id="L1019">			return;</span>
<span class="nc bnc" id="L1020" title="All 2 branches missed.">		} else if (&quot;PWT_LIMIT_EXCEED&quot;.equalsIgnoreCase(mainWinningBean.getStatus())) {</span>
<span class="nc" id="L1021">			finalPwtData = &quot;ErrorMsg:&quot; + EmbeddedErrors.PWT_LIMIT_EXCEED+&quot;ErrorCode:&quot; + EmbeddedErrors.PWT_LIMIT_EXCEED_ERROR_CODE+&quot;|&quot;;</span>
<span class="nc" id="L1022">			logger.debug(&quot;FINAL PWT DATA:&quot; + finalPwtData);</span>
<span class="nc" id="L1023">			response.getOutputStream().write(finalPwtData.getBytes());</span>
<span class="nc" id="L1024">			return;</span>
<span class="nc bnc" id="L1025" title="All 2 branches missed.">		} else if (&quot;HIGH_PRIZE&quot;.equalsIgnoreCase(mainWinningBean.getStatus())) {</span>
<span class="nc" id="L1026">			finalPwtData = &quot;ErrorMsg:&quot; + EmbeddedErrors.PWT_OUT_VERIFY_LIMIT+&quot;ErrorCode:&quot; + EmbeddedErrors.PWT_OUT_VERIFY_LIMIT_ERROR_CODE+&quot;|&quot;;</span>
<span class="nc" id="L1027">			logger.debug(&quot;FINAL PWT DATA:&quot; + finalPwtData);</span>
<span class="nc" id="L1028">			response.getOutputStream().write(finalPwtData.getBytes());</span>
<span class="nc" id="L1029">			return;</span>
<span class="nc bnc" id="L1030" title="All 2 branches missed.">		} else if (&quot;OUT_PAY_LIMIT&quot;</span>
				.equalsIgnoreCase(mainWinningBean.getStatus())) {
<span class="nc" id="L1032">			finalPwtData = &quot;ErrorMsg:&quot; + EmbeddedErrors.PWT_OUT_VERIFY_LIMIT+&quot;ErrorCode:&quot; + EmbeddedErrors.PWT_OUT_VERIFY_LIMIT_ERROR_CODE+&quot;|&quot;;</span>
<span class="nc" id="L1033">			logger.debug(&quot;FINAL PWT DATA:&quot; + finalPwtData);</span>
<span class="nc" id="L1034">			response.getOutputStream().write(finalPwtData.getBytes());</span>
<span class="nc" id="L1035">			return;</span>
<span class="nc bnc" id="L1036" title="All 2 branches missed.">		}else if (&quot;OUT_ASSIGNED_LIMITS&quot;</span>
				.equalsIgnoreCase(mainWinningBean.getStatus())) {
<span class="nc" id="L1038">			finalPwtData = &quot;ErrorMsg:&quot; + EmbeddedErrors.OUT_ASSIGNED_LIMITS;</span>
<span class="nc" id="L1039">			logger.debug(&quot;FINAL PWT DATA:&quot; + finalPwtData);</span>
<span class="nc" id="L1040">			response.getOutputStream().write(finalPwtData.getBytes());</span>
<span class="nc" id="L1041">			return;</span>
<span class="nc bnc" id="L1042" title="All 2 branches missed.">		} else if (&quot;TICKET_EXPIRED&quot;.equalsIgnoreCase(mainWinningBean</span>
				.getStatus())) {
<span class="nc" id="L1044">			finalPwtData = &quot;ErrorMsg:&quot; + EmbeddedErrors.PWT_TICKET_EXPIRED+&quot;ErrorCode:&quot; + EmbeddedErrors.PWT_TICKET_EXPIRED_ERROR_CODE+&quot;|&quot;;</span>
<span class="nc" id="L1045">			logger.debug(&quot;FINAL PWT DATA:&quot; + finalPwtData);</span>
<span class="nc" id="L1046">			response.getOutputStream().write(finalPwtData.getBytes());</span>
<span class="nc" id="L1047">			return;</span>
		}
<span class="nc" id="L1049">		StringBuilder stBuild = new StringBuilder(&quot;&quot;);</span>
<span class="nc" id="L1050">		String raffleData = &quot;&quot;;</span>
<span class="nc bnc" id="L1051" title="All 2 branches missed.">		if (mainWinningBean.getPwtTicketType().equalsIgnoreCase(&quot;RAFFLE&quot;)) {</span>
<span class="nc" id="L1052">			double totalRaffleAmount = 0.0;</span>
<span class="nc" id="L1053">			PWTDrawBean pwtwinBean = mainWinningBean.getWinningBeanList()</span>
			.get(0);
<span class="nc" id="L1055">			RaffleDrawIdBean raffleWinningBean = (RaffleDrawIdBean) pwtwinBean</span>
			.getRaffleDrawIdBeanList().get(0);
<span class="nc" id="L1057">			String dataArr[] = buildPWTRaffleData(raffleWinningBean).split(</span>
			&quot;RWA*&quot;);
<span class="nc" id="L1059">			String data = dataArr[0];</span>
<span class="nc bnc" id="L1060" title="All 2 branches missed.">			if (dataArr.length &gt; 1)</span>
<span class="nc" id="L1061">				totalRaffleAmount = Double.parseDouble(dataArr[1]);</span>
<span class="nc" id="L1062">			raffleData = raffleData + data + &quot;|Total Pay:&quot; + totalRaffleAmount</span>
			+ &quot;|&quot;;
<span class="nc bnc" id="L1064" title="All 2 branches missed.">		} else if (mainWinningBean.getPwtTicketType().equalsIgnoreCase(&quot;DRAW&quot;)) {</span>
<span class="nc bnc" id="L1065" title="All 2 branches missed.">			if (&quot;FRAUD&quot;.equalsIgnoreCase(mainWinningBean.getStatus())) {</span>
<span class="nc" id="L1066">				finalPwtData = &quot;ErrorMsg:&quot; + EmbeddedErrors.PWT_FRAUD+&quot;ErrorCode:&quot; + EmbeddedErrors.PWT_FRAUD_ERROR_CODE+&quot;|&quot;;</span>
<span class="nc" id="L1067">				logger.debug(&quot;FINAL PWT DATA:&quot; + finalPwtData);</span>
<span class="nc" id="L1068">				response.getOutputStream().write(finalPwtData.getBytes());</span>
<span class="nc" id="L1069">				return;// &quot;error&quot;;</span>
<span class="nc bnc" id="L1070" title="All 2 branches missed.">			} else if (&quot;TICKET_EXPIRED&quot;.equalsIgnoreCase(mainWinningBean</span>
					.getStatus())) {
<span class="nc" id="L1072">				finalPwtData = &quot;ErrorMsg:&quot; + EmbeddedErrors.PWT_TICKET_EXPIRED+&quot;ErrorCode:&quot; + EmbeddedErrors.PWT_TICKET_EXPIRED_ERROR_CODE+&quot;|&quot;;</span>
<span class="nc" id="L1073">				logger.debug(&quot;FINAL PWT DATA:&quot; + finalPwtData);</span>
<span class="nc" id="L1074">				response.getOutputStream().write(finalPwtData.getBytes());</span>
<span class="nc" id="L1075">				return;</span>
<span class="nc bnc" id="L1076" title="All 2 branches missed.">			} else if (!mainWinningBean.isValid()) {</span>
<span class="nc" id="L1077">				finalPwtData = &quot;ErrorMsg:&quot; + EmbeddedErrors.PWT_INVALID+&quot;ErrorCode:&quot; + EmbeddedErrors.PWT_INVALID_ERROR_CODE+&quot;|&quot;;</span>
<span class="nc" id="L1078">				logger.debug(&quot;FINAL PWT DATA:&quot; + finalPwtData);</span>
<span class="nc" id="L1079">				response.getOutputStream().write(finalPwtData.getBytes());</span>
<span class="nc" id="L1080">				return;</span>
<span class="nc bnc" id="L1081" title="All 4 branches missed.">			} else if (mainWinningBean.getStatus() != null</span>
					&amp;&amp; mainWinningBean.getStatus().equalsIgnoreCase(
					&quot;OUT_VERIFY_LIMIT&quot;)) {
<span class="nc" id="L1084">				finalPwtData = &quot;ErrorMsg:&quot;</span>
					+ EmbeddedErrors.PWT_OUT_VERIFY_LIMIT+&quot;ErrorCode:&quot; + EmbeddedErrors.PWT_OUT_VERIFY_LIMIT_ERROR_CODE+&quot;|&quot;;
<span class="nc" id="L1086">				logger.debug(&quot;FINAL PWT DATA:&quot; + finalPwtData);</span>
<span class="nc" id="L1087">				response.getOutputStream().write(finalPwtData.getBytes());</span>
<span class="nc" id="L1088">				return;</span>
<span class="nc bnc" id="L1089" title="All 2 branches missed.">			} else if (&quot;UN_AUTH&quot;.equalsIgnoreCase(mainWinningBean.getStatus())) {</span>
<span class="nc" id="L1090">				finalPwtData = &quot;ErrorMsg:&quot; + EmbeddedErrors.PWT_UN_AUTH+&quot;ErrorCode:&quot; + EmbeddedErrors.PWT_UN_AUTH_ERROR_CODE+&quot;|&quot;;</span>
<span class="nc" id="L1091">				logger.debug(&quot;FINAL PWT DATA:&quot; + finalPwtData);</span>
<span class="nc" id="L1092">				response.getOutputStream().write(finalPwtData.getBytes());</span>
<span class="nc" id="L1093">				return;</span>
			}
			// String raffleData=EmbeddedErrors.RAFFLE_DATA;
<span class="nc" id="L1096">			double totalRaffleAmount = 0.0;</span>
<span class="nc" id="L1097">			List&lt;PWTDrawBean&gt; pwtWinBeanlist = mainWinningBean</span>
			.getWinningBeanList();
<span class="nc bnc" id="L1099" title="All 2 branches missed.">			for (int i = 0; i &lt; pwtWinBeanlist.size(); i++) {</span>
<span class="nc" id="L1100">				PWTDrawBean pwtwinBean = pwtWinBeanlist.get(i);</span>
<span class="nc bnc" id="L1101" title="All 2 branches missed.">				if (pwtwinBean.getPwtTicketType().equalsIgnoreCase(&quot;RAFFLE&quot;)) {</span>
<span class="nc" id="L1102">					List&lt;RaffleDrawIdBean&gt; raffleDrawIdBeanList = pwtwinBean</span>
					.getRaffleDrawIdBeanList();
<span class="nc bnc" id="L1104" title="All 2 branches missed.">					if (raffleDrawIdBeanList != null) {</span>
<span class="nc bnc" id="L1105" title="All 2 branches missed.">						for (int j = 0; j &lt; raffleDrawIdBeanList.size(); j++) {</span>
<span class="nc bnc" id="L1106" title="All 2 branches missed.">							if (j &gt; 0) {</span>
<span class="nc" id="L1107">								raffleData = raffleData + &quot;;&quot;;</span>
							}
<span class="nc" id="L1109">							RaffleDrawIdBean raffleWinningBean = raffleDrawIdBeanList</span>
							.get(j);
<span class="nc" id="L1111">							String dataArr[] = buildPWTRaffleData(</span>
									raffleWinningBean).split(&quot;RWA&quot;);
<span class="nc" id="L1113">							String data = dataArr[0];</span>
<span class="nc bnc" id="L1114" title="All 2 branches missed.">							if (dataArr.length &gt; 1)</span>
<span class="nc" id="L1115">								totalRaffleAmount = Double</span>
								.parseDouble(dataArr[1]);
<span class="nc" id="L1117">							raffleData = raffleData + data;</span>
						}
					}
				}
			}
			//raffleData = raffleData + &quot;#&quot;;
			// StringBuilder stBuild = new StringBuilder(&quot;&quot;);
<span class="nc" id="L1124">			double totTktAmt = 0.0;</span>
<span class="nc" id="L1125">			double totalClmPndAmt=0.0;</span>
<span class="nc" id="L1126">			int totRegister = 0;</span>
<span class="nc bnc" id="L1127" title="All 2 branches missed.">			for (int k = 0; k &lt; pwtWinBeanlist.size(); k++) {</span>
<span class="nc" id="L1128">				PWTDrawBean pwtwinBean = pwtWinBeanlist.get(k);</span>
<span class="nc" id="L1129">				taxAmt=pwtwinBean.getGovtTaxAmount();</span>
<span class="nc bnc" id="L1130" title="All 2 branches missed.">				if (pwtwinBean.getPwtTicketType().equalsIgnoreCase(&quot;DRAW&quot;)) {</span>
<span class="nc bnc" id="L1131" title="All 2 branches missed.">					for (int i = 0; i &lt; pwtwinBean.getDrawWinList().size(); i++) {</span>
<span class="nc" id="L1132">						int nonWin = 0;</span>
<span class="nc" id="L1133">						int win = 0;</span>
<span class="nc" id="L1134">						int clm=0;</span>
<span class="nc" id="L1135">						int register = 0;</span>
<span class="nc" id="L1136">						int claim = 0;</span>
<span class="nc" id="L1137">						int outVerify = 0;</span>
<span class="nc" id="L1138">						int pndPay = 0;</span>
<span class="nc" id="L1139">						DrawIdBean drawBean = pwtwinBean.getDrawWinList().get(i);</span>
						//String drawStatusForTicket=drawBean.getDrawStatusForTicket();
<span class="nc" id="L1141">						String drawStatusForTicket=drawBean.getStatus();</span>
<span class="nc" id="L1142">						logger.info(drawStatusForTicket);</span>
<span class="nc" id="L1143">						String drawTime = drawBean.getDrawDateTime();</span>
<span class="nc" id="L1144">						boolean isResAwaited = false;</span>
<span class="nc" id="L1145">						boolean isExpired= false;</span>
<span class="nc" id="L1146">						boolean isVerPending=false;</span>
<span class="nc" id="L1147">						boolean isClmPending=false;</span>
<span class="nc" id="L1148">						double drawAmt = 0.0;</span>
<span class="nc" id="L1149">						List&lt;PanelIdBean&gt; panelWinList = drawBean</span>
						.getPanelWinList();
<span class="nc bnc" id="L1151" title="All 4 branches missed.">						if (panelWinList != null &amp;&amp; !drawStatusForTicket.equals(&quot;DRAW_EXPIRED&quot;) ) {</span>
<span class="nc bnc" id="L1152" title="All 2 branches missed.">							for (int j = 0; j &lt; panelWinList.size(); j++) {</span>
<span class="nc" id="L1153">								PanelIdBean panelBean = panelWinList.get(j);</span>
<span class="nc bnc" id="L1154" title="All 2 branches missed.">								if (panelBean.getStatus().equals(&quot;NON WIN&quot;)) {</span>
<span class="nc" id="L1155">									nonWin++;</span>
<span class="nc bnc" id="L1156" title="All 2 branches missed.">								} else if (panelBean.getStatus().equals(</span>
								&quot;NORMAL_PAY&quot;)) {
<span class="nc" id="L1158">									drawAmt = panelBean.getWinningAmt()+ drawAmt;</span>
<span class="nc" id="L1159">									win++;</span>
<span class="nc bnc" id="L1160" title="All 2 branches missed.">								} else if (panelBean.getStatus().equals(</span>
								&quot;CLAIMED&quot;)) {
<span class="nc" id="L1162">									claim++;</span>
<span class="nc bnc" id="L1163" title="All 2 branches missed.">								} else if (panelBean.getStatus().equals(</span>
								&quot;PND_PAY&quot;)) {
<span class="nc" id="L1165">									pndPay++;</span>
<span class="nc bnc" id="L1166" title="All 2 branches missed.">								} else if (panelBean.getStatus().equals(</span>
								&quot;HIGH_PRIZE&quot;)) {
<span class="nc" id="L1168">									register++;</span>
<span class="nc bnc" id="L1169" title="All 2 branches missed.">								} else if (panelBean.getStatus().equals(</span>
								&quot;OUT_PAY_LIMIT&quot;)) {
<span class="nc" id="L1171">									register++;</span>
<span class="nc bnc" id="L1172" title="All 2 branches missed.">								} else if (panelBean.getStatus().equals(</span>
								&quot;OUT_VERIFY_LIMIT&quot;)) {
<span class="nc" id="L1174">									outVerify++;</span>
<span class="nc bnc" id="L1175" title="All 2 branches missed.">								}else if(panelBean.getStatus().equals(&quot;CLAIM_PENDING&quot;)){</span>
<span class="nc" id="L1176">									drawAmt = panelBean.getWinningAmt()+ drawAmt;</span>
<span class="nc" id="L1177">									totalClmPndAmt+=panelBean.getWinningAmt();</span>
<span class="nc" id="L1178">									clm++;</span>
								}
							}
<span class="nc bnc" id="L1181" title="All 2 branches missed.">						}else if(drawStatusForTicket.equals(&quot;DRAW_EXPIRED&quot;)){</span>
<span class="nc" id="L1182">										isExpired=true;</span>
<span class="nc bnc" id="L1183" title="All 2 branches missed.">						}else if(drawStatusForTicket.equals(&quot;VERIFICATION_PENDING&quot;)){</span>
<span class="nc" id="L1184">							isVerPending=true;</span>
<span class="nc bnc" id="L1185" title="All 2 branches missed.">						}else if(drawStatusForTicket.equals(&quot;CLAIM_PENDING&quot;)){</span>
<span class="nc" id="L1186">							isClmPending=true;</span>
						}else{
<span class="nc" id="L1188">							isResAwaited = true;</span>
						}
<span class="nc bnc" id="L1190" title="All 2 branches missed.">						totTktAmt = (drawStatusForTicket.equals(&quot;CLAIM_PENDING&quot;)?0.0:drawAmt-taxAmt) + totTktAmt;</span>
<span class="nc bnc" id="L1191" title="All 2 branches missed.">						if(isExpired){</span>
<span class="nc" id="L1192">							stBuild.append(&quot;|DrawTime:&quot; + drawTime + &quot;&quot;);</span>
<span class="nc" id="L1193">							stBuild.append(&quot;,No:0,Message:&quot;+EmbeddedErrors.DRAW_EXP_MSG+&quot;MsgCode:&quot;+EmbeddedErrors.DRAW_EXP_MSG_CODE);</span>
<span class="nc bnc" id="L1194" title="All 2 branches missed.">						}else if (isVerPending) {</span>
<span class="nc" id="L1195">							stBuild.append(&quot;|DrawTime:&quot; + drawTime + &quot;&quot;);</span>
<span class="nc" id="L1196">							stBuild.append(&quot;,No:0,Message:&quot;+EmbeddedErrors.VER_PND_MSG+&quot;MsgCode:&quot;+EmbeddedErrors.VER_PND_MSG_CODE);</span>
<span class="nc bnc" id="L1197" title="All 2 branches missed.">						}else if (isResAwaited) {</span>
<span class="nc" id="L1198">							stBuild.append(&quot;|DrawTime:&quot; + drawTime + &quot;&quot;);</span>
<span class="nc" id="L1199">							stBuild.append(&quot;,No:0,Message:&quot;+EmbeddedErrors.AWAITED_MSG+&quot;MsgCode:&quot;+EmbeddedErrors.AWAITED_MSG_CODE);</span>
						} else {
<span class="nc" id="L1201">							stBuild.append(&quot;|DrawTime:&quot; + drawTime + &quot;&quot;);</span>
<span class="nc bnc" id="L1202" title="All 2 branches missed.">							if (nonWin != 0) {</span>
								// stBuild.append(&quot;\nDrawTime:&quot; + drawTime +
								// &quot;&quot;);
<span class="nc" id="L1205">								stBuild.append(&quot;,No:&quot; + nonWin</span>
										+ &quot;,Message:&quot;+EmbeddedErrors.TRY_AGAIN_MSG+&quot;MsgCode:&quot;+EmbeddedErrors.TRY_AGAIN_MSG_CODE);
							}
<span class="nc bnc" id="L1208" title="All 2 branches missed.">							if (win != 0) {</span>
								// stBuild.append(&quot;\nDrawTime:&quot; + drawTime +
								// &quot;&quot;);
<span class="nc" id="L1211">								stBuild.append(&quot;,No:&quot; + win + &quot;,Message:WIN &quot;</span>
										+ Util.getBalInString(drawAmt) +&quot;&quot;);
								
							}
<span class="nc bnc" id="L1215" title="All 2 branches missed.">							if (register != 0) {</span>
								// stBuild.append(&quot;\nDrawTime:&quot; + drawTime +
								// &quot;&quot;);
<span class="nc" id="L1218">								stBuild.append(&quot;,No:&quot; + register</span>
										+ &quot;,Message:&quot;+EmbeddedErrors.REG_REQ_MSG+&quot;MsgCode:&quot;+EmbeddedErrors.REG_REQ_MSG_CODE);
							}
<span class="nc bnc" id="L1221" title="All 2 branches missed.">							if (claim != 0) {</span>
								// stBuild.append(&quot;\nDrawTime:&quot; + drawTime +
								// &quot;&quot;);
<span class="nc" id="L1224">								stBuild.append(&quot;,No:&quot; + claim</span>
										+ &quot;,Message:&quot;+EmbeddedErrors.CLAIMED_MSG+&quot;MsgCode:&quot;+EmbeddedErrors.CLAIMED_MSG_CODE);
							}
<span class="nc bnc" id="L1227" title="All 2 branches missed.">							if (pndPay != 0) {</span>
								// stBuild.append(&quot;\nDrawTime:&quot; + drawTime +
								// &quot;&quot;);
<span class="nc" id="L1230">								stBuild.append(&quot;,No:&quot; + pndPay</span>
										+ &quot;,Message:&quot;+EmbeddedErrors.IN_PROCESS_MSG+&quot;MsgCode:&quot;+EmbeddedErrors.IN_PROCESS_MSG_CODE);
							}
<span class="nc bnc" id="L1233" title="All 2 branches missed.">							if (outVerify != 0) {</span>
								// stBuild.append(&quot;\nDrawTime:&quot; + drawTime +
								// &quot;&quot;);
<span class="nc" id="L1236">								stBuild.append(&quot;,No:&quot; + outVerify</span>
										+ &quot;,Message:&quot;+EmbeddedErrors.OUT_OF_VERIFY_MSG+&quot;MsgCode:&quot;+EmbeddedErrors.OUT_OF_VERIFY_MSG_CODE);
							}
<span class="nc bnc" id="L1239" title="All 2 branches missed.">							if(clm!=0){</span>
<span class="nc" id="L1240">								stBuild.append(&quot;,No:&quot; + clm</span>
										+ &quot;,Message:CLM PND &quot;+ Util.getBalInString(drawAmt-taxAmt) );
							}
						}
<span class="nc" id="L1244">						totRegister = totRegister + register;</span>
						// stBuild.append(&quot;;&quot;);
					}
				}
			}
<span class="nc" id="L1249">			totTktAmt = totTktAmt + totalRaffleAmount;</span>
<span class="nc" id="L1250">			int beepVolume=-1;</span>
<span class="nc bnc" id="L1251" title="All 2 branches missed.">			if(totTktAmt!=0){</span>
<span class="nc bnc" id="L1252" title="All 2 branches missed.">				if(totTktAmt&gt;=beepAmt)</span>
<span class="nc" id="L1253">					beepVolume=1;	</span>
				 else
<span class="nc" id="L1255">						beepVolume=0;</span>
<span class="nc bnc" id="L1256" title="All 2 branches missed.">			}else if(totalClmPndAmt&lt;=0){</span>
<span class="nc bnc" id="L1257" title="All 2 branches missed.">				if(totalClmPndAmt&gt;=beepAmt)</span>
<span class="nc" id="L1258">					beepVolume=1;	</span>
				 else
<span class="nc" id="L1260">					beepVolume=0;</span>
			}
			
<span class="nc" id="L1263">			stBuild.append(&quot;|Total Pay:&quot; + Util.getBalInString(totTktAmt) + &quot;|&quot;);</span>
<span class="nc bnc" id="L1264" title="All 2 branches missed.">			if(totalClmPndAmt&gt;0)</span>
<span class="nc" id="L1265">				stBuild.append(&quot;Total CLM PEND:&quot; + Util.getBalInString(totalClmPndAmt-taxAmt) + &quot;|&quot;);</span>
			else
<span class="nc" id="L1267">				stBuild.append(&quot;Total CLM PEND:&quot; + Util.getBalInString(totalClmPndAmt) + &quot;|&quot;);</span>
<span class="nc" id="L1268">			stBuild.append(&quot;BEEP VOL:&quot; + beepVolume + &quot;|&quot;);</span>
			
<span class="nc bnc" id="L1270" title="All 2 branches missed.">			if (totRegister != 0) {</span>
<span class="nc" id="L1271">				stBuild.append(&quot;No:&quot; + totRegister + &quot;,Message:&quot;+EmbeddedErrors.REG_REQ_MSG+EmbeddedErrors.REG_REQ_MSG_CODE+&quot;|&quot;);</span>
			}
		}
<span class="nc" id="L1274">		session.setAttribute(&quot;PWT_RES&quot;, mainWinningBean);</span>
<span class="nc" id="L1275">		currentUserSessionMap.put(userName, session);</span>
		// logger.debug(&quot; STRING BUILER is before reprint &quot; + stBuild);
<span class="nc" id="L1277">		AjaxRequestHelper ajxHelper = new AjaxRequestHelper();</span>
<span class="nc" id="L1278">		ajxHelper.getAvlblCreditAmt(userInfoBean);</span>
<span class="nc" id="L1279">		double bal2 = userInfoBean.getAvailableCreditLimit()</span>
		- userInfoBean.getClaimableBal();
<span class="nc" id="L1281">		double bal = bal2 - bal1;</span>
<span class="nc" id="L1282">		String balance = bal + &quot;00&quot;;</span>
<span class="nc" id="L1283">		balance = balance.substring(0, balance.indexOf(&quot;.&quot;) + 3);</span>
<span class="nc bnc" id="L1284" title="All 2 branches missed.">		if (!mainWinningBean.isReprint()) {</span>
<span class="nc" id="L1285">			finalPwtData = raffleData + stBuild.toString() + &quot;Amt:&quot; + balance</span>
			+ &quot;|&quot;;
		}
<span class="nc bnc" id="L1288" title="All 2 branches missed.">		if(taxAmt&gt;0)</span>
<span class="nc" id="L1289">			finalPwtData=finalPwtData+&quot;Tax:&quot;+Util.getBalInString(taxAmt) + &quot;|&quot;;</span>
<span class="nc" id="L1290">		logger.debug(&quot;FINAL PWT DATA:&quot; + finalPwtData);</span>
<span class="nc" id="L1291">		response.getOutputStream().write(finalPwtData.getBytes());</span>
<span class="nc" id="L1292">	}</span>
		
	public void payPwtTicket() throws Exception {
<span class="nc" id="L1295">		ServletContext sc = ServletActionContext.getServletContext();</span>
<span class="nc" id="L1296">		String isDraw = (String) sc.getAttribute(&quot;IS_DRAW&quot;);</span>
<span class="nc" id="L1297">		double govtCommAmt=0.0;</span>
<span class="nc" id="L1298">		response.setCharacterEncoding(&quot;UTF-8&quot;);</span>
<span class="nc" id="L1299">		response.setContentType(&quot;text/html&quot;);</span>
<span class="nc bnc" id="L1300" title="All 2 branches missed.">		if (isDraw.equalsIgnoreCase(&quot;NO&quot;)) {</span>
<span class="nc" id="L1301">			response.getOutputStream().write(</span>
					(&quot;ErrorMsg:&quot; + EmbeddedErrors.DRAW_GAME_NOT_AVAILABLE+&quot;ErrorCode:&quot; + EmbeddedErrors.DRAW_GAME_NOT_AVAILABLE_ERROR_CODE+&quot;|&quot;)
					.getBytes());
<span class="nc" id="L1304">			return;</span>
		}
<span class="nc" id="L1306">		Map currentUserSessionMap = (Map) sc.getAttribute(&quot;LOGGED_IN_USERS&quot;);</span>
<span class="nc" id="L1307">		HttpSession session = (HttpSession) currentUserSessionMap.get(userName);</span>
<span class="nc" id="L1308">		String countryDeployed = (String) sc.getAttribute(&quot;COUNTRY_DEPLOYED&quot;);</span>
<span class="nc" id="L1309">		UserInfoBean userInfoBean = (UserInfoBean) session</span>
		.getAttribute(&quot;USER_INFO&quot;);
<span class="nc" id="L1311">		String refMerchantId = (String) sc.getAttribute(&quot;REF_MERCHANT_ID&quot;);</span>
<span class="nc" id="L1312">		MainPWTDrawBean mainWinningBean = (MainPWTDrawBean) session</span>
		.getAttribute(&quot;PWT_RES&quot;);
<span class="nc" id="L1314">		AjaxRequestHelper ajxHelper1 = new AjaxRequestHelper();</span>
<span class="nc" id="L1315">		ajxHelper1.getAvlblCreditAmt(userInfoBean);</span>
<span class="nc" id="L1316">		double bal1 = userInfoBean.getAvailableCreditLimit()</span>
		- userInfoBean.getClaimableBal();
<span class="nc" id="L1318">		String highPrizeCriteria = (String) LMSUtility.sc.getAttribute(&quot;HIGH_PRIZE_CRITERIA&quot;);</span>
<span class="nc" id="L1319">		String highPrizeAmt = (String) LMSUtility.sc.getAttribute(&quot;HIGH_PRIZE_AMT&quot;);</span>
<span class="nc" id="L1320">		String highPrizeScheme = (String) LMSUtility.sc.getAttribute(</span>
						&quot;DRAW_GAME_HIGH_PRIZE_SCHEME&quot;);
<span class="nc" id="L1322">		DrawGameRPOSHelper helper = new DrawGameRPOSHelper();</span>
<span class="nc" id="L1323">		String promoTicketDta = &quot;&quot;;</span>
<span class="nc" id="L1324">		logger.debug(&quot;Before--&quot; + new Date());</span>
		//code for Payment Through mPesa ...
<span class="nc bnc" id="L1326" title="All 4 branches missed.">		if(&quot;Y&quot;.equalsIgnoreCase(mPesa) &amp;&amp; mobileNo!=null){</span>
<span class="nc" id="L1327">			mainWinningBean.setIsmPesaEnable(true);</span>
<span class="nc" id="L1328">			mainWinningBean.setMobileNumber(mobileNo);</span>
<span class="nc" id="L1329">			UserInfoBean mPesaUserBean = new MpesaPaymentProcessHelper().payBymPesaAcc(mainWinningBean, userInfoBean);</span>
<span class="nc" id="L1330">			mainWinningBean = helper.payPwtTicket(mainWinningBean, mPesaUserBean,highPrizeCriteria,highPrizeAmt,highPrizeScheme);</span>
<span class="nc" id="L1331">		}else{</span>
<span class="nc" id="L1332">			mainWinningBean = helper.payPwtTicket(mainWinningBean, userInfoBean,highPrizeCriteria,highPrizeAmt,highPrizeScheme);</span>
		}		
		/*
		 *  logger.debug(&quot;---------------------------- AFTER HELPER
		 * CLASS----------------------------------&quot; + new Date());
		 */
<span class="nc" id="L1338">		String finalPwtData = null;</span>
<span class="nc bnc" id="L1339" title="All 2 branches missed.">		if (&quot;PWT_LIMIT_EXCEED&quot;.equalsIgnoreCase(mainWinningBean.getStatus())) {</span>
<span class="nc" id="L1340">			finalPwtData = &quot;ErrorMsg:&quot; + EmbeddedErrors.PWT_LIMIT_EXCEED+&quot;ErrorCode:&quot; + EmbeddedErrors.PWT_LIMIT_EXCEED_ERROR_CODE+&quot;|&quot;;</span>
<span class="nc" id="L1341">			logger.debug(&quot;FINAL PWT DATA:&quot; + finalPwtData);</span>
<span class="nc" id="L1342">			response.getOutputStream().write(finalPwtData.getBytes());</span>
<span class="nc" id="L1343">			return;</span>
<span class="nc bnc" id="L1344" title="All 2 branches missed.">		}if (&quot;INVALID_PWT_LIMIT_EXCEED&quot;.equalsIgnoreCase(mainWinningBean.getStatus())) {</span>
<span class="nc" id="L1345">			finalPwtData = &quot;ErrorMsg:&quot; + EmbeddedErrors.INVALID_PWT_LIMIT_EXCEED+&quot;ErrorCode:&quot; + EmbeddedErrors.INVALID_PWT_LIMIT_EXCEED_ERROR_CODE+&quot;|&quot;;</span>
<span class="nc" id="L1346">			logger.debug(&quot;FINAL PWT DATA:&quot; + finalPwtData);</span>
<span class="nc" id="L1347">			response.getOutputStream().write(finalPwtData.getBytes());</span>
<span class="nc" id="L1348">			return;</span>
		}
		/*if(mainWinningBean.getWinningBeanList() != null) {
			for (int i = 0; i &lt; mainWinningBean.getWinningBeanList().size(); i++) {
				PWTDrawBean winningBean = new PWTDrawBean();
				winningBean = mainWinningBean.getWinningBeanList().get(i);
				for(DrawIdBean drawIdBean : winningBean.getDrawWinList()) {
					if(drawIdBean.getRankId() == 4 &amp;&amp; &quot;TwelveByTwentyFour&quot;.equals(Util.getGameName(mainWinningBean.getGameId()))) {
						double tktCost = Double.parseDouble(drawIdBean.getWinningAmt())/2;
						for(int iLoop = 0; iLoop &lt; 2; iLoop++) {
							double unitPrice = Util.getUnitPrice(mainWinningBean.getGameId(), &quot;Direct12&quot;);
							int gameId = Util.getGameId(&quot;TwelveByTwentyFour&quot;);
							
							KenoPurchaseBean drawGamePurchaseBean = new KenoPurchaseBean();
							drawGamePurchaseBean.setGame_no(Util.getGameNumberFromGameId(gameId));
							drawGamePurchaseBean.setGameId(gameId);
							drawGamePurchaseBean.setGameDispName(Util.getGameDisplayName(gameId));
							drawGamePurchaseBean.setBetAmountMultiple(new int[]{(int) (tktCost/unitPrice)});
							drawGamePurchaseBean.setIsQuickPick(new int[]{1});
							drawGamePurchaseBean.setPlayerData(new String[]{&quot;QP&quot;});
							drawGamePurchaseBean.setPlayType(new String[]{&quot;Direct12&quot;});
							drawGamePurchaseBean.setNoPicked(new String[]{&quot;12&quot;});
							drawGamePurchaseBean.setNoOfPanel(1);
							drawGamePurchaseBean.setPartyId(userInfoBean.getUserOrgId());
							drawGamePurchaseBean.setPartyType(userInfoBean.getUserType());
							drawGamePurchaseBean.setUserId(userInfoBean.getUserId());
							drawGamePurchaseBean.setNoOfDraws(1);
							drawGamePurchaseBean.setIsAdvancedPlay(0);
							drawGamePurchaseBean.setRefMerchantId((String) sc.getAttribute(&quot;REF_MERCHANT_ID&quot;));
							drawGamePurchaseBean.setPurchaseChannel(&quot;LMS_Terminal&quot;);
							drawGamePurchaseBean.setPlrMobileNumber(&quot;&quot;);
	//						drawGamePurchaseBean.setActionName(kenoPurchaseBean.getActionName());
	//						drawGamePurchaseBean.setLastGameId(kenoPurchaseBean.getLastGameId());
							drawGamePurchaseBean.setDeviceType(&quot;TERMINAL&quot;);
							drawGamePurchaseBean.setBarcodeType((String) LMSUtility.sc.getAttribute(&quot;BARCODE_TYPE&quot;));
							drawGamePurchaseBean.setUserMappingId(userInfoBean.getCurrentUserMappingId());
							drawGamePurchaseBean.setDrawIdTableMap((Map&lt;Integer, Map&lt;Integer, String&gt;&gt;) sc.getAttribute(&quot;drawIdTableMap&quot;));
							drawGamePurchaseBean.setLastSoldTicketNo(&quot;0&quot;);
							drawGamePurchaseBean.setServiceId(Util.getServiceIdFormCode(&quot;DG&quot;));
							drawGamePurchaseBean.setPromotkt(true);
							
							KenoPurchaseBean purchaseBean = new TwelveByTwentyFourHelper().twelveByTwentyFourPurchaseTicket(userInfoBean, drawGamePurchaseBean);
							if (&quot;SUCCESS&quot;.equalsIgnoreCase(purchaseBean.getSaleStatus())) {
								promoTicketDta += new DrawGameRPOSHelper().buildTwelveByTwentyFourData(purchaseBean, userInfoBean);
	//							orgOnLineSaleCreditUpdation.drawTicketNPromoMappigUpdate(1, kenoPurchaseBean.getGame_no(), kenoPurchaseBean.getTicket_no(), purchaseBean.getTicket_no());
							} else {
	//							kenoPurchaseBean.setPromoSaleStatus(&quot;FAILED&quot;);
	//							return kenoPurchaseBean;
							}
	//						kenoPurchaseBean.setPromoPurchaseBean(purchaseBean);
						}
					}
				}
			}
		}*/
		
<span class="nc" id="L1404">		String raffleData = &quot;&quot;;</span>
<span class="nc" id="L1405">		StringBuilder stBuild = new StringBuilder(&quot;&quot;);</span>
<span class="nc" id="L1406">		double totalRaffleAmount = 0.0;</span>
<span class="nc bnc" id="L1407" title="All 2 branches missed.">		if (mainWinningBean.getPwtTicketType().equalsIgnoreCase(&quot;RAFFLE&quot;)) {</span>
<span class="nc" id="L1408">			List&lt;RaffleDrawIdBean&gt; raffleDrawIdBeanList = mainWinningBean</span>
			.getWinningBeanList().get(0).getRaffleDrawIdBeanList();
<span class="nc bnc" id="L1410" title="All 2 branches missed.">			if (raffleDrawIdBeanList != null) {</span>
<span class="nc bnc" id="L1411" title="All 2 branches missed.">				for (int j = 0; j &lt; raffleDrawIdBeanList.size(); j++) {</span>
<span class="nc bnc" id="L1412" title="All 2 branches missed.">					if (j &gt; 0) {</span>
<span class="nc" id="L1413">						raffleData = raffleData + &quot;;&quot;;</span>
					}
<span class="nc" id="L1415">					RaffleDrawIdBean raffleWinningBean = raffleDrawIdBeanList</span>
					.get(j);
<span class="nc" id="L1417">					String dataArr[] = buildPWTRaffleData(raffleWinningBean)</span>
					.split(&quot;RWA&quot;);
<span class="nc" id="L1419">					String data = dataArr[0];</span>
<span class="nc bnc" id="L1420" title="All 2 branches missed.">					if (dataArr.length &gt; 1)</span>
<span class="nc" id="L1421">						totalRaffleAmount = Double.parseDouble(dataArr[1]);</span>
<span class="nc" id="L1422">					raffleData = raffleData + data;</span>
				}
			}
<span class="nc" id="L1425">			raffleData = raffleData + &quot;#&quot; + &quot;|Total Pay:&quot; + totalRaffleAmount</span>
			+ &quot;|&quot;;
<span class="nc bnc" id="L1427" title="All 2 branches missed.">		} else if (mainWinningBean.getPwtTicketType().equalsIgnoreCase(&quot;DRAW&quot;)) {</span>
			// String raffleData=EmbeddedErrors.RAFFLE_DATA;
			// double totalRaffleAmount=0.0;
<span class="nc" id="L1430">			List&lt;PWTDrawBean&gt; pwtWinBeanlist = mainWinningBean</span>
			.getWinningBeanList();
<span class="nc bnc" id="L1432" title="All 2 branches missed.">			for (int k = 0; k &lt; pwtWinBeanlist.size(); k++) {</span>
<span class="nc" id="L1433">				PWTDrawBean pwtWinningBean = pwtWinBeanlist.get(k);</span>
<span class="nc bnc" id="L1434" title="All 2 branches missed.">				if (pwtWinningBean.getPwtTicketType()</span>
						.equalsIgnoreCase(&quot;RAFFLE&quot;)) {
<span class="nc" id="L1436">					List&lt;RaffleDrawIdBean&gt; raffleDrawIdBeanList = pwtWinningBean</span>
					.getRaffleDrawIdBeanList();
<span class="nc bnc" id="L1438" title="All 2 branches missed.">					for (int i = 0; i &lt; raffleDrawIdBeanList.size(); i++) {</span>
<span class="nc bnc" id="L1439" title="All 2 branches missed.">						if (i &gt; 0) {</span>
<span class="nc" id="L1440">							raffleData = raffleData + &quot;;&quot;;</span>
						}
<span class="nc" id="L1442">						RaffleDrawIdBean raffleWinningBean = raffleDrawIdBeanList</span>
						.get(i);
<span class="nc bnc" id="L1444" title="All 2 branches missed.">						if (&quot;FRAUD&quot;.equalsIgnoreCase(raffleWinningBean</span>
								.getStatus())) {
<span class="nc" id="L1446">							raffleData = raffleData + &quot;ErrorMsg:&quot;</span>
							+ EmbeddedErrors.PWT_FRAUD;
<span class="nc bnc" id="L1448" title="All 2 branches missed.">						} else if (&quot;TICKET_EXPIRED&quot;</span>
								.equalsIgnoreCase(raffleWinningBean.getStatus())) {
<span class="nc" id="L1450">							raffleData = raffleData + &quot;ErrorMsg:&quot;</span>
							+ EmbeddedErrors.PWT_TICKET_EXPIRED+&quot;ErrorCode:&quot; + EmbeddedErrors.PWT_TICKET_EXPIRED_ERROR_CODE+&quot;|&quot;;
<span class="nc bnc" id="L1452" title="All 2 branches missed.">						} else if (raffleWinningBean.getStatus().equals(</span>
						&quot;RES_AWAITED&quot;)) {
<span class="nc" id="L1454">							raffleData = raffleData</span>
							+ raffleWinningBean.getDrawDateTime()
							+ &quot;,No:0,Message:Awaited&quot;;
<span class="nc bnc" id="L1457" title="All 4 branches missed.">						} else if (raffleWinningBean.getPwtStatus() != null</span>
								&amp;&amp; raffleWinningBean.getPwtStatus()
								.equalsIgnoreCase(&quot;OUT_VERIFY_LIMIT&quot;)) {
<span class="nc" id="L1460">							raffleData = raffleData + &quot;ErrorMsg:&quot;</span>
							+ EmbeddedErrors.PWT_OUT_VERIFY_LIMIT+&quot;ErrorCode:&quot; + EmbeddedErrors.PWT_OUT_VERIFY_LIMIT_ERROR_CODE+&quot;|&quot;;
<span class="nc bnc" id="L1462" title="All 4 branches missed.">						} else if (raffleWinningBean.getPwtStatus() != null</span>
								&amp;&amp; raffleWinningBean.getPwtStatus().equals(
								&quot;NON_WIN&quot;)) {
<span class="nc" id="L1465">							raffleData = raffleData</span>
							+ raffleWinningBean.getDrawDateTime()
							+ &quot;|TRY AGAIN&quot;;
<span class="nc bnc" id="L1468" title="All 4 branches missed.">						} else if (raffleWinningBean.getPwtStatus() != null</span>
								&amp;&amp; raffleWinningBean.getPwtStatus().equals(
								&quot;NORMAL_PAY&quot;)) {
<span class="nc" id="L1471">							totalRaffleAmount = totalRaffleAmount</span>
							+ Double.parseDouble(raffleWinningBean
									.getWinningAmt());
<span class="nc" id="L1474">							raffleData = EmbeddedErrors.RAFFLE_DATA;</span>
<span class="nc" id="L1475">							raffleData = raffleData</span>
							+ raffleWinningBean.getDrawDateTime()
							+ &quot;*Promotional Draw,No:1,Message:WIN &quot;
							+ raffleWinningBean.getWinningAmt();
<span class="nc bnc" id="L1479" title="All 4 branches missed.">						} else if (raffleWinningBean.getStatus() != null</span>
								&amp;&amp; raffleWinningBean.getStatus().equals(
								&quot;CLAIMED&quot;)) {
<span class="nc" id="L1482">							raffleData = raffleData</span>
							+ raffleWinningBean.getDrawDateTime()
							+ &quot;*Promotional Draw,No:1,Message:CLAIMED&quot;;
<span class="nc bnc" id="L1485" title="All 4 branches missed.">						} else if (raffleWinningBean.getPwtStatus() != null</span>
								&amp;&amp; raffleWinningBean.getPwtStatus().equals(
								&quot;PND_PAY&quot;)) {
<span class="nc" id="L1488">							raffleData = raffleData + &quot;ErrorMsg:&quot;</span>
							+ EmbeddedErrors.PWT_OUT_VERIFY_LIMIT+&quot;ErrorCode:&quot; + EmbeddedErrors.PWT_OUT_VERIFY_LIMIT_ERROR_CODE+&quot;|&quot;;
<span class="nc bnc" id="L1490" title="All 4 branches missed.">						} else if (raffleWinningBean.getPwtStatus() != null</span>
								&amp;&amp; raffleWinningBean.getPwtStatus().equals(
								&quot;HIGH_PRIZE&quot;)) {
<span class="nc" id="L1493">							raffleData = raffleData + &quot;ErrorMsg:&quot;</span>
							+ EmbeddedErrors.PWT_OUT_VERIFY_LIMIT+&quot;ErrorCode:&quot; + EmbeddedErrors.PWT_OUT_VERIFY_LIMIT_ERROR_CODE+&quot;|&quot;;
<span class="nc bnc" id="L1495" title="All 4 branches missed.">						} else if (raffleWinningBean.getPwtStatus() != null</span>
								&amp;&amp; raffleWinningBean.getPwtStatus().equals(
								&quot;OUT_PAY_LIMIT&quot;)) {
<span class="nc" id="L1498">							raffleData = raffleData + &quot;ErrorMsg:&quot;</span>
							+ EmbeddedErrors.PWT_OUT_VERIFY_LIMIT+&quot;ErrorCode:&quot; + EmbeddedErrors.PWT_OUT_VERIFY_LIMIT_ERROR_CODE+&quot;|&quot;;
<span class="nc bnc" id="L1500" title="All 4 branches missed.">						} else if (raffleWinningBean.getPwtStatus() != null</span>
								&amp;&amp; raffleWinningBean.getPwtStatus().equals(
								&quot;OUT_VERIFY_LIMIT&quot;)) {
<span class="nc" id="L1503">							raffleData = raffleData + &quot;ErrorMsg:&quot;</span>
							+ EmbeddedErrors.PWT_OUT_VERIFY_LIMIT+&quot;ErrorCode:&quot; + EmbeddedErrors.PWT_OUT_VERIFY_LIMIT_ERROR_CODE+&quot;|&quot;;
						}
					}
				}
			}
			//raffleData = raffleData + &quot;#&quot;;
			// StringBuilder stBuild = new StringBuilder(&quot;&quot;);
<span class="nc" id="L1511">			double totalClmPndAmt=0.0;</span>
<span class="nc bnc" id="L1512" title="All 2 branches missed.">			for (int k = 0; k &lt; pwtWinBeanlist.size(); k++) {</span>
<span class="nc" id="L1513">				PWTDrawBean pwtWinningBean = pwtWinBeanlist.get(k);</span>
<span class="nc" id="L1514">				govtCommAmt=pwtWinningBean.getGovtTaxAmount();</span>
<span class="nc bnc" id="L1515" title="All 2 branches missed.">				if (pwtWinningBean.getPwtTicketType().equalsIgnoreCase(&quot;DRAW&quot;)) {</span>
<span class="nc" id="L1516">					double totTktAmt = 0.0;</span>
<span class="nc" id="L1517">					int totRegister = 0;</span>
<span class="nc bnc" id="L1518" title="All 2 branches missed.">					if (!pwtWinningBean.isValid()) {</span>
<span class="nc" id="L1519">						stBuild.append(&quot;\nMsg:Invalid Ticket&quot;);</span>
<span class="nc bnc" id="L1520" title="All 2 branches missed.">					} else if (pwtWinningBean.getStatus().equals(&quot;SUCCESS&quot;)) {</span>
<span class="nc bnc" id="L1521" title="All 2 branches missed.">						for (int i = 0; i &lt; pwtWinningBean.getDrawWinList()</span>
<span class="nc" id="L1522">						.size(); i++) {</span>
<span class="nc" id="L1523">							int nonWin = 0;</span>
<span class="nc" id="L1524">							int win = 0;</span>
<span class="nc" id="L1525">							int clm=0;</span>
<span class="nc" id="L1526">							int register = 0;</span>
<span class="nc" id="L1527">							int claim = 0;</span>
<span class="nc" id="L1528">							int outVerify = 0;</span>
<span class="nc" id="L1529">							int pndPay = 0;</span>
<span class="nc" id="L1530">							boolean isExpired= false;</span>
<span class="nc" id="L1531">							boolean isVerPending=false;</span>
<span class="nc" id="L1532">							boolean isClmPending=false;</span>
<span class="nc" id="L1533">							DrawIdBean drawBean = pwtWinningBean</span>
							.getDrawWinList().get(i);
<span class="nc" id="L1535">							String drawStatusForTicket=drawBean.getStatus();</span>
<span class="nc" id="L1536">							String drawTime = drawBean.getDrawDateTime();</span>
<span class="nc" id="L1537">							String gameName = Util.getGameName(pwtWinningBean</span>
									.getGameNo());
<span class="nc" id="L1539">							String[] drawTimeArr = drawTime.split(&quot;\\*&quot;);</span>
<span class="nc bnc" id="L1540" title="All 2 branches missed.">							if (drawTimeArr.length &gt; 1) {</span>
<span class="nc bnc" id="L1541" title="All 4 branches missed.">								if (drawTimeArr[1] == null</span>
										|| &quot;NULL&quot;
										.equalsIgnoreCase(drawTimeArr[1])) {
<span class="nc" id="L1544">									drawTime = drawTimeArr[0];</span>
								}
							}
<span class="nc" id="L1547">							boolean isResAwaited = false;</span>
<span class="nc" id="L1548">							double drawAmt = 0.0;</span>
<span class="nc" id="L1549">							List&lt;PanelIdBean&gt; panelWinList = drawBean</span>
							.getPanelWinList();
<span class="nc bnc" id="L1551" title="All 4 branches missed.">							if (panelWinList != null &amp;&amp; !drawStatusForTicket.equals(&quot;DRAW_EXPIRED&quot;)) {</span>
<span class="nc bnc" id="L1552" title="All 2 branches missed.">								for (int j = 0; j &lt; panelWinList.size(); j++) {</span>
<span class="nc" id="L1553">									PanelIdBean panelBean = panelWinList.get(j);</span>
<span class="nc bnc" id="L1554" title="All 2 branches missed.">									if (panelBean.getStatus().equals(&quot;NON WIN&quot;)) {</span>
<span class="nc" id="L1555">										nonWin++;</span>
<span class="nc bnc" id="L1556" title="All 2 branches missed.">									} else if (panelBean.getStatus().equals(</span>
									&quot;NORMAL_PAY&quot;)) {
<span class="nc" id="L1558">										drawAmt = panelBean.getWinningAmt()</span>
										+ drawAmt;
<span class="nc" id="L1560">										win++;</span>
<span class="nc bnc" id="L1561" title="All 2 branches missed.">									} else if (panelBean.getStatus().equals(</span>
									&quot;CLAIMED&quot;)) {
<span class="nc" id="L1563">										claim++;</span>
<span class="nc bnc" id="L1564" title="All 2 branches missed.">									} else if (panelBean.getStatus().equals(</span>
									&quot;PND_PAY&quot;)) {
<span class="nc" id="L1566">										pndPay++;</span>
<span class="nc bnc" id="L1567" title="All 2 branches missed.">									} else if (panelBean.getStatus().equals(</span>
									&quot;HIGH_PRIZE&quot;)) {
<span class="nc" id="L1569">										register++;</span>
<span class="nc bnc" id="L1570" title="All 2 branches missed.">									} else if (panelBean.getStatus().equals(</span>
									&quot;OUT_PAY_LIMIT&quot;)) {
<span class="nc" id="L1572">										register++;</span>
<span class="nc bnc" id="L1573" title="All 2 branches missed.">									} else if (panelBean.getStatus().equals(</span>
									&quot;OUT_VERIFY_LIMIT&quot;)) {
<span class="nc" id="L1575">										outVerify++;</span>
<span class="nc bnc" id="L1576" title="All 2 branches missed.">									}else if(panelBean.getStatus().equals(&quot;CLAIM_PENDING&quot;)){</span>
<span class="nc" id="L1577">										drawAmt = panelBean.getWinningAmt()+ drawAmt;</span>
<span class="nc" id="L1578">										totalClmPndAmt+=panelBean.getWinningAmt();</span>
<span class="nc" id="L1579">										clm++;</span>
									}
								}
<span class="nc bnc" id="L1582" title="All 2 branches missed.">							}else if(drawStatusForTicket.equals(&quot;DRAW_EXPIRED&quot;)){</span>
<span class="nc" id="L1583">								isExpired=true;</span>
<span class="nc bnc" id="L1584" title="All 2 branches missed.">							}else if(drawStatusForTicket.equals(&quot;VERIFICATION_PENDING&quot;)){</span>
<span class="nc" id="L1585">								isVerPending=true;</span>
<span class="nc bnc" id="L1586" title="All 2 branches missed.">							}else if(drawStatusForTicket.equals(&quot;CLAIM_PENDING&quot;)){</span>
<span class="nc" id="L1587">								isClmPending=true;</span>
							}else{
<span class="nc" id="L1589">								isResAwaited = true;</span>
							}
<span class="nc bnc" id="L1591" title="All 2 branches missed.">							totTktAmt = (drawStatusForTicket.equals(&quot;CLAIM_PENDING&quot;)?0.0:drawAmt-govtCommAmt) + totTktAmt;</span>
<span class="nc bnc" id="L1592" title="All 2 branches missed.">							if(isExpired){</span>
<span class="nc" id="L1593">								stBuild.append(&quot;|DrawTime:&quot; + drawTime + &quot;&quot;);</span>
<span class="nc" id="L1594">								stBuild.append(&quot;,No:0,Message:Draw Expired&quot;);</span>
<span class="nc bnc" id="L1595" title="All 2 branches missed.">							}else if (isVerPending) {</span>
<span class="nc" id="L1596">								stBuild.append(&quot;|DrawTime:&quot; + drawTime + &quot;&quot;);</span>
<span class="nc" id="L1597">								stBuild.append(&quot;,No:0,Message:VER PEND&quot;);</span>
<span class="nc bnc" id="L1598" title="All 2 branches missed.">							}else if (isResAwaited) {</span>
<span class="nc" id="L1599">								stBuild.append(&quot;|DrawTime:&quot; + drawTime + &quot;&quot;);</span>
<span class="nc" id="L1600">								stBuild.append(&quot;,No:0,Message:Awaited&quot;);</span>
							} else {
								/* As per clients' requirement, it's commented to omit the non-win data 
								 *  to reduce the size of ticket and to show only relevant data.
								 */
<span class="nc" id="L1605">								stBuild.append(&quot;|DrawTime:&quot; + drawTime + &quot;&quot;);</span>
<span class="nc bnc" id="L1606" title="All 2 branches missed.">								if (nonWin != 0) {</span>
									//stBuild.append(&quot;,No:&quot; + nonWin + &quot;,Message:TRY AGAIN&quot;);
<span class="nc" id="L1608">									continue;</span>
								}
								
<span class="nc bnc" id="L1611" title="All 2 branches missed.">								if (win != 0) {</span>
									// stBuild.append(&quot;\nDrawTime:&quot; + drawTime +
									// &quot;&quot;);
<span class="nc" id="L1614">									stBuild.append(&quot;,No:&quot; + win + &quot;,Message:WIN &quot;</span>
											+ Util.getBalInString(drawAmt) +&quot;&quot;);
								}
<span class="nc bnc" id="L1617" title="All 2 branches missed.">								if (register != 0) {</span>
									// stBuild.append(&quot;\nDrawTime:&quot; + drawTime +
									// &quot;&quot;);
<span class="nc" id="L1620">									stBuild.append(&quot;,No:&quot; + register</span>
											+ &quot;,Message:REG. REQ.&quot;);
								}
<span class="nc bnc" id="L1623" title="All 2 branches missed.">								if (claim != 0) {</span>
									// stBuild.append(&quot;\nDrawTime:&quot; + drawTime +
									// &quot;&quot;);
<span class="nc" id="L1626">									stBuild.append(&quot;,No:&quot; + claim</span>
											+ &quot;,Message:CLAIMED&quot;);
								}
<span class="nc bnc" id="L1629" title="All 2 branches missed.">								if (pndPay != 0) {</span>
									// stBuild.append(&quot;\nDrawTime:&quot; + drawTime +
									// &quot;&quot;);
<span class="nc" id="L1632">									stBuild.append(&quot;,No:&quot; + pndPay</span>
											+ &quot;,Message:IN PROCESS&quot;);
								}
<span class="nc bnc" id="L1635" title="All 2 branches missed.">								if (outVerify != 0) {</span>
									// stBuild.append(&quot;\nDrawTime:&quot; + drawTime +
									// &quot;&quot;);
<span class="nc" id="L1638">									stBuild.append(&quot;,No:&quot; + outVerify</span>
											+ &quot;,Message:OUT OF VERIFY&quot;);
								}
<span class="nc bnc" id="L1641" title="All 2 branches missed.">								if(clm!=0){</span>
<span class="nc" id="L1642">									stBuild.append(&quot;,No:&quot; + clm</span>
											+ &quot;,Message:CLM PND &quot;+ Util.getBalInString(drawAmt-govtCommAmt));
								}
							}
<span class="nc" id="L1646">							totRegister = totRegister + register;</span>
						}
<span class="nc bnc" id="L1648" title="All 2 branches missed.">					} else if (pwtWinningBean.getStatus().equals(&quot;ERROR&quot;)) {</span>
<span class="nc" id="L1649">						finalPwtData = &quot;ErrorMsg:&quot; + EmbeddedErrors.PWT_ERROR+&quot;ErrorCode:&quot; + EmbeddedErrors.PWT_ERROR_CODE+&quot;|&quot;;</span>
<span class="nc" id="L1650">						logger.debug(&quot;FINAL PWT DATA:&quot; + finalPwtData);</span>
<span class="nc" id="L1651">						response.getOutputStream().write(</span>
								finalPwtData.getBytes());
<span class="nc" id="L1653">						return;</span>
					}
<span class="nc" id="L1655">					totTktAmt = totTktAmt + totalRaffleAmount;</span>
 
<span class="nc" id="L1657">					stBuild.append(&quot;|Total Pay:&quot; + Util.getBalInString(totTktAmt) + &quot;|&quot;);</span>
<span class="nc bnc" id="L1658" title="All 2 branches missed.">					if(totalClmPndAmt&gt;0)</span>
<span class="nc" id="L1659">						stBuild.append(&quot;Total CLM PEND:&quot; + Util.getBalInString(totalClmPndAmt-govtCommAmt) + &quot;|&quot;);</span>
					else
<span class="nc" id="L1661">						stBuild.append(&quot;Total CLM PEND:&quot; + Util. getBalInString(totalClmPndAmt) + &quot;|&quot;);</span>
<span class="nc bnc" id="L1662" title="All 2 branches missed.">					if (totRegister != 0) {</span>
<span class="nc" id="L1663">						stBuild.append(&quot;No:&quot; + totRegister</span>
								+ &quot;,Message:Reg. Req&quot;);
					}
					// session.setAttribute(&quot;PWT_RES&quot;, pwtWinningBean);
<span class="nc" id="L1667">					currentUserSessionMap.put(userName, session);</span>
					/*
					 * logger.debug(&quot; STRING BUILER is before reprint &quot; +
					 * stBuild);
					 * logger.debug(&quot;--------------------------GAME NUMBER &quot;
					 * + pwtWinningBean.getGameNo());
					 */
				}
			}
		}
<span class="nc" id="L1677">		AjaxRequestHelper ajxHelper2 = new AjaxRequestHelper();</span>
<span class="nc" id="L1678">		ajxHelper2.getAvlblCreditAmt(userInfoBean);</span>
<span class="nc" id="L1679">		double bal2 = userInfoBean.getAvailableCreditLimit()</span>
		- userInfoBean.getClaimableBal();
<span class="nc" id="L1681">		double bal = bal2 - bal1;</span>
<span class="nc" id="L1682">		NumberFormat nFormat = NumberFormat.getInstance();</span>
<span class="nc" id="L1683">		nFormat.setMinimumFractionDigits(2);</span>
<span class="nc" id="L1684">		String balance =  nFormat.format(bal).replace(&quot;,&quot;, &quot;&quot;);</span>
<span class="nc" id="L1685">		boolean isPromoPrint = false;</span>
<span class="nc bnc" id="L1686" title="All 2 branches missed.">		if (mainWinningBean.isReprint()) {</span>
<span class="nc" id="L1687">			isPromoPrint = true;</span>
<span class="nc" id="L1688">			Object Purchasebean = mainWinningBean.getPurchaseBean();</span>
<span class="nc bnc" id="L1689" title="All 2 branches missed.">			if (Purchasebean instanceof FortunePurchaseBean) {</span>
<span class="nc" id="L1690">				int gamenbr = helper.getGamenoFromTktnumber(mainWinningBean</span>
						.getTicketNo());
<span class="nc" id="L1692">				String gameName = Util.getGameName(gamenbr);</span>
<span class="nc" id="L1693">				FortunePurchaseBean bean = (FortunePurchaseBean) mainWinningBean</span>
				.getPurchaseBean();
<span class="nc" id="L1695">				stBuild.append(promoTicketDta + &quot;RPRT:&quot;</span>
						+ ReprintHepler.reprintFortuneTicket(bean, gameName));
<span class="nc" id="L1697">				String raffleDataRPRT = CommonMethods.buildRaffleData(bean</span>
						.getRafflePurchaseBeanList());
<span class="nc" id="L1699">				finalPwtData = raffleData + stBuild.toString() + &quot;|Amt:&quot;</span>
				+ balance + &quot;|QP:&quot; + bean.getIsQuickPick()[0] + &quot;|&quot;
				+ raffleDataRPRT;
<span class="nc bnc" id="L1702" title="All 2 branches missed.">			} else if (Purchasebean instanceof LottoPurchaseBean) {</span>
<span class="nc" id="L1703">				int gamenbr = helper.getGamenoFromTktnumber(mainWinningBean</span>
						.getTicketNo());
<span class="nc" id="L1705">				String gameName = Util.getGameName(gamenbr);</span>
<span class="nc" id="L1706">				LottoPurchaseBean bean = (LottoPurchaseBean) mainWinningBean</span>
				.getPurchaseBean();
<span class="nc" id="L1708">				stBuild.append(promoTicketDta + &quot;RPRT:&quot;</span>
						+ ReprintHepler.reprintLottoTicket(bean, gameName));
<span class="nc" id="L1710">				String raffleDataRPRT = CommonMethods.buildRaffleData(bean</span>
						.getRafflePurchaseBeanList());
<span class="nc" id="L1712">				finalPwtData = raffleData + stBuild.toString() + &quot;|Amt:&quot;</span>
				+ balance + &quot;|QP:&quot; + bean.getIsQuickPick()[0] + &quot;|&quot;
				+ raffleDataRPRT;
<span class="nc bnc" id="L1715" title="All 2 branches missed.">			} else if (Purchasebean instanceof KenoPurchaseBean) {</span>
<span class="nc" id="L1716">				int gamenbr = helper.getGamenoFromTktnumber(mainWinningBean</span>
						.getTicketNo());
<span class="nc" id="L1718">				String gameName = Util.getGameName(gamenbr);</span>
<span class="nc" id="L1719">				KenoPurchaseBean bean = (KenoPurchaseBean) mainWinningBean</span>
				.getPurchaseBean();
<span class="nc" id="L1721">				stBuild.append(promoTicketDta + &quot;RPRT:&quot;</span>
						+ ReprintHepler.reprintKenoTicket(bean, gameName,userInfoBean.getTerminalBuildVersion(),countryDeployed));
<span class="nc" id="L1723">				String raffleDataRPRT = CommonMethods.buildRaffleData(bean</span>
						.getRafflePurchaseBeanList());
<span class="nc" id="L1725">				finalPwtData = raffleData + stBuild.toString() + &quot;|Amt:&quot;</span>
				+ balance + &quot;|QP:&quot; + bean.getIsQuickPick()[0] + &quot;|&quot;
				+ raffleDataRPRT;
<span class="nc bnc" id="L1728" title="All 2 branches missed.">			} else if (Purchasebean instanceof FortuneTwoPurchaseBean) {</span>
<span class="nc" id="L1729">				int gameNbr = helper.getGamenoFromTktnumber(mainWinningBean</span>
						.getTicketNo());
<span class="nc" id="L1731">				String gameName = Util.getGameName(gameNbr);</span>
<span class="nc" id="L1732">				FortuneTwoPurchaseBean bean = (FortuneTwoPurchaseBean) mainWinningBean</span>
				.getPurchaseBean();
<span class="nc" id="L1734">				stBuild</span>
				.append(promoTicketDta + &quot;RPRT:&quot;
						+ ReprintHepler.reprintFortuneTwoTicket(bean,
								gameName));
<span class="nc" id="L1738">				String raffleDataRPRT = CommonMethods.buildRaffleData(bean</span>
						.getRafflePurchaseBeanList());
<span class="nc" id="L1740">				finalPwtData = raffleData + stBuild.toString() + &quot;|Amt:&quot;</span>
				+ balance + &quot;|QP:&quot; + bean.getIsQuickPick()[0] + &quot;|&quot;
				+ raffleDataRPRT;
<span class="nc bnc" id="L1743" title="All 2 branches missed.">			}else if (Purchasebean instanceof FortuneThreePurchaseBean) {</span>
<span class="nc" id="L1744">				int gameNbr = helper.getGamenoFromTktnumber(mainWinningBean</span>
						.getTicketNo());
<span class="nc" id="L1746">				String gameName = Util.getGameName(gameNbr);</span>
<span class="nc" id="L1747">				FortuneThreePurchaseBean bean = (FortuneThreePurchaseBean) mainWinningBean</span>
				.getPurchaseBean();
<span class="nc" id="L1749">				stBuild</span>
				.append(promoTicketDta + &quot;RPRT:&quot;
						+ ReprintHepler.reprintFortuneThreeTicket(bean,
								gameName));
<span class="nc" id="L1753">				String raffleDataRPRT = CommonMethods.buildRaffleData(bean</span>
						.getRafflePurchaseBeanList());
<span class="nc" id="L1755">				finalPwtData = raffleData + stBuild.toString() + &quot;|Amt:&quot;</span>
				+ balance + &quot;|QP:&quot; + bean.getIsQuickPick()[0] + &quot;|&quot;
				+ raffleDataRPRT;
			}
<span class="nc" id="L1759">		} else {</span>
<span class="nc" id="L1760">			finalPwtData = raffleData + stBuild.toString() + &quot;Amt:&quot; + balance</span>
			+ &quot;|&quot;;
		}
		//Mobile No:1111213132|Ref No:123135458|     to be added ...
<span class="nc" id="L1764">		StringBuilder topMsgsStr = new StringBuilder(&quot;&quot;);</span>
<span class="nc" id="L1765">		StringBuilder bottomMsgsStr = new StringBuilder(&quot;&quot;);</span>
<span class="nc" id="L1766">		String advtMsg = &quot;&quot;;</span>
<span class="nc" id="L1767">		UtilApplet.getAdvMsgs(mainWinningBean.getAdvMsg(), topMsgsStr,</span>
				bottomMsgsStr, 10);
<span class="nc bnc" id="L1769" title="All 2 branches missed.">		if (topMsgsStr.length() != 0) {</span>
<span class="nc" id="L1770">			advtMsg = &quot;topAdvMsg:&quot; + topMsgsStr + &quot;|&quot;;</span>
		}
<span class="nc bnc" id="L1772" title="All 2 branches missed.">		if (bottomMsgsStr.length() != 0) {</span>
<span class="nc" id="L1773">			advtMsg = advtMsg + &quot;bottomAdvMsg:&quot; + bottomMsgsStr + &quot;|&quot;;</span>
		}
<span class="nc bnc" id="L1775" title="All 2 branches missed.">		finalPwtData = finalPwtData + advtMsg + ((isPromoPrint)?&quot;&quot;:promoTicketDta);</span>
<span class="nc bnc" id="L1776" title="All 2 branches missed.">		if(govtCommAmt&gt;0)</span>
<span class="nc" id="L1777">			finalPwtData=finalPwtData+&quot;Tax:&quot;+Util.getBalInString(govtCommAmt)+&quot;|&quot;;</span>
<span class="nc bnc" id="L1778" title="All 2 branches missed.">		if(!&quot;|DrawTime:&quot;.equalsIgnoreCase(finalPwtData.substring(0,10)))</span>
<span class="nc" id="L1779">			finalPwtData=&quot;|DrawTime:&quot;+finalPwtData;</span>
<span class="nc" id="L1780">		logger.debug(&quot;FINAL PWT DATA:&quot; + finalPwtData);</span>
<span class="nc" id="L1781">		response.getOutputStream().write(finalPwtData.getBytes());</span>
<span class="nc" id="L1782">		return;</span>
	}
	public String buildPWTRaffleData(RaffleDrawIdBean raffleWinningBean) {
		// RaffleDrawIdBean
		// raffleWinningBean=(RaffleDrawIdBean)pwtWinningBean.getRaffleDrawIdBeanList().get(0);
<span class="nc" id="L1787">		double totalRaffleAmount = 0.0;</span>
<span class="nc bnc" id="L1788" title="All 2 branches missed.">		if (&quot;FRAUD&quot;.equalsIgnoreCase(raffleWinningBean.getStatus())) {</span>
<span class="nc" id="L1789">			return &quot;ErrorMsg:&quot; + EmbeddedErrors.PWT_FRAUD+&quot;ErrorCode:&quot; + EmbeddedErrors.PWT_FRAUD_ERROR_CODE+&quot;|&quot;;</span>
<span class="nc bnc" id="L1790" title="All 2 branches missed.">		} else if (&quot;TICKET_EXPIRED&quot;.equalsIgnoreCase(raffleWinningBean</span>
				.getStatus())) {
<span class="nc" id="L1792">			return &quot;ErrorMsg:&quot; + EmbeddedErrors.PWT_TICKET_EXPIRED+&quot;ErrorCode:&quot; + EmbeddedErrors.PWT_TICKET_EXPIRED_ERROR_CODE+&quot;|&quot;;</span>
<span class="nc bnc" id="L1793" title="All 2 branches missed.">		} else if (raffleWinningBean.getStatus().equals(&quot;RES_AWAITED&quot;)) {</span>
<span class="nc" id="L1794">			return raffleWinningBean.getDrawDateTime() + &quot;|Awaited&quot;;</span>
<span class="nc bnc" id="L1795" title="All 4 branches missed.">		} else if (raffleWinningBean.getPwtStatus() != null</span>
				&amp;&amp; raffleWinningBean.getPwtStatus().equalsIgnoreCase(
				&quot;OUT_VERIFY_LIMIT&quot;)) {
<span class="nc" id="L1798">			return &quot;ErrorMsg:&quot; + EmbeddedErrors.PWT_OUT_VERIFY_LIMIT+&quot;ErrorCode:&quot; + EmbeddedErrors.PWT_OUT_VERIFY_LIMIT_ERROR_CODE+&quot;|&quot;;</span>
<span class="nc bnc" id="L1799" title="All 4 branches missed.">		} else if (raffleWinningBean.getStatus() != null</span>
				&amp;&amp; raffleWinningBean.getStatus().equals(&quot;NON_WIN&quot;)) {
<span class="nc" id="L1801">			return raffleWinningBean.getDrawDateTime() + &quot;|TRY AGAIN&quot;;</span>
<span class="nc bnc" id="L1802" title="All 4 branches missed.">		} else if (raffleWinningBean.getPwtStatus() != null</span>
				&amp;&amp; raffleWinningBean.getPwtStatus().equals(&quot;NORMAL_PAY&quot;)) {
<span class="nc" id="L1804">			totalRaffleAmount = totalRaffleAmount</span>
			+ Double.parseDouble(raffleWinningBean.getWinningAmt());
<span class="nc" id="L1806">			return raffleWinningBean.getDrawDateTime() + &quot;|WIN &quot;</span>
			+ raffleWinningBean.getWinningAmt() + &quot;&quot; + &quot;RWA&quot;
			+ totalRaffleAmount;
<span class="nc bnc" id="L1809" title="All 4 branches missed.">		} else if (raffleWinningBean.getStatus() != null</span>
				&amp;&amp; raffleWinningBean.getStatus().equals(&quot;CLAIMED&quot;)) {
<span class="nc" id="L1811">			return raffleWinningBean.getDrawDateTime() + &quot;|CLAIMED&quot;;</span>
<span class="nc bnc" id="L1812" title="All 4 branches missed.">		} else if (raffleWinningBean.getPwtStatus() != null</span>
				&amp;&amp; raffleWinningBean.getPwtStatus().equals(&quot;PND_PAY&quot;)) {
<span class="nc" id="L1814">			return &quot;ErrorMsg:&quot; + EmbeddedErrors.PWT_OUT_VERIFY_LIMIT+&quot;ErrorCode:&quot; + EmbeddedErrors.PWT_OUT_VERIFY_LIMIT_ERROR_CODE+&quot;|&quot;;</span>
<span class="nc bnc" id="L1815" title="All 4 branches missed.">		} else if (raffleWinningBean.getPwtStatus() != null</span>
				&amp;&amp; raffleWinningBean.getPwtStatus().equals(&quot;HIGH_PRIZE&quot;)) {
<span class="nc" id="L1817">			return &quot;ErrorMsg:&quot; + EmbeddedErrors.PWT_OUT_VERIFY_LIMIT+&quot;ErrorCode:&quot; + EmbeddedErrors.PWT_OUT_VERIFY_LIMIT_ERROR_CODE+&quot;|&quot;;</span>
<span class="nc bnc" id="L1818" title="All 4 branches missed.">		} else if (raffleWinningBean.getPwtStatus() != null</span>
				&amp;&amp; raffleWinningBean.getPwtStatus().equals(&quot;OUT_PAY_LIMIT&quot;)) {
<span class="nc" id="L1820">			return &quot;ErrorMsg:&quot; + EmbeddedErrors.PWT_OUT_VERIFY_LIMIT+&quot;ErrorCode:&quot; + EmbeddedErrors.PWT_OUT_VERIFY_LIMIT_ERROR_CODE+&quot;|&quot;;</span>
<span class="nc bnc" id="L1821" title="All 4 branches missed.">		} else if (raffleWinningBean.getPwtStatus() != null</span>
				&amp;&amp; raffleWinningBean.getPwtStatus().equals(&quot;OUT_VERIFY_LIMIT&quot;)) {
<span class="nc" id="L1823">			return &quot;ErrorMsg:&quot; + EmbeddedErrors.PWT_OUT_VERIFY_LIMIT+&quot;ErrorCode:&quot; + EmbeddedErrors.PWT_OUT_VERIFY_LIMIT_ERROR_CODE+&quot;|&quot;;</span>
		}
<span class="nc" id="L1825">		return &quot;&quot;;</span>
	}

	public void reprintTicket() throws Exception {
		try{
<span class="fc" id="L1830">			servletContext = ServletActionContext.getServletContext();</span>
<span class="fc" id="L1831">			isDrawAvailable = (String) servletContext.getAttribute(&quot;IS_DRAW&quot;);</span>
<span class="fc" id="L1832">			response.setCharacterEncoding(&quot;UTF-8&quot;);</span>
<span class="fc" id="L1833">			response.setContentType(&quot;text/html&quot;);</span>
<span class="fc bfc" id="L1834" title="All 2 branches covered.">			if (&quot;NO&quot;.equalsIgnoreCase(isDrawAvailable)) {</span>
<span class="fc" id="L1835">				reprintIfDrawNotAvailable();</span>
			} else{
<span class="fc" id="L1837">				reprintIfDrawAvailable(servletContext);</span>
			}
<span class="fc" id="L1839">			logger.debug(&quot;FINAL REPRINT DATA:&quot; + finalReprintData);</span>
<span class="fc" id="L1840">		}catch(Exception e){</span>
<span class="fc" id="L1841">			logger.error(&quot;Error Occurred:&quot;, e);</span>
<span class="fc" id="L1842">			finalReprintData = &quot;ErrorMsg:&quot; + EmbeddedErrors.REPRINT_FAIL+&quot;ErrorCode:&quot; + EmbeddedErrors.REPRINT_FAIL_ERROR_CODE+&quot;|&quot;;</span>
<span class="fc" id="L1843">		}</span>
<span class="fc" id="L1844">		response.getOutputStream().write(finalReprintData.getBytes());</span>
<span class="fc" id="L1845">	}</span>

	private void reprintIfDrawNotAvailable() throws IOException {
<span class="fc" id="L1848">		finalReprintData = &quot;ErrorMsg:&quot; + EmbeddedErrors.DRAW_GAME_NOT_AVAILABLE+&quot;ErrorCode:&quot; + EmbeddedErrors.DRAW_GAME_NOT_AVAILABLE_ERROR_CODE+&quot;|&quot;;</span>
<span class="fc" id="L1849">	}</span>
	
	private void reprintIfDrawAvailable(ServletContext servletContext) {
		try{
<span class="fc" id="L1853">			getRequiredParametersForReprint(servletContext);</span>
<span class="fc" id="L1854">			rposHelper.checkLastPrintedTicketStatusAndUpdate(userInfoBean,lastPrintedTicket,&quot;TERMINAL&quot;,refernceMerchantId,autoCancelHoldDays,actionName, gameId);</span>
<span class="fc" id="L1855">			gameBean = rposHelper.reprintTicket(userInfoBean, false, null,true,null,&quot;TERMINAL&quot;);</span>
<span class="fc" id="L1856">			gameBeanType = gameBean.getClass().getSimpleName();</span>
<span class="fc" id="L1857">			setUserBalance();</span>
<span class="fc" id="L1858">			prepareEmbeddedReprintBean();</span>
<span class="fc" id="L1859">			fetchFinalReprintData();</span>
<span class="fc" id="L1860">		} catch(LMSException l){</span>
<span class="fc" id="L1861">			finalReprintData = &quot;ErrorMsg:&quot; + EmbeddedErrors.REPRINT_FAIL+&quot;ErrorCode:&quot; + EmbeddedErrors.REPRINT_FAIL_ERROR_CODE+&quot;|&quot;;</span>
<span class="fc" id="L1862">		} catch(Exception e){</span>
<span class="fc" id="L1863">			logger.error(&quot;Error Occurred:&quot;, e);</span>
<span class="fc" id="L1864">			finalReprintData = &quot;ErrorMsg:&quot; + EmbeddedErrors.REPRINT_FAIL+&quot;ErrorCode:&quot; + EmbeddedErrors.REPRINT_FAIL_ERROR_CODE+&quot;|&quot;;</span>
<span class="fc" id="L1865">		}</span>
<span class="fc" id="L1866">	}</span>
	
	private void getRequiredParametersForReprint(ServletContext servletContext) {
<span class="fc" id="L1869">		countryDeployed = (String)servletContext.getAttribute(&quot;COUNTRY_DEPLOYED&quot;);</span>
<span class="fc" id="L1870">		currentUserSessionMap = (Map)servletContext.getAttribute(&quot;LOGGED_IN_USERS&quot;);</span>
<span class="fc" id="L1871">		session = (HttpSession)currentUserSessionMap.get(userName);</span>
<span class="fc" id="L1872">		userInfoBean = (UserInfoBean)session.getAttribute(&quot;USER_INFO&quot;);</span>
<span class="fc" id="L1873">		refernceMerchantId = (String) servletContext.getAttribute(&quot;REF_MERCHANT_ID&quot;);</span>
<span class="fc" id="L1874">		autoCancelHoldDays = Integer.parseInt((String) servletContext.getAttribute(&quot;AUTO_CANCEL_CLOSER_DAYS&quot;));</span>
<span class="fc bfc" id="L1875" title="All 2 branches covered.">		if(LSTktNo != 0){</span>
<span class="fc" id="L1876">			lastPrintedTicket = LSTktNo/Util.getDivValueForLastSoldTkt(String.valueOf(LSTktNo).length());</span>
<span class="fc" id="L1877">			gameId = Util.getGameIdFromGameNumber(Util.getGamenoFromTktnumber(String.valueOf(LSTktNo)));</span>
		}
<span class="fc" id="L1879">		actionName = ActionContext.getContext().getName();</span>
<span class="fc" id="L1880">	}</span>

	private void setUserBalance() {
<span class="fc" id="L1883">		userBalance = userInfoBean.getAvailableCreditLimit() - userInfoBean.getClaimableBal();</span>
<span class="fc" id="L1884">		numberFormat = NumberFormat.getInstance();</span>
<span class="fc" id="L1885">		numberFormat.setMinimumFractionDigits(2);</span>
<span class="fc" id="L1886">		balance =  numberFormat.format(userBalance).replace(&quot;,&quot;, &quot;&quot;);</span>
<span class="fc" id="L1887">	}</span>

	private void prepareEmbeddedReprintBean() {
<span class="fc" id="L1890">		embeddedReprint = new EmbeddedReprint();</span>
<span class="fc" id="L1891">		embeddedReprint.setBalance(balance);</span>
<span class="fc" id="L1892">		embeddedReprint.setCountryDeployed(countryDeployed);</span>
<span class="fc" id="L1893">		embeddedReprint.setGameBean(gameBean);</span>
<span class="fc" id="L1894">		embeddedReprint.setUserInfoBean(userInfoBean);</span>
<span class="fc bfc" id="L1895" title="All 2 branches covered.">		if(&quot;KenoPurchaseBean&quot;.equalsIgnoreCase(gameBeanType)){</span>
<span class="fc" id="L1896">			embeddedReprint.setRaffleDrawDay((String) servletContext.getAttribute(&quot;RAFFLE_GAME_DRAW_DAY&quot;));</span>
<span class="fc" id="L1897">			embeddedReprint.setRaffleGameDataString((String) servletContext.getAttribute(&quot;RAFFLE_GAME_DATA&quot;));</span>
		}
<span class="fc" id="L1899">	}</span>

	private void fetchFinalReprintData() {
<span class="fc" id="L1902">		ReprintContext reprintContext = null;</span>
		try{
<span class="fc" id="L1904">			reprintContext = reprintFactory.fetchReprintGameTypeInstance(gameBeanType);</span>
<span class="fc" id="L1905">			finalReprintData = reprintContext.reprintTicket(embeddedReprint);</span>
<span class="fc" id="L1906">		}catch(LMSException l){</span>
<span class="fc" id="L1907">			finalReprintData = &quot;ErrorMsg:&quot; + l.getErrorMessage()+&quot;ErrorCode:&quot; + l.getErrorCode()+&quot;|&quot;;</span>
<span class="fc" id="L1908">		}</span>
<span class="fc" id="L1909">	}</span>

	
	public String buildPromoReprintData(Object PromoPurchaseBean,UserInfoBean userInfoBean,String countryDeployed)
	throws Exception {
		
<span class="nc bnc" id="L1915" title="All 2 branches missed.">			if (PromoPurchaseBean instanceof FortunePurchaseBean) {</span>
<span class="nc" id="L1916">				FortunePurchaseBean fortunePurchaseBean = (FortunePurchaseBean) PromoPurchaseBean;</span>
<span class="nc" id="L1917">				String promoGameName = Util.getGameName(fortunePurchaseBean</span>
						.getGame_no());
<span class="nc" id="L1919">				return &quot;PromoTkt:&quot;</span>
				+ ReprintHepler.reprintFortuneTicket(fortunePurchaseBean,
						promoGameName) + &quot;QP:&quot;
						+ fortunePurchaseBean.getIsQuickPick()[0] + &quot;|&quot;;
<span class="nc bnc" id="L1923" title="All 2 branches missed.">			} else if (PromoPurchaseBean instanceof LottoPurchaseBean) {</span>
<span class="nc" id="L1924">				LottoPurchaseBean lottoPurchaseBean = (LottoPurchaseBean) PromoPurchaseBean;</span>
<span class="nc" id="L1925">				String promoGameName = Util.getGameName(lottoPurchaseBean</span>
						.getGame_no());
<span class="nc" id="L1927">				return &quot;PromoTkt:&quot;</span>
				+ ReprintHepler.reprintLottoTicket(lottoPurchaseBean,
						promoGameName) + &quot;QP:&quot;
						+ lottoPurchaseBean.getIsQuickPick()[0] + &quot;|&quot;;
<span class="nc bnc" id="L1931" title="All 2 branches missed.">			} else if (PromoPurchaseBean instanceof KenoPurchaseBean) {</span>
<span class="nc" id="L1932">				KenoPurchaseBean kenoPurchaseBean = (KenoPurchaseBean) PromoPurchaseBean;</span>
<span class="nc" id="L1933">				String promoGameName = Util.getGameName(kenoPurchaseBean</span>
						.getGame_no());
<span class="nc" id="L1935">				return &quot;PromoTkt:&quot;</span>
				+ ReprintHepler.reprintKenoTicket(kenoPurchaseBean,
						promoGameName,userInfoBean.getTerminalBuildVersion(),countryDeployed) + &quot;QP:&quot;
						+ kenoPurchaseBean.getIsQuickPick()[0] + &quot;|&quot;;
<span class="nc bnc" id="L1939" title="All 2 branches missed.">			} else if (PromoPurchaseBean instanceof FortuneTwoPurchaseBean) {</span>
<span class="nc" id="L1940">				FortuneTwoPurchaseBean fortuneTwoPurchaseBean = (FortuneTwoPurchaseBean) PromoPurchaseBean;</span>
<span class="nc" id="L1941">				String promoGameName = Util.getGameName(fortuneTwoPurchaseBean</span>
						.getGame_no());
<span class="nc" id="L1943">				return &quot;PromoTkt:&quot;</span>
				+ ReprintHepler.reprintFortuneTwoTicket(
						fortuneTwoPurchaseBean, promoGameName) + &quot;QP:&quot;
						+ fortuneTwoPurchaseBean.getIsQuickPick()[0] + &quot;|&quot;;
<span class="nc bnc" id="L1947" title="All 2 branches missed.">			} else if (PromoPurchaseBean instanceof FortuneThreePurchaseBean) {</span>
<span class="nc" id="L1948">				FortuneThreePurchaseBean fortuneThreePurchaseBean = (FortuneThreePurchaseBean) PromoPurchaseBean;</span>
<span class="nc" id="L1949">				String promoGameName = Util.getGameName(fortuneThreePurchaseBean</span>
						.getGame_no());
<span class="nc" id="L1951">				return &quot;PromoTkt:&quot;</span>
				+ ReprintHepler.reprintFortuneThreeTicket(
						fortuneThreePurchaseBean, promoGameName) + &quot;QP:&quot;
						+ fortuneThreePurchaseBean.getIsQuickPick()[0] + &quot;|&quot;;
<span class="nc bnc" id="L1955" title="All 2 branches missed.">			} else if (PromoPurchaseBean instanceof List) {</span>
<span class="nc" id="L1956">				List&lt;RafflePurchaseBean&gt; rafflePurchaseBeanList = (List&lt;RafflePurchaseBean&gt;) PromoPurchaseBean;</span>
<span class="nc" id="L1957">				return CommonMethods.buildRaffleData(rafflePurchaseBeanList);</span>
			}
<span class="nc" id="L1959">			return &quot;&quot;;</span>
		}
	
		public void fetchUnsoldTkts(){
<span class="nc" id="L1963">			DrawGameRPOSHelper helper = new DrawGameRPOSHelper();</span>
<span class="nc" id="L1964">			helper.getUnsoldTkts(gameNo, startDate, endDate);</span>
<span class="nc" id="L1965">		}</span>
	/**
	 * This Method fetch Game Info for terminal version greater or equal to 9.5
	 *@param version Terminal Version
	 * @author Neeraj Jain
	 * @return Response Success/ErrorMsg
	 */
		public void	fetchLoginDrawGameData(){
		
			try {
				
<span class="nc" id="L1976">				logger.debug(&quot;--------In  Fetch Login Draw Game Data Action for EMBEDDED--------&quot;);</span>
<span class="nc" id="L1977">				logger.debug(&quot; userName:&quot;+userName+&quot;Version:&quot;+version);</span>
<span class="nc" id="L1978">				ServletContext sc = ServletActionContext.getServletContext();</span>
<span class="nc" id="L1979">				Map currentUserSessionMap = (Map) sc.getAttribute(&quot;LOGGED_IN_USERS&quot;);</span>
<span class="nc bnc" id="L1980" title="All 2 branches missed.">				if (currentUserSessionMap == null) {</span>
					try {
<span class="nc" id="L1982">						response</span>
						.getOutputStream()
						.write(
								(&quot;ErrorMsg:&quot; + EmbeddedErrors.SESSION_EXPIRED+&quot;ErrorCode:&quot;+EmbeddedErrors.SESSION_EXPIRED_ERROR_CODE+&quot;|&quot;)
								.getBytes());
<span class="nc" id="L1987">						return;</span>
<span class="nc" id="L1988">					} catch (IOException e) {</span>
<span class="nc" id="L1989">						e.printStackTrace();</span>
					}
				}
<span class="nc" id="L1992">				HttpSession session = (HttpSession) currentUserSessionMap.get(userName);</span>
<span class="nc bnc" id="L1993" title="All 2 branches missed.">				if (!CommonFunctionsHelper.isSessionValid(session)) {</span>
<span class="nc" id="L1994">					response.getOutputStream().write(</span>
									(&quot;ErrorMsg:&quot; + EmbeddedErrors.SESSION_EXPIRED+&quot;ErrorCode:&quot;+EmbeddedErrors.SESSION_EXPIRED_ERROR_CODE+&quot;|&quot;)
											.getBytes());
<span class="nc" id="L1997">					return;</span>
				}
<span class="nc" id="L1999">				UserInfoBean userInfoBean = (UserInfoBean) session.getAttribute(&quot;USER_INFO&quot;);</span>
<span class="nc" id="L2000">				String refMerchantId = (String) sc.getAttribute(&quot;REF_MERCHANT_ID&quot;);</span>
<span class="nc" id="L2001">				int autoCancelHoldDays=Integer.parseInt((String) sc.getAttribute(&quot;AUTO_CANCEL_CLOSER_DAYS&quot;));</span>
<span class="nc" id="L2002">				long lastPrintedTicket=0;</span>
<span class="nc" id="L2003">				int gameId = 0;</span>
<span class="nc bnc" id="L2004" title="All 2 branches missed.">				if(LSTktNo !=0){</span>
<span class="nc" id="L2005">					lastPrintedTicket = LSTktNo/Util.getDivValueForLastSoldTkt(String.valueOf(LSTktNo).length());</span>
<span class="nc" id="L2006">					gameId = Util.getGameIdFromGameNumber(Util.getGamenoFromTktnumber(String.valueOf(LSTktNo)));</span>
				}
<span class="nc" id="L2008">				double minTerminalVersion = Double.parseDouble( (String) sc.getAttribute(&quot;MIN_TERMINAL_VERSION&quot;));</span>
<span class="nc" id="L2009">				String actionName=ActionContext.getContext().getName();</span>
<span class="nc" id="L2010">				DrawGameRPOSHelper drawGameRPOSHelper = new DrawGameRPOSHelper();</span>
<span class="nc" id="L2011">				drawGameRPOSHelper.checkLastPrintedTicketStatusAndUpdate(userInfoBean,lastPrintedTicket,&quot;TERMINAL&quot;,refMerchantId,autoCancelHoldDays,actionName,gameId);</span>
<span class="nc" id="L2012">				boolean isOfflineUser = false;</span>
<span class="nc bnc" id="L2013" title="All 2 branches missed.">				if(version &lt; minTerminalVersion){</span>
<span class="nc" id="L2014">					response.getOutputStream().write((&quot;ErrorMsg:&quot; + &quot;Please upgrade the terminal version&quot;).getBytes());</span>
				}
				else{
<span class="nc" id="L2017">					String gameInfo = &quot;GameInfo:&quot;+ DrawGameRPOSHelper.embdDgData(isOfflineUser,</span>
								(Map&lt;Integer, Map&lt;Integer, String&gt;&gt;) sc.getAttribute(&quot;drawIdTableMap&quot;),
								userInfoBean.getUserId(), userInfoBean.getUserOrgId(), version);
<span class="nc" id="L2020">					String drawLimit = Utility.getPropertyValue(&quot;DRAW_LIMIT&quot;);</span>
<span class="nc" id="L2021">					gameInfo += &quot;|drawLimit:&quot;+drawLimit;</span>
<span class="nc bnc" id="L2022" title="All 2 branches missed.">					if(&quot;NO_ENTRY&quot;.equalsIgnoreCase(gameInfo.substring(gameInfo.indexOf(&quot;:&quot;)+1))) </span>
					{
<span class="nc" id="L2024">						response.getOutputStream().write((&quot;ErrorMsg:&quot; + &quot;Please upgrade the terminal version&quot;).getBytes());</span>
					}
					else
					{
<span class="nc" id="L2028">						response.getOutputStream().write((gameInfo).getBytes());</span>
					}
				}
				
				
			}
<span class="nc" id="L2034">			catch(Exception e){			</span>
<span class="nc" id="L2035">				e.printStackTrace();</span>
				try {
<span class="nc" id="L2037">					response.getOutputStream().write((&quot;ErrorMsg: &quot;+EmbeddedErrors.PURCHSE_INVALID_DATA+&quot;ErrorCode:&quot;+EmbeddedErrors.PURCHSE_INVALID_DATA_ERROR_CODE+&quot;|&quot;).getBytes());</span>
<span class="nc" id="L2038">				} catch (IOException e1) {</span>
<span class="nc" id="L2039">					logger.debug(&quot;Error In Setting Response&quot;);</span>
<span class="nc" id="L2040">					e1.printStackTrace();</span>
<span class="nc" id="L2041">				}</span>
<span class="nc" id="L2042">			}</span>
				
			
			
			
<span class="nc" id="L2047">		}</span>
			
		public void setAutoCancel(boolean autoCancel) {
<span class="nc" id="L2050">			this.autoCancel = autoCancel;</span>
<span class="nc" id="L2051">		}</span>
	
		public void setDrawGameData(TreeMap drawGameData) {
<span class="nc" id="L2054">			this.drawGameData = drawGameData;</span>
<span class="nc" id="L2055">		}</span>
	
		public void setDrawGameNewData(String drawGameNewData) {
<span class="nc" id="L2058">			this.drawGameNewData = drawGameNewData;</span>
<span class="nc" id="L2059">		}</span>
	
		public void setDrawTime(String drawTime) {
<span class="nc" id="L2062">			this.drawTime = drawTime;</span>
<span class="nc" id="L2063">		}</span>
	
		public void setFirstName(String firstName) {
<span class="nc" id="L2066">			this.firstName = firstName;</span>
<span class="nc" id="L2067">		}</span>
	
		public void setGameName(String gameName) {
<span class="nc" id="L2070">			this.gameName = gameName;</span>
<span class="nc" id="L2071">		}</span>
	
		public void setGameNo(int gameNo) {
<span class="nc" id="L2074">			this.gameNo = gameNo;</span>
<span class="nc" id="L2075">		}</span>
	
		public void setIdNumber(String idNumber) {
<span class="nc" id="L2078">			this.idNumber = idNumber;</span>
<span class="nc" id="L2079">		}</span>
	
		public void setIdType(String idType) {
<span class="nc" id="L2082">			this.idType = idType;</span>
<span class="nc" id="L2083">		}</span>
	
		public void setLastName(String lastName) {
<span class="nc" id="L2086">			this.lastName = lastName;</span>
<span class="nc" id="L2087">		}</span>
	
		public void setServletRequest(HttpServletRequest servletRequest) {
<span class="nc" id="L2090">			this.servletRequest = servletRequest;</span>
<span class="nc" id="L2091">		}</span>
	
		public void setServletResponse(HttpServletResponse response) {
<span class="fc" id="L2094">			this.response = response;</span>
<span class="fc" id="L2095">		}</span>
	
		public void setStartDate(String startDate) {
<span class="nc" id="L2098">			this.startDate = startDate;</span>
<span class="nc" id="L2099">		}</span>
	
		public void setTicketNo(String ticketNo) {
<span class="nc" id="L2102">			this.ticketNo = ticketNo;</span>
<span class="nc" id="L2103">		}</span>
	
		public void setUserName(String userName) {
<span class="fc" id="L2106">			this.userName = userName;</span>
<span class="fc" id="L2107">		}</span>
	
		public String getIsNewURL() {
<span class="nc" id="L2110">			return isNewURL;</span>
		}
	
		public void setIsNewURL(String isNewURL) {
<span class="nc" id="L2114">			this.isNewURL = isNewURL;</span>
<span class="nc" id="L2115">		}</span>
	
		public String getMobileNo() {
<span class="nc" id="L2118">			return mobileNo;</span>
		}
	
		public String getmPesa() {
<span class="nc" id="L2122">			return mPesa;</span>
		}
	
		public void setMobileNo(String mobileNo) {
<span class="nc" id="L2126">			this.mobileNo = mobileNo;</span>
<span class="nc" id="L2127">		}</span>
	
		public void setmPesa(String mPesa) {
<span class="nc" id="L2130">			this.mPesa = mPesa;</span>
<span class="nc" id="L2131">		}</span>
	
		public long getLSTktNo() {
<span class="nc" id="L2134">			return LSTktNo;</span>
		}
	
		public void setLSTktNo(long lSTktNo) {
<span class="fc" id="L2138">			LSTktNo = lSTktNo;</span>
<span class="fc" id="L2139">		}</span>
	
		public String getEndDate() {
<span class="nc" id="L2142">			return endDate;</span>
		}
	
		public void setEndDate(String endDate) {
<span class="nc" id="L2146">			this.endDate = endDate;</span>
<span class="nc" id="L2147">		}</span>
	
		public double getVersion() {
<span class="nc" id="L2150">			return version;</span>
		}
	
		public void setVersion(double version) {
<span class="nc" id="L2154">			this.version = version;</span>
<span class="nc" id="L2155">		}</span>
	
		public void setCancelType(String cancelType) {
<span class="nc" id="L2158">			this.cancelType = cancelType;</span>
<span class="nc" id="L2159">		}</span>
	
		public String getCancelType() {
<span class="nc" id="L2162">			return cancelType;</span>
		}
	
		public String getCurDate() {
<span class="nc" id="L2166">			return curDate;</span>
		}
	
		public void setCurDate(String curDate) {
<span class="nc" id="L2170">			this.curDate = curDate;</span>
<span class="nc" id="L2171">		}</span>


	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>