<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CommonFunctionsHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lms</a> &gt; <a href="index.source.html" class="el_package">com.skilrock.lms.coreEngine.userMgmt.common</a> &gt; <span class="el_source">CommonFunctionsHelper.java</span></div><h1>CommonFunctionsHelper.java</h1><pre class="source lang-java linenums">package com.skilrock.lms.coreEngine.userMgmt.common;

import java.io.InputStreamReader;
import java.io.Reader;
import java.io.StringReader;
import java.io.StringWriter;
import java.io.Writer;
import java.net.URLEncoder;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.sql.Timestamp;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.TreeMap;
import java.util.TreeSet;

import javax.servlet.http.HttpSession;
import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.xpath.XPath;
import javax.xml.xpath.XPathConstants;
import javax.xml.xpath.XPathExpression;
import javax.xml.xpath.XPathExpressionException;
import javax.xml.xpath.XPathFactory;

import org.apache.commons.httpclient.HttpClient;
import org.apache.commons.httpclient.MultiThreadedHttpConnectionManager;
import org.apache.commons.httpclient.methods.GetMethod;
import org.apache.commons.lang.StringUtils;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.w3c.dom.Document;
import org.w3c.dom.NodeList;
import org.xml.sax.InputSource;

import com.skilrock.lms.beans.ClmDrawSaleBean;
import com.skilrock.lms.beans.ClmPwtBean;
import com.skilrock.lms.beans.OrgBean;
import com.skilrock.lms.beans.OrgPwtLimitBean;
import com.skilrock.lms.beans.UserInfoBean;
import com.skilrock.lms.common.db.DBConnect;
import com.skilrock.lms.common.db.QueryManager;
import com.skilrock.lms.common.db.TableConstants;
import com.skilrock.lms.common.exception.LMSException;
import com.skilrock.lms.common.exception.handler.LMSExceptionInterceptor;
import com.skilrock.lms.common.filter.LMSFilterDispatcher;
import com.skilrock.lms.common.utility.CommonMethods;
import com.skilrock.lms.common.utility.FormatNumber;
import com.skilrock.lms.common.utility.GenerateRecieptNo;
import com.skilrock.lms.common.utility.GetDate;
import com.skilrock.lms.common.utility.MD5Encoder;
import com.skilrock.lms.common.utility.OrgCreditUpdation;
import com.skilrock.lms.dge.beans.GameMasterLMSBean;
import com.skilrock.lms.web.drawGames.common.Util;

<span class="nc" id="L63">public class CommonFunctionsHelper {</span>
<span class="nc" id="L64">	static Log logger = LogFactory.getLog(CommonFunctionsHelper.class);</span>
	private static final String GEOCODE_REQUEST_URL = &quot;http://maps.googleapis.com/maps/api/geocode/xml?sensor=false&amp;&quot;;
<span class="nc" id="L66">	private static HttpClient httpClient = new HttpClient(new MultiThreadedHttpConnectionManager());</span>
	
	public static String fetchNameOfUser(int userId) {
<span class="nc" id="L69">		String userName = &quot;&quot;;</span>
<span class="nc" id="L70">		Connection con = DBConnect.getConnection();</span>
		try {
<span class="nc" id="L72">			String query = &quot;select concat(first_name,' ',last_name) name from st_lms_user_contact_details where user_id = ?&quot;;</span>
<span class="nc" id="L73">			PreparedStatement pstmt = con.prepareStatement(query);</span>
<span class="nc" id="L74">			pstmt.setInt(1, userId);</span>
<span class="nc" id="L75">			ResultSet rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L77" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L78">				userName = rs.getString(&quot;name&quot;);</span>
			}
<span class="nc" id="L80">		} catch (SQLException ex) {</span>
<span class="nc" id="L81">			ex.printStackTrace();</span>
<span class="nc" id="L82">		}</span>
<span class="nc" id="L83">		return userName;</span>
	}

	public static ArrayList&lt;String&gt; getCityNameList(String countryName) {
<span class="nc" id="L87">		ArrayList&lt;String&gt; cityNameList = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L88">		Connection con = DBConnect.getConnection();</span>
		try {
<span class="nc" id="L90">			String getCityNameListAll = &quot;SELECT bb.city_name, bb.city_code FROM st_lms_city_master bb, st_lms_country_master aa WHERE aa.country_code = bb.country_code AND aa.name = ? order by bb.city_name&quot;;</span>
<span class="nc" id="L91">			PreparedStatement pstmt = con.prepareStatement(getCityNameListAll);</span>
<span class="nc" id="L92">			pstmt.setString(1, countryName);</span>
<span class="nc" id="L93">			ResultSet rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L95">				cityNameList.add(rs.getString(&quot;city_name&quot;).toUpperCase());</span>
			}
<span class="nc" id="L97">		} catch (SQLException e) {</span>
<span class="nc" id="L98">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L100">			try {</span>
<span class="nc bnc" id="L101" title="All 6 branches missed.">				if (con != null) {</span>
<span class="nc" id="L102">					con.close();</span>
				}
<span class="nc" id="L104">			} catch (SQLException se) {</span>
<span class="nc" id="L105">				se.printStackTrace();</span>
<span class="nc" id="L106">			}</span>
<span class="nc" id="L107">		}</span>
<span class="nc" id="L108">		return cityNameList;</span>
	}
	
	public static List&lt;String&gt; getCityCodeAndNameList(String selectState) {
<span class="nc" id="L112">		List&lt;String&gt; cityNameList = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L113">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L114">		Statement stmt = null;</span>
		try {
<span class="nc" id="L116">			stmt = con.createStatement();</span>
<span class="nc" id="L117">			ResultSet rs = stmt.executeQuery(&quot;select city_code,city_name from st_lms_city_master where state_code='&quot;+selectState+&quot;'&quot;);</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L119">				StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L120">				sb.append(rs.getString(&quot;city_name&quot;)).append(&quot;(&quot;).append(rs.getString(&quot;city_code&quot;).replace(' ', '_')).append(&quot;)&quot;);</span>
<span class="nc" id="L121">				cityNameList.add(sb.toString());</span>
<span class="nc" id="L122">			}</span>
<span class="nc" id="L123">		} catch (SQLException e) {</span>
<span class="nc" id="L124">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L126">			try {</span>
<span class="nc bnc" id="L127" title="All 6 branches missed.">				if (con != null) {</span>
<span class="nc" id="L128">					con.close();</span>
				}
<span class="nc" id="L130">			} catch (SQLException se) {</span>
<span class="nc" id="L131">				se.printStackTrace();</span>
<span class="nc" id="L132">			}</span>
<span class="nc" id="L133">		}</span>
<span class="nc" id="L134">		return cityNameList;</span>
	}
	public static List&lt;String&gt; getCityCodeList(String selectState) {
<span class="nc" id="L137">		List&lt;String&gt; cityCodeList = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L138">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L139">		Statement stmt = null;</span>
		try {
<span class="nc" id="L141">			stmt = con.createStatement();</span>
<span class="nc" id="L142">			ResultSet rs = stmt.executeQuery(&quot;select city_code,city_name from st_lms_city_master where state_code='&quot;+selectState+&quot;'&quot;);</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L144">				cityCodeList.add(rs.getString(&quot;city_code&quot;));</span>
			}
<span class="nc" id="L146">		} catch (SQLException e) {</span>
<span class="nc" id="L147">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L149">			try {</span>
<span class="nc bnc" id="L150" title="All 6 branches missed.">				if (con != null) {</span>
<span class="nc" id="L151">					con.close();</span>
				}
<span class="nc" id="L153">			} catch (SQLException se) {</span>
<span class="nc" id="L154">				se.printStackTrace();</span>
<span class="nc" id="L155">			}</span>
<span class="nc" id="L156">		}</span>
<span class="nc" id="L157">		return cityCodeList;</span>
	}
	public static List&lt;String&gt; getStateList() {
<span class="nc" id="L160">		List&lt;String&gt; statusList = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L161">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L162">		Statement stmt = null;</span>
		try {
<span class="nc" id="L164">			stmt = con.createStatement();</span>
<span class="nc" id="L165">			ResultSet rs = stmt.executeQuery(&quot;select state_code from st_lms_state_master&quot;);</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L167">				statusList.add(rs.getString(&quot;state_code&quot;));</span>
			}
<span class="nc" id="L169">		} catch (SQLException e) {</span>
<span class="nc" id="L170">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L172">			try {</span>
<span class="nc bnc" id="L173" title="All 6 branches missed.">				if (con != null) {</span>
<span class="nc" id="L174">					con.close();</span>
				}
<span class="nc" id="L176">			} catch (SQLException se) {</span>
<span class="nc" id="L177">				se.printStackTrace();</span>
<span class="nc" id="L178">			}</span>
<span class="nc" id="L179">		}</span>
<span class="nc" id="L180">		return statusList;</span>
	}
	public static List getUsersList(int orgId) {
<span class="nc" id="L183">		List&lt;String&gt; userList = new LinkedList&lt;String&gt;();</span>
<span class="nc" id="L184">		Connection connection = DBConnect.getConnection();</span>
<span class="nc" id="L185">		String query = &quot;select user_name from st_lms_user_master where organization_id =&quot;</span>
				+ orgId;
		try {
<span class="nc" id="L188">			PreparedStatement pstmt = connection.prepareStatement(query);</span>
<span class="nc" id="L189">			ResultSet rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L191" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L192">				userList.add(rs.getString(&quot;user_name&quot;));</span>
			}
<span class="nc" id="L194">			DBConnect.closeCon(connection);</span>
<span class="nc" id="L195">		} catch (SQLException e) {</span>
<span class="nc" id="L196">			e.printStackTrace();</span>
<span class="nc" id="L197">		}</span>
<span class="nc" id="L198">		return userList;</span>
	}

<span class="nc" id="L201">	private Connection conn = null;</span>

	private Connection connection;

	private PreparedStatement pstmt;

	private ResultSet result;

	public double fetchCommOfOrganization(int gameId, int orgId,
			String commType, String orgType, Connection con)
			throws SQLException {
<span class="nc" id="L212">		String fetCommAmount = &quot;&quot;;</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">		if (&quot;PWT&quot;.equalsIgnoreCase(commType)) {</span>

<span class="nc bnc" id="L215" title="All 2 branches missed.">			if (&quot;RETAILER&quot;.equalsIgnoreCase(orgType)) {</span>
<span class="nc" id="L216">				fetCommAmount = &quot;select a.game_id, a.retailer_pwt_comm_rate, b.pwt_comm_variance , &quot;</span>
						+ &quot;(ifnull(b.pwt_comm_variance, 0)+ a.retailer_pwt_comm_rate) 'total_comm' from &quot;
						+ &quot; (select game_id ,retailer_pwt_comm_rate from st_se_game_master where game_id = ?) a &quot;
						+ &quot; left join (select retailer_org_id, pwt_comm_variance, game_id from &quot;
						+ &quot; st_se_agent_retailer_sale_pwt_comm_variance where game_id = ? and  retailer_org_id = ?) b &quot;
						+ &quot;on a.game_id = b.game_id &quot;;
<span class="nc" id="L222">				logger.debug(&quot;PWT Commision Variance.&quot;);</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">			} else if (&quot;AGENT&quot;.equalsIgnoreCase(orgType)) {</span>
<span class="nc" id="L224">				fetCommAmount = &quot;select (a.agent_pwt_comm_rate+ifnull(b.pwt_comm_variance,0)) total_comm from(&quot;</span>
						+ &quot;select agent_pwt_comm_rate,game_id from st_se_game_master  where game_id=?)a left join&quot;
						+ &quot;(select pwt_comm_variance,game_id from st_se_bo_agent_sale_pwt_comm_variance &quot;
						+ &quot;where  game_id=? and agent_org_id=?) b on a.game_id=b.game_id&quot;;
<span class="nc" id="L228">				logger.debug(&quot;PWT Commision Variance.&quot;);</span>
			} else {
<span class="nc" id="L230">				logger.debug(&quot;ERROR:: Org type is not Defined properly :: &quot;</span>
						+ orgType);
			}

		} else {
<span class="nc" id="L235">			logger.debug(&quot;SALE Commision Variance.&quot;);</span>
		}
<span class="nc" id="L237">		PreparedStatement fetCommAmountPstmt = con</span>
				.prepareStatement(fetCommAmount);
<span class="nc" id="L239">		fetCommAmountPstmt.setInt(1, gameId);</span>
<span class="nc" id="L240">		fetCommAmountPstmt.setInt(2, gameId);</span>
<span class="nc" id="L241">		fetCommAmountPstmt.setInt(3, orgId);</span>
<span class="nc" id="L242">		ResultSet rs = fetCommAmountPstmt.executeQuery();</span>
<span class="nc" id="L243">		double commAmt = 0.0;</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">		if (rs.next()) {</span>
<span class="nc" id="L245">			commAmt = rs.getDouble(&quot;total_comm&quot;);</span>
		}
<span class="nc" id="L247">		logger.debug(&quot; commAmt = &quot; + commAmt + &quot; ,   fetCommAmount = &quot;</span>
				+ fetCommAmountPstmt);
<span class="nc" id="L249">		return commAmt;</span>

	}

	public Map fetchDGPwtDetailsOfAgtOrg(int agtOrgId, String orgType,
			String status, Connection con) throws LMSException {

<span class="nc" id="L256">		Map map = new TreeMap();</span>
<span class="nc" id="L257">		Map clmPwtDetailMap = new TreeMap();</span>
<span class="nc" id="L258">		Map newGameWiseTotAmt = new TreeMap();</span>

		try {
<span class="nc" id="L261">			String fetchClmBalOfOrgQuery = &quot;select  aaa.game_id, bbb.game_nbr, bbb.game_name, ticket_nbr, &quot;</span>
					+ &quot; aaa.draw_id, aaa.agt_claim_comm, aaa.pwt_amt, aaa.pwt_type, aaa.name from ((select &quot;
					+ &quot; b.ticket_nbr, a.pwt_amt, 'Anonymous' as 'pwt_type', a.game_id, a.agt_claim_comm, &quot;
					+ &quot; b.draw_id, 'Anonymous' as name from st_dg_agt_pwt a, st_dg_pwt_inv_? b where &quot;
					+ &quot; a.status = ? and agent_org_id = ? and a.transaction_id = b.agent_transaction_id ) union all &quot;
					+ &quot; (select  cc.ticket_nbr, aa.pwt_amt, 'direct_plr' as 'pwt_type', aa.game_id, &quot;
					+ &quot; agt_claim_comm, cc.draw_id ,concat(bb.first_name, ' ', bb.last_name) 'name' &quot;
					+ &quot; from st_dg_agt_direct_plr_pwt aa, st_lms_player_master bb, st_dg_pwt_inv_? cc where&quot;
					+ &quot; aa.pwt_claim_status = ? and agent_org_id = ? and aa.player_id = bb.player_id and &quot;
					+ &quot; aa.transaction_id = cc.agent_transaction_id ))aaa, st_dg_game_master bbb where &quot;
					+ &quot; aaa.game_id = bbb.game_id order by aaa.game_id, aaa.draw_id&quot;;

<span class="nc" id="L273">			logger.debug(fetchClmBalOfOrgQuery);</span>
<span class="nc" id="L274">			PreparedStatement pstmt = con</span>
					.prepareStatement(fetchClmBalOfOrgQuery);

<span class="nc" id="L277">			String fetchDrawGameListQuery = &quot;select game_id, game_nbr, game_name from st_dg_game_master&quot;;</span>
<span class="nc" id="L278">			Statement stmt = con.createStatement();</span>
<span class="nc" id="L279">			ResultSet rs = stmt.executeQuery(fetchDrawGameListQuery);</span>

<span class="nc" id="L281">			int gameNbr = 0;</span>
<span class="nc" id="L282">			double totalClmBal = 0.0, pwtAmt = 0.0;</span>
<span class="nc" id="L283">			ClmPwtBean pwtBean = null;</span>
<span class="nc" id="L284">			String gameName = &quot;&quot;;</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L286">				gameNbr = rs.getInt(&quot;game_nbr&quot;);</span>
<span class="nc" id="L287">				gameName = rs.getInt(&quot;game_nbr&quot;) + &quot;-&quot;</span>
						+ rs.getString(&quot;game_name&quot;);
<span class="nc" id="L289">				totalClmBal = 0.0;</span>

<span class="nc" id="L291">				pstmt.setInt(1, gameNbr);</span>
				// pstmt.setInt(2, gameNbr);
<span class="nc" id="L293">				pstmt.setString(2, status);</span>
<span class="nc" id="L294">				pstmt.setInt(3, agtOrgId);</span>
<span class="nc" id="L295">				pstmt.setInt(4, gameNbr);</span>
<span class="nc" id="L296">				pstmt.setString(5, status);</span>
<span class="nc" id="L297">				pstmt.setInt(6, agtOrgId);</span>
<span class="nc" id="L298">				logger.debug(&quot;Fetch &quot; + status + &quot; Draw game PWT details for &quot;</span>
						+ orgType + &quot; and orgId is &quot; + agtOrgId + &quot; query is &quot;
						+ pstmt);
<span class="nc" id="L301">				ResultSet result = pstmt.executeQuery();</span>

<span class="nc" id="L303">				List&lt;ClmPwtBean&gt; beanList = new ArrayList&lt;ClmPwtBean&gt;();</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">				while (result.next()) {</span>
<span class="nc" id="L305">					pwtBean = new ClmPwtBean();</span>
<span class="nc" id="L306">					pwtAmt = result.getDouble(&quot;pwt_amt&quot;);</span>
<span class="nc" id="L307">					totalClmBal = totalClmBal + pwtAmt;</span>
<span class="nc" id="L308">					pwtBean.setTktNbr(result.getString(&quot;ticket_nbr&quot;));</span>
<span class="nc" id="L309">					pwtBean.setDrawId(result.getInt(&quot;draw_id&quot;));</span>
					// pwtBean.setPanelId(result.getObject(&quot;panel_id&quot;));
<span class="nc" id="L311">					pwtBean.setPwtAmt(result.getDouble(&quot;pwt_amt&quot;));</span>
<span class="nc" id="L312">					pwtBean.setPwtType(result.getString(&quot;pwt_type&quot;));</span>
					// pwtBean.setClaimComm(result.getDouble(&quot;claim_comm&quot;));
<span class="nc" id="L314">					pwtBean.setGameId(result.getInt(&quot;game_id&quot;));</span>
<span class="nc" id="L315">					pwtBean.setGameName(result.getString(&quot;game_name&quot;));</span>
<span class="nc" id="L316">					pwtBean.setGameNbr(result.getInt(&quot;game_nbr&quot;));</span>
<span class="nc" id="L317">					pwtBean.setClaimedBy(result.getString(&quot;name&quot;));</span>
<span class="nc" id="L318">					pwtBean.setAgtClaimComm(result.getDouble(&quot;agt_claim_comm&quot;));</span>

<span class="nc" id="L320">					beanList.add(pwtBean);</span>
				}
<span class="nc bnc" id="L322" title="All 2 branches missed.">				if (!beanList.isEmpty()) {</span>
<span class="nc" id="L323">					clmPwtDetailMap.put(gameName, beanList);</span>
<span class="nc" id="L324">					newGameWiseTotAmt.put(gameName, totalClmBal);</span>
				}
<span class="nc" id="L326">			}</span>

<span class="nc bnc" id="L328" title="All 2 branches missed.">			if (!clmPwtDetailMap.isEmpty()) {</span>
<span class="nc" id="L329">				map.put(&quot;DRClmPwtDetailMap&quot;, clmPwtDetailMap);</span>
<span class="nc" id="L330">				map.put(&quot;newDRGameWiseTotAmt&quot;, newGameWiseTotAmt);</span>
			}
<span class="nc" id="L332">			return map;</span>

<span class="nc" id="L334">		} catch (SQLException e) {</span>
<span class="nc" id="L335">			e.printStackTrace();</span>
<span class="nc" id="L336">			throw new LMSException(e);</span>
		}
	}

	public Map fetchDGPwtDetailsOfAgtOrgClm(int agtOrgId, String orgType,
			String status, Connection con) throws LMSException {

<span class="nc" id="L343">		Map map = new TreeMap();</span>
<span class="nc" id="L344">		Map clmPwtDetailMap = new TreeMap();</span>
<span class="nc" id="L345">		Map newGameWiseTotAmt = new TreeMap();</span>

		try {
<span class="nc" id="L348">			String fetchClmBalOfOrgQuery = &quot;select  aaa.transaction_id, aaa.game_id, bbb.game_nbr, &quot;</span>
					+ &quot; bbb.game_name, aaa.draw_id, aaa.agt_claim_comm, aaa.pwt_amt, aaa.pwt_type, &quot;
					+ &quot; DATE(aaa.transaction_date) 'transaction_date' from ((select  a.transaction_id,  &quot;
					+ &quot; a.draw_id, a.pwt_amt, 'Anonymous' as 'pwt_type', a.game_id,  a.agt_claim_comm, &quot;
					+ &quot; transaction_date from st_dg_agt_pwt a, st_lms_agent_transaction_master b where   &quot;
					+ &quot; a.status = ? and a.agent_org_id = ? and game_id =? and a.transaction_id = b.transaction_id)&quot;
					+ &quot; union all (select    aa.transaction_id, aa.draw_id, aa.pwt_amt, 'direct_plr' as 'pwt_type', &quot;
					+ &quot; aa.game_id,  agt_claim_comm, transaction_date from st_dg_agt_direct_plr_pwt aa where &quot;
					+ &quot; aa.pwt_claim_status = ? and  aa.agent_org_id = ? and game_id =?))aaa, st_dg_game_master&quot;
					+ &quot; bbb where  aaa.game_id = bbb.game_id  order by aaa.game_id, aaa.draw_id, &quot;
					+ &quot; aaa.transaction_date&quot;;

<span class="nc" id="L360">			logger.debug(fetchClmBalOfOrgQuery);</span>
<span class="nc" id="L361">			PreparedStatement pstmt = con</span>
					.prepareStatement(fetchClmBalOfOrgQuery);

<span class="nc" id="L364">			String fetchDrawGameListQuery = &quot;select game_id, game_nbr, game_name from st_dg_game_master&quot;;</span>
<span class="nc" id="L365">			Statement stmt = con.createStatement();</span>
<span class="nc" id="L366">			ResultSet rs = stmt.executeQuery(fetchDrawGameListQuery);</span>

<span class="nc" id="L368">			int gameNbr = 0;</span>
<span class="nc" id="L369">			double totalClmBal = 0.0, pwtAmt = 0.0;</span>
<span class="nc" id="L370">			ClmPwtBean pwtBean = null;</span>
<span class="nc" id="L371">			String gameName = &quot;&quot;;</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L373">				gameNbr = rs.getInt(&quot;game_nbr&quot;);</span>

<span class="nc" id="L375">				gameName = rs.getInt(&quot;game_nbr&quot;) + &quot;-&quot;</span>
						+ rs.getString(&quot;game_name&quot;);
<span class="nc" id="L377">				totalClmBal = 0.0;</span>

<span class="nc" id="L379">				pstmt.setString(1, status);</span>
<span class="nc" id="L380">				pstmt.setInt(2, agtOrgId);</span>
<span class="nc" id="L381">				pstmt.setInt(3, rs.getInt(&quot;game_id&quot;));</span>
<span class="nc" id="L382">				pstmt.setString(4, status);</span>
<span class="nc" id="L383">				pstmt.setInt(5, agtOrgId);</span>
<span class="nc" id="L384">				pstmt.setInt(6, rs.getInt(&quot;game_id&quot;));</span>

<span class="nc" id="L386">				logger.debug(&quot;Fetch &quot; + status + &quot; Draw game PWT details for &quot;</span>
						+ orgType + &quot; and orgId is &quot; + agtOrgId + &quot; query is &quot;
						+ pstmt);
<span class="nc" id="L389">				ResultSet result = pstmt.executeQuery();</span>

<span class="nc" id="L391">				List&lt;ClmPwtBean&gt; beanList = new ArrayList&lt;ClmPwtBean&gt;();</span>
<span class="nc bnc" id="L392" title="All 2 branches missed.">				while (result.next()) {</span>
<span class="nc" id="L393">					pwtBean = new ClmPwtBean();</span>
<span class="nc" id="L394">					pwtAmt = result.getDouble(&quot;pwt_amt&quot;);</span>
<span class="nc" id="L395">					totalClmBal = totalClmBal + pwtAmt;</span>
					// pwtBean.setTktNbr(result.getString(&quot;ticket_nbr&quot;));
<span class="nc" id="L397">					pwtBean.setDrawId(result.getInt(&quot;draw_id&quot;));</span>
					// pwtBean.setPanelId(result.getObject(&quot;panel_id&quot;));
<span class="nc" id="L399">					pwtBean.setPwtAmt(result.getDouble(&quot;pwt_amt&quot;));</span>
<span class="nc" id="L400">					pwtBean.setPwtType(result.getString(&quot;pwt_type&quot;));</span>
					// pwtBean.setClaimComm(result.getDouble(&quot;claim_comm&quot;));
<span class="nc" id="L402">					pwtBean.setGameId(result.getInt(&quot;game_id&quot;));</span>
<span class="nc" id="L403">					pwtBean.setGameName(result.getString(&quot;game_name&quot;));</span>
<span class="nc" id="L404">					pwtBean.setGameNbr(result.getInt(&quot;game_nbr&quot;));</span>
					// pwtBean.setClaimedBy(result.getString(&quot;name&quot;));
<span class="nc" id="L406">					pwtBean.setAgtClaimComm(result.getDouble(&quot;agt_claim_comm&quot;));</span>
<span class="nc" id="L407">					pwtBean.setTransactionId(result.getLong(&quot;transaction_id&quot;));</span>
<span class="nc" id="L408">					pwtBean.setTransDate(result.getDate(&quot;transaction_date&quot;)</span>
							.toString());

<span class="nc" id="L411">					beanList.add(pwtBean);</span>
				}
				// if(!beanList.isEmpty()) {
<span class="nc" id="L414">				clmPwtDetailMap.put(gameName, beanList);</span>
<span class="nc" id="L415">				newGameWiseTotAmt.put(gameName, totalClmBal);</span>
				// }
<span class="nc" id="L417">			}</span>

<span class="nc bnc" id="L419" title="All 2 branches missed.">			if (!clmPwtDetailMap.isEmpty()) {</span>
<span class="nc" id="L420">				map.put(&quot;DRClmPwtDetailMap&quot;, clmPwtDetailMap);</span>
<span class="nc" id="L421">				map.put(&quot;newDRGameWiseTotAmt&quot;, newGameWiseTotAmt);</span>
			}
<span class="nc" id="L423">			return map;</span>

<span class="nc" id="L425">		} catch (SQLException e) {</span>
<span class="nc" id="L426">			e.printStackTrace();</span>
<span class="nc" id="L427">			throw new LMSException(e);</span>
		}
	}

	public Map fetchDGPwtDetailsOfRetOrg(int retOrgId, String orgType,
			String status, Connection con) throws LMSException {

<span class="nc" id="L434">		Map map = new TreeMap();</span>
<span class="nc" id="L435">		Map clmPwtDetailMap = new TreeMap();</span>
<span class="nc" id="L436">		Map newGameWiseTotAmt = new TreeMap();</span>

		try {
<span class="nc" id="L439">			String fetchClmBalOfOrgQuery = &quot;select aaa.game_id, bbb.game_nbr, bbb.game_name, ticket_nbr, &quot;</span>
					+ &quot; aaa.draw_id,  aaa.panel_id, aaa.agt_claim_comm, aaa.pwt_amt, aaa.pwt_type, &quot;
					+ &quot; aaa.retailer_claim_comm 'claim_comm', aaa.name, DATE(aaa.transaction_date) 'transaction_date' from((select &quot;
					+ &quot; b.ticket_nbr, a.pwt_amt, 'Anonymous' as  'pwt_type' , a.game_id, b.panel_id,   b.draw_id,&quot;
					+ &quot; a.retailer_claim_comm , a.agt_claim_comm , 'Anonymous' as name, transaction_date from &quot;
					+ &quot; st_dg_ret_pwt_?  a, st_dg_pwt_inv_? b, st_lms_retailer_transaction_master c where a.status&quot;
					+ &quot; = ? and a.retailer_org_id = ? and   a.transaction_id = b.retailer_transaction_id and &quot;
					+ &quot; a.transaction_id = c.transaction_id) union all (select  cc.ticket_nbr, aa.pwt_amt , 'direct_plr'&quot;
					+ &quot; as  'pwt_type',  aa.game_id, aa.panel_id, cc.draw_id, aa.retailer_claim_comm, &quot;
					+ &quot; aa.agt_claim_comm,   concat(bb.first_name, ' ', bb.last_name) 'name', transaction_date from &quot;
					+ &quot; st_dg_ret_direct_plr_pwt aa,  st_lms_player_master bb, st_dg_pwt_inv_? cc where  &quot;
					+ &quot; aa.pwt_claim_status = ?   and retailer_org_id = ? and aa.player_id = bb.player_id and &quot;
					+ &quot; aa.transaction_id =   cc.retailer_transaction_id))aaa, st_dg_game_master bbb  where &quot;
					+ &quot; aaa.game_id = bbb.game_id order by aaa.game_id, aaa.draw_id, aaa.panel_id, &quot;
					+ &quot; aaa.transaction_date&quot;;

<span class="nc" id="L455">			logger.debug(fetchClmBalOfOrgQuery);</span>
<span class="nc" id="L456">			PreparedStatement pstmt = con</span>
					.prepareStatement(fetchClmBalOfOrgQuery);

<span class="nc" id="L459">			String fetchDrawGameListQuery = &quot;select game_id, game_nbr, game_name from st_dg_game_master&quot;;</span>
<span class="nc" id="L460">			Statement stmt = con.createStatement();</span>
<span class="nc" id="L461">			ResultSet rs = stmt.executeQuery(fetchDrawGameListQuery);</span>

<span class="nc" id="L463">			int gameNbr = 0;</span>
<span class="nc" id="L464">			double totalClmBal = 0.0, pwtAmt = 0.0;</span>
<span class="nc" id="L465">			ClmPwtBean pwtBean = null;</span>
<span class="nc" id="L466">			String gameName = &quot;&quot;;</span>
<span class="nc bnc" id="L467" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L468">				gameNbr = rs.getInt(&quot;game_nbr&quot;);</span>
<span class="nc" id="L469">				gameName = rs.getInt(&quot;game_nbr&quot;) + &quot;-&quot;</span>
						+ rs.getString(&quot;game_name&quot;);
<span class="nc" id="L471">				totalClmBal = 0.0;</span>

<span class="nc" id="L473">				pstmt.setInt(1, gameNbr);</span>
<span class="nc" id="L474">				pstmt.setInt(2, gameNbr);</span>
<span class="nc" id="L475">				pstmt.setString(3, status);</span>
<span class="nc" id="L476">				pstmt.setInt(4, retOrgId);</span>
<span class="nc" id="L477">				pstmt.setInt(5, gameNbr);</span>
<span class="nc" id="L478">				pstmt.setString(6, status);</span>
<span class="nc" id="L479">				pstmt.setInt(7, retOrgId);</span>
<span class="nc" id="L480">				logger.debug(&quot;Fetch &quot; + status + &quot; Draw game PWT details for &quot;</span>
						+ orgType + &quot; and orgId is &quot; + retOrgId + &quot; query is &quot;
						+ pstmt);
<span class="nc" id="L483">				ResultSet result = pstmt.executeQuery();</span>

<span class="nc" id="L485">				List&lt;ClmPwtBean&gt; beanList = new ArrayList&lt;ClmPwtBean&gt;();</span>
<span class="nc bnc" id="L486" title="All 2 branches missed.">				while (result.next()) {</span>
<span class="nc" id="L487">					pwtBean = new ClmPwtBean();</span>
<span class="nc" id="L488">					pwtAmt = result.getDouble(&quot;pwt_amt&quot;);</span>
<span class="nc" id="L489">					totalClmBal = totalClmBal + pwtAmt;</span>
<span class="nc" id="L490">					pwtBean.setTktNbr(result.getString(&quot;ticket_nbr&quot;));</span>
<span class="nc" id="L491">					pwtBean.setDrawId(result.getInt(&quot;draw_id&quot;));</span>
<span class="nc" id="L492">					pwtBean.setPanelId(result.getObject(&quot;panel_id&quot;));</span>
<span class="nc" id="L493">					pwtBean.setPwtAmt(result.getDouble(&quot;pwt_amt&quot;));</span>
<span class="nc" id="L494">					pwtBean.setPwtType(result.getString(&quot;pwt_type&quot;));</span>
<span class="nc" id="L495">					pwtBean.setClaimComm(result.getDouble(&quot;claim_comm&quot;));</span>
<span class="nc" id="L496">					pwtBean.setGameId(result.getInt(&quot;game_id&quot;));</span>
<span class="nc" id="L497">					pwtBean.setGameName(result.getString(&quot;game_name&quot;));</span>
<span class="nc" id="L498">					pwtBean.setGameNbr(result.getInt(&quot;game_nbr&quot;));</span>
<span class="nc" id="L499">					pwtBean.setClaimedBy(result.getString(&quot;name&quot;));</span>
<span class="nc" id="L500">					pwtBean.setAgtClaimComm(result.getDouble(&quot;agt_claim_comm&quot;));</span>
<span class="nc" id="L501">					pwtBean.setTransDate(result.getDate(&quot;transaction_date&quot;)</span>
							.toString());

<span class="nc" id="L504">					beanList.add(pwtBean);</span>
				}
<span class="nc bnc" id="L506" title="All 2 branches missed.">				if (!beanList.isEmpty()) {</span>
<span class="nc" id="L507">					clmPwtDetailMap.put(gameName, beanList);</span>
<span class="nc" id="L508">					newGameWiseTotAmt.put(gameName, totalClmBal);</span>
				}
<span class="nc" id="L510">			}</span>

<span class="nc bnc" id="L512" title="All 2 branches missed.">			if (!clmPwtDetailMap.isEmpty()) {</span>
<span class="nc" id="L513">				map.put(&quot;DRClmPwtDetailMap&quot;, clmPwtDetailMap);</span>
<span class="nc" id="L514">				map.put(&quot;newDRGameWiseTotAmt&quot;, newGameWiseTotAmt);</span>
			}
<span class="nc" id="L516">			return map;</span>

<span class="nc" id="L518">		} catch (SQLException e) {</span>
<span class="nc" id="L519">			e.printStackTrace();</span>
<span class="nc" id="L520">			throw new LMSException(e);</span>
		}
	}

	public Map fetchDrawSaleDetailsOfOrg(int userOrgId, String orgType,
			String status, Connection con,
			Map&lt;Long, GameMasterLMSBean&gt; retComMap) throws LMSException {
<span class="nc" id="L527">		GameMasterLMSBean commBean = null;</span>
<span class="nc" id="L528">		Map map = new TreeMap();</span>
<span class="nc" id="L529">		ClmDrawSaleBean darwSaleBean = null;</span>
<span class="nc" id="L530">		PreparedStatement pstmtRefund = null;</span>
<span class="nc" id="L531">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L532">		PreparedStatement pstmtGameNbr = null;</span>
		try {
<span class="nc" id="L534">			String fetchClmBalOfOrgQuery = &quot;&quot;;</span>
<span class="nc" id="L535">			String fetchDrawRefundClmBal = &quot;&quot;;</span>
<span class="nc" id="L536">			String getGameNbrFromGameMaster = &quot;&quot;;</span>

<span class="nc" id="L538">			Map&lt;String, List&lt;ClmDrawSaleBean&gt;&gt; clmDrawSaleDetailMap = new TreeMap();</span>
<span class="nc" id="L539">			Map&lt;String, List&lt;ClmDrawSaleBean&gt;&gt; clmDrawSaleRefundDetailMap = new TreeMap();</span>

<span class="nc bnc" id="L541" title="All 2 branches missed.">			if (&quot;RETAILER&quot;.equalsIgnoreCase(orgType)) {</span>
<span class="nc" id="L542">				fetchClmBalOfOrgQuery = &quot;select a.transaction_id ,mrp_amt ,retailer_comm, agent_comm, &quot;</span>
						+ &quot; good_cause_amt, vat_amt,taxable_sale,a.game_id,DATE(transaction_date) 'transaction_date' from st_dg_ret_sale_? a,&quot;
						+ &quot; st_lms_retailer_transaction_master b  where a.retailer_org_id=? and claim_status=? &quot;
						+ &quot; and a.transaction_id = b.transaction_id order by game_id,transaction_date &quot;;

<span class="nc" id="L547">				fetchDrawRefundClmBal = &quot;select a.transaction_id ,b.transaction_type,a.mrp_amt ,a.retailer_comm,&quot;</span>
						+ &quot; a.agent_comm,a.good_cause_amt, a.vat_amt,a.taxable_sale,a.game_id,a.cancellation_charges, DATE(b.transaction_date) 'transaction_date' from &quot;
						+ &quot; st_dg_ret_sale_refund_? a,st_lms_retailer_transaction_master b  where a.retailer_org_id=? &quot;
						+ &quot; and a.claim_status=? and b.transaction_id=a.transaction_id order by a.game_id, &quot;
						+ &quot; b.transaction_type, b.transaction_date &quot;;

<span class="nc" id="L553">				getGameNbrFromGameMaster = &quot;select game_nbr,prize_payout_ratio,vat_amt from st_dg_game_master&quot;;</span>
<span class="nc" id="L554">				pstmtGameNbr = con.prepareStatement(getGameNbrFromGameMaster);</span>
<span class="nc" id="L555">				ResultSet resultGameNbr = pstmtGameNbr.executeQuery();</span>
<span class="nc" id="L556">				int gameNbr = 0;</span>
<span class="nc" id="L557">				double ppr = 0.0;</span>
<span class="nc" id="L558">				double vatAmt = 0.0;</span>

<span class="nc bnc" id="L560" title="All 2 branches missed.">				while (resultGameNbr.next()) {</span>
<span class="nc" id="L561">					gameNbr = resultGameNbr.getInt(&quot;game_nbr&quot;);</span>
<span class="nc" id="L562">					ppr = resultGameNbr.getInt(&quot;prize_payout_ratio&quot;);</span>
<span class="nc" id="L563">					vatAmt = resultGameNbr.getDouble(&quot;vat_amt&quot;);</span>
<span class="nc" id="L564">					pstmt = con.prepareStatement(fetchClmBalOfOrgQuery);</span>
<span class="nc" id="L565">					pstmt.setInt(1, gameNbr);</span>
<span class="nc" id="L566">					pstmt.setInt(2, userOrgId);</span>
<span class="nc" id="L567">					pstmt.setString(3, status);</span>
<span class="nc" id="L568">					logger.debug(&quot;****** Fetch RETAILER DRAW SALE=== &quot; + pstmt);</span>
<span class="nc" id="L569">					ResultSet result = pstmt.executeQuery();</span>
<span class="nc" id="L570">					List&lt;ClmDrawSaleBean&gt; beanList = new ArrayList&lt;ClmDrawSaleBean&gt;();</span>

					// String key=&quot;-1&quot;;
<span class="nc bnc" id="L573" title="All 2 branches missed.">					while (result.next()) {</span>
<span class="nc" id="L574">						commBean = retComMap.get(result</span>
								.getLong(&quot;transaction_id&quot;));

<span class="nc" id="L577">						darwSaleBean = new ClmDrawSaleBean();</span>
<span class="nc" id="L578">						double mrpAmt = result.getDouble(&quot;mrp_amt&quot;);</span>
<span class="nc" id="L579">						double retComm = result.getDouble(&quot;retailer_comm&quot;);</span>
<span class="nc" id="L580">						double agentComm = result.getDouble(&quot;agent_comm&quot;);</span>
<span class="nc" id="L581">						double goodCauseAmt = result</span>
								.getDouble(&quot;good_cause_amt&quot;);
<span class="nc" id="L583">						String transDate = result.getDate(&quot;transaction_date&quot;)</span>
								.toString();
<span class="nc" id="L585">						int game_id = result.getInt(&quot;game_id&quot;);</span>
<span class="nc bnc" id="L586" title="All 2 branches missed.">						if (mrpAmt != 0) {</span>
<span class="nc" id="L587">							logger.debug(game_id + &quot;=============&quot; + retComm</span>
									+ &quot;====***************&quot; + mrpAmt);
<span class="nc" id="L589">							String keyGen = game_id + &quot;:&quot;</span>
									+ commBean.getRetSaleCommRate() + &quot;:&quot;
									+ commBean.getAgentSaleCommRate() + &quot;:&quot;
									+ commBean.getGovtComm() + &quot;:&quot; + transDate;
<span class="nc" id="L593">							logger.debug(keyGen</span>
									+ &quot;=================***************&quot;);

<span class="nc" id="L596">							darwSaleBean.setPricePayRatio(ppr);</span>
<span class="nc" id="L597">							darwSaleBean.setVatAmt(vatAmt);</span>

<span class="nc" id="L599">							darwSaleBean.setMrpAmt(mrpAmt);</span>
<span class="nc" id="L600">							darwSaleBean.setRetComm(retComm);</span>
<span class="nc" id="L601">							darwSaleBean.setAgtComm(agentComm);</span>
<span class="nc" id="L602">							darwSaleBean.setAgtGoodCauseAmt(goodCauseAmt);</span>
<span class="nc" id="L603">							darwSaleBean.setGameId(game_id);</span>
<span class="nc" id="L604">							darwSaleBean.setTransactinId(result</span>
									.getLong(&quot;transaction_id&quot;));
<span class="nc" id="L606">							darwSaleBean.setTransDate(result.getDate(</span>
									&quot;transaction_date&quot;).toString());
<span class="nc" id="L608">							darwSaleBean.setGameNbr(gameNbr);</span>
							// modify the below code so as to improve
							// readability . Use map.contains method
							// remove duplicacy in variable declaration
							// modified by yogesh as suggested by reviewer
							// vinnet

<span class="nc bnc" id="L615" title="All 2 branches missed.">							if (clmDrawSaleDetailMap.containsKey(keyGen)) {</span>
<span class="nc" id="L616">								beanList = clmDrawSaleDetailMap.get(keyGen);</span>
<span class="nc" id="L617">								beanList.add(darwSaleBean);</span>
<span class="nc" id="L618">								clmDrawSaleDetailMap.put(keyGen, beanList);</span>
							} else {
<span class="nc" id="L620">								beanList = new ArrayList&lt;ClmDrawSaleBean&gt;();</span>
<span class="nc" id="L621">								beanList.add(darwSaleBean);</span>
<span class="nc" id="L622">								clmDrawSaleDetailMap.put(keyGen, beanList);</span>
							}
						}

<span class="nc" id="L626">					}</span>

					// get data from draw sale refund table
<span class="nc" id="L629">					pstmtRefund = con.prepareStatement(fetchDrawRefundClmBal);</span>
<span class="nc" id="L630">					pstmtRefund.setInt(1, gameNbr);</span>
<span class="nc" id="L631">					pstmtRefund.setInt(2, userOrgId);</span>
<span class="nc" id="L632">					pstmtRefund.setString(3, status);</span>
<span class="nc" id="L633">					logger.debug(&quot;****** Fetch RETAILER DRAW REFUND SALE=== &quot;</span>
							+ pstmtRefund);
<span class="nc" id="L635">					ResultSet resultRefund = pstmtRefund.executeQuery();</span>
<span class="nc" id="L636">					List&lt;ClmDrawSaleBean&gt; beanRefundList = new ArrayList&lt;ClmDrawSaleBean&gt;();</span>
					// Map clmDrawSaleRefundDetailMap = new TreeMap();

					// String keyRefund=&quot;-1&quot;;
<span class="nc bnc" id="L640" title="All 2 branches missed.">					while (resultRefund.next()) {</span>
<span class="nc" id="L641">						commBean = retComMap.get(resultRefund</span>
								.getLong(&quot;transaction_id&quot;));
<span class="nc" id="L643">						darwSaleBean = new ClmDrawSaleBean();</span>
<span class="nc" id="L644">						double mrpAmt = resultRefund.getDouble(&quot;mrp_amt&quot;);</span>
<span class="nc" id="L645">						double retComm = resultRefund</span>
								.getDouble(&quot;retailer_comm&quot;);
<span class="nc" id="L647">						double agentComm = resultRefund.getDouble(&quot;agent_comm&quot;);</span>
<span class="nc" id="L648">						double goodCauseAmt = resultRefund</span>
								.getDouble(&quot;good_cause_amt&quot;);
<span class="nc" id="L650">						int game_id = resultRefund.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L651">						double cancellationCharges = resultRefund</span>
								.getDouble(&quot;cancellation_charges&quot;);
<span class="nc" id="L653">						String refundType = resultRefund</span>
								.getString(&quot;transaction_type&quot;);
<span class="nc" id="L655">						String transDate = resultRefund.getDate(</span>
								&quot;transaction_date&quot;).toString();
<span class="nc bnc" id="L657" title="All 2 branches missed.">						if (mrpAmt != 0) {</span>
<span class="nc" id="L658">							String keyGenRefund = game_id + &quot;:&quot;</span>
									+ commBean.getRetSaleCommRate() + &quot;:&quot;
									+ commBean.getAgentSaleCommRate() + &quot;:&quot;
									+ commBean.getGovtComm() + &quot;:&quot; + refundType
									+ &quot;:&quot; + transDate;

<span class="nc" id="L664">							darwSaleBean.setPricePayRatio(ppr);</span>
<span class="nc" id="L665">							darwSaleBean.setVatAmt(vatAmt);</span>
<span class="nc" id="L666">							darwSaleBean.setMrpAmt(mrpAmt);</span>
<span class="nc" id="L667">							darwSaleBean.setRetComm(retComm);</span>
<span class="nc" id="L668">							darwSaleBean.setAgtComm(agentComm);</span>
<span class="nc" id="L669">							darwSaleBean.setAgtGoodCauseAmt(goodCauseAmt);</span>
<span class="nc" id="L670">							darwSaleBean.setGameId(game_id);</span>
<span class="nc" id="L671">							darwSaleBean.setTransactinId(resultRefund</span>
									.getLong(&quot;transaction_id&quot;));
<span class="nc" id="L673">							darwSaleBean.setTransDate(resultRefund.getDate(</span>
									&quot;transaction_date&quot;).toString());
<span class="nc" id="L675">							darwSaleBean.setGameNbr(gameNbr);</span>
<span class="nc" id="L676">							darwSaleBean</span>
									.setCancellationCharges(cancellationCharges);
							// modify same as sale

<span class="nc bnc" id="L680" title="All 2 branches missed.">							if (clmDrawSaleRefundDetailMap</span>
									.containsKey(keyGenRefund)) {
<span class="nc" id="L682">								beanRefundList = clmDrawSaleRefundDetailMap</span>
										.get(keyGenRefund);
<span class="nc" id="L684">								beanRefundList.add(darwSaleBean);</span>
<span class="nc" id="L685">								clmDrawSaleRefundDetailMap.put(keyGenRefund,</span>
										beanRefundList);
							} else {
<span class="nc" id="L688">								beanRefundList = new ArrayList&lt;ClmDrawSaleBean&gt;();</span>
<span class="nc" id="L689">								beanRefundList.add(darwSaleBean);</span>
<span class="nc" id="L690">								clmDrawSaleRefundDetailMap.put(keyGenRefund,</span>
										beanRefundList);
							}
						}

<span class="nc" id="L695">					}</span>
<span class="nc" id="L696">				}</span>
<span class="nc bnc" id="L697" title="All 2 branches missed.">			} else if (&quot;AGENT&quot;.equalsIgnoreCase(orgType)) {</span>
<span class="nc" id="L698">				fetchClmBalOfOrgQuery = &quot;select a.transaction_id ,mrp_amt ,retailer_comm,agent_comm, &quot;</span>
						+ &quot; govt_comm, vat_amt,taxable_sale,game_id,DATE(b.transaction_date) &quot;
						+ &quot; 'transaction_date' from st_dg_agt_sale a, st_lms_agent_transaction_master b &quot;
						+ &quot; where agent_org_id=? and claim_status=? and a.transaction_id = b.transaction_id&quot;
						+ &quot; order by game_id,transaction_date &quot;;

<span class="nc" id="L704">				fetchDrawRefundClmBal = &quot;select a.transaction_id ,b.transaction_type,a.mrp_amt , &quot;</span>
						+ &quot; a.retailer_comm,a.agent_comm,govt_comm,a.vat_amt, a.taxable_sale,a.game_id,a.cancellation_charges, DATE(b.transaction_date) 'transaction_date'&quot;
						+ &quot; from st_dg_agt_sale_refund a,st_lms_agent_transaction_master b where &quot;
						+ &quot; a.agent_org_id=? and a.claim_status=? and a.transaction_id=b.transaction_id &quot;
						+ &quot; order by a.game_id,b.transaction_type, transaction_date &quot;;

<span class="nc" id="L710">				pstmt = con.prepareStatement(fetchClmBalOfOrgQuery);</span>
<span class="nc" id="L711">				pstmt.setInt(1, userOrgId);</span>
<span class="nc" id="L712">				pstmt.setString(2, status);</span>
<span class="nc" id="L713">				logger.debug(&quot;****** Fetch AGENT DRAW SALE=== &quot; + pstmt);</span>
<span class="nc" id="L714">				ResultSet result = pstmt.executeQuery();</span>
<span class="nc" id="L715">				List&lt;ClmDrawSaleBean&gt; beanList = new ArrayList&lt;ClmDrawSaleBean&gt;();</span>
				// String key=&quot;-1&quot;;
<span class="nc bnc" id="L717" title="All 2 branches missed.">				while (result.next()) {</span>
<span class="nc" id="L718">					commBean = retComMap.get(result.getLong(&quot;transaction_id&quot;));</span>
<span class="nc" id="L719">					darwSaleBean = new ClmDrawSaleBean();</span>
<span class="nc" id="L720">					double mrpAmt = result.getDouble(&quot;mrp_amt&quot;);</span>
<span class="nc" id="L721">					double agentComm = result.getDouble(&quot;agent_comm&quot;);</span>
<span class="nc" id="L722">					double goodCauseAmt = result.getDouble(&quot;govt_comm&quot;);</span>
<span class="nc" id="L723">					int game_id = result.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L724">					String transDate = result.getDate(&quot;transaction_date&quot;)</span>
							.toString();
<span class="nc bnc" id="L726" title="All 2 branches missed.">					if (mrpAmt != 0) {</span>
<span class="nc" id="L727">						String keyGen = game_id + &quot;:&quot;</span>
								+ commBean.getAgentSaleCommRate() + &quot;:&quot;
								+ commBean.getGovtComm() + &quot;:&quot; + transDate;

<span class="nc" id="L731">						darwSaleBean.setMrpAmt(mrpAmt);</span>
<span class="nc" id="L732">						darwSaleBean.setAgtComm(agentComm);</span>
<span class="nc" id="L733">						darwSaleBean.setAgtGoodCauseAmt(goodCauseAmt);</span>
<span class="nc" id="L734">						darwSaleBean.setGameId(game_id);</span>
<span class="nc" id="L735">						darwSaleBean.setTransactinId(result</span>
								.getLong(&quot;transaction_id&quot;));
<span class="nc" id="L737">						darwSaleBean.setTransDate(transDate);</span>

						// modify same as retailer

<span class="nc bnc" id="L741" title="All 2 branches missed.">						if (clmDrawSaleDetailMap.containsKey(keyGen)) {</span>
<span class="nc" id="L742">							beanList = clmDrawSaleDetailMap.get(keyGen);</span>
<span class="nc" id="L743">							beanList.add(darwSaleBean);</span>
<span class="nc" id="L744">							clmDrawSaleDetailMap.put(keyGen, beanList);</span>
						} else {
<span class="nc" id="L746">							beanList = new ArrayList&lt;ClmDrawSaleBean&gt;();</span>
<span class="nc" id="L747">							beanList.add(darwSaleBean);</span>
<span class="nc" id="L748">							clmDrawSaleDetailMap.put(keyGen, beanList);</span>
						}
					}
<span class="nc" id="L751">				}</span>

				// get data from draw sale refund table
<span class="nc" id="L754">				pstmtRefund = con.prepareStatement(fetchDrawRefundClmBal);</span>
<span class="nc" id="L755">				pstmtRefund.setInt(1, userOrgId);</span>
<span class="nc" id="L756">				pstmtRefund.setString(2, status);</span>
<span class="nc" id="L757">				logger</span>
						.debug(&quot;****** Fetch AGENT DRAW REFUND=== &quot;
								+ pstmtRefund);
<span class="nc" id="L760">				ResultSet resultRefund = pstmtRefund.executeQuery();</span>
<span class="nc" id="L761">				List&lt;ClmDrawSaleBean&gt; beanRefundList = new ArrayList&lt;ClmDrawSaleBean&gt;();</span>

				// String keyRefund=&quot;-1&quot;;
<span class="nc bnc" id="L764" title="All 2 branches missed.">				while (resultRefund.next()) {</span>
<span class="nc" id="L765">					commBean = retComMap.get(resultRefund</span>
							.getLong(&quot;transaction_id&quot;));
<span class="nc" id="L767">					darwSaleBean = new ClmDrawSaleBean();</span>
<span class="nc" id="L768">					double mrpAmt = resultRefund.getDouble(&quot;mrp_amt&quot;);</span>
<span class="nc" id="L769">					double agentComm = resultRefund.getDouble(&quot;agent_comm&quot;);</span>
<span class="nc" id="L770">					double goodCauseAmt = resultRefund.getDouble(&quot;govt_comm&quot;);</span>
<span class="nc" id="L771">					int game_id = resultRefund.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L772">					double cancellationCharges = resultRefund</span>
							.getDouble(&quot;cancellation_charges&quot;);
<span class="nc" id="L774">					String refundType = resultRefund</span>
							.getString(&quot;transaction_type&quot;);
<span class="nc" id="L776">					String transDate = resultRefund.getDate(&quot;transaction_date&quot;)</span>
							.toString();
<span class="nc bnc" id="L778" title="All 2 branches missed.">					if (mrpAmt != 0) {</span>
<span class="nc" id="L779">						String keyGenRefund = game_id + &quot;:&quot;</span>
								+ commBean.getAgentSaleCommRate() + &quot;:&quot;
								+ commBean.getGovtComm() + &quot;:&quot; + refundType
								+ &quot;:&quot; + transDate;

<span class="nc" id="L784">						darwSaleBean.setMrpAmt(mrpAmt);</span>
<span class="nc" id="L785">						darwSaleBean.setAgtComm(agentComm);</span>
<span class="nc" id="L786">						darwSaleBean.setAgtGoodCauseAmt(goodCauseAmt);</span>
<span class="nc" id="L787">						darwSaleBean.setGameId(game_id);</span>
<span class="nc" id="L788">						darwSaleBean.setTransactinId(resultRefund</span>
								.getLong(&quot;transaction_id&quot;));
<span class="nc" id="L790">						darwSaleBean.setTransDate(transDate);</span>
<span class="nc" id="L791">						darwSaleBean</span>
								.setCancellationCharges(cancellationCharges);
						// modify same as retailer

<span class="nc bnc" id="L795" title="All 2 branches missed.">						if (clmDrawSaleRefundDetailMap</span>
								.containsKey(keyGenRefund)) {
<span class="nc" id="L797">							beanRefundList = clmDrawSaleRefundDetailMap</span>
									.get(keyGenRefund);
<span class="nc" id="L799">							beanRefundList.add(darwSaleBean);</span>
<span class="nc" id="L800">							clmDrawSaleRefundDetailMap.put(keyGenRefund,</span>
									beanRefundList);
						} else {
<span class="nc" id="L803">							beanRefundList = new ArrayList&lt;ClmDrawSaleBean&gt;();</span>
<span class="nc" id="L804">							beanRefundList.add(darwSaleBean);</span>
<span class="nc" id="L805">							clmDrawSaleRefundDetailMap.put(keyGenRefund,</span>
									beanRefundList);
						}

					}
<span class="nc" id="L810">				}</span>

			}

<span class="nc bnc" id="L814" title="All 4 branches missed.">			if (clmDrawSaleDetailMap != null &amp;&amp; !clmDrawSaleDetailMap.isEmpty()) {</span>
<span class="nc" id="L815">				map.put(&quot;drawSaleMap&quot;, clmDrawSaleDetailMap);</span>
			}
<span class="nc bnc" id="L817" title="All 4 branches missed.">			if (clmDrawSaleRefundDetailMap != null</span>
					&amp;&amp; !clmDrawSaleRefundDetailMap.isEmpty()) {
<span class="nc" id="L819">				map.put(&quot;drawSaleRefundMap&quot;, clmDrawSaleRefundDetailMap);</span>
			}

<span class="nc" id="L822">			return map;</span>

<span class="nc" id="L824">		} catch (SQLException e) {</span>
<span class="nc" id="L825">			e.printStackTrace();</span>
<span class="nc" id="L826">			throw new LMSException(e);</span>
		}
	}

	public Map fetchPwtDetailsOfOrg(int retOrgId, String orgType,
			String status, Connection con) throws LMSException {

<span class="nc" id="L833">		Map map = new TreeMap();</span>
<span class="nc" id="L834">		Map clmPwtDetailMap = new TreeMap();</span>
<span class="nc" id="L835">		ClmPwtBean pwtBean = null;</span>
		try {
<span class="nc" id="L837">			String fetchClmBalOfOrgQuery = &quot;&quot;;</span>
<span class="nc bnc" id="L838" title="All 2 branches missed.">			if (&quot;RETAILER&quot;.equalsIgnoreCase(orgType)) {</span>
<span class="nc" id="L839">				fetchClmBalOfOrgQuery = &quot;select  aaa.game_id, bbb.game_nbr, bbb.game_name, ticket_nbr, &quot;</span>
						+ &quot; aaa.agt_claim_comm ,  aaa.virn_code, aaa.pwt_amt,  aaa.pwt_type, aaa.claim_comm,&quot;
						+ &quot; aaa.name, aaa.transaction_date from((select  virn_code, ticket_nbr, pwt_amt, &quot;
						+ &quot; 'Anonymous' as  'pwt_type' , a.game_id, claim_comm , agt_claim_comm , 'Anonymous'&quot;
						+ &quot; as name, DATE(b.transaction_date) 'transaction_date' from st_se_retailer_pwt a, &quot;
						+ &quot; st_lms_retailer_transaction_master b where status = ?  and  a.retailer_org_id = ?&quot;
						+ &quot; and a.transaction_id = b.transaction_id)  &quot;
						+ &quot;union &quot;
						+ &quot; (select  aa.virn_code, aa.ticket_nbr, aa.pwt_amt , 'direct_plr' as  'pwt_type',  &quot;
						+ &quot; aa.game_id,  aa.claim_comm, agt_claim_comm , concat(bb.first_name, ' ', bb.last_name)&quot;
						+ &quot; 'name', DATE(transaction_date) 'transaction_date' from st_se_retailer_direct_player_pwt aa,&quot;
						+ &quot; st_lms_player_master bb where  pwt_claim_status = ?  and retailer_org_id = ? and &quot;
						+ &quot; aa.player_id = bb.player_id ))aaa, st_se_game_master bbb  where aaa.game_id = &quot;
						+ &quot; bbb.game_id order by aaa.game_id, aaa.transaction_date&quot;;
<span class="nc bnc" id="L853" title="All 2 branches missed.">			} else if (&quot;AGENT&quot;.equalsIgnoreCase(orgType)) {</span>
<span class="nc bnc" id="L854" title="All 4 branches missed.">				fetchClmBalOfOrgQuery = &quot;select  aa.game_id, bb.game_nbr, aa.ticket_nbr, &quot;</span>
						+ &quot; bb.game_name, aa.virn_code, aa.pwt_amt, aa.pwt_type, aa.claim_comm, aa.name, &quot;
						+ &quot; aa.transaction_date from((select a.virn_code,  a.pwt_amt,a.ticket_nbr, 'Anonymous' as 'pwt_type'&quot;
						+ &quot; , a.game_id, a.claim_comm, b.name, DATE(c.transaction_date) 'transaction_date' from&quot;
						+ &quot; st_se_agent_pwt a, st_lms_organization_master b, st_lms_agent_transaction_master c&quot;
						+ &quot; where a.retailer_org_id = b.organization_id  and ( a.status = ? &quot;
						+ (&quot;UNCLAIM_BAL&quot;.equalsIgnoreCase(status) ? &quot; or a.status ='BULK_BO' &quot;
								: &quot;&quot;)
						+ &quot;) and a.agent_org_id = ? and a.transaction_id = c.transaction_id) &quot;
						+ &quot; union &quot;
						+ &quot; ( select virn_code, pwt_amt 'dir_pwt_amt', ticket_nbr,'direct_plr' as 'pwt_type', game_id,&quot;
						+ &quot; claim_comm, concat(b.first_name, ' ', b.last_name) 'name',  DATE(transaction_date)&quot;
						+ &quot; 'transaction_date' from  st_se_agt_direct_player_pwt a, st_lms_player_master b  &quot;
						+ &quot; where a.player_id = b.player_id and ( pwt_claim_status = ? &quot;
						+ (&quot;UNCLAIM_BAL&quot;.equalsIgnoreCase(status) ? &quot; or pwt_claim_status ='BULK_BO' &quot;
								: &quot;&quot;)
						+ &quot; )and agent_org_id = ?))aa, st_se_game_master bb where aa.game_id = bb.game_id &quot;
						+ &quot; order by aa.game_id, aa.transaction_date&quot;;

			}
<span class="nc" id="L874">			logger.debug(fetchClmBalOfOrgQuery);</span>
<span class="nc" id="L875">			PreparedStatement pstmt = con</span>
					.prepareStatement(fetchClmBalOfOrgQuery);
<span class="nc" id="L877">			pstmt.setString(1, status);</span>
<span class="nc" id="L878">			pstmt.setInt(2, retOrgId);</span>
<span class="nc" id="L879">			pstmt.setString(3, status);</span>
<span class="nc" id="L880">			pstmt.setInt(4, retOrgId);</span>
<span class="nc" id="L881">			logger.debug(&quot;********Fetch &quot; + status + &quot; PWT details for &quot;</span>
					+ orgType + &quot; and orgId is &quot; + retOrgId + &quot; query is &quot;
					+ pstmt);
<span class="nc" id="L884">			ResultSet result = pstmt.executeQuery();</span>
<span class="nc" id="L885">			List&lt;ClmPwtBean&gt; beanList = new ArrayList&lt;ClmPwtBean&gt;();</span>
<span class="nc" id="L886">			int gameId = -1;</span>
<span class="nc" id="L887">			double totalClmBal = 0.0;</span>
<span class="nc" id="L888">			int count = 0;</span>
<span class="nc bnc" id="L889" title="All 2 branches missed.">			while (result.next()) {</span>
<span class="nc" id="L890">				count = count + 1;</span>
<span class="nc" id="L891">				pwtBean = new ClmPwtBean();</span>

<span class="nc" id="L893">				double pwtAmt = result.getDouble(&quot;pwt_amt&quot;);</span>
<span class="nc" id="L894">				int game_id = result.getInt(&quot;game_id&quot;);</span>

<span class="nc" id="L896">				totalClmBal = totalClmBal + pwtAmt;</span>

<span class="nc" id="L898">				pwtBean.setVirnCode(result.getString(&quot;virn_code&quot;));</span>
<span class="nc" id="L899">				pwtBean.setTktNbr(result.getString(&quot;ticket_nbr&quot;));</span>
<span class="nc" id="L900">				pwtBean.setPwtAmt(result.getDouble(&quot;pwt_amt&quot;));</span>
<span class="nc" id="L901">				pwtBean.setPwtType(result.getString(&quot;pwt_type&quot;));</span>
<span class="nc" id="L902">				pwtBean.setClaimComm(result.getDouble(&quot;claim_comm&quot;));</span>
<span class="nc" id="L903">				pwtBean.setGameId(result.getInt(&quot;game_id&quot;));</span>
<span class="nc" id="L904">				pwtBean.setGameName(result.getString(&quot;game_name&quot;));</span>
<span class="nc" id="L905">				pwtBean.setGameNbr(result.getInt(&quot;game_nbr&quot;));</span>
<span class="nc" id="L906">				pwtBean.setClaimedBy(result.getString(&quot;name&quot;));</span>
<span class="nc bnc" id="L907" title="All 2 branches missed.">				if (&quot;RETAILER&quot;.equalsIgnoreCase(orgType)) {</span>
<span class="nc" id="L908">					pwtBean.setAgtClaimComm(result.getDouble(&quot;agt_claim_comm&quot;));</span>
				}
<span class="nc" id="L910">				pwtBean.setTransDate(result.getDate(&quot;transaction_date&quot;)</span>
						.toString());

<span class="nc bnc" id="L913" title="All 2 branches missed.">				if (gameId != game_id) {</span>
<span class="nc bnc" id="L914" title="All 2 branches missed.">					if (gameId == -1) {</span>
<span class="nc" id="L915">						beanList.add(pwtBean);</span>
					} else {
<span class="nc" id="L917">						logger.debug(&quot;inside else game_id = &quot; + gameId</span>
								+ &quot;and list size = &quot; + beanList.size());
<span class="nc" id="L919">						clmPwtDetailMap.put(gameId, beanList);</span>
<span class="nc" id="L920">						beanList = new ArrayList&lt;ClmPwtBean&gt;();</span>
<span class="nc" id="L921">						gameId = game_id;</span>
<span class="nc" id="L922">						beanList.add(pwtBean);</span>
					}
<span class="nc" id="L924">					gameId = game_id;</span>
				} else {
<span class="nc" id="L926">					beanList.add(pwtBean);</span>
<span class="nc" id="L927">					gameId = game_id;</span>
				}

				// if result set row is last
<span class="nc bnc" id="L931" title="All 2 branches missed.">				if (result.isLast()) {</span>
<span class="nc" id="L932">					logger.debug(&quot;inside if when result is last game_id = &quot;</span>
							+ gameId + &quot; and list size = &quot; + beanList.size());
<span class="nc" id="L934">					clmPwtDetailMap.put(gameId, beanList);</span>
				}

<span class="nc" id="L937">			}</span>
<span class="nc" id="L938">			logger.debug(&quot;result row size = &quot; + count);</span>
<span class="nc bnc" id="L939" title="All 2 branches missed.">			if (!clmPwtDetailMap.isEmpty()) {</span>
<span class="nc" id="L940">				map.put(&quot;clmPwtDetails&quot;, clmPwtDetailMap);</span>
<span class="nc" id="L941">				map.put(&quot;totalClmBal&quot;, totalClmBal);</span>
			}
<span class="nc" id="L943">			return map;</span>

<span class="nc" id="L945">		} catch (SQLException e) {</span>
<span class="nc" id="L946">			e.printStackTrace();</span>
<span class="nc" id="L947">			throw new LMSException(e);</span>
		}
	}

	public OrgPwtLimitBean fetchPwtLimitsOfOrgnization(int organizationId,
			Connection connection) throws SQLException {
<span class="nc" id="L953">		OrgPwtLimitBean bean = null;</span>
<span class="nc" id="L954">		String query = &quot;select aa.organization_id, verification_limit, approval_limit, pay_limit, scrap_limit,min_claim_per_ticket,max_claim_per_ticket, bb.pwt_scrap from st_lms_oranization_limits aa, st_lms_organization_master bb where  aa.organization_id = bb.organization_id and  aa.organization_id = ?&quot;;</span>
<span class="nc" id="L955">		pstmt = connection.prepareStatement(query);</span>
<span class="nc" id="L956">		pstmt.setInt(1, organizationId);</span>
<span class="nc" id="L957">		result = pstmt.executeQuery();</span>
<span class="nc" id="L958">		logger.debug(&quot;query that fetch limit details = &quot; + pstmt);</span>
<span class="nc bnc" id="L959" title="All 2 branches missed.">		if (result.next()) {</span>
<span class="nc" id="L960">			bean = new OrgPwtLimitBean();</span>
<span class="nc" id="L961">			bean.setOrganizationId(organizationId);</span>
<span class="nc" id="L962">			bean.setVerificationLimit(result.getDouble(&quot;verification_limit&quot;));</span>
<span class="nc" id="L963">			bean.setApprovalLimit(result.getDouble(&quot;approval_limit&quot;));</span>
<span class="nc" id="L964">			bean.setPayLimit(result.getDouble(&quot;pay_limit&quot;));</span>
<span class="nc" id="L965">			bean.setScrapLimit(result.getDouble(&quot;scrap_limit&quot;));</span>
<span class="nc" id="L966">			bean.setIsPwtAutoScrap(result.getString(&quot;pwt_scrap&quot;));</span>
<span class="nc" id="L967">			bean.setMinClaimPerTicket(result.getDouble(&quot;min_claim_per_ticket&quot;));</span>
<span class="nc" id="L968">			bean.setMaxClaimPerTicket(result.getDouble(&quot;max_claim_per_ticket&quot;));</span>
		}
<span class="nc" id="L970">		return bean;</span>
	}

	public ArrayList&lt;String&gt; fetchTerminalIds(int userOrgId) {
<span class="nc" id="L974">		ArrayList&lt;String&gt; termId = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L975">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L976">		StringBuilder sb = new StringBuilder(&quot;&quot;);</span>
		try {
			/*
			 * PreparedStatement ps = con .prepareStatement(&quot;select
			 * m.model_name, i.serial_no from st_lms_inv_model_master m,
			 * st_lms_inv_status i where i.current_owner_id = ? and m.model_id =
			 * i.inv_model_id and (m.model_id = 1 or m.model_id = 2 or
			 * m.model_id = 20)&quot;);
			 */
<span class="nc" id="L985">			PreparedStatement ps = con</span>
					.prepareStatement(&quot;select m.model_name, i.serial_no,m.model_id from st_lms_inv_model_master m, st_lms_inv_status i where i.current_owner_id = ? and m.model_id = i.inv_model_id and m.is_req_on_reg='YES' and i.current_owner_type != 'REMOVED'&quot;);
<span class="nc" id="L987">			ps.setInt(1, userOrgId);</span>
<span class="nc" id="L988">			ResultSet rs = ps.executeQuery();</span>
<span class="nc" id="L989">			String modelName = &quot;&quot;;</span>
<span class="nc" id="L990">			String serialNo = &quot;&quot;;</span>

<span class="nc bnc" id="L992" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L993">				modelName = rs.getString(&quot;model_name&quot;);</span>
<span class="nc" id="L994">				serialNo = rs.getString(&quot;serial_no&quot;);</span>
<span class="nc" id="L995">				termId.add(modelName + &quot;-&quot; + serialNo+&quot;-&quot;+rs.getString(&quot;model_id&quot;));</span>
			}

<span class="nc" id="L998">		} catch (Exception e) {</span>
<span class="nc" id="L999">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L1001">			try {</span>
<span class="nc" id="L1002">				con.close();</span>
<span class="nc" id="L1003">			} catch (SQLException e) {</span>
<span class="nc" id="L1004">				e.printStackTrace();</span>
<span class="nc" id="L1005">			}</span>
<span class="nc" id="L1006">		}</span>
<span class="nc" id="L1007">		return termId;</span>
	}

	public ArrayList&lt;String&gt; fetchTerminalSerialNos(int userOrgId,
			String modelName) {
<span class="nc" id="L1012">		ArrayList&lt;String&gt; serialNoList = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L1013">		Connection con = DBConnect.getConnection();</span>
		try {
<span class="nc" id="L1015">			PreparedStatement ps = con</span>
					.prepareStatement(&quot;select i.serial_no from st_lms_inv_model_master m, st_lms_inv_status i where i.current_owner_id = ? and m.model_id = i.inv_model_id and m.model_name = ? and  m.is_req_on_reg='YES' order by i.serial_no&quot;);
<span class="nc" id="L1017">			ps.setInt(1, userOrgId);</span>
<span class="nc" id="L1018">			ps.setString(2, modelName);</span>
<span class="nc" id="L1019">			ResultSet rs = ps.executeQuery();</span>
<span class="nc" id="L1020">			System.out.println(&quot;Terminal Serial No Query:&quot; + ps);</span>

<span class="nc bnc" id="L1022" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1023">				serialNoList.add(rs.getString(&quot;serial_no&quot;));</span>
			}
<span class="nc" id="L1025">		} catch (Exception e) {</span>
<span class="nc" id="L1026">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L1028">			DBConnect.closeCon(con);</span>
<span class="nc" id="L1029">		}</span>
<span class="nc" id="L1030">		return serialNoList;</span>
	}

	public ArrayList&lt;String&gt; fetchTerminalModelNames(int userOrgId) {
<span class="nc" id="L1034">		ArrayList&lt;String&gt; modelNamesList = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L1035">		Connection con = DBConnect.getConnection();</span>
		try {
<span class="nc" id="L1037">			PreparedStatement ps = con</span>
					.prepareStatement(&quot;select distinct(model_name) from st_lms_inv_status, st_lms_inv_model_master where current_owner_id = ? and model_id = inv_model_id and is_req_on_reg = 'YES' and inv_id=? &quot;);
<span class="nc" id="L1039">			ps.setInt(1, userOrgId);</span>
<span class="nc" id="L1040">			ps.setInt(2, 1);// Get Models Of Terminal </span>
<span class="nc" id="L1041">			ResultSet rs = ps.executeQuery();</span>
<span class="nc" id="L1042">			System.out.println(&quot;Terminal Model Names Query:&quot; + ps);</span>

<span class="nc bnc" id="L1044" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1045">				modelNamesList.add(rs.getString(&quot;model_name&quot;));</span>
			}
<span class="nc" id="L1047">		} catch (Exception e) {</span>
<span class="nc" id="L1048">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L1050">			DBConnect.closeCon(con);</span>
<span class="nc" id="L1051">		}</span>
<span class="nc" id="L1052">		return modelNamesList;</span>
	}
	public ArrayList&lt;String&gt; fetchInvModelNames(int userOrgId) {
<span class="nc" id="L1055">		ArrayList&lt;String&gt; modelNamesList = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L1056">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L1057">		PreparedStatement ps =null;</span>
		try {
<span class="nc" id="L1059">			ps = con.prepareStatement(&quot;select distinct(model_name) from st_lms_inv_status, st_lms_inv_model_master where current_owner_id = ? and model_id = inv_model_id and is_req_on_reg = 'YES' and inv_id!=? &quot;);</span>
<span class="nc" id="L1060">			ps.setInt(1, userOrgId);</span>
<span class="nc" id="L1061">			ps.setInt(2, 1);// Get Models Of Terminal </span>
<span class="nc" id="L1062">			ResultSet rs = ps.executeQuery();</span>
<span class="nc" id="L1063">			logger.debug(&quot;Inv Model Names Query:&quot; + ps);</span>

<span class="nc bnc" id="L1065" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1066">				modelNamesList.add(rs.getString(&quot;model_name&quot;));</span>
			}
<span class="nc" id="L1068">		} catch (Exception e) {</span>
<span class="nc" id="L1069">			logger.error(&quot;exception&quot;,e);</span>
<span class="nc" id="L1070">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L1072">			DBConnect.closeConnection(con, ps);</span>
<span class="nc" id="L1073">		}</span>
<span class="nc" id="L1074">		return modelNamesList;</span>
	}
	public Map fetchUnCLMPwtDetailsOfOrg(int userOrgId, String orgType,
			String status) throws LMSException {
<span class="nc" id="L1078">		Connection connection = DBConnect.getConnection();</span>
		try {

<span class="nc" id="L1081">			boolean isDraw = &quot;YES&quot;.equalsIgnoreCase(LMSFilterDispatcher</span>
					.getIsDraw());
<span class="nc" id="L1083">			boolean isScratch = &quot;YES&quot;.equalsIgnoreCase(LMSFilterDispatcher</span>
					.getIsScratch());

<span class="nc" id="L1086">			logger.debug(&quot; user org id = &quot; + userOrgId + &quot;   , orgType = &quot;</span>
					+ orgType + &quot;   , status = &quot; + status);
			// fetch scratch game PWT details
<span class="nc" id="L1089">			Map map = null;</span>
<span class="nc" id="L1090">			Map detailMap = null;</span>
<span class="nc" id="L1091">			Map newDetailMap = new TreeMap();</span>
<span class="nc" id="L1092">			Map newGameWiseTotAmt = new TreeMap();</span>

<span class="nc bnc" id="L1094" title="All 2 branches missed.">			if (isScratch) {</span>
<span class="nc" id="L1095">				map = fetchPwtDetailsOfOrg(userOrgId, orgType, status,</span>
						connection);
<span class="nc" id="L1097">				detailMap = (Map) map.get(&quot;clmPwtDetails&quot;);</span>
				// create game details map game name wise

<span class="nc bnc" id="L1100" title="All 4 branches missed.">				if (detailMap != null &amp;&amp; !detailMap.isEmpty()) {</span>
<span class="nc" id="L1101">					Set gameIdSet = detailMap.keySet();</span>
<span class="nc bnc" id="L1102" title="All 2 branches missed.">					for (Object gameId : gameIdSet) {</span>
<span class="nc" id="L1103">						List&lt;ClmPwtBean&gt; clmBeanList = (List&lt;ClmPwtBean&gt;) detailMap</span>
								.get(gameId);
<span class="nc" id="L1105">						String gameName = &quot;&quot;;</span>
<span class="nc" id="L1106">						double pwtAmtSum = 0.0;</span>
<span class="nc bnc" id="L1107" title="All 2 branches missed.">						for (ClmPwtBean clmPwtBean : clmBeanList) {</span>
<span class="nc" id="L1108">							gameName = clmPwtBean.getGameNbr() + &quot;-&quot;</span>
									+ clmPwtBean.getGameName();
<span class="nc" id="L1110">							pwtAmtSum = pwtAmtSum + clmPwtBean.getPwtAmt();</span>
<span class="nc" id="L1111">						}</span>
<span class="nc" id="L1112">						newDetailMap.put(gameName, clmBeanList);</span>
<span class="nc" id="L1113">						newGameWiseTotAmt.put(gameName, pwtAmtSum);</span>
<span class="nc" id="L1114">					}</span>
				}
			}

			// fetch Draw game PWT details
<span class="nc" id="L1119">			Map drawMap = new TreeMap();</span>
<span class="nc bnc" id="L1120" title="All 2 branches missed.">			if (isDraw) {</span>

<span class="nc bnc" id="L1122" title="All 2 branches missed.">				if (&quot;AGENT&quot;.equalsIgnoreCase(orgType.trim())) {</span>
<span class="nc" id="L1123">					drawMap = fetchDGPwtDetailsOfAgtOrg(userOrgId, orgType,</span>
							status, connection);
				} else {
<span class="nc" id="L1126">					drawMap = fetchDGPwtDetailsOfRetOrg(userOrgId, orgType,</span>
							status, connection);
				}
			}
			// Map drawDetailMap = (Map)map.get(&quot;clmPwtDetails&quot;);

<span class="nc" id="L1132">			map = new TreeMap();</span>
<span class="nc" id="L1133">			map.put(&quot;unclmPwtDet&quot;, newDetailMap);</span>
<span class="nc" id="L1134">			map.put(&quot;totalUnclmBal&quot;, newGameWiseTotAmt);</span>
<span class="nc" id="L1135">			map.put(&quot;DRClmPwtDetailMap&quot;, drawMap.get(&quot;DRClmPwtDetailMap&quot;));</span>
<span class="nc" id="L1136">			map.put(&quot;newDRGameWiseTotAmt&quot;, drawMap.get(&quot;newDRGameWiseTotAmt&quot;));</span>

<span class="nc" id="L1138">			return map;</span>

<span class="nc" id="L1140">		} catch (Exception e) {</span>
<span class="nc" id="L1141">			e.printStackTrace();</span>
<span class="nc" id="L1142">			throw new LMSException(e);</span>
		} finally {
<span class="nc" id="L1144">			try {</span>
<span class="nc bnc" id="L1145" title="All 4 branches missed.">				if (connection != null) {</span>
<span class="nc" id="L1146">					connection.close();</span>
				}
<span class="nc" id="L1148">			} catch (SQLException se) {</span>
<span class="nc" id="L1149">				se.printStackTrace();</span>
<span class="nc" id="L1150">				throw new LMSException(se);</span>
<span class="nc" id="L1151">			}</span>
		}
	}

/*	public String generateReceiptBo(Connection connection, int partyId,
			String partyType, Map&lt;String, List&lt;Integer&gt;&gt; transIdMap)
			throws LMSException {
		try {
			Set&lt;String&gt; dateKeys = transIdMap.keySet();
			StringBuilder result = new StringBuilder(&quot;&quot;);
			for (String date : dateKeys) {
				List&lt;Integer&gt; transIdList = transIdMap.get(date);

				// get latest generated receipt number
				PreparedStatement autoGenRecptPstmtBO = connection
						.prepareStatement(QueryManager.getBOLatestReceiptNb());
				autoGenRecptPstmtBO.setString(1, &quot;RECEIPT&quot;);
				ResultSet recieptRsBO = autoGenRecptPstmtBO.executeQuery();

				String autoGeneRecieptNoBO = null;
				if (recieptRsBO.next()) {
					String lastRecieptNoGeneratedBO = recieptRsBO
							.getString(&quot;generated_id&quot;);
					autoGeneRecieptNoBO = GenerateRecieptNo.getRecieptNo(
							&quot;RECEIPT&quot;, lastRecieptNoGeneratedBO, &quot;BO&quot;);
				} else {
					autoGeneRecieptNoBO = GenerateRecieptNo.getRecieptNo(
							&quot;RECEIPT&quot;, null, &quot;BO&quot;);
				}

				// for generating receipt********************

				PreparedStatement boReceiptPstmt = connection
						.prepareStatement(QueryManager.insertInReceiptMaster());
				boReceiptPstmt.setString(1, &quot;BO&quot;);
				boReceiptPstmt.executeUpdate();
				int boReceiptId = -1;
				ResultSet boRSet = boReceiptPstmt.getGeneratedKeys();
				if (boRSet.next()) {
					boReceiptId = boRSet.getInt(1);

					boReceiptPstmt = connection.prepareStatement(QueryManager
							.insertInBOReceipts());
					boReceiptPstmt.setInt(1, boReceiptId);
					boReceiptPstmt.setString(2, &quot;RECEIPT&quot;);
					boReceiptPstmt.setInt(3, partyId);
					boReceiptPstmt.setString(4, partyType);
					boReceiptPstmt.setString(5, autoGeneRecieptNoBO);
					boReceiptPstmt.execute();

					PreparedStatement boReceiptMappingPstmt = connection
							.prepareStatement(QueryManager
									.insertBOReceiptTrnMapping());
					for (Integer transId : transIdList) {
						boReceiptMappingPstmt.setInt(1, boReceiptId);
						boReceiptMappingPstmt.setInt(2, transId);
						boReceiptMappingPstmt.execute();
					}

				}
				result.append(boReceiptId + &quot;-&quot; + autoGeneRecieptNoBO + &quot;;&quot;);
			}
			return result.toString();
		} catch (SQLException e) {
			e.printStackTrace();
			throw new LMSException();
		}
	}*/

	public String generateReceiptBoNew(Connection connection, int partyId,
			String partyType, Map&lt;String, List&lt;Long&gt;&gt; transIdMap)
			throws LMSException {
		try {
<span class="nc" id="L1224">			Set&lt;String&gt; dateKeys = transIdMap.keySet();</span>
<span class="nc" id="L1225">			StringBuilder result = new StringBuilder(&quot;&quot;);</span>
<span class="nc" id="L1226">			List&lt;Long&gt; transIdList = new ArrayList&lt;Long&gt;();</span>
			//for (String date : dateKeys) {
				//List&lt;Integer&gt; transIdList = transIdMap.get(date);
<span class="nc bnc" id="L1229" title="All 2 branches missed.">				for (String date : dateKeys) {</span>
	                //trnIdListInvoice = trnIdMapInvoice.get(date);
<span class="nc" id="L1231">					transIdList.addAll(transIdMap.get(date)) ;</span>
<span class="nc" id="L1232">					}</span>
				// get latest generated receipt number
<span class="nc" id="L1234">				PreparedStatement autoGenRecptPstmtBO = connection</span>
						.prepareStatement(QueryManager.getBOLatestReceiptNb());
<span class="nc" id="L1236">				autoGenRecptPstmtBO.setString(1, &quot;RECEIPT&quot;);</span>
<span class="nc" id="L1237">				ResultSet recieptRsBO = autoGenRecptPstmtBO.executeQuery();</span>

<span class="nc" id="L1239">				String autoGeneRecieptNoBO = null;</span>
<span class="nc bnc" id="L1240" title="All 2 branches missed.">				if (recieptRsBO.next()) {</span>
<span class="nc" id="L1241">					String lastRecieptNoGeneratedBO = recieptRsBO</span>
							.getString(&quot;generated_id&quot;);
<span class="nc" id="L1243">					autoGeneRecieptNoBO = GenerateRecieptNo.getRecieptNo(</span>
							&quot;RECEIPT&quot;, lastRecieptNoGeneratedBO, &quot;BO&quot;);
<span class="nc" id="L1245">				} else {</span>
<span class="nc" id="L1246">					autoGeneRecieptNoBO = GenerateRecieptNo.getRecieptNo(</span>
							&quot;RECEIPT&quot;, null, &quot;BO&quot;);
				}

				// for generating receipt********************

<span class="nc" id="L1252">				PreparedStatement boReceiptPstmt = connection</span>
						.prepareStatement(QueryManager.insertInReceiptMaster());
<span class="nc" id="L1254">				boReceiptPstmt.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L1255">				boReceiptPstmt.executeUpdate();</span>
<span class="nc" id="L1256">				int boReceiptId = -1;</span>
<span class="nc" id="L1257">				ResultSet boRSet = boReceiptPstmt.getGeneratedKeys();</span>
<span class="nc bnc" id="L1258" title="All 2 branches missed.">				if (boRSet.next()) {</span>
<span class="nc" id="L1259">					boReceiptId = boRSet.getInt(1);</span>

<span class="nc" id="L1261">					boReceiptPstmt = connection.prepareStatement(QueryManager</span>
							.insertInBOReceipts());
<span class="nc" id="L1263">					boReceiptPstmt.setInt(1, boReceiptId);</span>
<span class="nc" id="L1264">					boReceiptPstmt.setString(2, &quot;RECEIPT&quot;);</span>
<span class="nc" id="L1265">					boReceiptPstmt.setInt(3, partyId);</span>
<span class="nc" id="L1266">					boReceiptPstmt.setString(4, partyType);</span>
<span class="nc" id="L1267">					boReceiptPstmt.setString(5, autoGeneRecieptNoBO);</span>
<span class="nc" id="L1268">					boReceiptPstmt.setTimestamp(6, Util.getCurrentTimeStamp());</span>
<span class="nc" id="L1269">					boReceiptPstmt.execute();</span>

<span class="nc" id="L1271">					PreparedStatement boReceiptMappingPstmt = connection</span>
							.prepareStatement(QueryManager
									.insertBOReceiptTrnMapping());
<span class="nc bnc" id="L1274" title="All 2 branches missed.">					for (Long transId : transIdList) {</span>
<span class="nc" id="L1275">						boReceiptMappingPstmt.setInt(1, boReceiptId);</span>
<span class="nc" id="L1276">						boReceiptMappingPstmt.setLong(2, transId);</span>
<span class="nc" id="L1277">						boReceiptMappingPstmt.execute();</span>
<span class="nc" id="L1278">					}</span>

				}
<span class="nc" id="L1281">				result.append(boReceiptId + &quot;-&quot; + autoGeneRecieptNoBO + &quot;;&quot;);</span>
			//}
<span class="nc" id="L1283">			return result.toString();</span>
<span class="nc" id="L1284">		} catch (SQLException e) {</span>
<span class="nc" id="L1285">			e.printStackTrace();</span>
<span class="nc" id="L1286">			throw new LMSException();</span>
		}
	}
	
	public String generateReceiptDGBo(Connection connection, int partyId,
			String partyType, Map&lt;String, List&lt;Long&gt;&gt; transIdMap)
			throws LMSException {
		try {
<span class="nc" id="L1294">			Set&lt;String&gt; dateKeys = transIdMap.keySet();</span>
<span class="nc" id="L1295">			StringBuilder result = new StringBuilder(&quot;&quot;);</span>
<span class="nc bnc" id="L1296" title="All 2 branches missed.">			for (String date : dateKeys) {</span>
<span class="nc" id="L1297">				List&lt;Long&gt; transIdList = transIdMap.get(date);</span>

				// get latest generated receipt number
				// PreparedStatement autoGenRecptPstmtBO =
				// connection.prepareStatement(QueryManager.getBOLatestReceiptNb());
<span class="nc" id="L1302">				String query = &quot;SELECT generated_id from st_lms_bo_receipts where receipt_type='DG_INVOICE' or receipt_type='DG_RECEIPT' ORDER BY generated_id DESC LIMIT 1&quot;;</span>
<span class="nc" id="L1303">				PreparedStatement autoGenRecptPstmtBO = connection</span>
						.prepareStatement(query);
				// autoGenRecptPstmtBO.setString(1, &quot;DG_RECEIPT&quot;);
<span class="nc" id="L1306">				ResultSet recieptRsBO = autoGenRecptPstmtBO.executeQuery();</span>

<span class="nc" id="L1308">				String autoGeneRecieptNoBO = null;</span>
<span class="nc bnc" id="L1309" title="All 2 branches missed.">				if (recieptRsBO.next()) {</span>
<span class="nc" id="L1310">					String lastRecieptNoGeneratedBO = recieptRsBO</span>
							.getString(&quot;generated_id&quot;);
<span class="nc" id="L1312">					autoGeneRecieptNoBO = GenerateRecieptNo.getRecieptNo(</span>
							&quot;DG_RECEIPT&quot;, lastRecieptNoGeneratedBO, &quot;BO&quot;);
<span class="nc" id="L1314">				} else {</span>
<span class="nc" id="L1315">					autoGeneRecieptNoBO = GenerateRecieptNo.getRecieptNo(</span>
							&quot;DG_RECEIPT&quot;, null, &quot;BO&quot;);
				}

				// for generating receipt********************

<span class="nc" id="L1321">				PreparedStatement boReceiptPstmt = connection</span>
						.prepareStatement(QueryManager.insertInReceiptMaster());
<span class="nc" id="L1323">				boReceiptPstmt.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L1324">				boReceiptPstmt.executeUpdate();</span>
<span class="nc" id="L1325">				int boReceiptId = -1;</span>
<span class="nc" id="L1326">				ResultSet boRSet = boReceiptPstmt.getGeneratedKeys();</span>
<span class="nc bnc" id="L1327" title="All 2 branches missed.">				if (boRSet.next()) {</span>
<span class="nc" id="L1328">					boReceiptId = boRSet.getInt(1);</span>

<span class="nc" id="L1330">					boReceiptPstmt = connection.prepareStatement(QueryManager</span>
							.insertInBOReceipts());
<span class="nc" id="L1332">					boReceiptPstmt.setInt(1, boReceiptId);</span>
<span class="nc" id="L1333">					boReceiptPstmt.setString(2, &quot;DG_RECEIPT&quot;);</span>
<span class="nc" id="L1334">					boReceiptPstmt.setInt(3, partyId);</span>
<span class="nc" id="L1335">					boReceiptPstmt.setString(4, partyType);</span>
<span class="nc" id="L1336">					boReceiptPstmt.setString(5, autoGeneRecieptNoBO);</span>
<span class="nc" id="L1337">					boReceiptPstmt.setTimestamp(6, Util.getCurrentTimeStamp());</span>
<span class="nc" id="L1338">					boReceiptPstmt.execute();</span>

<span class="nc" id="L1340">					PreparedStatement boReceiptMappingPstmt = connection</span>
							.prepareStatement(QueryManager
									.insertBOReceiptTrnMapping());
<span class="nc bnc" id="L1343" title="All 2 branches missed.">					for (Long transId : transIdList) {</span>
<span class="nc" id="L1344">						boReceiptMappingPstmt.setInt(1, boReceiptId);</span>
<span class="nc" id="L1345">						boReceiptMappingPstmt.setLong(2, transId);</span>
<span class="nc" id="L1346">						boReceiptMappingPstmt.execute();</span>
<span class="nc" id="L1347">					}</span>

				}

<span class="nc" id="L1351">				result.append(boReceiptId + &quot;-&quot; + autoGeneRecieptNoBO + &quot;;&quot;);</span>
<span class="nc" id="L1352">			}</span>

<span class="nc" id="L1354">			return result.toString();</span>
<span class="nc" id="L1355">		} catch (SQLException e) {</span>
<span class="nc" id="L1356">			e.printStackTrace();</span>
<span class="nc" id="L1357">			throw new LMSException();</span>
		}
	}

	public synchronized String generateReciptForPwt(
			Map&lt;String, List&lt;Long&gt;&gt; transIdMap, Connection connection,
			int userOrgID, int partyId, String partyType, String recType) {
<span class="nc" id="L1364">		int agtReceiptId = -1;</span>
<span class="nc" id="L1365">		StringBuilder receipts = new StringBuilder(&quot;&quot;);</span>
		// int boReceiptId=-1;
<span class="nc" id="L1367">		PreparedStatement agtReceiptPstmt = null;</span>
<span class="nc" id="L1368">		PreparedStatement agtReceiptMappingPstmt = null;</span>
<span class="nc" id="L1369">		String receiptType = null;</span>
		try {
<span class="nc" id="L1371">			Set&lt;String&gt; transDate = transIdMap.keySet();</span>
<span class="nc bnc" id="L1372" title="All 2 branches missed.">			for (String date : transDate) {</span>
<span class="nc" id="L1373">				List&lt;Long&gt; transIdList = transIdMap.get(date);</span>
				// for generating receipt********************
				// insert in receipt master
<span class="nc" id="L1376">				agtReceiptPstmt = connection.prepareStatement(QueryManager</span>
						.insertInReceiptMaster());
<span class="nc" id="L1378">				agtReceiptPstmt.setString(1, &quot;AGENT&quot;);</span>
<span class="nc" id="L1379">				agtReceiptPstmt.executeUpdate();</span>
<span class="nc bnc" id="L1380" title="All 2 branches missed.">				if (&quot;DRAWGAME&quot;.equalsIgnoreCase(recType)) {</span>
<span class="nc" id="L1381">					receiptType = &quot;DG_RECEIPT&quot;;</span>
				} else {
<span class="nc" id="L1383">					receiptType = &quot;RECEIPT&quot;;</span>
				}
<span class="nc" id="L1385">				ResultSet agtRSet = agtReceiptPstmt.getGeneratedKeys();</span>
<span class="nc bnc" id="L1386" title="All 2 branches missed.">				while (agtRSet.next()) {</span>
<span class="nc" id="L1387">					agtReceiptId = agtRSet.getInt(1);</span>
<span class="nc" id="L1388">					logger.debug(&quot;Receipt Id:&quot; + agtReceiptId);</span>
				}

<span class="nc" id="L1391">				PreparedStatement autoGenRecptPstmt = null;</span>
<span class="nc bnc" id="L1392" title="All 2 branches missed.">				if (receiptType.equalsIgnoreCase(&quot;RECEIPT&quot;)) {</span>
<span class="nc" id="L1393">					autoGenRecptPstmt = connection</span>
							.prepareStatement(QueryManager
									.getAGENTLatestReceiptNb());
<span class="nc" id="L1396">					autoGenRecptPstmt.setString(1, receiptType);</span>
<span class="nc" id="L1397">					autoGenRecptPstmt.setInt(2, userOrgID);</span>
				} else {
<span class="nc bnc" id="L1399" title="All 2 branches missed.">					if (receiptType.equalsIgnoreCase(&quot;DG_RECEIPT&quot;)) {</span>
<span class="nc" id="L1400">						String query = &quot;SELECT generated_id from st_lms_agent_receipts where (receipt_type='DG_INVOICE' or receipt_type='DG_RECEIPT') and agent_org_id=&quot;</span>
								+ userOrgID
								+ &quot; ORDER BY generated_id DESC LIMIT 1&quot;;
<span class="nc" id="L1403">						autoGenRecptPstmt = connection.prepareStatement(query);</span>
					}
				}

<span class="nc" id="L1407">				ResultSet recieptRs = autoGenRecptPstmt.executeQuery();</span>
<span class="nc" id="L1408">				String lastRecieptNoGenerated = null;</span>

<span class="nc bnc" id="L1410" title="All 2 branches missed.">				while (recieptRs.next()) {</span>
<span class="nc" id="L1411">					lastRecieptNoGenerated = recieptRs</span>
							.getString(&quot;generated_id&quot;);
				}

<span class="nc" id="L1415">				String autoGeneRecieptNoAgt = GenerateRecieptNo</span>
						.getRecieptNoAgt(receiptType, lastRecieptNoGenerated,
								&quot;AGENT&quot;, userOrgID);

				// insert in agent receipts
				// agtReceiptQuery = QueryManager.getST1AgtReceiptsQuery();
<span class="nc" id="L1421">				agtReceiptPstmt = connection.prepareStatement(QueryManager</span>
						.insertInAgentReceipts());
<span class="nc" id="L1423">				agtReceiptPstmt.setInt(1, agtReceiptId);</span>
<span class="nc" id="L1424">				agtReceiptPstmt.setString(2, receiptType);</span>
<span class="nc" id="L1425">				agtReceiptPstmt.setInt(3, userOrgID);</span>
<span class="nc" id="L1426">				agtReceiptPstmt.setInt(4, partyId);</span>
<span class="nc" id="L1427">				agtReceiptPstmt.setString(5, partyType);</span>
<span class="nc" id="L1428">				agtReceiptPstmt.setString(6, autoGeneRecieptNoAgt);</span>
<span class="nc" id="L1429">				agtReceiptPstmt.setTimestamp(7, Util.getCurrentTimeStamp());</span>
<span class="nc" id="L1430">				agtReceiptPstmt.execute();</span>

				// insert agetn receipt trn mapping

				// agtReceiptMappingQuery =
				// QueryManager.getST1AgtReceiptsMappingQuery();
<span class="nc" id="L1436">				agtReceiptMappingPstmt = connection</span>
						.prepareStatement(QueryManager
								.insertAgentReceiptTrnMapping());

<span class="nc bnc" id="L1440" title="All 2 branches missed.">				for (int i = 0; i &lt; transIdList.size(); i++) {</span>
<span class="nc" id="L1441">					agtReceiptMappingPstmt.setInt(1, agtReceiptId);</span>
<span class="nc" id="L1442">					agtReceiptMappingPstmt.setLong(2, transIdList.get(i));</span>
<span class="nc" id="L1443">					agtReceiptMappingPstmt.execute();</span>
				}
<span class="nc" id="L1445">				receipts.append(agtReceiptId + &quot;-&quot; + autoGeneRecieptNoAgt);</span>
<span class="nc" id="L1446">			}</span>
<span class="nc" id="L1447">		} catch (SQLException e) {</span>
<span class="nc" id="L1448">			e.printStackTrace();</span>
<span class="nc" id="L1449">		}</span>

<span class="nc" id="L1451">		return receipts.toString();</span>
	}

	public synchronized String generateReciptForPwtNew(
			Map&lt;String, List&lt;Long&gt;&gt; transIdMap, Connection connection,
			int userOrgID, int partyId, String partyType, String recType) {
<span class="nc" id="L1457">		int agtReceiptId = -1;</span>
<span class="nc" id="L1458">		StringBuilder receipts = new StringBuilder(&quot;&quot;);</span>
		// int boReceiptId=-1;
<span class="nc" id="L1460">		PreparedStatement agtReceiptPstmt = null;</span>
<span class="nc" id="L1461">		PreparedStatement agtReceiptMappingPstmt = null;</span>
<span class="nc" id="L1462">		String receiptType = null;</span>
<span class="nc" id="L1463">		List&lt;Long&gt; transIdList = new ArrayList&lt;Long&gt;();</span>
		try {
<span class="nc" id="L1465">			Set&lt;String&gt; transDate = transIdMap.keySet();</span>
			//for (String date : transDate) {
				//List&lt;Integer&gt; transIdList = transIdMap.get(date);
<span class="nc bnc" id="L1468" title="All 2 branches missed.">				for (String date : transDate) {</span>
	                //trnIdListInvoice = trnIdMapInvoice.get(date);
<span class="nc" id="L1470">					transIdList.addAll(transIdMap.get(date)) ;</span>
<span class="nc" id="L1471">					}</span>
				// for generating receipt********************
				// insert in receipt master
<span class="nc" id="L1474">				agtReceiptPstmt = connection.prepareStatement(QueryManager</span>
						.insertInReceiptMaster());
<span class="nc" id="L1476">				agtReceiptPstmt.setString(1, &quot;AGENT&quot;);</span>
<span class="nc" id="L1477">				agtReceiptPstmt.executeUpdate();</span>
<span class="nc bnc" id="L1478" title="All 2 branches missed.">				if (&quot;DRAWGAME&quot;.equalsIgnoreCase(recType)) {</span>
<span class="nc" id="L1479">					receiptType = &quot;DG_RECEIPT&quot;;</span>
				} else {
<span class="nc" id="L1481">					receiptType = &quot;RECEIPT&quot;;</span>
				}
<span class="nc" id="L1483">				ResultSet agtRSet = agtReceiptPstmt.getGeneratedKeys();</span>
<span class="nc bnc" id="L1484" title="All 2 branches missed.">				while (agtRSet.next()) {</span>
<span class="nc" id="L1485">					agtReceiptId = agtRSet.getInt(1);</span>
<span class="nc" id="L1486">					logger.debug(&quot;Receipt Id:&quot; + agtReceiptId);</span>
				}

<span class="nc" id="L1489">				PreparedStatement autoGenRecptPstmt = null;</span>
<span class="nc bnc" id="L1490" title="All 2 branches missed.">				if (receiptType.equalsIgnoreCase(&quot;RECEIPT&quot;)) {</span>
<span class="nc" id="L1491">					autoGenRecptPstmt = connection</span>
							.prepareStatement(QueryManager
									.getAGENTLatestReceiptNb());
<span class="nc" id="L1494">					autoGenRecptPstmt.setString(1, receiptType);</span>
<span class="nc" id="L1495">					autoGenRecptPstmt.setInt(2, userOrgID);</span>
				} else {
<span class="nc bnc" id="L1497" title="All 2 branches missed.">					if (receiptType.equalsIgnoreCase(&quot;DG_RECEIPT&quot;)) {</span>
<span class="nc" id="L1498">						String query = &quot;SELECT generated_id from st_lms_agent_receipts where (receipt_type='DG_INVOICE' or receipt_type='DG_RECEIPT') and agent_org_id=&quot;</span>
								+ userOrgID
								+ &quot; ORDER BY generated_id DESC LIMIT 1&quot;;
<span class="nc" id="L1501">						autoGenRecptPstmt = connection.prepareStatement(query);</span>
					}
				}

<span class="nc" id="L1505">				ResultSet recieptRs = autoGenRecptPstmt.executeQuery();</span>
<span class="nc" id="L1506">				String lastRecieptNoGenerated = null;</span>

<span class="nc bnc" id="L1508" title="All 2 branches missed.">				while (recieptRs.next()) {</span>
<span class="nc" id="L1509">					lastRecieptNoGenerated = recieptRs</span>
							.getString(&quot;generated_id&quot;);
				}

<span class="nc" id="L1513">				String autoGeneRecieptNoAgt = GenerateRecieptNo</span>
						.getRecieptNoAgt(receiptType, lastRecieptNoGenerated,
								&quot;AGENT&quot;, userOrgID);

				// insert in agent receipts
				// agtReceiptQuery = QueryManager.getST1AgtReceiptsQuery();
<span class="nc" id="L1519">				agtReceiptPstmt = connection.prepareStatement(QueryManager</span>
						.insertInAgentReceipts());
<span class="nc" id="L1521">				agtReceiptPstmt.setInt(1, agtReceiptId);</span>
<span class="nc" id="L1522">				agtReceiptPstmt.setString(2, receiptType);</span>
<span class="nc" id="L1523">				agtReceiptPstmt.setInt(3, userOrgID);</span>
<span class="nc" id="L1524">				agtReceiptPstmt.setInt(4, partyId);</span>
<span class="nc" id="L1525">				agtReceiptPstmt.setString(5, partyType);</span>
<span class="nc" id="L1526">				agtReceiptPstmt.setString(6, autoGeneRecieptNoAgt);</span>
<span class="nc" id="L1527">				agtReceiptPstmt.setTimestamp(7, Util.getCurrentTimeStamp());</span>
<span class="nc" id="L1528">				agtReceiptPstmt.execute();</span>

				// insert agetn receipt trn mapping

				// agtReceiptMappingQuery =
				// QueryManager.getST1AgtReceiptsMappingQuery();
<span class="nc" id="L1534">				agtReceiptMappingPstmt = connection</span>
						.prepareStatement(QueryManager
								.insertAgentReceiptTrnMapping());

<span class="nc bnc" id="L1538" title="All 2 branches missed.">				for (int i = 0; i &lt; transIdList.size(); i++) {</span>
<span class="nc" id="L1539">					agtReceiptMappingPstmt.setInt(1, agtReceiptId);</span>
<span class="nc" id="L1540">					agtReceiptMappingPstmt.setLong(2, transIdList.get(i));</span>
<span class="nc" id="L1541">					agtReceiptMappingPstmt.execute();</span>
				}
<span class="nc" id="L1543">				receipts.append(agtReceiptId + &quot;-&quot; + autoGeneRecieptNoAgt);</span>
			//}
<span class="nc" id="L1545">		} catch (SQLException e) {</span>
<span class="nc" id="L1546">			e.printStackTrace();</span>
<span class="nc" id="L1547">		}</span>

<span class="nc" id="L1549">		return receipts.toString();</span>
	}
	public List&lt;OrgBean&gt; getAgentOrgList() {
<span class="nc" id="L1552">		List&lt;OrgBean&gt; list = new ArrayList&lt;OrgBean&gt;(0);</span>
<span class="nc" id="L1553">		OrgBean Bean = null;</span>
		try {
<span class="nc" id="L1555">			conn = DBConnect.getConnection();</span>
<span class="nc" id="L1556">			pstmt = conn.prepareStatement(QueryManager</span>
					.getOrgQry(&quot;AGENT&quot;));
			
<span class="nc" id="L1559">			result = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1560" title="All 2 branches missed.">			while (result.next()) {</span>
<span class="nc" id="L1561">				Bean = new OrgBean();</span>
<span class="nc" id="L1562">				Bean.setOrgId(result.getInt(TableConstants.ORG_ID));</span>
<span class="nc" id="L1563">				Bean.setOrgName(result.getString(&quot;orgCode&quot;));</span>
<span class="nc" id="L1564">				list.add(Bean);</span>
			}
<span class="nc" id="L1566">		} catch (SQLException e) {</span>
<span class="nc" id="L1567">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L1569">			try {</span>
<span class="nc" id="L1570">				conn.close();</span>
<span class="nc" id="L1571">			} catch (SQLException e) {</span>
<span class="nc" id="L1572">				e.printStackTrace();</span>
<span class="nc" id="L1573">			}</span>
<span class="nc" id="L1574">		}</span>
<span class="nc" id="L1575">		return list;</span>
	}

	public List&lt;OrgBean&gt; getActiveAgentList() {
<span class="nc" id="L1579">		List&lt;OrgBean&gt; list = new ArrayList&lt;OrgBean&gt;(0);</span>
<span class="nc" id="L1580">		OrgBean Bean = null;</span>
		try {
<span class="nc" id="L1582">			conn = DBConnect.getConnection();</span>
<span class="nc" id="L1583">			pstmt = conn.prepareStatement(QueryManager.getActiveInactiveBlockOrgQry(&quot;AGENT&quot;));</span>
<span class="nc" id="L1584">			result = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1585" title="All 2 branches missed.">			while (result.next()) {</span>
<span class="nc" id="L1586">				Bean = new OrgBean();</span>
<span class="nc" id="L1587">				Bean.setOrgId(result.getInt(TableConstants.ORG_ID));</span>
<span class="nc" id="L1588">				Bean.setOrgName(result.getString(&quot;orgCode&quot;));</span>
<span class="nc" id="L1589">				list.add(Bean);</span>
			}
<span class="nc" id="L1591">		} catch (SQLException e) {</span>
<span class="nc" id="L1592">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L1594">			DBConnect.closeCon(conn);</span>
<span class="nc" id="L1595">		}</span>

<span class="nc" id="L1597">		return list;</span>
	}

	public String getAgentOrgWithIdNACA() throws LMSException {
		try {
<span class="nc" id="L1602">			conn = DBConnect.getConnection();</span>
<span class="nc" id="L1603">			pstmt = conn.prepareStatement(QueryManager</span>
					.getST_RECEIPT_SEARCH_AGENT_ORGID());
<span class="nc" id="L1605">			result = pstmt.executeQuery();</span>
<span class="nc" id="L1606">			StringBuilder Orgstrng = new StringBuilder();</span>
<span class="nc" id="L1607">			boolean flag = false;</span>
<span class="nc bnc" id="L1608" title="All 2 branches missed.">			while (result.next()) {</span>
<span class="nc" id="L1609">				Orgstrng.append(&quot;Nx*&quot; + result.getString(TableConstants.NAME)</span>
						+ &quot;:&quot;);
<span class="nc" id="L1611">				Orgstrng.append(result.getInt(TableConstants.ORG_ID) + &quot;:&quot;);</span>
<span class="nc" id="L1612">				Orgstrng.append(result.getDouble(&quot;available_credit&quot;));</span>
<span class="nc" id="L1613">				flag = true;</span>
			}
<span class="nc" id="L1615">			String nbrFormatStr = &quot;&quot;;</span>
<span class="nc bnc" id="L1616" title="All 2 branches missed.">			if (flag) {</span>
<span class="nc" id="L1617">				nbrFormatStr = Orgstrng.delete(0, 3).toString();</span>
			}
<span class="nc" id="L1619">			logger.debug(&quot;returned string = &quot; + nbrFormatStr);</span>
<span class="nc" id="L1620">			return nbrFormatStr;</span>

<span class="nc" id="L1622">		} catch (SQLException e) {</span>
<span class="nc" id="L1623">			e.printStackTrace();</span>
<span class="nc" id="L1624">			throw new LMSException();</span>
		} finally {
<span class="nc" id="L1626">			try {</span>
<span class="nc" id="L1627">				conn.close();</span>
<span class="nc" id="L1628">			} catch (SQLException e) {</span>
<span class="nc" id="L1629">				e.printStackTrace();</span>
<span class="nc" id="L1630">			}</span>
		}

	}

	public ArrayList&lt;String&gt; getCityNameList(String countryName,
			String stateName) throws LMSException {
<span class="nc" id="L1637">		ArrayList&lt;String&gt; cityNameList = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L1638">		Connection con = DBConnect.getConnection();</span>
		try {
<span class="nc" id="L1640">			String getCityNameList = &quot;select cc.city_name from st_lms_country_master aa, st_lms_state_master bb, st_lms_city_master cc where cc.country_code = aa.country_code and cc.state_code = bb.state_code and aa.name = ? and bb.name = ?&quot;;</span>
<span class="nc" id="L1641">			PreparedStatement pstmt = con.prepareStatement(getCityNameList);</span>
<span class="nc" id="L1642">			pstmt.setString(1, countryName);</span>
<span class="nc" id="L1643">			pstmt.setString(2, stateName);</span>
<span class="nc" id="L1644">			ResultSet rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1645" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1646">				cityNameList.add(rs.getString(&quot;city_name&quot;));</span>
			}

<span class="nc" id="L1649">		} catch (SQLException e) {</span>
<span class="nc" id="L1650">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L1652">			try {</span>
<span class="nc bnc" id="L1653" title="All 6 branches missed.">				if (con != null) {</span>
<span class="nc" id="L1654">					con.close();</span>
				}
<span class="nc" id="L1656">			} catch (SQLException se) {</span>
<span class="nc" id="L1657">				se.printStackTrace();</span>
<span class="nc" id="L1658">			}</span>
<span class="nc" id="L1659">		}</span>
<span class="nc" id="L1660">		return cityNameList;</span>
	}

	public List&lt;UserInfoBean&gt; getOrgIdNClmAmtList(Connection con)
			throws SQLException {
<span class="nc" id="L1665">		List&lt;UserInfoBean&gt; orgList = new ArrayList&lt;UserInfoBean&gt;();</span>
<span class="nc" id="L1666">		String getOrgIdNClmListQuery = &quot;select aa.organization_id, aa.organization_type, aa.parent_id, aa.name, &quot;</span>
				+ &quot; aa.claimable_bal, bb.parent_user_id, bb.user_id from st_lms_organization_master aa, st_lms_user_master bb where &quot;
				+ &quot; aa.organization_id = bb.organization_id and bb.isrolehead = 'Y' and &quot;
				+ &quot; (aa.organization_type = 'AGENT' or aa.organization_type = 'RETAILER') &quot;
				+ &quot; and aa.organization_status!='TERMINATE' order by organization_type desc&quot;;
<span class="nc" id="L1671">		PreparedStatement pstmt = con.prepareStatement(getOrgIdNClmListQuery);</span>
<span class="nc" id="L1672">		ResultSet rs = pstmt.executeQuery();</span>
<span class="nc" id="L1673">		logger.debug(&quot;getOrgIdNClmAmtListQuery is = &quot; + pstmt);</span>
<span class="nc" id="L1674">		UserInfoBean userBean = null;</span>
<span class="nc bnc" id="L1675" title="All 2 branches missed.">		while (rs.next()) {</span>
<span class="nc" id="L1676">			userBean = new UserInfoBean();</span>
<span class="nc" id="L1677">			userBean.setUserOrgId(rs.getInt(&quot;organization_id&quot;));</span>
<span class="nc" id="L1678">			userBean.setUserId(rs.getInt(&quot;user_id&quot;));</span>
<span class="nc" id="L1679">			userBean.setClaimableBal(rs.getDouble(&quot;claimable_bal&quot;));</span>
<span class="nc" id="L1680">			userBean.setUserType(rs.getString(&quot;organization_type&quot;));</span>
<span class="nc" id="L1681">			userBean.setOrgName(rs.getString(&quot;name&quot;));</span>
<span class="nc" id="L1682">			userBean.setParentOrgId(rs.getInt(&quot;parent_id&quot;));</span>
<span class="nc" id="L1683">			userBean.setParentUserId(rs.getInt(&quot;parent_user_id&quot;));</span>
<span class="nc" id="L1684">			orgList.add(userBean);</span>
		}
<span class="nc" id="L1686">		return orgList;</span>
	}

	public List&lt;OrgBean&gt; getRetailerOrgList(String agentOrgId) {
<span class="nc" id="L1690">		List&lt;OrgBean&gt; list = new ArrayList&lt;OrgBean&gt;(0);</span>
<span class="nc" id="L1691">		OrgBean Bean = null;</span>
		try {
<span class="nc" id="L1693">			conn = DBConnect.getConnection();</span>
<span class="nc" id="L1694">			String query = &quot;select name, organization_id from st_lms_organization_master where organization_type='RETAILER' &quot;;</span>
<span class="nc bnc" id="L1695" title="All 2 branches missed.">			if (Integer.parseInt(agentOrgId) != -1) {</span>
<span class="nc" id="L1696">				query = query + &quot;and parent_id = &quot; + agentOrgId;</span>
			}
<span class="nc" id="L1698">			query = query + &quot; order by name&quot;;</span>

<span class="nc" id="L1700">			pstmt = conn.prepareStatement(query);</span>
<span class="nc" id="L1701">			result = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1702" title="All 2 branches missed.">			while (result.next()) {</span>
<span class="nc" id="L1703">				Bean = new OrgBean();</span>
<span class="nc" id="L1704">				Bean.setOrgId(result.getInt(TableConstants.ORG_ID));</span>
<span class="nc" id="L1705">				Bean.setOrgName(result.getString(TableConstants.NAME));</span>
<span class="nc" id="L1706">				list.add(Bean);</span>
			}
<span class="nc" id="L1708">			logger.debug(query + &quot;\nreceipt search list : &quot; + list);</span>
<span class="nc" id="L1709">		} catch (SQLException e) {</span>
<span class="nc" id="L1710">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L1712">			try {</span>
<span class="nc" id="L1713">				conn.close();</span>
<span class="nc" id="L1714">			} catch (SQLException e) {</span>
<span class="nc" id="L1715">				e.printStackTrace();</span>
<span class="nc" id="L1716">			}</span>
<span class="nc" id="L1717">		}</span>

<span class="nc" id="L1719">		return list;</span>
	}

	public String getRetailerOrgWithIdNACA(int agtOrgId) throws LMSException {
		try {
<span class="nc" id="L1724">			conn = DBConnect.getConnection();</span>
<span class="nc" id="L1725">			pstmt = conn</span>
					.prepareStatement(&quot;select name,organization_id,available_credit from st_lms_organization_master where organization_type='RETAILER' and parent_id=&quot;
							+ agtOrgId + &quot; order by name&quot;);
<span class="nc" id="L1728">			result = pstmt.executeQuery();</span>
<span class="nc" id="L1729">			StringBuilder Orgstrng = new StringBuilder();</span>
<span class="nc" id="L1730">			boolean flag = false;</span>
<span class="nc bnc" id="L1731" title="All 2 branches missed.">			while (result.next()) {</span>
<span class="nc" id="L1732">				Orgstrng.append(&quot;Nx*&quot; + result.getString(TableConstants.NAME)</span>
						+ &quot;:&quot;);
<span class="nc" id="L1734">				Orgstrng.append(result.getInt(TableConstants.ORG_ID) + &quot;:&quot;);</span>
<span class="nc" id="L1735">				Orgstrng.append(result.getDouble(&quot;available_credit&quot;));</span>
<span class="nc" id="L1736">				flag = true;</span>
			}
<span class="nc" id="L1738">			String nbrFormatStr = &quot;&quot;;</span>
<span class="nc bnc" id="L1739" title="All 2 branches missed.">			if (flag) {</span>
<span class="nc" id="L1740">				nbrFormatStr = Orgstrng.delete(0, 3).toString();</span>
			}
<span class="nc" id="L1742">			logger.debug(&quot;returned string = &quot; + nbrFormatStr);</span>
<span class="nc" id="L1743">			return nbrFormatStr;</span>

<span class="nc" id="L1745">		} catch (SQLException e) {</span>
<span class="nc" id="L1746">			e.printStackTrace();</span>
<span class="nc" id="L1747">			throw new LMSException();</span>
		} finally {
<span class="nc" id="L1749">			try {</span>
<span class="nc" id="L1750">				conn.close();</span>
<span class="nc" id="L1751">			} catch (SQLException e) {</span>
<span class="nc" id="L1752">				e.printStackTrace();</span>
<span class="nc" id="L1753">			}</span>
		}

	}

	public ArrayList&lt;String&gt; getStateNameList(String countryName)
			throws LMSException {
<span class="nc" id="L1760">		ArrayList&lt;String&gt; stateNameList = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L1761">		Connection con = DBConnect.getConnection();</span>
		try {
<span class="nc" id="L1763">			String getStateNameList = &quot;select bb.name from st_lms_country_master aa, st_lms_state_master bb where aa.country_code = bb.country_code and aa.name =?&quot;;</span>
<span class="nc" id="L1764">			PreparedStatement pstmt = con.prepareStatement(getStateNameList);</span>
<span class="nc" id="L1765">			pstmt.setString(1, countryName);</span>
<span class="nc" id="L1766">			ResultSet rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1767" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1768">				stateNameList.add(rs.getString(&quot;name&quot;));</span>
			}

<span class="nc" id="L1771">		} catch (SQLException e) {</span>
<span class="nc" id="L1772">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L1774">			try {</span>
<span class="nc bnc" id="L1775" title="All 6 branches missed.">				if (con != null) {</span>
<span class="nc" id="L1776">					con.close();</span>
				}
<span class="nc" id="L1778">			} catch (SQLException se) {</span>
<span class="nc" id="L1779">				se.printStackTrace();</span>
<span class="nc" id="L1780">			}</span>
<span class="nc" id="L1781">		}</span>
<span class="nc" id="L1782">		return stateNameList;</span>
	}
	
	public String getCountryPhnCode(String countryName) throws LMSException {
<span class="nc" id="L1786">		String code = &quot;&quot;;</span>
<span class="nc" id="L1787">		Connection con = DBConnect.getConnection();</span>
		try {
<span class="nc" id="L1789">			String phoneCodeQuery = &quot;select country_phone_code from st_lms_country_master where name='&quot;</span>
					+ countryName + &quot;'&quot;;
<span class="nc" id="L1791">			PreparedStatement pstmt = con.prepareStatement(phoneCodeQuery);</span>
<span class="nc" id="L1792">			ResultSet rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1793" title="All 2 branches missed.">			while (rs.next()) { </span>
<span class="nc" id="L1794">				code = rs.getString(&quot;country_phone_code&quot;);</span>
<span class="nc bnc" id="L1795" title="All 2 branches missed.">				if(code==null)</span>
<span class="nc" id="L1796">					code=&quot;&quot;;</span>
			}

<span class="nc" id="L1799">		} catch (SQLException e) {</span>
<span class="nc" id="L1800">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L1802">			try {</span>
<span class="nc bnc" id="L1803" title="All 6 branches missed.">				if (con != null) {</span>
<span class="nc" id="L1804">					con.close();</span>
				}
<span class="nc" id="L1806">			} catch (SQLException se) {</span>
<span class="nc" id="L1807">				se.printStackTrace();</span>
<span class="nc" id="L1808">			}</span>
<span class="nc" id="L1809">		}</span>
<span class="nc" id="L1810">		return code;</span>
	}
	
	public String getCityCode(String cityName) throws LMSException {
<span class="nc" id="L1814">		String cityCode=null;</span>
<span class="nc" id="L1815">		Connection con = DBConnect.getConnection();</span>
		try {
<span class="nc" id="L1817">			String getStateNameList = &quot;select city_phone_code from st_lms_city_master where city_name=?&quot;;</span>
<span class="nc" id="L1818">			PreparedStatement pstmt = con.prepareStatement(getStateNameList);</span>
<span class="nc" id="L1819">			pstmt.setString(1, cityName);</span>
<span class="nc" id="L1820">			ResultSet rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1821" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1822">				cityCode=rs.getString(&quot;city_phone_code&quot;); </span>
<span class="nc bnc" id="L1823" title="All 2 branches missed.">				if(cityCode==null) </span>
<span class="nc" id="L1824">				cityCode=&quot;&quot;;</span>
			}

<span class="nc" id="L1827">		} catch (SQLException e) {</span>
<span class="nc" id="L1828">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L1830">			try {</span>
<span class="nc bnc" id="L1831" title="All 6 branches missed.">				if (con != null) {</span>
<span class="nc" id="L1832">					con.close();</span>
				}
<span class="nc" id="L1834">			} catch (SQLException se) {</span>
<span class="nc" id="L1835">				se.printStackTrace();</span>
<span class="nc" id="L1836">			}</span>
<span class="nc" id="L1837">		}</span>
<span class="nc" id="L1838">		return cityCode;</span>
	}

	public ClmDrawSaleBean getVatAndPpr(Connection con,
			ClmDrawSaleBean saleBean, int gameId) throws SQLException {
<span class="nc" id="L1843">		String getGameNbrFromGameMaster = &quot;select game_nbr,prize_payout_ratio,vat_amt from st_dg_game_master where game_id =&quot;</span>
				+ gameId;
<span class="nc" id="L1845">		PreparedStatement pstmtGameNbr = con</span>
				.prepareStatement(getGameNbrFromGameMaster);
<span class="nc" id="L1847">		ResultSet resultGameNbr = pstmtGameNbr.executeQuery();</span>
<span class="nc bnc" id="L1848" title="All 2 branches missed.">		while (resultGameNbr.next()) {</span>
<span class="nc" id="L1849">			saleBean.setPricePayRatio(resultGameNbr</span>
					.getDouble(&quot;prize_payout_ratio&quot;));
<span class="nc" id="L1851">			saleBean.setVatAmt(resultGameNbr.getDouble(&quot;vat_amt&quot;));</span>
		}
<span class="nc" id="L1853">		return saleBean;</span>
	}

	public boolean updateBookStatus(int gameId, String bookNbr, Connection con,
			String status) throws SQLException {
<span class="nc" id="L1858">		String updateBookStatus = &quot;update st_se_game_inv_status set book_status = ? where game_id = ? and book_nbr=?&quot;;</span>
<span class="nc" id="L1859">		PreparedStatement updateBookStatusPstmt = con</span>
				.prepareStatement(updateBookStatus);
<span class="nc" id="L1861">		updateBookStatusPstmt.setString(1, status);</span>
<span class="nc" id="L1862">		updateBookStatusPstmt.setInt(2, gameId);</span>
<span class="nc" id="L1863">		updateBookStatusPstmt.setString(3, bookNbr);</span>
<span class="nc" id="L1864">		int retBalRow = updateBookStatusPstmt.executeUpdate();</span>
<span class="nc" id="L1865">		logger.debug(retBalRow + &quot; row updated,  updateBookStatus = &quot;</span>
				+ updateBookStatusPstmt);
<span class="nc bnc" id="L1867" title="All 2 branches missed.">		return retBalRow &gt; 0;</span>

	}

	public String updateClaimableForDrawSaleAgt(Map drawMap, int agtOrgId,
			int agtParentUserId, int agtParentOrgId, Connection con)
			throws LMSException {
<span class="nc" id="L1874">		logger.debug(&quot;inside agt updation &quot;);</span>
<span class="nc" id="L1875">		double agtDebitAmount = 0.0;// total amount of retailer that would be</span>
		// deducted from retailers ACA
<span class="nc" id="L1877">		List&lt;Long&gt; trnIdListInvoice = null;</span>
<span class="nc" id="L1878">		List&lt;Long&gt; trnIdListCRNote = null;</span>
<span class="nc" id="L1879">		Map&lt;String, List&lt;Long&gt;&gt; trnIdMapInvoice = new HashMap&lt;String, List&lt;Long&gt;&gt;();</span>
<span class="nc" id="L1880">		Map&lt;String, List&lt;Long&gt;&gt; trnIdMapCRNote = new HashMap&lt;String, List&lt;Long&gt;&gt;();</span>
<span class="nc" id="L1881">		String autoGeneRecieptNo = null;</span>
		try {

<span class="nc" id="L1884">			Map&lt;String, List&lt;ClmDrawSaleBean&gt;&gt; drawSaleMap = (Map) drawMap</span>
					.get(&quot;drawSaleMap&quot;);
<span class="nc" id="L1886">			Map&lt;String, List&lt;ClmDrawSaleBean&gt;&gt; drawSaleRefundMap = (Map) drawMap</span>
					.get(&quot;drawSaleRefundMap&quot;);
<span class="nc" id="L1888">			List&lt;ClmDrawSaleBean&gt; drawSaleBeanList = null;</span>
<span class="nc bnc" id="L1889" title="All 2 branches missed.">			if (drawSaleMap != null) {</span>
<span class="nc" id="L1890">				Set keySet = drawSaleMap.keySet();</span>
<span class="nc bnc" id="L1891" title="All 2 branches missed.">				for (Object key : keySet) {</span>
<span class="nc" id="L1892">					drawSaleBeanList = drawSaleMap.get(key);</span>
<span class="nc" id="L1893">					double totalMrpAmt = 0.0;</span>
<span class="nc" id="L1894">					double totalAgtComm = 0.0;</span>
<span class="nc" id="L1895">					double totalAgtNetAmt = 0.0;</span>
<span class="nc" id="L1896">					double totalGoodCauseAmt = 0.0;</span>
<span class="nc" id="L1897">					double ppr = 0.0;</span>
<span class="nc" id="L1898">					double vatAmt = 0.0;</span>
<span class="nc bnc" id="L1899" title="All 2 branches missed.">					if (!drawSaleBeanList.isEmpty()) {</span>
<span class="nc" id="L1900">						getVatAndPpr(con, drawSaleBeanList.get(0), Integer</span>
								.parseInt(((String) key).split(&quot;:&quot;)[0]));
<span class="nc" id="L1902">						ppr = drawSaleBeanList.get(0).getPricePayRatio();</span>
<span class="nc" id="L1903">						vatAmt = drawSaleBeanList.get(0).getVatAmt();</span>
					}
<span class="nc" id="L1905">					String transDate = null;</span>
<span class="nc bnc" id="L1906" title="All 2 branches missed.">					for (ClmDrawSaleBean clmDrawSaleBean : drawSaleBeanList) {</span>
<span class="nc" id="L1907">						totalMrpAmt += clmDrawSaleBean.getMrpAmt();</span>
<span class="nc" id="L1908">						totalAgtComm += clmDrawSaleBean.getAgtComm();</span>
<span class="nc" id="L1909">						totalGoodCauseAmt += clmDrawSaleBean</span>
								.getAgtGoodCauseAmt();
<span class="nc" id="L1911">						transDate = clmDrawSaleBean.getTransDate();</span>
<span class="nc" id="L1912">					}</span>

<span class="nc" id="L1914">					totalAgtNetAmt = totalMrpAmt - totalAgtComm;</span>

					// calculate agt vat , agt taxable sale and agt good cause
<span class="nc" id="L1917">					double agtCommRate = Double.parseDouble(((String) key)</span>
							.split(&quot;:&quot;)[1]);
<span class="nc" id="L1919">					double goodcauseRate = Double.parseDouble(((String) key)</span>
							.split(&quot;:&quot;)[2]);
<span class="nc" id="L1921">					double totalAgtVat = CommonMethods.calculateDrawGameVatAgt(</span>
							totalMrpAmt, agtCommRate, ppr, goodcauseRate,
							vatAmt);
					/*
					 * double tatalAgtTaxableSale = (((totalMrpAmt * (100 -
					 * (agtCommRate + 50 + goodcauseRate))) / 100) * 100) / (100 +
					 * 16);
					 */
<span class="nc" id="L1929">					double tatalAgtTaxableSale = CommonMethods.calTaxableSale(</span>
							totalMrpAmt, agtCommRate, ppr, goodcauseRate,
							vatAmt);
<span class="nc" id="L1932">					logger</span>
							.debug(key + &quot;Test======&quot; + drawSaleBeanList
									+ &quot;======vatAmt**&quot; + vatAmt
									+ &quot;===agt=========&quot; + agtCommRate
									+ &quot;**goodcauseRate**&quot; + goodcauseRate);
<span class="nc" id="L1937">					agtDebitAmount += totalAgtNetAmt;</span>

					// insert in main transaction table
<span class="nc" id="L1940">					PreparedStatement pstmt = con.prepareStatement(QueryManager</span>
							.insertInLMSTransactionMaster());
<span class="nc" id="L1942">					pstmt.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L1943">					pstmt.executeUpdate();</span>
<span class="nc" id="L1944">					ResultSet rsTrns = pstmt.getGeneratedKeys();</span>
<span class="nc bnc" id="L1945" title="All 2 branches missed.">					if (rsTrns.next()) {</span>
<span class="nc" id="L1946">						long transId = rsTrns.getLong(1);</span>
<span class="nc bnc" id="L1947" title="All 2 branches missed.">						if (trnIdMapInvoice.containsKey(transDate)) {</span>
<span class="nc" id="L1948">							trnIdMapInvoice.get(transDate).add(transId);</span>
						} else {
<span class="nc" id="L1950">							trnIdListInvoice = new ArrayList&lt;Long&gt;();</span>
<span class="nc" id="L1951">							trnIdListInvoice.add(transId);</span>
<span class="nc" id="L1952">							trnIdMapInvoice.put(transDate, trnIdListInvoice);</span>
						}
						// insert in bo transaction master
<span class="nc" id="L1955">						pstmt = con.prepareStatement(QueryManager</span>
								.insertInBOTransactionMaster());
<span class="nc" id="L1957">						pstmt.setLong(1, transId);</span>
<span class="nc" id="L1958">						pstmt.setInt(2, agtParentUserId);</span>
<span class="nc" id="L1959">						pstmt.setInt(3, agtParentOrgId);</span>
<span class="nc" id="L1960">						pstmt.setString(4, &quot;AGENT&quot;);</span>
<span class="nc" id="L1961">						pstmt.setInt(5, agtOrgId);</span>
<span class="nc" id="L1962">						pstmt</span>
								.setTimestamp(
										6,
										GetDate
												.fetchTransDateTimeStampForAdocLedger(transDate));
<span class="nc" id="L1967">						pstmt.setString(7, &quot;DG_SALE&quot;);</span>
<span class="nc" id="L1968">						pstmt.executeUpdate();</span>

						// insert in bo draw game sale table
<span class="nc" id="L1971">						pstmt = con</span>
								.prepareStatement(&quot;insert into st_dg_bo_sale(transaction_id,agent_org_id,game_id,mrp_amt,agent_comm,net_amt,vat_amt,taxable_sale,govt_comm) values(?,?,?,?,?,?,?,?,?)&quot;);
<span class="nc" id="L1973">						pstmt.setLong(1, transId);</span>
<span class="nc" id="L1974">						pstmt.setInt(2, agtOrgId);</span>
<span class="nc" id="L1975">						pstmt.setInt(3, Integer.parseInt(((String) key)</span>
								.split(&quot;:&quot;)[0]));
<span class="nc" id="L1977">						pstmt.setDouble(4, totalMrpAmt);</span>
<span class="nc" id="L1978">						pstmt.setDouble(5, totalAgtComm);</span>
<span class="nc" id="L1979">						pstmt.setDouble(6, totalAgtNetAmt);</span>
<span class="nc" id="L1980">						pstmt.setDouble(7, totalAgtVat);</span>
<span class="nc" id="L1981">						pstmt.setDouble(8, tatalAgtTaxableSale);</span>
<span class="nc" id="L1982">						pstmt.setDouble(9, totalGoodCauseAmt);</span>
<span class="nc" id="L1983">						pstmt.executeUpdate();</span>

						// update retailer draw table for claim_done
<span class="nc bnc" id="L1986" title="All 2 branches missed.">						for (ClmDrawSaleBean clmDrawSaleBean : drawSaleBeanList) {</span>
<span class="nc" id="L1987">							pstmt = con</span>
									.prepareStatement(&quot;update st_dg_agt_sale set claim_status=?,bo_ref_transaction_id=? where transaction_id=?&quot;);
<span class="nc" id="L1989">							pstmt.setString(1, &quot;DONE_CLAIM&quot;);</span>
<span class="nc" id="L1990">							pstmt.setLong(2, transId);</span>
<span class="nc" id="L1991">							pstmt.setLong(3, clmDrawSaleBean.getTransactinId());</span>
<span class="nc" id="L1992">							pstmt.executeUpdate();</span>

<span class="nc" id="L1994">						}</span>
					}
<span class="nc" id="L1996">				}</span>

				// genarate INVOICE at BO End here
				// int invoiceId = -1;
				// String autoGeneRecieptNo = null;
<span class="nc bnc" id="L2001" title="All 4 branches missed.">				if (trnIdMapInvoice.size() &gt; 0 &amp;&amp; trnIdMapInvoice != null) {</span>

<span class="nc" id="L2003">					Set&lt;String&gt; dateKeys = trnIdMapInvoice.keySet();</span>
<span class="nc bnc" id="L2004" title="All 2 branches missed.">					for (String date : dateKeys) {</span>
<span class="nc" id="L2005">						trnIdListInvoice = trnIdMapInvoice.get(date);</span>

<span class="nc" id="L2007">						String query = &quot;SELECT generated_id from st_lms_bo_receipts where receipt_type='DG_INVOICE' or receipt_type='DG_RECEIPT' ORDER BY generated_id DESC LIMIT 1&quot;;</span>
						// PreparedStatement boReceiptNoGenStmt =
						// connection.prepareStatement(QueryManager.getBOLatestReceiptNb());
<span class="nc" id="L2010">						PreparedStatement boReceiptNoGenStmt = con</span>
								.prepareStatement(query);
						// boReceiptNoGenStmt.setString(1, &quot;DG_INVOICE&quot;);
<span class="nc" id="L2013">						ResultSet recieptRs = boReceiptNoGenStmt.executeQuery();</span>
<span class="nc" id="L2014">						String lastRecieptNoGenerated = null;</span>

<span class="nc bnc" id="L2016" title="All 2 branches missed.">						while (recieptRs.next()) {</span>
<span class="nc" id="L2017">							lastRecieptNoGenerated = recieptRs</span>
									.getString(&quot;generated_id&quot;);
						}
						// String autoGeneRecieptNo = null;
<span class="nc" id="L2021">						autoGeneRecieptNo = GenerateRecieptNo.getRecieptNo(</span>
								&quot;DG_INVOICE&quot;, lastRecieptNoGenerated, &quot;BO&quot;);

<span class="nc" id="L2024">						boReceiptNoGenStmt = con.prepareStatement(QueryManager</span>
								.insertInReceiptMaster());
<span class="nc" id="L2026">						boReceiptNoGenStmt.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L2027">						boReceiptNoGenStmt.executeUpdate();</span>

<span class="nc" id="L2029">						ResultSet rs = boReceiptNoGenStmt.getGeneratedKeys();</span>
<span class="nc" id="L2030">						int invoiceId = -1;</span>
<span class="nc bnc" id="L2031" title="All 2 branches missed.">						while (rs.next()) {</span>
<span class="nc" id="L2032">							invoiceId = rs.getInt(1);</span>
						}

						// insert in bo receipts
<span class="nc" id="L2036">						boReceiptNoGenStmt = con.prepareStatement(QueryManager</span>
								.insertInBOReceipts());
<span class="nc" id="L2038">						boReceiptNoGenStmt.setInt(1, invoiceId);</span>
<span class="nc" id="L2039">						boReceiptNoGenStmt.setString(2, &quot;DG_INVOICE&quot;);</span>
<span class="nc" id="L2040">						boReceiptNoGenStmt.setInt(3, agtOrgId);</span>
<span class="nc" id="L2041">						boReceiptNoGenStmt.setString(4, &quot;AGENT&quot;);</span>
<span class="nc" id="L2042">						logger.debug(&quot;autoGeneRecieptNo********&quot;</span>
								+ autoGeneRecieptNo);
<span class="nc" id="L2044">						boReceiptNoGenStmt.setString(5, autoGeneRecieptNo);</span>
<span class="nc" id="L2045">						boReceiptNoGenStmt.setTimestamp(6, Util.getCurrentTimeStamp());</span>
<span class="nc" id="L2046">						boReceiptNoGenStmt.execute();</span>

<span class="nc" id="L2048">						boReceiptNoGenStmt = con.prepareStatement(QueryManager</span>
								.insertBOReceiptTrnMapping());

<span class="nc bnc" id="L2051" title="All 2 branches missed.">						for (int i = 0; i &lt; trnIdListInvoice.size(); i++) {</span>
<span class="nc" id="L2052">							boReceiptNoGenStmt.setInt(1, invoiceId);</span>
<span class="nc" id="L2053">							boReceiptNoGenStmt.setLong(2, trnIdListInvoice</span>
									.get(i));
<span class="nc" id="L2055">							boReceiptNoGenStmt.execute();</span>

						}
<span class="nc" id="L2058">					}</span>
				}
			}
			// update for refund sale
<span class="nc bnc" id="L2062" title="All 2 branches missed.">			if (drawSaleRefundMap != null) {</span>
<span class="nc" id="L2063">				Set keySetRefund = drawSaleRefundMap.keySet();</span>
<span class="nc bnc" id="L2064" title="All 2 branches missed.">				for (Object key : keySetRefund) {</span>
<span class="nc" id="L2065">					drawSaleBeanList = drawSaleRefundMap.get(key);</span>
<span class="nc" id="L2066">					double totalMrpAmt = 0.0;</span>
<span class="nc" id="L2067">					double totalAgtComm = 0.0;</span>
<span class="nc" id="L2068">					double totalAgtNetAmt = 0.0;</span>
<span class="nc" id="L2069">					double totalGoodCauseAmt = 0.0;</span>
<span class="nc" id="L2070">					double totalCancellationCharges = 0.0;</span>
<span class="nc" id="L2071">					double ppr = 0.0;</span>
<span class="nc" id="L2072">					double vatAmt = 0.0;</span>
<span class="nc bnc" id="L2073" title="All 2 branches missed.">					if (!drawSaleBeanList.isEmpty()) {</span>
<span class="nc" id="L2074">						getVatAndPpr(con, drawSaleBeanList.get(0), Integer</span>
								.parseInt(((String) key).split(&quot;:&quot;)[0]));
<span class="nc" id="L2076">						ppr = drawSaleBeanList.get(0).getPricePayRatio();</span>
<span class="nc" id="L2077">						vatAmt = drawSaleBeanList.get(0).getVatAmt();</span>
					}
<span class="nc" id="L2079">					String transDate = null;</span>
<span class="nc bnc" id="L2080" title="All 2 branches missed.">					for (ClmDrawSaleBean clmDrawSaleBean : drawSaleBeanList) {</span>
<span class="nc" id="L2081">						totalMrpAmt += clmDrawSaleBean.getMrpAmt();</span>
<span class="nc" id="L2082">						totalAgtComm += clmDrawSaleBean.getAgtComm();</span>
<span class="nc" id="L2083">						totalCancellationCharges += clmDrawSaleBean</span>
								.getCancellationCharges();
<span class="nc" id="L2085">						totalGoodCauseAmt += clmDrawSaleBean</span>
								.getAgtGoodCauseAmt();
<span class="nc" id="L2087">						transDate = clmDrawSaleBean.getTransDate();</span>
<span class="nc" id="L2088">					}</span>

<span class="nc" id="L2090">					totalAgtNetAmt = totalMrpAmt - totalAgtComm</span>
							- totalCancellationCharges;

					// calculate agt vat , agt taxable sale and agt good cause
<span class="nc" id="L2094">					double agtCommRate = Double.parseDouble(((String) key)</span>
							.split(&quot;:&quot;)[1]);
<span class="nc" id="L2096">					double goodcauseRate = Double.parseDouble(((String) key)</span>
							.split(&quot;:&quot;)[2]);
<span class="nc" id="L2098">					double totalAgtVat = CommonMethods.calculateDrawGameVatAgt(</span>
							totalMrpAmt, agtCommRate, ppr, goodcauseRate,
							vatAmt);
					// double tatalAgtTaxableSale =
					// (((totalMrpAmt*(100-(Double.parseDouble(((String)key).split(&quot;:&quot;)[1])*100/totalMrpAmt
					// + 50
					// +Double.parseDouble(((String)key).split(&quot;:&quot;)[2])*100/totalMrpAmt)))/100)*100)/(100+16);
					/*
					 * double tatalAgtTaxableSale = (((totalMrpAmt * (100 -
					 * (agtCommRate + 50 + goodcauseRate))) / 100) * 100) / (100 +
					 * 16);
					 */
<span class="nc" id="L2110">					double tatalAgtTaxableSale = CommonMethods.calTaxableSale(</span>
							totalMrpAmt, agtCommRate, ppr, goodcauseRate,
							vatAmt);

<span class="nc" id="L2114">					agtDebitAmount -= totalAgtNetAmt;</span>

					// insert in main transaction table
<span class="nc" id="L2117">					PreparedStatement pstmt = con.prepareStatement(QueryManager</span>
							.insertInLMSTransactionMaster());
<span class="nc" id="L2119">					pstmt.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L2120">					pstmt.executeUpdate();</span>
<span class="nc" id="L2121">					ResultSet rsTrns = pstmt.getGeneratedKeys();</span>
<span class="nc bnc" id="L2122" title="All 2 branches missed.">					if (rsTrns.next()) {</span>
<span class="nc" id="L2123">						long transId = rsTrns.getLong(1);</span>
<span class="nc bnc" id="L2124" title="All 2 branches missed.">						if (trnIdMapCRNote.containsKey(transDate)) {</span>
<span class="nc" id="L2125">							trnIdMapCRNote.get(transDate).add(transId);</span>
						} else {
<span class="nc" id="L2127">							trnIdListCRNote = new ArrayList&lt;Long&gt;();</span>
<span class="nc" id="L2128">							trnIdListCRNote.add(transId);</span>
<span class="nc" id="L2129">							trnIdMapCRNote.put(transDate, trnIdListCRNote);</span>
						}
						// insert in bo transaction master
<span class="nc" id="L2132">						pstmt = con.prepareStatement(QueryManager</span>
								.insertInBOTransactionMaster());
<span class="nc" id="L2134">						pstmt.setLong(1, transId);</span>
<span class="nc" id="L2135">						pstmt.setInt(2, agtParentUserId);</span>
<span class="nc" id="L2136">						pstmt.setInt(3, agtParentOrgId);</span>
<span class="nc" id="L2137">						pstmt.setString(4, &quot;AGENT&quot;);</span>
<span class="nc" id="L2138">						pstmt.setInt(5, agtOrgId);</span>
<span class="nc" id="L2139">						pstmt</span>
								.setTimestamp(
										6,
										GetDate
												.fetchTransDateTimeStampForAdocLedger(transDate));
<span class="nc" id="L2144">						pstmt.setString(7, ((String) key).split(&quot;:&quot;)[3]);</span>
<span class="nc" id="L2145">						pstmt.executeUpdate();</span>

						// insert in bo draw game sale table
<span class="nc" id="L2148">						pstmt = con</span>
								.prepareStatement(&quot;insert into st_dg_bo_sale_refund(transaction_id,agent_org_id,game_id,mrp_amt,agent_comm,net_amt,vat_amt,taxable_sale,govt_comm,cancellation_charges) values(?,?,?,?,?,?,?,?,?,?)&quot;);
<span class="nc" id="L2150">						pstmt.setLong(1, transId);</span>
<span class="nc" id="L2151">						pstmt.setInt(2, agtOrgId);</span>
<span class="nc" id="L2152">						pstmt.setInt(3, Integer.parseInt(((String) key)</span>
								.split(&quot;:&quot;)[0]));
<span class="nc" id="L2154">						pstmt.setDouble(4, totalMrpAmt);</span>
<span class="nc" id="L2155">						pstmt.setDouble(5, totalAgtComm);</span>
<span class="nc" id="L2156">						pstmt.setDouble(6, totalAgtNetAmt);</span>
<span class="nc" id="L2157">						pstmt.setDouble(7, totalAgtVat);</span>
<span class="nc" id="L2158">						pstmt.setDouble(8, tatalAgtTaxableSale);</span>
<span class="nc" id="L2159">						pstmt.setDouble(9, totalGoodCauseAmt);</span>
<span class="nc" id="L2160">						pstmt.setDouble(10, totalCancellationCharges);</span>
<span class="nc" id="L2161">						pstmt.executeUpdate();</span>
<span class="nc" id="L2162">						logger.debug(&quot;%%%%%insert &quot; + pstmt);</span>

						// update retailer draw table for claim_done
<span class="nc bnc" id="L2165" title="All 2 branches missed.">						for (ClmDrawSaleBean clmDrawSaleBean : drawSaleBeanList) {</span>
<span class="nc" id="L2166">							pstmt = con</span>
									.prepareStatement(&quot;update st_dg_agt_sale_refund set claim_status=?,bo_ref_transaction_id=? where transaction_id=?&quot;);
<span class="nc" id="L2168">							pstmt.setString(1, &quot;DONE_CLAIM&quot;);</span>
<span class="nc" id="L2169">							pstmt.setLong(2, transId);</span>
<span class="nc" id="L2170">							pstmt.setLong(3, clmDrawSaleBean.getTransactinId());</span>
<span class="nc" id="L2171">							pstmt.executeUpdate();</span>

<span class="nc" id="L2173">						}</span>
					}
<span class="nc" id="L2175">				}</span>

				// genarate INVOICE at BO End here
				// int invoiceId = -1;
				// String autoGeneRecieptNo = null;
<span class="nc bnc" id="L2180" title="All 4 branches missed.">				if (trnIdMapCRNote.size() &gt; 0 &amp;&amp; trnIdMapCRNote != null) {</span>
<span class="nc" id="L2181">					Set&lt;String&gt; dateKeys = trnIdMapCRNote.keySet();</span>
<span class="nc bnc" id="L2182" title="All 2 branches missed.">					for (String date : dateKeys) {</span>
<span class="nc" id="L2183">						trnIdListCRNote = trnIdMapCRNote.get(date);</span>

<span class="nc" id="L2185">						PreparedStatement boReceiptNoGenStmt = con</span>
								.prepareStatement(&quot;SELECT generated_id from st_lms_bo_receipts where receipt_type like ('CR_NOTE%')  ORDER BY generated_id DESC LIMIT 1&quot;);
						// boReceiptNoGenStmt.setString(1, &quot;INVOICE&quot;);
<span class="nc" id="L2188">						ResultSet recieptRs = boReceiptNoGenStmt.executeQuery();</span>
<span class="nc" id="L2189">						String lastRecieptNoGenerated = null;</span>

<span class="nc bnc" id="L2191" title="All 2 branches missed.">						while (recieptRs.next()) {</span>
<span class="nc" id="L2192">							lastRecieptNoGenerated = recieptRs</span>
									.getString(&quot;generated_id&quot;);
						}

						// String autoGeneRecieptNo = null;
<span class="nc" id="L2197">						autoGeneRecieptNo = GenerateRecieptNo.getRecieptNo(</span>
								&quot;CR_NOTE&quot;, lastRecieptNoGenerated, &quot;BO&quot;);

<span class="nc" id="L2200">						boReceiptNoGenStmt = con.prepareStatement(QueryManager</span>
								.insertInReceiptMaster());
<span class="nc" id="L2202">						boReceiptNoGenStmt.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L2203">						boReceiptNoGenStmt.executeUpdate();</span>

<span class="nc" id="L2205">						ResultSet rs = boReceiptNoGenStmt.getGeneratedKeys();</span>
<span class="nc" id="L2206">						int crNoteId = -1;</span>
<span class="nc bnc" id="L2207" title="All 2 branches missed.">						while (rs.next()) {</span>
<span class="nc" id="L2208">							crNoteId = rs.getInt(1);</span>
						}

						// insert in bo receipts
<span class="nc" id="L2212">						boReceiptNoGenStmt = con.prepareStatement(QueryManager</span>
								.insertInBOReceipts());
<span class="nc" id="L2214">						boReceiptNoGenStmt.setInt(1, crNoteId);</span>
<span class="nc" id="L2215">						boReceiptNoGenStmt.setString(2, &quot;CR_NOTE&quot;);</span>
<span class="nc" id="L2216">						boReceiptNoGenStmt.setInt(3, agtOrgId);</span>
<span class="nc" id="L2217">						boReceiptNoGenStmt.setString(4, &quot;AGENT&quot;);</span>
<span class="nc" id="L2218">						boReceiptNoGenStmt.setString(5, autoGeneRecieptNo);</span>
<span class="nc" id="L2219">						boReceiptNoGenStmt.execute();</span>

<span class="nc" id="L2221">						boReceiptNoGenStmt = con.prepareStatement(QueryManager</span>
								.insertBOReceiptTrnMapping());

<span class="nc bnc" id="L2224" title="All 2 branches missed.">						for (int i = 0; i &lt; trnIdListCRNote.size(); i++) {</span>
<span class="nc" id="L2225">							boReceiptNoGenStmt.setInt(1, crNoteId);</span>
<span class="nc" id="L2226">							boReceiptNoGenStmt</span>
									.setLong(2, trnIdListCRNote.get(i));
<span class="nc" id="L2228">							boReceiptNoGenStmt.execute();</span>

						}
<span class="nc" id="L2231">					}</span>
				}
			}

<span class="nc" id="L2235">			logger.debug(&quot;sale Agent Debit Amount &quot; + agtDebitAmount);</span>
			// update organization claimable balance
			
<span class="nc" id="L2238">			OrgCreditUpdation.updateOrganizationBalWithValidate(agtDebitAmount, &quot;TRANSACTION&quot;, &quot;DRAW_GAME_SALE&quot;, agtOrgId,</span>
					0, &quot;AGENT&quot;, 0, conn);			
			
<span class="nc" id="L2241">			OrgCreditUpdation.updateOrganizationBalWithValidate(agtDebitAmount, &quot;CLAIM_BAL&quot;, &quot;DEBIT&quot;, agtOrgId,</span>
					0, &quot;AGENT&quot;, 0, conn);
			/*OrgCreditUpdation.updateCreditLimitForAgent(agtOrgId,
					&quot;DRAW_GAME_SALE&quot;, agtDebitAmount, con);*/
			/*updateOrgBalance(&quot;CLAIM_BAL&quot;, agtDebitAmount, agtOrgId, &quot;DEBIT&quot;,
					con);*/
<span class="nc" id="L2247">			return autoGeneRecieptNo;</span>
<span class="nc" id="L2248">		} catch (SQLException e) {</span>
<span class="nc" id="L2249">			e.printStackTrace();</span>
<span class="nc" id="L2250">			throw new LMSException();</span>
		}

	}

	public String updateClaimableForDrawSaleRet(Map drawMap, int retOrgId,
			int retParentUserId, int retParentOrgId, Connection con)
			throws LMSException {
<span class="nc" id="L2258">		logger.debug(&quot;insideeeeeeeeeeeeeeeeeeeee&quot;);</span>
<span class="nc" id="L2259">		double retDebitAmount = 0.0;// total amount of retailer that would be</span>
		// deducted from retailers ACA
<span class="nc" id="L2261">		List&lt;Long&gt; trnIdListInvoice= null;</span>
<span class="nc" id="L2262">		Map&lt;String, List&lt;Long&gt;&gt; trnIdMapInvoice = new HashMap&lt;String, List&lt;Long&gt;&gt;();</span>
<span class="nc" id="L2263">		List&lt;Long&gt; trnIdListCRNote = null;</span>
<span class="nc" id="L2264">		Map&lt;String, List&lt;Long&gt;&gt; trnIdMapCRNote = new HashMap&lt;String, List&lt;Long&gt;&gt;();</span>
<span class="nc" id="L2265">		String autoGeneRecieptNo = null;</span>
		try {

<span class="nc" id="L2268">			Map&lt;String, List&lt;ClmDrawSaleBean&gt;&gt; drawSaleMap = (Map) drawMap</span>
					.get(&quot;drawSaleMap&quot;);
<span class="nc" id="L2270">			Map&lt;String, List&lt;ClmDrawSaleBean&gt;&gt; drawSaleRefundMap = (Map) drawMap</span>
					.get(&quot;drawSaleRefundMap&quot;);
<span class="nc" id="L2272">			List&lt;ClmDrawSaleBean&gt; drawSaleBeanList = null;</span>

<span class="nc bnc" id="L2274" title="All 2 branches missed.">			if (drawSaleMap != null) {</span>
<span class="nc" id="L2275">				Set keySet = drawSaleMap.keySet();</span>
<span class="nc bnc" id="L2276" title="All 2 branches missed.">				for (Object key : keySet) {</span>
<span class="nc" id="L2277">					drawSaleBeanList = drawSaleMap.get(key);</span>
<span class="nc" id="L2278">					double totalMrpAmt = 0.0;</span>
<span class="nc" id="L2279">					double totalRetComm = 0.0;</span>
<span class="nc" id="L2280">					double totalAgtComm = 0.0;</span>
<span class="nc" id="L2281">					double totalretNetAmt = 0.0;</span>
<span class="nc" id="L2282">					double totalAgtNetAmt = 0.0;</span>
<span class="nc" id="L2283">					double totalGoodCauseAmt = 0.0;</span>
<span class="nc" id="L2284">					double ppr = 0.0;</span>
<span class="nc" id="L2285">					double vatAmt = 0.0;</span>
<span class="nc bnc" id="L2286" title="All 2 branches missed.">					if (!drawSaleBeanList.isEmpty()) {</span>
<span class="nc" id="L2287">						ppr = drawSaleBeanList.get(0).getPricePayRatio();</span>
<span class="nc" id="L2288">						vatAmt = drawSaleBeanList.get(0).getVatAmt();</span>
					}
<span class="nc" id="L2290">					String transDate = null;</span>
<span class="nc bnc" id="L2291" title="All 2 branches missed.">					for (ClmDrawSaleBean clmDrawSaleBean : drawSaleBeanList) {</span>
<span class="nc" id="L2292">						totalMrpAmt = totalMrpAmt + clmDrawSaleBean.getMrpAmt();</span>
<span class="nc" id="L2293">						totalRetComm = totalRetComm</span>
								+ clmDrawSaleBean.getRetComm();
<span class="nc" id="L2295">						totalAgtComm = totalAgtComm</span>
								+ clmDrawSaleBean.getAgtComm();
<span class="nc" id="L2297">						totalGoodCauseAmt = totalGoodCauseAmt</span>
								+ clmDrawSaleBean.getAgtGoodCauseAmt();
<span class="nc" id="L2299">						transDate = clmDrawSaleBean.getTransDate();</span>
<span class="nc" id="L2300">					}</span>
<span class="nc" id="L2301">					totalretNetAmt = totalMrpAmt - totalRetComm;</span>
<span class="nc" id="L2302">					totalAgtNetAmt = totalMrpAmt - totalAgtComm;</span>

					// calculate agt vat , agt taxable sale and agt good cause
<span class="nc" id="L2305">					double retCommRate = Double.parseDouble(((String) key)</span>
							.split(&quot;:&quot;)[1]);
<span class="nc" id="L2307">					double goodCauserate = Double.parseDouble(((String) key)</span>
							.split(&quot;:&quot;)[3]);
<span class="nc" id="L2309">					logger.debug(key + &quot;Test======&quot; + drawSaleBeanList</span>
							+ &quot;======vatAmt**&quot; + vatAmt + &quot;============&quot;
							+ retCommRate);
<span class="nc" id="L2312">					double totalAgtVat = CommonMethods.calculateDrawGameVatRet(</span>
							totalMrpAmt, retCommRate, ppr, goodCauserate,
							vatAmt);
					/*
					 * double tatalAgtTaxableSale = (((totalMrpAmt * (100 -
					 * (retCommRate + ppr + goodCauserate))) / 100) * 100) /
					 * (100 + vatAmt);
					 */
<span class="nc" id="L2320">					double tatalAgtTaxableSale = CommonMethods.calTaxableSale(</span>
							totalMrpAmt, retCommRate, ppr, goodCauserate,
							vatAmt);

<span class="nc" id="L2324">					retDebitAmount = retDebitAmount + totalretNetAmt;</span>

					// insert in main transaction table
<span class="nc" id="L2327">					PreparedStatement pstmt = con.prepareStatement(QueryManager</span>
							.insertInLMSTransactionMaster());
<span class="nc" id="L2329">					pstmt.setString(1, &quot;AGENT&quot;);</span>
<span class="nc" id="L2330">					pstmt.executeUpdate();</span>
<span class="nc" id="L2331">					ResultSet rsTrns = pstmt.getGeneratedKeys();</span>
<span class="nc bnc" id="L2332" title="All 2 branches missed.">					if (rsTrns.next()) {</span>
<span class="nc" id="L2333">						long transId = rsTrns.getLong(1);</span>
						// trnIdListInvoice.add(transId);

<span class="nc bnc" id="L2336" title="All 2 branches missed.">						if (trnIdMapInvoice.containsKey(transDate)) {</span>
<span class="nc" id="L2337">							trnIdMapInvoice.get(transDate).add(transId);</span>
						} else {
<span class="nc" id="L2339">							trnIdListInvoice = new ArrayList&lt;Long&gt;();</span>
<span class="nc" id="L2340">							trnIdListInvoice.add(transId);</span>
<span class="nc" id="L2341">							trnIdMapInvoice.put(transDate, trnIdListInvoice);</span>
						}
						// insert in agent transaction master
<span class="nc" id="L2344">						pstmt = con.prepareStatement(QueryManager</span>
								.insertInAgentTransactionMaster());
<span class="nc" id="L2346">						pstmt.setLong(1, transId);</span>
<span class="nc" id="L2347">						pstmt.setInt(2, retParentUserId);</span>
<span class="nc" id="L2348">						pstmt.setInt(3, retParentOrgId);</span>
<span class="nc" id="L2349">						pstmt.setString(4, &quot;RETAILER&quot;);</span>
<span class="nc" id="L2350">						pstmt.setInt(5, retOrgId);</span>
<span class="nc" id="L2351">						pstmt.setString(6, &quot;DG_SALE&quot;);</span>
<span class="nc" id="L2352">						pstmt</span>
								.setTimestamp(
										7,
										GetDate
												.fetchTransDateTimeStampForAdocLedger(transDate));
<span class="nc" id="L2357">						pstmt.executeUpdate();</span>

						// insert in agent draw game sale table
<span class="nc" id="L2360">						pstmt = con</span>
								.prepareStatement(&quot;insert into st_dg_agt_sale(transaction_id,agent_org_id,retailer_org_id,game_id,mrp_amt,retailer_comm,net_amt,agent_comm,bo_net_amt,claim_status,vat_amt,taxable_sale,govt_comm) values(?,?,?,?,?,?,?,?,?,?,?,?,?)&quot;);

<span class="nc" id="L2363">						logger.debug(tatalAgtTaxableSale</span>
								+ &quot;Test========================&quot; + totalAgtVat);
<span class="nc" id="L2365">						pstmt.setLong(1, transId);</span>
<span class="nc" id="L2366">						pstmt.setInt(2, retParentOrgId);</span>
<span class="nc" id="L2367">						pstmt.setInt(3, retOrgId);</span>
<span class="nc" id="L2368">						pstmt.setInt(4, Integer.parseInt(((String) key)</span>
								.split(&quot;:&quot;)[0]));
<span class="nc" id="L2370">						pstmt.setDouble(5, totalMrpAmt);</span>
<span class="nc" id="L2371">						pstmt.setDouble(6, totalRetComm);</span>
<span class="nc" id="L2372">						pstmt.setDouble(7, totalretNetAmt);</span>
<span class="nc" id="L2373">						pstmt.setDouble(8, totalAgtComm);</span>
<span class="nc" id="L2374">						pstmt.setDouble(9, totalAgtNetAmt);</span>
<span class="nc" id="L2375">						pstmt.setString(10, &quot;CLAIM_BAL&quot;);</span>
<span class="nc" id="L2376">						pstmt.setDouble(11, totalAgtVat);</span>
<span class="nc" id="L2377">						pstmt.setDouble(12, CommonMethods</span>
								.fmtToTwoDecimal(tatalAgtTaxableSale));
<span class="nc" id="L2379">						pstmt.setDouble(13, CommonMethods</span>
								.fmtToTwoDecimal(totalGoodCauseAmt));
<span class="nc" id="L2381">						logger.debug(&quot;Test========================&quot; + pstmt);</span>
<span class="nc" id="L2382">						pstmt.executeUpdate();</span>

						// update retailer draw table for claim_done
<span class="nc bnc" id="L2385" title="All 2 branches missed.">						for (ClmDrawSaleBean clmDrawSaleBean : drawSaleBeanList) {</span>
<span class="nc" id="L2386">							pstmt = con</span>
									.prepareStatement(&quot;update st_dg_ret_sale_? set claim_status=?,agent_ref_transaction_id=? where transaction_id=?&quot;);
<span class="nc" id="L2388">							pstmt.setInt(1, clmDrawSaleBean.getGameNbr());</span>
<span class="nc" id="L2389">							pstmt.setString(2, &quot;DONE_CLAIM&quot;);</span>
<span class="nc" id="L2390">							pstmt.setLong(3, transId);</span>
<span class="nc" id="L2391">							pstmt.setLong(4, clmDrawSaleBean.getTransactinId());</span>
<span class="nc" id="L2392">							pstmt.executeUpdate();</span>

<span class="nc" id="L2394">						}</span>
					}
<span class="nc" id="L2396">				}</span>

				// genarate receipt here
				// int invoiceId = -1;
				// String autoGeneRecieptNo=null;
<span class="nc bnc" id="L2401" title="All 4 branches missed.">				if (trnIdMapInvoice != null &amp;&amp; trnIdMapInvoice.size() &gt; 0) {</span>
<span class="nc" id="L2402">					Set&lt;String&gt; dateKeys = trnIdMapInvoice.keySet();</span>
<span class="nc bnc" id="L2403" title="All 2 branches missed.">					for (String date : dateKeys) {</span>
<span class="nc" id="L2404">						trnIdListInvoice = trnIdMapInvoice.get(date);</span>

<span class="nc" id="L2406">						String query = &quot;SELECT generated_id from st_lms_agent_receipts where (receipt_type='DG_INVOICE' or receipt_type='DG_RECEIPT') and agent_org_id=&quot;</span>
								+ retParentOrgId
								+ &quot; ORDER BY generated_id DESC LIMIT 1&quot;;
						// PreparedStatement agtReceiptNoGenStmt =
						// con.prepareStatement(QueryManager.getAGENTLatestReceiptNb());
<span class="nc" id="L2411">						PreparedStatement agtReceiptNoGenStmt = con</span>
								.prepareStatement(query);
						// agtReceiptNoGenStmt.setString(1, &quot;DG_INVOICE&quot;);
						// agtReceiptNoGenStmt.setInt(2, retParentOrgId);
<span class="nc" id="L2415">						ResultSet recieptRs = agtReceiptNoGenStmt</span>
								.executeQuery();
<span class="nc" id="L2417">						String lastRecieptNoGenerated = null;</span>
<span class="nc bnc" id="L2418" title="All 2 branches missed.">						while (recieptRs.next()) {</span>
<span class="nc" id="L2419">							lastRecieptNoGenerated = recieptRs</span>
									.getString(&quot;generated_id&quot;);
						}

						// String autoGeneRecieptNo=null;
<span class="nc" id="L2424">						autoGeneRecieptNo = GenerateRecieptNo.getRecieptNoAgt(</span>
								&quot;DG_INVOICE&quot;, lastRecieptNoGenerated, &quot;AGENT&quot;,
								retParentOrgId);

						// insert in receipt master for invoice

<span class="nc" id="L2430">						agtReceiptNoGenStmt = con.prepareStatement(QueryManager</span>
								.insertInReceiptMaster());
<span class="nc" id="L2432">						agtReceiptNoGenStmt.setString(1, &quot;AGENT&quot;);</span>
<span class="nc" id="L2433">						agtReceiptNoGenStmt.executeUpdate();</span>

<span class="nc" id="L2435">						ResultSet rs = agtReceiptNoGenStmt.getGeneratedKeys();</span>
<span class="nc" id="L2436">						int invoiceId = -1;</span>
<span class="nc bnc" id="L2437" title="All 2 branches missed.">						while (rs.next()) {</span>
<span class="nc" id="L2438">							invoiceId = rs.getInt(1);</span>
						}

						// insert into agent receipt table

<span class="nc" id="L2443">						agtReceiptNoGenStmt = con.prepareStatement(QueryManager</span>
								.insertInAgentReceipts());
<span class="nc" id="L2445">						agtReceiptNoGenStmt.setInt(1, invoiceId);</span>
<span class="nc" id="L2446">						agtReceiptNoGenStmt.setString(2, &quot;DG_INVOICE&quot;);</span>
<span class="nc" id="L2447">						agtReceiptNoGenStmt.setInt(3, retParentOrgId);</span>
<span class="nc" id="L2448">						agtReceiptNoGenStmt.setInt(4, retOrgId);</span>
<span class="nc" id="L2449">						agtReceiptNoGenStmt.setString(5, &quot;RETAILER&quot;);</span>
<span class="nc" id="L2450">						agtReceiptNoGenStmt.setString(6, autoGeneRecieptNo);</span>
<span class="nc" id="L2451">						agtReceiptNoGenStmt.setTimestamp(7, Util.getCurrentTimeStamp());</span>
<span class="nc" id="L2452">						logger.debug(agtReceiptNoGenStmt);</span>
<span class="nc" id="L2453">						agtReceiptNoGenStmt.execute();</span>

<span class="nc" id="L2455">						agtReceiptNoGenStmt = con.prepareStatement(QueryManager</span>
								.insertAgentReceiptTrnMapping());
<span class="nc bnc" id="L2457" title="All 2 branches missed.">						for (int i = 0; i &lt; trnIdListInvoice.size(); i++) {</span>
<span class="nc" id="L2458">							agtReceiptNoGenStmt.setInt(1, invoiceId);</span>
<span class="nc" id="L2459">							agtReceiptNoGenStmt.setLong(2, trnIdListInvoice</span>
									.get(i));
<span class="nc" id="L2461">							agtReceiptNoGenStmt.execute();</span>

						}

<span class="nc" id="L2465">					}</span>
				}
			}
			// update for refund sale
<span class="nc bnc" id="L2469" title="All 2 branches missed.">			if (drawSaleRefundMap != null) {</span>
<span class="nc" id="L2470">				Set keySetRefund = drawSaleRefundMap.keySet();</span>
<span class="nc bnc" id="L2471" title="All 2 branches missed.">				for (Object key : keySetRefund) {</span>
<span class="nc" id="L2472">					drawSaleBeanList = drawSaleRefundMap.get(key);</span>
<span class="nc" id="L2473">					double totalMrpAmt = 0.0;</span>
<span class="nc" id="L2474">					double totalRetComm = 0.0;</span>
<span class="nc" id="L2475">					double totalAgtComm = 0.0;</span>
<span class="nc" id="L2476">					double totalretNetAmt = 0.0;</span>
<span class="nc" id="L2477">					double totalAgtNetAmt = 0.0;</span>
<span class="nc" id="L2478">					double totalGoodCauseAmt = 0.0;</span>
<span class="nc" id="L2479">					double totalCancellationCharges = 0.0;</span>
<span class="nc" id="L2480">					double ppr = 0.0;</span>
<span class="nc" id="L2481">					double vatAmt = 0.0;</span>
<span class="nc bnc" id="L2482" title="All 2 branches missed.">					if (!drawSaleBeanList.isEmpty()) {</span>
<span class="nc" id="L2483">						ppr = drawSaleBeanList.get(0).getPricePayRatio();</span>
<span class="nc" id="L2484">						vatAmt = drawSaleBeanList.get(0).getVatAmt();</span>
					}
<span class="nc" id="L2486">					String transDate = null;</span>
<span class="nc bnc" id="L2487" title="All 2 branches missed.">					for (ClmDrawSaleBean clmDrawSaleBean : drawSaleBeanList) {</span>

						// totalMrpAmt=clmDrawSaleBean.getMrpAmt();
<span class="nc" id="L2490">						totalMrpAmt += clmDrawSaleBean.getMrpAmt();</span>

						// totalRetComm=clmDrawSaleBean.getRetComm();
<span class="nc" id="L2493">						totalRetComm += clmDrawSaleBean.getRetComm();</span>

<span class="nc" id="L2495">						totalCancellationCharges += clmDrawSaleBean</span>
								.getCancellationCharges();

						// totalAgtComm = clmDrawSaleBean.getAgtComm();
<span class="nc" id="L2499">						totalAgtComm += clmDrawSaleBean.getAgtComm();</span>

						// totalGoodCauseAmt =
						// clmDrawSaleBean.getAgtGoodCauseAmt();
<span class="nc" id="L2503">						totalGoodCauseAmt += clmDrawSaleBean</span>
								.getAgtGoodCauseAmt();
<span class="nc" id="L2505">						transDate = clmDrawSaleBean.getTransDate();</span>

<span class="nc" id="L2507">					}</span>
<span class="nc" id="L2508">					totalretNetAmt = totalMrpAmt - totalRetComm</span>
							- totalCancellationCharges;
<span class="nc" id="L2510">					totalAgtNetAmt = totalMrpAmt - totalAgtComm</span>
							- totalCancellationCharges;

					// calculate agt vat , agt taxable sale and agt good cause

<span class="nc" id="L2515">					double totalAgtVat = CommonMethods.calculateDrawGameVatAgt(</span>
							totalMrpAmt, Double.parseDouble(((String) key)
									.split(&quot;:&quot;)[1]), ppr, Double
									.parseDouble(((String) key).split(&quot;:&quot;)[3]),
							vatAmt);
					/*
					 * double tatalAgtTaxableSale = (((totalMrpAmt * (100 -
					 * (Double .parseDouble(((String) key).split(&quot;:&quot;)[1]) 100 /
					 * totalMrpAmt + ppr + Double .parseDouble(((String)
					 * key).split(&quot;:&quot;)[3]) 100 / totalMrpAmt))) / 100) * 100) /
					 * (100 + vatAmt);
					 */
<span class="nc" id="L2527">					double tatalAgtTaxableSale = CommonMethods.calTaxableSale(</span>
							totalMrpAmt, Double.parseDouble(((String) key)
									.split(&quot;:&quot;)[1]), ppr, Double
									.parseDouble(((String) key).split(&quot;:&quot;)[3]),
							vatAmt);
<span class="nc" id="L2532">					retDebitAmount = retDebitAmount - totalretNetAmt;</span>

					// insert in main transaction master
					// insert in main transaction table
<span class="nc" id="L2536">					PreparedStatement pstmt = con.prepareStatement(QueryManager</span>
							.insertInLMSTransactionMaster());
<span class="nc" id="L2538">					pstmt.setString(1, &quot;AGENT&quot;);</span>
<span class="nc" id="L2539">					pstmt.executeUpdate();</span>
<span class="nc" id="L2540">					ResultSet rsTrns = pstmt.getGeneratedKeys();</span>
<span class="nc bnc" id="L2541" title="All 2 branches missed.">					if (rsTrns.next()) {</span>
<span class="nc" id="L2542">						long transId = rsTrns.getLong(1);</span>
						// trnIdListCRNote.add(transId);
<span class="nc bnc" id="L2544" title="All 2 branches missed.">						if (trnIdMapCRNote.containsKey(transDate)) {</span>
<span class="nc" id="L2545">							trnIdMapCRNote.get(transDate).add(transId);</span>
						} else {
<span class="nc" id="L2547">							trnIdListCRNote = new ArrayList&lt;Long&gt;();</span>
<span class="nc" id="L2548">							trnIdListCRNote.add(transId);</span>
<span class="nc" id="L2549">							trnIdMapCRNote.put(transDate, trnIdListCRNote);</span>
						}
						// insert in agent transaction master
<span class="nc" id="L2552">						pstmt = con.prepareStatement(QueryManager</span>
								.insertInAgentTransactionMaster());
<span class="nc" id="L2554">						pstmt.setLong(1, transId);</span>
<span class="nc" id="L2555">						pstmt.setInt(2, retParentUserId);</span>
<span class="nc" id="L2556">						pstmt.setInt(3, retParentOrgId);</span>
<span class="nc" id="L2557">						pstmt.setString(4, &quot;RETAILER&quot;);</span>
<span class="nc" id="L2558">						pstmt.setInt(5, retOrgId);</span>
<span class="nc" id="L2559">						pstmt.setString(6, ((String) key).split(&quot;:&quot;)[4]);</span>
<span class="nc" id="L2560">						pstmt</span>
								.setTimestamp(
										7,
										GetDate
												.fetchTransDateTimeStampForAdocLedger(transDate));
<span class="nc" id="L2565">						pstmt.executeUpdate();</span>

						// insert in agent draw game sale table
						// double retNetAmt=clmDrawSaleBean.getMrpAmt() -
						// clmDrawSaleBean.getRetComm();
						// retDebitAmount+=retNetAmt;
<span class="nc" id="L2571">						pstmt = con</span>
								.prepareStatement(&quot;insert into st_dg_agt_sale_refund(transaction_id,agent_org_id,retailer_org_id,game_id,mrp_amt,retailer_comm,net_amt,agent_comm,bo_net_amt,claim_status,vat_amt,taxable_sale,govt_comm,cancellation_charges) values(?,?,?,?,?,?,?,?,?,?,?,?,?,?)&quot;);
<span class="nc" id="L2573">						pstmt.setLong(1, transId);</span>
<span class="nc" id="L2574">						pstmt.setInt(2, retParentOrgId);</span>
<span class="nc" id="L2575">						pstmt.setInt(3, retOrgId);</span>
<span class="nc" id="L2576">						pstmt.setInt(4, Integer.parseInt(((String) key)</span>
								.split(&quot;:&quot;)[0]));
<span class="nc" id="L2578">						pstmt.setDouble(5, totalMrpAmt);</span>
<span class="nc" id="L2579">						pstmt.setDouble(6, totalRetComm);</span>
<span class="nc" id="L2580">						pstmt.setDouble(7, totalretNetAmt);</span>
<span class="nc" id="L2581">						pstmt.setDouble(8, totalAgtComm);</span>
<span class="nc" id="L2582">						pstmt.setDouble(9, totalAgtNetAmt);</span>
<span class="nc" id="L2583">						pstmt.setString(10, &quot;CLAIM_BAL&quot;);</span>
<span class="nc" id="L2584">						pstmt.setDouble(11, totalAgtVat);</span>
<span class="nc" id="L2585">						pstmt.setDouble(12, tatalAgtTaxableSale);</span>
<span class="nc" id="L2586">						pstmt.setDouble(13, totalGoodCauseAmt);</span>
<span class="nc" id="L2587">						pstmt.setDouble(14, totalCancellationCharges);</span>
<span class="nc" id="L2588">						pstmt.executeUpdate();</span>
<span class="nc" id="L2589">						logger.debug(&quot;%%%%%insert &quot; + pstmt);</span>

						// update retailer draw table for claim_done
<span class="nc bnc" id="L2592" title="All 2 branches missed.">						for (ClmDrawSaleBean clmDrawSaleBean : drawSaleBeanList) {</span>
<span class="nc" id="L2593">							pstmt = con</span>
									.prepareStatement(&quot;update st_dg_ret_sale_refund_? set claim_status=?,agent_ref_transaction_id=? where transaction_id=?&quot;);
<span class="nc" id="L2595">							pstmt.setInt(1, clmDrawSaleBean.getGameNbr());</span>
<span class="nc" id="L2596">							pstmt.setString(2, &quot;DONE_CLAIM&quot;);</span>
<span class="nc" id="L2597">							pstmt.setLong(3, transId);</span>
<span class="nc" id="L2598">							pstmt.setLong(4, clmDrawSaleBean.getTransactinId());</span>
<span class="nc" id="L2599">							pstmt.executeUpdate();</span>

<span class="nc" id="L2601">						}</span>
					}
<span class="nc" id="L2603">				}</span>

				// genarate receipt here
				// int credit note = -1;
				// String autoGeneRecieptNo=null;
<span class="nc bnc" id="L2608" title="All 4 branches missed.">				if (trnIdMapCRNote.size() &gt; 0 &amp;&amp; trnIdMapCRNote != null) {</span>

<span class="nc" id="L2610">					Set&lt;String&gt; dateKeys = trnIdMapCRNote.keySet();</span>
<span class="nc bnc" id="L2611" title="All 2 branches missed.">					for (String date : dateKeys) {</span>
<span class="nc" id="L2612">						trnIdListCRNote = trnIdMapCRNote.get(date);</span>

<span class="nc" id="L2614">						PreparedStatement agtReceiptNoGenStmt = con</span>
								.prepareStatement(QueryManager
										.getAgentLatestCRNoteNb());
<span class="nc" id="L2617">						agtReceiptNoGenStmt.setString(1, &quot;CR_NOTE_CASH&quot;);</span>
<span class="nc" id="L2618">						agtReceiptNoGenStmt.setString(2, &quot;CR_NOTE&quot;);</span>
<span class="nc" id="L2619">						agtReceiptNoGenStmt.setInt(3, retParentOrgId);</span>
<span class="nc" id="L2620">						ResultSet recieptRs = agtReceiptNoGenStmt</span>
								.executeQuery();
<span class="nc" id="L2622">						String lastRecieptNoGenerated = null;</span>
<span class="nc bnc" id="L2623" title="All 2 branches missed.">						while (recieptRs.next()) {</span>
<span class="nc" id="L2624">							lastRecieptNoGenerated = recieptRs</span>
									.getString(&quot;generated_id&quot;);
						}

						// String autoGeneRecieptNo=null;
<span class="nc" id="L2629">						autoGeneRecieptNo = GenerateRecieptNo.getRecieptNoAgt(</span>
								&quot;CR_NOTE&quot;, lastRecieptNoGenerated, &quot;AGENT&quot;,
								retParentOrgId);

						// insert in receipt master for invoice

<span class="nc" id="L2635">						agtReceiptNoGenStmt = con.prepareStatement(QueryManager</span>
								.insertInReceiptMaster());
<span class="nc" id="L2637">						agtReceiptNoGenStmt.setString(1, &quot;AGENT&quot;);</span>
<span class="nc" id="L2638">						agtReceiptNoGenStmt.executeUpdate();</span>

<span class="nc" id="L2640">						ResultSet rs = agtReceiptNoGenStmt.getGeneratedKeys();</span>
<span class="nc" id="L2641">						int crNoteId = -1;</span>
<span class="nc bnc" id="L2642" title="All 2 branches missed.">						while (rs.next()) {</span>
<span class="nc" id="L2643">							crNoteId = rs.getInt(1);</span>
						}

						// insert into agent receipt table

<span class="nc" id="L2648">						agtReceiptNoGenStmt = con.prepareStatement(QueryManager</span>
								.insertInAgentReceipts());
<span class="nc" id="L2650">						agtReceiptNoGenStmt.setInt(1, crNoteId);</span>
<span class="nc" id="L2651">						agtReceiptNoGenStmt.setString(2, &quot;CR_NOTE&quot;);</span>
<span class="nc" id="L2652">						agtReceiptNoGenStmt.setInt(3, retParentOrgId);</span>
<span class="nc" id="L2653">						agtReceiptNoGenStmt.setInt(4, retOrgId);</span>
<span class="nc" id="L2654">						agtReceiptNoGenStmt.setString(5, &quot;RETAILER&quot;);</span>
<span class="nc" id="L2655">						agtReceiptNoGenStmt.setString(6, autoGeneRecieptNo);</span>
<span class="nc" id="L2656">						agtReceiptNoGenStmt.execute();</span>

<span class="nc" id="L2658">						agtReceiptNoGenStmt = con.prepareStatement(QueryManager</span>
								.insertAgentReceiptTrnMapping());
<span class="nc bnc" id="L2660" title="All 2 branches missed.">						for (int i = 0; i &lt; trnIdListCRNote.size(); i++) {</span>
<span class="nc" id="L2661">							agtReceiptNoGenStmt.setInt(1, crNoteId);</span>
<span class="nc" id="L2662">							agtReceiptNoGenStmt.setLong(2, trnIdListCRNote</span>
									.get(i));
<span class="nc" id="L2664">							agtReceiptNoGenStmt.execute();</span>

						}

<span class="nc" id="L2668">					}</span>
				}
			}

<span class="nc" id="L2672">			logger.debug(&quot;&amp;&amp;&amp;&amp;&amp;77777777 &quot; + retDebitAmount);</span>
			// update organization claimable balance
			
<span class="nc" id="L2675">			boolean isValid=OrgCreditUpdation.updateOrganizationBalWithValidate(retDebitAmount, &quot;TRANSACTION&quot;, &quot;DRAW_GAME_SALE&quot;, retOrgId,</span>
					retParentOrgId, &quot;RETAILER&quot;, 0, con);
<span class="nc bnc" id="L2677" title="All 2 branches missed.">			if(!isValid)</span>
<span class="nc" id="L2678">				throw new LMSException();</span>
			
			/*OrgCreditUpdation.updateCreditLimitForRetailer(retOrgId,
					&quot;DRAW_GAME_SALE&quot;, retDebitAmount, con);*/
<span class="nc" id="L2682">			OrgCreditUpdation.updateOrganizationBalWithValidate(retDebitAmount, &quot;CLAIM_BAL&quot;, &quot;DEBIT&quot;, retOrgId,</span>
					retParentOrgId, &quot;RETAILER&quot;, 0, con);
			/*updateOrgBalance(&quot;CLAIM_BAL&quot;, retDebitAmount, retOrgId, &quot;DEBIT&quot;,
					con);*/
<span class="nc" id="L2686">			return autoGeneRecieptNo;</span>
<span class="nc" id="L2687">		} catch (SQLException e) {</span>
<span class="nc" id="L2688">			e.printStackTrace();</span>
<span class="nc" id="L2689">			throw new LMSException();</span>
		}

	}

	public String updateClmableBalOfAgtOrg(int agtUserId, int agtOrgId,
			int parUserId, int parOrgId, Map pwtMap, Connection conn)
			throws SQLException, LMSException {

<span class="nc" id="L2698">		String receiptId = null;</span>

<span class="nc" id="L2700">		String fetchClmBalOfOrgQuery = &quot;select claimable_bal from st_lms_organization_master where organization_id = ?&quot;;</span>
<span class="nc" id="L2701">		pstmt = conn.prepareStatement(fetchClmBalOfOrgQuery);</span>
<span class="nc" id="L2702">		pstmt.setInt(1, agtOrgId);</span>
<span class="nc" id="L2703">		result = pstmt.executeQuery();</span>

<span class="nc bnc" id="L2705" title="All 2 branches missed.">		if (result.next()) {</span>
<span class="nc" id="L2706">			double amt = result.getDouble(&quot;claimable_bal&quot;);</span>

<span class="nc" id="L2708">			logger.debug(&quot;======================&quot;);</span>
<span class="nc" id="L2709">			logger.debug(pwtMap.get(&quot;totalClmBal&quot;));</span>

<span class="nc" id="L2711">			double totalPwtAmt = (Double) pwtMap.get(&quot;totalClmBal&quot;);</span>
<span class="nc" id="L2712">			logger.debug(&quot;claimable_bal of  AGENT id &quot; + agtOrgId + &quot; is = &quot;</span>
					+ FormatNumber.formatNumberForJSP(amt)
					+ &quot; and total claimable pwt amt is = &quot;
					+ FormatNumber.formatNumberForJSP(totalPwtAmt));

<span class="nc bnc" id="L2717" title="All 4 branches missed.">			boolean verifyValue = amt &gt; 0 &amp;&amp; amt &gt;= totalPwtAmt;</span>
<span class="nc" id="L2718">			verifyValue = true; // need to change</span>
<span class="nc bnc" id="L2719" title="All 2 branches missed.">			if (verifyValue) {</span>

<span class="nc" id="L2721">				Map pwtDetail = (Map) pwtMap.get(&quot;clmPwtDetails&quot;);</span>
<span class="nc" id="L2722">				Set gameIdSet = pwtDetail.keySet();</span>

<span class="nc" id="L2724">				double agtCreditAmt = 0.0;</span>
<span class="nc" id="L2725">				List&lt;Long&gt; transList = null;</span>
<span class="nc" id="L2726">				Map&lt;String, List&lt;Long&gt;&gt; transMap = new HashMap&lt;String, List&lt;Long&gt;&gt;();</span>
<span class="nc bnc" id="L2727" title="All 2 branches missed.">				for (Object gameid : gameIdSet) {</span>
<span class="nc" id="L2728">					int gameId = (Integer) gameid;</span>
					/*
					 * List&lt;ClmPwtBean&gt; pwtBeanList = (List&lt;ClmPwtBean&gt;)
					 * pwtDetail .get(gameId);
					 */

<span class="nc" id="L2734">					List&lt;ClmPwtBean&gt; pwtBeanListGameIdWise = (List&lt;ClmPwtBean&gt;) pwtDetail</span>
							.get(gameId);
					;

<span class="nc bnc" id="L2738" title="All 2 branches missed.">					if (pwtBeanListGameIdWise.isEmpty()) {</span>
<span class="nc" id="L2739">						logger.debug(&quot;pwt bean list is empty for the game = &quot;</span>
								+ gameId);
<span class="nc" id="L2741">						continue;</span>
					}

					// These both for loops are created to group the data
<span class="nc" id="L2745">					Set&lt;String&gt; groupKeySet = new TreeSet&lt;String&gt;();</span>

<span class="nc bnc" id="L2747" title="All 2 branches missed.">					for (ClmPwtBean clmPwtBean : pwtBeanListGameIdWise) {</span>
<span class="nc" id="L2748">						groupKeySet.add(clmPwtBean.getGameId() + &quot;=&quot;</span>
								+ clmPwtBean.getTransDate());
<span class="nc" id="L2750">					}</span>

<span class="nc" id="L2752">					logger.debug(groupKeySet</span>
							+ &quot;Test111111****************keySet&quot;);
<span class="nc" id="L2754">					List&lt;ClmPwtBean&gt; pwtBeanList = null;</span>
<span class="nc" id="L2755">					int drawId = 0;</span>
<span class="nc" id="L2756">					String transDate = null, gameIdNTransDateArr[] = null;</span>
<span class="nc bnc" id="L2757" title="All 2 branches missed.">					for (String drawIdBean : groupKeySet) {</span>
<span class="nc" id="L2758">						gameIdNTransDateArr = drawIdBean.split(&quot;=&quot;);</span>
<span class="nc" id="L2759">						int game_id = Integer.parseInt(gameIdNTransDateArr[0]);</span>
<span class="nc" id="L2760">						transDate = gameIdNTransDateArr[1];</span>
<span class="nc" id="L2761">						pwtBeanList = new ArrayList&lt;ClmPwtBean&gt;();</span>
<span class="nc bnc" id="L2762" title="All 2 branches missed.">						for (ClmPwtBean clmPwtBean : pwtBeanListGameIdWise) {</span>
<span class="nc bnc" id="L2763" title="All 6 branches missed.">							if (drawId == clmPwtBean.getDrawId()</span>
									&amp;&amp; transDate != null
									&amp;&amp; transDate.equals(clmPwtBean
											.getTransDate())) {
<span class="nc" id="L2767">								pwtBeanList.add(clmPwtBean);</span>
							}
<span class="nc" id="L2769">						}</span>

						// insert data into main transaction master
<span class="nc" id="L2772">						String LMSMasterQuery = QueryManager</span>
								.insertInLMSTransactionMaster();
<span class="nc" id="L2774">						PreparedStatement LMSMasterPstmt = conn</span>
								.prepareStatement(LMSMasterQuery);
<span class="nc" id="L2776">						LMSMasterPstmt.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L2777">						LMSMasterPstmt.executeUpdate();</span>
<span class="nc" id="L2778">						logger</span>
								.debug(&quot;insert data into transaction master type  is BO &quot;);
<span class="nc" id="L2780">						ResultSet resultSet = LMSMasterPstmt.getGeneratedKeys();</span>

<span class="nc bnc" id="L2782" title="All 2 branches missed.">						if (resultSet.next()) {</span>
<span class="nc" id="L2783">							long transId = resultSet.getLong(1);</span>
<span class="nc bnc" id="L2784" title="All 2 branches missed.">							if (transMap.containsKey(transDate)) {</span>
<span class="nc" id="L2785">								transMap.get(transDate).add(transId);</span>
							} else {
<span class="nc" id="L2787">								transList = new ArrayList&lt;Long&gt;();</span>
<span class="nc" id="L2788">								transList.add(transId);</span>
<span class="nc" id="L2789">								transMap.put(transDate, transList);</span>
							}
							// insert into agent transaction master
<span class="nc" id="L2792">							String masterQuery = QueryManager</span>
									.insertInBOTransactionMaster();
<span class="nc" id="L2794">							PreparedStatement masterPstmt = conn</span>
									.prepareStatement(masterQuery);
<span class="nc" id="L2796">							masterPstmt.setLong(1, transId);</span>
<span class="nc" id="L2797">							masterPstmt.setInt(2, parUserId);</span>
<span class="nc" id="L2798">							masterPstmt.setInt(3, parOrgId);</span>
<span class="nc" id="L2799">							masterPstmt.setString(4, &quot;AGENT&quot;);</span>
<span class="nc" id="L2800">							masterPstmt.setInt(5, agtOrgId);</span>
<span class="nc" id="L2801">							masterPstmt</span>
									.setTimestamp(
											6,
											GetDate
													.fetchTransDateTimeStampForAdocLedger(transDate));
<span class="nc" id="L2806">							masterPstmt.setString(7, &quot;PWT_AUTO&quot;);</span>
<span class="nc" id="L2807">							masterPstmt.execute();</span>
<span class="nc" id="L2808">							logger</span>
									.debug(&quot;insert into agent transaction master = &quot;
											+ masterPstmt);

							// insert into st_se_agent_pwt when comes pwtAmt is
							// in
							// payment and approval limit
<span class="nc" id="L2815">							String boPwtinsertQuery = QueryManager</span>
									.getST1PwtBODetailQuery();
							;
<span class="nc" id="L2818">							PreparedStatement boPwtInsertPstmt = conn</span>
									.prepareStatement(boPwtinsertQuery);

							// update st_se_agent_pwt in case if AGENT brings
							// unclaimed PWTs to BO
<span class="nc" id="L2823">							String agtPwtUpdateQuery = &quot;update st_se_agent_pwt set status=? where game_id = ? and &quot;</span>
									+ &quot; virn_code = ? and agent_org_id = ? and ticket_nbr=?&quot;;
<span class="nc" id="L2825">							PreparedStatement agtPwtUpdatePstmt = conn</span>
									.prepareStatement(agtPwtUpdateQuery);

							// update st_se_agt_direct_player_pwt table
<span class="nc" id="L2829">							String agtPwtUpdateDirectPlr = &quot;update st_se_agt_direct_player_pwt set pwt_claim_status=? &quot;</span>
									+ &quot; where game_id = ? and virn_code = ? and agent_org_id = ? &quot;;
<span class="nc" id="L2831">							PreparedStatement agtDirPlrPstmt = conn</span>
									.prepareStatement(agtPwtUpdateDirectPlr);

<span class="nc" id="L2834">							double commAmt = 0.0, agtNetAmt = 0.0;</span>
<span class="nc bnc" id="L2835" title="All 2 branches missed.">							for (ClmPwtBean clmPwtBean : pwtBeanList) {</span>
<span class="nc" id="L2836">								logger.debug(&quot;\n\n\n&quot;);</span>
<span class="nc" id="L2837">								String encodedVirn = clmPwtBean.getVirnCode();</span>
<span class="nc" id="L2838">								double pwtAmt = clmPwtBean.getPwtAmt();</span>

<span class="nc" id="L2840">								boPwtInsertPstmt.setString(1, encodedVirn);</span>
<span class="nc" id="L2841">								boPwtInsertPstmt.setLong(2, transId);</span>
<span class="nc" id="L2842">								boPwtInsertPstmt.setInt(3, gameId);</span>
<span class="nc" id="L2843">								boPwtInsertPstmt.setInt(4, agtUserId);</span>
<span class="nc" id="L2844">								boPwtInsertPstmt.setInt(5, agtOrgId);</span>
<span class="nc" id="L2845">								commAmt = pwtAmt * clmPwtBean.getClaimComm()</span>
										* 0.01; // AGENT
								// commission
								// amount
<span class="nc" id="L2849">								agtNetAmt = pwtAmt + commAmt;</span>
<span class="nc" id="L2850">								agtCreditAmt += agtNetAmt; // Total Actual</span>
								// amount
								// that added in AGENT
								// ACA
<span class="nc" id="L2854">								boPwtInsertPstmt.setDouble(6, pwtAmt);</span>
<span class="nc" id="L2855">								boPwtInsertPstmt.setDouble(7, commAmt);</span>
<span class="nc" id="L2856">								boPwtInsertPstmt.setDouble(8, agtNetAmt);</span>
<span class="nc" id="L2857">								boPwtInsertPstmt.execute();</span>
<span class="nc" id="L2858">								logger.debug(&quot;insert into st_se_agent_pwt = &quot;</span>
										+ boPwtInsertPstmt);

<span class="nc bnc" id="L2861" title="All 2 branches missed.">								if (!&quot;direct_plr&quot;.equals(clmPwtBean</span>
										.getPwtType())) {
									// update retailer PWT status for claimed
									// PWT as
									// done
<span class="nc" id="L2866">									agtPwtUpdatePstmt.setString(1, &quot;DONE_CLM&quot;);</span>
<span class="nc" id="L2867">									agtPwtUpdatePstmt.setInt(2, gameId);</span>
<span class="nc" id="L2868">									agtPwtUpdatePstmt.setString(3, encodedVirn);</span>
<span class="nc" id="L2869">									agtPwtUpdatePstmt.setInt(4, agtOrgId);</span>
<span class="nc" id="L2870">									agtPwtUpdatePstmt.setString(5, clmPwtBean</span>
											.getTktNbr());
<span class="nc" id="L2872">									int row = agtPwtUpdatePstmt.executeUpdate();</span>
<span class="nc bnc" id="L2873" title="All 2 branches missed.">									if (row == 1) {</span>
<span class="nc" id="L2874">										logger</span>
												.debug(&quot;status of VIRN == &quot;
														+ encodedVirn
														+ &quot;   in AGENT PWT table Updated successfully = &quot;
														+ agtPwtUpdatePstmt);
									} else {
<span class="nc" id="L2880">										throw new LMSException(</span>
												&quot;row updated for VIRN &quot;
														+ encodedVirn
														+ &quot;  is = &quot; + row
														+ &quot; in AGENT PWT table&quot;
														+ agtPwtUpdatePstmt);
									}
<span class="nc" id="L2887">								} else {</span>
									// update retailer Direct Player PWT status
									// for
									// claimed PWT as done
<span class="nc" id="L2891">									agtDirPlrPstmt.setString(1, &quot;DONE_CLM&quot;);</span>
<span class="nc" id="L2892">									agtDirPlrPstmt.setInt(2, gameId);</span>
<span class="nc" id="L2893">									agtDirPlrPstmt.setString(3, encodedVirn);</span>
<span class="nc" id="L2894">									agtDirPlrPstmt.setInt(4, agtOrgId);</span>
<span class="nc" id="L2895">									int row = agtDirPlrPstmt.executeUpdate();</span>
<span class="nc bnc" id="L2896" title="All 2 branches missed.">									if (row == 1) {</span>
<span class="nc" id="L2897">										logger</span>
												.debug(&quot;status of  VIRN == &quot;
														+ encodedVirn
														+ &quot;      in AGENT Direct Player PWT table Updated successfully &quot;
														+ agtDirPlrPstmt);
									} else {
<span class="nc" id="L2903">										throw new LMSException(</span>
												&quot;row updated for VIRN &quot;
														+ encodedVirn
														+ &quot;  is = &quot;
														+ row
														+ &quot; in AGENT  Direct Player PWT table&quot;);
									}

								}

								// update the ticket_inv_detail table
								// String [] tktArr =
								// clmPwtBean.getTktNbr().split(&quot;-&quot;);
								// commHelper.updateTicketInvTable(clmPwtBean.getTktNbr(),
								// tktArr[0]+&quot;-&quot;+tktArr[1],
								// Integer.parseInt(tktArr[0]), gameId,
								// &quot;CLAIM_AGT_AUTO&quot;, parUserId , parOrgId,
								// conn);

								// update PWT inventory status table
<span class="nc" id="L2923">								updateVirnStatus(clmPwtBean.getGameNbr(),</span>
										&quot;CLAIM_AGT_AUTO&quot;, gameId, clmPwtBean
												.getVirnCode(), conn,
										MD5Encoder.encode(clmPwtBean
												.getTktNbr()));

<span class="nc" id="L2929">							}</span>

<span class="nc" id="L2931">						} else {</span>
<span class="nc" id="L2932">							throw new LMSException(</span>
									&quot;Transaction Not Generated Successfully &quot;);
						}
<span class="nc" id="L2935">					}</span>
<span class="nc" id="L2936">				}// for loop of all games finished here</span>

<span class="nc" id="L2938">				boolean isValid=OrgCreditUpdation.updateOrganizationBalWithValidate(agtCreditAmt, &quot;TRANSACTION&quot;, &quot;PWT_AUTO&quot;, agtOrgId,</span>
						0, &quot;AGENT&quot;, 0, conn);
<span class="nc bnc" id="L2940" title="All 2 branches missed.">				if(!isValid)</span>
<span class="nc" id="L2941">					throw new LMSException();</span>
					
				
				/*// update AGENT ACA and claimable Balance
				OrgCreditUpdation.updateCreditLimitForAgent(agtOrgId,
						&quot;PWT_AUTO&quot;, agtCreditAmt, conn);*/
				// commHelper.updateOrgBalance(&quot;CLAIM_BAL&quot;, agtCreditAmt,
				// agtOrgId, &quot;DEBIT&quot;, conn);
				// changed when draw game sale come picture
<span class="nc" id="L2950">				OrgCreditUpdation.updateOrganizationBalWithValidate(agtCreditAmt, &quot;CLAIM_BAL&quot;, &quot;CREDIT_UPDATE_LEDGER&quot;, agtOrgId,</span>
						0, &quot;AGENT&quot;, 0, conn);
				/*updateOrgBalance(&quot;CLAIM_BAL&quot;, agtCreditAmt, agtOrgId, &quot;CREDIT&quot;,
						conn);*/

				// generate receipt for BO
<span class="nc bnc" id="L2956" title="All 2 branches missed.">				if (transMap.size() &gt; 0) {</span>
<span class="nc" id="L2957">					String receipts = generateReceiptBoNew(conn, agtOrgId,</span>
							&quot;AGENT&quot;, transMap);
<span class="nc" id="L2959">					String receiptArr[] = receipts.split(&quot;-&quot;);</span>
<span class="nc" id="L2960">					receiptId = receiptArr[1];</span>
<span class="nc" id="L2961">					logger.debug(&quot;receipt id is = &quot; + receiptId</span>
							+ &quot;  transList.size() = &quot; + transMap.size()
							+ &quot;  and transaction ids = &quot; + transMap);
<span class="nc" id="L2964">				} else {</span>
<span class="nc" id="L2965">					logger.debug(&quot;receipt id is = &quot; + receiptId</span>
							+ &quot;  transList.size() = &quot; + transMap.size()
							+ &quot;  and transaction ids = &quot; + transMap);
					// throw new LMSException(&quot;NO Transaction Done &quot;);
<span class="nc" id="L2969">					return null;</span>
				}

<span class="nc" id="L2972">			} else {</span>
<span class="nc" id="L2973">				return null;</span>
				// throw new LMSException(&quot;Claimable Balance = &quot;+amt+&quot; is Not
				// Greator Then ZERO &quot; +
				// &quot; || Less Then total Pwt Amt = &quot;+totalPwtAmt);
			}
		}

<span class="nc" id="L2980">		return receiptId;</span>
	}

	public String updateClmableBalOfOrg(int userId, int userOrgId,
			String userType, int parentOrgId) throws LMSException {
<span class="nc" id="L2985">		connection = DBConnect.getConnection();</span>
<span class="nc" id="L2986">		String ledgerStatus = null;</span>
		try {
<span class="nc" id="L2988">			connection.setAutoCommit(false);</span>
<span class="nc" id="L2989">			ledgerStatus = updateClmableBalOfOrg(userId, userOrgId, userType,</span>
					parentOrgId, connection, fetchOrgCommRates(userOrgId,
							userType, parentOrgId, createQryForUpdLedger()));
<span class="nc" id="L2992">			connection.commit();</span>
<span class="nc" id="L2993">			return ledgerStatus;</span>

<span class="nc" id="L2995">		} catch (LMSException e) {</span>
			try {
<span class="nc" id="L2997">				logger.debug(&quot;exception catch before rollback occured&quot;);</span>
<span class="nc" id="L2998">				connection.rollback();</span>
<span class="nc" id="L2999">				logger.debug(&quot;after roolbacked&quot;);</span>
<span class="nc" id="L3000">			} catch (SQLException e1) {</span>
<span class="nc" id="L3001">				e1.printStackTrace();</span>
<span class="nc" id="L3002">				throw new LMSException(e);</span>
<span class="nc" id="L3003">			}</span>
<span class="nc" id="L3004">			e.printStackTrace();</span>
<span class="nc" id="L3005">			throw new LMSException(e);</span>
<span class="nc" id="L3006">		} catch (Exception e) {</span>
			try {
<span class="nc" id="L3008">				logger.debug(&quot;exception catch before rollback occured&quot;);</span>
<span class="nc" id="L3009">				connection.rollback();</span>
<span class="nc" id="L3010">				logger.debug(&quot;after roolbacked&quot;);</span>
<span class="nc" id="L3011">			} catch (SQLException e1) {</span>
<span class="nc" id="L3012">				e1.printStackTrace();</span>
<span class="nc" id="L3013">				throw new LMSException(e);</span>
<span class="nc" id="L3014">			}</span>
<span class="nc" id="L3015">			e.printStackTrace();</span>
<span class="nc" id="L3016">			throw new LMSException(e);</span>
		} finally {
<span class="nc" id="L3018">			try {</span>
<span class="nc" id="L3019">				connection.close();</span>
<span class="nc" id="L3020">			} catch (SQLException e) {</span>
<span class="nc" id="L3021">				e.printStackTrace();</span>
<span class="nc" id="L3022">				throw new LMSException(e);</span>
<span class="nc" id="L3023">			}</span>
		}
	}

	public String updateClmableBalOfOrg(int userId, int userOrgId,
			String userType, int parentOrgId, Connection connection,
			Map&lt;Long, GameMasterLMSBean&gt; commMap) throws LMSException {

		try {

<span class="nc" id="L3033">			boolean isDraw = &quot;YES&quot;.equalsIgnoreCase(LMSFilterDispatcher</span>
					.getIsDraw());
<span class="nc" id="L3035">			boolean isScratch = &quot;YES&quot;.equalsIgnoreCase(LMSFilterDispatcher</span>
					.getIsScratch());

<span class="nc" id="L3038">			String getagentUserId = &quot;select user_id, bb.name from st_lms_user_master aa, st_lms_organization_master bb,&quot;</span>
					+ &quot; st_lms_role_master cc where aa.organization_id =bb.organization_id and aa.role_id = cc.role_id&quot;
					+ &quot; and aa.organization_id = ? and isrolehead = 'Y' and cc.tier_id = (select tier_id from st_lms_tier_master where&quot;
					+ &quot; tier_code = ?) and cc.is_master = 'Y' &quot;;
<span class="nc" id="L3042">			pstmt = connection.prepareStatement(getagentUserId);</span>
<span class="nc" id="L3043">			pstmt.setInt(1, parentOrgId);</span>
<span class="nc bnc" id="L3044" title="All 2 branches missed.">			if (&quot;RETAILER&quot;.equalsIgnoreCase(userType)) {</span>
<span class="nc" id="L3045">				pstmt.setString(2, &quot;AGENT&quot;);</span>
<span class="nc bnc" id="L3046" title="All 2 branches missed.">			} else if (&quot;AGENT&quot;.equalsIgnoreCase(userType)) {</span>
<span class="nc" id="L3047">				pstmt.setString(2, &quot;BO&quot;);</span>
			}
<span class="nc" id="L3049">			ResultSet res = pstmt.executeQuery();</span>

<span class="nc" id="L3051">			int parentUserId = -1;</span>
			// String parentName = null;
<span class="nc bnc" id="L3053" title="All 2 branches missed.">			if (res.next()) {</span>
<span class="nc" id="L3054">				parentUserId = res.getInt(&quot;user_id&quot;);</span>
				// parentName = res.getString(&quot;name&quot;);
			} else {
<span class="nc" id="L3057">				throw new LMSException(</span>
						&quot;parent User Id not found some internal error has occured&quot;);
			}

			// update claimable Amount for Instant Game PWT
<span class="nc" id="L3062">			String receiptId = null;</span>
<span class="nc bnc" id="L3063" title="All 2 branches missed.">			if (isScratch) {</span>
<span class="nc" id="L3064">				logger.debug(&quot;Instant game pwt started&quot;);</span>
<span class="nc" id="L3065">				Map virnPwtMap = fetchPwtDetailsOfOrg(userOrgId, userType,</span>
						&quot;CLAIM_BAL&quot;, connection);
<span class="nc bnc" id="L3067" title="All 4 branches missed.">				if (virnPwtMap != null &amp;&amp; !virnPwtMap.isEmpty()) {</span>
<span class="nc bnc" id="L3068" title="All 2 branches missed.">					if (&quot;RETAILER&quot;.equalsIgnoreCase(userType)) {</span>
<span class="nc" id="L3069">						logger.debug(&quot;CLAIMABLE for RETAILER&quot;);</span>
<span class="nc" id="L3070">						receiptId = updateClmableBalOfRetOrg(userId, userOrgId,</span>
								parentUserId, parentOrgId, virnPwtMap,
								connection);
<span class="nc bnc" id="L3073" title="All 2 branches missed.">					} else if (&quot;AGENT&quot;.equalsIgnoreCase(userType)) { // claimable</span>
						// for
						// AGENT
<span class="nc" id="L3076">						logger.debug(&quot;CLAIMABLE for AGENT&quot;);</span>
<span class="nc" id="L3077">						receiptId = updateClmableBalOfAgtOrg(userId, userOrgId,</span>
								parentUserId, parentOrgId, virnPwtMap,
								connection);
					}
<span class="nc" id="L3081">					logger.debug(&quot;receipt id is &quot; + receiptId);</span>
				} else {
<span class="nc" id="L3083">					receiptId = &quot;AlreadyUpdated&quot;;</span>
				}
<span class="nc" id="L3085">			} else {</span>
<span class="nc" id="L3086">				logger.debug(&quot;Scratch Game Module not implemented !!&quot;);</span>
			}

			// update claimable Amount for Draw games PWT
<span class="nc" id="L3090">			String dgReceiptId = null;</span>
<span class="nc" id="L3091">			Map drawSaleMap = null;</span>
<span class="nc" id="L3092">			String receiptIdDrawSale = null;</span>

<span class="nc bnc" id="L3094" title="All 2 branches missed.">			if (isDraw) {</span>

<span class="nc" id="L3096">				logger.debug(&quot;Draw PWT game pwt started&quot;);</span>
<span class="nc" id="L3097">				Map dgVirnPwtMap = null;</span>
<span class="nc bnc" id="L3098" title="All 2 branches missed.">				if (&quot;RETAILER&quot;.equalsIgnoreCase(userType)) {</span>
<span class="nc" id="L3099">					dgVirnPwtMap = fetchDGPwtDetailsOfRetOrg(userOrgId,</span>
							userType, &quot;CLAIM_BAL&quot;, connection);
<span class="nc bnc" id="L3101" title="All 4 branches missed.">					if (dgVirnPwtMap != null &amp;&amp; !dgVirnPwtMap.isEmpty()) {</span>
<span class="nc" id="L3102">						logger.debug(&quot;CLAIMABLE for RETAILER&quot;);</span>
<span class="nc" id="L3103">						dgReceiptId = updateDGClmableBalOfRetOrg(userId,</span>
								userOrgId, parentUserId, parentOrgId,
								dgVirnPwtMap, connection);
					} else {
<span class="nc" id="L3107">						dgReceiptId = &quot;AlreadyUpdated&quot;;</span>
					}
<span class="nc bnc" id="L3109" title="All 2 branches missed.">				} else if (&quot;AGENT&quot;.equalsIgnoreCase(userType)) { // claimable</span>
					// for AGENT
<span class="nc" id="L3111">					dgVirnPwtMap = fetchDGPwtDetailsOfAgtOrgClm(userOrgId,</span>
							userType, &quot;CLAIM_BAL&quot;, connection);
<span class="nc bnc" id="L3113" title="All 4 branches missed.">					if (dgVirnPwtMap != null &amp;&amp; !dgVirnPwtMap.isEmpty()) {</span>
<span class="nc" id="L3114">						logger.debug(&quot;CLAIMABLE for AGENT&quot;);</span>
<span class="nc" id="L3115">						dgReceiptId = updateDGClmableBalOfAgtOrg(userId,</span>
								userOrgId, parentUserId, parentOrgId,
								dgVirnPwtMap, connection);
					} else {
<span class="nc" id="L3119">						dgReceiptId = &quot;AlreadyUpdated&quot;;</span>
					}
				}
<span class="nc" id="L3122">				logger.debug(&quot;receipt id is &quot; + dgReceiptId);</span>

				// added by yogesh claimable for draw sales
<span class="nc" id="L3125">				logger</span>
						.debug(&quot;code for draw game sale claimmable by yogesh is started *************************&quot;);
<span class="nc" id="L3127">				drawSaleMap = fetchDrawSaleDetailsOfOrg(userOrgId, userType,</span>
						&quot;CLAIM_BAL&quot;, connection, commMap);
<span class="nc bnc" id="L3129" title="All 4 branches missed.">				if (drawSaleMap != null &amp;&amp; !drawSaleMap.isEmpty()) {</span>
<span class="nc bnc" id="L3130" title="All 2 branches missed.">					if (&quot;RETAILER&quot;.equalsIgnoreCase(userType)) {</span>
<span class="nc" id="L3131">						logger</span>
								.debug(&quot;CLAIMABLE for RETAILER by yogesh ************************&quot;);
<span class="nc" id="L3133">						receiptIdDrawSale = updateClaimableForDrawSaleRet(</span>
								drawSaleMap, userOrgId, parentUserId,
								parentOrgId, connection);
<span class="nc bnc" id="L3136" title="All 2 branches missed.">					} else if (&quot;AGENT&quot;.equalsIgnoreCase(userType)) { // claimable</span>
						// for
						// AGENT
<span class="nc" id="L3139">						logger</span>
								.debug(&quot;CLAIMABLE for AGENT by yogesh************************&quot;);
<span class="nc" id="L3141">						receiptIdDrawSale = updateClaimableForDrawSaleAgt(</span>
								drawSaleMap, userOrgId, parentUserId,
								parentOrgId, connection);
					}
				} else {
<span class="nc" id="L3146">					receiptIdDrawSale = &quot;AlreadyUpdated&quot;;</span>
				}

<span class="nc" id="L3149">			} else {</span>
<span class="nc" id="L3150">				logger.debug(&quot;Draw Game Module not implemented !!&quot;);</span>
			}

<span class="nc bnc" id="L3153" title="All 6 branches missed.">			if (receiptId == null &amp;&amp; receiptIdDrawSale == null</span>
					&amp;&amp; dgReceiptId == null) {
<span class="nc" id="L3155">				logger</span>
						.debug(&quot;Exception throws because of no receipt generated !!&quot;);
<span class="nc" id="L3157">				throw new LMSException(</span>
						&quot;Exception throws because of no receipt generated !!&quot;);
<span class="nc bnc" id="L3159" title="All 6 branches missed.">			} else if (&quot;AlreadyUpdated&quot;.equalsIgnoreCase(receiptId)</span>
					&amp;&amp; &quot;AlreadyUpdated&quot;.equalsIgnoreCase(dgReceiptId)
					&amp;&amp; &quot;AlreadyUpdated&quot;.equalsIgnoreCase(receiptIdDrawSale)) {
<span class="nc" id="L3162">				return &quot;AlreadyUpdated&quot;;</span>
			}

<span class="nc" id="L3165">			return &quot;LedgerUpdated&quot;;</span>

<span class="nc" id="L3167">		} catch (Exception e) {</span>
<span class="nc" id="L3168">			e.printStackTrace();</span>
<span class="nc" id="L3169">			throw new LMSException(e);</span>
		}

	}

	/**
	 * this method is depricated and not used commented on 26 april 2013 by sumit
	 */
/*	public void updateClmableBalOfOrgList() throws LMSException {
		logger
				.debug(&quot;============Inside updateClmableBalOfOrgList for Claimable Balance Updation ======== &quot;);
		Connection connection = DBConnect.getConnection();
		String ledgerStatus = null;
		ResultSet rs = null;
		PreparedStatement pstmt = null;
		;
		try {
			connection.setAutoCommit(false);
			String query = &quot;select aa.user_id, aa.organization_id,aa.organization_type, bb.parent_id from 	st_lms_user_master aa, st_lms_organization_master bb where aa.organization_id = bb.organization_id and aa.organization_type!='BO' order by aa.organization_type desc&quot;;
			pstmt = connection.prepareStatement(query);
			rs = pstmt.executeQuery();
			while (rs.next()) {
				ledgerStatus = updateClmableBalOfOrg(rs.getInt(&quot;user_id&quot;), rs
						.getInt(&quot;organization_id&quot;), rs
						.getString(&quot;organization_type&quot;),
						rs.getInt(&quot;parent_id&quot;), connection, fetchOrgCommRates(
								rs.getInt(&quot;organization_id&quot;), rs
										.getString(&quot;organization_type&quot;), rs
										.getInt(&quot;parent_id&quot;),
								createQryForUpdLedger()));
			}
			connection.commit();
		} catch (Exception e) {
			e.printStackTrace();
			throw new LMSException(e);
		} finally {
			try {
				connection.close();
			} catch (SQLException e) {
				e.printStackTrace();
				throw new LMSException(e);
			}
		}
	}
*/
	public String updateClmableBalOfRetOrg(int retUserId, int retOrgId,
			int agentUserId, int agtOrgId, Map pwtMap, Connection connection)
			throws SQLException, LMSException {

		// int receiptId = -1;
<span class="nc" id="L3219">		String receiptId = null;</span>

<span class="nc" id="L3221">		String fetchClmBalOfOrgQuery = &quot;select claimable_bal from st_lms_organization_master where organization_id = ?&quot;;</span>
<span class="nc" id="L3222">		pstmt = connection.prepareStatement(fetchClmBalOfOrgQuery);</span>
<span class="nc" id="L3223">		pstmt.setInt(1, retOrgId);</span>
<span class="nc" id="L3224">		result = pstmt.executeQuery();</span>
<span class="nc bnc" id="L3225" title="All 2 branches missed.">		if (result.next()) {</span>
<span class="nc" id="L3226">			double amt = result.getDouble(&quot;claimable_bal&quot;);</span>
<span class="nc" id="L3227">			double totalPwtAmt = (Double) pwtMap.get(&quot;totalClmBal&quot;);</span>
<span class="nc" id="L3228">			logger.debug(&quot;claimable_bal of  retailer id &quot; + retOrgId + &quot; is = &quot;</span>
					+ amt + &quot; and total claimable pwt amt is = &quot; + totalPwtAmt);

<span class="nc bnc" id="L3231" title="All 4 branches missed.">			boolean verifyValue = amt &gt; 0 &amp;&amp; amt &gt;= totalPwtAmt;</span>
<span class="nc" id="L3232">			verifyValue = true; // need to change</span>
<span class="nc bnc" id="L3233" title="All 2 branches missed.">			if (verifyValue) {</span>

<span class="nc" id="L3235">				Map&lt;Integer, List&lt;ClmPwtBean&gt;&gt; pwtDetail = (Map&lt;Integer, List&lt;ClmPwtBean&gt;&gt;) pwtMap</span>
						.get(&quot;clmPwtDetails&quot;);
<span class="nc" id="L3237">				Set&lt;Integer&gt; gameIdSet = pwtDetail.keySet();</span>

<span class="nc" id="L3239">				double retCreditAmt = 0.0, agtTotalClmBal = 0.0;</span>
<span class="nc" id="L3240">				List&lt;Long&gt; transList = null;</span>
<span class="nc" id="L3241">				Map&lt;String, List&lt;Long&gt;&gt; transMap = new HashMap&lt;String, List&lt;Long&gt;&gt;();</span>
<span class="nc bnc" id="L3242" title="All 2 branches missed.">				for (Integer gameId : gameIdSet) {</span>

<span class="nc" id="L3244">					List&lt;ClmPwtBean&gt; pwtBeanListGameIdWise = pwtDetail</span>
							.get(gameId);

<span class="nc bnc" id="L3247" title="All 2 branches missed.">					if (pwtBeanListGameIdWise.isEmpty()) {</span>
<span class="nc" id="L3248">						logger.debug(&quot;pwt bean list is empty for the game = &quot;</span>
								+ gameId);
<span class="nc" id="L3250">						continue;</span>
					}

					// These both for loops are created to group the data
<span class="nc" id="L3254">					Set&lt;String&gt; groupKeySet = new TreeSet&lt;String&gt;();</span>

<span class="nc bnc" id="L3256" title="All 2 branches missed.">					for (ClmPwtBean clmPwtBean : pwtBeanListGameIdWise) {</span>
<span class="nc" id="L3257">						groupKeySet.add(clmPwtBean.getGameId() + &quot;=&quot;</span>
								+ clmPwtBean.getTransDate());
<span class="nc" id="L3259">					}</span>

<span class="nc" id="L3261">					logger.debug(groupKeySet</span>
							+ &quot;Test11111111****************keySet&quot;);
<span class="nc" id="L3263">					List&lt;ClmPwtBean&gt; pwtBeanList = null;</span>
<span class="nc" id="L3264">					int drawId = 0;</span>
<span class="nc" id="L3265">					String transDate = null, gameIdNTransDateArr[] = null;</span>
<span class="nc bnc" id="L3266" title="All 2 branches missed.">					for (String drawIdBean : groupKeySet) {</span>
<span class="nc" id="L3267">						gameIdNTransDateArr = drawIdBean.split(&quot;=&quot;);</span>
<span class="nc" id="L3268">						int gameid = Integer.parseInt(gameIdNTransDateArr[0]);</span>
<span class="nc" id="L3269">						transDate = gameIdNTransDateArr[1];</span>
<span class="nc" id="L3270">						pwtBeanList = new ArrayList&lt;ClmPwtBean&gt;();</span>
<span class="nc bnc" id="L3271" title="All 2 branches missed.">						for (ClmPwtBean clmPwtBean : pwtBeanListGameIdWise) {</span>
<span class="nc bnc" id="L3272" title="All 6 branches missed.">							if (drawId == clmPwtBean.getDrawId()</span>
									&amp;&amp; transDate != null
									&amp;&amp; transDate.equals(clmPwtBean
											.getTransDate())) {
<span class="nc" id="L3276">								pwtBeanList.add(clmPwtBean);</span>
							}
<span class="nc" id="L3278">						}</span>

						// fetch the PWT commission for parent organization
						// double agtPwtCommRate =
						// commHelper.fetchCommOfOrganization(gameId, agtOrgId,
						// &quot;PWT&quot;,&quot;AGENT&quot;, connection);
						// List&lt;ClmPwtBean&gt; pwtBeanList = pwtDetail.get(gameId);

						// insert data into main transaction master
<span class="nc" id="L3287">						logger</span>
								.debug(&quot;insert data into transaction master type  is AGENT&quot;);
<span class="nc" id="L3289">						String transMasQuery = QueryManager</span>
								.insertInLMSTransactionMaster();
<span class="nc" id="L3291">						PreparedStatement transMasQueryPstmt = connection</span>
								.prepareStatement(transMasQuery);
<span class="nc" id="L3293">						transMasQueryPstmt.setString(1, &quot;AGENT&quot;);</span>
<span class="nc" id="L3294">						transMasQueryPstmt.executeUpdate();</span>
<span class="nc" id="L3295">						ResultSet rs = transMasQueryPstmt.getGeneratedKeys();</span>

<span class="nc bnc" id="L3297" title="All 2 branches missed.">						if (rs.next()) {</span>
<span class="nc" id="L3298">							long transId = rs.getLong(1);</span>
							// added By Vaibhav
<span class="nc bnc" id="L3300" title="All 2 branches missed.">							if (transMap.containsKey(transDate)) {</span>
<span class="nc" id="L3301">								transMap.get(transDate).add(transId);</span>
							} else {
<span class="nc" id="L3303">								transList = new ArrayList&lt;Long&gt;();</span>
<span class="nc" id="L3304">								transList.add(transId);</span>
<span class="nc" id="L3305">								transMap.put(transDate, transList);</span>
							}
							// insert into agent transaction master
<span class="nc" id="L3308">							String agtTransMasterQuery = QueryManager</span>
									.insertInAgentTransactionMaster();
<span class="nc" id="L3310">							logger.debug(&quot;agtTransMasterQuery = &quot;</span>
									+ agtTransMasterQuery);
<span class="nc" id="L3312">							PreparedStatement agtTransMasterPstmt = connection</span>
									.prepareStatement(agtTransMasterQuery);
<span class="nc" id="L3314">							agtTransMasterPstmt.setLong(1, transId);</span>
<span class="nc" id="L3315">							agtTransMasterPstmt.setInt(2, agentUserId);</span>
<span class="nc" id="L3316">							agtTransMasterPstmt.setInt(3, agtOrgId);</span>
<span class="nc" id="L3317">							agtTransMasterPstmt.setString(4, &quot;RETAILER&quot;);</span>
<span class="nc" id="L3318">							agtTransMasterPstmt.setInt(5, retOrgId);</span>
<span class="nc" id="L3319">							agtTransMasterPstmt.setString(6, &quot;PWT_AUTO&quot;);</span>
<span class="nc" id="L3320">							agtTransMasterPstmt</span>
									.setTimestamp(
											7,
											GetDate
													.fetchTransDateTimeStampForAdocLedger(transDate));
<span class="nc" id="L3325">							agtTransMasterPstmt.executeUpdate();</span>
<span class="nc" id="L3326">							logger</span>
									.debug(&quot;insert into agent transaction master = &quot;
											+ agtTransMasterPstmt);

							// insert into st_se_agent_pwt when comes pwtAmt is
							// in
							// payment and approval limit
<span class="nc" id="L3333">							String agtPwtEntry = &quot;insert into  st_se_agent_pwt ( virn_code, transaction_id ,game_id,agent_user_id,retailer_user_id,retailer_org_id,pwt_amt,comm_amt,net_amt,agent_org_id,status,claim_comm,ticket_nbr ) values ( ?, ?, ?, ?, ?, ?, ?, ?, ?, ?,?,?,?)&quot;;</span>
<span class="nc" id="L3334">							pstmt = connection.prepareStatement(agtPwtEntry);</span>

							// update st_se_retailer_pwt in case if retailer
							// brings
							// unclaimed PWTs to agent
<span class="nc" id="L3339">							String retPwtUpdateQuery = &quot;update  st_se_retailer_pwt set status=? where game_id = ? and virn_code = ? and retailer_org_id = ? and ticket_nbr=?&quot;;</span>
<span class="nc" id="L3340">							PreparedStatement retPwtUpdatePstmt = connection</span>
									.prepareStatement(retPwtUpdateQuery);

							// insert in st_ret_direct_player table in case of
							// player
<span class="nc" id="L3345">							String retPwtUpdateDirectPlrQry = &quot;update st_se_retailer_direct_player_pwt set pwt_claim_status=? where game_id = ? and virn_code = ? and retailer_org_id = ? &quot;;</span>
<span class="nc" id="L3346">							PreparedStatement retDirPlrPstmt = connection</span>
									.prepareStatement(retPwtUpdateDirectPlrQry);

<span class="nc" id="L3349">							double commAmt = 0.0, retNetAmt = 0.0;</span>
<span class="nc bnc" id="L3350" title="All 2 branches missed.">							for (ClmPwtBean clmPwtBean : pwtBeanList) {</span>
<span class="nc" id="L3351">								logger.debug(&quot;\n\n\n&quot;);</span>
<span class="nc" id="L3352">								String encodedVirn = clmPwtBean.getVirnCode();</span>
<span class="nc" id="L3353">								double pwtAmt = clmPwtBean.getPwtAmt();</span>

<span class="nc" id="L3355">								pstmt.setString(1, encodedVirn);</span>
<span class="nc" id="L3356">								pstmt.setLong(2, transId);</span>
<span class="nc" id="L3357">								pstmt.setInt(3, gameId);</span>
<span class="nc" id="L3358">								pstmt.setInt(4, agentUserId);</span>
<span class="nc" id="L3359">								pstmt.setInt(5, retUserId);</span>
<span class="nc" id="L3360">								pstmt.setInt(6, retOrgId);</span>
<span class="nc" id="L3361">								commAmt = pwtAmt * clmPwtBean.getClaimComm()</span>
										* 0.01; // retailer
								// commission
								// amount
<span class="nc" id="L3365">								retNetAmt = pwtAmt + commAmt;</span>
<span class="nc" id="L3366">								retCreditAmt += retNetAmt; // Total Actual</span>
								// amount
								// that added in
								// retailer ACA
<span class="nc" id="L3370">								pstmt.setDouble(7, pwtAmt);</span>
<span class="nc" id="L3371">								pstmt.setDouble(8, commAmt);</span>
<span class="nc" id="L3372">								pstmt.setDouble(9, retNetAmt);</span>
<span class="nc" id="L3373">								pstmt.setInt(10, agtOrgId);</span>
<span class="nc" id="L3374">								pstmt.setString(11, &quot;CLAIM_BAL&quot;);</span>
								// agtTotalClmBal+=(pwtAmt+(pwtAmt*.01*agtPwtCommRate));
								// // Total Actual amount that added in AGENT
								// claimable
								// Commission of agent when PWT claimed at
								// retailer
<span class="nc" id="L3380">								pstmt.setDouble(12, clmPwtBean</span>
										.getAgtClaimComm());
<span class="nc" id="L3382">								pstmt.setString(13, clmPwtBean.getTktNbr());</span>
<span class="nc" id="L3383">								pstmt.executeUpdate();</span>
<span class="nc" id="L3384">								logger.debug(&quot;insert into st_se_agent_pwt = &quot;</span>
										+ pstmt);

<span class="nc bnc" id="L3387" title="All 2 branches missed.">								if (!&quot;direct_plr&quot;.equals(clmPwtBean</span>
										.getPwtType())) {
									// update retailer PWT status for claimed
									// PWT as
									// done
<span class="nc" id="L3392">									retPwtUpdatePstmt.setString(1, &quot;DONE_CLM&quot;);</span>
<span class="nc" id="L3393">									retPwtUpdatePstmt.setInt(2, gameId);</span>
<span class="nc" id="L3394">									retPwtUpdatePstmt.setString(3, encodedVirn);</span>
<span class="nc" id="L3395">									retPwtUpdatePstmt.setInt(4, retOrgId);</span>
<span class="nc" id="L3396">									retPwtUpdatePstmt.setString(5, clmPwtBean</span>
											.getTktNbr());
<span class="nc" id="L3398">									int row = retPwtUpdatePstmt.executeUpdate();</span>
<span class="nc bnc" id="L3399" title="All 2 branches missed.">									if (row == 1) {</span>
<span class="nc" id="L3400">										logger</span>
												.debug(&quot;VIRN == &quot;
														+ encodedVirn
														+ &quot;      in Retailet PWT table Updated successfully&quot;);
									} else {
<span class="nc" id="L3405">										throw new LMSException(</span>
												&quot;row updated for VIRN &quot;
														+ encodedVirn
														+ &quot;  is = &quot;
														+ row
														+ &quot; in Retailet PWT table&quot;);
									}
<span class="nc" id="L3412">								} else {</span>
									// update retailer Direct Player PWT status
									// for
									// claimed PWT as done
<span class="nc" id="L3416">									retDirPlrPstmt.setString(1, &quot;DONE_CLM&quot;);</span>
<span class="nc" id="L3417">									retDirPlrPstmt.setInt(2, gameId);</span>
<span class="nc" id="L3418">									retDirPlrPstmt.setString(3, encodedVirn);</span>
<span class="nc" id="L3419">									retDirPlrPstmt.setInt(4, retOrgId);</span>
<span class="nc" id="L3420">									int row = retDirPlrPstmt.executeUpdate();</span>
<span class="nc bnc" id="L3421" title="All 2 branches missed.">									if (row == 1) {</span>
<span class="nc" id="L3422">										logger</span>
												.debug(&quot;VIRN == &quot;
														+ encodedVirn
														+ &quot;      in Retailet Direct Player PWT table Updated successfully&quot;);
									} else {
<span class="nc" id="L3427">										throw new LMSException(</span>
												&quot;row updated for VIRN &quot;
														+ encodedVirn
														+ &quot;  is = &quot;
														+ row
														+ &quot; in Retailet  Direct Player PWT table&quot;);
									}

								}

								// update the ticket_inv_detail table
<span class="nc" id="L3438">								String[] tktArr = clmPwtBean.getTktNbr().split(</span>
										&quot;-&quot;);
<span class="nc" id="L3440">								updateTicketInvTable(clmPwtBean.getTktNbr(),</span>
										tktArr[0] + &quot;-&quot; + tktArr[1], Integer
												.parseInt(tktArr[0]), gameId,
										&quot;CLAIM_RET_CLM_AUTO&quot;, agentUserId,
										agtOrgId, &quot;UPDATE&quot;, retOrgId,
										&quot;RETAILER&quot;, &quot;WEB&quot;, connection);

								// update PWT inventory status table
<span class="nc" id="L3448">								updateVirnStatus(Integer.parseInt(tktArr[0]),</span>
										&quot;CLAIM_RET_CLM_AUTO&quot;, gameId,
										clmPwtBean.getVirnCode(), connection,
										MD5Encoder.encode(clmPwtBean
												.getTktNbr()));

<span class="nc" id="L3454">							}</span>

<span class="nc" id="L3456">						} else {</span>
<span class="nc" id="L3457">							throw new LMSException(</span>
									&quot;Transaction Not Generated Successfully &quot;);
						}
<span class="nc" id="L3460">					}</span>

<span class="nc" id="L3462">				}// for loop of all games finished here</span>

				// update retailer ACA and claimable Balance
				
<span class="nc" id="L3466">				boolean isValid=OrgCreditUpdation.updateOrganizationBalWithValidate(retCreditAmt, &quot;TRANSACTION&quot;, &quot;PWT_AUTO&quot;, retOrgId,</span>
						agtOrgId, &quot;RETAILER&quot;, 0, connection);
<span class="nc bnc" id="L3468" title="All 2 branches missed.">				if(!isValid)</span>
<span class="nc" id="L3469">					throw new LMSException();</span>
					
<span class="nc" id="L3471">				OrgCreditUpdation.updateOrganizationBalWithValidate(retCreditAmt, &quot;CLAIM_BAL&quot;, &quot;CREDIT_UPDATE_LEDGER&quot;, retOrgId,</span>
						agtOrgId, &quot;RETAILER&quot;, 0, connection);
				
				
				
				/*OrgCreditUpdation.updateCreditLimitForRetailer(retOrgId,
						&quot;PWT_AUTO&quot;, retCreditAmt, connection);
				// commHelper.updateOrgBalance(&quot;CLAIM_BAL&quot;, retCreditAmt,
				// retOrgId, &quot;DEBIT&quot;, connection);
				// changed when draw game sale come picture
				updateOrgBalance(&quot;CLAIM_BAL&quot;, retCreditAmt, retOrgId, &quot;CREDIT&quot;,
						connection);*/

				// update AGENT Claimable Balance is not required
				// changed when draw game sale come picture
				// commHelper.updateOrgBalance(&quot;CLAIM_BAL&quot;, agtTotalClmBal,
				// agtOrgId, &quot;CREDIT&quot;, connection);

				// generate receipt on agent end
<span class="nc bnc" id="L3490" title="All 2 branches missed.">				if (transMap.size() &gt; 0) {</span>
<span class="nc" id="L3491">					String strRec = generateReciptForPwtNew(transMap, connection,</span>
							agtOrgId, retOrgId, &quot;RETAILER&quot;, &quot;SCRATCH_GAME&quot;);
<span class="nc" id="L3493">					logger.debug(&quot;receipt id is = &quot; + receiptId</span>
							+ &quot;  transList.size() = &quot; + transMap.size()
							+ &quot;  and transaction ids = &quot; + transMap);
<span class="nc" id="L3496">					receiptId = strRec.split(&quot;-&quot;)[1];</span>
<span class="nc" id="L3497">				} else {</span>
<span class="nc" id="L3498">					logger.debug(&quot;receipt id is = &quot; + receiptId</span>
							+ &quot;  transList.size() = &quot; + transMap.size()
							+ &quot;  and transaction ids = &quot; + transMap);
					// throw new LMSException(&quot;NO Transaction Done &quot;);
<span class="nc" id="L3502">					return null;</span>
				}
<span class="nc" id="L3504">			} else {</span>
				// throw new LMSException(&quot;Claimable Balance = &quot;+amt+&quot; is Not
				// Greator Then ZERO &quot; +
				// &quot; || Less Then total Pwt Amt = &quot;+totalPwtAmt);
<span class="nc" id="L3508">				return null;</span>
			}
		}

<span class="nc" id="L3512">		return receiptId;</span>
	}

	public String updateDGClmableBalOfAgtOrg(int agtUserId, int agtOrgId,
			int boUserId, int boOrgId, Map pwtMap, Connection connection)
			throws SQLException, LMSException {

		// int receiptId = -1;
<span class="nc" id="L3520">		String receiptId = null;</span>

<span class="nc" id="L3522">		String fetchClmBalOfOrgQuery = &quot;select claimable_bal from st_lms_organization_master where &quot;</span>
				+ &quot; organization_id = ?&quot;;
<span class="nc" id="L3524">		PreparedStatement pstmt = connection</span>
				.prepareStatement(fetchClmBalOfOrgQuery);
<span class="nc" id="L3526">		pstmt.setInt(1, agtOrgId);</span>
<span class="nc" id="L3527">		ResultSet result = pstmt.executeQuery();</span>
<span class="nc bnc" id="L3528" title="All 2 branches missed.">		if (result.next()) {</span>
<span class="nc" id="L3529">			double orgClmBal = result.getDouble(&quot;claimable_bal&quot;);</span>
<span class="nc" id="L3530">			logger.debug(&quot;pwt total claimable_bal == &quot; + orgClmBal);</span>
<span class="nc" id="L3531">			boolean verifyValue = true; // need to change</span>

<span class="nc bnc" id="L3533" title="All 2 branches missed.">			if (verifyValue) {</span>

<span class="nc" id="L3535">				Map&lt;String, List&lt;ClmPwtBean&gt;&gt; pwtDetail = (Map&lt;String, List&lt;ClmPwtBean&gt;&gt;) pwtMap</span>
						.get(&quot;DRClmPwtDetailMap&quot;);
<span class="nc" id="L3537">				Set&lt;String&gt; gameNameSet = pwtDetail.keySet();</span>

<span class="nc" id="L3539">				double agtCreditAmt = 0.0;</span>
				// agtTotalClmBal = 0.0;
<span class="nc" id="L3541">				int gameNbr = -1, gameId = -1;</span>
<span class="nc" id="L3542">				List&lt;Long&gt; transList = null;</span>
<span class="nc" id="L3543">				Map&lt;String, List&lt;Long&gt;&gt; transMap = new HashMap&lt;String, List&lt;Long&gt;&gt;();</span>
<span class="nc bnc" id="L3544" title="All 2 branches missed.">				for (String gameName : gameNameSet) {</span>

<span class="nc" id="L3546">					List&lt;ClmPwtBean&gt; pwtBeanList = pwtDetail.get(gameName);</span>

<span class="nc bnc" id="L3548" title="All 2 branches missed.">					if (pwtBeanList.isEmpty()) {</span>
<span class="nc" id="L3549">						logger.debug(&quot;pwt bean list is empty for the game = &quot;</span>
								+ gameName);
<span class="nc" id="L3551">						continue;</span>
					}

					// These both for loops are created to group the data draw
					// id wise and comm wise
<span class="nc" id="L3556">					Set&lt;String&gt; drawIdSet = new TreeSet&lt;String&gt;();</span>

<span class="nc bnc" id="L3558" title="All 2 branches missed.">					for (ClmPwtBean clmPwtBean : pwtBeanList) {</span>
<span class="nc" id="L3559">						drawIdSet.add(clmPwtBean.getDrawId() + &quot;=&quot;</span>
								+ clmPwtBean.getTransDate());
<span class="nc" id="L3561">					}</span>

<span class="nc" id="L3563">					List&lt;ClmPwtBean&gt; drawIdWiseList = null;</span>
<span class="nc" id="L3564">					int drawId = 0;</span>
<span class="nc" id="L3565">					String transDate = null, drawIdNTransDateArr[] = null;</span>
<span class="nc bnc" id="L3566" title="All 2 branches missed.">					for (String drawIdBean : drawIdSet) {</span>
<span class="nc" id="L3567">						drawIdNTransDateArr = drawIdBean.split(&quot;=&quot;);</span>
<span class="nc" id="L3568">						drawId = Integer.parseInt(drawIdNTransDateArr[0]);</span>
<span class="nc" id="L3569">						transDate = drawIdNTransDateArr[1];</span>
<span class="nc" id="L3570">						drawIdWiseList = new ArrayList&lt;ClmPwtBean&gt;();</span>
<span class="nc bnc" id="L3571" title="All 2 branches missed.">						for (ClmPwtBean clmPwtBean : pwtBeanList) {</span>
<span class="nc bnc" id="L3572" title="All 6 branches missed.">							if (drawId == clmPwtBean.getDrawId()</span>
									&amp;&amp; transDate != null
									&amp;&amp; transDate.equals(clmPwtBean
											.getTransDate())) {
<span class="nc" id="L3576">								drawIdWiseList.add(clmPwtBean);</span>
							}
<span class="nc" id="L3578">						}</span>

<span class="nc" id="L3580">						logger.debug(drawId + &quot; and list size = &quot;</span>
								+ drawIdWiseList.size());
						// drawIdMap.put(drawId, drawIdWiseList);

						// insert data into main transaction master
<span class="nc" id="L3585">						logger</span>
								.debug(&quot;insert data into transaction master type  is BO&quot;);
<span class="nc" id="L3587">						String transMasQuery = QueryManager</span>
								.insertInLMSTransactionMaster();
<span class="nc" id="L3589">						PreparedStatement transMasQueryPstmt = connection</span>
								.prepareStatement(transMasQuery);
<span class="nc" id="L3591">						transMasQueryPstmt.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L3592">						transMasQueryPstmt.executeUpdate();</span>
<span class="nc" id="L3593">						ResultSet rs = transMasQueryPstmt.getGeneratedKeys();</span>

<span class="nc bnc" id="L3595" title="All 2 branches missed.">						if (rs.next()) {</span>
<span class="nc" id="L3596">							long transId = rs.getLong(1);</span>

<span class="nc bnc" id="L3598" title="All 2 branches missed.">							if (transMap.containsKey(transDate)) {</span>
<span class="nc" id="L3599">								transMap.get(transDate).add(transId);</span>
							} else {
<span class="nc" id="L3601">								transList = new ArrayList&lt;Long&gt;();</span>
<span class="nc" id="L3602">								transList.add(transId);</span>
<span class="nc" id="L3603">								transMap.put(transDate, transList);</span>
							}

							// insert into agent transaction master
<span class="nc" id="L3607">							String boTransMasterQuery = QueryManager</span>
									.insertInBOTransactionMaster();
<span class="nc" id="L3609">							logger.debug(&quot;boTransMasterQuery = &quot;</span>
									+ boTransMasterQuery);
<span class="nc" id="L3611">							PreparedStatement boTransMasterPstmt = connection</span>
									.prepareStatement(boTransMasterQuery);
<span class="nc" id="L3613">							boTransMasterPstmt.setLong(1, transId);</span>
<span class="nc" id="L3614">							boTransMasterPstmt.setInt(2, boUserId);</span>
<span class="nc" id="L3615">							boTransMasterPstmt.setInt(3, boOrgId);</span>
<span class="nc" id="L3616">							boTransMasterPstmt.setString(4, &quot;AGENT&quot;);</span>
<span class="nc" id="L3617">							boTransMasterPstmt.setInt(5, agtOrgId);</span>
<span class="nc" id="L3618">							boTransMasterPstmt</span>
									.setTimestamp(
											6,
											GetDate
													.fetchTransDateTimeStampForAdocLedger(transDate));
<span class="nc" id="L3623">							boTransMasterPstmt.setString(7, &quot;DG_PWT_AUTO&quot;);</span>

<span class="nc" id="L3625">							boTransMasterPstmt.executeUpdate();</span>
<span class="nc" id="L3626">							logger.debug(&quot;insert into bo transaction master = &quot;</span>
									+ boTransMasterPstmt);

							// update st_agt_pwt in case if retailer brings
							// unclaimed PWTs to bo

<span class="nc" id="L3632">							String agtPwtUpdateQuery = &quot;update st_dg_agt_pwt aa, st_dg_pwt_inv_? bb set aa.status = ? ,&quot;</span>
									+ &quot; bb.status = ? , bb.bo_transaction_id =&quot;
									+ transId
									+ &quot; where transaction_id = ? and bb.agent_transaction_id =?&quot;;
<span class="nc" id="L3636">							PreparedStatement agtPwtUpdatePstmt = connection</span>
									.prepareStatement(agtPwtUpdateQuery);

							// insert in st_agt_direct_player table in case of
							// player

<span class="nc" id="L3642">							String agtPwtUpdateDirectPlrQry = &quot;update st_dg_agt_direct_plr_pwt aa, st_dg_pwt_inv_? bb &quot;</span>
									+ &quot; set aa.pwt_claim_status = ? , bb.status = ? , bb.bo_transaction_id =&quot;
									+ transId
									+ &quot; where transaction_id = ?  and bb.agent_transaction_id =?&quot;;
<span class="nc" id="L3646">							PreparedStatement agtDirPlrPstmt = connection</span>
									.prepareStatement(agtPwtUpdateDirectPlrQry);

<span class="nc" id="L3649">							double agtNetAmt = 0.0, netPwt = 0.0, sumPwtAmt = 0.0, agtCommRate = 0.0;</span>
							// agtTotalClmBal = 0.0;
<span class="nc bnc" id="L3651" title="All 2 branches missed.">							for (ClmPwtBean clmPwtBean : drawIdWiseList) {</span>

<span class="nc" id="L3653">								gameNbr = clmPwtBean.getGameNbr();</span>
<span class="nc" id="L3654">								gameId = clmPwtBean.getGameId();</span>
								// sum of PWT Amount
<span class="nc" id="L3656">								sumPwtAmt = sumPwtAmt + clmPwtBean.getPwtAmt();</span>
								// net amount with commission
<span class="nc" id="L3658">								netPwt = clmPwtBean.getPwtAmt()</span>
										+ clmPwtBean.getAgtClaimComm();
								// AGENT net amount with commission
<span class="nc" id="L3661">								agtNetAmt = agtNetAmt + netPwt;</span>
								// Total Actual amount that added in retailer
								// ACA
<span class="nc" id="L3664">								agtCreditAmt = agtCreditAmt + netPwt;</span>
<span class="nc" id="L3665">								logger</span>
										.debug(&quot;netPwt = &quot; + netPwt
												+ &quot;agtNetAmt = &quot; + agtNetAmt
												+ &quot; agtCredit Amount = &quot;
												+ agtCreditAmt);

								// agtCommRate = clmPwtBean.getAgtClaimComm();
								// Total Actual amount that added in AGENT
								// claimable
								// agtTotalClmBal += clmPwtBean.getPwtAmt() +
								// (clmPwtBean.getPwtAmt()*
								// clmPwtBean.getAgtClaimComm()*.01);

<span class="nc bnc" id="L3678" title="All 2 branches missed.">								if (!&quot;direct_plr&quot;.equals(clmPwtBean</span>
										.getPwtType())) {
									// update AGENT PWT status for claimed PWT
									// as done
<span class="nc" id="L3682">									agtPwtUpdatePstmt.setInt(1, clmPwtBean</span>
											.getGameNbr());
<span class="nc" id="L3684">									agtPwtUpdatePstmt.setString(2, &quot;DONE_CLM&quot;);</span>
<span class="nc" id="L3685">									agtPwtUpdatePstmt.setString(3,</span>
											&quot;CLAIM_AGT_CLM_AUTO&quot;);
									// agtPwtUpdatePstmt.setInt(4,
									// clmPwtBean.getGameId());
									// agtPwtUpdatePstmt.setInt(5,
									// clmPwtBean.getDrawId());
									// agtPwtUpdatePstmt.setString(6,
									// clmPwtBean.getTktNbr());
									// agtPwtUpdatePstmt.setInt(7, agtOrgId);
<span class="nc" id="L3694">									agtPwtUpdatePstmt.setLong(4, clmPwtBean</span>
											.getTransactionId());
<span class="nc" id="L3696">									agtPwtUpdatePstmt.setLong(5, clmPwtBean</span>
											.getTransactionId());
<span class="nc" id="L3698">									agtPwtUpdatePstmt.executeUpdate();</span>
<span class="nc" id="L3699">									logger</span>
											.debug(&quot;  in agt Direct PWT table Updated successfully \n&quot;
													+ agtPwtUpdatePstmt);
								} else {
									// update AGENT Direct Player PWT status for
									// claimed PWT as done
<span class="nc" id="L3705">									agtDirPlrPstmt.setInt(1, clmPwtBean</span>
											.getGameNbr());
<span class="nc" id="L3707">									agtDirPlrPstmt.setString(2, &quot;DONE_CLM&quot;);</span>
<span class="nc" id="L3708">									agtDirPlrPstmt.setString(3,</span>
											&quot;CLAIM_AGT_CLM_AUTO&quot;);
									// agtDirPlrPstmt.setInt(4,
									// clmPwtBean.getGameId());
									// agtDirPlrPstmt.setInt(5,
									// clmPwtBean.getDrawId());
									// agtDirPlrPstmt.setString(6,
									// clmPwtBean.getTktNbr());
									// agtDirPlrPstmt.setInt(7, agtOrgId);
<span class="nc" id="L3717">									agtDirPlrPstmt.setLong(4, clmPwtBean</span>
											.getTransactionId());
<span class="nc" id="L3719">									agtDirPlrPstmt.setLong(5, clmPwtBean</span>
											.getTransactionId());
<span class="nc" id="L3721">									agtDirPlrPstmt.executeUpdate();</span>
<span class="nc" id="L3722">									logger</span>
											.debug(&quot;  in Retailet PWT table Updated successfully \n&quot;
													+ agtDirPlrPstmt);
								}

<span class="nc" id="L3727">							}</span>

<span class="nc" id="L3729">							logger.debug(&quot;=========agtCreditAmt = &quot;</span>
									+ agtCreditAmt + &quot;, agtNetAmt = &quot;
									+ agtNetAmt);

							// insert into st_bo_pwt when comes pwtAmt is in
							// payment and approval limit
<span class="nc" id="L3735">							String agtDGPwtEntry = &quot;insert into st_dg_bo_pwt (bo_user_id, bo_org_id, agent_org_id, &quot;</span>
									+ &quot; draw_id, game_id, transaction_id, pwt_amt, comm_amt, net_amt&quot;
									+ &quot;) values (?, ?, ?, ?, ?, ?, ?, ?,?)&quot;;
<span class="nc" id="L3738">							pstmt = connection.prepareStatement(agtDGPwtEntry);</span>
<span class="nc" id="L3739">							pstmt.setInt(1, boUserId);</span>
<span class="nc" id="L3740">							pstmt.setInt(2, boOrgId);</span>
<span class="nc" id="L3741">							pstmt.setInt(3, agtOrgId);</span>
<span class="nc" id="L3742">							pstmt.setInt(4, drawId);</span>
<span class="nc" id="L3743">							pstmt.setInt(5, gameId);</span>
<span class="nc" id="L3744">							pstmt.setLong(6, transId);</span>
<span class="nc" id="L3745">							pstmt.setDouble(7, sumPwtAmt);</span>
<span class="nc" id="L3746">							pstmt.setDouble(8, agtNetAmt - sumPwtAmt); // Total</span>
							// commission
							// amount
							// of
							// AGENT
<span class="nc" id="L3751">							pstmt.setDouble(9, agtNetAmt);</span>
<span class="nc" id="L3752">							logger.debug(&quot;insert into st_bo_pwt = &quot; + pstmt);</span>
<span class="nc" id="L3753">							pstmt.executeUpdate();</span>

<span class="nc" id="L3755">						} else {</span>
<span class="nc" id="L3756">							throw new LMSException(</span>
									&quot;Transaction Not Generated Successfully &quot;);
						}

<span class="nc" id="L3760">					} // for loop of all games finished here</span>
<span class="nc" id="L3761">				}</span>

				// update retailer ACA and claimable Balance
<span class="nc" id="L3764">				logger.debug(&quot;org claim bal = &quot; + orgClmBal</span>
						+ &quot; :::: agent credit Amt is = &quot; + agtCreditAmt);
				
<span class="nc" id="L3767">				boolean isValid=OrgCreditUpdation.updateOrganizationBalWithValidate(agtCreditAmt, &quot;TRANSACTION&quot;, &quot;PWT_AUTO&quot;, agtOrgId,</span>
						0, &quot;AGENT&quot;, 0, connection);
<span class="nc bnc" id="L3769" title="All 2 branches missed.">				if(!isValid)</span>
<span class="nc" id="L3770">					throw new LMSException();</span>
<span class="nc" id="L3771">				OrgCreditUpdation.updateOrganizationBalWithValidate(agtCreditAmt, &quot;CLAIM_BAL&quot;, &quot;CREDIT&quot;, agtOrgId,</span>
						0, &quot;AGENT&quot;, 0, connection);
				
				
				/*OrgCreditUpdation.updateCreditLimitForAgent(agtOrgId,
						&quot;PWT_AUTO&quot;, agtCreditAmt, connection);
				// commHelper.updateOrgBalance(&quot;CLAIM_BAL&quot;, retCreditAmt,
				// retOrgId, &quot;DEBIT&quot;, connection);
				// changed when draw game sale come picture
				updateOrgBalance(&quot;CLAIM_BAL&quot;, agtCreditAmt, agtOrgId, &quot;CREDIT&quot;,
						connection);*/

				// update AGENT Claimable Balance is not required
				// changed when draw game sale come picture
				// commHelper.updateOrgBalance(&quot;CLAIM_BAL&quot;, agtTotalClmBal,
				// agtOrgId, &quot;CREDIT&quot;, connection);

				// generate receipt on agent end
<span class="nc bnc" id="L3789" title="All 2 branches missed.">				if (transMap.size() &gt; 0) {</span>
<span class="nc" id="L3790">					String strRec = generateReceiptDGBo(connection, agtOrgId,</span>
							&quot;AGENT&quot;, transMap);
<span class="nc" id="L3792">					logger.debug(&quot;receipt id is = &quot; + receiptId</span>
							+ &quot;  transList.size() = &quot; + transMap.size()
							+ &quot;  and transaction ids = &quot; + transMap);
<span class="nc" id="L3795">					receiptId = strRec.split(&quot;-&quot;)[1];</span>
<span class="nc" id="L3796">				} else {</span>
<span class="nc" id="L3797">					logger.debug(&quot;receipt id is = &quot; + receiptId</span>
							+ &quot;  transList.size() = &quot; + transMap.size()
							+ &quot;  and transaction ids = &quot; + transMap);
					// throw new LMSException(&quot;NO Transaction Done &quot;);
<span class="nc" id="L3801">					return null;</span>
				}

<span class="nc" id="L3804">			} else {</span>
				// throw new LMSException(&quot;Claimable Balance = &quot;+amt+&quot; is Not
				// Greator Then ZERO &quot; +
				// &quot; || Less Then total Pwt Amt = &quot;+totalPwtAmt);
<span class="nc" id="L3808">				return null;</span>
			}
		}

<span class="nc" id="L3812">		return receiptId;</span>
	}

	public String updateDGClmableBalOfRetOrg(int retUserId, int retOrgId,
			int agentUserId, int agtOrgId, Map pwtMap, Connection connection)
			throws SQLException, LMSException {

<span class="nc" id="L3819">		String receiptId = null;</span>

<span class="nc" id="L3821">		String fetchClmBalOfOrgQuery = &quot;select claimable_bal from st_lms_organization_master where organization_id = ?&quot;;</span>
<span class="nc" id="L3822">		PreparedStatement pstmt = connection</span>
				.prepareStatement(fetchClmBalOfOrgQuery);
<span class="nc" id="L3824">		pstmt.setInt(1, retOrgId);</span>
<span class="nc" id="L3825">		ResultSet result = pstmt.executeQuery();</span>

<span class="nc" id="L3827">		double orgClmBal = 0.0, retCreditAmt = 0.0, agtTotalClmBal = 0.0;</span>
<span class="nc" id="L3828">		int gameNbr = -1, gameId = -1;</span>

<span class="nc bnc" id="L3830" title="All 2 branches missed.">		if (result.next()) {</span>
<span class="nc" id="L3831">			orgClmBal = result.getDouble(&quot;claimable_bal&quot;);</span>
<span class="nc" id="L3832">			logger.debug(&quot;total claimable_bal == &quot; + orgClmBal);</span>

<span class="nc" id="L3834">			boolean verifyValue = true; // need to change</span>

<span class="nc bnc" id="L3836" title="All 2 branches missed.">			if (verifyValue) {</span>

<span class="nc" id="L3838">				Map&lt;String, List&lt;ClmPwtBean&gt;&gt; pwtDetail = (Map&lt;String, List&lt;ClmPwtBean&gt;&gt;) pwtMap</span>
						.get(&quot;DRClmPwtDetailMap&quot;);
<span class="nc" id="L3840">				Set&lt;String&gt; gameNameSet = pwtDetail.keySet();</span>
<span class="nc" id="L3841">				CommonFunctionsHelper commHelper = new CommonFunctionsHelper();</span>
<span class="nc" id="L3842">				List&lt;Long&gt; transList = null;</span>
<span class="nc" id="L3843">				Map&lt;String, List&lt;Long&gt;&gt; transMap = new HashMap&lt;String, List&lt;Long&gt;&gt;();</span>
<span class="nc bnc" id="L3844" title="All 2 branches missed.">				for (String gameName : gameNameSet) {</span>

<span class="nc" id="L3846">					List&lt;ClmPwtBean&gt; pwtBeanList = pwtDetail.get(gameName);</span>

<span class="nc bnc" id="L3848" title="All 2 branches missed.">					if (pwtBeanList.isEmpty()) {</span>
<span class="nc" id="L3849">						logger.debug(&quot;pwt bean list is empty for the game = &quot;</span>
								+ gameName);
<span class="nc" id="L3851">						continue;</span>
					}

					// These both for loops are created to group the data draw
					// id wise
<span class="nc" id="L3856">					Set&lt;String&gt; drawIdSet = new TreeSet&lt;String&gt;();</span>

<span class="nc bnc" id="L3858" title="All 2 branches missed.">					for (ClmPwtBean clmPwtBean : pwtBeanList) {</span>
<span class="nc" id="L3859">						drawIdSet.add(clmPwtBean.getDrawId() + &quot;=&quot;</span>
								+ clmPwtBean.getTransDate());
<span class="nc" id="L3861">					}</span>

<span class="nc" id="L3863">					logger.debug(drawIdSet + &quot;Test****************drawIdSet&quot;);</span>
<span class="nc" id="L3864">					List&lt;ClmPwtBean&gt; drawIdWiseList = null;</span>
<span class="nc" id="L3865">					int drawId = 0;</span>
<span class="nc" id="L3866">					String transDate = null, drawIdNTransDateArr[] = null;</span>
<span class="nc bnc" id="L3867" title="All 2 branches missed.">					for (String drawIdBean : drawIdSet) {</span>
<span class="nc" id="L3868">						drawIdNTransDateArr = drawIdBean.split(&quot;=&quot;);</span>
<span class="nc" id="L3869">						drawId = Integer.parseInt(drawIdNTransDateArr[0]);</span>
<span class="nc" id="L3870">						transDate = drawIdNTransDateArr[1];</span>
<span class="nc" id="L3871">						drawIdWiseList = new ArrayList&lt;ClmPwtBean&gt;();</span>
<span class="nc bnc" id="L3872" title="All 2 branches missed.">						for (ClmPwtBean clmPwtBean : pwtBeanList) {</span>
<span class="nc bnc" id="L3873" title="All 6 branches missed.">							if (drawId == clmPwtBean.getDrawId()</span>
									&amp;&amp; transDate != null
									&amp;&amp; transDate.equals(clmPwtBean
											.getTransDate())) {
<span class="nc" id="L3877">								drawIdWiseList.add(clmPwtBean);</span>
							}
<span class="nc" id="L3879">						}</span>

						// insert data into main transaction master
<span class="nc" id="L3882">						logger</span>
								.debug(&quot;insert data into transaction master type  is AGENT&quot;);
<span class="nc" id="L3884">						String transMasQuery = QueryManager</span>
								.insertInLMSTransactionMaster();
<span class="nc" id="L3886">						PreparedStatement transMasQueryPstmt = connection</span>
								.prepareStatement(transMasQuery);
<span class="nc" id="L3888">						transMasQueryPstmt.setString(1, &quot;AGENT&quot;);</span>
<span class="nc" id="L3889">						transMasQueryPstmt.executeUpdate();</span>
<span class="nc" id="L3890">						ResultSet rs = transMasQueryPstmt.getGeneratedKeys();</span>

<span class="nc bnc" id="L3892" title="All 2 branches missed.">						if (rs.next()) {</span>
<span class="nc" id="L3893">							long  transId = rs.getLong(1);</span>
							// added By Vaibhav
<span class="nc bnc" id="L3895" title="All 2 branches missed.">							if (transMap.containsKey(transDate)) {</span>
<span class="nc" id="L3896">								transMap.get(transDate).add(transId);</span>
							} else {
<span class="nc" id="L3898">								transList = new ArrayList&lt;Long&gt;();</span>
<span class="nc" id="L3899">								transList.add(transId);</span>
<span class="nc" id="L3900">								transMap.put(transDate, transList);</span>
							}

							// insert into agent transaction master
<span class="nc" id="L3904">							String agtTransMasterQuery = QueryManager</span>
									.insertInAgentTransactionMaster();
<span class="nc" id="L3906">							logger.debug(&quot;agtTransMasterQuery = &quot;</span>
									+ agtTransMasterQuery);
<span class="nc" id="L3908">							PreparedStatement agtTransMasterPstmt = connection</span>
									.prepareStatement(agtTransMasterQuery);
<span class="nc" id="L3910">							agtTransMasterPstmt.setLong(1, transId);</span>
<span class="nc" id="L3911">							agtTransMasterPstmt.setInt(2, agentUserId);</span>
<span class="nc" id="L3912">							agtTransMasterPstmt.setInt(3, agtOrgId);</span>
<span class="nc" id="L3913">							agtTransMasterPstmt.setString(4, &quot;RETAILER&quot;);</span>
<span class="nc" id="L3914">							agtTransMasterPstmt.setInt(5, retOrgId);</span>
<span class="nc" id="L3915">							agtTransMasterPstmt.setString(6, &quot;DG_PWT_AUTO&quot;);</span>
<span class="nc" id="L3916">							agtTransMasterPstmt</span>
									.setTimestamp(
											7,
											GetDate
													.fetchTransDateTimeStampForAdocLedger(transDate));
<span class="nc" id="L3921">							agtTransMasterPstmt.executeUpdate();</span>
<span class="nc" id="L3922">							logger</span>
									.debug(&quot;insert into agent transaction master = &quot;
											+ agtTransMasterPstmt);

							// update st_retailer_pwt in case if retailer brings
							// unclaimed PWTs to agent
<span class="nc" id="L3928">							String retPwtUpdateQuery = &quot;update st_dg_ret_pwt_? aa, st_dg_pwt_inv_? bb set aa.status = ? ,&quot;</span>
									+ &quot; bb.status = ? , bb.agent_transaction_id =&quot;
									+ transId
									+ &quot; where transaction_id = bb.retailer_transaction_id &quot;
									+ &quot; and aa.game_id = ? and  bb.draw_id = ?  and bb.ticket_nbr = ? and aa.retailer_org_id =?&quot;;
<span class="nc" id="L3933">							PreparedStatement retPwtUpdatePstmt = connection</span>
									.prepareStatement(retPwtUpdateQuery);

							// insert in st_ret_direct_player table in case of
							// player
<span class="nc" id="L3938">							String retPwtUpdateDirectPlrQry = &quot;update st_dg_ret_direct_plr_pwt aa, st_dg_pwt_inv_? bb &quot;</span>
									+ &quot; set aa.pwt_claim_status = ? , bb.status = ? , bb.agent_transaction_id =&quot;
									+ transId
									+ &quot; where transaction_id = bb.retailer_transaction_id and aa.game_id = ? and bb.draw_id = ? &quot;
									+ &quot; and bb.ticket_nbr = ? and aa.retailer_org_id =?&quot;;
<span class="nc" id="L3943">							PreparedStatement retDirPlrPstmt = connection</span>
									.prepareStatement(retPwtUpdateDirectPlrQry);

<span class="nc" id="L3946">							double retNetAmt = 0.0, netPwtAmt = 0.0, sumPwtAmt = 0.0, agtCommRate = 0.0;</span>
<span class="nc" id="L3947">							agtTotalClmBal = 0.0;</span>
<span class="nc" id="L3948">							int rowUpdate = 0;</span>
<span class="nc bnc" id="L3949" title="All 2 branches missed.">							for (ClmPwtBean clmPwtBean : drawIdWiseList) {</span>

<span class="nc" id="L3951">								gameNbr = clmPwtBean.getGameNbr();</span>
<span class="nc" id="L3952">								gameId = clmPwtBean.getGameId();</span>
<span class="nc" id="L3953">								sumPwtAmt = sumPwtAmt + clmPwtBean.getPwtAmt();</span>
								// retailer Net amount with commission
								// commission amount
<span class="nc" id="L3956">								netPwtAmt = clmPwtBean.getPwtAmt()</span>
										+ clmPwtBean.getClaimComm();
								// retailer net PWT amount transaction wise
<span class="nc" id="L3959">								retNetAmt = retNetAmt + netPwtAmt;</span>
								// total amount to be claimed at AGENT End
<span class="nc" id="L3961">								retCreditAmt = retCreditAmt + netPwtAmt;</span>
<span class="nc" id="L3962">								logger.debug(&quot;netPwtAmt = &quot; + netPwtAmt</span>
										+ &quot;retNetAmt=&quot; + retNetAmt
										+ &quot; , retCreditAmt = &quot; + retCreditAmt);
<span class="nc" id="L3965">								agtCommRate += clmPwtBean.getAgtClaimComm();</span>
								// Total Actual amount that added in AGENT
								// claimable
								// agtTotalClmBal += clmPwtBean.getPwtAmt() +
								// (clmPwtBean.getPwtAmt()*
								// clmPwtBean.getAgtClaimComm()*.01);

<span class="nc bnc" id="L3972" title="All 2 branches missed.">								if (!&quot;direct_plr&quot;.equals(clmPwtBean</span>
										.getPwtType())) {
									// update retailer PWT status for claimed
									// PWT as done
<span class="nc" id="L3976">									retPwtUpdatePstmt.setInt(1, clmPwtBean</span>
											.getGameNbr());
<span class="nc" id="L3978">									retPwtUpdatePstmt.setInt(2, clmPwtBean</span>
											.getGameNbr());
<span class="nc" id="L3980">									retPwtUpdatePstmt.setString(3, &quot;DONE_CLM&quot;);</span>
<span class="nc" id="L3981">									retPwtUpdatePstmt.setString(4,</span>
											&quot;CLAIM_RET_CLM_AUTO&quot;);
<span class="nc" id="L3983">									retPwtUpdatePstmt.setInt(5, clmPwtBean</span>
											.getGameId());
<span class="nc" id="L3985">									retPwtUpdatePstmt.setInt(6, clmPwtBean</span>
											.getDrawId());
<span class="nc" id="L3987">									retPwtUpdatePstmt.setString(7, clmPwtBean</span>
											.getTktNbr());
<span class="nc" id="L3989">									retPwtUpdatePstmt.setInt(8, retOrgId);</span>
<span class="nc" id="L3990">									logger.debug(rowUpdate</span>
											+ &quot; : update  in Ret Direct PWT \n&quot;
											+ retPwtUpdatePstmt);
<span class="nc" id="L3993">									rowUpdate = retPwtUpdatePstmt</span>
											.executeUpdate();

								} else {
									// update retailer Direct Player PWT status
									// for claimed PWT as done
<span class="nc" id="L3999">									retDirPlrPstmt.setInt(1, clmPwtBean</span>
											.getGameNbr());
<span class="nc" id="L4001">									retDirPlrPstmt.setString(2, &quot;DONE_CLM&quot;);</span>
<span class="nc" id="L4002">									retDirPlrPstmt.setString(3,</span>
											&quot;CLAIM_RET_CLM_AUTO&quot;);
<span class="nc" id="L4004">									retDirPlrPstmt.setInt(4, clmPwtBean</span>
											.getGameId());
<span class="nc" id="L4006">									retDirPlrPstmt.setInt(5, clmPwtBean</span>
											.getDrawId());
<span class="nc" id="L4008">									retDirPlrPstmt.setString(6, clmPwtBean</span>
											.getTktNbr());
<span class="nc" id="L4010">									retDirPlrPstmt.setInt(7, retOrgId);</span>
<span class="nc" id="L4011">									rowUpdate = retDirPlrPstmt.executeUpdate();</span>
<span class="nc" id="L4012">									logger.debug(rowUpdate</span>
											+ &quot; : update in Ret PWT  \n&quot;
											+ retDirPlrPstmt);
								}

<span class="nc" id="L4017">							}</span>

							// insert into st_agent_pwt when comes pwtAmt is in
							// payment and approval limit
<span class="nc" id="L4021">							String agtDGPwtEntry = &quot;insert into st_dg_agt_pwt (agent_user_id, agent_org_id, retailer_org_id, &quot;</span>
									+ &quot; draw_id, game_id, transaction_id, pwt_amt, comm_amt, net_amt, agt_claim_comm, &quot;
									+ &quot; status) values (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)&quot;;
<span class="nc" id="L4024">							pstmt = connection.prepareStatement(agtDGPwtEntry);</span>
<span class="nc" id="L4025">							pstmt.setInt(1, agentUserId);</span>
<span class="nc" id="L4026">							pstmt.setInt(2, agtOrgId);</span>
<span class="nc" id="L4027">							pstmt.setInt(3, retOrgId);</span>
<span class="nc" id="L4028">							pstmt.setInt(4, drawId);</span>
<span class="nc" id="L4029">							pstmt.setInt(5, gameId);</span>
<span class="nc" id="L4030">							pstmt.setLong(6, transId);</span>
<span class="nc" id="L4031">							pstmt.setDouble(7, sumPwtAmt);</span>
<span class="nc" id="L4032">							pstmt.setDouble(8, retNetAmt - sumPwtAmt); // commission</span>
							// amount
							// of
							// retailer
<span class="nc" id="L4036">							pstmt.setDouble(9, retNetAmt);</span>
<span class="nc" id="L4037">							pstmt.setDouble(10, agtCommRate);</span>
<span class="nc" id="L4038">							pstmt.setString(11, &quot;CLAIM_BAL&quot;);</span>
<span class="nc" id="L4039">							logger.debug(&quot;insert into st_agent_pwt = &quot; + pstmt);</span>
<span class="nc" id="L4040">							pstmt.executeUpdate();</span>

<span class="nc" id="L4042">						} else {</span>
<span class="nc" id="L4043">							throw new LMSException(</span>
									&quot;Transaction Not Generated Successfully &quot;);
						}

<span class="nc" id="L4047">					} // for loop of all DrawId's For Outer game Loop finished</span>
					// here
<span class="nc" id="L4049">				} // for loop of all games finished here</span>

<span class="nc" id="L4051">				logger.debug(&quot;org current claim bal = &quot; + orgClmBal</span>
						+ &quot;/n credit amount to be claim_bal is = &quot;
						+ retCreditAmt);
				// update retailer ACA and claimable Balance
				
<span class="nc" id="L4056">				boolean isValid=OrgCreditUpdation.updateOrganizationBalWithValidate(retCreditAmt, &quot;TRANSACTION&quot;, &quot;PWT_AUTO&quot;, retOrgId,</span>
						agtOrgId, &quot;RETAILER&quot;, 0, connection);
<span class="nc bnc" id="L4058" title="All 2 branches missed.">				if(!isValid)</span>
<span class="nc" id="L4059">					throw new LMSException();</span>
					
<span class="nc" id="L4061">				OrgCreditUpdation.updateOrganizationBalWithValidate(retCreditAmt, &quot;CLAIM_BAL&quot;, &quot;CREDIT&quot;, retOrgId,</span>
						agtOrgId, &quot;RETAILER&quot;, 0, connection);
				
				
				/*OrgCreditUpdation.updateCreditLimitForRetailer(retOrgId,
						&quot;PWT_AUTO&quot;, retCreditAmt, connection);
				// commHelper.updateOrgBalance(&quot;CLAIM_BAL&quot;, retCreditAmt,
				// retOrgId, &quot;DEBIT&quot;, connection);
				// changed when draw game sale come picture
				commHelper.updateOrgBalance(&quot;CLAIM_BAL&quot;, retCreditAmt,
						retOrgId, &quot;CREDIT&quot;, connection);*/

				// update AGENT Claimable Balance is not required
				// changed when draw game sale come picture
				// commHelper.updateOrgBalance(&quot;CLAIM_BAL&quot;, agtTotalClmBal,
				// agtOrgId, &quot;CREDIT&quot;, connection);

				// generate receipt on agent end
<span class="nc bnc" id="L4079" title="All 2 branches missed.">				if (transMap.size() &gt; 0) {</span>
<span class="nc" id="L4080">					String strRec = generateReciptForPwt(transMap, connection,</span>
							agtOrgId, retOrgId, &quot;RETAILER&quot;, &quot;DRAWGAME&quot;);
<span class="nc" id="L4082">					logger.debug(&quot;receipt id is = &quot; + receiptId</span>
							+ &quot;  transList.size() = &quot; + transMap.size()
							+ &quot;  and transaction ids = &quot; + transMap);
<span class="nc" id="L4085">					receiptId = strRec.split(&quot;-&quot;)[1];</span>
<span class="nc" id="L4086">				} else {</span>
<span class="nc" id="L4087">					logger.debug(&quot;receipt id is = &quot; + receiptId</span>
							+ &quot;  transList.size() = &quot; + transMap.size()
							+ &quot;  and transaction ids = &quot; + transMap);
					// throw new LMSException(&quot;NO Transaction Done &quot;);
<span class="nc" id="L4091">					return null;</span>
				}

<span class="nc" id="L4094">			} else {</span>
				// throw new LMSException(&quot;Claimable Balance = &quot;+amt+&quot; is Not
				// Greator Then ZERO &quot; +
				// &quot; || Less Then total Pwt Amt = &quot;+totalPwtAmt);
<span class="nc" id="L4098">				return null;</span>
			}
		}

<span class="nc" id="L4102">		return receiptId;</span>
	}

	public boolean updateOrgBalance(String claimType, double amount, int orgId,
			String amtUpdateType, Connection connection) throws SQLException {

		// check whether amount type is debit or credit
<span class="nc bnc" id="L4109" title="All 2 branches missed.">		amount = &quot;DEBIT&quot;.equals(amtUpdateType) ? -1 * amount : amount;</span>
<span class="nc" id="L4110">		logger.debug(&quot;claimType &quot; + claimType + &quot; ::amtUpdateType &quot;</span>
				+ amtUpdateType + &quot; amount = &quot; + amount);
<span class="nc" id="L4112">		String updateRetBalQuery = null;</span>
<span class="nc bnc" id="L4113" title="All 2 branches missed.">		if (&quot;UNCLAIM_BAL&quot;.equalsIgnoreCase(claimType)) {</span>
<span class="nc" id="L4114">			updateRetBalQuery = &quot;update st_lms_organization_master set unclaimable_bal = (unclaimable_bal+?) where organization_id = ?&quot;;</span>
<span class="nc bnc" id="L4115" title="All 2 branches missed.">		} else if (&quot;CLAIM_BAL&quot;.equalsIgnoreCase(claimType)) {</span>
<span class="nc" id="L4116">			updateRetBalQuery = &quot;update st_lms_organization_master set claimable_bal = (claimable_bal+?) &quot;</span>
					+ &quot; , organization_status = if((available_credit-claimable_bal)&gt;0, 'ACTIVE', 'INACTIVE')&quot;
					+ &quot; where organization_id = ?&quot;;
			// updateRetBalQuery = &quot;update st_lms_organization_master set
			// claimable_bal = (claimable_bal+?) where organization_id = ?&quot;;
<span class="nc bnc" id="L4121" title="All 2 branches missed.">		} else if (&quot;ACA_N_CLAIM_BAL&quot;.equalsIgnoreCase(claimType)) {</span>
<span class="nc" id="L4122">			updateRetBalQuery = &quot;update st_lms_organization_master set claimable_bal = (claimable_bal-?),&quot;</span>
					+ &quot; available_credit=(available_credit+?) where organization_id = ?&quot;;
<span class="nc bnc" id="L4124" title="All 2 branches missed.">		} else if (&quot;ACA_N_UNCLAIM_BAL&quot;.equalsIgnoreCase(claimType)) {</span>
<span class="nc" id="L4125">			updateRetBalQuery = &quot;update st_lms_organization_master set unclaimable_bal = (unclaimable_bal-?),&quot;</span>
					+ &quot; available_credit=(available_credit+?) where organization_id = ?&quot;;
		}
<span class="nc" id="L4128">		PreparedStatement updateRetBal = connection</span>
				.prepareStatement(updateRetBalQuery);
<span class="nc" id="L4130">		updateRetBal.setDouble(1, amount);</span>
<span class="nc bnc" id="L4131" title="All 2 branches missed.">		if (&quot;ACA_N_CLAIM_BAL&quot;.equalsIgnoreCase(claimType)) {</span>
<span class="nc" id="L4132">			updateRetBal.setDouble(2, amount);</span>
<span class="nc" id="L4133">			updateRetBal.setInt(3, orgId);</span>
		} else {
<span class="nc" id="L4135">			updateRetBal.setInt(2, orgId);</span>
		}
<span class="nc" id="L4137">		int retBalRow = updateRetBal.executeUpdate();</span>
<span class="nc" id="L4138">		logger.debug(retBalRow + &quot; row updated,  updateRetBalQuery = &quot;</span>
				+ updateRetBal);

<span class="nc bnc" id="L4141" title="All 2 branches missed.">		return retBalRow &gt; 0;</span>
	}

	public boolean updateOrgForUnClaimedVirn(int orgId, String orgType,
			String enVirnCode, String virnStatus, int gameId, String tableType,
			Connection connection) throws SQLException, LMSException {
<span class="nc" id="L4147">		boolean flag = false;</span>
<span class="nc" id="L4148">		String fetchVirnDetailQuery = &quot;&quot;;</span>
<span class="nc" id="L4149">		String updateVirnDetailQuery = &quot;&quot;;</span>
<span class="nc bnc" id="L4150" title="All 2 branches missed.">		if (&quot;RETAILER&quot;.equalsIgnoreCase(orgType)) {</span>

			// update according to the retailer

<span class="nc bnc" id="L4154" title="All 2 branches missed.">		} else if (&quot;AGENT&quot;.equalsIgnoreCase(orgType)) {</span>
<span class="nc bnc" id="L4155" title="All 2 branches missed.">			if (&quot;AGENT&quot;.equalsIgnoreCase(tableType)) {</span>
<span class="nc" id="L4156">				updateVirnDetailQuery = &quot;update st_se_agent_pwt set status=? where game_id = ? and virn_code = ? and agent_org_id = ?&quot;;</span>
<span class="nc bnc" id="L4157" title="All 2 branches missed.">			} else if (&quot;PLAYER&quot;.equalsIgnoreCase(tableType)) {</span>
<span class="nc" id="L4158">				updateVirnDetailQuery = &quot;update st_se_agt_direct_player_pwt set pwt_claim_status=? where game_id = ? and virn_code = ? and agent_org_id = ?&quot;;</span>
			} else {
<span class="nc" id="L4160">				throw new LMSException(</span>
						&quot;ERROR OCCURED while updating status in AGENT or PLR table for UNCLAIMMABLE balance  for this tableType is &quot;
								+ tableType);
				// fetchVirnDetailQuery = &quot;select * from st_se_agent_pwt where
				// game_id = ? and virn_code = ? and agent_org_id = ? and status
				// =
				// ?&quot;;
				// fetchVirnDetailQuery = &quot;select * from st_se_agent_pwt where
				// game_id = ? and virn_code = ? and agent_org_id = ? and status
				// =
				// ?&quot;;
			}
		}
<span class="nc" id="L4173">		pstmt = connection.prepareStatement(updateVirnDetailQuery);</span>
<span class="nc" id="L4174">		pstmt.setString(1, virnStatus);</span>
<span class="nc" id="L4175">		pstmt.setInt(2, gameId);</span>
<span class="nc" id="L4176">		pstmt.setString(3, enVirnCode);</span>
<span class="nc" id="L4177">		pstmt.setInt(4, orgId);</span>
<span class="nc" id="L4178">		int isupdate = pstmt.executeUpdate();</span>
<span class="nc" id="L4179">		logger.debug(&quot; update  virn for &quot; + orgType + &quot; pwt table pstmt = &quot;</span>
				+ pstmt);
<span class="nc bnc" id="L4181" title="All 2 branches missed.">		if (isupdate == 1) {</span>
<span class="nc" id="L4182">			flag = true;</span>
		} else {
<span class="nc" id="L4184">			throw new LMSException(</span>
					&quot;ERROR OCCURED PWT NOT Found for this status &quot; + virnStatus);
		}
<span class="nc" id="L4187">		return flag;</span>
	}

	public int updateTicketInvTable(String tktNo, String bookNo, int gameNbr,
			int gameId, String status, int userId, int userOrgId,
			String updateType, int partyOrgId, String channel,
			String interfaceType, Connection connection) throws SQLException,
			LMSException {

<span class="nc" id="L4196">		int tktRow = 0;</span>
		// updated by yogesh now not to execute select query

<span class="nc bnc" id="L4199" title="All 2 branches missed.">		if (&quot;update&quot;.equalsIgnoreCase(updateType)) { // ticket already exist</span>
			// in st_pwt_tickets_inv
			// table
<span class="nc" id="L4202">			String updateTktInvQuery = &quot;update st_se_pwt_tickets_inv_? set status = ?, verify_by_user=?, verify_by_org=?, channel = ?, interface = ?, party_org_id = ?, date = ?  where game_id = ? and ticket_nbr = ?&quot;;</span>
<span class="nc" id="L4203">			PreparedStatement upTktInvPstmt = connection</span>
					.prepareStatement(updateTktInvQuery);
<span class="nc" id="L4205">			upTktInvPstmt.setInt(1, gameNbr);</span>
<span class="nc" id="L4206">			upTktInvPstmt.setString(2, status);</span>
<span class="nc" id="L4207">			upTktInvPstmt.setInt(3, userId);</span>
<span class="nc" id="L4208">			upTktInvPstmt.setInt(4, userOrgId);</span>
<span class="nc" id="L4209">			upTktInvPstmt.setString(5, channel);</span>
<span class="nc" id="L4210">			upTktInvPstmt.setString(6, interfaceType);</span>
<span class="nc" id="L4211">			upTktInvPstmt.setInt(7, partyOrgId);</span>
<span class="nc" id="L4212">			upTktInvPstmt.setTimestamp(8, new Timestamp(new java.util.Date()</span>
					.getTime()));
<span class="nc" id="L4214">			upTktInvPstmt.setInt(9, gameId);</span>
<span class="nc" id="L4215">			upTktInvPstmt.setString(10, tktNo);</span>
<span class="nc" id="L4216">			tktRow = upTktInvPstmt.executeUpdate();</span>
<span class="nc" id="L4217">			logger.debug(&quot;total row = &quot; + tktRow</span>
					+ &quot;   ,update ticket inventory status table = &quot;
					+ upTktInvPstmt);
<span class="nc bnc" id="L4220" title="All 2 branches missed.">			if (tktRow &lt; 1) {</span>
<span class="nc" id="L4221">				throw new LMSException(&quot;ticket Number &quot; + tktNo</span>
						+ &quot; status not updated in st_pwt_tickets_inv table.&quot;);
			}
<span class="nc bnc" id="L4224" title="All 2 branches missed.">			if (tktRow &gt; 1) {</span>
<span class="nc" id="L4225">				LMSExceptionInterceptor.sendMail(&quot;Ticket Number &quot; + tktNo</span>
						+ &quot;is duplicate in DATABASE&quot;);
<span class="nc" id="L4227">				throw new LMSException(&quot;Ticket Number &quot; + tktNo</span>
						+ &quot;is duplicate in DATABASE&quot;);
			}
<span class="nc bnc" id="L4230" title="All 2 branches missed.">		} else if (&quot;insert&quot;.equalsIgnoreCase(updateType)) { // if ticket not</span>
			// exist in
			// st_pwt_tickets_inv
			// table
<span class="nc" id="L4234">			String updateTktInvQuery = &quot;insert into  st_se_pwt_tickets_inv_? ( ticket_nbr , game_id , book_nbr , status , verify_by_user , verify_by_org, channel, interface, party_org_id, date ) values (?,?,?,?,?,?,?,?,?,?)&quot;;</span>
<span class="nc" id="L4235">			PreparedStatement inTktInvPstmt = connection</span>
					.prepareStatement(updateTktInvQuery);
<span class="nc" id="L4237">			inTktInvPstmt.setInt(1, gameNbr);</span>
<span class="nc" id="L4238">			inTktInvPstmt.setString(2, tktNo);</span>
<span class="nc" id="L4239">			inTktInvPstmt.setInt(3, gameId);</span>
<span class="nc" id="L4240">			inTktInvPstmt.setString(4, bookNo);</span>
<span class="nc" id="L4241">			inTktInvPstmt.setString(5, status);</span>
<span class="nc" id="L4242">			inTktInvPstmt.setInt(6, userId);</span>
<span class="nc" id="L4243">			inTktInvPstmt.setInt(7, userOrgId);</span>
<span class="nc" id="L4244">			inTktInvPstmt.setString(8, channel);</span>
<span class="nc" id="L4245">			inTktInvPstmt.setString(9, interfaceType);</span>
<span class="nc" id="L4246">			inTktInvPstmt.setInt(10, partyOrgId);</span>
<span class="nc" id="L4247">			inTktInvPstmt.setTimestamp(11, new Timestamp(new java.util.Date()</span>
					.getTime()));
<span class="nc" id="L4249">			tktRow = inTktInvPstmt.executeUpdate();</span>
<span class="nc" id="L4250">			logger.debug(&quot;total row = &quot; + tktRow</span>
					+ &quot;   ,insert ticket inventory details into table = &quot;
					+ inTktInvPstmt);
<span class="nc bnc" id="L4253" title="All 2 branches missed.">			if (tktRow &lt; 1) {</span>
<span class="nc" id="L4254">				throw new LMSException(&quot;ticket Number &quot; + tktNo</span>
						+ &quot; is not inserted in st_pwt_tickets_inv table.&quot;);
			}
<span class="nc bnc" id="L4257" title="All 2 branches missed.">		} else if (&quot;delete&quot;.equalsIgnoreCase(updateType)) { // in case of ticket</span>
			// temporary
			// cancellation
<span class="nc" id="L4260">			String updateTktInvQuery = &quot;delete from st_se_pwt_tickets_inv_? where game_id=? and ticket_nbr=? &quot;;</span>
<span class="nc" id="L4261">			PreparedStatement inTktInvPstmt = connection</span>
					.prepareStatement(updateTktInvQuery);
<span class="nc" id="L4263">			inTktInvPstmt.setInt(1, gameNbr);</span>
<span class="nc" id="L4264">			inTktInvPstmt.setInt(2, gameId);</span>
<span class="nc" id="L4265">			inTktInvPstmt.setString(3, tktNo);</span>
<span class="nc" id="L4266">			tktRow = inTktInvPstmt.executeUpdate();</span>
<span class="nc" id="L4267">			logger.debug(&quot;total row = &quot; + tktRow</span>
					+ &quot;   ,delete form ticket inventory  table = &quot;
					+ inTktInvPstmt);
<span class="nc bnc" id="L4270" title="All 2 branches missed.">			if (tktRow &lt; 1) {</span>
<span class="nc" id="L4271">				throw new LMSException(&quot;ticket Number &quot; + tktNo</span>
						+ &quot; is not deleted from st_pwt_tickets_inv table.&quot;);
			}
<span class="nc" id="L4274">		} else {</span>
<span class="nc" id="L4275">			throw new LMSException(</span>
					&quot;Exception occured while updating ticket inventory table updation type is :: &quot;
							+ updateType);
		}

<span class="nc" id="L4280">		return tktRow;</span>

	}

	public Boolean updateVirnStatus(int gameNbr, String pwtStatus, int gameId,
			String encVirnCode, Connection con, String encTktNbr)
			throws SQLException, LMSException {
<span class="nc" id="L4287">		String updateVirnInvQuery = &quot;update st_se_pwt_inv_? set status = ? where game_id = ? and virn_code = ? and id1=?&quot;;</span>
<span class="nc" id="L4288">		PreparedStatement invPstmt = con.prepareStatement(updateVirnInvQuery);</span>
<span class="nc" id="L4289">		invPstmt.setInt(1, gameNbr);</span>
<span class="nc" id="L4290">		invPstmt.setString(2, pwtStatus);</span>
<span class="nc" id="L4291">		invPstmt.setInt(3, gameId);</span>
<span class="nc" id="L4292">		invPstmt.setString(4, encVirnCode);</span>
<span class="nc" id="L4293">		invPstmt.setString(5, encTktNbr);</span>
<span class="nc" id="L4294">		int virnRow = invPstmt.executeUpdate();</span>
<span class="nc" id="L4295">		logger.debug(&quot;total row = &quot; + virnRow</span>
				+ &quot;   ,update ticket inventory status table = &quot; + invPstmt);
<span class="nc bnc" id="L4297" title="All 2 branches missed.">		if (virnRow &lt; 1) {</span>
<span class="nc" id="L4298">			throw new LMSException(</span>
					&quot;update ticket inventory status table not updated.&quot;);
		}
<span class="nc bnc" id="L4301" title="All 2 branches missed.">		return virnRow &gt; 0;</span>
	}

	public String verifyOrgForUnClaimedVirn(int orgId, String orgType,
			String enVirnCode, String virnStatus, int gameId,
			Connection connection) throws SQLException {
<span class="nc" id="L4307">		String flag = &quot;NONE&quot;;</span>
<span class="nc" id="L4308">		String fetchVirnDetailQuery = &quot;&quot;;</span>
<span class="nc bnc" id="L4309" title="All 2 branches missed.">		if (&quot;RETAILER&quot;.equalsIgnoreCase(orgType)) {</span>
<span class="nc" id="L4310">			fetchVirnDetailQuery = &quot;select virn_code,'RETAILER' as tableType from st_se_retailer_pwt where game_id = ? and virn_code = ? and retailer_org_id = ? and status = ? UNION select virn_code, 'PLAYER' as tableType from st_se_retailer_direct_player_pwt where game_id = ? and virn_code = ? and retailer_org_id = ? and pwt_claim_status = ?&quot;;</span>
			// fetchVirnDetailQuery = &quot;select * from st_se_retailer_pwt where
			// game_id = ? and virn_code = ? and retailer_org_id = ? and status
			// = ?&quot;;
<span class="nc bnc" id="L4314" title="All 2 branches missed.">		} else if (&quot;AGENT&quot;.equalsIgnoreCase(orgType)) {</span>

<span class="nc" id="L4316">			fetchVirnDetailQuery = &quot;select virn_code,'AGENT' as tableType from st_se_agent_pwt where game_id = ? and virn_code = ? and agent_org_id = ? and status = ? UNION select virn_code, 'PLAYER' as tableType from st_se_agt_direct_player_pwt where game_id = ? and virn_code = ? and agent_org_id = ? and pwt_claim_status=?&quot;;</span>
			// fetchVirnDetailQuery = &quot;select * from st_se_agent_pwt where
			// game_id = ? and virn_code = ? and agent_org_id = ? and status =
			// ?&quot;;
		}
<span class="nc" id="L4321">		pstmt = connection.prepareStatement(fetchVirnDetailQuery);</span>
<span class="nc" id="L4322">		pstmt.setInt(1, gameId);</span>
<span class="nc" id="L4323">		pstmt.setString(2, enVirnCode);</span>
<span class="nc" id="L4324">		pstmt.setInt(3, orgId);</span>
<span class="nc" id="L4325">		pstmt.setString(4, virnStatus);</span>
<span class="nc" id="L4326">		pstmt.setInt(5, gameId);</span>
<span class="nc" id="L4327">		pstmt.setString(6, enVirnCode);</span>
<span class="nc" id="L4328">		pstmt.setInt(7, orgId);</span>
<span class="nc" id="L4329">		pstmt.setString(8, virnStatus);</span>
<span class="nc" id="L4330">		result = pstmt.executeQuery();</span>
<span class="nc" id="L4331">		logger.debug(&quot; get detail of virn from &quot; + orgType</span>
				+ &quot; pwt table pstmt = &quot; + pstmt);
<span class="nc bnc" id="L4333" title="All 2 branches missed.">		if (result.next()) {</span>
<span class="nc bnc" id="L4334" title="All 2 branches missed.">			if (&quot;PLAYER&quot;.equalsIgnoreCase(result.getString(&quot;tableType&quot;))) {</span>
<span class="nc" id="L4335">				flag = &quot;IN_PLR_UNCLM&quot;;</span>
			} else {
<span class="nc" id="L4337">				flag = &quot;IN_&quot; + orgType + &quot;_UNCLM&quot;;</span>
			}
		} else {
			// we require to shoot a mail
<span class="nc" id="L4341">			logger.debug(&quot;status not matched in &quot; + orgType</span>
					+ &quot; pwt table and st_pwt_inv table for virn = &quot;
					+ enVirnCode);
			// CommonMethods.sendMail(&quot;status not matched in &quot;+orgType+&quot; pwt
			// table and st_pwt_inv table for virn = &quot;+enVirnCode);
		}
<span class="nc" id="L4347">		return flag;</span>
	}

	public Map&lt;Long, GameMasterLMSBean&gt; fetchOrgCommRates(int orgId,
			String orgType, int parentOrgId, List&lt;String&gt; qryList)
			throws SQLException {
<span class="nc" id="L4353">		Map&lt;Long, GameMasterLMSBean&gt; tansIdMap = new HashMap&lt;Long, GameMasterLMSBean&gt;();</span>
<span class="nc" id="L4354">		GameMasterLMSBean commBean = null;</span>

<span class="nc" id="L4356">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L4357">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L4358">		ResultSet rs = null;</span>

<span class="nc bnc" id="L4360" title="All 2 branches missed.">		if (&quot;RETAILER&quot;.equalsIgnoreCase(orgType)) {</span>
<span class="nc" id="L4361">			pstmt = con.prepareStatement(qryList.get(0).replaceAll(&quot;\\?&quot;,</span>
					orgId + &quot;&quot;)); // Sale Qry
<span class="nc" id="L4363">			rs = pstmt.executeQuery();</span>
			long transId;
<span class="nc bnc" id="L4365" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L4366">				transId = rs.getLong(&quot;transaction_id&quot;);</span>

<span class="nc" id="L4368">				commBean = new GameMasterLMSBean();</span>
<span class="nc" id="L4369">				tansIdMap.put(transId, commBean);</span>
<span class="nc" id="L4370">				commBean.setRetSaleCommRate(0.0);</span>
<span class="nc" id="L4371">				commBean.setAgentSaleCommRate(0.0);</span>
<span class="nc" id="L4372">				commBean.setGovtComm(0.0);</span>

<span class="nc" id="L4374">				PreparedStatement comPst = con.prepareStatement(qryList.get(2)); // Comm</span>
				// Qry
<span class="nc" id="L4376">				comPst.setInt(1, rs.getInt(&quot;game_id&quot;));</span>
<span class="nc" id="L4377">				comPst.setInt(2, orgId);</span>
<span class="nc" id="L4378">				comPst.setInt(3, parentOrgId);</span>
<span class="nc" id="L4379">				comPst.setInt(4, orgId);</span>
<span class="nc" id="L4380">				comPst.setInt(5, parentOrgId);</span>
<span class="nc" id="L4381">				comPst.setInt(6, rs.getInt(&quot;game_id&quot;));</span>
<span class="nc" id="L4382">				ResultSet comRs = comPst.executeQuery();</span>
<span class="nc bnc" id="L4383" title="All 2 branches missed.">				while (comRs.next()) {</span>
<span class="nc" id="L4384">					double retComm = comRs.getDouble(&quot;retSaleComm&quot;);</span>
<span class="nc" id="L4385">					double agtComm = comRs.getDouble(&quot;agtSaleComm&quot;);</span>
<span class="nc" id="L4386">					double govtComm = comRs.getDouble(&quot;govtComm&quot;);</span>
<span class="nc bnc" id="L4387" title="All 2 branches missed.">					if (comRs.getTimestamp(&quot;date&quot;).getTime() &gt; rs.getTimestamp(</span>
							&quot;transaction_date&quot;).getTime()) {
<span class="nc bnc" id="L4389" title="All 2 branches missed.">						if (retComm != 0.0) {</span>
<span class="nc" id="L4390">							commBean.setRetSaleCommRate(retComm);</span>
						}
<span class="nc bnc" id="L4392" title="All 2 branches missed.">						if (agtComm != 0.0) {</span>
<span class="nc" id="L4393">							commBean.setAgentSaleCommRate(agtComm);</span>
						}
<span class="nc bnc" id="L4395" title="All 2 branches missed.">						if (govtComm != 0.0) {</span>
<span class="nc" id="L4396">							commBean.setGovtComm(govtComm);</span>
						}
					}
<span class="nc" id="L4399">				}</span>
<span class="nc" id="L4400">			}</span>

<span class="nc" id="L4402">			pstmt = con.prepareStatement(qryList.get(1).replaceAll(&quot;\\?&quot;,</span>
					orgId + &quot;&quot;)); // Refund Qry
<span class="nc" id="L4404">			rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L4406" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L4407">				transId = rs.getLong(&quot;transaction_id&quot;);</span>

<span class="nc" id="L4409">				commBean = new GameMasterLMSBean();</span>
<span class="nc" id="L4410">				tansIdMap.put(transId, commBean);</span>
<span class="nc" id="L4411">				commBean.setRetSaleCommRate(0.0);</span>
<span class="nc" id="L4412">				commBean.setAgentSaleCommRate(0.0);</span>
<span class="nc" id="L4413">				commBean.setGovtComm(0.0);</span>

<span class="nc" id="L4415">				PreparedStatement comPst = con.prepareStatement(qryList.get(2)); // Comm</span>
				// Qry
<span class="nc" id="L4417">				comPst.setInt(1, rs.getInt(&quot;game_id&quot;));</span>
<span class="nc" id="L4418">				comPst.setInt(2, orgId);</span>
<span class="nc" id="L4419">				comPst.setInt(3, parentOrgId);</span>
<span class="nc" id="L4420">				comPst.setInt(4, orgId);</span>
<span class="nc" id="L4421">				comPst.setInt(5, parentOrgId);</span>
<span class="nc" id="L4422">				comPst.setInt(6, rs.getInt(&quot;game_id&quot;));</span>
<span class="nc" id="L4423">				ResultSet comRs = comPst.executeQuery();</span>
<span class="nc bnc" id="L4424" title="All 2 branches missed.">				while (comRs.next()) {</span>
<span class="nc" id="L4425">					double retComm = comRs.getDouble(&quot;retSaleComm&quot;);</span>
<span class="nc" id="L4426">					double agtComm = comRs.getDouble(&quot;agtSaleComm&quot;);</span>
<span class="nc" id="L4427">					double govtComm = comRs.getDouble(&quot;govtComm&quot;);</span>
<span class="nc bnc" id="L4428" title="All 2 branches missed.">					if (comRs.getTimestamp(&quot;date&quot;).getTime() &gt; rs.getTimestamp(</span>
							&quot;transaction_date&quot;).getTime()) {
<span class="nc bnc" id="L4430" title="All 2 branches missed.">						if (retComm != 0.0) {</span>
<span class="nc" id="L4431">							commBean.setRetSaleCommRate(retComm);</span>
						}
<span class="nc bnc" id="L4433" title="All 2 branches missed.">						if (agtComm != 0.0) {</span>
<span class="nc" id="L4434">							commBean.setAgentSaleCommRate(agtComm);</span>
						}
<span class="nc bnc" id="L4436" title="All 2 branches missed.">						if (govtComm != 0.0) {</span>
<span class="nc" id="L4437">							commBean.setGovtComm(govtComm);</span>
						}
					}

<span class="nc" id="L4441">				}</span>
<span class="nc" id="L4442">			}</span>
<span class="nc bnc" id="L4443" title="All 2 branches missed.">		} else if (&quot;AGENT&quot;.equalsIgnoreCase(orgType)) {</span>

<span class="nc" id="L4445">			String saleQryAgent = &quot;select a.transaction_id , game_id,b.transaction_date,agent_org_id from st_dg_agt_sale a, st_lms_agent_transaction_master b  where agent_org_id=? and claim_status='CLAIM_BAL' and a.transaction_id = b.transaction_id&quot;;</span>

<span class="nc" id="L4447">			String saleRefundQryAgent = &quot;select a.transaction_id , game_id,b.transaction_date,agent_org_id from st_dg_agt_sale_refund a, st_lms_agent_transaction_master b  where agent_org_id=? and claim_status='CLAIM_BAL' and a.transaction_id = b.transaction_id&quot;;</span>

<span class="nc" id="L4449">			String commQry = &quot;select game_id,agtSaleComm,govtComm,date from (select game_id,sum(agent_sale_comm_rate) agtSaleComm,sum(govt_comm) govtComm,now() 'date' from (select game_id,agent_sale_comm_rate,govt_comm from st_dg_game_master where game_id=? union all select game_id,sale_comm_variance,0 from st_dg_bo_agent_sale_pwt_comm_variance where agent_org_id=?) comm group by game_id union all select gm.game_id,agent_sale_comm_rate+sale_comm_variance agtComm,0,date_changed from st_dg_bo_agent_sale_comm_variance_history his inner join st_dg_game_master gm on his.game_id=gm.game_id where agent_org_id=? union all select game_id,0,govt_comm_rate,date_changed from st_dg_game_govt_comm_history where game_id=?) comm order by date desc&quot;;</span>

<span class="nc" id="L4451">			pstmt = con.prepareStatement(saleQryAgent);</span>
<span class="nc" id="L4452">			pstmt.setInt(1, orgId);</span>
<span class="nc" id="L4453">			rs = pstmt.executeQuery();</span>
			long transId;
<span class="nc bnc" id="L4455" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L4456">				transId = rs.getLong(&quot;transaction_id&quot;);</span>

<span class="nc" id="L4458">				commBean = new GameMasterLMSBean();</span>
<span class="nc" id="L4459">				tansIdMap.put(transId, commBean);</span>
<span class="nc" id="L4460">				commBean.setAgentSaleCommRate(0.0);</span>
<span class="nc" id="L4461">				commBean.setGovtComm(0.0);</span>

<span class="nc" id="L4463">				PreparedStatement comPst = con.prepareStatement(commQry);</span>
<span class="nc" id="L4464">				comPst.setInt(1, rs.getInt(&quot;game_id&quot;));</span>
<span class="nc" id="L4465">				comPst.setInt(2, orgId);</span>
<span class="nc" id="L4466">				comPst.setInt(3, orgId);</span>
<span class="nc" id="L4467">				comPst.setInt(4, rs.getInt(&quot;game_id&quot;));</span>
<span class="nc" id="L4468">				ResultSet comRs = comPst.executeQuery();</span>
<span class="nc bnc" id="L4469" title="All 2 branches missed.">				while (comRs.next()) {</span>
<span class="nc" id="L4470">					double agtComm = comRs.getDouble(&quot;agtSaleComm&quot;);</span>
<span class="nc" id="L4471">					double govtComm = comRs.getDouble(&quot;govtComm&quot;);</span>
<span class="nc bnc" id="L4472" title="All 2 branches missed.">					if (comRs.getTimestamp(&quot;date&quot;).getTime() &gt; rs.getTimestamp(</span>
							&quot;transaction_date&quot;).getTime()) {
<span class="nc bnc" id="L4474" title="All 2 branches missed.">						if (agtComm != 0.0) {</span>
<span class="nc" id="L4475">							commBean.setAgentSaleCommRate(agtComm);</span>
						}
<span class="nc bnc" id="L4477" title="All 2 branches missed.">						if (govtComm != 0.0) {</span>
<span class="nc" id="L4478">							commBean.setGovtComm(govtComm);</span>
						}
					}

<span class="nc" id="L4482">				}</span>
<span class="nc" id="L4483">			}</span>

<span class="nc" id="L4485">			pstmt = con.prepareStatement(saleRefundQryAgent);</span>
<span class="nc" id="L4486">			pstmt.setInt(1, orgId);</span>
<span class="nc" id="L4487">			rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L4489" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L4490">				transId = rs.getLong(&quot;transaction_id&quot;);</span>

<span class="nc" id="L4492">				commBean = new GameMasterLMSBean();</span>
<span class="nc" id="L4493">				tansIdMap.put(transId, commBean);</span>
<span class="nc" id="L4494">				commBean.setAgentSaleCommRate(0.0);</span>
<span class="nc" id="L4495">				commBean.setGovtComm(0.0);</span>

<span class="nc" id="L4497">				PreparedStatement comPst = con.prepareStatement(commQry);</span>
<span class="nc" id="L4498">				comPst.setInt(1, rs.getInt(&quot;game_id&quot;));</span>
<span class="nc" id="L4499">				comPst.setInt(2, orgId);</span>
<span class="nc" id="L4500">				comPst.setInt(3, orgId);</span>
<span class="nc" id="L4501">				comPst.setInt(4, rs.getInt(&quot;game_id&quot;));</span>
<span class="nc" id="L4502">				ResultSet comRs = comPst.executeQuery();</span>
<span class="nc bnc" id="L4503" title="All 2 branches missed.">				while (comRs.next()) {</span>
<span class="nc" id="L4504">					double agtComm = comRs.getDouble(&quot;agtSaleComm&quot;);</span>
<span class="nc" id="L4505">					double govtComm = comRs.getDouble(&quot;govtComm&quot;);</span>
<span class="nc bnc" id="L4506" title="All 2 branches missed.">					if (comRs.getTimestamp(&quot;date&quot;).getTime() &gt; rs.getTimestamp(</span>
							&quot;transaction_date&quot;).getTime()) {
<span class="nc bnc" id="L4508" title="All 2 branches missed.">						if (agtComm != 0.0) {</span>
<span class="nc" id="L4509">							commBean.setAgentSaleCommRate(agtComm);</span>
						}
<span class="nc bnc" id="L4511" title="All 2 branches missed.">						if (govtComm != 0.0) {</span>
<span class="nc" id="L4512">							commBean.setGovtComm(govtComm);</span>
						}
					}

<span class="nc" id="L4516">				}</span>
<span class="nc" id="L4517">			}</span>
		}

<span class="nc" id="L4520">		return tansIdMap;</span>
	}

	public List&lt;String&gt; createQryForUpdLedger() {
<span class="nc" id="L4524">		List&lt;String&gt; qryList = new ArrayList&lt;String&gt;();</span>

<span class="nc" id="L4526">		Set&lt;Integer&gt; gameSet = Util.getGameMap().keySet();</span>
<span class="nc" id="L4527">		StringBuilder saleQry = new StringBuilder(&quot;&quot;);</span>
<span class="nc" id="L4528">		StringBuilder saleRefundQry = new StringBuilder(&quot;&quot;);</span>
		
<span class="nc bnc" id="L4530" title="All 2 branches missed.">		for (Integer gameId : gameSet) {</span>
			
<span class="nc" id="L4532">			saleQry</span>
					.append(&quot;select a.transaction_id,a.game_id ,transaction_date,a.retailer_org_id from st_dg_ret_sale_&quot;
							+ gameId
							+ &quot; a, st_lms_retailer_transaction_master b  where claim_status='CLAIM_BAL' and a.transaction_id = b.transaction_id and a.retailer_org_id=? union all &quot;);

<span class="nc" id="L4537">			saleRefundQry</span>
					.append(&quot;select a.transaction_id,a.game_id ,transaction_date,a.retailer_org_id from st_dg_ret_sale_refund_&quot;
							+ gameId
							+ &quot; a, st_lms_retailer_transaction_master b  where claim_status='CLAIM_BAL' and a.transaction_id = b.transaction_id and a.retailer_org_id=? union all &quot;);
<span class="nc" id="L4541">		}</span>
<span class="nc" id="L4542">		saleQry.delete(saleQry.length() - 10, saleQry.length());</span>
<span class="nc" id="L4543">		saleRefundQry.delete(saleRefundQry.length() - 10, saleRefundQry</span>
				.length());

<span class="nc" id="L4546">		String commQry = &quot;select game_id,retSaleComm,agtSaleComm,govtComm,date from (select game_id,sum(retailer_sale_comm_rate) retSaleComm,sum(agent_sale_comm_rate) agtSaleComm,sum(govt_comm) govtComm,now() 'date' from (select game_id,retailer_sale_comm_rate,agent_sale_comm_rate,govt_comm from st_dg_game_master where game_id=? union all select game_id,sale_comm_variance,0,0 from st_dg_agent_retailer_sale_pwt_comm_variance where retailer_org_id=? union all select game_id,0,sale_comm_variance,0 from st_dg_bo_agent_sale_pwt_comm_variance where agent_org_id=?) comm group by game_id union all select gm.game_id,retailer_sale_comm_rate+sale_comm_variance retComm,0 agtComm,0 govtComm,date_changed from st_dg_agent_retailer_sale_comm_variance_history his inner join st_dg_game_master gm on his.game_id=gm.game_id where retialer_org_id=? union all select gm.game_id,0,agent_sale_comm_rate+sale_comm_variance agtComm,0,date_changed from st_dg_bo_agent_sale_comm_variance_history his inner join st_dg_game_master gm on his.game_id=gm.game_id where agent_org_id=? union all select game_id,0,0,govt_comm_rate,date_changed from st_dg_game_govt_comm_history where game_id=?) comm order by date desc&quot;;</span>
<span class="nc" id="L4547">		qryList.add(saleQry.toString());</span>
<span class="nc" id="L4548">		qryList.add(saleRefundQry.toString());</span>
<span class="nc" id="L4549">		qryList.add(commQry);</span>
<span class="nc" id="L4550">		return qryList;</span>

	}
/**
 * 
 * change due to org Code implementation 
 * @param userOrgId
 * @return
 */
	public static List&lt;String&gt; chkStatusAndFetchUsers(int userOrgId) {
<span class="nc" id="L4560">		String orgStatus = null;</span>
		
<span class="nc" id="L4562">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L4563">		List&lt;String&gt; userNameList = new ArrayList&lt;String&gt;();</span>

		try {
<span class="nc" id="L4566">			PreparedStatement pstmt = con</span>
					.prepareStatement(&quot;SELECT organization_status FROM st_lms_organization_master WHERE organization_id = ?&quot;);
<span class="nc" id="L4568">			pstmt.setInt(1, userOrgId);</span>
<span class="nc" id="L4569">			logger.debug(&quot;org status query : &quot; + pstmt + &quot;*********&quot;);</span>
<span class="nc" id="L4570">			ResultSet rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L4572" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L4573">				orgStatus = rs.getString(&quot;organization_status&quot;);</span>
				
			}
<span class="nc bnc" id="L4576" title="All 2 branches missed.">			if (&quot;INACTIVE&quot;.equalsIgnoreCase(orgStatus)) {</span>
<span class="nc" id="L4577">				pstmt = con</span>
						.prepareStatement(&quot;SELECT user_name FROM st_lms_user_master WHERE organization_id = ?&quot;);
<span class="nc" id="L4579">				pstmt.setInt(1, userOrgId);</span>
<span class="nc" id="L4580">				logger.debug(&quot;user lists query : &quot; + pstmt + &quot;*********&quot;);</span>
<span class="nc" id="L4581">				rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L4583" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L4584">					userNameList.add(rs.getString(&quot;user_name&quot;));</span>
				}
			}
<span class="nc" id="L4587">		} catch (Exception e) {</span>
<span class="nc" id="L4588">			e.printStackTrace();</span>
<span class="nc" id="L4589">			logger.debug(e);</span>
		} finally {
<span class="nc" id="L4591">			DBConnect.closeCon(con);</span>
<span class="nc" id="L4592">		}</span>
<span class="nc" id="L4593">		return userNameList;</span>
	}

	public static boolean isSessionValid(HttpSession session) {
<span class="nc" id="L4597">		boolean isCheck = true;</span>
<span class="nc bnc" id="L4598" title="All 2 branches missed.">		if (session == null) {</span>
<span class="nc" id="L4599">			isCheck = false;</span>
		} else {
			try {
<span class="nc" id="L4602">				session.getAttribute(&quot;&quot;);</span>
<span class="nc" id="L4603">			} catch (IllegalStateException ex) {</span>
<span class="nc" id="L4604">				System.out.println(ex.getMessage());</span>
<span class="nc bnc" id="L4605" title="All 2 branches missed.">				if (ex.getMessage().contains(&quot;Session already invalidated&quot;)) {</span>
<span class="nc" id="L4606">					isCheck = false;</span>
				}
<span class="nc" id="L4608">			}</span>
		}
<span class="nc" id="L4610">		return isCheck;</span>
	}
	public static ArrayList&lt;String&gt; getTerminalTypeList(boolean type) {
<span class="nc" id="L4613">		ArrayList&lt;String&gt; terminalList = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L4614">		Connection con = DBConnect.getConnection();</span>
		try {
<span class="nc" id="L4616">			Statement stmt = con.createStatement();</span>
<span class="nc" id="L4617">			ResultSet rs = stmt.executeQuery(&quot;select sim_name from st_lms_con_device_master order by id&quot;);</span>
			if(false){
			while (rs.next()) {
				terminalList.add(rs.getString(&quot;sim_name&quot;));
			}
			} else{
<span class="nc bnc" id="L4623" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L4624">					terminalList.add(rs.getString(&quot;sim_name&quot;).toUpperCase());</span>
				}
			}
<span class="nc" id="L4627">		} catch (SQLException e) {</span>
<span class="nc" id="L4628">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L4630">			try {</span>
<span class="nc bnc" id="L4631" title="All 6 branches missed.">				if (con != null) {</span>
<span class="nc" id="L4632">					con.close();</span>
				}
<span class="nc" id="L4634">			} catch (SQLException se) {</span>
<span class="nc" id="L4635">				se.printStackTrace();</span>
<span class="nc" id="L4636">			}</span>
<span class="nc" id="L4637">		}</span>
<span class="nc" id="L4638">		return terminalList;</span>
	}
	
	public static ArrayList&lt;String&gt; getTerminalBulidVersionList(String deviceName) {
<span class="nc" id="L4642">		ArrayList&lt;String&gt; versionList = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L4643">		Connection con = DBConnect.getConnection();</span>
		try {
<span class="nc" id="L4645">			Statement stmt = con.createStatement();</span>
<span class="nc" id="L4646">			ResultSet rs = stmt.executeQuery(&quot;select vm.device_id,version from st_lms_htpos_version_master vm inner join st_lms_htpos_device_master dm on vm.device_id=dm.device_id where device_type='&quot;+deviceName+&quot;'&quot;);</span>
<span class="nc bnc" id="L4647" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L4648">				versionList.add(rs.getString(&quot;version&quot;));</span>
			}
<span class="nc" id="L4650">		} catch (SQLException e) {</span>
<span class="nc" id="L4651">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L4653">			try {</span>
<span class="nc bnc" id="L4654" title="All 6 branches missed.">				if (con != null) {</span>
<span class="nc" id="L4655">					con.close();</span>
				}
<span class="nc" id="L4657">			} catch (SQLException se) {</span>
<span class="nc" id="L4658">				se.printStackTrace();</span>
<span class="nc" id="L4659">			}</span>
<span class="nc" id="L4660">		}</span>
<span class="nc" id="L4661">		return versionList;</span>
	}
	public static ArrayList&lt;String&gt; getTerminalList() {
<span class="nc" id="L4664">		ArrayList&lt;String&gt; terList = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L4665">		Connection con = DBConnect.getConnection();</span>
		try {
<span class="nc" id="L4667">			Statement stmt = con.createStatement();</span>
<span class="nc" id="L4668">			ResultSet rs = stmt.executeQuery(&quot;select device_type from st_lms_htpos_device_master&quot;);</span>
<span class="nc bnc" id="L4669" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L4670">				terList.add(rs.getString(&quot;device_type&quot;));</span>
			}
<span class="nc" id="L4672">		} catch (SQLException e) {</span>
<span class="nc" id="L4673">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L4675">			try {</span>
<span class="nc bnc" id="L4676" title="All 6 branches missed.">				if (con != null) {</span>
<span class="nc" id="L4677">					con.close();</span>
				}
<span class="nc" id="L4679">			} catch (SQLException se) {</span>
<span class="nc" id="L4680">				se.printStackTrace();</span>
<span class="nc" id="L4681">			}</span>
<span class="nc" id="L4682">		}</span>
<span class="nc" id="L4683">		return terList;</span>
	}
	public static List&lt;String&gt; getServiceList(){
<span class="nc" id="L4686">		List&lt;String&gt; list = new LinkedList&lt;String&gt;();</span>
<span class="nc bnc" id="L4687" title="All 2 branches missed.">		if(LMSFilterDispatcher.getIsDraw().equals(&quot;YES&quot;)){</span>
<span class="nc" id="L4688">			list.add(&quot;Draw Game&quot;);</span>
<span class="nc" id="L4689">			list.add(&quot;Draw Game Sale&quot;);</span>
<span class="nc" id="L4690">			list.add(&quot;Draw Game Pwt&quot;);</span>
		}
<span class="nc bnc" id="L4692" title="All 2 branches missed.">		if(LMSFilterDispatcher.getIsScratch().equals(&quot;YES&quot;)){</span>
<span class="nc" id="L4693">			list.add(&quot;Scratch Game&quot;);</span>
<span class="nc" id="L4694">			list.add(&quot;Scratch Game Sale&quot;);</span>
<span class="nc" id="L4695">			list.add(&quot;Scratch Game Pwt&quot;);</span>
		}
<span class="nc bnc" id="L4697" title="All 2 branches missed.">		if(LMSFilterDispatcher.getIsOLA().equals(&quot;YES&quot;)){</span>
<span class="nc" id="L4698">			list.add(&quot;Offline Affiliates&quot;);</span>
<span class="nc" id="L4699">			list.add(&quot;Offline Affiliates Deposit&quot;);</span>
<span class="nc" id="L4700">			list.add(&quot;Offline Affiliates Withdrawal&quot;);</span>
		}
<span class="nc bnc" id="L4702" title="All 2 branches missed.">		if(LMSFilterDispatcher.getIsCS().equals(&quot;YES&quot;)){</span>
<span class="nc" id="L4703">			list.add(&quot;Commercial Service&quot;);</span>
<span class="nc" id="L4704">			list.add(&quot;Commercial Service Sale&quot;);</span>
<span class="nc bnc" id="L4705" title="All 2 branches missed.">		}if(LMSFilterDispatcher.getIsSLE().equals(&quot;YES&quot;)){</span>
<span class="nc" id="L4706">			list.add(&quot;Sports Lottery&quot;);</span>
<span class="nc" id="L4707">			list.add(&quot;Sports Lottery Sale&quot;);</span>
<span class="nc" id="L4708">			list.add(&quot;Sports Lottery Pwt&quot;);</span>
		}
<span class="nc bnc" id="L4710" title="All 2 branches missed.">		if(LMSFilterDispatcher.getIsIW().equals(&quot;YES&quot;)){</span>
<span class="nc" id="L4711">			list.add(&quot;Instant Win&quot;);</span>
<span class="nc" id="L4712">			list.add(&quot;Instant Win Sale&quot;);</span>
<span class="nc" id="L4713">			list.add(&quot;Instant Win Pwt&quot;);</span>
		}
<span class="nc bnc" id="L4715" title="All 2 branches missed.">		if(LMSFilterDispatcher.getIsVS().equals(&quot;YES&quot;)){</span>
<span class="nc" id="L4716">			list.add(&quot;Virtual Sports&quot;);</span>
<span class="nc" id="L4717">			list.add(&quot;Virtual Sports Sale&quot;);</span>
<span class="nc" id="L4718">			list.add(&quot;Virtual Sports Pwt&quot;);</span>
		}

<span class="nc" id="L4721">		list.add(&quot;Login&quot;);</span>
<span class="nc" id="L4722">		list.add(&quot;HeartBeat&quot;);</span>
<span class="nc" id="L4723">		list.add(&quot;Total&quot;);</span>
<span class="nc" id="L4724">			return list;</span>
		} 
	public static String getLongitudeLatitude(String address) {
<span class="nc" id="L4727">		String strLatitude = &quot;0.000000&quot;;</span>
<span class="nc" id="L4728">		String strLongtitude =&quot;0.000000&quot;;</span>
		try {
<span class="nc" id="L4730">			StringBuilder urlBuilder = new StringBuilder(GEOCODE_REQUEST_URL);</span>
<span class="nc bnc" id="L4731" title="All 2 branches missed.">			if (StringUtils.isNotBlank(address)) {</span>
<span class="nc" id="L4732">				urlBuilder.append(&quot;&amp;address=&quot;).append(</span>
						URLEncoder.encode(address, &quot;UTF-8&quot;));
			}
<span class="nc" id="L4735">			final GetMethod getMethod = new GetMethod(urlBuilder.toString());</span>
			try {
<span class="nc" id="L4737">				httpClient.executeMethod(getMethod);</span>
<span class="nc" id="L4738">				Reader reader = new InputStreamReader(getMethod</span>
						.getResponseBodyAsStream(), getMethod
						.getResponseCharSet());
<span class="nc" id="L4741">				int data = reader.read();</span>
<span class="nc" id="L4742">				char[] buffer = new char[1024];</span>
<span class="nc" id="L4743">				Writer writer = new StringWriter();</span>
<span class="nc bnc" id="L4744" title="All 2 branches missed.">				while ((data = reader.read(buffer)) != -1) {</span>
<span class="nc" id="L4745">					writer.write(buffer, 0, data);</span>
				}

<span class="nc" id="L4748">				DocumentBuilderFactory dbf = DocumentBuilderFactory</span>
						.newInstance();
<span class="nc" id="L4750">				DocumentBuilder db = dbf.newDocumentBuilder();</span>
<span class="nc" id="L4751">				InputSource is = new InputSource();</span>
<span class="nc" id="L4752">				is.setCharacterStream(new StringReader(&quot;&lt;&quot;</span>
						+ writer.toString().trim()));
<span class="nc" id="L4754">				Document doc = db.parse(is);</span>
<span class="nc" id="L4755">				strLatitude = getXpathValue(doc,</span>
						&quot;//GeocodeResponse/result/geometry/location/lat/text()&quot;);
<span class="nc" id="L4757">				strLongtitude = getXpathValue(doc,</span>
						&quot;//GeocodeResponse/result/geometry/location/lng/text()&quot;);
<span class="nc bnc" id="L4759" title="All 2 branches missed.">				if(strLatitude == null)</span>
<span class="nc" id="L4760">					strLatitude = &quot;0.000000&quot;;</span>
<span class="nc bnc" id="L4761" title="All 2 branches missed.">				if(strLongtitude == null)</span>
<span class="nc" id="L4762">					strLongtitude = &quot;0.000000&quot;;</span>
			} finally {
<span class="nc" id="L4764">				getMethod.releaseConnection();</span>
<span class="nc" id="L4765">			}</span>
<span class="nc" id="L4766">		} catch (Exception e) {</span>
<span class="nc" id="L4767">			e.printStackTrace();</span>
<span class="nc" id="L4768">		}</span>
<span class="nc" id="L4769">		return strLatitude + &quot;:&quot; + strLongtitude;</span>
	}

	private static String getXpathValue(Document doc, String strXpath)
			throws XPathExpressionException {
<span class="nc" id="L4774">		XPath xPath = XPathFactory.newInstance().newXPath();</span>
<span class="nc" id="L4775">		XPathExpression expr = xPath.compile(strXpath);</span>
<span class="nc" id="L4776">		String resultData = null;</span>
<span class="nc" id="L4777">		Object result4 = expr.evaluate(doc, XPathConstants.NODESET);</span>
<span class="nc" id="L4778">		NodeList nodes = (NodeList) result4;</span>
<span class="nc bnc" id="L4779" title="All 2 branches missed.">		for (int i = 0; i &lt; nodes.getLength(); i++) {</span>
<span class="nc" id="L4780">			resultData = nodes.item(i).getNodeValue();</span>
		}
<span class="nc" id="L4782">		return resultData;</span>
	}
	public static List&lt;String&gt; getEmailIdsForDrawMgmtNotification(){
<span class="nc" id="L4785">		Connection con =null;</span>
<span class="nc" id="L4786">		PreparedStatement pstmt =null;</span>
<span class="nc" id="L4787">		ResultSet rs =null;</span>
<span class="nc" id="L4788">		List&lt;String&gt; emailList = new ArrayList&lt;String&gt;();</span>
		try{
<span class="nc" id="L4790">			con =DBConnect.getConnection();</span>
<span class="nc" id="L4791">			String query =&quot;select email_id from st_lms_report_email_priviledge_rep a inner join st_lms_report_email_priv_master  b on a.email_pid =b.email_pid &quot; +</span>
							&quot; inner join st_lms_report_email_user_master c on b.user_id=c.ref_user_id  where  priv_title ='DrawMgmtNotification' and a.status='ACTIVE' and b.status='ACTIVE' and c.status='ACTIVE'&quot;;
<span class="nc" id="L4793">			pstmt = con.prepareStatement(query);</span>
<span class="nc" id="L4794">			rs =pstmt.executeQuery();</span>
<span class="nc bnc" id="L4795" title="All 2 branches missed.">			while(rs.next()){</span>
				
<span class="nc" id="L4797">				emailList.add(rs.getString(&quot;email_id&quot;));</span>
			}
<span class="nc" id="L4799">			return emailList;</span>
			
<span class="nc" id="L4801">		}catch(Exception e){</span>
<span class="nc" id="L4802">			e.printStackTrace();</span>
		}
		
		
<span class="nc" id="L4806">		return null;</span>
	}
	
public static String  getStateListWithCode(String countryCode){

<span class="nc" id="L4811">	StringBuilder listWithCode = new StringBuilder();</span>
<span class="nc" id="L4812">	PreparedStatement pstmt = null;</span>
<span class="nc" id="L4813">	Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L4814">	ResultSet rs = null;</span>
	try {
<span class="nc" id="L4816">		pstmt = con.prepareStatement(&quot;select state_code,name from st_lms_state_master where country_code=? and status=?&quot;);</span>
<span class="nc" id="L4817">		pstmt.setString(1,countryCode);</span>
<span class="nc" id="L4818">		pstmt.setString(2,&quot;ACTIVE&quot;);</span>
<span class="nc" id="L4819">		rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L4820" title="All 2 branches missed.">		while (rs.next()) {</span>
<span class="nc" id="L4821">			listWithCode.append(rs.getString(&quot;state_code&quot;) + &quot;:&quot;</span>
					+ rs.getString(&quot;name&quot;)+&quot;|&quot;);

		}

<span class="nc" id="L4826">	} catch (Exception e) {</span>
<span class="nc" id="L4827">		e.printStackTrace();</span>

	} finally {

<span class="nc" id="L4831">		try {</span>
<span class="nc bnc" id="L4832" title="All 6 branches missed.">			if (con != null) {</span>
<span class="nc" id="L4833">				con.close();</span>
			}
<span class="nc bnc" id="L4835" title="All 6 branches missed.">			if (pstmt != null) {</span>
<span class="nc" id="L4836">				pstmt.close();</span>
			}
<span class="nc bnc" id="L4838" title="All 6 branches missed.">			if (rs != null) {</span>
<span class="nc" id="L4839">				rs.close();</span>

			}
<span class="nc" id="L4842">		} catch (Exception e) {</span>
<span class="nc" id="L4843">			e.printStackTrace();</span>
<span class="nc" id="L4844">		}</span>

<span class="nc" id="L4846">	}</span>

<span class="nc" id="L4848">	return listWithCode.toString();</span>

}
public static String  getCityListWithCode(String countryCode,String stateCode){

<span class="nc" id="L4853">	StringBuilder listWithCode = new StringBuilder();</span>
<span class="nc" id="L4854">	PreparedStatement pstmt = null;</span>
<span class="nc" id="L4855">	Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L4856">	ResultSet rs = null;</span>
	try {
<span class="nc" id="L4858">		pstmt = con.prepareStatement(&quot;select city_code,city_name from st_lms_city_master where state_code=? and country_code=? and status=? &quot;);</span>
<span class="nc" id="L4859">		pstmt.setString(1,stateCode);</span>
<span class="nc" id="L4860">		pstmt.setString(2,countryCode);</span>
<span class="nc" id="L4861">		pstmt.setString(3,&quot;ACTIVE&quot;);</span>
<span class="nc" id="L4862">		rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L4863" title="All 2 branches missed.">		while (rs.next()) {</span>
<span class="nc" id="L4864">			listWithCode.append(rs.getString(&quot;city_code&quot;) + &quot;:&quot;</span>
					+ rs.getString(&quot;city_name&quot;)+&quot;|&quot;);

		}

<span class="nc" id="L4869">	} catch (Exception e) {</span>
<span class="nc" id="L4870">		e.printStackTrace();</span>

	} finally {

<span class="nc" id="L4874">		try {</span>
<span class="nc bnc" id="L4875" title="All 6 branches missed.">			if (con != null) {</span>
<span class="nc" id="L4876">				con.close();</span>
			}
<span class="nc bnc" id="L4878" title="All 6 branches missed.">			if (pstmt != null) {</span>
<span class="nc" id="L4879">				pstmt.close();</span>
			}
<span class="nc bnc" id="L4881" title="All 6 branches missed.">			if (rs != null) {</span>
<span class="nc" id="L4882">				rs.close();</span>

			}
<span class="nc" id="L4885">		} catch (Exception e) {</span>
<span class="nc" id="L4886">			e.printStackTrace();</span>
<span class="nc" id="L4887">		}</span>

<span class="nc" id="L4889">	}</span>

<span class="nc" id="L4891">	return listWithCode.toString();</span>

}
public static String  getAreaListWithCode(String countryCode,String stateCode,String cityCode){

<span class="nc" id="L4896">	StringBuilder listWithCode = new StringBuilder();</span>
<span class="nc" id="L4897">	PreparedStatement pstmt = null;</span>
<span class="nc" id="L4898">	Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L4899">	ResultSet rs = null;</span>
	try {
		//pstmt = con.prepareStatement(&quot;select area_code,area_name from st_lms_area_master where city_code=? and state_code=? and country_code=? and status=? &quot;);
<span class="nc" id="L4902">		pstmt = con.prepareStatement(&quot;select area_code,area_name from st_lms_area_master am,st_lms_city_master ctm,st_lms_state_master sm,st_lms_country_master cm where am.city_code=ctm.city_code and am.state_code=sm.state_code and am.country_code=cm.country_code and ctm.city_name=? and sm.name=? and  cm.name=? and  am.status=?&quot;);</span>
<span class="nc" id="L4903">		pstmt.setString(1,cityCode);</span>
<span class="nc" id="L4904">		pstmt.setString(2,stateCode);</span>
<span class="nc" id="L4905">		pstmt.setString(3,countryCode);</span>
<span class="nc" id="L4906">		pstmt.setString(4,&quot;ACTIVE&quot;);</span>
<span class="nc" id="L4907">		rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L4908" title="All 2 branches missed.">		while (rs.next()) {</span>
<span class="nc" id="L4909">			listWithCode.append(rs.getString(&quot;area_code&quot;) + &quot;:&quot;</span>
					+ rs.getString(&quot;area_name&quot;)+&quot;|&quot;);

		}

<span class="nc" id="L4914">	} catch (Exception e) {</span>
<span class="nc" id="L4915">		e.printStackTrace();</span>

	} finally {

<span class="nc" id="L4919">		try {</span>
<span class="nc bnc" id="L4920" title="All 6 branches missed.">			if (con != null) {</span>
<span class="nc" id="L4921">				con.close();</span>
			}
<span class="nc bnc" id="L4923" title="All 6 branches missed.">			if (pstmt != null) {</span>
<span class="nc" id="L4924">				pstmt.close();</span>
			}
<span class="nc bnc" id="L4926" title="All 6 branches missed.">			if (rs != null) {</span>
<span class="nc" id="L4927">				rs.close();</span>

			}
<span class="nc" id="L4930">		} catch (Exception e) {</span>
<span class="nc" id="L4931">			e.printStackTrace();</span>
<span class="nc" id="L4932">		}</span>

<span class="nc" id="L4934">	}</span>

<span class="nc" id="L4936">	return listWithCode.toString();</span>

}
public static String  getDivisionListWithCode(String countryCode,String stateCode,String cityCode,String areaCode ){

<span class="nc" id="L4941">	StringBuilder listWithCode = new StringBuilder();</span>
<span class="nc" id="L4942">	PreparedStatement pstmt = null;</span>
<span class="nc" id="L4943">	Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L4944">	ResultSet rs = null;</span>
	try {
		//pstmt = con.prepareStatement(&quot;select area_code,area_name from st_lms_area_master where city_code=? and state_code=? and country_code=? and status=? &quot;);
<span class="nc" id="L4947">		pstmt = con.prepareStatement(&quot;select division_code,division_name from st_lms_division_master dm,st_lms_area_master am,st_lms_city_master ctm,st_lms_state_master sm,st_lms_country_master cm where dm.area_code=am.area_code and am.city_code=ctm.city_code and am.state_code=sm.state_code and am.country_code=cm.country_code and am.area_code=? and ctm.city_name=? and sm.name=? and  cm.name=? and  dm.status=?&quot;);</span>
<span class="nc" id="L4948">		pstmt.setString(1,areaCode);</span>
<span class="nc" id="L4949">		pstmt.setString(2,cityCode);</span>
<span class="nc" id="L4950">		pstmt.setString(3,stateCode);</span>
<span class="nc" id="L4951">		pstmt.setString(4,countryCode);</span>
<span class="nc" id="L4952">		pstmt.setString(5,&quot;ACTIVE&quot;);</span>
<span class="nc" id="L4953">		rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L4954" title="All 2 branches missed.">		while (rs.next()) {</span>
<span class="nc" id="L4955">			listWithCode.append(rs.getString(&quot;division_code&quot;) + &quot;:&quot;</span>
					+ rs.getString(&quot;division_name&quot;)+&quot;|&quot;);

		}

<span class="nc" id="L4960">	} catch (Exception e) {</span>
<span class="nc" id="L4961">		e.printStackTrace();</span>

	} finally {

<span class="nc" id="L4965">		try {</span>
<span class="nc bnc" id="L4966" title="All 6 branches missed.">			if (con != null) {</span>
<span class="nc" id="L4967">				con.close();</span>
			}
<span class="nc bnc" id="L4969" title="All 6 branches missed.">			if (pstmt != null) {</span>
<span class="nc" id="L4970">				pstmt.close();</span>
			}
<span class="nc bnc" id="L4972" title="All 6 branches missed.">			if (rs != null) {</span>
<span class="nc" id="L4973">				rs.close();</span>

			}
<span class="nc" id="L4976">		} catch (Exception e) {</span>
<span class="nc" id="L4977">			e.printStackTrace();</span>
<span class="nc" id="L4978">		}</span>

<span class="nc" id="L4980">	}</span>

<span class="nc" id="L4982">	return listWithCode.toString();</span>

}


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>