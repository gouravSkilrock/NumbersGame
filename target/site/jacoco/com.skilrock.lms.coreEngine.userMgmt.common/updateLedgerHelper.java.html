<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>updateLedgerHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lms</a> &gt; <a href="index.source.html" class="el_package">com.skilrock.lms.coreEngine.userMgmt.common</a> &gt; <span class="el_source">updateLedgerHelper.java</span></div><h1>updateLedgerHelper.java</h1><pre class="source lang-java linenums">package com.skilrock.lms.coreEngine.userMgmt.common;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.sql.Timestamp;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Set;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import com.skilrock.lms.beans.UserInfoBean;
import com.skilrock.lms.common.Utility;
import com.skilrock.lms.common.db.DBConnect;
import com.skilrock.lms.common.db.QueryManager;
import com.skilrock.lms.common.exception.LMSException;
import com.skilrock.lms.common.filter.LMSFilterDispatcher;
import com.skilrock.lms.common.utility.CommonMethods;
import com.skilrock.lms.common.utility.GenerateRecieptNo;
import com.skilrock.lms.common.utility.OrgCreditUpdation;
import com.skilrock.lms.web.drawGames.common.Util;

<span class="nc" id="L32">public class updateLedgerHelper {</span>
<span class="nc" id="L33">	private static Log logger = LogFactory.getLog(updateLedgerHelper.class);</span>

	public static void main(String[] args) throws ParseException {
		/*String transDate = &quot;2011-04-12 23:30:00&quot;;
		String curDate = (new SimpleDateFormat(&quot;yyyy-MM-dd&quot;))
				.format((new Timestamp((new Date()).getTime())));
		Timestamp startDate = new Timestamp((new SimpleDateFormat(
				&quot;yyyy-MM-dd hh:mm:ss&quot;)).parse(transDate).getTime());
		logger.debug(curDate);
		logger.debug(startDate);*/
		// logger.debug(fetchTransTimeStamp(transDate));
<span class="nc" id="L44">		updateLedgerHelper helper = new updateLedgerHelper();</span>
<span class="nc" id="L45">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L46">		Statement tempStmt=null;</span>
		try {
<span class="nc" id="L48">			helper.fillTempDGTransCommTlbForRet(con);</span>
<span class="nc" id="L49">			tempStmt=con.createStatement();</span>
<span class="nc" id="L50">			tempStmt.execute(&quot;CREATE TEMPORARY TABLE orgTransSummary (agent_ref_transaction_id BIGINT NOT NULL, ret_comm DECIMAL(20,2) NOT NULL DEFAULT 0.00, agt_comm DECIMAL(20,2) NOT NULL DEFAULT 0.00, govt_comm DECIMAL(20,2) NOT NULL DEFAULT 0.00, retailer_org_id INT UNSIGNED NOT NULL DEFAULT 0, game_id INT UNSIGNED NOT NULL DEFAULT 0,trans_date DATETIME)&quot;);</span>
<span class="nc" id="L51">			helper.updateDGSaleLedgerForRet(con);</span>
<span class="nc" id="L52">		} catch (LMSException e) {</span>
			// TODO Auto-generated catch block
<span class="nc" id="L54">			e.printStackTrace();</span>
<span class="nc" id="L55">		}catch (Exception e) {</span>
			// TODO: handle exception
<span class="nc" id="L57">		}</span>
		
<span class="nc" id="L59">	}</span>
	
	@SuppressWarnings(&quot;unchecked&quot;)
	public static void updateLedger() throws LMSException {
<span class="nc" id="L63">		Connection con = DBConnect.getConnection();</span>

		try {
<span class="nc" id="L66">			logger.debug(new Date()+&quot;---Update Ledger Start At--&quot;+new Date().getTime());</span>
<span class="nc" id="L67">			con.setAutoCommit(false);</span>
<span class="nc" id="L68">			Statement tempStmt=null;</span>
<span class="nc" id="L69">			boolean isDraw = &quot;YES&quot;.equalsIgnoreCase(LMSFilterDispatcher.getIsDraw());</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">			if (isDraw) {</span>
<span class="nc" id="L71">				updateLedgerHelper helper = new updateLedgerHelper();</span>
<span class="nc" id="L72">				logger.debug(new Date()+&quot;---Update Ledger Of Draw Game Start At--&quot;+new Date().getTime());</span>
<span class="nc" id="L73">				tempStmt=con.createStatement();</span>
<span class="nc" id="L74">				tempStmt.execute(&quot;CREATE TEMPORARY TABLE orgTransSummary (agent_ref_transaction_id BIGINT NOT NULL, ret_comm DECIMAL(20,2) NOT NULL DEFAULT 0.00, agt_comm DECIMAL(20,2) NOT NULL DEFAULT 0.00, govt_comm DECIMAL(20,2) NOT NULL DEFAULT 0.00, retailer_org_id INT UNSIGNED NOT NULL DEFAULT 0, game_id INT UNSIGNED NOT NULL DEFAULT 0,trans_date DATETIME)&quot;);</span>

<span class="nc" id="L76">				helper.fillTempDGTransCommTlbForRet(con);</span>
<span class="nc" id="L77">				helper.updateDGSaleLedgerForRet(con);</span>
				//helper.updateDGSaleLedgerForRetwithoutComm(con);
<span class="nc" id="L79">				helper.updateDGPwtLedgerForRet(con);</span>
<span class="nc" id="L80">				logger.debug(new Date()+&quot;---Draw Game Sale Pwt Complete for Retailer Start At--&quot;+new Date().getTime());</span>
<span class="nc" id="L81">				tempStmt.execute(&quot;drop table orgTransSummary&quot;);</span>
				
<span class="nc" id="L83">				tempStmt.execute(&quot;CREATE TEMPORARY TABLE agentTransSummary (bo_ref_transaction_id BIGINT NOT NULL, agt_comm DECIMAL(20,2) NOT NULL DEFAULT 0.00, govt_comm DECIMAL(20,2) NOT NULL DEFAULT 0.00, agent_org_id INT UNSIGNED NOT NULL DEFAULT 0, game_id INT UNSIGNED NOT NULL DEFAULT 0,trans_date DATETIME)&quot;);</span>

<span class="nc" id="L85">				helper.fillTempDGTransCommTlbForAgt(con);</span>
<span class="nc" id="L86">				helper.updateDGSaleLedgerForAgt(con);</span>
				//helper.updateDGSaleLedgerForAgtwithoutComm(con);
<span class="nc" id="L88">				helper.updateDGPwtLedgerForAgt(con);</span>
				
<span class="nc" id="L90">				tempStmt.execute(&quot;drop table agentTransSummary&quot;);</span>
<span class="nc" id="L91">				logger.debug(new Date()+&quot;---Draw Game Sale Pwt Complete for Agent Start At--&quot;+new Date().getTime());</span>
<span class="nc" id="L92">				logger.debug(new Date()+&quot;---Update Ledger Of Draw Game End At--&quot;+new Date().getTime());</span>
<span class="nc" id="L93">			} else {</span>
<span class="nc" id="L94">				logger.debug(&quot;Draw Game Module not implemented!!&quot;);</span>
			}

<span class="nc" id="L97">			boolean isCS = &quot;YES&quot;</span>
					.equalsIgnoreCase(LMSFilterDispatcher.getIsCS());
<span class="nc bnc" id="L99" title="All 2 branches missed.">			if (isCS) {</span>
<span class="nc" id="L100">				updateLedgerHelper helper = new updateLedgerHelper();</span>
<span class="nc" id="L101">				logger.debug(new Date()+&quot;---Update Ledger Of CS Start At--&quot;+new Date().getTime());</span>
<span class="nc" id="L102">				helper.updateCSSaleLedgerForRet(con);</span>
<span class="nc" id="L103">				helper.updateCSSaleLedgerForAgt(con);</span>
<span class="nc" id="L104">				logger.debug(new Date()+&quot;---Update Ledger Of CS End At--&quot;+new Date().getTime());</span>
<span class="nc" id="L105">			}else {</span>
<span class="nc" id="L106">				logger.debug(&quot;CS Module not implemented!!&quot;);</span>
			}
<span class="nc" id="L108">			boolean isOLA = &quot;YES&quot;.equalsIgnoreCase(LMSFilterDispatcher.getIsOLA());</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">			if(isOLA)</span>
			{
<span class="nc" id="L111">				updateLedgerHelper helper = new updateLedgerHelper();</span>
				//for retailer
<span class="nc" id="L113">				helper.updateOlaDepositLedgerForRet(con);</span>
<span class="nc" id="L114">				helper.updateOlaWithdrawlLedgerForRet(con);</span>
				//for Agent
<span class="nc" id="L116">				helper.updateOlaDepositLedgerForAgt(con);</span>
<span class="nc" id="L117">				helper.updateOlaWithdrawlLedgerForAgt(con);</span>
				
				//For commission agent and retailer in OLA
<span class="nc" id="L120">				helper.updateOLACommissionLedgerForRet(con);</span>
<span class="nc" id="L121">				helper.updateOLACommissionLedgerForAgt(con);</span>
				//for Agent for Player Commission
			//	helper.updateOlaPlayerCommissionLedgerForAgt(con);
				
<span class="nc" id="L125">			}</span>
			else
			{
<span class="nc" id="L128">				logger.debug(&quot;OLA module not implemented&quot;);</span>
			}
			// con.setAutoCommit(false);
<span class="nc" id="L131">			boolean isScratch = &quot;YES&quot;.equalsIgnoreCase(LMSFilterDispatcher</span>
					.getIsScratch());
<span class="nc bnc" id="L133" title="All 2 branches missed.">			if (isScratch) {</span>
<span class="nc" id="L134">				logger.debug(new Date()+&quot;---Update Ledger Of Scratch Start At--&quot;+new Date().getTime());</span>
<span class="nc" id="L135">				CommonFunctionsHelper commHelper = new CommonFunctionsHelper();</span>
<span class="nc" id="L136">				List&lt;UserInfoBean&gt; orgidList = commHelper</span>
						.getOrgIdNClmAmtList(con);
<span class="nc bnc" id="L138" title="All 2 branches missed.">				for (UserInfoBean userBean : orgidList) {</span>
<span class="nc" id="L139">					String receiptId = null;</span>
<span class="nc" id="L140">					logger.debug(&quot;Instant game pwt started&quot;);</span>
<span class="nc" id="L141">					Map virnPwtMap = commHelper.fetchPwtDetailsOfOrg(userBean</span>
							.getUserOrgId(), userBean.getUserType(),
							&quot;CLAIM_BAL&quot;, con);
<span class="nc bnc" id="L144" title="All 4 branches missed.">					if (virnPwtMap != null &amp;&amp; !virnPwtMap.isEmpty()) {						</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">						if (&quot;RETAILER&quot;.equalsIgnoreCase(userBean.getUserType())) {</span>
							
<span class="nc" id="L147">							logger.debug(&quot;CLAIMABLE for RETAILER&quot;);</span>
<span class="nc" id="L148">							receiptId = commHelper.updateClmableBalOfRetOrg(</span>
									userBean.getUserId(), userBean
											.getUserOrgId(), userBean.getParentUserId(), userBean
											.getParentOrgId(), virnPwtMap, con);
<span class="nc bnc" id="L152" title="All 2 branches missed.">						} else if (&quot;AGENT&quot;.equalsIgnoreCase(userBean</span>
								.getUserType())) { // claimable
							// for
							// AGENT
<span class="nc" id="L156">							logger.debug(&quot;CLAIMABLE for AGENT&quot;);</span>
<span class="nc" id="L157">							receiptId = commHelper.updateClmableBalOfAgtOrg(</span>
									userBean.getUserId(), userBean
											.getUserOrgId(), userBean.getParentUserId(), userBean
											.getParentOrgId(), virnPwtMap, con);
						}
<span class="nc" id="L162">						logger.debug(&quot;receipt id is &quot; + receiptId);</span>
					} else {
<span class="nc" id="L164">						receiptId = &quot;AlreadyUpdated&quot;;</span>
					}

<span class="nc" id="L167">				}</span>
<span class="nc" id="L168">				logger.debug(new Date()+&quot;---Update Ledger Of Scratch End At--&quot;+new Date().getTime());</span>
<span class="nc" id="L169">			} else {</span>
<span class="nc" id="L170">				logger.debug(&quot;Scratch Game Module not implemented !!&quot;);</span>
			}
<span class="nc" id="L172">			boolean isSLE = &quot;YES&quot;.equalsIgnoreCase(LMSFilterDispatcher.getIsSLE());</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">			if (isSLE) {</span>
<span class="nc" id="L174">				SLEUpdateLedgerHelper.runLedgerForSLE(con);</span>
				//SLEUpdateLedgerHelper.runTemp(con);
			} else {
<span class="nc" id="L177">				logger.debug(&quot;Draw Game Module not implemented!!&quot;);</span>
			}
			
			
			
<span class="nc" id="L182">			con.commit();</span>
			//new LedgerHelperQuartz().fillLedger();
<span class="nc" id="L184">		} catch (SQLException e) {</span>
<span class="nc" id="L185">			logger.info(&quot;SQL Exception &quot;,e);</span>
<span class="nc" id="L186">			throw new LMSException(&quot;SQL Exception &quot;+e.getMessage());</span>
<span class="nc" id="L187">		}catch (Exception e) {</span>
<span class="nc" id="L188">			logger.info(&quot;Exception &quot;,e);</span>
<span class="nc" id="L189">			throw new LMSException(&quot;Exception&quot;+e.getMessage());</span>
		} finally {
<span class="nc" id="L191">			DBConnect.closeCon(con);</span>
<span class="nc" id="L192">		}</span>
<span class="nc" id="L193">	}</span>

	public void updateCSSaleLedgerForRet(Connection con) throws LMSException {
<span class="nc" id="L196">		logger.debug(new Date() + &quot;---start-cs sale update for retailer--&quot;</span>
				+ new Date().getTime());
<span class="nc" id="L198">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L199">		ResultSet rs = null;</span>
		double totalMrpAmt, totalRetComm, totalAgtComm, totalJVAmt, totalretNetAmt, totalAgtNetAmt, vatAmt, govtCommAmt, totalCancelCharge;
		double retCommRate, agtCommRate, JVCommRate, vat, govtComm, retDebitAmount;
		String transDate;
<span class="nc" id="L203">		int retOrgId, agtUserId, agtOrgId=0;</span>
<span class="nc" id="L204">		Map&lt;Integer, Double&gt; orgIdAmountMap = new HashMap&lt;Integer, Double&gt;();</span>
<span class="nc" id="L205">		Map&lt;Integer, Integer&gt; orgIdParentIdMap = new HashMap&lt;Integer, Integer&gt;();</span>
<span class="nc" id="L206">		Map&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt; orgIdTransIdInvMap = new HashMap&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt;();</span>
<span class="nc" id="L207">		Map&lt;String, List&lt;Long&gt;&gt; transIdInvMap = null;</span>
<span class="nc" id="L208">		Map&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt; orgIdTransIdInvRetMap= new HashMap&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt;();</span>
<span class="nc" id="L209">		Map&lt;String, List&lt;Long&gt;&gt; transIdInvRetMap= null;</span>
		try {
<span class="nc" id="L211">			String getGameNbrFromGameMaster = &quot;select category_id from st_cs_product_category_master where status='ACTIVE'&quot;;</span>
<span class="nc" id="L212">			String saleQry = &quot;select a.retailer_org_id,agtUserId,agtOrgId,sum(mrp_amt) totalMrp ,(retailer_comm) totalRetComm,(agent_comm) totalagtComm, (jv_comm) totalJVComm,a.product_id,vat,vat_amt,govt_comm,govt_comm_amt,DATE(transaction_date) 'transaction_date',transaction_type from st_cs_sale_? a inner join  st_lms_retailer_transaction_master b inner join (select um.user_id retUserId,um.organization_id retOrgId,um.parent_user_id agtUserId,om.parent_id agtOrgId from st_lms_organization_master om inner join st_lms_user_master um on om.organization_id=um.organization_id where om.organization_type='RETAILER') c on a.transaction_id = b.transaction_id and a.retailer_org_id=retOrgId  where claim_status='CLAIM_BAL' group by a.retailer_org_id,DATE(transaction_date),a.product_id,retailer_comm,agent_comm,jv_comm  order by retailer_org_id,game_id,transaction_date&quot;;</span>
<span class="nc" id="L213">			String saleReturnQry = &quot;select a.retailer_org_id,agtUserId,agtOrgId,sum(mrp_amt) totalMrp ,(retailer_comm) totalRetComm,(agent_comm) totalagtComm, (jv_comm) totalJVComm,sum(cancellation_charges) totalCancelCharge,a.product_id,vat,vat_amt,govt_comm,govt_comm_amt,DATE(transaction_date) 'transaction_date',transaction_type from st_cs_refund_? a inner join  st_lms_retailer_transaction_master b inner join (select um.user_id retUserId,um.organization_id retOrgId,um.parent_user_id agtUserId,om.parent_id agtOrgId from st_lms_organization_master om inner join st_lms_user_master um on om.organization_id=um.organization_id where om.organization_type='RETAILER') c on a.transaction_id = b.transaction_id and a.retailer_org_id=retOrgId  where claim_status='CLAIM_BAL' group by a.retailer_org_id,DATE(transaction_date),a.product_id,transaction_type,retailer_comm,agent_comm,jv_comm  order by retailer_org_id,game_id,transaction_date&quot;;</span>
<span class="nc" id="L214">			PreparedStatement pstmtGameNbr = con</span>
					.prepareStatement(getGameNbrFromGameMaster);
<span class="nc" id="L216">			ResultSet resultGameNbr = pstmtGameNbr.executeQuery();</span>

<span class="nc" id="L218">			PreparedStatement pstmtAgt = con.prepareStatement(QueryManager</span>
					.insertInLMSTransactionMaster());
<span class="nc" id="L220">			PreparedStatement pstmtAgtTrans = con.prepareStatement(QueryManager</span>
					.insertInAgentTransactionMaster());
<span class="nc" id="L222">			PreparedStatement insAgtSalePstmt = con</span>
					.prepareStatement(&quot;insert into st_cs_agt_sale(transaction_id,agent_org_id,retailer_org_id,product_id,mrp_amt,retailer_comm,net_amt,agent_comm,bo_net_amt,claim_status,jv_comm,jv_comm_amt, vat, vat_amt, govt_comm, govt_comm_amt) values(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)&quot;);
<span class="nc" id="L224">			PreparedStatement updateRetSalePstmt = con</span>
					.prepareStatement(&quot;update st_cs_sale_? a inner join  st_lms_retailer_transaction_master b on a.transaction_id = b.transaction_id set claim_status='DONE_CLAIM',agent_ref_transaction_id=? where a.retailer_org_id=? and a.product_id =? and retailer_comm=? and agent_comm=? and jv_comm=? and DATE(transaction_date)=? and transaction_type=?&quot;);
<span class="nc" id="L226">			PreparedStatement insAgtSaleRetPstmt = con</span>
					.prepareStatement(&quot;insert into st_cs_agt_refund(transaction_id,agent_org_id,retailer_org_id,product_id,mrp_amt,retailer_comm,net_amt,agent_comm,bo_net_amt,claim_status,jv_comm,jv_comm_amt,vat, vat_amt, govt_comm, govt_comm_amt,cancellation_charges) values(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)&quot;);
<span class="nc" id="L228">			PreparedStatement updateRetSaleRetPstmt = con</span>
					.prepareStatement(&quot;update st_cs_refund_? a inner join  st_lms_retailer_transaction_master b on a.transaction_id = b.transaction_id set claim_status='DONE_CLAIM',agent_ref_transaction_id=? where a.retailer_org_id=? and a.product_id =? and retailer_comm=? and agent_comm=? and jv_comm=? and DATE(transaction_date)=? and transaction_type=?&quot;);

<span class="nc" id="L231">			int productId = 0;</span>
<span class="nc" id="L232">			int categoryId = 0;</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">			while (resultGameNbr.next()) {</span>
<span class="nc" id="L234">				categoryId = resultGameNbr.getInt(&quot;category_id&quot;);</span>
<span class="nc" id="L235">				pstmt = con.prepareStatement(saleQry);</span>
<span class="nc" id="L236">				pstmt.setInt(1, categoryId);</span>
<span class="nc" id="L237">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L239">					productId = rs.getInt(&quot;product_id&quot;);</span>
<span class="nc" id="L240">					retOrgId = rs.getInt(&quot;retailer_org_id&quot;);</span>
<span class="nc" id="L241">					agtUserId = rs.getInt(&quot;agtUserId&quot;);</span>
<span class="nc" id="L242">					agtOrgId = rs.getInt(&quot;agtOrgId&quot;);</span>

<span class="nc" id="L244">					totalMrpAmt = rs.getDouble(&quot;totalMrp&quot;);</span>
<span class="nc" id="L245">					totalRetComm = rs.getDouble(&quot;totalRetComm&quot;) * totalMrpAmt</span>
							* 0.01;
<span class="nc" id="L247">					totalAgtComm = rs.getDouble(&quot;totalagtComm&quot;) * totalMrpAmt</span>
							* 0.01;
<span class="nc" id="L249">					totalJVAmt = rs.getDouble(&quot;totalJVComm&quot;) * totalMrpAmt</span>
							* 0.01;
<span class="nc" id="L251">					retCommRate = rs.getDouble(&quot;totalRetComm&quot;);</span>
<span class="nc" id="L252">					agtCommRate = rs.getDouble(&quot;totalagtComm&quot;);</span>
<span class="nc" id="L253">					JVCommRate = rs.getDouble(&quot;totalJVComm&quot;);</span>
<span class="nc" id="L254">					vat = rs.getDouble(&quot;vat&quot;);</span>
<span class="nc" id="L255">					vatAmt = rs.getDouble(&quot;vat_amt&quot;);</span>
<span class="nc" id="L256">					govtComm = rs.getDouble(&quot;govt_comm&quot;);</span>
<span class="nc" id="L257">					govtCommAmt = rs.getDouble(&quot;govt_comm_amt&quot;);</span>
<span class="nc" id="L258">					transDate = rs.getString(&quot;transaction_date&quot;);</span>
<span class="nc" id="L259">					String tranType = rs.getString(&quot;transaction_type&quot;);</span>
<span class="nc" id="L260">					totalretNetAmt = totalMrpAmt - totalRetComm;</span>
<span class="nc" id="L261">					totalAgtNetAmt = totalMrpAmt - totalAgtComm;</span>

<span class="nc bnc" id="L263" title="All 2 branches missed.">					if (orgIdAmountMap.containsKey(retOrgId)) {</span>
<span class="nc" id="L264">						retDebitAmount = orgIdAmountMap.get(retOrgId)</span>
								+ totalretNetAmt;
					} else {
<span class="nc" id="L267">						retDebitAmount = totalretNetAmt;</span>
					}

<span class="nc" id="L270">					orgIdAmountMap.put(retOrgId, retDebitAmount);</span>
<span class="nc" id="L271">					orgIdParentIdMap.put(retOrgId, agtOrgId);</span>

<span class="nc bnc" id="L273" title="All 2 branches missed.">					if (orgIdTransIdInvMap.containsKey(retOrgId)) {</span>
<span class="nc" id="L274">						transIdInvMap = orgIdTransIdInvMap.get(retOrgId);</span>
					} else {
<span class="nc" id="L276">						transIdInvMap = new HashMap&lt;String, List&lt;Long&gt;&gt;();</span>
<span class="nc" id="L277">						orgIdTransIdInvMap.put(retOrgId, transIdInvMap);</span>
					}

					// insert in main transaction table

<span class="nc" id="L282">					pstmtAgt.setString(1, &quot;AGENT&quot;);</span>
<span class="nc" id="L283">					pstmtAgt.executeUpdate();</span>
<span class="nc" id="L284">					ResultSet rsTrns = pstmtAgt.getGeneratedKeys();</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">					if (rsTrns.next()) {</span>
<span class="nc" id="L286">						long transId = rsTrns.getLong(1);</span>
<span class="nc" id="L287">						logger.debug(productId+&quot;--&quot;+retOrgId+&quot;-Retailer Sale ---&quot;+transId+&quot;---&quot;+transDate);</span>
<span class="nc bnc" id="L288" title="All 2 branches missed.">						if (!transIdInvMap.containsKey(transDate)) {</span>
<span class="nc" id="L289">							transIdInvMap.put(transDate,</span>
									new ArrayList&lt;Long&gt;());
						}

<span class="nc" id="L293">						transIdInvMap.get(transDate).add(transId);</span>

<span class="nc" id="L295">						pstmtAgtTrans.setLong(1, transId);</span>
<span class="nc" id="L296">						pstmtAgtTrans.setInt(2, agtUserId);</span>
<span class="nc" id="L297">						pstmtAgtTrans.setInt(3, agtOrgId);</span>
<span class="nc" id="L298">						pstmtAgtTrans.setString(4, &quot;RETAILER&quot;);</span>
<span class="nc" id="L299">						pstmtAgtTrans.setInt(5, retOrgId);</span>
<span class="nc" id="L300">						pstmtAgtTrans.setString(6, &quot;CS_SALE&quot;);</span>
<span class="nc" id="L301">						pstmtAgtTrans.setTimestamp(7,fetchTransTimeStamp(transDate));</span>
<span class="nc" id="L302">						pstmtAgtTrans.executeUpdate();</span>

<span class="nc" id="L304">						insAgtSalePstmt.setLong(1, transId);</span>
<span class="nc" id="L305">						insAgtSalePstmt.setInt(2, agtOrgId);</span>
<span class="nc" id="L306">						insAgtSalePstmt.setInt(3, retOrgId);</span>
<span class="nc" id="L307">						insAgtSalePstmt.setInt(4, productId);</span>
<span class="nc" id="L308">						insAgtSalePstmt.setDouble(5, totalMrpAmt);</span>
<span class="nc" id="L309">						insAgtSalePstmt.setDouble(6, retCommRate);</span>
<span class="nc" id="L310">						insAgtSalePstmt.setDouble(7, totalretNetAmt);</span>
<span class="nc" id="L311">						insAgtSalePstmt.setDouble(8, agtCommRate);</span>
<span class="nc" id="L312">						insAgtSalePstmt.setDouble(9, totalAgtNetAmt);</span>
<span class="nc" id="L313">						insAgtSalePstmt.setString(10, &quot;CLAIM_BAL&quot;);</span>
<span class="nc" id="L314">						insAgtSalePstmt.setDouble(11, JVCommRate);</span>
<span class="nc" id="L315">						insAgtSalePstmt.setDouble(12, totalJVAmt);</span>
<span class="nc" id="L316">						insAgtSalePstmt.setDouble(13, vat);</span>
<span class="nc" id="L317">						insAgtSalePstmt.setDouble(14, vatAmt);</span>
<span class="nc" id="L318">						insAgtSalePstmt.setDouble(15, govtComm);</span>
<span class="nc" id="L319">						insAgtSalePstmt.setDouble(16, govtCommAmt);</span>
<span class="nc" id="L320">						insAgtSalePstmt.executeUpdate();</span>

						// update retailer table

<span class="nc" id="L324">						updateRetSalePstmt.setInt(1, categoryId);</span>
<span class="nc" id="L325">						updateRetSalePstmt.setLong(2, transId); // agent trans</span>
						// Id
<span class="nc" id="L327">						updateRetSalePstmt.setInt(3, retOrgId);</span>
<span class="nc" id="L328">						updateRetSalePstmt.setInt(4, productId);</span>
<span class="nc" id="L329">						updateRetSalePstmt.setDouble(5, retCommRate);</span>
<span class="nc" id="L330">						updateRetSalePstmt.setDouble(6, agtCommRate);</span>
<span class="nc" id="L331">						updateRetSalePstmt.setDouble(7, JVCommRate);</span>
<span class="nc" id="L332">						updateRetSalePstmt.setString(8, transDate);</span>
<span class="nc" id="L333">						updateRetSalePstmt.setString(9, tranType);</span>
<span class="nc" id="L334">						logger.debug(&quot;sale status update qry for retailer: &quot;</span>
								+ updateRetSalePstmt);
<span class="nc" id="L336">						updateRetSalePstmt.executeUpdate();</span>
					}

<span class="nc" id="L339">				}</span>

<span class="nc" id="L341">				pstmt = con.prepareStatement(saleReturnQry);</span>
<span class="nc" id="L342">				pstmt.setInt(1, categoryId);</span>
<span class="nc" id="L343">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L345">					productId = rs.getInt(&quot;product_id&quot;);</span>
<span class="nc" id="L346">					retOrgId = rs.getInt(&quot;retailer_org_id&quot;);</span>
<span class="nc" id="L347">					agtUserId = rs.getInt(&quot;agtUserId&quot;);</span>
<span class="nc" id="L348">					agtOrgId = rs.getInt(&quot;agtOrgId&quot;);</span>

<span class="nc" id="L350">					totalMrpAmt = rs.getDouble(&quot;totalMrp&quot;);</span>
<span class="nc" id="L351">					totalRetComm = rs.getDouble(&quot;totalRetComm&quot;) * totalMrpAmt</span>
							* 0.01;
<span class="nc" id="L353">					totalAgtComm = rs.getDouble(&quot;totalagtComm&quot;) * totalMrpAmt</span>
							* 0.01;
<span class="nc" id="L355">					totalJVAmt = rs.getDouble(&quot;totalJVComm&quot;) * totalMrpAmt</span>
							* 0.01;
<span class="nc" id="L357">					totalCancelCharge = rs.getDouble(&quot;totalCancelCharge&quot;);</span>
<span class="nc" id="L358">					retCommRate = rs.getDouble(&quot;totalRetComm&quot;);</span>
<span class="nc" id="L359">					agtCommRate = rs.getDouble(&quot;totalagtComm&quot;);</span>
<span class="nc" id="L360">					JVCommRate = rs.getDouble(&quot;totalJVComm&quot;);</span>
<span class="nc" id="L361">					vat = rs.getDouble(&quot;vat&quot;);</span>
<span class="nc" id="L362">					vatAmt = rs.getDouble(&quot;vat_amt&quot;);</span>
<span class="nc" id="L363">					govtComm = rs.getDouble(&quot;govt_comm&quot;);</span>
<span class="nc" id="L364">					govtCommAmt = rs.getDouble(&quot;govt_comm_amt&quot;);</span>
<span class="nc" id="L365">					transDate = rs.getString(&quot;transaction_date&quot;);</span>
<span class="nc" id="L366">					totalretNetAmt = totalMrpAmt - totalRetComm</span>
							- totalCancelCharge;
<span class="nc" id="L368">					totalAgtNetAmt = totalMrpAmt - totalAgtComm</span>
							- totalCancelCharge;
<span class="nc" id="L370">					String tranType = rs.getString(&quot;transaction_type&quot;);</span>

<span class="nc bnc" id="L372" title="All 2 branches missed.">					if (orgIdAmountMap.containsKey(retOrgId)) {</span>
<span class="nc" id="L373">						retDebitAmount = orgIdAmountMap.get(retOrgId)</span>
								- totalretNetAmt;
					} else {
<span class="nc" id="L376">						retDebitAmount = totalretNetAmt;</span>
					}

<span class="nc" id="L379">					orgIdAmountMap.put(retOrgId, retDebitAmount);</span>
<span class="nc" id="L380">					orgIdParentIdMap.put(retOrgId, agtOrgId);</span>

<span class="nc bnc" id="L382" title="All 2 branches missed.">					if (orgIdTransIdInvRetMap.containsKey(retOrgId)) {</span>
<span class="nc" id="L383">						transIdInvRetMap = orgIdTransIdInvRetMap.get(retOrgId);</span>
					} else {
<span class="nc" id="L385">						transIdInvRetMap = new HashMap&lt;String, List&lt;Long&gt;&gt;();</span>
<span class="nc" id="L386">						orgIdTransIdInvRetMap.put(retOrgId, transIdInvRetMap);</span>
					}

					// insert in main transaction table

<span class="nc" id="L391">					pstmtAgt.setString(1, &quot;AGENT&quot;);</span>
<span class="nc" id="L392">					pstmtAgt.executeUpdate();</span>
<span class="nc" id="L393">					ResultSet rsTrns = pstmtAgt.getGeneratedKeys();</span>
<span class="nc bnc" id="L394" title="All 2 branches missed.">					if (rsTrns.next()) {</span>
<span class="nc" id="L395">						long transId = rsTrns.getLong(1);</span>
<span class="nc" id="L396">						logger.debug(productId+&quot;--&quot;+retOrgId+&quot;-Retailer cancel ---&quot;+transId+&quot;---&quot;+transDate);</span>
<span class="nc bnc" id="L397" title="All 2 branches missed.">						if (!transIdInvRetMap.containsKey(transDate)) {</span>
<span class="nc" id="L398">							transIdInvRetMap.put(transDate,</span>
									new ArrayList&lt;Long&gt;());
						}

<span class="nc" id="L402">						transIdInvRetMap.get(transDate).add(transId);</span>

<span class="nc" id="L404">						pstmtAgtTrans.setLong(1, transId);</span>
<span class="nc" id="L405">						pstmtAgtTrans.setInt(2, agtUserId);</span>
<span class="nc" id="L406">						pstmtAgtTrans.setInt(3, agtOrgId);</span>
<span class="nc" id="L407">						pstmtAgtTrans.setString(4, &quot;RETAILER&quot;);</span>
<span class="nc" id="L408">						pstmtAgtTrans.setInt(5, retOrgId);</span>
<span class="nc" id="L409">						pstmtAgtTrans.setString(6, tranType);</span>
<span class="nc" id="L410">						pstmtAgtTrans.setTimestamp(7,</span>
								fetchTransTimeStamp(transDate));
<span class="nc" id="L412">						pstmtAgtTrans.executeUpdate();</span>

<span class="nc" id="L414">						insAgtSaleRetPstmt.setLong(1, transId);</span>
<span class="nc" id="L415">						insAgtSaleRetPstmt.setInt(2, agtOrgId);</span>
<span class="nc" id="L416">						insAgtSaleRetPstmt.setInt(3, retOrgId);</span>
<span class="nc" id="L417">						insAgtSaleRetPstmt.setInt(4, productId);</span>
<span class="nc" id="L418">						insAgtSaleRetPstmt.setDouble(5, totalMrpAmt);</span>
<span class="nc" id="L419">						insAgtSaleRetPstmt.setDouble(6, retCommRate);</span>
<span class="nc" id="L420">						insAgtSaleRetPstmt.setDouble(7, totalretNetAmt); // net</span>
						// amt
<span class="nc" id="L422">						insAgtSaleRetPstmt.setDouble(8, agtCommRate);</span>
<span class="nc" id="L423">						insAgtSaleRetPstmt.setDouble(9, totalAgtNetAmt); // bo</span>
						// net
						// amt
<span class="nc" id="L426">						insAgtSaleRetPstmt.setString(10, &quot;CLAIM_BAL&quot;);</span>
<span class="nc" id="L427">						insAgtSaleRetPstmt.setDouble(11, JVCommRate);</span>
<span class="nc" id="L428">						insAgtSaleRetPstmt.setDouble(12, totalJVAmt);</span>
<span class="nc" id="L429">						insAgtSaleRetPstmt.setDouble(13, vat);</span>
<span class="nc" id="L430">						insAgtSaleRetPstmt.setDouble(14, vatAmt);</span>
<span class="nc" id="L431">						insAgtSaleRetPstmt.setDouble(15, govtComm);</span>
<span class="nc" id="L432">						insAgtSaleRetPstmt.setDouble(16, govtCommAmt);</span>
<span class="nc" id="L433">						insAgtSaleRetPstmt.setDouble(17, totalCancelCharge);</span>
<span class="nc" id="L434">						insAgtSaleRetPstmt.executeUpdate();</span>

						// update retailer table
<span class="nc" id="L437">						updateRetSaleRetPstmt.setInt(1, categoryId);</span>
<span class="nc" id="L438">						updateRetSaleRetPstmt.setLong(2, transId); // agent</span>
						// trans Id
<span class="nc" id="L440">						updateRetSaleRetPstmt.setInt(3, retOrgId);</span>
<span class="nc" id="L441">						updateRetSaleRetPstmt.setInt(4, productId);</span>
<span class="nc" id="L442">						updateRetSaleRetPstmt.setDouble(5, retCommRate);</span>
<span class="nc" id="L443">						updateRetSaleRetPstmt.setDouble(6, agtCommRate);</span>
<span class="nc" id="L444">						updateRetSaleRetPstmt.setDouble(7, JVCommRate);</span>
<span class="nc" id="L445">						updateRetSaleRetPstmt.setString(8, transDate);</span>
<span class="nc" id="L446">						updateRetSaleRetPstmt.setString(9, tranType);</span>
<span class="nc" id="L447">						logger</span>
								.debug(&quot;sale Ref status update qry for retailer: &quot;
										+ updateRetSaleRetPstmt);
<span class="nc" id="L450">						updateRetSaleRetPstmt.executeUpdate();</span>
					}

<span class="nc" id="L453">				}</span>
			}

<span class="nc" id="L456">			generateDGReceiptNew(orgIdTransIdInvMap, orgIdParentIdMap,</span>
					&quot;CS_INVOICE&quot;, &quot;CS_RECEIPT&quot;, con);
<span class="nc" id="L458">			generateDGReceiptNew(orgIdTransIdInvRetMap, orgIdParentIdMap,</span>
					&quot;CR_NOTE&quot;, &quot;CR_NOTE_CASH&quot;, con);

<span class="nc" id="L461">			logger.debug(&quot;retailer orgIdAmountMap\n&quot; + orgIdAmountMap);</span>
			// update retailer balance
<span class="nc" id="L463">			Set&lt;Integer&gt; retOrgIdSet = orgIdAmountMap.keySet();</span>
<span class="nc bnc" id="L464" title="All 2 branches missed.">			for (Integer orgId : retOrgIdSet) {</span>
				
<span class="nc" id="L466">				boolean isValid=OrgCreditUpdation.updateOrganizationBalWithValidate(orgIdAmountMap.get(orgId), &quot;TRANSACTION&quot;, &quot;CS_SALE&quot;, orgId,</span>
						orgIdParentIdMap.get(orgId), &quot;RETAILER&quot;, 0, con);
<span class="nc bnc" id="L468" title="All 2 branches missed.">				if(!isValid)</span>
<span class="nc" id="L469">					throw new LMSException();</span>
					
<span class="nc" id="L471">				OrgCreditUpdation.updateOrganizationBalWithValidate(orgIdAmountMap.get(orgId), &quot;CLAIM_BAL&quot;, &quot;DEBIT&quot;, orgId,</span>
						orgIdParentIdMap.get(orgId), &quot;RETAILER&quot;, 0, con);
				
				
				/*OrgCreditUpdation.updateCreditLimitForRetailer(orgId,
						&quot;CS_SALE&quot;, orgIdAmountMap.get(orgId), con);
				updateOrgBalance(&quot;CLAIM_BAL&quot;, orgIdAmountMap.get(orgId), orgId,
						&quot;DEBIT&quot;, con);*/
<span class="nc" id="L479">			}</span>
<span class="nc" id="L480">		} catch (Exception e) {</span>
<span class="nc" id="L481">			e.printStackTrace();</span>
<span class="nc" id="L482">			throw new LMSException(&quot;error in sale retailer&quot;);</span>
<span class="nc" id="L483">		}</span>
<span class="nc" id="L484">		logger.debug(new Date() + &quot;---end-cs sale update for retailer--&quot;</span>
				+ new Date().getTime());
<span class="nc" id="L486">	}</span>

	public void updateCSSaleLedgerForAgt(Connection con) throws Exception {

<span class="nc" id="L490">		logger.debug(new Date() + &quot;---start-cs sale update for agent--&quot;</span>
				+ new Date().getTime());
<span class="nc" id="L492">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L493">		ResultSet rs = null;</span>
		double totalMrpAmt, totalAgtComm, totalJVComm, totalAgtNetAmt, vatAmt, govtCommAmt, totalCancelCharge;
		double agtCommRate, JVCommRate, agtDebitAmount, vat, govtComm;
		String transDate;
		int agtOrgId, boUserId, boOrgId;
<span class="nc" id="L498">		Map&lt;Integer, Double&gt; orgIdAmountMap = new HashMap&lt;Integer, Double&gt;();</span>
<span class="nc" id="L499">		Map&lt;Integer, Integer&gt; orgIdParentIdMap = new HashMap&lt;Integer, Integer&gt;();</span>
<span class="nc" id="L500">		Map&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt; orgIdTransIdInvMap = new HashMap&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt;();</span>
<span class="nc" id="L501">		Map&lt;String, List&lt;Long&gt;&gt; transIdInvMap = null;</span>
<span class="nc" id="L502">		Map&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt; orgIdTransIdInvRetMap = new HashMap&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt;();</span>
<span class="nc" id="L503">		Map&lt;String, List&lt;Long&gt;&gt; transIdInvRetMap = null;</span>
		try {
<span class="nc" id="L505">			String saleQry = &quot;select agent_org_id,boUserId,boOrgId,totalMrp,totalRetComm,totalagtComm,totalgovtComm,totalVat,totalJVComm,vat, govt_comm,product_id,transaction_date,transaction_type from(select a.agent_org_id,sum(mrp_amt) totalMrp ,retailer_comm totalRetComm,agent_comm totalagtComm, govt_comm_amt totalgovtComm, vat_amt totalVat, jv_comm totalJVComm, vat, govt_comm, a.product_id,transaction_type,DATE(transaction_date) 'transaction_date' from st_cs_agt_sale a inner join  st_lms_agent_transaction_master b on a.transaction_id = b.transaction_id where claim_status='CLAIM_BAL' group by a.agent_org_id,DATE(transaction_date),a.product_id,agent_comm,jv_comm  order by agent_org_id,product_id,transaction_date) sale inner join (select um.user_id agtUserId,um.organization_id agtOrgId,um.parent_user_id boUserId,om.parent_id boOrgId,isrolehead from st_lms_organization_master om inner join st_lms_user_master um on om.organization_id=um.organization_id where om.organization_type='AGENT') om on agent_org_id=agtOrgId and isrolehead = 'Y'&quot;;</span>
<span class="nc" id="L506">			String saleReturnQry = &quot;select agent_org_id,boUserId,boOrgId,totalMrp,totalRetComm,totalagtComm,totalgovtComm,totalVat,totalJVComm,vat, govt_comm,product_id,transaction_date,transaction_type,totalCancelCharge from(select a.agent_org_id,sum(mrp_amt) totalMrp ,retailer_comm totalRetComm,agent_comm totalagtComm, govt_comm_amt totalgovtComm, vat_amt totalVat, jv_comm totalJVComm, vat, govt_comm, a.product_id,transaction_type,DATE(transaction_date) 'transaction_date',cancellation_charges totalCancelCharge from st_cs_agt_refund a inner join  st_lms_agent_transaction_master b on a.transaction_id = b.transaction_id where claim_status='CLAIM_BAL' group by a.agent_org_id,DATE(transaction_date),a.product_id,agent_comm  order by agent_org_id,product_id,transaction_date) sale inner join (select um.user_id agtUserId,um.organization_id agtOrgId,um.parent_user_id boUserId,om.parent_id boOrgId,isrolehead from st_lms_organization_master om inner join st_lms_user_master um on om.organization_id=um.organization_id where om.organization_type='AGENT') om on agent_org_id=agtOrgId and isrolehead = 'Y'&quot;;</span>

<span class="nc" id="L508">			PreparedStatement pstmtBO = con.prepareStatement(QueryManager</span>
					.insertInLMSTransactionMaster());
<span class="nc" id="L510">			PreparedStatement insBoTranPstmt = con</span>
					.prepareStatement(QueryManager
							.insertInBOTransactionMaster());
<span class="nc" id="L513">			PreparedStatement insBoSalePstmt = con</span>
					.prepareStatement(&quot;insert into st_cs_bo_sale(transaction_id,agent_org_id,product_id,mrp_amt,agent_comm,net_amt,jv_comm,jv_comm_amt, vat, vat_amt, govt_comm, govt_comm_amt) values(?,?,?,?,?,?,?,?,?,?,?,?)&quot;);
<span class="nc" id="L515">			PreparedStatement updAgtSalepstmt = con</span>
					.prepareStatement(&quot;update st_cs_agt_sale a inner join  st_lms_agent_transaction_master b on a.transaction_id = b.transaction_id set claim_status='DONE_CLAIM',bo_ref_transaction_id=? where a.agent_org_id=? and a.product_id =? and agent_comm=? and jv_comm=? and DATE(transaction_date)=? and transaction_type=?&quot;);
<span class="nc" id="L517">			PreparedStatement insBoSaleRetpstmt = con</span>
					.prepareStatement(&quot;insert into st_cs_bo_refund(transaction_id,agent_org_id,product_id,mrp_amt,agent_comm,net_amt,jv_comm,jv_comm_amt, vat, vat_amt,govt_comm,govt_comm_amt,cancellation_charges) values(?,?,?,?,?,?,?,?,?,?,?,?,?)&quot;);
<span class="nc" id="L519">			PreparedStatement updAgtSaleRetPstmt = con</span>
					.prepareStatement(&quot;update st_cs_agt_refund a inner join  st_lms_agent_transaction_master b on a.transaction_id = b.transaction_id set claim_status='DONE_CLAIM',bo_ref_transaction_id=? where a.agent_org_id=? and a.product_id =? and agent_comm=? and jv_comm=? and DATE(transaction_date)=? and transaction_type=?&quot;);

<span class="nc" id="L522">			int productId = 0;</span>

<span class="nc" id="L524">			pstmt = con.prepareStatement(saleQry);</span>
<span class="nc" id="L525">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L526" title="All 2 branches missed.">			while (rs.next()) {</span>

<span class="nc" id="L528">				agtOrgId = rs.getInt(&quot;agent_org_id&quot;);</span>
<span class="nc" id="L529">				boUserId = rs.getInt(&quot;boUserId&quot;);</span>
<span class="nc" id="L530">				boOrgId = rs.getInt(&quot;boOrgId&quot;);</span>
<span class="nc" id="L531">				productId = rs.getInt(&quot;product_id&quot;);</span>
<span class="nc" id="L532">				totalMrpAmt = rs.getDouble(&quot;totalMrp&quot;);</span>
<span class="nc" id="L533">				agtCommRate = rs.getDouble(&quot;totalagtComm&quot;);</span>
<span class="nc" id="L534">				totalAgtComm = rs.getDouble(&quot;totalagtComm&quot;) * totalMrpAmt</span>
						* 0.01;
<span class="nc" id="L536">				totalJVComm = rs.getDouble(&quot;totalJVComm&quot;) * totalMrpAmt * 0.01;</span>
<span class="nc" id="L537">				JVCommRate = rs.getDouble(&quot;totalJVComm&quot;);</span>
<span class="nc" id="L538">				govtComm = rs.getDouble(&quot;govt_comm&quot;);</span>
<span class="nc" id="L539">				govtCommAmt = rs.getDouble(&quot;totalgovtComm&quot;);</span>
<span class="nc" id="L540">				vat = rs.getDouble(&quot;vat&quot;);</span>
<span class="nc" id="L541">				vatAmt = rs.getDouble(&quot;totalVat&quot;);</span>
<span class="nc" id="L542">				String tranType = rs.getString(&quot;transaction_type&quot;);</span>
<span class="nc" id="L543">				transDate = rs.getString(&quot;transaction_date&quot;);</span>

<span class="nc" id="L545">				totalAgtNetAmt = totalMrpAmt - totalAgtComm;</span>

<span class="nc bnc" id="L547" title="All 2 branches missed.">				if (orgIdAmountMap.containsKey(agtOrgId)) {</span>
<span class="nc" id="L548">					agtDebitAmount = orgIdAmountMap.get(agtOrgId)</span>
							+ totalAgtNetAmt;
				} else {
<span class="nc" id="L551">					agtDebitAmount = totalAgtNetAmt;</span>
				}

<span class="nc" id="L554">				orgIdAmountMap.put(agtOrgId, agtDebitAmount);</span>
<span class="nc" id="L555">				orgIdParentIdMap.put(agtOrgId, boOrgId);</span>

<span class="nc bnc" id="L557" title="All 2 branches missed.">				if (orgIdTransIdInvMap.containsKey(agtOrgId)) {</span>
<span class="nc" id="L558">					transIdInvMap = orgIdTransIdInvMap.get(agtOrgId);</span>
				} else {
<span class="nc" id="L560">					transIdInvMap = new HashMap&lt;String, List&lt;Long&gt;&gt;();</span>
<span class="nc" id="L561">					orgIdTransIdInvMap.put(agtOrgId, transIdInvMap);</span>
				}

				// insert in main transaction table

<span class="nc" id="L566">				pstmtBO.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L567">				pstmtBO.executeUpdate();</span>
<span class="nc" id="L568">				ResultSet rsTrns = pstmtBO.getGeneratedKeys();</span>
<span class="nc bnc" id="L569" title="All 2 branches missed.">				if (rsTrns.next()) {</span>
<span class="nc" id="L570">					long transId = rsTrns.getLong(1);</span>
<span class="nc" id="L571">					logger.debug(productId+&quot;--&quot;+agtOrgId+&quot;-Agent Sale ---&quot;+transId+&quot;---&quot;+transDate);</span>
<span class="nc bnc" id="L572" title="All 2 branches missed.">					if (!transIdInvMap.containsKey(transDate)) {</span>
<span class="nc" id="L573">						transIdInvMap.put(transDate, new ArrayList&lt;Long&gt;());</span>
					}

<span class="nc" id="L576">					transIdInvMap.get(transDate).add(transId);</span>

<span class="nc" id="L578">					insBoTranPstmt.setLong(1, transId);</span>
<span class="nc" id="L579">					insBoTranPstmt.setInt(2, boUserId);</span>
<span class="nc" id="L580">					insBoTranPstmt.setInt(3, boOrgId);</span>
<span class="nc" id="L581">					insBoTranPstmt.setString(4, &quot;AGENT&quot;);</span>
<span class="nc" id="L582">					insBoTranPstmt.setInt(5, agtOrgId);</span>
<span class="nc" id="L583">					insBoTranPstmt.setTimestamp(6,</span>
							fetchTransTimeStamp(transDate));
<span class="nc" id="L585">					insBoTranPstmt.setString(7, &quot;CS_SALE&quot;);</span>
<span class="nc" id="L586">					insBoTranPstmt.executeUpdate();</span>

<span class="nc" id="L588">					insBoSalePstmt.setLong(1, transId);</span>
<span class="nc" id="L589">					insBoSalePstmt.setInt(2, agtOrgId);</span>
<span class="nc" id="L590">					insBoSalePstmt.setInt(3, productId);</span>
<span class="nc" id="L591">					insBoSalePstmt.setDouble(4, totalMrpAmt);</span>
<span class="nc" id="L592">					insBoSalePstmt.setDouble(5, agtCommRate);</span>
<span class="nc" id="L593">					insBoSalePstmt.setDouble(6, totalAgtNetAmt);</span>
<span class="nc" id="L594">					insBoSalePstmt.setDouble(7, JVCommRate);</span>
<span class="nc" id="L595">					insBoSalePstmt.setDouble(8, totalJVComm);</span>
<span class="nc" id="L596">					insBoSalePstmt.setDouble(9, vat);</span>
<span class="nc" id="L597">					insBoSalePstmt.setDouble(10, vatAmt);</span>
<span class="nc" id="L598">					insBoSalePstmt.setDouble(11, govtComm);</span>
<span class="nc" id="L599">					insBoSalePstmt.setDouble(12, govtCommAmt);</span>
<span class="nc" id="L600">					insBoSalePstmt.executeUpdate();</span>

					// update agent table
<span class="nc" id="L603">					updAgtSalepstmt.setLong(1, transId); // agent trans Id</span>
<span class="nc" id="L604">					updAgtSalepstmt.setInt(2, agtOrgId);</span>
<span class="nc" id="L605">					updAgtSalepstmt.setInt(3, productId);</span>
<span class="nc" id="L606">					updAgtSalepstmt.setDouble(4, agtCommRate);</span>
<span class="nc" id="L607">					updAgtSalepstmt.setDouble(5, JVCommRate);</span>
<span class="nc" id="L608">					updAgtSalepstmt.setString(6, transDate);</span>
<span class="nc" id="L609">					updAgtSalepstmt.setString(7, tranType);</span>
<span class="nc" id="L610">					logger.debug(&quot;sale status update qry for agent: &quot;</span>
							+ updAgtSalepstmt);
<span class="nc" id="L612">					updAgtSalepstmt.executeUpdate();</span>
				}

<span class="nc" id="L615">			}</span>

<span class="nc" id="L617">			pstmt = con.prepareStatement(saleReturnQry);</span>
<span class="nc" id="L618">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L619" title="All 2 branches missed.">			while (rs.next()) {</span>

<span class="nc" id="L621">				agtOrgId = rs.getInt(&quot;agent_org_id&quot;);</span>
<span class="nc" id="L622">				boUserId = rs.getInt(&quot;boUserId&quot;);</span>
<span class="nc" id="L623">				boOrgId = rs.getInt(&quot;boOrgId&quot;);</span>
<span class="nc" id="L624">				productId = rs.getInt(&quot;product_id&quot;);</span>
<span class="nc" id="L625">				totalMrpAmt = rs.getDouble(&quot;totalMrp&quot;);</span>
<span class="nc" id="L626">				agtCommRate = rs.getDouble(&quot;totalagtComm&quot;);</span>
<span class="nc" id="L627">				totalAgtComm = rs.getDouble(&quot;totalagtComm&quot;) * totalMrpAmt</span>
						* 0.01;
<span class="nc" id="L629">				totalJVComm = rs.getDouble(&quot;totalJVComm&quot;) * totalMrpAmt * 0.01;</span>
<span class="nc" id="L630">				JVCommRate = rs.getDouble(&quot;totalJVComm&quot;);</span>
<span class="nc" id="L631">				govtComm = rs.getDouble(&quot;govt_comm&quot;);</span>
<span class="nc" id="L632">				govtCommAmt = rs.getDouble(&quot;totalgovtComm&quot;);</span>
<span class="nc" id="L633">				vat = rs.getDouble(&quot;vat&quot;);</span>
<span class="nc" id="L634">				vatAmt = rs.getDouble(&quot;totalVat&quot;);</span>
<span class="nc" id="L635">				String tranType = rs.getString(&quot;transaction_type&quot;);</span>
<span class="nc" id="L636">				totalCancelCharge = rs.getDouble(&quot;totalCancelCharge&quot;);</span>
<span class="nc" id="L637">				transDate = rs.getString(&quot;transaction_date&quot;);</span>

<span class="nc" id="L639">				totalAgtNetAmt = totalMrpAmt - totalAgtComm - totalCancelCharge;</span>

<span class="nc bnc" id="L641" title="All 2 branches missed.">				if (orgIdAmountMap.containsKey(agtOrgId)) {</span>
<span class="nc" id="L642">					agtDebitAmount = orgIdAmountMap.get(agtOrgId)</span>
							- totalAgtNetAmt;
				} else {
<span class="nc" id="L645">					agtDebitAmount = totalAgtNetAmt;</span>
				}

<span class="nc" id="L648">				orgIdAmountMap.put(agtOrgId, agtDebitAmount);</span>
<span class="nc" id="L649">				orgIdParentIdMap.put(agtOrgId, boOrgId);</span>

<span class="nc bnc" id="L651" title="All 2 branches missed.">				if (orgIdTransIdInvRetMap.containsKey(agtOrgId)) {</span>
<span class="nc" id="L652">					transIdInvRetMap = orgIdTransIdInvRetMap.get(agtOrgId);</span>
				} else {
<span class="nc" id="L654">					transIdInvRetMap = new HashMap&lt;String, List&lt;Long&gt;&gt;();</span>
<span class="nc" id="L655">					orgIdTransIdInvRetMap.put(agtOrgId, transIdInvRetMap);</span>
				}

				// insert in main transaction table

<span class="nc" id="L660">				pstmtBO.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L661">				pstmtBO.executeUpdate();</span>
<span class="nc" id="L662">				ResultSet rsTrns = pstmtBO.getGeneratedKeys();</span>
<span class="nc bnc" id="L663" title="All 2 branches missed.">				if (rsTrns.next()) {</span>
<span class="nc" id="L664">					long transId = rsTrns.getLong(1);</span>
<span class="nc" id="L665">					logger.debug(productId+&quot;--&quot;+agtOrgId+&quot;-Agent Cancel ---&quot;+transId+&quot;---&quot;+transDate);</span>
<span class="nc bnc" id="L666" title="All 2 branches missed.">					if (!transIdInvRetMap.containsKey(transDate)) {</span>
<span class="nc" id="L667">						transIdInvRetMap.put(transDate,</span>
								new ArrayList&lt;Long&gt;());
					}

<span class="nc" id="L671">					transIdInvRetMap.get(transDate).add(transId);</span>

<span class="nc" id="L673">					insBoTranPstmt.setLong(1, transId);</span>
<span class="nc" id="L674">					insBoTranPstmt.setInt(2, boUserId);</span>
<span class="nc" id="L675">					insBoTranPstmt.setInt(3, boOrgId);</span>
<span class="nc" id="L676">					insBoTranPstmt.setString(4, &quot;AGENT&quot;);</span>
<span class="nc" id="L677">					insBoTranPstmt.setInt(5, agtOrgId);</span>
<span class="nc" id="L678">					insBoTranPstmt.setTimestamp(6,</span>
							fetchTransTimeStamp(transDate));
<span class="nc" id="L680">					insBoTranPstmt.setString(7, tranType);</span>
<span class="nc" id="L681">					insBoTranPstmt.executeUpdate();</span>

<span class="nc" id="L683">					insBoSaleRetpstmt.setLong(1, transId);</span>
<span class="nc" id="L684">					insBoSaleRetpstmt.setInt(2, agtOrgId);</span>
<span class="nc" id="L685">					insBoSaleRetpstmt.setInt(3, productId);</span>
<span class="nc" id="L686">					insBoSaleRetpstmt.setDouble(4, totalMrpAmt);</span>
<span class="nc" id="L687">					insBoSaleRetpstmt.setDouble(5, agtCommRate);</span>
<span class="nc" id="L688">					insBoSaleRetpstmt.setDouble(6, totalAgtNetAmt);</span>
<span class="nc" id="L689">					insBoSaleRetpstmt.setDouble(7, JVCommRate);</span>
<span class="nc" id="L690">					insBoSaleRetpstmt.setDouble(8, totalJVComm);</span>
<span class="nc" id="L691">					insBoSaleRetpstmt.setDouble(9, vat);</span>
<span class="nc" id="L692">					insBoSaleRetpstmt.setDouble(10, vatAmt);</span>
<span class="nc" id="L693">					insBoSaleRetpstmt.setDouble(11, govtComm);</span>
<span class="nc" id="L694">					insBoSaleRetpstmt.setDouble(12, govtCommAmt);</span>
<span class="nc" id="L695">					insBoSaleRetpstmt.setDouble(13, totalCancelCharge);</span>
<span class="nc" id="L696">					insBoSaleRetpstmt.executeUpdate();</span>

					// update agent table
<span class="nc" id="L699">					updAgtSaleRetPstmt.setLong(1, transId); // agent trans Id</span>
<span class="nc" id="L700">					updAgtSaleRetPstmt.setInt(2, agtOrgId);</span>
<span class="nc" id="L701">					updAgtSaleRetPstmt.setInt(3, productId);</span>
<span class="nc" id="L702">					updAgtSaleRetPstmt.setDouble(4, agtCommRate);</span>
<span class="nc" id="L703">					updAgtSaleRetPstmt.setDouble(5, JVCommRate);</span>
<span class="nc" id="L704">					updAgtSaleRetPstmt.setString(6, transDate);</span>
<span class="nc" id="L705">					updAgtSaleRetPstmt.setString(7, tranType);</span>
<span class="nc" id="L706">					logger.debug(&quot;sale return status update qry for agent: &quot;</span>
							+ updAgtSaleRetPstmt);
<span class="nc" id="L708">					updAgtSaleRetPstmt.executeUpdate();</span>
				}

<span class="nc" id="L711">			}</span>

<span class="nc" id="L713">			generateDGReceiptForBONew(orgIdTransIdInvMap, orgIdParentIdMap,</span>
					&quot;CS_INVOICE&quot;, &quot;CS_RECEIPT&quot;, con);
<span class="nc" id="L715">			generateDGReceiptForBONew(orgIdTransIdInvRetMap, orgIdParentIdMap,</span>
					&quot;CR_NOTE&quot;, &quot;CR_NOTE_CASH&quot;, con);

<span class="nc" id="L718">			logger.debug(&quot;agent orgIdAmountMap\n&quot; + orgIdAmountMap);</span>
			// update agent balance
<span class="nc" id="L720">			Set&lt;Integer&gt; agtOrgIdSet = orgIdAmountMap.keySet();</span>
<span class="nc bnc" id="L721" title="All 2 branches missed.">			for (Integer orgId : agtOrgIdSet) {</span>
				
<span class="nc" id="L723">					boolean isValid=OrgCreditUpdation.updateOrganizationBalWithValidate(orgIdAmountMap.get(orgId), &quot;TRANSACTION&quot;, &quot;CS_SALE&quot;, orgId,</span>
						0, &quot;AGENT&quot;, 0, con);
<span class="nc bnc" id="L725" title="All 2 branches missed.">				if(!isValid)</span>
<span class="nc" id="L726">					throw new LMSException();</span>
<span class="nc" id="L727">				OrgCreditUpdation.updateOrganizationBalWithValidate(orgIdAmountMap.get(orgId), &quot;CLAIM_BAL&quot;, &quot;DEBIT&quot;, orgId,</span>
						0, &quot;AGENT&quot;, 0, con);
					/*OrgCreditUpdation.updateCreditLimitForAgent(orgId, &quot;CS_SALE&quot;,
						orgIdAmountMap.get(orgId), con);*/
				/*updateOrgBalance(&quot;CLAIM_BAL&quot;, orgIdAmountMap.get(orgId), orgId,
						&quot;DEBIT&quot;, con);*/
<span class="nc" id="L733">			}</span>
<span class="nc" id="L734">		} catch (Exception e) {</span>
<span class="nc" id="L735">			e.printStackTrace();</span>
<span class="nc" id="L736">			throw new LMSException(&quot;error in sale agent&quot;);</span>
<span class="nc" id="L737">		}</span>
<span class="nc" id="L738">		logger.debug(new Date() + &quot;---end-cs sale update for agent--&quot;</span>
				+ new Date().getTime());

<span class="nc" id="L741">	}</span>

	public static Timestamp fetchTransTimeStamp(String transDate)
			throws ParseException {

<span class="nc" id="L746">		String curDate = (new SimpleDateFormat(&quot;yyyy-MM-dd&quot;))</span>
				.format((new Timestamp((new Date()).getTime())));

<span class="nc bnc" id="L749" title="All 2 branches missed.">		if (transDate.equals(curDate)) {</span>
<span class="nc" id="L750">			return new java.sql.Timestamp(new java.util.Date().getTime());</span>
		} else {
<span class="nc" id="L752">			transDate = transDate + &quot; 23:30:00&quot;;</span>
<span class="nc" id="L753">			return new Timestamp((new SimpleDateFormat(&quot;yyyy-MM-dd hh:mm:ss&quot;))</span>
					.parse(transDate).getTime());
		}

	}

	public void fillTempDGTransCommTlbForRet(Connection con)
			throws LMSException {
<span class="nc" id="L761">		logger.debug(new Date() + &quot;---start---&quot; + new Date().getTime());</span>

<span class="nc" id="L763">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L764">		ResultSet rs = null;</span>
		try {
<span class="nc" id="L766">			con.prepareStatement(&quot;truncate table st_temp_update_ledger&quot;)</span>
					.executeUpdate();

<span class="nc" id="L769">			String gameQry = &quot;select game_id from st_dg_game_master&quot;;</span>
<span class="nc" id="L770">			pstmt = con.prepareStatement(gameQry);</span>
<span class="nc" id="L771">			rs = pstmt.executeQuery();</span>
			//int transId = 0;
<span class="nc" id="L773">			long transId=0;</span>
<span class="nc" id="L774">			int gameId = 0;</span>
<span class="nc" id="L775">			int orgId = 0;</span>
<span class="nc" id="L776">			int parentId = 0;</span>
<span class="nc" id="L777">			long transDate = 0;</span>
			double retComm, agtComm, govtComm;
<span class="nc" id="L779">			Statement stmt = con.createStatement();</span>
<span class="nc bnc" id="L780" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L781">				int count = 0;</span>
<span class="nc" id="L782">				gameId = rs.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L783">				StringBuilder sb = new StringBuilder(</span>
						&quot;insert into st_temp_update_ledger (trans_id, ret_comm, agt_comm, govt_comm) values&quot;);

<span class="nc" id="L786">				String transQry = &quot;select sale.transaction_id,sale.game_id ,transaction_date,sale.retailer_org_id,parent_id from st_lms_retailer_transaction_master tm inner join st_lms_organization_master om inner join st_dg_ret_sale_&quot;</span>
						+ gameId
						+ &quot; sale on tm.retailer_org_id=om.organization_id and tm.transaction_id=sale.transaction_id  where claim_status in('CLAIM_BAL') union all select sale.transaction_id,sale.game_id ,transaction_date,sale.retailer_org_id,parent_id from st_lms_retailer_transaction_master tm inner join st_lms_organization_master om inner join st_dg_ret_sale_refund_&quot;
						+ gameId
						+ &quot; sale on tm.retailer_org_id=om.organization_id and tm.transaction_id=sale.transaction_id  where claim_status in('CLAIM_BAL')&quot;;
<span class="nc" id="L791">				PreparedStatement traStmt = con.prepareStatement(transQry);</span>
<span class="nc" id="L792">				ResultSet tranRs = traStmt.executeQuery();</span>
<span class="nc" id="L793">				gameQry = &quot;select * from (select game_id,sum(retailer_sale_comm_rate) ret_comm,sum(agent_sale_comm_rate) agt_comm,sum(govt_comm) govt_comm,now() date from (select game_id,retailer_sale_comm_rate,agent_sale_comm_rate,govt_comm from st_dg_game_master where game_id=&quot;</span>
						+ gameId
						+ &quot; union all select game_id,sale_comm_variance,0,0 from st_dg_agent_retailer_sale_pwt_comm_variance where retailer_org_id=? and game_id=&quot;
						+ gameId
						+ &quot; union all select game_id,0,sale_comm_variance,0 from st_dg_bo_agent_sale_pwt_comm_variance where agent_org_id=? and game_id=&quot;
						+ gameId
						+ &quot;) aa group by game_id union all select gm.game_id,retailer_sale_comm_rate+sale_comm_variance retComm,0 agtComm,0 govtComm,date_changed from st_dg_agent_retailer_sale_comm_variance_history his inner join st_dg_game_master gm on his.game_id=gm.game_id where retialer_org_id=? and gm.game_id=&quot;
						+ gameId
						+ &quot; union all select gm.game_id,0,agent_sale_comm_rate+sale_comm_variance agtComm,0,date_changed from st_dg_bo_agent_sale_comm_variance_history his inner join st_dg_game_master gm on his.game_id=gm.game_id where agent_org_id=? and gm.game_id=&quot;
						+ gameId
						+ &quot; union all select game_id,0,0,govt_comm_rate,date_changed from st_dg_game_govt_comm_history where game_id=&quot;
						+ gameId + &quot;) aa order by date desc&quot;;
<span class="nc" id="L805">				PreparedStatement gameStmt = con.prepareStatement(gameQry);</span>

<span class="nc bnc" id="L807" title="All 2 branches missed.">				while (tranRs.next()) {</span>
<span class="nc" id="L808">					transId = tranRs.getLong(&quot;transaction_id&quot;);</span>
<span class="nc" id="L809">					orgId = tranRs.getInt(&quot;retailer_org_id&quot;);</span>
<span class="nc" id="L810">					parentId = tranRs.getInt(&quot;parent_id&quot;);</span>
<span class="nc" id="L811">					transDate = tranRs.getTimestamp(&quot;transaction_date&quot;)</span>
							.getTime();
<span class="nc" id="L813">					gameStmt.setInt(1, orgId);</span>
<span class="nc" id="L814">					gameStmt.setInt(2, parentId);</span>
<span class="nc" id="L815">					gameStmt.setInt(3, orgId);</span>
<span class="nc" id="L816">					gameStmt.setInt(4, parentId);</span>
<span class="nc" id="L817">					ResultSet gameRs = gameStmt.executeQuery();</span>
<span class="nc" id="L818">					retComm = 0;</span>
<span class="nc" id="L819">					agtComm = 0;</span>
<span class="nc" id="L820">					govtComm = 0;</span>

<span class="nc bnc" id="L822" title="All 2 branches missed.">					while (gameRs.next()) {</span>
<span class="nc" id="L823">						double retCommTemp = gameRs.getDouble(&quot;ret_comm&quot;);</span>
<span class="nc" id="L824">						double agtCommTemp = gameRs.getDouble(&quot;agt_comm&quot;);</span>
<span class="nc" id="L825">						double govtCommTemp = gameRs.getDouble(&quot;govt_comm&quot;);</span>
<span class="nc bnc" id="L826" title="All 2 branches missed.">						if (gameRs.getTimestamp(&quot;date&quot;).getTime() &gt; transDate) {</span>
<span class="nc bnc" id="L827" title="All 2 branches missed.">							if (retCommTemp != 0.0) {</span>
<span class="nc" id="L828">								retComm = retCommTemp;</span>
							}
<span class="nc bnc" id="L830" title="All 2 branches missed.">							if (agtCommTemp != 0.0) {</span>
<span class="nc" id="L831">								agtComm = agtCommTemp;</span>
							}
<span class="nc bnc" id="L833" title="All 2 branches missed.">							if (govtCommTemp != 0.0) {</span>
<span class="nc" id="L834">								govtComm = govtCommTemp;</span>
							}
						}
<span class="nc" id="L837">					}</span>

<span class="nc" id="L839">					sb.append(&quot;(&quot; + transId + &quot;, &quot; + retComm + &quot;, &quot; + agtComm</span>
							+ &quot;,&quot; + govtComm + &quot;),&quot;);
<span class="nc" id="L841">					count++;</span>

<span class="nc bnc" id="L843" title="All 2 branches missed.">					if (count &gt; 500) {</span>
<span class="nc" id="L844">						sb.deleteCharAt(sb.length() - 1);</span>
<span class="nc" id="L845">						stmt.executeUpdate(sb.toString());</span>
<span class="nc" id="L846">						count = 0;</span>
<span class="nc" id="L847">						sb = null;</span>
<span class="nc" id="L848">						sb = new StringBuilder(</span>
								&quot;insert into st_temp_update_ledger (trans_id, ret_comm,agt_comm,govt_comm) values&quot;);
					}

<span class="nc" id="L852">				}</span>

<span class="nc bnc" id="L854" title="All 2 branches missed.">				if (count &gt; 0) {</span>
<span class="nc" id="L855">					sb.deleteCharAt(sb.length() - 1);</span>
<span class="nc" id="L856">					stmt.executeUpdate(sb.toString());</span>
				}
<span class="nc" id="L858">			}</span>
<span class="nc" id="L859">			logger.debug(new Date() + &quot;---end---&quot; + new Date().getTime());</span>
<span class="nc" id="L860">		} catch (Exception e) {</span>
<span class="nc" id="L861">			e.printStackTrace();</span>
<span class="nc" id="L862">			throw new LMSException(&quot;enable to fill comm table for retailer&quot;);</span>
<span class="nc" id="L863">		}</span>
<span class="nc" id="L864">	}</span>

	public void fillTempDGTransCommTlbForAgt(Connection con)
			throws LMSException {
<span class="nc" id="L868">		logger.debug(new Date() + &quot;---start---&quot; + new Date().getTime());</span>

		try {
<span class="nc" id="L871">			con.prepareStatement(&quot;truncate table st_temp_update_ledger&quot;)</span>
					.executeUpdate(); // it commits all previous transaction in database of this connection;
<span class="nc" id="L873">			long transId = 0;</span>
<span class="nc" id="L874">			int gameId = 0;</span>
<span class="nc" id="L875">			int orgId = 0;</span>
<span class="nc" id="L876">			Timestamp transDate = null;</span>
			double retComm, agtComm, govtComm;
<span class="nc" id="L878">			String gameQry = &quot;select * from (select game_id,sum(retailer_sale_comm_rate) ret_comm,sum(agent_sale_comm_rate) agt_comm,sum(govt_comm) govt_comm,now() date from (select game_id,retailer_sale_comm_rate,agent_sale_comm_rate,govt_comm from st_dg_game_master where game_id=? union all select game_id,0,sale_comm_variance,0 from st_dg_bo_agent_sale_pwt_comm_variance where agent_org_id=? and game_id=?) aa group by game_id union all select gm.game_id,0,agent_sale_comm_rate+sale_comm_variance agtComm,0,date_changed from st_dg_bo_agent_sale_comm_variance_history his inner join st_dg_game_master gm on his.game_id=gm.game_id where agent_org_id=? and gm.game_id=? union all select game_id,0,0,govt_comm_rate,date_changed from st_dg_game_govt_comm_history where game_id=?) aa order by date desc&quot;;</span>
<span class="nc" id="L879">			Statement stmt = con.createStatement();</span>

<span class="nc" id="L881">			int count = 0;</span>
<span class="nc" id="L882">			StringBuilder sb = new StringBuilder(</span>
					&quot;insert into st_temp_update_ledger (trans_id, ret_comm, agt_comm, govt_comm) values&quot;);

<span class="nc" id="L885">			String transQry = &quot;select sale.transaction_id,sale.game_id ,transaction_date,sale.agent_org_id,parent_id from st_lms_agent_transaction_master tm inner join st_lms_organization_master om inner join st_dg_agt_sale sale on sale.agent_org_id=om.organization_id and tm.transaction_id=sale.transaction_id  where claim_status in('CLAIM_BAL') union all select sale.transaction_id,sale.game_id ,transaction_date,sale.agent_org_id,parent_id from st_lms_agent_transaction_master tm inner join st_lms_organization_master om inner join st_dg_agt_sale_refund sale on sale.agent_org_id=om.organization_id and tm.transaction_id=sale.transaction_id  where claim_status in('CLAIM_BAL')&quot;;</span>
<span class="nc" id="L886">			PreparedStatement traStmt = con.prepareStatement(transQry);</span>
<span class="nc" id="L887">			ResultSet tranRs = traStmt.executeQuery();</span>
<span class="nc" id="L888">			PreparedStatement gameStmt = con.prepareStatement(gameQry);</span>

<span class="nc bnc" id="L890" title="All 2 branches missed.">			while (tranRs.next()) {</span>
<span class="nc" id="L891">				transId = tranRs.getLong(&quot;transaction_id&quot;);</span>
<span class="nc" id="L892">				gameId = tranRs.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L893">				orgId = tranRs.getInt(&quot;agent_org_id&quot;);</span>
<span class="nc" id="L894">				transDate = tranRs.getTimestamp(&quot;transaction_date&quot;);</span>
<span class="nc" id="L895">				gameStmt.setInt(1, gameId);</span>
<span class="nc" id="L896">				gameStmt.setInt(2, orgId);</span>
<span class="nc" id="L897">				gameStmt.setInt(3, gameId);</span>
<span class="nc" id="L898">				gameStmt.setInt(4, orgId);</span>
<span class="nc" id="L899">				gameStmt.setInt(5, gameId);</span>
<span class="nc" id="L900">				gameStmt.setInt(6, gameId);</span>
<span class="nc" id="L901">				ResultSet gameRs = gameStmt.executeQuery();</span>
<span class="nc" id="L902">				retComm = 0;</span>
<span class="nc" id="L903">				agtComm = 0;</span>
<span class="nc" id="L904">				govtComm = 0;</span>
<span class="nc bnc" id="L905" title="All 2 branches missed.">				while (gameRs.next()) {</span>
<span class="nc bnc" id="L906" title="All 2 branches missed.">					if (gameRs.getTimestamp(&quot;date&quot;).getTime() &gt; transDate</span>
							.getTime()) {
<span class="nc bnc" id="L908" title="All 2 branches missed.">						if (gameRs.getDouble(&quot;ret_comm&quot;) != 0.0) {</span>
<span class="nc" id="L909">							retComm = gameRs.getDouble(&quot;ret_comm&quot;);</span>
						}
<span class="nc bnc" id="L911" title="All 2 branches missed.">						if (gameRs.getDouble(&quot;agt_comm&quot;) != 0.0) {</span>
<span class="nc" id="L912">							agtComm = gameRs.getDouble(&quot;agt_comm&quot;);</span>
						}
<span class="nc bnc" id="L914" title="All 2 branches missed.">						if (gameRs.getDouble(&quot;govt_comm&quot;) != 0.0) {</span>
<span class="nc" id="L915">							govtComm = gameRs.getDouble(&quot;govt_comm&quot;);</span>
						}
					}
				}

<span class="nc" id="L920">				sb.append(&quot;(&quot; + transId + &quot;, &quot; + retComm + &quot;, &quot; + agtComm + &quot;,&quot;</span>
						+ govtComm + &quot;),&quot;);
<span class="nc" id="L922">				count++;</span>
				// if (count &gt; 500) {
				// sb.deleteCharAt(sb.length() - 1);
				// stmt.executeUpdate(sb.toString());
				// count = 0;
				//
				// sb = new StringBuilder(
				// &quot;insert into st_temp_update_ledger (trans_id, ret_comm,
				// agt_comm, govt_comm) values&quot;);
				//
				// }
<span class="nc" id="L933">			}</span>
<span class="nc bnc" id="L934" title="All 2 branches missed.">			if (count &gt; 0) {</span>
<span class="nc" id="L935">				sb.deleteCharAt(sb.length() - 1);</span>
<span class="nc" id="L936">				stmt.executeUpdate(sb.toString());</span>
			}
<span class="nc" id="L938">			logger.debug(new Date() + &quot;---end---&quot; + new Date().getTime());</span>
<span class="nc" id="L939">		} catch (Exception e) {</span>
<span class="nc" id="L940">			e.printStackTrace();</span>
<span class="nc" id="L941">			throw new LMSException(&quot;error in comm table agent&quot;);</span>
<span class="nc" id="L942">		}</span>
<span class="nc" id="L943">	}</span>

	public void updateDGSaleLedgerForRet(Connection con) throws LMSException {
<span class="nc" id="L946">		logger.debug(new Date() + &quot;---start-dg sale update for retailer--&quot;</span>
				+ new Date().getTime());
<span class="nc" id="L948">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L949">		ResultSet rs = null;</span>
		double totalMrpAmt, totalRetComm, totalAgtComm, totalGoodCauseAmt, totalretNetAmt, totalAgtNetAmt, totalCancelCharge;
		double retCommRate, agtCommRate, govtCommRate, retDebitAmount;
		String transDate;
<span class="nc" id="L953">		int retOrgId, agtUserId, agtOrgId=0;</span>
<span class="nc" id="L954">		Map&lt;Integer, Double&gt; orgIdAmountMap = new HashMap&lt;Integer, Double&gt;();</span>
<span class="nc" id="L955">		Map&lt;Integer, Integer&gt; orgIdParentIdMap = new HashMap&lt;Integer, Integer&gt;();</span>
<span class="nc" id="L956">		Map&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt; orgIdTransIdInvMap = new HashMap&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt;();</span>
<span class="nc" id="L957">		Map&lt;String, List&lt;Long&gt;&gt; transIdInvMap = null;</span>
<span class="nc" id="L958">		Map&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt; orgIdTransIdInvRetMap = new HashMap&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt;();</span>
<span class="nc" id="L959">		Map&lt;String, List&lt;Long&gt;&gt; transIdInvRetMap = null;</span>
<span class="nc" id="L960">		Statement tempStmt=null;</span>
		
		try {
<span class="nc" id="L963">			String getGameNbrFromGameMaster = &quot;select game_id,prize_payout_ratio,vat_amt from st_dg_game_master&quot;;</span>
<span class="nc" id="L964">			String saleQry = &quot;select a.retailer_org_id,agtUserId,agtOrgId,sum(mrp_amt) totalMrp ,sum(retailer_comm) totalRetComm,sum(agent_comm) totalagtComm, sum(good_cause_amt) totalgovtComm, sum(vat_amt) totalVat,sum(taxable_sale) totalTaxSale,sum(ret_sd_amt) totalSd,sum(agt_vat_amt)totatAgtVat,a.game_id,DATE(transaction_date) 'transaction_date',ret_comm,agt_comm,govt_comm from st_dg_ret_sale_? a inner join  st_lms_retailer_transaction_master b inner join st_temp_update_ledger c inner join (select um.user_id retUserId,um.organization_id retOrgId,um.parent_user_id agtUserId,om.parent_id agtOrgId from st_lms_organization_master om inner join st_lms_user_master um on om.organization_id=um.organization_id where om.organization_type='RETAILER') d on a.transaction_id = b.transaction_id and a.transaction_id=trans_id and a.retailer_org_id=retOrgId  where claim_status='CLAIM_BAL' group by a.retailer_org_id,DATE(transaction_date),a.game_id,ret_comm,agt_comm,govt_comm  order by retailer_org_id,game_id,transaction_date&quot;;</span>
<span class="nc" id="L965">			String saleReturnQry = &quot;select a.retailer_org_id,agtUserId,agtOrgId,sum(mrp_amt) totalMrp ,sum(retailer_comm) totalRetComm,sum(agent_comm) totalagtComm, sum(good_cause_amt) totalgovtComm, sum(vat_amt) totalVat,sum(taxable_sale) totalTaxSale,sum(cancellation_charges) totalCancelCharge,sum(ret_sd_amt) totalSd,sum(agt_vat_amt)totatAgtVat, a.game_id,DATE(transaction_date) 'transaction_date',ret_comm,agt_comm,govt_comm,transaction_type from st_dg_ret_sale_refund_? a inner join  st_lms_retailer_transaction_master b inner join st_temp_update_ledger c inner join (select um.user_id retUserId,um.organization_id retOrgId,um.parent_user_id agtUserId,om.parent_id agtOrgId from st_lms_organization_master om inner join st_lms_user_master um on om.organization_id=um.organization_id where om.organization_type='RETAILER') d on a.transaction_id = b.transaction_id and a.transaction_id=trans_id and a.retailer_org_id=retOrgId  where claim_status='CLAIM_BAL' group by a.retailer_org_id,DATE(transaction_date),a.game_id,transaction_type,ret_comm,agt_comm,govt_comm  order by retailer_org_id,game_id,transaction_date&quot;;</span>
<span class="nc" id="L966">			PreparedStatement pstmtGameNbr = con</span>
					.prepareStatement(getGameNbrFromGameMaster);
<span class="nc" id="L968">			ResultSet resultGameNbr = pstmtGameNbr.executeQuery();</span>

<span class="nc" id="L970">			PreparedStatement pstmtAgt = con.prepareStatement(QueryManager</span>
					.insertInLMSTransactionMaster());
<span class="nc" id="L972">			PreparedStatement pstmtAgtTrans = con.prepareStatement(QueryManager</span>
					.insertInAgentTransactionMaster());
<span class="nc" id="L974">			PreparedStatement insAgtSalePstmt = con</span>
					.prepareStatement(&quot;insert into st_dg_agt_sale(transaction_id,agent_org_id,retailer_org_id,game_id,mrp_amt,retailer_comm,net_amt,agent_comm,bo_net_amt,claim_status,vat_amt,taxable_sale,govt_comm) values(?,?,?,?,?,?,?,?,?,?,?,?,?)&quot;);
			//PreparedStatement updateRetSalePstmt = con
				//	.prepareStatement(&quot;update st_dg_ret_sale_? a inner join  st_lms_retailer_transaction_master b inner join st_temp_update_ledger c on a.transaction_id = b.transaction_id and a.transaction_id=trans_id set claim_status='DONE_CLAIM',agent_ref_transaction_id=? where a.retailer_org_id=? and ret_comm=? and agt_comm=? and govt_comm=? and DATE(transaction_date)=?&quot;);
<span class="nc" id="L978">			PreparedStatement insTempTablePstmt=con.prepareStatement(&quot;insert into orgTransSummary(agent_ref_transaction_id,ret_comm,agt_comm,govt_comm,retailer_org_id,game_id,trans_date) values(?,?,?,?,?,?,?)&quot;);</span>
<span class="nc" id="L979">			PreparedStatement insAgtSaleRetPstmt = con</span>
					.prepareStatement(&quot;insert into st_dg_agt_sale_refund(transaction_id,agent_org_id,retailer_org_id,game_id,mrp_amt,retailer_comm,net_amt,agent_comm,bo_net_amt,claim_status,vat_amt,taxable_sale,govt_comm,cancellation_charges) values(?,?,?,?,?,?,?,?,?,?,?,?,?,?)&quot;);
			//PreparedStatement updateRetSaleRetPstmt = con
				//	.prepareStatement(&quot;update st_dg_ret_sale_refund_? a inner join  st_lms_retailer_transaction_master b inner join st_temp_update_ledger c on a.transaction_id = b.transaction_id and a.transaction_id=trans_id set claim_status='DONE_CLAIM',agent_ref_transaction_id=? where a.retailer_org_id=? and ret_comm=? and agt_comm=? and govt_comm=? and DATE(transaction_date)=? and transaction_type=?&quot;);
<span class="nc" id="L983">			tempStmt=con.createStatement();</span>
<span class="nc" id="L984">			tempStmt.execute(&quot;delete from  orgTransSummary &quot;);</span>
<span class="nc" id="L985">			int gameId = 0;</span>
<span class="nc" id="L986">			double ppr = 0.0;</span>
<span class="nc" id="L987">			double vatAmt = 0.0;</span>
<span class="nc" id="L988">			final int batchSize = 500;</span>
<span class="nc" id="L989">			int count = 0;</span>
<span class="nc bnc" id="L990" title="All 2 branches missed.">			while (resultGameNbr.next()) {</span>
<span class="nc" id="L991">				gameId = resultGameNbr.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L992">				ppr = resultGameNbr.getInt(&quot;prize_payout_ratio&quot;);</span>
<span class="nc" id="L993">				vatAmt = resultGameNbr.getDouble(&quot;vat_amt&quot;);</span>
<span class="nc" id="L994">				pstmt = con.prepareStatement(saleQry);</span>
<span class="nc" id="L995">				pstmt.setInt(1, gameId);</span>
<span class="nc" id="L996">				rs = pstmt.executeQuery();</span>
<span class="nc" id="L997">				logger.debug(&quot;--Start Sale tran for game No&quot; + gameId);</span>
				
<span class="nc bnc" id="L999" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L1000">					retOrgId = rs.getInt(&quot;retailer_org_id&quot;);</span>
<span class="nc" id="L1001">					agtUserId = rs.getInt(&quot;agtUserId&quot;);</span>
<span class="nc" id="L1002">					agtOrgId = rs.getInt(&quot;agtOrgId&quot;);</span>

<span class="nc" id="L1004">					totalMrpAmt = rs.getDouble(&quot;totalMrp&quot;);</span>
<span class="nc bnc" id="L1005" title="All 2 branches missed.">					if(&quot;BENIN&quot;.equalsIgnoreCase(Utility.getPropertyValue(&quot;COUNTRY_DEPLOYED&quot;))){</span>
<span class="nc" id="L1006">						totalRetComm = rs.getDouble(&quot;totalRetComm&quot;)-rs.getDouble(&quot;totalVat&quot;)-rs.getDouble(&quot;totalSd&quot;);</span>
<span class="nc" id="L1007">						totalAgtComm = totalRetComm;</span>
					}else{
<span class="nc" id="L1009">						totalRetComm = rs.getDouble(&quot;totalRetComm&quot;);</span>
<span class="nc" id="L1010">						totalAgtComm = rs.getDouble(&quot;totalagtComm&quot;);</span>
					}
<span class="nc" id="L1012">					totalGoodCauseAmt = rs.getDouble(&quot;totalgovtComm&quot;);</span>
<span class="nc" id="L1013">					retCommRate = rs.getDouble(&quot;ret_comm&quot;);</span>
<span class="nc" id="L1014">					agtCommRate = rs.getDouble(&quot;agt_comm&quot;);</span>
<span class="nc" id="L1015">					govtCommRate = rs.getDouble(&quot;govt_comm&quot;);</span>
<span class="nc" id="L1016">					transDate = rs.getString(&quot;transaction_date&quot;);</span>
<span class="nc" id="L1017">					totalretNetAmt = totalMrpAmt - totalRetComm;</span>
<span class="nc" id="L1018">					totalAgtNetAmt = totalMrpAmt - totalAgtComm;</span>
<span class="nc" id="L1019">					double totalAgtVat= rs.getDouble(&quot;totatAgtVat&quot;);</span>
					/*double totalAgtVat = CommonMethods
							.calculateDrawGameVatRet(totalMrpAmt, retCommRate,
									ppr, govtCommRate, vatAmt);*/
<span class="nc" id="L1023">					double tatalAgtTaxableSale = CommonMethods</span>
							.calTaxableSale(totalMrpAmt, retCommRate, ppr,
									govtCommRate, vatAmt);

<span class="nc bnc" id="L1027" title="All 2 branches missed.">					if (orgIdAmountMap.containsKey(retOrgId)) {</span>
<span class="nc" id="L1028">						retDebitAmount = orgIdAmountMap.get(retOrgId)</span>
								+ totalretNetAmt;
					} else {
<span class="nc" id="L1031">						retDebitAmount = totalretNetAmt;</span>
					}

<span class="nc" id="L1034">					orgIdAmountMap.put(retOrgId, retDebitAmount);</span>
<span class="nc" id="L1035">					orgIdParentIdMap.put(retOrgId, agtOrgId);</span>

<span class="nc bnc" id="L1037" title="All 2 branches missed.">					if (orgIdTransIdInvMap.containsKey(retOrgId)) {</span>
<span class="nc" id="L1038">						transIdInvMap = orgIdTransIdInvMap.get(retOrgId);</span>
					} else {
<span class="nc" id="L1040">						transIdInvMap = new HashMap&lt;String, List&lt;Long&gt;&gt;();</span>
<span class="nc" id="L1041">						orgIdTransIdInvMap.put(retOrgId, transIdInvMap);</span>
					}

					// insert in main transaction table

<span class="nc" id="L1046">					pstmtAgt.setString(1, &quot;AGENT&quot;);</span>
<span class="nc" id="L1047">					pstmtAgt.executeUpdate();</span>
<span class="nc" id="L1048">					ResultSet rsTrns = pstmtAgt.getGeneratedKeys();</span>
<span class="nc bnc" id="L1049" title="All 2 branches missed.">					if (rsTrns.next()) {</span>
<span class="nc" id="L1050">						long transId = rsTrns.getLong(1);</span>
<span class="nc" id="L1051">						logger.debug(&quot;--Retailer org id&quot;+retOrgId+&quot;--Agent org Id--&quot;+agtOrgId+&quot;--Start Sale tran for game No&quot; + gameId);</span>
<span class="nc bnc" id="L1052" title="All 2 branches missed.">						if (!transIdInvMap.containsKey(transDate)) {</span>
<span class="nc" id="L1053">							transIdInvMap.put(transDate,</span>
									new ArrayList&lt;Long&gt;());
						}

<span class="nc" id="L1057">						transIdInvMap.get(transDate).add(transId);</span>

<span class="nc" id="L1059">						pstmtAgtTrans.setLong(1, transId);</span>
<span class="nc" id="L1060">						pstmtAgtTrans.setInt(2, agtUserId);</span>
<span class="nc" id="L1061">						pstmtAgtTrans.setInt(3, agtOrgId);</span>
<span class="nc" id="L1062">						pstmtAgtTrans.setString(4, &quot;RETAILER&quot;);</span>
<span class="nc" id="L1063">						pstmtAgtTrans.setInt(5, retOrgId);</span>
<span class="nc" id="L1064">						pstmtAgtTrans.setString(6, &quot;DG_SALE&quot;);</span>
<span class="nc" id="L1065">						pstmtAgtTrans.setTimestamp(7,</span>
								fetchTransTimeStamp(transDate));
<span class="nc" id="L1067">						pstmtAgtTrans.executeUpdate();</span>

<span class="nc" id="L1069">						insAgtSalePstmt.setLong(1, transId);</span>
<span class="nc" id="L1070">						insAgtSalePstmt.setInt(2, agtOrgId);</span>
<span class="nc" id="L1071">						insAgtSalePstmt.setInt(3, retOrgId);</span>
<span class="nc" id="L1072">						insAgtSalePstmt.setInt(4, gameId);</span>
<span class="nc" id="L1073">						insAgtSalePstmt.setDouble(5, totalMrpAmt);</span>
<span class="nc" id="L1074">						insAgtSalePstmt.setDouble(6, totalRetComm);</span>
<span class="nc" id="L1075">						insAgtSalePstmt.setDouble(7, totalretNetAmt);</span>
<span class="nc" id="L1076">						insAgtSalePstmt.setDouble(8, totalAgtComm);</span>
<span class="nc" id="L1077">						insAgtSalePstmt.setDouble(9, totalAgtNetAmt);</span>
<span class="nc" id="L1078">						insAgtSalePstmt.setString(10, &quot;CLAIM_BAL&quot;);</span>
<span class="nc" id="L1079">						insAgtSalePstmt.setDouble(11, totalAgtVat);</span>
<span class="nc" id="L1080">						insAgtSalePstmt.setDouble(12, tatalAgtTaxableSale);</span>
<span class="nc" id="L1081">						insAgtSalePstmt.setDouble(13, totalGoodCauseAmt);</span>
<span class="nc" id="L1082">						insAgtSalePstmt.executeUpdate();</span>

						
						
						//insert temp table
<span class="nc" id="L1087">						insTempTablePstmt.setLong(1, transId);</span>
<span class="nc" id="L1088">						insTempTablePstmt.setDouble(2, retCommRate);</span>
<span class="nc" id="L1089">						insTempTablePstmt.setDouble(3, agtCommRate);</span>
<span class="nc" id="L1090">						insTempTablePstmt.setDouble(4, govtCommRate);</span>
<span class="nc" id="L1091">						insTempTablePstmt.setInt(5, retOrgId);</span>
<span class="nc" id="L1092">						insTempTablePstmt.setInt(6, gameId);</span>
<span class="nc" id="L1093">						insTempTablePstmt.setString(7, transDate);</span>
<span class="nc" id="L1094">						insTempTablePstmt.addBatch();</span>
<span class="nc bnc" id="L1095" title="All 2 branches missed.">						if(++count % batchSize == 0) {</span>
<span class="nc" id="L1096">							insTempTablePstmt.executeBatch();</span>
					    }
						/*// update retailer table

						updateRetSalePstmt.setInt(1, gameId);
						updateRetSalePstmt.setLong(2, transId); // agent trans
						// Id
						updateRetSalePstmt.setInt(3, retOrgId);
						updateRetSalePstmt.setDouble(4, retCommRate);
						updateRetSalePstmt.setDouble(5, agtCommRate);
						updateRetSalePstmt.setDouble(6, govtCommRate);
						updateRetSalePstmt.setString(7, transDate);
						updateRetSalePstmt.addBatch();*/
						
					}

<span class="nc" id="L1112">				}</span>
				
<span class="nc" id="L1114">				insTempTablePstmt.executeBatch();</span>
				
				
<span class="nc" id="L1117">				tempStmt.executeUpdate(&quot;update st_dg_ret_sale_&quot;+gameId+&quot; sale inner join (select yy.transaction_id,xx.agent_ref_transaction_id from orgTransSummary xx inner join (select transaction_id,transaction_date,retailer_org_id,ret_comm,agt_comm,govt_comm,game_id from st_lms_retailer_transaction_master a inner join st_temp_update_ledger b on a.transaction_id = b.trans_id)yy on DATE(trans_date)=DATE(transaction_date) and xx.retailer_org_id=yy.retailer_org_id and xx.ret_comm=yy.ret_comm and xx.agt_comm=yy.agt_comm and xx.govt_comm=yy.govt_comm and xx.game_id=yy.game_id) tlb on sale.transaction_id=tlb.transaction_id set sale.claim_status='DONE_CLAIM',sale.agent_ref_transaction_id=tlb.agent_ref_transaction_id&quot;);</span>
<span class="nc" id="L1118">				tempStmt.execute(&quot;delete from  orgTransSummary &quot;);</span>
				//tempStmt.execute(&quot;truncate table orgTransSummary&quot;);
				
<span class="nc" id="L1121">				pstmt = con.prepareStatement(saleReturnQry);</span>
<span class="nc" id="L1122">				pstmt.setInt(1, gameId);</span>
<span class="nc" id="L1123">				rs = pstmt.executeQuery();</span>
<span class="nc" id="L1124">				logger.debug(&quot;--Start Cancel tran for game No&quot; + gameId);</span>
<span class="nc bnc" id="L1125" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L1126">					retOrgId = rs.getInt(&quot;retailer_org_id&quot;);</span>
<span class="nc" id="L1127">					agtUserId = rs.getInt(&quot;agtUserId&quot;);</span>
<span class="nc" id="L1128">					agtOrgId = rs.getInt(&quot;agtOrgId&quot;);</span>

<span class="nc" id="L1130">					totalMrpAmt = rs.getDouble(&quot;totalMrp&quot;);</span>
<span class="nc bnc" id="L1131" title="All 2 branches missed.">					if(&quot;BENIN&quot;.equalsIgnoreCase(Utility.getPropertyValue(&quot;COUNTRY_DEPLOYED&quot;))){</span>
<span class="nc" id="L1132">						totalRetComm = rs.getDouble(&quot;totalRetComm&quot;)-rs.getDouble(&quot;totalVat&quot;)-rs.getDouble(&quot;totalSd&quot;);</span>
<span class="nc" id="L1133">						totalAgtComm = totalRetComm;</span>
					}else{
<span class="nc" id="L1135">						totalRetComm = rs.getDouble(&quot;totalRetComm&quot;);</span>
<span class="nc" id="L1136">						totalAgtComm = rs.getDouble(&quot;totalagtComm&quot;);</span>
					}
<span class="nc" id="L1138">					totalGoodCauseAmt = rs.getDouble(&quot;totalgovtComm&quot;);</span>
<span class="nc" id="L1139">					totalCancelCharge = rs.getDouble(&quot;totalCancelCharge&quot;);</span>
<span class="nc" id="L1140">					retCommRate = rs.getDouble(&quot;ret_comm&quot;);</span>
<span class="nc" id="L1141">					agtCommRate = rs.getDouble(&quot;agt_comm&quot;);</span>
<span class="nc" id="L1142">					govtCommRate = rs.getDouble(&quot;govt_comm&quot;);</span>
<span class="nc" id="L1143">					transDate = rs.getString(&quot;transaction_date&quot;);</span>
<span class="nc" id="L1144">					totalretNetAmt = totalMrpAmt - totalRetComm</span>
							- totalCancelCharge;
<span class="nc" id="L1146">					totalAgtNetAmt = totalMrpAmt - totalAgtComm</span>
							- totalCancelCharge;
<span class="nc" id="L1148">					String tranType = rs.getString(&quot;transaction_type&quot;);</span>
<span class="nc" id="L1149">					double totalAgtVat =rs.getDouble(&quot;totatAgtVat&quot;);</span>
					/*double totalAgtVat = CommonMethods
							.calculateDrawGameVatRet(totalMrpAmt, retCommRate,
									ppr, govtCommRate, vatAmt);*/
<span class="nc" id="L1153">					double tatalAgtTaxableSale = CommonMethods</span>
							.calTaxableSale(totalMrpAmt, retCommRate, ppr,
									govtCommRate, vatAmt);

<span class="nc bnc" id="L1157" title="All 2 branches missed.">					if (orgIdAmountMap.containsKey(retOrgId)) {</span>
<span class="nc" id="L1158">						retDebitAmount = orgIdAmountMap.get(retOrgId)</span>
								- totalretNetAmt;
					} else {
<span class="nc" id="L1161">						retDebitAmount = -totalretNetAmt;</span>
					}

<span class="nc" id="L1164">					orgIdAmountMap.put(retOrgId, retDebitAmount);</span>
<span class="nc" id="L1165">					orgIdParentIdMap.put(retOrgId, agtOrgId);</span>

<span class="nc bnc" id="L1167" title="All 2 branches missed.">					if (orgIdTransIdInvRetMap.containsKey(retOrgId)) {</span>
<span class="nc" id="L1168">						transIdInvRetMap = orgIdTransIdInvRetMap.get(retOrgId);</span>
					} else {
<span class="nc" id="L1170">						transIdInvRetMap = new HashMap&lt;String, List&lt;Long&gt;&gt;();</span>
<span class="nc" id="L1171">						orgIdTransIdInvRetMap.put(retOrgId, transIdInvRetMap);</span>
					}

					// insert in main transaction table

<span class="nc" id="L1176">					pstmtAgt.setString(1, &quot;AGENT&quot;);</span>
<span class="nc" id="L1177">					pstmtAgt.executeUpdate();</span>
<span class="nc" id="L1178">					ResultSet rsTrns = pstmtAgt.getGeneratedKeys();</span>
<span class="nc bnc" id="L1179" title="All 2 branches missed.">					if (rsTrns.next()) {</span>
<span class="nc" id="L1180">						long transId = rsTrns.getLong(1);</span>
<span class="nc" id="L1181">						logger.debug(&quot;--Retailer org id&quot;+retOrgId+&quot;--Agent org Id--&quot;+agtOrgId+&quot;--Start Sale Cancel tran for game No&quot; + gameId);</span>
<span class="nc bnc" id="L1182" title="All 2 branches missed.">						if (!transIdInvRetMap.containsKey(transDate)) {</span>
<span class="nc" id="L1183">							transIdInvRetMap.put(transDate,</span>
									new ArrayList&lt;Long&gt;());
						}

<span class="nc" id="L1187">						transIdInvRetMap.get(transDate).add(transId);</span>

<span class="nc" id="L1189">						pstmtAgtTrans.setLong(1, transId);</span>
<span class="nc" id="L1190">						pstmtAgtTrans.setInt(2, agtUserId);</span>
<span class="nc" id="L1191">						pstmtAgtTrans.setInt(3, agtOrgId);</span>
<span class="nc" id="L1192">						pstmtAgtTrans.setString(4, &quot;RETAILER&quot;);</span>
<span class="nc" id="L1193">						pstmtAgtTrans.setInt(5, retOrgId);</span>
<span class="nc" id="L1194">						pstmtAgtTrans.setString(6, tranType);</span>
<span class="nc" id="L1195">						pstmtAgtTrans.setTimestamp(7,</span>
								fetchTransTimeStamp(transDate));
<span class="nc" id="L1197">						pstmtAgtTrans.executeUpdate();</span>

<span class="nc" id="L1199">						insAgtSaleRetPstmt.setLong(1, transId);</span>
<span class="nc" id="L1200">						insAgtSaleRetPstmt.setInt(2, agtOrgId);</span>
<span class="nc" id="L1201">						insAgtSaleRetPstmt.setInt(3, retOrgId);</span>
<span class="nc" id="L1202">						insAgtSaleRetPstmt.setInt(4, gameId);</span>
<span class="nc" id="L1203">						insAgtSaleRetPstmt.setDouble(5, totalMrpAmt);</span>
<span class="nc" id="L1204">						insAgtSaleRetPstmt.setDouble(6, totalRetComm);</span>
<span class="nc" id="L1205">						insAgtSaleRetPstmt.setDouble(7, totalretNetAmt);</span>
<span class="nc" id="L1206">						insAgtSaleRetPstmt.setDouble(8, totalAgtComm);</span>
<span class="nc" id="L1207">						insAgtSaleRetPstmt.setDouble(9, totalAgtNetAmt);</span>
<span class="nc" id="L1208">						insAgtSaleRetPstmt.setString(10, &quot;CLAIM_BAL&quot;);</span>
<span class="nc" id="L1209">						insAgtSaleRetPstmt.setDouble(11, totalAgtVat);</span>
<span class="nc" id="L1210">						insAgtSaleRetPstmt.setDouble(12, tatalAgtTaxableSale);</span>
<span class="nc" id="L1211">						insAgtSaleRetPstmt.setDouble(13, totalGoodCauseAmt);</span>
<span class="nc" id="L1212">						insAgtSaleRetPstmt.setDouble(14, totalCancelCharge);</span>
<span class="nc" id="L1213">						insAgtSaleRetPstmt.executeUpdate();</span>

						
						//insert temp table
<span class="nc" id="L1217">						insTempTablePstmt.setLong(1, transId);</span>
<span class="nc" id="L1218">						insTempTablePstmt.setDouble(2, retCommRate);</span>
<span class="nc" id="L1219">						insTempTablePstmt.setDouble(3, agtCommRate);</span>
<span class="nc" id="L1220">						insTempTablePstmt.setDouble(4, govtCommRate);</span>
<span class="nc" id="L1221">						insTempTablePstmt.setInt(5, retOrgId);</span>
<span class="nc" id="L1222">						insTempTablePstmt.setInt(6, gameId);</span>
<span class="nc" id="L1223">						insTempTablePstmt.setString(7, transDate);</span>
<span class="nc" id="L1224">						insTempTablePstmt.addBatch();</span>
<span class="nc bnc" id="L1225" title="All 2 branches missed.">						if(++count % batchSize == 0) {</span>
<span class="nc" id="L1226">							insTempTablePstmt.executeBatch();</span>
					    }
						
						// update retailer table
						/*updateRetSaleRetPstmt.setInt(1, gameId);
						updateRetSaleRetPstmt.setLong(2, transId); // agent
						// trans Id
						updateRetSaleRetPstmt.setInt(3, retOrgId);
						updateRetSaleRetPstmt.setDouble(4, retCommRate);
						updateRetSaleRetPstmt.setDouble(5, agtCommRate);
						updateRetSaleRetPstmt.setDouble(6, govtCommRate);
						updateRetSaleRetPstmt.setString(7, transDate);
						updateRetSaleRetPstmt.setString(8, tranType);
						updateRetSaleRetPstmt.addBatch();*/
						//updateRetSaleRetPstmt.executeUpdate();
					}

<span class="nc" id="L1243">				}</span>
				
<span class="nc" id="L1245">				insTempTablePstmt.executeBatch();</span>
				
<span class="nc" id="L1247">				tempStmt.executeUpdate(&quot;update st_dg_ret_sale_refund_&quot;+gameId+&quot; sale inner join (select yy.transaction_id,xx.agent_ref_transaction_id from orgTransSummary xx inner join (select transaction_id,transaction_date,retailer_org_id,ret_comm,agt_comm,govt_comm,game_id from st_lms_retailer_transaction_master a inner join st_temp_update_ledger b on a.transaction_id = b.trans_id)yy on DATE(trans_date)=DATE(transaction_date) and xx.retailer_org_id=yy.retailer_org_id and xx.ret_comm=yy.ret_comm and xx.agt_comm=yy.agt_comm and xx.govt_comm=yy.govt_comm and xx.game_id=yy.game_id) tlb on sale.transaction_id=tlb.transaction_id set sale.claim_status='DONE_CLAIM',sale.agent_ref_transaction_id=tlb.agent_ref_transaction_id&quot;);</span>
<span class="nc" id="L1248">				tempStmt.execute(&quot;delete from orgTransSummary&quot;);</span>
				
			}

<span class="nc" id="L1252">			generateDGReceiptNew(orgIdTransIdInvMap, orgIdParentIdMap,</span>
					&quot;DG_INVOICE&quot;, &quot;DG_RECEIPT&quot;, con);
<span class="nc" id="L1254">			generateDGReceiptNew(orgIdTransIdInvRetMap, orgIdParentIdMap,</span>
					&quot;CR_NOTE&quot;, &quot;CR_NOTE_CASH&quot;, con);

<span class="nc" id="L1257">			logger.debug(&quot;retailer orgIdAmountMap\n&quot; + orgIdAmountMap);</span>
			// update retailer balance
<span class="nc" id="L1259">			Set&lt;Integer&gt; retOrgIdSet = orgIdAmountMap.keySet();</span>
<span class="nc bnc" id="L1260" title="All 2 branches missed.">			for (Integer orgId : retOrgIdSet) {</span>
<span class="nc" id="L1261">				boolean isValid=OrgCreditUpdation.updateOrganizationBalWithValidate(CommonMethods.fmtToTwoDecimal(orgIdAmountMap.get(orgId)), &quot;TRANSACTION&quot;, &quot;DRAW_GAME_SALE&quot;, orgId,</span>
						orgIdParentIdMap.get(orgId), &quot;RETAILER&quot;, 0, con);
<span class="nc bnc" id="L1263" title="All 2 branches missed.">				if(!isValid)</span>
<span class="nc" id="L1264">					throw new LMSException();</span>
					
<span class="nc" id="L1266">				OrgCreditUpdation.updateOrganizationBalWithValidate(CommonMethods.fmtToTwoDecimal(orgIdAmountMap.get(orgId)), &quot;CLAIM_BAL&quot;, &quot;DEBIT&quot;, orgId,</span>
						orgIdParentIdMap.get(orgId), &quot;RETAILER&quot;, 0, con);
				
				/*OrgCreditUpdation.updateCreditLimitForRetailer(orgId,
						&quot;DRAW_GAME_SALE&quot;, orgIdAmountMap.get(orgId), con);
				updateOrgBalance(&quot;CLAIM_BAL&quot;, orgIdAmountMap.get(orgId), orgId,
						&quot;DEBIT&quot;, con);*/
<span class="nc" id="L1273">			}</span>
<span class="nc" id="L1274">		} catch (Exception e) {</span>
<span class="nc" id="L1275">			e.printStackTrace();</span>
<span class="nc" id="L1276">			throw new LMSException(&quot;error in sale retailer&quot;);</span>
<span class="nc" id="L1277">		}</span>
<span class="nc" id="L1278">		logger.debug(new Date() + &quot;---end-dg sale update for retailer--&quot;</span>
				+ new Date().getTime());
<span class="nc" id="L1280">	}</span>

	public void updateDGSaleLedgerForRetwithoutComm(Connection con) throws LMSException {
<span class="nc" id="L1283">		logger.debug(new Date() + &quot;---start-dg sale update for retailer--&quot;</span>
				+ new Date().getTime());
<span class="nc" id="L1285">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L1286">		ResultSet rs = null;</span>
		double totalMrpAmt, totalRetComm, totalAgtComm, totalGoodCauseAmt, totalretNetAmt, totalAgtNetAmt, totalCancelCharge;
		double retCommRate,  govtCommRate,retDebitAmount;
		String transDate;
<span class="nc" id="L1290">		int retOrgId, agtUserId, agtOrgId=0;</span>
<span class="nc" id="L1291">		Map&lt;Integer, Double&gt; orgIdAmountMap = new HashMap&lt;Integer, Double&gt;();</span>
<span class="nc" id="L1292">		Map&lt;Integer, Integer&gt; orgIdParentIdMap = new HashMap&lt;Integer, Integer&gt;();</span>
<span class="nc" id="L1293">		Map&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt; orgIdTransIdInvMap = new HashMap&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt;();</span>
<span class="nc" id="L1294">		Map&lt;String, List&lt;Long&gt;&gt; transIdInvMap = null;</span>
<span class="nc" id="L1295">		Map&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt; orgIdTransIdInvRetMap = new HashMap&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt;();</span>
<span class="nc" id="L1296">		Map&lt;String, List&lt;Long&gt;&gt; transIdInvRetMap = null;</span>
		try {
<span class="nc" id="L1298">			String getGameNbrFromGameMaster = &quot;select game_id,prize_payout_ratio,vat_amt from st_dg_game_master&quot;;</span>
<span class="nc" id="L1299">			String saleQry = &quot;select a.retailer_org_id,agtUserId,agtOrgId,sum(mrp_amt) totalMrp ,sum(retailer_comm) totalRetComm,sum(agent_comm) totalagtComm, sum(good_cause_amt) totalgovtComm, sum(vat_amt) totalVat,sum(taxable_sale) totalTaxSale,a.game_id,DATE(transaction_date) 'transaction_date' from st_dg_ret_sale_? a inner join  st_lms_retailer_transaction_master b inner join (select um.user_id retUserId,um.organization_id retOrgId,um.parent_user_id agtUserId,om.parent_id agtOrgId from st_lms_organization_master om inner join st_lms_user_master um on om.organization_id=um.organization_id where om.organization_type='RETAILER') d on a.transaction_id = b.transaction_id and a.retailer_org_id=retOrgId  where claim_status='CLAIM_BAL' group by a.retailer_org_id,DATE(transaction_date),a.game_id order by retailer_org_id,game_id,transaction_date&quot;;</span>
<span class="nc" id="L1300">			String saleReturnQry = &quot;select a.retailer_org_id,agtUserId,agtOrgId,sum(mrp_amt) totalMrp ,sum(retailer_comm) totalRetComm,sum(agent_comm) totalagtComm, sum(good_cause_amt) totalgovtComm, sum(vat_amt) totalVat,sum(taxable_sale) totalTaxSale,sum(cancellation_charges) totalCancelCharge,a.game_id,DATE(transaction_date) 'transaction_date',transaction_type from st_dg_ret_sale_refund_? a inner join  st_lms_retailer_transaction_master b inner join (select um.user_id retUserId,um.organization_id retOrgId,um.parent_user_id agtUserId,om.parent_id agtOrgId from st_lms_organization_master om inner join st_lms_user_master um on om.organization_id=um.organization_id where om.organization_type='RETAILER') d on a.transaction_id = b.transaction_id and a.retailer_org_id=retOrgId  where claim_status='CLAIM_BAL' group by a.retailer_org_id,DATE(transaction_date),a.game_id,transaction_type order by retailer_org_id,game_id,transaction_date&quot;;</span>
<span class="nc" id="L1301">			PreparedStatement pstmtGameNbr = con</span>
					.prepareStatement(getGameNbrFromGameMaster);
<span class="nc" id="L1303">			ResultSet resultGameNbr = pstmtGameNbr.executeQuery();</span>

<span class="nc" id="L1305">			PreparedStatement pstmtAgt = con.prepareStatement(QueryManager</span>
					.insertInLMSTransactionMaster());
<span class="nc" id="L1307">			PreparedStatement pstmtAgtTrans = con.prepareStatement(QueryManager</span>
					.insertInAgentTransactionMaster());
<span class="nc" id="L1309">			PreparedStatement insAgtSalePstmt = con</span>
					.prepareStatement(&quot;insert into st_dg_agt_sale(transaction_id,agent_org_id,retailer_org_id,game_id,mrp_amt,retailer_comm,net_amt,agent_comm,bo_net_amt,claim_status,vat_amt,taxable_sale,govt_comm) values(?,?,?,?,?,?,?,?,?,?,?,?,?)&quot;);
<span class="nc" id="L1311">			PreparedStatement updateRetSalePstmt = con</span>
					.prepareStatement(&quot;update st_dg_ret_sale_? a inner join  st_lms_retailer_transaction_master b on a.transaction_id = b.transaction_id set claim_status='DONE_CLAIM',agent_ref_transaction_id=? where a.retailer_org_id=? and DATE(transaction_date)=?&quot;);
<span class="nc" id="L1313">			PreparedStatement insAgtSaleRetPstmt = con</span>
					.prepareStatement(&quot;insert into st_dg_agt_sale_refund(transaction_id,agent_org_id,retailer_org_id,game_id,mrp_amt,retailer_comm,net_amt,agent_comm,bo_net_amt,claim_status,vat_amt,taxable_sale,govt_comm,cancellation_charges) values(?,?,?,?,?,?,?,?,?,?,?,?,?,?)&quot;);
<span class="nc" id="L1315">			PreparedStatement updateRetSaleRetPstmt = con</span>
					.prepareStatement(&quot;update st_dg_ret_sale_refund_? a inner join  st_lms_retailer_transaction_master b on a.transaction_id = b.transaction_id set claim_status='DONE_CLAIM',agent_ref_transaction_id=? where a.retailer_org_id=? and DATE(transaction_date)=? and transaction_type=?&quot;);

<span class="nc" id="L1318">			int gameId = 0;</span>
<span class="nc" id="L1319">			double ppr = 0.0;</span>
<span class="nc" id="L1320">			double vatAmt = 0.0;</span>
<span class="nc bnc" id="L1321" title="All 2 branches missed.">			while (resultGameNbr.next()) {</span>
<span class="nc" id="L1322">				gameId = resultGameNbr.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L1323">				ppr = resultGameNbr.getInt(&quot;prize_payout_ratio&quot;);</span>
<span class="nc" id="L1324">				vatAmt = resultGameNbr.getDouble(&quot;vat_amt&quot;);</span>
<span class="nc" id="L1325">				pstmt = con.prepareStatement(saleQry);</span>
<span class="nc" id="L1326">				pstmt.setInt(1, gameId);</span>
<span class="nc" id="L1327">				rs = pstmt.executeQuery();</span>
<span class="nc" id="L1328">				logger.debug(&quot;--Start Sale tran for game No&quot; + gameId);</span>
<span class="nc bnc" id="L1329" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L1330">					retOrgId = rs.getInt(&quot;retailer_org_id&quot;);</span>
<span class="nc" id="L1331">					agtUserId = rs.getInt(&quot;agtUserId&quot;);</span>
<span class="nc" id="L1332">					agtOrgId = rs.getInt(&quot;agtOrgId&quot;);</span>

<span class="nc" id="L1334">					totalMrpAmt = rs.getDouble(&quot;totalMrp&quot;);</span>
<span class="nc" id="L1335">					totalRetComm = rs.getDouble(&quot;totalRetComm&quot;);</span>
<span class="nc" id="L1336">					totalAgtComm = rs.getDouble(&quot;totalagtComm&quot;);</span>
<span class="nc" id="L1337">					totalGoodCauseAmt = rs.getDouble(&quot;totalgovtComm&quot;);</span>
<span class="nc bnc" id="L1338" title="All 2 branches missed.">					retCommRate = totalMrpAmt!=0?(totalRetComm/totalMrpAmt)*100:0;</span>
//					agtCommRate = rs.getDouble(&quot;agt_comm&quot;);
<span class="nc bnc" id="L1340" title="All 2 branches missed.">					govtCommRate = totalMrpAmt!=0?(totalGoodCauseAmt/totalMrpAmt)*100:0;</span>
<span class="nc" id="L1341">					transDate = rs.getString(&quot;transaction_date&quot;);</span>
<span class="nc" id="L1342">					totalretNetAmt = totalMrpAmt - totalRetComm;</span>
<span class="nc" id="L1343">					totalAgtNetAmt = totalMrpAmt - totalAgtComm;</span>

<span class="nc" id="L1345">					double totalAgtVat = CommonMethods</span>
							.calculateDrawGameVatRet(totalMrpAmt, retCommRate,
									ppr, govtCommRate, vatAmt);
<span class="nc" id="L1348">					double tatalAgtTaxableSale = CommonMethods</span>
							.calTaxableSale(totalMrpAmt, retCommRate, ppr,
									govtCommRate, vatAmt);

<span class="nc bnc" id="L1352" title="All 2 branches missed.">					if (orgIdAmountMap.containsKey(retOrgId)) {</span>
<span class="nc" id="L1353">						retDebitAmount = orgIdAmountMap.get(retOrgId)</span>
								+ totalretNetAmt;
					} else {
<span class="nc" id="L1356">						retDebitAmount = totalretNetAmt;</span>
					}

<span class="nc" id="L1359">					orgIdAmountMap.put(retOrgId, retDebitAmount);</span>
<span class="nc" id="L1360">					orgIdParentIdMap.put(retOrgId, agtOrgId);</span>

<span class="nc bnc" id="L1362" title="All 2 branches missed.">					if (orgIdTransIdInvMap.containsKey(retOrgId)) {</span>
<span class="nc" id="L1363">						transIdInvMap = orgIdTransIdInvMap.get(retOrgId);</span>
					} else {
<span class="nc" id="L1365">						transIdInvMap = new HashMap&lt;String, List&lt;Long&gt;&gt;();</span>
<span class="nc" id="L1366">						orgIdTransIdInvMap.put(retOrgId, transIdInvMap);</span>
					}

					// insert in main transaction table

<span class="nc" id="L1371">					pstmtAgt.setString(1, &quot;AGENT&quot;);</span>
<span class="nc" id="L1372">					pstmtAgt.executeUpdate();</span>
<span class="nc" id="L1373">					ResultSet rsTrns = pstmtAgt.getGeneratedKeys();</span>
<span class="nc bnc" id="L1374" title="All 2 branches missed.">					if (rsTrns.next()) {</span>
<span class="nc" id="L1375">						long transId = rsTrns.getLong(1);</span>
<span class="nc" id="L1376">						logger.debug(&quot;--Retailer org id&quot;+retOrgId+&quot;--Agent org Id--&quot;+agtOrgId+&quot;--Start Sale tran for game No&quot; + gameId);</span>
<span class="nc bnc" id="L1377" title="All 2 branches missed.">						if (!transIdInvMap.containsKey(transDate)) {</span>
<span class="nc" id="L1378">							transIdInvMap.put(transDate,</span>
									new ArrayList&lt;Long&gt;());
						}

<span class="nc" id="L1382">						transIdInvMap.get(transDate).add(transId);</span>

<span class="nc" id="L1384">						pstmtAgtTrans.setLong(1, transId);</span>
<span class="nc" id="L1385">						pstmtAgtTrans.setInt(2, agtUserId);</span>
<span class="nc" id="L1386">						pstmtAgtTrans.setInt(3, agtOrgId);</span>
<span class="nc" id="L1387">						pstmtAgtTrans.setString(4, &quot;RETAILER&quot;);</span>
<span class="nc" id="L1388">						pstmtAgtTrans.setInt(5, retOrgId);</span>
<span class="nc" id="L1389">						pstmtAgtTrans.setString(6, &quot;DG_SALE&quot;);</span>
<span class="nc" id="L1390">						pstmtAgtTrans.setTimestamp(7,</span>
								fetchTransTimeStamp(transDate));
<span class="nc" id="L1392">						pstmtAgtTrans.executeUpdate();</span>

<span class="nc" id="L1394">						insAgtSalePstmt.setLong(1, transId);</span>
<span class="nc" id="L1395">						insAgtSalePstmt.setInt(2, agtOrgId);</span>
<span class="nc" id="L1396">						insAgtSalePstmt.setInt(3, retOrgId);</span>
<span class="nc" id="L1397">						insAgtSalePstmt.setInt(4, gameId);</span>
<span class="nc" id="L1398">						insAgtSalePstmt.setDouble(5, totalMrpAmt);</span>
<span class="nc" id="L1399">						insAgtSalePstmt.setDouble(6, totalRetComm);</span>
<span class="nc" id="L1400">						insAgtSalePstmt.setDouble(7, totalretNetAmt);</span>
<span class="nc" id="L1401">						insAgtSalePstmt.setDouble(8, totalAgtComm);</span>
<span class="nc" id="L1402">						insAgtSalePstmt.setDouble(9, totalAgtNetAmt);</span>
<span class="nc" id="L1403">						insAgtSalePstmt.setString(10, &quot;CLAIM_BAL&quot;);</span>
<span class="nc" id="L1404">						insAgtSalePstmt.setDouble(11, totalAgtVat);</span>
<span class="nc" id="L1405">						insAgtSalePstmt.setDouble(12, tatalAgtTaxableSale);</span>
<span class="nc" id="L1406">						insAgtSalePstmt.setDouble(13, totalGoodCauseAmt);</span>
<span class="nc" id="L1407">						insAgtSalePstmt.executeUpdate();</span>

						// update retailer table

<span class="nc" id="L1411">						updateRetSalePstmt.setInt(1, gameId);</span>
<span class="nc" id="L1412">						updateRetSalePstmt.setLong(2, transId); // agent trans</span>
						// Id
<span class="nc" id="L1414">						updateRetSalePstmt.setInt(3, retOrgId);</span>
//						updateRetSalePstmt.setDouble(4, retCommRate);
//						updateRetSalePstmt.setDouble(5, agtCommRate);
//						updateRetSalePstmt.setDouble(6, govtCommRate);
<span class="nc" id="L1418">						updateRetSalePstmt.setString(4, transDate);</span>
<span class="nc" id="L1419">						updateRetSalePstmt.executeUpdate();</span>
					}

<span class="nc" id="L1422">				}</span>

<span class="nc" id="L1424">				pstmt = con.prepareStatement(saleReturnQry);</span>
<span class="nc" id="L1425">				pstmt.setInt(1, gameId);</span>
<span class="nc" id="L1426">				rs = pstmt.executeQuery();</span>
<span class="nc" id="L1427">				logger.debug(&quot;--Start Cancel tran for game No&quot; + gameId);</span>
<span class="nc bnc" id="L1428" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L1429">					retOrgId = rs.getInt(&quot;retailer_org_id&quot;);</span>
<span class="nc" id="L1430">					agtUserId = rs.getInt(&quot;agtUserId&quot;);</span>
<span class="nc" id="L1431">					agtOrgId = rs.getInt(&quot;agtOrgId&quot;);</span>

<span class="nc" id="L1433">					totalMrpAmt = rs.getDouble(&quot;totalMrp&quot;);</span>
<span class="nc" id="L1434">					totalRetComm = rs.getDouble(&quot;totalRetComm&quot;);</span>
<span class="nc" id="L1435">					totalAgtComm = rs.getDouble(&quot;totalagtComm&quot;);</span>
<span class="nc" id="L1436">					totalGoodCauseAmt = rs.getDouble(&quot;totalgovtComm&quot;);</span>
<span class="nc" id="L1437">					totalCancelCharge = rs.getDouble(&quot;totalCancelCharge&quot;);</span>
<span class="nc bnc" id="L1438" title="All 2 branches missed.">					retCommRate = totalMrpAmt!=0?(totalRetComm/totalMrpAmt)*100:0;</span>
//					agtCommRate = rs.getDouble(&quot;agt_comm&quot;);
<span class="nc bnc" id="L1440" title="All 2 branches missed.">					govtCommRate = totalMrpAmt!=0?(totalGoodCauseAmt/totalMrpAmt)*100:0;</span>
<span class="nc" id="L1441">					transDate = rs.getString(&quot;transaction_date&quot;);</span>
<span class="nc" id="L1442">					totalretNetAmt = totalMrpAmt - totalRetComm</span>
							- totalCancelCharge;
<span class="nc" id="L1444">					totalAgtNetAmt = totalMrpAmt - totalAgtComm</span>
							- totalCancelCharge;
<span class="nc" id="L1446">					String tranType = rs.getString(&quot;transaction_type&quot;);</span>
<span class="nc" id="L1447">					double totalAgtVat = CommonMethods</span>
							.calculateDrawGameVatRet(totalMrpAmt, retCommRate,
									ppr, govtCommRate, vatAmt);
<span class="nc" id="L1450">					double tatalAgtTaxableSale = CommonMethods</span>
							.calTaxableSale(totalMrpAmt, retCommRate, ppr,
									govtCommRate, vatAmt);

<span class="nc bnc" id="L1454" title="All 2 branches missed.">					if (orgIdAmountMap.containsKey(retOrgId)) {</span>
<span class="nc" id="L1455">						retDebitAmount = orgIdAmountMap.get(retOrgId)</span>
								- totalretNetAmt;
					} else {
<span class="nc" id="L1458">						retDebitAmount = -totalretNetAmt;</span>
					}

<span class="nc" id="L1461">					orgIdAmountMap.put(retOrgId, retDebitAmount);</span>
<span class="nc" id="L1462">					orgIdParentIdMap.put(retOrgId, agtOrgId);</span>

<span class="nc bnc" id="L1464" title="All 2 branches missed.">					if (orgIdTransIdInvRetMap.containsKey(retOrgId)) {</span>
<span class="nc" id="L1465">						transIdInvRetMap = orgIdTransIdInvRetMap.get(retOrgId);</span>
					} else {
<span class="nc" id="L1467">						transIdInvRetMap = new HashMap&lt;String, List&lt;Long&gt;&gt;();</span>
<span class="nc" id="L1468">						orgIdTransIdInvRetMap.put(retOrgId, transIdInvRetMap);</span>
					}

					// insert in main transaction table

<span class="nc" id="L1473">					pstmtAgt.setString(1, &quot;AGENT&quot;);</span>
<span class="nc" id="L1474">					pstmtAgt.executeUpdate();</span>
<span class="nc" id="L1475">					ResultSet rsTrns = pstmtAgt.getGeneratedKeys();</span>
<span class="nc bnc" id="L1476" title="All 2 branches missed.">					if (rsTrns.next()) {</span>
<span class="nc" id="L1477">						long transId = rsTrns.getLong(1);</span>
<span class="nc" id="L1478">						logger.debug(&quot;--Retailer org id&quot;+retOrgId+&quot;--Agent org Id--&quot;+agtOrgId+&quot;--Start Sale Cancel tran for game No&quot; + gameId);</span>
<span class="nc bnc" id="L1479" title="All 2 branches missed.">						if (!transIdInvRetMap.containsKey(transDate)) {</span>
<span class="nc" id="L1480">							transIdInvRetMap.put(transDate,</span>
									new ArrayList&lt;Long&gt;());
						}

<span class="nc" id="L1484">						transIdInvRetMap.get(transDate).add(transId);</span>

<span class="nc" id="L1486">						pstmtAgtTrans.setLong(1, transId);</span>
<span class="nc" id="L1487">						pstmtAgtTrans.setInt(2, agtUserId);</span>
<span class="nc" id="L1488">						pstmtAgtTrans.setInt(3, agtOrgId);</span>
<span class="nc" id="L1489">						pstmtAgtTrans.setString(4, &quot;RETAILER&quot;);</span>
<span class="nc" id="L1490">						pstmtAgtTrans.setInt(5, retOrgId);</span>
<span class="nc" id="L1491">						pstmtAgtTrans.setString(6, tranType);</span>
<span class="nc" id="L1492">						pstmtAgtTrans.setTimestamp(7,</span>
								fetchTransTimeStamp(transDate));
<span class="nc" id="L1494">						pstmtAgtTrans.executeUpdate();</span>

<span class="nc" id="L1496">						insAgtSaleRetPstmt.setLong(1, transId);</span>
<span class="nc" id="L1497">						insAgtSaleRetPstmt.setInt(2, agtOrgId);</span>
<span class="nc" id="L1498">						insAgtSaleRetPstmt.setInt(3, retOrgId);</span>
<span class="nc" id="L1499">						insAgtSaleRetPstmt.setInt(4, gameId);</span>
<span class="nc" id="L1500">						insAgtSaleRetPstmt.setDouble(5, totalMrpAmt);</span>
<span class="nc" id="L1501">						insAgtSaleRetPstmt.setDouble(6, totalRetComm);</span>
<span class="nc" id="L1502">						insAgtSaleRetPstmt.setDouble(7, totalretNetAmt);</span>
<span class="nc" id="L1503">						insAgtSaleRetPstmt.setDouble(8, totalAgtComm);</span>
<span class="nc" id="L1504">						insAgtSaleRetPstmt.setDouble(9, totalAgtNetAmt);</span>
<span class="nc" id="L1505">						insAgtSaleRetPstmt.setString(10, &quot;CLAIM_BAL&quot;);</span>
<span class="nc" id="L1506">						insAgtSaleRetPstmt.setDouble(11, totalAgtVat);</span>
<span class="nc" id="L1507">						insAgtSaleRetPstmt.setDouble(12, tatalAgtTaxableSale);</span>
<span class="nc" id="L1508">						insAgtSaleRetPstmt.setDouble(13, totalGoodCauseAmt);</span>
<span class="nc" id="L1509">						insAgtSaleRetPstmt.setDouble(14, totalCancelCharge);</span>
<span class="nc" id="L1510">						insAgtSaleRetPstmt.executeUpdate();</span>

						// update retailer table
<span class="nc" id="L1513">						updateRetSaleRetPstmt.setInt(1, gameId);</span>
<span class="nc" id="L1514">						updateRetSaleRetPstmt.setLong(2, transId); // agent</span>
						// trans Id
<span class="nc" id="L1516">						updateRetSaleRetPstmt.setInt(3, retOrgId);</span>
//						updateRetSaleRetPstmt.setDouble(4, retCommRate);
//						updateRetSaleRetPstmt.setDouble(5, agtCommRate);
//						updateRetSaleRetPstmt.setDouble(6, govtCommRate);
<span class="nc" id="L1520">						updateRetSaleRetPstmt.setString(4, transDate);</span>
<span class="nc" id="L1521">						updateRetSaleRetPstmt.setString(5, tranType);</span>
<span class="nc" id="L1522">						updateRetSaleRetPstmt.executeUpdate();</span>
					}

<span class="nc" id="L1525">				}</span>
			}

<span class="nc" id="L1528">			generateDGReceiptNew(orgIdTransIdInvMap, orgIdParentIdMap,</span>
					&quot;DG_INVOICE&quot;, &quot;DG_RECEIPT&quot;, con);
<span class="nc" id="L1530">			generateDGReceiptNew(orgIdTransIdInvRetMap, orgIdParentIdMap,</span>
					&quot;CR_NOTE&quot;, &quot;CR_NOTE_CASH&quot;, con);

<span class="nc" id="L1533">			logger.debug(&quot;retailer orgIdAmountMap\n&quot; + orgIdAmountMap);</span>
			// update retailer balance
<span class="nc" id="L1535">			Set&lt;Integer&gt; retOrgIdSet = orgIdAmountMap.keySet();</span>
<span class="nc bnc" id="L1536" title="All 2 branches missed.">			for (Integer orgId : retOrgIdSet) {</span>
<span class="nc" id="L1537">				boolean isValid=OrgCreditUpdation.updateOrganizationBalWithValidate(orgIdAmountMap.get(orgId), &quot;TRANSACTION&quot;, &quot;DRAW_GAME_SALE&quot;, orgId,</span>
						orgIdParentIdMap.get(orgId), &quot;RETAILER&quot;, 0, con);
<span class="nc bnc" id="L1539" title="All 2 branches missed.">				if(!isValid)</span>
<span class="nc" id="L1540">					throw new LMSException();</span>
					
<span class="nc" id="L1542">				OrgCreditUpdation.updateOrganizationBalWithValidate(orgIdAmountMap.get(orgId), &quot;CLAIM_BAL&quot;, &quot;DEBIT&quot;, orgId,</span>
						orgIdParentIdMap.get(orgId), &quot;RETAILER&quot;, 0, con);
				
				/*OrgCreditUpdation.updateCreditLimitForRetailer(orgId,
						&quot;DRAW_GAME_SALE&quot;, orgIdAmountMap.get(orgId), con);
				updateOrgBalance(&quot;CLAIM_BAL&quot;, orgIdAmountMap.get(orgId), orgId,
						&quot;DEBIT&quot;, con);*/
<span class="nc" id="L1549">			}</span>
<span class="nc" id="L1550">		} catch (Exception e) {</span>
<span class="nc" id="L1551">			e.printStackTrace();</span>
<span class="nc" id="L1552">			throw new LMSException(&quot;error in sale retailer&quot;);</span>
<span class="nc" id="L1553">		}</span>
<span class="nc" id="L1554">		logger.debug(new Date() + &quot;---end-dg sale update for retailer--&quot;</span>
				+ new Date().getTime());
<span class="nc" id="L1556">	}</span>
	
	public void updateDGSaleLedgerForAgt(Connection con) throws LMSException {
<span class="nc" id="L1559">		logger.debug(new Date() + &quot;---start-dg sale update for agent--&quot;</span>
				+ new Date().getTime());
<span class="nc" id="L1561">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L1562">		ResultSet rs = null;</span>
		double totalMrpAmt, totalAgtComm, totalGoodCauseAmt, totalAgtNetAmt, totalCancelCharge;
		double agtCommRate, govtCommRate, agtDebitAmount;
		String transDate;
		int agtOrgId, boUserId, boOrgId;
<span class="nc" id="L1567">		Map&lt;Integer, Double&gt; orgIdAmountMap = new HashMap&lt;Integer, Double&gt;();</span>
<span class="nc" id="L1568">		Map&lt;Integer, Integer&gt; orgIdParentIdMap = new HashMap&lt;Integer, Integer&gt;();</span>
<span class="nc" id="L1569">		Map&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt; orgIdTransIdInvMap = new HashMap&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt;();</span>
<span class="nc" id="L1570">		Map&lt;String, List&lt;Long&gt;&gt; transIdInvMap = null;</span>
<span class="nc" id="L1571">		Map&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt; orgIdTransIdInvRetMap = new HashMap&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt;();</span>
<span class="nc" id="L1572">		Map&lt;String, List&lt;Long&gt;&gt; transIdInvRetMap = null;</span>
<span class="nc" id="L1573">		Statement tempStmt=null;</span>
		try {
<span class="nc" id="L1575">			String saleQry = &quot;select agent_org_id,boUserId,boOrgId,totalMrp,totalRetComm,totalagtComm,totalgovtComm,totalVat,totalTaxSale,tot.game_id,transaction_date,ret_comm,agt_comm,tot.govt_comm,prize_payout_ratio,vat_amt from (select agent_org_id,boUserId,boOrgId,totalMrp,totalRetComm,totalagtComm,totalgovtComm,totalVat,totalTaxSale,game_id,transaction_date,ret_comm,agt_comm,govt_comm from(select a.agent_org_id,sum(mrp_amt) totalMrp ,sum(retailer_comm) totalRetComm,sum(agent_comm) totalagtComm, sum(a.govt_comm) totalgovtComm, sum(vat_amt) totalVat,sum(taxable_sale) totalTaxSale,a.game_id,DATE(transaction_date) 'transaction_date',ret_comm,agt_comm,c.govt_comm from st_dg_agt_sale a inner join  st_lms_agent_transaction_master b inner join st_temp_update_ledger c on a.transaction_id = b.transaction_id and a.transaction_id=trans_id where claim_status='CLAIM_BAL' group by a.agent_org_id,DATE(transaction_date),a.game_id,agt_comm,c.govt_comm  order by agent_org_id,game_id,transaction_date) sale inner join (select um.user_id agtUserId,um.organization_id agtOrgId,um.parent_user_id boUserId,om.parent_id boOrgId,isrolehead from st_lms_organization_master om inner join st_lms_user_master um on om.organization_id=um.organization_id where om.organization_type='AGENT') om on agent_org_id=agtOrgId and isrolehead = 'Y') tot inner join st_dg_game_master gm on tot.game_id=gm.game_id&quot;;</span>
<span class="nc" id="L1576">			String saleReturnQry = &quot;select agent_org_id,boUserId,boOrgId,totalMrp,totalRetComm,totalagtComm,totalgovtComm,totalVat,totalTaxSale,totalCancelCharge,tot.game_id,transaction_date,ret_comm,agt_comm,tot.govt_comm,transaction_type,prize_payout_ratio,vat_amt from(select agent_org_id,boUserId,boOrgId,totalMrp,totalRetComm,totalagtComm,totalgovtComm,totalVat,totalTaxSale,totalCancelCharge,game_id,transaction_date,ret_comm,agt_comm,govt_comm,transaction_type from(select a.agent_org_id,sum(mrp_amt) totalMrp ,sum(retailer_comm) totalRetComm,sum(agent_comm) totalagtComm, sum(a.govt_comm) totalgovtComm, sum(vat_amt) totalVat,sum(taxable_sale) totalTaxSale,sum(cancellation_charges) totalCancelCharge,a.game_id,DATE(transaction_date) 'transaction_date',ret_comm,agt_comm,c.govt_comm,transaction_type from st_dg_agt_sale_refund a inner join  st_lms_agent_transaction_master b inner join st_temp_update_ledger c on a.transaction_id = b.transaction_id and a.transaction_id=trans_id where claim_status='CLAIM_BAL' group by a.agent_org_id,DATE(transaction_date),a.game_id,transaction_type,agt_comm,c.govt_comm  order by agent_org_id,game_id,transaction_date) saleRefund inner join (select um.user_id agtUserId,um.organization_id agtOrgId,um.parent_user_id boUserId,om.parent_id boOrgId,isrolehead from st_lms_organization_master om inner join st_lms_user_master um on om.organization_id=um.organization_id where om.organization_type='AGENT') d on agent_org_id=agtOrgId and isrolehead = 'Y') tot inner join st_dg_game_master gm on tot.game_id=gm.game_id&quot;;</span>

<span class="nc" id="L1578">			PreparedStatement pstmtBO = con.prepareStatement(QueryManager.insertInLMSTransactionMaster());</span>
<span class="nc" id="L1579">			PreparedStatement insBoTranPstmt = con.prepareStatement(QueryManager.insertInBOTransactionMaster());</span>
<span class="nc" id="L1580">			PreparedStatement insBoSalePstmt = con.prepareStatement(&quot;insert into st_dg_bo_sale(transaction_id,agent_org_id,game_id,mrp_amt,agent_comm,net_amt,vat_amt,taxable_sale,govt_comm) values(?,?,?,?,?,?,?,?,?)&quot;);</span>
			
			//PreparedStatement updAgtSalepstmt = con.prepareStatement(&quot;update st_dg_agt_sale a inner join (select transaction_date,transaction_id,agt_comm,govt_comm from st_lms_agent_transaction_master a inner join st_temp_update_ledger b on a.transaction_id = b.trans_id) b on a.transaction_id = b.transaction_id set claim_status='DONE_CLAIM',bo_ref_transaction_id=? where a.agent_org_id=? and b.agt_comm=? and b.govt_comm=? and DATE(transaction_date)=? and game_id=?&quot;);
			
<span class="nc" id="L1584">			PreparedStatement insTempTablePstmt=con.prepareStatement(&quot;insert into agentTransSummary(bo_ref_transaction_id,agt_comm,govt_comm,agent_org_id,game_id,trans_date) values(?,?,?,?,?,?)&quot;);</span>

<span class="nc" id="L1586">			PreparedStatement insBoSaleRetpstmt = con.prepareStatement(&quot;insert into st_dg_bo_sale_refund(transaction_id,agent_org_id,game_id,mrp_amt,agent_comm,net_amt,vat_amt,taxable_sale,govt_comm,cancellation_charges) values(?,?,?,?,?,?,?,?,?,?)&quot;);</span>
			//PreparedStatement updAgtSaleRetPstmt = con.prepareStatement(&quot;update st_dg_agt_sale_refund a inner join (select transaction_date,transaction_type,transaction_id,agt_comm,govt_comm from st_lms_agent_transaction_master a inner join st_temp_update_ledger b on a.transaction_id = b.trans_id) b on a.transaction_id = b.transaction_id set claim_status='DONE_CLAIM',bo_ref_transaction_id=? where a.agent_org_id=? and b.agt_comm=? and b.govt_comm=? and DATE(transaction_date)=? and transaction_type=? and game_id=?&quot;);

<span class="nc" id="L1589">			int gameId = 0;</span>
<span class="nc" id="L1590">			double ppr = 0.0;</span>
<span class="nc" id="L1591">			double vatAmt = 0.0;</span>
<span class="nc" id="L1592">			final int batchSize = 500;</span>
<span class="nc" id="L1593">			int count = 0;</span>
<span class="nc" id="L1594">			tempStmt=con.createStatement();</span>
<span class="nc" id="L1595">			tempStmt.execute(&quot;delete from  agentTransSummary &quot;);</span>
<span class="nc" id="L1596">			pstmt = con.prepareStatement(saleQry);</span>
<span class="nc" id="L1597">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1598" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1599">				agtOrgId = rs.getInt(&quot;agent_org_id&quot;);</span>
<span class="nc" id="L1600">				boUserId = rs.getInt(&quot;boUserId&quot;);</span>
<span class="nc" id="L1601">				boOrgId = rs.getInt(&quot;boOrgId&quot;);</span>
<span class="nc" id="L1602">				gameId = rs.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L1603">				logger.debug(&quot;--Agent Org Id--&quot;+agtOrgId+&quot;--Agent Sale tran for game No&quot; + gameId);</span>
<span class="nc" id="L1604">				totalMrpAmt = rs.getDouble(&quot;totalMrp&quot;);</span>
<span class="nc" id="L1605">				totalAgtComm = rs.getDouble(&quot;totalagtComm&quot;);</span>
<span class="nc" id="L1606">				totalGoodCauseAmt = rs.getDouble(&quot;totalgovtComm&quot;);</span>
<span class="nc" id="L1607">				agtCommRate = rs.getDouble(&quot;agt_comm&quot;);</span>
<span class="nc" id="L1608">				govtCommRate = rs.getDouble(&quot;govt_comm&quot;);</span>
<span class="nc" id="L1609">				transDate = rs.getString(&quot;transaction_date&quot;);</span>
<span class="nc" id="L1610">				vatAmt = rs.getDouble(&quot;vat_amt&quot;);</span>
<span class="nc" id="L1611">				ppr = rs.getDouble(&quot;prize_payout_ratio&quot;);</span>
<span class="nc" id="L1612">				totalAgtNetAmt = totalMrpAmt - totalAgtComm;</span>
<span class="nc" id="L1613">				double totalAgtVat =rs.getDouble(&quot;totalVat&quot;);</span>
				/*double totalAgtVat = CommonMethods.calculateDrawGameVatAgt(
						totalMrpAmt, agtCommRate, ppr, govtCommRate, vatAmt);*/
<span class="nc" id="L1616">				double tatalAgtTaxableSale = CommonMethods.calTaxableSale(</span>
						totalMrpAmt, agtCommRate, ppr, govtCommRate, vatAmt);

<span class="nc bnc" id="L1619" title="All 2 branches missed.">				if (orgIdAmountMap.containsKey(agtOrgId)) {</span>
<span class="nc" id="L1620">					agtDebitAmount = orgIdAmountMap.get(agtOrgId)</span>
							+ totalAgtNetAmt;
				} else {
<span class="nc" id="L1623">					agtDebitAmount = totalAgtNetAmt;</span>
				}

<span class="nc" id="L1626">				orgIdAmountMap.put(agtOrgId, agtDebitAmount);</span>
<span class="nc" id="L1627">				orgIdParentIdMap.put(agtOrgId, boOrgId);</span>

<span class="nc bnc" id="L1629" title="All 2 branches missed.">				if (orgIdTransIdInvMap.containsKey(agtOrgId)) {</span>
<span class="nc" id="L1630">					transIdInvMap = orgIdTransIdInvMap.get(agtOrgId);</span>
				} else {
<span class="nc" id="L1632">					transIdInvMap = new HashMap&lt;String, List&lt;Long&gt;&gt;();</span>
<span class="nc" id="L1633">					orgIdTransIdInvMap.put(agtOrgId, transIdInvMap);</span>
				}

				// insert in main transaction table

<span class="nc" id="L1638">				pstmtBO.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L1639">				pstmtBO.executeUpdate();</span>
<span class="nc" id="L1640">				ResultSet rsTrns = pstmtBO.getGeneratedKeys();</span>
<span class="nc bnc" id="L1641" title="All 2 branches missed.">				if (rsTrns.next()) {</span>
<span class="nc" id="L1642">					long transId = rsTrns.getLong(1);</span>

<span class="nc bnc" id="L1644" title="All 2 branches missed.">					if (!transIdInvMap.containsKey(transDate)) {</span>
<span class="nc" id="L1645">						transIdInvMap.put(transDate, new ArrayList&lt;Long&gt;());</span>
					}

<span class="nc" id="L1648">					transIdInvMap.get(transDate).add(transId);</span>

<span class="nc" id="L1650">					insBoTranPstmt.setLong(1, transId);</span>
<span class="nc" id="L1651">					insBoTranPstmt.setInt(2, boUserId);</span>
<span class="nc" id="L1652">					insBoTranPstmt.setInt(3, boOrgId);</span>
<span class="nc" id="L1653">					insBoTranPstmt.setString(4, &quot;AGENT&quot;);</span>
<span class="nc" id="L1654">					insBoTranPstmt.setInt(5, agtOrgId);</span>
<span class="nc" id="L1655">					insBoTranPstmt.setTimestamp(6,</span>
							fetchTransTimeStamp(transDate));
<span class="nc" id="L1657">					insBoTranPstmt.setString(7, &quot;DG_SALE&quot;);</span>
<span class="nc" id="L1658">					insBoTranPstmt.executeUpdate();</span>

<span class="nc" id="L1660">					insBoSalePstmt.setLong(1, transId);</span>
<span class="nc" id="L1661">					insBoSalePstmt.setInt(2, agtOrgId);</span>
<span class="nc" id="L1662">					insBoSalePstmt.setInt(3, gameId);</span>
<span class="nc" id="L1663">					insBoSalePstmt.setDouble(4, totalMrpAmt);</span>
<span class="nc" id="L1664">					insBoSalePstmt.setDouble(5, totalAgtComm);</span>
<span class="nc" id="L1665">					insBoSalePstmt.setDouble(6, totalAgtNetAmt);</span>
<span class="nc" id="L1666">					insBoSalePstmt.setDouble(7, totalAgtVat);</span>
<span class="nc" id="L1667">					insBoSalePstmt.setDouble(8, tatalAgtTaxableSale);</span>
<span class="nc" id="L1668">					insBoSalePstmt.setDouble(9, totalGoodCauseAmt);</span>
<span class="nc" id="L1669">					insBoSalePstmt.executeUpdate();</span>

					
					//insert temp table
<span class="nc" id="L1673">					insTempTablePstmt.setLong(1, transId);</span>
<span class="nc" id="L1674">					insTempTablePstmt.setDouble(2, agtCommRate);</span>
<span class="nc" id="L1675">					insTempTablePstmt.setDouble(3, govtCommRate);</span>
<span class="nc" id="L1676">					insTempTablePstmt.setInt(4, agtOrgId);</span>
<span class="nc" id="L1677">					insTempTablePstmt.setInt(5, gameId);</span>
<span class="nc" id="L1678">					insTempTablePstmt.setString(6, transDate);</span>
<span class="nc" id="L1679">					insTempTablePstmt.addBatch();</span>
<span class="nc bnc" id="L1680" title="All 2 branches missed.">					if(++count % batchSize == 0) {</span>
<span class="nc" id="L1681">						insTempTablePstmt.executeBatch();</span>
				    }
					
					
					/*// update retailer table

					updAgtSalepstmt.setLong(1, transId); // agent trans Id
					updAgtSalepstmt.setInt(2, agtOrgId);
					updAgtSalepstmt.setDouble(3, agtCommRate);
					updAgtSalepstmt.setDouble(4, govtCommRate);
					updAgtSalepstmt.setString(5, transDate);
					updAgtSalepstmt.setInt(6, gameId);
					updAgtSalepstmt.executeUpdate();*/
				}

<span class="nc" id="L1696">			}</span>

<span class="nc" id="L1698">			insTempTablePstmt.executeBatch();</span>
			
			
<span class="nc" id="L1701">			tempStmt.executeUpdate(&quot;update st_dg_agt_sale  sale inner join (select yy.transaction_id,xx.bo_ref_transaction_id,game_id from agentTransSummary xx inner join (select transaction_id,transaction_date,user_org_id agent_org_id,agt_comm,govt_comm from st_lms_agent_transaction_master a inner join st_temp_update_ledger b on a.transaction_id = b.trans_id)yy on DATE(trans_date)=DATE(transaction_date) and xx.agent_org_id=yy.agent_org_id and  xx.agt_comm=yy.agt_comm and xx.govt_comm=yy.govt_comm ) tlb on sale.transaction_id=tlb.transaction_id and  sale.game_id=tlb.game_id set sale.claim_status='DONE_CLAIM',sale.bo_ref_transaction_id=tlb.bo_ref_transaction_id&quot;);</span>
<span class="nc" id="L1702">			tempStmt.execute(&quot;delete from  agentTransSummary &quot;);</span>
		
			
<span class="nc" id="L1705">			pstmt = con.prepareStatement(saleReturnQry);</span>
<span class="nc" id="L1706">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1707" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1708">				agtOrgId = rs.getInt(&quot;agent_org_id&quot;);</span>
<span class="nc" id="L1709">				boUserId = rs.getInt(&quot;boUserId&quot;);</span>
<span class="nc" id="L1710">				boOrgId = rs.getInt(&quot;boOrgId&quot;);</span>
<span class="nc" id="L1711">				gameId = rs.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L1712">				logger.debug(&quot;--Agent Org Id--&quot;+agtOrgId+&quot;--Agent Sale Cancel tran for game No&quot; + gameId);</span>
<span class="nc" id="L1713">				totalMrpAmt = rs.getDouble(&quot;totalMrp&quot;);</span>
<span class="nc" id="L1714">				totalAgtComm = rs.getDouble(&quot;totalagtComm&quot;);</span>
<span class="nc" id="L1715">				totalGoodCauseAmt = rs.getDouble(&quot;totalgovtComm&quot;);</span>
<span class="nc" id="L1716">				totalCancelCharge = rs.getDouble(&quot;totalCancelCharge&quot;);</span>
<span class="nc" id="L1717">				agtCommRate = rs.getDouble(&quot;agt_comm&quot;);</span>
<span class="nc" id="L1718">				govtCommRate = rs.getDouble(&quot;govt_comm&quot;);</span>
<span class="nc" id="L1719">				transDate = rs.getString(&quot;transaction_date&quot;);</span>
<span class="nc" id="L1720">				vatAmt = rs.getDouble(&quot;vat_amt&quot;);</span>
<span class="nc" id="L1721">				ppr = rs.getDouble(&quot;prize_payout_ratio&quot;);</span>
<span class="nc" id="L1722">				totalAgtNetAmt = totalMrpAmt - totalAgtComm - totalCancelCharge;</span>
<span class="nc" id="L1723">				String tranType = rs.getString(&quot;transaction_type&quot;);</span>
<span class="nc" id="L1724">				double totalAgtVat =rs.getDouble(&quot;totalVat&quot;);</span>
				/*double totalAgtVat = CommonMethods.calculateDrawGameVatAgt(
						totalMrpAmt, agtCommRate, ppr, govtCommRate, vatAmt);*/
<span class="nc" id="L1727">				double tatalAgtTaxableSale = CommonMethods.calTaxableSale(</span>
						totalMrpAmt, agtCommRate, ppr, govtCommRate, vatAmt);

<span class="nc bnc" id="L1730" title="All 2 branches missed.">				if (orgIdAmountMap.containsKey(agtOrgId)) {</span>
<span class="nc" id="L1731">					agtDebitAmount = orgIdAmountMap.get(agtOrgId)</span>
							- totalAgtNetAmt;
				} else {
<span class="nc" id="L1734">					agtDebitAmount = -totalAgtNetAmt;</span>
				}

<span class="nc" id="L1737">				orgIdAmountMap.put(agtOrgId, agtDebitAmount);</span>
<span class="nc" id="L1738">				orgIdParentIdMap.put(agtOrgId, boOrgId);</span>

<span class="nc bnc" id="L1740" title="All 2 branches missed.">				if (orgIdTransIdInvRetMap.containsKey(agtOrgId)) {</span>
<span class="nc" id="L1741">					transIdInvRetMap = orgIdTransIdInvRetMap.get(agtOrgId);</span>
				} else {
<span class="nc" id="L1743">					transIdInvRetMap = new HashMap&lt;String, List&lt;Long&gt;&gt;();</span>
<span class="nc" id="L1744">					orgIdTransIdInvRetMap.put(agtOrgId, transIdInvRetMap);</span>
				}

				// insert in main transaction table

<span class="nc" id="L1749">				pstmtBO.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L1750">				pstmtBO.executeUpdate();</span>
<span class="nc" id="L1751">				ResultSet rsTrns = pstmtBO.getGeneratedKeys();</span>
<span class="nc bnc" id="L1752" title="All 2 branches missed.">				if (rsTrns.next()) {</span>
<span class="nc" id="L1753">					long transId = rsTrns.getLong(1);</span>

<span class="nc bnc" id="L1755" title="All 2 branches missed.">					if (!transIdInvRetMap.containsKey(transDate)) {</span>
<span class="nc" id="L1756">						transIdInvRetMap.put(transDate,</span>
								new ArrayList&lt;Long&gt;());
					}

<span class="nc" id="L1760">					transIdInvRetMap.get(transDate).add(transId);</span>

<span class="nc" id="L1762">					insBoTranPstmt.setLong(1, transId);</span>
<span class="nc" id="L1763">					insBoTranPstmt.setInt(2, boUserId);</span>
<span class="nc" id="L1764">					insBoTranPstmt.setInt(3, boOrgId);</span>
<span class="nc" id="L1765">					insBoTranPstmt.setString(4, &quot;AGENT&quot;);</span>
<span class="nc" id="L1766">					insBoTranPstmt.setInt(5, agtOrgId);</span>
<span class="nc" id="L1767">					insBoTranPstmt.setTimestamp(6,</span>
							fetchTransTimeStamp(transDate));
<span class="nc" id="L1769">					insBoTranPstmt.setString(7, tranType);</span>
<span class="nc" id="L1770">					insBoTranPstmt.executeUpdate();</span>

<span class="nc" id="L1772">					insBoSaleRetpstmt.setLong(1, transId);</span>
<span class="nc" id="L1773">					insBoSaleRetpstmt.setInt(2, agtOrgId);</span>
<span class="nc" id="L1774">					insBoSaleRetpstmt.setInt(3, gameId);</span>
<span class="nc" id="L1775">					insBoSaleRetpstmt.setDouble(4, totalMrpAmt);</span>
<span class="nc" id="L1776">					insBoSaleRetpstmt.setDouble(5, totalAgtComm);</span>
<span class="nc" id="L1777">					insBoSaleRetpstmt.setDouble(6, totalAgtNetAmt);</span>
<span class="nc" id="L1778">					insBoSaleRetpstmt.setDouble(7, totalAgtVat);</span>
<span class="nc" id="L1779">					insBoSaleRetpstmt.setDouble(8, tatalAgtTaxableSale);</span>
<span class="nc" id="L1780">					insBoSaleRetpstmt.setDouble(9, totalGoodCauseAmt);</span>
<span class="nc" id="L1781">					insBoSaleRetpstmt.setDouble(10, totalCancelCharge);</span>
<span class="nc" id="L1782">					insBoSaleRetpstmt.executeUpdate();</span>

					//insert temp table
<span class="nc" id="L1785">					insTempTablePstmt.setLong(1, transId);</span>
<span class="nc" id="L1786">					insTempTablePstmt.setDouble(2, agtCommRate);</span>
<span class="nc" id="L1787">					insTempTablePstmt.setDouble(3, govtCommRate);</span>
<span class="nc" id="L1788">					insTempTablePstmt.setInt(4, agtOrgId);</span>
<span class="nc" id="L1789">					insTempTablePstmt.setInt(5, gameId);</span>
<span class="nc" id="L1790">					insTempTablePstmt.setString(6, transDate);</span>
<span class="nc" id="L1791">					insTempTablePstmt.addBatch();</span>
<span class="nc bnc" id="L1792" title="All 2 branches missed.">					if(++count % batchSize == 0) {</span>
<span class="nc" id="L1793">						insTempTablePstmt.executeBatch();</span>
				    }
					
					
					/*// update retailer table

					updAgtSaleRetPstmt.setLong(1, transId); // agent trans Id
					updAgtSaleRetPstmt.setInt(2, agtOrgId);
					updAgtSaleRetPstmt.setDouble(3, agtCommRate);
					updAgtSaleRetPstmt.setDouble(4, govtCommRate);
					updAgtSaleRetPstmt.setString(5, transDate);
					updAgtSaleRetPstmt.setString(6, tranType);
					updAgtSaleRetPstmt.setInt(7, gameId);
					updAgtSaleRetPstmt.executeUpdate();*/
				}

<span class="nc" id="L1809">			}</span>
<span class="nc" id="L1810">			insTempTablePstmt.executeBatch();</span>
			
			
<span class="nc" id="L1813">			tempStmt.executeUpdate(&quot;update st_dg_agt_sale_refund  sale inner join (select yy.transaction_id,xx.bo_ref_transaction_id,game_id from agentTransSummary xx inner join (select transaction_id,transaction_date,user_org_id agent_org_id,agt_comm,govt_comm from st_lms_agent_transaction_master a inner join st_temp_update_ledger b on a.transaction_id = b.trans_id)yy on DATE(trans_date)=DATE(transaction_date) and xx.agent_org_id=yy.agent_org_id and  xx.agt_comm=yy.agt_comm and xx.govt_comm=yy.govt_comm ) tlb on sale.transaction_id=tlb.transaction_id and  sale.game_id=tlb.game_id set sale.claim_status='DONE_CLAIM',sale.bo_ref_transaction_id=tlb.bo_ref_transaction_id&quot;);</span>
<span class="nc" id="L1814">			tempStmt.execute(&quot;delete from  agentTransSummary &quot;);</span>
		
<span class="nc" id="L1816">			generateDGReceiptForBONew(orgIdTransIdInvMap, orgIdParentIdMap,</span>
					&quot;DG_INVOICE&quot;, &quot;DG_RECEIPT&quot;, con);
<span class="nc" id="L1818">			generateDGReceiptForBONew(orgIdTransIdInvRetMap, orgIdParentIdMap,</span>
					&quot;CR_NOTE&quot;, &quot;CR_NOTE_CASH&quot;, con);

<span class="nc" id="L1821">			logger.debug(&quot;agent orgIdAmountMap\n&quot; + orgIdAmountMap);</span>
			// update agent balance
<span class="nc" id="L1823">			Set&lt;Integer&gt; agtOrgIdSet = orgIdAmountMap.keySet();</span>
<span class="nc bnc" id="L1824" title="All 2 branches missed.">			for (Integer orgId : agtOrgIdSet) {</span>
<span class="nc" id="L1825">				boolean isValid=OrgCreditUpdation.updateOrganizationBalWithValidate(CommonMethods.fmtToTwoDecimal(orgIdAmountMap.get(orgId)), &quot;TRANSACTION&quot;, &quot;DRAW_GAME_SALE&quot;, orgId,</span>
						0, &quot;AGENT&quot;, 0, con);
<span class="nc bnc" id="L1827" title="All 2 branches missed.">				if(!isValid)</span>
<span class="nc" id="L1828">					throw new LMSException();</span>
<span class="nc" id="L1829">				OrgCreditUpdation.updateOrganizationBalWithValidate(CommonMethods.fmtToTwoDecimal(orgIdAmountMap.get(orgId)), &quot;CLAIM_BAL&quot;, &quot;DEBIT&quot;, orgId,</span>
						0, &quot;AGENT&quot;, 0, con);
				
				/*OrgCreditUpdation.updateCreditLimitForAgent(orgId,
						&quot;DRAW_GAME_SALE&quot;, orgIdAmountMap.get(orgId), con);
				updateOrgBalance(&quot;CLAIM_BAL&quot;, orgIdAmountMap.get(orgId), orgId,
						&quot;DEBIT&quot;, con);*/
<span class="nc" id="L1836">			}</span>
<span class="nc" id="L1837">		} catch (Exception e) {</span>
<span class="nc" id="L1838">			e.printStackTrace();</span>
<span class="nc" id="L1839">			throw new LMSException(&quot;error in sale agent&quot;);</span>
<span class="nc" id="L1840">		}</span>
<span class="nc" id="L1841">		logger.debug(new Date() + &quot;---end-dg sale update for agent--&quot;</span>
				+ new Date().getTime());
<span class="nc" id="L1843">	}</span>
	
	
	public void updateDGSaleLedgerForAgtwithoutComm(Connection con) throws LMSException {
<span class="nc" id="L1847">		logger.debug(new Date() + &quot;---start-dg sale update for agent--&quot;</span>
				+ new Date().getTime());
<span class="nc" id="L1849">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L1850">		ResultSet rs = null;</span>
		double totalMrpAmt, totalAgtComm, totalGoodCauseAmt, totalAgtNetAmt, totalCancelCharge;
		double agtCommRate, govtCommRate, agtDebitAmount;
		String transDate;
		int agtOrgId, boUserId, boOrgId;
<span class="nc" id="L1855">		Map&lt;Integer, Double&gt; orgIdAmountMap = new HashMap&lt;Integer, Double&gt;();</span>
<span class="nc" id="L1856">		Map&lt;Integer, Integer&gt; orgIdParentIdMap = new HashMap&lt;Integer, Integer&gt;();</span>
<span class="nc" id="L1857">		Map&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt; orgIdTransIdInvMap = new HashMap&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt;();</span>
<span class="nc" id="L1858">		Map&lt;String, List&lt;Long&gt;&gt; transIdInvMap = null;</span>
<span class="nc" id="L1859">		Map&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt; orgIdTransIdInvRetMap = new HashMap&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt;();</span>
<span class="nc" id="L1860">		Map&lt;String, List&lt;Long&gt;&gt; transIdInvRetMap = null;</span>
		try {
<span class="nc" id="L1862">			String saleQry = &quot;select agent_org_id,boUserId,boOrgId,totalMrp,totalRetComm,totalagtComm,totalgovtComm,totalVat,totalTaxSale,game_id,transaction_date from(select a.agent_org_id,sum(mrp_amt) totalMrp ,sum(retailer_comm) totalRetComm,sum(agent_comm) totalagtComm, sum(a.govt_comm) totalgovtComm, sum(vat_amt) totalVat,sum(taxable_sale) totalTaxSale,a.game_id,DATE(transaction_date) 'transaction_date' from st_dg_agt_sale a inner join  st_lms_agent_transaction_master b on a.transaction_id = b.transaction_id where claim_status='CLAIM_BAL' group by a.agent_org_id,DATE(transaction_date),a.game_id order by agent_org_id,game_id,transaction_date) sale inner join (select um.user_id agtUserId,um.organization_id agtOrgId,um.parent_user_id boUserId,om.parent_id boOrgId,isrolehead from st_lms_organization_master om inner join st_lms_user_master um on om.organization_id=um.organization_id where om.organization_type='AGENT') om on agent_org_id=agtOrgId and isrolehead = 'Y'&quot;;</span>
<span class="nc" id="L1863">			String saleReturnQry = &quot;select agent_org_id,boUserId,boOrgId,totalMrp,totalRetComm,totalagtComm,totalgovtComm,totalVat,totalTaxSale,totalCancelCharge,game_id,transaction_date,transaction_type from(select a.agent_org_id,sum(mrp_amt) totalMrp ,sum(retailer_comm) totalRetComm,sum(agent_comm) totalagtComm, sum(a.govt_comm) totalgovtComm, sum(vat_amt) totalVat,sum(taxable_sale) totalTaxSale,sum(cancellation_charges) totalCancelCharge,a.game_id,DATE(transaction_date) 'transaction_date',transaction_type from st_dg_agt_sale_refund a inner join  st_lms_agent_transaction_master b on a.transaction_id = b.transaction_id where claim_status='CLAIM_BAL' group by a.agent_org_id,DATE(transaction_date),a.game_id,transaction_type  order by agent_org_id,game_id,transaction_date) saleRefund inner join (select um.user_id agtUserId,um.organization_id agtOrgId,um.parent_user_id boUserId,om.parent_id boOrgId,isrolehead from st_lms_organization_master om inner join st_lms_user_master um on om.organization_id=um.organization_id where om.organization_type='AGENT') d on agent_org_id=agtOrgId and isrolehead = 'Y'&quot;;</span>

<span class="nc" id="L1865">			PreparedStatement pstmtBO = con.prepareStatement(QueryManager</span>
					.insertInLMSTransactionMaster());
<span class="nc" id="L1867">			PreparedStatement insBoTranPstmt = con</span>
					.prepareStatement(QueryManager
							.insertInBOTransactionMaster());
<span class="nc" id="L1870">			PreparedStatement insBoSalePstmt = con</span>
					.prepareStatement(&quot;insert into st_dg_bo_sale(transaction_id,agent_org_id,game_id,mrp_amt,agent_comm,net_amt,vat_amt,taxable_sale,govt_comm) values(?,?,?,?,?,?,?,?,?)&quot;);
<span class="nc" id="L1872">			PreparedStatement updAgtSalepstmt = con</span>
					.prepareStatement(&quot;update st_dg_agt_sale a inner join st_lms_agent_transaction_master b on a.transaction_id = b.transaction_id set claim_status='DONE_CLAIM',bo_ref_transaction_id=? where a.agent_org_id=? and DATE(transaction_date)=? and game_id=?&quot;);
<span class="nc" id="L1874">			PreparedStatement insBoSaleRetpstmt = con</span>
					.prepareStatement(&quot;insert into st_dg_bo_sale_refund(transaction_id,agent_org_id,game_id,mrp_amt,agent_comm,net_amt,vat_amt,taxable_sale,govt_comm,cancellation_charges) values(?,?,?,?,?,?,?,?,?,?)&quot;);
<span class="nc" id="L1876">			PreparedStatement updAgtSaleRetPstmt = con</span>
					.prepareStatement(&quot;update st_dg_agt_sale_refund a inner join st_lms_agent_transaction_master b on a.transaction_id = b.transaction_id set claim_status='DONE_CLAIM',bo_ref_transaction_id=? where a.agent_org_id=? and DATE(transaction_date)=? and transaction_type=? and game_id=?&quot;);

<span class="nc" id="L1879">			int gameId = 0;</span>
<span class="nc" id="L1880">			double ppr = 0.0;</span>
<span class="nc" id="L1881">			double vatAmt = 0.0;</span>

<span class="nc" id="L1883">			pstmt = con.prepareStatement(saleQry);</span>
<span class="nc" id="L1884">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1885" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1886">				agtOrgId = rs.getInt(&quot;agent_org_id&quot;);</span>
<span class="nc" id="L1887">				boUserId = rs.getInt(&quot;boUserId&quot;);</span>
<span class="nc" id="L1888">				boOrgId = rs.getInt(&quot;boOrgId&quot;);</span>
<span class="nc" id="L1889">				gameId = rs.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L1890">				logger.debug(&quot;--Agent Org Id--&quot;+agtOrgId+&quot;--Agent Sale tran for game No&quot; + gameId);</span>
<span class="nc" id="L1891">				totalMrpAmt = rs.getDouble(&quot;totalMrp&quot;);</span>
<span class="nc" id="L1892">				totalAgtComm = rs.getDouble(&quot;totalagtComm&quot;);</span>
<span class="nc" id="L1893">				totalGoodCauseAmt = rs.getDouble(&quot;totalgovtComm&quot;);</span>
<span class="nc bnc" id="L1894" title="All 2 branches missed.">				agtCommRate = totalMrpAmt!=0?(totalAgtComm/totalMrpAmt)*100:0;</span>
<span class="nc bnc" id="L1895" title="All 2 branches missed.">				govtCommRate = totalMrpAmt!=0?(totalGoodCauseAmt/totalMrpAmt)*100:0;</span>
<span class="nc" id="L1896">				transDate = rs.getString(&quot;transaction_date&quot;);</span>

<span class="nc" id="L1898">				totalAgtNetAmt = totalMrpAmt - totalAgtComm;</span>

<span class="nc" id="L1900">				double totalAgtVat = CommonMethods.calculateDrawGameVatAgt(</span>
						totalMrpAmt, agtCommRate, ppr, govtCommRate, vatAmt);
<span class="nc" id="L1902">				double tatalAgtTaxableSale = CommonMethods.calTaxableSale(</span>
						totalMrpAmt, agtCommRate, ppr, govtCommRate, vatAmt);

<span class="nc bnc" id="L1905" title="All 2 branches missed.">				if (orgIdAmountMap.containsKey(agtOrgId)) {</span>
<span class="nc" id="L1906">					agtDebitAmount = orgIdAmountMap.get(agtOrgId)</span>
							+ totalAgtNetAmt;
				} else {
<span class="nc" id="L1909">					agtDebitAmount = totalAgtNetAmt;</span>
				}

<span class="nc" id="L1912">				orgIdAmountMap.put(agtOrgId, agtDebitAmount);</span>
<span class="nc" id="L1913">				orgIdParentIdMap.put(agtOrgId, boOrgId);</span>

<span class="nc bnc" id="L1915" title="All 2 branches missed.">				if (orgIdTransIdInvMap.containsKey(agtOrgId)) {</span>
<span class="nc" id="L1916">					transIdInvMap = orgIdTransIdInvMap.get(agtOrgId);</span>
				} else {
<span class="nc" id="L1918">					transIdInvMap = new HashMap&lt;String, List&lt;Long&gt;&gt;();</span>
<span class="nc" id="L1919">					orgIdTransIdInvMap.put(agtOrgId, transIdInvMap);</span>
				}

				// insert in main transaction table

<span class="nc" id="L1924">				pstmtBO.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L1925">				pstmtBO.executeUpdate();</span>
<span class="nc" id="L1926">				ResultSet rsTrns = pstmtBO.getGeneratedKeys();</span>
<span class="nc bnc" id="L1927" title="All 2 branches missed.">				if (rsTrns.next()) {</span>
<span class="nc" id="L1928">					long transId = rsTrns.getLong(1);</span>

<span class="nc bnc" id="L1930" title="All 2 branches missed.">					if (!transIdInvMap.containsKey(transDate)) {</span>
<span class="nc" id="L1931">						transIdInvMap.put(transDate, new ArrayList&lt;Long&gt;());</span>
					}

<span class="nc" id="L1934">					transIdInvMap.get(transDate).add(transId);</span>

<span class="nc" id="L1936">					insBoTranPstmt.setLong(1, transId);</span>
<span class="nc" id="L1937">					insBoTranPstmt.setInt(2, boUserId);</span>
<span class="nc" id="L1938">					insBoTranPstmt.setInt(3, boOrgId);</span>
<span class="nc" id="L1939">					insBoTranPstmt.setString(4, &quot;AGENT&quot;);</span>
<span class="nc" id="L1940">					insBoTranPstmt.setInt(5, agtOrgId);</span>
<span class="nc" id="L1941">					insBoTranPstmt.setTimestamp(6,</span>
							fetchTransTimeStamp(transDate));
<span class="nc" id="L1943">					insBoTranPstmt.setString(7, &quot;DG_SALE&quot;);</span>
<span class="nc" id="L1944">					insBoTranPstmt.executeUpdate();</span>

<span class="nc" id="L1946">					insBoSalePstmt.setLong(1, transId);</span>
<span class="nc" id="L1947">					insBoSalePstmt.setInt(2, agtOrgId);</span>
<span class="nc" id="L1948">					insBoSalePstmt.setInt(3, gameId);</span>
<span class="nc" id="L1949">					insBoSalePstmt.setDouble(4, totalMrpAmt);</span>
<span class="nc" id="L1950">					insBoSalePstmt.setDouble(5, totalAgtComm);</span>
<span class="nc" id="L1951">					insBoSalePstmt.setDouble(6, totalAgtNetAmt);</span>
<span class="nc" id="L1952">					insBoSalePstmt.setDouble(7, totalAgtVat);</span>
<span class="nc" id="L1953">					insBoSalePstmt.setDouble(8, tatalAgtTaxableSale);</span>
<span class="nc" id="L1954">					insBoSalePstmt.setDouble(9, totalGoodCauseAmt);</span>
<span class="nc" id="L1955">					insBoSalePstmt.executeUpdate();</span>

					// update retailer table

<span class="nc" id="L1959">					updAgtSalepstmt.setLong(1, transId); // agent trans Id</span>
<span class="nc" id="L1960">					updAgtSalepstmt.setInt(2, agtOrgId);</span>
//					updAgtSalepstmt.setDouble(3, agtCommRate);
//					updAgtSalepstmt.setDouble(4, govtCommRate);
<span class="nc" id="L1963">					updAgtSalepstmt.setString(3, transDate);</span>
<span class="nc" id="L1964">					updAgtSalepstmt.setInt(4, gameId);</span>
<span class="nc" id="L1965">					updAgtSalepstmt.executeUpdate();</span>
				}

<span class="nc" id="L1968">			}</span>

<span class="nc" id="L1970">			pstmt = con.prepareStatement(saleReturnQry);</span>
<span class="nc" id="L1971">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1972" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1973">				agtOrgId = rs.getInt(&quot;agent_org_id&quot;);</span>
<span class="nc" id="L1974">				boUserId = rs.getInt(&quot;boUserId&quot;);</span>
<span class="nc" id="L1975">				boOrgId = rs.getInt(&quot;boOrgId&quot;);</span>
<span class="nc" id="L1976">				gameId = rs.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L1977">				logger.debug(&quot;--Agent Org Id--&quot;+agtOrgId+&quot;--Agent Sale Cancel tran for game No&quot; + gameId);</span>
<span class="nc" id="L1978">				totalMrpAmt = rs.getDouble(&quot;totalMrp&quot;);</span>
<span class="nc" id="L1979">				totalAgtComm = rs.getDouble(&quot;totalagtComm&quot;);</span>
<span class="nc" id="L1980">				totalGoodCauseAmt = rs.getDouble(&quot;totalgovtComm&quot;);</span>
<span class="nc" id="L1981">				totalCancelCharge = rs.getDouble(&quot;totalCancelCharge&quot;);</span>
<span class="nc bnc" id="L1982" title="All 2 branches missed.">				agtCommRate = totalMrpAmt!=0?(totalAgtComm/totalMrpAmt)*100:0;</span>
<span class="nc bnc" id="L1983" title="All 2 branches missed.">				govtCommRate = totalMrpAmt!=0?(totalGoodCauseAmt/totalMrpAmt)*100:0;</span>
<span class="nc" id="L1984">				transDate = rs.getString(&quot;transaction_date&quot;);</span>

<span class="nc" id="L1986">				totalAgtNetAmt = totalMrpAmt - totalAgtComm - totalCancelCharge;</span>
<span class="nc" id="L1987">				String tranType = rs.getString(&quot;transaction_type&quot;);</span>

<span class="nc" id="L1989">				double totalAgtVat = CommonMethods.calculateDrawGameVatAgt(</span>
						totalMrpAmt, agtCommRate, ppr, govtCommRate, vatAmt);
<span class="nc" id="L1991">				double tatalAgtTaxableSale = CommonMethods.calTaxableSale(</span>
						totalMrpAmt, agtCommRate, ppr, govtCommRate, vatAmt);

<span class="nc bnc" id="L1994" title="All 2 branches missed.">				if (orgIdAmountMap.containsKey(agtOrgId)) {</span>
<span class="nc" id="L1995">					agtDebitAmount = orgIdAmountMap.get(agtOrgId)</span>
							- totalAgtNetAmt;
				} else {
<span class="nc" id="L1998">					agtDebitAmount = -totalAgtNetAmt;</span>
				}

<span class="nc" id="L2001">				orgIdAmountMap.put(agtOrgId, agtDebitAmount);</span>
<span class="nc" id="L2002">				orgIdParentIdMap.put(agtOrgId, boOrgId);</span>

<span class="nc bnc" id="L2004" title="All 2 branches missed.">				if (orgIdTransIdInvRetMap.containsKey(agtOrgId)) {</span>
<span class="nc" id="L2005">					transIdInvRetMap = orgIdTransIdInvRetMap.get(agtOrgId);</span>
				} else {
<span class="nc" id="L2007">					transIdInvRetMap = new HashMap&lt;String, List&lt;Long&gt;&gt;();</span>
<span class="nc" id="L2008">					orgIdTransIdInvRetMap.put(agtOrgId, transIdInvRetMap);</span>
				}

				// insert in main transaction table

<span class="nc" id="L2013">				pstmtBO.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L2014">				pstmtBO.executeUpdate();</span>
<span class="nc" id="L2015">				ResultSet rsTrns = pstmtBO.getGeneratedKeys();</span>
<span class="nc bnc" id="L2016" title="All 2 branches missed.">				if (rsTrns.next()) {</span>
<span class="nc" id="L2017">					long transId = rsTrns.getLong(1);</span>

<span class="nc bnc" id="L2019" title="All 2 branches missed.">					if (!transIdInvRetMap.containsKey(transDate)) {</span>
<span class="nc" id="L2020">						transIdInvRetMap.put(transDate,</span>
								new ArrayList&lt;Long&gt;());
					}

<span class="nc" id="L2024">					transIdInvRetMap.get(transDate).add(transId);</span>

<span class="nc" id="L2026">					insBoTranPstmt.setLong(1, transId);</span>
<span class="nc" id="L2027">					insBoTranPstmt.setInt(2, boUserId);</span>
<span class="nc" id="L2028">					insBoTranPstmt.setInt(3, boOrgId);</span>
<span class="nc" id="L2029">					insBoTranPstmt.setString(4, &quot;AGENT&quot;);</span>
<span class="nc" id="L2030">					insBoTranPstmt.setInt(5, agtOrgId);</span>
<span class="nc" id="L2031">					insBoTranPstmt.setTimestamp(6,</span>
							fetchTransTimeStamp(transDate));
<span class="nc" id="L2033">					insBoTranPstmt.setString(7, tranType);</span>
<span class="nc" id="L2034">					insBoTranPstmt.executeUpdate();</span>

<span class="nc" id="L2036">					insBoSaleRetpstmt.setLong(1, transId);</span>
<span class="nc" id="L2037">					insBoSaleRetpstmt.setInt(2, agtOrgId);</span>
<span class="nc" id="L2038">					insBoSaleRetpstmt.setInt(3, gameId);</span>
<span class="nc" id="L2039">					insBoSaleRetpstmt.setDouble(4, totalMrpAmt);</span>
<span class="nc" id="L2040">					insBoSaleRetpstmt.setDouble(5, totalAgtComm);</span>
<span class="nc" id="L2041">					insBoSaleRetpstmt.setDouble(6, totalAgtNetAmt);</span>
<span class="nc" id="L2042">					insBoSaleRetpstmt.setDouble(7, totalAgtVat);</span>
<span class="nc" id="L2043">					insBoSaleRetpstmt.setDouble(8, tatalAgtTaxableSale);</span>
<span class="nc" id="L2044">					insBoSaleRetpstmt.setDouble(9, totalGoodCauseAmt);</span>
<span class="nc" id="L2045">					insBoSaleRetpstmt.setDouble(10, totalCancelCharge);</span>
<span class="nc" id="L2046">					insBoSaleRetpstmt.executeUpdate();</span>

					// update retailer table

<span class="nc" id="L2050">					updAgtSaleRetPstmt.setLong(1, transId); // agent trans Id</span>
<span class="nc" id="L2051">					updAgtSaleRetPstmt.setInt(2, agtOrgId);</span>
//					updAgtSaleRetPstmt.setDouble(3, agtCommRate);
//					updAgtSaleRetPstmt.setDouble(4, govtCommRate);
<span class="nc" id="L2054">					updAgtSaleRetPstmt.setString(3, transDate);</span>
<span class="nc" id="L2055">					updAgtSaleRetPstmt.setString(4, tranType);</span>
<span class="nc" id="L2056">					updAgtSaleRetPstmt.setInt(5, gameId);</span>
<span class="nc" id="L2057">					updAgtSaleRetPstmt.executeUpdate();</span>
				}

<span class="nc" id="L2060">			}</span>

<span class="nc" id="L2062">			generateDGReceiptForBONew(orgIdTransIdInvMap, orgIdParentIdMap,</span>
					&quot;DG_INVOICE&quot;, &quot;DG_RECEIPT&quot;, con);
<span class="nc" id="L2064">			generateDGReceiptForBONew(orgIdTransIdInvRetMap, orgIdParentIdMap,</span>
					&quot;CR_NOTE&quot;, &quot;CR_NOTE_CASH&quot;, con);

<span class="nc" id="L2067">			logger.debug(&quot;agent orgIdAmountMap\n&quot; + orgIdAmountMap);</span>
			// update agent balance
<span class="nc" id="L2069">			Set&lt;Integer&gt; agtOrgIdSet = orgIdAmountMap.keySet();</span>
<span class="nc bnc" id="L2070" title="All 2 branches missed.">			for (Integer orgId : agtOrgIdSet) {</span>
<span class="nc" id="L2071">				boolean isValid=OrgCreditUpdation.updateOrganizationBalWithValidate(orgIdAmountMap.get(orgId), &quot;TRANSACTION&quot;, &quot;DRAW_GAME_SALE&quot;, orgId,</span>
						0, &quot;AGENT&quot;, 0, con);
<span class="nc bnc" id="L2073" title="All 2 branches missed.">				if(!isValid)</span>
<span class="nc" id="L2074">					throw new LMSException();</span>
<span class="nc" id="L2075">				OrgCreditUpdation.updateOrganizationBalWithValidate(orgIdAmountMap.get(orgId), &quot;CLAIM_BAL&quot;, &quot;DEBIT&quot;, orgId,</span>
						0, &quot;AGENT&quot;, 0, con);
				/*OrgCreditUpdation.updateCreditLimitForAgent(orgId,
						&quot;DRAW_GAME_SALE&quot;, orgIdAmountMap.get(orgId), con);
				updateOrgBalance(&quot;CLAIM_BAL&quot;, orgIdAmountMap.get(orgId), orgId,
						&quot;DEBIT&quot;, con);*/
<span class="nc" id="L2081">			}</span>
<span class="nc" id="L2082">		} catch (Exception e) {</span>
<span class="nc" id="L2083">			e.printStackTrace();</span>
<span class="nc" id="L2084">			throw new LMSException(&quot;error in sale agent&quot;);</span>
<span class="nc" id="L2085">		}</span>
<span class="nc" id="L2086">		logger.debug(new Date() + &quot;---end-dg sale update for agent--&quot;</span>
				+ new Date().getTime());
<span class="nc" id="L2088">	}</span>

	public void updateDGPwtLedgerForRet(Connection con) throws LMSException {
<span class="nc" id="L2091">		logger.debug(new Date() + &quot;---start-dg pwt update for retailer--&quot;</span>
				+ new Date().getTime());
<span class="nc" id="L2093">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L2094">		ResultSet rs = null;</span>

		try {
<span class="nc" id="L2097">			String gameQry = &quot;select game_id, game_nbr, game_name from st_dg_game_master&quot;;</span>
<span class="nc" id="L2098">			String pwtQry = &quot;select aaa.game_id, bbb.game_nbr, bbb.game_name,retailer_org_id,agtUserId,agtOrgId, aaa.draw_id, sum(aaa.agt_claim_comm) totalAgtComm, sum(aaa.pwt_amt) totalPwtAmt, aaa.pwt_type, sum(aaa.retailer_claim_comm) totalRetComm,DATE(aaa.transaction_date) 'transaction_date', sum(govt_claim_comm) govtClaimComm from((select  b.ticket_nbr,a.retailer_org_id, a.pwt_amt, 'Anonymous' as  'pwt_type' , a.game_id, b.panel_id,   b.draw_id, a.retailer_claim_comm , a.agt_claim_comm,a.govt_claim_comm , 'Anonymous' as name, transaction_date from  st_dg_ret_pwt_?  a, st_dg_pwt_inv_? b, st_lms_retailer_transaction_master c where a.status = 'CLAIM_BAL' and a.transaction_id = b.retailer_transaction_id and  a.transaction_id = c.transaction_id) union all (select  cc.ticket_nbr,aa.retailer_org_id, aa.pwt_amt , 'direct_plr' as  'pwt_type',  aa.game_id, aa.panel_id, cc.draw_id, aa.retailer_claim_comm,  aa.agt_claim_comm, 0,  concat(bb.first_name, ' ', bb.last_name) 'name', transaction_date from  st_dg_ret_direct_plr_pwt aa,  st_lms_player_master bb, st_dg_pwt_inv_? cc where   aa.pwt_claim_status = 'CLAIM_BAL' and aa.player_id = bb.player_id and  aa.transaction_id =   cc.retailer_transaction_id))aaa, st_dg_game_master bbb,(select um.user_id retUserId,um.organization_id retOrgId,um.parent_user_id agtUserId,om.parent_id agtOrgId from st_lms_organization_master om inner join st_lms_user_master um on om.organization_id=um.organization_id where om.organization_type='RETAILER') ccc  where  aaa.game_id = bbb.game_id and retailer_org_id=retOrgId  group by pwt_type,retailer_org_id,aaa.game_id, aaa.draw_id,date(aaa.transaction_date)&quot;;</span>

<span class="nc" id="L2100">			String retPwtUpdateQuery = &quot;update st_dg_ret_pwt_? aa, st_dg_pwt_inv_? bb,st_lms_retailer_transaction_master cc set aa.status = ? ,&quot;</span>
					+ &quot; bb.status = ? , bb.agent_transaction_id =? where aa.transaction_id = bb.retailer_transaction_id and aa.transaction_id=cc.transaction_id &quot;
					+ &quot; and aa.game_id = ? and  bb.draw_id = ?  and aa.retailer_org_id =? and date(cc.transaction_date)=?&quot;;
<span class="nc" id="L2103">			PreparedStatement retPwtUpdatePstmt = con</span>
					.prepareStatement(retPwtUpdateQuery);

<span class="nc" id="L2106">			String retPwtUpdateDirectPlrQry = &quot;update st_dg_ret_direct_plr_pwt aa, st_dg_pwt_inv_? bb,st_lms_retailer_transaction_master cc &quot;</span>
					+ &quot; set aa.pwt_claim_status = ? , bb.status = ? , bb.agent_transaction_id =? where aa.transaction_id = bb.retailer_transaction_id and aa.transaction_id=cc.transaction_id and aa.game_id = ? and bb.draw_id = ? &quot;
					+ &quot; and aa.retailer_org_id =? and date(cc.transaction_date)=?&quot;;
<span class="nc" id="L2109">			PreparedStatement retDirPlrPstmt = con</span>
					.prepareStatement(retPwtUpdateDirectPlrQry);

<span class="nc" id="L2112">			PreparedStatement gameStmt = con.prepareStatement(gameQry);</span>

<span class="nc" id="L2114">			PreparedStatement transMasQueryPstmt = con</span>
					.prepareStatement(QueryManager
							.insertInLMSTransactionMaster());
<span class="nc" id="L2117">			PreparedStatement agtTransMasterPstmt = con</span>
					.prepareStatement(QueryManager
							.insertInAgentTransactionMaster());
<span class="nc" id="L2120">			String agtDGPwtEntry = &quot;insert into st_dg_agt_pwt (agent_user_id, agent_org_id, retailer_org_id, &quot;</span>
					+ &quot; draw_id, game_id, transaction_id, pwt_amt, comm_amt, net_amt, agt_claim_comm, &quot;
					+ &quot; status, govt_claim_comm) values (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?,?)&quot;;
<span class="nc" id="L2123">			PreparedStatement agtPstmt = con.prepareStatement(agtDGPwtEntry);</span>

<span class="nc" id="L2125">			ResultSet gameRs = gameStmt.executeQuery();</span>
<span class="nc" id="L2126">			pstmt = con.prepareStatement(pwtQry);</span>

<span class="nc" id="L2128">			int retOrgId = 0, agtOrgId=0, agtUserId, gameId, drawId;</span>
<span class="nc" id="L2129">			double totalPwtAmt, totalAgtComm, govtClaimComm, totalRetComm, totalNetAmt = 0;</span>
			String pwtType, transDate;
<span class="nc" id="L2131">			Map&lt;Integer, Double&gt; orgAmtMap = new HashMap&lt;Integer, Double&gt;();</span>
<span class="nc" id="L2132">			Map&lt;Integer, Integer&gt; orgIdParentIdMap = new HashMap&lt;Integer, Integer&gt;();</span>
<span class="nc" id="L2133">			Map&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt; orgIdTransIdInvMap = new HashMap&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt;();</span>
<span class="nc" id="L2134">			Map&lt;String, List&lt;Long&gt;&gt; transIdInvMap = null;</span>
<span class="nc bnc" id="L2135" title="All 2 branches missed.">			while (gameRs.next()) {</span>
<span class="nc" id="L2136">				gameId = gameRs.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L2137">				totalNetAmt = 0;</span>
<span class="nc" id="L2138">				pstmt.setInt(1, gameId);</span>
<span class="nc" id="L2139">				pstmt.setInt(2, gameId);</span>
<span class="nc" id="L2140">				pstmt.setInt(3, gameId);</span>
<span class="nc" id="L2141">				rs = pstmt.executeQuery();</span>
<span class="nc" id="L2142">				logger.debug(&quot;--Start PWT tran for game No&quot; + gameId);</span>
<span class="nc bnc" id="L2143" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L2144">					retOrgId = rs.getInt(&quot;retailer_org_id&quot;);</span>
<span class="nc" id="L2145">					agtOrgId = rs.getInt(&quot;agtOrgId&quot;);</span>
<span class="nc" id="L2146">					agtUserId = rs.getInt(&quot;agtUserId&quot;);</span>
<span class="nc" id="L2147">					gameId = rs.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L2148">					drawId = rs.getInt(&quot;draw_id&quot;);</span>
<span class="nc" id="L2149">					totalPwtAmt = rs.getDouble(&quot;totalPwtAmt&quot;);</span>
<span class="nc" id="L2150">					totalAgtComm = rs.getDouble(&quot;totalAgtComm&quot;);</span>
<span class="nc" id="L2151">					govtClaimComm= rs.getDouble(&quot;govtClaimComm&quot;);</span>
<span class="nc" id="L2152">					totalRetComm = rs.getDouble(&quot;totalRetComm&quot;);</span>
<span class="nc" id="L2153">					pwtType = rs.getString(&quot;pwt_type&quot;);</span>
<span class="nc" id="L2154">					transDate = rs.getString(&quot;transaction_date&quot;);</span>
<span class="nc" id="L2155">					totalNetAmt = totalPwtAmt + totalRetComm - govtClaimComm;</span>

<span class="nc" id="L2157">					orgIdParentIdMap.put(retOrgId, agtOrgId);</span>
<span class="nc bnc" id="L2158" title="All 2 branches missed.">					if (orgIdTransIdInvMap.containsKey(retOrgId)) {</span>
<span class="nc" id="L2159">						transIdInvMap = orgIdTransIdInvMap.get(retOrgId);</span>
					} else {
<span class="nc" id="L2161">						transIdInvMap = new HashMap&lt;String, List&lt;Long&gt;&gt;();</span>
<span class="nc" id="L2162">						orgIdTransIdInvMap.put(retOrgId, transIdInvMap);</span>
					}
					// insert data into main transaction master

<span class="nc" id="L2166">					transMasQueryPstmt.setString(1, &quot;AGENT&quot;);</span>
<span class="nc" id="L2167">					transMasQueryPstmt.executeUpdate();</span>
<span class="nc" id="L2168">					ResultSet tranRs = transMasQueryPstmt.getGeneratedKeys();</span>

<span class="nc bnc" id="L2170" title="All 2 branches missed.">					if (tranRs.next()) {</span>
<span class="nc" id="L2171">						long transId = tranRs.getLong(1);</span>

<span class="nc bnc" id="L2173" title="All 2 branches missed.">						if (!transIdInvMap.containsKey(transDate)) {</span>
<span class="nc" id="L2174">							transIdInvMap.put(transDate,</span>
									new ArrayList&lt;Long&gt;());
						}
<span class="nc" id="L2177">						transIdInvMap.get(transDate).add(transId);</span>

<span class="nc" id="L2179">						agtTransMasterPstmt.setLong(1, transId);</span>
<span class="nc" id="L2180">						agtTransMasterPstmt.setInt(2, agtUserId);</span>
<span class="nc" id="L2181">						agtTransMasterPstmt.setInt(3, agtOrgId);</span>
<span class="nc" id="L2182">						agtTransMasterPstmt.setString(4, &quot;RETAILER&quot;);</span>
<span class="nc" id="L2183">						agtTransMasterPstmt.setInt(5, retOrgId);</span>
<span class="nc" id="L2184">						agtTransMasterPstmt.setString(6, &quot;DG_PWT_AUTO&quot;);</span>
<span class="nc" id="L2185">						agtTransMasterPstmt.setTimestamp(7,</span>
								fetchTransTimeStamp(transDate));
<span class="nc" id="L2187">						agtTransMasterPstmt.executeUpdate();</span>

<span class="nc bnc" id="L2189" title="All 2 branches missed.">						if (!&quot;direct_plr&quot;.equals(pwtType)) {</span>
<span class="nc" id="L2190">							retPwtUpdatePstmt.setInt(1, gameId);</span>
<span class="nc" id="L2191">							retPwtUpdatePstmt.setInt(2, gameId);</span>
<span class="nc" id="L2192">							retPwtUpdatePstmt.setString(3, &quot;DONE_CLM&quot;);</span>
<span class="nc" id="L2193">							retPwtUpdatePstmt</span>
									.setString(4, &quot;CLAIM_RET_CLM_AUTO&quot;);
<span class="nc" id="L2195">							retPwtUpdatePstmt.setLong(5, transId);</span>
<span class="nc" id="L2196">							retPwtUpdatePstmt.setInt(6, gameId);</span>
<span class="nc" id="L2197">							retPwtUpdatePstmt.setInt(7, drawId);</span>
<span class="nc" id="L2198">							retPwtUpdatePstmt.setInt(8, retOrgId);</span>
<span class="nc" id="L2199">							retPwtUpdatePstmt.setString(9, transDate);</span>
<span class="nc" id="L2200">							retPwtUpdatePstmt.executeUpdate();</span>
						} else {
<span class="nc" id="L2202">							retDirPlrPstmt.setInt(1, gameId);</span>
<span class="nc" id="L2203">							retDirPlrPstmt.setString(2, &quot;DONE_CLM&quot;);</span>
<span class="nc" id="L2204">							retDirPlrPstmt.setString(3, &quot;CLAIM_RET_CLM_AUTO&quot;);</span>
<span class="nc" id="L2205">							retDirPlrPstmt.setLong(4, transId);</span>
<span class="nc" id="L2206">							retDirPlrPstmt.setInt(5, gameId);</span>
<span class="nc" id="L2207">							retDirPlrPstmt.setInt(6, drawId);</span>
<span class="nc" id="L2208">							retDirPlrPstmt.setInt(7, retOrgId);</span>
<span class="nc" id="L2209">							retPwtUpdatePstmt.setString(8, transDate);</span>
<span class="nc" id="L2210">							retDirPlrPstmt.executeUpdate();</span>
						}

<span class="nc" id="L2213">						agtPstmt.setInt(1, agtUserId);</span>
<span class="nc" id="L2214">						agtPstmt.setInt(2, agtOrgId);</span>
<span class="nc" id="L2215">						agtPstmt.setInt(3, retOrgId);</span>
<span class="nc" id="L2216">						agtPstmt.setInt(4, drawId);</span>
<span class="nc" id="L2217">						agtPstmt.setInt(5, gameId);</span>
<span class="nc" id="L2218">						agtPstmt.setLong(6, transId);</span>
<span class="nc" id="L2219">						agtPstmt.setDouble(7, totalPwtAmt);</span>
<span class="nc" id="L2220">						agtPstmt.setDouble(8, totalRetComm);</span>
<span class="nc" id="L2221">						agtPstmt.setDouble(9, totalNetAmt);</span>
<span class="nc" id="L2222">						agtPstmt.setDouble(10, totalAgtComm);</span>
<span class="nc" id="L2223">						agtPstmt.setString(11, &quot;CLAIM_BAL&quot;);</span>
<span class="nc" id="L2224">						agtPstmt.setDouble(12, govtClaimComm) ;</span>
<span class="nc" id="L2225">						agtPstmt.executeUpdate();</span>

					}
<span class="nc" id="L2228">					double retCrAmt = totalNetAmt;</span>
<span class="nc bnc" id="L2229" title="All 2 branches missed.">					if (orgAmtMap.containsKey(retOrgId)) {</span>
<span class="nc" id="L2230">						retCrAmt = retCrAmt + orgAmtMap.get(retOrgId);</span>
					}
<span class="nc" id="L2232">					orgAmtMap.put(retOrgId, retCrAmt);</span>
<span class="nc" id="L2233">				}</span>

			}

<span class="nc" id="L2237">			Set&lt;Integer&gt; allRetId = orgAmtMap.keySet();</span>
<span class="nc" id="L2238">			logger.debug(&quot;retailer pwt update org amt map&quot; + orgAmtMap);</span>
<span class="nc bnc" id="L2239" title="All 2 branches missed.">			for (Integer orgId : allRetId) {</span>
<span class="nc bnc" id="L2240" title="All 2 branches missed.">				if (orgId != 0) {</span>
<span class="nc" id="L2241">					boolean isValid=OrgCreditUpdation.updateOrganizationBalWithValidate(CommonMethods.fmtToTwoDecimal(orgAmtMap.get(orgId)), &quot;TRANSACTION&quot;, &quot;PWT_AUTO&quot;, orgId,</span>
							orgIdParentIdMap.get(orgId), &quot;RETAILER&quot;, 0, con);
<span class="nc bnc" id="L2243" title="All 2 branches missed.">					if(!isValid)</span>
<span class="nc" id="L2244">						throw new LMSException();</span>
						
<span class="nc" id="L2246">					OrgCreditUpdation.updateOrganizationBalWithValidate(CommonMethods.fmtToTwoDecimal(orgAmtMap.get(orgId)), &quot;CLAIM_BAL&quot;, &quot;CREDIT_UPDATE_LEDGER&quot;, orgId,</span>
							orgIdParentIdMap.get(orgId), &quot;RETAILER&quot;, 0, con);
					
					/*OrgCreditUpdation.updateCreditLimitForRetailer(orgId,
							&quot;PWT_AUTO&quot;, orgAmtMap.get(orgId), con);
					updateOrgBalance(&quot;CLAIM_BAL&quot;, orgAmtMap.get(orgId), orgId,
							&quot;CREDIT&quot;, con);*/
<span class="nc" id="L2253">					generateReciptForPwtNew(orgIdTransIdInvMap.get(orgId), con,</span>
							orgIdParentIdMap.get(orgId), retOrgId, &quot;RETAILER&quot;,
							&quot;DRAWGAME&quot;);
				}
<span class="nc" id="L2257">			}</span>

<span class="nc" id="L2259">		} catch (Exception e) {</span>
<span class="nc" id="L2260">			e.printStackTrace();</span>
<span class="nc" id="L2261">			throw new LMSException(&quot;error in pwt retailer&quot;);</span>
<span class="nc" id="L2262">		}</span>
<span class="nc" id="L2263">		logger.debug(new Date() + &quot;---start-dg pwt update for retailer--&quot;</span>
				+ new Date().getTime());
<span class="nc" id="L2265">	}</span>

	public void updateDGPwtLedgerForAgt(Connection con) throws LMSException {
<span class="nc" id="L2268">		logger.debug(new Date() + &quot;---start-dg pwt update for agent--&quot;</span>
				+ new Date().getTime());
<span class="nc" id="L2270">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L2271">		ResultSet rs = null;</span>

		try {
<span class="nc" id="L2274">			String pwtQry = &quot;select aaa.agent_org_id,boUserId,boOrgId, aaa.game_id, bbb.game_nbr, bbb.game_name, aaa.draw_id, sum(aaa.agt_claim_comm) totalAgtComm,sum(aaa.govt_claim_comm) govtClaimComm, sum(aaa.pwt_amt) totalPwtAmt, aaa.pwt_type, DATE(aaa.transaction_date) 'transaction_date' from ((select  a.transaction_id,a.agent_org_id,  a.draw_id, a.pwt_amt, 'Anonymous' as 'pwt_type', a.game_id,  a.agt_claim_comm,a.govt_claim_comm, transaction_date from st_dg_agt_pwt a, st_lms_agent_transaction_master b where   a.status = 'CLAIM_BAL' and a.transaction_id = b.transaction_id) union all (select    aa.transaction_id,aa.agent_org_id, aa.draw_id, aa.pwt_amt, 'direct_plr' as 'pwt_type', aa.game_id,  agt_claim_comm,0, transaction_date from st_dg_agt_direct_plr_pwt aa where aa.pwt_claim_status = 'CLAIM_BAL' ))aaa, st_dg_game_master bbb,(select um.user_id agtUserId,um.organization_id agtOrgId,um.parent_user_id boUserId,om.parent_id boOrgId from st_lms_organization_master om inner join st_lms_user_master um on om.organization_id=um.organization_id where om.organization_type='AGENT' and isrolehead='Y') ccc where  aaa.game_id = bbb.game_id and agent_org_id=agtOrgId  group by pwt_type,agent_org_id,aaa.game_id, aaa.draw_id, date(aaa.transaction_date)&quot;;</span>

<span class="nc" id="L2276">			String agtPwtUpdateQuery = &quot;update st_dg_agt_pwt aa, st_dg_pwt_inv_? bb,st_lms_agent_transaction_master cc set aa.status = ? , bb.status = ? , bb.bo_transaction_id =? where aa.transaction_id = bb.agent_transaction_id and aa.transaction_id=cc.transaction_id and aa.game_id = ? and bb.draw_id = ? and aa.agent_org_id=? and date(cc.transaction_date)=?&quot;;</span>
<span class="nc" id="L2277">			PreparedStatement agtPwtUpdatePstmt = con</span>
					.prepareStatement(agtPwtUpdateQuery);

			// insert in st_agt_direct_player table in case of
			// player

<span class="nc" id="L2283">			String agtPwtUpdateDirectPlrQry = &quot;update st_dg_agt_direct_plr_pwt aa, st_dg_pwt_inv_? bb,st_lms_agent_transaction_master cc set aa.pwt_claim_status = ? , bb.status = ? , bb.bo_transaction_id =? where aa.transaction_id = bb.agent_transaction_id and aa.transaction_id=cc.transaction_id and aa.game_id = ? and bb.draw_id = ? and aa.agent_org_id=? and date(cc.transaction_date)=?&quot;;</span>
<span class="nc" id="L2284">			PreparedStatement agtDirPlrPstmt = con</span>
					.prepareStatement(agtPwtUpdateDirectPlrQry);
<span class="nc" id="L2286">			PreparedStatement transMasQueryPstmt = con</span>
					.prepareStatement(QueryManager
							.insertInLMSTransactionMaster());
<span class="nc" id="L2289">			PreparedStatement boTransMasterPstmt = con</span>
					.prepareStatement(QueryManager
							.insertInBOTransactionMaster());
<span class="nc" id="L2292">			String agtDGPwtEntry = &quot;insert into st_dg_bo_pwt (bo_user_id, bo_org_id, agent_org_id, &quot;</span>
					+ &quot; draw_id, game_id, transaction_id, pwt_amt, comm_amt, net_amt, govt_claim_comm&quot;
					+ &quot;) values (?, ?, ?, ?, ?, ?, ?, ?,?,?)&quot;;
<span class="nc" id="L2295">			PreparedStatement agtPstmt = con.prepareStatement(agtDGPwtEntry);</span>
			int agtOrgId, boOrgId, boUserId, gameId, drawId;
			double totalPwtAmt, totalAgtComm, totalNetAmt, govtClaimComm;
			String pwtType, transDate;
<span class="nc" id="L2299">			Map&lt;Integer, Double&gt; orgAmtMap = new HashMap&lt;Integer, Double&gt;();</span>
<span class="nc" id="L2300">			Map&lt;Integer, Integer&gt; orgIdParentIdMap = new HashMap&lt;Integer, Integer&gt;();</span>
<span class="nc" id="L2301">			Map&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt; orgIdTransIdInvMap = new HashMap&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt;();</span>
<span class="nc" id="L2302">			Map&lt;String, List&lt;Long&gt;&gt; transIdInvMap = null;</span>

<span class="nc" id="L2304">			pstmt = con.prepareStatement(pwtQry);</span>
<span class="nc" id="L2305">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L2306" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L2307">				agtOrgId = rs.getInt(&quot;agent_org_id&quot;);</span>
<span class="nc" id="L2308">				boOrgId = rs.getInt(&quot;boOrgId&quot;);</span>
<span class="nc" id="L2309">				boUserId = rs.getInt(&quot;boUserId&quot;);</span>
<span class="nc" id="L2310">				gameId = rs.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L2311">				logger.debug(&quot;--Agent PWT tran for game No&quot; + gameId);</span>
<span class="nc" id="L2312">				drawId = rs.getInt(&quot;draw_id&quot;);</span>
<span class="nc" id="L2313">				totalPwtAmt = rs.getDouble(&quot;totalPwtAmt&quot;);</span>
<span class="nc" id="L2314">				totalAgtComm = rs.getDouble(&quot;totalAgtComm&quot;);</span>
<span class="nc" id="L2315">				govtClaimComm = rs.getDouble(&quot;govtClaimComm&quot;);</span>
<span class="nc" id="L2316">				pwtType = rs.getString(&quot;pwt_type&quot;);</span>
<span class="nc" id="L2317">				transDate = rs.getString(&quot;transaction_date&quot;);</span>
<span class="nc" id="L2318">				totalNetAmt = totalPwtAmt + totalAgtComm - govtClaimComm;</span>

<span class="nc" id="L2320">				orgIdParentIdMap.put(agtOrgId, boOrgId);</span>
<span class="nc bnc" id="L2321" title="All 2 branches missed.">				if (orgIdTransIdInvMap.containsKey(agtOrgId)) {</span>
<span class="nc" id="L2322">					transIdInvMap = orgIdTransIdInvMap.get(agtOrgId);</span>
				} else {
<span class="nc" id="L2324">					transIdInvMap = new HashMap&lt;String, List&lt;Long&gt;&gt;();</span>
<span class="nc" id="L2325">					orgIdTransIdInvMap.put(agtOrgId, transIdInvMap);</span>
				}
				// insert data into main transaction master

<span class="nc" id="L2329">				transMasQueryPstmt.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L2330">				transMasQueryPstmt.executeUpdate();</span>
<span class="nc" id="L2331">				ResultSet tranRs = transMasQueryPstmt.getGeneratedKeys();</span>

<span class="nc bnc" id="L2333" title="All 2 branches missed.">				if (tranRs.next()) {</span>
<span class="nc" id="L2334">					long transId = tranRs.getLong(1);</span>

<span class="nc bnc" id="L2336" title="All 2 branches missed.">					if (!transIdInvMap.containsKey(transDate)) {</span>
<span class="nc" id="L2337">						transIdInvMap.put(transDate, new ArrayList&lt;Long&gt;());</span>
					}
<span class="nc" id="L2339">					transIdInvMap.get(transDate).add(transId);</span>

<span class="nc" id="L2341">					boTransMasterPstmt.setLong(1, transId);</span>
<span class="nc" id="L2342">					boTransMasterPstmt.setInt(2, boUserId);</span>
<span class="nc" id="L2343">					boTransMasterPstmt.setInt(3, boOrgId);</span>
<span class="nc" id="L2344">					boTransMasterPstmt.setString(4, &quot;AGENT&quot;);</span>
<span class="nc" id="L2345">					boTransMasterPstmt.setInt(5, agtOrgId);</span>
<span class="nc" id="L2346">					boTransMasterPstmt.setTimestamp(6,</span>
							fetchTransTimeStamp(transDate));
<span class="nc" id="L2348">					boTransMasterPstmt.setString(7, &quot;DG_PWT_AUTO&quot;);</span>
<span class="nc" id="L2349">					boTransMasterPstmt.executeUpdate();</span>

<span class="nc bnc" id="L2351" title="All 2 branches missed.">					if (!&quot;direct_plr&quot;.equals(pwtType)) {</span>
<span class="nc" id="L2352">						agtPwtUpdatePstmt.setInt(1, gameId);</span>
<span class="nc" id="L2353">						agtPwtUpdatePstmt.setString(2, &quot;DONE_CLM&quot;);</span>
<span class="nc" id="L2354">						agtPwtUpdatePstmt.setString(3, &quot;CLAIM_AGT_CLM_AUTO&quot;);</span>
<span class="nc" id="L2355">						agtPwtUpdatePstmt.setLong(4, transId);</span>
<span class="nc" id="L2356">						agtPwtUpdatePstmt.setInt(5, gameId);</span>
<span class="nc" id="L2357">						agtPwtUpdatePstmt.setInt(6, drawId);</span>
<span class="nc" id="L2358">						agtPwtUpdatePstmt.setInt(7, agtOrgId);</span>
<span class="nc" id="L2359">						agtPwtUpdatePstmt.setString(8, transDate);</span>
<span class="nc" id="L2360">						logger.debug(&quot;--agent pwt update--&quot;+agtDirPlrPstmt);</span>
<span class="nc" id="L2361">						agtPwtUpdatePstmt.executeUpdate();</span>
					} else {
<span class="nc" id="L2363">						agtDirPlrPstmt.setInt(1, gameId);</span>
<span class="nc" id="L2364">						agtDirPlrPstmt.setString(2, &quot;DONE_CLM&quot;);</span>
<span class="nc" id="L2365">						agtDirPlrPstmt.setString(3, &quot;CLAIM_AGT_CLM_AUTO&quot;);</span>
<span class="nc" id="L2366">						agtDirPlrPstmt.setLong(4, transId);</span>
<span class="nc" id="L2367">						agtDirPlrPstmt.setInt(5, gameId);</span>
<span class="nc" id="L2368">						agtDirPlrPstmt.setInt(6, drawId);</span>
<span class="nc" id="L2369">						agtDirPlrPstmt.setInt(7, agtOrgId);</span>
<span class="nc" id="L2370">						agtDirPlrPstmt.setString(8, transDate);</span>
<span class="nc" id="L2371">						logger.debug(&quot;--agent pwt update- direct plr-&quot;+agtDirPlrPstmt);</span>
<span class="nc" id="L2372">						agtDirPlrPstmt.executeUpdate();</span>
					}

<span class="nc" id="L2375">					agtPstmt.setInt(1, boUserId);</span>
<span class="nc" id="L2376">					agtPstmt.setInt(2, boOrgId);</span>
<span class="nc" id="L2377">					agtPstmt.setInt(3, agtOrgId);</span>
<span class="nc" id="L2378">					agtPstmt.setInt(4, drawId);</span>
<span class="nc" id="L2379">					agtPstmt.setInt(5, gameId);</span>
<span class="nc" id="L2380">					agtPstmt.setLong(6, transId);</span>
<span class="nc" id="L2381">					agtPstmt.setDouble(7, totalPwtAmt);</span>
<span class="nc" id="L2382">					agtPstmt.setDouble(8, totalAgtComm);</span>
<span class="nc" id="L2383">					agtPstmt.setDouble(9, totalNetAmt);</span>
<span class="nc" id="L2384">					agtPstmt.setDouble(10, govtClaimComm);</span>
<span class="nc" id="L2385">					agtPstmt.executeUpdate();</span>

				}
<span class="nc" id="L2388">				double agtCrAmt = totalNetAmt;</span>
<span class="nc bnc" id="L2389" title="All 2 branches missed.">				if (orgAmtMap.containsKey(agtOrgId)) {</span>
<span class="nc" id="L2390">					agtCrAmt = agtCrAmt + orgAmtMap.get(agtOrgId);</span>
				}
<span class="nc" id="L2392">				orgAmtMap.put(agtOrgId, agtCrAmt);</span>
<span class="nc" id="L2393">			}</span>

<span class="nc" id="L2395">			Set&lt;Integer&gt; allAgtId = orgAmtMap.keySet();</span>
<span class="nc" id="L2396">			logger.debug(&quot;agent pwt update org amt map&quot; + orgAmtMap);</span>
<span class="nc bnc" id="L2397" title="All 2 branches missed.">			for (Integer orgId : allAgtId) {</span>
<span class="nc bnc" id="L2398" title="All 2 branches missed.">				if (orgId != 0) {</span>
					
					
<span class="nc" id="L2401">					boolean isValid=OrgCreditUpdation.updateOrganizationBalWithValidate(CommonMethods.fmtToTwoDecimal(orgAmtMap.get(orgId)), &quot;TRANSACTION&quot;, &quot;PWT_AUTO&quot;, orgId,</span>
							0, &quot;AGENT&quot;, 0, con);
<span class="nc bnc" id="L2403" title="All 2 branches missed.">					if(!isValid)</span>
<span class="nc" id="L2404">						throw new LMSException();</span>
<span class="nc" id="L2405">					OrgCreditUpdation.updateOrganizationBalWithValidate(CommonMethods.fmtToTwoDecimal(orgAmtMap.get(orgId)), &quot;CLAIM_BAL&quot;, &quot;CREDIT_UPDATE_LEDGER&quot;, orgId,</span>
							0, &quot;AGENT&quot;, 0, con);
					/*OrgCreditUpdation.updateCreditLimitForAgent(orgId,
							&quot;PWT_AUTO&quot;, orgAmtMap.get(orgId), con);
					updateOrgBalance(&quot;CLAIM_BAL&quot;, orgAmtMap.get(orgId), orgId,
							&quot;CREDIT&quot;, con);*/
<span class="nc" id="L2411">					generateReceiptDGBoNew(con, orgId, &quot;AGENT&quot;, orgIdTransIdInvMap</span>
							.get(orgId));
				}
<span class="nc" id="L2414">			}</span>

<span class="nc" id="L2416">		} catch (Exception e) {</span>
<span class="nc" id="L2417">			e.printStackTrace();</span>
<span class="nc" id="L2418">			throw new LMSException(&quot;error in pwt agent&quot;);</span>
<span class="nc" id="L2419">		}</span>
<span class="nc" id="L2420">		logger.debug(new Date() + &quot;---start-dg pwt update for agent--&quot;</span>
				+ new Date().getTime());
<span class="nc" id="L2422">	}</span>
	
	protected void generateDGReceiptNew(
			Map&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt; orgTranMap,
			Map&lt;Integer, Integer&gt; orgParentMap, String mainRecType,
			String secRecType, Connection con) throws SQLException {

<span class="nc" id="L2429">		Map&lt;String, List&lt;Long&gt;&gt; trnIdMapInvoice = null;</span>
		//List&lt;Integer&gt; trnIdListInvoice = null;
		//List&lt;Integer&gt; trnIdListInvoice = new ArrayList&lt;Integer&gt;();
<span class="nc" id="L2432">		Set&lt;Integer&gt; orgIdSet = null;</span>
<span class="nc" id="L2433">		String query = &quot;SELECT generated_id from st_lms_agent_receipts where (receipt_type=? or receipt_type=?) and agent_org_id=? ORDER BY receipt_id DESC LIMIT 1&quot;;</span>
<span class="nc" id="L2434">		PreparedStatement selStmt = con.prepareStatement(query);</span>
<span class="nc" id="L2435">		PreparedStatement recMasStmt = con.prepareStatement(QueryManager</span>
				.insertInReceiptMaster());
<span class="nc" id="L2437">		PreparedStatement agtRecStmt = con.prepareStatement(QueryManager</span>
				.insertInAgentReceipts());
<span class="nc" id="L2439">		PreparedStatement recMapStmt = con.prepareStatement(QueryManager</span>
				.insertAgentReceiptTrnMapping());

<span class="nc bnc" id="L2442" title="All 4 branches missed.">		if (orgTranMap != null &amp;&amp; orgParentMap != null) {</span>
<span class="nc" id="L2443">			orgIdSet = orgTranMap.keySet();</span>
		}
<span class="nc bnc" id="L2445" title="All 2 branches missed.">		for (Integer orgId : orgIdSet) {</span>
<span class="nc" id="L2446">			trnIdMapInvoice = orgTranMap.get(orgId);</span>
<span class="nc" id="L2447">			List&lt;Long&gt; trnIdListInvoice = new ArrayList&lt;Long&gt;();</span>
<span class="nc bnc" id="L2448" title="All 4 branches missed.">			if (trnIdMapInvoice != null &amp;&amp; trnIdMapInvoice.size() &gt; 0) {</span>
<span class="nc" id="L2449">				Set&lt;String&gt; dateKeys = trnIdMapInvoice.keySet();</span>
				//for (String date : dateKeys) {
					//trnIdListInvoice = trnIdMapInvoice.get(date);
<span class="nc bnc" id="L2452" title="All 2 branches missed.">				for (String date : dateKeys) {</span>
                //trnIdListInvoice = trnIdMapInvoice.get(date);
<span class="nc" id="L2454">					trnIdListInvoice.addAll(trnIdMapInvoice.get(date)) ;</span>
<span class="nc" id="L2455">				}</span>
<span class="nc" id="L2456">					selStmt.setString(1, mainRecType);</span>
<span class="nc" id="L2457">					selStmt.setString(2, secRecType);</span>
<span class="nc" id="L2458">					selStmt.setInt(3, orgParentMap.get(orgId));</span>
<span class="nc" id="L2459">					ResultSet recieptRs = selStmt.executeQuery();</span>
<span class="nc" id="L2460">					String lastRecieptNoGenerated = null;</span>
<span class="nc bnc" id="L2461" title="All 2 branches missed.">					while (recieptRs.next()) {</span>
<span class="nc" id="L2462">						lastRecieptNoGenerated = recieptRs</span>
								.getString(&quot;generated_id&quot;);
					}

					// String autoGeneRecieptNo=null;
<span class="nc" id="L2467">					String autoGeneRecieptNo = GenerateRecieptNo</span>
							.getRecieptNoAgt(mainRecType,
									lastRecieptNoGenerated, &quot;AGENT&quot;,
									orgParentMap.get(orgId));
<span class="nc" id="L2471">					logger.debug(&quot;--ReceieptNo--&quot; + autoGeneRecieptNo);</span>
					// insert in receipt master for invoice

<span class="nc" id="L2474">					recMasStmt.setString(1, &quot;AGENT&quot;);</span>
<span class="nc" id="L2475">					recMasStmt.executeUpdate();</span>

<span class="nc" id="L2477">					ResultSet rs = recMasStmt.getGeneratedKeys();</span>
<span class="nc" id="L2478">					int invoiceId = -1;</span>
<span class="nc bnc" id="L2479" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L2480">						invoiceId = rs.getInt(1);</span>
					}

					// insert into agent receipt table

<span class="nc" id="L2485">					agtRecStmt.setInt(1, invoiceId);</span>
<span class="nc" id="L2486">					agtRecStmt.setString(2, mainRecType);</span>
<span class="nc" id="L2487">					agtRecStmt.setInt(3, orgParentMap.get(orgId));</span>
<span class="nc" id="L2488">					agtRecStmt.setInt(4, orgId);</span>
<span class="nc" id="L2489">					agtRecStmt.setString(5, &quot;RETAILER&quot;);</span>
<span class="nc" id="L2490">					agtRecStmt.setString(6, autoGeneRecieptNo);</span>
<span class="nc" id="L2491">					agtRecStmt.setTimestamp(7, Util.getCurrentTimeStamp());</span>
<span class="nc" id="L2492">					agtRecStmt.execute();</span>

<span class="nc bnc" id="L2494" title="All 2 branches missed.">					for (int i = 0; i &lt; trnIdListInvoice.size(); i++) {</span>
<span class="nc" id="L2495">						recMapStmt.setInt(1, invoiceId);</span>
<span class="nc" id="L2496">						recMapStmt.setLong(2, trnIdListInvoice.get(i));</span>
<span class="nc" id="L2497">						recMapStmt.execute();</span>

					}

				//}
			}
<span class="nc" id="L2503">		}</span>
<span class="nc" id="L2504">	}</span>


	protected void generateDGReceiptForBONew(
			Map&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt; orgTranMap,
			Map&lt;Integer, Integer&gt; orgParentMap, String mainRecType,
			String secRecType, Connection con) throws SQLException {

<span class="nc" id="L2512">		Map&lt;String, List&lt;Long&gt;&gt; trnIdMapInvoice = null;</span>
		//List&lt;Integer&gt; trnIdListInvoice = null;
		//List&lt;Integer&gt; trnIdListInvoice = new ArrayList&lt;Integer&gt;();
<span class="nc" id="L2515">		Set&lt;Integer&gt; orgIdSet = null;</span>
<span class="nc" id="L2516">		String query = &quot;SELECT generated_id from st_lms_bo_receipts where receipt_type=? or receipt_type=? ORDER BY receipt_id DESC LIMIT 1&quot;;</span>
<span class="nc" id="L2517">		PreparedStatement selStmt = con.prepareStatement(query);</span>
<span class="nc" id="L2518">		PreparedStatement recMasStmt = con.prepareStatement(QueryManager</span>
				.insertInReceiptMaster());
<span class="nc" id="L2520">		PreparedStatement boRecStmt = con.prepareStatement(QueryManager</span>
				.insertInBOReceipts());
<span class="nc" id="L2522">		PreparedStatement recMapStmt = con.prepareStatement(QueryManager</span>
				.insertBOReceiptTrnMapping());

<span class="nc bnc" id="L2525" title="All 4 branches missed.">		if (orgTranMap != null &amp;&amp; orgParentMap != null) {</span>
<span class="nc" id="L2526">			orgIdSet = orgTranMap.keySet();</span>
		}
<span class="nc bnc" id="L2528" title="All 2 branches missed.">		for (Integer orgId : orgIdSet) {</span>
<span class="nc" id="L2529">			trnIdMapInvoice = orgTranMap.get(orgId);</span>
<span class="nc" id="L2530">			List&lt;Long&gt; trnIdListInvoice = new ArrayList&lt;Long&gt;();</span>
<span class="nc bnc" id="L2531" title="All 4 branches missed.">			if (trnIdMapInvoice != null &amp;&amp; trnIdMapInvoice.size() &gt; 0) {</span>
<span class="nc" id="L2532">				Set&lt;String&gt; dateKeys = trnIdMapInvoice.keySet();</span>
				//for (String date : dateKeys) {
					//trnIdListInvoice = trnIdMapInvoice.get(date);
                    
<span class="nc bnc" id="L2536" title="All 2 branches missed.">				for (String date : dateKeys) {</span>
					//trnIdListInvoice = trnIdMapInvoice.get(date);
<span class="nc" id="L2538">					trnIdListInvoice.addAll(trnIdMapInvoice.get(date)) ;</span>
<span class="nc" id="L2539">				}</span>
<span class="nc" id="L2540">					selStmt.setString(1, mainRecType);</span>
<span class="nc" id="L2541">					selStmt.setString(2, secRecType);</span>
<span class="nc" id="L2542">					ResultSet recieptRs = selStmt.executeQuery();</span>
<span class="nc" id="L2543">					String lastRecieptNoGenerated = null;</span>
<span class="nc bnc" id="L2544" title="All 2 branches missed.">					while (recieptRs.next()) {</span>
<span class="nc" id="L2545">						lastRecieptNoGenerated = recieptRs</span>
								.getString(&quot;generated_id&quot;);
					}

<span class="nc" id="L2549">					String autoGeneRecieptNo = GenerateRecieptNo.getRecieptNo(</span>
							mainRecType, lastRecieptNoGenerated, &quot;BO&quot;);
<span class="nc" id="L2551">					logger.debug(&quot;--Reciept No--&quot; + autoGeneRecieptNo);</span>
					// insert in receipt master for invoice

<span class="nc" id="L2554">					recMasStmt.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L2555">					recMasStmt.executeUpdate();</span>

<span class="nc" id="L2557">					ResultSet rs = recMasStmt.getGeneratedKeys();</span>
<span class="nc" id="L2558">					int invoiceId = -1;</span>
<span class="nc bnc" id="L2559" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L2560">						invoiceId = rs.getInt(1);</span>
					}

					// insert into agent receipt table

<span class="nc" id="L2565">					boRecStmt.setInt(1, invoiceId);</span>
<span class="nc" id="L2566">					boRecStmt.setString(2, mainRecType);</span>
<span class="nc" id="L2567">					boRecStmt.setInt(3, orgId);</span>
<span class="nc" id="L2568">					boRecStmt.setString(4, &quot;AGENT&quot;);</span>
<span class="nc" id="L2569">					boRecStmt.setString(5, autoGeneRecieptNo);</span>
<span class="nc" id="L2570">					boRecStmt.setTimestamp(6, Util.getCurrentTimeStamp());</span>
<span class="nc" id="L2571">					boRecStmt.execute();</span>

<span class="nc bnc" id="L2573" title="All 2 branches missed.">					for (int i = 0; i &lt; trnIdListInvoice.size(); i++) {</span>
<span class="nc" id="L2574">						recMapStmt.setInt(1, invoiceId);</span>
<span class="nc" id="L2575">						recMapStmt.setLong(2, trnIdListInvoice.get(i));</span>
<span class="nc" id="L2576">						recMapStmt.execute();</span>

					}

				//}
			}
<span class="nc" id="L2582">		}</span>
<span class="nc" id="L2583">	}</span>

	private boolean updateOrgBalance(String claimType, double amount,
			int orgId, String amtUpdateType, Connection connection)
			throws SQLException {

		// check whether amount type is debit or credit
<span class="nc bnc" id="L2590" title="All 2 branches missed.">		amount = &quot;DEBIT&quot;.equals(amtUpdateType) ? -1 * amount : amount;</span>

<span class="nc" id="L2592">		String updateRetBalQuery = null;</span>
<span class="nc bnc" id="L2593" title="All 2 branches missed.">		if (&quot;UNCLAIM_BAL&quot;.equalsIgnoreCase(claimType)) {</span>
<span class="nc" id="L2594">			updateRetBalQuery = &quot;update st_lms_organization_master set unclaimable_bal = (unclaimable_bal+?) where organization_id = ?&quot;;</span>
<span class="nc bnc" id="L2595" title="All 2 branches missed.">		} else if (&quot;CLAIM_BAL&quot;.equalsIgnoreCase(claimType)) {</span>
<span class="nc" id="L2596">			updateRetBalQuery = &quot;update st_lms_organization_master set claimable_bal = (claimable_bal+?) &quot;</span>
					+ &quot; , organization_status =  if(organization_status='TERMINATE','TERMINATE',if((available_credit-claimable_bal)&gt;0, 'ACTIVE', 'INACTIVE')) &quot;
					+ &quot; where organization_id = ?&quot;;
			// updateRetBalQuery = &quot;update st_lms_organization_master set
			// claimable_bal = (claimable_bal+?) where organization_id = ?&quot;;
<span class="nc bnc" id="L2601" title="All 2 branches missed.">		} else if (&quot;ACA_N_CLAIM_BAL&quot;.equalsIgnoreCase(claimType)) {</span>
<span class="nc" id="L2602">			updateRetBalQuery = &quot;update st_lms_organization_master set claimable_bal = (claimable_bal-?),&quot;</span>
					+ &quot; available_credit=(available_credit+?) where organization_id = ?&quot;;
<span class="nc bnc" id="L2604" title="All 2 branches missed.">		} else if (&quot;ACA_N_UNCLAIM_BAL&quot;.equalsIgnoreCase(claimType)) {</span>
<span class="nc" id="L2605">			updateRetBalQuery = &quot;update st_lms_organization_master set unclaimable_bal = (unclaimable_bal-?),&quot;</span>
					+ &quot; available_credit=(available_credit+?) where organization_id = ?&quot;;
		}
<span class="nc" id="L2608">		PreparedStatement updateRetBal = connection</span>
				.prepareStatement(updateRetBalQuery);
<span class="nc" id="L2610">		updateRetBal.setDouble(1, amount);</span>
<span class="nc bnc" id="L2611" title="All 2 branches missed.">		if (&quot;ACA_N_CLAIM_BAL&quot;.equalsIgnoreCase(claimType)) {</span>
<span class="nc" id="L2612">			updateRetBal.setDouble(2, amount);</span>
<span class="nc" id="L2613">			updateRetBal.setInt(3, orgId);</span>
		} else {
<span class="nc" id="L2615">			updateRetBal.setInt(2, orgId);</span>
		}
<span class="nc" id="L2617">		logger.debug(&quot;organisation master update::&quot; + updateRetBal);</span>
<span class="nc" id="L2618">		int retBalRow = updateRetBal.executeUpdate();</span>

<span class="nc bnc" id="L2620" title="All 2 branches missed.">		return retBalRow &gt; 0;</span>
	}
	
	protected String generateReciptForPwtNew(Map&lt;String, List&lt;Long&gt;&gt; transIdMap,
			Connection connection, int userOrgID, int partyId,
			String partyType, String recType) {
<span class="nc" id="L2626">		int agtReceiptId = -1;</span>
<span class="nc" id="L2627">		StringBuilder receipts = new StringBuilder(&quot;&quot;);</span>
		// int boReceiptId=-1;
<span class="nc" id="L2629">		PreparedStatement agtReceiptPstmt = null;</span>
<span class="nc" id="L2630">		PreparedStatement agtReceiptMappingPstmt = null;</span>
<span class="nc" id="L2631">		String receiptType = null;</span>
		try {
<span class="nc" id="L2633">			Set&lt;String&gt; transDate = transIdMap.keySet();</span>
			//for (String date : transDate) {
			//	List&lt;Integer&gt; transIdList = transIdMap.get(date);
            //List&lt;Integer&gt; transIdList=null;
<span class="nc" id="L2637">			List&lt;Long&gt; transIdList= new ArrayList&lt;Long&gt;();</span>
<span class="nc bnc" id="L2638" title="All 2 branches missed.">			for (String date : transDate) {</span>
					 //transIdList = transIdMap.get(date);
<span class="nc" id="L2640">				     transIdList.addAll(transIdMap.get(date)) ;</span>
<span class="nc" id="L2641">			}</span>
				// for generating receipt********************
				// insert in receipt master
<span class="nc" id="L2644">				agtReceiptPstmt = connection.prepareStatement(QueryManager</span>
						.insertInReceiptMaster());
<span class="nc" id="L2646">				agtReceiptPstmt.setString(1, &quot;AGENT&quot;);</span>
<span class="nc" id="L2647">				agtReceiptPstmt.executeUpdate();</span>
<span class="nc bnc" id="L2648" title="All 2 branches missed.">				if (&quot;DRAWGAME&quot;.equalsIgnoreCase(recType)) {</span>
<span class="nc" id="L2649">					receiptType = &quot;DG_RECEIPT&quot;;</span>
				}
<span class="nc bnc" id="L2651" title="All 2 branches missed.">				else if(&quot;OLA&quot;.equalsIgnoreCase(recType)){</span>
<span class="nc" id="L2652">					receiptType = &quot;OLA_RECEIPT&quot;;</span>
				}else {
<span class="nc" id="L2654">					receiptType = &quot;RECEIPT&quot;;</span>
				}
<span class="nc" id="L2656">				ResultSet agtRSet = agtReceiptPstmt.getGeneratedKeys();</span>
<span class="nc bnc" id="L2657" title="All 2 branches missed.">				while (agtRSet.next()) {</span>
<span class="nc" id="L2658">					agtReceiptId = agtRSet.getInt(1);</span>
				}

<span class="nc" id="L2661">				PreparedStatement autoGenRecptPstmt = null;</span>
<span class="nc bnc" id="L2662" title="All 2 branches missed.">				if (receiptType.equalsIgnoreCase(&quot;RECEIPT&quot;)) {</span>
<span class="nc" id="L2663">					autoGenRecptPstmt = connection</span>
							.prepareStatement(QueryManager
									.getAGENTLatestReceiptNb());
<span class="nc" id="L2666">					autoGenRecptPstmt.setString(1, receiptType);</span>
<span class="nc" id="L2667">					autoGenRecptPstmt.setInt(2, userOrgID);</span>
<span class="nc bnc" id="L2668" title="All 2 branches missed.">				} else if (receiptType.equalsIgnoreCase(&quot;DG_RECEIPT&quot;)) {</span>
<span class="nc" id="L2669">						String query = &quot;SELECT generated_id from st_lms_agent_receipts where (receipt_type='DG_INVOICE' or receipt_type='DG_RECEIPT') and agent_org_id=&quot;</span>
								+ userOrgID
								+ &quot; ORDER BY generated_id DESC LIMIT 1&quot;;
<span class="nc" id="L2672">						autoGenRecptPstmt = connection.prepareStatement(query);</span>
<span class="nc" id="L2673">					}</span>
<span class="nc bnc" id="L2674" title="All 2 branches missed.">					else if (receiptType.equalsIgnoreCase(&quot;OLA_RECEIPT&quot;)) {</span>
<span class="nc" id="L2675">							String query = &quot;SELECT generated_id from st_lms_agent_receipts where (receipt_type='OLA_INVOICE' or receipt_type='OLA_RECEIPT') and agent_org_id=&quot;</span>
									+ userOrgID
									+ &quot; ORDER BY generated_id DESC LIMIT 1&quot;;
<span class="nc" id="L2678">							autoGenRecptPstmt = connection.prepareStatement(query);</span>
						}
			
		
<span class="nc" id="L2682">				ResultSet recieptRs = autoGenRecptPstmt.executeQuery();</span>
<span class="nc" id="L2683">				String lastRecieptNoGenerated = null;</span>

<span class="nc bnc" id="L2685" title="All 2 branches missed.">				while (recieptRs.next()) {</span>
<span class="nc" id="L2686">					lastRecieptNoGenerated = recieptRs</span>
							.getString(&quot;generated_id&quot;);
				}

<span class="nc" id="L2690">				String autoGeneRecieptNoAgt = GenerateRecieptNo</span>
						.getRecieptNoAgt(receiptType, lastRecieptNoGenerated,
								&quot;AGENT&quot;, userOrgID);
<span class="nc" id="L2693">				logger.debug(&quot;--Reciept No--&quot; + autoGeneRecieptNoAgt);</span>
				// insert in agent receipts
				// agtReceiptQuery = QueryManager.getST1AgtReceiptsQuery();
<span class="nc" id="L2696">				agtReceiptPstmt = connection.prepareStatement(QueryManager</span>
						.insertInAgentReceipts());
<span class="nc" id="L2698">				agtReceiptPstmt.setInt(1, agtReceiptId);</span>
<span class="nc" id="L2699">				agtReceiptPstmt.setString(2, receiptType);</span>
<span class="nc" id="L2700">				agtReceiptPstmt.setInt(3, userOrgID);</span>
<span class="nc" id="L2701">				agtReceiptPstmt.setInt(4, partyId);</span>
<span class="nc" id="L2702">				agtReceiptPstmt.setString(5, partyType);</span>
<span class="nc" id="L2703">				agtReceiptPstmt.setString(6, autoGeneRecieptNoAgt);</span>
<span class="nc" id="L2704">				agtReceiptPstmt.setTimestamp(7, Util.getCurrentTimeStamp());</span>
<span class="nc" id="L2705">				agtReceiptPstmt.execute();</span>

				// insert agetn receipt trn mapping

				// agtReceiptMappingQuery =
				// QueryManager.getST1AgtReceiptsMappingQuery();
<span class="nc" id="L2711">				agtReceiptMappingPstmt = connection</span>
						.prepareStatement(QueryManager
								.insertAgentReceiptTrnMapping());

<span class="nc bnc" id="L2715" title="All 2 branches missed.">				for (int i = 0; i &lt; transIdList.size(); i++) {</span>
<span class="nc" id="L2716">					agtReceiptMappingPstmt.setInt(1, agtReceiptId);</span>
<span class="nc" id="L2717">					agtReceiptMappingPstmt.setLong(2, transIdList.get(i));</span>
<span class="nc" id="L2718">					agtReceiptMappingPstmt.execute();</span>
				}
<span class="nc" id="L2720">				receipts.append(agtReceiptId + &quot;-&quot; + autoGeneRecieptNoAgt);</span>
			//}
<span class="nc" id="L2722">		} catch (SQLException e) {</span>
<span class="nc" id="L2723">			e.printStackTrace();</span>
<span class="nc" id="L2724">		}</span>

<span class="nc" id="L2726">		return receipts.toString();</span>
	}
	private String generateReceiptOlaBo(Connection connection, int partyId,
			String partyType, Map&lt;String, List&lt;Long&gt;&gt; transIdMap)
			throws LMSException {
		try {
<span class="nc" id="L2732">			Set&lt;String&gt; dateKeys = transIdMap.keySet();</span>
<span class="nc" id="L2733">			StringBuilder result = new StringBuilder(&quot;&quot;);</span>
<span class="nc bnc" id="L2734" title="All 2 branches missed.">			for (String date : dateKeys) {</span>
<span class="nc" id="L2735">				List&lt;Long&gt; transIdList = transIdMap.get(date);</span>

				// get latest generated receipt number
				// PreparedStatement autoGenRecptPstmtBO =
				// connection.prepareStatement(QueryManager.getBOLatestReceiptNb());
<span class="nc" id="L2740">				String query = &quot;SELECT generated_id from st_lms_bo_receipts where receipt_type='OLA_INVOICE' or receipt_type='OLA_RECEIPT' ORDER BY generated_id DESC LIMIT 1&quot;;</span>
<span class="nc" id="L2741">				PreparedStatement autoGenRecptPstmtBO = connection</span>
						.prepareStatement(query);
				// autoGenRecptPstmtBO.setString(1, &quot;DG_RECEIPT&quot;);
<span class="nc" id="L2744">				ResultSet recieptRsBO = autoGenRecptPstmtBO.executeQuery();</span>

<span class="nc" id="L2746">				String autoGeneRecieptNoBO = null;</span>
<span class="nc bnc" id="L2747" title="All 2 branches missed.">				if (recieptRsBO.next()) {</span>
<span class="nc" id="L2748">					String lastRecieptNoGeneratedBO = recieptRsBO</span>
							.getString(&quot;generated_id&quot;);
<span class="nc" id="L2750">					autoGeneRecieptNoBO = GenerateRecieptNo.getRecieptNo(</span>
							&quot;OLA_RECEIPT&quot;, lastRecieptNoGeneratedBO, &quot;BO&quot;);
<span class="nc" id="L2752">				} else {</span>
<span class="nc" id="L2753">					autoGeneRecieptNoBO = GenerateRecieptNo.getRecieptNo(</span>
							&quot;OLA_RECEIPT&quot;, null, &quot;BO&quot;);
				}
<span class="nc" id="L2756">				logger.debug(&quot;--Reciept No--&quot; + autoGeneRecieptNoBO);</span>
				// for generating receipt********************

<span class="nc" id="L2759">				PreparedStatement boReceiptPstmt = connection</span>
						.prepareStatement(QueryManager.insertInReceiptMaster());
<span class="nc" id="L2761">				boReceiptPstmt.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L2762">				boReceiptPstmt.executeUpdate();</span>
<span class="nc" id="L2763">				int boReceiptId = -1;</span>
<span class="nc" id="L2764">				ResultSet boRSet = boReceiptPstmt.getGeneratedKeys();</span>
<span class="nc bnc" id="L2765" title="All 2 branches missed.">				if (boRSet.next()) {</span>
<span class="nc" id="L2766">					boReceiptId = boRSet.getInt(1);</span>

<span class="nc" id="L2768">					boReceiptPstmt = connection.prepareStatement(QueryManager</span>
							.insertInBOReceipts());
<span class="nc" id="L2770">					boReceiptPstmt.setInt(1, boReceiptId);</span>
<span class="nc" id="L2771">					boReceiptPstmt.setString(2, &quot;OLA_RECEIPT&quot;);</span>
<span class="nc" id="L2772">					boReceiptPstmt.setInt(3, partyId);</span>
<span class="nc" id="L2773">					boReceiptPstmt.setString(4, partyType);</span>
<span class="nc" id="L2774">					boReceiptPstmt.setString(5, autoGeneRecieptNoBO);</span>
<span class="nc" id="L2775">					boReceiptPstmt.setTimestamp(6, Util.getCurrentTimeStamp());</span>
<span class="nc" id="L2776">					boReceiptPstmt.execute();</span>

<span class="nc" id="L2778">					PreparedStatement boReceiptMappingPstmt = connection</span>
							.prepareStatement(QueryManager
									.insertBOReceiptTrnMapping());
<span class="nc bnc" id="L2781" title="All 2 branches missed.">					for (Long transId : transIdList) {</span>
<span class="nc" id="L2782">						boReceiptMappingPstmt.setInt(1, boReceiptId);</span>
<span class="nc" id="L2783">						boReceiptMappingPstmt.setLong(2, transId);</span>
<span class="nc" id="L2784">						boReceiptMappingPstmt.execute();</span>
<span class="nc" id="L2785">					}</span>

				}

<span class="nc" id="L2789">				result.append(boReceiptId + &quot;-&quot; + autoGeneRecieptNoBO + &quot;;&quot;);</span>
<span class="nc" id="L2790">			}</span>

<span class="nc" id="L2792">			return result.toString();</span>
<span class="nc" id="L2793">		} catch (SQLException e) {</span>
<span class="nc" id="L2794">			e.printStackTrace();</span>
<span class="nc" id="L2795">			throw new LMSException();</span>
		}
	}
	protected String generateReceiptDGBoNew(Connection connection, int partyId,
			String partyType, Map&lt;String, List&lt;Long&gt;&gt; transIdMap)
			throws LMSException {
		try {
<span class="nc" id="L2802">			Set&lt;String&gt; dateKeys = transIdMap.keySet();</span>
<span class="nc" id="L2803">			StringBuilder result = new StringBuilder(&quot;&quot;);</span>
			//for (String date : dateKeys) {
			//	List&lt;Integer&gt; transIdList = transIdMap.get(date);
           //List&lt;Integer&gt; transIdList = null;
<span class="nc" id="L2807">			List&lt;Long&gt; transIdList = new ArrayList&lt;Long&gt;();</span>
<span class="nc bnc" id="L2808" title="All 2 branches missed.">			for (String date : dateKeys) {</span>
					//transIdList = transIdMap.get(date);
<span class="nc" id="L2810">				    transIdList.addAll(transIdMap.get(date)) ;</span>
<span class="nc" id="L2811">			}</span>

				// get latest generated receipt number
				// PreparedStatement autoGenRecptPstmtBO =
				// connection.prepareStatement(QueryManager.getBOLatestReceiptNb());
<span class="nc" id="L2816">				String query = &quot;SELECT generated_id from st_lms_bo_receipts where receipt_type='DG_INVOICE' or receipt_type='DG_RECEIPT' ORDER BY generated_id DESC LIMIT 1&quot;;</span>
<span class="nc" id="L2817">				PreparedStatement autoGenRecptPstmtBO = connection</span>
						.prepareStatement(query);
				// autoGenRecptPstmtBO.setString(1, &quot;DG_RECEIPT&quot;);
<span class="nc" id="L2820">				ResultSet recieptRsBO = autoGenRecptPstmtBO.executeQuery();</span>

<span class="nc" id="L2822">				String autoGeneRecieptNoBO = null;</span>
<span class="nc bnc" id="L2823" title="All 2 branches missed.">				if (recieptRsBO.next()) {</span>
<span class="nc" id="L2824">					String lastRecieptNoGeneratedBO = recieptRsBO</span>
							.getString(&quot;generated_id&quot;);
<span class="nc" id="L2826">					autoGeneRecieptNoBO = GenerateRecieptNo.getRecieptNo(</span>
							&quot;DG_RECEIPT&quot;, lastRecieptNoGeneratedBO, &quot;BO&quot;);
<span class="nc" id="L2828">				} else {</span>
<span class="nc" id="L2829">					autoGeneRecieptNoBO = GenerateRecieptNo.getRecieptNo(</span>
							&quot;DG_RECEIPT&quot;, null, &quot;BO&quot;);
				}
<span class="nc" id="L2832">				logger.debug(&quot;--Reciept No--&quot; + autoGeneRecieptNoBO);</span>
				// for generating receipt********************

<span class="nc" id="L2835">				PreparedStatement boReceiptPstmt = connection</span>
						.prepareStatement(QueryManager.insertInReceiptMaster());
<span class="nc" id="L2837">				boReceiptPstmt.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L2838">				boReceiptPstmt.executeUpdate();</span>
<span class="nc" id="L2839">				int boReceiptId = -1;</span>
<span class="nc" id="L2840">				ResultSet boRSet = boReceiptPstmt.getGeneratedKeys();</span>
<span class="nc bnc" id="L2841" title="All 2 branches missed.">				if (boRSet.next()) {</span>
<span class="nc" id="L2842">					boReceiptId = boRSet.getInt(1);</span>

<span class="nc" id="L2844">					boReceiptPstmt = connection.prepareStatement(QueryManager</span>
							.insertInBOReceipts());
<span class="nc" id="L2846">					boReceiptPstmt.setInt(1, boReceiptId);</span>
<span class="nc" id="L2847">					boReceiptPstmt.setString(2, &quot;DG_RECEIPT&quot;);</span>
<span class="nc" id="L2848">					boReceiptPstmt.setInt(3, partyId);</span>
<span class="nc" id="L2849">					boReceiptPstmt.setString(4, partyType);</span>
<span class="nc" id="L2850">					boReceiptPstmt.setString(5, autoGeneRecieptNoBO);</span>
<span class="nc" id="L2851">					boReceiptPstmt.setTimestamp(6, Util.getCurrentTimeStamp());</span>
<span class="nc" id="L2852">					boReceiptPstmt.execute();</span>

<span class="nc" id="L2854">					PreparedStatement boReceiptMappingPstmt = connection</span>
							.prepareStatement(QueryManager
									.insertBOReceiptTrnMapping());
<span class="nc bnc" id="L2857" title="All 2 branches missed.">					for (Long transId : transIdList) {</span>
<span class="nc" id="L2858">						boReceiptMappingPstmt.setInt(1, boReceiptId);</span>
<span class="nc" id="L2859">						boReceiptMappingPstmt.setLong(2, transId);</span>
<span class="nc" id="L2860">						boReceiptMappingPstmt.execute();</span>
<span class="nc" id="L2861">					}</span>

				}

<span class="nc" id="L2865">				result.append(boReceiptId + &quot;-&quot; + autoGeneRecieptNoBO + &quot;;&quot;);</span>
			//}

<span class="nc" id="L2868">			return result.toString();</span>
<span class="nc" id="L2869">		} catch (SQLException e) {</span>
<span class="nc" id="L2870">			e.printStackTrace();</span>
<span class="nc" id="L2871">			throw new LMSException();</span>
		}
	}
	/**
	 * @since 
	 * @param con
	 */
	public void updateOlaDepositLedgerForRet(Connection con)
	{
<span class="nc" id="L2880">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L2881">		ResultSet rs = null;</span>
		int retOrgId, agtUserId, agtOrgId,walletId;
		String transDate;
		double depositAmt,retComm,agtComm,retDebitAmount,totalRetNetAmt,totalAgtNetAmt;
		try{
<span class="nc" id="L2886">			String depositQuery = &quot;select retailer_comm,agent_comm,DATE(transaction_date) 'transaction_date',wallet_id,a.retailer_org_id,agtUserId,agtOrgId,sum(deposit_Amt) depositAmt,sum(net_amt) totalretNetAmt,sum(agent_net_amt) totalAgentNetAmt from st_ola_ret_deposit a inner join  st_lms_retailer_transaction_master b inner join (select um.user_id retUserId,um.organization_id retOrgId,um.parent_user_id agtUserId,om.parent_id agtOrgId from st_lms_organization_master om inner join st_lms_user_master um on om.organization_id=um.organization_id where om.organization_type='RETAILER') d on a.transaction_id = b.transaction_id and a.retailer_org_id=retOrgId  where claim_status='CLAIM_BAL' group by a.retailer_org_id,a.wallet_id,DATE(b.transaction_date),retailer_comm,agent_comm order by retailer_org_id,wallet_id,transaction_date&quot;;</span>
<span class="nc" id="L2887">			String depositRefundQuery = &quot;select retailer_comm,agent_comm,wallet_id,sum(net_amt) totalretNetAmt,sum(agent_net_amt) totalAgentNetAmt,a.retailer_org_id,agtUserId,agtOrgId,sum(deposit_amt) depositAmt,DATE(transaction_date) 'transaction_date',transaction_type from st_ola_ret_deposit_refund a inner join  st_lms_retailer_transaction_master b inner join (select um.user_id retUserId,um.organization_id retOrgId,um.parent_user_id agtUserId,om.parent_id agtOrgId from st_lms_organization_master om inner join st_lms_user_master um on om.organization_id=um.organization_id where om.organization_type='RETAILER') d on a.transaction_id = b.transaction_id and a.retailer_org_id=retOrgId  where claim_status='CLAIM_BAL' group by a.retailer_org_id,DATE(transaction_date),transaction_type,wallet_id,retailer_comm,agent_comm order by retailer_org_id,transaction_date&quot;;</span>
<span class="nc" id="L2888">			Map&lt;Integer, Double&gt; orgIdAmountMap = new HashMap&lt;Integer, Double&gt;();</span>
<span class="nc" id="L2889">			Map&lt;Integer, Integer&gt; orgIdParentIdMap = new HashMap&lt;Integer, Integer&gt;();</span>
<span class="nc" id="L2890">			Map&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt; orgIdTransIdInvMap = new HashMap&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt;();</span>
<span class="nc" id="L2891">			Map&lt;String, List&lt;Long&gt;&gt; transIdInvMap = null;</span>
<span class="nc" id="L2892">			Map&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt; orgIdTransIdInvRetMap = new HashMap&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt;();</span>
<span class="nc" id="L2893">			Map&lt;String, List&lt;Long&gt;&gt; transIdInvRetMap = null;</span>
<span class="nc" id="L2894">			PreparedStatement pstmtAgt = con.prepareStatement(QueryManager.insertInLMSTransactionMaster());</span>
<span class="nc" id="L2895">			PreparedStatement pstmtAgtTrans = con.prepareStatement(QueryManager.insertInAgentTransactionMaster());</span>
<span class="nc" id="L2896">			pstmt = con.prepareStatement(depositQuery);</span>
<span class="nc" id="L2897">			PreparedStatement insAgtDepositPstmt = con.prepareStatement(&quot;insert into st_ola_agt_deposit(transaction_id, bo_ref_transaction_id, agent_org_id, deposit_amt, net_amt,bo_net_amt,retailer_comm, agent_comm, claim_status, wallet_id, retailer_org_id) values(?,?,?,?,?,?,?,?,?,?,?)&quot;);</span>
<span class="nc" id="L2898">	PreparedStatement updateRetDepositPstmt = con</span>
			.prepareStatement(&quot;update st_ola_ret_deposit a inner join  st_lms_retailer_transaction_master b  on a.transaction_id = b.transaction_id  set claim_status='DONE_CLAIM',agent_ref_transaction_id=? where a.retailer_org_id=? and wallet_id=? and retailer_comm=? and agent_comm=?&quot;);
<span class="nc" id="L2900">	PreparedStatement insAgtDepositRetPstmt = con</span>
			.prepareStatement(&quot;insert into st_ola_agt_deposit_refund (transaction_id, bo_ref_transaction_id, deposit_amt, net_amt,bo_net_amt, retailer_comm,agent_comm,wallet_id, status, retailer_org_id, agent_org_id) values(?,?,?,?,?,?,?,?,?,?,?)&quot;);
<span class="nc" id="L2902">	PreparedStatement updateRetDepositRetPstmt = con</span>
			.prepareStatement(&quot;update st_ola_ret_deposit_refund a inner join  st_lms_retailer_transaction_master b on a.transaction_id = b.transaction_id  set claim_status='DONE_CLAIM',agent_ref_transaction_id=? where a.retailer_org_id=? and DATE(transaction_date)=? and transaction_type=? and wallet_id=? and retailer_comm=? and agent_comm=?&quot;);
<span class="nc" id="L2904">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L2905" title="All 2 branches missed.">			while(rs.next())</span>
			{
<span class="nc" id="L2907">				transDate = rs.getString(&quot;transaction_date&quot;);</span>
<span class="nc" id="L2908">				walletId = rs.getInt(&quot;wallet_id&quot;);</span>
<span class="nc" id="L2909">				retOrgId = rs.getInt(&quot;retailer_org_id&quot;);</span>
<span class="nc" id="L2910">				agtUserId = rs.getInt(&quot;agtUserId&quot;);</span>
<span class="nc" id="L2911">				agtOrgId = rs.getInt(&quot;agtOrgId&quot;);</span>
<span class="nc" id="L2912">				depositAmt = rs.getDouble(&quot;depositAmt&quot;);</span>
<span class="nc" id="L2913">				totalRetNetAmt = rs.getDouble(&quot;totalretNetAmt&quot;);</span>
<span class="nc" id="L2914">				totalAgtNetAmt = rs.getDouble(&quot;totalAgentNetAmt&quot;);</span>
				//totalRetComm = rs.getDouble(&quot;retailerComm&quot;);
				//totalAgtComm = rs.getDouble(&quot;agentComm&quot;);
<span class="nc" id="L2917">				retComm = rs.getDouble(&quot;retailer_comm&quot;);</span>
<span class="nc" id="L2918">				agtComm = rs.getDouble(&quot;agent_comm&quot;);</span>
			

<span class="nc bnc" id="L2921" title="All 2 branches missed.">		if (orgIdAmountMap.containsKey(retOrgId)) {</span>
<span class="nc" id="L2922">			retDebitAmount = orgIdAmountMap.get(retOrgId)</span>
					+ totalRetNetAmt;
		} else {
<span class="nc" id="L2925">			retDebitAmount = totalRetNetAmt;</span>
		}

<span class="nc" id="L2928">		orgIdAmountMap.put(retOrgId, retDebitAmount);</span>
<span class="nc" id="L2929">		orgIdParentIdMap.put(retOrgId, agtOrgId);</span>

<span class="nc bnc" id="L2931" title="All 2 branches missed.">		if (orgIdTransIdInvMap.containsKey(retOrgId)) {</span>
<span class="nc" id="L2932">			transIdInvMap = orgIdTransIdInvMap.get(retOrgId);</span>
		} else {
<span class="nc" id="L2934">			transIdInvMap = new HashMap&lt;String, List&lt;Long&gt;&gt;();</span>
<span class="nc" id="L2935">			orgIdTransIdInvMap.put(retOrgId, transIdInvMap);</span>
		}

		// insert in main transaction table

<span class="nc" id="L2940">		pstmtAgt.setString(1, &quot;AGENT&quot;);</span>
<span class="nc" id="L2941">		pstmtAgt.executeUpdate();</span>
<span class="nc" id="L2942">		ResultSet rsTrns = pstmtAgt.getGeneratedKeys();</span>
<span class="nc bnc" id="L2943" title="All 2 branches missed.">		if(rsTrns.next()) {</span>
<span class="nc" id="L2944">			long  transId = rsTrns.getLong(1);</span>

<span class="nc bnc" id="L2946" title="All 2 branches missed.">			if (!transIdInvMap.containsKey(transDate)) {</span>
<span class="nc" id="L2947">				transIdInvMap.put(transDate,</span>
						new ArrayList&lt;Long&gt;());
			}

<span class="nc" id="L2951">			transIdInvMap.get(transDate).add(transId);</span>
<span class="nc" id="L2952">			pstmtAgtTrans.setLong(1, transId);</span>
<span class="nc" id="L2953">			pstmtAgtTrans.setInt(2, agtUserId);</span>
<span class="nc" id="L2954">			pstmtAgtTrans.setInt(3, agtOrgId);</span>
<span class="nc" id="L2955">			pstmtAgtTrans.setString(4, &quot;RETAILER&quot;);</span>
<span class="nc" id="L2956">			pstmtAgtTrans.setInt(5, retOrgId);</span>
<span class="nc" id="L2957">			pstmtAgtTrans.setString(6, &quot;OLA_DEPOSIT&quot;);</span>
<span class="nc" id="L2958">			pstmtAgtTrans.setTimestamp(7,</span>
					fetchTransTimeStamp(transDate));
<span class="nc" id="L2960">			pstmtAgtTrans.executeUpdate();</span>

<span class="nc" id="L2962">			insAgtDepositPstmt.setLong(1, transId);</span>
<span class="nc" id="L2963">			insAgtDepositPstmt.setInt(2, 0);</span>
<span class="nc" id="L2964">			insAgtDepositPstmt.setInt(3, agtOrgId);</span>
<span class="nc" id="L2965">			insAgtDepositPstmt.setDouble(4, depositAmt);</span>
<span class="nc" id="L2966">			insAgtDepositPstmt.setDouble(5, totalRetNetAmt);</span>
<span class="nc" id="L2967">			insAgtDepositPstmt.setDouble(6, totalAgtNetAmt);</span>
<span class="nc" id="L2968">			insAgtDepositPstmt.setDouble(7, retComm);</span>
<span class="nc" id="L2969">			insAgtDepositPstmt.setDouble(8, agtComm);</span>
<span class="nc" id="L2970">			insAgtDepositPstmt.setString(9, &quot;CLAIM_BAL&quot;);</span>
<span class="nc" id="L2971">			insAgtDepositPstmt.setInt(10, walletId);</span>
<span class="nc" id="L2972">			insAgtDepositPstmt.setInt(11, retOrgId);</span>
<span class="nc" id="L2973">			insAgtDepositPstmt.executeUpdate();</span>

			// update retailer table
<span class="nc" id="L2976">			updateRetDepositPstmt.setLong(1, transId); // agent trans</span>
			// Id
<span class="nc" id="L2978">			updateRetDepositPstmt.setInt(2, retOrgId);</span>
<span class="nc" id="L2979">			updateRetDepositPstmt.setInt(3, walletId);</span>
<span class="nc" id="L2980">			updateRetDepositPstmt.setDouble(4, retComm);</span>
<span class="nc" id="L2981">			updateRetDepositPstmt.setDouble(5, agtComm);</span>
<span class="nc" id="L2982">			int isUpdate = updateRetDepositPstmt.executeUpdate();</span>
<span class="nc" id="L2983">			System.out.println(&quot;isUpdate&quot;+isUpdate);</span>
			
		}

<span class="nc" id="L2987">	}</span>

<span class="nc" id="L2989">	pstmt = con.prepareStatement(depositRefundQuery);</span>
<span class="nc" id="L2990">	rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L2991" title="All 2 branches missed.">	while (rs.next()) {</span>
<span class="nc" id="L2992">		retComm = rs.getDouble(&quot;retailer_comm&quot;);</span>
<span class="nc" id="L2993">		agtComm = rs.getDouble(&quot;agent_comm&quot;);</span>
<span class="nc" id="L2994">		walletId = rs.getInt(&quot;wallet_id&quot;);</span>
<span class="nc" id="L2995">		totalRetNetAmt = rs.getDouble(&quot;totalretNetAmt&quot;);</span>
<span class="nc" id="L2996">		retOrgId = rs.getInt(&quot;retailer_org_id&quot;);</span>
<span class="nc" id="L2997">		agtUserId = rs.getInt(&quot;agtUserId&quot;);</span>
<span class="nc" id="L2998">		agtOrgId = rs.getInt(&quot;agtOrgId&quot;);</span>
<span class="nc" id="L2999">		totalAgtNetAmt = rs.getDouble(&quot;totalAgentNetAmt&quot;);</span>
<span class="nc" id="L3000">		depositAmt = rs.getDouble(&quot;depositAmt&quot;);</span>
		//totalRetComm = rs.getDouble(&quot;totalRetComm&quot;);
		//totalAgtComm = rs.getDouble(&quot;totalagtComm&quot;);
<span class="nc" id="L3003">		transDate = rs.getString(&quot;transaction_date&quot;);</span>
<span class="nc" id="L3004">		String tranType = rs.getString(&quot;transaction_type&quot;);</span>
<span class="nc bnc" id="L3005" title="All 2 branches missed.">		if (orgIdAmountMap.containsKey(retOrgId)) {</span>
<span class="nc" id="L3006">			retDebitAmount = orgIdAmountMap.get(retOrgId)</span>
					- totalRetNetAmt;
		} else {
<span class="nc" id="L3009">			retDebitAmount = totalRetNetAmt;</span>
		}

<span class="nc" id="L3012">		orgIdAmountMap.put(retOrgId, retDebitAmount);</span>
<span class="nc" id="L3013">		orgIdParentIdMap.put(retOrgId, agtOrgId);</span>

<span class="nc bnc" id="L3015" title="All 2 branches missed.">		if (orgIdTransIdInvRetMap.containsKey(retOrgId)) {</span>
<span class="nc" id="L3016">			transIdInvRetMap = orgIdTransIdInvRetMap.get(retOrgId);</span>
		} else {
<span class="nc" id="L3018">			transIdInvRetMap = new HashMap&lt;String, List&lt;Long&gt;&gt;();</span>
<span class="nc" id="L3019">			orgIdTransIdInvRetMap.put(retOrgId, transIdInvRetMap);</span>
		}

		// insert in main transaction table

<span class="nc" id="L3024">		pstmtAgt.setString(1, &quot;AGENT&quot;);</span>
<span class="nc" id="L3025">		pstmtAgt.executeUpdate();</span>
<span class="nc" id="L3026">		ResultSet rsTrns = pstmtAgt.getGeneratedKeys();</span>
<span class="nc bnc" id="L3027" title="All 2 branches missed.">		if(rsTrns.next()) {</span>
<span class="nc" id="L3028">			long transId = rsTrns.getLong(1);</span>

<span class="nc bnc" id="L3030" title="All 2 branches missed.">			if (!transIdInvRetMap.containsKey(transDate)) {</span>
<span class="nc" id="L3031">				transIdInvRetMap.put(transDate,</span>
						new ArrayList&lt;Long&gt;());
			}

<span class="nc" id="L3035">			transIdInvRetMap.get(transDate).add(transId);</span>

<span class="nc" id="L3037">			pstmtAgtTrans.setLong(1, transId);</span>
<span class="nc" id="L3038">			pstmtAgtTrans.setInt(2, agtUserId);</span>
<span class="nc" id="L3039">			pstmtAgtTrans.setDouble(3, agtOrgId);</span>
<span class="nc" id="L3040">			pstmtAgtTrans.setString(4, &quot;RETAILER&quot;);</span>
<span class="nc" id="L3041">			pstmtAgtTrans.setInt(5, retOrgId);</span>
<span class="nc" id="L3042">			pstmtAgtTrans.setString(6, tranType);</span>
<span class="nc" id="L3043">			pstmtAgtTrans.setTimestamp(7,</span>
					fetchTransTimeStamp(transDate));
<span class="nc" id="L3045">			pstmtAgtTrans.executeUpdate();</span>

<span class="nc" id="L3047">			insAgtDepositRetPstmt.setLong(1, transId);</span>
<span class="nc" id="L3048">			insAgtDepositRetPstmt.setInt(2, 0);</span>
<span class="nc" id="L3049">			insAgtDepositRetPstmt.setDouble(3, depositAmt);</span>
<span class="nc" id="L3050">			insAgtDepositRetPstmt.setDouble(4, totalRetNetAmt);</span>
<span class="nc" id="L3051">			insAgtDepositRetPstmt.setDouble(5, totalAgtNetAmt);</span>
<span class="nc" id="L3052">			insAgtDepositRetPstmt.setDouble(6, retComm);</span>
<span class="nc" id="L3053">			insAgtDepositRetPstmt.setDouble(7, agtComm);</span>
<span class="nc" id="L3054">			insAgtDepositRetPstmt.setInt(8, walletId);</span>
<span class="nc" id="L3055">			insAgtDepositRetPstmt.setString(9, &quot;CLAIM_BAL&quot;);</span>
<span class="nc" id="L3056">			insAgtDepositRetPstmt.setInt(10, retOrgId);</span>
<span class="nc" id="L3057">			insAgtDepositRetPstmt.setInt(11, agtOrgId);</span>
<span class="nc" id="L3058">			insAgtDepositRetPstmt.executeUpdate();</span>

			// update retailer table
<span class="nc" id="L3061">			updateRetDepositRetPstmt.setLong(1, transId); // agent</span>
			// trans Id
<span class="nc" id="L3063">			updateRetDepositRetPstmt.setInt(2, retOrgId);</span>
<span class="nc" id="L3064">			updateRetDepositRetPstmt.setString(3, transDate);</span>
<span class="nc" id="L3065">			updateRetDepositRetPstmt.setString(4, tranType);</span>
<span class="nc" id="L3066">			updateRetDepositRetPstmt.setInt(5, walletId);</span>
<span class="nc" id="L3067">			updateRetDepositRetPstmt.setDouble(6, retComm);</span>
<span class="nc" id="L3068">			updateRetDepositRetPstmt.setDouble(7, agtComm);</span>
<span class="nc" id="L3069">			updateRetDepositRetPstmt.executeUpdate();</span>
		}

<span class="nc" id="L3072">	}</span>
	
<span class="nc" id="L3074">	generateDGReceiptNew(orgIdTransIdInvMap, orgIdParentIdMap,</span>
			&quot;OLA_INVOICE&quot;, &quot;OLA_RECEIPT&quot;, con);
<span class="nc" id="L3076">	generateDGReceiptNew(orgIdTransIdInvRetMap, orgIdParentIdMap,</span>
			&quot;CR_NOTE&quot;, &quot;CR_NOTE_CASH&quot;, con);
// update retailer balance
<span class="nc" id="L3079">Set&lt;Integer&gt; retOrgIdSet = orgIdAmountMap.keySet();</span>

<span class="nc bnc" id="L3081" title="All 2 branches missed.">			for (Integer orgId : retOrgIdSet) {</span>

<span class="nc" id="L3083">				boolean isValid = OrgCreditUpdation.updateOrganizationBalWithValidate(</span>
						orgIdAmountMap.get(orgId), &quot;TRANSACTION&quot;, &quot;OLA_DEPOSIT&quot;,orgId,
						orgIdParentIdMap.get(orgId), &quot;RETAILER&quot;,
								0, con);
<span class="nc bnc" id="L3087" title="All 2 branches missed.">				if (!isValid)</span>
<span class="nc" id="L3088">					throw new LMSException();</span>

<span class="nc" id="L3090">				OrgCreditUpdation.updateOrganizationBalWithValidate(</span>
						orgIdAmountMap.get(orgId), &quot;CLAIM_BAL&quot;, &quot;DEBIT&quot;, orgId,
						orgIdParentIdMap.get(orgId), &quot;RETAILER&quot;, 0, con);

				/*
				 * OrgCreditUpdation.updateCreditLimitForRetailer(orgId,
				 * &quot;OLA_DEPOSIT&quot;, orgIdAmountMap.get(orgId), con);
				 * updateOrgBalance(&quot;CLAIM_BAL&quot;, orgIdAmountMap.get(orgId),
				 * orgId, &quot;DEBIT&quot;, con);
				 */

<span class="nc" id="L3101">			}</span>
} 
<span class="nc" id="L3103">		catch(Exception e)</span>
		{
<span class="nc" id="L3105">			e.printStackTrace();</span>
<span class="nc" id="L3106">		}</span>
<span class="nc" id="L3107">}		</span>
	public void updateOlaWithdrawlLedgerForRet(Connection con)
	{
<span class="nc" id="L3110">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L3111">		ResultSet rs = null;</span>
<span class="nc" id="L3112">		int retOrgId = 0, agtUserId, agtOrgId,walletId;</span>
		String transDate;
		double withdrawlAmt,retComm,agtComm,retDebitAmount,totalRetNetAmt,totalAgtNetAmt;
		try{
<span class="nc" id="L3116">			String withdrawlQuery = &quot;select retailer_comm,agent_comm,DATE(transaction_date) 'transaction_date',wallet_id,a.retailer_org_id,agtUserId,agtOrgId,sum(withdrawl_Amt) withdrawlAmt,sum(net_amt) totalretNetAmt,sum(agent_net_amt) totalAgentNetAmt from st_ola_ret_withdrawl a inner join  st_lms_retailer_transaction_master b inner join (select um.user_id retUserId,um.organization_id retOrgId,um.parent_user_id agtUserId,om.parent_id agtOrgId from st_lms_organization_master om inner join st_lms_user_master um on om.organization_id=um.organization_id where om.organization_type='RETAILER') d on a.transaction_id = b.transaction_id and a.retailer_org_id=retOrgId  where claim_status='CLAIM_BAL' group by a.retailer_org_id,a.wallet_id,DATE(b.transaction_id),retailer_comm,agent_comm order by retailer_org_id,wallet_id,transaction_date&quot;;</span>
<span class="nc" id="L3117">			String withdrawlRefundQuery = &quot;select wallet_id,sum(net_amt) totalretNetAmt,sum(agent_net_amt) totalAgentNetAmt,a.retailer_org_id,agtUserId,agtOrgId,sum(withdrawl_amt) withdrawlAmt,retailer_comm,agent_comm,DATE(transaction_date) 'transaction_date',transaction_type from st_ola_ret_withdrawl_refund a inner join  st_lms_retailer_transaction_master b inner join (select um.user_id retUserId,um.organization_id retOrgId,um.parent_user_id agtUserId,om.parent_id agtOrgId from st_lms_organization_master om inner join st_lms_user_master um on om.organization_id=um.organization_id where om.organization_type='RETAILER') d on a.transaction_id = b.transaction_id and a.retailer_org_id=retOrgId  where claim_status='CLAIM_BAL' group by a.retailer_org_id,DATE(transaction_date),transaction_type,wallet_id,retailer_comm,agent_comm order by retailer_org_id,transaction_date&quot;;</span>
<span class="nc" id="L3118">			Map&lt;Integer, Double&gt; orgIdAmountMap = new HashMap&lt;Integer, Double&gt;();</span>
<span class="nc" id="L3119">			Map&lt;Integer, Integer&gt; orgIdParentIdMap = new HashMap&lt;Integer, Integer&gt;();</span>
<span class="nc" id="L3120">			Map&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt; orgIdTransIdInvMap = new HashMap&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt;();</span>
<span class="nc" id="L3121">			Map&lt;String, List&lt;Long&gt;&gt; transIdInvMap = null;</span>
<span class="nc" id="L3122">			Map&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt; orgIdTransIdInvRetMap = new HashMap&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt;();</span>
<span class="nc" id="L3123">			Map&lt;String, List&lt;Long&gt;&gt; transIdInvRetMap = null;</span>
<span class="nc" id="L3124">			PreparedStatement pstmtAgt = con.prepareStatement(QueryManager</span>
					.insertInLMSTransactionMaster());
<span class="nc" id="L3126">			PreparedStatement pstmtAgtTrans = con.prepareStatement(QueryManager</span>
					.insertInAgentTransactionMaster());
<span class="nc" id="L3128">			pstmt = con.prepareStatement(withdrawlQuery);</span>
<span class="nc" id="L3129">			PreparedStatement insAgtWithdrawlPstmt = con</span>
			.prepareStatement(&quot;insert into st_ola_agt_withdrawl(transaction_id, bo_ref_transaction_id, agent_org_id, withdrawl_amt, net_amt,bo_net_amt,retailer_comm, agent_comm, claim_status, wallet_id, retailer_org_id) values(?,?,?,?,?,?,?,?,?,?,?)&quot;);
<span class="nc" id="L3131">	PreparedStatement updateRetWithdrawlPstmt = con</span>
			.prepareStatement(&quot;update st_ola_ret_withdrawl a inner join  st_lms_retailer_transaction_master b  on a.transaction_id = b.transaction_id  set claim_status='DONE_CLAIM',agent_ref_transaction_id=? where a.retailer_org_id=? and wallet_id=? and retailer_comm=? and agent_comm=?&quot;);
<span class="nc" id="L3133">	PreparedStatement insAgtWithdrawlRetPstmt = con</span>
			.prepareStatement(&quot;insert into st_ola_agt_withdrawl_refund (transaction_id, bo_ref_transaction_id, withdrawl_amt, net_amt,bo_net_amt,retailer_comm,agent_comm ,wallet_id, status, retailer_org_id, agent_org_id) values(?,?,?,?,?,?,?,?,?,?,?)&quot;);
<span class="nc" id="L3135">	PreparedStatement updateRetWithdrawlRetPstmt = con</span>
			.prepareStatement(&quot;update st_ola_ret_withdrawl_refund a inner join  st_lms_retailer_transaction_master b on a.transaction_id = b.transaction_id  set claim_status='DONE_CLAIM',agent_ref_transaction_id=? where a.retailer_org_id=? and DATE(transaction_date)=? and transaction_type=? and wallet_id=? and retailer_comm=? and agent_comm=?&quot;);
<span class="nc" id="L3137">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L3138" title="All 2 branches missed.">			while(rs.next())</span>
			{
<span class="nc" id="L3140">				transDate = rs.getString(&quot;transaction_date&quot;);</span>
<span class="nc" id="L3141">				walletId = rs.getInt(&quot;wallet_id&quot;);</span>
<span class="nc" id="L3142">				retOrgId = rs.getInt(&quot;retailer_org_id&quot;);</span>
<span class="nc" id="L3143">				agtUserId = rs.getInt(&quot;agtUserId&quot;);</span>
<span class="nc" id="L3144">				agtOrgId = rs.getInt(&quot;agtOrgId&quot;);</span>
<span class="nc" id="L3145">				withdrawlAmt = rs.getDouble(&quot;withdrawlAmt&quot;);</span>
<span class="nc" id="L3146">				totalRetNetAmt = rs.getDouble(&quot;totalretNetAmt&quot;);</span>
				
<span class="nc" id="L3148">				totalAgtNetAmt = rs.getDouble(&quot;totalAgentNetAmt&quot;);</span>
				//totalRetComm = rs.getDouble(&quot;retailerComm&quot;);
				//totalAgtComm = rs.getDouble(&quot;agentComm&quot;);
<span class="nc" id="L3151">				retComm = rs.getDouble(&quot;retailer_comm&quot;);</span>
<span class="nc" id="L3152">				agtComm = rs.getDouble(&quot;agent_comm&quot;);</span>
			

<span class="nc bnc" id="L3155" title="All 2 branches missed.">		if (orgIdAmountMap.containsKey(retOrgId)) {</span>
<span class="nc" id="L3156">			retDebitAmount = orgIdAmountMap.get(retOrgId)</span>
					+ totalRetNetAmt;
		} else {
<span class="nc" id="L3159">			retDebitAmount = totalRetNetAmt;</span>
		}

<span class="nc" id="L3162">		orgIdAmountMap.put(retOrgId, retDebitAmount);</span>
<span class="nc" id="L3163">		orgIdParentIdMap.put(retOrgId, agtOrgId);</span>

<span class="nc bnc" id="L3165" title="All 2 branches missed.">		if (orgIdTransIdInvMap.containsKey(retOrgId)) {</span>
<span class="nc" id="L3166">			transIdInvMap = orgIdTransIdInvMap.get(retOrgId);</span>
		} else {
<span class="nc" id="L3168">			transIdInvMap = new HashMap&lt;String, List&lt;Long&gt;&gt;();</span>
<span class="nc" id="L3169">			orgIdTransIdInvMap.put(retOrgId, transIdInvMap);</span>
		}

		// insert in main transaction table

<span class="nc" id="L3174">		pstmtAgt.setString(1, &quot;AGENT&quot;);</span>
<span class="nc" id="L3175">		pstmtAgt.executeUpdate();</span>
<span class="nc" id="L3176">		ResultSet rsTrns = pstmtAgt.getGeneratedKeys();</span>
<span class="nc bnc" id="L3177" title="All 2 branches missed.">		if(rsTrns.next()) {</span>
<span class="nc" id="L3178">			long transId = rsTrns.getLong(1);</span>

<span class="nc bnc" id="L3180" title="All 2 branches missed.">			if (!transIdInvMap.containsKey(transDate)) {</span>
<span class="nc" id="L3181">				transIdInvMap.put(transDate,</span>
						new ArrayList&lt;Long&gt;());
			}

<span class="nc" id="L3185">			transIdInvMap.get(transDate).add(transId);</span>
<span class="nc" id="L3186">			pstmtAgtTrans.setLong(1, transId);</span>
<span class="nc" id="L3187">			pstmtAgtTrans.setInt(2, agtUserId);</span>
<span class="nc" id="L3188">			pstmtAgtTrans.setInt(3, agtOrgId);</span>
<span class="nc" id="L3189">			pstmtAgtTrans.setString(4, &quot;RETAILER&quot;);</span>
<span class="nc" id="L3190">			pstmtAgtTrans.setInt(5, retOrgId);</span>
<span class="nc" id="L3191">			pstmtAgtTrans.setString(6, &quot;OLA_WITHDRAWL&quot;);</span>
<span class="nc" id="L3192">			pstmtAgtTrans.setTimestamp(7,</span>
					fetchTransTimeStamp(transDate));
<span class="nc" id="L3194">			pstmtAgtTrans.executeUpdate();</span>

<span class="nc" id="L3196">			insAgtWithdrawlPstmt.setLong(1, transId);</span>
<span class="nc" id="L3197">			insAgtWithdrawlPstmt.setInt(2, 0);</span>
<span class="nc" id="L3198">			insAgtWithdrawlPstmt.setInt(3, agtOrgId);</span>
<span class="nc" id="L3199">			insAgtWithdrawlPstmt.setDouble(4, withdrawlAmt);</span>
<span class="nc" id="L3200">			insAgtWithdrawlPstmt.setDouble(5, totalRetNetAmt);</span>
<span class="nc" id="L3201">			insAgtWithdrawlPstmt.setDouble(6, totalAgtNetAmt);</span>
<span class="nc" id="L3202">			insAgtWithdrawlPstmt.setDouble(7, retComm);</span>
<span class="nc" id="L3203">			insAgtWithdrawlPstmt.setDouble(8, agtComm);</span>
<span class="nc" id="L3204">			insAgtWithdrawlPstmt.setString(9, &quot;CLAIM_BAL&quot;);</span>
<span class="nc" id="L3205">			insAgtWithdrawlPstmt.setInt(10, walletId);</span>
<span class="nc" id="L3206">			insAgtWithdrawlPstmt.setInt(11, retOrgId);</span>
<span class="nc" id="L3207">			insAgtWithdrawlPstmt.executeUpdate();</span>

			// update retailer table
<span class="nc" id="L3210">			updateRetWithdrawlPstmt.setLong(1, transId); // agent trans</span>
			// Id
<span class="nc" id="L3212">			updateRetWithdrawlPstmt.setInt(2, retOrgId);</span>
<span class="nc" id="L3213">			updateRetWithdrawlPstmt.setInt(3, walletId);</span>
<span class="nc" id="L3214">			updateRetWithdrawlPstmt.setDouble(4, retComm);</span>
<span class="nc" id="L3215">			updateRetWithdrawlPstmt.setDouble(5, agtComm);</span>
<span class="nc" id="L3216">			updateRetWithdrawlPstmt.executeUpdate();</span>
			
		}

<span class="nc" id="L3220">	}</span>

<span class="nc" id="L3222">	pstmt = con.prepareStatement(withdrawlRefundQuery);</span>
<span class="nc" id="L3223">	rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L3224" title="All 2 branches missed.">	while (rs.next()) {</span>
<span class="nc" id="L3225">		retComm = rs.getDouble(&quot;retailer_comm&quot;);</span>
<span class="nc" id="L3226">		agtComm = rs.getDouble(&quot;agent_comm&quot;);</span>
<span class="nc" id="L3227">		walletId = rs.getInt(&quot;wallet_id&quot;);</span>
<span class="nc" id="L3228">		totalRetNetAmt = rs.getDouble(&quot;totalretNetAmt&quot;);</span>
<span class="nc" id="L3229">		retOrgId = rs.getInt(&quot;retailer_org_id&quot;);</span>
<span class="nc" id="L3230">		agtUserId = rs.getInt(&quot;agtUserId&quot;);</span>
<span class="nc" id="L3231">		agtOrgId = rs.getInt(&quot;agtOrgId&quot;);</span>
<span class="nc" id="L3232">		withdrawlAmt = rs.getDouble(&quot;withdrawlAmt&quot;);</span>
<span class="nc" id="L3233">		totalAgtNetAmt = rs.getDouble(&quot;totalAgentNetAmt&quot;);</span>
		//	totalRetComm = rs.getDouble(&quot;totalRetComm&quot;);
		//totalAgtComm = rs.getDouble(&quot;totalagtComm&quot;);
<span class="nc" id="L3236">		transDate = rs.getString(&quot;transaction_date&quot;);</span>
<span class="nc" id="L3237">		String tranType = rs.getString(&quot;transaction_type&quot;);</span>
<span class="nc bnc" id="L3238" title="All 2 branches missed.">		if (orgIdAmountMap.containsKey(retOrgId)) {</span>
<span class="nc" id="L3239">			retDebitAmount = orgIdAmountMap.get(retOrgId)</span>
					- totalRetNetAmt;
		} else {
<span class="nc" id="L3242">			retDebitAmount = totalRetNetAmt;</span>
		}

<span class="nc" id="L3245">		orgIdAmountMap.put(retOrgId, retDebitAmount);</span>
<span class="nc" id="L3246">		orgIdParentIdMap.put(retOrgId, agtOrgId);</span>

<span class="nc bnc" id="L3248" title="All 2 branches missed.">		if (orgIdTransIdInvRetMap.containsKey(retOrgId)) {</span>
<span class="nc" id="L3249">			transIdInvRetMap = orgIdTransIdInvRetMap.get(retOrgId);</span>
		} else {
<span class="nc" id="L3251">			transIdInvRetMap = new HashMap&lt;String, List&lt;Long&gt;&gt;();</span>
<span class="nc" id="L3252">			orgIdTransIdInvRetMap.put(retOrgId, transIdInvRetMap);</span>
		}

		// insert in main transaction table

<span class="nc" id="L3257">		pstmtAgt.setString(1, &quot;AGENT&quot;);</span>
<span class="nc" id="L3258">		pstmtAgt.executeUpdate();</span>
<span class="nc" id="L3259">		ResultSet rsTrns = pstmtAgt.getGeneratedKeys();</span>
<span class="nc bnc" id="L3260" title="All 2 branches missed.">		if(rsTrns.next()) {</span>
<span class="nc" id="L3261">			long transId = rsTrns.getLong(1);</span>

<span class="nc bnc" id="L3263" title="All 2 branches missed.">			if (!transIdInvRetMap.containsKey(transDate)) {</span>
<span class="nc" id="L3264">				transIdInvRetMap.put(transDate,</span>
						new ArrayList&lt;Long&gt;());
			}

<span class="nc" id="L3268">			transIdInvRetMap.get(transDate).add(transId);</span>

<span class="nc" id="L3270">			pstmtAgtTrans.setLong(1, transId);</span>
<span class="nc" id="L3271">			pstmtAgtTrans.setInt(2, agtUserId);</span>
<span class="nc" id="L3272">			pstmtAgtTrans.setDouble(3, agtOrgId);</span>
<span class="nc" id="L3273">			pstmtAgtTrans.setString(4, &quot;RETAILER&quot;);</span>
<span class="nc" id="L3274">			pstmtAgtTrans.setInt(5, retOrgId);</span>
<span class="nc" id="L3275">			pstmtAgtTrans.setString(6, tranType);</span>
<span class="nc" id="L3276">			pstmtAgtTrans.setTimestamp(7,</span>
					fetchTransTimeStamp(transDate));
<span class="nc" id="L3278">			pstmtAgtTrans.executeUpdate();</span>

<span class="nc" id="L3280">			insAgtWithdrawlRetPstmt.setLong(1, transId);</span>
<span class="nc" id="L3281">			insAgtWithdrawlRetPstmt.setInt(2, 0);</span>
<span class="nc" id="L3282">			insAgtWithdrawlRetPstmt.setDouble(3, withdrawlAmt);</span>
<span class="nc" id="L3283">			insAgtWithdrawlRetPstmt.setDouble(4, totalRetNetAmt);</span>
<span class="nc" id="L3284">			insAgtWithdrawlRetPstmt.setDouble(5, totalAgtNetAmt);</span>
<span class="nc" id="L3285">			insAgtWithdrawlRetPstmt.setDouble(6, retComm);</span>
<span class="nc" id="L3286">			insAgtWithdrawlRetPstmt.setDouble(7, agtComm);</span>
<span class="nc" id="L3287">			insAgtWithdrawlRetPstmt.setInt(8, walletId);</span>
<span class="nc" id="L3288">			insAgtWithdrawlRetPstmt.setString(9, &quot;CLAIM_BAL&quot;);</span>
<span class="nc" id="L3289">			insAgtWithdrawlRetPstmt.setInt(10, retOrgId);</span>
<span class="nc" id="L3290">			insAgtWithdrawlRetPstmt.setInt(11, agtOrgId);</span>
<span class="nc" id="L3291">			insAgtWithdrawlRetPstmt.executeUpdate();</span>

			// update retailer table
<span class="nc" id="L3294">			updateRetWithdrawlRetPstmt.setLong(1, transId); // agent</span>
			// trans Id
<span class="nc" id="L3296">			updateRetWithdrawlRetPstmt.setInt(2, retOrgId);</span>
<span class="nc" id="L3297">			updateRetWithdrawlRetPstmt.setString(3, transDate);</span>
<span class="nc" id="L3298">			updateRetWithdrawlRetPstmt.setString(4, tranType);</span>
<span class="nc" id="L3299">			updateRetWithdrawlRetPstmt.setInt(5, walletId);</span>
<span class="nc" id="L3300">			updateRetWithdrawlRetPstmt.setDouble(6, retComm);</span>
<span class="nc" id="L3301">			updateRetWithdrawlRetPstmt.setDouble(7, agtComm);</span>
<span class="nc" id="L3302">			updateRetWithdrawlRetPstmt.executeUpdate();</span>
		}

<span class="nc" id="L3305">	}</span>
// update retailer balance
<span class="nc" id="L3307">Set&lt;Integer&gt; retOrgIdSet = orgIdAmountMap.keySet();</span>
<span class="nc bnc" id="L3308" title="All 2 branches missed.">			for (Integer orgId : retOrgIdSet) {</span>

<span class="nc" id="L3310">				boolean isValid = OrgCreditUpdation</span>
						.updateOrganizationBalWithValidate(orgIdAmountMap
								.get(orgId), &quot;TRANSACTION&quot;, &quot;OLA_WITHDRAWL&quot;,
								orgId, orgIdParentIdMap.get(orgId), &quot;RETAILER&quot;,
								0, con);
<span class="nc bnc" id="L3315" title="All 2 branches missed.">				if (!isValid)</span>
<span class="nc" id="L3316">					throw new LMSException();</span>

<span class="nc" id="L3318">				OrgCreditUpdation.updateOrganizationBalWithValidate(</span>
						orgIdAmountMap.get(orgId), &quot;CLAIM_BAL&quot;, &quot;CREDIT&quot;,
						orgId, orgIdParentIdMap.get(orgId), &quot;RETAILER&quot;, 0, con);
				/*
				 * OrgCreditUpdation.updateCreditLimitForRetailer(orgId,
				 * &quot;OLA_WITHDRAWL&quot;, orgIdAmountMap.get(orgId), con);
				 * 
				 * updateOrgBalance(&quot;CLAIM_BAL&quot;, orgIdAmountMap.get(orgId),
				 * orgId, &quot;CREDIT&quot;, con);
				 */
<span class="nc" id="L3328">				generateReciptForPwtNew(orgIdTransIdInvMap.get(orgId), con,</span>
						orgIdParentIdMap.get(orgId), retOrgId, &quot;RETAILER&quot;,
						&quot;OLA&quot;);

<span class="nc" id="L3332">			}</span>
} 
<span class="nc" id="L3334">		catch(Exception e)</span>
		{
<span class="nc" id="L3336">			e.printStackTrace();</span>
<span class="nc" id="L3337">		}</span>
<span class="nc" id="L3338">	}</span>
	public void updateOlaDepositLedgerForAgt(Connection con)
	{
<span class="nc" id="L3341">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L3342">		ResultSet rs = null;</span>
		double depositAmt, totalAgtNetAmt;
		double agentComm,agtDebitAmount;
		String transDate;
		int agtOrgId, boUserId, boOrgId;
<span class="nc" id="L3347">		Map&lt;Integer, Double&gt; orgIdAmountMap = new HashMap&lt;Integer, Double&gt;();</span>
<span class="nc" id="L3348">		Map&lt;Integer, Integer&gt; orgIdParentIdMap = new HashMap&lt;Integer, Integer&gt;();</span>
<span class="nc" id="L3349">		Map&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt; orgIdTransIdInvMap = new HashMap&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt;();</span>
<span class="nc" id="L3350">		Map&lt;String, List&lt;Long&gt;&gt; transIdInvMap = null;</span>
<span class="nc" id="L3351">		Map&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt; orgIdTransIdInvRetMap = new HashMap&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt;();</span>
<span class="nc" id="L3352">		Map&lt;String, List&lt;Long&gt;&gt; transIdInvRetMap = null;</span>
		try {
<span class="nc" id="L3354">			String depositQry = &quot;select agent_org_id,boUserId,boOrgId,depositAmt,bo_net_amt,wallet_id,transaction_date,agent_comm from(select a.agent_org_id,sum(deposit_amt) depositAmt,sum(bo_net_amt) bo_net_amt ,a.wallet_id,DATE(transaction_date) 'transaction_date',agent_comm from ((select agent_org_id,deposit_amt,bo_net_amt ,wallet_id,transaction_id,agent_comm from st_ola_agt_deposit where claim_status='CLAIM_BAL') union all (select agent_org_id,deposit_amt,net_amt bo_net_amt,wallet_id,transaction_id,agt_claim_comm from st_ola_agt_direct_plr_deposit where deposit_claim_status='CLAIM_BAL')) a inner join  st_lms_agent_transaction_master b  on a.transaction_id = b.transaction_id   group by a.agent_org_id,DATE(transaction_date),a.wallet_id,agent_comm) deposit inner join (select um.user_id agtUserId,um.organization_id agtOrgId,um.parent_user_id boUserId,om.parent_id boOrgId,isrolehead from st_lms_organization_master om inner join st_lms_user_master um on om.organization_id=um.organization_id where om.organization_type='AGENT') om on agent_org_id=agtOrgId and isrolehead = 'Y'&quot;;</span>
<span class="nc" id="L3355">			String depositRefundQry = &quot;select agent_org_id,boUserId,boOrgId,depositAmt,bo_net_amt,wallet_id,transaction_date,agent_comm,transaction_type from(select a.agent_org_id,sum(deposit_amt) depositAmt ,sum(bo_net_amt) bo_net_amt,a.wallet_id,DATE(transaction_date) 'transaction_date',agent_comm,transaction_type from ((select agent_org_id,deposit_amt,bo_net_amt ,wallet_id,transaction_id,agent_comm from st_ola_agt_deposit_refund where status='CLAIM_BAL') union all (select agent_org_id,deposit_amt,net_amt bo_net_amt,wallet_id,transaction_id,agt_claim_comm from st_ola_agt_direct_plr_deposit_refund where deposit_claim_status='CLAIM_BAL')) a inner join  st_lms_agent_transaction_master b on a.transaction_id = b.transaction_id   group by a.agent_org_id,DATE(transaction_date),a.wallet_id,transaction_type,agent_comm order by agent_org_id,wallet_id,transaction_date) depositRefund inner join (select um.user_id agtUserId,um.organization_id agtOrgId,um.parent_user_id boUserId,om.parent_id boOrgId,isrolehead from st_lms_organization_master om inner join st_lms_user_master um on om.organization_id=um.organization_id where om.organization_type='AGENT') d on agent_org_id=agtOrgId and isrolehead = 'Y'&quot;;</span>
<span class="nc" id="L3356">			PreparedStatement pstmtBO = con.prepareStatement(QueryManager.insertInLMSTransactionMaster());</span>
<span class="nc" id="L3357">			PreparedStatement insBoTranPstmt = con.prepareStatement(QueryManager.insertInBOTransactionMaster());</span>
<span class="nc" id="L3358">			PreparedStatement insBoDepositPstmt = con</span>
					.prepareStatement(&quot;insert into st_ola_bo_deposit (transaction_id, deposit_amt, net_amt, wallet_id, agent_org_id, agent_comm) values(?,?,?,?,?,?)&quot;);
<span class="nc" id="L3360">			PreparedStatement updAgtDepositpstmt = con</span>
					.prepareStatement(&quot;update st_ola_agt_deposit a inner join st_lms_agent_transaction_master b on a.transaction_id = b.transaction_id set claim_status='DONE_CLAIM',bo_ref_transaction_id=? where a.agent_org_id=?  and agent_comm=? and DATE(transaction_date)=? and wallet_id=?&quot;);
<span class="nc" id="L3362">			PreparedStatement updAgtDirPlrDepositpstmt = con</span>
			.prepareStatement(&quot;update st_ola_agt_direct_plr_deposit a inner join st_lms_agent_transaction_master b on a.transaction_id = b.transaction_id set deposit_claim_status='DONE_CLAIM',bo_ref_transaction_id=? where a.agent_org_id=?  and agt_claim_comm=? and DATE(transaction_date)=? and wallet_id=?&quot;);
	
			
			
<span class="nc" id="L3367">			PreparedStatement insBoDepositRetpstmt = con</span>
					.prepareStatement(&quot;insert into st_ola_bo_deposit_refund(transaction_id, agent_org_id, deposit_amt, net_amt, agent_comm, wallet_id)	values(?,?,?,?,?,?)&quot;);
<span class="nc" id="L3369">			PreparedStatement updAgtDepositRetPstmt = con</span>
					.prepareStatement(&quot;update st_ola_agt_deposit_refund a inner join st_lms_agent_transaction_master b on a.transaction_id = b.transaction_id set status='DONE_CLAIM',bo_ref_transaction_id=? where a.agent_org_id=? and agent_comm=? and DATE(transaction_date)=? and transaction_type=? and wallet_id=?&quot;);
<span class="nc" id="L3371">			PreparedStatement updAgtDirPlrDepositRefpstmt = con</span>
			.prepareStatement(&quot;update st_ola_agt_direct_plr_deposit_refund a inner join st_lms_agent_transaction_master b on a.transaction_id = b.transaction_id set deposit_claim_status='DONE_CLAIM',bo_ref_transaction_id=? where a.agent_org_id=? and agt_claim_comm=? and DATE(transaction_date)=? and transaction_type=? and wallet_id=?&quot;);

		
<span class="nc" id="L3375">			int walletId = 0;</span>
<span class="nc" id="L3376">			pstmt = con.prepareStatement(depositQry);</span>
<span class="nc" id="L3377">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L3378" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L3379">				agtOrgId = rs.getInt(&quot;agent_org_id&quot;);</span>
<span class="nc" id="L3380">				boUserId = rs.getInt(&quot;boUserId&quot;);</span>
<span class="nc" id="L3381">				boOrgId = rs.getInt(&quot;boOrgId&quot;);</span>
<span class="nc" id="L3382">				walletId = rs.getInt(&quot;wallet_id&quot;);</span>
<span class="nc" id="L3383">				depositAmt = rs.getDouble(&quot;depositAmt&quot;);</span>
				//retailerComm = rs.getDouble(&quot;retailer_comm&quot;);
<span class="nc" id="L3385">				agentComm = rs.getDouble(&quot;agent_comm&quot;);</span>
<span class="nc" id="L3386">				transDate = rs.getString(&quot;transaction_date&quot;);</span>
<span class="nc" id="L3387">				totalAgtNetAmt=rs.getDouble(&quot;bo_net_amt&quot;);</span>
				//totalAgtNetAmt = (depositAmt - (depositAmt*agentComm*.01));
				
<span class="nc bnc" id="L3390" title="All 2 branches missed.">				if (orgIdAmountMap.containsKey(agtOrgId)) {</span>
<span class="nc" id="L3391">					agtDebitAmount = orgIdAmountMap.get(agtOrgId)</span>
							+ totalAgtNetAmt;
				} else {
<span class="nc" id="L3394">					agtDebitAmount = totalAgtNetAmt;</span>
				}

<span class="nc" id="L3397">				orgIdAmountMap.put(agtOrgId, agtDebitAmount);</span>
<span class="nc" id="L3398">				orgIdParentIdMap.put(agtOrgId, boOrgId);</span>

<span class="nc bnc" id="L3400" title="All 2 branches missed.">				if (orgIdTransIdInvMap.containsKey(agtOrgId)) {</span>
<span class="nc" id="L3401">					transIdInvMap = orgIdTransIdInvMap.get(agtOrgId);</span>
				} else {
<span class="nc" id="L3403">					transIdInvMap = new HashMap&lt;String, List&lt;Long&gt;&gt;();</span>
<span class="nc" id="L3404">					orgIdTransIdInvMap.put(agtOrgId, transIdInvMap);</span>
				}

				// insert in main transaction table

<span class="nc" id="L3409">				pstmtBO.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L3410">				pstmtBO.executeUpdate();</span>
<span class="nc" id="L3411">				ResultSet rsTrns = pstmtBO.getGeneratedKeys();</span>
<span class="nc bnc" id="L3412" title="All 2 branches missed.">				if (rsTrns.next()) {</span>
<span class="nc" id="L3413">					long transId = rsTrns.getLong(1);</span>

<span class="nc bnc" id="L3415" title="All 2 branches missed.">					if (!transIdInvMap.containsKey(transDate)) {</span>
<span class="nc" id="L3416">						transIdInvMap.put(transDate, new ArrayList&lt;Long&gt;());</span>
					}

<span class="nc" id="L3419">					transIdInvMap.get(transDate).add(transId);</span>

<span class="nc" id="L3421">					insBoTranPstmt.setLong(1, transId);</span>
<span class="nc" id="L3422">					insBoTranPstmt.setInt(2, boUserId);</span>
<span class="nc" id="L3423">					insBoTranPstmt.setInt(3, boOrgId);</span>
<span class="nc" id="L3424">					insBoTranPstmt.setString(4, &quot;AGENT&quot;);</span>
<span class="nc" id="L3425">					insBoTranPstmt.setInt(5, agtOrgId);</span>
<span class="nc" id="L3426">					insBoTranPstmt.setTimestamp(6,</span>
							fetchTransTimeStamp(transDate));
<span class="nc" id="L3428">					insBoTranPstmt.setString(7, &quot;OLA_DEPOSIT&quot;);</span>
<span class="nc" id="L3429">					insBoTranPstmt.executeUpdate();</span>

<span class="nc" id="L3431">					insBoDepositPstmt.setLong(1, transId);</span>
<span class="nc" id="L3432">					insBoDepositPstmt.setDouble(2, depositAmt);</span>
<span class="nc" id="L3433">					insBoDepositPstmt.setDouble(3, totalAgtNetAmt);</span>
<span class="nc" id="L3434">					insBoDepositPstmt.setInt(4, walletId);</span>
<span class="nc" id="L3435">					insBoDepositPstmt.setInt(5, agtOrgId);</span>
<span class="nc" id="L3436">					insBoDepositPstmt.setDouble(6, agentComm);</span>
<span class="nc" id="L3437">					insBoDepositPstmt.executeUpdate();</span>

					// update retupdateOlaDepositLedgerForAgtailer table

<span class="nc" id="L3441">					updAgtDepositpstmt.setLong(1, transId); // agent trans Id</span>
<span class="nc" id="L3442">					updAgtDepositpstmt.setInt(2, agtOrgId);</span>
<span class="nc" id="L3443">					updAgtDepositpstmt.setDouble(3, agentComm);</span>
<span class="nc" id="L3444">					updAgtDepositpstmt.setString(4, transDate);</span>
<span class="nc" id="L3445">					updAgtDepositpstmt.setInt(5, walletId);</span>
<span class="nc" id="L3446">					updAgtDepositpstmt.executeUpdate();</span>
					// update agent direct player deposit 
<span class="nc" id="L3448">					updAgtDirPlrDepositpstmt.setLong(1, transId); // agent trans Id</span>
<span class="nc" id="L3449">					updAgtDirPlrDepositpstmt.setInt(2, agtOrgId);</span>
<span class="nc" id="L3450">					updAgtDirPlrDepositpstmt.setDouble(3, agentComm);</span>
<span class="nc" id="L3451">					updAgtDirPlrDepositpstmt.setString(4, transDate);</span>
<span class="nc" id="L3452">					updAgtDirPlrDepositpstmt.setInt(5, walletId);</span>
<span class="nc" id="L3453">					updAgtDirPlrDepositpstmt.executeUpdate();</span>
					
					
				}
<span class="nc" id="L3457">			}</span>

<span class="nc" id="L3459">			pstmt = con.prepareStatement(depositRefundQry);</span>
<span class="nc" id="L3460">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L3461" title="All 2 branches missed.">			while (rs.next()) {</span>

<span class="nc" id="L3463">				agtOrgId = rs.getInt(&quot;agent_org_id&quot;);</span>
<span class="nc" id="L3464">				boUserId = rs.getInt(&quot;boUserId&quot;);</span>
<span class="nc" id="L3465">				boOrgId = rs.getInt(&quot;boOrgId&quot;);</span>
<span class="nc" id="L3466">				walletId = rs.getInt(&quot;wallet_id&quot;);</span>
<span class="nc" id="L3467">				depositAmt = rs.getDouble(&quot;depositAmt&quot;);</span>
<span class="nc" id="L3468">				agentComm = rs.getDouble(&quot;agent_comm&quot;);</span>
				///	retailerComm = rs.getDouble(&quot;retailer_comm&quot;);
<span class="nc" id="L3470">				transDate = rs.getString(&quot;transaction_date&quot;);</span>
<span class="nc" id="L3471">				totalAgtNetAmt =rs.getDouble(&quot;bo_net_amt&quot;);</span>
				//totalAgtNetAmt = depositAmt - (depositAmt*agentComm*.01);
<span class="nc" id="L3473">				String tranType = rs.getString(&quot;transaction_type&quot;);</span>

<span class="nc bnc" id="L3475" title="All 2 branches missed.">				if (orgIdAmountMap.containsKey(agtOrgId)) {</span>
<span class="nc" id="L3476">					agtDebitAmount = orgIdAmountMap.get(agtOrgId)</span>
							- totalAgtNetAmt;
				} else {
<span class="nc" id="L3479">					agtDebitAmount = totalAgtNetAmt;</span>
				}

<span class="nc" id="L3482">				orgIdAmountMap.put(agtOrgId, agtDebitAmount);</span>
<span class="nc" id="L3483">				orgIdParentIdMap.put(agtOrgId, boOrgId);</span>

<span class="nc bnc" id="L3485" title="All 2 branches missed.">				if (orgIdTransIdInvRetMap.containsKey(agtOrgId)) {</span>
<span class="nc" id="L3486">					transIdInvRetMap = orgIdTransIdInvRetMap.get(agtOrgId);</span>
				} else {
<span class="nc" id="L3488">					transIdInvRetMap = new HashMap&lt;String, List&lt;Long&gt;&gt;();</span>
<span class="nc" id="L3489">					orgIdTransIdInvRetMap.put(agtOrgId, transIdInvRetMap);</span>
				}

				// insert in main transaction table

<span class="nc" id="L3494">				pstmtBO.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L3495">				pstmtBO.executeUpdate();</span>
<span class="nc" id="L3496">				ResultSet rsTrns = pstmtBO.getGeneratedKeys();</span>
<span class="nc bnc" id="L3497" title="All 2 branches missed.">				if (rsTrns.next()) {</span>
<span class="nc" id="L3498">					long transId = rsTrns.getLong(1);</span>

<span class="nc bnc" id="L3500" title="All 2 branches missed.">					if (!transIdInvRetMap.containsKey(transDate)) {</span>
<span class="nc" id="L3501">						transIdInvRetMap.put(transDate,</span>
								new ArrayList&lt;Long&gt;());
					}

<span class="nc" id="L3505">					transIdInvRetMap.get(transDate).add(transId);</span>

<span class="nc" id="L3507">					insBoTranPstmt.setLong(1, transId);</span>
<span class="nc" id="L3508">					insBoTranPstmt.setInt(2, boUserId);</span>
<span class="nc" id="L3509">					insBoTranPstmt.setInt(3, boOrgId);</span>
<span class="nc" id="L3510">					insBoTranPstmt.setString(4, &quot;AGENT&quot;);</span>
<span class="nc" id="L3511">					insBoTranPstmt.setInt(5, agtOrgId);</span>
<span class="nc" id="L3512">					insBoTranPstmt.setTimestamp(6,</span>
							fetchTransTimeStamp(transDate));
<span class="nc" id="L3514">					insBoTranPstmt.setString(7, tranType);</span>
<span class="nc" id="L3515">					insBoTranPstmt.executeUpdate();</span>

<span class="nc" id="L3517">					insBoDepositRetpstmt.setLong(1, transId);</span>
<span class="nc" id="L3518">					insBoDepositRetpstmt.setInt(2, agtOrgId);</span>
<span class="nc" id="L3519">					insBoDepositRetpstmt.setDouble(3, depositAmt);</span>
<span class="nc" id="L3520">					insBoDepositRetpstmt.setDouble(4, totalAgtNetAmt);</span>
<span class="nc" id="L3521">					insBoDepositRetpstmt.setDouble(5, agentComm);</span>
<span class="nc" id="L3522">					insBoDepositRetpstmt.setInt(6, walletId);</span>
<span class="nc" id="L3523">					insBoDepositRetpstmt.executeUpdate();</span>

					// update retailer table

<span class="nc" id="L3527">					updAgtDepositRetPstmt.setLong(1, transId); // agent trans Id</span>
<span class="nc" id="L3528">					updAgtDepositRetPstmt.setInt(2, agtOrgId);</span>
<span class="nc" id="L3529">					updAgtDepositRetPstmt.setDouble(3, agentComm);</span>
<span class="nc" id="L3530">					updAgtDepositRetPstmt.setString(4, transDate);</span>
<span class="nc" id="L3531">					updAgtDepositRetPstmt.setString(5, tranType);</span>
<span class="nc" id="L3532">					updAgtDepositRetPstmt.setInt(6, walletId);</span>
<span class="nc" id="L3533">					 updAgtDepositRetPstmt.executeUpdate();</span>
					 
					// update agent direct player deposit refund table

<span class="nc" id="L3537">					 updAgtDirPlrDepositRefpstmt.setLong(1, transId); // agent trans Id</span>
<span class="nc" id="L3538">					 updAgtDirPlrDepositRefpstmt.setInt(2, agtOrgId);</span>
<span class="nc" id="L3539">					 updAgtDirPlrDepositRefpstmt.setDouble(3, agentComm);</span>
<span class="nc" id="L3540">					 updAgtDirPlrDepositRefpstmt.setString(4, transDate);</span>
<span class="nc" id="L3541">					 updAgtDirPlrDepositRefpstmt.setString(5, tranType);</span>
<span class="nc" id="L3542">					 updAgtDirPlrDepositRefpstmt.setInt(6, walletId);</span>
<span class="nc" id="L3543">					 updAgtDirPlrDepositRefpstmt.executeUpdate();</span>
					 
					 
				}
<span class="nc" id="L3547">			}</span>
<span class="nc" id="L3548">			generateDGReceiptForBONew(orgIdTransIdInvMap, orgIdParentIdMap,</span>
					&quot;OLA_INVOICE&quot;, &quot;OLA_RECEIPT&quot;, con);
<span class="nc" id="L3550">			generateDGReceiptForBONew(orgIdTransIdInvRetMap, orgIdParentIdMap,</span>
					&quot;CR_NOTE&quot;, &quot;CR_NOTE_CASH&quot;, con);
			// update agent balance
<span class="nc" id="L3553">			Set&lt;Integer&gt; agtOrgIdSet = orgIdAmountMap.keySet();</span>
<span class="nc bnc" id="L3554" title="All 2 branches missed.">			for (Integer orgId : agtOrgIdSet) {</span>
			
<span class="nc" id="L3556">				boolean isValid = OrgCreditUpdation.updateOrganizationBalWithValidate(</span>
						orgIdAmountMap.get(orgId), &quot;TRANSACTION&quot;, &quot;OLA_DEPOSIT&quot;,orgId,
						orgIdParentIdMap.get(orgId), &quot;AGENT&quot;,
								0, con);
<span class="nc bnc" id="L3560" title="All 2 branches missed.">				if (!isValid)</span>
<span class="nc" id="L3561">					throw new LMSException();</span>

<span class="nc" id="L3563">				OrgCreditUpdation.updateOrganizationBalWithValidate(</span>
						orgIdAmountMap.get(orgId), &quot;CLAIM_BAL&quot;, &quot;DEBIT&quot;, orgId,
						orgIdParentIdMap.get(orgId), &quot;AGENT&quot;, 0, con);

				/*
				 	OrgCreditUpdation.updateCreditLimitForAgent(orgId,
						&quot;OLA_DEPOSIT&quot;, orgIdAmountMap.get(orgId), con);
				updateOrgBalance(&quot;CLAIM_BAL&quot;, orgIdAmountMap.get(orgId), orgId,
						&quot;DEBIT&quot;, con);
				 */
				
				
				
				
				
				
<span class="nc" id="L3579">			}</span>
<span class="nc" id="L3580">		}catch (Exception e) {</span>
<span class="nc" id="L3581">			e.printStackTrace();</span>
<span class="nc" id="L3582">		}</span>
	
<span class="nc" id="L3584">	}</span>
	public void updateOlaWithdrawlLedgerForAgt(Connection con)
	{

<span class="nc" id="L3588">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L3589">		ResultSet rs = null;</span>
		double withdrawlAmt, totalAgtNetAmt;
		double agentComm,retailerComm, agtDebitAmount;
		String transDate;
		int agtOrgId, boUserId, boOrgId;
<span class="nc" id="L3594">		Map&lt;Integer, Double&gt; orgIdAmountMap = new HashMap&lt;Integer, Double&gt;();</span>
<span class="nc" id="L3595">		Map&lt;Integer, Integer&gt; orgIdParentIdMap = new HashMap&lt;Integer, Integer&gt;();</span>
<span class="nc" id="L3596">		Map&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt; orgIdTransIdInvMap = new HashMap&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt;();</span>
<span class="nc" id="L3597">		Map&lt;String, List&lt;Long&gt;&gt; transIdInvMap = null;</span>
<span class="nc" id="L3598">		Map&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt; orgIdTransIdInvRetMap = new HashMap&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt;();</span>
<span class="nc" id="L3599">		Map&lt;String, List&lt;Long&gt;&gt; transIdInvRetMap = null;</span>
		try {
<span class="nc" id="L3601">			String withdrawlQry = &quot;select agent_org_id,boUserId,boOrgId,withdrawlAmt,wallet_id,transaction_date,agent_comm from(select a.agent_org_id,sum(withdrawl_amt) withdrawlAmt,sum(bo_net_amt) bo_net_amt ,a.wallet_id,DATE(transaction_date) 'transaction_date',agent_comm from ((select agent_org_id ,withdrawl_amt,bo_net_amt ,wallet_id,transaction_id,agent_comm from st_ola_agt_withdrawl where claim_status='CLAIM_BAL') union all (select agent_org_id agent_org_id,withdrawl_amt,net_amt bo_net_amt,wallet_id,transaction_id,agt_claim_comm from st_ola_agt_direct_plr_withdrawl where withdrawl_claim_status='CLAIM_BAL')) a inner join  st_lms_agent_transaction_master b  on a.transaction_id = b.transaction_id   group by a.agent_org_id,DATE(transaction_date),a.wallet_id,agent_comm) withdrawl inner join (select um.user_id agtUserId,um.organization_id agtOrgId,um.parent_user_id boUserId,om.parent_id boOrgId,isrolehead from st_lms_organization_master om inner join st_lms_user_master um on om.organization_id=um.organization_id where om.organization_type='AGENT') om on agent_org_id=agtOrgId and isrolehead = 'Y'&quot;;</span>
<span class="nc" id="L3602">			String withdrawlRefundQry = &quot;select agent_org_id,boUserId,boOrgId,withdrawlRefAmt,wallet_id,transaction_date,agent_comm from(select a.agent_org_id,sum(withdrawl_amt) withdrawlRefAmt,sum(bo_net_amt) bo_net_amt ,a.wallet_id,DATE(transaction_date) 'transaction_date',agent_comm from ((select agent_org_id ,withdrawl_amt,bo_net_amt ,wallet_id,transaction_id,agent_comm from st_ola_agt_withdrawl_refund where status='CLAIM_BAL') union all (select agt_org_id agent_org_id,withdrawl_amt,agent_net_amt bo_net_amt,wallet_id,transaction_id,agent_comm from st_ola_agt_direct_plr_withdrawl_refund where claim_status='CLAIM_BAL')) a inner join  st_lms_agent_transaction_master b  on a.transaction_id = b.transaction_id   group by a.agent_org_id,DATE(transaction_date),a.wallet_id,agent_comm) withdrawl inner join (select um.user_id agtUserId,um.organization_id agtOrgId,um.parent_user_id boUserId,om.parent_id boOrgId,isrolehead from st_lms_organization_master om inner join st_lms_user_master um on om.organization_id=um.organization_id where om.organization_type='AGENT') om on agent_org_id=agtOrgId and isrolehead = 'Y'&quot;;</span>
<span class="nc" id="L3603">			PreparedStatement pstmtBO = con.prepareStatement(QueryManager.insertInLMSTransactionMaster());</span>
<span class="nc" id="L3604">			PreparedStatement insBoTranPstmt = con.prepareStatement(QueryManager.insertInBOTransactionMaster());</span>
<span class="nc" id="L3605">			PreparedStatement insBoWithdrawlPstmt = con.prepareStatement(&quot;insert into st_ola_bo_withdrawl (transaction_id, withdrawl_amt, net_amt, wallet_id, agent_org_id, agent_comm) values(?,?,?,?,?,?)&quot;);</span>
<span class="nc" id="L3606">			PreparedStatement updAgtWithdrawlpstmt = con.prepareStatement(&quot;update st_ola_agt_withdrawl a inner join st_lms_agent_transaction_master b on a.transaction_id = b.transaction_id set claim_status='DONE_CLAIM',bo_ref_transaction_id=? where a.agent_org_id=? and agent_comm=? and DATE(transaction_date)=? and wallet_id=?&quot;);</span>
<span class="nc" id="L3607">			PreparedStatement updAgtDirectPlrWithdrawlpstmt = con.prepareStatement(&quot;update st_ola_agt_direct_plr_withdrawl a inner join st_lms_agent_transaction_master b on a.transaction_id = b.transaction_id set withdrawl_claim_status='DONE_CLAIM',bo_ref_transaction_id=? where a.agent_org_id=? and agt_claim_comm=? and DATE(transaction_date)=? and wallet_id=?&quot;);</span>
<span class="nc" id="L3608">			PreparedStatement insBoWithdrawlRetpstmt = con.prepareStatement(&quot;insert into st_ola_bo_withdrawl_refund(transaction_id, agent_org_id, withdrawl_amt, net_amt, agent_comm, wallet_id)	values(?,?,?,?,?,?)&quot;);</span>
<span class="nc" id="L3609">			PreparedStatement updAgtwithdrawlRetPstmt = con.prepareStatement(&quot;update st_ola_agt_withdrawl_refund a inner join st_lms_agent_transaction_master b on a.transaction_id = b.transaction_id set status='DONE_CLAIM',bo_ref_transaction_id=? where a.agent_org_id=? and agent_comm=? and DATE(transaction_date)=? and transaction_type=? and wallet_id=?&quot;);</span>
<span class="nc" id="L3610">			PreparedStatement updAgtDirectPlrWithdrawlRefpstmt = con.prepareStatement(&quot;update st_ola_agt_direct_plr_withdrawl_refund a inner join st_lms_agent_transaction_master b on a.transaction_id = b.transaction_id set status='DONE_CLAIM',bo_ref_transaction_id=? where a.agt_org_id=? and agent_comm=? and DATE(transaction_date)=? and transaction_type=? and wallet_id=?&quot;);</span>

<span class="nc" id="L3612">			int walletId = 0;</span>
<span class="nc" id="L3613">			pstmt = con.prepareStatement(withdrawlQry);</span>
<span class="nc" id="L3614">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L3615" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L3616">				agtOrgId = rs.getInt(&quot;agent_org_id&quot;);</span>
<span class="nc" id="L3617">				boUserId = rs.getInt(&quot;boUserId&quot;);</span>
<span class="nc" id="L3618">				boOrgId = rs.getInt(&quot;boOrgId&quot;);</span>
<span class="nc" id="L3619">				walletId = rs.getInt(&quot;wallet_id&quot;);</span>
<span class="nc" id="L3620">				withdrawlAmt = rs.getDouble(&quot;withdrawlAmt&quot;);</span>
				//retailerComm = rs.getDouble(&quot;retailer_comm&quot;);
<span class="nc" id="L3622">				agentComm = rs.getDouble(&quot;agent_comm&quot;);</span>
<span class="nc" id="L3623">				transDate = rs.getString(&quot;transaction_date&quot;);</span>

				//totalAgtNetAmt = (withdrawlAmt + (withdrawlAmt*agentComm*.01));
				
<span class="nc" id="L3627">				totalAgtNetAmt =rs.getDouble(&quot;withdrawlAmt&quot;);</span>
<span class="nc bnc" id="L3628" title="All 2 branches missed.">				if (orgIdAmountMap.containsKey(agtOrgId)) {</span>
<span class="nc" id="L3629">					agtDebitAmount = orgIdAmountMap.get(agtOrgId)</span>
							+ totalAgtNetAmt;
				} else {
<span class="nc" id="L3632">					agtDebitAmount = totalAgtNetAmt;</span>
				}

<span class="nc" id="L3635">				orgIdAmountMap.put(agtOrgId, agtDebitAmount);</span>
<span class="nc" id="L3636">				orgIdParentIdMap.put(agtOrgId, boOrgId);</span>

<span class="nc bnc" id="L3638" title="All 2 branches missed.">				if (orgIdTransIdInvMap.containsKey(agtOrgId)) {</span>
<span class="nc" id="L3639">					transIdInvMap = orgIdTransIdInvMap.get(agtOrgId);</span>
				} else {
<span class="nc" id="L3641">					transIdInvMap = new HashMap&lt;String, List&lt;Long&gt;&gt;();</span>
<span class="nc" id="L3642">					orgIdTransIdInvMap.put(agtOrgId, transIdInvMap);</span>
				}

				// insert in main transaction table

<span class="nc" id="L3647">				pstmtBO.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L3648">				pstmtBO.executeUpdate();</span>
<span class="nc" id="L3649">				ResultSet rsTrns = pstmtBO.getGeneratedKeys();</span>
<span class="nc bnc" id="L3650" title="All 2 branches missed.">				if (rsTrns.next()) {</span>
<span class="nc" id="L3651">					long transId = rsTrns.getLong(1);</span>

<span class="nc bnc" id="L3653" title="All 2 branches missed.">					if (!transIdInvMap.containsKey(transDate)) {</span>
<span class="nc" id="L3654">						transIdInvMap.put(transDate, new ArrayList&lt;Long&gt;());</span>
					}

<span class="nc" id="L3657">					transIdInvMap.get(transDate).add(transId);</span>

<span class="nc" id="L3659">					insBoTranPstmt.setLong(1, transId);</span>
<span class="nc" id="L3660">					insBoTranPstmt.setInt(2, boUserId);</span>
<span class="nc" id="L3661">					insBoTranPstmt.setInt(3, boOrgId);</span>
<span class="nc" id="L3662">					insBoTranPstmt.setString(4, &quot;AGENT&quot;);</span>
<span class="nc" id="L3663">					insBoTranPstmt.setInt(5, agtOrgId);</span>
<span class="nc" id="L3664">					insBoTranPstmt.setTimestamp(6,</span>
							fetchTransTimeStamp(transDate));
<span class="nc" id="L3666">					insBoTranPstmt.setString(7, &quot;OLA_WITHDRAWL&quot;);</span>
<span class="nc" id="L3667">					insBoTranPstmt.executeUpdate();</span>

<span class="nc" id="L3669">					insBoWithdrawlPstmt.setLong(1, transId);</span>
<span class="nc" id="L3670">					insBoWithdrawlPstmt.setDouble(2, withdrawlAmt);</span>
<span class="nc" id="L3671">					insBoWithdrawlPstmt.setDouble(3, totalAgtNetAmt);</span>
<span class="nc" id="L3672">					insBoWithdrawlPstmt.setInt(4, walletId);</span>
<span class="nc" id="L3673">					insBoWithdrawlPstmt.setInt(5, agtOrgId);</span>
<span class="nc" id="L3674">					insBoWithdrawlPstmt.setDouble(6, agentComm);</span>
<span class="nc" id="L3675">					insBoWithdrawlPstmt.executeUpdate();</span>

					// update Agent table

<span class="nc" id="L3679">					updAgtWithdrawlpstmt.setLong(1, transId); // agent trans Id</span>
<span class="nc" id="L3680">					updAgtWithdrawlpstmt.setInt(2, agtOrgId);</span>
<span class="nc" id="L3681">					updAgtWithdrawlpstmt.setDouble(3, agentComm);</span>
<span class="nc" id="L3682">					updAgtWithdrawlpstmt.setString(4, transDate);</span>
<span class="nc" id="L3683">					updAgtWithdrawlpstmt.setInt(5, walletId);</span>
<span class="nc" id="L3684">					updAgtWithdrawlpstmt.executeUpdate();</span>
					
					// update Agent Direct Player Withdrawl Table
<span class="nc" id="L3687">					updAgtDirectPlrWithdrawlpstmt.setLong(1, transId); // agent trans Id</span>
<span class="nc" id="L3688">					updAgtDirectPlrWithdrawlpstmt.setInt(2, agtOrgId);</span>
<span class="nc" id="L3689">					updAgtDirectPlrWithdrawlpstmt.setDouble(3, agentComm);</span>
<span class="nc" id="L3690">					updAgtDirectPlrWithdrawlpstmt.setString(4, transDate);</span>
<span class="nc" id="L3691">					updAgtDirectPlrWithdrawlpstmt.setInt(5, walletId);</span>
<span class="nc" id="L3692">					updAgtDirectPlrWithdrawlpstmt.executeUpdate();</span>
					
					
					
					
				}
<span class="nc" id="L3698">			}</span>

<span class="nc" id="L3700">			pstmt = con.prepareStatement(withdrawlRefundQry);</span>
<span class="nc" id="L3701">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L3702" title="All 2 branches missed.">			while (rs.next()) {</span>

<span class="nc" id="L3704">				agtOrgId = rs.getInt(&quot;agent_org_id&quot;);</span>
<span class="nc" id="L3705">				boUserId = rs.getInt(&quot;boUserId&quot;);</span>
<span class="nc" id="L3706">				boOrgId = rs.getInt(&quot;boOrgId&quot;);</span>
<span class="nc" id="L3707">				walletId = rs.getInt(&quot;wallet_id&quot;);</span>
<span class="nc" id="L3708">				withdrawlAmt = rs.getDouble(&quot;withdrawlAmt&quot;);</span>
<span class="nc" id="L3709">				agentComm = rs.getDouble(&quot;agent_comm&quot;);</span>
				//	retailerComm = rs.getDouble(&quot;retailer_comm&quot;);
<span class="nc" id="L3711">				transDate = rs.getString(&quot;transaction_date&quot;);</span>
<span class="nc" id="L3712">				totalAgtNetAmt =  rs.getDouble(&quot;withdrawlRefAmt&quot;);// withdrawlAmt - (withdrawlAmt*agentComm*.01);</span>
<span class="nc" id="L3713">				String tranType = rs.getString(&quot;transaction_type&quot;);</span>

<span class="nc bnc" id="L3715" title="All 2 branches missed.">				if (orgIdAmountMap.containsKey(agtOrgId)) {</span>
<span class="nc" id="L3716">					agtDebitAmount = orgIdAmountMap.get(agtOrgId)</span>
							- totalAgtNetAmt;
				} else {
<span class="nc" id="L3719">					agtDebitAmount = totalAgtNetAmt;</span>
				}

<span class="nc" id="L3722">				orgIdAmountMap.put(agtOrgId, agtDebitAmount);</span>
<span class="nc" id="L3723">				orgIdParentIdMap.put(agtOrgId, boOrgId);</span>

<span class="nc bnc" id="L3725" title="All 2 branches missed.">				if (orgIdTransIdInvRetMap.containsKey(agtOrgId)) {</span>
<span class="nc" id="L3726">					transIdInvRetMap = orgIdTransIdInvRetMap.get(agtOrgId);</span>
				} else {
<span class="nc" id="L3728">					transIdInvRetMap = new HashMap&lt;String, List&lt;Long&gt;&gt;();</span>
<span class="nc" id="L3729">					orgIdTransIdInvRetMap.put(agtOrgId, transIdInvRetMap);</span>
				}

				// insert in main transaction table

<span class="nc" id="L3734">				pstmtBO.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L3735">				pstmtBO.executeUpdate();</span>
<span class="nc" id="L3736">				ResultSet rsTrns = pstmtBO.getGeneratedKeys();</span>
<span class="nc bnc" id="L3737" title="All 2 branches missed.">				if (rsTrns.next()) {</span>
<span class="nc" id="L3738">					long transId = rsTrns.getLong(1);</span>

<span class="nc bnc" id="L3740" title="All 2 branches missed.">					if (!transIdInvRetMap.containsKey(transDate)) {</span>
<span class="nc" id="L3741">						transIdInvRetMap.put(transDate,</span>
								new ArrayList&lt;Long&gt;());
					}

<span class="nc" id="L3745">					transIdInvRetMap.get(transDate).add(transId);</span>

<span class="nc" id="L3747">					insBoTranPstmt.setLong(1, transId);</span>
<span class="nc" id="L3748">					insBoTranPstmt.setInt(2, boUserId);</span>
<span class="nc" id="L3749">					insBoTranPstmt.setInt(3, boOrgId);</span>
<span class="nc" id="L3750">					insBoTranPstmt.setString(4, &quot;AGENT&quot;);</span>
<span class="nc" id="L3751">					insBoTranPstmt.setInt(5, agtOrgId);</span>
<span class="nc" id="L3752">					insBoTranPstmt.setTimestamp(6,</span>
							fetchTransTimeStamp(transDate));
<span class="nc" id="L3754">					insBoTranPstmt.setString(7, tranType);</span>
<span class="nc" id="L3755">					insBoTranPstmt.executeUpdate();</span>

<span class="nc" id="L3757">					insBoWithdrawlRetpstmt.setLong(1, transId);</span>
<span class="nc" id="L3758">					insBoWithdrawlRetpstmt.setInt(2, agtOrgId);</span>
<span class="nc" id="L3759">					insBoWithdrawlRetpstmt.setDouble(3, withdrawlAmt);</span>
<span class="nc" id="L3760">					insBoWithdrawlRetpstmt.setDouble(4, totalAgtNetAmt);</span>
<span class="nc" id="L3761">					insBoWithdrawlRetpstmt.setDouble(5, agentComm);</span>
<span class="nc" id="L3762">					insBoWithdrawlRetpstmt.setInt(6, walletId);</span>
<span class="nc" id="L3763">					insBoWithdrawlRetpstmt.executeUpdate();</span>

					// update agent table

<span class="nc" id="L3767">					updAgtwithdrawlRetPstmt.setLong(1, transId); // agent trans Id</span>
<span class="nc" id="L3768">					updAgtwithdrawlRetPstmt.setInt(2, agtOrgId);</span>
<span class="nc" id="L3769">					updAgtwithdrawlRetPstmt.setDouble(3, agentComm);</span>
					//updAgtwithdrawlRetPstmt.setDouble(4, retailerComm);
<span class="nc" id="L3771">					updAgtwithdrawlRetPstmt.setString(4, transDate);</span>
<span class="nc" id="L3772">					updAgtwithdrawlRetPstmt.setString(5, tranType);</span>
<span class="nc" id="L3773">					updAgtwithdrawlRetPstmt.setInt(6, walletId);</span>
<span class="nc" id="L3774">					updAgtwithdrawlRetPstmt.executeUpdate();</span>
					// update agent direct player withdrawl refund table
<span class="nc" id="L3776">					updAgtDirectPlrWithdrawlRefpstmt.setLong(1, transId); // agent trans Id</span>
<span class="nc" id="L3777">					updAgtDirectPlrWithdrawlRefpstmt.setInt(2, agtOrgId);</span>
<span class="nc" id="L3778">					updAgtDirectPlrWithdrawlRefpstmt.setDouble(3, agentComm);</span>
					//updAgtwithdrawlRetPstmt.setDouble(4, retailerComm);
<span class="nc" id="L3780">					updAgtDirectPlrWithdrawlRefpstmt.setString(4, transDate);</span>
<span class="nc" id="L3781">					updAgtDirectPlrWithdrawlRefpstmt.setString(5, tranType);</span>
<span class="nc" id="L3782">					updAgtDirectPlrWithdrawlRefpstmt.setInt(6, walletId);</span>
<span class="nc" id="L3783">					updAgtDirectPlrWithdrawlRefpstmt.executeUpdate();</span>
					
					
					
				}
<span class="nc" id="L3788">			}</span>
			// update agent balance
<span class="nc" id="L3790">			Set&lt;Integer&gt; agtOrgIdSet = orgIdAmountMap.keySet();</span>
<span class="nc bnc" id="L3791" title="All 2 branches missed.">			for (Integer orgId : agtOrgIdSet) {</span>
			

				
<span class="nc" id="L3795">				boolean isValid = OrgCreditUpdation.updateOrganizationBalWithValidate(</span>
						orgIdAmountMap.get(orgId), &quot;TRANSACTION&quot;, &quot;OLA_WITHDRAWL&quot;,orgId,
						orgIdParentIdMap.get(orgId), &quot;AGENT&quot;,
								0, con);
<span class="nc bnc" id="L3799" title="All 2 branches missed.">				if (!isValid)</span>
<span class="nc" id="L3800">					throw new LMSException();</span>

<span class="nc" id="L3802">				OrgCreditUpdation.updateOrganizationBalWithValidate(</span>
						orgIdAmountMap.get(orgId), &quot;CLAIM_BAL&quot;, &quot;CREDIT&quot;, orgId,
						orgIdParentIdMap.get(orgId), &quot;AGENT&quot;, 0, con);

				/*
				 		OrgCreditUpdation.updateCreditLimitForAgent(orgId,
						&quot;OLA_WITHDRAWL&quot;, orgIdAmountMap.get(orgId), con);
				updateOrgBalance(&quot;CLAIM_BAL&quot;, orgIdAmountMap.get(orgId), orgId,
						&quot;CREDIT&quot;, con);
				
				 */
						
				
<span class="nc" id="L3815">				generateReceiptOlaBo(con, orgId, &quot;AGENT&quot;, orgIdTransIdInvMap</span>
						.get(orgId));
				
				
				
				
<span class="nc" id="L3821">			}</span>
<span class="nc" id="L3822">		}catch (Exception e) {</span>
<span class="nc" id="L3823">			e.printStackTrace();</span>
<span class="nc" id="L3824">		}</span>
		
	
<span class="nc" id="L3827">	}</span>
	
	
	
	
	public void updateOLACommissionLedgerForRet(Connection con) throws LMSException {
<span class="nc" id="L3833">		logger.debug(new Date() + &quot;---start-dg pwt update for retailer--&quot;</span>
				+ new Date().getTime());
<span class="nc" id="L3835">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L3836">		ResultSet rs = null;</span>

		try {
<span class="nc" id="L3839">			String walletQry = &quot;select wallet_id,tds_comm_rate from st_ola_wallet_master where wallet_status='ACTIVE'&quot;;</span>
<span class="nc" id="L3840">			String CommQry = &quot;select wallet_id,retailer_user_id,sum(retailer_net_claim_comm)retailer_net_claim_comm,sum(retailer_claim_comm) retailer_claim_comm,tds_comm_rate,sum(agt_claim_comm)agt_claim_comm,transaction_date,transaction_id,agtUserId,agtOrgId,retOrgId from( select wallet_id,rc.retailer_user_id,retailer_net_claim_comm,retailer_claim_comm,tds_comm_rate,agt_claim_comm,transaction_date,rc.transaction_id from st_ola_ret_comm rc,st_lms_retailer_transaction_master rtm &quot; </span>
				            +&quot;where rc.transaction_id=rtm.transaction_id and rc.status='CLAIM_BAL') commTlb inner join (select um.user_id retUserId,um.organization_id retOrgId,um.parent_user_id agtUserId,om.parent_id agtOrgId from st_lms_organization_master om inner join st_lms_user_master um on om.organization_id=um.organization_id where om.organization_type='RETAILER') oum on commTlb.retailer_user_id=oum.retUserId group by retOrgId,wallet_id,date(transaction_date)&quot;;

<span class="nc" id="L3843">			String retOlaCommUpdateQuery = &quot;update st_ola_ret_comm rc,st_lms_retailer_transaction_master rtm set rc.status='DONE_CLM' where rc.transaction_id=rtm.transaction_id and rc.wallet_id=? and rc.retailer_org_id=?&quot;;</span>
			//String retOlaCommUpdateQuery = &quot;update st_ola_ret_comm set status='DONE_CLM' where transaction_id=? and retailer_org_id=?&quot;;
<span class="nc" id="L3845">			PreparedStatement retOlaCommUpdatePstmt = con</span>
					.prepareStatement(retOlaCommUpdateQuery);

			
<span class="nc" id="L3849">			PreparedStatement walletStmt = con.prepareStatement(walletQry);</span>

<span class="nc" id="L3851">			PreparedStatement transMasQueryPstmt = con</span>
					.prepareStatement(&quot;INSERT INTO st_lms_transaction_master (user_type, service_code, interface) VALUES (?, ?,?)&quot;);
<span class="nc" id="L3853">			PreparedStatement agtTransMasterPstmt = con</span>
					.prepareStatement(&quot;INSERT INTO st_lms_agent_transaction_master (transaction_id,user_id,user_org_id,party_type,party_id,transaction_type,transaction_date) VALUES (?,?,?,?,?,?,?)&quot;);
			
<span class="nc" id="L3856">			String agtOlaCommEntry = &quot;insert into st_ola_agt_comm(transaction_id,wallet_id,agent_user_id,agent_org_id,retailer_org_id,agt_claim_comm,tds_comm_rate,agt_net_claim_comm,ret_mrp_comm,ret_claim_comm,status)&quot; +</span>
					&quot; values (?, ?, ?, ?, ?, ?, ?, ?, ?, ?,?)&quot;;
<span class="nc" id="L3858">			PreparedStatement agtPstmt = con.prepareStatement(agtOlaCommEntry);</span>

<span class="nc" id="L3860">			ResultSet walletRs = walletStmt.executeQuery();</span>
<span class="nc" id="L3861">			pstmt = con.prepareStatement(CommQry);</span>

<span class="nc" id="L3863">			int retOrgId = 0, agtOrgId, agtUserId, walletId, drawId;</span>
<span class="nc" id="L3864">			double  netAgtComm,agtComm, totalRetComm,totalRetMrpComm,tdsCommRate, totalNetAmt = 0;</span>
			String  transDate;
<span class="nc" id="L3866">			Map&lt;Integer, Double&gt; orgAmtMap = new HashMap&lt;Integer, Double&gt;();</span>
<span class="nc" id="L3867">			Map&lt;Integer, Integer&gt; orgIdParentIdMap = new HashMap&lt;Integer, Integer&gt;();</span>
<span class="nc" id="L3868">			Map&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt; orgIdTransIdInvMap = new HashMap&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt;();</span>
<span class="nc" id="L3869">			Map&lt;String, List&lt;Long&gt;&gt; transIdInvMap = null;</span>
<span class="nc bnc" id="L3870" title="All 2 branches missed.">			while (walletRs.next()) {</span>
<span class="nc" id="L3871">				walletId = walletRs.getInt(&quot;wallet_id&quot;);</span>
<span class="nc" id="L3872">				totalNetAmt = 0;</span>
				
<span class="nc" id="L3874">				rs = pstmt.executeQuery();</span>
<span class="nc" id="L3875">				logger.debug(&quot;--Start PWT tran for Wallet Id&quot; + walletId);</span>
<span class="nc bnc" id="L3876" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L3877">					int id=rs.getInt(&quot;transaction_id&quot;);</span>
<span class="nc" id="L3878">					retOrgId = rs.getInt(&quot;retOrgId&quot;);</span>
<span class="nc" id="L3879">					agtOrgId = rs.getInt(&quot;agtOrgId&quot;);</span>
<span class="nc" id="L3880">					agtUserId = rs.getInt(&quot;agtUserId&quot;);</span>
<span class="nc" id="L3881">					walletId = rs.getInt(&quot;wallet_id&quot;);</span>
	
<span class="nc" id="L3883">					agtComm = rs.getDouble(&quot;agt_claim_comm&quot;);</span>
<span class="nc" id="L3884">					tdsCommRate=rs.getDouble(&quot;tds_comm_rate&quot;);</span>
<span class="nc" id="L3885">					netAgtComm=agtComm-(agtComm*tdsCommRate*.01);</span>
<span class="nc" id="L3886">					totalRetComm = rs.getDouble(&quot;retailer_net_claim_comm&quot;);</span>
<span class="nc" id="L3887">					totalRetMrpComm=rs.getDouble(&quot;retailer_claim_comm&quot;);</span>
<span class="nc" id="L3888">					transDate = rs.getString(&quot;transaction_date&quot;);</span>
					
					
<span class="nc" id="L3891">					orgIdParentIdMap.put(retOrgId, agtOrgId);</span>
<span class="nc bnc" id="L3892" title="All 2 branches missed.">					if (orgIdTransIdInvMap.containsKey(retOrgId)) {</span>
<span class="nc" id="L3893">						transIdInvMap = orgIdTransIdInvMap.get(retOrgId);</span>
					} else {
<span class="nc" id="L3895">						transIdInvMap = new HashMap&lt;String, List&lt;Long&gt;&gt;();</span>
<span class="nc" id="L3896">						orgIdTransIdInvMap.put(retOrgId, transIdInvMap);</span>
					}
					// insert data into main transaction master

<span class="nc" id="L3900">					transMasQueryPstmt.setString(1, &quot;AGENT&quot;);</span>
<span class="nc" id="L3901">					transMasQueryPstmt.setString(2, &quot;OLA&quot;);</span>
<span class="nc" id="L3902">					transMasQueryPstmt.setString(3, &quot;WEB&quot;);</span>
<span class="nc" id="L3903">					transMasQueryPstmt.executeUpdate();</span>
<span class="nc" id="L3904">					ResultSet tranRs = transMasQueryPstmt.getGeneratedKeys();</span>

<span class="nc bnc" id="L3906" title="All 2 branches missed.">					if (tranRs.next()) {</span>
<span class="nc" id="L3907">						long transId = tranRs.getLong(1);</span>

<span class="nc bnc" id="L3909" title="All 2 branches missed.">						if (!transIdInvMap.containsKey(transDate)) {</span>
<span class="nc" id="L3910">							transIdInvMap.put(transDate,</span>
									new ArrayList&lt;Long&gt;());
						}
<span class="nc" id="L3913">						transIdInvMap.get(transDate).add(transId);</span>

<span class="nc" id="L3915">						agtTransMasterPstmt.setLong(1, transId);</span>
<span class="nc" id="L3916">						agtTransMasterPstmt.setInt(2, agtUserId);</span>
<span class="nc" id="L3917">						agtTransMasterPstmt.setInt(3, agtOrgId);</span>
<span class="nc" id="L3918">						agtTransMasterPstmt.setString(4, &quot;RETAILER&quot;);</span>
<span class="nc" id="L3919">						agtTransMasterPstmt.setInt(5, retOrgId);</span>
<span class="nc" id="L3920">						agtTransMasterPstmt.setString(6, &quot;OLA_COMMISSION&quot;);</span>
<span class="nc" id="L3921">						agtTransMasterPstmt.setTimestamp(7,</span>
								fetchTransTimeStamp(transDate));
<span class="nc" id="L3923">						agtTransMasterPstmt.executeUpdate();</span>

						
<span class="nc" id="L3926">						retOlaCommUpdatePstmt.setInt(1, walletId);</span>
<span class="nc" id="L3927">						retOlaCommUpdatePstmt.setInt(2, retOrgId);</span>
<span class="nc" id="L3928">						System.out.println(&quot;update st_ola_ret_comm:&quot;+retOlaCommUpdatePstmt);</span>
<span class="nc" id="L3929">						retOlaCommUpdatePstmt.executeUpdate();</span>
						
							
<span class="nc" id="L3932">						agtPstmt.setLong(1, transId);</span>
<span class="nc" id="L3933">						agtPstmt.setInt(2, walletId);</span>
<span class="nc" id="L3934">						agtPstmt.setInt(3, agtUserId);</span>
<span class="nc" id="L3935">						agtPstmt.setInt(4, agtOrgId);</span>
<span class="nc" id="L3936">						agtPstmt.setInt(5, retOrgId);</span>
<span class="nc" id="L3937">						agtPstmt.setDouble(6, agtComm);</span>
<span class="nc" id="L3938">						agtPstmt.setDouble(7, tdsCommRate);</span>
<span class="nc" id="L3939">						agtPstmt.setDouble(8, netAgtComm);</span>
<span class="nc" id="L3940">						agtPstmt.setDouble(9, totalRetMrpComm);</span>
<span class="nc" id="L3941">						agtPstmt.setDouble(10, totalRetComm);</span>
<span class="nc" id="L3942">						agtPstmt.setString(11, &quot;CLAIM_BAL&quot;);</span>
<span class="nc" id="L3943">						agtPstmt.executeUpdate();</span>

					}
<span class="nc" id="L3946">					double retCrAmt = totalRetComm;</span>
<span class="nc bnc" id="L3947" title="All 2 branches missed.">					if (orgAmtMap.containsKey(retOrgId)) {</span>
<span class="nc" id="L3948">						retCrAmt = retCrAmt + orgAmtMap.get(retOrgId);</span>
					}
<span class="nc" id="L3950">					orgAmtMap.put(retOrgId, retCrAmt);</span>
<span class="nc" id="L3951">				}</span>

			}

<span class="nc" id="L3955">			Set&lt;Integer&gt; allRetId = orgAmtMap.keySet();</span>
<span class="nc" id="L3956">			logger.debug(&quot;retailer pwt update org amt map&quot; + orgAmtMap);</span>
<span class="nc bnc" id="L3957" title="All 2 branches missed.">			for (Integer orgId : allRetId) {</span>
<span class="nc bnc" id="L3958" title="All 2 branches missed.">				if (orgId != 0) {</span>
<span class="nc" id="L3959">					OrgCreditUpdation.updateCreditLimitForRetailer(orgId,</span>
							&quot;OLA_COMMISSION&quot;, orgAmtMap.get(orgId), con);
<span class="nc" id="L3961">					updateOrgBalance(&quot;CLAIM_BAL&quot;, orgAmtMap.get(orgId), orgId,</span>
							&quot;CREDIT&quot;, con);
<span class="nc" id="L3963">					generateReciptForPwtNew(orgIdTransIdInvMap.get(orgId), con,</span>
							orgIdParentIdMap.get(orgId), orgId, &quot;RETAILER&quot;,
							&quot;OLA&quot;);
				}
<span class="nc" id="L3967">			}</span>

<span class="nc" id="L3969">		} catch (Exception e) {</span>
<span class="nc" id="L3970">			e.printStackTrace();</span>
<span class="nc" id="L3971">			throw new LMSException(&quot;error in pwt retailer&quot;);</span>
<span class="nc" id="L3972">		}</span>
<span class="nc" id="L3973">		logger.debug(new Date() + &quot;---start-dg pwt update for retailer--&quot;</span>
				+ new Date().getTime());
<span class="nc" id="L3975">	}</span>
	
	public void updateOLACommissionLedgerForAgt(Connection con) throws LMSException {
<span class="nc" id="L3978">		logger.debug(new Date() + &quot;---start-dg pwt update for agent--&quot;</span>
				+ new Date().getTime());
<span class="nc" id="L3980">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L3981">		ResultSet rs = null;</span>

		try {
<span class="nc" id="L3984">			String CommQry = &quot;select wallet_id,agent_org_id,sum(agt_claim_comm) total_agt_comm,tds_comm_rate,sum(ret_claim_comm)ret_claim_comm,transaction_date,transaction_id,agtUserId,boUserId,boOrgId from( select wallet_id,ac.agent_org_id,agt_claim_comm,agt_net_claim_comm,tds_comm_rate,ret_claim_comm,transaction_date,ac.transaction_id from st_ola_agt_comm ac,st_lms_agent_transaction_master rtm where ac.transaction_id=rtm.transaction_id and ac.status='CLAIM_BAL') commTlb inner join &quot; </span>
				            +&quot;(select um.user_id agtUserId,um.organization_id agtOrgId,um.parent_user_id boUserId,om.parent_id boOrgId from st_lms_organization_master om inner join st_lms_user_master um on om.organization_id=um.organization_id where om.organization_type='AGENT' and isrolehead='Y') oum on commTlb.agent_org_id=oum.agtOrgId group by agtOrgId,wallet_id,date(transaction_date)&quot;;

			
<span class="nc" id="L3988">			String agtOlaCommUpdateQuery = &quot;update st_ola_agt_comm rc,st_lms_agent_transaction_master rtm set rc.status='DONE_CLM' where rc.transaction_id=rtm.transaction_id and rc.wallet_id=? and rc.agent_org_id=?&quot;;</span>

			//String agtOlaCommUpdateQuery = &quot;update st_ola_agt_comm set status='DONE_CLM' where transaction_id=? and agent_org_id=?&quot;;
<span class="nc" id="L3991">			PreparedStatement agtOlaCommUpdatePstmt = con</span>
					.prepareStatement(agtOlaCommUpdateQuery);

			
			// insert in st_agt_direct_player table in case of
			// player


<span class="nc" id="L3999">			PreparedStatement transMasQueryPstmt = con</span>
			.prepareStatement(&quot;INSERT INTO st_lms_transaction_master (user_type, service_code, interface) VALUES (?, ?,?)&quot;);
<span class="nc" id="L4001">	           PreparedStatement boTransMasterPstmt = con</span>
			.prepareStatement(&quot;INSERT INTO st_lms_bo_transaction_master (transaction_id,user_id,user_org_id,party_type,party_id,transaction_type,transaction_date) VALUES (?,?,?,?,?,?,?)&quot;);
	
<span class="nc" id="L4004">	           String boOlaCommEntry = &quot;insert into st_ola_bo_comm(transaction_id,wallet_id,bo_user_id,bo_org_id,agent_org_id,agt_claim_comm,tds_comm_rate,agt_net_claim_comm)&quot; +</span>
				&quot; values (?, ?, ?, ?, ?, ?, ?, ?)&quot;;
<span class="nc" id="L4006">		PreparedStatement boPstmt = con.prepareStatement(boOlaCommEntry);</span>
		
		
			int agtOrgId, boOrgId, boUserId, walletId, drawId;
			double netAgtComm, totalAgtComm, totalNetAmt,tdsCommRate;
			String pwtType, transDate;
<span class="nc" id="L4012">			Map&lt;Integer, Double&gt; orgAmtMap = new HashMap&lt;Integer, Double&gt;();</span>
<span class="nc" id="L4013">			Map&lt;Integer, Integer&gt; orgIdParentIdMap = new HashMap&lt;Integer, Integer&gt;();</span>
<span class="nc" id="L4014">			Map&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt; orgIdTransIdInvMap = new HashMap&lt;Integer, Map&lt;String, List&lt;Long&gt;&gt;&gt;();</span>
<span class="nc" id="L4015">			Map&lt;String, List&lt;Long&gt;&gt; transIdInvMap= null;</span>

<span class="nc" id="L4017">			pstmt = con.prepareStatement(CommQry);</span>
<span class="nc" id="L4018">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L4019" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L4020">				int id=rs.getInt(&quot;transaction_id&quot;);</span>
<span class="nc" id="L4021">				agtOrgId = rs.getInt(&quot;agent_org_id&quot;);</span>
<span class="nc" id="L4022">				boOrgId = rs.getInt(&quot;boOrgId&quot;);</span>
<span class="nc" id="L4023">				boUserId = rs.getInt(&quot;boUserId&quot;);</span>
<span class="nc" id="L4024">				walletId = rs.getInt(&quot;wallet_id&quot;);</span>
<span class="nc" id="L4025">				logger.debug(&quot;--Agent PWT tran for game No&quot; + walletId);</span>
				
<span class="nc" id="L4027">				totalAgtComm = rs.getDouble(&quot;total_agt_comm&quot;);</span>
<span class="nc" id="L4028">				tdsCommRate=rs.getDouble(&quot;tds_comm_rate&quot;);</span>
<span class="nc" id="L4029">				netAgtComm=totalAgtComm-(totalAgtComm*tdsCommRate*.01);</span>
<span class="nc" id="L4030">				transDate = rs.getString(&quot;transaction_date&quot;);</span>
				

<span class="nc" id="L4033">				orgIdParentIdMap.put(agtOrgId, boOrgId);</span>
<span class="nc bnc" id="L4034" title="All 2 branches missed.">				if (orgIdTransIdInvMap.containsKey(agtOrgId)) {</span>
<span class="nc" id="L4035">					transIdInvMap = orgIdTransIdInvMap.get(agtOrgId);</span>
				} else {
<span class="nc" id="L4037">					transIdInvMap = new HashMap&lt;String, List&lt;Long&gt;&gt;();</span>
<span class="nc" id="L4038">					orgIdTransIdInvMap.put(agtOrgId, transIdInvMap);</span>
				}
				// insert data into main transaction master

<span class="nc" id="L4042">				transMasQueryPstmt.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L4043">				transMasQueryPstmt.setString(2, &quot;OLA&quot;);</span>
<span class="nc" id="L4044">				transMasQueryPstmt.setString(3, &quot;WEB&quot;);</span>
				
<span class="nc" id="L4046">				transMasQueryPstmt.executeUpdate();</span>
<span class="nc" id="L4047">				ResultSet tranRs = transMasQueryPstmt.getGeneratedKeys();</span>

<span class="nc bnc" id="L4049" title="All 2 branches missed.">				if (tranRs.next()) {</span>
<span class="nc" id="L4050">					long transId = tranRs.getLong(1);</span>

<span class="nc bnc" id="L4052" title="All 2 branches missed.">					if (!transIdInvMap.containsKey(transDate)) {</span>
<span class="nc" id="L4053">						transIdInvMap.put(transDate, new ArrayList&lt;Long&gt;());</span>
					}
<span class="nc" id="L4055">					transIdInvMap.get(transDate).add(transId);</span>

<span class="nc" id="L4057">					boTransMasterPstmt.setLong(1, transId);</span>
<span class="nc" id="L4058">					boTransMasterPstmt.setInt(2, boUserId);</span>
<span class="nc" id="L4059">					boTransMasterPstmt.setInt(3, boOrgId);</span>
<span class="nc" id="L4060">					boTransMasterPstmt.setString(4, &quot;AGENT&quot;);</span>
<span class="nc" id="L4061">					boTransMasterPstmt.setInt(5, agtOrgId);</span>
<span class="nc" id="L4062">					boTransMasterPstmt.setString(6, &quot;OLA_COMMISSION&quot;);</span>
<span class="nc" id="L4063">					boTransMasterPstmt.setTimestamp(7,</span>
							fetchTransTimeStamp(transDate));
					
<span class="nc" id="L4066">					boTransMasterPstmt.executeUpdate();</span>

					
					
					

<span class="nc" id="L4072">					boPstmt.setLong(1, transId);</span>
<span class="nc" id="L4073">					boPstmt.setInt(2, walletId);</span>
<span class="nc" id="L4074">					boPstmt.setInt(3, boUserId);</span>
<span class="nc" id="L4075">					boPstmt.setInt(4, boOrgId);</span>
<span class="nc" id="L4076">					boPstmt.setInt(5, agtOrgId);</span>
<span class="nc" id="L4077">					boPstmt.setDouble(6, totalAgtComm);</span>
<span class="nc" id="L4078">					boPstmt.setDouble(7, tdsCommRate);</span>
<span class="nc" id="L4079">					boPstmt.setDouble(8, netAgtComm);</span>
										
<span class="nc" id="L4081">					boPstmt.executeUpdate();</span>

<span class="nc" id="L4083">					agtOlaCommUpdatePstmt.setInt(1, walletId);</span>
<span class="nc" id="L4084">					agtOlaCommUpdatePstmt.setInt(2, agtOrgId);</span>
						
						
<span class="nc" id="L4087">					agtOlaCommUpdatePstmt.executeUpdate();</span>
				}
<span class="nc" id="L4089">				double agtCrAmt = netAgtComm;</span>
<span class="nc bnc" id="L4090" title="All 2 branches missed.">				if (orgAmtMap.containsKey(agtOrgId)) {</span>
<span class="nc" id="L4091">					agtCrAmt = agtCrAmt + orgAmtMap.get(agtOrgId);</span>
				}
<span class="nc" id="L4093">				orgAmtMap.put(agtOrgId, agtCrAmt);</span>
<span class="nc" id="L4094">			}</span>

<span class="nc" id="L4096">			Set&lt;Integer&gt; allAgtId = orgAmtMap.keySet();</span>
<span class="nc" id="L4097">			logger.debug(&quot;agent pwt update org amt map&quot; + orgAmtMap);</span>
<span class="nc bnc" id="L4098" title="All 2 branches missed.">			for (Integer orgId : allAgtId) {</span>
<span class="nc bnc" id="L4099" title="All 2 branches missed.">				if (orgId != 0) {</span>
<span class="nc" id="L4100">					OrgCreditUpdation.updateCreditLimitForAgent(orgId,</span>
							&quot;OLA_COMMISSION&quot;, orgAmtMap.get(orgId), con);
<span class="nc" id="L4102">					updateOrgBalance(&quot;CLAIM_BAL&quot;, orgAmtMap.get(orgId), orgId,</span>
							&quot;CREDIT&quot;, con);
<span class="nc" id="L4104">					generateReceiptOlaBo(con, orgId, &quot;AGENT&quot;, orgIdTransIdInvMap</span>
							.get(orgId));
				}
<span class="nc" id="L4107">			}</span>

<span class="nc" id="L4109">		} catch (Exception e) {</span>
<span class="nc" id="L4110">			e.printStackTrace();</span>
<span class="nc" id="L4111">			throw new LMSException(&quot;error in pwt agent&quot;);</span>
<span class="nc" id="L4112">		}</span>
<span class="nc" id="L4113">		logger.debug(new Date() + &quot;---start-dg pwt update for agent--&quot;</span>
				+ new Date().getTime());
<span class="nc" id="L4115">	}</span>
	
	
	
	/*public void updateOlaPlayerCommissionLedgerForAgt(Connection con)
	{
		PreparedStatement pstmt = null;
		ResultSet rs = null;
		double netGamingAmt, commissionCalculated,totalAgentComm;
		double agentComm, agtDebitAmount;
		String startDate,endDate;
		int agtOrgId, boUserId, boOrgId;
		Map&lt;Integer, Double&gt; orgIdAmountMap = new HashMap&lt;Integer, Double&gt;();
		try {
			String playerCommQry = &quot;select agt_org_id,boUserId,boOrgId,netGamingAmt,wallet_id,start_date,end_date,commissionCalculated,agentCommission,agt_comm_rate from(select a.agt_org_id,sum(plr_net_gaming) netGamingAmt ,a.wallet_id,start_date,end_date, sum(commission_calculated) commissionCalculated, sum(agent_commission) agentCommission,agt_comm_rate from  st_ola_agt_ret_commisiion  a inner join  st_lms_agent_transaction_master b  on a.transaction_id = b.transaction_id  where claim_status='CLAIM_BAL' group by a.agt_org_id,a.wallet_id,agt_comm_rate  order by agt_org_id,wallet_id) netGaming inner join (select um.user_id agtUserId,um.organization_id agtOrgId,um.parent_user_id boUserId,om.parent_id boOrgId,isrolehead from st_lms_organization_master om inner join st_lms_user_master um on om.organization_id=um.organization_id where om.organization_type='AGENT') om on agt_org_id=agtOrgId and isrolehead = 'Y'&quot;;
			PreparedStatement pstmtBO = con.prepareStatement(QueryManager
					.insertInLMSTransactionMaster());
			PreparedStatement insBoTranPstmt = con
					.prepareStatement(QueryManager
							.insertInBOTransactionMaster());
			PreparedStatement insBoAgentCommissionPstmt = con
					.prepareStatement(&quot;insert into st_ola_bo_agt_commisiion (agt_org_id, net_gaming, commission_calculated, comm_rate, transaction_id, start_date, end_date)values(?,?,?,?,?,?,?)&quot;);
			PreparedStatement updAgtRetCommissionpstmt = con
					.prepareStatement(&quot;update st_ola_agt_ret_commisiion a inner join st_lms_agent_transaction_master b on a.transaction_id = b.transaction_id set claim_status='DONE_CLAIM',bo_ref_transaction_id=? where a.agt_org_id=? and agt_comm_rate  =?  and wallet_id=?&quot;);
			int walletId = 0;
			pstmt = con.prepareStatement(playerCommQry);
			rs = pstmt.executeQuery();
			while (rs.next()) {
				agtOrgId = rs.getInt(&quot;agt_org_id&quot;);
					boUserId = rs.getInt(&quot;boUserId&quot;);
				boOrgId = rs.getInt(&quot;boOrgId&quot;);
				walletId = rs.getInt(&quot;wallet_id&quot;);
				netGamingAmt = rs.getDouble(&quot;netGamingAmt&quot;);
				commissionCalculated = rs.getDouble(&quot;commissionCalculated&quot;);
				totalAgentComm = rs.getDouble(&quot;agentCommission&quot;);
				agentComm = rs.getDouble(&quot;agt_comm_rate&quot;);
				System.out.println(&quot;agent commisiion&quot;+agentComm);
				startDate = rs.getString(&quot;start_date&quot;);
				endDate = rs.getString(&quot;end_date&quot;);
				if (orgIdAmountMap.containsKey(agtOrgId)) {
					agtDebitAmount = orgIdAmountMap.get(agtOrgId)
							+ totalAgentComm;
				} else {
					agtDebitAmount = totalAgentComm;
				}

				orgIdAmountMap.put(agtOrgId, agtDebitAmount);
				// insert in main transaction table

				pstmtBO.setString(1, &quot;BO&quot;);
				pstmtBO.executeUpdate();
				ResultSet rsTrns = pstmtBO.getGeneratedKeys();
				if (rsTrns.next()) {
					int transId = rsTrns.getInt(1);

					//if (!transIdInvMap.containsKey(transDate)) {
						//transIdInvMap.put(transDate, new ArrayList&lt;Integer&gt;());
					//}

				//	transIdInvMap.get(transDate).add(transId);

					insBoTranPstmt.setInt(1, transId);
					insBoTranPstmt.setInt(2, boUserId);
					insBoTranPstmt.setInt(3, boOrgId);
					insBoTranPstmt.setString(4, &quot;AGENT&quot;);
					insBoTranPstmt.setInt(5, agtOrgId);
					insBoTranPstmt.setTimestamp(6,
							fetchTransTimeStamp(startDate));
					insBoTranPstmt.setString(7, &quot;OLA_COMMISSION&quot;);
					insBoTranPstmt.executeUpdate();

					insBoAgentCommissionPstmt.setInt(1, agtOrgId);
					insBoAgentCommissionPstmt.setDouble(2, netGamingAmt);
					insBoAgentCommissionPstmt.setDouble(3, commissionCalculated);
					System.out.println(&quot;agent+sdjksd&quot;+agentComm);
					insBoAgentCommissionPstmt.setDouble(4, agentComm);
					insBoAgentCommissionPstmt.setInt(5, transId);
					insBoAgentCommissionPstmt.setString(6, startDate);
					insBoAgentCommissionPstmt.setString(7, endDate);
					insBoAgentCommissionPstmt.executeUpdate();

					// update retailer table

					updAgtRetCommissionpstmt.setInt(1, transId); // agent trans Id
					updAgtRetCommissionpstmt.setInt(2, agtOrgId);
					updAgtRetCommissionpstmt.setDouble(3, agentComm);
					updAgtRetCommissionpstmt.setInt(4, walletId);
					updAgtRetCommissionpstmt.executeUpdate();
				}
			}
			
				// update agent balance
			Set&lt;Integer&gt; agtOrgIdSet = orgIdAmountMap.keySet();
			for (Integer orgId : agtOrgIdSet) {
				OrgCreditUpdation.updateCreditLimitForAgent(orgId,
						&quot;OLA_COMMISSION&quot;, orgIdAmountMap.get(orgId), con);
				updateOrgBalance(&quot;CLAIM_BAL&quot;, orgIdAmountMap.get(orgId), orgId,
						&quot;DEBIT&quot;, con);
			}
		} catch (Exception e) {
			e.printStackTrace();
		}
	
	
	}*/
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>