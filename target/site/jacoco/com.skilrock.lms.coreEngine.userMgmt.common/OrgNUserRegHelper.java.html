<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OrgNUserRegHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lms</a> &gt; <a href="index.source.html" class="el_package">com.skilrock.lms.coreEngine.userMgmt.common</a> &gt; <span class="el_source">OrgNUserRegHelper.java</span></div><h1>OrgNUserRegHelper.java</h1><pre class="source lang-java linenums">package com.skilrock.lms.coreEngine.userMgmt.common;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.sql.Time;
import java.sql.Timestamp;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;
import java.util.Set;
import java.util.TreeMap;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import com.skilrock.lms.api.lms.beans.LmsUserIdMappingRequestBean;
import com.skilrock.lms.api.lms.beans.LmsUserIdMappingResponseBean;
import com.skilrock.lms.beans.AgentRegistrationBean;
import com.skilrock.lms.beans.RetailerRegistrationBean;
import com.skilrock.lms.beans.ServicesBean;
import com.skilrock.lms.beans.UserIdMappingBean;
import com.skilrock.lms.beans.UserInfoBean;
import com.skilrock.lms.common.LSControllerImpl;
import com.skilrock.lms.common.MyTextProvider;
import com.skilrock.lms.common.Utility;
import com.skilrock.lms.common.db.DBConnect;
import com.skilrock.lms.common.db.QueryManager;
import com.skilrock.lms.common.db.TableConstants;
import com.skilrock.lms.common.exception.LMSException;
import com.skilrock.lms.common.filter.LMSFilterDispatcher;
import com.skilrock.lms.common.utility.CommonMethods;
import com.skilrock.lms.common.utility.LMSUtility;
import com.skilrock.lms.common.utility.MD5Encoder;
import com.skilrock.lms.common.utility.MailSend;
import com.skilrock.lms.common.utility.ResponsibleGaming;
import com.skilrock.lms.controller.userMgmtController.UserMgmtController;
import com.skilrock.lms.coreEngine.drawGames.playMgmt.DrawGameOfflineHelper;
import com.skilrock.lms.coreEngine.drawGames.playMgmt.ServerStartUpData;
import com.skilrock.lms.coreEngine.ola.common.OLAUtility;
import com.skilrock.lms.coreEngine.userMgmt.daoImpl.MessageInboxDaoImpl;
import com.skilrock.lms.coreEngine.virtualSport.beans.VSRequestBean;
import com.skilrock.lms.lmswrapperAPI.client.LMSServicesClient;
import com.skilrock.lms.lmswrapperAPI.client.LMSServicesPortType;
import com.skilrock.lms.sportsLottery.common.NotifySLE;
import com.skilrock.lms.sportsLottery.common.SLE;
import com.skilrock.lms.sportsLottery.userMgmt.javaBeans.UserDataBean;
import com.skilrock.lms.web.bankMgmt.Helpers.BankHelper;
import com.skilrock.lms.web.drawGames.common.Util;
import com.skilrock.lms.web.loginMgmt.AutoGenerate;
import com.skilrock.lms.web.userMgmt.common.RetailerOrgUserRegAction;
import com.skilrock.lms.wrapper.common.NotifyWrapper;
import com.skilrock.lms.wrapper.common.Wraper;
import com.skilrock.lms.wrapper.javaBeans.UserRegistrationRequestBean;
import com.skilrock.lms.wrapper.javaBeans.UserRegistrationResponseBean;
import com.sun.tools.xjc.reader.xmlschema.bindinfo.BIConversion.Static;

<span class="nc" id="L62">public class OrgNUserRegHelper extends MyTextProvider {</span>

	/*private static final String projectName = ServletActionContext
			.getServletContext().getContextPath();*/
/*	private Connection con = null;
	private PreparedStatement pstmt = null;
	private ResultSet rs = null;
	private Statement stmt = null;*/
<span class="nc" id="L70">	private static MyTextProvider textProvider = new MyTextProvider();</span>
<span class="nc" id="L71">	static Log logger = LogFactory.getLog(OrgNUserRegHelper.class);</span>
	private static boolean assignEmailPriviledges(int userId, String orgType,
			String email, String[] emailPrivId, Connection con)
			throws SQLException {

		// insert details into st_report_email_user_master
<span class="nc" id="L77">		String insertEmailQuery = &quot;insert into st_lms_report_email_user_master (&quot;</span>
				+ &quot; ref_user_id, organization_id, organization_type, first_name, last_name, email_id, mob_no,	registration_date, status)&quot;
				+ &quot; select  aa.user_id 'ref_user_id', organization_id, organization_type, first_name, last_name,	email_id, phone_nbr, CURRENT_TIMESTAMP, 'ACTIVE'&quot;
				+ &quot; from st_lms_user_master aa, st_lms_user_contact_details bb&quot;
				+ &quot; where aa.user_id=bb.user_id and aa.user_id=&quot; + userId;
<span class="nc" id="L82">		logger.info(&quot;insertEmailQuery == &quot; + insertEmailQuery);</span>
		//logger.info(&quot;insertEmailQuery == &quot; + insertEmailQuery);
<span class="nc" id="L84">		PreparedStatement pstmt = con.prepareStatement(insertEmailQuery);</span>
<span class="nc" id="L85">		int updateRow = pstmt.executeUpdate();</span>
<span class="nc" id="L86">		ResultSet rs  = pstmt.getGeneratedKeys();</span>

<span class="nc bnc" id="L88" title="All 2 branches missed.">		if (rs.next()) {</span>
<span class="nc" id="L89">			int newUserId = rs.getInt(1);</span>
<span class="nc" id="L90">			logger.info(&quot;insertion into st_lms_report_email_user_master table is done &amp; user_id is == &quot;</span>
					+ newUserId);
			
<span class="nc" id="L93">			pstmt = con</span>
					.prepareStatement(&quot;insert into st_lms_report_email_priv_master (user_id, email_pid, status) &quot;
							+ &quot;select &quot;
							+ newUserId
							+ &quot;, email_pid, 'INACTIVE' from st_lms_report_email_priviledge_rep where &quot;
							+ &quot;priv_owner='&quot; + orgType + &quot;' &quot;);
<span class="nc" id="L99">			updateRow = pstmt.executeUpdate();</span>
<span class="nc" id="L100">			logger.info(&quot;total row inserted as inactive == &quot; + updateRow);</span>
		/*	System.out
					.println(&quot;total row inserted as inactive == &quot; + updateRow);*/

<span class="nc bnc" id="L104" title="All 4 branches missed.">			if (emailPrivId != null &amp;&amp; emailPrivId.length &gt; 0) {</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">				for (String emailPid : emailPrivId) {</span>
<span class="nc" id="L106">					pstmt = con</span>
							.prepareStatement(&quot; update st_lms_report_email_priv_master set status = 'ACTIVE' where user_id = ? and email_pid = ?&quot;);
<span class="nc" id="L108">					pstmt.setInt(1, newUserId);</span>
<span class="nc" id="L109">					pstmt.setInt(2, Integer.parseInt(emailPid.trim()));</span>
<span class="nc" id="L110">					updateRow = pstmt.executeUpdate();	</span>
<span class="nc" id="L111">					logger.info(&quot;total row active == &quot; + updateRow);</span>
					///logger.info(&quot;total row active == &quot; + updateRow);
				}
			}
<span class="nc" id="L115">			return true;</span>
		} else {
<span class="nc" id="L117">			throw new SQLException(</span>
					&quot;Key is not generated for email_user_master table.&quot;);
		}

	}

public void assignDirectInventoryToRetailer(UserInfoBean userBean,RetailerRegistrationBean retailerRegistrationBean, UserInfoBean boUserBean) {
<span class="nc" id="L124">		Connection con = null ;</span>
<span class="nc" id="L125">		PreparedStatement  pstmt =null;</span>
<span class="nc" id="L126">		ResultSet rs =null;</span>
		try {
<span class="nc" id="L128">			con =DBConnect.getConnection();</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">			if (retailerRegistrationBean.getTerminalId() != null) {</span>
<span class="nc" id="L130">				String query = &quot;select user_id, organization_id from st_lms_ret_offline_master where serial_number = ?&quot;;</span>
<span class="nc" id="L131">				pstmt = con.prepareStatement(query);</span>
<span class="nc" id="L132">				pstmt.setString(1,retailerRegistrationBean.getTerminalId());</span>
<span class="nc" id="L133">				rs = pstmt.executeQuery();</span>

<span class="nc" id="L135">				int retUserOrgId = 0;</span>

<span class="nc bnc" id="L137" title="All 2 branches missed.">				if (rs.next()) {</span>
<span class="nc" id="L138">					retUserOrgId = rs.getInt(&quot;organization_id&quot;);</span>
				}else{
					
					return ;
				}
				// Assign Terminal 
<span class="nc" id="L144">				updateInvForRetailerFromBO(con,retailerRegistrationBean.getModelName(), userBean,retailerRegistrationBean.getTerminalId(), retUserOrgId, boUserBean);</span>
				// Assign Sim
				
<span class="nc bnc" id="L147" title="All 2 branches missed.">				if(retailerRegistrationBean.getSimModelName()!=null){</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">					for(int i=0;i&lt;retailerRegistrationBean.getSimModelName().length;i++){</span>
<span class="nc bnc" id="L149" title="All 4 branches missed.">						if(retailerRegistrationBean.getSimModelName()[i]!=null &amp;&amp; retailerRegistrationBean.getSim()[i]!=null){</span>
<span class="nc" id="L150">							updateInvForRetailer(con,retailerRegistrationBean.getSimModelName()[i], userBean,retailerRegistrationBean.getSim()[i], retUserOrgId);</span>
						}
					}
				}
			}

<span class="nc" id="L156">		} catch (SQLException ex) {</span>
<span class="nc" id="L157">			ex.printStackTrace();</span>
			try {
<span class="nc" id="L159">				con.rollback();</span>
<span class="nc" id="L160">			} catch (SQLException e) {</span>
<span class="nc" id="L161">				e.printStackTrace();</span>
<span class="nc" id="L162">			}</span>
		} finally {
<span class="nc" id="L164">			try {</span>
<span class="nc" id="L165">				con.close();</span>
<span class="nc" id="L166">			} catch (SQLException e) {</span>
<span class="nc" id="L167">				e.printStackTrace();</span>
<span class="nc" id="L168">			}</span>
<span class="nc" id="L169">		}</span>
<span class="nc" id="L170">	}</span>

	public void assignInventoryToRetailer(UserInfoBean userBean,RetailerRegistrationBean retailerRegistrationBean) {
		

<span class="nc" id="L175">		Connection con = null ;//DBConnect.getConnection();</span>
<span class="nc" id="L176">		PreparedStatement  pstmt =null;</span>
<span class="nc" id="L177">		ResultSet rs =null;</span>
		try {
<span class="nc" id="L179">			con =DBConnect.getConnection();</span>
		/*	String query = &quot;select inv_model_id, cost_to_bo from st_lms_inv_detail where current_owner_type = ? and current_owner_id = ? and serial_no = ?&quot;;
			PreparedStatement ps = con.prepareStatement(query);
			ps.setString(1, userBean.getUserType());
			ps.setInt(2, userBean.getUserOrgId());
			ps.setString(3, serialNo);
			ResultSet rs = ps.executeQuery();*/



		/*	if (rs.getFetchSize() &gt; 1) {
				logger.info(&quot;one terminal id is assigned to more than one user.&quot;);
				logger.info(&quot;one terminal id is assigned to more than one user.&quot;);
				return;
			}*/
			
                                                                                     
			// -----------

		
			
<span class="nc bnc" id="L200" title="All 2 branches missed.">			if (retailerRegistrationBean.getTerminalId() != null) {</span>
<span class="nc" id="L201">				String query = &quot;select user_id, organization_id from st_lms_ret_offline_master where serial_number = ?&quot;;</span>
<span class="nc" id="L202">				pstmt = con.prepareStatement(query);</span>
<span class="nc" id="L203">				pstmt.setString(1,retailerRegistrationBean.getTerminalId());</span>
<span class="nc" id="L204">				rs = pstmt.executeQuery();</span>

				//	int retUserId = 0;
<span class="nc" id="L207">				int retUserOrgId = 0;</span>

<span class="nc bnc" id="L209" title="All 2 branches missed.">				if (rs.next()) {</span>
					//retUserId = rs.getInt(&quot;user_id&quot;);
<span class="nc" id="L211">					retUserOrgId = rs.getInt(&quot;organization_id&quot;);</span>
				}else{
					
					return ;
				}
				// Assign Terminal 
<span class="nc" id="L217">				updateInvForRetailer(con,retailerRegistrationBean.getModelName(), userBean,retailerRegistrationBean.getTerminalId(), retUserOrgId);</span>
				// Assign Sim
				
<span class="nc bnc" id="L220" title="All 2 branches missed.">				if(retailerRegistrationBean.getSimModelName()!=null){</span>
					
<span class="nc bnc" id="L222" title="All 2 branches missed.">					for(int i=0;i&lt;retailerRegistrationBean.getSimModelName().length;i++){</span>
					
<span class="nc bnc" id="L224" title="All 4 branches missed.">						if(retailerRegistrationBean.getSimModelName()[i]!=null &amp;&amp; retailerRegistrationBean.getSim()[i]!=null){</span>
						
<span class="nc" id="L226">							updateInvForRetailer(con,retailerRegistrationBean.getSimModelName()[i], userBean,retailerRegistrationBean.getSim()[i], retUserOrgId);</span>
						
						}
					
					
					}
					
				
				}
				
			
				// terminalId = serialNo.substring(serialNo.length() - 8,
				// serialNo.length());
			}
			
			
			
			// ----------
			

<span class="nc" id="L246">		} catch (SQLException ex) {</span>
<span class="nc" id="L247">			ex.printStackTrace();</span>
			try {
<span class="nc" id="L249">				con.rollback();</span>
<span class="nc" id="L250">			} catch (SQLException e) {</span>
<span class="nc" id="L251">				e.printStackTrace();</span>
<span class="nc" id="L252">			}</span>
		} finally {
<span class="nc" id="L254">			try {</span>
<span class="nc" id="L255">				con.close();</span>
<span class="nc" id="L256">			} catch (SQLException e) {</span>
<span class="nc" id="L257">				e.printStackTrace();</span>
<span class="nc" id="L258">			}</span>
<span class="nc" id="L259">		}</span>
<span class="nc" id="L260">	}</span>
public void updateInvForRetailer(Connection con,String modelName,UserInfoBean userBean,String serialNo,int retUserOrgId){
<span class="nc" id="L262">	PreparedStatement  pstmt =null;</span>
<span class="nc" id="L263">	ResultSet rs =null;</span>
<span class="nc" id="L264">	int invModelId = 0;</span>
<span class="nc" id="L265">	double costToBo = 0.0;</span>
	try{
<span class="nc" id="L267">		String query = &quot;select  model_id,cost_to_bo  from  st_lms_inv_model_master inner join st_lms_inv_status  on inv_model_id=model_id  where model_name=? and serial_no=? and current_owner_id= ?&quot;;</span>
<span class="nc" id="L268">		pstmt =con.prepareStatement(query);</span>
<span class="nc" id="L269">		pstmt.setString(1,modelName);</span>
<span class="nc" id="L270">		pstmt.setString(2, serialNo);</span>
<span class="nc" id="L271">		pstmt.setInt(3,userBean.getUserOrgId());</span>
<span class="nc" id="L272">		rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">		if (rs.next()) {</span>
<span class="nc" id="L274">			invModelId = rs.getInt(&quot;model_id&quot;);</span>
<span class="nc" id="L275">			costToBo = rs.getDouble(&quot;cost_to_bo&quot;);</span>
		}
<span class="nc" id="L277">		DBConnect.closeConnection(pstmt, rs);</span>
<span class="nc" id="L278">		con.setAutoCommit(false);</span>
<span class="nc" id="L279">		query = &quot;insert into st_lms_inv_detail (user_id, user_org_type, user_org_id, inv_model_id, serial_no, date, cost_to_bo, is_new, current_owner_type, current_owner_id) values(?,?,?,?,?,?,?,?,?,?)&quot;;</span>
<span class="nc" id="L280">		pstmt = con.prepareStatement(query);</span>

<span class="nc" id="L282">		pstmt.setInt(1, userBean.getUserId());</span>
<span class="nc" id="L283">		pstmt.setString(2, userBean.getUserType());</span>
<span class="nc" id="L284">		pstmt.setInt(3, userBean.getUserOrgId());</span>
<span class="nc" id="L285">		pstmt.setInt(4, invModelId);</span>
<span class="nc" id="L286">		pstmt.setString(5, serialNo);</span>
<span class="nc" id="L287">		pstmt.setTimestamp(6, new java.sql.Timestamp(new Date().getTime()));</span>
<span class="nc" id="L288">		pstmt.setDouble(7, costToBo);</span>
<span class="nc" id="L289">		pstmt.setString(8, &quot;Y&quot;);</span>
<span class="nc" id="L290">		pstmt.setString(9, &quot;RETAILER&quot;);</span>
<span class="nc" id="L291">		pstmt.setInt(10, retUserOrgId);</span>
<span class="nc" id="L292">		logger.info(&quot;inv assign: insert in inv Details&quot;+pstmt);</span>
<span class="nc" id="L293">		pstmt.executeUpdate();</span>
<span class="nc" id="L294">		DBConnect.closePstmt(pstmt);</span>
		// -------------

<span class="nc" id="L297">		query = &quot;update st_lms_inv_status set user_id = ?, user_org_type = ?, user_org_id = ?, current_owner_type = ?, current_owner_id = ? where inv_model_id = ? and serial_no = ?&quot;;</span>
<span class="nc" id="L298">		pstmt = con.prepareStatement(query);</span>

<span class="nc" id="L300">		pstmt.setInt(1, userBean.getUserId());</span>
<span class="nc" id="L301">		pstmt.setString(2, userBean.getUserType());</span>
<span class="nc" id="L302">		pstmt.setInt(3, userBean.getUserOrgId());</span>
<span class="nc" id="L303">		pstmt.setString(4, &quot;RETAILER&quot;);</span>
<span class="nc" id="L304">		pstmt.setInt(5, retUserOrgId);</span>
<span class="nc" id="L305">		pstmt.setInt(6, invModelId);</span>
<span class="nc" id="L306">		pstmt.setString(7, serialNo);</span>
<span class="nc" id="L307">		logger.info(&quot;inv assign: update   inv status&quot;+pstmt);</span>
<span class="nc" id="L308">		pstmt.executeUpdate();</span>
<span class="nc" id="L309">		DBConnect.closePstmt(pstmt);</span>
		
<span class="nc" id="L311">		con.commit();</span>
<span class="nc" id="L312">	}catch (Exception e) {</span>
<span class="nc" id="L313">		logger.error(&quot; Exception &quot;,e);</span>
<span class="nc" id="L314">	}</span>
	
<span class="nc" id="L316">}</span>

	public void updateInvForRetailerFromBO(Connection con,String modelName,UserInfoBean userBean,String serialNo,int retUserOrgId, UserInfoBean boInfoBean){
<span class="nc" id="L319">		PreparedStatement  pstmt =null;</span>
<span class="nc" id="L320">		ResultSet rs =null;</span>
<span class="nc" id="L321">		int invModelId = 0;</span>
<span class="nc" id="L322">		double costToBo = 0.0;</span>
		try{
<span class="nc" id="L324">			String countryDep =((String)LMSUtility.sc.getAttribute(&quot;COUNTRY_DEPLOYED&quot;)).trim();</span>
			
<span class="nc" id="L326">			String query = &quot;select  model_id,cost_to_bo  from  st_lms_inv_model_master inner join st_lms_inv_status  on inv_model_id=model_id  where model_name=? and serial_no=? and current_owner_id= ?&quot;;</span>
<span class="nc" id="L327">			pstmt =con.prepareStatement(query);</span>
<span class="nc" id="L328">			pstmt.setString(1,modelName);</span>
<span class="nc" id="L329">			pstmt.setString(2, serialNo);</span>
<span class="nc bnc" id="L330" title="All 2 branches missed.">			if (&quot;BENIN&quot;.equalsIgnoreCase(countryDep)) {</span>
<span class="nc" id="L331">				pstmt.setInt(3,boInfoBean.getUserOrgId());</span>
			} else {
<span class="nc" id="L333">				pstmt.setInt(3,userBean.getUserId());</span>
			}
<span class="nc" id="L335">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L337">				invModelId = rs.getInt(&quot;model_id&quot;);</span>
<span class="nc" id="L338">				costToBo = rs.getDouble(&quot;cost_to_bo&quot;);</span>
			}
<span class="nc" id="L340">			DBConnect.closeConnection(pstmt, rs);</span>
<span class="nc" id="L341">			con.setAutoCommit(false);</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">			if (&quot;BENIN&quot;.equalsIgnoreCase(countryDep)) {</span>
				//First assign from BO to Agent			
<span class="nc" id="L344">				query = &quot;insert into st_lms_inv_detail (user_id, user_org_type, user_org_id, inv_model_id, serial_no, date, cost_to_bo, is_new, current_owner_type, current_owner_id) values(?,?,?,?,?,?,?,?,?,?)&quot;;</span>
<span class="nc" id="L345">				pstmt = con.prepareStatement(query);</span>
		
<span class="nc" id="L347">				pstmt.setInt(1, boInfoBean.getUserId());</span>
<span class="nc" id="L348">				pstmt.setString(2, boInfoBean.getUserType());</span>
<span class="nc" id="L349">				pstmt.setInt(3, boInfoBean.getUserOrgId());</span>
<span class="nc" id="L350">				pstmt.setInt(4, invModelId);</span>
<span class="nc" id="L351">				pstmt.setString(5, serialNo);</span>
<span class="nc" id="L352">				pstmt.setTimestamp(6, new java.sql.Timestamp(new Date().getTime()));</span>
<span class="nc" id="L353">				pstmt.setDouble(7, costToBo);</span>
<span class="nc" id="L354">				pstmt.setString(8, &quot;Y&quot;);</span>
<span class="nc" id="L355">				pstmt.setString(9, &quot;AGENT&quot;);</span>
<span class="nc" id="L356">				pstmt.setInt(10, userBean.getUserOrgId());</span>
<span class="nc" id="L357">				logger.info(&quot;inv assign: insert in inv Details&quot;+pstmt);</span>
<span class="nc" id="L358">				pstmt.executeUpdate();</span>
<span class="nc" id="L359">				DBConnect.closePstmt(pstmt);</span>
			}
			
			//First assign from Agent to Retailer			
<span class="nc" id="L363">			query = &quot;insert into st_lms_inv_detail (user_id, user_org_type, user_org_id, inv_model_id, serial_no, date, cost_to_bo, is_new, current_owner_type, current_owner_id) values(?,?,?,?,?,?,?,?,?,?)&quot;;</span>
<span class="nc" id="L364">			pstmt = con.prepareStatement(query);</span>
	
<span class="nc" id="L366">			pstmt.setInt(1, userBean.getUserId());</span>
<span class="nc" id="L367">			pstmt.setString(2, userBean.getUserType());</span>
<span class="nc" id="L368">			pstmt.setInt(3, userBean.getUserOrgId());</span>
<span class="nc" id="L369">			pstmt.setInt(4, invModelId);</span>
<span class="nc" id="L370">			pstmt.setString(5, serialNo);</span>
<span class="nc" id="L371">			pstmt.setTimestamp(6, new java.sql.Timestamp(new Date().getTime()));</span>
<span class="nc" id="L372">			pstmt.setDouble(7, costToBo);</span>
<span class="nc" id="L373">			pstmt.setString(8, &quot;Y&quot;);</span>
<span class="nc" id="L374">			pstmt.setString(9, &quot;RETAILER&quot;);</span>
<span class="nc" id="L375">			pstmt.setInt(10, retUserOrgId);</span>
<span class="nc" id="L376">			logger.info(&quot;inv assign: insert in inv Details&quot;+pstmt);</span>
<span class="nc" id="L377">			pstmt.executeUpdate();</span>
<span class="nc" id="L378">			DBConnect.closePstmt(pstmt);</span>
			// -------------
	
<span class="nc" id="L381">			query = &quot;update st_lms_inv_status set user_id = ?, user_org_type = ?, user_org_id = ?, current_owner_type = ?, current_owner_id = ? where inv_model_id = ? and serial_no = ?&quot;;</span>
<span class="nc" id="L382">			pstmt = con.prepareStatement(query);</span>
	
<span class="nc" id="L384">			pstmt.setInt(1, userBean.getUserId());</span>
<span class="nc" id="L385">			pstmt.setString(2, userBean.getUserType());</span>
<span class="nc" id="L386">			pstmt.setInt(3, userBean.getUserOrgId());</span>
<span class="nc" id="L387">			pstmt.setString(4, &quot;RETAILER&quot;);</span>
<span class="nc" id="L388">			pstmt.setInt(5, retUserOrgId);</span>
<span class="nc" id="L389">			pstmt.setInt(6, invModelId);</span>
<span class="nc" id="L390">			pstmt.setString(7, serialNo);</span>
<span class="nc" id="L391">			logger.info(&quot;inv assign: update   inv status&quot;+pstmt);</span>
<span class="nc" id="L392">			pstmt.executeUpdate();</span>
<span class="nc" id="L393">			DBConnect.closePstmt(pstmt);</span>
			
<span class="nc" id="L395">			con.commit();</span>
<span class="nc" id="L396">		}catch (Exception e) {</span>
<span class="nc" id="L397">			logger.error(&quot; Exception &quot;,e);</span>
<span class="nc" id="L398">		}</span>
		
<span class="nc" id="L400">	}</span>

	public static Map&lt;String, String&gt; checkUniqueIdNo(String idNbr, String idType,
			Connection conn) throws LMSException {
<span class="nc" id="L404">		Connection con = conn;</span>
<span class="nc" id="L405">		Map&lt;String, String&gt; errorMap = new TreeMap&lt;String, String&gt;();</span>
		try {
<span class="nc" id="L407">			Statement stmt = con.createStatement();</span>
<span class="nc" id="L408">			String organizationName = &quot;select * from st_lms_user_contact_details where id_nbr ='&quot;</span>
					+ idNbr + &quot;' and id_type='&quot; + idType + &quot;'&quot;;
<span class="nc" id="L410">			logger.info(&quot;Check Unique Id Number::&quot;+organizationName);</span>
         ///    logger.info(&quot;Check Unique Id Number::&quot;+organizationName);
<span class="nc" id="L412">			ResultSet res = stmt.executeQuery(organizationName);</span>
<span class="nc bnc" id="L413" title="All 2 branches missed.">			if (res.next()) {	</span>
<span class="nc" id="L414">				logger.info(&quot;id Number is Already exits !!&quot;);</span>
				
			//	logger.info(&quot;id Number is Already exits !!&quot;);
<span class="nc" id="L417">				errorMap.put(&quot;idError&quot;, textProvider.getText(&quot;msg.id.nbr.already.exists&quot;));</span>
<span class="nc" id="L418">				errorMap.put(&quot;returnTypeError&quot;, &quot;input&quot;);</span>
			} else {
<span class="nc" id="L420">				errorMap.put(&quot;idError&quot;, &quot;A&quot;);</span>
			}

<span class="nc" id="L423">			return errorMap;</span>
<span class="nc" id="L424">		} catch (SQLException se) {</span>
<span class="nc" id="L425">			se.printStackTrace();</span>
<span class="nc" id="L426">			throw new LMSException(se);</span>
		}
	}

	public UserInfoBean createAgtBean(int agtOrgId) {
<span class="nc" id="L431">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L432">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L433">		ResultSet rs = null;</span>
<span class="nc" id="L434">		String selectQuery = null;</span>
<span class="nc" id="L435">		UserInfoBean agtInfoBean = new UserInfoBean();</span>
		try {
<span class="nc" id="L437">			selectQuery = &quot;select um.user_id,um.user_name,om.organization_type,om.pwt_scrap from st_lms_organization_master om,st_lms_user_master um where um.organization_id=? and om.organization_id=um.organization_id&quot;;</span>
<span class="nc" id="L438">			pstmt = con.prepareStatement(selectQuery);</span>
<span class="nc" id="L439">			pstmt.setInt(1, agtOrgId);</span>
<span class="nc" id="L440">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L441" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L442">				agtInfoBean.setUserId(rs.getInt(&quot;user_id&quot;));</span>
<span class="nc" id="L443">				agtInfoBean.setUserType(rs.getString(&quot;organization_type&quot;));</span>
<span class="nc" id="L444">				agtInfoBean.setPwtSacrap(rs.getString(&quot;pwt_scrap&quot;));</span>
<span class="nc" id="L445">				agtInfoBean.setUserOrgId(agtOrgId);</span>
<span class="nc" id="L446">				agtInfoBean.setUserName(rs.getString(&quot;user_name&quot;));</span>
			}

<span class="nc" id="L449">		} catch (Exception e) {</span>
<span class="nc" id="L450">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L452">			try {</span>
<span class="nc bnc" id="L453" title="All 6 branches missed.">				if(con!=null){</span>
<span class="nc" id="L454">					con.close();</span>
				}
<span class="nc bnc" id="L456" title="All 6 branches missed.">				if(pstmt!=null){</span>
<span class="nc" id="L457">					pstmt.close();</span>
				}
<span class="nc bnc" id="L459" title="All 6 branches missed.">				if(rs!=null){</span>
<span class="nc" id="L460">					rs.close();</span>
					
				}
				
<span class="nc" id="L464">			} catch (SQLException e) {</span>
			
<span class="nc" id="L466">				e.printStackTrace();</span>
<span class="nc" id="L467">			}</span>
<span class="nc" id="L468">		}</span>

<span class="nc" id="L470">		return agtInfoBean;</span>
	}

	public static synchronized Map&lt;String, String&gt; createNewAgentOrgNUser(
			UserInfoBean userInfoBean, AgentRegistrationBean orgUserData,String loginType)
			throws LMSException {
<span class="nc" id="L476">			Connection con = null;</span>
<span class="nc" id="L477">			PreparedStatement pstmt = null;</span>
<span class="nc" id="L478">			ResultSet rs = null;</span>
<span class="nc" id="L479">			PreparedStatement stmt = null;</span>
		try {
			//String agtDepositLimit = (String)context.getAttribute(&quot;agtDepositLimit&quot;);
<span class="nc" id="L482">			String agtDepositLimit =(String) LMSUtility.sc.getAttribute(&quot;agtDepositLimit&quot;);</span>
			//String agtWithdrawalLimit = (String)context.getAttribute(&quot;agtWithdrawalLimit&quot;);
<span class="nc" id="L484">			String agtWithdrawalLimit = (String) LMSUtility.sc.getAttribute(&quot;agtWithdrawalLimit&quot;);</span>
<span class="nc" id="L485">			String countryDep =((String)LMSUtility.sc.getAttribute(&quot;COUNTRY_DEPLOYED&quot;)).trim();</span>
<span class="nc bnc" id="L486" title="All 6 branches missed.">			boolean isIFU = &quot;IFU Code&quot;.equalsIgnoreCase(orgUserData.getIdType()) &amp;&amp; orgUserData.getIdNo() != null &amp;&amp; !&quot;&quot;.equalsIgnoreCase(orgUserData.getIdNo());</span>
<span class="nc" id="L487">			con = DBConnect.getConnection();</span>

			// check is organization and user name is already exists
<span class="nc" id="L490">			Map&lt;String, String&gt; errorMap = verifyOrgName(orgUserData</span>
					.getOrgName(), orgUserData.getUserName(), con);
<span class="nc" id="L492">			Map&lt;String, String&gt; idErrorMap = null;</span>
<span class="nc bnc" id="L493" title="All 4 branches missed.">			if (orgUserData.getIdNo() != null &amp;&amp; !&quot;&quot;.equals(orgUserData.getIdNo())) {</span>
<span class="nc" id="L494">				idErrorMap = checkUniqueIdNo(orgUserData</span>
					.getIdNo(), orgUserData.getIdType(), con);
			}
			
<span class="nc bnc" id="L498" title="All 6 branches missed.">			if (errorMap.containsKey(&quot;returnTypeError&quot;)</span>
					|| (idErrorMap != null &amp;&amp; idErrorMap.containsKey(&quot;returnTypeError&quot;))) {
<span class="nc bnc" id="L500" title="All 2 branches missed.">				if (&quot;A&quot;.equalsIgnoreCase(errorMap.get(&quot;orgError&quot;))) {</span>
<span class="nc" id="L501">					errorMap.put(&quot;orgError&quot;, &quot;&quot;);</span>
				}
<span class="nc bnc" id="L503" title="All 2 branches missed.">				if (&quot;A&quot;.equalsIgnoreCase(errorMap.get(&quot;userError&quot;))) {</span>
<span class="nc" id="L504">					errorMap.put(&quot;userError&quot;, &quot;&quot;);</span>
				}
<span class="nc bnc" id="L506" title="All 2 branches missed.">				if(idErrorMap!=null){</span>
<span class="nc" id="L507">				errorMap.putAll(idErrorMap);</span>
<span class="nc bnc" id="L508" title="All 2 branches missed.">				  if (&quot;A&quot;.equalsIgnoreCase(idErrorMap.get(&quot;idError&quot;))) {</span>
<span class="nc" id="L509">					errorMap.put(&quot;idError&quot;, &quot;&quot;);</span>
				}
				}
				
<span class="nc" id="L513">				logger.info(&quot;organization/user/Id Number is already exist = &quot;</span>
						+ errorMap);
				/*logger.info(&quot;organization/user/Id Number is already exist = &quot;
								+ errorMap);*/
<span class="nc" id="L517">				errorMap.put(&quot;returnTypeError&quot;, &quot;input&quot;);</span>
<span class="nc" id="L518">				return errorMap;</span>
			}

			// get the role id from database
			
<span class="nc" id="L523">			String getRoleIdQuery = QueryManager.getST3RoleId() + &quot;'AGENT' )&quot;;</span>
<span class="nc" id="L524">			stmt = con.prepareStatement(getRoleIdQuery);</span>
<span class="nc" id="L525">			rs = stmt.executeQuery();</span>
<span class="nc" id="L526">			logger.info(&quot;get the role id from database : &quot;</span>
					+ getRoleIdQuery);
		/*	logger.info(&quot;get the role id from database : &quot;
					+ getRoleIdQuery);*/
<span class="nc" id="L530">			int roleId = -1;</span>
<span class="nc bnc" id="L531" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L532">				roleId = rs.getInt(TableConstants.ROLE_ID);</span>
			}
<span class="nc" id="L534">			rs.close();</span>
<span class="nc" id="L535">			stmt.close();</span>
<span class="nc bnc" id="L536" title="All 2 branches missed.">			if (roleId == -1) {</span>
<span class="nc" id="L537">				new LMSException(&quot;roleId is not in database&quot;);</span>
			}

			// get the state and country code from DB
	
<span class="nc" id="L542">			String getCountryStateCode = QueryManager.getCountryAndStateCode()</span>
					+ &quot; where cont.name='&quot;
					+ orgUserData.getCountry()
					+ &quot; ' and stat.country_code=cont.country_code and stat.name='&quot;
					+ orgUserData.getState() + &quot;'&quot;;
<span class="nc" id="L547">			stmt = con.prepareStatement(getCountryStateCode);</span>
<span class="nc" id="L548">			rs = stmt.executeQuery();</span>
<span class="nc" id="L549">			String countryCode = null;</span>
<span class="nc" id="L550">			String stateCode = null;</span>
<span class="nc" id="L551">			int newOrgNbr=0;</span>
<span class="nc bnc" id="L552" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L553">				countryCode = rs.getString(TableConstants.COUNTRY_CODE);</span>
<span class="nc" id="L554">				stateCode = rs.getString(TableConstants.STATE_CODE);</span>
<span class="nc" id="L555">				newOrgNbr = rs.getInt(&quot;no_agt_registered&quot;)+1;				</span>
<span class="nc" id="L556">				logger.info(&quot; countryCode = &quot; + countryCode</span>
						+ &quot;  state codde = &quot; + stateCode);
				/*logger.info(&quot; countryCode = &quot; + countryCode
						+ &quot;  state codde = &quot; + stateCode);*/
			}

<span class="nc" id="L562">			con.setAutoCommit(false);</span>
<span class="nc" id="L563">			String newOrgQueryCode = generateAccessCodeForOrg(stateCode, newOrgNbr,orgUserData.getUserName().trim()</span>
					.toLowerCase(), &quot;AGENT&quot;, con,countryDep);
			// create the new organization into DB
<span class="nc bnc" id="L566" title="All 4 branches missed.">			if (orgUserData.getAutoScrap() == null</span>
					|| &quot;&quot;.equalsIgnoreCase(orgUserData.getAutoScrap().trim())) {
<span class="nc" id="L568">				orgUserData.setAutoScrap(&quot;NO&quot;);</span>
			}
			/*		String insertOrg = QueryManager.insertST3OrganizationAgent()
					+ &quot; values ( '&quot; + orgUserData.getOrgType() + &quot;','&quot;
					+ orgUserData.getOrgName() + &quot;', '&quot;
					+ userInfoBean.getUserOrgId() + &quot;','&quot;
					+ orgUserData.getAddrLine1() + &quot;','&quot;
					+ orgUserData.getAddrLine2() + &quot;','&quot;
					+ orgUserData.getCity() + &quot;',&quot; + orgUserData.getPin()
					+ &quot;,'&quot; + stateCode + &quot;','&quot; + countryCode + &quot;', 0, '&quot;
					+ orgUserData.getCreditLimit() + &quot;','&quot;
					+ orgUserData.getSecurity() + &quot;','&quot;
					+ orgUserData.getStatusorg() + &quot;', '&quot;
					+ orgUserData.getCreditLimit() + &quot;','&quot;
					+ orgUserData.getVatRegNo() + &quot;', '&quot;
					+ orgUserData.getAutoScrap() + &quot;', '&quot;
					+ orgUserData.getReconReportType() + &quot;') &quot;;
			
			String insertOrg = QueryManager.insertST3OrganizationAgent()
			+ &quot; values ( '&quot; + orgUserData.getOrgType() + &quot;','&quot;
			+ orgUserData.getOrgName() + &quot;', '&quot;
			+ userInfoBean.getUserOrgId() + &quot;','&quot;
			+ orgUserData.getAddrLine1() + &quot;','&quot;
			+ orgUserData.getAddrLine2() + &quot;','&quot;
			+ orgUserData.getCity() + &quot;',&quot; + orgUserData.getPin()
			+ &quot;,'&quot; + stateCode + &quot;','&quot; + countryCode + &quot;', 0, '&quot;
			+ orgUserData.getCreditLimit() + &quot;','&quot;
			+ orgUserData.getSecurity() + &quot;','&quot;
			+ orgUserData.getStatusorg() + &quot;', '&quot;
			+ orgUserData.getCreditLimit() + &quot;','&quot;
			+ orgUserData.getVatRegNo() + &quot;', '&quot;
			+ orgUserData.getAutoScrap() + &quot;','&quot;
			+ orgUserData.getReconReportType() + &quot;') &quot;; */
<span class="nc" id="L601">			pstmt = con.prepareStatement(QueryManager.insertST3OrganizationAgent());</span>
<span class="nc" id="L602">			pstmt.setString(1,orgUserData.getOrgType());</span>
<span class="nc" id="L603">			pstmt.setString(2,orgUserData.getOrgName().trim());</span>
<span class="nc" id="L604">			pstmt.setString(3,newOrgQueryCode);// org code </span>
<span class="nc" id="L605">			pstmt.setInt(4,userInfoBean.getUserOrgId());</span>
<span class="nc" id="L606">			pstmt.setString(5,orgUserData.getAddrLine1());</span>
<span class="nc" id="L607">			pstmt.setString(6,orgUserData.getAddrLine2());</span>
<span class="nc" id="L608">			pstmt.setString(7,orgUserData.getCity());</span>
<span class="nc" id="L609">			pstmt.setString(8,orgUserData.getDivision());</span>
<span class="nc" id="L610">			pstmt.setString(9,orgUserData.getArea());</span>
<span class="nc" id="L611">			pstmt.setString(10,stateCode);</span>
<span class="nc" id="L612">			pstmt.setString(11,countryCode); </span>
<span class="nc" id="L613">			pstmt.setLong(12,orgUserData.getPin());</span>
<span class="nc" id="L614">			pstmt.setDouble(13,orgUserData.getCreditLimit());</span>
<span class="nc" id="L615">			pstmt.setDouble(14,orgUserData.getCreditLimit());</span>
<span class="nc" id="L616">			pstmt.setDouble(15,orgUserData.getSecurity());</span>
<span class="nc" id="L617">			pstmt.setString(16,orgUserData.getStatusorg());</span>
<span class="nc" id="L618">			pstmt.setDouble(17,0);// default zero</span>
<span class="nc" id="L619">			pstmt.setString(18,orgUserData.getVatRegNo());</span>
<span class="nc" id="L620">			pstmt.setString(19,orgUserData.getAutoScrap());</span>
<span class="nc" id="L621">			pstmt.setString(20,orgUserData.getReconReportType());</span>
<span class="nc" id="L622">			int orgCreateRows = pstmt.executeUpdate();</span>
<span class="nc" id="L623">			logger.info(&quot;rows updated = &quot; + orgCreateRows+ &quot; ,  org creation query = &quot; + pstmt);</span>
<span class="nc" id="L624">			logger.info(&quot;rows updated = &quot; + orgCreateRows</span>
					+ &quot; ,  Agent org creation query = &quot; + pstmt);

<span class="nc" id="L627">			ResultSet res = pstmt.getGeneratedKeys();</span>
			// when organization creation completed
<span class="nc bnc" id="L629" title="All 2 branches missed.">			if (res.next()) {</span>
<span class="nc" id="L630">				errorMap.put(&quot;orgCode&quot;,newOrgQueryCode);</span>
				
<span class="nc" id="L632">				int genOrgId = res.getInt(1);</span>

<span class="nc" id="L634">				insertIntoOrgGameInvoiceMethods(genOrgId, con);</span>
<span class="nc" id="L635">				pstmt.close();</span>
				
				// Insert into st_lms_organization_security_levy_master (For Benin)...
<span class="nc bnc" id="L638" title="All 2 branches missed.">				if (&quot;BENIN&quot;.equalsIgnoreCase(countryDep)) {</span>
<span class="nc" id="L639">					String insOrgSecurityLevyDataQuery = &quot;INSERT INTO st_lms_organization_security_levy_master (organization_id ,initial_security_deposit ,expected_security_deposit ,collected_security_deposit ,levy_cat_type) VALUES (?,?,?,?,?)&quot;;</span>
<span class="nc" id="L640">					pstmt = con.prepareStatement(insOrgSecurityLevyDataQuery);</span>
<span class="nc" id="L641">					pstmt.setInt(1, genOrgId);</span>
<span class="nc" id="L642">					pstmt.setDouble(2, orgUserData.getSecurity());</span>
<span class="nc" id="L643">					pstmt.setDouble(3, 0.0);</span>
<span class="nc" id="L644">					pstmt.setDouble(4, orgUserData.getSecurity());</span>
<span class="nc bnc" id="L645" title="All 2 branches missed.">					pstmt.setString(5, isIFU ? &quot;CAT-1&quot; : &quot;CAT-2&quot;);</span>
				
<span class="nc" id="L647">					int insOrgSecurityLevyRows = pstmt.executeUpdate();</span>
<span class="nc" id="L648">					logger.info(&quot;total rows = &quot; + insOrgSecurityLevyRows</span>
							+ &quot; data inserted into st_lms_organization_security_levy_master query : &quot;
							+ pstmt);

<span class="nc" id="L652">					pstmt.close();</span>
				}
				
				// insert into st_organization_limit
<span class="nc" id="L656">				String insOrgLimQuery = &quot;insert into  st_lms_oranization_limits ( organization_id , verification_limit , approval_limit , pay_limit , scrap_limit , ola_deposit_limit , ola_withdrawal_limit, max_daily_claim_amt, self_claim, other_claim, min_claim_per_ticket, max_claim_per_ticket, block_amt, block_days, block_action,levy_rate) values (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)&quot;;</span>
<span class="nc" id="L657">				pstmt = con.prepareStatement(insOrgLimQuery);</span>
<span class="nc" id="L658">				pstmt.setInt(1, genOrgId);</span>
<span class="nc" id="L659">				pstmt.setDouble(2, Double.parseDouble(orgUserData.getVerLimit()</span>
						.replace(&quot;,&quot;, &quot;&quot;)));
<span class="nc" id="L661">				pstmt.setDouble(3, Double.parseDouble(orgUserData.getAppLimit()</span>
						.replace(&quot;,&quot;, &quot;&quot;)));
<span class="nc" id="L663">				pstmt.setDouble(4, Double.parseDouble(orgUserData.getPayLimit()</span>
						.replace(&quot;,&quot;, &quot;&quot;)));
<span class="nc" id="L665">				pstmt.setDouble(5, Double.parseDouble(orgUserData</span>
						.getScrapLimit().replace(&quot;,&quot;, &quot;&quot;)));
				
<span class="nc" id="L668">				pstmt.setDouble(6, Double.parseDouble(agtDepositLimit.replace(&quot;,&quot;, &quot;&quot;)));</span>
<span class="nc" id="L669">				pstmt.setDouble(7, Double.parseDouble(agtWithdrawalLimit.replace(&quot;,&quot;, &quot;&quot;)));</span>
<span class="nc" id="L670">				pstmt.setDouble(8, orgUserData.getMaxPerDayPayLimit());</span>
<span class="nc" id="L671">				pstmt.setString(9, orgUserData.getSelfClaim());</span>
<span class="nc" id="L672">				pstmt.setString(10, orgUserData.getOtherClaim());</span>
<span class="nc" id="L673">				pstmt.setDouble(11, orgUserData.getMinClaimPerTicket());</span>
<span class="nc" id="L674">				pstmt.setDouble(12, orgUserData.getMaxClaimPerTicket());</span>
<span class="nc" id="L675">				pstmt.setDouble(13, orgUserData.getBlockAmt());</span>
<span class="nc" id="L676">				pstmt.setInt(14, orgUserData.getBlockDays());</span>
<span class="nc" id="L677">				pstmt.setString(15, orgUserData.getBlockAction());</span>
<span class="nc bnc" id="L678" title="All 2 branches missed.">				if (&quot;BENIN&quot;.equalsIgnoreCase(countryDep))</span>
<span class="nc bnc" id="L679" title="All 2 branches missed.">					pstmt.setDouble(16, isIFU ? Double.parseDouble(Utility.getPropertyValue(&quot;LEVY_CAT-1_PERCENTAGE&quot;)) : Double.parseDouble(Utility.getPropertyValue(&quot;LEVY_CAT-2_PERCENTAGE&quot;)));</span>
				else
<span class="nc" id="L681">					pstmt.setDouble(16, 0.0);</span>
<span class="nc" id="L682">				int insOrgLimRows = pstmt.executeUpdate();</span>
<span class="nc" id="L683">				logger.info(&quot;total rows = &quot; + insOrgLimRows</span>
						+ &quot; data inserted into st_organization_limit query : &quot;
						+ pstmt);

<span class="nc" id="L687">				pstmt.close();</span>

				// insert in cl_xcl_update history
				/*
				Statement stmt2=con.createStatement();
				String updtCreditXtendedLimitHistory=&quot;insert into st_lms_cl_xcl_update_history(organization_id,date_time,type,amount,updated_value,total_bal_before_update) values(&quot;+ genOrgId+&quot;,'&quot;+ new java.sql.Timestamp(new java.util.Date().getTime()).toString() +&quot;','CL',&quot;+orgUserData.getCreditLimit()+&quot;,&quot;+orgUserData.getCreditLimit()+&quot;,&quot;+&quot;0.00)&quot;;
				logger.info(&quot;inset Query for st_lms_cl_xcl_update history:&quot;+updtCreditXtendedLimitHistory);
				stmt2.executeUpdate(updtCreditXtendedLimitHistory);
				*/
<span class="nc" id="L696">				PreparedStatement stmt2=con.prepareStatement(&quot;insert into st_lms_cl_xcl_update_history(organization_id,done_by_user_id,date_time,type,amount,updated_value,total_bal_before_update) values(?,?,?,?,?,?,?);&quot;);</span>
<span class="nc" id="L697">				stmt2.setInt(1, genOrgId);</span>
<span class="nc" id="L698">				stmt2.setInt(2, userInfoBean.getUserId());</span>
<span class="nc" id="L699">				stmt2.setTimestamp(3, Util.getCurrentTimeStamp());</span>
<span class="nc" id="L700">				stmt2.setString(4, &quot;CL&quot;);</span>
<span class="nc" id="L701">				stmt2.setDouble(5, orgUserData.getCreditLimit());</span>
<span class="nc" id="L702">				stmt2.setDouble(6, orgUserData.getCreditLimit());</span>
<span class="nc" id="L703">				stmt2.setDouble(7, 0.00);</span>
<span class="nc" id="L704">				logger.info(stmt2);</span>
<span class="nc" id="L705">				stmt2.executeUpdate();</span>

				/*
				 * // insert into st_rg_org_daily_tx String
				 * insOrgRgdailyTxQuery=&quot;insert into
				 * st_lms_rg_org_daily_tx(organization_id,date) values(?,?)&quot;;
				 * pstmt = con.prepareStatement(insOrgRgdailyTxQuery);
				 * pstmt.setInt(1, genOrgId); pstmt.setDate(2, new
				 * java.sql.Date(new Date().getTime())); int
				 * insOrgRgdailytansRows = pstmt.executeUpdate();
				 * logger.info(&quot;total rows = &quot;+insOrgRgdailytansRows+&quot;
				 * data inserted into st_rg_org_daily_tx query : &quot;+pstmt);
				 * 
				 * pstmt.close(); // insert into st_rg_org_weekly_tx String
				 * insOrgRgWeeklyTxQuery=&quot;insert into
				 * st_lms_rg_org_weekly_tx(organization_id,date) values(?,?)&quot;;
				 * pstmt = con.prepareStatement(insOrgRgWeeklyTxQuery);
				 * pstmt.setInt(1, genOrgId); Calendar cal
				 * =Calendar.getInstance(); cal.set(Calendar.DAY_OF_WEEK, 2);
				 * Date weekMondayDate = cal.getTime(); pstmt.setDate(2,new
				 * java.sql.Date(weekMondayDate.getTime())); int
				 * insOrgRgWeeklytansRows = pstmt.executeUpdate();
				 * logger.info(&quot;total rows = &quot;+insOrgRgWeeklytansRows+&quot;
				 * data inserted into st_rg_org_weekly_tx query : &quot;+pstmt);
				 * 
				 */

<span class="nc" id="L732">				Timestamp regDate = new java.sql.Timestamp(new Date().getTime());</span>
				// generate the auto password
<span class="nc" id="L734">				String autoPass = AutoGenerate.autoPassword();</span>
<span class="nc" id="L735">				pstmt.close();</span>
				// insert data into st_lms_user_master table
<span class="nc" id="L737">				String userReg = QueryManager.insertST3AgentDetails();</span>
				/*
				 * organization_id,role_id,organization_type,auto_password
				 * ,user_name,password,status,secret_ques,secret_ans,registration_date,
				 * isrolehead,parent_user_id, register_by_id, tp_user_id
				 * */
<span class="nc" id="L743">				pstmt = con.prepareStatement(userReg);</span>
<span class="nc" id="L744">				pstmt.setInt(1, genOrgId);</span>
<span class="nc" id="L745">				pstmt.setInt(2, roleId);</span>
<span class="nc" id="L746">				pstmt.setString(3, orgUserData.getOrgType());</span>
<span class="nc" id="L747">				pstmt.setString(4, &quot;1&quot;);</span>
<span class="nc" id="L748">				pstmt.setString(5, orgUserData.getUserName().trim()</span>
						.toLowerCase());
<span class="nc" id="L750">				pstmt.setString(6, MD5Encoder.encode(autoPass));</span>
<span class="nc" id="L751">				pstmt.setString(7, orgUserData.getStatus());</span>
<span class="nc" id="L752">				pstmt.setString(8, orgUserData.getSecQues());</span>
<span class="nc" id="L753">				pstmt.setString(9, orgUserData.getSecAns());</span>
<span class="nc" id="L754">				pstmt.setTimestamp(10, regDate);</span>
<span class="nc" id="L755">				pstmt.setString(11, &quot;Y&quot;);</span>
<span class="nc" id="L756">				pstmt.setInt(12, userInfoBean.getUserId());</span>
<span class="nc" id="L757">				pstmt.setInt(13, userInfoBean.getUserId());</span>
<span class="nc bnc" id="L758" title="All 2 branches missed.">				if(orgUserData.getTpUserId() != null){</span>
<span class="nc" id="L759">					pstmt.setString(14, orgUserData.getTpUserId());</span>
				}else{
<span class="nc" id="L761">					pstmt.setString(14, null);</span>
				}
<span class="nc" id="L763">				pstmt.executeUpdate();</span>
<span class="nc" id="L764">				logger.info(&quot;Agent user created query : &quot; + pstmt);</span>

				// get the generated user_id
<span class="nc" id="L767">				rs = pstmt.getGeneratedKeys();</span>
<span class="nc bnc" id="L768" title="All 2 branches missed.">				if (rs.next()) {</span>
<span class="nc" id="L769">					int userId = rs.getInt(1);</span>
<span class="nc" id="L770">					logger.info(&quot;AGENT user created and user id : &quot;</span>
							+ userId);
<span class="nc" id="L772">					logger.info(&quot;phone no &quot; + orgUserData.getPhone());</span>
					// insert data into st_lms_user_contact_details
<span class="nc" id="L774">					String insertContactDetail = QueryManager</span>
							.insertST3ContactsDetails();
<span class="nc" id="L776">					pstmt = con.prepareStatement(insertContactDetail);</span>
<span class="nc" id="L777">					pstmt.setInt(1, userId);</span>
<span class="nc" id="L778">					pstmt.setString(2, orgUserData.getFirstName());</span>
<span class="nc" id="L779">					pstmt.setString(3, orgUserData.getLastName());</span>
<span class="nc" id="L780">					pstmt.setString(4, orgUserData.getEmail());</span>
<span class="nc" id="L781">					pstmt.setLong(5, orgUserData.getPhone());</span>
<span class="nc" id="L782">					pstmt.setString(6, orgUserData.getIdType());</span>
<span class="nc" id="L783">					pstmt.setString(7, orgUserData.getIdNo());</span>
<span class="nc" id="L784">					pstmt.setLong(8, orgUserData.getMobile());</span>
<span class="nc" id="L785">					int contactDetailRows = pstmt.executeUpdate();</span>
<span class="nc" id="L786">					logger.info(&quot;total rows update in st_lms_user_contact_details table == &quot;</span>
									+ contactDetailRows + &quot; pstmt : &quot; + pstmt);

					// insert password details into st_password_history table
<span class="nc" id="L790">					String passwordDetails = QueryManager</span>
							.insertST3PasswordDetails();
<span class="nc" id="L792">					pstmt = con.prepareStatement(passwordDetails);</span>
<span class="nc" id="L793">					pstmt.setInt(1, userId);</span>
<span class="nc" id="L794">					pstmt.setString(2, MD5Encoder.encode(autoPass));</span>
<span class="nc" id="L795">					int passHistoryRows = pstmt.executeUpdate();</span>
<span class="nc" id="L796">					logger.info(&quot;total rows update in passHistory table == &quot;</span>
									+ passHistoryRows);
<span class="nc" id="L798">					pstmt.close();</span>

					//	Insert Data In st_lms_user_ip_time_mapping Table.
<span class="nc" id="L801">					LoginTimeIPValidationHelper helper = new LoginTimeIPValidationHelper();</span>
<span class="nc" id="L802">					helper.insertUserTimeLimitData(userId, con);</span>

					// insert organization history into
					// st_lms_organization_master_history table
					//UserInfoBean loginUserBean = (UserInfoBean)ServletActionContext.getRequest().getSession().getAttribute(&quot;USER_INFO&quot;);
					/*String insertOrgHistory = QueryManager
							.insertST3OrganizationHistory()
							+ &quot; values( &quot;
							+ userInfoBean.getUserId()
							+ &quot;, &quot;
							+ genOrgId
							+ &quot;, '&quot;
							+ orgUserData.getAddrLine1()
							+ &quot;', '&quot;
							+ orgUserData.getAddrLine2()
							+ &quot;', '&quot;
							+ orgUserData.getDivision()
							+ &quot;', '&quot;
							+ orgUserData.getArea()
							+ &quot;', '&quot;
							+ orgUserData.getCity()
							+ &quot;', &quot;
							+ orgUserData.getPin()
							+ &quot;, &quot;
							+ orgUserData.getCreditLimit()
							+ &quot;, &quot;
							+ orgUserData.getSecurity()
							+ &quot;,'ACTIVE_MANUAL_&quot;+loginType+&quot;'&quot;
							+ &quot;,'New Agent Organization created','&quot;
							+ orgUserData.getStatusorg()
							+ &quot;', '&quot;
							+ new java.sql.Timestamp(new Date().getTime()).toString()
							+ &quot;','&quot;
							+orgUserData.getAutoScrap()
							+ &quot;','&quot;
							+ orgUserData.getReconReportType()
							+ &quot;'&quot;
							+ &quot;)&quot;;
					stmt = con.prepareStatement(insertOrgHistory);
					logger.info(&quot; rows updated and Query to update history 111:: &quot;
									+ insertOrgHistory);
					int historyRows = stmt.executeUpdate();
					logger.info(historyRows
							+ &quot; rows updated and Query to update history :: &quot;
							+ insertOrgHistory);*/

					// insert into service role mapping for organization
<span class="nc" id="L849">					String serRole = &quot;insert into st_lms_service_role_mapping (role_id,organization_id,id,status) values&quot;;</span>
<span class="nc" id="L850">					int id[] = orgUserData.getId();</span>
<span class="nc" id="L851">					String status[] = orgUserData.getStatusTable();</span>
<span class="nc" id="L852">					StringBuilder values = new StringBuilder();</span>
<span class="nc bnc" id="L853" title="All 2 branches missed.">					for (int i = 0; i &lt; id.length; i++) {</span>
<span class="nc" id="L854">						values.append(&quot;(&quot; + roleId + &quot;,&quot; + genOrgId + &quot;,&quot;</span>
								+ id[i] + &quot;,'&quot; + (status[i].split(&quot;-&quot;))[0]
								+ &quot;'),&quot;);
					}
<span class="nc" id="L858">					serRole = serRole</span>
							+ values.substring(0, values.length() - 1);
<span class="nc" id="L860">					logger.info(&quot;Service Role entry-----&quot; + serRole);</span>
<span class="nc" id="L861">					pstmt = con.prepareStatement(serRole);</span>
<span class="nc" id="L862">					pstmt.executeUpdate();</span>

					// insert into st_lms_user_priv_master
					/*
					 * String insertUserPrivQuery=&quot;insert into
					 * st_lms_user_priv_mapping select &quot;+userId+&quot;,&quot;+roleId+&quot;,
					 * aa.pid, aa.status from st_lms_role_priv_mapping aa,
					 * priviledge_rep bb where aa.pid = bb.pid and aa.role_id =
					 * &quot;+roleId; pstmt =
					 * con.prepareStatement(insertUserPrivQuery); int
					 * userPrivMasterRows = pstmt.executeUpdate();
					 * logger.info(&quot;total rows = &quot;+userPrivMasterRows+&quot;
					 * data inserted into st_user_priv_master query : &quot;+pstmt);
					 */
<span class="nc" id="L876">					String serviceData[] = orgUserData.getStatusTable();</span>
<span class="nc" id="L877">					String insertUserPriv = null;</span>
<span class="nc" id="L878">					String privStatus = null;</span>
<span class="nc" id="L879">					String tableName = null;</span>
<span class="nc" id="L880">					logger.info(&quot;Service Id Length::&quot; + id.length);</span>
<span class="nc bnc" id="L881" title="All 2 branches missed.">					for (int i = 0; i &lt; id.length; i++) {</span>
<span class="nc" id="L882">						privStatus = serviceData[i].split(&quot;-&quot;)[0];</span>
<span class="nc" id="L883">						tableName = serviceData[i].split(&quot;-&quot;)[1];</span>
<span class="nc bnc" id="L884" title="All 2 branches missed.">						if (privStatus.equals(&quot;ACTIVE&quot;)) {</span>
<span class="nc" id="L885">							privStatus = &quot;rpm.status&quot;;</span>
						} else {
<span class="nc" id="L887">							privStatus = &quot;'INACTIVE'&quot;;</span>
						}
<span class="nc" id="L889">						insertUserPriv = &quot;insert into st_lms_user_priv_mapping (priv_id ,user_id , role_id, service_mapping_id, status) select &quot;</span>
								+ &quot;  distinct(rpm.priv_id),&quot;
								+ userId
								+ &quot;,&quot;
								+ roleId
								+ &quot;,rpm.service_mapping_id, &quot;
								+ privStatus
								+ &quot; from st_lms_role_priv_mapping rpm, &quot;
								+ tableName
								+ &quot; pr  where rpm.role_id = &quot;
								+ roleId
								+ &quot; and rpm.priv_id = pr.priv_id and service_mapping_id=&quot;
								+ id[i] + &quot;&quot;;

<span class="nc" id="L903">						logger.info(&quot;insertUserPriv::&quot; + i + &quot; :: &quot;</span>
								+ insertUserPriv);
<span class="nc" id="L905">						pstmt = con.prepareStatement(insertUserPriv);</span>
<span class="nc" id="L906">						pstmt.executeUpdate();</span>
					}

					// assign privilege to AGENT
<span class="nc" id="L910">					assignEmailPriviledges(userId, orgUserData.getOrgType(),</span>
							orgUserData.getEmail(), orgUserData
									.getEmailPrivId(), con);

					//Added For Agent Responsible gaming
<span class="nc" id="L915">					ResponsibleGaming.rgInsertion(userId, genOrgId , con);</span>
					//ResponsibleGaming.rgInsertion(userId, genOrgId);
					

					//	Insert Registration Messages
<span class="nc" id="L920">					MessageInboxDaoImpl.getSingleInstance().addRegistrationMessage(userId, &quot;AGENT&quot;, &quot;WEB&quot;, con);</span>

					// con.commit();
					
<span class="nc bnc" id="L924" title="All 2 branches missed.">					if(&quot;true&quot;.equalsIgnoreCase(Utility.getPropertyValue(&quot;AGENT_BANK_MAPPING&quot;))){</span>
<span class="nc" id="L925">						new BankHelper().saveDetails(orgUserData.getBankId(), orgUserData.getBranchId(), genOrgId, orgUserData.getAccountNbr(), userInfoBean, regDate ,con);</span>
					}
					
//					 userDataBean = new UserDataBean();
<span class="nc bnc" id="L929" title="All 4 branches missed.">					if (&quot;NIGERIA&quot;.equalsIgnoreCase(countryDep) &amp;&amp; &quot;YES&quot;.equalsIgnoreCase(Utility.getPropertyValue(&quot;IS_WRAPPER_ENABLED&quot;)) ) {</span>
<span class="nc" id="L930">						UserRegistrationRequestBean userRegistrationRequestBean = new UserRegistrationRequestBean();  </span>
<span class="nc" id="L931">						userRegistrationRequestBean.setUserName(orgUserData.getUserName());</span>
<span class="nc bnc" id="L932" title="All 2 branches missed.">						if (&quot;WRAPPER&quot;.equals(orgUserData.getRegFrom()))</span>
<span class="nc" id="L933">							userRegistrationRequestBean.setRegType(&quot;WRAPPER&quot;);</span>
						else
<span class="nc" id="L935">							userRegistrationRequestBean.setRegType(&quot;LMS&quot;);</span>
<span class="nc" id="L936">						NotifyWrapper notifyWrapper = new NotifyWrapper(Wraper.Activity.USER_REGISTER, userRegistrationRequestBean);</span>
<span class="nc" id="L937">						UserRegistrationResponseBean userRegistrationResponseBean = (UserRegistrationResponseBean) notifyWrapper.asyncCall(notifyWrapper);</span>
						
<span class="nc bnc" id="L939" title="All 2 branches missed.">						if (userRegistrationResponseBean.getResponseCode() != 0) {</span>
<span class="nc" id="L940">							errorMap = new HashMap&lt;String, String&gt;();</span>
<span class="nc" id="L941">							errorMap.put(&quot;returnTypeError&quot;, &quot;input&quot;);</span>
<span class="nc" id="L942">							errorMap.put(&quot;userError&quot;, &quot;User Name already exists !!&quot;);</span>
<span class="nc" id="L943">							return errorMap;</span>
						}
					}

<span class="nc bnc" id="L947" title="All 2 branches missed.">					if(&quot;YES&quot;.equalsIgnoreCase(LMSFilterDispatcher.getIsSLE())){</span>
						try {
<span class="nc" id="L949">							ServerStartUpData.updateOrgDataForSLE(&quot;AGENT&quot; , genOrgId, con);</span>
<span class="nc" id="L950">						} catch (Exception e) {</span>
<span class="nc" id="L951">							logger.error(&quot;Could not update the orgDataMap for SLE....&quot;);</span>
<span class="nc" id="L952">							e.printStackTrace();</span>
<span class="nc" id="L953">						}</span>
					}
<span class="nc" id="L955">					con.commit();</span>

					/*	Send Registration Data to SLE 	*/
<span class="nc bnc" id="L958" title="All 2 branches missed.">					if(ServicesBean.isSLE()) {</span>
<span class="nc" id="L959">						UserDataBean dataBean = null;</span>
						try {
<span class="nc" id="L961">							dataBean = UserMgmtController.getInstance().getUserInfo(orgUserData.getUserName().trim());</span>
<span class="nc" id="L962">							dataBean.setCreatorUserId(userInfoBean.getUserId());</span>
<span class="nc" id="L963">							NotifySLE notifySLE = new NotifySLE(SLE.Activity.USER_REGISTER, dataBean);</span>
<span class="nc" id="L964">							notifySLE.start();</span>
<span class="nc" id="L965">						} catch (Exception e) {</span>
<span class="nc" id="L966">							e.printStackTrace();</span>
<span class="nc" id="L967">						}</span>
					}

<span class="nc" id="L970">					logger.info(&quot;Agent registration completed successfully&quot;);</span>
					//This is harcoded check for OLA to run independently.
<span class="nc bnc" id="L972" title="All 2 branches missed.">					if(ServicesBean.isDG())</span>
<span class="nc" id="L973">					Util.orgDataMap.put(genOrgId, ServerStartUpData.getOrgGameData(genOrgId, con, &quot;AGENT&quot;));</span>
<span class="nc bnc" id="L974" title="All 2 branches missed.">					if(ServicesBean.isIW())</span>
<span class="nc" id="L975">						Util.iwOrgDataMap.put(genOrgId, ServerStartUpData.getOrgGameDataIW(genOrgId, con, &quot;AGENT&quot;));</span>
<span class="nc bnc" id="L976" title="All 2 branches missed.">					if(ServicesBean.isVS())</span>
<span class="nc" id="L977">						Util.vsOrgDataMap.put(genOrgId, ServerStartUpData.getOrgGameDataVS(genOrgId, con, &quot;AGENT&quot;));</span>
					//logger.info(&quot;sale variance after registration: &quot; + Util.getSaleCommVariance(genOrgId,2));				
					
					// send mail to user is commented now because retailer is
					// not online
<span class="nc bnc" id="L982" title="All 2 branches missed.">					if (orgUserData.getOrgType().equals(&quot;AGENT&quot;)) {</span>
<span class="nc" id="L983">						String msgFor = &quot;Thanks for registration to our gaming system  Your Login details are&quot;;</span>
<span class="nc" id="L984">						String emailMsgTxt = &quot;&lt;html&gt;&lt;table&gt;&lt;tr&gt;&lt;td&gt;Hi &quot;</span>
								+ orgUserData.getFirstName()
								+ &quot; &quot;
								+ orgUserData.getLastName()
								+ &quot;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&quot;
								+ msgFor
								+ &quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;table&gt;&lt;tr&gt;&lt;td&gt;User Name :: &lt;/td&gt;&lt;td&gt;&quot;
								+ orgUserData.getUserName().trim()
								+ &quot;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;password :: &lt;/td&gt;&lt;td&gt;&quot;
								+ autoPass.toString()
								+ &quot;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;log on &lt;/td&gt;&lt;td&gt;&quot;
								+ LMSFilterDispatcher.webLink + &quot;/&quot;
								+ LMSFilterDispatcher.mailProjName
								+ &quot;/&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/html&gt;&quot;;
<span class="nc" id="L998">						MailSend mailSend = new MailSend(</span>
								orgUserData.getEmail(), emailMsgTxt);
<span class="nc" id="L1000">						mailSend.setDaemon(true);</span>
<span class="nc" id="L1001">						mailSend.start();</span>
						// MailSend.sendMailToUser(email, autoPass,
						// userName.trim(), firstName, lastName, msgFor);
<span class="nc" id="L1004">						logger.info(&quot;mail sent after commit&quot;);</span>
					}
<span class="nc" id="L1006">					insertIntoAgentRoleMapping(genOrgId, userInfoBean.getRoleId(), con);</span>
<span class="nc" id="L1007">					con.commit();</span>
<span class="nc" id="L1008">					return errorMap;</span>
				} else {
<span class="nc" id="L1010">					logger.info(&quot;User is not created &quot;);</span>
<span class="nc" id="L1011">					throw new LMSException(&quot;User is not created &quot;);</span>
				}
			} else {
<span class="nc" id="L1014">				logger.info(&quot;organization is not created &quot;);</span>
<span class="nc" id="L1015">				throw new LMSException(&quot;Organization is not created &quot;);</span>
			}
<span class="nc" id="L1017">		} catch (SQLException se) { </span>
<span class="nc" id="L1018">			se.printStackTrace();</span>
<span class="nc" id="L1019">			throw new LMSException(&quot;sql exception&quot;, se);</span>
		} finally {
<span class="nc" id="L1021">			DBConnect.closeCon(con);</span>

			//	Licensing Server Validation
<span class="nc" id="L1024">			LSControllerImpl.getInstance().clientValidation();</span>
		}
	}

	private static void insertIntoOrgGameInvoiceMethods(int orgId,
			Connection con) {

<span class="nc" id="L1031">		Statement st = null ;</span>
<span class="nc" id="L1032">		PreparedStatement ps = null ;</span>
<span class="nc" id="L1033">		ResultSet rs = null ;</span>
		
		try{
<span class="nc" id="L1036">			String fetchFromGameMaster = &quot;select game_id, invoice_scheme_id, scheme_value from st_se_game_master gm inner join st_se_invoicing_methods im on gm.invoice_scheme_id = im.invoice_method_id&quot; ;</span>
<span class="nc" id="L1037">			String insertIntoOrgGameInvoiceMethods = &quot;insert into st_se_org_game_invoice_methods values (?, ?, ?, ?)&quot; ;</span>
<span class="nc" id="L1038">			st = con.createStatement() ;</span>
			
<span class="nc" id="L1040">			rs = st.executeQuery(fetchFromGameMaster) ;</span>
<span class="nc" id="L1041">			ps = con.prepareStatement(insertIntoOrgGameInvoiceMethods) ;</span>
			
<span class="nc bnc" id="L1043" title="All 2 branches missed.">			while (rs.next()){</span>
<span class="nc" id="L1044">				ps.setInt(1, orgId) ;</span>
<span class="nc" id="L1045">				ps.setInt(2, rs.getInt(&quot;game_id&quot;));</span>
<span class="nc" id="L1046">				ps.setInt(3, rs.getInt(&quot;invoice_scheme_id&quot;));</span>
<span class="nc" id="L1047">				ps.setString(4, rs.getString(&quot;scheme_value&quot;));</span>
<span class="nc" id="L1048">				ps.addBatch();</span>
			}
<span class="nc" id="L1050">			ps.executeBatch() ;</span>
			
<span class="nc" id="L1052">		}catch(Exception e){</span>
<span class="nc" id="L1053">			e.printStackTrace() ;</span>
		}finally{
<span class="nc" id="L1055">			DBConnect.closeResource(st, rs, ps) ;</span>
<span class="nc" id="L1056">		}</span>
		
		
<span class="nc" id="L1059">	}</span>

	public Map&lt;String, String&gt; createNewQuickRetailerOrgNUser(
			UserInfoBean userInfoBean, RetailerOrgUserRegAction orgUserData,
			Set keySet) throws LMSException {
<span class="nc" id="L1064">		String deviceType = null;</span>
<span class="nc" id="L1065">		String terminalId = null;</span>
<span class="nc" id="L1066">		Connection con =null;</span>
<span class="nc" id="L1067">		PreparedStatement pstmt=null;</span>
		try {
<span class="nc" id="L1069">			con = DBConnect.getConnection();</span>

			// check is organization and user name is already exists
<span class="nc" id="L1072">			Map&lt;String, String&gt; errorMap = verifyOrgName(orgUserData</span>
					.getOrgName(), orgUserData.getUserName(), con);
<span class="nc" id="L1074">			Map&lt;String, String&gt; idErrorMap = checkUniqueIdNo(orgUserData</span>
					.getIdNo(), orgUserData.getIdType(), con);
<span class="nc bnc" id="L1076" title="All 4 branches missed.">			if (errorMap.containsKey(&quot;returnTypeError&quot;)</span>
					|| idErrorMap.containsKey(&quot;returnTypeError&quot;)) {
<span class="nc bnc" id="L1078" title="All 2 branches missed.">				if (&quot;A&quot;.equalsIgnoreCase(errorMap.get(&quot;orgError&quot;))) {</span>
<span class="nc" id="L1079">					errorMap.put(&quot;orgError&quot;, &quot;&quot;);</span>
				}
<span class="nc bnc" id="L1081" title="All 2 branches missed.">				if (&quot;A&quot;.equalsIgnoreCase(errorMap.get(&quot;userError&quot;))) {</span>
<span class="nc" id="L1082">					errorMap.put(&quot;userError&quot;, &quot;&quot;);</span>
				}
<span class="nc" id="L1084">				errorMap.putAll(idErrorMap);</span>
<span class="nc bnc" id="L1085" title="All 2 branches missed.">				if (&quot;A&quot;.equalsIgnoreCase(idErrorMap.get(&quot;idError&quot;))) {</span>
<span class="nc" id="L1086">					errorMap.put(&quot;idError&quot;, &quot;&quot;);</span>
				}

<span class="nc" id="L1089">				logger.info(&quot;organization/user/Id Number is already exist = &quot;</span>
								+ errorMap);
<span class="nc" id="L1091">				errorMap.put(&quot;returnTypeError&quot;, &quot;input&quot;);</span>
<span class="nc" id="L1092">				return errorMap;</span>
			}

			// get the role id from database
<span class="nc" id="L1096">			Statement stmt = con.createStatement();</span>
<span class="nc" id="L1097">			String getRoleIdQuery = QueryManager.getST3RoleId() + &quot;'Retailer')&quot;;</span>
<span class="nc" id="L1098">			ResultSet rs = stmt.executeQuery(getRoleIdQuery);</span>
<span class="nc" id="L1099">			logger.info(&quot;get the role id from database : &quot;</span>
					+ getRoleIdQuery);
<span class="nc" id="L1101">			int roleId = -1;</span>
<span class="nc bnc" id="L1102" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L1103">				roleId = rs.getInt(TableConstants.ROLE_ID);</span>
			}
<span class="nc" id="L1105">			rs.close();</span>
<span class="nc" id="L1106">			stmt.close();</span>
<span class="nc bnc" id="L1107" title="All 2 branches missed.">			if (roleId == -1) {</span>
<span class="nc" id="L1108">				new LMSException(&quot;roleId is not in database&quot;);</span>
			}

<span class="nc" id="L1111">			String orgStatus = &quot;ACTIVE&quot;;</span>
<span class="nc bnc" id="L1112" title="All 2 branches missed.">			if (orgUserData.getCreditLimit() &lt;= 0.0) {</span>
<span class="nc" id="L1113">				orgStatus = &quot;INACTIVE&quot;;</span>
			}

<span class="nc" id="L1116">			con.setAutoCommit(false);</span>

			// create the new organization into DB
<span class="nc" id="L1119">			String insertOrg = QueryManager.insertST3OrganizationAgent()</span>
					+ &quot; select 'RETAILER', '&quot;
					+ orgUserData.getOrgName()
					+ &quot;', '&quot;
					+ userInfoBean.getUserOrgId()
					+ &quot;',addr_line1, addr_line2, city, pin_code,&quot;
					+ &quot;state_code, country_code, 0, '&quot;
					+ orgUserData.getCreditLimit()
					+ &quot;', 0, '&quot;
					+ orgStatus
					+ &quot;', '&quot;
					+ orgUserData.getCreditLimit()
					+ &quot;',vat_registration_nbr, 'NO', 'Ticket Wise Report' from st_lms_organization_master where organization_id =&quot;
					+ userInfoBean.getUserOrgId();
<span class="nc" id="L1133">			pstmt = con.prepareStatement(insertOrg);</span>
<span class="nc" id="L1134">			logger.info(&quot;org creation query = &quot; + pstmt);</span>
<span class="nc" id="L1135">			int orgCreateRows = pstmt.executeUpdate();</span>
<span class="nc" id="L1136">			logger.info(&quot;rows updated = &quot; + orgCreateRows);</span>

<span class="nc" id="L1138">			ResultSet res = pstmt.getGeneratedKeys();</span>
			// when organization creation completed
<span class="nc bnc" id="L1140" title="All 2 branches missed.">			if (res.next()) {</span>
<span class="nc" id="L1141">				int genOrgId = res.getInt(1);</span>

<span class="nc" id="L1143">				pstmt.close();</span>
				// insert into st_organization_limit
<span class="nc" id="L1145">				String insOrgLimQuery = &quot;insert into  st_lms_oranization_limits ( organization_id , verification_limit , approval_limit , pay_limit , scrap_limit , ola_deposit_limit , ola_withdrawl_limit) values ( ?,?,?,?,?,?,?)&quot;;</span>
<span class="nc" id="L1146">				pstmt = con.prepareStatement(insOrgLimQuery);</span>
<span class="nc" id="L1147">				pstmt.setInt(1, genOrgId);</span>
<span class="nc" id="L1148">				pstmt.setDouble(2, Double.parseDouble(orgUserData.getVerLimit()</span>
						.replace(&quot;,&quot;, &quot;&quot;)));
<span class="nc" id="L1150">				pstmt.setDouble(3, Double.parseDouble(orgUserData.getAppLimit()</span>
						.replace(&quot;,&quot;, &quot;&quot;)));
<span class="nc" id="L1152">				pstmt.setDouble(4, Double.parseDouble(orgUserData.getPayLimit()</span>
						.replace(&quot;,&quot;, &quot;&quot;)));
<span class="nc" id="L1154">				pstmt.setDouble(5, Double.parseDouble(orgUserData</span>
						.getScrapLimit().replace(&quot;,&quot;, &quot;&quot;)));
<span class="nc" id="L1156">				pstmt.setDouble(6, Double.parseDouble(orgUserData</span>
						.getOlaDepositLimit().replace(&quot;,&quot;, &quot;&quot;)));
<span class="nc" id="L1158">				pstmt.setDouble(7, Double.parseDouble(orgUserData</span>
						.getOlaWithdrawalLimit().replace(&quot;,&quot;, &quot;&quot;)));
<span class="nc" id="L1160">				int insOrgLimRows = pstmt.executeUpdate();</span>
<span class="nc" id="L1161">				logger.info(&quot;total rows = &quot;</span>
								+ insOrgLimRows
								+ &quot; data inserted into st_lms_organization_limit query : &quot;
								+ pstmt);

<span class="nc" id="L1166">				pstmt.close();</span>

				/*
				 * // insert into st_lms_rg_org_daily_tx String
				 * insOrgRgdailyTxQuery=&quot;insert into
				 * st_lms_rg_org_daily_tx(organization_id,date) values(?,?)&quot;;
				 * pstmt = con.prepareStatement(insOrgRgdailyTxQuery);
				 * pstmt.setInt(1, genOrgId); pstmt.setDate(2, new
				 * java.sql.Date(new Date().getTime())); int
				 * insOrgRgdailytansRows = pstmt.executeUpdate();
				 * logger.info(&quot;total rows = &quot;+insOrgRgdailytansRows+&quot;
				 * data inserted into st_lms_rg_org_daily_tx query : &quot;+pstmt);
				 * 
				 * pstmt.close(); // insert into st_lms_rg_org_weekly_tx String
				 * insOrgRgWeeklyTxQuery=&quot;insert into
				 * st_lms_rg_org_weekly_tx(organization_id,date) values(?,?)&quot;;
				 * pstmt = con.prepareStatement(insOrgRgWeeklyTxQuery);
				 * pstmt.setInt(1, genOrgId); Calendar cal
				 * =Calendar.getInstance(); cal.set(Calendar.DAY_OF_WEEK, 2);
				 * Date weekMondayDate = cal.getTime(); pstmt.setDate(2,new
				 * java.sql.Date(weekMondayDate.getTime())); int
				 * insOrgRgWeeklytansRows = pstmt.executeUpdate();
				 * logger.info(&quot;total rows = &quot;+insOrgRgWeeklytansRows+&quot;
				 * data inserted into st_lms_rg_org_weekly_tx query : &quot;+pstmt);
				 * 
				 */

				// generate the auto password
<span class="nc" id="L1194">				String autoPass = null;</span>
<span class="nc" id="L1195">				logger.info(&quot;Get Attribute: &quot;</span>
						+ (String) LMSUtility.sc
								.getAttribute(&quot;RETAILER_PASS&quot;));
<span class="nc bnc" id="L1198" title="All 2 branches missed.">				if (&quot;integer&quot;.equalsIgnoreCase(((String) LMSUtility.sc.getAttribute(&quot;RETAILER_PASS&quot;))</span>
						.trim())) {
<span class="nc" id="L1200">					autoPass = AutoGenerate.autoPasswordInt() + &quot;&quot;;</span>
				} else {
<span class="nc" id="L1202">					autoPass = AutoGenerate.autoPassword();</span>
				}
<span class="nc" id="L1204">				logger.info(&quot;Password Generated: &quot; + autoPass);</span>
<span class="nc" id="L1205">				pstmt.close();</span>
				// insert data into st_lms_user_master table
<span class="nc" id="L1207">				String userReg = &quot;INSERT into st_lms_user_master(organization_id, role_id,parent_user_id,organization_type,auto_password,user_name, &quot;</span>
						+ &quot;password, status, secret_ques, secret_ans, registration_date, isrolehead) select &quot;
						+ genOrgId
						+ &quot;, &quot;
						+ roleId
						+ &quot;,'&quot;
						+ userInfoBean.getUserId()
						+ &quot;', 'RETAILER', '1', '&quot;
						+ orgUserData.getUserName().trim().toLowerCase()
						+ &quot;', '&quot;
						+ MD5Encoder.encode(autoPass)
						+ &quot;','ACTIVE', secret_ques, secret_ans, '&quot;
						+ new java.sql.Timestamp(new Date().getTime())
						+ &quot;', 'Y' from st_lms_user_master where user_id =&quot;
						+ userInfoBean.getUserId();
<span class="nc" id="L1222">				pstmt = con.prepareStatement(userReg);</span>
<span class="nc" id="L1223">				logger.info(&quot;bo user created query : &quot; + pstmt);</span>
<span class="nc" id="L1224">				pstmt.executeUpdate();</span>

				// get the generated user_id
<span class="nc" id="L1227">				rs = pstmt.getGeneratedKeys();</span>
<span class="nc bnc" id="L1228" title="All 2 branches missed.">				if (rs.next()) {</span>
<span class="nc" id="L1229">					int userId = rs.getInt(1);</span>
<span class="nc" id="L1230">					logger.info(&quot;bo user created and user id : &quot;</span>
							+ userId);

					// insert data into st_lms_user_contact_details
<span class="nc" id="L1234">					String insertContactDetail = &quot;INSERT into st_lms_user_contact_details(user_id,first_name,last_name,email_id,phone_nbr,&quot;</span>
							+ &quot; id_type, id_nbr) select ?, ?, ?, email_id, ?, ?, ? from st_lms_user_contact_details where user_id =&quot;
							+ userInfoBean.getUserId();
<span class="nc" id="L1237">					pstmt = con.prepareStatement(insertContactDetail);</span>
<span class="nc" id="L1238">					pstmt.setInt(1, userId);</span>
<span class="nc" id="L1239">					pstmt.setString(2, orgUserData.getFirstName());</span>
<span class="nc" id="L1240">					pstmt.setString(3, orgUserData.getLastName());</span>
<span class="nc" id="L1241">					pstmt.setLong(4, orgUserData.getPhone());</span>
<span class="nc" id="L1242">					pstmt.setString(5, orgUserData.getIdType());</span>
<span class="nc" id="L1243">					pstmt.setString(6, orgUserData.getIdNo());</span>
<span class="nc" id="L1244">					int contactDetailRows = pstmt.executeUpdate();</span>
<span class="nc" id="L1245">					logger.info(&quot;total rows update in st_lms_user_contact_details table == &quot;</span>
									+ contactDetailRows + &quot; pstmt : &quot; + pstmt);

					// insert password details into st_lms_password_history
					// table
<span class="nc" id="L1250">					String passwordDetails = QueryManager</span>
							.insertST3PasswordDetails();
<span class="nc" id="L1252">					pstmt = con.prepareStatement(passwordDetails);</span>
<span class="nc" id="L1253">					pstmt.setInt(1, userId);</span>
<span class="nc" id="L1254">					pstmt.setString(2, MD5Encoder.encode(autoPass));</span>
<span class="nc" id="L1255">					int passHistoryRows = pstmt.executeUpdate();</span>
<span class="nc" id="L1256">					logger.info(&quot;total rows update in passHistory table == &quot;</span>
									+ passHistoryRows);
<span class="nc" id="L1258">					pstmt.close();</span>

					// insert organization history into
					// st_lms_organization_master_history table
					//UserInfoBean loginUserBean = (UserInfoBean)ServletActionContext.getRequest().getSession().getAttribute(&quot;USER_INFO&quot;);
					/*String insertOrgHistory = QueryManager
							.insertST3OrganizationHistory()
							+ &quot; values( &quot;
							+ userInfoBean.getUserId()
							+ &quot;, &quot;
							+ genOrgId
							+ &quot;, '&quot;
							+ orgUserData.getAddrLine1()
							+ &quot;', '&quot;
							+ orgUserData.getAddrLine2()
							+ &quot;', '&quot;
							+ orgUserData.getCity()
							+ &quot;', &quot;
							+ orgUserData.getPin()
							+ &quot;, &quot;
							+ orgUserData.getCreditLimit()
							+ &quot;, &quot;
							+ orgUserData.getSecurity()
							+ &quot;,'ACTIVE_MANUAL_&quot;+userInfoBean.getUserType()+&quot;'&quot;
							+ &quot;,'New Retailer Organization created','&quot;
							+ orgUserData.getStatusorg()
							+ &quot;', '&quot;
							+ new java.sql.Timestamp(new Date().getTime()).toString()
							+ &quot;','&quot;
							+orgUserData.getAutoScrap()
							+ &quot;','&quot;
							+ orgUserData.getReconReportType()
							+ &quot;'&quot;
							+ &quot;)&quot;;
					stmt = con.createStatement();
					int historyRows = stmt.executeUpdate(insertOrgHistory);
					logger.info(historyRows
							+ &quot; rows updated and Query to update history :: &quot;
							+ insertOrgHistory);*/

					// insert into service role mapping for organization Vaibhav
<span class="nc" id="L1299">					String serRole = &quot;insert into st_lms_service_role_mapping select service_delivery_master_id,&quot;</span>
							+ roleId
							+ &quot;,&quot;
							+ genOrgId
							+ &quot;,status from st_lms_service_delivery_master where tier_id in (select tier_id from st_lms_tier_master where tier_code='Retailer')&quot;;
<span class="nc" id="L1304">					pstmt = con.prepareStatement(serRole);</span>
<span class="nc" id="L1305">					logger.info(&quot;query ==&quot; + serRole);</span>
<span class="nc" id="L1306">					int orgSerRole = pstmt.executeUpdate();</span>
<span class="nc" id="L1307">					logger.info(&quot;total rows = &quot;</span>
									+ orgSerRole
									+ &quot; data inserted into st_lms_user_priv_master query : &quot;
									+ pstmt);

					// insert into st_lms_st_lms_user_priv_mapping
<span class="nc" id="L1313">					String insertUserPrivQuery = &quot;insert into st_lms_user_priv_mapping select &quot;</span>
							+ userId
							+ &quot;,&quot;
							+ roleId
							+ &quot;,priv_id,service_mapping_id,status from st_lms_role_priv_mapping where role_id=&quot;
							+ roleId;
<span class="nc" id="L1319">					pstmt = con.prepareStatement(insertUserPrivQuery);</span>
<span class="nc" id="L1320">					logger.info(&quot;query ==&quot; + insertUserPrivQuery);</span>
<span class="nc" id="L1321">					int userPrivMasterRows = pstmt.executeUpdate();</span>
<span class="nc" id="L1322">					logger.info(&quot;total rows = &quot;</span>
									+ userPrivMasterRows
									+ &quot; data inserted into st_lms_user_priv_master query : &quot;
									+ pstmt);

					// added for offline sale
<span class="nc" id="L1328">					String isRetailerOffline = (String) LMSUtility.sc.getAttribute(&quot;RET_OFFLINE&quot;);</span>
<span class="nc" id="L1329">					String isLoginBind = (String) LMSUtility.sc.getAttribute(&quot;LOGIN_BINDING&quot;);</span>
<span class="nc bnc" id="L1330" title="All 2 branches missed.">					boolean  isSimBind =&quot;YES&quot;.equalsIgnoreCase((String) LMSUtility.sc.getAttribute(&quot;sim_binding&quot;))?true:false;</span>
<span class="nc" id="L1331">					int retOfflineId = 0;</span>
<span class="nc" id="L1332">					StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L1333">					String address = null;</span>
<span class="nc" id="L1334">					String latLon = null;</span>
					//if(&quot;YES&quot;.equalsIgnoreCase(isLoginBind.trim())){
<span class="nc bnc" id="L1336" title="All 2 branches missed.">						if (!&quot;YES&quot;.equalsIgnoreCase(isRetailerOffline.trim())) {</span>
<span class="nc" id="L1337">							orgUserData.setIsOffLine(&quot;NO&quot;);</span>
						}
<span class="nc" id="L1339">						DrawGameOfflineHelper helper = new DrawGameOfflineHelper();</span>
<span class="nc" id="L1340">						address = sb.append(orgUserData.getAddrLine1()).append(&quot;,&quot;).append(orgUserData.getAddrLine2()).append(&quot; &quot;).append(orgUserData.getCity()).append(&quot; &quot;).append(orgUserData.getCountry()).toString();</span>
						
<span class="nc" id="L1342">						latLon = CommonFunctionsHelper.getLongitudeLatitude(address);</span>
<span class="nc bnc" id="L1343" title="All 2 branches missed.">						if(orgUserData.getTerminalId() == null){</span>
<span class="nc" id="L1344">							deviceType = &quot;-1&quot;;</span>
<span class="nc" id="L1345">							terminalId = &quot;-1&quot;;</span>
						} else{
<span class="nc" id="L1347">							deviceType = orgUserData.getTerminalId().split(&quot;-&quot;)[0];</span>
<span class="nc" id="L1348">							terminalId = orgUserData.getTerminalId().split(&quot;-&quot;)[1];</span>
						}
					/*	retOfflineId = helper.saveOfflineRetData(userId,
								genOrgId, orgUserData.getIsOffLine(),
								deviceType,terminalId, con,latLon,orgUserData.getCity(),isLoginBind);*/
						
						
<span class="nc" id="L1355">						retOfflineId = helper.saveOfflineRetData(userId,genOrgId, orgUserData.getIsOffLine(),orgUserData.getModelName(),orgUserData.getTerminalId(), con,latLon,orgUserData.getCity(),isLoginBind,orgUserData.getSim(),orgUserData.getSimModelName(),isSimBind);</span>
<span class="nc bnc" id="L1356" title="All 2 branches missed.">						if (retOfflineId &lt; 1) {</span>
<span class="nc" id="L1357">							throw new LMSException(&quot;User is not created &quot;);</span>
						}
					//}
					
					// rg calling
					//ResponsibleGaming.rgInsertion(userId, genOrgId);
<span class="nc" id="L1363">					ResponsibleGaming.rgInsertion(userId, genOrgId , con);</span>

<span class="nc" id="L1365">					con.commit();</span>
<span class="nc" id="L1366">					logger.info(&quot;retailer registration completed successfully&quot;);</span>
					// send mail to user is commented now because retailer is
					// not online
<span class="nc" id="L1369">					String isRetaileOnline = (String) LMSUtility.sc.getAttribute(&quot;RET_ONLINE&quot;);</span>
<span class="nc" id="L1370">					errorMap.put(&quot;NewPassword&quot;, autoPass);</span>
<span class="nc bnc" id="L1371" title="All 2 branches missed.">					if (&quot;YES&quot;.equalsIgnoreCase(isRetaileOnline.trim())) {</span>
<span class="nc" id="L1372">						String emailAddress = &quot;&quot;;</span>
<span class="nc" id="L1373">						String msgFor = &quot;Thanks for registration to our gaming system  Your Login details are&quot;;</span>
<span class="nc" id="L1374">						String emailMsgTxt = &quot;&lt;html&gt;&lt;table&gt;&lt;tr&gt;&lt;td&gt;Hi &quot;</span>
								+ orgUserData.getFirstName()
								+ &quot; &quot;
								+ orgUserData.getLastName()
								+ &quot;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&quot;
								+ msgFor
								+ &quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;table&gt;&lt;tr&gt;&lt;td&gt;User Name :: &lt;/td&gt;&lt;td&gt;&quot;
								+ orgUserData.getUserName().trim()
								+ &quot;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;password :: &lt;/td&gt;&lt;td&gt;&quot;
								+ autoPass.toString()
								+ &quot;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;log on &lt;/td&gt;&lt;td&gt;&quot;
								+ LMSFilterDispatcher.webLink + &quot;/&quot;
								+ LMSFilterDispatcher.mailProjName
								+ &quot;/&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/html&gt;&quot;;
<span class="nc" id="L1388">						PreparedStatement stmt1 = con</span>
								.prepareStatement(&quot;select email_id from st_lms_user_contact_details where user_id = &quot;
										+ userInfoBean.getUserId());
<span class="nc" id="L1391">						rs = stmt1.executeQuery();</span>
<span class="nc bnc" id="L1392" title="All 2 branches missed.">						if (rs.next()) {</span>
<span class="nc" id="L1393">							emailAddress = rs.getString(1);</span>
						}

<span class="nc" id="L1396">						logger.info(&quot;email address is &quot; + emailAddress);</span>
<span class="nc" id="L1397">						MailSend mailSend = new MailSend(emailAddress,</span>
								emailMsgTxt);
<span class="nc" id="L1399">						mailSend.setDaemon(true);</span>
<span class="nc" id="L1400">						mailSend.start();</span>
						// MailSend.sendMailToUser(email, autoPass,
						// userName.trim(), firstName, lastName, msgFor);
<span class="nc" id="L1403">						logger.info(&quot;mail sent after commit&quot;);</span>
<span class="nc" id="L1404">						stmt1 = null;</span>
					}
<span class="nc" id="L1406">					return errorMap;</span>
				} else {
<span class="nc" id="L1408">					logger.info(&quot;User is not created &quot;);</span>
<span class="nc" id="L1409">					throw new LMSException(&quot;User is not created &quot;);</span>
				}
			} else {
<span class="nc" id="L1412">				logger.info(&quot;organization is not created &quot;);</span>
<span class="nc" id="L1413">				throw new LMSException(&quot;Organization is not created &quot;);</span>
			}
<span class="nc" id="L1415">		} catch (SQLException se) {</span>
<span class="nc" id="L1416">			se.printStackTrace();</span>
<span class="nc" id="L1417">			throw new LMSException(&quot;sql exception&quot;, se);</span>
		} finally {
<span class="nc" id="L1419">			DBConnect.closeCon(con);</span>
			
			//	Licensing Server Validation
<span class="nc" id="L1422">			LSControllerImpl.getInstance().clientValidation();</span>
		}

	}

	public static synchronized Map&lt;String, String&gt;  createNewRetailerOrgNUser(
			UserInfoBean userInfoBean, RetailerRegistrationBean orgUserData,String loginType)
			throws LMSException {
<span class="nc" id="L1430">		Connection con =null;</span>
<span class="nc" id="L1431">		PreparedStatement stmt =null;</span>
<span class="nc" id="L1432">		ResultSet rs =null;</span>
<span class="nc" id="L1433">		PreparedStatement pstmt =null;</span>
		try {
		
<span class="nc" id="L1436">			String retDepositLimit = (String)LMSUtility.sc.getAttribute(&quot;retDepositLimit&quot;);</span>
<span class="nc" id="L1437">			String retWithdrawalLimit = (String)LMSUtility.sc.getAttribute(&quot;retWithdrawalLimit&quot;);</span>
<span class="nc" id="L1438">			String rootPath = LMSUtility.sc.getRealPath(&quot;/&quot;).toString();</span>
<span class="nc" id="L1439">			String countryDep =((String)LMSUtility.sc.getAttribute(&quot;COUNTRY_DEPLOYED&quot;)).trim();</span>
<span class="nc bnc" id="L1440" title="All 6 branches missed.">			boolean isIFU = &quot;IFU Code&quot;.equalsIgnoreCase(orgUserData.getIdType()) &amp;&amp; orgUserData.getIdNo() != null &amp;&amp; !&quot;&quot;.equalsIgnoreCase(orgUserData.getIdNo()); </span>
<span class="nc" id="L1441">			con = DBConnect.getConnection();</span>
			
			// check is organization and user name is already exists
<span class="nc" id="L1444">			Map&lt;String, String&gt; errorMap = verifyOrgName(orgUserData</span>
					.getOrgName(), orgUserData.getUserName(), con);
<span class="nc" id="L1446">			Map&lt;String, String&gt; idErrorMap = null;</span>
<span class="nc bnc" id="L1447" title="All 4 branches missed.">			if (orgUserData.getIdNo() != null &amp;&amp; !&quot;&quot;.equals(orgUserData.getIdNo())) {</span>
<span class="nc" id="L1448">				idErrorMap = checkUniqueIdNo(orgUserData</span>
					.getIdNo(), orgUserData.getIdType(), con);
			}
			
<span class="nc bnc" id="L1452" title="All 6 branches missed.">			if (errorMap.containsKey(&quot;returnTypeError&quot;)</span>
					|| (idErrorMap != null &amp;&amp; idErrorMap.containsKey(&quot;returnTypeError&quot;))) {
<span class="nc bnc" id="L1454" title="All 2 branches missed.">				if (&quot;A&quot;.equalsIgnoreCase(errorMap.get(&quot;orgError&quot;))) {</span>
<span class="nc" id="L1455">					errorMap.put(&quot;orgError&quot;, &quot;&quot;);</span>
				}
<span class="nc bnc" id="L1457" title="All 2 branches missed.">				if (&quot;A&quot;.equalsIgnoreCase(errorMap.get(&quot;userError&quot;))) {</span>
<span class="nc" id="L1458">					errorMap.put(&quot;userError&quot;, &quot;&quot;);</span>
				}
<span class="nc bnc" id="L1460" title="All 2 branches missed.">				if(idErrorMap!=null){</span>
<span class="nc" id="L1461">				errorMap.putAll(idErrorMap);</span>
<span class="nc bnc" id="L1462" title="All 2 branches missed.">				if (&quot;A&quot;.equalsIgnoreCase(idErrorMap.get(&quot;idError&quot;))) {</span>
<span class="nc" id="L1463">					errorMap.put(&quot;idError&quot;, &quot;&quot;);</span>
				}
				}

<span class="nc" id="L1467">				logger.info(&quot;organization/user/Id Number is already exist = &quot;</span>
								+ errorMap);
<span class="nc" id="L1469">				errorMap.put(&quot;returnTypeError&quot;, &quot;input&quot;);</span>
<span class="nc" id="L1470">				return errorMap;</span>
			}

			
			//here append the code for creating affiliate in PlayTech System
<span class="nc" id="L1475">			String walletName=&quot;RUMMY&quot;; //Default for rummy retailer reg </span>
			//here check for playtech retailer reg
<span class="nc bnc" id="L1477" title="All 4 branches missed.">			if((LMSFilterDispatcher.getIsOLA()).equalsIgnoreCase(&quot;YES&quot;) &amp;&amp; &quot;PLAY_TECH&quot;.equalsIgnoreCase(walletName))</span>
			{
<span class="nc" id="L1479">			boolean isSuccess = false;</span>
<span class="nc" id="L1480">			isSuccess = OLAUtility.createAffiliate(orgUserData, errorMap,rootPath);</span>
<span class="nc bnc" id="L1481" title="All 2 branches missed.">			if(!isSuccess)</span>
<span class="nc" id="L1482">				return errorMap;</span>
			}
			// get the role id from database
<span class="nc" id="L1485">			String getRoleIdQuery = QueryManager.getST3RoleId()+ &quot; 'RETAILER' )&quot;;</span>
<span class="nc" id="L1486">			stmt = con.prepareStatement(getRoleIdQuery);</span>
<span class="nc" id="L1487">			rs = stmt.executeQuery();</span>
<span class="nc" id="L1488">			logger.info(&quot;get the role id from database : &quot;</span>
					+ getRoleIdQuery);
<span class="nc" id="L1490">			int roleId = -1;</span>
<span class="nc bnc" id="L1491" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L1492">				roleId = rs.getInt(TableConstants.ROLE_ID);</span>
			}
<span class="nc" id="L1494">			rs.close();</span>
<span class="nc" id="L1495">			stmt.close();</span>
<span class="nc bnc" id="L1496" title="All 2 branches missed.">			if (roleId == -1) {</span>
<span class="nc" id="L1497">				throw new LMSException(textProvider.getText(&quot;msg.roleId.not.inDB&quot;));</span>
			}

			// get the state and country code from DB
			
<span class="nc" id="L1502">			String getCountryStateCode = QueryManager.getCountryAndStateCode()</span>
					+ &quot; where cont.name='&quot;
					+ orgUserData.getCountry()
					+ &quot; ' and stat.country_code=cont.country_code and stat.name='&quot;
					+ orgUserData.getState() + &quot;'&quot;;
<span class="nc" id="L1507">			stmt = con.prepareStatement(getCountryStateCode);</span>
<span class="nc" id="L1508">			rs = stmt.executeQuery();</span>
<span class="nc" id="L1509">			String countryCode = null;</span>
<span class="nc" id="L1510">			String stateCode = null;</span>
<span class="nc" id="L1511">			int newOrgNbr=0;</span>
<span class="nc bnc" id="L1512" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L1513">				countryCode = rs.getString(TableConstants.COUNTRY_CODE);</span>
<span class="nc" id="L1514">				stateCode = rs.getString(TableConstants.STATE_CODE);</span>
<span class="nc" id="L1515">				newOrgNbr = rs.getInt(&quot;no_ret_registered&quot;)+1;	</span>
<span class="nc" id="L1516">				logger.info(&quot; countryCode = &quot; + countryCode</span>
						+ &quot;  state codde = &quot; + stateCode);
			}
<span class="nc" id="L1519">			con.setAutoCommit(false);</span>
<span class="nc bnc" id="L1520" title="All 2 branches missed.">			if(newOrgNbr&lt;0){</span>
<span class="nc" id="L1521">				logger.info(&quot;&quot;);</span>
<span class="nc" id="L1522">				throw new LMSException(textProvider.getText(&quot;msg.error.inOrgCodeGen&quot;));</span>
			}
			
<span class="nc" id="L1525">			String newOrgQueryCode = generateAccessCodeForOrg(stateCode, newOrgNbr,userInfoBean.getUserName().trim(), &quot;RETAILER&quot;, con,countryDep);</span>
			// create the new organization into DB
<span class="nc bnc" id="L1527" title="All 6 branches missed.">			if (orgUserData.getAutoScrap() == null</span>
					|| &quot;&quot;.equalsIgnoreCase(orgUserData.getAutoScrap().trim())
					|| !&quot;YES&quot;.equalsIgnoreCase(userInfoBean.getPwtSacrap())) {
<span class="nc" id="L1530">				orgUserData.setAutoScrap(&quot;NO&quot;);</span>
			}
		/*	String insertOrg = QueryManager.insertST3OrganizationAgent()
					+ &quot; values ( '&quot; + orgUserData.getOrgType() + &quot;','&quot;
					+ orgUserData.getOrgName() + &quot;', '&quot;
					+ userInfoBean.getUserOrgId() + &quot;','&quot;
					+ orgUserData.getAddrLine1() + &quot;','&quot;
					+ orgUserData.getAddrLine2() + &quot;','&quot;
					+ orgUserData.getCity() + &quot;',&quot; + orgUserData.getPin()
					+ &quot;,'&quot; + stateCode + &quot;','&quot; + countryCode + &quot;', 0, '&quot;
					+ orgUserData.getCreditLimit() + &quot;','&quot;
					+ orgUserData.getSecurity() + &quot;','&quot;
					+ orgUserData.getStatusorg() + &quot;', '&quot;
					+ orgUserData.getCreditLimit() + &quot;','&quot;
					+ orgUserData.getVatRegNo() + &quot;', '&quot;
					+ orgUserData.getAutoScrap() + &quot;','&quot;
					+ orgUserData.getReconReportType() + &quot;') &quot;;*/
<span class="nc" id="L1547">			pstmt = con.prepareStatement(QueryManager.insertST3OrganizationAgent());</span>
<span class="nc" id="L1548">			pstmt.setString(1,orgUserData.getOrgType());</span>
<span class="nc" id="L1549">			pstmt.setString(2,orgUserData.getOrgName().trim());</span>
<span class="nc" id="L1550">			pstmt.setString(3,newOrgQueryCode);// org code </span>
<span class="nc" id="L1551">			pstmt.setInt(4,userInfoBean.getUserOrgId());</span>
<span class="nc" id="L1552">			pstmt.setString(5,orgUserData.getAddrLine1());</span>
<span class="nc" id="L1553">			pstmt.setString(6,orgUserData.getAddrLine2());</span>
<span class="nc" id="L1554">			pstmt.setString(7,orgUserData.getCity());</span>
<span class="nc" id="L1555">			pstmt.setString(8,orgUserData.getDivision());</span>
<span class="nc" id="L1556">			pstmt.setString(9,orgUserData.getArea());</span>
<span class="nc" id="L1557">			pstmt.setString(10,stateCode);</span>
<span class="nc" id="L1558">			pstmt.setString(11,countryCode); </span>
<span class="nc" id="L1559">			pstmt.setLong(12,orgUserData.getPin());</span>
<span class="nc" id="L1560">			pstmt.setDouble(13,orgUserData.getCreditLimit());</span>
<span class="nc" id="L1561">			pstmt.setDouble(14,orgUserData.getCreditLimit());</span>
<span class="nc" id="L1562">			pstmt.setDouble(15,orgUserData.getSecurity());</span>
<span class="nc" id="L1563">			pstmt.setString(16,orgUserData.getStatusorg());</span>
<span class="nc" id="L1564">			pstmt.setDouble(17,0);// default zero</span>
<span class="nc" id="L1565">			pstmt.setString(18,orgUserData.getVatRegNo());</span>
<span class="nc" id="L1566">			pstmt.setString(19,orgUserData.getAutoScrap());</span>
<span class="nc" id="L1567">			pstmt.setString(20,orgUserData.getReconReportType());</span>
<span class="nc" id="L1568">			int orgCreateRows = pstmt.executeUpdate();</span>
<span class="nc" id="L1569">			logger.info(&quot;rows updated = &quot; + orgCreateRows+ &quot; ,  org creation query = &quot; + pstmt);</span>
	/*		logger.info(&quot;rows updated = &quot; + orgCreateRows
					+ &quot; ,  org creation query = &quot; + pstmt);*/

<span class="nc" id="L1573">			ResultSet res = pstmt.getGeneratedKeys();</span>
			// when organization creation completed
<span class="nc bnc" id="L1575" title="All 2 branches missed.">			if (res.next()) {</span>
	
<span class="nc" id="L1577">				errorMap.put(&quot;orgCode&quot;,newOrgQueryCode);</span>
<span class="nc" id="L1578">				int genOrgId = res.getInt(1);</span>

<span class="nc" id="L1580">				insertIntoOrgGameInvoiceMethods(genOrgId, con);</span>
<span class="nc" id="L1581">				pstmt.close();</span>
				
				// Insert into st_lms_organization_security_levy_master (For Benin)...
<span class="nc bnc" id="L1584" title="All 2 branches missed.">				if (&quot;BENIN&quot;.equalsIgnoreCase(countryDep)) {</span>
<span class="nc" id="L1585">					String insOrgSecurityLevyDataQuery = &quot;INSERT INTO st_lms_organization_security_levy_master (organization_id ,initial_security_deposit ,expected_security_deposit ,collected_security_deposit ,levy_cat_type) VALUES (?,?,?,?,?)&quot;;</span>
<span class="nc" id="L1586">					pstmt = con.prepareStatement(insOrgSecurityLevyDataQuery);</span>
<span class="nc" id="L1587">					pstmt.setInt(1, genOrgId);</span>
<span class="nc" id="L1588">					pstmt.setDouble(2, orgUserData.getSecurity());</span>
<span class="nc" id="L1589">					pstmt.setDouble(3, Double.parseDouble(Utility.getPropertyValue(&quot;SECURITY_DEPOSIT_AMOUNT&quot;)));</span>
<span class="nc" id="L1590">					pstmt.setDouble(4, orgUserData.getSecurity());</span>
<span class="nc bnc" id="L1591" title="All 2 branches missed.">					pstmt.setString(5, isIFU ? &quot;CAT-1&quot; : &quot;CAT-2&quot;);</span>
				
<span class="nc" id="L1593">					int insOrgSecurityLevyRows = pstmt.executeUpdate();</span>
<span class="nc" id="L1594">					logger.info(&quot;total rows = &quot; + insOrgSecurityLevyRows</span>
							+ &quot; data inserted into st_lms_organization_security_levy_master query : &quot;
							+ pstmt);

<span class="nc" id="L1598">					pstmt.close();</span>
				}
				
				// insert into st_organization_limit
<span class="nc" id="L1602">				String insOrgLimQuery = &quot;insert into  st_lms_oranization_limits ( organization_id , verification_limit , approval_limit , pay_limit , scrap_limit , ola_deposit_limit , ola_withdrawal_limit, max_daily_claim_amt, self_claim, other_claim, min_claim_per_ticket, max_claim_per_ticket, block_amt, block_days, block_action,levy_rate,security_deposit_rate) values ( ?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)&quot;;</span>
<span class="nc" id="L1603">				pstmt = con.prepareStatement(insOrgLimQuery);</span>
<span class="nc" id="L1604">				pstmt.setInt(1, genOrgId);</span>
<span class="nc" id="L1605">				pstmt.setDouble(2, Double.parseDouble(orgUserData.getVerLimit()</span>
						.replace(&quot;,&quot;, &quot;&quot;)));
<span class="nc" id="L1607">				pstmt.setDouble(3, Double.parseDouble(orgUserData.getAppLimit()</span>
						.replace(&quot;,&quot;, &quot;&quot;)));
<span class="nc" id="L1609">				pstmt.setDouble(4, Double.parseDouble(orgUserData.getPayLimit()</span>
						.replace(&quot;,&quot;, &quot;&quot;)));
<span class="nc" id="L1611">				pstmt.setDouble(5, Double.parseDouble(orgUserData</span>
						.getScrapLimit().replace(&quot;,&quot;, &quot;&quot;)));
			
<span class="nc" id="L1614">				pstmt.setDouble(6, Double.parseDouble(retDepositLimit.replace(&quot;,&quot;, &quot;&quot;)));</span>
<span class="nc" id="L1615">				pstmt.setDouble(7, Double.parseDouble(retWithdrawalLimit.replace(&quot;,&quot;, &quot;&quot;)));</span>
<span class="nc" id="L1616">				pstmt.setDouble(8, orgUserData.getMaxPerDayPayLimit());</span>
<span class="nc" id="L1617">				pstmt.setString(9, orgUserData.getSelfClaim());</span>
<span class="nc" id="L1618">				pstmt.setString(10, orgUserData.getOtherClaim());</span>
<span class="nc" id="L1619">				pstmt.setDouble(11, orgUserData.getMinClaimPerTicket());</span>
<span class="nc" id="L1620">				pstmt.setDouble(12, orgUserData.getMaxClaimPerTicket());</span>
<span class="nc" id="L1621">				pstmt.setDouble(13, orgUserData.getBlockAmt());</span>
<span class="nc" id="L1622">				pstmt.setInt(14, orgUserData.getBlockDays());</span>
<span class="nc" id="L1623">				pstmt.setString(15, orgUserData.getBlockAction());</span>
<span class="nc bnc" id="L1624" title="All 2 branches missed.">				if (&quot;BENIN&quot;.equalsIgnoreCase(countryDep)) {</span>
<span class="nc bnc" id="L1625" title="All 2 branches missed.">					pstmt.setDouble(16, isIFU ? Double.parseDouble(Utility.getPropertyValue(&quot;LEVY_CAT-1_PERCENTAGE&quot;)) : Double.parseDouble(Utility.getPropertyValue(&quot;LEVY_CAT-2_PERCENTAGE&quot;)));</span>
<span class="nc bnc" id="L1626" title="All 2 branches missed.">					pstmt.setDouble(17, Double.parseDouble(Utility.getPropertyValue(&quot;SECURITY_DEPOSIT_AMOUNT&quot;)) &lt;= orgUserData.getSecurity() ? 0 : Double.parseDouble(Utility.getPropertyValue(&quot;SECURITY_DEPOSIT_RATE&quot;)));</span>
				} else {
<span class="nc" id="L1628">					pstmt.setDouble(16, 0.0);</span>
<span class="nc" id="L1629">					pstmt.setDouble(17, 0.0);</span>
				}
<span class="nc" id="L1631">				int insOrgLimRows = pstmt.executeUpdate();</span>
<span class="nc" id="L1632">				logger.info(&quot;total rows = &quot; + insOrgLimRows</span>
						+ &quot; data inserted into st_organization_limit query : &quot;
						+ pstmt);

<span class="nc" id="L1636">				pstmt.close();</span>

<span class="nc" id="L1638">				String insertRetSoldQuery = &quot;INSERT INTO st_lms_ret_sold_claim_criteria (organization_id, claim_at_self_ret, claim_at_self_agt, claim_at_other_ret_same_agt, claim_at_other_ret, claim_at_other_agt, claim_at_bo) VALUES (?,?,?,?,?,?,?);&quot;;</span>
<span class="nc" id="L1639">				pstmt = con.prepareStatement(insertRetSoldQuery);</span>
<span class="nc" id="L1640">				pstmt.setInt(1, genOrgId);</span>
<span class="nc" id="L1641">				pstmt.setString(2, Utility.getPropertyValue(&quot;CLAIM_AT_SELF_RET&quot;));</span>
<span class="nc" id="L1642">				pstmt.setString(3, Utility.getPropertyValue(&quot;CLAIM_AT_SELF_AGT&quot;));</span>
<span class="nc" id="L1643">				pstmt.setString(4, Utility.getPropertyValue(&quot;CLAIM_AT_OTHER_RET_SAME_AGT&quot;));</span>
<span class="nc" id="L1644">				pstmt.setString(5, Utility.getPropertyValue(&quot;CLAIM_AT_OTHER_RET&quot;));</span>
<span class="nc" id="L1645">				pstmt.setString(6, Utility.getPropertyValue(&quot;CLAIM_AT_OTHER_AGT&quot;));</span>
<span class="nc" id="L1646">				pstmt.setString(7, Utility.getPropertyValue(&quot;CLAIM_AT_BO&quot;));</span>
<span class="nc" id="L1647">				int rowUpdated = pstmt.executeUpdate();</span>
<span class="nc" id="L1648">				logger.info(&quot;Total Rows = &quot;+rowUpdated+&quot;, Data Inserted Into st_lms_ret_sold_claim_criteria Query - &quot;+pstmt);</span>

<span class="nc" id="L1650">				pstmt.close();</span>

				// insert in cl_xcl_update history
<span class="nc" id="L1653">				Statement stmt2=con.createStatement();</span>
<span class="nc" id="L1654">				String updtCreditXtendedLimitHistory=&quot;insert into st_lms_cl_xcl_update_history(organization_id,done_by_user_id,date_time,type,amount,updated_value,total_bal_before_update) values(&quot;+ genOrgId+&quot;,&quot;+userInfoBean.getUserId()+&quot;,'&quot;+ new java.sql.Timestamp(new java.util.Date().getTime()).toString() +&quot;','CL',&quot;+orgUserData.getCreditLimit()+&quot;,&quot;+orgUserData.getCreditLimit()+&quot;,&quot;+&quot;0.00)&quot;;</span>
<span class="nc" id="L1655">				logger.info(&quot;inset Query for st_lms_cl_xcl_update history:&quot;+updtCreditXtendedLimitHistory);</span>
<span class="nc" id="L1656">				stmt2.executeUpdate(updtCreditXtendedLimitHistory);</span>
							
				/*
				 * // insert into st_rg_org_daily_tx String
				 * insOrgRgdailyTxQuery=&quot;insert into
				 * st_lms_rg_org_daily_tx(organization_id,date) values(?,?)&quot;;
				 * pstmt = con.prepareStatement(insOrgRgdailyTxQuery);
				 * pstmt.setInt(1, genOrgId); pstmt.setDate(2, new
				 * java.sql.Date(new Date().getTime())); int
				 * insOrgRgdailytansRows = pstmt.executeUpdate();
				 * logger.info(&quot;total rows = &quot;+insOrgRgdailytansRows+&quot;
				 * data inserted into st_rg_org_daily_tx query : &quot;+pstmt);
				 * 
				 * pstmt.close(); // insert into st_rg_org_weekly_tx String
				 * insOrgRgWeeklyTxQuery=&quot;insert into
				 * st_lms_rg_org_weekly_tx(organization_id,date) values(?,?)&quot;;
				 * pstmt = con.prepareStatement(insOrgRgWeeklyTxQuery);
				 * pstmt.setInt(1, genOrgId); Calendar cal
				 * =Calendar.getInstance(); cal.set(Calendar.DAY_OF_WEEK, 2);
				 * Date weekMondayDate = cal.getTime(); pstmt.setDate(2,new
				 * java.sql.Date(weekMondayDate.getTime())); int
				 * insOrgRgWeeklytansRows = pstmt.executeUpdate();
				 * logger.info(&quot;total rows = &quot;+insOrgRgWeeklytansRows+&quot;
				 * data inserted into st_rg_org_weekly_tx query : &quot;+pstmt);
				 * pstmt.close();
				 */
				// generate the auto password
<span class="nc" id="L1683">				String autoPass = null;</span>

<span class="nc bnc" id="L1685" title="All 2 branches missed.">				if (&quot;integer&quot;.equalsIgnoreCase(((String) LMSUtility.sc.getAttribute(&quot;RETAILER_PASS&quot;))</span>
						.trim())) {
<span class="nc" id="L1687">					autoPass = AutoGenerate.autoPasswordInt() + &quot;&quot;;</span>
				} else {
<span class="nc" id="L1689">					autoPass = AutoGenerate.autoPassword();</span>
				}
<span class="nc" id="L1691">				logger.info(&quot;Password Generated: &quot; + autoPass);</span>
				// insert data into st_lms_user_master table
<span class="nc" id="L1693">				String userReg = QueryManager.insertST3AgentDetails();</span>
<span class="nc" id="L1694">				pstmt = con.prepareStatement(userReg);</span>
<span class="nc" id="L1695">				pstmt.setInt(1, genOrgId);	</span>
<span class="nc" id="L1696">				pstmt.setInt(2, roleId);</span>
<span class="nc" id="L1697">				pstmt.setString(3, orgUserData.getOrgType());</span>
<span class="nc" id="L1698">				pstmt.setString(4, &quot;1&quot;);</span>
<span class="nc" id="L1699">				pstmt.setString(5, orgUserData.getUserName().trim()</span>
						.toLowerCase());
<span class="nc" id="L1701">				pstmt.setString(6, MD5Encoder.encode(autoPass));</span>
<span class="nc" id="L1702">				pstmt.setString(7, orgUserData.getStatus());</span>
<span class="nc" id="L1703">				pstmt.setString(8, orgUserData.getSecQues());</span>
<span class="nc" id="L1704">				pstmt.setString(9, orgUserData.getSecAns());</span>
<span class="nc" id="L1705">				pstmt.setTimestamp(10, new java.sql.Timestamp(new Date()</span>
						.getTime()));
<span class="nc" id="L1707">				pstmt.setString(11, &quot;Y&quot;);</span>
<span class="nc" id="L1708">				pstmt.setInt(12, userInfoBean.getUserId());</span>
<span class="nc" id="L1709">				pstmt.setInt(13, orgUserData.getRegisterById());</span>
<span class="nc bnc" id="L1710" title="All 2 branches missed.">				if(orgUserData.getTpUserId() != null){</span>
<span class="nc" id="L1711">					pstmt.setString(14, orgUserData.getTpUserId());</span>
				}else{
<span class="nc" id="L1713">					pstmt.setString(14, null);</span>
				}
<span class="nc" id="L1715">				pstmt.executeUpdate();</span>
<span class="nc" id="L1716">				logger.info(&quot;user type::&quot;+userInfoBean.getUserType());</span>
<span class="nc" id="L1717">				logger.info(&quot;bo user created query : &quot; + pstmt);</span>

				// get the generated user_id
<span class="nc" id="L1720">				rs = pstmt.getGeneratedKeys();</span>
<span class="nc bnc" id="L1721" title="All 2 branches missed.">				if (rs.next()) {</span>
<span class="nc" id="L1722">					int userId = rs.getInt(1);</span>
<span class="nc" id="L1723">					logger.info(&quot;bo user created and user id : &quot;</span>
							+ userId);

					// insert data into st_lms_user_contact_details
<span class="nc" id="L1727">					String insertContactDetail = QueryManager</span>
							.insertST3ContactsDetails();
<span class="nc" id="L1729">					pstmt = con.prepareStatement(insertContactDetail);</span>
<span class="nc" id="L1730">					pstmt.setInt(1, userId);</span>
<span class="nc" id="L1731">					pstmt.setString(2, orgUserData.getFirstName());</span>
<span class="nc" id="L1732">					pstmt.setString(3, orgUserData.getLastName());</span>
<span class="nc" id="L1733">					pstmt.setString(4, orgUserData.getEmail());</span>
<span class="nc" id="L1734">					pstmt.setLong(5, orgUserData.getPhone());</span>
<span class="nc" id="L1735">					pstmt.setString(6, orgUserData.getIdType());</span>
<span class="nc" id="L1736">					pstmt.setString(7, orgUserData.getIdNo());</span>
<span class="nc" id="L1737">					pstmt.setLong(8, orgUserData.getMobile());</span>
<span class="nc" id="L1738">					int contactDetailRows = pstmt.executeUpdate();</span>
<span class="nc" id="L1739">					logger.info(&quot;total rows update in st_lms_user_contact_details table == &quot;</span>
									+ contactDetailRows + &quot; pstmt : &quot; + pstmt);

					// insert password details into st_password_history table
<span class="nc" id="L1743">					String passwordDetails = QueryManager</span>
							.insertST3PasswordDetails();
<span class="nc" id="L1745">					pstmt = con.prepareStatement(passwordDetails);</span>
<span class="nc" id="L1746">					pstmt.setInt(1, userId);</span>
<span class="nc" id="L1747">					pstmt.setString(2, MD5Encoder.encode(autoPass));</span>
<span class="nc" id="L1748">					int passHistoryRows = pstmt.executeUpdate();</span>
<span class="nc" id="L1749">					logger.info(&quot;total rows update in passHistory table == &quot;</span>
									+ passHistoryRows);
<span class="nc" id="L1751">					pstmt.close();</span>

					//	Insert Data In st_lms_user_ip_time_mapping Table.
<span class="nc" id="L1754">					LoginTimeIPValidationHelper loginTimeIPValidationHelper = new LoginTimeIPValidationHelper();</span>
<span class="nc" id="L1755">					loginTimeIPValidationHelper.insertUserTimeLimitData(userId, con);</span>

					// insert organization history into
					// st_lms_organization_master_history table
					//UserInfoBean loginUserBean = (UserInfoBean)ServletActionContext.getRequest().getSession().getAttribute(&quot;USER_INFO&quot;);
					/*String insertOrgHistory = QueryManager
							.insertST3OrganizationHistory()
							+ &quot; values( &quot;
							+ userInfoBean.getUserId()
							+ &quot;, &quot;
							+ genOrgId
							+ &quot;, '&quot;
							+ orgUserData.getAddrLine1()
							+ &quot;', '&quot;
							+ orgUserData.getAddrLine2()
							+ &quot;', '&quot;
							+ orgUserData.getDivision()
							+ &quot;', '&quot;
							+ orgUserData.getArea()
							+ &quot;', '&quot;
							+ orgUserData.getCity()
							+ &quot;', &quot;
							+ orgUserData.getPin()
							+ &quot;, &quot;
							+ orgUserData.getCreditLimit()
							+ &quot;, &quot;
							+ orgUserData.getSecurity()
							+ &quot;,'ACTIVE_MANUAL_&quot;+loginType+&quot;'&quot;
							+ &quot;,'New Retailer Organization created','&quot;
							+ orgUserData.getStatusorg()
							+ &quot;',' &quot;
							+ new java.sql.Timestamp(new Date().getTime()).toString()
							+ &quot;','&quot;
							+orgUserData.getAutoScrap()
							+ &quot;','&quot;
							+ orgUserData.getReconReportType()
							+ &quot;'&quot;
							+ &quot;)&quot;;
					stmt = con.prepareStatement(insertOrgHistory);
					int historyRows = stmt.executeUpdate();
					logger.info(historyRows
							+ &quot; rows updated and Query to update history :: &quot;
							+ insertOrgHistory);*/

					// insert into service role mapping for organization
<span class="nc" id="L1800">					String serRole = &quot;insert into st_lms_service_role_mapping (role_id,organization_id,id,status) values &quot;;</span>
<span class="nc" id="L1801">					int id[] = orgUserData.getId();</span>
<span class="nc" id="L1802">					String status[] = orgUserData.getStatusTable();</span>
<span class="nc" id="L1803">					StringBuilder values = new StringBuilder();</span>
<span class="nc bnc" id="L1804" title="All 2 branches missed.">					for (int i = 0; i &lt; id.length; i++) {</span>
<span class="nc" id="L1805">						values.append(&quot;(&quot; + roleId + &quot;,&quot; + genOrgId + &quot;,&quot;</span>
								+ id[i] + &quot;,'&quot; + (status[i].split(&quot;-&quot;))[0]
								+ &quot;'),&quot;);
					}
<span class="nc" id="L1809">					serRole = serRole</span>
							+ values.substring(0, values.length() - 1);
<span class="nc" id="L1811">					logger.info(&quot;Service Role entry-----&quot; + serRole);</span>
<span class="nc" id="L1812">					pstmt = con.prepareStatement(serRole);</span>
<span class="nc" id="L1813">					pstmt.executeUpdate();</span>

					// insert into st_user_priv_master
					/*
					 * String insertUserPrivQuery=&quot;insert into user_priv_master
					 * select &quot;+userId+&quot;,&quot;+roleId+&quot;, aa.pid, bb.status from
					 * role_privl_mapping aa, priviledge_rep bb where aa.pid =
					 * bb.pid and aa.role_id = &quot;+roleId; pstmt =
					 * con.prepareStatement(insertUserPrivQuery); int
					 * userPrivMasterRows = pstmt.executeUpdate();
					 * logger.info(&quot;total rows = &quot;+userPrivMasterRows+&quot;
					 * data inserted into st_user_priv_master query : &quot;+pstmt);
					 */
					
					// Insertion into st_dg_last_sold_ticket
<span class="nc" id="L1828">					PreparedStatement addRetOrgQry = con.prepareStatement(&quot;insert into st_dg_last_sold_ticket(ret_org_id,terminal_ticket_number,web_ticket_number,terminal_ticket_status,web_ticket_status) values(?,0,0,null,null)&quot;);</span>
<span class="nc" id="L1829">					addRetOrgQry.setInt(1, genOrgId);</span>
<span class="nc" id="L1830">					logger.info(&quot;addRetOrgQry:&quot; + addRetOrgQry);</span>
					
<span class="nc" id="L1832">					addRetOrgQry.executeUpdate();</span>
					
					//--- Insertion of Organization Id in CS's 'Last Sale Txn Table'
<span class="nc" id="L1835">					PreparedStatement lastTxnPstmt = con.prepareStatement(&quot;insert into st_lms_last_sale_transaction values(?,0,0,0)&quot;);</span>
<span class="nc" id="L1836">					lastTxnPstmt.setInt(1, genOrgId);</span>
<span class="nc" id="L1837">					logger.info(&quot;lastTxnQuery:&quot; + lastTxnPstmt);</span>
					
<span class="nc" id="L1839">					lastTxnPstmt.executeUpdate();</span>
					//---
					
<span class="nc" id="L1842">					String insertUserPriv = null;</span>
<span class="nc" id="L1843">					String privStatus = null;</span>
<span class="nc" id="L1844">					String tableName = null;</span>
<span class="nc bnc" id="L1845" title="All 2 branches missed.">					for (int i = 0; i &lt; id.length; i++) {</span>
<span class="nc" id="L1846">						privStatus = status[i].split(&quot;-&quot;)[0];</span>
<span class="nc" id="L1847">						tableName = status[i].split(&quot;-&quot;)[1];</span>
<span class="nc bnc" id="L1848" title="All 2 branches missed.">						if (privStatus.equals(&quot;ACTIVE&quot;)) {</span>
<span class="nc" id="L1849">							privStatus = &quot;rpm.status&quot;;</span>
						} else {
<span class="nc" id="L1851">							privStatus = &quot;'INACTIVE'&quot;;</span>
						}
<span class="nc" id="L1853">						insertUserPriv = &quot;insert into st_lms_user_priv_mapping (priv_id ,user_id , role_id, service_mapping_id, status) select &quot;</span>
								+ &quot;  distinct(rpm.priv_id),&quot;
								+ userId
								+ &quot;,&quot;
								+ roleId
								+ &quot;,rpm.service_mapping_id, &quot;
								+ privStatus
								+ &quot; from st_lms_role_priv_mapping rpm, &quot;
								+ tableName
								+ &quot; pr  where rpm.role_id = &quot;
								+ roleId
								+ &quot; and rpm.priv_id = pr.priv_id and service_mapping_id=&quot;
								+ id[i] + &quot;&quot;;
<span class="nc" id="L1866">						pstmt = con.prepareStatement(insertUserPriv);</span>
<span class="nc" id="L1867">						pstmt.executeUpdate();</span>
					}

					// send mail to user is commented now because retailer is
					// not online
<span class="nc bnc" id="L1872" title="All 2 branches missed.">					if (orgUserData.getOrgType().equals(&quot;AGENT&quot;)) {</span>
						// assign privilege to RETAILER
<span class="nc" id="L1874">						assignEmailPriviledges(userId,</span>
								orgUserData.getOrgType(), orgUserData
										.getEmail(), orgUserData
										.getEmailPrivId(), con);

					}

					// added for offline sale
<span class="nc" id="L1882">					String isRetailerOffline = (String) LMSUtility.sc.getAttribute(&quot;RET_OFFLINE&quot;);</span>
<span class="nc" id="L1883">					String isLoginBind = (String) LMSUtility.sc.getAttribute(&quot;LOGIN_BINDING&quot;);</span>
<span class="nc bnc" id="L1884" title="All 2 branches missed.">					boolean  isSimBind =&quot;YES&quot;.equalsIgnoreCase((String) LMSUtility.sc.getAttribute(&quot;sim_binding&quot;))?true:false;</span>
<span class="nc" id="L1885">					int retOfflineId = 0;</span>
<span class="nc" id="L1886">					StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L1887">					String address = null;</span>
<span class="nc" id="L1888">					String latLon = null;</span>
					//if(&quot;YES&quot;.equalsIgnoreCase(isLoginBind.trim())){
<span class="nc bnc" id="L1890" title="All 2 branches missed.">						if (!&quot;YES&quot;.equalsIgnoreCase(isRetailerOffline.trim())) {</span>
<span class="nc" id="L1891">							orgUserData.setIsOffLine(&quot;NO&quot;);</span>
						}
<span class="nc" id="L1893">						DrawGameOfflineHelper helper = new DrawGameOfflineHelper();</span>
<span class="nc bnc" id="L1894" title="All 2 branches missed.">						if(orgUserData.getModelName()==null){</span>
<span class="nc" id="L1895">							orgUserData.setModelName(&quot;-1&quot;);</span>
<span class="nc" id="L1896">							orgUserData.setTerminalId(&quot;-1&quot;);</span>
						}
<span class="nc" id="L1898">						address = sb.append(orgUserData.getAddrLine1()).append(&quot;,&quot;).append(orgUserData.getAddrLine2()).append(&quot; &quot;).append(orgUserData.getCity()).append(&quot; &quot;).append(orgUserData.getCountry()).toString();</span>
<span class="nc" id="L1899">						latLon = CommonFunctionsHelper.getLongitudeLatitude(address);</span>
<span class="nc" id="L1900">						retOfflineId = helper.saveOfflineRetData(userId,genOrgId, orgUserData.getIsOffLine(),orgUserData.getModelName(),orgUserData.getTerminalId(), con,latLon,orgUserData.getCity(),isLoginBind,orgUserData.getSim(),orgUserData.getSimModelName(),isSimBind);</span>
<span class="nc bnc" id="L1901" title="All 2 branches missed.">						if (retOfflineId &lt; 1) {</span>
<span class="nc" id="L1902">							throw new LMSException(textProvider.getText(&quot;error.usr.not.create&quot;));</span>
						}
					//}
					// rg calling
					//ResponsibleGaming.rgInsertion(userId, genOrgId);
<span class="nc" id="L1907">					ResponsibleGaming.rgInsertion(userId, genOrgId ,con);</span>
                    
					//here insert the entry into the st_ola_org_affiliate_mapping tabla\le
<span class="nc bnc" id="L1910" title="All 2 branches missed.">					if((LMSFilterDispatcher.getIsOLA()).equalsIgnoreCase(&quot;YES&quot;))</span>
					{
<span class="nc" id="L1912">					pstmt = con.prepareStatement(&quot;insert into st_ola_org_affiliate_mapping(organization_id, ref_user_id) values(?,?)&quot;);</span>
<span class="nc" id="L1913">					pstmt.setInt(1, genOrgId);</span>
<span class="nc" id="L1914">					pstmt.setString(2, orgUserData.getUserName());</span>
<span class="nc" id="L1915">					pstmt.executeUpdate();</span>
					//con.commit();
					}
					
<span class="nc" id="L1919">					int noOfExpDays = Integer.parseInt(com.skilrock.lms.common.Utility.getPropertyValue(&quot;USER_MAPPING_ID_EXPIRY&quot;).trim());</span>
<span class="nc" id="L1920">					String thirdPartyAddress = com.skilrock.lms.common.Utility.getPropertyValue(&quot;ADD_OF_THIRD_PARTY_GEN_MAPPING_ID&quot;).trim();</span>
					
<span class="nc" id="L1922">					String systemUserName = com.skilrock.lms.common.Utility.getPropertyValue(&quot;SYSTEM_AUTHENTICATION_USERNAME&quot;).trim();</span>
<span class="nc" id="L1923">					String systemUserPassword = com.skilrock.lms.common.Utility.getPropertyValue(&quot;SYSTEM_AUTHENTICATION_PASSWORD&quot;).trim();</span>
					
<span class="nc" id="L1925">					boolean isGenPlaceLMS = &quot;true&quot;.equalsIgnoreCase(com.skilrock.lms.common.Utility.getPropertyValue(&quot;MAPPING_ID_GEN_BY_THIRD_PARTY&quot;).trim());</span>
					
<span class="nc" id="L1927">					UserIdMappingBean userIdMappingBean = new UserIdMappingBean();</span>
<span class="nc" id="L1928">					LmsUserIdMappingRequestBean lmsUserIdMappingRequestBean = null;</span>
<span class="nc bnc" id="L1929" title="All 2 branches missed.">					if (isGenPlaceLMS) {</span>
<span class="nc" id="L1930">						LMSServicesClient client = new LMSServicesClient(thirdPartyAddress);</span>
<span class="nc" id="L1931">						LMSServicesPortType service = client.getLMSServicesHttpPort();</span>
<span class="nc" id="L1932">						lmsUserIdMappingRequestBean = new LmsUserIdMappingRequestBean();</span>
<span class="nc" id="L1933">						lmsUserIdMappingRequestBean.setSystemUserName(systemUserName);</span>
<span class="nc" id="L1934">						lmsUserIdMappingRequestBean.setSystemUserPassword(systemUserPassword);</span>
<span class="nc" id="L1935">						lmsUserIdMappingRequestBean.setAll(false);</span>
<span class="nc" id="L1936">						lmsUserIdMappingRequestBean.setSpecific(true);</span>
<span class="nc" id="L1937">						lmsUserIdMappingRequestBean.setUserId(userId);</span>
<span class="nc" id="L1938">						lmsUserIdMappingRequestBean.setActivity(&quot;RET_REG&quot;);</span>
<span class="nc" id="L1939">						lmsUserIdMappingRequestBean.setExpiryDays(noOfExpDays); </span>
<span class="nc" id="L1940">						lmsUserIdMappingRequestBean.setDoneByUserId(userInfoBean.getUserOrgId());</span>
<span class="nc" id="L1941">						logger.debug(&quot;Requesting Third Party For Random ID from &quot;+ orgUserData.getUserName() + &quot;With user Id &quot; + userId);</span>
<span class="nc" id="L1942">						LmsUserIdMappingResponseBean lmsUserIdMappingResponseBean = service.getRandomMappingIdFromThirdParty(lmsUserIdMappingRequestBean);</span>
						
<span class="nc bnc" id="L1944" title="All 2 branches missed.">						if(!lmsUserIdMappingResponseBean.isSuccess()){</span>
<span class="nc" id="L1945">							logger.error(&quot;Error from Third Party... throwing exception &quot;);</span>
<span class="nc" id="L1946">							throw new LMSException(); // TEMP</span>
						}
			
<span class="nc" id="L1949">						LmsUserIdMappingRequestBean responseBean = lmsUserIdMappingResponseBean.getLmsUserIdMappingRequestBean();</span>
<span class="nc" id="L1950">						logger.error(&quot;SUCCESS from Third Party... &quot;);</span>
<span class="nc" id="L1951">						logger.error(&quot;SUCCESS from Third Party... RANDOM ID FOR &quot; +responseBean.getUserId());</span>
<span class="nc" id="L1952">						userIdMappingBean.setThirdPartyGeneration(true);</span>
<span class="nc" id="L1953">						userIdMappingBean.setNewGenerationDateTime(responseBean.getNewGenerationDateTime());</span>
<span class="nc" id="L1954">						userIdMappingBean.setNewCodeExpiryDateTime(responseBean.getNewCodeExpiryDateTime());</span>
<span class="nc" id="L1955">						userIdMappingBean.setAdvGenerationDateTime(responseBean.getAdvGenerationDateTime());</span>
<span class="nc" id="L1956">						userIdMappingBean.setAdvCodeExpiryDateTime(responseBean.getAdvCodeExpiryDateTime());</span>
<span class="nc" id="L1957">						userIdMappingBean.setUserMappingIdMap(CommonMethods.prepareHashMapFromAnyTypeMap(responseBean.getUserMappingIdMap()));</span>
<span class="nc" id="L1958">						userIdMappingBean.setAdvUserMappingIdMap(CommonMethods.prepareHashMapFromAnyTypeMap(responseBean.getAdvUserMappingIdMap()));</span>
<span class="nc" id="L1959">					}else{</span>
<span class="nc" id="L1960">						userIdMappingBean.setThirdPartyGeneration(false);</span>
					}
<span class="nc" id="L1962">						userIdMappingBean.setAll(false);</span>
<span class="nc" id="L1963">						userIdMappingBean.setSpecific(true);</span>
<span class="nc" id="L1964">						userIdMappingBean.setUserId(userId);</span>
<span class="nc" id="L1965">						userIdMappingBean.setActivity(&quot;RET_REG&quot;);</span>
<span class="nc" id="L1966">						userIdMappingBean.setExpiryDays(noOfExpDays); </span>
<span class="nc" id="L1967">						userIdMappingBean.setDoneByUserId(userInfoBean.getUserOrgId());</span>
<span class="nc" id="L1968">						CommonMethods.getUserIdToGenMappindId(userIdMappingBean, con);</span>

						//	Insert Registration Messages
<span class="nc" id="L1971">						MessageInboxDaoImpl.getSingleInstance().addRegistrationMessage(userId, &quot;RETAILER&quot;, &quot;WEB&quot;, con);</span>
<span class="nc" id="L1972">						MessageInboxDaoImpl.getSingleInstance().addRegistrationMessage(userId, &quot;RETAILER&quot;, &quot;TERMINAL&quot;, con);</span>

<span class="nc bnc" id="L1974" title="All 2 branches missed.">						if(&quot;YES&quot;.equalsIgnoreCase(LMSFilterDispatcher.getIsSLE())){</span>
<span class="nc" id="L1975">							ServerStartUpData.updateOrgDataForSLE(&quot;RETAILER&quot; , genOrgId, con);</span>
						}

<span class="nc" id="L1978">						con.commit();</span>

<span class="nc bnc" id="L1980" title="All 2 branches missed.">						if(ServicesBean.isSLE()) {</span>
<span class="nc" id="L1981">							UserDataBean dataBean = UserMgmtController.getInstance().getUserInfo(orgUserData.getUserName().trim());</span>
<span class="nc" id="L1982">							dataBean.setCreatorUserId(userInfoBean.getUserId());</span>
<span class="nc" id="L1983">							NotifySLE notifySLE = new NotifySLE(SLE.Activity.USER_REGISTER, dataBean);</span>
<span class="nc" id="L1984">							notifySLE.start();</span>
						}
						
<span class="nc bnc" id="L1987" title="All 2 branches missed.">					if (ServicesBean.isVS()) {</span>
<span class="nc" id="L1988">						VSRequestBean vsRequestBean = new VSRequestBean(orgUserData.getOrgName(), genOrgId, orgUserData.getUserName(), userId, orgUserData.getUserName());</span>
<span class="nc" id="L1989">						VirtualSportsControllerImpl.Single.INSTANCE.getInstance().registerRetailer(vsRequestBean);</span>
					}

<span class="nc" id="L1992">						logger.info(&quot;retailer registration completed successfully&quot;);</span>
					//now update the comm variance for the new organization
					//add one more entry in the org game data map
					//This is harcoded check for OLA to run independently.
<span class="nc bnc" id="L1996" title="All 2 branches missed.">					if (ServicesBean.isDG()) //</span>
<span class="nc" id="L1997">						Util.orgDataMap.put(genOrgId, ServerStartUpData.getOrgGameData(genOrgId, con, &quot;RETAILER&quot;));</span>
<span class="nc bnc" id="L1998" title="All 2 branches missed.">					if (ServicesBean.isIW())</span>
<span class="nc" id="L1999">						Util.iwOrgDataMap.put(genOrgId, ServerStartUpData.getOrgGameDataIW(genOrgId, con, &quot;RETAILER&quot;));</span>
<span class="nc bnc" id="L2000" title="All 2 branches missed.">					if (ServicesBean.isVS())</span>
<span class="nc" id="L2001">						Util.vsOrgDataMap.put(genOrgId, ServerStartUpData.getOrgGameDataVS(genOrgId, con, &quot;RETAILER&quot;));</span>
					//logger.info(&quot;sale variance after registration: &quot; + Util.getSaleCommVariance(genOrgId,2));
					// send mail to user is commented now because retailer is
					// not online
					//String isRetaileOnline = (String) LMSUtility.sc.getAttribute(&quot;RET_ONLINE&quot;);
<span class="nc" id="L2006">					String isRetaileOnline = orgUserData.getIsRetailerOnline();</span>
<span class="nc" id="L2007">					errorMap.put(&quot;NewPassword&quot;, autoPass);</span>
<span class="nc bnc" id="L2008" title="All 2 branches missed.">					if (&quot;YES&quot;.equalsIgnoreCase(isRetaileOnline.trim())) {</span>
<span class="nc" id="L2009">						String msgFor = textProvider.getText(&quot;error.thank.for.reg.game.sys.login.det.are&quot;);</span>
<span class="nc" id="L2010">						String emailMsgTxt = &quot;&lt;html&gt;&lt;table&gt;&lt;tr&gt;&lt;td&gt;Hi &quot;</span>
								+ orgUserData.getFirstName()
								+ &quot; &quot;
								+ orgUserData.getLastName()
								+ &quot;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&quot;
								+ msgFor
								+ &quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;table&gt;&lt;tr&gt;&lt;td&gt;User Name :: &lt;/td&gt;&lt;td&gt;&quot;
								+ orgUserData.getUserName().trim()
								+ &quot;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;password :: &lt;/td&gt;&lt;td&gt;&quot;
								+ autoPass.toString()
								+ &quot;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;log on &lt;/td&gt;&lt;td&gt;&quot;
								+ LMSFilterDispatcher.webLink + &quot;/&quot;
								+ LMSFilterDispatcher.mailProjName
								+ &quot;/&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/html&gt;&quot;;
<span class="nc" id="L2024">						MailSend mailSend = new MailSend(</span>
								orgUserData.getEmail(), emailMsgTxt);
<span class="nc" id="L2026">						mailSend.setDaemon(true);</span>
<span class="nc" id="L2027">						mailSend.start();</span>
						// MailSend.sendMailToUser(email, autoPass,
						// userName.trim(), firstName, lastName, msgFor);
<span class="nc" id="L2030">						logger.info(&quot;mail sent after commit&quot;);</span>
					}
<span class="nc" id="L2032">					return errorMap;</span>
				} else {
<span class="nc" id="L2034">					logger.info(&quot;User is not created &quot;);</span>
<span class="nc" id="L2035">					throw new LMSException(textProvider.getText(&quot;error.usr.not.create&quot;));</span>
				}
			} else {
<span class="nc" id="L2038">				logger.info(&quot;organization is not created &quot;);</span>
<span class="nc" id="L2039">				throw new LMSException(textProvider.getText(&quot;error.org.not.create&quot;));</span>
			}
<span class="nc" id="L2041">		} catch (SQLException se) {</span>
<span class="nc" id="L2042">			se.printStackTrace();</span>
<span class="nc" id="L2043">			throw new LMSException(&quot;sql exception&quot;, se);</span>
<span class="nc" id="L2044">		}catch (Exception se) {</span>
<span class="nc" id="L2045">			se.printStackTrace();</span>
<span class="nc" id="L2046">			throw new LMSException(&quot;exception&quot;, se);</span>
		} finally {
<span class="nc" id="L2048">			DBConnect.closeCon(con);</span>

			try {
<span class="nc bnc" id="L2051" title="All 8 branches missed.">					if(con!=null){</span>
<span class="nc" id="L2052">						con.close();</span>
					}
<span class="nc bnc" id="L2054" title="All 8 branches missed.">					if(rs!=null){</span>
<span class="nc" id="L2055">						rs.close();</span>
					}
<span class="nc bnc" id="L2057" title="All 8 branches missed.">					if(pstmt!=null){</span>
<span class="nc" id="L2058">						pstmt.close();</span>
					}
<span class="nc bnc" id="L2060" title="All 8 branches missed.">					if(stmt!=null){</span>
<span class="nc" id="L2061">						stmt.close();</span>
					}
<span class="nc" id="L2063">				} catch (Exception e) {</span>
<span class="nc" id="L2064">					e.printStackTrace();</span>
<span class="nc" id="L2065">				}</span>

			//	Licensing Server Validation
<span class="nc" id="L2068">			LSControllerImpl.getInstance().clientValidation();</span>
		}
	}

	// Added by Umesh

	public Map&lt;Integer, String&gt; getMailingReportTitle(String userType) {
<span class="nc" id="L2075">		Map&lt;Integer, String&gt; mailReportTitle = new TreeMap&lt;Integer, String&gt;();</span>
<span class="nc" id="L2076">		Connection con = DBConnect.getConnection();</span>
		try {
<span class="nc" id="L2078">			Statement stmt = con.createStatement();</span>
<span class="nc" id="L2079">			String mailReportTitleQuery = &quot;select email_pid, priv_title from st_lms_report_email_priviledge_rep where priv_owner = '&quot;</span>
					+ userType + &quot;' and status ='ACTIVE'&quot;;
<span class="nc" id="L2081">			ResultSet rs = stmt.executeQuery(mailReportTitleQuery);</span>
<span class="nc bnc" id="L2082" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L2083">				String privTitle = rs.getString(&quot;priv_title&quot;);</span>
<span class="nc" id="L2084">				int emailPid = rs.getInt(&quot;email_pid&quot;);</span>
<span class="nc" id="L2085">				mailReportTitle.put(emailPid, privTitle);</span>
<span class="nc" id="L2086">			}</span>
<span class="nc" id="L2087">			rs.close();</span>
<span class="nc" id="L2088">			stmt.close();</span>
<span class="nc" id="L2089">		} catch (SQLException se) {</span>
<span class="nc" id="L2090">			se.printStackTrace();</span>
<span class="nc" id="L2091">		} catch (Exception e) {</span>
<span class="nc" id="L2092">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L2094">			try {</span>
<span class="nc bnc" id="L2095" title="All 8 branches missed.">				if (con != null) {</span>
<span class="nc" id="L2096">					con.close();</span>
				}
<span class="nc" id="L2098">			} catch (SQLException se) {</span>
<span class="nc" id="L2099">				se.printStackTrace();</span>
<span class="nc" id="L2100">			}</span>
<span class="nc" id="L2101">		}</span>

<span class="nc" id="L2103">		return mailReportTitle;</span>
	}

	public static Map&lt;String, String&gt; verifyOrgName(String orgName, String userName,
			Connection conn) throws LMSException {
<span class="nc" id="L2108">		Connection con = conn;</span>
<span class="nc" id="L2109">		Map&lt;String, String&gt; errorMap = new TreeMap&lt;String, String&gt;();</span>
		try {
<span class="nc" id="L2111">			Statement stmt = con.createStatement();</span>
<span class="nc" id="L2112">			String organizationName = QueryManager.getST3OrgName()</span>
					+ &quot; where name='&quot; + orgName.trim() + &quot;'&quot;;
<span class="nc" id="L2114">            logger.info(&quot;VERIFY Organization Name::&quot;+organizationName);</span>
<span class="nc" id="L2115">			ResultSet res = stmt.executeQuery(organizationName);</span>
<span class="nc bnc" id="L2116" title="All 4 branches missed.">			if (&quot;admin&quot;.equalsIgnoreCase(orgName) || res.next()) {</span>
<span class="nc" id="L2117">				logger.info(&quot;Organization Name Already exits !!&quot;);</span>
<span class="nc" id="L2118">				errorMap.put(&quot;orgError&quot;, textProvider.getText(&quot;error.org.name.already.exist&quot;)+&quot; !!&quot;);</span>
<span class="nc" id="L2119">				errorMap.put(&quot;returnTypeError&quot;, &quot;input&quot;);</span>
			} else {
<span class="nc" id="L2121">				errorMap.put(&quot;orgError&quot;, &quot;A&quot;);</span>
			}

			// check is 'user_name' already exists in st_lms_user_master table
<span class="nc" id="L2125">			String getUsersName = QueryManager.getST3UserName()</span>
					+ &quot;where user_name= '&quot; + userName.trim() + &quot;'&quot;;
<span class="nc" id="L2127">			res = stmt.executeQuery(getUsersName);</span>
<span class="nc" id="L2128">			logger.info(&quot;CHECK USER NAME::&quot;+getUsersName);</span>
<span class="nc bnc" id="L2129" title="All 4 branches missed.">			if (&quot;admin&quot;.equalsIgnoreCase(userName) || res.next()) {</span>
<span class="nc" id="L2130">				logger.info(&quot;user already exists !!&quot;);</span>
<span class="nc" id="L2131">				errorMap.put(&quot;userError&quot;, textProvider.getText(&quot;error.uname.already.exist&quot;)+&quot; !!&quot;);</span>
<span class="nc" id="L2132">				errorMap.put(&quot;returnTypeError&quot;, &quot;input&quot;);</span>
			} else {
<span class="nc" id="L2134">				errorMap.put(&quot;userError&quot;, &quot;A&quot;);</span>
			}
<span class="nc" id="L2136">			return errorMap;</span>
<span class="nc" id="L2137">		} catch (SQLException se) {</span>
<span class="nc" id="L2138">			se.printStackTrace();</span>
<span class="nc" id="L2139">			throw new LMSException(se);</span>
		}
	}
/**
 * Added to set userInfoBean data for organization_type
 * @param organization_type
 * @param userInfoBean
 * @return
 */
	public UserInfoBean changeUserBean(String organization_type,UserInfoBean userInfoBean) {
<span class="nc" id="L2149">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L2150">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L2151">		ResultSet rs = null;</span>
<span class="nc" id="L2152">		String selectQuery = null;</span>
	try {
<span class="nc" id="L2154">			logger.info(&quot;changing user bean for admin to &quot;+organization_type);</span>
<span class="nc" id="L2155">			selectQuery = &quot;select  user_id,organization_id from st_lms_user_master um where organization_type=? and isrolehead='Y' limit 1&quot;;</span>
<span class="nc" id="L2156">			pstmt = con.prepareStatement(selectQuery);</span>
<span class="nc" id="L2157">			pstmt.setString(1,organization_type);</span>
<span class="nc" id="L2158">			rs = pstmt.executeQuery();</span>
<span class="nc" id="L2159">			logger.info(&quot;changing query&quot;+pstmt);</span>
<span class="nc bnc" id="L2160" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L2161">				userInfoBean.setUserId(rs.getInt(&quot;user_id&quot;));</span>
<span class="nc" id="L2162">				userInfoBean.setUserOrgId(rs.getInt(&quot;organization_id&quot;));</span>
<span class="nc" id="L2163">				userInfoBean.setUserType(organization_type);</span>
			}

<span class="nc" id="L2166">		} catch (Exception e) {</span>
<span class="nc" id="L2167">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L2169">			try {</span>
<span class="nc" id="L2170">				con.close();</span>
<span class="nc" id="L2171">			} catch (SQLException e) {</span>
				// TODO Auto-generated catch block
<span class="nc" id="L2173">				e.printStackTrace();</span>
<span class="nc" id="L2174">			}</span>
<span class="nc" id="L2175">		}</span>

<span class="nc" id="L2177">		return userInfoBean;</span>
	}
	
	private static String generateAccessCodeForOrg(String stateCode,int newOrgNumber,String userName,String orgType,Connection con,String countryDep) throws LMSException{
<span class="nc" id="L2181">			PreparedStatement pstmt =null;</span>
<span class="nc" id="L2182">			PreparedStatement pstmt1 =null;</span>
<span class="nc" id="L2183">			ResultSet rs =null;</span>
		try{

<span class="nc" id="L2186">			String generatedCode =&quot;&quot;;</span>
<span class="nc" id="L2187">			logger.info(&quot;Inside Code Generation stateCode &quot; + stateCode+&quot; userName&quot;+userName+&quot;orgType&quot;+orgType+&quot;countryDep &quot;+countryDep+&quot;newOrgNumber &quot;+newOrgNumber);		</span>
<span class="nc bnc" id="L2188" title="All 4 branches missed.">			if(&quot;ZIMBABWE&quot;.equalsIgnoreCase(countryDep)||&quot;NIGERIA&quot;.equalsIgnoreCase(countryDep)){</span>
				
<span class="nc bnc" id="L2190" title="All 2 branches missed.">				if(&quot;AGENT&quot;.equalsIgnoreCase(orgType)){</span>
<span class="nc" id="L2191">					generatedCode = userName;</span>
<span class="nc bnc" id="L2192" title="All 2 branches missed.">					if(userName.matches(&quot;.*[0-9].*&quot;)){</span>
<span class="nc" id="L2193">						throw new LMSException(textProvider.getText(&quot;error.inv.agt.uname&quot;));</span>
					}
<span class="nc" id="L2195">					pstmt=con.prepareStatement(&quot;update st_lms_state_master set no_agt_registered=&quot;+newOrgNumber+ &quot; where state_code='&quot;+stateCode+&quot;'&quot;);</span>
<span class="nc" id="L2196">					int update =pstmt.executeUpdate();</span>
<span class="nc bnc" id="L2197" title="All 2 branches missed.">					if(update==0){</span>
<span class="nc" id="L2198">						logger.info(&quot;no_agt_registered not updated:&quot; + pstmt);</span>
<span class="nc" id="L2199">						throw new LMSException(textProvider.getText(&quot;error.no.agt.reg.not.update&quot;));</span>
					}
<span class="nc bnc" id="L2201" title="All 2 branches missed.">				}else if(&quot;RETAILER&quot;.equalsIgnoreCase(orgType)){</span>
<span class="nc" id="L2202">					pstmt1 = con.prepareStatement(&quot;select count(organization_id) nofRet from st_lms_organization_master where parent_id=(select organization_id from st_lms_user_master where user_name='&quot;+userName+&quot;')&quot;);	</span>
<span class="nc" id="L2203">					rs = pstmt1.executeQuery();</span>
<span class="nc" id="L2204">					int retCounter = 0;</span>
<span class="nc bnc" id="L2205" title="All 2 branches missed.">					if(rs.next()){</span>
<span class="nc" id="L2206">						retCounter=rs.getInt(&quot;nofRet&quot;);</span>
					}
					
<span class="nc" id="L2209">					generatedCode =userName+(retCounter+1);</span>
<span class="nc" id="L2210">					pstmt=con.prepareStatement(&quot;update st_lms_state_master set no_ret_registered=&quot;+newOrgNumber+ &quot; where state_code='&quot;+stateCode+&quot;'&quot;);</span>
<span class="nc" id="L2211">					int update =pstmt.executeUpdate();</span>
<span class="nc bnc" id="L2212" title="All 2 branches missed.">					if(update ==0){</span>
<span class="nc" id="L2213">						logger.info(&quot;no_ret_registered not updated:&quot; + pstmt);</span>
<span class="nc" id="L2214">						throw new LMSException(textProvider.getText(&quot;error.no.ret.reg.not.update&quot;));</span>
						
					}
					
<span class="nc" id="L2218">				}else {</span>
<span class="nc" id="L2219">					logger.info(&quot;Invalid Org Type &quot; + orgType);</span>
<span class="nc" id="L2220">					throw new LMSException(textProvider.getText(&quot;error.org.type.not.pass.proper.during.access.code.create&quot;));</span>
					
				}
				

				
			}
<span class="nc bnc" id="L2227" title="All 6 branches missed.">			else if(&quot;GHANA&quot;.equalsIgnoreCase(countryDep)||&quot;BENIN&quot;.equalsIgnoreCase(countryDep) || &quot;SAFARIBET&quot;.equalsIgnoreCase(countryDep)){</span>
<span class="nc" id="L2228">					generatedCode =newOrgNumber+&quot;&quot;;</span>
<span class="nc bnc" id="L2229" title="All 2 branches missed.">				if(&quot;AGENT&quot;.equalsIgnoreCase(orgType)){</span>
				    //4 digit in case of agt
					
<span class="nc bnc" id="L2232" title="All 2 branches missed.">					if(newOrgNumber&gt;9999){</span>
<span class="nc" id="L2233">						logger.info(&quot;Agent Registration Limit Reached&quot; + newOrgNumber);</span>
<span class="nc" id="L2234">						throw new LMSException(textProvider.getText(&quot;error.agt.reg.limit.reach&quot;));</span>
					}
<span class="nc bnc" id="L2236" title="All 2 branches missed.">					while(generatedCode.length()&lt; 4){</span>
<span class="nc" id="L2237">								generatedCode = &quot;0&quot; + generatedCode; </span>
								}
							
<span class="nc" id="L2240">						generatedCode = stateCode + generatedCode;</span>
<span class="nc" id="L2241">						pstmt=con.prepareStatement(&quot;update st_lms_state_master set no_agt_registered=&quot;+newOrgNumber+ &quot; where state_code='&quot;+stateCode+&quot;'&quot;);</span>
<span class="nc" id="L2242">						int update =pstmt.executeUpdate();</span>
<span class="nc bnc" id="L2243" title="All 2 branches missed.">						if(update==0){</span>
<span class="nc" id="L2244">							logger.info(&quot;no_agt_registered not updated:&quot; + pstmt);</span>
<span class="nc" id="L2245">							throw new LMSException(textProvider.getText(&quot;error.no.agt.reg.not.update&quot;));</span>
						}
					//  stmt.executeUpdate(&quot;update st_lms_state_master set no_agt_registered=&quot;+newOrgNumber+ &quot; where state_code='&quot;+stateCode+&quot;'&quot;);
					 			 
<span class="nc" id="L2249">					}</span>
<span class="nc bnc" id="L2250" title="All 2 branches missed.">					else if(&quot;RETAILER&quot;.equalsIgnoreCase(orgType)){</span>
<span class="nc bnc" id="L2251" title="All 2 branches missed.">						if(newOrgNumber&gt;99999){</span>
<span class="nc" id="L2252">							logger.info(&quot;Retailer Registration Limit Reached&quot; + newOrgNumber);</span>
<span class="nc" id="L2253">							throw new LMSException(textProvider.getText(&quot;error.ret.reg.limit.reach&quot;));</span>
						}
						//5 digit in case of retailer
<span class="nc bnc" id="L2256" title="All 2 branches missed.">						while(generatedCode.length()&lt;5){</span>
<span class="nc" id="L2257">							generatedCode = &quot;0&quot; + generatedCode; </span>
						}
<span class="nc" id="L2259">						generatedCode = stateCode + generatedCode;</span>
<span class="nc" id="L2260">						pstmt=con.prepareStatement(&quot;update st_lms_state_master set no_ret_registered=&quot;+newOrgNumber+ &quot; where state_code='&quot;+stateCode+&quot;'&quot;);</span>
<span class="nc" id="L2261">						int update =pstmt.executeUpdate();</span>
<span class="nc bnc" id="L2262" title="All 2 branches missed.">						if(update ==0){</span>
<span class="nc" id="L2263">							logger.info(&quot;no_ret_registered not updated:&quot; + pstmt);</span>
<span class="nc" id="L2264">							throw new LMSException(textProvider.getText(&quot;error.no.ret.reg.not.update&quot;));</span>
							
						}
						//stmt.executeUpdate(&quot;update st_lms_state_master set no_ret_registered=&quot;+newOrgNumber+ &quot; where state_code='&quot;+stateCode+&quot;'&quot;);
<span class="nc" id="L2268">					}			</span>
					else {
						
<span class="nc" id="L2271">						logger.info(&quot;Invalid Org Type &quot; + orgType);</span>
<span class="nc" id="L2272">						throw new LMSException(textProvider.getText(&quot;error.org.type.not.pass.proper.during.access.code.create&quot;));</span>
					}
						
<span class="nc bnc" id="L2275" title="All 6 branches missed.">			}else if(&quot;SIKKIM&quot;.equalsIgnoreCase(countryDep)||&quot;PHILIP&quot;.equalsIgnoreCase(countryDep) || &quot;INDIA&quot;.equalsIgnoreCase(countryDep)){</span>
<span class="nc" id="L2276">					generatedCode =newOrgNumber+&quot;&quot;;</span>
<span class="nc bnc" id="L2277" title="All 2 branches missed.">				if(&quot;AGENT&quot;.equalsIgnoreCase(orgType)){</span>
				    //4 digit in case of agt
					
<span class="nc bnc" id="L2280" title="All 2 branches missed.">					if(newOrgNumber&gt;9999){</span>
<span class="nc" id="L2281">						logger.info(&quot;Agent Registration Limit Reached&quot; + newOrgNumber);</span>
<span class="nc" id="L2282">						throw new LMSException(textProvider.getText(&quot;error.agt.reg.limit.reach&quot;));</span>
					}
<span class="nc bnc" id="L2284" title="All 2 branches missed.">					while(generatedCode.length()&lt; 4){</span>
<span class="nc" id="L2285">								generatedCode = &quot;0&quot; + generatedCode; </span>
								}
							
<span class="nc" id="L2288">						generatedCode = stateCode + generatedCode;</span>
<span class="nc" id="L2289">						pstmt=con.prepareStatement(&quot;update st_lms_state_master set no_agt_registered=&quot;+newOrgNumber+ &quot; where state_code='&quot;+stateCode+&quot;'&quot;);</span>
<span class="nc" id="L2290">						int update =pstmt.executeUpdate();</span>
<span class="nc bnc" id="L2291" title="All 2 branches missed.">						if(update==0){</span>
<span class="nc" id="L2292">							logger.info(&quot;no_agt_registered not updated:&quot; + pstmt);</span>
<span class="nc" id="L2293">							throw new LMSException(textProvider.getText(&quot;error.no.agt.reg.not.update&quot;));</span>
						}
					//  stmt.executeUpdate(&quot;update st_lms_state_master set no_agt_registered=&quot;+newOrgNumber+ &quot; where state_code='&quot;+stateCode+&quot;'&quot;);
					 			 
<span class="nc" id="L2297">					}</span>
<span class="nc bnc" id="L2298" title="All 2 branches missed.">					else if(&quot;RETAILER&quot;.equalsIgnoreCase(orgType)){</span>
<span class="nc bnc" id="L2299" title="All 2 branches missed.">						if(newOrgNumber&gt;99999){</span>
<span class="nc" id="L2300">							logger.info(&quot;Retailer Registration Limit Reached&quot; + newOrgNumber);</span>
<span class="nc" id="L2301">							throw new LMSException(textProvider.getText(&quot;error.ret.reg.limit.reach&quot;));</span>
						}
						//5 digit in case of retailer
<span class="nc bnc" id="L2304" title="All 2 branches missed.">						while(generatedCode.length()&lt;5){</span>
<span class="nc" id="L2305">							generatedCode = &quot;0&quot; + generatedCode; </span>
						}
<span class="nc" id="L2307">						generatedCode = stateCode + generatedCode;</span>
<span class="nc" id="L2308">						pstmt=con.prepareStatement(&quot;update st_lms_state_master set no_ret_registered=&quot;+newOrgNumber+ &quot; where state_code='&quot;+stateCode+&quot;'&quot;);</span>
<span class="nc" id="L2309">						int update =pstmt.executeUpdate();</span>
<span class="nc bnc" id="L2310" title="All 2 branches missed.">						if(update ==0){</span>
<span class="nc" id="L2311">							logger.info(&quot;no_ret_registered not updated:&quot; + pstmt);</span>
<span class="nc" id="L2312">							throw new LMSException(textProvider.getText(&quot;error.no.ret.reg.not.update&quot;));</span>
							
						}
						//stmt.executeUpdate(&quot;update st_lms_state_master set no_ret_registered=&quot;+newOrgNumber+ &quot; where state_code='&quot;+stateCode+&quot;'&quot;);
<span class="nc" id="L2316">					}			</span>
					else {
						
<span class="nc" id="L2319">						logger.info(&quot;Invalid Org Type &quot; + orgType);</span>
<span class="nc" id="L2320">						throw new LMSException(textProvider.getText(&quot;error.org.type.not.pass.proper.during.access.code.create&quot;));</span>
					}
						
			} else {
<span class="nc" id="L2324">				logger.info(&quot;Invalid Country Deployed  &quot; + countryDep);</span>
<span class="nc" id="L2325">				throw new LMSException(textProvider.getText(&quot;error.inv.country.not.auth.create.org&quot;));</span>
				
			}
		
<span class="nc" id="L2329">			logger.info(&quot;Generated Access Code is : &quot; + generatedCode);</span>
			
<span class="nc" id="L2331">			return generatedCode;</span>
			
<span class="nc" id="L2333">		}catch(Exception e){</span>
<span class="nc" id="L2334">			e.printStackTrace();</span>
<span class="nc" id="L2335">			throw new LMSException(textProvider.getText(&quot;error.org.type.not.pass.proper&quot;));</span>
		}finally{
			
<span class="nc" id="L2338">			try{</span>
<span class="nc bnc" id="L2339" title="All 4 branches missed.">				if(pstmt!=null){</span>
<span class="nc" id="L2340">					pstmt.close();</span>
					
				}
<span class="nc bnc" id="L2343" title="All 4 branches missed.">				if(rs!=null){</span>
<span class="nc" id="L2344">					rs.close();</span>
					
				}
<span class="nc" id="L2347">			}catch(Exception e){</span>
<span class="nc" id="L2348">				e.printStackTrace();</span>
<span class="nc" id="L2349">			}</span>
		}		
	}
	private static void insertIntoAgentRoleMapping(int AgentId,int roleId,Connection con){
<span class="nc" id="L2353">		PreparedStatement pstmt = null;</span>
		try {
<span class="nc" id="L2355">			String userIpMapping = &quot;&quot;;</span>
<span class="nc bnc" id="L2356" title="All 2 branches missed.">			if (roleId == 1) {</span>
<span class="nc" id="L2357">				 userIpMapping = &quot;INSERT INTO st_lms_role_agent_mapping(role_id,agent_id) values(?,?);&quot;;</span>
			}else{
<span class="nc" id="L2359">				 userIpMapping = &quot;INSERT INTO st_lms_role_agent_mapping(role_id,agent_id) values(?,?),(1,?);&quot;;</span>
			}
<span class="nc" id="L2361">			pstmt = con.prepareStatement(userIpMapping);</span>
<span class="nc" id="L2362">			pstmt.setInt(1, roleId);</span>
<span class="nc" id="L2363">			pstmt.setInt(2, AgentId);</span>
<span class="nc bnc" id="L2364" title="All 2 branches missed.">			if (roleId != 1) {</span>
<span class="nc" id="L2365">				pstmt.setInt(3, AgentId);</span>
			}
<span class="nc" id="L2367">			logger.info(&quot;inside insertIntoAgentRoleMapping pstmt {} &quot;+ pstmt);</span>
<span class="nc" id="L2368">			pstmt.executeUpdate();</span>
<span class="nc" id="L2369">		} catch (SQLException se) {</span>
<span class="nc" id="L2370">			logger.error(&quot;sql exception&quot;, se);</span>
<span class="nc" id="L2371">		} catch (Exception e) {</span>
<span class="nc" id="L2372">			logger.error(&quot;Some Error while mapping into role agent &quot;, e);</span>
		}finally {
<span class="nc" id="L2374">			DBConnect.closeResource(pstmt);</span>
<span class="nc" id="L2375">		}</span>
<span class="nc" id="L2376">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>