<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SearchOrgHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lms</a> &gt; <a href="index.source.html" class="el_package">com.skilrock.lms.coreEngine.userMgmt.common</a> &gt; <span class="el_source">SearchOrgHelper.java</span></div><h1>SearchOrgHelper.java</h1><pre class="source lang-java linenums">/***
 *  * ï¿½ copyright 2007, SkilRock Technologies, A division of Sugal &amp; Damani Lottery Agency Pvt. Ltd.
 * All Rights Reserved
 * The contents of this file are the property of Sugal &amp; Damani Lottery Agency Pvt. Ltd.
 * and are subject to a License agreement with Sugal &amp; Damani Lottery Agency Pvt. Ltd.; you may
 * not use this file except in compliance with that License.  You may obtain a
 * copy of that license from:
 * Legal Department
 * Sugal &amp; Damani Lottery Agency Pvt. Ltd.
 * 6/35,WEA, Karol Bagh,
 * New Delhi
 * India - 110005
 * This software is distributed under the License and is provided on an ï¿½AS ISï¿½
 * basis, without warranty of any kind, either express or implied, unless
 * otherwise provided in the License.  See the License for governing rights and
 * limitations under the License.
 * 
 */
package com.skilrock.lms.coreEngine.userMgmt.common;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.text.DateFormat;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Set;

import com.skilrock.lms.beans.OrganizationBean;
import com.skilrock.lms.common.Utility;
import com.skilrock.lms.common.db.DBConnect;
import com.skilrock.lms.common.db.QueryManager;
import com.skilrock.lms.common.db.TableConstants;
import com.skilrock.lms.common.exception.LMSException;
import com.skilrock.lms.common.filter.LMSFilterDispatcher;

/**
 * 
 * This class is a helper used to process the Company search @ BO.
 * @author SkilRock Technologies
 * 
 */
<span class="nc" id="L50">public class SearchOrgHelper {</span>

	public static void main(String[] args) {
<span class="nc" id="L53">		long days = 0, hours = 0;</span>

<span class="nc" id="L55">		Calendar today = Calendar.getInstance();</span>
<span class="nc" id="L56">		today.set(today.get(Calendar.YEAR), today.get(Calendar.MONTH), today</span>
				.get(Calendar.DAY_OF_MONTH), 0, 0, 0);

<span class="nc" id="L59">		Calendar extendedDate = Calendar.getInstance();</span>
		// extendedDate.setTimeInMillis(date.getTime());
<span class="nc" id="L61">		extendedDate.set(2009, 3, 30, 0, 0, 0);</span>

<span class="nc" id="L63">		long timeDiff = extendedDate.getTimeInMillis()</span>
				- today.getTimeInMillis();

<span class="nc" id="L66">		days = timeDiff / (1000 * 60 * 60 * 24);</span>
<span class="nc" id="L67">		hours = timeDiff / (1000 * 60 * 60);</span>

<span class="nc" id="L69">		System.out.println(&quot; dd days : &quot; + days + &quot;  hours = &quot; + hours);</span>
<span class="nc" id="L70">		System.out.println(&quot;,  extendedDate = &quot; + extendedDate.getTime()</span>
				+ &quot;     ,today : &quot; + today.getTime());

<span class="nc" id="L73">	}</span>

	private int calculateExtendsCreditLimitUpto(java.sql.Date date) {
<span class="nc bnc" id="L76" title="All 2 branches missed.">		if (date == null) {</span>
<span class="nc" id="L77">			return 0;</span>
		}
<span class="nc" id="L79">		long days = 0, hours = 0;</span>

<span class="nc" id="L81">		Calendar today = Calendar.getInstance();</span>
<span class="nc" id="L82">		today.set(today.get(Calendar.YEAR), today.get(Calendar.MONTH), today</span>
				.get(Calendar.DAY_OF_MONTH), 0, 0, 0);

<span class="nc" id="L85">		Calendar extendedDate = Calendar.getInstance();</span>
<span class="nc" id="L86">		extendedDate.setTimeInMillis(date.getTime());</span>
<span class="nc" id="L87">		extendedDate.set(extendedDate.get(Calendar.YEAR), extendedDate</span>
				.get(Calendar.MONTH), extendedDate.get(Calendar.DAY_OF_MONTH),
				0, 0, 1);

<span class="nc" id="L91">		long timeDiff = extendedDate.getTimeInMillis()</span>
				- today.getTimeInMillis();
<span class="nc bnc" id="L93" title="All 2 branches missed.">		if (timeDiff &gt; 0) {</span>
<span class="nc" id="L94">			days = timeDiff / (1000 * 60 * 60 * 24);</span>
<span class="nc" id="L95">			hours = timeDiff / (1000 * 60 * 60);</span>
		}
		// System.out.println(&quot; dd days : &quot;+days +&quot; hours = &quot;+hours);
		// System.out.println(date +&quot;, extendedDate = &quot;+extendedDate.getTime()
		// +&quot; ,today : &quot;+today.getTime());

<span class="nc" id="L101">		return (int) days;</span>
	}

	private java.sql.Date getDate(String date) throws LMSException {
		try {
<span class="nc" id="L106">			DateFormat dateFormat = new SimpleDateFormat();</span>

<span class="nc" id="L108">			Date parsedDate = dateFormat.parse(date);</span>
<span class="nc" id="L109">			return new java.sql.Date(parsedDate.getTime());</span>
<span class="nc" id="L110">		} catch (Exception e) {</span>
<span class="nc" id="L111">			throw new LMSException();</span>
		}

	}

	public int getRoleId(String key) throws LMSException {
<span class="nc" id="L117">		int roleId = 0;</span>
<span class="nc" id="L118">		Connection connection = null;</span>
<span class="nc" id="L119">		Statement statement = null;</span>
<span class="nc" id="L120">		ResultSet rs = null;</span>
		try {
			 
<span class="nc" id="L123">			connection = DBConnect.getConnection();</span>
<span class="nc" id="L124">			statement = connection.createStatement();</span>
<span class="nc" id="L125">			String query1 = QueryManager.getST5RoleQuery()</span>
					+ &quot; where role_name='&quot; + key + &quot;'&quot;;
<span class="nc" id="L127">			System.out.println(&quot; query to get role Id&quot; + query1);</span>
<span class="nc" id="L128">			rs = statement.executeQuery(query1);</span>
<span class="nc" id="L129">			rs.next();</span>
<span class="nc" id="L130">			roleId = rs.getInt(&quot;role_id&quot;);</span>

<span class="nc" id="L132">			return roleId;</span>
<span class="nc" id="L133">		} catch (SQLException e) {</span>
<span class="nc" id="L134">			throw new LMSException(e);</span>
		}

		finally {

<span class="nc" id="L139">			try {</span>
<span class="nc bnc" id="L140" title="All 4 branches missed.">				if (rs != null) {</span>
<span class="nc" id="L141">					rs.close();</span>
				}
<span class="nc bnc" id="L143" title="All 4 branches missed.">				if (statement != null) {</span>
<span class="nc" id="L144">					statement.close();</span>
				}
<span class="nc bnc" id="L146" title="All 4 branches missed.">				if (connection != null) {</span>
<span class="nc" id="L147">					connection.close();</span>
				}
<span class="nc" id="L149">			} catch (SQLException se) {</span>
<span class="nc" id="L150">				throw new LMSException(se);</span>
<span class="nc" id="L151">			}</span>

		}
	}

	private String getWhereClause(Map searchMap,String parentorgQry,String orgQry) {
<span class="nc" id="L157">		Set keySet = null;</span>
<span class="nc" id="L158">		StringBuffer whereClause = new StringBuffer();</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">		if (searchMap != null) {</span>
<span class="nc" id="L160">			keySet = searchMap.keySet();</span>
<span class="nc" id="L161">			Iterator itr = keySet.iterator();</span>
<span class="nc" id="L162">			String key = null;</span>
			String strValue;
<span class="nc" id="L164">			int fieldAdded = 1;</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">			while (itr.hasNext()) {</span>
<span class="nc" id="L166">				key = (String) itr.next();</span>

<span class="nc bnc" id="L168" title="All 2 branches missed.">				if (key.equals(&quot;PARENT_ORG_NAME&quot;)) {</span>
<span class="nc" id="L169">					strValue = (String) searchMap.get(key);</span>

<span class="nc bnc" id="L171" title="All 4 branches missed.">					if (strValue != null &amp;&amp; !strValue.equals(&quot;&quot;)) {</span>

<span class="nc bnc" id="L173" title="All 2 branches missed.">						if (fieldAdded &gt; 0) {</span>
<span class="nc" id="L174">							whereClause</span>
									.append(&quot; and a.parent_id in(select organization_id from st_lms_organization_master where &quot;);
						}

<span class="nc" id="L178">						whereClause.append(parentorgQry);</span>
<span class="nc" id="L179">						whereClause.append(&quot; like '&quot;);</span>
<span class="nc" id="L180">						whereClause.append(strValue.trim());</span>
<span class="nc" id="L181">						whereClause.append(&quot;%')&quot;);</span>
<span class="nc" id="L182">						System.out.println(&quot;Org name Clause&quot;);</span>
<span class="nc" id="L183">						fieldAdded++;</span>
					}
<span class="nc bnc" id="L185" title="All 2 branches missed.">				} else if (key.equals(&quot;AGENT_ID&quot;)) {</span>
<span class="nc" id="L186">					strValue = (String) searchMap.get(key);</span>

<span class="nc bnc" id="L188" title="All 4 branches missed.">					if (strValue != null &amp;&amp; !strValue.equals(&quot;&quot;)) {</span>
<span class="nc" id="L189">						int orgId = Integer.parseInt(strValue);</span>

<span class="nc bnc" id="L191" title="All 2 branches missed.">						if (fieldAdded &gt; 0) {</span>
<span class="nc" id="L192">							whereClause.append(&quot; and &quot;);</span>
						}
<span class="nc" id="L194">						whereClause.append(&quot;a.parent_id&quot;);</span>
<span class="nc" id="L195">						whereClause.append(&quot;=&quot;);</span>
<span class="nc" id="L196">						whereClause.append(orgId);</span>
<span class="nc" id="L197">						System.out.println(&quot;Org name Clause&quot;);</span>
<span class="nc" id="L198">						fieldAdded++;</span>
<span class="nc" id="L199">					}</span>
				}

<span class="nc bnc" id="L202" title="All 2 branches missed.">				else if (key.equals(&quot;ORG_NAME&quot;)) {</span>
<span class="nc" id="L203">					strValue = (String) searchMap.get(key);</span>

<span class="nc bnc" id="L205" title="All 4 branches missed.">					if (strValue != null &amp;&amp; !strValue.equals(&quot;&quot;)) {</span>

<span class="nc bnc" id="L207" title="All 2 branches missed.">						if (fieldAdded &gt; 0) {</span>
<span class="nc" id="L208">							whereClause.append(&quot; and &quot;);</span>
						}
						//whereClause.append(&quot;a.&quot;);
<span class="nc" id="L211">						whereClause.append(orgQry);</span>
<span class="nc" id="L212">						whereClause.append(&quot; like '&quot;);</span>
<span class="nc" id="L213">						whereClause.append(strValue.trim());</span>
<span class="nc" id="L214">						whereClause.append(&quot;%'&quot;);</span>
<span class="nc" id="L215">						System.out.println(&quot;Org name Clause&quot;);</span>
<span class="nc" id="L216">						fieldAdded++;</span>
					}
				}

<span class="nc bnc" id="L220" title="All 2 branches missed.">				else if (key.equals(&quot;ORG_STATUS&quot;)) {</span>

<span class="nc" id="L222">					strValue = (String) searchMap.get(key);</span>
<span class="nc" id="L223">					System.out.println(strValue);</span>
<span class="nc bnc" id="L224" title="All 4 branches missed.">					if (strValue != null &amp;&amp; !strValue.equals(&quot;&quot;)) {</span>

<span class="nc bnc" id="L226" title="All 2 branches missed.">						if (fieldAdded &gt; 0) {</span>
<span class="nc" id="L227">							whereClause.append(&quot; and &quot;);</span>
						}
<span class="nc" id="L229">						whereClause.append(&quot;a.&quot;);</span>
<span class="nc" id="L230">						whereClause.append(TableConstants.ORGANIZATION_STATUS);</span>
<span class="nc" id="L231">						whereClause.append(&quot; = &quot;);</span>
<span class="nc" id="L232">						whereClause.append(&quot;'&quot;);</span>
<span class="nc" id="L233">						whereClause.append(strValue.trim());</span>
<span class="nc" id="L234">						whereClause.append(&quot;'&quot;);</span>
<span class="nc" id="L235">						System.out.println(&quot;status Clause&quot;);</span>
<span class="nc" id="L236">						fieldAdded++;</span>

					}
				}

<span class="nc bnc" id="L241" title="All 2 branches missed.">				else if (key.equals(&quot;ORG_TYPE&quot;)) {</span>
<span class="nc" id="L242">					strValue = (String) searchMap.get(key);</span>
<span class="nc" id="L243">					System.out.println(strValue);</span>

<span class="nc" id="L245">					strValue = (String) searchMap.get(key);</span>

<span class="nc bnc" id="L247" title="All 4 branches missed.">					if (strValue != null &amp;&amp; !strValue.equals(&quot;&quot;)) {</span>

<span class="nc bnc" id="L249" title="All 2 branches missed.">						if (fieldAdded &gt; 0) {</span>
<span class="nc" id="L250">							whereClause.append(&quot; and &quot;);</span>
						}
<span class="nc" id="L252">						whereClause.append(&quot;a.&quot;);</span>
<span class="nc" id="L253">						whereClause.append(TableConstants.ORGANIZATION_TYPE);</span>
<span class="nc" id="L254">						whereClause.append(&quot; = &quot;);</span>
<span class="nc" id="L255">						whereClause.append(&quot;'&quot;);</span>
<span class="nc" id="L256">						whereClause.append(strValue.trim());</span>
<span class="nc" id="L257">						whereClause.append(&quot;'&quot;);</span>
<span class="nc" id="L258">						System.out.println(&quot;Org Type&quot;);</span>
<span class="nc" id="L259">						fieldAdded++;</span>

					}
				}

			}
<span class="nc bnc" id="L265" title="All 2 branches missed.">			if (fieldAdded == 0) {</span>
<span class="nc" id="L266">				whereClause.append(&quot;1=1&quot;);</span>

			}

		}
		
<span class="nc" id="L272">		return whereClause.toString();</span>
	}
private String getWhereClause(Map searchMap) {
<span class="nc" id="L275">		Set keySet = null;</span>
<span class="nc" id="L276">		StringBuffer whereClause = new StringBuffer();</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">		if (searchMap != null) {</span>
<span class="nc" id="L278">			keySet = searchMap.keySet();</span>
<span class="nc" id="L279">			Iterator itr = keySet.iterator();</span>
<span class="nc" id="L280">			String key = null;</span>
			String strValue;
<span class="nc" id="L282">			int fieldAdded = 1;</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">			while (itr.hasNext()) {</span>
<span class="nc" id="L284">				key = (String) itr.next();</span>

<span class="nc bnc" id="L286" title="All 2 branches missed.">				if (key.equals(&quot;PARENT_ORG_NAME&quot;)) {</span>
<span class="nc" id="L287">					strValue = (String) searchMap.get(key);</span>

<span class="nc bnc" id="L289" title="All 4 branches missed.">					if (strValue != null &amp;&amp; !strValue.equals(&quot;&quot;)) {</span>

<span class="nc bnc" id="L291" title="All 2 branches missed.">						if (fieldAdded &gt; 0) {</span>
<span class="nc" id="L292">							whereClause</span>
									.append(&quot; and a.parent_id in(select organization_id from st_lms_organization_master where &quot;);
						}

<span class="nc" id="L296">						whereClause.append(TableConstants.NAME);</span>
<span class="nc" id="L297">						whereClause.append(&quot; like '&quot;);</span>
<span class="nc" id="L298">						whereClause.append(strValue.trim());</span>
<span class="nc" id="L299">						whereClause.append(&quot;%')&quot;);</span>
<span class="nc" id="L300">						System.out.println(&quot;Org name Clause&quot;);</span>
<span class="nc" id="L301">						fieldAdded++;</span>
					}
<span class="nc bnc" id="L303" title="All 2 branches missed.">				} else if (key.equals(&quot;AGENT_ID&quot;)) {</span>
<span class="nc" id="L304">					strValue = (String) searchMap.get(key);</span>

<span class="nc bnc" id="L306" title="All 4 branches missed.">					if (strValue != null &amp;&amp; !strValue.equals(&quot;&quot;)) {</span>
<span class="nc" id="L307">						int orgId = Integer.parseInt(strValue);</span>

<span class="nc bnc" id="L309" title="All 2 branches missed.">						if (fieldAdded &gt; 0) {</span>
<span class="nc" id="L310">							whereClause.append(&quot; and &quot;);</span>
						}
<span class="nc" id="L312">						whereClause.append(&quot;a.parent_id&quot;);</span>
<span class="nc" id="L313">						whereClause.append(&quot;=&quot;);</span>
<span class="nc" id="L314">						whereClause.append(orgId);</span>
<span class="nc" id="L315">						System.out.println(&quot;Org name Clause&quot;);</span>
<span class="nc" id="L316">						fieldAdded++;</span>
<span class="nc" id="L317">					}</span>
				}

<span class="nc bnc" id="L320" title="All 2 branches missed.">				else if (key.equals(&quot;ORG_NAME&quot;)) {</span>
<span class="nc" id="L321">					strValue = (String) searchMap.get(key);</span>

<span class="nc bnc" id="L323" title="All 4 branches missed.">					if (strValue != null &amp;&amp; !strValue.equals(&quot;&quot;)) {</span>

<span class="nc bnc" id="L325" title="All 2 branches missed.">						if (fieldAdded &gt; 0) {</span>
<span class="nc" id="L326">							whereClause.append(&quot; and &quot;);</span>
						}
<span class="nc" id="L328">						whereClause.append(&quot;a.&quot;);</span>
<span class="nc" id="L329">						whereClause.append(TableConstants.NAME);</span>
<span class="nc" id="L330">						whereClause.append(&quot; like '&quot;);</span>
<span class="nc" id="L331">						whereClause.append(strValue.trim());</span>
<span class="nc" id="L332">						whereClause.append(&quot;%'&quot;);</span>
<span class="nc" id="L333">						System.out.println(&quot;Org name Clause&quot;);</span>
<span class="nc" id="L334">						fieldAdded++;</span>
					}
				}

<span class="nc bnc" id="L338" title="All 2 branches missed.">				else if (key.equals(&quot;ORG_STATUS&quot;)) {</span>

<span class="nc" id="L340">					strValue = (String) searchMap.get(key);</span>
<span class="nc" id="L341">					System.out.println(strValue);</span>
<span class="nc bnc" id="L342" title="All 4 branches missed.">					if (strValue != null &amp;&amp; !strValue.equals(&quot;&quot;)) {</span>

<span class="nc bnc" id="L344" title="All 2 branches missed.">						if (fieldAdded &gt; 0) {</span>
<span class="nc" id="L345">							whereClause.append(&quot; and &quot;);</span>
						}
<span class="nc" id="L347">						whereClause.append(&quot;a.&quot;);</span>
<span class="nc" id="L348">						whereClause.append(TableConstants.ORGANIZATION_STATUS);</span>
<span class="nc" id="L349">						whereClause.append(&quot; = &quot;);</span>
<span class="nc" id="L350">						whereClause.append(&quot;'&quot;);</span>
<span class="nc" id="L351">						whereClause.append(strValue.trim());</span>
<span class="nc" id="L352">						whereClause.append(&quot;'&quot;);</span>
<span class="nc" id="L353">						System.out.println(&quot;status Clause&quot;);</span>
<span class="nc" id="L354">						fieldAdded++;</span>

					}
				}

<span class="nc bnc" id="L359" title="All 2 branches missed.">				else if (key.equals(&quot;ORG_TYPE&quot;)) {</span>
<span class="nc" id="L360">					strValue = (String) searchMap.get(key);</span>
<span class="nc" id="L361">					System.out.println(strValue);</span>

<span class="nc" id="L363">					strValue = (String) searchMap.get(key);</span>

<span class="nc bnc" id="L365" title="All 4 branches missed.">					if (strValue != null &amp;&amp; !strValue.equals(&quot;&quot;)) {</span>

<span class="nc bnc" id="L367" title="All 2 branches missed.">						if (fieldAdded &gt; 0) {</span>
<span class="nc" id="L368">							whereClause.append(&quot; and &quot;);</span>
						}
<span class="nc" id="L370">						whereClause.append(&quot;a.&quot;);</span>
<span class="nc" id="L371">						whereClause.append(TableConstants.ORGANIZATION_TYPE);</span>
<span class="nc" id="L372">						whereClause.append(&quot; = &quot;);</span>
<span class="nc" id="L373">						whereClause.append(&quot;'&quot;);</span>
<span class="nc" id="L374">						whereClause.append(strValue.trim());</span>
<span class="nc" id="L375">						whereClause.append(&quot;'&quot;);</span>
<span class="nc" id="L376">						System.out.println(&quot;Org Type&quot;);</span>
<span class="nc" id="L377">						fieldAdded++;</span>

					}
				}

			}
<span class="nc bnc" id="L383" title="All 2 branches missed.">			if (fieldAdded == 0) {</span>
<span class="nc" id="L384">				whereClause.append(&quot;1=1&quot;);</span>

			}

		}

<span class="nc" id="L390">		return whereClause.toString();</span>
	}

	private String getWhereClause(String orgName, String orgType,
			String orgStatus, String parentCompName, String CrLimitSign,
			String extendCrLimitSign, String avlblCrLimitSign,
			String securityDepositSign, String CrLimit, String extendCrLimit,
			String avlblCrLimit, String securityDeposit, String pwtScrapStatus,String orgQry ,String parentorgQry) {
<span class="nc" id="L398">		StringBuilder whereClause = new StringBuilder();</span>
	
		
<span class="nc bnc" id="L401" title="All 6 branches missed.">		if (orgName != null &amp; !orgName.equals(&quot;&quot;)) {</span>
<span class="nc" id="L402">			whereClause.append(&quot;and &quot; + orgQry+ &quot; like '&quot;</span>
					+ orgName + &quot;%' &quot;);
		
			
		}
<span class="nc bnc" id="L407" title="All 4 branches missed.">		if (orgType != null &amp;&amp; !orgType.equals(&quot;-1&quot;)) {</span>
<span class="nc" id="L408">			whereClause.append(&quot;and a.&quot; + TableConstants.ORGANIZATION_TYPE</span>
					+ &quot;='&quot; + orgType + &quot;' &quot;);
		}
<span class="nc bnc" id="L411" title="All 4 branches missed.">		if (orgStatus != null &amp;&amp; !orgStatus.equals(&quot;-1&quot;)) {</span>
<span class="nc" id="L412">			whereClause.append(&quot;and a.&quot; + TableConstants.ORGANIZATION_STATUS</span>
					+ &quot;='&quot; + orgStatus + &quot;' &quot;);
		}
<span class="nc bnc" id="L415" title="All 4 branches missed.">		if (parentCompName != null &amp;&amp; !parentCompName.equals(&quot;&quot;)) {</span>
<span class="nc" id="L416">			whereClause.append(&quot;and &quot;+parentorgQry+&quot;  like '&quot;</span>
					+ parentCompName + &quot;%' &quot;);

		}
<span class="nc bnc" id="L420" title="All 4 branches missed.">		if (CrLimit != null &amp;&amp; !CrLimit.trim().equals(&quot;&quot;)) {</span>
<span class="nc" id="L421">			whereClause.append(&quot;and a.credit_limit &quot; + CrLimitSign + &quot; &quot;</span>
					+ CrLimit + &quot; &quot;);
		}
<span class="nc bnc" id="L424" title="All 4 branches missed.">		if (extendCrLimit != null &amp;&amp; !extendCrLimit.trim().equals(&quot;&quot;)) {</span>
<span class="nc" id="L425">			whereClause.append(&quot;and a.extended_credit_limit &quot;</span>
					+ extendCrLimitSign + &quot; &quot; + extendCrLimit + &quot; &quot;);
		}
<span class="nc bnc" id="L428" title="All 4 branches missed.">		if (avlblCrLimit != null &amp;&amp; !avlblCrLimit.trim().equals(&quot;&quot;)) {</span>
<span class="nc" id="L429">			whereClause.append(&quot;and a.available_credit &quot; + avlblCrLimitSign</span>
					+ &quot; &quot; + avlblCrLimit + &quot; &quot;);
		}
<span class="nc bnc" id="L432" title="All 4 branches missed.">		if (securityDeposit != null &amp;&amp; !securityDeposit.trim().equals(&quot;&quot;)) {</span>
<span class="nc" id="L433">			whereClause.append(&quot;and a.security_deposit &quot; + securityDepositSign</span>
					+ &quot; &quot; + securityDeposit + &quot; &quot;);
		}
<span class="nc bnc" id="L436" title="All 8 branches missed.">		if (pwtScrapStatus != null &amp;&amp; !pwtScrapStatus.trim().equals(&quot;&quot;)</span>
				&amp; !pwtScrapStatus.equals(&quot;-1&quot;)) {
<span class="nc" id="L438">			whereClause.append(&quot;and a.pwt_scrap = '&quot; + pwtScrapStatus + &quot;'&quot;);</span>
		}
<span class="nc" id="L440">		return whereClause.toString();</span>
	}

	/**
	 * This method is used to search Company
	 * 
	 * @BO
	 * @param searchMap(agent
	 *            id,org id)
	 * @return List
	 * @throws LMSException
	 */

	public List searchOrg(String orgName, String orgType, String orgStatus,
			String parentCompName, String CrLimitSign, 
			String extendCrLimitSign, String avlblCrLimitSign,
			String securityDepositSign, String CrLimit, String extendCrLimit,
			String avlblCrLimit, String securityDeposit, String pwtScrapStatus, String reportType, String terminalStatusType)
			throws LMSException {

<span class="nc" id="L460">		Connection connection = null;</span>
<span class="nc" id="L461">		Statement statement = null;</span>
<span class="nc" id="L462">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L463">		ResultSet rsLedger = null;</span>
<span class="nc" id="L464">		ResultSet resultSet = null;</span>
<span class="nc" id="L465">		String colletedSdCol=null;</span>
<span class="nc" id="L466">		String joinCheckAppendQry=null;</span>
<span class="nc" id="L467">		String joinQry=null;</span>
		

		try {
			

<span class="nc" id="L473">			String appendQury =QueryManager.getAppendOrgOrder();</span>
<span class="nc" id="L474">			String orgCodeQry = &quot; a.name orgCode,d.name parentorgCode &quot;;</span>
<span class="nc" id="L475">			String orgQry = &quot; a.name &quot;;</span>
<span class="nc" id="L476">			String parentorgQry = &quot; d.name &quot;;</span>
			
<span class="nc bnc" id="L478" title="All 2 branches missed.">			if ((LMSFilterDispatcher.orgFieldType).equalsIgnoreCase(&quot;CODE&quot;)) {</span>
<span class="nc" id="L479">				orgCodeQry = &quot; a.org_code orgCode,d.org_code parentorgCode &quot;;</span>
<span class="nc" id="L480">				orgQry = &quot; a.org_code  &quot;;</span>
<span class="nc" id="L481">				parentorgQry =&quot; d.org_code &quot;;</span>

<span class="nc bnc" id="L483" title="All 2 branches missed.">			} else if ((LMSFilterDispatcher.orgFieldType)</span>
					.equalsIgnoreCase(&quot;CODE_NAME&quot;)) {
<span class="nc" id="L485">				orgCodeQry = &quot; concat(a.org_code,'_',a.name)  orgCode,concat(d.org_code,'_',d.name)  parentorgCode &quot;;</span>
<span class="nc" id="L486">				orgQry = &quot; concat(a.org_code,'_',a.name)   &quot;;</span>
<span class="nc" id="L487">				parentorgQry =&quot; concat(d.org_code,'_',d.name) &quot;;</span>
				
<span class="nc bnc" id="L489" title="All 2 branches missed.">			} else if ((LMSFilterDispatcher.orgFieldType)</span>
					.equalsIgnoreCase(&quot;NAME_CODE&quot;)) {
<span class="nc" id="L491">				orgCodeQry = &quot; concat(a.name,'_',a.org_code)  orgCode,concat(d.name,'_',d.org_code)  parentorgCode &quot;;</span>
<span class="nc" id="L492">				orgQry = &quot;  concat(a.name,'_',a.org_code)  &quot;;</span>
<span class="nc" id="L493">				parentorgQry =&quot;  concat(d.name,'_',d.org_code  &quot;;</span>

			}
<span class="nc" id="L496">			OrganizationBean orgBean = null;</span>
<span class="nc" id="L497">			List&lt;OrganizationBean&gt; searchResults = new ArrayList&lt;OrganizationBean&gt;();</span>

			 
<span class="nc" id="L500">			connection = DBConnect.getConnection();</span>
<span class="nc" id="L501">			statement = connection.createStatement();</span>

<span class="nc" id="L503">			String dynamicWhereClause = getWhereClause(orgName, orgType,</span>
					orgStatus, parentCompName, CrLimitSign, extendCrLimitSign,
					avlblCrLimitSign, securityDepositSign, CrLimit,
					extendCrLimit, avlblCrLimit, securityDeposit,
					pwtScrapStatus,orgQry,parentorgQry);
			// String query = QueryManager.getST5OrgSearchQuery() +
			// dynamicWhereClause;
		/*	String query = QueryManager.getST5OrgSearchQuery()
					+ dynamicWhereClause + &quot;order by a.name&quot;;*/

<span class="nc" id="L513">			String appender = null;</span>
<span class="nc bnc" id="L514" title="All 2 branches missed.">			if(&quot;clXclReport&quot;.equals(reportType)) {</span>
<span class="nc bnc" id="L515" title="All 2 branches missed.">				if(!dynamicWhereClause.contains(&quot;TERMINATE&quot;)) {</span>
<span class="nc" id="L516">					appender = &quot;and a.organization_status !='TERMINATE'&quot;;</span>
				}
				else{
<span class="nc" id="L519">					appender=&quot;&quot;;</span>
				}
				
<span class="nc bnc" id="L522" title="All 2 branches missed.">			} else if(&quot;searchAgtRetReport&quot;.equals(reportType)) {</span>
<span class="nc" id="L523">				appender = &quot;&quot;;</span>
			}
<span class="nc bnc" id="L525" title="All 2 branches missed.">			if(&quot;BENIN&quot;.equalsIgnoreCase(Utility.getPropertyValue(&quot;COUNTRY_DEPLOYED&quot;))){</span>
<span class="nc" id="L526">				joinCheckAppendQry=&quot;and e.organization_id=a.organization_id &quot;;</span>
<span class="nc" id="L527">				colletedSdCol=&quot;e.collected_security_deposit,&quot;;</span>
<span class="nc" id="L528">				joinQry=&quot;,st_lms_organization_security_levy_master e&quot;;</span>
<span class="nc" id="L529">				dynamicWhereClause=dynamicWhereClause.replace(&quot;a.security_deposit&quot;, &quot;e.collected_security_deposit&quot;);</span>
			}
			else{
<span class="nc" id="L532">				joinCheckAppendQry=&quot;&quot;;</span>
<span class="nc" id="L533">				colletedSdCol=&quot;&quot;;</span>
<span class="nc" id="L534">				joinQry=&quot;&quot;;</span>
			}
<span class="nc" id="L536">			String query =&quot; select a.organization_id, a.extends_credit_limit_upto, a.organization_type,a.parent_id, &quot;+orgCodeQry+&quot; ,a.organization_status,a.addr_line1,a.city,a.available_credit,a.credit_limit,a.security_deposit,&quot;+colletedSdCol+&quot;a.extended_credit_limit,a.pwt_scrap,a.claimable_bal,a.unclaimable_bal,b.name 'state',c.name 'country' from st_lms_organization_master a,st_lms_organization_master d,st_lms_state_master b,st_lms_country_master c &quot;+joinQry+&quot; where a.state_code=b.state_code and  a.country_code=c.country_code &quot;+joinCheckAppendQry+&quot;and a.parent_id = d.organization_id &quot;+appender+&quot; and a.organization_type in('AGENT','RETAILER') &quot;+dynamicWhereClause+&quot; order by &quot;+appendQury;</span>
<span class="nc bnc" id="L537" title="All 2 branches missed.">			if(&quot;RETAILER&quot;.equals(orgType)) {</span>
<span class="nc bnc" id="L538" title="All 2 branches missed.">				if(&quot;ALL&quot;.equals(terminalStatusType)) {</span>
<span class="nc" id="L539">					query = &quot;SELECT organization_id, extends_credit_limit_upto, organization_type, parent_id, orgCode, parentorgCode, organization_status, addr_line1, city, available_credit, credit_limit, security_deposit, extended_credit_limit, pwt_scrap, claimable_bal, unclaimable_bal, state, country, concat(b.model_name,'-', status.serial_no) serial_no from (&quot;</span>
							+ query
							+ &quot; )main LEFT JOIN st_lms_inv_status status ON main.organization_id = status.current_owner_id inner join st_lms_inv_model_master b on b.model_id = inv_model_id &quot;
							+&quot;UNION ALL SELECT organization_id, extends_credit_limit_upto, organization_type, parent_id, orgCode, parentorgCode, organization_status, addr_line1, city, available_credit, credit_limit, security_deposit, extended_credit_limit, pwt_scrap, claimable_bal, unclaimable_bal, state, country, status.serial_no from (&quot;
						+ query
						+ &quot; )main LEFT JOIN st_lms_inv_status status ON main.organization_id = status.current_owner_id WHERE status.serial_no IS NULL;&quot;;

<span class="nc bnc" id="L546" title="All 2 branches missed.">				} else if (&quot;DONT_HAVE&quot;.equals(terminalStatusType)) {</span>
<span class="nc" id="L547">					query = &quot;SELECT organization_id, extends_credit_limit_upto, organization_type, parent_id, orgCode, parentorgCode, organization_status, addr_line1, city, available_credit, credit_limit, security_deposit, extended_credit_limit, pwt_scrap, claimable_bal, unclaimable_bal, state, country, status.serial_no from (&quot;</span>
							+ query
							+ &quot; )main LEFT JOIN st_lms_inv_status status ON main.organization_id = status.current_owner_id WHERE status.serial_no IS NULL;&quot;;
<span class="nc bnc" id="L550" title="All 2 branches missed.">				} else if (&quot;HAVE&quot;.equals(terminalStatusType)) {</span>
<span class="nc" id="L551">					query = &quot;SELECT organization_id, extends_credit_limit_upto, organization_type, parent_id, orgCode, parentorgCode, organization_status, addr_line1, city, available_credit, credit_limit, security_deposit, extended_credit_limit, pwt_scrap, claimable_bal, unclaimable_bal, state, country,  concat(b.model_name,'-', status.serial_no) serial_no from (&quot;</span>
							+ query
							+ &quot; )main INNER JOIN st_lms_inv_status status ON main.organization_id = status.current_owner_id  inner join st_lms_inv_model_master b on b.model_id = inv_model_id;&quot;;
				}
			}

<span class="nc" id="L557">			System.out.println(&quot;-----Query For org Search----::&quot; + query);</span>

<span class="nc" id="L559">			resultSet = statement.executeQuery(query);</span>

<span class="nc" id="L561">			System.out</span>
					.println(&quot;Result Set for Organization Search&quot; + resultSet);
<span class="nc bnc" id="L563" title="All 2 branches missed.">			while (resultSet.next()) {</span>
				// System.out.println(&quot;State &quot;+resultSet.getString(&quot;state&quot;));
<span class="nc" id="L565">				orgBean = new OrganizationBean();</span>
				// userBean.setUserId(resultSet.getInt(TableConstants.USER_ID));
<span class="nc" id="L567">				orgBean.setOrgId(resultSet</span>
						.getInt(TableConstants.ORGANIZATION_ID));
				// userBean.setUserName(resultSet.getString(TableConstants.USER_NAME));
<span class="nc" id="L570">				orgBean.setOrgName(resultSet.getString(&quot;orgCode&quot;));</span>
<span class="nc" id="L571">				orgBean.setParentOrgName(resultSet.getString(&quot;parentorgCode&quot;));</span>
<span class="nc" id="L572">				orgBean.setParentOrgId(resultSet.getInt(&quot;parent_id&quot;));</span>
				// userBean.setUserRoleName(TableConstants.ROLE_NAME);
<span class="nc" id="L574">				orgBean.setUserOrgType(orgType);</span>
<span class="nc" id="L575">				orgBean.setOrgType(resultSet</span>
						.getString(TableConstants.ORGANIZATION_TYPE));
<span class="nc" id="L577">				orgBean.setOrgStatus(resultSet</span>
						.getString(TableConstants.ORGANIZATION_STATUS));
<span class="nc" id="L579">				orgBean.setOrgState(resultSet.getString(&quot;state&quot;));</span>
<span class="nc" id="L580">				orgBean.setOrgCity(resultSet.getString(&quot;city&quot;));</span>
<span class="nc" id="L581">				orgBean.setOrgCountry((String) resultSet.getString(&quot;country&quot;));</span>
<span class="nc" id="L582">				orgBean.setOrgAddr1((String) resultSet.getString(&quot;addr_line1&quot;));</span>
<span class="nc" id="L583">				orgBean.setAvailableCredit(resultSet</span>
						.getDouble(&quot;available_credit&quot;));
<span class="nc" id="L585">				orgBean.setClaimableBal(resultSet.getDouble(&quot;claimable_bal&quot;));</span>
<span class="nc" id="L586">				orgBean.setUnclaimableBal(resultSet</span>
						.getDouble(&quot;unclaimable_bal&quot;));
				// changed by arun
<span class="nc" id="L589">				int extendedCreditLimitUpto = calculateExtendsCreditLimitUpto(resultSet</span>
						.getDate(&quot;extends_credit_limit_upto&quot;));
<span class="nc" id="L591">				orgBean.setExtendsCreditLimitUpto(extendedCreditLimitUpto);</span>
<span class="nc" id="L592">				orgBean.setOrgCreditLimit(resultSet.getDouble(&quot;credit_limit&quot;));</span>
<span class="nc" id="L593">				orgBean.setExtendedCredit(resultSet</span>
						.getDouble(&quot;extended_credit_limit&quot;));
<span class="nc" id="L595">				orgBean.setPwtScrapStatus(resultSet.getString(&quot;pwt_scrap&quot;));</span>
<span class="nc bnc" id="L596" title="All 2 branches missed.">				orgBean.setSecurityDeposit(&quot;BENIN&quot;.equalsIgnoreCase(Utility.getPropertyValue(&quot;COUNTRY_DEPLOYED&quot;))?resultSet</span>
						.getDouble(&quot;collected_security_deposit&quot;):resultSet.getDouble(&quot;security_deposit&quot;));

				// get the last updated ledger balance of AGENT/RETAILER
<span class="nc bnc" id="L600" title="All 2 branches missed.">				if (&quot;AGENT&quot;.equalsIgnoreCase(orgBean.getOrgType())) {</span>
<span class="nc" id="L601">					pstmt = connection</span>
							.prepareStatement(&quot;select *  from st_lms_bo_current_balance where agent_org_id = ?&quot;);
				} else {
<span class="nc" id="L604">					pstmt = connection</span>
							.prepareStatement(&quot;select *  from st_lms_agent_current_balance where account_type = ?&quot;);
				}
<span class="nc" id="L607">				pstmt.setInt(1, orgBean.getOrgId());</span>
<span class="nc" id="L608">				rsLedger = pstmt.executeQuery();</span>
<span class="nc bnc" id="L609" title="All 2 branches missed.">				if (rsLedger.next()) {</span>
<span class="nc" id="L610">					orgBean.setLedgerBalance(rsLedger</span>
							.getDouble(&quot;current_balance&quot;));
				}

				// commented by arun bcz ledger balance get from
				// 'current_balance' table directly
				// double ledgerBalance = orgBean.getAvailableCredit() -
				// orgBean.getOrgCreditLimit() - orgBean.getExtendedCredit();
				// System.out.println(&quot;ledger Balance of
				// ==&quot;+orgBean.getOrgName()+&quot;== is =
				// &quot;+orgBean.getLedgerBalance()+&quot; calculated ledger =
				// &quot;+ledgerBalance);
				// orgBean.setOrgCreditLimit(resultSet.getDouble(&quot;credit_limit&quot;)
				// + resultSet.getDouble(&quot;extended_credit_limit&quot;));
				
<span class="nc bnc" id="L625" title="All 2 branches missed.">				if (&quot;RETAILER&quot;.equals(orgType)) {</span>
<span class="nc bnc" id="L626" title="All 2 branches missed.">					if (resultSet.getString(&quot;serial_no&quot;) != null)</span>
<span class="nc" id="L627">						orgBean.setSerialNo(resultSet.getString(&quot;serial_no&quot;));</span>
					else
<span class="nc" id="L629">						orgBean.setSerialNo(&quot;NA&quot;);</span>
				} else
<span class="nc" id="L631">					orgBean.setSerialNo(&quot;NA&quot;);</span>

<span class="nc" id="L633">				searchResults.add(orgBean);</span>
<span class="nc" id="L634">			}</span>

<span class="nc" id="L636">			return searchResults;</span>

<span class="nc" id="L638">		} catch (SQLException e) {</span>
<span class="nc" id="L639">			throw new LMSException(e);</span>
		}

		finally {

<span class="nc" id="L644">			try {</span>
<span class="nc bnc" id="L645" title="All 4 branches missed.">				if (resultSet != null) {</span>
<span class="nc" id="L646">					resultSet.close();</span>
				}
<span class="nc bnc" id="L648" title="All 4 branches missed.">				if (statement != null) {</span>
<span class="nc" id="L649">					statement.close();</span>
				}
<span class="nc bnc" id="L651" title="All 4 branches missed.">				if (connection != null) {</span>
<span class="nc" id="L652">					connection.close();</span>
				}
<span class="nc" id="L654">			} catch (SQLException se) {</span>
<span class="nc" id="L655">				throw new LMSException(se);</span>
<span class="nc" id="L656">			}</span>
		}

	}

	/**
	 * This method is used to search Company
	 * 
	 * @AGENT
	 * @param searchMap
	 * @return List
	 * @throws LMSException
	 */

	public List searchOrgForRetailer(Map searchMap) throws LMSException {

<span class="nc" id="L672">		Connection connection = null;</span>
<span class="nc" id="L673">		Statement statement = null;</span>
<span class="nc" id="L674">		Statement statement1 = null;</span>
<span class="nc" id="L675">		ResultSet resultSet = null;</span>

		try {

<span class="nc" id="L679">			OrganizationBean orgBean = null;</span>
<span class="nc" id="L680">			List&lt;OrganizationBean&gt; searchResults = new ArrayList&lt;OrganizationBean&gt;();</span>

			 
<span class="nc" id="L683">			connection = DBConnect.getConnection();</span>
<span class="nc" id="L684">			statement = connection.createStatement();</span>

<span class="nc" id="L686">			String dynamicWhereClause = getWhereClause(searchMap);</span>
<span class="nc" id="L687">			String query = QueryManager.getST5OrgSearchQuery()</span>
					+ dynamicWhereClause + &quot;order by a.name&quot;;

<span class="nc" id="L690">			System.out.println(&quot;-----Query----::&quot; + query);</span>

<span class="nc" id="L692">			resultSet = statement.executeQuery(query);</span>

<span class="nc bnc" id="L694" title="All 2 branches missed.">			while (resultSet.next()) {</span>
				// System.out.println(&quot;Helper Result Set&quot;);
<span class="nc" id="L696">				orgBean = new OrganizationBean();</span>
				// userBean.setUserId(resultSet.getInt(TableConstants.USER_ID));
<span class="nc" id="L698">				orgBean.setOrgId(resultSet</span>
						.getInt(TableConstants.ORGANIZATION_ID));
				// userBean.setUserName(resultSet.getString(TableConstants.USER_NAME));
<span class="nc" id="L701">				orgBean.setOrgName(resultSet.getString(TableConstants.NAME));</span>
				// userBean.setUserRoleName(TableConstants.ROLE_NAME);
<span class="nc" id="L703">				orgBean.setOrgType(resultSet</span>
						.getString(TableConstants.ORGANIZATION_TYPE));
<span class="nc" id="L705">				orgBean.setOrgStatus(resultSet</span>
						.getString(TableConstants.ORGANIZATION_STATUS));
<span class="nc" id="L707">				orgBean.setOrgState(resultSet.getString(&quot;state&quot;));</span>
<span class="nc" id="L708">				orgBean.setOrgCity(resultSet.getString(&quot;city&quot;));</span>
<span class="nc" id="L709">				orgBean.setOrgCountry(resultSet.getString(&quot;country&quot;));</span>
<span class="nc" id="L710">				orgBean.setOrgAddr1(resultSet.getString(&quot;addr_line1&quot;));</span>

<span class="nc" id="L712">				searchResults.add(orgBean);</span>
			}

<span class="nc" id="L715">			return searchResults;</span>

<span class="nc" id="L717">		} catch (SQLException e) {</span>
<span class="nc" id="L718">			throw new LMSException(e);</span>
		}

		finally {

<span class="nc" id="L723">			try {</span>
<span class="nc bnc" id="L724" title="All 4 branches missed.">				if (resultSet != null) {</span>
<span class="nc" id="L725">					resultSet.close();</span>
				}
<span class="nc bnc" id="L727" title="All 4 branches missed.">				if (statement != null) {</span>
<span class="nc" id="L728">					statement.close();</span>
				}
<span class="nc bnc" id="L730" title="All 4 branches missed.">				if (connection != null) {</span>
<span class="nc" id="L731">					connection.close();</span>
				}
<span class="nc" id="L733">			} catch (SQLException se) {</span>
<span class="nc" id="L734">				throw new LMSException(se);</span>
<span class="nc" id="L735">			}</span>

		}

	}

	public List&lt;OrganizationBean&gt; searchOrgRetailer(
			Map&lt;String, String&gt; searchMap, int orgId) throws LMSException {

<span class="nc" id="L744">		Connection connection = null;</span>
<span class="nc" id="L745">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L746">		ResultSet resultSet = null;</span>

		try {
<span class="nc" id="L749">			OrganizationBean orgBean = null;</span>
<span class="nc" id="L750">			List&lt;OrganizationBean&gt; searchResults = new ArrayList&lt;OrganizationBean&gt;();</span>

			
	/*		String query = QueryManager.getST5_RET_ORG_SEARCH_FOR_AGENT()
					+ dynamicWhereClause + &quot; order by a.name&quot;;*/
<span class="nc" id="L755">			String appendQury =QueryManager.getAppendOrgOrder();</span>
<span class="nc" id="L756">			String orgCodeQry = &quot; a.name orgCode,d.name parentorgCode &quot;;</span>
<span class="nc" id="L757">			String parentOrgQry = &quot; name &quot;;</span>
<span class="nc" id="L758">			String orgQry = &quot; a.name &quot;;</span>

<span class="nc bnc" id="L760" title="All 2 branches missed.">			if ((LMSFilterDispatcher.orgFieldType).equalsIgnoreCase(&quot;CODE&quot;)) {</span>
<span class="nc" id="L761">				orgCodeQry = &quot; a.org_code orgCode,d.org_code parentorgCode &quot;;</span>
<span class="nc" id="L762">				parentOrgQry = &quot;  org_code  &quot;;</span>
<span class="nc" id="L763">				orgQry = &quot;  a.org_code  &quot;;</span>
			

<span class="nc bnc" id="L766" title="All 2 branches missed.">			} else if ((LMSFilterDispatcher.orgFieldType)</span>
					.equalsIgnoreCase(&quot;CODE_NAME&quot;)) {
<span class="nc" id="L768">				orgCodeQry = &quot; concat(a.org_code,'_',a.name)  orgCode,concat(d.org_code,'_',d.name)  parentorgCode &quot;;</span>
<span class="nc" id="L769">				parentOrgQry = &quot; concat(org_code,'_',name)   &quot;;</span>
<span class="nc" id="L770">				orgQry = &quot; concat(a.org_code,'_',a.name)   &quot;;</span>
				
<span class="nc bnc" id="L772" title="All 2 branches missed.">			} else if ((LMSFilterDispatcher.orgFieldType)</span>
					.equalsIgnoreCase(&quot;NAME_CODE&quot;)) {
<span class="nc" id="L774">				orgCodeQry = &quot; concat(a.name,'_',a.org_code)  orgCode,concat(d.name,'_',d.org_code)  parentorgCode &quot;;</span>
<span class="nc" id="L775">				parentOrgQry = &quot;  concat(name,'_',org_code)  &quot;;</span>
<span class="nc" id="L776">				orgQry = &quot; concat(a.name,'_',a.org_code)   &quot;;</span>
				

			}
<span class="nc" id="L780">			String dynamicWhereClause = getWhereClause(searchMap,parentOrgQry,orgQry);</span>
<span class="nc" id="L781">			String query =&quot; select a.organization_id, a.extends_credit_limit_upto ,a.organization_type,&quot;+orgCodeQry+&quot; ,a.organization_status,a.addr_line1,a.city,a.available_credit,a.credit_limit,a.security_deposit,a.extended_credit_limit,a.pwt_scrap,a.claimable_bal,b.name 'state',c.name 'country' from st_lms_organization_master a,st_lms_organization_master d,st_lms_state_master b,st_lms_country_master c where a.state_code=b.state_code and  a.country_code=c.country_code and a.parent_id=d.organization_id and a.organization_type='RETAILER' and a.parent_id=? &quot;+dynamicWhereClause+&quot; order by &quot;+appendQury;</span>
<span class="nc" id="L782">			System.out.println(&quot;-----Query----::&quot; + query);</span>

<span class="nc" id="L784">			connection = DBConnect.getConnection();</span>
<span class="nc" id="L785">			pstmt = connection.prepareStatement(query);</span>
<span class="nc" id="L786">			pstmt.setInt(1, orgId);</span>
<span class="nc" id="L787">			resultSet = pstmt.executeQuery();</span>

<span class="nc bnc" id="L789" title="All 2 branches missed.">			while (resultSet.next()) {</span>
				// System.out.println(&quot;Helper Result Set&quot;);
<span class="nc" id="L791">				orgBean = new OrganizationBean();</span>
				// userBean.setUserId(resultSet.getInt(TableConstants.USER_ID));
<span class="nc" id="L793">				orgBean.setOrgId(resultSet</span>
						.getInt(TableConstants.ORGANIZATION_ID));
<span class="nc" id="L795">				orgBean.setParentOrgName(resultSet.getString(&quot;parentorgCode&quot;));</span>
<span class="nc" id="L796">				orgBean.setParentOrgId(orgId);</span>
				// userBean.setUserName(resultSet.getString(TableConstants.USER_NAME));
<span class="nc" id="L798">				orgBean.setOrgName(resultSet.getString(&quot;orgCode&quot;));</span>
				// userBean.setUserRoleName(TableConstants.ROLE_NAME);
<span class="nc" id="L800">				orgBean.setOrgType(resultSet</span>
						.getString(TableConstants.ORGANIZATION_TYPE));
<span class="nc" id="L802">				orgBean.setOrgStatus(resultSet</span>
						.getString(TableConstants.ORGANIZATION_STATUS));
<span class="nc" id="L804">				orgBean.setOrgState(resultSet.getString(&quot;state&quot;));</span>
<span class="nc" id="L805">				orgBean.setOrgCity(resultSet.getString(&quot;city&quot;));</span>
<span class="nc" id="L806">				orgBean.setOrgCountry(resultSet.getString(&quot;country&quot;));</span>
<span class="nc" id="L807">				orgBean.setOrgAddr1(resultSet.getString(&quot;addr_line1&quot;));</span>
<span class="nc" id="L808">				orgBean.setAvailableCredit(resultSet</span>
						.getDouble(&quot;available_credit&quot;));
				// changed by arun
<span class="nc" id="L811">				int extendedCreditLimitUpto = calculateExtendsCreditLimitUpto(resultSet</span>
						.getDate(&quot;extends_credit_limit_upto&quot;));
<span class="nc" id="L813">				orgBean.setExtendsCreditLimitUpto(extendedCreditLimitUpto);</span>
<span class="nc" id="L814">				orgBean.setOrgCreditLimit(resultSet.getDouble(&quot;credit_limit&quot;));</span>
<span class="nc" id="L815">				orgBean.setExtendedCredit(resultSet</span>
						.getDouble(&quot;extended_credit_limit&quot;));
<span class="nc" id="L817">				orgBean.setClaimableBal(resultSet.getDouble(&quot;claimable_bal&quot;));// added</span>
				// by
				// amit
				// on
				// 21/09/10

				// get the last updated ledger balance of AGENT/RETAILER
<span class="nc" id="L824">				pstmt = connection</span>
						.prepareStatement(&quot;select *  from st_lms_agent_current_balance where account_type = ?&quot;);
<span class="nc" id="L826">				pstmt.setInt(1, orgBean.getOrgId());</span>
<span class="nc" id="L827">				ResultSet rsLedger = pstmt.executeQuery();</span>
<span class="nc bnc" id="L828" title="All 2 branches missed.">				if (rsLedger.next()) {</span>
<span class="nc" id="L829">					orgBean.setLedgerBalance(rsLedger</span>
							.getDouble(&quot;current_balance&quot;));
				}

<span class="nc" id="L833">				double ledgerBalance = orgBean.getAvailableCredit()</span>
						- orgBean.getOrgCreditLimit()
						- orgBean.getExtendedCredit();
<span class="nc" id="L836">				System.out.println(&quot;ledger Balance of ==&quot;</span>
						+ orgBean.getOrgName() + &quot;==  is = &quot;
						+ orgBean.getLedgerBalance()
						+ &quot;     calculated ledger = &quot; + ledgerBalance);

				// orgBean.setOrgCreditLimit(resultSet.getDouble(&quot;credit_limit&quot;)
				// + resultSet.getDouble(&quot;extended_credit_limit&quot;));
<span class="nc" id="L843">				orgBean.setSecurityDeposit(resultSet</span>
						.getDouble(&quot;security_deposit&quot;));
<span class="nc" id="L845">				searchResults.add(orgBean);</span>
<span class="nc" id="L846">			}</span>

<span class="nc" id="L848">			return searchResults;</span>

<span class="nc" id="L850">		} catch (SQLException e) {</span>
<span class="nc" id="L851">			throw new LMSException(e);</span>
		}

		finally {

<span class="nc" id="L856">			try {</span>
<span class="nc bnc" id="L857" title="All 4 branches missed.">				if (resultSet != null) {</span>
<span class="nc" id="L858">					resultSet.close();</span>
				}
<span class="nc bnc" id="L860" title="All 4 branches missed.">				if (pstmt != null) {</span>
<span class="nc" id="L861">					pstmt.close();</span>
				}
<span class="nc bnc" id="L863" title="All 12 branches missed.">				if (connection != null &amp; !connection.isClosed()) {</span>
<span class="nc" id="L864">					connection.close();</span>
				}

<span class="nc" id="L867">			} catch (SQLException se) {</span>
<span class="nc" id="L868">				throw new LMSException(se);</span>
<span class="nc" id="L869">			}</span>

		}

	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>