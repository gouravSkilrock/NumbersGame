<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>reportsMgmtUtility.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lms</a> &gt; <a href="index.source.html" class="el_package">com.skilrock.lms.web.drawGames.reportsMgmt.common</a> &gt; <span class="el_source">reportsMgmtUtility.java</span></div><h1>reportsMgmtUtility.java</h1><pre class="source lang-java linenums">package com.skilrock.lms.web.drawGames.reportsMgmt.common;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.TreeMap;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import com.skilrock.lms.common.db.DBConnect;
import com.skilrock.lms.common.exception.LMSException;
import com.skilrock.lms.common.filter.LMSFilterDispatcher;
import com.skilrock.lms.web.drawGames.common.Util;

<span class="nc" id="L26">public class reportsMgmtUtility {</span>
<span class="nc" id="L27">	private static Log logger = LogFactory.getLog(reportsMgmtUtility.class);</span>
	public static void getCommonDailyRetActivity() throws ParseException, LMSException, SQLException
	{
<span class="nc" id="L30">		String drawDate = getStartNEndDates();</span>
<span class="nc" id="L31">		String csDate = getStartNEndDatesForCS();</span>
<span class="nc" id="L32">		String slDate=getStartNEndDatesForSL();</span>
<span class="nc" id="L33">		String iwDate=getStartNEndDatesForIW();</span>
<span class="nc" id="L34">		String vsDate = getStartNEndDates(&quot;VS&quot;);</span>
<span class="nc" id="L35">		Calendar calStart = Calendar.getInstance();</span>
<span class="nc" id="L36">		Calendar calEnd = Calendar.getInstance();</span>
<span class="nc" id="L37">		Calendar calStart1 = Calendar.getInstance();</span>
<span class="nc" id="L38">		Calendar calStart2=Calendar.getInstance();</span>
<span class="nc" id="L39">		Calendar calStart3=Calendar.getInstance();</span>
<span class="nc" id="L40">		Calendar calStart4 = Calendar.getInstance();</span>
<span class="nc" id="L41">		SimpleDateFormat frmt = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span>
<span class="nc" id="L42">		Date darwDate1 = frmt.parse(drawDate);</span>
<span class="nc" id="L43">		Date csDate1 = frmt.parse(csDate);</span>
<span class="nc" id="L44">		Date slDate1=frmt.parse(slDate);</span>
<span class="nc" id="L45">		Date iwDate1=frmt.parse(iwDate);</span>
<span class="nc" id="L46">		Date vsDate1 = frmt.parse(vsDate);</span>
<span class="nc" id="L47">		System.out.println(darwDate1);</span>
<span class="nc" id="L48">		Date endDate = frmt.parse(new java.sql.Date(new Date().getTime()) + &quot;&quot;);</span>
<span class="nc" id="L49">		calStart.setTime(darwDate1);</span>
<span class="nc" id="L50">		calStart1.setTime(csDate1);</span>
<span class="nc" id="L51">		calStart2.setTime(slDate1);</span>
<span class="nc" id="L52">		calStart3.setTime(iwDate1);</span>
<span class="nc" id="L53">		calStart4.setTime(vsDate1);</span>
<span class="nc" id="L54">		calEnd.setTime(endDate);</span>
		//calEnd.add(Calendar.DAY_OF_MONTH, 1);
<span class="nc bnc" id="L56" title="All 2 branches missed.">		while (calStart.compareTo(calEnd) &lt; 0)</span>
		{
<span class="nc" id="L58">			java.sql.Date date = new java.sql.Date(calStart.getTime()</span>
					.getTime());
<span class="nc" id="L60">			String date1 = frmt.format(date);</span>
<span class="nc" id="L61">			System.out.println(date1);</span>
<span class="nc bnc" id="L62" title="All 2 branches missed.">			if(&quot;YES&quot;.equalsIgnoreCase(LMSFilterDispatcher.getIsDraw())){</span>
<span class="nc" id="L63">					getDailyRetActivity(date1);</span>
			}
<span class="nc" id="L65">			calStart.add(Calendar.DAY_OF_MONTH, 1);</span>
<span class="nc" id="L66">		}</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">		while (calStart1.compareTo(calEnd) &lt; 0)</span>
		{
<span class="nc" id="L69">			java.sql.Date secondDate = new java.sql.Date(calStart1.getTime()</span>
					.getTime());
<span class="nc" id="L71">			String date2 = frmt.format(secondDate);</span>
<span class="nc" id="L72">			System.out.println(date2);</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">			if(&quot;YES&quot;.equalsIgnoreCase(LMSFilterDispatcher.getIsCS()))</span>
			{
<span class="nc" id="L75">			  getDailyRetActivityForCS(date2);</span>
			}
<span class="nc" id="L77">			calStart1.add(Calendar.DAY_OF_MONTH, 1);</span>
<span class="nc" id="L78">		}</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">		while(calStart2.compareTo(calEnd)&lt;0)</span>
		{
<span class="nc" id="L81">			java.sql.Date date2=new java.sql.Date(calStart2.getTime().getTime());</span>
<span class="nc" id="L82">			String date3=frmt.format(date2);</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">			if(&quot;YES&quot;.equalsIgnoreCase(LMSFilterDispatcher.getIsSLE()))</span>
			{
<span class="nc" id="L85">			  getDailyRetActivityForSL(date3);</span>
			}
<span class="nc" id="L87">			calStart2.add(Calendar.DAY_OF_MONTH, 1);</span>
<span class="nc" id="L88">		}</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">		while (calStart3.compareTo(calEnd) &lt; 0) {</span>
<span class="nc" id="L90">			java.sql.Date date2 = new java.sql.Date(calStart3.getTime().getTime());</span>
<span class="nc" id="L91">			String date3 = frmt.format(date2);</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">			if (&quot;YES&quot;.equalsIgnoreCase(LMSFilterDispatcher.getIsIW())) {</span>
<span class="nc" id="L93">				getDailyRetActivityForIW(date3);</span>
			}
<span class="nc" id="L95">			calStart3.add(Calendar.DAY_OF_MONTH, 1);</span>
<span class="nc" id="L96">		}</span>

<span class="nc bnc" id="L98" title="All 2 branches missed.">		while (calStart4.compareTo(calEnd) &lt; 0) {</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">			if (&quot;YES&quot;.equalsIgnoreCase(LMSFilterDispatcher.getIsVS())) {</span>
<span class="nc" id="L100">				java.sql.Date date = new java.sql.Date(calStart4.getTime().getTime());</span>
<span class="nc" id="L101">				String dateString = frmt.format(date);</span>

<span class="nc" id="L103">				getDailyRetActivityForVS(dateString);</span>
			}
<span class="nc" id="L105">			calStart4.add(Calendar.DAY_OF_MONTH, 1);</span>
		}
<span class="nc" id="L107">	}</span>

	public static String getStartNEndDates() {
<span class="nc" id="L110">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L111">		Date startDate = null;</span>
<span class="nc" id="L112">		StringBuffer sb = new StringBuffer();</span>
		try {
<span class="nc" id="L114">			con.setAutoCommit(false);</span>
<span class="nc" id="L115">			PreparedStatement pStatement = con</span>
					.prepareStatement(&quot;SELECT date FROM st_lms_ret_activity_history ORDER BY date DESC LIMIT 1&quot;);
<span class="nc" id="L117">			ResultSet rSet = pStatement.executeQuery();</span>
<span class="nc" id="L118">			SimpleDateFormat sdf = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">			while (rSet.next()) {</span>
<span class="nc" id="L120">				startDate = rSet.getDate(&quot;date&quot;);</span>
			}
<span class="nc" id="L122">			Calendar calStart = Calendar.getInstance();</span>
<span class="nc" id="L123">			java.util.Date currDate = new java.util.Date(calStart</span>
					.getTimeInMillis());
<span class="nc bnc" id="L125" title="All 2 branches missed.">						if(startDate!=null)</span>
						{
<span class="nc" id="L127">							calStart.setTime(startDate);</span>
<span class="nc" id="L128">							calStart.add(Calendar.DAY_OF_MONTH, 1);</span>
						}
						else
						{
<span class="nc" id="L132">							calStart.setTime(currDate);	</span>
<span class="nc" id="L133">							calStart.add(Calendar.DAY_OF_MONTH, -1);</span>
						}
<span class="nc" id="L135">						sb.append(sdf.format(calStart.getTimeInMillis()));</span>
<span class="nc" id="L136">					con.commit();</span>
<span class="nc" id="L137">		} catch (Exception e) {</span>
<span class="nc" id="L138">			e.printStackTrace();</span>
		}
		finally {
<span class="nc" id="L141">			try {</span>
<span class="nc" id="L142">				con.close();</span>
<span class="nc" id="L143">			} catch (SQLException e) {</span>
<span class="nc" id="L144">				e.printStackTrace();</span>
<span class="nc" id="L145">			}</span>
<span class="nc" id="L146">		}</span>
<span class="nc" id="L147">		System.out.println(sb.toString());</span>
<span class="nc" id="L148">		return sb.toString();</span>
	}
	public static String getStartNEndDatesForSL()
	{
<span class="nc" id="L152">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L153">		Date startDate = null;</span>
<span class="nc" id="L154">		StringBuffer sb = new StringBuffer();</span>
		try {
<span class="nc" id="L156">			con.setAutoCommit(false);</span>
<span class="nc" id="L157">			PreparedStatement pStatement = con</span>
					.prepareStatement(&quot;SELECT date FROM st_sle_ret_activity_history ORDER BY date DESC LIMIT 1&quot;);
<span class="nc" id="L159">			ResultSet rSet = pStatement.executeQuery();</span>
<span class="nc" id="L160">			SimpleDateFormat sdf = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">			while (rSet.next()) {</span>
<span class="nc" id="L162">				startDate = rSet.getDate(&quot;date&quot;);</span>
			}
<span class="nc" id="L164">			Calendar calStart = Calendar.getInstance();</span>
<span class="nc" id="L165">			java.util.Date currDate = new java.util.Date(calStart</span>
					.getTimeInMillis());
<span class="nc bnc" id="L167" title="All 2 branches missed.">						if(startDate!=null)</span>
						{
<span class="nc" id="L169">							calStart.setTime(startDate);</span>
<span class="nc" id="L170">							calStart.add(Calendar.DAY_OF_MONTH, 1);</span>
						}
						else
						{
<span class="nc" id="L174">							calStart.setTime(currDate);	</span>
<span class="nc" id="L175">							calStart.add(Calendar.DAY_OF_MONTH, -1);</span>
						}
<span class="nc" id="L177">						sb.append(sdf.format(calStart.getTimeInMillis()));</span>
<span class="nc" id="L178">					con.commit();</span>
<span class="nc" id="L179">		} catch (Exception e) {</span>
<span class="nc" id="L180">			e.printStackTrace();</span>
		}
		finally {
<span class="nc" id="L183">			try {</span>
<span class="nc" id="L184">				con.close();</span>
<span class="nc" id="L185">			} catch (SQLException e) {</span>
<span class="nc" id="L186">				e.printStackTrace();</span>
<span class="nc" id="L187">			}</span>
<span class="nc" id="L188">		}</span>
<span class="nc" id="L189">		System.out.println(sb.toString());</span>
<span class="nc" id="L190">		return sb.toString();</span>
	}
	
	public static String getStartNEndDatesForIW() {
<span class="nc" id="L194">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L195">		Date startDate = null;</span>
<span class="nc" id="L196">		StringBuffer sb = new StringBuffer();</span>
		try {
<span class="nc" id="L198">			con.setAutoCommit(false);</span>
<span class="nc" id="L199">			PreparedStatement pStatement = con.prepareStatement(&quot;SELECT date FROM st_iw_ret_activity_history ORDER BY date DESC LIMIT 1&quot;);</span>
<span class="nc" id="L200">			ResultSet rSet = pStatement.executeQuery();</span>
<span class="nc" id="L201">			SimpleDateFormat sdf = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">			while (rSet.next()) {</span>
<span class="nc" id="L203">				startDate = rSet.getDate(&quot;date&quot;);</span>
			}
<span class="nc" id="L205">			Calendar calStart = Calendar.getInstance();</span>
<span class="nc" id="L206">			java.util.Date currDate = new java.util.Date(calStart.getTimeInMillis());</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">			if (startDate != null) {</span>
<span class="nc" id="L208">				calStart.setTime(startDate);</span>
<span class="nc" id="L209">				calStart.add(Calendar.DAY_OF_MONTH, 1);</span>
			} else {
<span class="nc" id="L211">				calStart.setTime(currDate);</span>
<span class="nc" id="L212">				calStart.add(Calendar.DAY_OF_MONTH, -1);</span>
			}
<span class="nc" id="L214">			sb.append(sdf.format(calStart.getTimeInMillis()));</span>
<span class="nc" id="L215">			con.commit();</span>
<span class="nc" id="L216">		} catch (Exception e) {</span>
<span class="nc" id="L217">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L219">			try {</span>
<span class="nc" id="L220">				con.close();</span>
<span class="nc" id="L221">			} catch (SQLException e) {</span>
<span class="nc" id="L222">				e.printStackTrace();</span>
<span class="nc" id="L223">			}</span>
<span class="nc" id="L224">		}</span>
<span class="nc" id="L225">		System.out.println(sb.toString());</span>
<span class="nc" id="L226">		return sb.toString();</span>
	}

	public static String getStartNEndDates(String serviceName) {
<span class="nc" id="L230">		Connection connection = null;</span>
<span class="nc" id="L231">		Statement stmt = null;</span>
<span class="nc" id="L232">		ResultSet rs = null;</span>

<span class="nc" id="L234">		SimpleDateFormat dateFormat = null;</span>
<span class="nc" id="L235">		String returnDate = null;</span>
		try {
<span class="nc" id="L237">			dateFormat = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span>

<span class="nc" id="L239">			String tableName = null;</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">			if(&quot;VS&quot;.equals(serviceName))</span>
<span class="nc" id="L241">				tableName = &quot;st_vs_ret_activity_history&quot;;</span>
<span class="nc" id="L242">			String query = &quot;SELECT date FROM &quot;+tableName+&quot; ORDER BY date DESC LIMIT 1;&quot;;</span>

<span class="nc" id="L244">			connection = DBConnect.getConnection();</span>
<span class="nc" id="L245">			stmt = connection.createStatement();</span>
<span class="nc" id="L246">			logger.info(&quot;getStartNEndDates - &quot;+query);</span>
<span class="nc" id="L247">			rs = stmt.executeQuery(query);</span>
<span class="nc" id="L248">			Date startDate = null;</span>
<span class="nc bnc" id="L249" title="All 2 branches missed.">			if (rs.next())</span>
<span class="nc" id="L250">				startDate = rs.getDate(&quot;date&quot;);</span>

<span class="nc" id="L252">			Calendar calendar = Calendar.getInstance();</span>
<span class="nc" id="L253">			Date currentDate = new java.util.Date();</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">			if (startDate != null) {</span>
<span class="nc" id="L255">				calendar.setTime(startDate);</span>
<span class="nc" id="L256">				calendar.add(Calendar.DAY_OF_MONTH, 1);</span>
			} else {
<span class="nc" id="L258">				calendar.setTime(currentDate);</span>
<span class="nc" id="L259">				calendar.add(Calendar.DAY_OF_MONTH, -1);</span>
			}

<span class="nc" id="L262">			returnDate = dateFormat.format(calendar.getTimeInMillis());</span>
<span class="nc" id="L263">		} catch (Exception e) {</span>
<span class="nc" id="L264">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L266">			DBConnect.closeResource(connection);</span>
<span class="nc" id="L267">		}</span>

<span class="nc" id="L269">		logger.info(&quot;Return Date - &quot;+returnDate);</span>
<span class="nc" id="L270">		return returnDate.toString();</span>
	}

	public static String getStartNEndDatesForCS() {
<span class="nc" id="L274">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L275">		Date startDate = null;</span>
<span class="nc" id="L276">		StringBuffer sb = new StringBuffer();</span>
		try {
<span class="nc" id="L278">			con.setAutoCommit(false);</span>
<span class="nc" id="L279">			PreparedStatement pStatement = con</span>
					.prepareStatement(&quot;SELECT date FROM st_cs_ret_activity_history ORDER BY date DESC LIMIT 1&quot;);
<span class="nc" id="L281">			ResultSet rSet = pStatement.executeQuery();</span>
<span class="nc" id="L282">			SimpleDateFormat sdf = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">			while (rSet.next()) {</span>
<span class="nc" id="L284">				startDate = rSet.getDate(&quot;date&quot;);</span>
			}
<span class="nc" id="L286">			Calendar calStart = Calendar.getInstance();</span>
<span class="nc" id="L287">			java.util.Date currDate = new java.util.Date(calStart</span>
					.getTimeInMillis());
<span class="nc bnc" id="L289" title="All 2 branches missed.">						if(startDate!=null)</span>
						{
<span class="nc" id="L291">							calStart.setTime(startDate);</span>
<span class="nc" id="L292">							calStart.add(Calendar.DAY_OF_MONTH, 1);</span>
						}
						else
						{
<span class="nc" id="L296">							calStart.setTime(currDate);	</span>
<span class="nc" id="L297">							calStart.add(Calendar.DAY_OF_MONTH, -1);</span>
						}
<span class="nc" id="L299">						sb.append(sdf.format(calStart.getTimeInMillis()));</span>
<span class="nc" id="L300">					con.commit();</span>
<span class="nc" id="L301">		} catch (Exception e) {</span>
<span class="nc" id="L302">			e.printStackTrace();</span>
		}
		finally {
<span class="nc" id="L305">			try {</span>
<span class="nc" id="L306">				con.close();</span>
<span class="nc" id="L307">			} catch (SQLException e) {</span>
<span class="nc" id="L308">				e.printStackTrace();</span>
<span class="nc" id="L309">			}</span>
<span class="nc" id="L310">		}</span>
<span class="nc" id="L311">		System.out.println(sb.toString());</span>
<span class="nc" id="L312">		return sb.toString();</span>
	}
	public static void getDailyRetActivity(String date) throws LMSException{
	// TreeMap&lt;Integer, ArrayList&lt;Double&gt;&gt; gameDataMap = new TreeMap&lt;Integer, ArrayList&lt;Double&gt;&gt;();
		 
<span class="nc" id="L317">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L318">		ResultSet rs = null;</span>
<span class="nc" id="L319">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L320">		ArrayList&lt;Double&gt; totAmt = null;</span>
<span class="nc" id="L321">		int gameNum = 0;</span>
		//List&lt;Integer&gt; gameNumList = Util.getGameNumberList();
<span class="nc" id="L323">		List&lt;Integer&gt; gameNumList =Util.getLMSGameNumberList();</span>

<span class="nc" id="L325">		int liveRets = 0;</span>
<span class="nc" id="L326">		int noSaleRets = 0;</span>
<span class="nc" id="L327">		int inactiveRets = 0;</span>
<span class="nc" id="L328">		int terminateRets = 0;</span>
<span class="nc" id="L329">		double totalSale = 0.0;</span>
<span class="nc" id="L330">		double totalPwt = 0.0;</span>
<span class="nc" id="L331">		int totTktCnt = 0;</span>
<span class="nc" id="L332">		int totPwtCnt = 0;</span>
<span class="nc" id="L333">		double avgSalePerRet = 0.0;</span>

		//String date = new java.sql.Date(new Date().getTime()) + &quot;&quot;;

<span class="nc" id="L337">		String fromDate = date + &quot; 00:00:00&quot;;</span>
<span class="nc" id="L338">		String toDate = date + &quot; 23:59:59&quot;;</span>
<span class="nc" id="L339">		String trxDate = &quot;transaction_date&gt;'&quot; + fromDate</span>
				+ &quot;' and transaction_date&lt;'&quot; + toDate + &quot;'&quot;;
<span class="nc" id="L341">		String retQry = &quot;select count(distinct(retailer_org_id)) retCount from st_lms_retailer_transaction_master where transaction_type not in ('CS_SALE','CS_CANCEL_SERVER','CS_CANCEL_RET') and &quot;</span>
				+ trxDate;

<span class="nc" id="L344">		String trxQry = &quot;select transaction_id from st_lms_retailer_transaction_master where &quot;</span>
				+ trxDate;
<span class="nc" id="L346">		String saleQry = &quot;select sum(mrp_amt) res from st_dg_ret_sale_? where transaction_id in (&quot;</span>
				+ trxQry + &quot;)&quot;;
<span class="nc" id="L348">		String saleRetQry = &quot;select sum(mrp_amt) res  from st_dg_ret_sale_refund_? where transaction_id in (&quot;</span>
				+ trxQry + &quot;)&quot;;
<span class="nc" id="L350">		String pwtQry = &quot;select sum(pwt_amt) res from st_dg_ret_pwt_? where transaction_id in (&quot;</span>
				+ trxQry + &quot;)&quot;;
<span class="nc" id="L352">		String combinedQry = saleQry + &quot; union all &quot; + saleRetQry</span>
				+ &quot; union all &quot; + pwtQry;

<span class="nc" id="L355">		String dirPlrQry = &quot;select if(a.pwt_amt is null ,0,a.pwt_amt)+if(b.pwt_amt is null ,0,b.pwt_amt) dirPwt from (select sum(pwt_amt) pwt_amt from st_dg_bo_direct_plr_pwt where &quot;</span>
				+ trxDate
				+ &quot;) a,(select sum(pwt_amt) pwt_amt from st_dg_agt_direct_plr_pwt where &quot;
				+ trxDate + &quot;) b&quot;;
<span class="nc" id="L359">		String retSelQry=&quot;select count(distinct(organization_id)) retCount from st_lms_organization_master where organization_type='RETAILER'&quot;;</span>
<span class="nc" id="L360">		String inactiveQry=retSelQry+&quot; and organization_status='INACTIVE'&quot;;</span>
<span class="nc" id="L361">		String terQry=retSelQry+&quot; and organization_status='TERMINATE'&quot;;</span>
		//String nosaleQry=retSelQry+&quot; and organization_status='ACTIVE' and organization_id not in (select distinct(retailer_org_id) from st_lms_retailer_transaction_master where transaction_type not in ('CS_SALE','CS_CANCEL_SERVER','CS_CANCEL_RET') and &quot;+trxDate+&quot; )&quot;;
<span class="nc" id="L363">		String nosaleQry=&quot; SELECT count(distinct(a.organization_id)) retCount from ( (select distinct(organization_id) from st_lms_organization_master where organization_type='RETAILER' and organization_status='ACTIVE')a LEFT JOIN (select distinct(retailer_org_id) retailer_org_id from st_lms_retailer_transaction_master where transaction_type not in ('CS_SALE','CS_CANCEL_SERVER','CS_CANCEL_RET')&quot;+ </span>
							&quot; and &quot;+trxDate+&quot; )b on a.organization_id=b.retailer_org_id )WHERE b.retailer_org_id IS NULL&quot;;
<span class="nc" id="L365">		String combinedCntQry=retQry+&quot; union all &quot;+inactiveQry+&quot; union all &quot;+terQry+&quot; union all &quot;+nosaleQry;</span>
<span class="nc" id="L366">		double tempRetPwt=0.0;</span>
		try {
<span class="nc bnc" id="L368" title="All 2 branches missed.">		for (int i = 0; i &lt; gameNumList.size(); i++) {</span>
<span class="nc" id="L369">			gameNum = gameNumList.get(i);</span>
<span class="nc" id="L370">			totAmt = new ArrayList&lt;Double&gt;();</span>
<span class="nc" id="L371">			pstmt = con.prepareStatement(combinedQry);</span>
<span class="nc" id="L372">			pstmt.setInt(1, gameNum);</span>
<span class="nc" id="L373">			pstmt.setInt(2, gameNum);</span>
<span class="nc" id="L374">			pstmt.setInt(3, gameNum);</span>
<span class="nc" id="L375">			System.out.println(&quot;Q1:&quot;+pstmt);</span>
<span class="nc" id="L376">			rs = pstmt.executeQuery();</span>
				
			
<span class="nc bnc" id="L379" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L380">				totAmt.add(rs.getDouble(&quot;res&quot;));</span>
			}
<span class="nc" id="L382">			totalSale+=(totAmt.get(0)-totAmt.get(1));</span>
<span class="nc" id="L383">			tempRetPwt+=totAmt.get(2);</span>
			//gameDataMap.put(gameNum, totAmt);
		}
		// direct player pwt 
<span class="nc" id="L387">		double dirPlrPwt=0.0;</span>
<span class="nc" id="L388">		pstmt = con.prepareStatement(dirPlrQry);</span>
<span class="nc" id="L389">		System.out.println(&quot;Q1:&quot;+pstmt);</span>
<span class="nc" id="L390">		rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L391" title="All 2 branches missed.">		if (rs.next()) {</span>
<span class="nc" id="L392">			dirPlrPwt = rs.getInt(&quot;dirPwt&quot;);</span>
		}
		
		// total sale &amp; Pwt
		/*double tempRetPwt=0.0;
		Iterator&lt;Map.Entry&lt;Integer, ArrayList&lt;Double&gt;&gt;&gt; itr = gameDataMap.entrySet().iterator();
		while (itr.hasNext()){
			Map.Entry&lt;Integer, ArrayList&lt;Double&gt;&gt; pair = itr.next();
			ArrayList&lt;Double&gt; list = (ArrayList&lt;Double&gt;)pair.getValue();
			totalSale+=(list.get(0)-list.get(1));
			tempRetPwt+=list.get(2);
			
		}*/
<span class="nc" id="L405">		totalPwt = tempRetPwt+dirPlrPwt;</span>
		
		// Retailer count query
<span class="nc" id="L408">		pstmt=con.prepareStatement(combinedCntQry);</span>
<span class="nc" id="L409">		System.out.println(&quot;combined query:&quot;+combinedCntQry);</span>
<span class="nc" id="L410">		rs=pstmt.executeQuery();</span>
<span class="nc" id="L411">		List&lt;Integer&gt; retCntList = new ArrayList&lt;Integer&gt;();</span>
<span class="nc bnc" id="L412" title="All 2 branches missed.">		while(rs.next()){</span>
<span class="nc" id="L413">			retCntList.add(rs.getInt(&quot;retCount&quot;));</span>
		}
		
<span class="nc bnc" id="L416" title="All 2 branches missed.">		if(retCntList.size()&gt;0){</span>
<span class="nc" id="L417">			liveRets=retCntList.get(0);</span>
<span class="nc" id="L418">			inactiveRets=retCntList.get(1);</span>
<span class="nc" id="L419">			terminateRets=retCntList.get(2);</span>
<span class="nc" id="L420">			noSaleRets=retCntList.get(3);</span>
		}
		
		
		// calculating avgSalePerRet 
<span class="nc bnc" id="L425" title="All 4 branches missed.">		if(totalSale != 0.0 &amp;&amp; liveRets !=0)</span>
<span class="nc" id="L426">			 avgSalePerRet = totalSale/liveRets;</span>
			
		/*
		// total noSale rets
		pstmt = con
				.prepareStatement(&quot;select count(distinct(organization_id)) retNSCount from &quot; +
						&quot;st_lms_organization_master where organization_type='RETAILER' and &quot; +
						&quot;organization_status='ACTIVE' and organization_id not &quot; +
						&quot;in (select distinct(retailer_org_id) from st_lms_retailer_transaction_master where &quot;+trxDate+&quot; )&quot;);
		System.out.println(&quot;Q1:&quot;+pstmt);
		rs = pstmt.executeQuery();
		if (rs.next()) {
			noSaleRets = rs.getInt(&quot;retNSCount&quot;);
		}
		// total Live Rets
		pstmt = con.prepareStatement(retQry);
		System.out.println(&quot;Q1:&quot;+pstmt);
		rs = pstmt.executeQuery();
		if (rs.next()) {
			liveRets = rs.getInt(&quot;retCount&quot;);
		}
		// total Inactive rets
		pstmt = con
				.prepareStatement(&quot;select count(distinct(organization_id)) retInCount from &quot; +
						&quot;st_lms_organization_master where organization_type='RETAILER'&quot; +
						&quot; and organization_status='INACTIVE'&quot;);
		System.out.println(&quot;Q1:&quot;+pstmt);
		rs = pstmt.executeQuery();
		if (rs.next()) {
			inactiveRets = rs.getInt(&quot;retInCount&quot;);
		}
		// total terminate rets
		pstmt = con
				.prepareStatement(&quot;select count(distinct(organization_id)) retTrCount from &quot; +
						&quot;st_lms_organization_master where organization_type='RETAILER'&quot; +
						&quot; and organization_status='TERMINATE'&quot;);
		System.out.println(&quot;Q1:&quot;+pstmt);
		rs = pstmt.executeQuery();
		if (rs.next()) {
			terminateRets = rs.getInt(&quot;retTrCount&quot;);
		}*/
		
		
		
		// total ticket sold 
<span class="nc" id="L471">		pstmt = con.prepareStatement(&quot;select (sale.saleCnt - ref.refCnt) as netSaleCnt from &quot; +</span>
				&quot;(select ifnull(count(*),0) saleCnt from st_lms_retailer_transaction_master where (&quot;+trxDate+&quot;) and &quot; +
						&quot;(transaction_type ='DG_SALE' or transaction_type='DG_SALE_OFFLINE') )sale,&quot; +
						&quot;(select ifnull(count(*),0)refCnt from st_lms_retailer_transaction_master where (&quot;+
						trxDate+&quot;) and (transaction_type ='DG_REFUND_CANCEL' or transaction_type='DG_REFUND_FAILED'))ref&quot;);
<span class="nc" id="L476">		System.out.println(&quot;Q1:&quot;+pstmt);</span>
<span class="nc" id="L477">		rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L478" title="All 2 branches missed.">		if (rs.next()) {</span>
<span class="nc" id="L479">			totTktCnt = rs.getInt(&quot;netSaleCnt&quot;);</span>
		}
		//total PWT count 
<span class="nc" id="L482">		pstmt = con.prepareStatement(&quot;select (ret.retPwt+agt.agtPwt+bo.boPwt) as pwtCnt from &quot; +</span>
				&quot;((select ifnull(count(*),0) retPwt  from  st_lms_retailer_transaction_master where &quot;+trxDate +&quot; and  &quot; +
						&quot;transaction_type='DG_PWT'))ret,(select ifnull(count(*),0) agtPwt from st_dg_agt_direct_plr_pwt where &quot;+
						trxDate + &quot;)agt,(select ifnull(count(*),0) boPwt from st_dg_bo_direct_plr_pwt where &quot;+trxDate+&quot; )bo&quot; );
<span class="nc" id="L486">		System.out.println(&quot;Q1:&quot;+pstmt);</span>
<span class="nc" id="L487">		rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L488" title="All 2 branches missed.">		if (rs.next()) {</span>
<span class="nc" id="L489">			totPwtCnt = rs.getInt(&quot;pwtCnt&quot;);</span>
		}
			
		// done columns
<span class="nc" id="L493">		System.out.println(&quot;liveRets:&quot; + liveRets);</span>
<span class="nc" id="L494">		System.out.println(&quot;inactiveRets:&quot; + inactiveRets);</span>
<span class="nc" id="L495">		System.out.println(&quot;terminateRets:&quot; + terminateRets);</span>
<span class="nc" id="L496">		System.out.println(&quot;noSaleRets:&quot; + noSaleRets);</span>
<span class="nc" id="L497">		System.out.println(&quot;totalSale:&quot; + totalSale);</span>
<span class="nc" id="L498">		System.out.println(&quot;totalPwt:&quot; + totalPwt);</span>
<span class="nc" id="L499">		System.out.println(&quot;avgSalePerRet:&quot; + avgSalePerRet);</span>
<span class="nc" id="L500">		System.out.println(&quot;totTktCnt:&quot; + totTktCnt);</span>
<span class="nc" id="L501">		System.out.println(&quot;totPwtCnt:&quot; + totPwtCnt);</span>
<span class="nc" id="L502">		String insertvalues = &quot;insert into st_lms_ret_activity_history (date,live_retailers,noSale_retailers,inactive_retailers,terminated_retailers,total_sales,total_pwt,total_tkt_count,total_pwt_count,avg_sale_per_ret) values (?,?,?,?,?,?,?,?,?,?)&quot;;</span>
<span class="nc" id="L503">		pstmt=con.prepareStatement(insertvalues);</span>
<span class="nc" id="L504">		pstmt.setString(1,fromDate);</span>
<span class="nc" id="L505">		pstmt.setInt(2, liveRets);</span>
<span class="nc" id="L506">		pstmt.setInt(3, noSaleRets);</span>
<span class="nc" id="L507">		pstmt.setInt(4, inactiveRets);</span>
<span class="nc" id="L508">		pstmt.setInt(5, terminateRets);</span>
<span class="nc" id="L509">		pstmt.setDouble(6, totalSale);</span>
<span class="nc" id="L510">		pstmt.setDouble(7, totalPwt);</span>
<span class="nc" id="L511">		pstmt.setInt(8,totTktCnt);</span>
<span class="nc" id="L512">		pstmt.setInt(9, totPwtCnt);</span>
<span class="nc" id="L513">		pstmt.setDouble(10, avgSalePerRet);</span>
<span class="nc" id="L514">		System.out.println(&quot;Q1:&quot;+pstmt);</span>
<span class="nc" id="L515">		pstmt.executeUpdate();</span>
<span class="nc" id="L516">		rs = pstmt.getGeneratedKeys();</span>
<span class="nc" id="L517">		int retActId =0 ;</span>
<span class="nc bnc" id="L518" title="All 2 branches missed.">		if(rs.next()){</span>
<span class="nc" id="L519">			retActId=rs.getInt(1);</span>
		}
<span class="nc bnc" id="L521" title="All 2 branches missed.">		if(retActId&gt;0)</span>
<span class="nc" id="L522">			System.out.println(&quot;Data for the day :&quot;+date+&quot; inserted successfully &quot;);</span>
		else
<span class="nc" id="L524">			System.out.println(&quot;Data for the day :&quot;+date+&quot;not inserted &quot;);</span>
<span class="nc" id="L525">		} catch (SQLException e) {</span>
<span class="nc" id="L526">			logger.info(&quot;SQL Exception &quot;,e);</span>
<span class="nc" id="L527">			throw new LMSException(&quot;SQL Exception &quot;+e.getMessage());</span>
<span class="nc" id="L528">		}catch (Exception e) {</span>
<span class="nc" id="L529">			logger.info(&quot;Exception &quot;,e);</span>
<span class="nc" id="L530">			throw new LMSException(&quot;Exception&quot;+e.getMessage());</span>
		} finally {
<span class="nc" id="L532">			DBConnect.closeCon(con);</span>
<span class="nc" id="L533">		}</span>
<span class="nc" id="L534">	}</span>

public static void getDailyRetActivityForSL(String date) throws LMSException,SQLException
{
<span class="nc" id="L538">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L539">		ResultSet rs = null;</span>
<span class="nc" id="L540">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L541">		ArrayList&lt;Double&gt; totAmt = null;</span>
<span class="nc" id="L542">		int liveRets = 0;</span>
<span class="nc" id="L543">		int noSaleRets = 0;</span>
<span class="nc" id="L544">		int inactiveRets = 0;</span>
<span class="nc" id="L545">		int terminateRets = 0;</span>
<span class="nc" id="L546">		double totalSale = 0.0;</span>
<span class="nc" id="L547">		double totalPwt = 0.0;</span>
<span class="nc" id="L548">		int totTktCnt = 0;</span>
<span class="nc" id="L549">		int totPwtCnt = 0;</span>
<span class="nc" id="L550">		double avgSalePerRet = 0.0;</span>

<span class="nc" id="L552">		String fromDate = date + &quot; 00:00:00&quot;;</span>
<span class="nc" id="L553">		String toDate = date + &quot; 23:59:59&quot;;</span>
<span class="nc" id="L554">		String trxDate = &quot;transaction_date&gt;'&quot; + fromDate</span>
				+ &quot;' and transaction_date&lt;'&quot; + toDate + &quot;'&quot;;
<span class="nc" id="L556">		String retQry = &quot;select count(distinct(retailer_org_id)) retCount from st_lms_retailer_transaction_master where transaction_type in ('SLE_PWT','SLE_REFUND_CANCEL','SLE_SALE') and &quot;</span>
				+ trxDate;
<span class="nc" id="L558">		String trxQry = &quot;select transaction_id from st_lms_retailer_transaction_master where &quot;</span>
				+ trxDate;
<span class="nc" id="L560">		String saleQry = &quot;select sum(mrp_amt) res from st_sle_ret_sale where transaction_id in (&quot;</span>
				+ trxQry + &quot;)&quot;;
<span class="nc" id="L562">		String saleRetQry = &quot;select sum(mrp_amt) res  from st_sle_ret_sale_refund where transaction_id in (&quot;</span>
				+ trxQry + &quot;)&quot;;
<span class="nc" id="L564">		String pwtQry = &quot;select sum(pwt_amt) res from st_sle_ret_pwt where transaction_id in (&quot;</span>
				+ trxQry + &quot;)&quot;;
<span class="nc" id="L566">		String combinedQry = saleQry + &quot; union all &quot; + saleRetQry</span>
				+ &quot; union all &quot; + pwtQry;
<span class="nc" id="L568">		String dirPlrQry = &quot;select if(a.pwt_amt is null ,0,a.pwt_amt)+if(b.pwt_amt is null ,0,b.pwt_amt) dirPwt from (select sum(pwt_amt) pwt_amt from st_sle_bo_direct_plr_pwt where &quot;</span>
				+ trxDate
				+ &quot;) a,(select sum(pwt_amt) pwt_amt from st_sle_agent_direct_plr_pwt where &quot;
				+ trxDate + &quot;) b&quot;;
<span class="nc" id="L572">		String retSelQry=&quot;select count(distinct(organization_id)) retCount from st_lms_organization_master where organization_type='RETAILER'&quot;;</span>
<span class="nc" id="L573">		String inactiveQry=retSelQry+&quot; and organization_status='INACTIVE'&quot;;</span>
<span class="nc" id="L574">		String terQry=retSelQry+&quot; and organization_status='TERMINATE'&quot;;</span>
<span class="nc" id="L575">		String nosaleQry=&quot; SELECT count(distinct(a.organization_id)) retCount from ( (select distinct(organization_id) from st_lms_organization_master where organization_type='RETAILER' and organization_status='ACTIVE')a LEFT JOIN (select distinct(retailer_org_id) retailer_org_id from st_lms_retailer_transaction_master where transaction_type in ('SLE_PWT','SLE_REFUND_CANCEL','SLE_SALE')&quot;+ </span>
							&quot; and &quot;+trxDate+&quot; )b on a.organization_id=b.retailer_org_id )WHERE b.retailer_org_id IS NULL&quot;;
<span class="nc" id="L577">		String combinedCntQry=retQry+&quot; union all &quot;+inactiveQry+&quot; union all &quot;+terQry+&quot; union all &quot;+nosaleQry;</span>
<span class="nc" id="L578">		double tempRetPwt=0.0;</span>
		try {
<span class="nc" id="L580">			totAmt = new ArrayList&lt;Double&gt;();</span>
<span class="nc" id="L581">			pstmt = con.prepareStatement(combinedQry);</span>
<span class="nc" id="L582">			logger.info(&quot;Combined query for sale,sale_refund and pwt:&quot;+pstmt);</span>
<span class="nc" id="L583">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L584" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L585">				totAmt.add(rs.getDouble(&quot;res&quot;));</span>
			}
<span class="nc" id="L587">			totalSale += (totAmt.get(0) - totAmt.get(1));</span>
<span class="nc" id="L588">			tempRetPwt += totAmt.get(2);</span>
			// direct player pwt
<span class="nc" id="L590">			double dirPlrPwt = 0.0;</span>
<span class="nc" id="L591">			pstmt = con.prepareStatement(dirPlrQry);</span>
<span class="nc" id="L592">			logger.info(&quot;Query for direct player pwt:&quot; + pstmt);</span>
<span class="nc" id="L593">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L594" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L595">				dirPlrPwt = rs.getInt(&quot;dirPwt&quot;);</span>
			}
			// total sale &amp; Pwt
<span class="nc" id="L598">			totalPwt = tempRetPwt + dirPlrPwt;</span>
			// Retailer count query
<span class="nc" id="L600">			pstmt = con.prepareStatement(combinedCntQry);</span>
<span class="nc" id="L601">			logger.info(&quot;combined query:&quot;+combinedCntQry);</span>
<span class="nc" id="L602">			rs = pstmt.executeQuery();</span>
<span class="nc" id="L603">			List&lt;Integer&gt; retCntList = new ArrayList&lt;Integer&gt;();</span>
<span class="nc bnc" id="L604" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L605">				retCntList.add(rs.getInt(&quot;retCount&quot;));</span>
			}
<span class="nc bnc" id="L607" title="All 2 branches missed.">			if (retCntList.size() &gt; 0) {</span>
<span class="nc" id="L608">				liveRets = retCntList.get(0);</span>
<span class="nc" id="L609">				inactiveRets = retCntList.get(1);</span>
<span class="nc" id="L610">				terminateRets = retCntList.get(2);</span>
<span class="nc" id="L611">				noSaleRets = retCntList.get(3);</span>
			}
			// calculating avgSalePerRet
<span class="nc bnc" id="L614" title="All 4 branches missed.">			if (totalSale != 0.0 &amp;&amp; liveRets != 0)</span>
<span class="nc" id="L615">				avgSalePerRet = totalSale / liveRets;</span>
			// total ticket sold
<span class="nc" id="L617">			pstmt = con</span>
					.prepareStatement(&quot;select (sale.saleCnt - ref.refCnt) as netSaleCnt from &quot;
							+ &quot;(select ifnull(count(*),0) saleCnt from st_lms_retailer_transaction_master where (&quot;
							+ trxDate
							+ &quot;) and &quot;
							+ &quot;(transaction_type ='SLE_SALE') )sale,&quot;
							+ &quot;(select ifnull(count(*),0)refCnt from st_lms_retailer_transaction_master where (&quot;
							+ trxDate
							+ &quot;) and (transaction_type ='SLE_REFUND_CANCEL'))ref&quot;);
			
<span class="nc" id="L627">			logger.info(&quot;Q1:&quot;+pstmt);</span>
<span class="nc" id="L628">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L629" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L630">				totTktCnt = rs.getInt(&quot;netSaleCnt&quot;);</span>
			}
			// total PWT count
<span class="nc" id="L633">			pstmt = con</span>
					.prepareStatement(&quot;select (ret.retPwt+agt.agtPwt+bo.boPwt) as pwtCnt from &quot;
							+ &quot;((select ifnull(count(*),0) retPwt  from  st_lms_retailer_transaction_master where &quot;
							+ trxDate
							+ &quot; and  &quot;
							+ &quot;transaction_type='SLE_PWT'))ret,(select ifnull(count(*),0) agtPwt from st_sle_agent_direct_plr_pwt where &quot;
							+ trxDate
							+ &quot;)agt,(select ifnull(count(*),0) boPwt from st_sle_bo_direct_plr_pwt where &quot;
							+ trxDate + &quot; )bo&quot;);
<span class="nc" id="L642">			logger.info(&quot;Q1:&quot;+pstmt);</span>
<span class="nc" id="L643">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L644" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L645">				totPwtCnt = rs.getInt(&quot;pwtCnt&quot;);</span>
			}
			// done columns
<span class="nc" id="L648">			logger.info(&quot;liveRets:&quot; + liveRets);</span>
<span class="nc" id="L649">			logger.info(&quot;inactiveRets:&quot; + inactiveRets);</span>
<span class="nc" id="L650">			logger.info(&quot;terminateRets:&quot; + terminateRets);</span>
<span class="nc" id="L651">			logger.info(&quot;noSaleRets:&quot; + noSaleRets);</span>
<span class="nc" id="L652">			logger.info(&quot;totalSale:&quot; + totalSale);</span>
<span class="nc" id="L653">			logger.info(&quot;totalPwt:&quot; + totalPwt);</span>
<span class="nc" id="L654">			logger.info(&quot;avgSalePerRet:&quot; + avgSalePerRet);</span>
<span class="nc" id="L655">			logger.info(&quot;totTktCnt:&quot; + totTktCnt);</span>
<span class="nc" id="L656">			logger.info(&quot;totPwtCnt:&quot; + totPwtCnt);</span>
<span class="nc" id="L657">			String insertvalues = &quot;insert into st_sle_ret_activity_history (date,live_retailers,noSale_retailers,inactive_retailers,terminated_retailers,total_sales,total_pwt,total_tkt_count,total_pwt_count,avg_sale_per_ret) values (?,?,?,?,?,?,?,?,?,?)&quot;;</span>
<span class="nc" id="L658">			pstmt = con.prepareStatement(insertvalues);</span>
<span class="nc" id="L659">			pstmt.setString(1, fromDate);</span>
<span class="nc" id="L660">			pstmt.setInt(2, liveRets);</span>
<span class="nc" id="L661">			pstmt.setInt(3, noSaleRets);</span>
<span class="nc" id="L662">			pstmt.setInt(4, inactiveRets);</span>
<span class="nc" id="L663">			pstmt.setInt(5, terminateRets);</span>
<span class="nc" id="L664">			pstmt.setDouble(6, totalSale);</span>
<span class="nc" id="L665">			pstmt.setDouble(7, totalPwt);</span>
<span class="nc" id="L666">			pstmt.setInt(8, totTktCnt);</span>
<span class="nc" id="L667">			pstmt.setInt(9, totPwtCnt);</span>
<span class="nc" id="L668">			pstmt.setDouble(10, avgSalePerRet);</span>
<span class="nc" id="L669">			System.out.println(&quot;Q1:&quot; + pstmt);</span>
<span class="nc" id="L670">			pstmt.executeUpdate();</span>
<span class="nc" id="L671">			rs = pstmt.getGeneratedKeys();</span>
<span class="nc" id="L672">			int retActId = 0;</span>
<span class="nc bnc" id="L673" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L674">				retActId = rs.getInt(1);</span>
			}
<span class="nc bnc" id="L676" title="All 2 branches missed.">			if (retActId &gt; 0)</span>
<span class="nc" id="L677">				logger.info(&quot;Data for the day :&quot; + date+ &quot; inserted successfully &quot;);</span>
			else
<span class="nc" id="L679">				logger.info(&quot;Data for the day :&quot; + date+ &quot;not inserted &quot;);</span>
<span class="nc" id="L680">		} catch (SQLException e) {</span>
<span class="nc" id="L681">			logger.info(&quot;SQL Exception &quot;, e);</span>
<span class="nc" id="L682">			throw new LMSException(&quot;SQL Exception &quot; + e.getMessage());</span>
<span class="nc" id="L683">		} catch (Exception e) {</span>
<span class="nc" id="L684">			logger.info(&quot;Exception &quot;, e);</span>
<span class="nc" id="L685">			throw new LMSException(&quot;Exception&quot; + e.getMessage());</span>
		} finally {
<span class="nc" id="L687">			DBConnect.closeCon(con);</span>
<span class="nc" id="L688">		}</span>
	
<span class="nc" id="L690">}</span>

	public static void getDailyRetActivityForIW(String date) throws LMSException, SQLException {
<span class="nc" id="L693">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L694">		ResultSet rs = null;</span>
<span class="nc" id="L695">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L696">		ArrayList&lt;Double&gt; totAmt = null;</span>
<span class="nc" id="L697">		int liveRets = 0;</span>
<span class="nc" id="L698">		int noSaleRets = 0;</span>
<span class="nc" id="L699">		int inactiveRets = 0;</span>
<span class="nc" id="L700">		int terminateRets = 0;</span>
<span class="nc" id="L701">		double totalSale = 0.0;</span>
<span class="nc" id="L702">		double totalPwt = 0.0;</span>
<span class="nc" id="L703">		int totTktCnt = 0;</span>
<span class="nc" id="L704">		int totPwtCnt = 0;</span>
<span class="nc" id="L705">		double avgSalePerRet = 0.0;</span>

<span class="nc" id="L707">		String fromDate = date + &quot; 00:00:00&quot;;</span>
<span class="nc" id="L708">		String toDate = date + &quot; 23:59:59&quot;;</span>
<span class="nc" id="L709">		String trxDate = &quot;transaction_date&gt;'&quot; + fromDate + &quot;' and transaction_date&lt;'&quot; + toDate + &quot;'&quot;;</span>
<span class="nc" id="L710">		String retQry = &quot;select count(distinct(retailer_org_id)) retCount from st_lms_retailer_transaction_master where transaction_type in ('IW_PWT','IW_REFUND_CANCEL','IW_SALE') and &quot; + trxDate;</span>
<span class="nc" id="L711">		String trxQry = &quot;select transaction_id from st_lms_retailer_transaction_master where &quot; + trxDate;</span>
<span class="nc" id="L712">		String saleQry = &quot;select sum(mrp_amt) res from st_iw_ret_sale where transaction_id in (&quot; + trxQry + &quot;)&quot;;</span>
<span class="nc" id="L713">		String saleRetQry = &quot;select sum(mrp_amt) res  from st_iw_ret_sale_refund where transaction_id in (&quot; + trxQry + &quot;)&quot;;</span>
<span class="nc" id="L714">		String pwtQry = &quot;select sum(pwt_amt) res from st_iw_ret_pwt where transaction_id in (&quot; + trxQry + &quot;)&quot;;</span>
<span class="nc" id="L715">		String combinedQry = saleQry + &quot; union all &quot; + saleRetQry + &quot; union all &quot; + pwtQry;</span>
<span class="nc" id="L716">		String dirPlrQry = &quot;select if(a.pwt_amt is null ,0,a.pwt_amt)+if(b.pwt_amt is null ,0,b.pwt_amt) dirPwt from (select sum(pwt_amt) pwt_amt from st_iw_bo_direct_plr_pwt where &quot; + trxDate + &quot;) a,(select sum(pwt_amt) pwt_amt from st_iw_agent_direct_plr_pwt where &quot; + trxDate + &quot;) b&quot;;</span>
<span class="nc" id="L717">		String retSelQry = &quot;select count(distinct(organization_id)) retCount from st_lms_organization_master where organization_type='RETAILER'&quot;;</span>
<span class="nc" id="L718">		String inactiveQry = retSelQry + &quot; and organization_status='INACTIVE'&quot;;</span>
<span class="nc" id="L719">		String terQry = retSelQry + &quot; and organization_status='TERMINATE'&quot;;</span>
<span class="nc" id="L720">		String nosaleQry = &quot; SELECT count(distinct(a.organization_id)) retCount from ( (select distinct(organization_id) from st_lms_organization_master where organization_type='RETAILER' and organization_status='ACTIVE')a LEFT JOIN (select distinct(retailer_org_id) retailer_org_id from st_lms_retailer_transaction_master where transaction_type in ('IW_PWT','IW_REFUND_CANCEL','IW_SALE')&quot; + &quot; and &quot; + trxDate + &quot; )b on a.organization_id=b.retailer_org_id )WHERE b.retailer_org_id IS NULL&quot;;</span>
<span class="nc" id="L721">		String combinedCntQry = retQry + &quot; union all &quot; + inactiveQry + &quot; union all &quot; + terQry + &quot; union all &quot; + nosaleQry;</span>
<span class="nc" id="L722">		double tempRetPwt = 0.0;</span>
		try {
<span class="nc" id="L724">			totAmt = new ArrayList&lt;Double&gt;();</span>
<span class="nc" id="L725">			pstmt = con.prepareStatement(combinedQry);</span>
<span class="nc" id="L726">			logger.info(&quot;Combined query for sale, sale_refund and pwt:&quot; + pstmt);</span>
<span class="nc" id="L727">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L728" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L729">				totAmt.add(rs.getDouble(&quot;res&quot;));</span>
			}
<span class="nc" id="L731">			totalSale += (totAmt.get(0) - totAmt.get(1));</span>
<span class="nc" id="L732">			tempRetPwt += totAmt.get(2);</span>
			// direct player pwt
<span class="nc" id="L734">			double dirPlrPwt = 0.0;</span>
<span class="nc" id="L735">			pstmt = con.prepareStatement(dirPlrQry);</span>
<span class="nc" id="L736">			logger.info(&quot;Query for direct player pwt:&quot; + pstmt);</span>
<span class="nc" id="L737">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L738" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L739">				dirPlrPwt = rs.getInt(&quot;dirPwt&quot;);</span>
			}
			// total sale &amp; Pwt
<span class="nc" id="L742">			totalPwt = tempRetPwt + dirPlrPwt;</span>
			// Retailer count query
<span class="nc" id="L744">			pstmt = con.prepareStatement(combinedCntQry);</span>
<span class="nc" id="L745">			logger.info(&quot;combined query:&quot; + combinedCntQry);</span>
<span class="nc" id="L746">			rs = pstmt.executeQuery();</span>
<span class="nc" id="L747">			List&lt;Integer&gt; retCntList = new ArrayList&lt;Integer&gt;();</span>
<span class="nc bnc" id="L748" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L749">				retCntList.add(rs.getInt(&quot;retCount&quot;));</span>
			}
<span class="nc bnc" id="L751" title="All 2 branches missed.">			if (retCntList.size() &gt; 0) {</span>
<span class="nc" id="L752">				liveRets = retCntList.get(0);</span>
<span class="nc" id="L753">				inactiveRets = retCntList.get(1);</span>
<span class="nc" id="L754">				terminateRets = retCntList.get(2);</span>
<span class="nc" id="L755">				noSaleRets = retCntList.get(3);</span>
			}
			// calculating avgSalePerRet
<span class="nc bnc" id="L758" title="All 4 branches missed.">			if (totalSale != 0.0 &amp;&amp; liveRets != 0)</span>
<span class="nc" id="L759">				avgSalePerRet = totalSale / liveRets;</span>
			// total ticket sold
<span class="nc" id="L761">			pstmt = con.prepareStatement(&quot;select (sale.saleCnt - ref.refCnt) as netSaleCnt from &quot; + &quot;(select ifnull(count(*),0) saleCnt from st_lms_retailer_transaction_master where (&quot; + trxDate + &quot;) and &quot; + &quot;(transaction_type ='IW_SALE') )sale,&quot; + &quot;(select ifnull(count(*),0)refCnt from st_lms_retailer_transaction_master where (&quot; + trxDate + &quot;) and (transaction_type ='IW_REFUND_CANCEL'))ref&quot;);</span>
<span class="nc" id="L762">			logger.info(&quot;Q1:&quot; + pstmt);</span>
<span class="nc" id="L763">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L764" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L765">				totTktCnt = rs.getInt(&quot;netSaleCnt&quot;);</span>
			}
			// total PWT count
<span class="nc" id="L768">			pstmt = con.prepareStatement(&quot;select (ret.retPwt + agt.agtPwt + bo.boPwt) as pwtCnt from &quot; + &quot;((select ifnull(count(*),0) retPwt from st_lms_retailer_transaction_master where &quot; + trxDate + &quot; and  &quot; + &quot;transaction_type='IW_PWT'))ret,(select ifnull(count(*),0) agtPwt from st_iw_agent_direct_plr_pwt where &quot; + trxDate + &quot;)agt,(select ifnull(count(*),0) boPwt from st_iw_bo_direct_plr_pwt where &quot; + trxDate + &quot; )bo&quot;);</span>
<span class="nc" id="L769">			logger.info(&quot;Q1:&quot; + pstmt);</span>
<span class="nc" id="L770">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L771" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L772">				totPwtCnt = rs.getInt(&quot;pwtCnt&quot;);</span>
			}
			// done columns
<span class="nc" id="L775">			logger.info(&quot;liveRets:&quot; + liveRets);</span>
<span class="nc" id="L776">			logger.info(&quot;inactiveRets:&quot; + inactiveRets);</span>
<span class="nc" id="L777">			logger.info(&quot;terminateRets:&quot; + terminateRets);</span>
<span class="nc" id="L778">			logger.info(&quot;noSaleRets:&quot; + noSaleRets);</span>
<span class="nc" id="L779">			logger.info(&quot;totalSale:&quot; + totalSale);</span>
<span class="nc" id="L780">			logger.info(&quot;totalPwt:&quot; + totalPwt);</span>
<span class="nc" id="L781">			logger.info(&quot;avgSalePerRet:&quot; + avgSalePerRet);</span>
<span class="nc" id="L782">			logger.info(&quot;totTktCnt:&quot; + totTktCnt);</span>
<span class="nc" id="L783">			logger.info(&quot;totPwtCnt:&quot; + totPwtCnt);</span>
<span class="nc" id="L784">			String insertvalues = &quot;insert into st_iw_ret_activity_history (date,live_retailers,noSale_retailers,inactive_retailers,terminated_retailers,total_sales,total_pwt,total_tkt_count,total_pwt_count,avg_sale_per_ret) values (?,?,?,?,?,?,?,?,?,?)&quot;;</span>
<span class="nc" id="L785">			pstmt = con.prepareStatement(insertvalues);</span>
<span class="nc" id="L786">			pstmt.setString(1, fromDate);</span>
<span class="nc" id="L787">			pstmt.setInt(2, liveRets);</span>
<span class="nc" id="L788">			pstmt.setInt(3, noSaleRets);</span>
<span class="nc" id="L789">			pstmt.setInt(4, inactiveRets);</span>
<span class="nc" id="L790">			pstmt.setInt(5, terminateRets);</span>
<span class="nc" id="L791">			pstmt.setDouble(6, totalSale);</span>
<span class="nc" id="L792">			pstmt.setDouble(7, totalPwt);</span>
<span class="nc" id="L793">			pstmt.setInt(8, totTktCnt);</span>
<span class="nc" id="L794">			pstmt.setInt(9, totPwtCnt);</span>
<span class="nc" id="L795">			pstmt.setDouble(10, avgSalePerRet);</span>
<span class="nc" id="L796">			System.out.println(&quot;Q1:&quot; + pstmt);</span>
<span class="nc" id="L797">			pstmt.executeUpdate();</span>
<span class="nc" id="L798">			rs = pstmt.getGeneratedKeys();</span>
<span class="nc" id="L799">			int retActId = 0;</span>
<span class="nc bnc" id="L800" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L801">				retActId = rs.getInt(1);</span>
			}
<span class="nc bnc" id="L803" title="All 2 branches missed.">			if (retActId &gt; 0)</span>
<span class="nc" id="L804">				logger.info(&quot;Data for the day :&quot; + date + &quot; inserted successfully &quot;);</span>
			else
<span class="nc" id="L806">				logger.info(&quot;Data for the day :&quot; + date + &quot;not inserted &quot;);</span>
<span class="nc" id="L807">		} catch (SQLException e) {</span>
<span class="nc" id="L808">			logger.info(&quot;SQL Exception &quot;, e);</span>
<span class="nc" id="L809">			throw new LMSException(&quot;SQL Exception &quot; + e.getMessage());</span>
<span class="nc" id="L810">		} catch (Exception e) {</span>
<span class="nc" id="L811">			logger.info(&quot;Exception &quot;, e);</span>
<span class="nc" id="L812">			throw new LMSException(&quot;Exception&quot; + e.getMessage());</span>
		} finally {
<span class="nc" id="L814">			DBConnect.closeCon(con);</span>
<span class="nc" id="L815">		}</span>
<span class="nc" id="L816">	}</span>

	public static void getDailyRetActivityForVS(String date) throws LMSException, SQLException {
<span class="nc" id="L819">		Connection connection = null;</span>
<span class="nc" id="L820">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L821">		ResultSet rs = null;</span>
		try {
<span class="nc" id="L823">			connection = DBConnect.getConnection();</span>

<span class="nc" id="L825">			String fromDate = date + &quot; 00:00:00&quot;;</span>
<span class="nc" id="L826">			String toDate = date + &quot; 23:59:59&quot;;</span>

<span class="nc" id="L828">			List&lt;Double&gt; totalAmount = new ArrayList&lt;Double&gt;();</span>
<span class="nc" id="L829">			pstmt = connection.prepareStatement(&quot;SELECT SUM(mrp_amt) res FROM st_vs_ret_sale WHERE transaction_id IN (SELECT transaction_id FROM st_lms_retailer_transaction_master WHERE transaction_date &gt; '&quot; + fromDate + &quot;' AND transaction_date &lt; '&quot; + toDate + &quot;') UNION ALL SELECT SUM(mrp_amt) res FROM st_vs_ret_sale_refund WHERE transaction_id IN (SELECT transaction_id FROM st_lms_retailer_transaction_master WHERE transaction_date &gt; '&quot; + fromDate + &quot;' AND transaction_date &lt; '&quot; + toDate + &quot;') UNION ALL SELECT SUM(pwt_amt) res FROM st_vs_ret_pwt WHERE transaction_id IN (SELECT transaction_id FROM st_lms_retailer_transaction_master WHERE transaction_date &gt; '&quot; + fromDate + &quot;' AND transaction_date &lt; '&quot; + toDate + &quot;');&quot;);</span>
<span class="nc" id="L830">			logger.info(&quot;Combined Query for SALE, CANCEL, PWT - &quot; + pstmt);</span>
<span class="nc" id="L831">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L832" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L833">				totalAmount.add(rs.getDouble(&quot;res&quot;));</span>
			}
<span class="nc" id="L835">			double totalSale = 0.0;</span>
<span class="nc" id="L836">			double normalPwt = 0.0;</span>
<span class="nc" id="L837">			totalSale += totalAmount.get(0) - totalAmount.get(1);</span>
<span class="nc" id="L838">			normalPwt += totalAmount.get(2);</span>

<span class="nc" id="L840">			double dirPlayerPwt = 0.0;</span>
<span class="nc" id="L841">			pstmt = connection.prepareStatement(&quot;SELECT IF(a.pwt_amt IS NULL, 0, a.pwt_amt) + IF(b.pwt_amt IS NULL, 0, b.pwt_amt) dirPwt FROM (SELECT SUM(pwt_amt) pwt_amt FROM st_vs_bo_direct_plr_pwt WHERE transaction_date &gt; '&quot; + fromDate + &quot;' AND transaction_date &lt; '&quot; + toDate + &quot;') a, (SELECT SUM(pwt_amt) pwt_amt FROM st_vs_agent_direct_plr_pwt WHERE transaction_date &gt; '&quot; + fromDate + &quot;' AND transaction_date &lt; '&quot; + toDate + &quot;') b;&quot;);</span>
<span class="nc" id="L842">			logger.info(&quot;Query for Direct Player PWT - &quot; + pstmt);</span>
<span class="nc" id="L843">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L844" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L845">				dirPlayerPwt = rs.getInt(&quot;dirPwt&quot;);</span>
			}
<span class="nc" id="L847">			double totalPwt = 0.0;</span>
<span class="nc" id="L848">			totalPwt = normalPwt + dirPlayerPwt;</span>

<span class="nc" id="L850">			List&lt;Integer&gt; retailerCountList = new ArrayList&lt;Integer&gt;();</span>
<span class="nc" id="L851">			pstmt = connection.prepareStatement(&quot;SELECT COUNT(DISTINCT(retailer_org_id)) retCount FROM st_lms_retailer_transaction_master WHERE transaction_type IN ('VS_SALE','VS_REFUND_CANCEL','VS_PWT') AND transaction_date &gt; '&quot; + fromDate + &quot;' AND transaction_date &lt; '&quot; + toDate + &quot;' UNION ALL SELECT COUNT(DISTINCT(organization_id)) retCount FROM st_lms_organization_master WHERE organization_type='RETAILER' AND organization_status='INACTIVE' UNION ALL SELECT COUNT(DISTINCT(organization_id)) retCount FROM st_lms_organization_master WHERE organization_type='RETAILER' AND organization_status='TERMINATE' UNION ALL SELECT COUNT(DISTINCT(a.organization_id)) retCount FROM ((SELECT DISTINCT(organization_id) FROM st_lms_organization_master WHERE organization_type='RETAILER' AND organization_status='ACTIVE') a LEFT JOIN (SELECT DISTINCT(retailer_org_id) retailer_org_id FROM st_lms_retailer_transaction_master WHERE transaction_type IN ('VS_SALE','VS_REFUND_CANCEL','VS_PWT') AND transaction_date &gt; '&quot; + fromDate + &quot;' AND transaction_date &lt; '&quot; + toDate + &quot;' )b ON a.organization_id=b.retailer_org_id) WHERE b.retailer_org_id IS NULL;&quot;);</span>
<span class="nc" id="L852">			logger.info(&quot;Combined Query for Count - &quot; + pstmt);</span>
<span class="nc" id="L853">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L854" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L855">				retailerCountList.add(rs.getInt(&quot;retCount&quot;));</span>
			}

<span class="nc" id="L858">			int liveRet = 0;</span>
<span class="nc" id="L859">			int noSaleRet = 0;</span>
<span class="nc" id="L860">			int inactiveRet = 0;</span>
<span class="nc" id="L861">			int terminateRet = 0;</span>
<span class="nc bnc" id="L862" title="All 2 branches missed.">			if (retailerCountList.size() &gt; 0) {</span>
<span class="nc" id="L863">				liveRet = retailerCountList.get(0);</span>
<span class="nc" id="L864">				inactiveRet = retailerCountList.get(1);</span>
<span class="nc" id="L865">				terminateRet = retailerCountList.get(2);</span>
<span class="nc" id="L866">				noSaleRet = retailerCountList.get(3);</span>
			}

<span class="nc" id="L869">			double avgSalePerRet = 0.0;</span>
<span class="nc bnc" id="L870" title="All 4 branches missed.">			if (totalSale!=0.0 &amp;&amp; liveRet!=0) {</span>
<span class="nc" id="L871">				avgSalePerRet = totalSale / liveRet;</span>
			}

<span class="nc" id="L874">			int totalTicketCount = 0;</span>
<span class="nc" id="L875">			pstmt = connection.prepareStatement(&quot;SELECT (sale.saleCnt - ref.refCnt) AS netSaleCnt FROM (SELECT IFNULL(COUNT(*), 0) saleCnt FROM st_lms_retailer_transaction_master WHERE (transaction_date &gt; '&quot; + fromDate + &quot;' AND transaction_date &lt; '&quot; + toDate + &quot;') AND (transaction_type ='VS_SALE'))sale, (SELECT IFNULL(COUNT(*), 0) refCnt FROM st_lms_retailer_transaction_master WHERE (transaction_date &gt; '&quot; + fromDate + &quot;' AND transaction_date &lt; '&quot; + toDate + &quot;') AND (transaction_type ='VS_REFUND_CANCEL')) ref;&quot;);</span>
<span class="nc" id="L876">			logger.info(&quot;Total Ticket Count Query - &quot; + pstmt);</span>
<span class="nc" id="L877">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L878" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L879">				totalTicketCount = rs.getInt(&quot;netSaleCnt&quot;);</span>
			}

<span class="nc" id="L882">			int totalPWTCount = 0;</span>
<span class="nc" id="L883">			pstmt = connection.prepareStatement(&quot;SELECT (ret.retPwt + agt.agtPwt + bo.boPwt) AS pwtCnt FROM ((SELECT IFNULL(COUNT(*), 0) retPwt FROM st_lms_retailer_transaction_master WHERE transaction_date &gt; '&quot; + fromDate + &quot;' AND transaction_date &lt; '&quot; + toDate + &quot;' AND transaction_type='VS_PWT')) ret, (SELECT IFNULL(COUNT(*), 0) agtPwt FROM st_vs_agent_direct_plr_pwt WHERE transaction_date &gt; '&quot; + fromDate + &quot;' AND transaction_date &lt; '&quot; + toDate + &quot;') agt, (SELECT IFNULL(COUNT(*), 0) boPwt FROM st_vs_bo_direct_plr_pwt WHERE transaction_date &gt; '&quot; + fromDate + &quot;' AND transaction_date &lt; '&quot; + toDate + &quot;') bo;&quot;);</span>
<span class="nc" id="L884">			logger.info(&quot;Total PWT Count Query - &quot; + pstmt);</span>
<span class="nc" id="L885">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L886" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L887">				totalPWTCount = rs.getInt(&quot;pwtCnt&quot;);</span>
			}

<span class="nc" id="L890">			logger.info(&quot;Live Retailers - &quot; + liveRet);</span>
<span class="nc" id="L891">			logger.info(&quot;Inactive Retailers - &quot; + inactiveRet);</span>
<span class="nc" id="L892">			logger.info(&quot;Terminated Retailers - &quot; + terminateRet);</span>
<span class="nc" id="L893">			logger.info(&quot;No Sale Retailers - &quot; + noSaleRet);</span>
<span class="nc" id="L894">			logger.info(&quot;Total Sale Retailers - &quot; + totalSale);</span>
<span class="nc" id="L895">			logger.info(&quot;Total PWT Retailers - &quot; + totalPwt);</span>
<span class="nc" id="L896">			logger.info(&quot;Average Sale Per Retailer - &quot; + avgSalePerRet);</span>
<span class="nc" id="L897">			logger.info(&quot;Total Ticket Count - &quot; + totalTicketCount);</span>
<span class="nc" id="L898">			logger.info(&quot;Total PWT Count&quot; + totalPWTCount);</span>

<span class="nc" id="L900">			String insertValues = &quot;INSERT INTO st_vs_ret_activity_history (DATE, live_retailers, noSale_retailers, inactive_retailers, terminated_retailers, total_sales, total_pwt, total_tkt_count, total_pwt_count, avg_sale_per_ret) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?);&quot;;</span>
<span class="nc" id="L901">			pstmt = connection.prepareStatement(insertValues);</span>
<span class="nc" id="L902">			pstmt.setString(1, fromDate);</span>
<span class="nc" id="L903">			pstmt.setInt(2, liveRet);</span>
<span class="nc" id="L904">			pstmt.setInt(3, noSaleRet);</span>
<span class="nc" id="L905">			pstmt.setInt(4, inactiveRet);</span>
<span class="nc" id="L906">			pstmt.setInt(5, terminateRet);</span>
<span class="nc" id="L907">			pstmt.setDouble(6, totalSale);</span>
<span class="nc" id="L908">			pstmt.setDouble(7, totalPwt);</span>
<span class="nc" id="L909">			pstmt.setInt(8, totalTicketCount);</span>
<span class="nc" id="L910">			pstmt.setInt(9, totalPWTCount);</span>
<span class="nc" id="L911">			pstmt.setDouble(10, avgSalePerRet);</span>
<span class="nc" id="L912">			System.out.println(&quot;Insert in st_vs_ret_activity_history - &quot; + pstmt);</span>
<span class="nc" id="L913">			pstmt.executeUpdate();</span>

<span class="nc" id="L915">			rs = pstmt.getGeneratedKeys();</span>
<span class="nc" id="L916">			int retActId = 0;</span>
<span class="nc bnc" id="L917" title="All 2 branches missed.">			if (rs.next())</span>
<span class="nc" id="L918">				retActId = rs.getInt(1);</span>

<span class="nc bnc" id="L920" title="All 2 branches missed.">			if (retActId &gt; 0)</span>
<span class="nc" id="L921">				logger.info(&quot;Data for Day - &quot; + date + &quot; Inserted Successfully.&quot;);</span>
			else
<span class="nc" id="L923">				logger.info(&quot;Data for Day - &quot; + date + &quot; Not Inserted.&quot;);</span>
<span class="nc" id="L924">		} catch (SQLException e) {</span>
<span class="nc" id="L925">			e.printStackTrace();</span>
<span class="nc" id="L926">			throw new LMSException(&quot;SQL Exception - &quot; + e.getMessage());</span>
<span class="nc" id="L927">		} catch (Exception e) {</span>
<span class="nc" id="L928">			e.printStackTrace();</span>
<span class="nc" id="L929">			throw new LMSException(&quot;Exception - &quot; + e.getMessage());</span>
		} finally {
<span class="nc" id="L931">			DBConnect.closeResource(connection, pstmt, rs);</span>
<span class="nc" id="L932">		}</span>
<span class="nc" id="L933">	}</span>

public static void getDailyRetActivityForCS(String date) throws LMSException, SQLException{
<span class="nc" id="L936">	TreeMap&lt;Integer, ArrayList&lt;Double&gt;&gt; gameDataMap = new TreeMap&lt;Integer, ArrayList&lt;Double&gt;&gt;();</span>
	 
<span class="nc" id="L938">	Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L939">	ResultSet rs = null;</span>
<span class="nc" id="L940">	PreparedStatement pstmt = null;</span>
<span class="nc" id="L941">	ArrayList&lt;Double&gt; totAmt = null;</span>
<span class="nc" id="L942">	int catNum = 0;</span>
<span class="nc" id="L943">	List&lt;Integer&gt; categoryList = Util.getCategoryNumberList(con);</span>

<span class="nc" id="L945">	int liveRets = 0;</span>
<span class="nc" id="L946">	int noSaleRets = 0;</span>
<span class="nc" id="L947">	int inactiveRets = 0;</span>
<span class="nc" id="L948">	int terminateRets = 0;</span>
<span class="nc" id="L949">	double totalSale = 0.0;</span>
<span class="nc" id="L950">	double avgSalePerRet = 0.0;</span>

	//String date = new java.sql.Date(new Date().getTime()) + &quot;&quot;;

<span class="nc" id="L954">	String fromDate = date + &quot; 00:00:00&quot;;</span>
<span class="nc" id="L955">	String toDate = date + &quot; 23:59:59&quot;;</span>
<span class="nc" id="L956">	String trxDate = &quot;transaction_date&gt;'&quot; + fromDate</span>
			+ &quot;' and transaction_date&lt;'&quot; + toDate + &quot;'&quot;;
<span class="nc" id="L958">	String retQry = &quot;select count(distinct(retailer_org_id)) retCount from st_lms_retailer_transaction_master where transaction_type in ('CS_SALE','CS_CANCEL_SERVER','CS_CANCEL_RET') and &quot;</span>
			+ trxDate;

<span class="nc" id="L961">	String trxQry = &quot;select transaction_id from st_lms_retailer_transaction_master where &quot;</span>
			+ trxDate;
<span class="nc" id="L963">	String saleQry = &quot;select sum(mrp_amt) res from st_cs_sale_? where transaction_id in (&quot;</span>
			+ trxQry + &quot;)&quot;;
<span class="nc" id="L965">	String saleRetQry = &quot;select sum(mrp_amt) res  from st_cs_refund_? where transaction_id in (&quot;</span>
			+ trxQry + &quot;)&quot;;
<span class="nc" id="L967">	String combinedQry = saleQry + &quot; union all &quot; + saleRetQry;</span>

<span class="nc" id="L969">	String retSelQry=&quot;select count(distinct(organization_id)) from st_lms_organization_master where organization_type='RETAILER'&quot;;</span>
<span class="nc" id="L970">	String inactiveQry=retSelQry+&quot; and organization_status='INACTIVE'&quot;;</span>
<span class="nc" id="L971">	String terQry=retSelQry+&quot; and organization_status='TERMINATE'&quot;;</span>
<span class="nc" id="L972">	String nosaleQry=retSelQry+&quot; and organization_status='ACTIVE' and organization_id not in (select distinct(retailer_org_id) from st_lms_retailer_transaction_master where transaction_type in ('CS_SALE','CS_CANCEL_SERVER','CS_CANCEL_RET') and &quot;+trxDate+&quot; )&quot;;</span>
<span class="nc" id="L973">	String combinedCntQry=retQry+&quot; union all &quot;+inactiveQry+&quot; union all &quot;+terQry+&quot; union all &quot;+nosaleQry;</span>
	
	try {
<span class="nc bnc" id="L976" title="All 2 branches missed.">	for (int i = 0; i &lt; categoryList.size(); i++) {</span>
<span class="nc" id="L977">		catNum = categoryList.get(i);</span>
<span class="nc" id="L978">		totAmt = new ArrayList&lt;Double&gt;();</span>
<span class="nc" id="L979">		pstmt = con.prepareStatement(combinedQry);</span>
<span class="nc" id="L980">		pstmt.setInt(1, catNum);</span>
<span class="nc" id="L981">		pstmt.setInt(2, catNum);</span>
<span class="nc" id="L982">		System.out.println(&quot;Q1:&quot;+pstmt);</span>
<span class="nc" id="L983">		rs = pstmt.executeQuery();</span>
		
		
<span class="nc bnc" id="L986" title="All 2 branches missed.">		while (rs.next()) {</span>
<span class="nc" id="L987">			totAmt.add(rs.getDouble(&quot;res&quot;));</span>
		}
<span class="nc" id="L989">		gameDataMap.put(catNum, totAmt);</span>
	}

	// total sale &amp; Pwt
	
<span class="nc" id="L994">	Iterator&lt;Map.Entry&lt;Integer, ArrayList&lt;Double&gt;&gt;&gt; itr = gameDataMap.entrySet().iterator();</span>
<span class="nc bnc" id="L995" title="All 2 branches missed.">	while (itr.hasNext()){</span>
<span class="nc" id="L996">		Map.Entry&lt;Integer, ArrayList&lt;Double&gt;&gt; pair = itr.next();</span>
<span class="nc" id="L997">		ArrayList&lt;Double&gt; list = (ArrayList&lt;Double&gt;)pair.getValue();</span>
<span class="nc" id="L998">		totalSale+=(list.get(0)-list.get(1));</span>
<span class="nc" id="L999">	}</span>
	// Retailer count query
<span class="nc" id="L1001">	pstmt=con.prepareStatement(combinedCntQry);</span>
<span class="nc" id="L1002">	System.out.println(&quot;combined query:&quot;+combinedCntQry);</span>
<span class="nc" id="L1003">	rs=pstmt.executeQuery();</span>
<span class="nc" id="L1004">	List&lt;Integer&gt; retCntList = new ArrayList&lt;Integer&gt;();</span>
<span class="nc bnc" id="L1005" title="All 2 branches missed.">	while(rs.next()){</span>
<span class="nc" id="L1006">		retCntList.add(rs.getInt(&quot;retCount&quot;));</span>
	}
	
<span class="nc bnc" id="L1009" title="All 2 branches missed.">	if(retCntList.size()&gt;0){</span>
<span class="nc" id="L1010">		liveRets=retCntList.get(0);</span>
<span class="nc" id="L1011">		inactiveRets=retCntList.get(1);</span>
<span class="nc" id="L1012">		terminateRets=retCntList.get(2);</span>
<span class="nc" id="L1013">		noSaleRets=retCntList.get(3);</span>
	}
	// calculating avgSalePerRet 
<span class="nc bnc" id="L1016" title="All 4 branches missed.">	if(totalSale != 0.0 &amp;&amp; liveRets !=0)</span>
<span class="nc" id="L1017">		 avgSalePerRet = totalSale/liveRets;</span>
		
	
	
	
	// done columns
<span class="nc" id="L1023">	System.out.println(&quot;liveRets:&quot; + liveRets);</span>
<span class="nc" id="L1024">	System.out.println(&quot;inactiveRets:&quot; + inactiveRets);</span>
<span class="nc" id="L1025">	System.out.println(&quot;terminateRets:&quot; + terminateRets);</span>
<span class="nc" id="L1026">	System.out.println(&quot;noSaleRets:&quot; + noSaleRets);</span>
<span class="nc" id="L1027">	System.out.println(&quot;totalSale:&quot; + totalSale);</span>
<span class="nc" id="L1028">	System.out.println(&quot;avgSalePerRet:&quot; + avgSalePerRet);</span>
<span class="nc" id="L1029">	String insertvalues = &quot;insert into st_cs_ret_activity_history (date,live_retailers,noSale_retailers,inactive_retailers,terminated_retailers,total_sales,avg_sale_per_ret) values (?,?,?,?,?,?,?)&quot;;</span>
<span class="nc" id="L1030">	pstmt=con.prepareStatement(insertvalues);</span>
<span class="nc" id="L1031">	pstmt.setString(1,fromDate);</span>
<span class="nc" id="L1032">	pstmt.setInt(2, liveRets);</span>
<span class="nc" id="L1033">	pstmt.setInt(3, noSaleRets);</span>
<span class="nc" id="L1034">	pstmt.setInt(4, inactiveRets);</span>
<span class="nc" id="L1035">	pstmt.setInt(5, terminateRets);</span>
<span class="nc" id="L1036">	pstmt.setDouble(6, totalSale);</span>
<span class="nc" id="L1037">	pstmt.setDouble(7, avgSalePerRet);</span>
<span class="nc" id="L1038">	System.out.println(&quot;Q1:&quot;+pstmt);</span>
<span class="nc" id="L1039">	pstmt.executeUpdate();</span>
<span class="nc" id="L1040">	rs = pstmt.getGeneratedKeys();</span>
<span class="nc" id="L1041">	int retActId =0 ;</span>
<span class="nc bnc" id="L1042" title="All 2 branches missed.">	if(rs.next()){</span>
<span class="nc" id="L1043">		retActId=rs.getInt(1);</span>
	}
<span class="nc bnc" id="L1045" title="All 2 branches missed.">	if(retActId&gt;0)</span>
<span class="nc" id="L1046">		System.out.println(&quot;Data for the day :&quot;+date+&quot; inserted successfully &quot;);</span>
	else
<span class="nc" id="L1048">		System.out.println(&quot;Data for the day :&quot;+date+&quot;not inserted &quot;);</span>
<span class="nc" id="L1049">	}catch (SQLException e) {</span>
<span class="nc" id="L1050">		logger.info(&quot;SQL Exception &quot;,e);</span>
<span class="nc" id="L1051">		throw new LMSException(&quot;SQL Exception &quot;+e.getMessage());</span>
<span class="nc" id="L1052">	}catch (Exception e) {</span>
<span class="nc" id="L1053">		logger.info(&quot;Exception &quot;,e);</span>
<span class="nc" id="L1054">		throw new LMSException(&quot;Exception&quot;+e.getMessage());</span>
	} finally {
<span class="nc" id="L1056">		DBConnect.closeCon(con);</span>
<span class="nc" id="L1057">	}</span>
<span class="nc" id="L1058">}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>