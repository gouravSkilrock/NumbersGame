<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DrawGameRPOSHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lms</a> &gt; <a href="index.source.html" class="el_package">com.skilrock.lms.coreEngine.drawGames.playMgmt</a> &gt; <span class="el_source">DrawGameRPOSHelper.java</span></div><h1>DrawGameRPOSHelper.java</h1><pre class="source lang-java linenums">package com.skilrock.lms.coreEngine.drawGames.playMgmt;

import java.lang.reflect.Method;
import java.lang.reflect.Type;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.sql.Time;
import java.sql.Timestamp;
import java.text.DateFormat;
import java.text.NumberFormat;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Comparator;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.TreeMap;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.apache.struts2.ServletActionContext;

import com.google.gson.Gson;
import com.google.gson.JsonElement;
import com.google.gson.JsonObject;
import com.google.gson.JsonParser;
import com.google.gson.reflect.TypeToken;
import com.skilrock.itg.IDBarcode.IDBarcode;
import com.skilrock.lms.ajax.AjaxRequestHelper;
import com.skilrock.lms.api.beans.PWTApiBean;
import com.skilrock.lms.beans.OrgPwtLimitBean;
import com.skilrock.lms.beans.PromoGameBean;
import com.skilrock.lms.beans.ServiceRequest;
import com.skilrock.lms.beans.ServiceResponse;
import com.skilrock.lms.beans.UserInfoBean;
import com.skilrock.lms.common.ConfigurationVariables;
import com.skilrock.lms.common.Utility;
import com.skilrock.lms.common.db.DBConnect;
import com.skilrock.lms.common.exception.LMSErrors;
import com.skilrock.lms.common.exception.LMSException;
import com.skilrock.lms.common.filter.LMSFilterDispatcher;
import com.skilrock.lms.common.utility.CommonMethods;
import com.skilrock.lms.common.utility.LMSUtility;
import com.skilrock.lms.common.utility.ResponsibleGaming;
import com.skilrock.lms.common.utility.orgOnLineSaleCreditUpdation;
import com.skilrock.lms.controller.pwtMgmtDao.pwtMgmtDaoImpl;
import com.skilrock.lms.coreEngine.drawGames.common.CommonFunctionsHelper;
import com.skilrock.lms.coreEngine.drawGames.common.DGPromoScheme;
import com.skilrock.lms.coreEngine.drawGames.pwtMgmt.RetailerPwtProcessHelper;
import com.skilrock.lms.coreEngine.service.IServiceDelegate;
import com.skilrock.lms.coreEngine.service.ServiceDelegate;
import com.skilrock.lms.coreEngine.service.dge.ServiceMethodName;
import com.skilrock.lms.coreEngine.service.dge.ServiceName;
import com.skilrock.lms.dge.beans.BetDetailsBean;
import com.skilrock.lms.dge.beans.CancelTicketBean;
import com.skilrock.lms.dge.beans.CommonPurchaseBean;
import com.skilrock.lms.dge.beans.DrawIdBean;
import com.skilrock.lms.dge.beans.DrawWinningReportBean;
import com.skilrock.lms.dge.beans.FortunePurchaseBean;
import com.skilrock.lms.dge.beans.FortuneThreePurchaseBean;
import com.skilrock.lms.dge.beans.FortuneTwoPurchaseBean;
import com.skilrock.lms.dge.beans.KenoPurchaseBean;
import com.skilrock.lms.dge.beans.KenoRequestBean;
import com.skilrock.lms.dge.beans.KenoRequestBeanBuilder;
import com.skilrock.lms.dge.beans.KenoResponseBean;
import com.skilrock.lms.dge.beans.LottoPurchaseBean;
import com.skilrock.lms.dge.beans.LottoRequestBean;
import com.skilrock.lms.dge.beans.LottoResponseBean;
import com.skilrock.lms.dge.beans.MainPWTDrawBean;
import com.skilrock.lms.dge.beans.OfflineRetailerBean;
import com.skilrock.lms.dge.beans.PWTDrawBean;
import com.skilrock.lms.dge.beans.RaffleDrawIdBean;
import com.skilrock.lms.dge.beans.RafflePurchaseBean;
import com.skilrock.lms.dge.beans.ReprintBean;
import com.skilrock.lms.dge.beans.ValidateTicketBean;
import com.skilrock.lms.dge.gameconstants.KenoConstants;
import com.skilrock.lms.embedded.drawGames.common.EmbeddedErrors;
import com.skilrock.lms.web.drawGames.common.Util;
import com.skilrock.lms.web.drawGames.pwtMgmt.javaBeans.PwtVerifyTicketBean;

import net.sf.json.JSONObject;

public class DrawGameRPOSHelper {
<span class="fc" id="L92">	static Log logger=LogFactory.getLog(DrawGameRPOSHelper.class);</span>
	private double totalPurchaseAmount;
<span class="fc" id="L94">	private double modifiedTotalPurchaseAmount = 0.0;</span>
<span class="fc" id="L95">	private double oldTotalPurchaseAmount = 0.0;</span>
<span class="fc" id="L96">	private String status = &quot;&quot;;</span>
<span class="fc" id="L97">	private ServiceResponse serviceResponse = new ServiceResponse();</span>
<span class="fc" id="L98">	private ServiceRequest serviceRequest = new ServiceRequest();</span>
<span class="fc" id="L99">	IServiceDelegate delegate = null;</span>
	AjaxRequestHelper ajaxHelper;

<span class="fc" id="L102">	public DrawGameRPOSHelper() {</span>
<span class="fc" id="L103">		delegate = ServiceDelegate.getInstance();</span>
<span class="fc" id="L104">		this.ajaxHelper = new AjaxRequestHelper();</span>
<span class="fc" id="L105">	}</span>


<span class="fc" id="L108">	public DrawGameRPOSHelper(IServiceDelegate iServiceDelegate, AjaxRequestHelper ajaxHelper) {</span>
<span class="fc" id="L109">		delegate = iServiceDelegate;</span>
<span class="fc" id="L110">		this.ajaxHelper = ajaxHelper;</span>
<span class="fc" id="L111">	}</span>

<span class="fc" id="L113">	private long balanceDeduction = 0;</span>

	// Freeze time is checked for the sale Game only , means sale of other game
	// is allowed
	public static boolean chkFreezeTimeSale(int gameNo) {
<span class="pc bpc" id="L118" title="1 of 2 branches missed.">		if (!Util.onfreezeSale) {</span>
<span class="nc" id="L119">			Long curDate = new Date().getTime();</span>
<span class="nc" id="L120">			TreeMap&lt;Integer, List&lt;List&gt;&gt; gameData = Util.gameData;</span>
<span class="nc" id="L121">			List&lt;List&gt; gameDataList = gameData.get(gameNo); // can be removed</span>
<span class="nc" id="L122">			List&lt;Map&lt;String, String&gt;&gt; frzNdrawTimeList = gameDataList.get(3);</span>
<span class="nc" id="L123">			Map&lt;String, String&gt; frzNdrawTime = frzNdrawTimeList.get(0);</span>
<span class="nc" id="L124">			Iterator&lt;Map.Entry&lt;String, String&gt;&gt; iter = frzNdrawTime.entrySet().iterator();</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">			while (iter.hasNext()) {</span>
<span class="nc" id="L126">				Map.Entry&lt;String, String&gt; pair = iter.next();</span>
<span class="nc bnc" id="L127" title="All 4 branches missed.">				if (Long.parseLong(pair.getKey()) &lt; curDate &amp;&amp; Long.parseLong(pair.getValue()) &gt; curDate) {</span>
<span class="nc" id="L128">					return true;</span>
				}
<span class="nc" id="L130">			}</span>
		}
<span class="fc" id="L132">		return false;</span>

	}

	public boolean cancelRaffleTicket(CancelTicketBean cancelTicketBean, UserInfoBean userInfoBean,
			String cancellationCharges, Connection con) {
<span class="nc" id="L138">		int barCodeCount = -1;</span>
<span class="nc" id="L139">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L140">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L141">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L142">		List&lt;String&gt; promoTicketList = cancelTicketBean.getPromoTicketList();</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">		if (cancelTicketBean.getTicketNo().length() == com.skilrock.lms.common.ConfigurationVariables.barcodeCount)</span>
<span class="nc" id="L144">			barCodeCount = Integer.parseInt(Util.getBarCodeCountFromTicketNumber(cancelTicketBean.getTicketNo()));</span>
<span class="nc" id="L145">		cancelTicketBean.setBarCodeCount(barCodeCount);</span>
<span class="nc" id="L146">		int rafleGmeNo = getGamenoFromTktnumber(promoTicketList.get(0) + &quot;0&quot;);</span>
		// here cancel raffle ticket
<span class="nc" id="L148">		long refTransid = orgOnLineSaleCreditUpdation.drawRaffleTicketCancel(userInfoBean, con, cancellationCharges,</span>
				promoTicketList.get(0), Util.getGameIdFromGameNumber(rafleGmeNo));
<span class="nc" id="L150">		cancelTicketBean.setRefTransId(refTransid + &quot;&quot;);</span>
<span class="nc" id="L151">		cancelTicketBean.setTicketNo(promoTicketList.get(0) + &quot;0&quot;);</span>
<span class="nc" id="L152">		cancelTicketBean.setGameId(rafleGmeNo);</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">		if (refTransid &gt; 0) {</span>
<span class="nc" id="L154">			sRes = new ServiceResponse();</span>
<span class="nc" id="L155">			sReq = new ServiceRequest();</span>
<span class="nc" id="L156">			sReq.setServiceName(ServiceName.RAFFLE);</span>
<span class="nc" id="L157">			sReq.setServiceMethod(ServiceMethodName.RAFFLE_CANCEL_TICKET);</span>
<span class="nc" id="L158">			sReq.setServiceData(cancelTicketBean);</span>
<span class="nc" id="L159">			sRes = delegate.getResponse(sReq);</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">			if (sRes.getIsSuccess()) {</span>
<span class="nc" id="L161">				return true;</span>
			} else {
<span class="nc" id="L163">				cancelTicketBean.setValid(false);</span>
<span class="nc" id="L164">				return false;</span>
			}
		} else {
<span class="nc" id="L167">			return false;</span>
		}
	}

	public boolean cancelStdTkt(UserInfoBean userInfoBean, CancelTicketBean cancelTicketBean, Connection con,
			String cancellationCharges) {

<span class="nc" id="L174">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L175">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L176">		sReq.setServiceName(ServiceName.PLAYGAME);</span>
<span class="nc" id="L177">		sReq.setServiceMethod(ServiceMethodName.DRAWGAME_CANCEL_TICKET);</span>
<span class="nc" id="L178">		sReq.setServiceData(cancelTicketBean);</span>
<span class="nc" id="L179">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>

<span class="nc" id="L181">		double tickRefundAmt = orgOnLineSaleCreditUpdation.drawTicketCancel(userInfoBean, cancelTicketBean, con,</span>
				cancellationCharges);
<span class="nc" id="L183">		logger.debug(tickRefundAmt + &quot;*tickRefundAmt&quot;);</span>

<span class="nc bnc" id="L185" title="All 2 branches missed.">		if (tickRefundAmt &gt;= 0) {</span>

<span class="nc" id="L187">			cancelTicketBean.setTicketNo(cancelTicketBean.getTicketNo() + cancelTicketBean.getReprintCount());</span>
<span class="nc" id="L188">			sRes = delegate.getResponse(sReq);</span>

<span class="nc" id="L190">			String responseString = sRes.getResponseData().toString();</span>
<span class="nc" id="L191">			Type elementType = new TypeToken&lt;CancelTicketBean&gt;() {</span>
			}.getType();

<span class="nc bnc" id="L194" title="All 2 branches missed.">			if (sRes.getIsSuccess()) {</span>
<span class="nc" id="L195">				logger.debug(&quot;*Inside Cancel Ticket Success&quot;);</span>
<span class="nc" id="L196">				cancelTicketBean.setRefundAmount(tickRefundAmt);</span>
<span class="nc" id="L197">				CancelTicketBean cancelTicketBean1 = new Gson().fromJson(responseString, elementType);</span>
<span class="nc" id="L198">				cancelTicketBean.setCancelTime(cancelTicketBean1.getCancelTime());</span>
<span class="nc" id="L199">				return true;</span>
			} else {
<span class="nc" id="L201">				cancelTicketBean.setValid(false);</span>
<span class="nc" id="L202">				return false;</span>
			}

		} else {
<span class="nc bnc" id="L206" title="All 2 branches missed.">			if (tickRefundAmt == -3)</span>
<span class="nc" id="L207">				return true;</span>
<span class="nc" id="L208">			cancelTicketBean.setValid(false);</span>
<span class="nc" id="L209">			return false;</span>
		}

	}

	public CancelTicketBean cancelTicket(CancelTicketBean cancelTicketBean, UserInfoBean userInfoBean,
			boolean autoCancel, String cancelType) {
<span class="nc" id="L216">		logger.debug(&quot;autoCancel and cancelTicketBean:&quot; + autoCancel + &quot; &quot; + cancelTicketBean);</span>
<span class="nc" id="L217">		Connection con = DBConnect.getConnection();</span>

<span class="nc" id="L219">		String tNum = cancelTicketBean.getTicketNo();</span>

		try {
			// we check user id from user info bean directly
			/*
			 * PreparedStatement ps = con
			 * .prepareStatement(&quot;select organization_id from st_lms_user_master where user_id=&quot;
			 * + Util.getUserIdFromTicket(tNum)); ResultSet rs =
			 * ps.executeQuery(); int orgId = 0; if (rs.next()) { orgId =
			 * rs.getInt(1); }
			 */
<span class="nc bnc" id="L230" title="All 2 branches missed.">			if (userInfoBean.getUserId() != Util.getUserIdFromTicket(tNum)) {</span>
<span class="nc" id="L231">				cancelTicketBean.setValid(false);</span>
<span class="nc" id="L232">				cancelTicketBean.setError(true);</span>
<span class="nc" id="L233">				cancelTicketBean.setErrMsg(EmbeddedErrors.UNAUTH_RET_FOR_THIS_TKT_ERROR_MSG);</span>
<span class="nc" id="L234">				return cancelTicketBean;</span>
			}
<span class="nc" id="L236">			con.setAutoCommit(false);</span>
<span class="nc" id="L237">			ValidateTicketBean tktBean = Util.validateTkt(tNum);</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">			if (tktBean.isValid()) {</span>
<span class="nc" id="L239">				int gameId = Util.getGameIdFromGameNumber(tktBean.getGameNo());</span>

				// rg calling
				// autoCancel is used to stop calling RG when ticket is not
				// printed
<span class="nc" id="L244">				cancelTicketBean.setDayOfTicket(tktBean.getDayOfTicket());</span>
				// no need of calling advertising message on auto cancel ticket
<span class="nc bnc" id="L246" title="All 2 branches missed.">				if (!autoCancel) {</span>
<span class="nc" id="L247">					cancelTicketBean.setAdvMsg(</span>
							Util.getAdvMessage(userInfoBean.getUserOrgId(), gameId, &quot;PLAYER&quot;, &quot;CANCEL&quot;, &quot;DG&quot;));
				}
				// logger.info(&quot;**********autoCancel&quot; + autoCancel);

<span class="nc bnc" id="L252" title="All 2 branches missed.">				boolean isFraud = autoCancel ? false</span>
						: ResponsibleGaming.respGaming(userInfoBean, &quot;DG_CANCEL&quot;, &quot;1&quot;, con);
				// need to call responsible gaming for decrease the total sale
				// amount from sale

<span class="nc bnc" id="L257" title="All 2 branches missed.">				if (!isFraud) {</span>
					// cancelTicketBean.setTicketNo(tktBean.getTicketNumInDB());
					// cancelTicketBean.setReprintCount(tktBean.getReprintCount());
<span class="nc" id="L260">					cancelTicketBean.setGameNo(tktBean.getGameNo());</span>

<span class="nc bnc" id="L262" title="All 2 branches missed.">					if (&quot;manual&quot;.equals(cancelType)) {</span>
<span class="nc" id="L263">						cancelTicketBean.setAutoCancel(&quot;CANCEL_MANUAL&quot;);</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">					} else if (&quot;responseTimeOut&quot;.equals(cancelType)) {</span>
<span class="nc" id="L265">						cancelTicketBean.setAutoCancel(&quot;CANCEL_RTO&quot;);</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">					} else if (&quot;paperOut&quot;.equals(cancelType)) {</span>
<span class="nc" id="L267">						cancelTicketBean.setAutoCancel(&quot;CANCEL_PRINTER&quot;);</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">					} else if (&quot;dataError&quot;.equals(cancelType)) {</span>
<span class="nc" id="L269">						cancelTicketBean.setAutoCancel(&quot;CANCEL_DATA_ERROR&quot;);</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">					} else if (&quot;CANCEL_MISMATCH&quot;.equals(cancelType)) {</span>
<span class="nc" id="L271">						cancelTicketBean.setAutoCancel(&quot;CANCEL_MISMATCH&quot;);</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">					} else if (&quot;CANCEL_SERVER&quot;.equals(cancelType)) {</span>
<span class="nc" id="L273">						cancelTicketBean.setAutoCancel(&quot;CANCEL_SERVER&quot;);</span>
					} else {
<span class="nc" id="L275">						cancelTicketBean.setAutoCancel(&quot;CANCEL_PRINTER&quot;);</span>
					}

<span class="nc" id="L278">					String cancellationCharges = (String) LMSUtility.sc.getAttribute(&quot;DRAW_GAME_CANCELLATION_CHARGES&quot;);</span>
<span class="nc" id="L279">					boolean isPromoCancelled = true;</span>
					// cancelTicketBean.setTicketNo(tNum);
					// cancelStdTkt(userInfoBean, cancelTicketBean, con,
					// cancellationCharges);
					// get the promo ticket from promo tble

					// if sql exception in this function then cancel continue or
					// not
<span class="nc" id="L287">					List&lt;String&gt; promoTicketList = orgOnLineSaleCreditUpdation</span>
							.getAssociatedPromoTicket(tktBean.getTicketNumInDB(), con);
<span class="nc bnc" id="L289" title="All 4 branches missed.">					if (promoTicketList != null &amp;&amp; promoTicketList.size() &gt; 0) {</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">						for (int i = 0; i &lt; promoTicketList.size(); i++) {</span>
<span class="nc" id="L291">							int gameNo = getGamenoFromTktnumber(promoTicketList.get(i)</span>
									+ Util.getRpcAppenderForTickets(promoTicketList.get(i).length()));
<span class="nc" id="L293">							String gameType = Util.getGameType(Util.getGameIdFromGameNumber(gameNo));</span>

<span class="nc bnc" id="L295" title="All 2 branches missed.">							if (&quot;RAFFLE&quot;.equalsIgnoreCase(gameType)) {</span>
<span class="nc" id="L296">								cancelTicketBean.setPromoTicketList(promoTicketList);</span>
<span class="nc" id="L297">								cancelTicketBean.setReprintCount(tktBean.getReprintCount());</span>
<span class="nc" id="L298">								cancelTicketBean.setGameNo(gameNo);</span>
<span class="nc" id="L299">								cancelTicketBean.setGameId(Util.getGameIdFromGameNumber(gameNo));</span>

<span class="nc" id="L301">								isPromoCancelled = cancelRaffleTicket(cancelTicketBean, userInfoBean,</span>
										cancellationCharges, con);
							} else {
<span class="nc" id="L304">								cancelTicketBean.setTicketNo(promoTicketList.get(i));</span>
<span class="nc" id="L305">								cancelTicketBean.setReprintCount(tktBean.getReprintCount());</span>
<span class="nc" id="L306">								cancelTicketBean.setBarCodeCount(-1);</span>
<span class="nc" id="L307">								cancelTicketBean.setGameNo(gameNo);</span>
<span class="nc" id="L308">								cancelTicketBean.setGameId(Util.getGameIdFromGameNumber(gameNo));</span>
<span class="nc" id="L309">								isPromoCancelled = cancelStdTkt(userInfoBean, cancelTicketBean, con,</span>
										cancellationCharges);
							}

						}
					}
					// if and only if all the child ticket has been cancelled
					// then only parent ticket would be cancelled
					// After cancelling all the promo tickets main ticket would
					// be cancelled
<span class="nc bnc" id="L319" title="All 2 branches missed.">					if (isPromoCancelled) {</span>
<span class="nc" id="L320">						cancelTicketBean.setTicketNo(tktBean.getTicketNumInDB());</span>
<span class="nc" id="L321">						cancelTicketBean.setReprintCount(tktBean.getReprintCount());</span>
<span class="nc" id="L322">						cancelTicketBean.setBarCodeCount(-1);</span>
<span class="nc" id="L323">						cancelTicketBean.setGameNo(tktBean.getGameNo());</span>
<span class="nc" id="L324">						cancelTicketBean.setGameId(gameId);</span>
<span class="nc" id="L325">						boolean isCancelled = cancelStdTkt(userInfoBean, cancelTicketBean, con, cancellationCharges);</span>
<span class="nc bnc" id="L326" title="All 2 branches missed.">						if (isCancelled)</span>
<span class="nc" id="L327">							con.commit();</span>
					}

<span class="nc" id="L330">				} else {</span>
					// rg fail
<span class="nc" id="L332">					cancelTicketBean.setValid(false);</span>
<span class="nc" id="L333">					cancelTicketBean.setError(true);</span>
<span class="nc" id="L334">					cancelTicketBean.setErrMsg(EmbeddedErrors.CANCEL_TKT_LIMIT_EXCEED_ERROR_MSG + &quot;ErrorCode:&quot;</span>
							+ EmbeddedErrors.CANCEL_TKT_LIMIT_EXCEED_ERROR_CODE + &quot;|&quot;);
				}
<span class="nc" id="L337">			} else {</span>
<span class="nc" id="L338">				cancelTicketBean.setValid(false);</span>
			}
<span class="nc" id="L340">		} catch (Exception e) {</span>
<span class="nc" id="L341">			e.printStackTrace();</span>
<span class="nc" id="L342">			cancelTicketBean.setValid(false);</span>
		} finally {
<span class="nc bnc" id="L344" title="All 8 branches missed.">			if (con != null) {</span>
				try {
<span class="nc" id="L346">					con.close();</span>
<span class="nc" id="L347">				} catch (SQLException e) {</span>
<span class="nc" id="L348">					e.printStackTrace();</span>
<span class="nc" id="L349">				}</span>
			}
		}
<span class="nc" id="L352">		logger.debug(&quot;*Inside Cancel Ticket Before Return&quot;);</span>
<span class="nc" id="L353">		return cancelTicketBean;</span>
	}

	public void cancelTicket(String ticketNo, String cancelChannel, Map&lt;Integer, Map&lt;Integer, String&gt;&gt; drawIdTableMap,
			int gameNo, int partyId, String partyType, String refMerchantId, UserInfoBean userBean, String refTransId)
			throws LMSException {
<span class="fc" id="L359">		CancelTicketBean cancelTicketBean = new CancelTicketBean();</span>
<span class="fc" id="L360">		logger.debug(&quot;*Inside Cancel Ticket Failed Transaction&quot;);</span>

<span class="fc" id="L362">		ValidateTicketBean tktBean = Util.validateTkt(ticketNo);</span>
<span class="nc" id="L363">		cancelTicketBean.setTicketNo(tktBean.getTicketNumInDB());</span>
<span class="nc" id="L364">		cancelTicketBean.setReprintCount(tktBean.getReprintCount());</span>
<span class="nc" id="L365">		cancelTicketBean.setGameNo(tktBean.getGameNo());</span>
<span class="nc" id="L366">		cancelTicketBean.setGameId(Util.getGameIdFromGameNumber(tktBean.getGameNo()));</span>

<span class="nc" id="L368">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L369">		cancelTicketBean.setDrawIdTableMap(drawIdTableMap);</span>

<span class="nc" id="L371">		cancelTicketBean.setPartyId(partyId);</span>
<span class="nc" id="L372">		cancelTicketBean.setPartyType(partyType);</span>
<span class="nc" id="L373">		cancelTicketBean.setCancelChannel(cancelChannel);</span>
<span class="nc" id="L374">		cancelTicketBean.setRefMerchantId(refMerchantId);</span>
<span class="nc" id="L375">		cancelTicketBean.setRefTransId(refTransId);</span>
		// added by amit not present earlier
<span class="nc" id="L377">		cancelTicketBean.setAutoCancel(true);</span>
<span class="nc" id="L378">		cancelTicketBean.setAutoCancel(&quot;CANCEL_SERVER&quot;);</span>
<span class="nc" id="L379">		logger.debug(&quot;*Inside Cancel Ticket&quot;);</span>

<span class="nc" id="L381">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L382">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L383">		sReq.setServiceName(ServiceName.PLAYGAME);</span>
<span class="nc" id="L384">		sReq.setServiceMethod(ServiceMethodName.DRAWGAME_CANCEL_TICKET);</span>

<span class="nc" id="L386">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>

<span class="nc" id="L388">		String tNum = cancelTicketBean.getTicketNo();</span>

		try {
<span class="nc" id="L391">			con.setAutoCommit(false);</span>

<span class="nc" id="L393">			double tickRefundAmt = orgOnLineSaleCreditUpdation.drawTicketTxCancel(cancelTicketBean, userBean, con);</span>
<span class="nc" id="L394">			cancelTicketBean.setRefundAmount(tickRefundAmt);</span>
<span class="nc" id="L395">			con.commit();</span>
<span class="nc" id="L396">			AjaxRequestHelper ajxHelper = new AjaxRequestHelper();</span>
<span class="nc" id="L397">			ajxHelper.getAvlblCreditAmt(userBean, con);</span>
<span class="nc" id="L398">			DBConnect.closeCon(con);</span>
<span class="nc" id="L399">			cancelTicketBean.setUserId(userBean.getUserId());</span>
<span class="nc" id="L400">			cancelTicketBean.setTicketNo(ticketNo);</span>
<span class="nc" id="L401">			sReq.setServiceData(cancelTicketBean);</span>
<span class="nc" id="L402">			sRes = delegate.getResponse(sReq);</span>
<span class="nc bnc" id="L403" title="All 2 branches missed.">			if (sRes.getIsSuccess()) {</span>
<span class="nc" id="L404">				logger.debug(&quot;*Inside Cancel Ticket Success&quot;);</span>

			} else {
<span class="nc" id="L407">				logger.debug(&quot;*Inside Cancel Ticket Error&quot; + cancelTicketBean.getRefTransId());</span>
				// Mail to be sent to BO
			}

<span class="nc" id="L411">		} catch (Exception e) {</span>
<span class="nc" id="L412">			e.printStackTrace();</span>
<span class="nc" id="L413">			cancelTicketBean.setValid(false);</span>
		} finally {
<span class="nc bnc" id="L415" title="All 6 branches missed.">			if (con != null) {</span>
				try {
<span class="nc" id="L417">					con.close();</span>
<span class="nc" id="L418">				} catch (SQLException e) {</span>
<span class="nc" id="L419">					e.printStackTrace();</span>
<span class="nc" id="L420">				}</span>
			}
		}
<span class="nc" id="L423">		logger.debug(&quot;*Inside Cancel Ticket Failed Trx&quot;);</span>
<span class="nc" id="L424">	}</span>

	public FortunePurchaseBean card12PurchaseTicket(UserInfoBean userBean, FortunePurchaseBean card12PurchaseBean)
			throws LMSException {

		// int balDed = 0;
<span class="nc" id="L430">		long balDed = 0;</span>
		// int tickUpd = 0;
<span class="nc" id="L432">		int tickUpd = 0;</span>
<span class="nc" id="L433">		String status = &quot;&quot;;</span>
<span class="nc" id="L434">		double oldTotalPurchaseAmt = 0.0;</span>
<span class="nc" id="L435">		double modifiedTotalPurchaseAmt = 0.0;</span>
<span class="nc" id="L436">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L437">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L438">		sReq.setServiceName(ServiceName.CARD12);</span>
<span class="nc" id="L439">		sReq.setServiceMethod(ServiceMethodName.CARD12_PURCHASE_TICKET);</span>
<span class="nc" id="L440">		sReq.setServiceData(card12PurchaseBean);</span>
<span class="nc" id="L441">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L442">		Connection con = null;</span>
		try {
<span class="nc bnc" id="L444" title="All 4 branches missed.">			if (isDrawAvailable(card12PurchaseBean.getGame_no())</span>
					|| chkFreezeTimeSale(card12PurchaseBean.getGame_no())) {
<span class="nc" id="L446">				card12PurchaseBean.setSaleStatus(&quot;NO_DRAWS&quot;);</span>
<span class="nc" id="L447">				return card12PurchaseBean;</span>
			}
<span class="nc bnc" id="L449" title="All 2 branches missed.">			if (fortuneDataValidation(card12PurchaseBean)) {</span>
<span class="nc" id="L450">				logger.debug(&quot;Data validation returns true&quot;);</span>
				// card12PurchaseBean.setAdvMsg(Util.getAdvMessage(userBean.getUserOrgId(),
				// card12PurchaseBean.getGame_no(), &quot;PLAYER&quot;, &quot;SALE&quot;, &quot;DG&quot;));
<span class="nc" id="L453">				card12PurchaseBean</span>
						.setAdvMsg(Util.getDGSaleAdvMessage(userBean.getUserOrgId(), card12PurchaseBean.getGame_no()));

<span class="nc" id="L456">				card12PurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L457">				double totPurAmt = card12PurchaseBean.getTotalNoOfPanels()</span>
						* Util.getUnitPrice(card12PurchaseBean.getGame_no(), null) * card12PurchaseBean.getNoOfDraws();

<span class="nc" id="L460">				logger.debug(&quot;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&quot; + totPurAmt);</span>
<span class="nc" id="L461">				card12PurchaseBean.setTotalPurchaseAmt(totPurAmt);</span>
<span class="nc bnc" id="L462" title="All 2 branches missed.">				if (!userBean.getUserType().equals(&quot;RETAILER&quot;)) {</span>
<span class="nc" id="L463">					return card12PurchaseBean;</span>
				}
<span class="nc" id="L465">				logger.debug(&quot;Inside Card12 FE1*******&quot;);</span>
<span class="nc" id="L466">				con = DBConnect.getConnection();</span>

				// rg calling
<span class="nc" id="L469">				boolean isFraud = ResponsibleGaming.respGaming(userBean, &quot;DG_SALE&quot;, totPurAmt + &quot;&quot;, con);</span>
<span class="nc bnc" id="L470" title="All 2 branches missed.">				if (!isFraud) {</span>

<span class="nc" id="L472">					balDed = orgOnLineSaleCreditUpdation.drawTcketSaleBalDeduction(userBean,</span>
							card12PurchaseBean.getGame_no(), card12PurchaseBean.getTotalPurchaseAmt(),
							card12PurchaseBean.getPlrMobileNumber(), con);
<span class="nc" id="L475">					oldTotalPurchaseAmt = card12PurchaseBean.getTotalPurchaseAmt();</span>

<span class="nc" id="L477">					logger.debug(&quot;Total Purchase Amt inside DrawGameRPOSHelper Just Before  getting Success :&quot;</span>
							+ oldTotalPurchaseAmt);
				} else {
<span class="nc" id="L480">					logger.debug(&quot;Responsing Gaming not allowed to sale&quot;);</span>
<span class="nc" id="L481">					card12PurchaseBean.setSaleStatus(&quot;FRAUD&quot;);</span>
				}

<span class="nc" id="L484">				logger.debug(&quot;Inside Card12 FE*******&quot; + sRes);</span>
<span class="nc" id="L485">				return card12PurchaseBean;</span>
			} else {
<span class="nc" id="L487">				logger.debug(&quot;Data validation returns false&quot;);</span>
<span class="nc" id="L488">				card12PurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L489">				return card12PurchaseBean;</span>
			}
<span class="nc" id="L491">		} catch (Exception e) {</span>

<span class="nc" id="L493">			e.printStackTrace();</span>
		}

		try {
<span class="nc bnc" id="L497" title="All 2 branches missed.">			if (balDed &gt; 0) {</span>
<span class="nc" id="L498">				card12PurchaseBean.setRefTransId(balDed + &quot;&quot;);</span>
<span class="nc" id="L499">				sRes = delegate.getResponse(sReq);</span>

<span class="nc bnc" id="L501" title="All 2 branches missed.">				if (sRes.getIsSuccess()) {</span>
<span class="nc" id="L502">					card12PurchaseBean = (FortunePurchaseBean) sRes.getResponseData();</span>

<span class="nc" id="L504">					modifiedTotalPurchaseAmt = card12PurchaseBean.getTotalPurchaseAmt();</span>
<span class="nc" id="L505">					logger.debug(&quot;Total Purchase Amt inside DrawGameRPOSHelper After getting Success :&quot;</span>
							+ modifiedTotalPurchaseAmt);

<span class="nc bnc" id="L508" title="All 2 branches missed.">					if (oldTotalPurchaseAmt != modifiedTotalPurchaseAmt) {</span>
<span class="nc" id="L509">						balDed = orgOnLineSaleCreditUpdation.drawTcketSaleBalDedUpdate(userBean,</span>
								card12PurchaseBean.getGame_no(), modifiedTotalPurchaseAmt, oldTotalPurchaseAmt, balDed,
								con);

					}
<span class="nc" id="L514">					tickUpd = orgOnLineSaleCreditUpdation.drawTicketSaleTicketUpdate(balDed,</span>
							card12PurchaseBean.getTicket_no(), card12PurchaseBean.getGame_no(), userBean,
							card12PurchaseBean.getPurchaseChannel(), con);

<span class="nc bnc" id="L518" title="All 2 branches missed.">					if (tickUpd == 1) {</span>
<span class="nc" id="L519">						status = &quot;SUCCESS&quot;;</span>
<span class="nc" id="L520">						card12PurchaseBean.setSaleStatus(status);</span>
<span class="nc bnc" id="L521" title="All 2 branches missed.">						if (!card12PurchaseBean.getBarcodeType().equals(&quot;applet&quot;)) {</span>
<span class="nc" id="L522">							new IDBarcode().getBarcode(</span>
									card12PurchaseBean.getTicket_no() + card12PurchaseBean.getReprintCount());
						}
<span class="nc" id="L525">						return card12PurchaseBean;</span>
					} else {
<span class="nc" id="L527">						status = &quot;FAILED&quot;;</span>
<span class="nc" id="L528">						card12PurchaseBean.setSaleStatus(status);</span>
						// Code for cancelling the Ticket to be send to
						// Draw
						// Game Engine
<span class="nc" id="L532">						cancelTicket(card12PurchaseBean.getTicket_no() + card12PurchaseBean.getReprintCount(),</span>
								card12PurchaseBean.getPurchaseChannel(), card12PurchaseBean.getDrawIdTableMap(),
								card12PurchaseBean.getGame_no(), card12PurchaseBean.getPartyId(),
								card12PurchaseBean.getPartyType(), card12PurchaseBean.getRefMerchantId(), userBean,
								card12PurchaseBean.getRefTransId());
<span class="nc" id="L537">						return card12PurchaseBean;</span>
					}
				} else {
<span class="nc" id="L540">					card12PurchaseBean = (FortunePurchaseBean) sRes.getResponseData();</span>
<span class="nc bnc" id="L541" title="All 2 branches missed.">					if (card12PurchaseBean.getSaleStatus() == null) {</span>
<span class="nc" id="L542">						card12PurchaseBean.setSaleStatus(&quot;FAILED&quot;);// Error</span>
<span class="nc" id="L543">						orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, card12PurchaseBean.getGame_no(),</span>
								&quot;FAILED&quot;, balDed);
<span class="nc" id="L545">						return card12PurchaseBean;</span>
<span class="nc bnc" id="L546" title="All 2 branches missed.">					} else if (&quot;ERROR_TICKET_LIMIT&quot;.equalsIgnoreCase(card12PurchaseBean.getSaleStatus())) {</span>
<span class="nc" id="L547">						orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, card12PurchaseBean.getGame_no(),</span>
								&quot;FAILED&quot;, balDed);
<span class="nc" id="L549">						return card12PurchaseBean;</span>
					} else {
<span class="nc" id="L551">						orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, card12PurchaseBean.getGame_no(),</span>
								&quot;FAILED&quot;, balDed);
<span class="nc" id="L553">						return card12PurchaseBean;</span>
					}
				}
			} else {

<span class="nc" id="L558">				status = getStatusIfErrorInTransaction(status, balDed);</span>
<span class="nc" id="L559">				card12PurchaseBean.setSaleStatus(status);</span>
<span class="nc" id="L560">				return card12PurchaseBean;</span>
			}
<span class="nc" id="L562">		} catch (Exception e) {</span>
			// TODO: handle exception
		}
<span class="nc" id="L565">		return card12PurchaseBean;</span>
	}

	public FortunePurchaseBean card16PurchaseTicket(UserInfoBean userBean, FortunePurchaseBean card16PurchaseBean)
			throws LMSException {
		// int balDed = 0;
<span class="nc" id="L571">		long balDed = 0;</span>
<span class="nc" id="L572">		int tickUpd = 0;</span>
<span class="nc" id="L573">		String status = &quot;&quot;;</span>
		// int tickUpd = 0;
<span class="nc" id="L575">		double oldTotalPurchaseAmt = 0.0;</span>
<span class="nc" id="L576">		double modifiedTotalPurchaseAmt = 0.0;</span>
<span class="nc" id="L577">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L578">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L579">		sReq.setServiceName(ServiceName.CARD16);</span>
<span class="nc" id="L580">		sReq.setServiceMethod(ServiceMethodName.CARD16_PURCHASE_TICKET);</span>
<span class="nc" id="L581">		sReq.setServiceData(card16PurchaseBean);</span>
<span class="nc" id="L582">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L583">		Connection con = null;</span>
<span class="nc bnc" id="L584" title="All 4 branches missed.">		if (isDrawAvailable(card16PurchaseBean.getGame_no()) || chkFreezeTimeSale(card16PurchaseBean.getGame_no())) {</span>
<span class="nc" id="L585">			card16PurchaseBean.setSaleStatus(&quot;NO_DRAWS&quot;);</span>
<span class="nc" id="L586">			return card16PurchaseBean;</span>
		}

		try {
<span class="nc bnc" id="L590" title="All 2 branches missed.">			if (fortuneDataValidation(card16PurchaseBean)) {</span>
<span class="nc" id="L591">				logger.debug(&quot;Data validation returns true&quot;);</span>
				// card16PurchaseBean.setAdvMsg(Util.getAdvMessage(userBean.getUserOrgId(),
				// card16PurchaseBean.getGame_no(), &quot;PLAYER&quot;, &quot;SALE&quot;, &quot;DG&quot;));
<span class="nc" id="L594">				card16PurchaseBean</span>
						.setAdvMsg(Util.getDGSaleAdvMessage(userBean.getUserOrgId(), card16PurchaseBean.getGame_no()));

<span class="nc" id="L597">				card16PurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L598">				double totPurAmt = card16PurchaseBean.getTotalNoOfPanels()</span>
						* Util.getUnitPrice(card16PurchaseBean.getGame_no(), null) * card16PurchaseBean.getNoOfDraws();

<span class="nc" id="L601">				logger.debug(&quot;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&quot; + totPurAmt);</span>
<span class="nc" id="L602">				card16PurchaseBean.setTotalPurchaseAmt(totPurAmt);</span>
<span class="nc bnc" id="L603" title="All 2 branches missed.">				if (!userBean.getUserType().equals(&quot;RETAILER&quot;)) {</span>
<span class="nc" id="L604">					return card16PurchaseBean;</span>
				}
<span class="nc" id="L606">				con = DBConnect.getConnection();</span>
<span class="nc" id="L607">				logger.debug(&quot;Inside Card16 FE1*******&quot;);</span>
				// rg calling
<span class="nc" id="L609">				boolean isFraud = ResponsibleGaming.respGaming(userBean, &quot;DG_SALE&quot;, totPurAmt + &quot;&quot;);</span>
<span class="nc bnc" id="L610" title="All 2 branches missed.">				if (!isFraud) {</span>

<span class="nc" id="L612">					balDed = orgOnLineSaleCreditUpdation.drawTcketSaleBalDeduction(userBean,</span>
							card16PurchaseBean.getGame_no(), card16PurchaseBean.getTotalPurchaseAmt(),
							card16PurchaseBean.getPlrMobileNumber(), con);
<span class="nc" id="L615">					oldTotalPurchaseAmt = card16PurchaseBean.getTotalPurchaseAmt();</span>

<span class="nc" id="L617">					logger.debug(&quot;Total Purchase Amt inside DrawGameRPOSHelper Just Before  getting Success :&quot;</span>
							+ oldTotalPurchaseAmt);

				} else {
<span class="nc" id="L621">					logger.debug(&quot;Responsing Gaming not allowed to sale&quot;);</span>
<span class="nc" id="L622">					card16PurchaseBean.setSaleStatus(&quot;FRAUD&quot;);</span>
				}

<span class="nc" id="L625">				logger.debug(&quot;Inside Card12 FE*******&quot; + sRes);</span>
<span class="nc" id="L626">				return card16PurchaseBean;</span>
			} else {
<span class="nc" id="L628">				logger.debug(&quot;Data validation returns false&quot;);</span>
<span class="nc" id="L629">				card16PurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L630">				return card16PurchaseBean;</span>
			}
<span class="nc" id="L632">		} catch (Exception e) {</span>

<span class="nc" id="L634">			e.printStackTrace();</span>
		}

		try {

<span class="nc bnc" id="L639" title="All 2 branches missed.">			if (balDed &gt; 0) {</span>
<span class="nc" id="L640">				card16PurchaseBean.setRefTransId(balDed + &quot;&quot;);</span>
<span class="nc" id="L641">				sRes = delegate.getResponse(sReq);</span>

<span class="nc bnc" id="L643" title="All 2 branches missed.">				if (sRes.getIsSuccess()) {</span>
<span class="nc" id="L644">					card16PurchaseBean = (FortunePurchaseBean) sRes.getResponseData();</span>

<span class="nc" id="L646">					modifiedTotalPurchaseAmt = card16PurchaseBean.getTotalPurchaseAmt();</span>
<span class="nc" id="L647">					logger.debug(&quot;Total Purchase Amt inside DrawGameRPOSHelper After getting Success :&quot;</span>
							+ modifiedTotalPurchaseAmt);
<span class="nc" id="L649">					con = DBConnect.getConnection();</span>
<span class="nc bnc" id="L650" title="All 2 branches missed.">					if (oldTotalPurchaseAmt != modifiedTotalPurchaseAmt) {</span>
<span class="nc" id="L651">						balDed = orgOnLineSaleCreditUpdation.drawTcketSaleBalDedUpdate(userBean,</span>
								card16PurchaseBean.getGame_no(), modifiedTotalPurchaseAmt, oldTotalPurchaseAmt, balDed,
								con);

					}
<span class="nc" id="L656">					tickUpd = orgOnLineSaleCreditUpdation.drawTicketSaleTicketUpdate(balDed,</span>
							card16PurchaseBean.getTicket_no(), card16PurchaseBean.getGame_no(), userBean,
							card16PurchaseBean.getPurchaseChannel(), con);

<span class="nc bnc" id="L660" title="All 2 branches missed.">					if (tickUpd == 1) {</span>
<span class="nc" id="L661">						status = &quot;SUCCESS&quot;;</span>
<span class="nc" id="L662">						card16PurchaseBean.setSaleStatus(status);</span>
<span class="nc bnc" id="L663" title="All 2 branches missed.">						if (!card16PurchaseBean.getBarcodeType().equals(&quot;applet&quot;)) {</span>
<span class="nc" id="L664">							new IDBarcode().getBarcode(</span>
									card16PurchaseBean.getTicket_no() + card16PurchaseBean.getReprintCount());
						}
<span class="nc" id="L667">						return card16PurchaseBean;</span>
					} else {
<span class="nc" id="L669">						status = &quot;FAILED&quot;;</span>
<span class="nc" id="L670">						card16PurchaseBean.setSaleStatus(status);</span>
						// Code for cancelling the Ticket to be send to
						// Draw
						// Game Engine
<span class="nc" id="L674">						cancelTicket(card16PurchaseBean.getTicket_no() + card16PurchaseBean.getReprintCount(),</span>
								card16PurchaseBean.getPurchaseChannel(), card16PurchaseBean.getDrawIdTableMap(),
								card16PurchaseBean.getGame_no(), card16PurchaseBean.getPartyId(),
								card16PurchaseBean.getPartyType(), card16PurchaseBean.getRefMerchantId(), userBean,
								card16PurchaseBean.getRefTransId());
<span class="nc" id="L679">						return card16PurchaseBean;</span>
					}
				} else {
<span class="nc" id="L682">					card16PurchaseBean = (FortunePurchaseBean) sRes.getResponseData();</span>
<span class="nc bnc" id="L683" title="All 2 branches missed.">					if (card16PurchaseBean.getSaleStatus() == null) {</span>
<span class="nc" id="L684">						card16PurchaseBean.setSaleStatus(&quot;FAILED&quot;);// Error</span>
<span class="nc" id="L685">						orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, card16PurchaseBean.getGame_no(),</span>
								&quot;FAILED&quot;, balDed);
<span class="nc" id="L687">						return card16PurchaseBean;</span>
<span class="nc bnc" id="L688" title="All 2 branches missed.">					} else if (&quot;ERROR_TICKET_LIMIT&quot;.equalsIgnoreCase(card16PurchaseBean.getSaleStatus())) {</span>
<span class="nc" id="L689">						orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, card16PurchaseBean.getGame_no(),</span>
								&quot;FAILED&quot;, balDed);
<span class="nc" id="L691">						return card16PurchaseBean;</span>
					} else {
<span class="nc" id="L693">						orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, card16PurchaseBean.getGame_no(),</span>
								&quot;FAILED&quot;, balDed);
<span class="nc" id="L695">						return card16PurchaseBean;</span>
					}
				}
			} else {

<span class="nc" id="L700">				status = getStatusIfErrorInTransaction(status, balDed);</span>
<span class="nc" id="L701">				card16PurchaseBean.setSaleStatus(status);</span>
<span class="nc" id="L702">				return card16PurchaseBean;</span>
			}
<span class="nc" id="L704">		} catch (Exception e) {</span>
			// TODO: handle exception
		}
<span class="nc" id="L707">		return card16PurchaseBean;</span>
	}

	public LottoPurchaseBean commonPromoPurchaseProcess(LottoPurchaseBean lottoPurchaseBean, UserInfoBean userBean)
			throws LMSException, SQLException {

<span class="nc" id="L713">		List&lt;RafflePurchaseBean&gt; rafflePurchaseBeanList = new ArrayList&lt;RafflePurchaseBean&gt;();</span>
<span class="nc" id="L714">		CommonFunctionsHelper commonHelper = new CommonFunctionsHelper();</span>
		// String gameType = getGameType(kenoPurchaseBean.getGame_no());
<span class="nc" id="L716">		String gameName = Util.getGameName(lottoPurchaseBean.getGame_no());</span>
<span class="nc" id="L717">		List&lt;PromoGameBean&gt; promoGameslist = DGPromoScheme.getAvailablePromoGamesNew(gameName,</span>
				lottoPurchaseBean.getTotalPurchaseAmt(), null);

<span class="nc bnc" id="L720" title="All 2 branches missed.">		for (int i = 0; i &lt; promoGameslist.size(); i++) {</span>
<span class="nc" id="L721">			PromoGameBean promobean = promoGameslist.get(i);</span>
<span class="nc bnc" id="L722" title="All 2 branches missed.">			if (promobean.getPromoGametype().equalsIgnoreCase(&quot;RAFFLE&quot;)) {</span>
<span class="nc" id="L723">				lottoPurchaseBean.setRaffleNo(promobean.getPromoGameNo());</span>
<span class="nc" id="L724">				RafflePurchaseBean rafflePurchaseBean = (RafflePurchaseBean) rafflePurchaseTicket(userBean,</span>
						lottoPurchaseBean, true);
<span class="nc" id="L726">				rafflePurchaseBean.setRaffleTicketType(promobean.getPromoTicketType());</span>
<span class="nc bnc" id="L727" title="All 2 branches missed.">				if (rafflePurchaseBean.getSaleStatus().equalsIgnoreCase(&quot;FAILED&quot;)) {</span>
<span class="nc" id="L728">					lottoPurchaseBean.setPromoSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L729">					return lottoPurchaseBean;</span>
<span class="nc bnc" id="L730" title="All 2 branches missed.">				} else if (rafflePurchaseBean.getSaleStatus().equalsIgnoreCase(&quot;SUCCESS&quot;)) {</span>
					// here insert entry into the promo ticket mapping table
<span class="nc" id="L732">					int tktlen = rafflePurchaseBean.getRaffleTicket_no().length();</span>
<span class="nc" id="L733">					orgOnLineSaleCreditUpdation.drawTicketNPromoMappigUpdate(1, rafflePurchaseBean.getGame_no(),</span>
							rafflePurchaseBean.getParentTktNo(),
							rafflePurchaseBean.getRaffleTicket_no().substring(0, tktlen - 2));
<span class="nc" id="L736">					rafflePurchaseBeanList.add(rafflePurchaseBean);</span>
				}
<span class="nc" id="L738">				lottoPurchaseBean.setPromoPurchaseBean(rafflePurchaseBeanList);</span>
<span class="nc bnc" id="L739" title="All 2 branches missed.">			} else if (promobean.getPromoGametype().equalsIgnoreCase(&quot;Zerotonine&quot;)) {</span>
				// call winfast purchase process
<span class="nc" id="L741">				int gameId = Util.getGameId(&quot;Zerotonine&quot;);</span>
<span class="nc" id="L742">				FortunePurchaseBean drawGamePurchaseBean = new FortunePurchaseBean();</span>
<span class="nc" id="L743">				drawGamePurchaseBean.setIsQP(1);</span>
<span class="nc" id="L744">				drawGamePurchaseBean.setTotalNoOfPanels(1);</span>
				// drawGamePurchaseBean.setSymbols(symbols);
<span class="nc" id="L746">				drawGamePurchaseBean.setNoOfPanels(&quot;1&quot;);</span>

				// drawGamePurchaseBean.setBetAmountMultiple(betAmountMultiple);
<span class="nc" id="L749">				drawGamePurchaseBean.setDrawIdTableMap(lottoPurchaseBean.getDrawIdTableMap());</span>
<span class="nc" id="L750">				drawGamePurchaseBean.setGame_no(gameId);</span>
<span class="nc" id="L751">				drawGamePurchaseBean.setGameDispName(Util.getGameDisplayName(gameId));</span>
				// drawGamePurchaseBean.setIsQuickPick(isQuickPickNew);
<span class="nc" id="L753">				drawGamePurchaseBean.setNoOfDraws(1);</span>
<span class="nc" id="L754">				drawGamePurchaseBean.setPartyId(userBean.getUserOrgId());</span>
<span class="nc" id="L755">				drawGamePurchaseBean.setPartyType(userBean.getUserType());</span>
<span class="nc" id="L756">				drawGamePurchaseBean.setUserId(userBean.getUserId());</span>
<span class="nc" id="L757">				drawGamePurchaseBean.setRefMerchantId(lottoPurchaseBean.getRefMerchantId());</span>
<span class="nc" id="L758">				drawGamePurchaseBean.setPurchaseChannel(lottoPurchaseBean.getPurchaseChannel());</span>
<span class="nc" id="L759">				drawGamePurchaseBean.setPromotkt(true);</span>
<span class="nc" id="L760">				drawGamePurchaseBean.setPlrMobileNumber(lottoPurchaseBean.getPlrMobileNumber());</span>
				// if (drawIdArr != null) {
				// drawGamePurchaseBean.setDrawDateTime(Arrays.asList(drawIdArr));
				// }
<span class="nc" id="L764">				drawGamePurchaseBean.setIsAdvancedPlay(0);</span>
<span class="nc" id="L765">				FortunePurchaseBean fortuneBean = zeroToNinePurchaseTicket(userBean, drawGamePurchaseBean);</span>
<span class="nc bnc" id="L766" title="All 2 branches missed.">				if (&quot;SUCCESS&quot;.equalsIgnoreCase(fortuneBean.getSaleStatus())) {</span>
<span class="nc" id="L767">					orgOnLineSaleCreditUpdation.drawTicketNPromoMappigUpdate(1, lottoPurchaseBean.getGame_no(),</span>
							lottoPurchaseBean.getTicket_no(), fortuneBean.getTicket_no());
				} else {
<span class="nc" id="L770">					lottoPurchaseBean.setPromoSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L771">					return lottoPurchaseBean;</span>
				}
				// kenoPurchaseBean.setFortunePurchaseBean(fortuneBean);
<span class="nc" id="L774">				lottoPurchaseBean.setPromoPurchaseBean(fortuneBean);</span>
			}
			// kenoPurchaseBean.setRafflePurchaseBeanList(rafflePurchaseBeanList);
			// kenoPurchaseBean.setPromoPurchaseBean(rafflePurchaseBeanList);
		}

<span class="nc" id="L780">		return lottoPurchaseBean;</span>
	}

	public KenoPurchaseBean commonPromoPurchaseProcess(KenoPurchaseBean kenoPurchaseBean, UserInfoBean userBean)
			throws LMSException, SQLException {

<span class="fc" id="L786">		List&lt;RafflePurchaseBean&gt; rafflePurchaseBeanList = new ArrayList&lt;RafflePurchaseBean&gt;();</span>

<span class="fc" id="L788">		List&lt;PromoGameBean&gt; promoGameslist = Util.promoGameBeanMap.get(kenoPurchaseBean.getGameId());</span>
<span class="fc" id="L789">		java.util.Date date1 = new java.util.Date();</span>
<span class="fc" id="L790">		Calendar cal = Calendar.getInstance();</span>
<span class="fc" id="L791">		Time currentTime = new Time(date1.getTime());</span>
<span class="pc bpc" id="L792" title="1 of 2 branches missed.">		if (promoGameslist != null) {</span>
<span class="nc bnc" id="L793" title="All 2 branches missed.">			for (int i = 0; i &lt; promoGameslist.size(); i++) {</span>
<span class="nc" id="L794">				PromoGameBean promobean = promoGameslist.get(i);</span>
<span class="nc bnc" id="L795" title="All 4 branches missed.">				if (promobean.getSaleStartTime() != null &amp;&amp; promobean.getSaleStartTime().trim().length() &gt; 1) {</span>
<span class="nc" id="L796">					String timeArray[] = promobean.getSaleStartTime().split(&quot;:&quot;); // HH:mm:ss</span>
<span class="nc" id="L797">					cal.set(Calendar.HOUR_OF_DAY, Integer.parseInt(timeArray[0])); // Your</span>
																					// hour
<span class="nc" id="L799">					cal.set(Calendar.MINUTE, Integer.parseInt(timeArray[1])); // Your</span>
																				// Mintue
<span class="nc" id="L801">					cal.set(Calendar.SECOND, Integer.parseInt(timeArray[2])); // Your</span>
																				// second
<span class="nc" id="L803">					Time saleStartTime = new Time(cal.getTime().getTime());</span>
<span class="nc" id="L804">					timeArray = promobean.getSaleEndTime().split(&quot;:&quot;); // HH:mm:ss</span>
<span class="nc" id="L805">					cal.set(Calendar.HOUR_OF_DAY, Integer.parseInt(timeArray[0])); // Your</span>
																					// hour
<span class="nc" id="L807">					cal.set(Calendar.MINUTE, Integer.parseInt(timeArray[1])); // Your</span>
																				// Mintue
<span class="nc" id="L809">					cal.set(Calendar.SECOND, Integer.parseInt(timeArray[2])); // Your</span>
																				// second
<span class="nc" id="L811">					Time saleEndTime = new Time(cal.getTime().getTime());</span>
<span class="nc" id="L812">					logger.info(&quot;Promo Criteria currentTime&quot; + currentTime + &quot; saleStartTime &quot; + saleStartTime</span>
							+ &quot; saleEndTime &quot; + saleEndTime + &quot; Amount &quot; + promobean.getSaleTicketAmt());
<span class="nc bnc" id="L814" title="All 6 branches missed.">					if (currentTime.before(saleStartTime) || currentTime.after(saleEndTime)</span>
							|| kenoPurchaseBean.getTotalPurchaseAmt() &lt; promobean.getSaleTicketAmt()) {
<span class="nc" id="L816">						logger.info(&quot;Promo Criteria does not match&quot;);</span>
<span class="nc" id="L817">						kenoPurchaseBean.setPromoSaleStatus(&quot;SUCCESS&quot;);</span>
<span class="nc" id="L818">						return kenoPurchaseBean;</span>
					} else {
<span class="nc" id="L820">						logger.info(&quot;Promo Criteria match&quot;);</span>
					}
<span class="nc" id="L822">				} else {</span>
<span class="nc" id="L823">					logger.info(&quot;Promo Criteria Not Set&quot;);</span>
				}

<span class="nc bnc" id="L826" title="All 2 branches missed.">				if (&quot;RAFFLE&quot;.equalsIgnoreCase(promobean.getPromoGametype())) {</span>
<span class="nc" id="L827">					kenoPurchaseBean.setRaffleNo(promobean.getPromoGameNo());</span>
<span class="nc" id="L828">					kenoPurchaseBean.setNoofDrawsForPromo(promobean.getNoOfDraws());</span>
<span class="nc" id="L829">					RafflePurchaseBean rafflePurchaseBean = (RafflePurchaseBean) rafflePurchaseTicket(userBean,</span>
							kenoPurchaseBean, true);
<span class="nc" id="L831">					rafflePurchaseBean.setRaffleTicketType(promobean.getPromoTicketType());</span>
<span class="nc bnc" id="L832" title="All 2 branches missed.">					if (rafflePurchaseBean.getSaleStatus().equalsIgnoreCase(&quot;FAILED&quot;)) {</span>
<span class="nc" id="L833">						kenoPurchaseBean.setPromoSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L834">						return kenoPurchaseBean;</span>
<span class="nc bnc" id="L835" title="All 2 branches missed.">					} else if (rafflePurchaseBean.getSaleStatus().equalsIgnoreCase(&quot;SUCCESS&quot;)) {</span>
						// here insert entry into the promo ticket mapping table
<span class="nc" id="L837">						int tktlen = rafflePurchaseBean.getRaffleTicket_no().length();</span>
<span class="nc" id="L838">						orgOnLineSaleCreditUpdation.drawTicketNPromoMappigUpdate(1, rafflePurchaseBean.getGame_no(),</span>
								rafflePurchaseBean.getParentTktNo(), rafflePurchaseBean.getRaffleTicket_no());
<span class="nc" id="L840">						rafflePurchaseBeanList.add(rafflePurchaseBean);</span>
					}
<span class="nc" id="L842">					kenoPurchaseBean.setPromoPurchaseBean(rafflePurchaseBeanList);</span>
<span class="nc bnc" id="L843" title="All 2 branches missed.">				} else if (&quot;Zerotonine&quot;.equals(promobean.getPromoGametype())) {</span>
					// call winfast purchase process
<span class="nc" id="L845">					int gameId = Util.getGameId(&quot;Zerotonine&quot;);</span>
<span class="nc" id="L846">					FortunePurchaseBean drawGamePurchaseBean = new FortunePurchaseBean();</span>
<span class="nc" id="L847">					drawGamePurchaseBean.setIsQP(1);</span>
<span class="nc" id="L848">					drawGamePurchaseBean.setTotalNoOfPanels(1);</span>
					// drawGamePurchaseBean.setSymbols(symbols);
<span class="nc" id="L850">					drawGamePurchaseBean.setNoOfPanels(&quot;1&quot;);</span>

					// drawGamePurchaseBean.setBetAmountMultiple(betAmountMultiple);
<span class="nc" id="L853">					drawGamePurchaseBean.setDrawIdTableMap(kenoPurchaseBean.getDrawIdTableMap());</span>
<span class="nc" id="L854">					drawGamePurchaseBean.setGame_no(gameId);</span>
<span class="nc" id="L855">					drawGamePurchaseBean.setGameDispName(Util.getGameDisplayName(gameId));</span>
					// drawGamePurchaseBean.setIsQuickPick(isQuickPickNew);
<span class="nc" id="L857">					drawGamePurchaseBean.setNoOfDraws(1);</span>
<span class="nc" id="L858">					drawGamePurchaseBean.setPartyId(userBean.getUserOrgId());</span>
<span class="nc" id="L859">					drawGamePurchaseBean.setPartyType(userBean.getUserType());</span>
<span class="nc" id="L860">					drawGamePurchaseBean.setUserId(userBean.getUserId());</span>
<span class="nc" id="L861">					drawGamePurchaseBean.setRefMerchantId(kenoPurchaseBean.getRefMerchantId());</span>
<span class="nc" id="L862">					drawGamePurchaseBean.setPurchaseChannel(kenoPurchaseBean.getPurchaseChannel());</span>
<span class="nc" id="L863">					drawGamePurchaseBean.setPlrMobileNumber(kenoPurchaseBean.getPlrMobileNumber());</span>
<span class="nc" id="L864">					drawGamePurchaseBean.setPromotkt(true);</span>
					// if (drawIdArr != null) {
					// drawGamePurchaseBean.setDrawDateTime(Arrays.asList(drawIdArr));
					// }
<span class="nc" id="L868">					drawGamePurchaseBean.setIsAdvancedPlay(0);</span>
<span class="nc" id="L869">					FortunePurchaseBean fortuneBean = zeroToNinePurchaseTicket(userBean, drawGamePurchaseBean);</span>
<span class="nc bnc" id="L870" title="All 2 branches missed.">					if (&quot;SUCCESS&quot;.equalsIgnoreCase(fortuneBean.getSaleStatus())) {</span>
<span class="nc" id="L871">						orgOnLineSaleCreditUpdation.drawTicketNPromoMappigUpdate(1, kenoPurchaseBean.getGame_no(),</span>
								kenoPurchaseBean.getTicket_no(), fortuneBean.getTicket_no());
					} else {
<span class="nc" id="L874">						kenoPurchaseBean.setPromoSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L875">						return kenoPurchaseBean;</span>
					}
					// kenoPurchaseBean.setFortunePurchaseBean(fortuneBean);
<span class="nc" id="L878">					kenoPurchaseBean.setPromoPurchaseBean(fortuneBean);</span>
<span class="nc bnc" id="L879" title="All 4 branches missed.">				} else if (&quot;TwelveByTwentyFour&quot;.equals(promobean.getPromoGameName())</span>
						&amp;&amp; kenoPurchaseBean.getTotalPurchaseAmt() &gt;= Double
								.parseDouble(Utility.getPropertyValue(&quot;TwelveByTwentyFourFreeAmtLimit&quot;))) {
<span class="nc" id="L882">					boolean isAvail = false;</span>
<span class="nc" id="L883">					DateFormat df = new SimpleDateFormat(&quot;HH:mm:ss&quot;);</span>
<span class="nc" id="L884">					DateFormat pdf = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;);</span>
					try {
<span class="nc bnc" id="L886" title="All 2 branches missed.">						if (Utility.getPropertyValue(&quot;TwelveByTwentyFourFreeTime&quot;) != null) {</span>
<span class="nc" id="L887">							String gameArr[] = Utility.getPropertyValue(&quot;TwelveByTwentyFourFreeTime&quot;).split(&quot;#&quot;);</span>
<span class="nc bnc" id="L888" title="All 2 branches missed.">							for (String gameData : gameArr) {</span>
<span class="nc" id="L889">								String gameDataArr[] = gameData.split(&quot;~&quot;);</span>
<span class="nc bnc" id="L890" title="All 2 branches missed.">								if (Integer.parseInt(gameDataArr[0]) == kenoPurchaseBean.getGameId()) {</span>
<span class="nc" id="L891">									String timeArr[] = gameDataArr[1].split(&quot;&amp;&quot;);</span>
									// new
									// SimpleDateFormat(&quot;HH:mm:ss&quot;).parse(new
									// SimpleDateFormat(&quot;HH:mm:ss&quot;).format(new
									// SimpleDateFormat(&quot;yyyy-MM-dd
									// HH:mm:ss&quot;).parse(str)))
<span class="nc" id="L897">									long ptime = df.parse(df.format(pdf.parse(kenoPurchaseBean.getPurchaseTime())))</span>
											.getTime();
									// if(df.parse(kenoPurchaseBean.getPurchaseTime()).getTime()
									// &gt;= df.parse(timeArr[0]).getTime() &amp;&amp;
									// df.parse(kenoPurchaseBean.getPurchaseTime()).getTime()
									// &lt;= df.parse(timeArr[1]).getTime()) {
<span class="nc bnc" id="L903" title="All 4 branches missed.">									if (ptime &gt;= df.parse(timeArr[0]).getTime()</span>
											&amp;&amp; ptime &lt;= df.parse(timeArr[1]).getTime()) {
<span class="nc" id="L905">										isAvail = true;</span>
									}
								}
							}
						}
<span class="nc bnc" id="L910" title="All 2 branches missed.">						if (isAvail) {</span>
<span class="nc" id="L911">							int gameId = Util.getGameId(&quot;TwelveByTwentyFour&quot;);</span>

<span class="nc" id="L913">							KenoPurchaseBean drawGamePurchaseBean = new KenoPurchaseBean();</span>
<span class="nc" id="L914">							drawGamePurchaseBean.setGame_no(Util.getGameNumberFromGameId(gameId));</span>
<span class="nc" id="L915">							drawGamePurchaseBean.setGameId(gameId);</span>
<span class="nc" id="L916">							drawGamePurchaseBean.setGameDispName(Util.getGameDisplayName(gameId));</span>
<span class="nc" id="L917">							drawGamePurchaseBean.setBetAmountMultiple(new int[] { 1 });</span>
<span class="nc" id="L918">							drawGamePurchaseBean.setIsQuickPick(new int[] { 1 });</span>
<span class="nc" id="L919">							drawGamePurchaseBean.setPlayerData(new String[] { &quot;QP&quot; });</span>
<span class="nc" id="L920">							drawGamePurchaseBean.setPlayType(new String[] { &quot;Direct12&quot; });</span>
<span class="nc" id="L921">							drawGamePurchaseBean.setNoPicked(new String[] { &quot;12&quot; });</span>
<span class="nc" id="L922">							drawGamePurchaseBean.setNoOfPanel(1);</span>
<span class="nc" id="L923">							drawGamePurchaseBean.setPartyId(userBean.getUserOrgId());</span>
<span class="nc" id="L924">							drawGamePurchaseBean.setPartyType(userBean.getUserType());</span>
<span class="nc" id="L925">							drawGamePurchaseBean.setUserId(userBean.getUserId());</span>
<span class="nc" id="L926">							drawGamePurchaseBean.setNoOfDraws(1);</span>
<span class="nc" id="L927">							drawGamePurchaseBean.setIsAdvancedPlay(0);</span>
<span class="nc" id="L928">							drawGamePurchaseBean.setRefMerchantId(kenoPurchaseBean.getRefMerchantId());</span>
<span class="nc" id="L929">							drawGamePurchaseBean.setPurchaseChannel(kenoPurchaseBean.getPurchaseChannel());</span>
<span class="nc" id="L930">							drawGamePurchaseBean.setPlrMobileNumber(kenoPurchaseBean.getPlrMobileNumber());</span>
<span class="nc" id="L931">							drawGamePurchaseBean.setActionName(kenoPurchaseBean.getActionName());</span>
<span class="nc" id="L932">							drawGamePurchaseBean.setLastGameId(kenoPurchaseBean.getLastGameId()); // check</span>
																									// whether
																									// in
																									// use
<span class="nc" id="L936">							drawGamePurchaseBean.setDeviceType(kenoPurchaseBean.getDeviceType());</span>
<span class="nc" id="L937">							drawGamePurchaseBean.setBarcodeType(kenoPurchaseBean.getBarcodeType());</span>
<span class="nc" id="L938">							drawGamePurchaseBean.setUserMappingId(kenoPurchaseBean.getUserMappingId());</span>
<span class="nc" id="L939">							drawGamePurchaseBean.setDrawIdTableMap(kenoPurchaseBean.getDrawIdTableMap());</span>
<span class="nc" id="L940">							drawGamePurchaseBean.setLastSoldTicketNo(&quot;0&quot;);</span>
<span class="nc" id="L941">							drawGamePurchaseBean.setServiceId(kenoPurchaseBean.getServiceId());</span>
<span class="nc" id="L942">							drawGamePurchaseBean.setPromotkt(true);</span>

<span class="nc" id="L944">							KenoPurchaseBean purchaseBean = new TwelveByTwentyFourHelper()</span>
									.twelveByTwentyFourPurchaseTicket(userBean, drawGamePurchaseBean);

<span class="nc bnc" id="L947" title="All 2 branches missed.">							if (&quot;SUCCESS&quot;.equalsIgnoreCase(purchaseBean.getSaleStatus())) {</span>
<span class="nc" id="L948">								int returnValue = orgOnLineSaleCreditUpdation.drawTicketNPromoMappigUpdate(</span>
										promobean.getSchemeId(), kenoPurchaseBean.getGame_no(),
										kenoPurchaseBean.getTicket_no(), purchaseBean.getTicket_no());
<span class="nc bnc" id="L951" title="All 2 branches missed.">								if (returnValue == 0) {</span>
<span class="nc" id="L952">									cancelPromoTkts(userBean, purchaseBean);</span>
<span class="nc" id="L953">									kenoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L954">									return kenoPurchaseBean;</span>
								}
<span class="nc" id="L956">							} else {</span>
<span class="nc" id="L957">								kenoPurchaseBean.setPromoSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L958">								return kenoPurchaseBean;</span>
							}
<span class="nc" id="L960">							kenoPurchaseBean.setPromoPurchaseBean(purchaseBean);</span>
						}
<span class="nc" id="L962">					} catch (Exception e) {</span>
<span class="nc" id="L963">						e.printStackTrace();</span>
<span class="nc" id="L964">					}</span>
				}
				// kenoPurchaseBean.setRafflePurchaseBeanList(rafflePurchaseBeanList);
				// kenoPurchaseBean.setPromoPurchaseBean(rafflePurchaseBeanList);
			}
		}
<span class="fc" id="L970">		return kenoPurchaseBean;</span>
	}


	public KenoPurchaseBean kenoTwoPurchaseTicket(UserInfoBean userBean,
			KenoPurchaseBean kenoTwoPurchaseBean) throws LMSException {
<span class="fc" id="L976">		KenoRequestBean kenoRequestBean=null;</span>
<span class="fc" id="L977">		String status = null;</span>
<span class="fc" id="L978">		double dgeTicketPrice = 0.0;</span>
<span class="fc" id="L979">		double lmsTicketPrice = 0.0;</span>
<span class="fc" id="L980">		long transId=0;</span>
<span class="fc" id="L981">		Connection connection=null;</span>
<span class="fc" id="L982">		ServiceRequest serviceRequest=null;</span>
		try {
<span class="fc" id="L984">			connection=DBConnect.getConnection();</span>
<span class="fc" id="L985">			connection.setAutoCommit(false);</span>
<span class="pc bpc" id="L986" title="1 of 2 branches missed.">			if (checkDrawAvailability(kenoTwoPurchaseBean.getGameId())) {</span>
<span class="nc" id="L987">				kenoTwoPurchaseBean.setSaleStatus(&quot;NO_DRAWS&quot;);</span>
<span class="nc" id="L988">				return kenoTwoPurchaseBean;</span>
			}
<span class="fc" id="L990">			kenoTwoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
<span class="fc" id="L991">			dgeTicketPrice = prepareUnitPriceArrayAndCalculateDGETicketPrice(kenoTwoPurchaseBean);</span>
<span class="fc bfc" id="L992" title="All 2 branches covered.">			if (dgeTicketPrice &lt;= 0) {</span>
<span class="fc" id="L993">				kenoTwoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
<span class="fc" id="L994">				return kenoTwoPurchaseBean;</span>
			}
<span class="fc" id="L996">			kenoTwoPurchaseBean.setTotalPurchaseAmt(dgeTicketPrice);</span>
<span class="fc" id="L997">			lmsTicketPrice = CommonMethods.fmtToTwoDecimal(dgeTicketPrice);</span>
<span class="fc" id="L998">			checkLastPrintedTicketForTerminal(userBean, kenoTwoPurchaseBean, connection);</span>
<span class="fc" id="L999">			boolean isFraud = ResponsibleGaming.respGaming(userBean, &quot;DG_SALE&quot;,String.valueOf(lmsTicketPrice),connection);</span>
<span class="fc bfc" id="L1000" title="All 2 branches covered.">			if (!isFraud) {</span>
<span class="fc" id="L1001">				transId = orgOnLineSaleCreditUpdation.drawTcketSaleBalDeduction(userBean,kenoTwoPurchaseBean.getGameId(),lmsTicketPrice,</span>
						 kenoTwoPurchaseBean.getPlrMobileNumber(),connection);
				
<span class="fc bfc" id="L1004" title="All 2 branches covered.">				if(transId &lt;= 0){</span>
<span class="fc" id="L1005">					kenoTwoPurchaseBean.setSaleStatus(getStatusIfErrorInTransaction(status, transId));</span>
<span class="fc" id="L1006">					return kenoTwoPurchaseBean;</span>
				}
<span class="fc" id="L1008">				kenoTwoPurchaseBean.setRefTransId(transId + &quot;&quot;);</span>
<span class="fc" id="L1009">				connection.commit();</span>
			} else {
<span class="fc" id="L1011">				kenoTwoPurchaseBean.setSaleStatus(&quot;FRAUD&quot;);</span>
<span class="fc" id="L1012">				return kenoTwoPurchaseBean;</span>
			}
<span class="fc" id="L1014">			connection.commit();</span>
<span class="fc" id="L1015">         } catch (Exception e) {</span>
<span class="fc" id="L1016">			logger.error(e);</span>
<span class="fc" id="L1017">			throw new LMSException(LMSErrors.GENERAL_EXCEPTION_ERROR_CODE,LMSErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
		}finally{
<span class="pc" id="L1019">			DBConnect.closeCon(connection);</span>
<span class="fc" id="L1020">		}</span>
				
		try{
<span class="fc" id="L1023">			serviceRequest = createServiceRequest();</span>
<span class="fc" id="L1024">			serviceRequest.setServiceData(prepareKenoRequestBean(kenoTwoPurchaseBean));</span>
<span class="fc" id="L1025">			String dgeResponseString = delegate.getResponseString(serviceRequest);</span>
<span class="fc" id="L1026">			KenoResponseBean kenoResponseBean = new Gson().fromJson(dgeResponseString, KenoResponseBean.class);</span>
<span class="fc bfc" id="L1027" title="All 2 branches covered.">			if (kenoResponseBean.getIsSuccess()) {</span>
<span class="fc" id="L1028">				setKenoTwoDGEResponseData(kenoTwoPurchaseBean, kenoResponseBean);</span>
<span class="fc" id="L1029">				double fromDgeTicketPrice = kenoTwoPurchaseBean.getTotalPurchaseAmt();</span>
<span class="fc" id="L1030">				kenoTwoPurchaseBean.setTotalPurchaseAmt(lmsTicketPrice);</span>
<span class="fc" id="L1031">				connection=DBConnect.getConnection();</span>
<span class="fc" id="L1032">				connection.setAutoCommit(false);</span>
<span class="fc bfc" id="L1033" title="All 2 branches covered.">				if (fromDgeTicketPrice != dgeTicketPrice) {</span>
<span class="fc" id="L1034">					fromDgeTicketPrice = CommonMethods.roundDrawTktAmt(fromDgeTicketPrice);</span>
<span class="fc" id="L1035">					kenoTwoPurchaseBean.setTotalPurchaseAmt(fromDgeTicketPrice);</span>
<span class="fc" id="L1036">					transId = orgOnLineSaleCreditUpdation.drawTcketSaleBalDedUpdate(userBean,kenoTwoPurchaseBean.getGameId(),</span>
									fromDgeTicketPrice,lmsTicketPrice, transId,connection);
				}
<span class="fc" id="L1039">				int tickUpd = orgOnLineSaleCreditUpdation.drawTicketSaleTicketUpdate(transId,</span>
								kenoTwoPurchaseBean.getTicket_no(),kenoTwoPurchaseBean.getGameId(),
								userBean,kenoTwoPurchaseBean.getPurchaseChannel(),connection);
<span class="pc bpc" id="L1042" title="1 of 2 branches missed.">				if (tickUpd == 1) {</span>
<span class="fc" id="L1043">					doKenoTwoSaleAfterSuccesWork(userBean, kenoTwoPurchaseBean, connection);</span>
<span class="fc" id="L1044">					connection.commit();</span>
<span class="fc" id="L1045">					return kenoTwoPurchaseBean;</span>
				} else {
<span class="nc" id="L1047">					ifErrorOccurInKenoTwoTicketUpdation(userBean, kenoTwoPurchaseBean);</span>
<span class="nc" id="L1048">					return kenoTwoPurchaseBean;</span>
				}
			} else {
<span class="fc" id="L1051">				kenoTwoPurchaseBean.setSaleStatus(kenoResponseBean.getSaleStatus());</span>
<span class="fc" id="L1052">				failedKenoTwoTransactionIfFailedAtDGE(userBean, kenoTwoPurchaseBean, transId);</span>
			}
<span class="fc" id="L1054">		} catch (Exception e) {</span>
<span class="fc" id="L1055">			e.printStackTrace();</span>
<span class="fc" id="L1056">			failedKenoTwoTrasactionIfAnyExceptionOccur(userBean, kenoTwoPurchaseBean, transId);</span>
			
		}finally{
<span class="pc" id="L1059">			DBConnect.closeCon(connection);</span>
<span class="fc" id="L1060">		}</span>
<span class="fc" id="L1061">		return kenoTwoPurchaseBean;</span>
	}


	private ServiceRequest createServiceRequest() {
		ServiceRequest serviceRequest;
<span class="fc" id="L1067">		serviceRequest = new ServiceRequest();</span>
<span class="fc" id="L1068">		serviceRequest.setServiceName(ServiceName.KENOTWO_MGMT);</span>
<span class="fc" id="L1069">		serviceRequest.setServiceMethod(ServiceMethodName.KENOTWO_PURCHASE_TICKET);</span>
<span class="fc" id="L1070">		return serviceRequest;</span>
	}


	private void doKenoTwoSaleAfterSuccesWork(UserInfoBean userBean, KenoPurchaseBean kenoTwoPurchaseBean,
			Connection connection) throws SQLException {
<span class="fc" id="L1076">		ajaxHelper.getAvlblCreditAmt(userBean,connection);</span>
<span class="fc" id="L1077">		kenoTwoPurchaseBean.setAdvMsg(Util.getDGSaleAdvMessage(userBean.getUserOrgId(), kenoTwoPurchaseBean.getGameId()));</span>
<span class="fc" id="L1078">		kenoTwoPurchaseBean.setSaleStatus(&quot;SUCCESS&quot;);</span>
<span class="fc" id="L1079">	}</span>


	private void ifErrorOccurInKenoTwoTicketUpdation(UserInfoBean userBean, KenoPurchaseBean kenoTwoPurchaseBean)
			throws LMSException {
<span class="nc" id="L1084">		kenoTwoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L1085">		cancelTicket(kenoTwoPurchaseBean.getTicket_no()+ kenoTwoPurchaseBean.getReprintCount(),kenoTwoPurchaseBean.getPurchaseChannel(),</span>
				kenoTwoPurchaseBean.getDrawIdTableMap(),kenoTwoPurchaseBean.getGame_no(),kenoTwoPurchaseBean.getPartyId(),
				kenoTwoPurchaseBean.getPartyType(),kenoTwoPurchaseBean.getRefMerchantId(),
				userBean, kenoTwoPurchaseBean.getRefTransId());
<span class="nc" id="L1089">	}</span>


	private void setKenoTwoDGEResponseData(KenoPurchaseBean kenoTwoPurchaseBean, KenoResponseBean kenoResponseBean) {
<span class="fc" id="L1093">		kenoTwoPurchaseBean.setSaleStatus(kenoResponseBean.getSaleStatus());</span>
<span class="fc" id="L1094">		kenoTwoPurchaseBean.setTicket_no(kenoResponseBean.getTicketNo());</span>
<span class="fc" id="L1095">		kenoTwoPurchaseBean.setBarcodeCount(kenoResponseBean.getBarcodeCount());</span>
<span class="fc" id="L1096">		kenoTwoPurchaseBean.setNoOfDraws(kenoResponseBean.getNoOfDraws());</span>
<span class="fc" id="L1097">		kenoTwoPurchaseBean.setPurchaseTime(kenoResponseBean.getPurchaseTime());</span>
<span class="fc" id="L1098">		kenoTwoPurchaseBean.setReprintCount(kenoResponseBean.getReprintCount());</span>
<span class="fc" id="L1099">		kenoTwoPurchaseBean.setPlayerData(kenoResponseBean.getPlayerData());</span>
<span class="fc" id="L1100">		kenoTwoPurchaseBean.setTotalPurchaseAmt(kenoResponseBean.getTotalPurchaseAmt());</span>
<span class="fc" id="L1101">		kenoTwoPurchaseBean.setDrawDateTime(kenoResponseBean.getDrawDateTime());</span>
<span class="fc" id="L1102">	}</span>


	private void failedKenoTwoTrasactionIfAnyExceptionOccur(UserInfoBean userBean, KenoPurchaseBean kenoTwoPurchaseBean,
			long transId) {
<span class="pc bpc" id="L1107" title="1 of 2 branches missed.">		if(kenoTwoPurchaseBean.getSaleStatus() == null){</span>
<span class="fc" id="L1108">			kenoTwoPurchaseBean.setSaleStatus(&quot;FAILED&quot;); // Error</span>
<span class="fc" id="L1109">			orgOnLineSaleCreditUpdation.drawTicketSaleRefund(</span>
					userBean, kenoTwoPurchaseBean.getGameId(),
					&quot;FAILED&quot;, transId);
		}else{
<span class="nc" id="L1113">			orgOnLineSaleCreditUpdation.drawTicketSaleRefund(</span>
					userBean, kenoTwoPurchaseBean.getGameId(),
					&quot;FAILED&quot;, transId);
		}
<span class="fc" id="L1117">	}</span>


	private void failedKenoTwoTransactionIfFailedAtDGE(UserInfoBean userBean, KenoPurchaseBean kenoTwoPurchaseBean,
			long transId) {
<span class="pc bpc" id="L1122" title="1 of 2 branches missed.">		if(kenoTwoPurchaseBean.getSaleStatus() == null){</span>
<span class="fc" id="L1123">			kenoTwoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);// Error</span>
<span class="fc" id="L1124">			orgOnLineSaleCreditUpdation.drawTicketSaleRefund(</span>
					userBean, kenoTwoPurchaseBean.getGameId(),
					&quot;FAILED&quot;, transId);
<span class="nc bnc" id="L1127" title="All 2 branches missed.">		}else if(&quot;ERROR_TICKET_LIMIT&quot;.equalsIgnoreCase(kenoTwoPurchaseBean.getSaleStatus())){</span>
<span class="nc" id="L1128">			orgOnLineSaleCreditUpdation.drawTicketSaleRefund(</span>
					userBean, kenoTwoPurchaseBean.getGameId(),
					&quot;FAILED&quot;, transId);							
		}else{
<span class="nc" id="L1132">			orgOnLineSaleCreditUpdation.drawTicketSaleRefund(</span>
					userBean, kenoTwoPurchaseBean.getGameId(),
					&quot;FAILED&quot;, transId);
		}
<span class="fc" id="L1136">	}</span>


	private KenoRequestBean prepareKenoRequestBean(KenoPurchaseBean kenoTwoPurchaseBean) {
<span class="fc" id="L1140">		KenoRequestBean	kenoRequestBean = new KenoRequestBeanBuilder().setBetAmountMultiple(kenoTwoPurchaseBean.getBetAmountMultiple()).setDrawIdTableMap(kenoTwoPurchaseBean.getDrawIdTableMap()).setDrawDateTime(kenoTwoPurchaseBean.getDrawDateTime())</span>
				.setGame_no(kenoTwoPurchaseBean.getGame_no()).setGameId(kenoTwoPurchaseBean.getGameId()).setIsAdvancedPlay(kenoTwoPurchaseBean.getIsAdvancedPlay()).setIsQuickPick(kenoTwoPurchaseBean.getIsQuickPick()).setNoOfDraws(kenoTwoPurchaseBean.getNoOfDraws())
				.setPartyId(kenoTwoPurchaseBean.getPartyId()).setPartyType(kenoTwoPurchaseBean.getPartyType()).setPlayType(kenoTwoPurchaseBean.getPlayerData()).setPlayType(kenoTwoPurchaseBean.getPlayType()).setPurchaseChannel(kenoTwoPurchaseBean.getPurchaseChannel())
				.setRefMerchantId(kenoTwoPurchaseBean.getRefMerchantId()).setRefTransId(kenoTwoPurchaseBean.getRefTransId()).setUserId(kenoTwoPurchaseBean.getUserId()).setUserMappingId(kenoTwoPurchaseBean.getUserMappingId()).setServiceId(kenoTwoPurchaseBean.getServiceId())
				.setPromotkt(kenoTwoPurchaseBean.isPromotkt()).setUnitPrice(kenoTwoPurchaseBean.getUnitPrice()).setTotalPurchaseAmt(kenoTwoPurchaseBean.getTotalPurchaseAmt()).setQPPreGenerated(kenoTwoPurchaseBean.getQPPreGenerated()).setPlayerData(kenoTwoPurchaseBean.getPlayerData()).setNoPicked(kenoTwoPurchaseBean.getNoPicked())
				.preapreKenoRequestBean();
<span class="fc" id="L1146">		return kenoRequestBean;</span>
	}


	private String getStatusIfErrorInTransaction(String status, long transId) {
<span class="fc bfc" id="L1151" title="All 2 branches covered.">		if (transId == -1) {</span>
<span class="fc" id="L1152">			status = &quot;AGT_INS_BAL&quot;;// Agent has insufficient balance</span>
<span class="fc bfc" id="L1153" title="All 2 branches covered.">		} else if (transId == -2) {</span>
<span class="fc" id="L1154">			status = &quot;FAILED&quot;;// Error LMS</span>
<span class="pc bpc" id="L1155" title="1 of 2 branches missed.">		} else if (transId == 0) {</span>
<span class="fc" id="L1156">			status = &quot;RET_INS_BAL&quot;;// Retailer has insufficient  Balance</span>
		}
<span class="fc" id="L1158">		return status;</span>
	}


	private void checkLastPrintedTicketForTerminal(UserInfoBean userBean, KenoPurchaseBean kenoTwoPurchaseBean,
			Connection connection) throws LMSException {
<span class="pc bpc" id="L1164" title="1 of 2 branches missed.">		if(&quot;TERMINAL&quot;.equals(kenoTwoPurchaseBean.getDeviceType())) {</span>
<span class="nc" id="L1165">			int autoCancelHoldDays=Integer.parseInt(Utility.getPropertyValue(&quot;AUTO_CANCEL_CLOSER_DAYS&quot;)); </span>
<span class="nc" id="L1166">			checkLastPrintedTicketStatusAndUpdate(userBean,Long.parseLong(kenoTwoPurchaseBean.getLastSoldTicketNo()),kenoTwoPurchaseBean.getDeviceType(),kenoTwoPurchaseBean.getRefMerchantId(),autoCancelHoldDays,kenoTwoPurchaseBean.getActionName(), kenoTwoPurchaseBean.getLastGameId(),connection);</span>
		}
<span class="fc" id="L1168">	}</span>


	private boolean checkDrawAvailability(int gameId) {
<span class="pc bpc" id="L1172" title="2 of 4 branches missed.">		return isDrawAvailable(gameId) || chkFreezeTimeSale(gameId);</span>
	}


	private double prepareUnitPriceArrayAndCalculateDGETicketPrice(KenoPurchaseBean kenoTwoPurchaseBean) {
<span class="fc" id="L1177">		double dgeTicketPrice=0.0;</span>
<span class="fc" id="L1178">		int noOfPanel = kenoTwoPurchaseBean.getNoOfPanel();</span>
<span class="fc" id="L1179">		int noOfLines[] = new int[noOfPanel];</span>
<span class="fc" id="L1180">		int betAmtMulArr[] = kenoTwoPurchaseBean.getBetAmountMultiple();</span>
<span class="fc" id="L1181">		double unitPriceArr[] = new double[noOfPanel];</span>
<span class="fc bfc" id="L1182" title="All 2 branches covered.">		for (int i = 0; i &lt; noOfPanel; i++) {</span>
<span class="fc" id="L1183">			preapareNoOfLinesArray(kenoTwoPurchaseBean, noOfLines, i);</span>
<span class="fc" id="L1184">			unitPriceArr[i] = Util.getUnitPrice(kenoTwoPurchaseBean.getGameId(), kenoTwoPurchaseBean.getPlayType()[i]);</span>
<span class="fc" id="L1185">			dgeTicketPrice += noOfLines[i] * unitPriceArr[i]* kenoTwoPurchaseBean.getNoOfDraws() * betAmtMulArr[i];</span>
		}
<span class="fc" id="L1187">		kenoTwoPurchaseBean.setUnitPrice(unitPriceArr);</span>
<span class="fc" id="L1188">		kenoTwoPurchaseBean.setNoOfLines(noOfLines);</span>
<span class="fc" id="L1189">		return dgeTicketPrice;</span>
	}


	private void preapareNoOfLinesArray(KenoPurchaseBean kenoPurchaseBean, int[] noOfLines, int i) {
<span class="fc" id="L1194">		String playType =  kenoPurchaseBean.getPlayType()[i];</span>
<span class="fc" id="L1195">		String[] noPick = kenoPurchaseBean.getNoPicked()[i].split(&quot;,&quot;);</span>
<span class="fc" id="L1196">		int[] n = new int[noPick.length];</span>
<span class="fc bfc" id="L1197" title="All 2 branches covered.">		for (int j = 0; j &lt; noPick.length; j++) {</span>
<span class="fc" id="L1198">			n[j] = Integer.parseInt(noPick[j]);</span>
		}
<span class="fc bfc" id="L1200" title="All 2 branches covered.">		if (playType.contains(&quot;Direct&quot;)) {</span>
<span class="fc" id="L1201">			noOfLines[i] = 1;</span>
<span class="pc bpc" id="L1202" title="1 of 2 branches missed.">		} else if (playType.equalsIgnoreCase(&quot;perm2&quot;)) {</span>
<span class="nc" id="L1203">			noOfLines[i] = n[0] * (n[0] - 1) / 2;</span>
<span class="pc bpc" id="L1204" title="1 of 2 branches missed.">		} else if (playType.equalsIgnoreCase(&quot;perm3&quot;)) {</span>
<span class="nc" id="L1205">			noOfLines[i] = n[0] * (n[0] - 1) * (n[0] - 2) / 6;</span>
<span class="pc bpc" id="L1206" title="1 of 2 branches missed.">		} else if (playType.equalsIgnoreCase(&quot;Banker1AgainstAll&quot;)) {</span>
<span class="nc" id="L1207">			noOfLines[i] = 89;</span>
<span class="pc bpc" id="L1208" title="1 of 2 branches missed.">		} else if (playType.equalsIgnoreCase(&quot;banker&quot;)) {</span>
<span class="nc" id="L1209">			noOfLines[i] = n[0] * n[1];</span>
<span class="pc bpc" id="L1210" title="1 of 2 branches missed.">		} else if(playType.equalsIgnoreCase(&quot;Perm1&quot;)){</span>
<span class="fc" id="L1211">			noOfLines[i] = n[0];</span>
		}
<span class="fc" id="L1213">	}</span>

	public KenoPurchaseBean superTwoPurchaseTicket(UserInfoBean userBean, KenoPurchaseBean superTwoPurchaseBean)
			throws LMSException, SQLException {

<span class="nc bnc" id="L1218" title="All 2 branches missed.">		if (checkDrawAvailability(superTwoPurchaseBean.getGameId())) {</span>
<span class="nc" id="L1219">			superTwoPurchaseBean.setSaleStatus(&quot;NO_DRAWS&quot;);</span>
<span class="nc" id="L1220">			return superTwoPurchaseBean;</span>
		}

<span class="nc" id="L1223">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L1224">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L1225">		sReq.setServiceName(ServiceName.SUPERTWO);</span>
<span class="nc" id="L1226">		sReq.setServiceMethod(ServiceMethodName.SUPERTWO_PURCHASE_TICKET);</span>
<span class="nc" id="L1227">		sReq.setServiceData(superTwoPurchaseBean);</span>
<span class="nc" id="L1228">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L1229">		String status = &quot;&quot;;</span>
<span class="nc" id="L1230">		double oldTotalPurchaseAmt = 0.0;</span>
<span class="nc" id="L1231">		double modifiedTotalPurchaseAmt = 0.0;</span>

<span class="nc" id="L1233">		superTwoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L1234">		long balDed = 0;</span>
<span class="nc" id="L1235">		double totPurAmt = 0.0;</span>
<span class="nc" id="L1236">		Connection con = null;</span>
		try {
<span class="nc" id="L1238">			int noOfPanel = superTwoPurchaseBean.getNoOfPanel();</span>
<span class="nc" id="L1239">			String playTypeArr[] = superTwoPurchaseBean.getPlayType();</span>
<span class="nc" id="L1240">			String[] noPickStr = superTwoPurchaseBean.getNoPicked();</span>
<span class="nc" id="L1241">			int noOfLines[] = new int[noOfPanel];</span>
<span class="nc" id="L1242">			int betAmtMulArr[] = superTwoPurchaseBean.getBetAmountMultiple();</span>
<span class="nc" id="L1243">			double unitPriceArr[] = new double[noOfPanel];</span>
<span class="nc bnc" id="L1244" title="All 2 branches missed.">			for (int i = 0; i &lt; noOfPanel; i++) {</span>
<span class="nc" id="L1245">				int n = Integer.parseInt(noPickStr[i]);</span>
<span class="nc bnc" id="L1246" title="All 2 branches missed.">				if (&quot;Perm-2 Position&quot;.equalsIgnoreCase(playTypeArr[i])) {</span>
<span class="nc" id="L1247">					noOfLines[i] = n * n;</span>
<span class="nc bnc" id="L1248" title="All 2 branches missed.">				} else if (&quot;Perm-2 Regular&quot;.equalsIgnoreCase(playTypeArr[i])) {</span>
<span class="nc" id="L1249">					noOfLines[i] = n * (n - 1) / 2 + n;</span>
<span class="nc bnc" id="L1250" title="All 2 branches missed.">				} else if (&quot;Perm-2&quot;.equalsIgnoreCase(playTypeArr[i])) {</span>
<span class="nc" id="L1251">					noOfLines[i] = n * (n - 1) / 2;</span>
				} else {
<span class="nc" id="L1253">					noOfLines[i] = 1;// in case of other bet types like Dir-2</span>
										// and Banker
				}
<span class="nc" id="L1256">				unitPriceArr[i] = Util.getUnitPrice(superTwoPurchaseBean.getGameId(), playTypeArr[i]);</span>
<span class="nc" id="L1257">				logger.debug(&quot;----unitPrice--&quot; + unitPriceArr[i]);</span>
<span class="nc" id="L1258">				logger.debug(&quot;----playTypeArr--&quot; + playTypeArr[i]);</span>
<span class="nc" id="L1259">				totPurAmt += noOfLines[i] * unitPriceArr[i] * superTwoPurchaseBean.getNoOfDraws() * betAmtMulArr[i];</span>
			}

<span class="nc" id="L1262">			superTwoPurchaseBean.setUnitPrice(unitPriceArr);</span>

<span class="nc" id="L1264">			superTwoPurchaseBean.setNoOfLines(noOfLines);</span>

<span class="nc" id="L1266">			logger.debug(&quot;!totPurAmt&gt;&gt;&gt;superTwo&quot; + totPurAmt);</span>

<span class="nc bnc" id="L1268" title="All 2 branches missed.">			if (totPurAmt &lt;= 0) {</span>
<span class="nc" id="L1269">				superTwoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);// Error Draw</span>
<span class="nc" id="L1270">				return superTwoPurchaseBean;</span>
			}
<span class="nc" id="L1272">			superTwoPurchaseBean.setTotalPurchaseAmt(totPurAmt);</span>

<span class="nc" id="L1274">			con = getConnectionObject();</span>

<span class="nc bnc" id="L1276" title="All 2 branches missed.">			if (superTwoPurchaseBean.getLastSoldTicketNo() != null) {</span>
<span class="nc bnc" id="L1277" title="All 2 branches missed.">				if (!&quot;0&quot;.equalsIgnoreCase(superTwoPurchaseBean.getLastSoldTicketNo())) {</span>
<span class="nc" id="L1278">					Util.insertLastSoldTicketTeminal(superTwoPurchaseBean.getUserId(),</span>
							superTwoPurchaseBean.getLastSoldTicketNo(), superTwoPurchaseBean.getGameId(), con);
				}
			}
<span class="nc" id="L1282">			logger.debug(&quot;Inside SuperTwo FE1*******&quot;);</span>
			// rg calling
<span class="nc" id="L1284">			boolean isFraud = ResponsibleGaming.respGaming(userBean, &quot;DG_SALE&quot;, totPurAmt + &quot;&quot;, con);</span>
<span class="nc bnc" id="L1285" title="All 2 branches missed.">			if (!isFraud) {</span>

<span class="nc" id="L1287">				balDed = orgOnLineSaleCreditUpdation.drawTcketSaleBalDeduction(userBean,</span>
						superTwoPurchaseBean.getGameId(), superTwoPurchaseBean.getTotalPurchaseAmt(),
						superTwoPurchaseBean.getPlrMobileNumber(), con);
<span class="nc" id="L1290">				oldTotalPurchaseAmt = superTwoPurchaseBean.getTotalPurchaseAmt();</span>
<span class="nc" id="L1291">				logger.debug(&quot;Total Purchase Amt inside DrawGameRPOSHelper Just Before  getting Success :&quot;</span>
						+ oldTotalPurchaseAmt);
<span class="nc" id="L1293">				con.commit();</span>
			} else {
<span class="nc" id="L1295">				logger.debug(&quot;Responsing Gaming not allowed to sale&quot;);</span>
<span class="nc" id="L1296">				superTwoPurchaseBean.setSaleStatus(&quot;FRAUD&quot;);</span>
<span class="nc" id="L1297">				return superTwoPurchaseBean;</span>
			}
<span class="nc" id="L1299">		} catch (SQLException se) {</span>
<span class="nc" id="L1300">			se.printStackTrace();</span>
<span class="nc" id="L1301">		} catch (Exception e) {</span>
<span class="nc" id="L1302">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L1304">			DBConnect.closeCon(con);</span>
<span class="nc" id="L1305">		}</span>

		try {
<span class="nc bnc" id="L1308" title="All 2 branches missed.">			if (balDed &gt; 0) {</span>
<span class="nc" id="L1309">				logger.debug(&quot;in superTwo if----------------&quot;);</span>
<span class="nc" id="L1310">				superTwoPurchaseBean.setRefTransId(balDed + &quot;&quot;);</span>
<span class="nc" id="L1311">				sRes = delegate.getResponse(sReq);</span>

<span class="nc bnc" id="L1313" title="All 2 branches missed.">				if (sRes.getIsSuccess()) {</span>
<span class="nc" id="L1314">					superTwoPurchaseBean = (KenoPurchaseBean) sRes.getResponseData();</span>
<span class="nc" id="L1315">					modifiedTotalPurchaseAmt = superTwoPurchaseBean.getTotalPurchaseAmt();</span>
<span class="nc" id="L1316">					logger.debug(&quot;Total Purchase Amt inside DrawGameRPOSHelper After getting Success :&quot;</span>
							+ modifiedTotalPurchaseAmt);
<span class="nc" id="L1318">					con = getConnectionObject();</span>
<span class="nc" id="L1319">					modifiedTotalPurchaseAmt = CommonMethods.roundDrawTktAmt(modifiedTotalPurchaseAmt);</span>
<span class="nc bnc" id="L1320" title="All 2 branches missed.">					if (oldTotalPurchaseAmt != modifiedTotalPurchaseAmt) {</span>
<span class="nc" id="L1321">						superTwoPurchaseBean.setTotalPurchaseAmt(modifiedTotalPurchaseAmt);</span>
<span class="nc" id="L1322">						balDed = orgOnLineSaleCreditUpdation.drawTcketSaleBalDedUpdate(userBean,</span>
								superTwoPurchaseBean.getGameId(), modifiedTotalPurchaseAmt, oldTotalPurchaseAmt, balDed,
								con);

					}

<span class="nc" id="L1328">					int tickUpd = orgOnLineSaleCreditUpdation.drawTicketSaleTicketUpdate(balDed,</span>
							superTwoPurchaseBean.getTicket_no(), superTwoPurchaseBean.getGameId(), userBean,
							superTwoPurchaseBean.getPurchaseChannel(), con);

<span class="nc bnc" id="L1332" title="All 2 branches missed.">					if (tickUpd == 1) {</span>
						// superTwoPurchaseBean.setAdvMsg(Util.getAdvMessage(userBean.getUserOrgId(),
						// superTwoPurchaseBean.getGame_no(), &quot;PLAYER&quot;, &quot;SALE&quot;,
						// &quot;DG&quot;));
<span class="nc" id="L1336">						superTwoPurchaseBean.setAdvMsg(</span>
								Util.getDGSaleAdvMessage(userBean.getUserOrgId(), superTwoPurchaseBean.getGameId()));
<span class="nc" id="L1338">						AjaxRequestHelper ajxHelper = new AjaxRequestHelper();</span>
<span class="nc" id="L1339">						ajxHelper.getAvlblCreditAmt(userBean, con);</span>
<span class="nc" id="L1340">						status = &quot;SUCCESS&quot;;</span>
<span class="nc" id="L1341">						superTwoPurchaseBean.setSaleStatus(status);</span>
<span class="nc bnc" id="L1342" title="All 2 branches missed.">						if (!superTwoPurchaseBean.getBarcodeType().equals(&quot;applet&quot;)) {</span>
<span class="nc" id="L1343">							IDBarcode.getBarcode(</span>
									superTwoPurchaseBean.getTicket_no() + superTwoPurchaseBean.getReprintCount());
						}
<span class="nc" id="L1346">						con.commit();</span>
<span class="nc" id="L1347">						return superTwoPurchaseBean;</span>
					} else {
<span class="nc" id="L1349">						status = &quot;FAILED&quot;;</span>
<span class="nc" id="L1350">						superTwoPurchaseBean.setSaleStatus(status);</span>
						// Code for cancelling the Ticket to be send to Draw
						// Game Engine
<span class="nc" id="L1353">						cancelTicket(superTwoPurchaseBean.getTicket_no() + superTwoPurchaseBean.getReprintCount(),</span>
								superTwoPurchaseBean.getPurchaseChannel(), superTwoPurchaseBean.getDrawIdTableMap(),
								superTwoPurchaseBean.getGame_no(), superTwoPurchaseBean.getPartyId(),
								superTwoPurchaseBean.getPartyType(), superTwoPurchaseBean.getRefMerchantId(), userBean,
								superTwoPurchaseBean.getRefTransId());

<span class="nc" id="L1359">						return superTwoPurchaseBean;</span>
					}
				} else {
<span class="nc" id="L1362">					superTwoPurchaseBean = (KenoPurchaseBean) sRes.getResponseData();</span>
<span class="nc bnc" id="L1363" title="All 2 branches missed.">					if (superTwoPurchaseBean.getSaleStatus() == null) {</span>
<span class="nc" id="L1364">						superTwoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);// Error</span>
<span class="nc" id="L1365">						orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, superTwoPurchaseBean.getGame_no(),</span>
								&quot;FAILED&quot;, balDed);
<span class="nc" id="L1367">						return superTwoPurchaseBean;</span>
<span class="nc bnc" id="L1368" title="All 2 branches missed.">					} else if (&quot;ERROR_TICKET_LIMIT&quot;.equalsIgnoreCase(superTwoPurchaseBean.getSaleStatus())) {</span>
<span class="nc" id="L1369">						orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, superTwoPurchaseBean.getGame_no(),</span>
								&quot;FAILED&quot;, balDed);
<span class="nc" id="L1371">						return superTwoPurchaseBean;</span>
					} else {
<span class="nc" id="L1373">						orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, superTwoPurchaseBean.getGame_no(),</span>
								&quot;FAILED&quot;, balDed);
<span class="nc" id="L1375">						return superTwoPurchaseBean;</span>
					}
				}
			} else {

<span class="nc" id="L1380">				status = getStatusIfErrorInTransaction(status, balDed);</span>
<span class="nc" id="L1381">				superTwoPurchaseBean.setSaleStatus(status);</span>
<span class="nc" id="L1382">				return superTwoPurchaseBean;</span>
			}
<span class="nc" id="L1384">		} catch (Exception e) {</span>
			// TODO: handle exception
		} finally {
<span class="nc" id="L1387">			DBConnect.closeCon(con);</span>
<span class="nc" id="L1388">		}</span>
<span class="nc" id="L1389">		return superTwoPurchaseBean;</span>
	}

	// added for new pwt process for zimlottob two

	public LottoPurchaseBean commonPurchseProcess(UserInfoBean userBean, LottoPurchaseBean lottoPurchaseBean)
			throws Exception {

<span class="nc" id="L1397">		lottoPurchaseBean.setPromotkt(false);</span>
<span class="nc" id="L1398">		lottoPurchaseBean = zimLottoTwoPurchaseTicket(userBean, lottoPurchaseBean);</span>
<span class="nc" id="L1399">		String saleStatus = lottoPurchaseBean.getSaleStatus();</span>
<span class="nc bnc" id="L1400" title="All 2 branches missed.">		if (&quot;SUCCESS&quot;.equalsIgnoreCase(saleStatus)) {</span>
<span class="nc" id="L1401">			lottoPurchaseBean = commonPromoPurchaseProcess(lottoPurchaseBean, userBean);</span>
			// FortunePurchaseBean fortunePurchseben=
			// kenoPurchaseBean.getFortunePurchaseBean();
<span class="nc bnc" id="L1404" title="All 2 branches missed.">			if (&quot;SUCCESS&quot;.equalsIgnoreCase(lottoPurchaseBean.getPromoSaleStatus())) {</span>
<span class="nc" id="L1405">				return lottoPurchaseBean;</span>
			} else {
<span class="nc" id="L1407">				cancelTicket(lottoPurchaseBean.getTicket_no() + lottoPurchaseBean.getReprintCount(),</span>
						lottoPurchaseBean.getPurchaseChannel(), lottoPurchaseBean.getDrawIdTableMap(),
						lottoPurchaseBean.getGame_no(), lottoPurchaseBean.getPartyId(),
						lottoPurchaseBean.getPartyType(), lottoPurchaseBean.getRefMerchantId(), userBean,
						lottoPurchaseBean.getRefTransId());
			}
		}
<span class="nc" id="L1414">		return lottoPurchaseBean;</span>

	}

	// added for new pwt process

	public KenoPurchaseBean commonPurchseProcess(UserInfoBean userBean, KenoPurchaseBean kenoPurchaseBean)
			throws LMSException, SQLException {

<span class="nc" id="L1423">		kenoPurchaseBean.setPromotkt(false);</span>
<span class="nc" id="L1424">		kenoPurchaseBean = kenoPurchaseTicket(userBean, kenoPurchaseBean);</span>
<span class="nc" id="L1425">		String saleStatus = kenoPurchaseBean.getSaleStatus();</span>
<span class="nc bnc" id="L1426" title="All 2 branches missed.">		if (&quot;SUCCESS&quot;.equalsIgnoreCase(saleStatus)) {</span>
<span class="nc" id="L1427">			kenoPurchaseBean = commonPromoPurchaseProcess(kenoPurchaseBean, userBean);</span>
			// FortunePurchaseBean fortunePurchseben=
			// kenoPurchaseBean.getFortunePurchaseBean();
<span class="nc bnc" id="L1430" title="All 2 branches missed.">			if (&quot;SUCCESS&quot;.equalsIgnoreCase(kenoPurchaseBean.getPromoSaleStatus())) {</span>
<span class="nc" id="L1431">				return kenoPurchaseBean;</span>
			} else {
<span class="nc" id="L1433">				cancelTicket(kenoPurchaseBean.getTicket_no() + kenoPurchaseBean.getReprintCount(),</span>
						kenoPurchaseBean.getPurchaseChannel(), kenoPurchaseBean.getDrawIdTableMap(),
						kenoPurchaseBean.getGame_no(), kenoPurchaseBean.getPartyId(), kenoPurchaseBean.getPartyType(),
						kenoPurchaseBean.getRefMerchantId(), userBean, kenoPurchaseBean.getRefTransId());
			}
		}
<span class="nc" id="L1439">		return kenoPurchaseBean;</span>

	}

	public KenoPurchaseBean commonPurchseProcessKenoTwo(UserInfoBean userBean,
			KenoPurchaseBean kenoPurchaseBean) throws LMSException  {
		try {
<span class="fc" id="L1446">			kenoPurchaseBean.setPromotkt(false);</span>
<span class="fc" id="L1447">			kenoPurchaseBean = kenoTwoPurchaseTicket(userBean, kenoPurchaseBean);</span>
<span class="fc bfc" id="L1448" title="All 2 branches covered.">			if (&quot;SUCCESS&quot;.equalsIgnoreCase( kenoPurchaseBean.getSaleStatus())) {</span>
<span class="fc" id="L1449">				kenoPurchaseBean = commonPromoPurchaseProcess(kenoPurchaseBean,userBean);</span>
<span class="pc bpc" id="L1450" title="1 of 2 branches missed.">				if (!&quot;SUCCESS&quot;.equalsIgnoreCase(kenoPurchaseBean.getPromoSaleStatus())) {</span>
<span class="nc" id="L1451">					cancelTicket(kenoPurchaseBean.getTicket_no()+ kenoPurchaseBean.getReprintCount(), kenoPurchaseBean.getPurchaseChannel(), kenoPurchaseBean</span>
							.getDrawIdTableMap(), kenoPurchaseBean.getGame_no(),kenoPurchaseBean.getPartyId(), kenoPurchaseBean.getPartyType(), kenoPurchaseBean.getRefMerchantId(), userBean, kenoPurchaseBean
									.getRefTransId());
				}
			}
<span class="fc" id="L1456">		} catch (LMSException e) {</span>
<span class="fc" id="L1457">			throw e;</span>
<span class="fc" id="L1458">		}catch (Exception e) {</span>
<span class="fc" id="L1459">			throw new LMSException(LMSErrors.GENERAL_EXCEPTION_ERROR_CODE,LMSErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="fc" id="L1460">		}</span>

<span class="fc" id="L1462">		return kenoPurchaseBean;</span>

	}

	public KenoPurchaseBean commonPurchseProcessSuperTwo(UserInfoBean userBean, KenoPurchaseBean superTwoPurchaseBean)
			throws Exception {

<span class="nc" id="L1469">		superTwoPurchaseBean.setPromotkt(false);</span>
<span class="nc" id="L1470">		superTwoPurchaseBean = superTwoPurchaseTicket(userBean, superTwoPurchaseBean);</span>
<span class="nc" id="L1471">		String saleStatus = superTwoPurchaseBean.getSaleStatus();</span>
<span class="nc bnc" id="L1472" title="All 2 branches missed.">		if (&quot;SUCCESS&quot;.equalsIgnoreCase(saleStatus)) {</span>
<span class="nc" id="L1473">			superTwoPurchaseBean = commonPromoPurchaseProcess(superTwoPurchaseBean, userBean);</span>
			// FortunePurchaseBean fortunePurchseben=
			// superTwoPurchaseBean.getFortunePurchaseBean();
<span class="nc bnc" id="L1476" title="All 2 branches missed.">			if (&quot;SUCCESS&quot;.equalsIgnoreCase(superTwoPurchaseBean.getPromoSaleStatus())) {</span>
<span class="nc" id="L1477">				return superTwoPurchaseBean;</span>
			} else {
<span class="nc" id="L1479">				cancelTicket(superTwoPurchaseBean.getTicket_no() + superTwoPurchaseBean.getReprintCount(),</span>
						superTwoPurchaseBean.getPurchaseChannel(), superTwoPurchaseBean.getDrawIdTableMap(),
						superTwoPurchaseBean.getGame_no(), superTwoPurchaseBean.getPartyId(),
						superTwoPurchaseBean.getPartyType(), superTwoPurchaseBean.getRefMerchantId(), userBean,
						superTwoPurchaseBean.getRefTransId());
			}
		}
<span class="nc" id="L1486">		return superTwoPurchaseBean;</span>

	}

	// Fast Lotto Data Validation
	public boolean fastLottoDataValidation(LottoPurchaseBean lottoPurchaseBean) {
<span class="nc" id="L1492">		int noOfDraws = lottoPurchaseBean.getNoOfDraws();</span>
<span class="nc" id="L1493">		String[] picknumbers = lottoPurchaseBean.getPicknumbers();</span>
		Set&lt;Integer&gt; picknumSet;
		String pickNum[];
<span class="nc" id="L1496">		int noOfPanels = picknumbers.length;</span>
<span class="nc" id="L1497">		logger.debug(&quot;no of Panels: &quot; + noOfPanels);</span>
<span class="nc bnc" id="L1498" title="All 4 branches missed.">		if (noOfDraws &gt; 0 &amp;&amp; noOfPanels &gt; 0) {</span>
<span class="nc bnc" id="L1499" title="All 2 branches missed.">			for (int i = 0; i &lt; noOfPanels; i++) {</span>
<span class="nc bnc" id="L1500" title="All 2 branches missed.">				if (picknumbers[i].equalsIgnoreCase(&quot;QP&quot;)) {</span>
<span class="nc" id="L1501">					logger.debug(&quot;quick pick Selected&quot;);</span>

				} else {
<span class="nc" id="L1504">					logger.debug(&quot;not quick pick&quot;);</span>
<span class="nc" id="L1505">					logger.debug(&quot;Player picked Data:&quot; + picknumbers[i]);</span>
<span class="nc" id="L1506">					pickNum = picknumbers[i].split(&quot;,&quot;);</span>
<span class="nc" id="L1507">					picknumSet = new HashSet&lt;Integer&gt;();</span>
<span class="nc bnc" id="L1508" title="All 2 branches missed.">					for (String element : pickNum) {</span>
<span class="nc" id="L1509">						picknumSet.add(Integer.parseInt(element));</span>
					}
<span class="nc bnc" id="L1511" title="All 4 branches missed.">					if (pickNum.length != picknumSet.size()</span>
							|| pickNum.length &gt; com.skilrock.lms.dge.gameconstants.FastlottoConstants.MAX_PLAYER_PICKED) {
<span class="nc" id="L1513">						logger.debug(&quot;picNum.Length: &quot; + pickNum.length + &quot;Set length:  &quot; + picknumSet.size());</span>
<span class="nc" id="L1514">						return false;</span>
					}
				}
			}
<span class="nc" id="L1518">			return true;</span>
		}
<span class="nc" id="L1520">		return false;</span>
	}

	public LottoPurchaseBean fastLottoPurchaseTicket(UserInfoBean userBean, LottoPurchaseBean lottoPurchaseBean)
			throws Exception {

<span class="nc bnc" id="L1526" title="All 4 branches missed.">		if (isDrawAvailable(lottoPurchaseBean.getGame_no()) || chkFreezeTimeSale(lottoPurchaseBean.getGame_no())) {</span>
<span class="nc" id="L1527">			lottoPurchaseBean.setSaleStatus(&quot;NO_DRAWS&quot;);</span>
<span class="nc" id="L1528">			return lottoPurchaseBean;</span>
		}
<span class="nc" id="L1530">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L1531">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L1532">		sReq.setServiceName(ServiceName.FASTLOTTO);</span>
<span class="nc" id="L1533">		sReq.setServiceMethod(ServiceMethodName.FASTLOTTO_PURCHASE_TICKET);</span>
<span class="nc" id="L1534">		sReq.setServiceData(lottoPurchaseBean);</span>
<span class="nc" id="L1535">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L1536">		double oldTotalPurchaseAmt = 0.0;</span>
<span class="nc" id="L1537">		double modifiedTotalPurchaseAmt = 0.0;</span>
<span class="nc" id="L1538">		String status = &quot;&quot;;</span>
<span class="nc" id="L1539">		long balDed = 0;</span>
<span class="nc" id="L1540">		Connection con = null;</span>
		try {
<span class="nc" id="L1542">			logger.debug(&quot;Inside  FE1*******&quot;);</span>
<span class="nc bnc" id="L1543" title="All 2 branches missed.">			if (fastLottoDataValidation(lottoPurchaseBean)) {</span>
<span class="nc" id="L1544">				logger.debug(&quot;Data Validation Returns True&quot;);</span>
				// lottoPurchaseBean.setAdvMsg(Util.getAdvMessage(userBean.getUserOrgId(),
				// lottoPurchaseBean.getGame_no(), &quot;PLAYER&quot;, &quot;SALE&quot;, &quot;DG&quot;));
<span class="nc" id="L1547">				lottoPurchaseBean</span>
						.setAdvMsg(Util.getDGSaleAdvMessage(userBean.getUserOrgId(), lottoPurchaseBean.getGame_no()));

<span class="nc" id="L1550">				con = DBConnect.getConnection();</span>
				// here insert the last sold tikcet on terminal or by third
				// party

<span class="nc bnc" id="L1554" title="All 2 branches missed.">				if (lottoPurchaseBean.getLastSoldTicketNo() != null) {</span>
<span class="nc bnc" id="L1555" title="All 2 branches missed.">					if (!&quot;0&quot;.equalsIgnoreCase(lottoPurchaseBean.getLastSoldTicketNo())) {</span>
<span class="nc" id="L1556">						Util.insertLastSoldTicketTeminal(lottoPurchaseBean.getUserId(),</span>
								lottoPurchaseBean.getLastSoldTicketNo(), lottoPurchaseBean.getGameId(), con);
					}
				}
<span class="nc" id="L1560">				lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L1561">				double totPurAmt = lottoPurchaseBean.getPicknumbers().length</span>
						* Util.getUnitPrice(lottoPurchaseBean.getGame_no(), null) * lottoPurchaseBean.getNoOfDraws();
<span class="nc" id="L1563">				logger.debug(&quot;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&quot; + totPurAmt);</span>
<span class="nc" id="L1564">				lottoPurchaseBean.setUnitPrice(Util.getUnitPrice(lottoPurchaseBean.getGame_no(), null));</span>
<span class="nc" id="L1565">				lottoPurchaseBean.setTotalPurchaseAmt(totPurAmt);</span>

				// rg calling
<span class="nc" id="L1568">				boolean isFraud = ResponsibleGaming.respGaming(userBean, &quot;DG_SALE&quot;, totPurAmt + &quot;&quot;);</span>
<span class="nc bnc" id="L1569" title="All 2 branches missed.">				if (!isFraud) {</span>
<span class="nc" id="L1570">					balDed = orgOnLineSaleCreditUpdation.drawTcketSaleBalDeduction(userBean,</span>
							lottoPurchaseBean.getGame_no(), lottoPurchaseBean.getTotalPurchaseAmt(),
							lottoPurchaseBean.getPlrMobileNumber(), con);
<span class="nc" id="L1573">					oldTotalPurchaseAmt = lottoPurchaseBean.getTotalPurchaseAmt();</span>

<span class="nc" id="L1575">					logger.debug(&quot;Total Purchase Amt inside DrawGameRPOSHelper Just Before  getting Success :&quot;</span>
							+ oldTotalPurchaseAmt);
				} else {
<span class="nc" id="L1578">					logger.debug(&quot;Responsing Gaming not allowed to sale&quot;);</span>
<span class="nc" id="L1579">					lottoPurchaseBean.setSaleStatus(&quot;FRAUD&quot;);</span>
				}
<span class="nc" id="L1581">			} else {</span>
<span class="nc" id="L1582">				logger.debug(&quot;Data validation returns false&quot;);</span>
<span class="nc" id="L1583">				lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
			}
<span class="nc" id="L1585">		} catch (Exception e) {</span>
<span class="nc" id="L1586">			e.printStackTrace();</span>
			// commented by amit as not relevant here

			/*
			 * lottoPurchaseBean = (LottoPurchaseBean) sRes.getResponseData();
			 * String ticketNo = lottoPurchaseBean.getTicket_no(); String
			 * cancelChannel = lottoPurchaseBean.getPurchaseChannel();
			 * Map&lt;Integer, Map&lt;Integer, String&gt;&gt; drawIdTableMap =
			 * lottoPurchaseBean .getDrawIdTableMap(); int gameNo =
			 * lottoPurchaseBean.getGame_no(); int partyId =
			 * lottoPurchaseBean.getPartyId(); String partyType =
			 * lottoPurchaseBean.getPartyType(); String refTransId =
			 * lottoPurchaseBean.getRefTransId();
			 * 
			 * cancelTicket(ticketNo, cancelChannel, drawIdTableMap, gameNo,
			 * partyId, partyType, refTransId);
			 */
<span class="nc" id="L1603">		}</span>

		try {
<span class="nc bnc" id="L1606" title="All 2 branches missed.">			if (balDed &gt; 0) {</span>
<span class="nc" id="L1607">				lottoPurchaseBean.setRefTransId(balDed + &quot;&quot;);</span>
<span class="nc" id="L1608">				sRes = delegate.getResponse(sReq);</span>

<span class="nc bnc" id="L1610" title="All 2 branches missed.">				if (sRes.getIsSuccess()) {</span>
<span class="nc" id="L1611">					lottoPurchaseBean = (LottoPurchaseBean) sRes.getResponseData();</span>
<span class="nc" id="L1612">					modifiedTotalPurchaseAmt = lottoPurchaseBean.getTotalPurchaseAmt();</span>
<span class="nc" id="L1613">					logger.debug(&quot;Total Purchase Amt inside DrawGameRPOSHelper After getting Success :&quot;</span>
							+ modifiedTotalPurchaseAmt);
<span class="nc" id="L1615">					con = DBConnect.getConnection();</span>
<span class="nc bnc" id="L1616" title="All 2 branches missed.">					if (oldTotalPurchaseAmt != modifiedTotalPurchaseAmt) {</span>
<span class="nc" id="L1617">						balDed = orgOnLineSaleCreditUpdation.drawTcketSaleBalDedUpdate(userBean,</span>
								lottoPurchaseBean.getGame_no(), modifiedTotalPurchaseAmt, oldTotalPurchaseAmt, balDed,
								con);

					}
<span class="nc" id="L1622">					int tickUpd = orgOnLineSaleCreditUpdation.drawTicketSaleTicketUpdate(balDed,</span>
							lottoPurchaseBean.getTicket_no(), lottoPurchaseBean.getGame_no(), userBean,
							lottoPurchaseBean.getPurchaseChannel(), con);
<span class="nc bnc" id="L1625" title="All 2 branches missed.">					if (tickUpd == 1) {</span>
<span class="nc" id="L1626">						status = &quot;SUCCESS&quot;;</span>
<span class="nc" id="L1627">						lottoPurchaseBean.setSaleStatus(status);</span>
<span class="nc bnc" id="L1628" title="All 2 branches missed.">						if (!lottoPurchaseBean.getBarcodeType().equals(&quot;applet&quot;)) {</span>
<span class="nc" id="L1629">							IDBarcode</span>
									.getBarcode(lottoPurchaseBean.getTicket_no() + lottoPurchaseBean.getReprintCount());
						}

<span class="nc" id="L1633">						List&lt;RafflePurchaseBean&gt; rafflePurchaseBeanList = new ArrayList&lt;RafflePurchaseBean&gt;();</span>

<span class="nc" id="L1635">						List&lt;PromoGameBean&gt; promoGameslist = Util.promoGameBeanMap.get(lottoPurchaseBean.getGame_no());</span>
						// String gameType =
						// getGameType(fortunePurchaseBean.getGame_no());
						// List&lt;PromoGameBean&gt; promoGameslist =
						// commonHelper.getAvailablePromoGames(gameType);

<span class="nc bnc" id="L1641" title="All 2 branches missed.">						for (int i = 0; i &lt; promoGameslist.size(); i++) {</span>
<span class="nc" id="L1642">							PromoGameBean promobean = promoGameslist.get(i);</span>
<span class="nc bnc" id="L1643" title="All 2 branches missed.">							if (promobean.getPromoGametype().equalsIgnoreCase(&quot;RAFFLE&quot;)) {</span>
<span class="nc" id="L1644">								lottoPurchaseBean.setRaffleNo(promobean.getPromoGameNo());</span>
<span class="nc" id="L1645">								RafflePurchaseBean rafflePurchaseBean = (RafflePurchaseBean) rafflePurchaseTicket(</span>
										userBean, lottoPurchaseBean, true);
<span class="nc" id="L1647">								rafflePurchaseBean.setRaffleTicketType(promobean.getPromoTicketType());</span>
<span class="nc bnc" id="L1648" title="All 2 branches missed.">								if (rafflePurchaseBean.getSaleStatus().equalsIgnoreCase(&quot;FAILED&quot;)) {</span>
<span class="nc" id="L1649">									status = &quot;FAILED&quot;;</span>
<span class="nc" id="L1650">									lottoPurchaseBean.setSaleStatus(status);</span>
									// Code for cancelling the Ticket to
									// be send to Draw Game Engine
<span class="nc" id="L1653">									cancelTicket(lottoPurchaseBean.getTicket_no() + lottoPurchaseBean.getReprintCount(),</span>
											lottoPurchaseBean.getPurchaseChannel(),
											lottoPurchaseBean.getDrawIdTableMap(), lottoPurchaseBean.getGame_no(),
											lottoPurchaseBean.getPartyId(), lottoPurchaseBean.getPartyType(),
											lottoPurchaseBean.getRefMerchantId(), userBean,
											lottoPurchaseBean.getRefTransId());
<span class="nc" id="L1659">									lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L1660">									return lottoPurchaseBean;</span>
<span class="nc bnc" id="L1661" title="All 2 branches missed.">								} else if (rafflePurchaseBean.getSaleStatus().equalsIgnoreCase(&quot;SUCCESS&quot;)) {</span>
									// here insert entry into the promo
									// ticket mapping table
<span class="nc" id="L1664">									int tktlen = rafflePurchaseBean.getRaffleTicket_no().length();</span>
<span class="nc" id="L1665">									orgOnLineSaleCreditUpdation.drawTicketNPromoMappigUpdate(1,</span>
											rafflePurchaseBean.getGame_no(), rafflePurchaseBean.getParentTktNo(),
											rafflePurchaseBean.getRaffleTicket_no().substring(0, tktlen - 2));
<span class="nc" id="L1668">									rafflePurchaseBeanList.add(rafflePurchaseBean);</span>
								}
							}
						}

<span class="nc" id="L1673">						lottoPurchaseBean.setRafflePurchaseBeanList(rafflePurchaseBeanList);</span>
<span class="nc" id="L1674">						return lottoPurchaseBean;</span>
					} else {
<span class="nc" id="L1676">						status = &quot;FAILED&quot;;</span>
<span class="nc" id="L1677">						lottoPurchaseBean.setSaleStatus(status);</span>
						// Code for cancelling the Ticket to be send to
						// Draw
						// Game Engine
<span class="nc" id="L1681">						cancelTicket(lottoPurchaseBean.getTicket_no() + lottoPurchaseBean.getReprintCount(),</span>
								lottoPurchaseBean.getPurchaseChannel(), lottoPurchaseBean.getDrawIdTableMap(),
								lottoPurchaseBean.getGame_no(), lottoPurchaseBean.getPartyId(),
								lottoPurchaseBean.getPartyType(), lottoPurchaseBean.getRefMerchantId(), userBean,
								lottoPurchaseBean.getRefTransId());

<span class="nc" id="L1687">						return lottoPurchaseBean;</span>
					}
				} else {
<span class="nc" id="L1690">					lottoPurchaseBean = (LottoPurchaseBean) sRes.getResponseData();</span>
<span class="nc bnc" id="L1691" title="All 2 branches missed.">					if (lottoPurchaseBean.getSaleStatus() == null) {</span>
<span class="nc" id="L1692">						lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);// Error</span>
<span class="nc" id="L1693">						orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, lottoPurchaseBean.getGame_no(),</span>
								&quot;FAILED&quot;, balDed);
<span class="nc" id="L1695">						return lottoPurchaseBean;</span>
<span class="nc bnc" id="L1696" title="All 2 branches missed.">					} else if (&quot;ERROR_TICKET_LIMIT&quot;.equalsIgnoreCase(lottoPurchaseBean.getSaleStatus())) {</span>
<span class="nc" id="L1697">						orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, lottoPurchaseBean.getGame_no(),</span>
								&quot;FAILED&quot;, balDed);
<span class="nc" id="L1699">						return lottoPurchaseBean;</span>
					} else {
<span class="nc" id="L1701">						orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, lottoPurchaseBean.getGame_no(),</span>
								&quot;FAILED&quot;, balDed);
<span class="nc" id="L1703">						return lottoPurchaseBean;</span>
					}
				}
			} else {

<span class="nc" id="L1708">				status = getStatusIfErrorInTransaction(status, balDed);</span>
<span class="nc" id="L1709">				lottoPurchaseBean.setSaleStatus(status);</span>
<span class="nc" id="L1710">				return lottoPurchaseBean;</span>
			}
<span class="nc" id="L1712">		} catch (Exception e) {</span>
			// TODO: handle exception
		}
<span class="nc" id="L1715">		return lottoPurchaseBean;</span>
	}
	// bonus ball two data validation

	public boolean bonusBallTwoDataValidation(LottoPurchaseBean lottoPurchaseBean) {
<span class="nc" id="L1720">		int noOfDraws = lottoPurchaseBean.getNoOfDraws();</span>
<span class="nc" id="L1721">		String[] picknumbers = lottoPurchaseBean.getPicknumbers();</span>
		Set&lt;Integer&gt; picknumSet;
		String pickNum[];
<span class="nc" id="L1724">		int noOfPanels = picknumbers.length;</span>
<span class="nc" id="L1725">		logger.debug(&quot;no of Panels: &quot; + noOfPanels);</span>
<span class="nc bnc" id="L1726" title="All 4 branches missed.">		if (noOfPanels != 4 &amp;&amp; lottoPurchaseBean.getPlayType().equalsIgnoreCase(&quot;direct5&quot;)) {</span>
<span class="nc" id="L1727">			return false;</span>
		}
<span class="nc bnc" id="L1729" title="All 6 branches missed.">		if (noOfDraws &gt; 0 &amp;&amp; noOfPanels &gt; 0 &amp;&amp; lottoPurchaseBean.getPlayType().equalsIgnoreCase(&quot;direct5&quot;)) {</span>
<span class="nc bnc" id="L1730" title="All 2 branches missed.">			for (int i = 0; i &lt; noOfPanels; i++) {</span>
<span class="nc bnc" id="L1731" title="All 2 branches missed.">				if (picknumbers[i].equalsIgnoreCase(&quot;QP&quot;)) {</span>
<span class="nc" id="L1732">					logger.debug(&quot;quick pick Selected&quot;);</span>

				} else {
<span class="nc" id="L1735">					logger.debug(&quot;not quick pick&quot;);</span>
<span class="nc" id="L1736">					logger.debug(&quot;Player picked Data:&quot; + picknumbers[i]);</span>
<span class="nc" id="L1737">					pickNum = picknumbers[i].split(&quot;,&quot;);</span>
<span class="nc" id="L1738">					picknumSet = new HashSet&lt;Integer&gt;();</span>
<span class="nc bnc" id="L1739" title="All 2 branches missed.">					for (String element : pickNum) {</span>
<span class="nc" id="L1740">						picknumSet.add(Integer.parseInt(element));</span>
					}
<span class="nc bnc" id="L1742" title="All 4 branches missed.">					if (pickNum.length != picknumSet.size()</span>
							|| pickNum.length &gt; com.skilrock.lms.dge.gameconstants.BonusBalltwoConstants.MAX_PLAYER_PICKED) {
<span class="nc" id="L1744">						logger.debug(&quot;picNum.Length: &quot; + pickNum.length + &quot;Set length:  &quot; + picknumSet.size());</span>
<span class="nc" id="L1745">						return false;</span>
					}
				}
			}
<span class="nc" id="L1749">			return true;</span>
<span class="nc bnc" id="L1750" title="All 2 branches missed.">		} else if (&quot;Perm5&quot;.equalsIgnoreCase(lottoPurchaseBean.getPlayType())) {</span>
<span class="nc" id="L1751">			return true;</span>

		}
<span class="nc" id="L1754">		return false;</span>

	}

	public LottoPurchaseBean bonusBallTwoPurchaseTicket(UserInfoBean userBean, LottoPurchaseBean lottoPurchaseBean)
			throws Exception {

<span class="nc bnc" id="L1761" title="All 4 branches missed.">		if (isDrawAvailable(lottoPurchaseBean.getGame_no()) || chkFreezeTimeSale(lottoPurchaseBean.getGame_no())) {</span>
<span class="nc" id="L1762">			lottoPurchaseBean.setSaleStatus(&quot;NO_DRAWS&quot;);</span>
<span class="nc" id="L1763">			return lottoPurchaseBean;</span>
		}
<span class="nc" id="L1765">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L1766">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L1767">		sReq.setServiceName(ServiceName.BUNUSTWOLOTTO);</span>
<span class="nc" id="L1768">		sReq.setServiceMethod(ServiceMethodName.BONUSBALLTWO_PURCHASE_TICKET);</span>
<span class="nc" id="L1769">		sReq.setServiceData(lottoPurchaseBean);</span>
<span class="nc" id="L1770">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L1771">		String status = &quot;&quot;;</span>
<span class="nc" id="L1772">		long balDed = 0;</span>
<span class="nc" id="L1773">		double oldTotalPurchaseAmt = 0.0;</span>
<span class="nc" id="L1774">		double modifiedTotalPurchaseAmt = 0.0;</span>
<span class="nc" id="L1775">		Connection con = null;</span>
		try {
<span class="nc" id="L1777">			logger.debug(&quot;Inside  FE1*******&quot;);</span>
<span class="nc bnc" id="L1778" title="All 2 branches missed.">			if (bonusBallTwoDataValidation(lottoPurchaseBean)) {</span>
<span class="nc" id="L1779">				logger.debug(&quot;Data Validation Returns True&quot;);</span>
				// lottoPurchaseBean.setAdvMsg(Util.getAdvMessage(userBean.getUserOrgId(),
				// lottoPurchaseBean.getGame_no(), &quot;PLAYER&quot;, &quot;SALE&quot;, &quot;DG&quot;));
<span class="nc" id="L1782">				lottoPurchaseBean</span>
						.setAdvMsg(Util.getDGSaleAdvMessage(userBean.getUserOrgId(), lottoPurchaseBean.getGame_no()));

<span class="nc" id="L1785">				con = DBConnect.getConnection();</span>
<span class="nc" id="L1786">				lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
				// here insert the last sold tikcet on terminal or by third
				// party

<span class="nc bnc" id="L1790" title="All 2 branches missed.">				if (lottoPurchaseBean.getLastSoldTicketNo() != null) {</span>
<span class="nc bnc" id="L1791" title="All 2 branches missed.">					if (!&quot;0&quot;.equalsIgnoreCase(lottoPurchaseBean.getLastSoldTicketNo())) {</span>
<span class="nc" id="L1792">						Util.insertLastSoldTicketTeminal(lottoPurchaseBean.getUserId(),</span>
								lottoPurchaseBean.getLastSoldTicketNo(), lottoPurchaseBean.getGameId(), con);
					}
				}
<span class="nc" id="L1796">				int noOfLines = lottoPurchaseBean.getPicknumbers().length;</span>

<span class="nc bnc" id="L1798" title="All 2 branches missed.">				if (&quot;Perm5&quot;.equals(lottoPurchaseBean.getPlayType())) {</span>
<span class="nc" id="L1799">					int n = lottoPurchaseBean.getNoPicked();</span>
<span class="nc bnc" id="L1800" title="All 2 branches missed.">					if (n &lt; 6) {</span>
<span class="nc" id="L1801">						lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L1802">						return lottoPurchaseBean;</span>
					}

<span class="nc" id="L1805">					noOfLines = (n * (n - 1) * (n - 2) * (n - 3) * (n - 4)) / 120;</span>

				}

<span class="nc" id="L1809">				lottoPurchaseBean.setNoOfLines(noOfLines);</span>

<span class="nc bnc" id="L1811" title="All 2 branches missed.">				double totPurAmt = noOfLines</span>
						* Util.getUnitPrice(lottoPurchaseBean.getGame_no(), lottoPurchaseBean.getPlayType())
						* lottoPurchaseBean.getNoOfDraws()
						* (lottoPurchaseBean.getBetAmtMultiple() &gt; 0 ? lottoPurchaseBean.getBetAmtMultiple() : 1);
<span class="nc" id="L1815">				totPurAmt = CommonMethods.fmtToTwoDecimal(totPurAmt);</span>
<span class="nc" id="L1816">				logger.debug(&quot;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&quot; + totPurAmt);</span>
				// done to support generic coding of lotto games ...
<span class="nc" id="L1818">				int noOfPanels = lottoPurchaseBean.getPicknumbers().length;</span>
<span class="nc" id="L1819">				int[] betAmountMul = new int[noOfPanels];</span>
<span class="nc bnc" id="L1820" title="All 2 branches missed.">				for (int i = 0; i &lt; noOfPanels; i++) {</span>
<span class="nc" id="L1821">					betAmountMul[i] = lottoPurchaseBean.getBetAmtMultiple();</span>
				}

<span class="nc" id="L1824">				lottoPurchaseBean.setBetAmountMultiple(betAmountMul);</span>
<span class="nc" id="L1825">				lottoPurchaseBean.setTotalPurchaseAmt(totPurAmt);</span>
<span class="nc" id="L1826">				lottoPurchaseBean.setUnitPrice(</span>
						Util.getUnitPrice(lottoPurchaseBean.getGame_no(), lottoPurchaseBean.getPlayType()));

				// rg calling
<span class="nc" id="L1830">				boolean isFraud = ResponsibleGaming.respGaming(userBean, &quot;DG_SALE&quot;, totPurAmt + &quot;&quot;);</span>
<span class="nc bnc" id="L1831" title="All 2 branches missed.">				if (!isFraud) {</span>
<span class="nc" id="L1832">					balDed = orgOnLineSaleCreditUpdation.drawTcketSaleBalDeduction(userBean,</span>
							lottoPurchaseBean.getGame_no(), lottoPurchaseBean.getTotalPurchaseAmt(),
							lottoPurchaseBean.getPlrMobileNumber(), con);
<span class="nc" id="L1835">					oldTotalPurchaseAmt = lottoPurchaseBean.getTotalPurchaseAmt();</span>

<span class="nc" id="L1837">					logger.debug(&quot;Total Purchase Amt inside DrawGameRPOSHelper Just Before  getting Success :&quot;</span>
							+ oldTotalPurchaseAmt);
				} else {
<span class="nc" id="L1840">					logger.debug(&quot;Responsing Gaming not allowed to sale&quot;);</span>
<span class="nc" id="L1841">					lottoPurchaseBean.setSaleStatus(&quot;FRAUD&quot;);</span>
				}
<span class="nc" id="L1843">			} else {</span>
<span class="nc" id="L1844">				logger.debug(&quot;Data validation returns false&quot;);</span>
<span class="nc" id="L1845">				lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
			}
<span class="nc" id="L1847">		} catch (Exception e) {</span>
<span class="nc" id="L1848">			e.printStackTrace();</span>
			// commented by amit as not relevant here

			/*
			 * lottoPurchaseBean = (LottoPurchaseBean) sRes.getResponseData();
			 * String ticketNo = lottoPurchaseBean.getTicket_no(); String
			 * cancelChannel = lottoPurchaseBean.getPurchaseChannel();
			 * Map&lt;Integer, Map&lt;Integer, String&gt;&gt; drawIdTableMap =
			 * lottoPurchaseBean .getDrawIdTableMap(); int gameNo =
			 * lottoPurchaseBean.getGame_no(); int partyId =
			 * lottoPurchaseBean.getPartyId(); String partyType =
			 * lottoPurchaseBean.getPartyType(); String refTransId =
			 * lottoPurchaseBean.getRefTransId();
			 * 
			 * cancelTicket(ticketNo, cancelChannel, drawIdTableMap, gameNo,
			 * partyId, partyType, refTransId);
			 */
<span class="nc" id="L1865">		}</span>

		try {
<span class="nc bnc" id="L1868" title="All 2 branches missed.">			if (balDed &gt; 0) {</span>
<span class="nc" id="L1869">				lottoPurchaseBean.setRefTransId(balDed + &quot;&quot;);</span>
<span class="nc" id="L1870">				sRes = delegate.getResponse(sReq);</span>

<span class="nc bnc" id="L1872" title="All 2 branches missed.">				if (sRes.getIsSuccess()) {</span>
<span class="nc" id="L1873">					lottoPurchaseBean = (LottoPurchaseBean) sRes.getResponseData();</span>
<span class="nc" id="L1874">					modifiedTotalPurchaseAmt = lottoPurchaseBean.getTotalPurchaseAmt();</span>

					// rouding

<span class="nc" id="L1878">					modifiedTotalPurchaseAmt = CommonMethods.roundDrawTktAmt(modifiedTotalPurchaseAmt);</span>
<span class="nc" id="L1879">					logger.debug(&quot;Total Purchase Amt inside DrawGameRPOSHelper After getting Success :&quot;</span>
							+ modifiedTotalPurchaseAmt);
<span class="nc" id="L1881">					con = DBConnect.getConnection();</span>
<span class="nc bnc" id="L1882" title="All 2 branches missed.">					if (oldTotalPurchaseAmt != modifiedTotalPurchaseAmt) {</span>
<span class="nc" id="L1883">						lottoPurchaseBean.setTotalPurchaseAmt(modifiedTotalPurchaseAmt);</span>
<span class="nc" id="L1884">						balDed = orgOnLineSaleCreditUpdation.drawTcketSaleBalDedUpdate(userBean,</span>
								lottoPurchaseBean.getGame_no(), modifiedTotalPurchaseAmt, oldTotalPurchaseAmt, balDed,
								con);

					}
<span class="nc" id="L1889">					int tickUpd = orgOnLineSaleCreditUpdation.drawTicketSaleTicketUpdate(balDed,</span>
							lottoPurchaseBean.getTicket_no(), lottoPurchaseBean.getGame_no(), userBean,
							lottoPurchaseBean.getPurchaseChannel(), con);
<span class="nc bnc" id="L1892" title="All 2 branches missed.">					if (tickUpd == 1) {</span>
<span class="nc" id="L1893">						status = &quot;SUCCESS&quot;;</span>
<span class="nc" id="L1894">						lottoPurchaseBean.setSaleStatus(status);</span>
<span class="nc bnc" id="L1895" title="All 2 branches missed.">						if (!lottoPurchaseBean.getBarcodeType().equals(&quot;applet&quot;)) {</span>
<span class="nc" id="L1896">							IDBarcode</span>
									.getBarcode(lottoPurchaseBean.getTicket_no() + lottoPurchaseBean.getReprintCount());
						}

<span class="nc" id="L1900">						List&lt;RafflePurchaseBean&gt; rafflePurchaseBeanList = new ArrayList&lt;RafflePurchaseBean&gt;();</span>
						// CommonFunctionsHelper commonHelper = new
						// CommonFunctionsHelper();

<span class="nc" id="L1904">						List&lt;PromoGameBean&gt; promoGameslist = Util.promoGameBeanMap.get(lottoPurchaseBean.getGame_no());</span>
						// String gameType =
						// getGameType(fortunePurchaseBean.getGame_no());
						// List&lt;PromoGameBean&gt; promoGameslist =
						// commonHelper.getAvailablePromoGames(gameType);

<span class="nc bnc" id="L1910" title="All 2 branches missed.">						for (int i = 0; i &lt; promoGameslist.size(); i++) {</span>
<span class="nc" id="L1911">							PromoGameBean promobean = promoGameslist.get(i);</span>
<span class="nc bnc" id="L1912" title="All 2 branches missed.">							if (promobean.getPromoGametype().equalsIgnoreCase(&quot;RAFFLE&quot;)) {</span>
<span class="nc" id="L1913">								lottoPurchaseBean.setRaffleNo(promobean.getPromoGameNo());</span>
<span class="nc" id="L1914">								RafflePurchaseBean rafflePurchaseBean = (RafflePurchaseBean) rafflePurchaseTicket(</span>
										userBean, lottoPurchaseBean, true);
<span class="nc" id="L1916">								rafflePurchaseBean.setRaffleTicketType(promobean.getPromoTicketType());</span>
<span class="nc bnc" id="L1917" title="All 2 branches missed.">								if (rafflePurchaseBean.getSaleStatus().equalsIgnoreCase(&quot;FAILED&quot;)) {</span>
<span class="nc" id="L1918">									status = &quot;FAILED&quot;;</span>
<span class="nc" id="L1919">									lottoPurchaseBean.setSaleStatus(status);</span>
									// Code for cancelling the Ticket to
									// be send to Draw Game Engine
<span class="nc" id="L1922">									cancelTicket(lottoPurchaseBean.getTicket_no() + lottoPurchaseBean.getReprintCount(),</span>
											lottoPurchaseBean.getPurchaseChannel(),
											lottoPurchaseBean.getDrawIdTableMap(), lottoPurchaseBean.getGame_no(),
											lottoPurchaseBean.getPartyId(), lottoPurchaseBean.getPartyType(),
											lottoPurchaseBean.getRefMerchantId(), userBean,
											lottoPurchaseBean.getRefTransId());
<span class="nc" id="L1928">									lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L1929">									return lottoPurchaseBean;</span>
<span class="nc bnc" id="L1930" title="All 2 branches missed.">								} else if (rafflePurchaseBean.getSaleStatus().equalsIgnoreCase(&quot;SUCCESS&quot;)) {</span>
									// here insert entry into the promo
									// ticket mapping table
<span class="nc" id="L1933">									int tktlen = rafflePurchaseBean.getRaffleTicket_no().length();</span>
<span class="nc" id="L1934">									orgOnLineSaleCreditUpdation.drawTicketNPromoMappigUpdate(1,</span>
											rafflePurchaseBean.getGame_no(), rafflePurchaseBean.getParentTktNo(),
											rafflePurchaseBean.getRaffleTicket_no().substring(0, tktlen - 2));
<span class="nc" id="L1937">									rafflePurchaseBeanList.add(rafflePurchaseBean);</span>
								}
							}
						}

<span class="nc" id="L1942">						lottoPurchaseBean.setRafflePurchaseBeanList(rafflePurchaseBeanList);</span>
<span class="nc" id="L1943">						return lottoPurchaseBean;</span>
					} else {
<span class="nc" id="L1945">						status = &quot;FAILED&quot;;</span>
<span class="nc" id="L1946">						lottoPurchaseBean.setSaleStatus(status);</span>
						// Code for cancelling the Ticket to be send to
						// Draw
						// Game Engine
<span class="nc" id="L1950">						cancelTicket(lottoPurchaseBean.getTicket_no() + lottoPurchaseBean.getReprintCount(),</span>
								lottoPurchaseBean.getPurchaseChannel(), lottoPurchaseBean.getDrawIdTableMap(),
								lottoPurchaseBean.getGame_no(), lottoPurchaseBean.getPartyId(),
								lottoPurchaseBean.getPartyType(), lottoPurchaseBean.getRefMerchantId(), userBean,
								lottoPurchaseBean.getRefTransId());

<span class="nc" id="L1956">						return lottoPurchaseBean;</span>
					}
				} else {
<span class="nc" id="L1959">					lottoPurchaseBean = (LottoPurchaseBean) sRes.getResponseData();</span>
<span class="nc bnc" id="L1960" title="All 2 branches missed.">					if (lottoPurchaseBean.getSaleStatus() == null) {</span>
<span class="nc" id="L1961">						lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);// Error</span>
<span class="nc" id="L1962">						orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, lottoPurchaseBean.getGame_no(),</span>
								&quot;FAILED&quot;, balDed);
<span class="nc" id="L1964">						return lottoPurchaseBean;</span>
<span class="nc bnc" id="L1965" title="All 2 branches missed.">					} else if (&quot;ERROR_TICKET_LIMIT&quot;.equalsIgnoreCase(lottoPurchaseBean.getSaleStatus())) {</span>
<span class="nc" id="L1966">						orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, lottoPurchaseBean.getGame_no(),</span>
								&quot;FAILED&quot;, balDed);
<span class="nc" id="L1968">						return lottoPurchaseBean;</span>
					} else {
<span class="nc" id="L1970">						orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, lottoPurchaseBean.getGame_no(),</span>
								&quot;FAILED&quot;, balDed);
<span class="nc" id="L1972">						return lottoPurchaseBean;</span>
					}
				}
			} else {

<span class="nc" id="L1977">				status = getStatusIfErrorInTransaction(status, balDed);</span>
<span class="nc" id="L1978">				lottoPurchaseBean.setSaleStatus(status);</span>
<span class="nc" id="L1979">				return lottoPurchaseBean;</span>
			}
<span class="nc" id="L1981">		} catch (Exception e) {</span>
			// TODO: handle exception
		}
<span class="nc" id="L1984">		return lottoPurchaseBean;</span>
	}

	private void fillRaffleBean(RafflePurchaseBean rafflePurchaseBean, Object gameBean) {
<span class="nc bnc" id="L1988" title="All 2 branches missed.">		if (gameBean instanceof FortunePurchaseBean) {</span>
<span class="nc" id="L1989">			logger.debug(&quot; FortunePurchaseBean &quot;);</span>
<span class="nc" id="L1990">			FortunePurchaseBean parentBean = (FortunePurchaseBean) gameBean;</span>
<span class="nc" id="L1991">			rafflePurchaseBean.setBetAmountMultiple(1);</span>
<span class="nc" id="L1992">			rafflePurchaseBean.setPartyId(parentBean.getPartyId());</span>
<span class="nc" id="L1993">			rafflePurchaseBean.setUserId(parentBean.getUserId());</span>
<span class="nc" id="L1994">			rafflePurchaseBean.setPartyType(parentBean.getPartyType());</span>
<span class="nc" id="L1995">			rafflePurchaseBean.setNoOfDraws(parentBean.getNoOfDraws());</span>
<span class="nc" id="L1996">			rafflePurchaseBean.setRefTransId(parentBean.getRefTransId());</span>
<span class="nc" id="L1997">			rafflePurchaseBean.setPurchaseChannel(parentBean.getPurchaseChannel());</span>
<span class="nc" id="L1998">			rafflePurchaseBean.setRefMerchantId(parentBean.getRefMerchantId());</span>
<span class="nc" id="L1999">			rafflePurchaseBean.setDrawIdTableMap(parentBean.getDrawIdTableMap());</span>
<span class="nc" id="L2000">			rafflePurchaseBean.setParentTktNo(parentBean.getTicket_no());</span>
<span class="nc" id="L2001">			rafflePurchaseBean.setGame_no(parentBean.getGame_no());</span>
			// rafflePurchaseBean.setRaffleTicketType(&quot;ORIGINAL&quot;);
<span class="nc" id="L2003">			rafflePurchaseBean.setRaffle_no(parentBean.getRaffleNo());</span>
<span class="nc" id="L2004">			rafflePurchaseBean.setPlrMobileNumber(parentBean.getPlrMobileNumber());</span>
<span class="nc bnc" id="L2005" title="All 2 branches missed.">		} else if (gameBean instanceof LottoPurchaseBean) {</span>

<span class="nc" id="L2007">			LottoPurchaseBean parentBean = (LottoPurchaseBean) gameBean;</span>
<span class="nc" id="L2008">			rafflePurchaseBean.setBetAmountMultiple(1);</span>
<span class="nc" id="L2009">			rafflePurchaseBean.setPartyId(parentBean.getPartyId());</span>
<span class="nc" id="L2010">			rafflePurchaseBean.setUserId(parentBean.getUserId());</span>
<span class="nc" id="L2011">			rafflePurchaseBean.setPartyType(parentBean.getPartyType());</span>
<span class="nc" id="L2012">			rafflePurchaseBean.setNoOfDraws(parentBean.getNoOfDraws());</span>
<span class="nc" id="L2013">			rafflePurchaseBean.setRefTransId(parentBean.getRefTransId());</span>
<span class="nc" id="L2014">			rafflePurchaseBean.setPurchaseChannel(parentBean.getPurchaseChannel());</span>
<span class="nc" id="L2015">			rafflePurchaseBean.setRefMerchantId(parentBean.getRefMerchantId());</span>
<span class="nc" id="L2016">			rafflePurchaseBean.setDrawIdTableMap(parentBean.getDrawIdTableMap());</span>
<span class="nc" id="L2017">			rafflePurchaseBean.setParentTktNo(parentBean.getTicket_no());</span>
<span class="nc" id="L2018">			rafflePurchaseBean.setGame_no(parentBean.getGame_no());</span>
			// rafflePurchaseBean.setRaffleTicketType(&quot;ORIGINAL&quot;);
<span class="nc" id="L2020">			rafflePurchaseBean.setRaffle_no(parentBean.getRaffleNo());</span>
<span class="nc" id="L2021">			rafflePurchaseBean.setPlrMobileNumber(parentBean.getPlrMobileNumber());</span>
<span class="nc bnc" id="L2022" title="All 2 branches missed.">		} else if (gameBean instanceof KenoPurchaseBean) {</span>
<span class="nc" id="L2023">			logger.debug(&quot; kenoPurchaseBean &quot;);</span>
<span class="nc" id="L2024">			KenoPurchaseBean parentBean = (KenoPurchaseBean) gameBean;</span>
<span class="nc" id="L2025">			rafflePurchaseBean.setBetAmountMultiple(1);</span>
<span class="nc" id="L2026">			rafflePurchaseBean.setPartyId(parentBean.getPartyId());</span>
<span class="nc" id="L2027">			rafflePurchaseBean.setUserId(parentBean.getUserId());</span>
<span class="nc" id="L2028">			rafflePurchaseBean.setPartyType(parentBean.getPartyType());</span>
<span class="nc" id="L2029">			rafflePurchaseBean.setNoOfDraws(parentBean.getNoofDrawsForPromo());</span>
<span class="nc" id="L2030">			rafflePurchaseBean.setNoOfDrawPlayedFor(parentBean.getNoofDrawsForPromo());</span>
<span class="nc" id="L2031">			rafflePurchaseBean.setRefTransId(parentBean.getRefTransId());</span>
<span class="nc" id="L2032">			rafflePurchaseBean.setPurchaseChannel(parentBean.getPurchaseChannel());</span>
<span class="nc" id="L2033">			rafflePurchaseBean.setRefMerchantId(parentBean.getRefMerchantId());</span>
<span class="nc" id="L2034">			rafflePurchaseBean.setDrawIdTableMap(parentBean.getDrawIdTableMap());</span>
<span class="nc" id="L2035">			rafflePurchaseBean.setParentTktNo(parentBean.getTicket_no());</span>
			// rafflePurchaseBean.setGame_no(parentBean.getGame_no());
<span class="nc" id="L2037">			rafflePurchaseBean.setGameId(parentBean.getRaffleNo());// Affle game</span>
																	// Id
			// rafflePurchaseBean.setRaffleTicketType(&quot;ORIGINAL&quot;);
<span class="nc" id="L2040">			rafflePurchaseBean.setRaffle_no(parentBean.getRaffleNo());</span>
<span class="nc" id="L2041">			rafflePurchaseBean.setPlrMobileNumber(parentBean.getPlrMobileNumber());</span>
<span class="nc" id="L2042">			rafflePurchaseBean.setUserMappingId(parentBean.getUserMappingId());</span>
<span class="nc" id="L2043">			rafflePurchaseBean.setServiceName(&quot;DG&quot;);</span>
<span class="nc" id="L2044">			rafflePurchaseBean.setServiceId(parentBean.getServiceId());</span>

			// Will be implement later
		}

<span class="nc" id="L2049">	}</span>

	/**
	 * Data Validation method checks for
	 * noOfDraws,isQuikePic,BetAmountMultiple,SumofBetAmtMultiple etc,It also
	 * calculates Total Purchase Amt
	 * 
	 */
	public boolean fortuneDataValidation(FortunePurchaseBean card12PurchaseBean) {
<span class="nc" id="L2058">		logger.debug(&quot;Inside Data Validation&quot;);</span>
<span class="nc" id="L2059">		int noOfDraw = card12PurchaseBean.getNoOfDraws();</span>

<span class="nc" id="L2061">		int isQP = card12PurchaseBean.getIsQP();</span>
<span class="nc" id="L2062">		int QPTotalNoPanels = 0;</span>
<span class="nc bnc" id="L2063" title="All 2 branches missed.">		if (isQP == 1) {</span>
<span class="nc" id="L2064">			logger.debug(&quot;QP selected ....&quot;);</span>
<span class="nc" id="L2065">			QPTotalNoPanels = card12PurchaseBean.getTotalNoOfPanels();</span>
<span class="nc bnc" id="L2066" title="All 2 branches missed.">			if (QPTotalNoPanels &gt; 1000) {</span>
<span class="nc" id="L2067">				return false;</span>
			}
<span class="nc" id="L2069">			return true;</span>
		} else {
<span class="nc" id="L2071">			String noOfPanels = card12PurchaseBean.getNoOfPanels();</span>
<span class="nc" id="L2072">			String[] noOfPanel = noOfPanels.split(&quot;,&quot;);</span>
<span class="nc" id="L2073">			int betAmountMultiple[] = null;</span>
<span class="nc" id="L2074">			int totalNoOfPanels = 0;</span>
<span class="nc" id="L2075">			String symbols = card12PurchaseBean.getSymbols();</span>
			String[] pickedNumber;
<span class="nc" id="L2077">			Set&lt;String&gt; s = new HashSet&lt;String&gt;();</span>
<span class="nc" id="L2078">			betAmountMultiple = new int[noOfPanel.length];</span>
<span class="nc" id="L2079">			logger.debug(&quot;QP not selected ....&quot;);</span>
<span class="nc bnc" id="L2080" title="All 2 branches missed.">			if (isQP == 2) {</span>
<span class="nc bnc" id="L2081" title="All 2 branches missed.">				for (int i = 0; i &lt; noOfPanel.length; i++) {</span>
<span class="nc" id="L2082">					betAmountMultiple[i] = Integer.parseInt(noOfPanel[i]);</span>
<span class="nc bnc" id="L2083" title="All 2 branches missed.">					if (betAmountMultiple[i] &gt; 1000) {</span>
<span class="nc" id="L2084">						return false;</span>
					}
<span class="nc" id="L2086">					totalNoOfPanels += betAmountMultiple[i];</span>
				}
<span class="nc" id="L2088">				pickedNumber = symbols.split(&quot;,&quot;);</span>
				// Checks for unique Symbols
<span class="nc bnc" id="L2090" title="All 2 branches missed.">				for (String element : pickedNumber) {</span>
<span class="nc" id="L2091">					s.add(element);</span>
				}
<span class="nc bnc" id="L2093" title="All 6 branches missed.">				if (noOfDraw &gt; 0 &amp;&amp; totalNoOfPanels &lt;= 1000 &amp;&amp; pickedNumber.length == s.size()) {</span>
<span class="nc" id="L2094">					return true;</span>
				}
			}
<span class="nc" id="L2097">			return false;</span>
		}

	}

	public boolean fortuneTwoDataValidation(FortuneTwoPurchaseBean fortuneTwoPurchaseBean) {
		/*
		 * logger.debug(&quot;Inside Data Validation&quot;); int noOfDraw =
		 * fortuneTwoPurchaseBean.getNoOfDraws();
		 * 
		 * int isQP = fortuneTwoPurchaseBean.getIsQP(); int QPTotalNoPanels = 0;
		 * if (isQP == 1) { logger.debug(&quot;QP selected ....&quot;); QPTotalNoPanels =
		 * fortuneTwoPurchaseBean.getTotalNoOfPanels(); if (QPTotalNoPanels &gt;
		 * 1000) { return false; } return true; } else { String noOfPanels =
		 * fortuneTwoPurchaseBean.getNoOfPanels(); String[] noOfPanel =
		 * noOfPanels.split(&quot;,&quot;); int betAmountMultiple[] = null; int
		 * totalNoOfPanels = 0; String symbols =
		 * fortuneTwoPurchaseBean.getSymbols(); String[] pickedNumber;
		 * Set&lt;String&gt; s = new HashSet&lt;String&gt;(); betAmountMultiple = new
		 * int[noOfPanel.length]; logger.debug(&quot;QP not selected ....&quot;); if (isQP
		 * == 2) { for (int i = 0; i &lt; noOfPanel.length; i++) {
		 * betAmountMultiple[i] = Integer.parseInt(noOfPanel[i]); if
		 * (betAmountMultiple[i] &gt; 1000) { return false; } totalNoOfPanels +=
		 * betAmountMultiple[i]; } pickedNumber = symbols.split(&quot;,&quot;); // Checks
		 * for unique Symbols for (String element : pickedNumber) {
		 * s.add(element); } if (noOfDraw &gt; 0 &amp;&amp; totalNoOfPanels &lt;= 1000 &amp;&amp;
		 * pickedNumber.length == s.size()) { return true; } } return false; }
		 * 
<span class="nc" id="L2125">		 */return true;</span>
	}

	public boolean fortuneThreeDataValidation(FortuneThreePurchaseBean fortuneThreePurchaseBean) {
		/*
		 * logger.debug(&quot;Inside Data Validation&quot;); int noOfDraw =
		 * fortuneTwoPurchaseBean.getNoOfDraws();
		 * 
		 * int isQP = fortuneTwoPurchaseBean.getIsQP(); int QPTotalNoPanels = 0;
		 * if (isQP == 1) { logger.debug(&quot;QP selected ....&quot;); QPTotalNoPanels =
		 * fortuneTwoPurchaseBean.getTotalNoOfPanels(); if (QPTotalNoPanels &gt;
		 * 1000) { return false; } return true; } else { String noOfPanels =
		 * fortuneTwoPurchaseBean.getNoOfPanels(); String[] noOfPanel =
		 * noOfPanels.split(&quot;,&quot;); int betAmountMultiple[] = null; int
		 * totalNoOfPanels = 0; String symbols =
		 * fortuneTwoPurchaseBean.getSymbols(); String[] pickedNumber;
		 * Set&lt;String&gt; s = new HashSet&lt;String&gt;(); betAmountMultiple = new
		 * int[noOfPanel.length]; logger.debug(&quot;QP not selected ....&quot;); if (isQP
		 * == 2) { for (int i = 0; i &lt; noOfPanel.length; i++) {
		 * betAmountMultiple[i] = Integer.parseInt(noOfPanel[i]); if
		 * (betAmountMultiple[i] &gt; 1000) { return false; } totalNoOfPanels +=
		 * betAmountMultiple[i]; } pickedNumber = symbols.split(&quot;,&quot;); // Checks
		 * for unique Symbols for (String element : pickedNumber) {
		 * s.add(element); } if (noOfDraw &gt; 0 &amp;&amp; totalNoOfPanels &lt;= 1000 &amp;&amp;
		 * pickedNumber.length == s.size()) { return true; } } return false; }
		 * 
<span class="nc" id="L2151">		 */return true;</span>
	}

	public FortunePurchaseBean fortunePurchaseTicket(UserInfoBean userBean, FortunePurchaseBean fortunePurchaseBean)
			throws Exception {

<span class="nc bnc" id="L2157" title="All 4 branches missed.">		if (isDrawAvailable(fortunePurchaseBean.getGameId()) || chkFreezeTimeSale(fortunePurchaseBean.getGameId())) {</span>
<span class="nc" id="L2158">			fortunePurchaseBean.setSaleStatus(&quot;NO_DRAWS&quot;);</span>
<span class="nc" id="L2159">			return fortunePurchaseBean;</span>
		}
<span class="nc" id="L2161">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L2162">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L2163">		sReq.setServiceName(ServiceName.FORTUNE_MGMT);</span>
<span class="nc" id="L2164">		sReq.setServiceMethod(ServiceMethodName.FORTUNE_PURCHASE_TICKET);</span>
<span class="nc" id="L2165">		sReq.setServiceData(fortunePurchaseBean);</span>
<span class="nc" id="L2166">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L2167">		fortunePurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L2168">		long balDed = 0;</span>
<span class="nc" id="L2169">		int tickUpd = 0;</span>
<span class="nc" id="L2170">		double oldTotalPurchaseAmt = 0.0;</span>
<span class="nc" id="L2171">		double modifiedTotalPurchaseAmt = 0.0;</span>
<span class="nc" id="L2172">		String status = &quot;&quot;;</span>
<span class="nc" id="L2173">		Connection con = null;</span>
		try {
<span class="nc bnc" id="L2175" title="All 2 branches missed.">			if (fortuneDataValidation(fortunePurchaseBean)) {</span>
<span class="nc" id="L2176">				logger.debug(&quot;Data validation returns true&quot;);</span>

<span class="nc" id="L2178">				con = DBConnect.getConnection();</span>

				// here insert the last sold tikcet on terminal or by third
				// party

<span class="nc bnc" id="L2183" title="All 2 branches missed.">				if (fortunePurchaseBean.getLastSoldTicketNo() != null) {</span>
<span class="nc bnc" id="L2184" title="All 2 branches missed.">					if (!&quot;0&quot;.equalsIgnoreCase(fortunePurchaseBean.getLastSoldTicketNo())) {</span>
<span class="nc" id="L2185">						Util.insertLastSoldTicketTeminal(fortunePurchaseBean.getUserId(),</span>
								fortunePurchaseBean.getLastSoldTicketNo(), fortunePurchaseBean.getGameId(), con);
					}
				}

				// fortunePurchaseBean.setAdvMsg(Util.getAdvMessage(
				// userBean.getUserOrgId(), fortunePurchaseBean.getGame_no(),
				// &quot;PLAYER&quot;, &quot;SALE&quot;, &quot;DG&quot;));
<span class="nc" id="L2193">				fortunePurchaseBean</span>
						.setAdvMsg(Util.getDGSaleAdvMessage(userBean.getUserOrgId(), fortunePurchaseBean.getGame_no()));

<span class="nc" id="L2196">				logger.debug(fortunePurchaseBean.getTotalNoOfPanels()</span>
						* Util.getUnitPrice(fortunePurchaseBean.getGameId(), fortunePurchaseBean.getPlayType())
						* fortunePurchaseBean.getNoOfDraws());

<span class="nc" id="L2200">				double totPurAmt = fortunePurchaseBean.getTotalNoOfPanels()</span>
						* Util.getUnitPrice(fortunePurchaseBean.getGameId(), fortunePurchaseBean.getPlayType())
						* fortunePurchaseBean.getNoOfDraws();

<span class="nc" id="L2204">				fortunePurchaseBean.setTotalPurchaseAmt(totPurAmt);</span>
<span class="nc bnc" id="L2205" title="All 2 branches missed.">				if (!userBean.getUserType().equals(&quot;RETAILER&quot;)) {</span>
<span class="nc" id="L2206">					return fortunePurchaseBean;</span>
				}
<span class="nc" id="L2208">				boolean isPromoAssociated = false;</span>

<span class="nc" id="L2210">				logger.debug(&quot;Inside Fortune FE1*******  &quot;);</span>
				// rg calling
<span class="nc" id="L2212">				boolean isFraud = ResponsibleGaming.respGaming(userBean, &quot;DG_SALE&quot;, totPurAmt + &quot;&quot;, con);</span>
<span class="nc bnc" id="L2213" title="All 2 branches missed.">				if (!isFraud) {</span>

<span class="nc" id="L2215">					balDed = orgOnLineSaleCreditUpdation.drawTcketSaleBalDeduction(userBean,</span>
							fortunePurchaseBean.getGameId(), fortunePurchaseBean.getTotalPurchaseAmt(),
							fortunePurchaseBean.getPlrMobileNumber(), con);
<span class="nc" id="L2218">					oldTotalPurchaseAmt = fortunePurchaseBean.getTotalPurchaseAmt();</span>

<span class="nc" id="L2220">					logger.debug(&quot;Total Purchase Amt inside DrawGameRPOSHelper Just Before  getting Success :&quot;</span>
							+ oldTotalPurchaseAmt);
<span class="nc" id="L2222">					logger.debug(&quot;Bal deduction inside DrawGameRPOSHelper Just Before  getting Success :&quot; + balDed);</span>
				} else {
<span class="nc" id="L2224">					logger.debug(&quot;Responsing Gaming not allowed to sale&quot;);</span>
<span class="nc" id="L2225">					fortunePurchaseBean.setSaleStatus(&quot;FRAUD&quot;);</span>
				}
<span class="nc" id="L2227">			} else {</span>

<span class="nc" id="L2229">				logger.debug(&quot;Data validation returns false&quot;);</span>
<span class="nc" id="L2230">				fortunePurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L2231">				return fortunePurchaseBean;</span>

			}
<span class="nc" id="L2234">		} catch (Exception e) {</span>

<span class="nc" id="L2236">			e.printStackTrace();</span>
<span class="nc" id="L2237">		}</span>

		try {
<span class="nc bnc" id="L2240" title="All 2 branches missed.">			if (balDed &gt; 0) {</span>
<span class="nc" id="L2241">				fortunePurchaseBean.setRefTransId(balDed + &quot;&quot;);</span>
<span class="nc" id="L2242">				fortunePurchaseBean.setPromotkt(false);</span>
<span class="nc" id="L2243">				sRes = delegate.getResponse(sReq);</span>

<span class="nc" id="L2245">				Type elementType = new TypeToken&lt;FortunePurchaseBean&gt;() {</span>
				}.getType();

<span class="nc bnc" id="L2248" title="All 2 branches missed.">				if (sRes.getIsSuccess()) {</span>
<span class="nc" id="L2249">					fortunePurchaseBean = new Gson().fromJson((JsonElement) sRes.getResponseData(), elementType);</span>
<span class="nc" id="L2250">					modifiedTotalPurchaseAmt = fortunePurchaseBean.getTotalPurchaseAmt();</span>
<span class="nc" id="L2251">					logger.debug(&quot;Total Purchase Amt inside DrawGameRPOSHelper After getting Success :&quot;</span>
							+ modifiedTotalPurchaseAmt);
<span class="nc" id="L2253">					con = DBConnect.getConnection();</span>
<span class="nc bnc" id="L2254" title="All 2 branches missed.">					if (oldTotalPurchaseAmt != modifiedTotalPurchaseAmt) {</span>
<span class="nc" id="L2255">						balDed = orgOnLineSaleCreditUpdation.drawTcketSaleBalDedUpdate(userBean,</span>
								fortunePurchaseBean.getGameId(), modifiedTotalPurchaseAmt, oldTotalPurchaseAmt, balDed,
								con);

					}
<span class="nc" id="L2260">					tickUpd = orgOnLineSaleCreditUpdation.drawTicketSaleTicketUpdate(balDed,</span>
							fortunePurchaseBean.getTicket_no(), fortunePurchaseBean.getGameId(), userBean,
							fortunePurchaseBean.getPurchaseChannel(), con);

<span class="nc bnc" id="L2264" title="All 2 branches missed.">					if (tickUpd == 1) {</span>
<span class="nc" id="L2265">						status = &quot;SUCCESS&quot;;</span>
<span class="nc" id="L2266">						fortunePurchaseBean.setSaleStatus(status);</span>
<span class="nc bnc" id="L2267" title="All 2 branches missed.">						if (!fortunePurchaseBean.getBarcodeType().equals(&quot;applet&quot;)) {</span>
<span class="nc" id="L2268">							IDBarcode.getBarcode(</span>
									fortunePurchaseBean.getTicket_no() + fortunePurchaseBean.getReprintCount());
						}
						// call promo purchase process here
<span class="nc" id="L2272">						List&lt;RafflePurchaseBean&gt; rafflePurchaseBeanList = new ArrayList&lt;RafflePurchaseBean&gt;();</span>

<span class="nc" id="L2274">						List&lt;PromoGameBean&gt; promoGameslist = Util.promoGameBeanMap</span>
								.get(fortunePurchaseBean.getGame_no());
						// String gameType =
						// getGameType(fortunePurchaseBean.getGame_no());
						// List&lt;PromoGameBean&gt; promoGameslist =
						// commonHelper.getAvailablePromoGames(gameType);

<span class="nc bnc" id="L2281" title="All 2 branches missed.">						for (int i = 0; i &lt; promoGameslist.size(); i++) {</span>
<span class="nc" id="L2282">							PromoGameBean promobean = promoGameslist.get(i);</span>
<span class="nc bnc" id="L2283" title="All 2 branches missed.">							if (promobean.getPromoGametype().equalsIgnoreCase(&quot;RAFFLE&quot;)) {</span>
<span class="nc" id="L2284">								fortunePurchaseBean.setRaffleNo(promobean.getPromoGameNo());</span>
<span class="nc" id="L2285">								RafflePurchaseBean rafflePurchaseBean = (RafflePurchaseBean) rafflePurchaseTicket(</span>
										userBean, fortunePurchaseBean, true);
<span class="nc" id="L2287">								rafflePurchaseBean.setRaffleTicketType(promobean.getPromoTicketType());</span>
<span class="nc bnc" id="L2288" title="All 2 branches missed.">								if (rafflePurchaseBean.getSaleStatus().equalsIgnoreCase(&quot;FAILED&quot;)) {</span>
<span class="nc" id="L2289">									status = &quot;FAILED&quot;;</span>
<span class="nc" id="L2290">									fortunePurchaseBean.setSaleStatus(status);</span>
									// Code for cancelling the Ticket to
									// be send to Draw Game Engine
<span class="nc" id="L2293">									cancelTicket(</span>
											fortunePurchaseBean.getTicket_no() + fortunePurchaseBean.getReprintCount(),
											fortunePurchaseBean.getPurchaseChannel(),
											fortunePurchaseBean.getDrawIdTableMap(), fortunePurchaseBean.getGameId(),
											fortunePurchaseBean.getPartyId(), fortunePurchaseBean.getPartyType(),
											fortunePurchaseBean.getRefMerchantId(), userBean,
											fortunePurchaseBean.getRefTransId());
<span class="nc" id="L2300">									fortunePurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L2301">									return fortunePurchaseBean;</span>
<span class="nc bnc" id="L2302" title="All 2 branches missed.">								} else if (rafflePurchaseBean.getSaleStatus().equalsIgnoreCase(&quot;SUCCESS&quot;)) {</span>
									// here insert entry into the promo
									// ticket mapping table
<span class="nc" id="L2305">									int tktlen = rafflePurchaseBean.getRaffleTicket_no().length();</span>
<span class="nc" id="L2306">									orgOnLineSaleCreditUpdation.drawTicketNPromoMappigUpdate(1,</span>
											rafflePurchaseBean.getGame_no(), rafflePurchaseBean.getParentTktNo(),
											rafflePurchaseBean.getRaffleTicket_no().substring(0, tktlen - 2));
<span class="nc" id="L2309">									rafflePurchaseBeanList.add(rafflePurchaseBean);</span>
								}
							}
						}

<span class="nc" id="L2314">						fortunePurchaseBean.setRafflePurchaseBeanList(rafflePurchaseBeanList);</span>
<span class="nc" id="L2315">						return fortunePurchaseBean;</span>
					} else {
<span class="nc" id="L2317">						status = &quot;FAILED&quot;;</span>

<span class="nc" id="L2319">						fortunePurchaseBean.setSaleStatus(status);</span>
						// Code for cancelling the Ticket to be send to
						// Draw
						// Game Engine
<span class="nc" id="L2323">						cancelTicket(fortunePurchaseBean.getTicket_no(), fortunePurchaseBean.getPurchaseChannel(),</span>
								fortunePurchaseBean.getDrawIdTableMap(), fortunePurchaseBean.getGameId(),
								fortunePurchaseBean.getPartyId(), fortunePurchaseBean.getPartyType(),
								fortunePurchaseBean.getRefMerchantId(), userBean, fortunePurchaseBean.getRefTransId());

<span class="nc" id="L2328">						return fortunePurchaseBean;</span>
					}

				} else {
<span class="nc" id="L2332">					fortunePurchaseBean = new Gson().fromJson((JsonElement) sRes.getResponseData(), elementType);</span>
<span class="nc bnc" id="L2333" title="All 2 branches missed.">					if (fortunePurchaseBean.getSaleStatus() == null) {</span>
<span class="nc" id="L2334">						fortunePurchaseBean.setSaleStatus(&quot;FAILED&quot;);// Error</span>
<span class="nc" id="L2335">						orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, fortunePurchaseBean.getGame_no(),</span>
								&quot;FAILED&quot;, balDed);
<span class="nc" id="L2337">						return fortunePurchaseBean;</span>
<span class="nc bnc" id="L2338" title="All 2 branches missed.">					} else if (&quot;ERROR_TICKET_LIMIT&quot;.equalsIgnoreCase(fortunePurchaseBean.getSaleStatus())) {</span>
<span class="nc" id="L2339">						orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, fortunePurchaseBean.getGame_no(),</span>
								&quot;FAILED&quot;, balDed);
<span class="nc" id="L2341">						return fortunePurchaseBean;</span>
					} else {
<span class="nc" id="L2343">						orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, fortunePurchaseBean.getGame_no(),</span>
								&quot;FAILED&quot;, balDed);
<span class="nc" id="L2345">						return fortunePurchaseBean;</span>
					}
				}
			} else {

<span class="nc" id="L2350">				status = getStatusIfErrorInTransaction(status, balDed);</span>
<span class="nc" id="L2351">				fortunePurchaseBean.setSaleStatus(status);</span>
<span class="nc" id="L2352">				return fortunePurchaseBean;</span>
			}
<span class="nc" id="L2354">		} catch (Exception e) {</span>
			// TODO: handle exception
		}
<span class="nc" id="L2357">		logger.debug(&quot;Inside Fortune FE*******&quot; + sRes);</span>
<span class="nc" id="L2358">		return fortunePurchaseBean;</span>
	}

	// new fortune game

	public FortuneTwoPurchaseBean fortuneTwoPurchaseTicket(UserInfoBean userBean,
			FortuneTwoPurchaseBean fortuneTwoPurchaseBean) throws Exception {

<span class="nc bnc" id="L2366" title="All 4 branches missed.">		if (isDrawAvailable(fortuneTwoPurchaseBean.getGame_no())</span>
				|| chkFreezeTimeSale(fortuneTwoPurchaseBean.getGame_no())) {
<span class="nc" id="L2368">			fortuneTwoPurchaseBean.setSaleStatus(&quot;NO_DRAWS&quot;);</span>
<span class="nc" id="L2369">			return fortuneTwoPurchaseBean;</span>
		}
<span class="nc" id="L2371">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L2372">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L2373">		sReq.setServiceName(ServiceName.FORTUNETWO);</span>
<span class="nc" id="L2374">		sReq.setServiceMethod(ServiceMethodName.FORTUNE_TWO_PURCHASE_TICKET);</span>
<span class="nc" id="L2375">		sReq.setServiceData(fortuneTwoPurchaseBean);</span>
<span class="nc" id="L2376">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L2377">		long balDed = 0;</span>
<span class="nc" id="L2378">		int tickUpd = 0;</span>
<span class="nc" id="L2379">		double oldTotalPurchaseAmt = 0.0;</span>
<span class="nc" id="L2380">		double modifiedTotalPurchaseAmt = 0.0;</span>
<span class="nc" id="L2381">		String status = &quot;&quot;;</span>
<span class="nc" id="L2382">		Connection con = null;</span>
		try {
<span class="nc bnc" id="L2384" title="All 2 branches missed.">			if (fortuneTwoDataValidation(fortuneTwoPurchaseBean)) {</span>
<span class="nc" id="L2385">				logger.debug(&quot;Data validation returns true&quot;);</span>
				// fortuneTwoPurchaseBean.setAdvMsg(Util.getAdvMessage(
				// userBean.getUserOrgId(), fortuneTwoPurchaseBean.getGame_no(),
				// &quot;PLAYER&quot;, &quot;SALE&quot;, &quot;DG&quot;));
<span class="nc" id="L2389">				fortuneTwoPurchaseBean.setAdvMsg(</span>
						Util.getDGSaleAdvMessage(userBean.getUserOrgId(), fortuneTwoPurchaseBean.getGame_no()));

<span class="nc" id="L2392">				fortuneTwoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L2393">				int noOfPanels = fortuneTwoPurchaseBean.getNoOfPanel();</span>
<span class="nc" id="L2394">				double totPurAmt = 0.0;</span>
<span class="nc" id="L2395">				con = DBConnect.getConnection();</span>
				// here insert the last sold tikcet on terminal or by third
				// party

<span class="nc bnc" id="L2399" title="All 2 branches missed.">				if (fortuneTwoPurchaseBean.getLastSoldTicketNo() != null) {</span>
<span class="nc bnc" id="L2400" title="All 2 branches missed.">					if (!&quot;0&quot;.equalsIgnoreCase(fortuneTwoPurchaseBean.getLastSoldTicketNo())) {</span>
<span class="nc" id="L2401">						Util.insertLastSoldTicketTeminal(fortuneTwoPurchaseBean.getUserId(),</span>
								fortuneTwoPurchaseBean.getLastSoldTicketNo(), fortuneTwoPurchaseBean.getGameId(), con);
					}
				}

<span class="nc" id="L2406">				double[] unitPriceArr = new double[noOfPanels];</span>
<span class="nc" id="L2407">				String playTypeArr[] = fortuneTwoPurchaseBean.getPlayType();</span>
<span class="nc" id="L2408">				int[] noOfLines = new int[noOfPanels];</span>
<span class="nc bnc" id="L2409" title="All 2 branches missed.">				for (int i = 0; i &lt; noOfPanels; i++) {</span>
<span class="nc" id="L2410">					String playType = playTypeArr[i];</span>
<span class="nc bnc" id="L2411" title="All 2 branches missed.">					if (playType.contains(&quot;Direct&quot;)) {</span>
<span class="nc" id="L2412">						noOfLines[i] = 1;</span>
<span class="nc bnc" id="L2413" title="All 2 branches missed.">					} else if (playType.contains(&quot;Banker&quot;)) {</span>
<span class="nc" id="L2414">						noOfLines[i] = 12;// for banker2 and banker3</span>
					}
<span class="nc" id="L2416">					totPurAmt += noOfLines[i]</span>
							* Util.getUnitPrice(fortuneTwoPurchaseBean.getGame_no(),
									fortuneTwoPurchaseBean.getPlayType()[i])
							* fortuneTwoPurchaseBean.getBetAmountMultiple()[i] * fortuneTwoPurchaseBean.getNoOfDraws();
<span class="nc" id="L2420">					unitPriceArr[i] = Util.getUnitPrice(fortuneTwoPurchaseBean.getGame_no(),</span>
							fortuneTwoPurchaseBean.getPlayType()[i]);
				}
<span class="nc" id="L2423">				logger.debug(&quot;calculated total purchase amt:&quot; + totPurAmt);</span>

				/*
				 * totPurAmt = fortuneTwoPurchaseBean.getTotalNoOfPanels()
				 * Util.getUnitPrice(fortuneTwoPurchaseBean.getGame_no(), null)
				 * fortuneTwoPurchaseBean.getNoOfDraws();
				 */

<span class="nc" id="L2431">				fortuneTwoPurchaseBean.setTotalPurchaseAmt(totPurAmt);</span>
<span class="nc" id="L2432">				fortuneTwoPurchaseBean.setUnitPrice(unitPriceArr);</span>
<span class="nc" id="L2433">				fortuneTwoPurchaseBean.setNoOfLines(noOfLines);</span>
<span class="nc bnc" id="L2434" title="All 2 branches missed.">				if (!userBean.getUserType().equals(&quot;RETAILER&quot;)) {</span>
<span class="nc" id="L2435">					return fortuneTwoPurchaseBean;</span>
				}

<span class="nc" id="L2438">				boolean isPromoAssociated = false;</span>

<span class="nc" id="L2440">				logger.debug(&quot;Inside Fortune two  FE1*******&quot;);</span>
				// rg calling
<span class="nc" id="L2442">				boolean isFraud = ResponsibleGaming.respGaming(userBean, &quot;DG_SALE&quot;, totPurAmt + &quot;&quot;, con);</span>
<span class="nc bnc" id="L2443" title="All 2 branches missed.">				if (!isFraud) {</span>

<span class="nc" id="L2445">					balDed = orgOnLineSaleCreditUpdation.drawTcketSaleBalDeduction(userBean,</span>
							fortuneTwoPurchaseBean.getGame_no(), fortuneTwoPurchaseBean.getTotalPurchaseAmt(),
							fortuneTwoPurchaseBean.getPlrMobileNumber(), con);
<span class="nc" id="L2448">					oldTotalPurchaseAmt = fortuneTwoPurchaseBean.getTotalPurchaseAmt();</span>

<span class="nc" id="L2450">					logger.debug(&quot;Total Purchase Amt inside DrawGameRPOSHelper Just Before  getting Success :&quot;</span>
							+ oldTotalPurchaseAmt);

<span class="nc" id="L2453">					logger.debug(&quot;Bal deduction inside DrawGameRPOSHelper Just Before  getting Success :&quot; + balDed);</span>
				} else {
<span class="nc" id="L2455">					logger.debug(&quot;Responsing Gaming not allowed to sale&quot;);</span>
<span class="nc" id="L2456">					fortuneTwoPurchaseBean.setSaleStatus(&quot;FRAUD&quot;);</span>
				}
<span class="nc" id="L2458">			} else {</span>

<span class="nc" id="L2460">				logger.debug(&quot;Data validation returns false&quot;);</span>
<span class="nc" id="L2461">				fortuneTwoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L2462">				return fortuneTwoPurchaseBean;</span>

			}
<span class="nc" id="L2465">		} catch (Exception e) {</span>

<span class="nc" id="L2467">			e.printStackTrace();</span>
<span class="nc" id="L2468">		}</span>

		try {
<span class="nc bnc" id="L2471" title="All 2 branches missed.">			if (balDed &gt; 0) {</span>
<span class="nc" id="L2472">				fortuneTwoPurchaseBean.setRefTransId(balDed + &quot;&quot;);</span>
<span class="nc" id="L2473">				fortuneTwoPurchaseBean.setPromotkt(false);</span>
<span class="nc" id="L2474">				sRes = delegate.getResponse(sReq);</span>

<span class="nc bnc" id="L2476" title="All 2 branches missed.">				if (sRes.getIsSuccess()) {</span>
<span class="nc" id="L2477">					fortuneTwoPurchaseBean = (FortuneTwoPurchaseBean) sRes.getResponseData();</span>
<span class="nc" id="L2478">					modifiedTotalPurchaseAmt = fortuneTwoPurchaseBean.getTotalPurchaseAmt();</span>
<span class="nc" id="L2479">					logger.debug(&quot;Total Purchase Amt inside DrawGameRPOSHelper After getting Success :&quot;</span>
							+ modifiedTotalPurchaseAmt);
<span class="nc" id="L2481">					con = DBConnect.getConnection();</span>
<span class="nc bnc" id="L2482" title="All 2 branches missed.">					if (oldTotalPurchaseAmt != modifiedTotalPurchaseAmt) {</span>
<span class="nc" id="L2483">						balDed = orgOnLineSaleCreditUpdation.drawTcketSaleBalDedUpdate(userBean,</span>
								fortuneTwoPurchaseBean.getGame_no(), modifiedTotalPurchaseAmt, oldTotalPurchaseAmt,
								balDed, con);

					}
<span class="nc" id="L2488">					tickUpd = orgOnLineSaleCreditUpdation.drawTicketSaleTicketUpdate(balDed,</span>
							fortuneTwoPurchaseBean.getTicket_no(), fortuneTwoPurchaseBean.getGame_no(), userBean,
							fortuneTwoPurchaseBean.getPurchaseChannel(), con);

<span class="nc bnc" id="L2492" title="All 2 branches missed.">					if (tickUpd == 1) {</span>
<span class="nc" id="L2493">						status = &quot;SUCCESS&quot;;</span>
<span class="nc" id="L2494">						fortuneTwoPurchaseBean.setSaleStatus(status);</span>
<span class="nc bnc" id="L2495" title="All 2 branches missed.">						if (!fortuneTwoPurchaseBean.getBarcodeType().equals(&quot;applet&quot;)) {</span>
<span class="nc" id="L2496">							IDBarcode.getBarcode(</span>
									fortuneTwoPurchaseBean.getTicket_no() + fortuneTwoPurchaseBean.getReprintCount());
						}
						// call promo purchase process here
<span class="nc" id="L2500">						List&lt;RafflePurchaseBean&gt; rafflePurchaseBeanList = new ArrayList&lt;RafflePurchaseBean&gt;();</span>

<span class="nc" id="L2502">						List&lt;PromoGameBean&gt; promoGameslist = Util.promoGameBeanMap</span>
								.get(fortuneTwoPurchaseBean.getGame_no());
						// String gameType =
						// getGameType(fortuneTwoPurchaseBean.getGame_no());
						// List&lt;PromoGameBean&gt; promoGameslist =
						// commonHelper.getAvailablePromoGames(gameType);

<span class="nc bnc" id="L2509" title="All 2 branches missed.">						for (int i = 0; i &lt; promoGameslist.size(); i++) {</span>
<span class="nc" id="L2510">							PromoGameBean promobean = promoGameslist.get(i);</span>
<span class="nc bnc" id="L2511" title="All 2 branches missed.">							if (promobean.getPromoGametype().equalsIgnoreCase(&quot;RAFFLE&quot;)) {</span>
<span class="nc" id="L2512">								fortuneTwoPurchaseBean.setRaffleNo(promobean.getPromoGameNo());</span>
<span class="nc" id="L2513">								RafflePurchaseBean rafflePurchaseBean = (RafflePurchaseBean) rafflePurchaseTicket(</span>
										userBean, fortuneTwoPurchaseBean, true);
<span class="nc" id="L2515">								rafflePurchaseBean.setRaffleTicketType(promobean.getPromoTicketType());</span>
<span class="nc bnc" id="L2516" title="All 2 branches missed.">								if (rafflePurchaseBean.getSaleStatus().equalsIgnoreCase(&quot;FAILED&quot;)) {</span>
<span class="nc" id="L2517">									status = &quot;FAILED&quot;;</span>
<span class="nc" id="L2518">									fortuneTwoPurchaseBean.setSaleStatus(status);</span>
									// Code for cancelling the Ticket to
									// be send to Draw Game Engine
<span class="nc" id="L2521">									cancelTicket(</span>
											fortuneTwoPurchaseBean.getTicket_no()
													+ fortuneTwoPurchaseBean.getReprintCount(),
											fortuneTwoPurchaseBean.getPurchaseChannel(),
											fortuneTwoPurchaseBean.getDrawIdTableMap(),
											fortuneTwoPurchaseBean.getGame_no(), fortuneTwoPurchaseBean.getPartyId(),
											fortuneTwoPurchaseBean.getPartyType(),
											fortuneTwoPurchaseBean.getRefMerchantId(), userBean,
											fortuneTwoPurchaseBean.getRefTransId());
<span class="nc" id="L2530">									fortuneTwoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L2531">									return fortuneTwoPurchaseBean;</span>
<span class="nc bnc" id="L2532" title="All 2 branches missed.">								} else if (rafflePurchaseBean.getSaleStatus().equalsIgnoreCase(&quot;SUCCESS&quot;)) {</span>
									// here insert entry into the promo
									// ticket mapping table
<span class="nc" id="L2535">									int tktlen = rafflePurchaseBean.getRaffleTicket_no().length();</span>
<span class="nc" id="L2536">									orgOnLineSaleCreditUpdation.drawTicketNPromoMappigUpdate(1,</span>
											rafflePurchaseBean.getGame_no(), rafflePurchaseBean.getParentTktNo(),
											rafflePurchaseBean.getRaffleTicket_no().substring(0, tktlen - 2));
<span class="nc" id="L2539">									rafflePurchaseBeanList.add(rafflePurchaseBean);</span>
								}
							}
						}

<span class="nc" id="L2544">						fortuneTwoPurchaseBean.setRafflePurchaseBeanList(rafflePurchaseBeanList);</span>
<span class="nc" id="L2545">						return fortuneTwoPurchaseBean;</span>
					} else {
<span class="nc" id="L2547">						status = &quot;FAILED&quot;;</span>

<span class="nc" id="L2549">						fortuneTwoPurchaseBean.setSaleStatus(status);</span>
						// Code for cancelling the Ticket to be send to
						// Draw
						// Game Engine
<span class="nc" id="L2553">						cancelTicket(fortuneTwoPurchaseBean.getTicket_no(), fortuneTwoPurchaseBean.getPurchaseChannel(),</span>
								fortuneTwoPurchaseBean.getDrawIdTableMap(), fortuneTwoPurchaseBean.getGame_no(),
								fortuneTwoPurchaseBean.getPartyId(), fortuneTwoPurchaseBean.getPartyType(),
								fortuneTwoPurchaseBean.getRefMerchantId(), userBean,
								fortuneTwoPurchaseBean.getRefTransId());

<span class="nc" id="L2559">						return fortuneTwoPurchaseBean;</span>
					}

				} else {
<span class="nc" id="L2563">					fortuneTwoPurchaseBean = (FortuneTwoPurchaseBean) sRes.getResponseData();</span>
<span class="nc bnc" id="L2564" title="All 2 branches missed.">					if (fortuneTwoPurchaseBean.getSaleStatus() == null) {</span>
<span class="nc" id="L2565">						fortuneTwoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);// Error</span>
<span class="nc" id="L2566">						orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, fortuneTwoPurchaseBean.getGame_no(),</span>
								&quot;FAILED&quot;, balDed);
<span class="nc" id="L2568">						return fortuneTwoPurchaseBean;</span>
<span class="nc bnc" id="L2569" title="All 2 branches missed.">					} else if (&quot;ERROR_TICKET_LIMIT&quot;.equalsIgnoreCase(fortuneTwoPurchaseBean.getSaleStatus())) {</span>
<span class="nc" id="L2570">						orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, fortuneTwoPurchaseBean.getGame_no(),</span>
								&quot;FAILED&quot;, balDed);
<span class="nc" id="L2572">						return fortuneTwoPurchaseBean;</span>
					} else {
<span class="nc" id="L2574">						orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, fortuneTwoPurchaseBean.getGame_no(),</span>
								&quot;FAILED&quot;, balDed);
<span class="nc" id="L2576">						return fortuneTwoPurchaseBean;</span>
					}
				}
			} else {

<span class="nc" id="L2581">				status = getStatusIfErrorInTransaction(status, balDed);</span>
<span class="nc" id="L2582">				fortuneTwoPurchaseBean.setSaleStatus(status);</span>
<span class="nc" id="L2583">				return fortuneTwoPurchaseBean;</span>
			}
<span class="nc" id="L2585">		} catch (Exception e) {</span>
			// TODO: handle exception
		}
<span class="nc" id="L2588">		return fortuneTwoPurchaseBean;</span>
	}

	// fortune three by sumit
	public FortuneThreePurchaseBean fortuneThreePurchaseTicket(UserInfoBean userBean,
			FortuneThreePurchaseBean fortuneThreePurchaseBean) throws Exception {

<span class="nc bnc" id="L2595" title="All 4 branches missed.">		if (isDrawAvailable(fortuneThreePurchaseBean.getGame_no())</span>
				|| chkFreezeTimeSale(fortuneThreePurchaseBean.getGame_no())) {
<span class="nc" id="L2597">			fortuneThreePurchaseBean.setSaleStatus(&quot;NO_DRAWS&quot;);</span>
<span class="nc" id="L2598">			return fortuneThreePurchaseBean;</span>
		}

<span class="nc" id="L2601">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L2602">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L2603">		sReq.setServiceName(ServiceName.FORTUNETHREE);</span>
<span class="nc" id="L2604">		sReq.setServiceMethod(ServiceMethodName.FORTUNE_THREE_PURCHASE_TICKET);</span>
<span class="nc" id="L2605">		sReq.setServiceData(fortuneThreePurchaseBean);</span>
<span class="nc" id="L2606">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L2607">		long balDed = 0;</span>
<span class="nc" id="L2608">		int tickUpd = 0;</span>
<span class="nc" id="L2609">		double oldTotalPurchaseAmt = 0.0;</span>
<span class="nc" id="L2610">		double modifiedTotalPurchaseAmt = 0.0;</span>
<span class="nc" id="L2611">		Connection con = null;</span>
<span class="nc" id="L2612">		String status = &quot;&quot;;</span>
		try {
<span class="nc bnc" id="L2614" title="All 2 branches missed.">			if (fortuneThreeDataValidation(fortuneThreePurchaseBean)) {</span>
<span class="nc" id="L2615">				logger.debug(&quot;Data validation returns true&quot;);</span>
				// fortuneThreePurchaseBean.setAdvMsg(Util.getAdvMessage(
				// userBean.getUserOrgId(),
				// fortuneThreePurchaseBean.getGame_no(),
				// &quot;PLAYER&quot;, &quot;SALE&quot;, &quot;DG&quot;));
<span class="nc" id="L2620">				fortuneThreePurchaseBean.setAdvMsg(</span>
						Util.getDGSaleAdvMessage(userBean.getUserOrgId(), fortuneThreePurchaseBean.getGame_no()));
<span class="nc" id="L2622">				con = DBConnect.getConnection();</span>
<span class="nc" id="L2623">				fortuneThreePurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>

				// here insert the last sold tikcet on terminal or by third
				// party

<span class="nc bnc" id="L2628" title="All 2 branches missed.">				if (fortuneThreePurchaseBean.getLastSoldTicketNo() != null) {</span>
<span class="nc bnc" id="L2629" title="All 2 branches missed.">					if (!&quot;0&quot;.equalsIgnoreCase(fortuneThreePurchaseBean.getLastSoldTicketNo())) {</span>
<span class="nc" id="L2630">						Util.insertLastSoldTicketTeminal(fortuneThreePurchaseBean.getUserId(),</span>
								fortuneThreePurchaseBean.getLastSoldTicketNo(), fortuneThreePurchaseBean.getGameId(),
								con);
					}
				}

<span class="nc" id="L2636">				int noOfPanels = fortuneThreePurchaseBean.getNoOfPanel();</span>
<span class="nc" id="L2637">				double totPurAmt = 0.0;</span>
<span class="nc" id="L2638">				double[] unitPriceArr = new double[noOfPanels];</span>
<span class="nc" id="L2639">				String playTypeArr[] = fortuneThreePurchaseBean.getPlayType();</span>
<span class="nc" id="L2640">				int[] noOfLines = new int[noOfPanels];</span>
<span class="nc bnc" id="L2641" title="All 2 branches missed.">				for (int i = 0; i &lt; noOfPanels; i++) {</span>
<span class="nc" id="L2642">					String playType = playTypeArr[i];</span>
<span class="nc bnc" id="L2643" title="All 2 branches missed.">					if (playType.contains(&quot;Direct&quot;)) {</span>
<span class="nc" id="L2644">						noOfLines[i] = 1;</span>
<span class="nc bnc" id="L2645" title="All 2 branches missed.">					} else if (playType.contains(&quot;Banker&quot;)) {</span>
<span class="nc" id="L2646">						noOfLines[i] = 12;// for banker2 and banker3</span>
					}
<span class="nc" id="L2648">					totPurAmt += noOfLines[i]</span>
							* Util.getUnitPrice(fortuneThreePurchaseBean.getGame_no(),
									fortuneThreePurchaseBean.getPlayType()[i])
							* fortuneThreePurchaseBean.getBetAmountMultiple()[i]
							* fortuneThreePurchaseBean.getNoOfDraws();
<span class="nc" id="L2653">					unitPriceArr[i] = Util.getUnitPrice(fortuneThreePurchaseBean.getGame_no(),</span>
							fortuneThreePurchaseBean.getPlayType()[i]);
				}
<span class="nc" id="L2656">				logger.debug(&quot;calculated total purchase amt:&quot; + totPurAmt);</span>

				/*
				 * totPurAmt = fortuneThreePurchaseBean.getTotalNoOfPanels()
				 * Util.getUnitPrice(fortuneThreePurchaseBean.getGame_no(),
				 * null) fortuneThreePurchaseBean.getNoOfDraws();
				 */

<span class="nc" id="L2664">				fortuneThreePurchaseBean.setTotalPurchaseAmt(totPurAmt);</span>
<span class="nc" id="L2665">				fortuneThreePurchaseBean.setUnitPrice(unitPriceArr);</span>
<span class="nc" id="L2666">				fortuneThreePurchaseBean.setNoOfLines(noOfLines);</span>
<span class="nc bnc" id="L2667" title="All 2 branches missed.">				if (!userBean.getUserType().equals(&quot;RETAILER&quot;)) {</span>
<span class="nc" id="L2668">					return fortuneThreePurchaseBean;</span>
				}

<span class="nc" id="L2671">				boolean isPromoAssociated = false;</span>

<span class="nc" id="L2673">				logger.debug(&quot;Inside Fortune three  FE1*******&quot;);</span>
				// rg calling
<span class="nc" id="L2675">				boolean isFraud = ResponsibleGaming.respGaming(userBean, &quot;DG_SALE&quot;, totPurAmt + &quot;&quot;);</span>
<span class="nc bnc" id="L2676" title="All 2 branches missed.">				if (!isFraud) {</span>

<span class="nc" id="L2678">					balDed = orgOnLineSaleCreditUpdation.drawTcketSaleBalDeduction(userBean,</span>
							fortuneThreePurchaseBean.getGame_no(), fortuneThreePurchaseBean.getTotalPurchaseAmt(),
							fortuneThreePurchaseBean.getPlrMobileNumber(), con);
<span class="nc" id="L2681">					oldTotalPurchaseAmt = fortuneThreePurchaseBean.getTotalPurchaseAmt();</span>

<span class="nc" id="L2683">					logger.debug(&quot;Total Purchase Amt inside DrawGameRPOSHelper Just Before  getting Success :&quot;</span>
							+ oldTotalPurchaseAmt);

<span class="nc" id="L2686">					logger.debug(&quot;Bal deduction inside DrawGameRPOSHelper Just Before  getting Success :&quot; + balDed);</span>
				} else {
<span class="nc" id="L2688">					logger.debug(&quot;Responsing Gaming not allowed to sale&quot;);</span>
<span class="nc" id="L2689">					fortuneThreePurchaseBean.setSaleStatus(&quot;FRAUD&quot;);</span>
				}
<span class="nc" id="L2691">			} else {</span>

<span class="nc" id="L2693">				logger.debug(&quot;Data validation returns false&quot;);</span>
<span class="nc" id="L2694">				fortuneThreePurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L2695">				return fortuneThreePurchaseBean;</span>

			}
<span class="nc" id="L2698">		} catch (Exception e) {</span>

<span class="nc" id="L2700">			e.printStackTrace();</span>
<span class="nc" id="L2701">		}</span>

		try {
<span class="nc bnc" id="L2704" title="All 2 branches missed.">			if (balDed &gt; 0) {</span>
<span class="nc" id="L2705">				fortuneThreePurchaseBean.setRefTransId(balDed + &quot;&quot;);</span>
<span class="nc" id="L2706">				fortuneThreePurchaseBean.setPromotkt(false);</span>
<span class="nc" id="L2707">				sRes = delegate.getResponse(sReq);</span>

<span class="nc bnc" id="L2709" title="All 2 branches missed.">				if (sRes.getIsSuccess()) {</span>
<span class="nc" id="L2710">					fortuneThreePurchaseBean = (FortuneThreePurchaseBean) sRes.getResponseData();</span>
<span class="nc" id="L2711">					modifiedTotalPurchaseAmt = fortuneThreePurchaseBean.getTotalPurchaseAmt();</span>
<span class="nc" id="L2712">					logger.debug(&quot;Total Purchase Amt inside DrawGameRPOSHelper After getting Success :&quot;</span>
							+ modifiedTotalPurchaseAmt);
<span class="nc" id="L2714">					con = DBConnect.getConnection();</span>
<span class="nc bnc" id="L2715" title="All 2 branches missed.">					if (oldTotalPurchaseAmt != modifiedTotalPurchaseAmt) {</span>
<span class="nc" id="L2716">						balDed = orgOnLineSaleCreditUpdation.drawTcketSaleBalDedUpdate(userBean,</span>
								fortuneThreePurchaseBean.getGame_no(), modifiedTotalPurchaseAmt, oldTotalPurchaseAmt,
								balDed, con);

					}
<span class="nc" id="L2721">					tickUpd = orgOnLineSaleCreditUpdation.drawTicketSaleTicketUpdate(balDed,</span>
							fortuneThreePurchaseBean.getTicket_no(), fortuneThreePurchaseBean.getGame_no(), userBean,
							fortuneThreePurchaseBean.getPurchaseChannel(), con);

<span class="nc bnc" id="L2725" title="All 2 branches missed.">					if (tickUpd == 1) {</span>
<span class="nc" id="L2726">						status = &quot;SUCCESS&quot;;</span>
<span class="nc" id="L2727">						fortuneThreePurchaseBean.setSaleStatus(status);</span>
<span class="nc bnc" id="L2728" title="All 2 branches missed.">						if (!fortuneThreePurchaseBean.getBarcodeType().equals(&quot;applet&quot;)) {</span>
<span class="nc" id="L2729">							IDBarcode.getBarcode(fortuneThreePurchaseBean.getTicket_no()</span>
									+ fortuneThreePurchaseBean.getReprintCount());
						}
						// call promo purchase process here
<span class="nc" id="L2733">						List&lt;RafflePurchaseBean&gt; rafflePurchaseBeanList = new ArrayList&lt;RafflePurchaseBean&gt;();</span>

<span class="nc" id="L2735">						List&lt;PromoGameBean&gt; promoGameslist = Util.promoGameBeanMap</span>
								.get(fortuneThreePurchaseBean.getGame_no());
						// String gameType =
						// getGameType(fortuneThreePurchaseBean.getGame_no());
						// List&lt;PromoGameBean&gt; promoGameslist =
						// commonHelper.getAvailablePromoGames(gameType);

<span class="nc bnc" id="L2742" title="All 2 branches missed.">						for (int i = 0; i &lt; promoGameslist.size(); i++) {</span>
<span class="nc" id="L2743">							PromoGameBean promobean = promoGameslist.get(i);</span>
<span class="nc bnc" id="L2744" title="All 2 branches missed.">							if (promobean.getPromoGametype().equalsIgnoreCase(&quot;RAFFLE&quot;)) {</span>
<span class="nc" id="L2745">								fortuneThreePurchaseBean.setRaffleNo(promobean.getPromoGameNo());</span>
<span class="nc" id="L2746">								RafflePurchaseBean rafflePurchaseBean = (RafflePurchaseBean) rafflePurchaseTicket(</span>
										userBean, fortuneThreePurchaseBean, true);
<span class="nc" id="L2748">								rafflePurchaseBean.setRaffleTicketType(promobean.getPromoTicketType());</span>
<span class="nc bnc" id="L2749" title="All 2 branches missed.">								if (rafflePurchaseBean.getSaleStatus().equalsIgnoreCase(&quot;FAILED&quot;)) {</span>
<span class="nc" id="L2750">									status = &quot;FAILED&quot;;</span>
<span class="nc" id="L2751">									fortuneThreePurchaseBean.setSaleStatus(status);</span>
									// Code for cancelling the Ticket to
									// be send to Draw Game Engine
<span class="nc" id="L2754">									cancelTicket(</span>
											fortuneThreePurchaseBean.getTicket_no()
													+ fortuneThreePurchaseBean.getReprintCount(),
											fortuneThreePurchaseBean.getPurchaseChannel(),
											fortuneThreePurchaseBean.getDrawIdTableMap(),
											fortuneThreePurchaseBean.getGame_no(),
											fortuneThreePurchaseBean.getPartyId(),
											fortuneThreePurchaseBean.getPartyType(),
											fortuneThreePurchaseBean.getRefMerchantId(), userBean,
											fortuneThreePurchaseBean.getRefTransId());
<span class="nc" id="L2764">									fortuneThreePurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L2765">									return fortuneThreePurchaseBean;</span>
<span class="nc bnc" id="L2766" title="All 2 branches missed.">								} else if (rafflePurchaseBean.getSaleStatus().equalsIgnoreCase(&quot;SUCCESS&quot;)) {</span>
									// here insert entry into the promo
									// ticket mapping table
<span class="nc" id="L2769">									int tktlen = rafflePurchaseBean.getRaffleTicket_no().length();</span>
<span class="nc" id="L2770">									orgOnLineSaleCreditUpdation.drawTicketNPromoMappigUpdate(1,</span>
											rafflePurchaseBean.getGame_no(), rafflePurchaseBean.getParentTktNo(),
											rafflePurchaseBean.getRaffleTicket_no().substring(0, tktlen - 2));
<span class="nc" id="L2773">									rafflePurchaseBeanList.add(rafflePurchaseBean);</span>
								}
							}
						}

<span class="nc" id="L2778">						fortuneThreePurchaseBean.setRafflePurchaseBeanList(rafflePurchaseBeanList);</span>
<span class="nc" id="L2779">						return fortuneThreePurchaseBean;</span>
					} else {
<span class="nc" id="L2781">						status = &quot;FAILED&quot;;</span>

<span class="nc" id="L2783">						fortuneThreePurchaseBean.setSaleStatus(status);</span>
						// Code for cancelling the Ticket to be send to
						// Draw
						// Game Engine
<span class="nc" id="L2787">						cancelTicket(fortuneThreePurchaseBean.getTicket_no(),</span>
								fortuneThreePurchaseBean.getPurchaseChannel(),
								fortuneThreePurchaseBean.getDrawIdTableMap(), fortuneThreePurchaseBean.getGame_no(),
								fortuneThreePurchaseBean.getPartyId(), fortuneThreePurchaseBean.getPartyType(),
								fortuneThreePurchaseBean.getRefMerchantId(), userBean,
								fortuneThreePurchaseBean.getRefTransId());

<span class="nc" id="L2794">						return fortuneThreePurchaseBean;</span>
					}

				} else {
<span class="nc" id="L2798">					fortuneThreePurchaseBean = (FortuneThreePurchaseBean) sRes.getResponseData();</span>
<span class="nc bnc" id="L2799" title="All 2 branches missed.">					if (fortuneThreePurchaseBean.getSaleStatus() == null) {</span>
<span class="nc" id="L2800">						fortuneThreePurchaseBean.setSaleStatus(&quot;FAILED&quot;);// Error</span>
<span class="nc" id="L2801">						orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean,</span>
								fortuneThreePurchaseBean.getGame_no(), &quot;FAILED&quot;, balDed);
<span class="nc" id="L2803">						return fortuneThreePurchaseBean;</span>
<span class="nc bnc" id="L2804" title="All 2 branches missed.">					} else if (&quot;ERROR_TICKET_LIMIT&quot;.equalsIgnoreCase(fortuneThreePurchaseBean.getSaleStatus())) {</span>
<span class="nc" id="L2805">						orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean,</span>
								fortuneThreePurchaseBean.getGame_no(), &quot;FAILED&quot;, balDed);
<span class="nc" id="L2807">						return fortuneThreePurchaseBean;</span>
					} else {
<span class="nc" id="L2809">						orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean,</span>
								fortuneThreePurchaseBean.getGame_no(), &quot;FAILED&quot;, balDed);
<span class="nc" id="L2811">						return fortuneThreePurchaseBean;</span>
					}
				}
			} else {

<span class="nc" id="L2816">				status = getStatusIfErrorInTransaction(status, balDed);</span>
<span class="nc" id="L2817">				fortuneThreePurchaseBean.setSaleStatus(status);</span>
<span class="nc" id="L2818">				return fortuneThreePurchaseBean;</span>
			}
<span class="nc" id="L2820">		} catch (Exception e) {</span>
			// TODO: handle exception
		}
<span class="nc" id="L2823">		return fortuneThreePurchaseBean;</span>
	}

	public TreeMap&lt;Integer, DrawWinningReportBean&gt; getDrawGameData() {
<span class="nc" id="L2827">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L2828">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L2829">		sReq.setServiceName(ServiceName.REPORTS_MGMT);</span>
<span class="nc" id="L2830">		sReq.setServiceMethod(ServiceMethodName.DRAWGAME_FETCH_GAMEDATA);</span>

<span class="nc" id="L2832">		sReq.setServiceData(LMSFilterDispatcher.isMachineEnabled);</span>

<span class="nc" id="L2834">		logger.debug(&quot;2222222222222222 sd&quot;);</span>
<span class="nc" id="L2835">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L2836">		sRes = delegate.getResponse(sReq);</span>

<span class="nc" id="L2838">		Type type = new TypeToken&lt;TreeMap&lt;Integer, DrawWinningReportBean&gt;&gt;() {</span>
		}.getType();

<span class="nc" id="L2841">		return (TreeMap&lt;Integer, DrawWinningReportBean&gt;) new Gson().fromJson((JsonElement) sRes.getResponseData(),</span>
				type);

		// return (TreeMap) sRes.getResponseData();
	}

	public int getGamenoFromTktnumber(String tktNum) {

<span class="nc" id="L2849">		int retIdLen = 0;</span>
<span class="nc" id="L2850">		int gameNo = 0;</span>
<span class="nc" id="L2851">		int tktLen = 0;</span>
<span class="nc" id="L2852">		String tktBuf = null;</span>

<span class="nc bnc" id="L2854" title="All 6 branches missed.">		if (tktNum != null &amp;&amp; (tktNum.length() == ConfigurationVariables.tktLenA</span>
				|| tktNum.length() == ConfigurationVariables.tktLenB)) {
<span class="nc bnc" id="L2856" title="All 2 branches missed.">			if (tktNum.length() == ConfigurationVariables.tktLenA) {</span>
<span class="nc" id="L2857">				tktLen = ConfigurationVariables.tktLenA;</span>
<span class="nc" id="L2858">				retIdLen = ConfigurationVariables.retIdLenA;</span>
<span class="nc" id="L2859">				tktBuf = tktNum.substring(retIdLen, retIdLen + ConfigurationVariables.gameNoLenA);</span>
<span class="nc bnc" id="L2860" title="All 2 branches missed.">			} else if (tktNum.length() == ConfigurationVariables.tktLenB) {</span>
<span class="nc" id="L2861">				tktLen = ConfigurationVariables.tktLenB;</span>
<span class="nc" id="L2862">				retIdLen = ConfigurationVariables.retIdLenB;</span>
<span class="nc" id="L2863">				tktBuf = tktNum.substring(retIdLen, retIdLen + ConfigurationVariables.gameNoLenB);</span>
			}
<span class="nc" id="L2865">			gameNo = Integer.parseInt(tktBuf);</span>
		}
<span class="nc" id="L2867">		return gameNo;</span>

	}

	public String getLastSoldTicketNO(UserInfoBean userInfoBean, String interfaceType) {
<span class="nc" id="L2872">		String ticketNum = null;</span>
<span class="nc" id="L2873">		String gameId = null;</span>
<span class="nc" id="L2874">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L2875">		String gameNoQry = &quot;select srtm.transaction_id,sdgm.game_id,interface from st_lms_retailer_transaction_master srtm,st_dg_game_master sdgm,st_lms_transaction_master tm where retailer_org_id=&quot;</span>
				+ userInfoBean.getUserOrgId()
				+ &quot; and srtm.game_id=sdgm.game_id and srtm.transaction_type like 'DG_%' and tm.transaction_id=srtm.transaction_id order by transaction_id desc limit 1&quot;;

		try {
<span class="nc" id="L2880">			Statement stm = con.createStatement();</span>
<span class="nc" id="L2881">			ResultSet rs = stm.executeQuery(gameNoQry);</span>
<span class="nc" id="L2882">			long txId = 0;</span>
<span class="nc" id="L2883">			String purchInterFace = &quot;&quot;;</span>
<span class="nc bnc" id="L2884" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L2885">				gameId = rs.getString(&quot;game_id&quot;);</span>
<span class="nc" id="L2886">				txId = rs.getLong(&quot;transaction_id&quot;);</span>
<span class="nc" id="L2887">				purchInterFace = rs.getString(&quot;interface&quot;);</span>
			}
<span class="nc bnc" id="L2889" title="All 2 branches missed.">			if (!interfaceType.equalsIgnoreCase(purchInterFace)) {</span>
<span class="nc" id="L2890">				return null;</span>
			}

			// need to get all data from this here
<span class="nc" id="L2894">			rs = stm.executeQuery(</span>
					&quot;select ticket_nbr,mrp_amt from st_dg_ret_sale_&quot; + gameId + &quot; where transaction_id=&quot; + txId);
<span class="nc bnc" id="L2896" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L2897">				ticketNum = rs.getString(&quot;ticket_nbr&quot;);</span>
<span class="nc" id="L2898">				double mrpAmount = 0.0;</span>
<span class="nc" id="L2899">				mrpAmount = rs.getDouble(&quot;mrp_amt&quot;);</span>
<span class="nc bnc" id="L2900" title="All 2 branches missed.">				if (mrpAmount &gt; 0) {</span>
					// it is sale ticket
				} else {
					// it is promo ticket go to the mapping table to get the
					// sale ticket
<span class="nc" id="L2905">					rs = stm.executeQuery(</span>
							&quot;select sale_ticket_nbr from ge_sale_promo_ticket_mapping where promo_ticket_nbr=&quot;
									+ ticketNum);
<span class="nc bnc" id="L2908" title="All 2 branches missed.">					if (rs.next()) {</span>
<span class="nc" id="L2909">						ticketNum = rs.getString(&quot;sale_ticket_nbr&quot;);</span>
					} else
<span class="nc" id="L2911">						ticketNum = null;</span>
				}

<span class="nc" id="L2914">			}</span>
<span class="nc" id="L2915">			logger.debug(&quot;ticket no is :::::::::&quot; + ticketNum);</span>
<span class="nc bnc" id="L2916" title="All 2 branches missed.">			if (ticketNum == null) {</span>
<span class="nc" id="L2917">				return null;</span>
			}
<span class="nc" id="L2919">		} catch (Exception e) {</span>
<span class="nc" id="L2920">			e.printStackTrace();</span>
<span class="nc" id="L2921">			return null;</span>
		} finally {
<span class="nc" id="L2923">			DBConnect.closeCon(con);</span>
<span class="nc" id="L2924">		}</span>

<span class="nc" id="L2926">		return ticketNum;</span>
	}

	public static String getRaffleTktTypeFromgameNbr(int gameId, Connection con) {
		Statement stm;
		try {
<span class="nc" id="L2932">			stm = con.createStatement();</span>
<span class="nc" id="L2933">			ResultSet rs = stm.executeQuery(&quot;select raffle_ticket_type from st_dg_game_master where game_id=&quot; + gameId);</span>
<span class="nc bnc" id="L2934" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L2935">				return rs.getString(1);</span>
			}
<span class="nc" id="L2937">		} catch (SQLException e) {</span>
			// TODO Auto-generated catch block
<span class="nc" id="L2939">			e.printStackTrace();</span>
<span class="nc" id="L2940">		}</span>
<span class="nc" id="L2941">		return null;</span>
	}

	public MainPWTDrawBean getTotalPWTTkeAmt(MainPWTDrawBean mainPwtBean, String highPrizeCriteria, String highPrizeAmt,
			Connection connection, UserInfoBean userInfoBean) throws LMSException {
		// here see the limits after adding both for draw and promo

<span class="nc" id="L2948">		double totalticketAmt = 0.0;</span>
<span class="nc" id="L2949">		List&lt;PWTDrawBean&gt; winningBeanList = mainPwtBean.getWinningBeanList();</span>

<span class="nc bnc" id="L2951" title="All 2 branches missed.">		for (int i = 0; i &lt; winningBeanList.size(); i++) {</span>
<span class="nc" id="L2952">			PWTDrawBean pwtBean = winningBeanList.get(i);</span>
<span class="nc" id="L2953">			totalticketAmt = totalticketAmt + pwtBean.getTotalAmount();</span>
		}

		// get the retailer PWT Limits
<span class="nc" id="L2957">		CommonFunctionsHelper commonFunction = new CommonFunctionsHelper();</span>
<span class="nc" id="L2958">		OrgPwtLimitBean orgPwtLimit = null;</span>
		try {
<span class="nc" id="L2960">			orgPwtLimit = commonFunction.fetchPwtLimitsOfOrgnization(userInfoBean.getUserOrgId(), connection);</span>
<span class="nc bnc" id="L2961" title="All 2 branches missed.">			if (orgPwtLimit == null) { // send mail to</span>
				// backoffice
<span class="nc" id="L2963">				throw new LMSException(&quot;PWT Limits Are Not defined Properly!!&quot;);</span>

			}
<span class="nc" id="L2966">		} catch (SQLException e) {</span>
<span class="nc" id="L2967">			e.printStackTrace();</span>
<span class="nc" id="L2968">		}</span>

<span class="nc bnc" id="L2970" title="All 2 branches missed.">		if (totalticketAmt &gt; 0) {</span>
<span class="nc bnc" id="L2971" title="All 2 branches missed.">			if (totalticketAmt &lt;= orgPwtLimit.getVerificationLimit()) {</span>
<span class="nc" id="L2972">				logger.debug(&quot;inside verification limit == &quot;);</span>
<span class="nc bnc" id="L2973" title="All 4 branches missed.">				boolean isHighPrizeFlag = highPrizeCriteria.equals(&quot;amt&quot;)</span>
						&amp;&amp; totalticketAmt &gt; Double.parseDouble(highPrizeAmt);
				// check for HIGH Prize Or is Approval Required

<span class="nc bnc" id="L2977" title="All 4 branches missed.">				if (totalticketAmt &lt; orgPwtLimit.getMinClaimPerTicket()</span>
						|| totalticketAmt &gt; orgPwtLimit.getMaxClaimPerTicket()) {
<span class="nc" id="L2979">					mainPwtBean.setStatus(&quot;OUT_ASSIGNED_LIMITS&quot;);</span>
<span class="nc bnc" id="L2980" title="All 4 branches missed.">				} else if (totalticketAmt &gt; orgPwtLimit.getApprovalLimit() || isHighPrizeFlag) {</span>
<span class="nc" id="L2981">					mainPwtBean.setStatus(&quot;HIGH_PRIZE&quot;);</span>

<span class="nc bnc" id="L2983" title="All 2 branches missed.">				} else if (totalticketAmt &lt;= orgPwtLimit.getPayLimit()) {</span>
<span class="nc" id="L2984">					mainPwtBean.setStatus(&quot;NORMAL_PAY&quot;);</span>

				} else {
<span class="nc" id="L2987">					mainPwtBean.setStatus(&quot;OUT_PAY_LIMIT&quot;);</span>
				}
<span class="nc" id="L2989">			} else {</span>
<span class="nc" id="L2990">				mainPwtBean.setStatus(&quot;OUT_VERIFY_LIMIT&quot;);</span>

			}
		}
<span class="nc" id="L2994">		mainPwtBean.setTotlticketAmount(totalticketAmt);</span>
<span class="nc" id="L2995">		return mainPwtBean;</span>
	}

	private boolean isDrawAvailable(int gameNo) {
<span class="fc" id="L2999">		return Util.drawIdTableMap.get(gameNo).isEmpty();</span>
	}

	public KenoPurchaseBean kenoPurchaseTicket(UserInfoBean userBean, KenoPurchaseBean kenoPurchaseBean)
			throws LMSException {
<span class="nc" id="L3004">		kenoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L3005">		Connection con = null;</span>
<span class="nc" id="L3006">		long balDed = 0;</span>
<span class="nc" id="L3007">		String status = &quot;&quot;;</span>
<span class="nc" id="L3008">		double oldTotalPurchaseAmt = 0.0;</span>
<span class="nc" id="L3009">		double modifiedTotalPurchaseAmt = 0.0;</span>
		// ServiceResponse sRes = new ServiceResponse();
<span class="nc" id="L3011">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L3012">		sReq.setServiceName(ServiceName.KENO_MGMT);</span>
<span class="nc" id="L3013">		sReq.setServiceMethod(ServiceMethodName.KENO_PURCHASE_TICKET);</span>
		// sReq.setServiceData(kenoPurchaseBean);
<span class="nc" id="L3015">		KenoRequestBean kenoRequestBean = new KenoRequestBean();</span>
<span class="nc" id="L3016">		sReq.setServiceData(kenoRequestBean);</span>
<span class="nc" id="L3017">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>

		try {
<span class="nc bnc" id="L3020" title="All 2 branches missed.">			if (checkDrawAvailability(kenoPurchaseBean.getGameId())) {</span>
<span class="nc" id="L3021">				kenoPurchaseBean.setSaleStatus(&quot;NO_DRAWS&quot;);</span>
<span class="nc" id="L3022">				return kenoPurchaseBean;</span>
			}
			// needs to be optimized in case of multiple validations
<span class="nc bnc" id="L3025" title="All 2 branches missed.">			if (!kenoValidateData(kenoPurchaseBean)) {</span>
				// logger.debug(&quot;Data Validation returned false&quot;);
<span class="nc" id="L3027">				return kenoPurchaseBean;</span>
			}

<span class="nc" id="L3030">			double totPurAmt = 0.0;</span>
<span class="nc" id="L3031">			int noOfPanel = kenoPurchaseBean.getNoOfPanel();</span>
<span class="nc" id="L3032">			String playTypeArr[] = kenoPurchaseBean.getPlayType();</span>
<span class="nc" id="L3033">			String[] noPickStr = kenoPurchaseBean.getNoPicked();</span>
<span class="nc" id="L3034">			int noOfLines[] = new int[noOfPanel];</span>
<span class="nc" id="L3035">			int betAmtMulArr[] = kenoPurchaseBean.getBetAmountMultiple();</span>
<span class="nc" id="L3036">			double unitPriceArr[] = new double[noOfPanel];</span>
<span class="nc bnc" id="L3037" title="All 2 branches missed.">			for (int i = 0; i &lt; noOfPanel; i++) {</span>
<span class="nc" id="L3038">				String playType = playTypeArr[i];</span>
<span class="nc" id="L3039">				String[] noPick = noPickStr[i].split(&quot;,&quot;);</span>
<span class="nc" id="L3040">				int[] n = new int[noPick.length];</span>
<span class="nc bnc" id="L3041" title="All 2 branches missed.">				for (int j = 0; j &lt; noPick.length; j++) {</span>
<span class="nc" id="L3042">					n[j] = Integer.parseInt(noPick[j]);</span>
				}
<span class="nc bnc" id="L3044" title="All 2 branches missed.">				if (playType.contains(&quot;Direct&quot;)) {</span>
<span class="nc" id="L3045">					noOfLines[i] = 1;</span>
<span class="nc bnc" id="L3046" title="All 2 branches missed.">				} else if (playType.equalsIgnoreCase(&quot;perm2&quot;)) {</span>
<span class="nc" id="L3047">					noOfLines[i] = n[0] * (n[0] - 1) / 2;</span>
<span class="nc bnc" id="L3048" title="All 2 branches missed.">				} else if (playType.equalsIgnoreCase(&quot;perm3&quot;)) {</span>
<span class="nc" id="L3049">					noOfLines[i] = n[0] * (n[0] - 1) * (n[0] - 2) / 6;</span>
<span class="nc bnc" id="L3050" title="All 2 branches missed.">				} else if (playType.equalsIgnoreCase(&quot;Banker1AgainstAll&quot;)) {</span>
<span class="nc" id="L3051">					noOfLines[i] = 89;</span>
<span class="nc bnc" id="L3052" title="All 2 branches missed.">				} else if (playType.equalsIgnoreCase(&quot;banker&quot;)) {</span>
<span class="nc" id="L3053">					noOfLines[i] = n[0] * n[1];</span>
				}

<span class="nc" id="L3056">				unitPriceArr[i] = Util.getUnitPrice(kenoPurchaseBean.getGameId(), playTypeArr[i]);</span>
				// logger.debug(&quot;----unitPrice--&quot; + unitPriceArr[i]);
				// logger.debug(&quot;----playTypeArr--&quot; + playTypeArr[i]);
<span class="nc" id="L3059">				totPurAmt += noOfLines[i] * unitPriceArr[i] * kenoPurchaseBean.getNoOfDraws() * betAmtMulArr[i];</span>
			}

<span class="nc" id="L3062">			kenoPurchaseBean.setUnitPrice(unitPriceArr);</span>

<span class="nc" id="L3064">			kenoPurchaseBean.setNoOfLines(noOfLines);</span>

			// logger.debug(&quot;Total Purchase Amount:&quot; + totPurAmt);

<span class="nc bnc" id="L3068" title="All 2 branches missed.">			if (totPurAmt &lt;= 0) {</span>
<span class="nc" id="L3069">				kenoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);// Error Draw</span>
<span class="nc" id="L3070">				return kenoPurchaseBean;</span>
			}
<span class="nc" id="L3072">			kenoPurchaseBean.setTotalPurchaseAmt(totPurAmt);</span>

<span class="nc" id="L3074">			con = getConnectionObject();</span>

<span class="nc" id="L3076">			int autoCancelHoldDays = Integer.parseInt(Utility.getPropertyValue(&quot;AUTO_CANCEL_CLOSER_DAYS&quot;));</span>
<span class="nc" id="L3077">			checkLastPrintedTicketStatusAndUpdate(userBean, Long.parseLong(kenoPurchaseBean.getLastSoldTicketNo()),</span>
					kenoPurchaseBean.getDeviceType(), kenoPurchaseBean.getRefMerchantId(), autoCancelHoldDays,
					kenoPurchaseBean.getActionName(), kenoPurchaseBean.getLastGameId(), con);

			// Add condition in single if method transfer in this method
			// checkLastPrintedTicketStatusAndUpdate in DrawgameRPOSHelper.java
			/*
			 * if(kenoPurchaseBean.getLastSoldTicketNo()!=null ){
			 * if(!&quot;0&quot;.equalsIgnoreCase(kenoPurchaseBean.getLastSoldTicketNo()))
			 * { //If below insertion throw an error or no row updated then stop
			 * sale
			 * Util.insertLastSoldTicketTeminal(kenoPurchaseBean.getUserId(),
			 * kenoPurchaseBean.getLastSoldTicketNo(),kenoPurchaseBean.getGameId
			 * (),con); } }
			 */

			// rg calling
<span class="nc" id="L3094">			boolean isFraud = ResponsibleGaming.respGaming(userBean, &quot;DG_SALE&quot;, totPurAmt + &quot;&quot;, con);</span>
<span class="nc bnc" id="L3095" title="All 2 branches missed.">			if (!isFraud) {</span>
<span class="nc" id="L3096">				balDed = orgOnLineSaleCreditUpdation.drawTcketSaleBalDeduction(userBean, kenoPurchaseBean.getGameId(),</span>
						kenoPurchaseBean.getTotalPurchaseAmt(), kenoPurchaseBean.getPlrMobileNumber(), con);
				// check valDed value for &gt;0 else return error
<span class="nc" id="L3099">				oldTotalPurchaseAmt = kenoPurchaseBean.getTotalPurchaseAmt();</span>
				/*
				 * logger
				 * .debug(&quot;Total Purchase Amt inside DrawGameRPOSHelper Just Before  getting Success :&quot;
				 * + oldTotalPurchaseAmt);
				 */
<span class="nc bnc" id="L3105" title="All 2 branches missed.">				if (balDed &gt; 0) {</span>
					// logger.debug(&quot;in keno if----------------&quot;);
<span class="nc" id="L3107">					kenoPurchaseBean.setRefTransId(balDed + &quot;&quot;);</span>
<span class="nc" id="L3108">					con.commit();</span>
				} else {

<span class="nc" id="L3111">					status = getStatusIfErrorInTransaction(status, balDed);</span>
<span class="nc" id="L3112">					kenoPurchaseBean.setSaleStatus(status);</span>
<span class="nc" id="L3113">					return kenoPurchaseBean;</span>
				}

			} else {
<span class="nc" id="L3117">				logger.debug(&quot;Responsing Gaming not allowed to sale&quot;);</span>
<span class="nc" id="L3118">				kenoPurchaseBean.setSaleStatus(&quot;FRAUD&quot;);</span>
<span class="nc" id="L3119">				return kenoPurchaseBean;</span>
			}

<span class="nc" id="L3122">		} catch (SQLException se) {</span>

<span class="nc" id="L3124">			se.printStackTrace();</span>
<span class="nc" id="L3125">			throw new LMSException();</span>
<span class="nc" id="L3126">		} catch (Exception e) {</span>
<span class="nc" id="L3127">			e.printStackTrace();</span>
<span class="nc" id="L3128">			throw new LMSException();</span>
		} finally {
<span class="nc" id="L3130">			DBConnect.closeCon(con);</span>
<span class="nc" id="L3131">		}</span>

		try {
<span class="nc" id="L3134">			kenoRequestBean.setBetAmountMultiple(kenoPurchaseBean.getBetAmountMultiple());</span>
<span class="nc" id="L3135">			kenoRequestBean.setDrawIdTableMap(kenoPurchaseBean.getDrawIdTableMap());</span>
<span class="nc" id="L3136">			kenoRequestBean.setDrawDateTime(kenoPurchaseBean.getDrawDateTime());</span>
<span class="nc" id="L3137">			kenoRequestBean.setGame_no(kenoPurchaseBean.getGame_no());</span>
<span class="nc" id="L3138">			kenoRequestBean.setGameId(kenoPurchaseBean.getGameId());</span>
<span class="nc" id="L3139">			kenoRequestBean.setIsAdvancedPlay(kenoPurchaseBean.getIsAdvancedPlay());</span>
<span class="nc" id="L3140">			kenoRequestBean.setIsQuickPick(kenoPurchaseBean.getIsQuickPick());</span>
<span class="nc" id="L3141">			kenoRequestBean.setNoOfDraws(kenoPurchaseBean.getNoOfDraws());</span>
<span class="nc" id="L3142">			kenoRequestBean.setNoPicked(kenoPurchaseBean.getNoPicked());</span>
<span class="nc" id="L3143">			kenoRequestBean.setPartyId(kenoPurchaseBean.getPartyId());</span>
<span class="nc" id="L3144">			kenoRequestBean.setPartyType(kenoPurchaseBean.getPartyType());</span>
<span class="nc" id="L3145">			kenoRequestBean.setPlayerData(kenoPurchaseBean.getPlayerData());</span>
<span class="nc" id="L3146">			kenoRequestBean.setPlayType(kenoPurchaseBean.getPlayType());</span>
<span class="nc" id="L3147">			kenoRequestBean.setPurchaseChannel(kenoPurchaseBean.getPurchaseChannel());</span>
<span class="nc" id="L3148">			kenoRequestBean.setRefMerchantId(kenoPurchaseBean.getRefMerchantId());</span>
<span class="nc" id="L3149">			kenoRequestBean.setRefTransId(kenoPurchaseBean.getRefTransId());</span>
<span class="nc" id="L3150">			kenoRequestBean.setUserId(kenoPurchaseBean.getUserId());</span>
<span class="nc" id="L3151">			kenoRequestBean.setUserMappingId(kenoPurchaseBean.getUserMappingId());</span>
<span class="nc" id="L3152">			kenoRequestBean.setServiceId(kenoPurchaseBean.getServiceId());</span>
<span class="nc" id="L3153">			kenoRequestBean.setPromotkt(kenoPurchaseBean.isPromotkt());</span>
<span class="nc" id="L3154">			kenoRequestBean.setUnitPrice(kenoPurchaseBean.getUnitPrice());</span>
<span class="nc" id="L3155">			kenoRequestBean.setTotalPurchaseAmt(kenoPurchaseBean.getTotalPurchaseAmt());</span>

			/*
			 * sRes = delegate.getResponse(sReq); String responseString =
			 * sRes.getResponseData().toString(); Type elementType = new
			 * TypeToken&lt;KenoPurchaseBean&gt;(){}.getType();
			 */
<span class="nc" id="L3162">			String responseString = delegate.getResponseString(sReq);</span>
<span class="nc" id="L3163">			KenoResponseBean kenoResponseBean = new Gson().fromJson(responseString, KenoResponseBean.class);</span>

<span class="nc bnc" id="L3165" title="All 2 branches missed.">			if (kenoResponseBean.getIsSuccess()) {</span>
<span class="nc" id="L3166">				setKenoTwoDGEResponseData(kenoPurchaseBean, kenoResponseBean);</span>

				// kenoPurchaseBean = new Gson().fromJson(responseString,
				// elementType);
<span class="nc" id="L3170">				modifiedTotalPurchaseAmt = kenoPurchaseBean.getTotalPurchaseAmt();</span>
<span class="nc" id="L3171">				con = getConnectionObject();</span>
<span class="nc bnc" id="L3172" title="All 2 branches missed.">				if (oldTotalPurchaseAmt != modifiedTotalPurchaseAmt) {</span>

<span class="nc" id="L3174">					balDed = orgOnLineSaleCreditUpdation.drawTcketSaleBalDedUpdate(userBean,</span>
							kenoPurchaseBean.getGameId(), modifiedTotalPurchaseAmt, oldTotalPurchaseAmt, balDed, con);

				}

<span class="nc" id="L3179">				int tickUpd = orgOnLineSaleCreditUpdation.drawTicketSaleTicketUpdate(balDed,</span>
						kenoPurchaseBean.getTicket_no(), kenoPurchaseBean.getGameId(), userBean,
						kenoPurchaseBean.getPurchaseChannel(), con);

<span class="nc bnc" id="L3183" title="All 2 branches missed.">				if (tickUpd == 1) {</span>
<span class="nc" id="L3184">					AjaxRequestHelper ajxHelper = new AjaxRequestHelper();</span>
<span class="nc" id="L3185">					ajxHelper.getAvlblCreditAmt(userBean, con);</span>
					// kenoPurchaseBean.setAdvMsg(Util.getAdvMessage(userBean.getUserOrgId(),
					// kenoPurchaseBean.getGame_no(), &quot;PLAYER&quot;, &quot;SALE&quot;, &quot;DG&quot;));
<span class="nc" id="L3188">					kenoPurchaseBean</span>
							.setAdvMsg(Util.getDGSaleAdvMessage(userBean.getUserOrgId(), kenoPurchaseBean.getGameId()));

<span class="nc" id="L3191">					status = &quot;SUCCESS&quot;;</span>
<span class="nc" id="L3192">					kenoPurchaseBean.setSaleStatus(status);</span>
<span class="nc bnc" id="L3193" title="All 2 branches missed.">					if (!&quot;applet&quot;.equals(kenoPurchaseBean.getBarcodeType())) {</span>
<span class="nc" id="L3194">						IDBarcode.getBarcode(kenoPurchaseBean.getTicket_no() + kenoPurchaseBean.getReprintCount());</span>
					}
<span class="nc" id="L3196">					con.commit();</span>

<span class="nc" id="L3198">					return kenoPurchaseBean;</span>
				} else {
					// con.rollback();
					// DBConnect.closeCon(con);

<span class="nc" id="L3203">					status = &quot;FAILED&quot;;</span>
<span class="nc" id="L3204">					kenoPurchaseBean.setSaleStatus(status);</span>
					// Code for cancelling the Ticket to be send to Draw
					// Game Engine
<span class="nc" id="L3207">					cancelTicket(kenoPurchaseBean.getTicket_no() + kenoPurchaseBean.getReprintCount(),</span>
							kenoPurchaseBean.getPurchaseChannel(), kenoPurchaseBean.getDrawIdTableMap(),
							kenoPurchaseBean.getGame_no(), kenoPurchaseBean.getPartyId(),
							kenoPurchaseBean.getPartyType(), kenoPurchaseBean.getRefMerchantId(), userBean,
							kenoPurchaseBean.getRefTransId());

<span class="nc" id="L3213">					return kenoPurchaseBean;</span>
				}
			} else {
				// kenoPurchaseBean = new Gson().fromJson(responseString,
				// elementType);
<span class="nc bnc" id="L3218" title="All 2 branches missed.">				if (kenoPurchaseBean.getSaleStatus() == null) {</span>
<span class="nc" id="L3219">					kenoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);// Error</span>
<span class="nc" id="L3220">					orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, kenoPurchaseBean.getGame_no(), &quot;FAILED&quot;,</span>
							balDed);
<span class="nc" id="L3222">					return kenoPurchaseBean;</span>
<span class="nc bnc" id="L3223" title="All 2 branches missed.">				} else if (&quot;ERROR_TICKET_LIMIT&quot;.equalsIgnoreCase(kenoPurchaseBean.getSaleStatus())) {</span>
<span class="nc" id="L3224">					orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, kenoPurchaseBean.getGame_no(), &quot;FAILED&quot;,</span>
							balDed);
<span class="nc" id="L3226">					return kenoPurchaseBean;</span>
				} else {
<span class="nc" id="L3228">					orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, kenoPurchaseBean.getGame_no(), &quot;FAILED&quot;,</span>
							balDed);
<span class="nc" id="L3230">					return kenoPurchaseBean;</span>
				}
			}
<span class="nc" id="L3233">		} catch (Exception se) {</span>
<span class="nc" id="L3234">			se.printStackTrace();</span>
<span class="nc bnc" id="L3235" title="All 2 branches missed.">			if (kenoPurchaseBean.getSaleStatus() == null) {</span>
<span class="nc" id="L3236">				kenoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);// Error</span>
<span class="nc" id="L3237">				orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, kenoPurchaseBean.getGame_no(), &quot;FAILED&quot;,</span>
						balDed);
			} else {
<span class="nc" id="L3240">				orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, kenoPurchaseBean.getGame_no(), &quot;FAILED&quot;,</span>
						balDed);
			}
		} finally {
<span class="nc" id="L3244">			DBConnect.closeCon(con);</span>
<span class="nc" id="L3245">		}</span>
<span class="nc" id="L3246">		return kenoPurchaseBean;</span>
	}

	public boolean kenoValidateData(KenoPurchaseBean kenoPurchaseBean) {// this
																		// method
																		// needs
																		// to be
																		// updated
																		// later
<span class="nc bnc" id="L3255" title="All 2 branches missed.">		if (kenoPurchaseBean != null) {</span>
<span class="nc bnc" id="L3256" title="All 2 branches missed.">			if (kenoPurchaseBean.getNoOfDraws() &lt; 1) {</span>
<span class="nc" id="L3257">				logger.debug(&quot;insufficient no of draws&quot;);</span>
<span class="nc" id="L3258">				return false;</span>
			}
<span class="nc bnc" id="L3260" title="All 2 branches missed.">			if (kenoPurchaseBean.getNoOfPanel() &lt; 1) {</span>
<span class="nc" id="L3261">				logger.debug(&quot;insufficient no of panels&quot;);</span>
<span class="nc" id="L3262">				return false;</span>
			}

			// Kenya project is not in operation
			// boolean isKenya =
			// &quot;Kenya&quot;.equalsIgnoreCase((String)LMSUtility.sc.getAttribute(&quot;COUNTRY_DEPLOYED&quot;));
<span class="nc" id="L3268">			int noOfPanel = kenoPurchaseBean.getNoOfPanel();</span>
<span class="nc" id="L3269">			String playTypeArr[] = kenoPurchaseBean.getPlayType();</span>
			// String[] noPickStr = kenoPurchaseBean.getNoPicked();
			// String[] pickedNumbers = kenoPurchaseBean.getPlayerData();
<span class="nc" id="L3272">			int[] qp = kenoPurchaseBean.getIsQuickPick();</span>
			/*
			 * for (int i = 0; i &lt; noOfPanel; i++) { String playType =
			 * playTypeArr[i]; String[] noPick = noPickStr[i].split(&quot;,&quot;); int[]
			 * n = new int[noPick.length]; for (int j = 0; j &lt; noPick.length;
			 * j++) { n[j] = Integer.parseInt(noPick[j]); }
			 * if(!&quot;QP&quot;.equalsIgnoreCase(pickedNumbers[i])){ if
			 * (playType.contains(&quot;Direct1&quot;)) { if(n[0]!=1 || qp[i]!=2 ||
			 * pickedNumbers[i].split(&quot;,&quot;).length !=1 ){ return false; } } else
			 * if (playType.equalsIgnoreCase(&quot;Direct2&quot;)) { if(n[0]!=2 ||
			 * qp[i]!=2 || pickedNumbers[i].split(&quot;,&quot;).length !=2 ){ return
			 * false; } }else if (playType.equalsIgnoreCase(&quot;Direct3&quot;)) {
			 * if(n[0]!=3 || qp[i]!=2 || pickedNumbers[i].split(&quot;,&quot;).length !=3
			 * ){ return false; } } else if
			 * (playType.equalsIgnoreCase(&quot;Direct4&quot;)) { if(n[0]!=4 || qp[i]!=2
			 * || pickedNumbers[i].split(&quot;,&quot;).length !=4 ){ return false; }
			 * 
			 * } else if (playType.equalsIgnoreCase(&quot;Direct5&quot;)) { if(n[0]!=5 ||
			 * qp[i]!=2 || pickedNumbers[i].split(&quot;,&quot;).length !=5 ){ return
			 * false; }
			 * 
			 * } else if (playType.equalsIgnoreCase(&quot;Perm2&quot;)) { //if(!isKenya){
			 * if(n[0]&lt;3 || qp[i]!=2 || pickedNumbers[i].split(&quot;,&quot;).length &lt;3 ){
			 * return false; } //} } else if
			 * (playType.equalsIgnoreCase(&quot;Perm3&quot;)) { if(n[0]&lt;4 || qp[i]!=2 ||
			 * pickedNumbers[i].split(&quot;,&quot;).length &lt;4 ){ return false; }
			 * 
			 * } }else{ if (playType.contains(&quot;Direct1&quot;)) { if(n[0]!=1 ||
			 * qp[i]!=1){ return false; } } else if
			 * (playType.equalsIgnoreCase(&quot;Direct2&quot;)) { if(n[0]!=2 || qp[i]!=1
			 * ){ return false; } }else if
			 * (playType.equalsIgnoreCase(&quot;Direct3&quot;)) { if(n[0]!=3 || qp[i]!=1
			 * ){ return false; } } else if
			 * (playType.equalsIgnoreCase(&quot;Direct4&quot;)) { if(n[0]!=4 || qp[i]!=1
			 * ){ return false; }
			 * 
			 * } else if (playType.equalsIgnoreCase(&quot;Direct5&quot;)) { if(n[0]!=5 ||
			 * qp[i]!=1 ){ return false; }
			 * 
			 * } else if (playType.equalsIgnoreCase(&quot;Perm2&quot;)) { if(n[0]&lt;3 ||
			 * qp[i]!=1 ){ return false; }
			 * 
			 * } else if (playType.equalsIgnoreCase(&quot;Perm3&quot;)) { if(n[0]&lt;4 ||
			 * qp[i]!=1 ){ return false; }
			 * 
			 * } }
			 * 
			 * 
			 * }
			 */

<span class="nc" id="L3323">			boolean isValid = true;</span>
<span class="nc" id="L3324">			String[] pickedNumbersArr = kenoPurchaseBean.getPlayerData();</span>
			// int noOfPanel = pickedNumbersArr.length;
<span class="nc" id="L3326">			String[] noPickedArr = kenoPurchaseBean.getNoPicked();</span>
<span class="nc bnc" id="L3327" title="All 2 branches missed.">			for (int i = 0; i &lt; noOfPanel; i++) {</span>

<span class="nc" id="L3329">				String playerData = pickedNumbersArr[i];</span>

<span class="nc bnc" id="L3331" title="All 2 branches missed.">				if (!&quot;QP&quot;.equals(playerData)) {</span>
<span class="nc bnc" id="L3332" title="All 4 branches missed.">					if (playTypeArr[i].contains(&quot;Direct&quot;) || &quot;Banker1AgainstAll&quot;.equals(playTypeArr[i])) {</span>
<span class="nc" id="L3333">						int pickValue = KenoConstants.BET_TYPE_MAP.get(playTypeArr[i]);</span>
<span class="nc bnc" id="L3334" title="All 6 branches missed.">						if (qp[i] != 2 || playerData.split(&quot;,&quot;).length != pickValue</span>
								|| Integer.parseInt(noPickedArr[i]) != pickValue) {
<span class="nc" id="L3336">							isValid = false;</span>
<span class="nc" id="L3337">							break;</span>
						}
						/*
						 * isValid = noPickedArr[i].equals(pickValue);
						 * logger.debug(&quot;-Direct---&quot; + playTypeArr[i] + &quot;---&quot; +
						 * noPickedArr[i]); if (!isValid) { break; }
						 */
<span class="nc bnc" id="L3344" title="All 2 branches missed.">					} else if (playTypeArr[i].contains(&quot;Perm&quot;)) {</span>
<span class="nc" id="L3345">						int minPickValue = KenoConstants.BET_TYPE_MAP.get(playTypeArr[i] + &quot;MIN&quot;);</span>
<span class="nc" id="L3346">						int maxPickValue = KenoConstants.BET_TYPE_MAP.get(playTypeArr[i] + &quot;MAX&quot;);</span>
<span class="nc" id="L3347">						int selPick = Integer.parseInt(noPickedArr[i]);</span>
<span class="nc" id="L3348">						logger.debug(&quot;-Perm---&quot; + playTypeArr[i] + &quot;---&quot; + noPickedArr[i]);</span>
<span class="nc bnc" id="L3349" title="All 10 branches missed.">						if (qp[i] != 2 || minPickValue &gt; playerData.split(&quot;,&quot;).length</span>
								|| maxPickValue &lt; playerData.split(&quot;,&quot;).length || minPickValue &gt; selPick
								|| maxPickValue &lt; selPick) {
<span class="nc" id="L3352">							isValid = false;</span>
<span class="nc" id="L3353">							break;</span>
						}
<span class="nc bnc" id="L3355" title="All 2 branches missed.">					} else if (&quot;Banker&quot;.equals(playTypeArr[i])) {</span>
<span class="nc" id="L3356">						logger.debug(&quot;-Banker---&quot; + playTypeArr[i] + &quot;---&quot; + noPickedArr[i]);</span>

<span class="nc" id="L3358">						int minULPickValue = KenoConstants.BET_TYPE_MAP.get(playTypeArr[i] + &quot;ULMIN&quot;);</span>
<span class="nc" id="L3359">						int maxULPickValue = KenoConstants.BET_TYPE_MAP.get(playTypeArr[i] + &quot;ULMAX&quot;);</span>
<span class="nc" id="L3360">						int minBLPickValue = KenoConstants.BET_TYPE_MAP.get(playTypeArr[i] + &quot;BLMIN&quot;);</span>
<span class="nc" id="L3361">						int maxBLPickValue = KenoConstants.BET_TYPE_MAP.get(playTypeArr[i] + &quot;BLMAX&quot;);</span>
<span class="nc" id="L3362">						String selPick[] = noPickedArr[i].split(&quot;,&quot;);</span>
<span class="nc" id="L3363">						int selUL = Integer.parseInt(selPick[0]);</span>
<span class="nc" id="L3364">						int selBL = Integer.parseInt(selPick[1]);</span>

<span class="nc" id="L3366">						int pickedUL = playerData.substring(0, playerData.indexOf(&quot;,UL,&quot;)).split(&quot;,&quot;).length;</span>
<span class="nc" id="L3367">						int pickedBL = playerData.substring(playerData.indexOf(&quot;,UL,&quot;) + 4, playerData.indexOf(&quot;,BL&quot;))</span>
								.split(&quot;,&quot;).length;

						// for upper line &amp; below line
<span class="nc bnc" id="L3371" title="All 18 branches missed.">						if (qp[i] != 2 || minULPickValue &gt; pickedUL || maxULPickValue &lt; pickedUL</span>
								|| minBLPickValue &gt; pickedBL || maxBLPickValue &lt; pickedBL || minULPickValue &gt; selUL
								|| maxULPickValue &lt; selUL || minBLPickValue &gt; selBL || maxBLPickValue &lt; selBL) {
<span class="nc" id="L3374">							isValid = false;</span>
<span class="nc" id="L3375">							break;</span>
						}
					}
<span class="nc" id="L3378">					isValid = Util.validateNumber(KenoConstants.START_RANGE, KenoConstants.END_RANGE,</span>
							playerData.replace(&quot;,UL,&quot;, &quot;,&quot;).replace(&quot;,BL&quot;, &quot;&quot;), false);
<span class="nc" id="L3380">					logger.debug(&quot;-Data---&quot; + playTypeArr[i] + &quot;---&quot; + noPickedArr[i] + &quot;---&quot; + playerData);</span>
<span class="nc bnc" id="L3381" title="All 2 branches missed.">					if (!isValid) {</span>
<span class="nc" id="L3382">						break;</span>
					}
				} else {
<span class="nc bnc" id="L3385" title="All 4 branches missed.">					if (playTypeArr[i].contains(&quot;Direct&quot;) || &quot;Banker1AgainstAll&quot;.equals(playTypeArr[i])) {</span>
<span class="nc" id="L3386">						int pickValue = KenoConstants.BET_TYPE_MAP.get(playTypeArr[i]);</span>
<span class="nc bnc" id="L3387" title="All 4 branches missed.">						if (qp[i] != 1 || Integer.parseInt(noPickedArr[i]) != pickValue) {</span>
<span class="nc" id="L3388">							isValid = false;</span>
<span class="nc" id="L3389">							break;</span>
						}
						/*
						 * isValid = noPickedArr[i].equals(pickValue);
						 * logger.debug(&quot;-Direct---&quot; + playTypeArr[i] + &quot;---&quot; +
						 * noPickedArr[i]); if (!isValid) { break; }
						 */
<span class="nc bnc" id="L3396" title="All 2 branches missed.">					} else if (playTypeArr[i].contains(&quot;Perm&quot;)) {</span>
<span class="nc" id="L3397">						int minPickValue = KenoConstants.BET_TYPE_MAP.get(playTypeArr[i] + &quot;MIN&quot;);</span>
<span class="nc" id="L3398">						int maxPickValue = KenoConstants.BET_TYPE_MAP.get(playTypeArr[i] + &quot;MAX&quot;);</span>
<span class="nc" id="L3399">						int selPick = Integer.parseInt(noPickedArr[i]);</span>
<span class="nc" id="L3400">						logger.debug(&quot;-Perm---&quot; + playTypeArr[i] + &quot;---&quot; + noPickedArr[i]);</span>
<span class="nc bnc" id="L3401" title="All 6 branches missed.">						if (qp[i] != 1 || minPickValue &gt; selPick || maxPickValue &lt; selPick) {</span>
<span class="nc" id="L3402">							isValid = false;</span>
<span class="nc" id="L3403">							break;</span>
						}
<span class="nc bnc" id="L3405" title="All 2 branches missed.">					} else if (&quot;Banker&quot;.equals(playTypeArr[i])) {</span>
<span class="nc" id="L3406">						logger.debug(&quot;-Banker---&quot; + playTypeArr[i] + &quot;---&quot; + noPickedArr[i]);</span>

<span class="nc" id="L3408">						int minULPickValue = KenoConstants.BET_TYPE_MAP.get(playTypeArr[i] + &quot;ULMIN&quot;);</span>
<span class="nc" id="L3409">						int maxULPickValue = KenoConstants.BET_TYPE_MAP.get(playTypeArr[i] + &quot;ULMAX&quot;);</span>
<span class="nc" id="L3410">						int minBLPickValue = KenoConstants.BET_TYPE_MAP.get(playTypeArr[i] + &quot;BLMIN&quot;);</span>
<span class="nc" id="L3411">						int maxBLPickValue = KenoConstants.BET_TYPE_MAP.get(playTypeArr[i] + &quot;BLMAX&quot;);</span>
<span class="nc" id="L3412">						String selPick[] = noPickedArr[i].split(&quot;,&quot;);</span>
<span class="nc" id="L3413">						int selUL = Integer.parseInt(selPick[0]);</span>
<span class="nc" id="L3414">						int selBL = Integer.parseInt(selPick[1]);</span>

						// for upper line &amp; below line
<span class="nc bnc" id="L3417" title="All 10 branches missed.">						if (qp[i] != 1 || minULPickValue &gt; selUL || maxULPickValue &lt; selUL || minBLPickValue &gt; selBL</span>
								|| maxBLPickValue &lt; selBL) {
<span class="nc" id="L3419">							isValid = false;</span>
<span class="nc" id="L3420">							break;</span>
						}
					}
				}
			}

<span class="nc bnc" id="L3426" title="All 2 branches missed.">			if (!isValid) {</span>
<span class="nc" id="L3427">				kenoPurchaseBean.setSaleStatus(&quot;INVALID_INPUT&quot;);// Error Draw</span>
				// setKenoPurchaseBean(kenoPurchaseBean);
<span class="nc" id="L3429">				logger.error(&quot;-----------Keno Validation Error-------------------&quot; + kenoPurchaseBean.getSaleStatus());</span>
<span class="nc" id="L3430">				return false;</span>
			}

<span class="nc" id="L3433">		} else {</span>
<span class="nc" id="L3434">			logger.debug(&quot;keno bean null&quot;);</span>
<span class="nc" id="L3435">			return false;</span>
		}
<span class="nc" id="L3437">		return true;</span>
		/*
		 * if (kenoPurchaseBean != null) { int noOfDraws =
		 * kenoPurchaseBean.getNoOfDraws(); if (noOfDraws &lt; 1) {
		 * logger.debug(&quot;insufficient no of draws&quot;); }
		 * 
		 * String pickedNumbers = kenoPurchaseBean.getPlayerData(); if
		 * (pickedNumbers == null) { logger.debug(&quot;invalid data&quot;); } else {
		 * List&lt;String&gt; pickData = Arrays.asList(pickedNumbers.split(&quot;,&quot;));
		 * String playType = kenoPurchaseBean.getPlayType();
		 * 
		 * if (playType.equalsIgnoreCase(&quot;Banker&quot;)) { int[] noPicked =
		 * kenoPurchaseBean.getNoPicked(); String checkNum[] =
		 * KenoConstants.BET_TYPE_MAP .get(playType).split(&quot;,&quot;);
		 * 
		 * if (&quot;QP&quot;.equalsIgnoreCase(pickData.get(0))) { logger.debug(&quot;---In
		 * QP---&quot;); if (!(noPicked[0] &gt;= Integer.parseInt(checkNum[0]) &amp;&amp;
		 * noPicked[0] &lt;= Integer.parseInt(checkNum[1]) &amp;&amp; noPicked[1] &gt;=
		 * Integer.parseInt(checkNum[2]) &amp;&amp; noPicked[1] &lt;= Integer
		 * .parseInt(checkNum[3]))) { logger.debug(&quot;invalid UL data&quot;); }
		 * kenoPurchaseBean.setNoOfLines(noPicked[0]*noPicked[1]); }else {
		 * String[] noPick = pickedNumbers.replace(&quot;,BL&quot;, &quot;&quot;) .split(&quot;,UL,&quot;);
		 * String[] noPickedUL = noPick[0].split(&quot;,&quot;); if (noPickedUL.length &lt;
		 * Integer.parseInt(checkNum[0]) || noPickedUL.length &gt; Integer
		 * .parseInt(checkNum[1])) { logger.debug(&quot;invalid UL data&quot;); }
		 * SortedSet&lt;Integer&gt; set = new TreeSet&lt;Integer&gt;(); for (int i = 0; i &lt;
		 * noPickedUL.length; i++) { set.add(Integer.parseInt(noPickedUL[i])); }
		 * if (set.size() &lt; noPickedUL.length) { logger.debug(&quot;duplicate UL
		 * data&quot;); } if (set.first() &lt; 1 || set.last() &gt; 90) { logger.debug(&quot;UL
		 * data out of range.&quot;); }
		 * 
		 * String[] noPickedBL = noPick[1].split(&quot;,&quot;); if (noPickedBL.length &lt;
		 * Integer.parseInt(checkNum[2]) || noPickedBL.length &gt; Integer
		 * .parseInt(checkNum[3])) { logger.debug(&quot;invalid BL data&quot;); }
		 * SortedSet&lt;Integer&gt; sortedSetBL = new TreeSet&lt;Integer&gt;(); for (int i =
		 * 0; i &lt; noPickedBL.length; i++) {
		 * sortedSetBL.add(Integer.parseInt(noPickedBL[i])); } if
		 * (sortedSetBL.size() &lt; noPickedBL.length) { logger.debug(&quot;duplicate BL
		 * data&quot;); } if (sortedSetBL.first() &lt; 1 || sortedSetBL.last() &gt; 90) {
		 * logger.debug(&quot;BL data out of range.&quot;); }
		 * 
		 * TreeSet treeSet = new TreeSet(); treeSet.add(set);
		 * treeSet.add(sortedSetBL); if (treeSet.size() &lt; set.size() +
		 * sortedSetBL.size()) { logger.debug(&quot;Both UL and BL can't contain the
		 * same values.&quot;); }
		 * 
		 * int noOfLines = noPickedUL.length * noPickedBL.length;
		 * kenoPurchaseBean.setNoOfLines(noOfLines); } } else if
		 * (playType.contains(&quot;Direct&quot;) ||
		 * playType.equalsIgnoreCase(&quot;Banker1AgainstAll&quot;)) { int checkNum =
		 * Integer.parseInt(KenoConstants.BET_TYPE_MAP .get(playType)); if
		 * (&quot;QP&quot;.equalsIgnoreCase(pickData.get(0))) { int[] noPicked =
		 * kenoPurchaseBean.getNoPicked(); if (noPicked[0] != checkNum) {
		 * logger.debug(&quot;invalid data&quot;); } } else { String[] pickedNum =
		 * pickedNumbers.split(&quot;,&quot;); if (pickedNum.length != checkNum) {
		 * logger.debug(&quot;invalid ata&quot;); } SortedSet&lt;Integer&gt; set = new
		 * TreeSet&lt;Integer&gt;(); for (int i = 0; i &lt; pickedNum.length; i++) {
		 * set.add(Integer.parseInt(pickedNum[i])); } if (set.size() &lt;
		 * pickedNum.length) { logger.debug(&quot;duplicate data&quot;); } if (set.first()
		 * &lt; 1 || set.last() &gt; 90) { logger.debug(&quot;data out of range.&quot;); } } }
		 * else if (playType.contains(&quot;Perm&quot;)) { String checkNum[] =
		 * KenoConstants.BET_TYPE_MAP .get(playType).split(&quot;,&quot;); if
		 * (&quot;QP&quot;.equalsIgnoreCase(pickData.get(0))) { int[] noPicked =
		 * kenoPurchaseBean.getNoPicked(); if (!(noPicked[0] &gt;=
		 * Integer.parseInt(checkNum[0]) &amp;&amp; noPicked[0] &lt;= Integer
		 * .parseInt(checkNum[1]))) { logger.debug(&quot;invalid data&quot;); } } else {
		 * String[] pickedNum = pickedNumbers.split(&quot;,&quot;); if (pickedNum.length
		 * &gt;= Integer.parseInt(checkNum[0]) || pickedNum.length &lt;= Integer
		 * .parseInt(checkNum[1])) { logger.debug(&quot;invalid ata&quot;); }
		 * SortedSet&lt;Integer&gt; set = new TreeSet&lt;Integer&gt;(); for (int i = 0; i &lt;
		 * pickedNum.length; i++) { set.add(Integer.parseInt(pickedNum[i])); }
		 * if (set.size() &lt; pickedNum.length) { logger.debug(&quot;duplicate data&quot;);
		 * } if (set.first() &lt; 1 || set.last() &gt; 90) {
		 * logger.debug(&quot;data out of range.&quot;); } } }
		 * 
		 * if (kenoPurchaseBean.getBetAmountMultiple() &lt; 1) {
		 * logger.debug(&quot;invalid Bet Amount Multiple&quot;); }
		 * 
		 * int noOfLines = 0; int[] noPicked = kenoPurchaseBean.getNoPicked();
		 * if (playType.contains(&quot;Direct&quot;)) { noOfLines = 1; } else if
		 * (playType.equalsIgnoreCase(&quot;perm2&quot;)) { noOfLines = (noPicked[0] *
		 * (noPicked[0] - 1)) / 2; } else if
		 * (playType.equalsIgnoreCase(&quot;perm3&quot;)) { noOfLines = (noPicked[0] *
		 * (noPicked[0] - 1) * (noPicked[0] - 2)) / 6; } else if
		 * (playType.equalsIgnoreCase(&quot;Banker1AgainstAll&quot;)) { noOfLines = 89; }
		 * kenoPurchaseBean.setNoOfLines(noOfLines);
		 * 
		 * double totalPurAmt = kenoPurchaseBean.getNoOfLines()
		 * Util.getUnitPrice(kenoPurchaseBean.getGame_no(),
		 * kenoPurchaseBean.getPlayType()) kenoPurchaseBean.getNoOfDraws()
		 * kenoPurchaseBean.getBetAmountMultiple(); if (totalPurAmt &lt;= 0) {
		 * logger.debug(&quot;invalid purchase amount&quot;); }
		 * kenoPurchaseBean.setTotalPurchaseAmt(totalPurAmt); } }
		 * 
		 */
	}

	public boolean lottoDataValidation(LottoPurchaseBean lottoPurchaseBean) {
<span class="nc" id="L3535">		int noOfDraws = lottoPurchaseBean.getNoOfDraws();</span>
<span class="nc" id="L3536">		String[] picknumbers = lottoPurchaseBean.getPicknumbers();</span>
		Set&lt;Integer&gt; picknumSet;
		String pickNum[];
<span class="nc" id="L3539">		int noOfPanels = picknumbers.length;</span>
<span class="nc" id="L3540">		logger.debug(&quot;no of Panels: &quot; + noOfPanels);</span>
<span class="nc bnc" id="L3541" title="All 4 branches missed.">		if (noOfDraws &gt; 0 &amp;&amp; noOfPanels &gt; 0) {</span>
<span class="nc bnc" id="L3542" title="All 2 branches missed.">			for (int i = 0; i &lt; noOfPanels; i++) {</span>
<span class="nc bnc" id="L3543" title="All 2 branches missed.">				if (picknumbers[i].equalsIgnoreCase(&quot;QP&quot;)) {</span>
<span class="nc" id="L3544">					logger.debug(&quot;quick pick Selected&quot;);</span>

				} else {
<span class="nc" id="L3547">					logger.debug(&quot;not quick pick&quot;);</span>
<span class="nc" id="L3548">					logger.debug(&quot;Player picked Data:&quot; + picknumbers[i]);</span>
<span class="nc" id="L3549">					pickNum = picknumbers[i].split(&quot;,&quot;);</span>
<span class="nc" id="L3550">					picknumSet = new HashSet&lt;Integer&gt;();</span>
<span class="nc bnc" id="L3551" title="All 2 branches missed.">					for (String element : pickNum) {</span>
<span class="nc" id="L3552">						picknumSet.add(Integer.parseInt(element));</span>
					}
<span class="nc bnc" id="L3554" title="All 4 branches missed.">					if (pickNum.length != picknumSet.size()</span>
							|| pickNum.length &gt; com.skilrock.lms.dge.gameconstants.LottoConstants.MAX_PLAYER_PICKED) {
<span class="nc" id="L3556">						logger.debug(&quot;picNum.Length: &quot; + pickNum.length + &quot;Set length:  &quot; + picknumSet.size());</span>
<span class="nc" id="L3557">						return false;</span>
					}
				}
			}
<span class="nc" id="L3561">			return true;</span>
		}
<span class="nc" id="L3563">		return false;</span>
	}

	public LottoPurchaseBean lottoPurchaseTicket(UserInfoBean userBean, LottoPurchaseBean lottoPurchaseBean)
			throws Exception {

<span class="nc" id="L3569">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L3570">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L3571">		sReq.setServiceName(ServiceName.LOTTO);</span>
<span class="nc" id="L3572">		sReq.setServiceMethod(ServiceMethodName.LOTTO_PURCHASE_TICKET);</span>
<span class="nc" id="L3573">		sReq.setServiceData(lottoPurchaseBean);</span>
<span class="nc" id="L3574">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L3575">		double oldTotalPurchaseAmt = 0.0;</span>
<span class="nc" id="L3576">		double modifiedTotalPurchaseAmt = 0.0;</span>
<span class="nc" id="L3577">		String status = &quot;&quot;;</span>
<span class="nc" id="L3578">		long balDed = 0;</span>
<span class="nc" id="L3579">		Connection con = null;</span>
<span class="nc bnc" id="L3580" title="All 4 branches missed.">		if (isDrawAvailable(lottoPurchaseBean.getGame_no()) || chkFreezeTimeSale(lottoPurchaseBean.getGame_no())) {</span>
<span class="nc" id="L3581">			lottoPurchaseBean.setSaleStatus(&quot;NO_DRAWS&quot;);</span>
<span class="nc" id="L3582">			return lottoPurchaseBean;</span>
		}
		try {
<span class="nc bnc" id="L3585" title="All 2 branches missed.">			if (lottoDataValidation(lottoPurchaseBean)) {</span>
<span class="nc" id="L3586">				logger.debug(&quot;Data Validation returns True&quot;);</span>
				// lottoPurchaseBean.setAdvMsg(Util.getAdvMessage(userBean.getUserOrgId(),
				// lottoPurchaseBean.getGame_no(), &quot;PLAYER&quot;, &quot;SALE&quot;, &quot;DG&quot;));
<span class="nc" id="L3589">				lottoPurchaseBean</span>
						.setAdvMsg(Util.getDGSaleAdvMessage(userBean.getUserOrgId(), lottoPurchaseBean.getGame_no()));

<span class="nc" id="L3592">				lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L3593">				con = DBConnect.getConnection();</span>
<span class="nc bnc" id="L3594" title="All 2 branches missed.">				if (lottoPurchaseBean.getLastSoldTicketNo() != null) {</span>
<span class="nc bnc" id="L3595" title="All 2 branches missed.">					if (!&quot;0&quot;.equalsIgnoreCase(lottoPurchaseBean.getLastSoldTicketNo())) {</span>
<span class="nc" id="L3596">						Util.insertLastSoldTicketTeminal(lottoPurchaseBean.getUserId(),</span>
								lottoPurchaseBean.getLastSoldTicketNo(), lottoPurchaseBean.getGameId(), con);
					}
				}

<span class="nc" id="L3601">				double totPurAmt = lottoPurchaseBean.getPicknumbers().length</span>
						* Util.getUnitPrice(lottoPurchaseBean.getGame_no(), null) * lottoPurchaseBean.getNoOfDraws();
<span class="nc" id="L3603">				logger.debug(&quot;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&quot; + totPurAmt);</span>

<span class="nc" id="L3605">				lottoPurchaseBean.setTotalPurchaseAmt(totPurAmt);</span>

<span class="nc" id="L3607">				logger.debug(&quot;Inside  FE1*******&quot;);</span>
				// rg calling
<span class="nc" id="L3609">				boolean isFraud = ResponsibleGaming.respGaming(userBean, &quot;DG_SALE&quot;, totPurAmt + &quot;&quot;);</span>
<span class="nc bnc" id="L3610" title="All 2 branches missed.">				if (!isFraud) {</span>
<span class="nc" id="L3611">					balDed = orgOnLineSaleCreditUpdation.drawTcketSaleBalDeduction(userBean,</span>
							lottoPurchaseBean.getGame_no(), lottoPurchaseBean.getTotalPurchaseAmt(),
							lottoPurchaseBean.getPlrMobileNumber(), con);
<span class="nc" id="L3614">					oldTotalPurchaseAmt = lottoPurchaseBean.getTotalPurchaseAmt();</span>
<span class="nc" id="L3615">					logger.debug(&quot;Total Purchase Amt inside DrawGameRPOSHelper Just Before  getting Success :&quot;</span>
							+ oldTotalPurchaseAmt);
				} else {
<span class="nc" id="L3618">					logger.debug(&quot;Responsing Gaming not allowed to sale&quot;);</span>
<span class="nc" id="L3619">					lottoPurchaseBean.setSaleStatus(&quot;FRAUD&quot;);</span>
				}
<span class="nc" id="L3621">			} else {</span>

<span class="nc" id="L3623">				logger.debug(&quot;Data validation returns false&quot;);</span>
<span class="nc" id="L3624">				lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>

			}
<span class="nc" id="L3627">		} catch (Exception e) {</span>
			// commented by amit as not relevant here

			/*
			 * lottoPurchaseBean = (LottoPurchaseBean) sRes.getResponseData();
			 * String ticketNo = lottoPurchaseBean.getTicket_no(); String
			 * cancelChannel = lottoPurchaseBean.getPurchaseChannel();
			 * Map&lt;Integer, Map&lt;Integer, String&gt;&gt; drawIdTableMap =
			 * lottoPurchaseBean .getDrawIdTableMap(); int gameNo =
			 * lottoPurchaseBean.getGame_no(); int partyId =
			 * lottoPurchaseBean.getPartyId(); String partyType =
			 * lottoPurchaseBean.getPartyType(); String refTransId =
			 * lottoPurchaseBean.getRefTransId();
			 * 
			 * cancelTicket(ticketNo, cancelChannel, drawIdTableMap, gameNo,
			 * partyId, partyType, refTransId);
			 */
<span class="nc" id="L3644">			e.printStackTrace();</span>
<span class="nc" id="L3645">		}</span>

		try {

<span class="nc bnc" id="L3649" title="All 2 branches missed.">			if (balDed &gt; 0) {</span>
<span class="nc" id="L3650">				lottoPurchaseBean.setRefTransId(balDed + &quot;&quot;);</span>
<span class="nc" id="L3651">				sRes = delegate.getResponse(sReq);</span>

<span class="nc bnc" id="L3653" title="All 2 branches missed.">				if (sRes.getIsSuccess()) {</span>
<span class="nc" id="L3654">					lottoPurchaseBean = (LottoPurchaseBean) sRes.getResponseData();</span>
<span class="nc" id="L3655">					modifiedTotalPurchaseAmt = lottoPurchaseBean.getTotalPurchaseAmt();</span>
<span class="nc" id="L3656">					logger.debug(&quot;Total Purchase Amt inside DrawGameRPOSHelper After getting Success :&quot;</span>
							+ modifiedTotalPurchaseAmt);
<span class="nc" id="L3658">					con = DBConnect.getConnection();</span>
<span class="nc bnc" id="L3659" title="All 2 branches missed.">					if (oldTotalPurchaseAmt != modifiedTotalPurchaseAmt) {</span>
<span class="nc" id="L3660">						balDed = orgOnLineSaleCreditUpdation.drawTcketSaleBalDedUpdate(userBean,</span>
								lottoPurchaseBean.getGame_no(), modifiedTotalPurchaseAmt, oldTotalPurchaseAmt, balDed,
								con);

					}
<span class="nc" id="L3665">					int tickUpd = orgOnLineSaleCreditUpdation.drawTicketSaleTicketUpdate(balDed,</span>
							lottoPurchaseBean.getTicket_no(), lottoPurchaseBean.getGame_no(), userBean,
							lottoPurchaseBean.getPurchaseChannel(), con);

<span class="nc bnc" id="L3669" title="All 2 branches missed.">					if (tickUpd == 1) {</span>
<span class="nc" id="L3670">						status = &quot;SUCCESS&quot;;</span>
<span class="nc" id="L3671">						lottoPurchaseBean.setSaleStatus(status);</span>
<span class="nc bnc" id="L3672" title="All 2 branches missed.">						if (!lottoPurchaseBean.getBarcodeType().equals(&quot;applet&quot;)) {</span>
<span class="nc" id="L3673">							IDBarcode</span>
									.getBarcode(lottoPurchaseBean.getTicket_no() + lottoPurchaseBean.getReprintCount());
						}
<span class="nc" id="L3676">						return lottoPurchaseBean;</span>
					} else {
<span class="nc" id="L3678">						status = &quot;FAILED&quot;;</span>
<span class="nc" id="L3679">						lottoPurchaseBean.setSaleStatus(status);</span>
						// Code for cancelling the Ticket to be send to
						// Draw
						// Game Engine
<span class="nc" id="L3683">						cancelTicket(lottoPurchaseBean.getTicket_no() + lottoPurchaseBean.getReprintCount(),</span>
								lottoPurchaseBean.getPurchaseChannel(), lottoPurchaseBean.getDrawIdTableMap(),
								lottoPurchaseBean.getGame_no(), lottoPurchaseBean.getPartyId(),
								lottoPurchaseBean.getPartyType(), lottoPurchaseBean.getRefMerchantId(), userBean,
								lottoPurchaseBean.getRefTransId());

<span class="nc" id="L3689">						return lottoPurchaseBean;</span>
					}
				} else {
<span class="nc" id="L3692">					lottoPurchaseBean = (LottoPurchaseBean) sRes.getResponseData();</span>
<span class="nc bnc" id="L3693" title="All 2 branches missed.">					if (lottoPurchaseBean.getSaleStatus() == null) {</span>
<span class="nc" id="L3694">						lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);// Error</span>
<span class="nc" id="L3695">						orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, lottoPurchaseBean.getGame_no(),</span>
								&quot;FAILED&quot;, balDed);
<span class="nc" id="L3697">						return lottoPurchaseBean;</span>
<span class="nc bnc" id="L3698" title="All 2 branches missed.">					} else if (&quot;ERROR_TICKET_LIMIT&quot;.equalsIgnoreCase(lottoPurchaseBean.getSaleStatus())) {</span>
<span class="nc" id="L3699">						orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, lottoPurchaseBean.getGame_no(),</span>
								&quot;FAILED&quot;, balDed);
<span class="nc" id="L3701">						return lottoPurchaseBean;</span>
					} else {
<span class="nc" id="L3703">						orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, lottoPurchaseBean.getGame_no(),</span>
								&quot;FAILED&quot;, balDed);
<span class="nc" id="L3705">						return lottoPurchaseBean;</span>
					}
				}
			} else {

<span class="nc" id="L3710">				status = getStatusIfErrorInTransaction(status, balDed);</span>
<span class="nc" id="L3711">				lottoPurchaseBean.setSaleStatus(status);</span>
<span class="nc" id="L3712">				return lottoPurchaseBean;</span>
			}
<span class="nc" id="L3714">		} catch (Exception e) {</span>
			// TODO: handle exception
		}
<span class="nc" id="L3717">		return lottoPurchaseBean;</span>
	}

	public MainPWTDrawBean payPwtTicket(MainPWTDrawBean mainPwtBean, UserInfoBean userInfoBean,
			String highPrizeCriteria, String highPrizeAmt, String highPrizeScheme) throws Exception {
<span class="nc" id="L3722">		List&lt;Long&gt; transIdList = new ArrayList&lt;Long&gt;();</span>
<span class="nc" id="L3723">		Connection connection = DBConnect.getConnection();</span>
<span class="nc" id="L3724">		boolean isResAwaited = false;</span>
<span class="nc" id="L3725">		double totPay = mainPwtBean.getTotlticketAmount();</span>
<span class="nc" id="L3726">		boolean isHighPrz = false;</span>

<span class="nc" id="L3728">		Type type = null;</span>

<span class="nc bnc" id="L3730" title="All 2 branches missed.">		if (&quot;HIGH_PRIZE&quot;.equalsIgnoreCase(mainPwtBean.getStatus())) {</span>
<span class="nc" id="L3731">			isHighPrz = true;</span>
		}
<span class="nc" id="L3733">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L3734">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L3735">		sReq.setServiceName(ServiceName.PWT_MGMT);</span>
<span class="nc" id="L3736">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
		try {
<span class="nc" id="L3738">			type = new TypeToken&lt;PWTDrawBean&gt;() {</span>
			}.getType();

<span class="nc" id="L3741">			connection.setAutoCommit(false);</span>

			/*
			 * String highPrizeCriteria = (String)
			 * LMSUtility.sc.getAttribute(&quot;HIGH_PRIZE_CRITERIA&quot;); String
			 * highPrizeAmt = (String)
			 * LMSUtility.sc.getAttribute(&quot;HIGH_PRIZE_AMT&quot;); String
			 * highPrizeScheme = (String) LMSUtility.sc.getAttribute(
			 * &quot;DRAW_GAME_HIGH_PRIZE_SCHEME&quot;);
			 */

			// if HIGH HIGH_PRIZE_CRITERIA or HIGH_PRIZE_AMT is NULL
<span class="nc bnc" id="L3753" title="All 6 branches missed.">			if (highPrizeCriteria == null || highPrizeAmt == null || userInfoBean == null) {</span>

<span class="nc" id="L3755">				mainPwtBean.setStatus(&quot;ERROR&quot;);</span>
<span class="nc" id="L3756">				return mainPwtBean;</span>
			}
			// rg calling
<span class="nc" id="L3759">			boolean isFraudAmt = ResponsibleGaming.respGaming(userInfoBean, &quot;DG_PWT&quot;,</span>
					&quot;&quot; + mainPwtBean.getTotlticketAmount());
<span class="nc" id="L3761">			boolean isFraudInvalid = ResponsibleGaming.respGaming(userInfoBean, &quot;DG_PWT_INVALID&quot;, &quot;&quot; + 0);</span>
<span class="nc bnc" id="L3762" title="All 4 branches missed.">			if (!(isFraudAmt || isFraudInvalid)) {</span>

<span class="nc bnc" id="L3764" title="All 2 branches missed.">				if (mainPwtBean.getPwtTicketType().equalsIgnoreCase(&quot;RAFFLE&quot;)) {</span>
<span class="nc" id="L3765">					PWTDrawBean winningBean = new PWTDrawBean();</span>
<span class="nc" id="L3766">					winningBean = mainPwtBean.getWinningBeanList().get(0);</span>
<span class="nc" id="L3767">					RetailerPwtProcessHelper pwtProcess = new RetailerPwtProcessHelper();</span>
<span class="nc" id="L3768">					pwtProcess.verifyDrawPwt(winningBean.getTicketNo(), winningBean.getGameId(), connection,</span>
							userInfoBean, highPrizeCriteria, highPrizeAmt, winningBean, highPrizeScheme, true,
							winningBean.getPwtTicketType(), transIdList);

<span class="nc" id="L3772">					RaffleDrawIdBean raffleDrawIdBean = (RaffleDrawIdBean) winningBean.getRaffleDrawIdBeanList().get(0);</span>
					// Draw Game Updation of Ticket
<span class="nc" id="L3774">					winningBean.setGameDispName(Util.getGameDisplayName(winningBean.getGameId()));</span>

<span class="nc bnc" id="L3776" title="All 2 branches missed.">					if (highPrizeScheme.equalsIgnoreCase(&quot;DRAW_WISE&quot;)) {</span>

<span class="nc" id="L3778">						logger.debug(&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;DRAW_WISE in rpos&quot;);</span>
<span class="nc bnc" id="L3779" title="All 2 branches missed.">						if (winningBean.getDrawWinList() != null) {</span>
<span class="nc bnc" id="L3780" title="All 2 branches missed.">							for (DrawIdBean drawIdBean : winningBean.getDrawWinList()) {</span>

<span class="nc bnc" id="L3782" title="All 2 branches missed.">								if (drawIdBean.getStatus().equalsIgnoreCase(&quot;NORMAL_PAY&quot;)) {</span>
<span class="nc" id="L3783">									winningBean.setStatus(&quot;NORMAL_PAY&quot;);</span>
<span class="nc" id="L3784">									break;</span>
								} else {
<span class="nc" id="L3786">									winningBean.setStatus(&quot;SUCCESS&quot;);</span>
								}
<span class="nc" id="L3788">							}</span>
						}

<span class="nc bnc" id="L3791" title="All 2 branches missed.">					} else if (highPrizeScheme.equalsIgnoreCase(&quot;PANEL_WISE&quot;)) {</span>
<span class="nc" id="L3792">						logger.debug(&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;PANEL_WISE in rpos&quot;);</span>
<span class="nc" id="L3793">						winningBean.setStatus(&quot;NORMAL_PAY&quot;);</span>
<span class="nc bnc" id="L3794" title="All 2 branches missed.">					} else if (highPrizeScheme.equalsIgnoreCase(&quot;TICKET_WISE&quot;)) {</span>
<span class="nc" id="L3795">						logger.debug(&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;TICKET_WISE in rpos&quot;);</span>
<span class="nc bnc" id="L3796" title="All 2 branches missed.">						if (&quot;NORMAL_PAY&quot;.equalsIgnoreCase(raffleDrawIdBean.getPwtStatus())) {</span>
<span class="nc" id="L3797">							winningBean.setStatus(&quot;NORMAL_PAY&quot;);</span>
						} else {
<span class="nc" id="L3799">							winningBean.setStatus(&quot;SUCCESS&quot;);</span>
						}
					}

<span class="nc bnc" id="L3803" title="All 2 branches missed.">					if (raffleDrawIdBean.getStatus().equalsIgnoreCase(&quot;NORMAL_PAY&quot;)) {</span>
						// send request for raffle pyment
<span class="nc" id="L3805">						sReq.setServiceName(ServiceName.PWT_MGMT);</span>
<span class="nc" id="L3806">						sReq.setServiceMethod(ServiceMethodName.RAFFLE_PWT_UPDATE);</span>
<span class="nc" id="L3807">						sReq.setServiceData(winningBean);</span>
<span class="nc" id="L3808">						sRes = delegate.getResponse(sReq);</span>

<span class="nc" id="L3810">						winningBean = (PWTDrawBean) new Gson().fromJson((JsonElement) sRes.getResponseData(), type);</span>

						// winningBean = (PWTDrawBean) sRes.getResponseData();
<span class="nc bnc" id="L3813" title="All 2 branches missed.">						if (sRes.getIsSuccess()) {</span>
							// connection.commit();
							// connection.close();
<span class="nc bnc" id="L3816" title="All 2 branches missed.">							if (winningBean.isResAwaited()) {</span>
<span class="nc" id="L3817">								isResAwaited = true;</span>
							}
<span class="nc" id="L3819">							winningBean.setStatus(&quot;SUCCESS&quot;);</span>
<span class="nc" id="L3820">							mainPwtBean.setStatus(&quot;SUCCESS&quot;);</span>
						}

						else {
							// connection.rollback();
							// connection.close();
<span class="nc" id="L3826">							winningBean.setStatus(&quot;ERROR&quot;);</span>
<span class="nc" id="L3827">							mainPwtBean.setStatus(&quot;ERROR&quot;);</span>
						}
					}

<span class="nc" id="L3831">				} else {</span>

<span class="nc bnc" id="L3833" title="All 2 branches missed.">					for (int i = 0; i &lt; mainPwtBean.getWinningBeanList().size(); i++) {</span>
<span class="nc" id="L3834">						PWTDrawBean winningBean = new PWTDrawBean();</span>
<span class="nc" id="L3835">						winningBean = mainPwtBean.getWinningBeanList().get(i);</span>

<span class="nc" id="L3837">						mainPwtBean.setAdvMsg(Util.getAdvMessage(userInfoBean.getUserOrgId(), winningBean.getGameId(),</span>
								&quot;PLAYER&quot;, &quot;PWT&quot;, &quot;DG&quot;));

<span class="nc bnc" id="L3840" title="All 2 branches missed.">						if (winningBean.getPwtTicketType().equalsIgnoreCase(&quot;RAFFLE&quot;)) {</span>

<span class="nc" id="L3842">							RetailerPwtProcessHelper pwtProcess = new RetailerPwtProcessHelper();</span>
<span class="nc" id="L3843">							pwtProcess.verifyDrawPwt(winningBean.getTicketNo(), winningBean.getGameId(), connection,</span>
									userInfoBean, highPrizeCriteria, highPrizeAmt, winningBean, highPrizeScheme, true,
									winningBean.getPwtTicketType(), transIdList);

<span class="nc" id="L3847">							RaffleDrawIdBean raffleDrawIdBean = (RaffleDrawIdBean) winningBean.getRaffleDrawIdBeanList()</span>
									.get(0);
							// Draw Game Updation of Ticket
<span class="nc" id="L3850">							winningBean.setGameDispName(Util.getGameDisplayName(winningBean.getGameId()));</span>

<span class="nc bnc" id="L3852" title="All 2 branches missed.">							if (highPrizeScheme.equalsIgnoreCase(&quot;DRAW_WISE&quot;)) {</span>

<span class="nc" id="L3854">								logger.debug(&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;DRAW_WISE in rpos&quot;);</span>
<span class="nc bnc" id="L3855" title="All 2 branches missed.">								if (winningBean.getDrawWinList() != null) {</span>
<span class="nc bnc" id="L3856" title="All 2 branches missed.">									for (DrawIdBean drawIdBean : winningBean.getDrawWinList()) {</span>

<span class="nc bnc" id="L3858" title="All 2 branches missed.">										if (drawIdBean.getStatus().equalsIgnoreCase(&quot;NORMAL_PAY&quot;)) {</span>
<span class="nc" id="L3859">											winningBean.setStatus(&quot;NORMAL_PAY&quot;);</span>
<span class="nc" id="L3860">											break;</span>
										} else {
<span class="nc" id="L3862">											winningBean.setStatus(&quot;SUCCESS&quot;);</span>
										}
<span class="nc" id="L3864">									}</span>
								}

<span class="nc bnc" id="L3867" title="All 2 branches missed.">							} else if (highPrizeScheme.equalsIgnoreCase(&quot;PANEL_WISE&quot;)) {</span>
<span class="nc" id="L3868">								logger.debug(&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;PANEL_WISE in rpos&quot;);</span>
<span class="nc" id="L3869">								winningBean.setStatus(&quot;NORMAL_PAY&quot;);</span>
<span class="nc bnc" id="L3870" title="All 2 branches missed.">							} else if (highPrizeScheme.equalsIgnoreCase(&quot;TICKET_WISE&quot;)) {</span>
<span class="nc" id="L3871">								logger.debug(&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;TICKET_WISE in rpos&quot;);</span>
<span class="nc bnc" id="L3872" title="All 2 branches missed.">								if (&quot;NORMAL_PAY&quot;.equalsIgnoreCase(raffleDrawIdBean.getPwtStatus())) {</span>
<span class="nc" id="L3873">									winningBean.setStatus(&quot;NORMAL_PAY&quot;);</span>
								} else {
<span class="nc" id="L3875">									winningBean.setStatus(&quot;SUCCESS&quot;);</span>
								}
							}
<span class="nc bnc" id="L3878" title="All 2 branches missed.">							if (raffleDrawIdBean.isResAwaited()) {</span>
<span class="nc" id="L3879">								isResAwaited = true;</span>
							}

<span class="nc bnc" id="L3882" title="All 2 branches missed.">							if (raffleDrawIdBean.getStatus().equalsIgnoreCase(&quot;NORMAL_PAY&quot;)) {</span>
								// send request for raffle pyment
<span class="nc" id="L3884">								sReq.setServiceName(ServiceName.PWT_MGMT);</span>
<span class="nc" id="L3885">								sReq.setServiceMethod(ServiceMethodName.RAFFLE_PWT_UPDATE);</span>
<span class="nc" id="L3886">								sReq.setServiceData(winningBean);</span>
<span class="nc" id="L3887">								sRes = delegate.getResponse(sReq);</span>

<span class="nc" id="L3889">								winningBean = (PWTDrawBean) new Gson().fromJson((JsonElement) sRes.getResponseData(),</span>
										type);
								// winningBean = (PWTDrawBean) sRes
								// .getResponseData();
<span class="nc bnc" id="L3893" title="All 2 branches missed.">								if (sRes.getIsSuccess()) {</span>
									// connection.commit();
									// connection.close();
<span class="nc bnc" id="L3896" title="All 2 branches missed.">									if (winningBean.isResAwaited()) {</span>
<span class="nc" id="L3897">										isResAwaited = true;</span>
									}
<span class="nc" id="L3899">									winningBean.setStatus(&quot;SUCCESS&quot;);</span>
<span class="nc" id="L3900">									mainPwtBean.setStatus(&quot;SUCCESS&quot;);</span>
								}

								else {
									// connection.rollback();
									// connection.close();
<span class="nc" id="L3906">									winningBean.setStatus(&quot;ERROR&quot;);</span>
<span class="nc" id="L3907">									mainPwtBean.setStatus(&quot;ERROR&quot;);</span>
<span class="nc" id="L3908">									return mainPwtBean;</span>
								}
							}

<span class="nc bnc" id="L3912" title="All 2 branches missed.">						} else if (winningBean.getPwtTicketType().equalsIgnoreCase(&quot;DRAW&quot;)) {</span>
<span class="nc" id="L3913">							boolean isPay = true; // For 12/24 Rank 4 Only</span>
<span class="nc bnc" id="L3914" title="All 2 branches missed.">							if (&quot;TwelveByTwentyFour&quot;.equals(Util.getGameName(mainPwtBean.getGameId()))) {</span>
<span class="nc bnc" id="L3915" title="All 2 branches missed.">								for (DrawIdBean drawIdWinningBean : winningBean.getDrawWinList()) {</span>
<span class="nc bnc" id="L3916" title="All 2 branches missed.">									if (drawIdWinningBean.getRankId() == 4) {</span>
<span class="nc" id="L3917">										winningBean.setStatus(&quot;NORMAL_PAY&quot;);</span>
<span class="nc" id="L3918">										isPay = false;</span>
									}
<span class="nc" id="L3920">								}</span>
							}

<span class="nc" id="L3923">							RetailerPwtProcessHelper pwtProcess = new RetailerPwtProcessHelper();</span>
<span class="nc bnc" id="L3924" title="All 2 branches missed.">							if (isPay)</span>
<span class="nc" id="L3925">								pwtProcess.verifyDrawPwt(winningBean.getTicketNo(), winningBean.getGameId(), connection,</span>
										userInfoBean, highPrizeCriteria, highPrizeAmt, winningBean, highPrizeScheme,
										true, winningBean.getPwtTicketType(), transIdList);
							else {
<span class="nc" id="L3929">								pwtProcess.verifyDrawPwt(winningBean.getTicketNo(), winningBean.getGameId(), connection,</span>
										userInfoBean, highPrizeCriteria, highPrizeAmt, winningBean, highPrizeScheme,
										false, winningBean.getPwtTicketType(), transIdList);
<span class="nc" id="L3932">								winningBean.setStatus(&quot;NORMAL_PAY&quot;);</span>
							}
							// Draw Game Updation of Ticket
<span class="nc" id="L3935">							winningBean.setGameDispName(Util.getGameDisplayName(winningBean.getGameId()));</span>

<span class="nc bnc" id="L3937" title="All 2 branches missed.">							if (highPrizeScheme.equalsIgnoreCase(&quot;DRAW_WISE&quot;)) {</span>

<span class="nc" id="L3939">								logger.debug(&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;DRAW_WISE in rpos&quot;);</span>
<span class="nc bnc" id="L3940" title="All 2 branches missed.">								if (winningBean.getDrawWinList() != null) {</span>
<span class="nc bnc" id="L3941" title="All 2 branches missed.">									for (DrawIdBean drawIdBean : winningBean.getDrawWinList()) {</span>

<span class="nc bnc" id="L3943" title="All 2 branches missed.">										if (drawIdBean.getStatus().equalsIgnoreCase(&quot;NORMAL_PAY&quot;)) {</span>
<span class="nc" id="L3944">											winningBean.setStatus(&quot;NORMAL_PAY&quot;);</span>
<span class="nc" id="L3945">											break;</span>
										} else {
<span class="nc" id="L3947">											winningBean.setStatus(&quot;SUCCESS&quot;);</span>
										}
<span class="nc" id="L3949">									}</span>
								}

<span class="nc bnc" id="L3952" title="All 2 branches missed.">							} else if (highPrizeScheme.equalsIgnoreCase(&quot;PANEL_WISE&quot;)) {</span>
<span class="nc" id="L3953">								logger.debug(&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;PANEL_WISE in rpos&quot;);</span>
<span class="nc" id="L3954">								winningBean.setStatus(&quot;NORMAL_PAY&quot;);</span>
<span class="nc bnc" id="L3955" title="All 2 branches missed.">							} else if (highPrizeScheme.equalsIgnoreCase(&quot;TICKET_WISE&quot;)) {</span>
<span class="nc" id="L3956">								logger.debug(&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;TICKET_WISE in rpos&quot;);</span>
<span class="nc bnc" id="L3957" title="All 2 branches missed.">								if (&quot;NORMAL_PAY&quot;.equalsIgnoreCase(winningBean.getPwtStatus())) {</span>
<span class="nc" id="L3958">									winningBean.setStatus(&quot;NORMAL_PAY&quot;);</span>
								} else {
<span class="nc" id="L3960">									winningBean.setStatus(&quot;SUCCESS&quot;);</span>
								}
							}

							/*
							 * DrawIdBean drawBean =
							 * winningBean.getDrawWinList().get(i);
							 * List&lt;PanelIdBean&gt; panelWinList =
							 * drawBean.getPanelWinList(); if (panelWinList ==
							 * null){ isResAwaited=true; }
							 */
<span class="nc bnc" id="L3971" title="All 2 branches missed.">							if (winningBean.isResAwaited()) {</span>
<span class="nc" id="L3972">								isResAwaited = true;</span>
							}

<span class="nc bnc" id="L3975" title="All 2 branches missed.">							if (winningBean.getStatus().equalsIgnoreCase(&quot;NORMAL_PAY&quot;)) {</span>
								// Insert last pwt time in
								// st_lms_ret_offline_master table
<span class="nc" id="L3978">								Util.setHeartBeatAndSaleTime(userInfoBean.getUserOrgId(), &quot;PWT&quot;, connection);</span>
								// send request for main draw gamw payment

<span class="nc" id="L3981">								sReq.setServiceMethod(ServiceMethodName.DRAWGAME_PWT_UPDATE);</span>
<span class="nc" id="L3982">								sReq.setServiceData(winningBean);</span>
<span class="nc" id="L3983">								sRes = delegate.getResponse(sReq);</span>
<span class="nc bnc" id="L3984" title="All 2 branches missed.">								if (sRes.getIsSuccess()) {</span>
									// connection.commit();
									// connection.close();
<span class="nc bnc" id="L3987" title="All 2 branches missed.">									if (winningBean.isResAwaited()) {</span>
<span class="nc" id="L3988">										isResAwaited = true;</span>
									}
<span class="nc" id="L3990">									mainPwtBean.setBarcodeCount(winningBean.getBarCodeCount());</span>
<span class="nc" id="L3991">									winningBean.setStatus(&quot;SUCCESS&quot;);</span>
<span class="nc" id="L3992">									mainPwtBean.setStatus(&quot;SUCCESS&quot;);</span>

								}

								else {
									// connection.rollback();
									// connection.close();
<span class="nc" id="L3999">									winningBean.setStatus(&quot;ERROR&quot;);</span>
<span class="nc" id="L4000">									mainPwtBean.setStatus(&quot;ERROR&quot;);</span>
<span class="nc" id="L4001">									return mainPwtBean;</span>
								}

							}

						}

					}

				}

				// do here the reprint process and call reprint function from
				// LMS only
<span class="nc bnc" id="L4014" title="All 4 branches missed.">				if (isResAwaited || isHighPrz) {</span>
<span class="nc bnc" id="L4015" title="All 12 branches missed.">					if (isResAwaited &amp;&amp; totPay &gt; 0 || isHighPrz &amp;&amp; totPay &gt; 0 || isResAwaited &amp;&amp; isHighPrz) {</span>
<span class="nc" id="L4016">						String ticketNumber = mainPwtBean.getTicketNo();</span>
<span class="nc" id="L4017">						int len = ticketNumber.length();</span>
<span class="nc" id="L4018">						Object gameBean = reprintTicket(userInfoBean,</span>
								true, /*
										 * len==ConfigurationVariables.
										 * barcodeCount?ticketNumber.substring(
										 * 0, len - 4):ticketNumber.substring(0,
										 * len - 2)
										 */
								Util.getTktWithoutRpcNBarCodeCount(ticketNumber, len), false, null, null);
<span class="nc" id="L4026">						mainPwtBean.setPurchaseBean(gameBean);</span>
<span class="nc" id="L4027">						mainPwtBean.setReprint(true);</span>
<span class="nc" id="L4028">						mainPwtBean.setStatus(&quot;SUCCESS&quot;);</span>
<span class="nc" id="L4029">					} else {</span>
<span class="nc" id="L4030">						mainPwtBean.setStatus(&quot;ERROR&quot;);</span>
					}
				}
<span class="nc" id="L4033">				mainPwtBean.setTransactionIdList(transIdList);</span>
<span class="nc" id="L4034">				connection.commit();</span>
<span class="nc" id="L4035">				connection.close();</span>

			} else {
<span class="nc bnc" id="L4038" title="All 2 branches missed.">				if (isFraudAmt) {</span>
<span class="nc" id="L4039">					mainPwtBean.setStatus(&quot;PWT_LIMIT_EXCEED&quot;);</span>
<span class="nc" id="L4040">					mainPwtBean.setPwtStatus(&quot;Your Daliy PWT Limit of Responsible Gaming Exceed&quot;);</span>
				} else {
<span class="nc" id="L4042">					mainPwtBean.setStatus(&quot;INVALID_PWT_LIMIT_EXCEED&quot;);</span>
<span class="nc" id="L4043">					mainPwtBean.setPwtStatus(&quot;Your Daliy Invalid PWT Limit of Responsible Gaming Exceed&quot;);</span>
				}
			}
<span class="nc" id="L4046">		} catch (Exception e) {</span>
<span class="nc" id="L4047">			e.printStackTrace();</span>
<span class="nc" id="L4048">			mainPwtBean.setStatus(&quot;ERROR&quot;);</span>
<span class="nc" id="L4049">		}</span>
<span class="nc" id="L4050">		return mainPwtBean;</span>
	}

	public MainPWTDrawBean prizeWinningTicket(MainPWTDrawBean mainPwtBean, UserInfoBean userInfoBean,
			String refMerchantId) throws SQLException {

<span class="nc" id="L4056">		ResultSet rs = null;</span>
<span class="nc" id="L4057">		PreparedStatement ps = null;</span>
<span class="nc" id="L4058">		Connection connection = null;</span>

		int gameNo;
<span class="nc" id="L4061">		int gameId = 0;</span>
<span class="nc" id="L4062">		int barCodeCount = -1;</span>
		String gameType;
		String highPrizeCriteria;
		String highPrizeAmt;
		String highPrizeScheme;
<span class="nc" id="L4067">		boolean byPassDates = false;</span>
<span class="nc" id="L4068">		List&lt;PWTDrawBean&gt; winningBeanList = null;</span>

<span class="nc" id="L4070">		Type type = null;</span>

		// Get The Actual Ticket Number
<span class="nc" id="L4073">		String ticketNumber = Util.getTicketNumber(mainPwtBean.getTicketNo(), mainPwtBean.getInpType());</span>
<span class="nc bnc" id="L4074" title="All 4 branches missed.">		if (ticketNumber.equals(&quot;ERROR&quot;) || &quot;&quot;.equals(ticketNumber)) {</span>
<span class="nc" id="L4075">			mainPwtBean.setStatus(&quot;ERROR_INVALID&quot;);</span>
<span class="nc" id="L4076">			return mainPwtBean;</span>
		}
		// get game No from ticket
<span class="nc" id="L4079">		gameNo = getGamenoFromTktnumber(ticketNumber);</span>
<span class="nc" id="L4080">		gameId = Util.getGameIdFromGameNumber(gameNo);</span>
<span class="nc bnc" id="L4081" title="All 2 branches missed.">		if (gameNo &lt;= 0) {</span>
<span class="nc" id="L4082">			mainPwtBean.setStatus(&quot;ERROR_INVALID&quot;);</span>
<span class="nc" id="L4083">			return mainPwtBean;</span>
		}
		// get game type from ticket type
<span class="nc" id="L4086">		gameType = Util.getGameType(gameId);</span>
<span class="nc bnc" id="L4087" title="All 2 branches missed.">		if (gameType == null) {</span>
<span class="nc" id="L4088">			mainPwtBean.setStatus(&quot;ERROR_INVALID&quot;);</span>
<span class="nc" id="L4089">			return mainPwtBean;</span>
		}
		// Get The BarCode From Ticket Number If Required
<span class="nc bnc" id="L4092" title="All 6 branches missed.">		if (mainPwtBean.getInpType() == 1 || (mainPwtBean.getInpType() == 3</span>
				&amp;&amp; mainPwtBean.getTicketNo().length() == com.skilrock.lms.common.ConfigurationVariables.barcodeCount)) {
<span class="nc" id="L4094">			barCodeCount = Integer.parseInt(Util.getBarCodeCountFromTicketNumber(mainPwtBean.getTicketNo()));</span>
		}
<span class="nc" id="L4096">		mainPwtBean.setMainTktGameNo(gameNo);</span>
<span class="nc" id="L4097">		mainPwtBean.setGameId(gameId);</span>
<span class="nc" id="L4098">		connection = DBConnect.getConnection();</span>
<span class="nc" id="L4099">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>

		try {
<span class="nc" id="L4102">			type = new TypeToken&lt;PWTDrawBean&gt;() {</span>
			}.getType();

			/*
			 * if (&quot;NO&quot;.equalsIgnoreCase((String)
			 * LMSUtility.sc.getAttribute(&quot;PWT_CLAIM_EVERYWHERE&quot;))) { ps =
			 * connection
			 * .prepareStatement(&quot;select organization_id from st_lms_user_master where user_id=&quot;
			 * + Util.getUserIdFromTicket(ticketNumber)); rs =
			 * ps.executeQuery(); int orgId = 0; if (rs.next()) { orgId =
			 * rs.getInt(1); }
			 * 
			 * if (userInfoBean.getUserOrgId() != orgId) {
			 * mainPwtBean.setStatus(&quot;UN_AUTH&quot;); return mainPwtBean; } }
			 */

<span class="nc bnc" id="L4118" title="All 2 branches missed.">			if (!Util.canClaimRetailer(ticketNumber, userInfoBean.getUserOrgId(), userInfoBean.getParentOrgId(),</span>
					connection)) {
<span class="nc" id="L4120">				mainPwtBean.setStatus(&quot;UN_AUTH&quot;);</span>
<span class="nc" id="L4121">				return mainPwtBean;</span>
			}
<span class="nc" id="L4123">			mainPwtBean.setAdvMsg(Util.getAdvMessage(userInfoBean.getUserOrgId(), gameId, &quot;PLAYER&quot;, &quot;PWT&quot;, &quot;DG&quot;));</span>
<span class="nc" id="L4124">			connection.setAutoCommit(false);</span>
<span class="nc" id="L4125">			highPrizeCriteria = (String) LMSUtility.sc.getAttribute(&quot;HIGH_PRIZE_CRITERIA&quot;);</span>
<span class="nc" id="L4126">			highPrizeAmt = (String) LMSUtility.sc.getAttribute(&quot;HIGH_PRIZE_AMT&quot;);</span>
<span class="nc" id="L4127">			highPrizeScheme = (String) LMSUtility.sc.getAttribute(&quot;DRAW_GAME_HIGH_PRIZE_SCHEME&quot;);</span>
<span class="nc" id="L4128">			winningBeanList = new ArrayList&lt;PWTDrawBean&gt;();</span>
<span class="nc" id="L4129">			logger.debug(&quot;highPrizeAmt..........&quot; + highPrizeAmt);</span>
			// if HIGH HIGH_PRIZE_CRITERIA or HIGH_PRIZE_AMT is NULL
<span class="nc bnc" id="L4131" title="All 6 branches missed.">			if (highPrizeCriteria == null || highPrizeAmt == null || userInfoBean == null) {</span>
<span class="nc" id="L4132">				mainPwtBean.setStatus(&quot;ERROR&quot;);</span>
<span class="nc" id="L4133">				return mainPwtBean;</span>
			}

<span class="nc bnc" id="L4136" title="All 2 branches missed.">			if (gameType.equalsIgnoreCase(&quot;RAFFLE&quot;)) {</span>
<span class="nc" id="L4137">				mainPwtBean.setPwtTicketType(&quot;RAFFLE&quot;);</span>
<span class="nc" id="L4138">				PWTDrawBean winBean = new PWTDrawBean();</span>
<span class="nc" id="L4139">				winBean.setTicketNo(mainPwtBean.getTicketNo());</span>
<span class="nc" id="L4140">				winBean.setPartyId(userInfoBean.getUserOrgId());</span>
<span class="nc" id="L4141">				winBean.setPartyType(userInfoBean.getUserType());</span>
<span class="nc" id="L4142">				winBean.setUserId(userInfoBean.getUserId());</span>
<span class="nc" id="L4143">				winBean.setRefMerchantId(refMerchantId);</span>
<span class="nc" id="L4144">				winBean.setPwtTicketType(&quot;ORIGINAL&quot;);</span>
<span class="nc" id="L4145">				winBean.setGameId(gameId);</span>
<span class="nc" id="L4146">				winBean.setGameDispName(Util.getGameDisplayName(gameId));</span>
<span class="nc" id="L4147">				ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L4148">				ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L4149">				sReq.setServiceName(ServiceName.PWT_MGMT);</span>
<span class="nc" id="L4150">				sReq.setServiceMethod(ServiceMethodName.RAFFLE_PRZE_WINNING_TICKET);</span>
<span class="nc" id="L4151">				sReq.setServiceData(winBean);</span>
<span class="nc" id="L4152">				sRes = delegate.getResponse(sReq);</span>

<span class="nc" id="L4154">				winBean = (PWTDrawBean) new Gson().fromJson((JsonElement) sRes.getResponseData(), type);</span>

				// winBean = (PWTDrawBean) sRes.getResponseData();

<span class="nc" id="L4158">				List raffleDrawIdBeanList = winBean.getRaffleDrawIdBeanList();</span>
<span class="nc bnc" id="L4159" title="All 2 branches missed.">				if (raffleDrawIdBeanList.size() &lt; 1) {</span>
<span class="nc" id="L4160">					mainPwtBean.setStatus(&quot;ERROR&quot;);</span>
<span class="nc" id="L4161">					return mainPwtBean;</span>
				}

<span class="nc" id="L4164">				RaffleDrawIdBean raffleWinningBean = (RaffleDrawIdBean) raffleDrawIdBeanList.get(0);</span>

<span class="nc" id="L4166">				logger.debug(raffleWinningBean.isValid() + &quot;************Test***********&quot;);</span>
<span class="nc bnc" id="L4167" title="All 2 branches missed.">				if (sRes.getIsRaffleSuccess()) {</span>
					// LMS
<span class="nc bnc" id="L4169" title="All 2 branches missed.">					if (raffleWinningBean.getStatus().equalsIgnoreCase(&quot;ERROR&quot;)) {</span>
<span class="nc" id="L4170">						raffleWinningBean.setStatus(&quot;ERROR&quot;);</span>
<span class="nc" id="L4171">						mainPwtBean.setStatus(&quot;ERROR&quot;);</span>
<span class="nc" id="L4172">						return mainPwtBean;</span>
<span class="nc bnc" id="L4173" title="All 2 branches missed.">					} else if (raffleWinningBean.getStatus().equalsIgnoreCase(&quot;CANCELLED&quot;)) {</span>
<span class="nc" id="L4174">						raffleWinningBean.setStatus(&quot;CANCELLED&quot;);</span>
<span class="nc" id="L4175">						mainPwtBean.setStatus(&quot;CANCELLED&quot;);</span>
<span class="nc" id="L4176">						return mainPwtBean;</span>
					}

<span class="nc" id="L4179">					RetailerPwtProcessHelper pwtProcess = new RetailerPwtProcessHelper();</span>
<span class="nc" id="L4180">					pwtProcess.verifyDrawPwt(winBean.getTicketNo(), winBean.getGameNo(), connection, userInfoBean,</span>
							highPrizeCriteria, highPrizeAmt, winBean, highPrizeScheme, false, &quot;RAFFLE&quot;, null);
					// connection.commit();
					// connection.close();
<span class="nc" id="L4184">					winBean.setStatus(&quot;SUCCESS&quot;);</span>
<span class="nc" id="L4185">					mainPwtBean.setStatus(&quot;SUCCESS&quot;);</span>
					// winningBeanList.add(winBean);
<span class="nc" id="L4187">					winningBeanList.add(winBean);</span>
<span class="nc" id="L4188">					mainPwtBean.setWinningBeanList(winningBeanList);</span>

<span class="nc" id="L4190">				} else {</span>

<span class="nc bnc" id="L4192" title="All 2 branches missed.">					if (&quot;TICKET_EXPIRED&quot;.equalsIgnoreCase(raffleWinningBean.getStatus())) {</span>
<span class="nc" id="L4193">						logger.debug(&quot;Ticket has been expired.&quot;);</span>
<span class="nc" id="L4194">						raffleWinningBean.setStatus(&quot;TICKET_EXPIRED&quot;);</span>
<span class="nc" id="L4195">						winBean.setStatus(&quot;TICKET_EXPIRED&quot;);</span>
<span class="nc" id="L4196">						mainPwtBean.setStatus(&quot;TICKET_EXPIRED&quot;);</span>
<span class="nc" id="L4197">						winningBeanList.add(winBean);</span>
<span class="nc" id="L4198">						mainPwtBean.setWinningBeanList(winningBeanList);</span>
<span class="nc" id="L4199">						return mainPwtBean;</span>

					} else {
<span class="nc" id="L4202">						logger.debug(&quot;inside invalid ticket &quot;);</span>
<span class="nc" id="L4203">						boolean isFraud = ResponsibleGaming.respGaming(userInfoBean, &quot;DG_PWT_INVALID&quot;, &quot;1&quot;);</span>
<span class="nc" id="L4204">						logger.debug(&quot;*****is fraud***** &quot; + isFraud);</span>
<span class="nc bnc" id="L4205" title="All 2 branches missed.">						if (isFraud) {</span>
<span class="nc" id="L4206">							raffleWinningBean.setStatus(&quot;FRAUD&quot;);</span>
<span class="nc" id="L4207">							winBean.setStatus(&quot;FRAUD&quot;);</span>
<span class="nc" id="L4208">							mainPwtBean.setStatus(&quot;FRAUD&quot;);</span>
<span class="nc" id="L4209">							winningBeanList.add(winBean);</span>
<span class="nc" id="L4210">							mainPwtBean.setWinningBeanList(winningBeanList);</span>
<span class="nc" id="L4211">							return mainPwtBean;</span>
						} else {
<span class="nc" id="L4213">							raffleWinningBean.setValid(false);</span>
<span class="nc" id="L4214">							raffleWinningBean.setStatus(&quot;ERROR&quot;);</span>
<span class="nc" id="L4215">							winBean.setStatus(&quot;ERROR&quot;);</span>
<span class="nc" id="L4216">							mainPwtBean.setStatus(&quot;ERROR&quot;);</span>
<span class="nc" id="L4217">							winningBeanList.add(winBean);</span>
<span class="nc" id="L4218">							mainPwtBean.setWinningBeanList(winningBeanList);</span>
<span class="nc" id="L4219">							return mainPwtBean;</span>
						}
					}
				}

<span class="nc" id="L4224">			} else {</span>
<span class="nc" id="L4225">				mainPwtBean.setPwtTicketType(&quot;DRAW&quot;);</span>
<span class="nc" id="L4226">				ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L4227">				ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L4228">				sReq.setServiceName(ServiceName.PWT_MGMT);</span>
<span class="nc" id="L4229">				sReq.setServiceMethod(ServiceMethodName.DRAWGAME_PRZE_WINNING_TICKET);</span>
<span class="nc" id="L4230">				PWTDrawBean winBean = new PWTDrawBean();</span>
<span class="nc" id="L4231">				winBean.setByPassDates(byPassDates);</span>
<span class="nc" id="L4232">				winBean.setTicketNo(ticketNumber);</span>
<span class="nc" id="L4233">				winBean.setBarCodeCount(barCodeCount);</span>
<span class="nc" id="L4234">				winBean.setPartyId(userInfoBean.getUserOrgId());</span>
<span class="nc" id="L4235">				winBean.setPartyType(userInfoBean.getUserType());</span>
<span class="nc" id="L4236">				winBean.setUserId(userInfoBean.getUserId());</span>
<span class="nc" id="L4237">				winBean.setRefMerchantId(refMerchantId);</span>
<span class="nc" id="L4238">				winBean.setGameId(gameId);</span>
<span class="nc" id="L4239">				winBean.setGameDispName(Util.getGameDisplayName(gameId));</span>
<span class="nc" id="L4240">				sReq.setServiceData(winBean);</span>

				/*
				 * if(ResponsibleGaming.respGaming( userInfoBean,
				 * &quot;DG_PWT_COUNT&quot;, &quot;1&quot;)){ winBean.setStatus(&quot;FRAUD&quot;);
				 * mainPwtBean.setStatus(&quot;FRAUD&quot;); winningBeanList.add(winBean);
				 * mainPwtBean.setWinningBeanList(winningBeanList); return
				 * mainPwtBean; }
				 */

<span class="nc" id="L4250">				sRes = delegate.getResponse(sReq);</span>

<span class="nc" id="L4252">				winBean = (PWTDrawBean) new Gson().fromJson((JsonElement) sRes.getResponseData(), type);</span>
<span class="nc" id="L4253">				winBean.setErrorCode(sRes.getErrorCode());</span>
<span class="nc" id="L4254">				winBean.setErrorMessage(sRes.getErrorMessage());</span>
				// winBean = (PWTDrawBean) sRes.getResponseData();

<span class="nc bnc" id="L4257" title="All 2 branches missed.">				if (sRes.getIsSuccess()) {</span>
<span class="nc bnc" id="L4258" title="All 2 branches missed.">					if (Boolean.parseBoolean(</span>
							(String) com.skilrock.lms.common.Utility.getPropertyValue(&quot;DO_MATH_ROUNDING_FOR_PWT_AMT&quot;)))
<span class="nc" id="L4260">						CommonMethods.doRoundingForPwtAmt(winBean);</span>

<span class="nc" id="L4262">					RetailerPwtProcessHelper pwtProcess = new RetailerPwtProcessHelper();</span>
<span class="nc" id="L4263">					pwtProcess.verifyDrawPwt(winBean.getTicketNo(), winBean.getGameId(), connection, userInfoBean,</span>
							highPrizeCriteria, highPrizeAmt, winBean, highPrizeScheme, false,
							winBean.getPwtTicketType(), null);
<span class="nc" id="L4266">					connection.commit();</span>
					// connection.close();
<span class="nc" id="L4268">					winBean.setStatus(&quot;SUCCESS&quot;);</span>

<span class="nc" id="L4270">				} else {</span>
<span class="nc bnc" id="L4271" title="All 2 branches missed.">					if (winBean.getErrorCode() == 122) {</span>
<span class="nc" id="L4272">						winBean.setValid(false);</span>
<span class="nc" id="L4273">						winBean.setStatus(&quot;ALREADY_CANCELLED&quot;);</span>
<span class="nc" id="L4274">						mainPwtBean.setStatus(&quot;ALREADY_CANCELLED&quot;);</span>
<span class="nc" id="L4275">						winningBeanList.add(winBean);</span>
<span class="nc" id="L4276">						mainPwtBean.setWinningBeanList(winningBeanList);</span>
<span class="nc" id="L4277">						return mainPwtBean;</span>
					}
<span class="nc bnc" id="L4279" title="All 2 branches missed.">					if (winBean.getErrorCode() == 3001) {</span>
<span class="nc" id="L4280">						winBean.setValid(false);</span>
<span class="nc" id="L4281">						winBean.setStatus(&quot;ERROR_INVALID&quot;);</span>
<span class="nc" id="L4282">						mainPwtBean.setStatus(&quot;ERROR_INVALID&quot;);</span>
<span class="nc" id="L4283">						winningBeanList.add(winBean);</span>
<span class="nc" id="L4284">						mainPwtBean.setWinningBeanList(winningBeanList);</span>
<span class="nc" id="L4285">						return mainPwtBean;</span>
					}

<span class="nc bnc" id="L4288" title="All 2 branches missed.">					if (&quot;TICKET_EXPIRED&quot;.equalsIgnoreCase(winBean.getStatus())) {</span>
<span class="nc" id="L4289">						logger.debug(&quot;Ticket has been expired.&quot;);</span>
<span class="nc" id="L4290">						winBean.setStatus(&quot;TICKET_EXPIRED&quot;);</span>
<span class="nc" id="L4291">						mainPwtBean.setStatus(&quot;TICKET_EXPIRED&quot;);</span>
<span class="nc" id="L4292">						winningBeanList.add(winBean);</span>
<span class="nc" id="L4293">						mainPwtBean.setWinningBeanList(winningBeanList);</span>
<span class="nc" id="L4294">						return mainPwtBean;</span>
					} else {
<span class="nc" id="L4296">						logger.debug(&quot;inside invalid ticket &quot;);</span>
<span class="nc" id="L4297">						boolean isFraud = ResponsibleGaming.respGaming(userInfoBean, &quot;DG_PWT_INVALID&quot;, &quot;1&quot;);</span>
<span class="nc" id="L4298">						logger.debug(&quot;*****is fraud***** &quot; + isFraud);</span>
<span class="nc bnc" id="L4299" title="All 2 branches missed.">						if (isFraud) {</span>
<span class="nc" id="L4300">							winBean.setStatus(&quot;FRAUD&quot;);</span>
<span class="nc" id="L4301">							mainPwtBean.setStatus(&quot;FRAUD&quot;);</span>
<span class="nc" id="L4302">							winningBeanList.add(winBean);</span>
<span class="nc" id="L4303">							mainPwtBean.setWinningBeanList(winningBeanList);</span>
<span class="nc" id="L4304">							return mainPwtBean;</span>

						} else {
<span class="nc" id="L4307">							winBean.setValid(false);</span>
<span class="nc" id="L4308">							winBean.setStatus(&quot;ERROR&quot;);</span>
<span class="nc" id="L4309">							mainPwtBean.setStatus(&quot;ERROR&quot;);</span>
<span class="nc" id="L4310">							winningBeanList.add(winBean);</span>
<span class="nc" id="L4311">							mainPwtBean.setWinningBeanList(winningBeanList);</span>
<span class="nc" id="L4312">							return mainPwtBean;</span>
						}
					}
				}

<span class="nc" id="L4317">				winningBeanList.add(winBean);</span>

				// if and only if priomo tickrt is reference
<span class="nc" id="L4320">				String raffleTktType = getRaffleTktTypeFromgameNbr(gameId, connection);</span>
<span class="nc bnc" id="L4321" title="All 2 branches missed.">				if (&quot;REFERENCE&quot;.equalsIgnoreCase(raffleTktType)) {</span>
					// get the promo ticket from promo tble
<span class="nc" id="L4323">					int len = ticketNumber.length();</span>
<span class="nc" id="L4324">					List&lt;String&gt; promoTicketList = orgOnLineSaleCreditUpdation</span>
							.getAssociatedPromoTicket(ticketNumber.substring(0, len - 1));
<span class="nc bnc" id="L4326" title="All 2 branches missed.">					for (int i = 0; i &lt; promoTicketList.size(); i++) {</span>
<span class="nc" id="L4327">						PWTDrawBean promoWinBean = new PWTDrawBean();</span>
<span class="nc" id="L4328">						promoWinBean.setTicketNo(promoTicketList.get(i) + &quot;0&quot;);</span>
<span class="nc" id="L4329">						promoWinBean.setPartyId(userInfoBean.getUserOrgId());</span>
<span class="nc" id="L4330">						promoWinBean.setPartyType(userInfoBean.getUserType());</span>
<span class="nc" id="L4331">						promoWinBean.setUserId(userInfoBean.getUserId());</span>
<span class="nc" id="L4332">						promoWinBean.setRefMerchantId(refMerchantId);</span>
<span class="nc" id="L4333">						promoWinBean.setPwtTicketType(&quot;REFERENCE&quot;);</span>
						// here identify the type of request for raffle or for
						// draw(standard)
<span class="nc" id="L4336">						sReq.setServiceMethod(ServiceMethodName.RAFFLE_PRZE_WINNING_TICKET);</span>
<span class="nc" id="L4337">						sReq.setServiceData(promoWinBean);</span>
<span class="nc" id="L4338">						sRes = delegate.getResponse(sReq);</span>

<span class="nc" id="L4340">						promoWinBean = (PWTDrawBean) new Gson().fromJson((JsonElement) sRes.getResponseData(), type);</span>
						// promoWinBean = (PWTDrawBean) sRes.getResponseData();

<span class="nc bnc" id="L4343" title="All 2 branches missed.">						if (sRes.getIsSuccess()) {</span>
<span class="nc" id="L4344">							RetailerPwtProcessHelper pwtProcess = new RetailerPwtProcessHelper();</span>
<span class="nc" id="L4345">							pwtProcess.verifyDrawPwt(promoWinBean.getTicketNo(), promoWinBean.getGameId(), connection,</span>
									userInfoBean, highPrizeCriteria, highPrizeAmt, promoWinBean, highPrizeScheme, false,
									&quot;RAFFLE&quot;, null);
							// connection.commit();
							// connection.close();
<span class="nc" id="L4350">							promoWinBean.setStatus(&quot;SUCCESS&quot;);</span>
<span class="nc" id="L4351">							winningBeanList.add(promoWinBean);</span>
<span class="nc" id="L4352">						} else {</span>
<span class="nc" id="L4353">							promoWinBean.setValid(false);</span>
<span class="nc" id="L4354">							promoWinBean.setStatus(&quot;ERROR&quot;);</span>
<span class="nc" id="L4355">							winningBeanList.add(promoWinBean);</span>
<span class="nc" id="L4356">							mainPwtBean.setWinningBeanList(winningBeanList);</span>
<span class="nc" id="L4357">							return mainPwtBean;</span>
						}
					}
				}

<span class="nc" id="L4362">				mainPwtBean.setWinningBeanList(winningBeanList);</span>

			}
<span class="nc" id="L4365">			mainPwtBean = getTotalPWTTkeAmt(mainPwtBean, highPrizeCriteria, highPrizeAmt, connection, userInfoBean);</span>
<span class="nc" id="L4366">			connection.commit();</span>
<span class="nc" id="L4367">			connection.close();</span>

<span class="nc" id="L4369">		} catch (Exception e) {</span>
<span class="nc" id="L4370">			e.printStackTrace();</span>
<span class="nc" id="L4371">			mainPwtBean.setStatus(&quot;ERROR&quot;);</span>
<span class="nc" id="L4372">		}</span>
<span class="nc" id="L4373">		return mainPwtBean;</span>
	}

	public RafflePurchaseBean rafflePurchaseTicket(UserInfoBean userBean, Object gameBean, boolean isPromo)
			throws LMSException, SQLException {
<span class="nc" id="L4378">		RafflePurchaseBean rafflePurchaseBean = new RafflePurchaseBean();</span>
<span class="nc" id="L4379">		fillRaffleBean(rafflePurchaseBean, gameBean);</span>
<span class="nc" id="L4380">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L4381">		long balDed = orgOnLineSaleCreditUpdation.drawTcketSaleBalDeduction(userBean, rafflePurchaseBean.getRaffle_no(),</span>
				0.0, rafflePurchaseBean.getPlrMobileNumber(), con);

<span class="nc" id="L4384">		rafflePurchaseBean.setAdvMsg(</span>
				Util.getAdvMessage(userBean.getUserOrgId(), rafflePurchaseBean.getRaffle_no(), &quot;PLAYER&quot;, &quot;SALE&quot;, &quot;DG&quot;));
<span class="nc bnc" id="L4386" title="All 2 branches missed.">		if (balDed &gt; 0) {</span>
<span class="nc" id="L4387">			rafflePurchaseBean.setRefTransId(balDed + &quot;&quot;);</span>

			// ServiceResponse sRes = new ServiceResponse();
<span class="nc" id="L4390">			ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L4391">			sReq.setServiceName(ServiceName.RAFFLE);</span>
<span class="nc" id="L4392">			sReq.setServiceMethod(ServiceMethodName.RAFFLE_PURCHASE_TICKET);</span>
<span class="nc bnc" id="L4393" title="All 2 branches missed.">			if (isPromo) {</span>
<span class="nc" id="L4394">				rafflePurchaseBean.setPromotkt(true);</span>
			} else {
<span class="nc" id="L4396">				rafflePurchaseBean.setPromotkt(false);</span>
			}

<span class="nc" id="L4399">			sReq.setServiceData(rafflePurchaseBean);</span>
<span class="nc" id="L4400">			IServiceDelegate delegate = ServiceDelegate.getInstance();</span>

<span class="nc" id="L4402">			logger.debug(&quot;Inside rafflePurchaseTicket *******&quot;);</span>
<span class="nc" id="L4403">			String responseString = delegate.getResponseString(sReq);</span>
			// long t1 = System.currentTimeMillis();
			// Type elementType = new TypeToken&lt;KenoResponseBean&gt;(){}.getType();
<span class="nc" id="L4406">			rafflePurchaseBean = new Gson().fromJson(responseString, RafflePurchaseBean.class);</span>
<span class="nc" id="L4407">			fillRaffleBean(rafflePurchaseBean, gameBean);</span>
			// sRes = delegate.getResponseString(sReq);
<span class="nc" id="L4409">			rafflePurchaseBean.setGameDispName(Util.getGameDisplayName(rafflePurchaseBean.getRaffle_no()));</span>
<span class="nc bnc" id="L4410" title="All 2 branches missed.">			if (rafflePurchaseBean.isSuccess()) {</span>

<span class="nc" id="L4412">				rafflePurchaseBean.setSaleStatus(&quot;SUCCESS&quot;);</span>
<span class="nc" id="L4413">				int tktlen = rafflePurchaseBean.getRaffleTicket_no().length();</span>
<span class="nc" id="L4414">				int tickUpd = orgOnLineSaleCreditUpdation.drawTicketSaleTicketUpdate(balDed,</span>
						rafflePurchaseBean.getRaffleTicket_no(), rafflePurchaseBean.getRaffle_no(), userBean,
						rafflePurchaseBean.getPurchaseChannel(), con);

<span class="nc" id="L4418">			} else {</span>
<span class="nc" id="L4419">				rafflePurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
			}

<span class="nc" id="L4422">		} else {</span>
<span class="nc" id="L4423">			rafflePurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
		}

<span class="nc" id="L4426">		return rafflePurchaseBean;</span>

	}

	public PWTDrawBean registerPlayer(String firstName, String lastName, String idNumber, String idType,
			PWTDrawBean drawBean, UserInfoBean userInfoBean) {
<span class="nc" id="L4432">		Connection connection = DBConnect.getConnection();</span>
		try {
<span class="nc" id="L4434">			connection.setAutoCommit(false);</span>
<span class="nc" id="L4435">			ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L4436">			ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L4437">			sReq.setServiceName(ServiceName.PWT_MGMT);</span>
<span class="nc" id="L4438">			IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L4439">			drawBean.setStatus(&quot;REGISTRATION&quot;);</span>
<span class="nc" id="L4440">			String highPrizeScheme = (String) ServletActionContext.getServletContext()</span>
					.getAttribute(&quot;DRAW_GAME_HIGH_PRIZE_SCHEME&quot;);
<span class="nc" id="L4442">			RetailerPwtProcessHelper retPwt = new RetailerPwtProcessHelper();</span>
<span class="nc" id="L4443">			retPwt.plrRegistrationAndApproval(firstName, lastName, idNumber, idType, connection, drawBean, userInfoBean,</span>
					highPrizeScheme);
			// Draw Game Updation of Ticket
<span class="nc" id="L4446">			sReq.setServiceMethod(ServiceMethodName.DRAWGAME_PWT_UPDATE);</span>
<span class="nc" id="L4447">			sReq.setServiceData(drawBean);</span>
<span class="nc" id="L4448">			sRes = delegate.getResponse(sReq);</span>
<span class="nc" id="L4449">			logger.debug(&quot;Registration---&quot; + sRes.getIsSuccess());</span>
<span class="nc bnc" id="L4450" title="All 2 branches missed.">			if (sRes.getIsSuccess()) {</span>
<span class="nc" id="L4451">				connection.commit();</span>
<span class="nc" id="L4452">				drawBean.setStatus(&quot;SUCCESS&quot;);</span>
			} else {
<span class="nc" id="L4454">				drawBean.setStatus(&quot;ERROR&quot;);</span>
			}
<span class="nc" id="L4456">		} catch (Exception e) {</span>
<span class="nc" id="L4457">			e.printStackTrace();</span>
<span class="nc" id="L4458">			drawBean.setStatus(&quot;ERROR&quot;);</span>
		} finally {
<span class="nc bnc" id="L4460" title="All 6 branches missed.">			if (connection != null) {</span>
				try {
<span class="nc" id="L4462">					connection.close();</span>
<span class="nc" id="L4463">				} catch (SQLException e) {</span>
<span class="nc" id="L4464">					e.printStackTrace();</span>
<span class="nc" id="L4465">				}</span>
			}
		}
<span class="nc" id="L4468">		return drawBean;</span>

	}

	/**
	 * This method is used to reprit the promo ticket of standard game oly
	 */

	public Object reprintPromoStdTicket(int gameId, String ticketNo, boolean isPwt, boolean isPromo, Connection con,
			UserInfoBean userInfoBean) {

<span class="nc" id="L4479">		String saleStatus = null;</span>
<span class="nc" id="L4480">		Object reprintBean = null;</span>
<span class="nc" id="L4481">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L4482">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L4483">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
		try {
			/*
			 * Statement stm = con.createStatement(); ResultSet rs = stm
			 * .executeQuery(&quot;select ticket_nbr from st_dg_ret_sale_refund_&quot; +
			 * gameNo + &quot; where ticket_nbr=&quot; + ticketNo);
			 * logger.debug(&quot;Reprint****ticketNo****&quot; + ticketNo);
			 */
<span class="nc" id="L4491">			ReprintBean reprintbean = new ReprintBean();</span>
<span class="nc" id="L4492">			reprintbean.setPwt(isPwt);</span>
<span class="nc" id="L4493">			reprintbean.setTicketNumber(ticketNo + /* &quot;00&quot; */Util.getRpcAppenderForTickets(ticketNo.length())); // CHECK</span>
																												// FOR
																												// NEW
																												// TKT
																												// NUMBER
<span class="nc" id="L4498">			reprintbean.setGameId(gameId);</span>
<span class="nc" id="L4499">			sReq.setServiceData(reprintbean);</span>
			// sReq.setServiceData(ticketNo + &quot;00&quot;);// 00 is appended in case of
			// reprint to set the length
			// of actual ticket
			// This has no affect on functionality.
<span class="nc" id="L4504">			String family = Util.getGameType(gameId);</span>
<span class="nc" id="L4505">			String gameName = Util.getGameName(gameId);</span>
			// String pck = &quot;com.skilrock.lms.beans.&quot;;
			// String pb = &quot;PurchaseBean&quot;;
			// Class familyClass = Class.forName(pck + family + pb);
			/*
			 * if (rs.next() || ticketNo == null) { Method method =
			 * familyClass.getDeclaredMethod(&quot;setSaleStatus&quot;, String.class);
			 * method.invoke(familyClass.newInstance(), &quot;REPRINT_FAIL&quot;); return
			 * familyClass; }
			 */
<span class="nc" id="L4515">			sReq.setServiceName(&quot;playMgmt&quot;);</span>
<span class="nc" id="L4516">			sReq.setServiceMethod(gameName.toLowerCase() + &quot;ReprintTicket&quot;);</span>

			// rg calling
<span class="nc bnc" id="L4519" title="All 4 branches missed.">			boolean isFraud = (isPwt || isPromo) ? false</span>
					: ResponsibleGaming.respGaming(userInfoBean, &quot;DG_REPRINT&quot;, &quot;1&quot;, con);

			// boolean isFraud = ResponsibleGaming.respGaming(userInfoBean,
			// &quot;DG_REPRINT&quot;, &quot;1&quot;, con);
<span class="nc bnc" id="L4524" title="All 2 branches missed.">			if (!isFraud) {</span>
<span class="nc" id="L4525">				sRes = delegate.getResponse(sReq);</span>

<span class="nc" id="L4527">				String responseString = sRes.getResponseData().toString();</span>
<span class="nc" id="L4528">				Type elementType = null;</span>

<span class="nc bnc" id="L4530" title="All 2 branches missed.">				if (sRes.getIsSuccess()) {</span>

					// reprintBean = new Gson().fromJson(responseString,
					// elementType);

<span class="nc bnc" id="L4535" title="All 2 branches missed.">					if (&quot;Fortune&quot;.equals(family)) {</span>
						// FortunePurchaseBean winningBean =
						// (FortunePurchaseBean) reprintBean;
						// responseString = sRes.getResponseData().toString();
<span class="nc" id="L4539">						elementType = new TypeToken&lt;FortunePurchaseBean&gt;() {</span>
						}.getType();
<span class="nc" id="L4541">						FortunePurchaseBean winningBean = new Gson().fromJson(responseString, elementType);</span>
<span class="nc bnc" id="L4542" title="All 2 branches missed.">						if (winningBean.isPromotkt()) {</span>
<span class="nc" id="L4543">							winningBean.setTotalPurchaseAmt(0.0);</span>
						}
<span class="nc" id="L4545">						saleStatus = winningBean.getSaleStatus();</span>
						// return (FortunePurchaseBean) reprintBean;
<span class="nc bnc" id="L4547" title="All 2 branches missed.">					} else if (&quot;Lotto&quot;.equals(family)) {</span>
						// LottoPurchaseBean winningBean = (LottoPurchaseBean)
						// reprintBean;
						// responseString = sRes.getResponseData().toString();
<span class="nc" id="L4551">						elementType = new TypeToken&lt;LottoPurchaseBean&gt;() {</span>
						}.getType();
<span class="nc" id="L4553">						LottoPurchaseBean winningBean = new Gson().fromJson(responseString, elementType);</span>
<span class="nc" id="L4554">						saleStatus = winningBean.getSaleStatus();</span>
						// return (LottoPurchaseBean) reprintBean;

<span class="nc bnc" id="L4557" title="All 2 branches missed.">					} else if (&quot;Keno&quot;.equals(family)) {</span>
						// KenoPurchaseBean winningBean = (KenoPurchaseBean)
						// reprintBean;
						// responseString = sRes.getResponseData().toString();
<span class="nc" id="L4561">						elementType = new TypeToken&lt;KenoPurchaseBean&gt;() {</span>
						}.getType();
<span class="nc" id="L4563">						KenoPurchaseBean winningBean = new Gson().fromJson(responseString, elementType);</span>
<span class="nc" id="L4564">						saleStatus = winningBean.getSaleStatus();</span>
						// return (KenoPurchaseBean) reprintBean;
<span class="nc bnc" id="L4566" title="All 2 branches missed.">					} else if (&quot;FortuneTwo&quot;.equals(family)) {</span>
						// FortuneTwoPurchaseBean winningBean =
						// (FortuneTwoPurchaseBean)reprintBean;
						// responseString = sRes.getResponseData().toString();
<span class="nc" id="L4570">						elementType = new TypeToken&lt;FortuneTwoPurchaseBean&gt;() {</span>
						}.getType();
<span class="nc" id="L4572">						FortuneTwoPurchaseBean winningBean = new Gson().fromJson(responseString, elementType);</span>
<span class="nc" id="L4573">						saleStatus = winningBean.getSaleStatus();</span>
<span class="nc bnc" id="L4574" title="All 2 branches missed.">					} else if (&quot;FortuneThree&quot;.equals(family)) {</span>
						// FortuneThreePurchaseBean winningBean =
						// (FortuneThreePurchaseBean)reprintBean;
						// responseString = sRes.getResponseData().toString();
<span class="nc" id="L4578">						elementType = new TypeToken&lt;FortuneThreePurchaseBean&gt;() {</span>
						}.getType();
<span class="nc" id="L4580">						FortuneThreePurchaseBean winningBean = new Gson().fromJson(responseString, elementType);</span>
<span class="nc" id="L4581">						saleStatus = winningBean.getSaleStatus();</span>
<span class="nc bnc" id="L4582" title="All 2 branches missed.">					} else if (&quot;RAFFLE&quot;.equals(family)) {</span>
<span class="nc" id="L4583">						elementType = new TypeToken&lt;RafflePurchaseBean&gt;() {</span>
						}.getType();
<span class="nc" id="L4585">						RafflePurchaseBean winningBean = new Gson().fromJson(responseString, elementType);</span>
<span class="nc" id="L4586">						saleStatus = winningBean.getSaleStatus();</span>
<span class="nc bnc" id="L4587" title="All 2 branches missed.">					} else if (&quot;Rainbow&quot;.equals(family)) {</span>
<span class="nc" id="L4588">						elementType = new TypeToken&lt;KenoPurchaseBean&gt;() {</span>
						}.getType();
<span class="nc" id="L4590">						KenoPurchaseBean winningBean = new Gson().fromJson(responseString, elementType);</span>
<span class="nc" id="L4591">						saleStatus = winningBean.getSaleStatus();</span>
					}

<span class="nc" id="L4594">					logger.debug(saleStatus + &quot;****reprintTicket rpos helper********&quot;);</span>
<span class="nc bnc" id="L4595" title="All 2 branches missed.">					if (&quot;LIMIT_EXCEEDED&quot;.equalsIgnoreCase(saleStatus)) {</span>
<span class="nc" id="L4596">						return new String(&quot;ErrorMsg:&quot; + EmbeddedErrors.LIMIT_EXCEEDED + &quot;ErrorCode:&quot;</span>
								+ EmbeddedErrors.LIMIT_EXCEEDED_ERROR_CODE + &quot;|&quot;); // Normal
					}
<span class="nc bnc" id="L4599" title="All 2 branches missed.">					if (&quot;PERFORMED&quot;.equalsIgnoreCase(saleStatus)) {</span>
<span class="nc" id="L4600">						return new String(&quot;ErrorMsg:&quot; + EmbeddedErrors.DRAW_PERFORMED + &quot;ErrorCode:&quot;</span>
								+ EmbeddedErrors.DRAW_PERFORMED_ERROR_CODE + &quot;|&quot;);
					}

<span class="nc bnc" id="L4604" title="All 2 branches missed.">					if (&quot;Fortune&quot;.equals(family)) {</span>
<span class="nc" id="L4605">						elementType = new TypeToken&lt;FortunePurchaseBean&gt;() {</span>
						}.getType();
<span class="nc" id="L4607">						FortunePurchaseBean winningBean = new Gson().fromJson(responseString, elementType);</span>
<span class="nc" id="L4608">						return winningBean;</span>
<span class="nc bnc" id="L4609" title="All 2 branches missed.">					} else if (&quot;Lotto&quot;.equals(family)) {</span>
<span class="nc" id="L4610">						elementType = new TypeToken&lt;LottoPurchaseBean&gt;() {</span>
						}.getType();
<span class="nc" id="L4612">						LottoPurchaseBean winningBean = new Gson().fromJson(responseString, elementType);</span>
<span class="nc" id="L4613">						return winningBean;</span>
<span class="nc bnc" id="L4614" title="All 2 branches missed.">					} else if (&quot;Keno&quot;.equals(family)) {</span>
<span class="nc" id="L4615">						elementType = new TypeToken&lt;KenoPurchaseBean&gt;() {</span>
						}.getType();
<span class="nc" id="L4617">						KenoPurchaseBean winningBean = new Gson().fromJson(responseString, elementType);</span>
<span class="nc" id="L4618">						return winningBean;</span>
<span class="nc bnc" id="L4619" title="All 2 branches missed.">					} else if (&quot;FortuneTwo&quot;.equals(family)) {</span>
<span class="nc" id="L4620">						elementType = new TypeToken&lt;FortuneThreePurchaseBean&gt;() {</span>
						}.getType();
<span class="nc" id="L4622">						FortuneThreePurchaseBean winningBean = new Gson().fromJson(responseString, elementType);</span>
<span class="nc" id="L4623">						return winningBean;</span>
<span class="nc bnc" id="L4624" title="All 2 branches missed.">					} else if (&quot;FortuneThree&quot;.equalsIgnoreCase(family)) {</span>
<span class="nc" id="L4625">						elementType = new TypeToken&lt;FortuneThreePurchaseBean&gt;() {</span>
						}.getType();
<span class="nc" id="L4627">						FortuneThreePurchaseBean winningBean = new Gson().fromJson(responseString, elementType);</span>
<span class="nc" id="L4628">						return winningBean;</span>
<span class="nc bnc" id="L4629" title="All 2 branches missed.">					} else if (&quot;RAFFLE&quot;.equalsIgnoreCase(family)) {</span>
<span class="nc" id="L4630">						elementType = new TypeToken&lt;RafflePurchaseBean&gt;() {</span>
						}.getType();
<span class="nc" id="L4632">						RafflePurchaseBean winningBean = new Gson().fromJson(responseString, elementType);</span>
<span class="nc" id="L4633">						return winningBean;</span>
<span class="nc bnc" id="L4634" title="All 2 branches missed.">					} else if (&quot;Rainbow&quot;.equalsIgnoreCase(family)) {</span>
<span class="nc" id="L4635">						elementType = new TypeToken&lt;KenoPurchaseBean&gt;() {</span>
						}.getType();
<span class="nc" id="L4637">						KenoPurchaseBean winningBean = new Gson().fromJson(responseString, elementType);</span>
<span class="nc" id="L4638">						return winningBean;</span>
					}
				}
<span class="nc" id="L4641">			} else {</span>
				// com.skilrock.lms.common.utility.CommonMethods
				// .fetchUpdatedReprintCount(gameNo, ticketNo, -1);
<span class="nc" id="L4644">				return new String(&quot;RG_RPERINT&quot;); // Responsible Gaming</span>
				// Reprint Limit Exceed
			}
<span class="nc" id="L4647">		} catch (Exception e) {</span>
<span class="nc" id="L4648">			e.printStackTrace();</span>
<span class="nc" id="L4649">		}</span>
<span class="nc" id="L4650">		return null;</span>
	}

	/**
	 * this method is used to reprint the raflle ticket only
	 */
	public Object reprintRaffleTicket(boolean isFirstTime, Connection con, int gameId, boolean isPwt,
			String tktNumber) {

		String saleStatus;
<span class="nc" id="L4660">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L4661">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L4662">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
		// Object reprintRaffleBean = null;
<span class="nc" id="L4664">		ReprintBean reprintbean = new ReprintBean();</span>
<span class="nc" id="L4665">		String raffleTicketType = getRaffleTktTypeFromgameNbr(gameId, con);</span>
<span class="nc bnc" id="L4666" title="All 4 branches missed.">		if (isFirstTime || raffleTicketType.equalsIgnoreCase(&quot;REFERENCE&quot;)) {</span>
<span class="nc" id="L4667">			reprintbean.setPwt(isPwt);</span>
<span class="nc" id="L4668">			reprintbean.setTicketNumber(tktNumber);</span>
<span class="nc" id="L4669">			reprintbean.setGameId(gameId);</span>
<span class="nc" id="L4670">			sReq.setServiceData(reprintbean);</span>
<span class="nc" id="L4671">			sReq.setServiceName(ServiceName.RAFFLE);</span>
<span class="nc" id="L4672">			sReq.setServiceMethod(ServiceMethodName.RAFFLE_REPRINT_TICKET);</span>
<span class="nc" id="L4673">			sRes = delegate.getResponse(sReq);</span>
<span class="nc" id="L4674">			String responseString = sRes.getResponseData().toString();</span>
<span class="nc" id="L4675">			Type elementType = null;</span>
<span class="nc bnc" id="L4676" title="All 2 branches missed.">			if (sRes.getIsSuccess()) {</span>
<span class="nc" id="L4677">				elementType = new TypeToken&lt;RafflePurchaseBean&gt;() {</span>
				}.getType();
<span class="nc" id="L4679">				RafflePurchaseBean rafflePurchaseBean = new Gson().fromJson(responseString, elementType);</span>
				// reprintRaffleBean = sRes.getResponseData();
				// RafflePurchaseBean rafflePurchaseBean = (RafflePurchaseBean)
				// reprintRaffleBean;
<span class="nc" id="L4683">				saleStatus = rafflePurchaseBean.getSaleStatus();</span>
<span class="nc bnc" id="L4684" title="All 2 branches missed.">				if (&quot;LIMIT_EXCEEDED&quot;.equalsIgnoreCase(saleStatus)) {</span>
<span class="nc" id="L4685">					return new String(&quot;Reprint Limit Exceed&quot;); // Normal</span>
				}
<span class="nc bnc" id="L4687" title="All 2 branches missed.">				if (&quot;PERFORMED&quot;.equalsIgnoreCase(saleStatus)) {</span>
<span class="nc" id="L4688">					return new String(&quot;Draw Performed&quot;);</span>
				}
<span class="nc" id="L4690">				rafflePurchaseBean.setRaffleTicketType(raffleTicketType);</span>
<span class="nc" id="L4691">				return rafflePurchaseBean;</span>
			}
		}
<span class="nc" id="L4694">		return null;</span>

	}

	public Object reprintTicket(UserInfoBean userInfoBean) {
<span class="nc" id="L4699">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L4700">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L4701">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L4702">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L4703">		Object reprintBean = null;</span>
<span class="nc" id="L4704">		int gameNo = 0;</span>
<span class="nc" id="L4705">		String saleStatus = null;</span>
<span class="nc" id="L4706">		String gameNoQry = &quot;select transaction_id,game_nbr from st_lms_retailer_transaction_master srtm,st_dg_game_master sdgm where retailer_org_id=&quot;</span>
				+ userInfoBean.getUserOrgId()
				+ &quot; and srtm.game_id=sdgm.game_id and transaction_type like 'DG_%' order by transaction_id desc limit 1&quot;;
<span class="nc" id="L4709">		logger.debug(&quot;Reprint**&quot; + gameNoQry);</span>
		try {
<span class="nc" id="L4711">			con.setAutoCommit(false);</span>
<span class="nc" id="L4712">			Statement stm = con.createStatement();</span>
<span class="nc" id="L4713">			ResultSet rs = stm.executeQuery(gameNoQry);</span>
<span class="nc" id="L4714">			String ticketNo = null;</span>
<span class="nc" id="L4715">			int txId = 0;</span>

<span class="nc bnc" id="L4717" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L4718">				gameNo = rs.getShort(&quot;game_nbr&quot;);</span>
<span class="nc" id="L4719">				txId = rs.getInt(&quot;transaction_id&quot;);</span>
			}
<span class="nc" id="L4721">			rs = stm.executeQuery(&quot;select ticket_nbr from st_dg_ret_sale_&quot; + gameNo + &quot; where transaction_id=&quot; + txId);</span>
<span class="nc bnc" id="L4722" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L4723">				ticketNo = rs.getString(&quot;ticket_nbr&quot;);</span>
			}
<span class="nc" id="L4725">			rs = stm.executeQuery(</span>
					&quot;select ticket_nbr from st_dg_ret_sale_refund_&quot; + gameNo + &quot; where ticket_nbr=&quot; + ticketNo);
			// check for pwt claimed for whole ticket
			//

<span class="nc" id="L4730">			logger.debug(&quot;Reprint****ticketNo****&quot; + ticketNo);</span>
<span class="nc" id="L4731">			sReq.setServiceData(ticketNo + &quot;00&quot;);// 00 is appended in case of</span>
			// reprint to set the length
			// of actual ticket
			// This has no affect on functionality.
<span class="nc" id="L4735">			String family = Util.getGameType(gameNo);</span>
<span class="nc" id="L4736">			String gameName = Util.getGameName(gameNo);</span>
<span class="nc" id="L4737">			String pck = &quot;com.skilrock.lms.beans.&quot;;</span>
<span class="nc" id="L4738">			String pb = &quot;PurchaseBean&quot;;</span>
<span class="nc" id="L4739">			Class familyClass = Class.forName(pck + family + pb);</span>
<span class="nc bnc" id="L4740" title="All 4 branches missed.">			if (rs.next() || ticketNo == null) {</span>
<span class="nc" id="L4741">				Method method = familyClass.getDeclaredMethod(&quot;setSaleStatus&quot;, String.class);</span>
<span class="nc" id="L4742">				method.invoke(familyClass.newInstance(), &quot;REPRINT_FAIL&quot;);</span>
<span class="nc" id="L4743">				return familyClass;</span>
			}
<span class="nc" id="L4745">			sReq.setServiceName(gameName.toLowerCase() + &quot;Module&quot;);</span>
<span class="nc" id="L4746">			sReq.setServiceMethod(&quot;reprintTicket&quot;);</span>
<span class="nc" id="L4747">			sRes = delegate.getResponse(sReq);</span>
<span class="nc bnc" id="L4748" title="All 2 branches missed.">			if (sRes.getIsSuccess()) {</span>
				// rg calling
<span class="nc" id="L4750">				boolean isFraud = ResponsibleGaming.respGaming(userInfoBean, &quot;DG_REPRINT&quot;, &quot;1&quot;, con);</span>
<span class="nc bnc" id="L4751" title="All 2 branches missed.">				if (!isFraud) {</span>
<span class="nc" id="L4752">					reprintBean = sRes.getResponseData();</span>

					// This code is just a backup, if the Applet Barcode
					// printing fails
					// There here is a duplicacy of fetching family type.

<span class="nc bnc" id="L4758" title="All 2 branches missed.">					if (&quot;Fortune&quot;.equals(family)) {</span>
<span class="nc" id="L4759">						FortunePurchaseBean winningBean = (FortunePurchaseBean) reprintBean;</span>
<span class="nc" id="L4760">						saleStatus = winningBean.getSaleStatus();</span>
<span class="nc bnc" id="L4761" title="All 2 branches missed.">					} else if (&quot;Lotto&quot;.equals(family)) {</span>
<span class="nc" id="L4762">						LottoPurchaseBean winningBean = (LottoPurchaseBean) reprintBean;</span>
<span class="nc" id="L4763">						saleStatus = winningBean.getSaleStatus();</span>

<span class="nc bnc" id="L4765" title="All 2 branches missed.">					} else if (&quot;Keno&quot;.equals(family)) {</span>
<span class="nc" id="L4766">						KenoPurchaseBean winningBean = (KenoPurchaseBean) reprintBean;</span>
<span class="nc" id="L4767">						saleStatus = winningBean.getSaleStatus();</span>

<span class="nc bnc" id="L4769" title="All 2 branches missed.">					} else if (&quot;FortuneTwo&quot;.equals(family)) {</span>
<span class="nc" id="L4770">						FortuneTwoPurchaseBean winningBean = (FortuneTwoPurchaseBean) reprintBean;</span>
<span class="nc" id="L4771">						saleStatus = winningBean.getSaleStatus();</span>
<span class="nc bnc" id="L4772" title="All 2 branches missed.">					} else if (&quot;FortuneThree&quot;.equalsIgnoreCase(family)) {</span>
<span class="nc" id="L4773">						FortuneThreePurchaseBean winningBean = (FortuneThreePurchaseBean) reprintBean;</span>
<span class="nc" id="L4774">						saleStatus = winningBean.getSaleStatus();</span>
					}

<span class="nc" id="L4777">					logger.debug(saleStatus + &quot;****reprintTicket rpos helper********&quot;);</span>
<span class="nc bnc" id="L4778" title="All 2 branches missed.">					if (&quot;LIMIT_EXCEEDED&quot;.equalsIgnoreCase(saleStatus)) {</span>
<span class="nc" id="L4779">						return new String(&quot;Reprint Limit Exceed&quot;); // Normal</span>
					}
<span class="nc bnc" id="L4781" title="All 2 branches missed.">					if (&quot;PERFORMED&quot;.equalsIgnoreCase(saleStatus)) {</span>
<span class="nc" id="L4782">						return new String(&quot;Draw Performed&quot;);</span>
					}
<span class="nc" id="L4784">					con.commit();</span>
<span class="nc bnc" id="L4785" title="All 2 branches missed.">					if (&quot;Fortune&quot;.equals(family)) {</span>
<span class="nc" id="L4786">						return (FortunePurchaseBean) reprintBean;</span>
<span class="nc bnc" id="L4787" title="All 2 branches missed.">					} else if (&quot;Lotto&quot;.equals(family)) {</span>
<span class="nc" id="L4788">						return (LottoPurchaseBean) reprintBean;</span>
<span class="nc bnc" id="L4789" title="All 2 branches missed.">					} else if (&quot;Keno&quot;.equals(family)) {</span>
<span class="nc" id="L4790">						return (KenoPurchaseBean) reprintBean;</span>
<span class="nc bnc" id="L4791" title="All 2 branches missed.">					} else if (&quot;FortuneTwo&quot;.equals(family)) {</span>
<span class="nc" id="L4792">						return (FortuneTwoPurchaseBean) reprintBean;</span>
<span class="nc bnc" id="L4793" title="All 2 branches missed.">					} else if (&quot;FortuneThree&quot;.equalsIgnoreCase(family)) {</span>
<span class="nc" id="L4794">						return (FortuneThreePurchaseBean) reprintBean;</span>
					}
				} else {
<span class="nc" id="L4797">					return new String(&quot;RG_RPERINT&quot;); // Responsible Gaming</span>
					// Reprint Limit Exceed
				}
			}
<span class="nc" id="L4801">		} catch (Exception e) {</span>
<span class="nc" id="L4802">			e.printStackTrace();</span>
		} finally {
<span class="nc bnc" id="L4804" title="All 24 branches missed.">			if (con != null) {</span>
				try {
<span class="nc" id="L4806">					con.close();</span>
<span class="nc" id="L4807">				} catch (SQLException e) {</span>
<span class="nc" id="L4808">					e.printStackTrace();</span>
<span class="nc" id="L4809">				}</span>
			}
		}
<span class="nc" id="L4812">		return null;</span>
	}

	public Object reprintTicket(UserInfoBean userInfoBean, boolean isPwt, String tkNbrPwt, boolean isFirstTime,
			String txnId, String interfaceType) {

<span class="nc" id="L4818">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L4819">		int gameId = 0;</span>
<span class="nc" id="L4820">		String phoneNo = null;</span>
<span class="nc" id="L4821">		String gameNoQry = &quot;select srtm.transaction_id,sdgm.game_id,interface from st_lms_retailer_transaction_master srtm,st_dg_game_master sdgm,st_lms_transaction_master tm where retailer_org_id=&quot;</span>
				+ userInfoBean.getUserOrgId()
				+ &quot; and srtm.game_id=sdgm.game_id and transaction_type like 'DG_%' and tm.transaction_id=srtm.transaction_id order by transaction_id desc limit 1&quot;;
<span class="nc" id="L4824">		logger.debug(&quot;Reprint**&quot; + gameNoQry);</span>
<span class="nc" id="L4825">		String ticketNo = null;</span>
		try {
<span class="nc" id="L4827">			con.setAutoCommit(false);</span>

<span class="nc bnc" id="L4829" title="All 4 branches missed.">			if (txnId != null &amp;&amp; Long.parseLong(txnId) &gt; 0) {</span>
<span class="nc" id="L4830">				ticketNo = getTicketNumberFrmTxnId(txnId, userInfoBean.getUserOrgId());</span>

			} else {

<span class="nc" id="L4834">				Statement stm = con.createStatement();</span>
<span class="nc" id="L4835">				ResultSet rs = stm.executeQuery(gameNoQry);</span>
<span class="nc" id="L4836">				String purchInterFace = &quot;&quot;;</span>

<span class="nc bnc" id="L4838" title="All 2 branches missed.">				if (!isPwt) {</span>
<span class="nc" id="L4839">					long txId = 0;</span>

<span class="nc bnc" id="L4841" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L4842">						gameId = rs.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L4843">						txId = rs.getLong(&quot;transaction_id&quot;);</span>
<span class="nc" id="L4844">						purchInterFace = rs.getString(&quot;interface&quot;);</span>
					}
<span class="nc bnc" id="L4846" title="All 2 branches missed.">					if (!interfaceType.equalsIgnoreCase(purchInterFace)) {</span>
<span class="nc" id="L4847">						return null;</span>
					}

<span class="nc" id="L4850">					double mrpAmount = 0.0;</span>
<span class="nc" id="L4851">					rs = stm.executeQuery(&quot;select ticket_nbr,mrp_amt,player_mob_number from st_dg_ret_sale_&quot; + gameId</span>
							+ &quot; where transaction_id=&quot; + txId);
<span class="nc bnc" id="L4853" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L4854">						ticketNo = rs.getString(&quot;ticket_nbr&quot;);</span>
<span class="nc" id="L4855">						mrpAmount = rs.getDouble(&quot;mrp_amt&quot;);</span>
<span class="nc" id="L4856">						phoneNo = rs.getString(&quot;player_mob_number&quot;);</span>
<span class="nc bnc" id="L4857" title="All 2 branches missed.">						if (mrpAmount &gt; 0) {</span>
							// it is sale ticket
						} else {
							// it is promo ticket go to the mapping table to get
							// the
							// sale ticket
<span class="nc" id="L4863">							rs = stm.executeQuery(</span>
									&quot;select sale_ticket_nbr from ge_sale_promo_ticket_mapping where promo_ticket_nbr=&quot;
											+ ticketNo);
<span class="nc bnc" id="L4866" title="All 2 branches missed.">							while (rs.next()) {</span>
<span class="nc" id="L4867">								ticketNo = rs.getString(&quot;sale_ticket_nbr&quot;);</span>
							}
						}
					}
<span class="nc" id="L4871">				} else {</span>
<span class="nc" id="L4872">					ticketNo = tkNbrPwt;</span>
					// gameId=Util.getGameIdFromGameNumber(Util.getGamenoFromTktnumber(ticketNo+/*&quot;00&quot;*/Util.getRpcAppenderForTickets(ticketNo.length())));
					// // CHECK ON THE BASIS OF TKTA OR TKTB IN REPRINT
				}
			}

<span class="nc bnc" id="L4878" title="All 2 branches missed.">			if (ticketNo == null) {</span>
				//return EmbeddedErrors.REPRINT_FAIL.replace(&quot;|&quot;, &quot;&quot;);
<span class="nc" id="L4880">				return &quot;ErrorMsg:&quot; + EmbeddedErrors.REPRINT_FAIL+&quot;ErrorCode:&quot; + EmbeddedErrors.REPRINT_FAIL_ERROR_CODE+&quot;|&quot;;</span>

			}
			// gameNo = getGamenoFromTktnumber(ticketNo + &quot;00&quot;);
<span class="nc" id="L4884">			gameId = Util.getGameIdFromGameNumber(</span>
					Util.getGamenoFromTktnumber(ticketNo + /* &quot;00&quot; */Util.getRpcAppenderForTickets(ticketNo.length()))); // CHECK
																															// ON
																															// THE
																															// BASIS
																															// OF
																															// TKTA
																															// OR
																															// TKTB
																															// IN
																															// REPRINT

<span class="nc bnc" id="L4896" title="All 2 branches missed.">			if (gameId == 0) {</span>
<span class="nc" id="L4897">				return &quot;ErrorMsg:&quot; + EmbeddedErrors.REPRINT_FAIL_ERROR_MSG + &quot;ErrorCode:&quot;</span>
						+ EmbeddedErrors.REPRINT_FAIL_ERR_CODE + &quot;|&quot;;
			}

<span class="nc" id="L4901">			Statement stm = con.createStatement();</span>
<span class="nc" id="L4902">			ResultSet rs = stm.executeQuery(</span>
					&quot;select ticket_nbr from st_dg_ret_sale_refund_&quot; + gameId + &quot; where ticket_nbr=&quot; + ticketNo);
<span class="nc" id="L4904">			logger.debug(&quot;Reprint****ticketNo****&quot; + ticketNo);</span>

<span class="nc bnc" id="L4906" title="All 4 branches missed.">			if (rs.next() || ticketNo == null) {</span>

<span class="nc" id="L4908">				return &quot;ErrorMsg:&quot; + EmbeddedErrors.REPRINT_FAIL_ERROR_MSG + &quot;ErrorCode:&quot;</span>
						+ EmbeddedErrors.REPRINT_FAIL_ERR_CODE + &quot;|&quot;;
			}

<span class="nc" id="L4912">			List&lt;RafflePurchaseBean&gt; rafflePurchaseBeanList = new ArrayList&lt;RafflePurchaseBean&gt;();</span>
<span class="nc" id="L4913">			boolean isStdtkeRprtSuccess = false;</span>
<span class="nc" id="L4914">			Object gameBean = reprintPromoStdTicket(gameId, ticketNo, isPwt, false, con, userInfoBean);</span>
<span class="nc" id="L4915">			FortunePurchaseBean fortunebean = null;</span>
<span class="nc" id="L4916">			LottoPurchaseBean lottobean = null;</span>
<span class="nc" id="L4917">			KenoPurchaseBean kenobean = null;</span>
<span class="nc" id="L4918">			FortuneTwoPurchaseBean fortuneTwoBean = null;</span>
<span class="nc" id="L4919">			FortuneThreePurchaseBean fortuneThreeBean = null;</span>
<span class="nc" id="L4920">			RafflePurchaseBean rafflePurchaseBean = null;</span>
<span class="nc" id="L4921">			AjaxRequestHelper ajxHelper = new AjaxRequestHelper();</span>
<span class="nc" id="L4922">			ajxHelper.getAvlblCreditAmt(userInfoBean, con);</span>
			// ---
<span class="nc bnc" id="L4924" title="All 2 branches missed.">			if (gameBean instanceof CommonPurchaseBean) {</span>
<span class="nc" id="L4925">				CommonPurchaseBean commonBean = (CommonPurchaseBean) gameBean;</span>
<span class="nc" id="L4926">				commonBean.setAdvMsg(Util.getAdvMessage(userInfoBean.getUserOrgId(), gameId, &quot;PLAYER&quot;, &quot;SALE&quot;, &quot;DG&quot;));</span>
			}
			// ---
<span class="nc bnc" id="L4929" title="All 2 branches missed.">			if (gameBean instanceof RafflePurchaseBean) {</span>
<span class="nc" id="L4930">				rafflePurchaseBean = (RafflePurchaseBean) gameBean;</span>
<span class="nc" id="L4931">				isStdtkeRprtSuccess = true;</span>
<span class="nc bnc" id="L4932" title="All 2 branches missed.">			} else if (gameBean instanceof FortunePurchaseBean) {</span>
<span class="nc" id="L4933">				fortunebean = (FortunePurchaseBean) gameBean;</span>
<span class="nc" id="L4934">				isStdtkeRprtSuccess = true;</span>

<span class="nc bnc" id="L4936" title="All 2 branches missed.">			} else if (gameBean instanceof LottoPurchaseBean) {</span>
<span class="nc" id="L4937">				lottobean = (LottoPurchaseBean) gameBean;</span>
<span class="nc" id="L4938">				isStdtkeRprtSuccess = true;</span>

<span class="nc bnc" id="L4940" title="All 2 branches missed.">			} else if (gameBean instanceof KenoPurchaseBean) {</span>
<span class="nc" id="L4941">				kenobean = (KenoPurchaseBean) gameBean;</span>
<span class="nc" id="L4942">				kenobean.setPlrMobileNumber(phoneNo);</span>
<span class="nc" id="L4943">				kenobean.setAdvMsg(Util.getAdvMessage(userInfoBean.getUserOrgId(), gameId, &quot;PLAYER&quot;, &quot;SALE&quot;, &quot;DG&quot;));</span>
<span class="nc" id="L4944">				isStdtkeRprtSuccess = true;</span>

<span class="nc bnc" id="L4946" title="All 2 branches missed.">			} else if (gameBean instanceof FortuneTwoPurchaseBean) {</span>
<span class="nc" id="L4947">				fortuneTwoBean = (FortuneTwoPurchaseBean) gameBean;</span>
<span class="nc" id="L4948">				isStdtkeRprtSuccess = true;</span>

<span class="nc bnc" id="L4950" title="All 2 branches missed.">			} else if (gameBean instanceof FortuneThreePurchaseBean) {</span>
<span class="nc" id="L4951">				fortuneThreeBean = (FortuneThreePurchaseBean) gameBean;</span>
<span class="nc" id="L4952">				isStdtkeRprtSuccess = true;</span>
			}

<span class="nc bnc" id="L4955" title="All 4 branches missed.">			else if (gameBean instanceof String &amp;&amp; &quot;RG_RPERINT&quot;.equals(gameBean.toString())) {</span>
<span class="nc" id="L4956">				return new String(&quot;RG_RPERINT&quot;);</span>
<span class="nc bnc" id="L4957" title="All 2 branches missed.">			} else if (gameBean instanceof String) {</span>
<span class="nc" id="L4958">				return gameBean.toString();</span>
			} else {
<span class="nc" id="L4960">				return new String(&quot;ErrorMsg:&quot; + EmbeddedErrors.REPRINT_FAIL_ERROR_MSG + &quot;ErrorCode:&quot;</span>
						+ EmbeddedErrors.REPRINT_FAIL_ERR_CODE + &quot;|&quot;);
			}

<span class="nc bnc" id="L4964" title="All 2 branches missed.">			if (isStdtkeRprtSuccess) {</span>
<span class="nc" id="L4965">				List&lt;String&gt; promoTicketList = orgOnLineSaleCreditUpdation.getAssociatedPromoTicket(ticketNo, con);</span>
<span class="nc bnc" id="L4966" title="All 4 branches missed.">				if (promoTicketList != null &amp;&amp; promoTicketList.size() &gt; 0) {</span>
<span class="nc" id="L4967">					List&lt;LottoPurchaseBean&gt; lottoBeanList = new ArrayList&lt;LottoPurchaseBean&gt;();</span>
<span class="nc bnc" id="L4968" title="All 2 branches missed.">					for (int i = 0; i &lt; promoTicketList.size(); i++) {</span>
<span class="nc" id="L4969">						String proMoTktNumber = promoTicketList.get(i);</span>
<span class="nc" id="L4970">						gameId = Util.getGameIdFromGameNumber(getGamenoFromTktnumber(promoTicketList.get(i)</span>
								+ Util.getRpcAppenderForTickets(promoTicketList.get(i).length())));
<span class="nc" id="L4972">						String gameType = Util.getGameType(gameId);</span>
<span class="nc bnc" id="L4973" title="All 2 branches missed.">						if (gameType == null) {</span>
<span class="nc" id="L4974">							return new String(&quot;ErrorMsg:&quot; + EmbeddedErrors.REPRINT_FAIL_ERROR_MSG + &quot;ErrorCode:&quot;</span>
									+ EmbeddedErrors.REPRINT_FAIL_ERR_CODE + &quot;|&quot;);
						}

<span class="nc bnc" id="L4978" title="All 2 branches missed.">						if (&quot;RAFFLE&quot;.equalsIgnoreCase(gameType)) {</span>
<span class="nc" id="L4979">							Object raffleGameBean = reprintRaffleTicket(isFirstTime, con, gameId, isPwt,</span>
									proMoTktNumber + Util.getRpcAppenderForTickets(proMoTktNumber.length()));
<span class="nc bnc" id="L4981" title="All 2 branches missed.">							if (raffleGameBean instanceof RafflePurchaseBean) {</span>
								// RafflePurchaseBean rafflePurchaseBean =
								// (RafflePurchaseBean) raffleGameBean;
<span class="nc" id="L4984">								rafflePurchaseBean = (RafflePurchaseBean) raffleGameBean;</span>
<span class="nc" id="L4985">								rafflePurchaseBeanList.add(rafflePurchaseBean);</span>
<span class="nc bnc" id="L4986" title="All 2 branches missed.">								if (fortunebean != null) {</span>
<span class="nc" id="L4987">									fortunebean.setRafflePurchaseBeanList(rafflePurchaseBeanList); // has</span>
									// to
									// be
									// change
									// like
									// keno
									// below
<span class="nc" id="L4994">									fortunebean.setPromoPurchaseBean(rafflePurchaseBeanList);</span>
									// return fortunebean;
<span class="nc bnc" id="L4996" title="All 2 branches missed.">								} else if (kenobean != null) {</span>
<span class="nc" id="L4997">									kenobean.setRafflePurchaseBeanList(rafflePurchaseBeanList);</span>
<span class="nc" id="L4998">									kenobean.setPromoPurchaseBean(rafflePurchaseBeanList);</span>
									// return kenobean;
<span class="nc bnc" id="L5000" title="All 2 branches missed.">								} else if (lottobean != null) {</span>
<span class="nc" id="L5001">									lottobean.setRafflePurchaseBeanList(rafflePurchaseBeanList);// has</span>
									// to
									// be
									// change
									// like
									// keno
									// below
<span class="nc" id="L5008">									lottobean.setPromoPurchaseBean(rafflePurchaseBeanList);</span>
									// return lottobean;
								}

<span class="nc bnc" id="L5012" title="All 2 branches missed.">							} else if (raffleGameBean != null) {</span>
<span class="nc" id="L5013">								com.skilrock.lms.common.utility.CommonMethods.fetchUpdatedReprintCount(gameId, ticketNo,</span>
										-1);
<span class="nc" id="L5015">								return new String(&quot;ErrorMsg:&quot; + EmbeddedErrors.REPRINT_FAIL_ERROR_MSG + &quot;ErrorCode:&quot;</span>
										+ EmbeddedErrors.REPRINT_FAIL_ERR_CODE + &quot;|&quot;);
							}
<span class="nc" id="L5018">						} else {</span>
<span class="nc bnc" id="L5019" title="All 2 branches missed.">							if (isFirstTime) {</span>
<span class="nc" id="L5020">								Object promoGameBean = reprintPromoStdTicket(gameId, proMoTktNumber, isPwt, true, con,</span>
										userInfoBean);

<span class="nc bnc" id="L5023" title="All 2 branches missed.">								if (promoGameBean instanceof String) {</span>
<span class="nc" id="L5024">									com.skilrock.lms.common.utility.CommonMethods.fetchUpdatedReprintCount(gameId,</span>
											ticketNo, -1);
<span class="nc" id="L5026">									return new String(&quot;ErrorMsg:&quot; + EmbeddedErrors.REPRINT_FAIL_ERROR_MSG + &quot;ErrorCode:&quot;</span>
											+ EmbeddedErrors.REPRINT_FAIL_ERR_CODE + &quot;|&quot;);
<span class="nc bnc" id="L5028" title="All 2 branches missed.">								} else if (promoGameBean instanceof LottoPurchaseBean) {</span>
<span class="nc" id="L5029">									lottoBeanList.add((LottoPurchaseBean) promoGameBean);</span>
<span class="nc" id="L5030">									logger.debug(&quot;Promo Bean Data for zim lotto Three&quot; + promoGameBean);</span>
									// kenoPurchaseBean.setFortunePurchaseBean(fortuneBean);
<span class="nc" id="L5032">									lottobean.setPromoPurchaseBeanList(lottoBeanList);</span>

								} else {
<span class="nc" id="L5035">									kenobean.setPromoPurchaseBean(promoGameBean);</span>
								}
							}

						}
					}
				}
<span class="nc" id="L5042">				con.commit();</span>
<span class="nc bnc" id="L5043" title="All 2 branches missed.">				if (fortunebean != null) {</span>
<span class="nc" id="L5044">					return fortunebean;</span>
<span class="nc bnc" id="L5045" title="All 2 branches missed.">				} else if (kenobean != null) {</span>
<span class="nc" id="L5046">					return kenobean;</span>
<span class="nc bnc" id="L5047" title="All 2 branches missed.">				} else if (lottobean != null) {</span>
<span class="nc" id="L5048">					return lottobean;</span>
<span class="nc bnc" id="L5049" title="All 2 branches missed.">				} else if (fortuneTwoBean != null) {</span>
<span class="nc" id="L5050">					return fortuneTwoBean;</span>
<span class="nc bnc" id="L5051" title="All 2 branches missed.">				} else if (fortuneThreeBean != null) {</span>
<span class="nc" id="L5052">					return fortuneThreeBean;</span>
<span class="nc bnc" id="L5053" title="All 2 branches missed.">				} else if (rafflePurchaseBean != null) {</span>
<span class="nc" id="L5054">					return rafflePurchaseBean;</span>
				}
			}

<span class="nc" id="L5058">		} catch (Exception e) {</span>
<span class="nc" id="L5059">			e.printStackTrace();</span>
		} finally {
<span class="nc bnc" id="L5061" title="All 38 branches missed.">			if (con != null) {</span>
				try {
<span class="nc" id="L5063">					con.close();</span>
<span class="nc" id="L5064">				} catch (SQLException e) {</span>
<span class="nc" id="L5065">					e.printStackTrace();</span>
<span class="nc" id="L5066">				}</span>
			}
		}
<span class="nc" id="L5069">		return null;</span>

	}

	public Object reprintTicket(UserInfoBean userInfoBean, String ticketNo) {
<span class="nc" id="L5074">		logger.debug(&quot;---reprintTicket with Number=&quot; + ticketNo);</span>

<span class="nc" id="L5076">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L5077">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L5078">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L5079">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L5080">		Object reprintBean = null;</span>
<span class="nc" id="L5081">		int gameNo = 0;</span>
<span class="nc" id="L5082">		String saleStatus = null;</span>
<span class="nc" id="L5083">		int retOrgId = 0;</span>
		try {
<span class="nc" id="L5085">			con.setAutoCommit(false);</span>
<span class="nc" id="L5086">			ResultSet rs = null;</span>
<span class="nc" id="L5087">			Statement stm = con.createStatement();</span>
<span class="nc" id="L5088">			ValidateTicketBean tktBean = Util.validateTkt(ticketNo);</span>
<span class="nc bnc" id="L5089" title="All 2 branches missed.">			if (tktBean.isValid()) {</span>
<span class="nc" id="L5090">				gameNo = Integer.parseInt(ticketNo.substring(4, 5));</span>

<span class="nc" id="L5092">				rs = stm.executeQuery(&quot;select game_id,retailer_org_id from st_dg_ret_sale_&quot; + gameNo</span>
						+ &quot; where ticket_nbr=&quot; + ticketNo.substring(0, ticketNo.length() - 2));
<span class="nc bnc" id="L5094" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L5095">					retOrgId = rs.getInt(&quot;retailer_org_id&quot;);</span>
				}

<span class="nc bnc" id="L5098" title="All 2 branches missed.">				if (retOrgId != userInfoBean.getUserOrgId()) {</span>
<span class="nc" id="L5099">					return &quot;You Are not Authorize To Reprint This Ticket&quot;;</span>
				}
<span class="nc" id="L5101">				rs = stm.executeQuery(&quot;select ticket_nbr from st_dg_ret_sale_refund_&quot; + gameNo + &quot; where ticket_nbr=&quot;</span>
						+ ticketNo.substring(0, ticketNo.length() - 2));
				// check for pwt claimed for whole ticket
				//

<span class="nc" id="L5106">				logger.debug(&quot;Reprint****ticketNo****&quot; + ticketNo);</span>
<span class="nc" id="L5107">				sReq.setServiceData(ticketNo);// 00 is appended in case of</span>
				// reprint to set the length
				// of actual ticket
				// This has no affect on functionality.
<span class="nc" id="L5111">				String family = Util.getGameType(gameNo);</span>
<span class="nc" id="L5112">				String gameName = Util.getGameName(gameNo);</span>
<span class="nc" id="L5113">				String pck = &quot;com.skilrock.lms.beans.&quot;;</span>
<span class="nc" id="L5114">				String pb = &quot;PurchaseBean&quot;;</span>
<span class="nc" id="L5115">				Class familyClass = Class.forName(pck + family + pb);</span>
<span class="nc bnc" id="L5116" title="All 4 branches missed.">				if (rs.next() || ticketNo == null) {</span>
<span class="nc" id="L5117">					Method method = familyClass.getDeclaredMethod(&quot;setSaleStatus&quot;, String.class);</span>
<span class="nc" id="L5118">					method.invoke(familyClass.newInstance(), &quot;REPRINT_FAIL&quot;);</span>
<span class="nc" id="L5119">					return familyClass;</span>
				}
<span class="nc" id="L5121">				sReq.setServiceName(gameName.toLowerCase() + &quot;Module&quot;);</span>
<span class="nc" id="L5122">				sReq.setServiceMethod(&quot;reprintTicket&quot;);</span>
<span class="nc" id="L5123">				sRes = delegate.getResponse(sReq);</span>
<span class="nc bnc" id="L5124" title="All 2 branches missed.">				if (sRes.getIsSuccess()) {</span>
					// rg calling
<span class="nc" id="L5126">					boolean isFraud = ResponsibleGaming.respGaming(userInfoBean, &quot;DG_REPRINT&quot;, &quot;1&quot;, con);</span>
<span class="nc bnc" id="L5127" title="All 2 branches missed.">					if (!isFraud) {</span>
<span class="nc" id="L5128">						reprintBean = sRes.getResponseData();</span>

						// This code is just a backup, if the Applet Barcode
						// printing fails
						// There here is a duplicacy of fetching family type.

<span class="nc bnc" id="L5134" title="All 2 branches missed.">						if (&quot;Fortune&quot;.equals(family)) {</span>
<span class="nc" id="L5135">							FortunePurchaseBean winningBean = (FortunePurchaseBean) reprintBean;</span>
<span class="nc" id="L5136">							saleStatus = winningBean.getSaleStatus();</span>
<span class="nc bnc" id="L5137" title="All 2 branches missed.">						} else if (&quot;Lotto&quot;.equals(family)) {</span>
<span class="nc" id="L5138">							LottoPurchaseBean winningBean = (LottoPurchaseBean) reprintBean;</span>
<span class="nc" id="L5139">							saleStatus = winningBean.getSaleStatus();</span>

<span class="nc bnc" id="L5141" title="All 2 branches missed.">						} else if (&quot;Keno&quot;.equals(family)) {</span>
<span class="nc" id="L5142">							KenoPurchaseBean winningBean = (KenoPurchaseBean) reprintBean;</span>
<span class="nc" id="L5143">							saleStatus = winningBean.getSaleStatus();</span>

<span class="nc bnc" id="L5145" title="All 2 branches missed.">						} else if (&quot;FortuneTwo&quot;.equals(family)) {</span>
<span class="nc" id="L5146">							FortuneTwoPurchaseBean winningBean = (FortuneTwoPurchaseBean) reprintBean;</span>
<span class="nc" id="L5147">							saleStatus = winningBean.getSaleStatus();</span>
<span class="nc bnc" id="L5148" title="All 2 branches missed.">						} else if (&quot;FortuneThree&quot;.equals(family)) {</span>
<span class="nc" id="L5149">							FortuneThreePurchaseBean winningBean = (FortuneThreePurchaseBean) reprintBean;</span>
<span class="nc" id="L5150">							saleStatus = winningBean.getSaleStatus();</span>
						}

<span class="nc" id="L5153">						logger.debug(saleStatus + &quot;****reprintTicket rpos helper********&quot;);</span>
<span class="nc bnc" id="L5154" title="All 2 branches missed.">						if (&quot;LIMIT_EXCEEDED&quot;.equalsIgnoreCase(saleStatus)) {</span>

<span class="nc" id="L5156">							return new String(&quot;Reprint Limit Exceed&quot;); // Normal</span>
						}
<span class="nc bnc" id="L5158" title="All 2 branches missed.">						if (&quot;PERFORMED&quot;.equalsIgnoreCase(saleStatus)) {</span>
<span class="nc" id="L5159">							return new String(&quot;Draw Performed&quot;);</span>
						}

<span class="nc" id="L5162">						con.commit();</span>

<span class="nc bnc" id="L5164" title="All 2 branches missed.">						if (&quot;Fortune&quot;.equals(family)) {</span>
<span class="nc" id="L5165">							return (FortunePurchaseBean) reprintBean;</span>
<span class="nc bnc" id="L5166" title="All 2 branches missed.">						} else if (&quot;Lotto&quot;.equals(family)) {</span>
<span class="nc" id="L5167">							return (LottoPurchaseBean) reprintBean;</span>
<span class="nc bnc" id="L5168" title="All 2 branches missed.">						} else if (&quot;Keno&quot;.equals(family)) {</span>
<span class="nc" id="L5169">							return (KenoPurchaseBean) reprintBean;</span>
<span class="nc bnc" id="L5170" title="All 2 branches missed.">						} else if (&quot;FortuneTwo&quot;.equals(family)) {</span>
<span class="nc" id="L5171">							return (FortuneTwoPurchaseBean) reprintBean;</span>
<span class="nc bnc" id="L5172" title="All 2 branches missed.">						} else if (&quot;FortuneThree&quot;.equals(family)) {</span>
<span class="nc" id="L5173">							return (FortuneThreePurchaseBean) reprintBean;</span>
						}
					} else {
<span class="nc" id="L5176">						return new String(&quot;RG_RPERINT&quot;); // Responsible</span>
						// Gaming
						// Reprint Limit
						// Exceed
					}
				}
<span class="nc" id="L5182">			} else {</span>
<span class="nc" id="L5183">				return new String(&quot;Invalid Ticket Number&quot;);</span>
			}
<span class="nc" id="L5185">		} catch (Exception e) {</span>
<span class="nc" id="L5186">			e.printStackTrace();</span>
		} finally {
<span class="nc bnc" id="L5188" title="All 28 branches missed.">			if (con != null) {</span>
				try {
<span class="nc" id="L5190">					con.close();</span>
<span class="nc" id="L5191">				} catch (SQLException e) {</span>
<span class="nc" id="L5192">					e.printStackTrace();</span>
<span class="nc" id="L5193">				}</span>
			}
		}

<span class="nc" id="L5197">		return null;</span>
	}

	public FortunePurchaseBean zeroToNinePurchaseTicket(UserInfoBean userBean,
			FortunePurchaseBean zeroToNinePurchaseBean) throws LMSException {

<span class="nc bnc" id="L5203" title="All 4 branches missed.">		if (isDrawAvailable(zeroToNinePurchaseBean.getGame_no())</span>
				|| chkFreezeTimeSale(zeroToNinePurchaseBean.getGame_no())) {
<span class="nc" id="L5205">			zeroToNinePurchaseBean.setSaleStatus(&quot;NO_DRAWS&quot;);</span>
<span class="nc" id="L5206">			return zeroToNinePurchaseBean;</span>
		}

<span class="nc" id="L5209">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L5210">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L5211">		sReq.setServiceName(ServiceName.ZEROTONINE);</span>
<span class="nc" id="L5212">		sReq.setServiceMethod(ServiceMethodName.ZEROTONINE_PURCHASE_TICKET);</span>
<span class="nc" id="L5213">		sReq.setServiceData(zeroToNinePurchaseBean);</span>
<span class="nc" id="L5214">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L5215">		long balDed = 0;</span>
<span class="nc" id="L5216">		int tickUpd = 0;</span>
<span class="nc" id="L5217">		String status = &quot;&quot;;</span>
<span class="nc" id="L5218">		double oldTotalPurchaseAmt = 0.0;</span>
<span class="nc" id="L5219">		double modifiedTotalPurchaseAmt = 0.0;</span>
<span class="nc" id="L5220">		Connection con = null;</span>
		try {
<span class="nc bnc" id="L5222" title="All 2 branches missed.">			if (fortuneDataValidation(zeroToNinePurchaseBean)) {</span>

<span class="nc" id="L5224">				logger.debug(&quot;Data validation returns true&quot;);</span>
<span class="nc" id="L5225">				zeroToNinePurchaseBean.setAdvMsg(Util.getAdvMessage(userBean.getUserOrgId(),</span>
						zeroToNinePurchaseBean.getGame_no(), &quot;PLAYER&quot;, &quot;SALE&quot;, &quot;DG&quot;));

<span class="nc" id="L5228">				zeroToNinePurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L5229">				double totPurAmt = 0.0;</span>
<span class="nc bnc" id="L5230" title="All 2 branches missed.">				if (zeroToNinePurchaseBean.isPromotkt()) {</span>
<span class="nc" id="L5231">					totPurAmt = 0.0;</span>
				} else {
<span class="nc" id="L5233">					totPurAmt = zeroToNinePurchaseBean.getTotalNoOfPanels()</span>
							* Util.getUnitPrice(zeroToNinePurchaseBean.getGame_no(), null)
							* zeroToNinePurchaseBean.getNoOfDraws();
				}
<span class="nc" id="L5237">				zeroToNinePurchaseBean.setUnitPrice(Util.getUnitPrice(zeroToNinePurchaseBean.getGame_no(), null));</span>

<span class="nc" id="L5239">				logger.debug(&quot;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&quot; + totPurAmt);</span>

<span class="nc" id="L5241">				zeroToNinePurchaseBean.setTotalPurchaseAmt(totPurAmt);</span>
<span class="nc bnc" id="L5242" title="All 2 branches missed.">				if (!userBean.getUserType().equals(&quot;RETAILER&quot;)) {</span>
<span class="nc" id="L5243">					return zeroToNinePurchaseBean;</span>
				}
<span class="nc" id="L5245">				con = DBConnect.getConnection();</span>

<span class="nc bnc" id="L5247" title="All 2 branches missed.">				if (zeroToNinePurchaseBean.getLastSoldTicketNo() != null) {</span>
<span class="nc bnc" id="L5248" title="All 2 branches missed.">					if (!&quot;0&quot;.equalsIgnoreCase(zeroToNinePurchaseBean.getLastSoldTicketNo())) {</span>
<span class="nc" id="L5249">						Util.insertLastSoldTicketTeminal(zeroToNinePurchaseBean.getUserId(),</span>
								zeroToNinePurchaseBean.getLastSoldTicketNo(), zeroToNinePurchaseBean.getGameId(), con);
					}
				}
<span class="nc" id="L5253">				logger.debug(&quot;Inside ZERO TO NINE FE1*******&quot;);</span>
				// rg calling
<span class="nc" id="L5255">				boolean isFraud = ResponsibleGaming.respGaming(userBean, &quot;DG_SALE&quot;, totPurAmt + &quot;&quot;, con);</span>
<span class="nc bnc" id="L5256" title="All 2 branches missed.">				if (!isFraud) {</span>

<span class="nc" id="L5258">					balDed = orgOnLineSaleCreditUpdation.drawTcketSaleBalDeduction(userBean,</span>
							zeroToNinePurchaseBean.getGame_no(), zeroToNinePurchaseBean.getTotalPurchaseAmt(),
							zeroToNinePurchaseBean.getPlrMobileNumber(), con);
<span class="nc" id="L5261">					oldTotalPurchaseAmt = zeroToNinePurchaseBean.getTotalPurchaseAmt();</span>

<span class="nc" id="L5263">					logger.debug(&quot;Total Purchase Amt inside DrawGameRPOSHelper Just Before  getting Success :&quot;</span>
							+ oldTotalPurchaseAmt);

				} else {
<span class="nc" id="L5267">					logger.debug(&quot;Responsing Gaming not allowed to sale&quot;);</span>
<span class="nc" id="L5268">					zeroToNinePurchaseBean.setSaleStatus(&quot;FRAUD&quot;);</span>
				}

<span class="nc" id="L5271">				logger.debug(&quot;Inside Zero To Nine FE*******&quot; + sRes);</span>
<span class="nc" id="L5272">				return zeroToNinePurchaseBean;</span>
			} else {
<span class="nc" id="L5274">				logger.debug(&quot;Data validation returns false&quot;);</span>
<span class="nc" id="L5275">				zeroToNinePurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L5276">				return zeroToNinePurchaseBean;</span>
			}
<span class="nc" id="L5278">		} catch (Exception e) {</span>

<span class="nc" id="L5280">			e.printStackTrace();</span>
		}

		try {
<span class="nc bnc" id="L5284" title="All 2 branches missed.">			if (balDed &gt; 0) {</span>
<span class="nc" id="L5285">				zeroToNinePurchaseBean.setRefTransId(balDed + &quot;&quot;);</span>
<span class="nc" id="L5286">				sRes = delegate.getResponse(sReq);</span>

<span class="nc bnc" id="L5288" title="All 2 branches missed.">				if (sRes.getIsSuccess()) {</span>
<span class="nc" id="L5289">					zeroToNinePurchaseBean = (FortunePurchaseBean) sRes.getResponseData();</span>

<span class="nc" id="L5291">					modifiedTotalPurchaseAmt = zeroToNinePurchaseBean.getTotalPurchaseAmt();</span>
<span class="nc" id="L5292">					logger.debug(&quot;Total Purchase Amt inside DrawGameRPOSHelper After getting Success :&quot;</span>
							+ modifiedTotalPurchaseAmt);
<span class="nc" id="L5294">					con = DBConnect.getConnection();</span>
<span class="nc bnc" id="L5295" title="All 2 branches missed.">					if (oldTotalPurchaseAmt != modifiedTotalPurchaseAmt) {</span>
<span class="nc" id="L5296">						balDed = orgOnLineSaleCreditUpdation.drawTcketSaleBalDedUpdate(userBean,</span>
								zeroToNinePurchaseBean.getGame_no(), modifiedTotalPurchaseAmt, oldTotalPurchaseAmt,
								balDed, con);

					}
<span class="nc" id="L5301">					tickUpd = orgOnLineSaleCreditUpdation.drawTicketSaleTicketUpdate(balDed,</span>
							zeroToNinePurchaseBean.getTicket_no(), zeroToNinePurchaseBean.getGame_no(), userBean,
							zeroToNinePurchaseBean.getPurchaseChannel(), con);

<span class="nc bnc" id="L5305" title="All 2 branches missed.">					if (tickUpd == 1) {</span>
<span class="nc" id="L5306">						status = &quot;SUCCESS&quot;;</span>
<span class="nc" id="L5307">						zeroToNinePurchaseBean.setSaleStatus(status);</span>
<span class="nc bnc" id="L5308" title="All 2 branches missed.">						if (!zeroToNinePurchaseBean.getBarcodeType().equals(&quot;applet&quot;)) {</span>
<span class="nc" id="L5309">							IDBarcode.getBarcode(</span>
									zeroToNinePurchaseBean.getTicket_no() + zeroToNinePurchaseBean.getReprintCount());
						}
<span class="nc" id="L5312">						return zeroToNinePurchaseBean;</span>
					} else {
<span class="nc" id="L5314">						status = &quot;FAILED&quot;;</span>
<span class="nc" id="L5315">						zeroToNinePurchaseBean.setSaleStatus(status);</span>
						// Code for cancelling the Ticket to be send to
						// Draw
						// Game Engine
<span class="nc" id="L5319">						cancelTicket(zeroToNinePurchaseBean.getTicket_no() + zeroToNinePurchaseBean.getReprintCount(),</span>
								zeroToNinePurchaseBean.getPurchaseChannel(), zeroToNinePurchaseBean.getDrawIdTableMap(),
								zeroToNinePurchaseBean.getGame_no(), zeroToNinePurchaseBean.getPartyId(),
								zeroToNinePurchaseBean.getPartyType(), zeroToNinePurchaseBean.getRefMerchantId(),
								userBean, zeroToNinePurchaseBean.getRefTransId());
<span class="nc" id="L5324">						return zeroToNinePurchaseBean;</span>
					}
				} else {
<span class="nc" id="L5327">					zeroToNinePurchaseBean = (FortunePurchaseBean) sRes.getResponseData();</span>
<span class="nc bnc" id="L5328" title="All 2 branches missed.">					if (zeroToNinePurchaseBean.getSaleStatus() == null) {</span>
<span class="nc" id="L5329">						zeroToNinePurchaseBean.setSaleStatus(&quot;FAILED&quot;);// Error</span>
<span class="nc" id="L5330">						orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, zeroToNinePurchaseBean.getGame_no(),</span>
								&quot;FAILED&quot;, balDed);
<span class="nc" id="L5332">						return zeroToNinePurchaseBean;</span>
<span class="nc bnc" id="L5333" title="All 2 branches missed.">					} else if (&quot;ERROR_TICKET_LIMIT&quot;.equalsIgnoreCase(zeroToNinePurchaseBean.getSaleStatus())) {</span>
<span class="nc" id="L5334">						orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, zeroToNinePurchaseBean.getGame_no(),</span>
								&quot;FAILED&quot;, balDed);
<span class="nc" id="L5336">						return zeroToNinePurchaseBean;</span>
					} else {
<span class="nc" id="L5338">						orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, zeroToNinePurchaseBean.getGame_no(),</span>
								&quot;FAILED&quot;, balDed);
<span class="nc" id="L5340">						return zeroToNinePurchaseBean;</span>
					}
				}
			} else {

<span class="nc" id="L5345">				status = getStatusIfErrorInTransaction(status, balDed);</span>
<span class="nc" id="L5346">				zeroToNinePurchaseBean.setSaleStatus(status);</span>
<span class="nc" id="L5347">				return zeroToNinePurchaseBean;</span>
			}
<span class="nc" id="L5349">		} catch (Exception e) {</span>
			// TODO: handle exception
		}
<span class="nc" id="L5352">		return zeroToNinePurchaseBean;</span>
	}

	// ZimLotto Data Validation
	public boolean zimLottoDataValidation(LottoPurchaseBean lottoPurchaseBean) {
<span class="nc" id="L5357">		int noOfDraws = lottoPurchaseBean.getNoOfDraws();</span>
<span class="nc" id="L5358">		String[] picknumbers = lottoPurchaseBean.getPicknumbers();</span>
		Set&lt;Integer&gt; picknumSet;
		String pickNum[];
<span class="nc" id="L5361">		int noOfPanels = picknumbers.length;</span>
<span class="nc" id="L5362">		logger.debug(&quot;no of Panels: &quot; + noOfPanels);</span>
<span class="nc bnc" id="L5363" title="All 4 branches missed.">		if (noOfDraws &gt; 0 &amp;&amp; noOfPanels &gt; 0) {</span>
<span class="nc bnc" id="L5364" title="All 2 branches missed.">			for (int i = 0; i &lt; noOfPanels; i++) {</span>
<span class="nc bnc" id="L5365" title="All 2 branches missed.">				if (picknumbers[i].equalsIgnoreCase(&quot;QP&quot;)) {</span>
<span class="nc" id="L5366">					logger.debug(&quot;quick pick Selected&quot;);</span>

				} else {
<span class="nc" id="L5369">					logger.debug(&quot;not quick pick&quot;);</span>
<span class="nc" id="L5370">					logger.debug(&quot;Player picked Data:&quot; + picknumbers[i]);</span>
<span class="nc" id="L5371">					pickNum = picknumbers[i].split(&quot;,&quot;);</span>
<span class="nc" id="L5372">					picknumSet = new HashSet&lt;Integer&gt;();</span>
<span class="nc bnc" id="L5373" title="All 2 branches missed.">					for (String element : pickNum) {</span>
<span class="nc" id="L5374">						picknumSet.add(Integer.parseInt(element));</span>
					}
<span class="nc bnc" id="L5376" title="All 4 branches missed.">					if (pickNum.length != picknumSet.size()</span>
							|| pickNum.length &gt; com.skilrock.lms.dge.gameconstants.ZimlottoConstants.MAX_PLAYER_PICKED) {
<span class="nc" id="L5378">						logger.debug(&quot;picNum.Length: &quot; + pickNum.length + &quot;Set length:  &quot; + picknumSet.size());</span>
<span class="nc" id="L5379">						return false;</span>
					}
				}
			}
<span class="nc" id="L5383">			return true;</span>
		}
<span class="nc" id="L5385">		return false;</span>
	}

	// tanzanialotto validation

	public boolean tanzaniaLottoDataValidation(LottoPurchaseBean lottoPurchaseBean) {
<span class="nc" id="L5391">		int noOfDraws = lottoPurchaseBean.getNoOfDraws();</span>
<span class="nc" id="L5392">		String[] picknumbers = lottoPurchaseBean.getPicknumbers();</span>
		Set&lt;Integer&gt; picknumSet;
		String pickNum[];
<span class="nc" id="L5395">		int noOfPanels = picknumbers.length;</span>
<span class="nc" id="L5396">		logger.debug(&quot;no of Panels: &quot; + noOfPanels);</span>
<span class="nc bnc" id="L5397" title="All 4 branches missed.">		if (noOfPanels &lt; 5 || noOfPanels % 5 != 0) {</span>
<span class="nc" id="L5398">			return false;</span>
		}
<span class="nc bnc" id="L5400" title="All 4 branches missed.">		if (noOfDraws &gt; 0 &amp;&amp; noOfPanels &gt; 0) {</span>
<span class="nc bnc" id="L5401" title="All 2 branches missed.">			for (int i = 0; i &lt; noOfPanels; i++) {</span>
<span class="nc bnc" id="L5402" title="All 2 branches missed.">				if (picknumbers[i].equalsIgnoreCase(&quot;QP&quot;)) {</span>
<span class="nc" id="L5403">					logger.debug(&quot;quick pick Selected&quot;);</span>

				} else {
<span class="nc" id="L5406">					logger.debug(&quot;not quick pick&quot;);</span>
<span class="nc" id="L5407">					logger.debug(&quot;Player picked Data:&quot; + picknumbers[i]);</span>
<span class="nc" id="L5408">					pickNum = picknumbers[i].split(&quot;,&quot;);</span>
<span class="nc" id="L5409">					picknumSet = new HashSet&lt;Integer&gt;();</span>
<span class="nc bnc" id="L5410" title="All 2 branches missed.">					for (String element : pickNum) {</span>
<span class="nc" id="L5411">						picknumSet.add(Integer.parseInt(element));</span>
					}
<span class="nc bnc" id="L5413" title="All 4 branches missed.">					if (pickNum.length != picknumSet.size()</span>
							|| pickNum.length != com.skilrock.lms.dge.gameconstants.TanzanialottoConstants.MAX_PLAYER_PICKED) {
<span class="nc" id="L5415">						logger.debug(&quot;picNum.Length: &quot; + pickNum.length + &quot;Set length:  &quot; + picknumSet.size());</span>
<span class="nc" id="L5416">						return false;</span>
					}
				}
			}
<span class="nc" id="L5420">			return true;</span>
		}
<span class="nc" id="L5422">		return false;</span>
	}

	public LottoPurchaseBean zimLottoPurchaseTicket(UserInfoBean userBean, LottoPurchaseBean lottoPurchaseBean)
			throws Exception {
		// here insert the last sold tikcet on terminal or by third party

<span class="nc" id="L5429">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L5430">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L5431">		sReq.setServiceName(ServiceName.ZIMLOTTO);</span>
<span class="nc" id="L5432">		sReq.setServiceMethod(ServiceMethodName.ZIMLOTTO_PURCHASE_TICKET);</span>
<span class="nc" id="L5433">		sReq.setServiceData(lottoPurchaseBean);</span>
<span class="nc" id="L5434">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L5435">		lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L5436">		double oldTotalPurchaseAmt = 0.0;</span>
<span class="nc" id="L5437">		double modifiedTotalPurchaseAmt = 0.0;</span>
<span class="nc" id="L5438">		String status = &quot;&quot;;</span>
<span class="nc" id="L5439">		long balDed = 0;</span>
<span class="nc" id="L5440">		Connection con = null;</span>

		try {
<span class="nc bnc" id="L5443" title="All 2 branches missed.">			if (zimLottoDataValidation(lottoPurchaseBean)) {</span>
<span class="nc" id="L5444">				con = DBConnect.getConnection();</span>
<span class="nc bnc" id="L5445" title="All 2 branches missed.">				if (lottoPurchaseBean.getLastSoldTicketNo() != null) {</span>
<span class="nc bnc" id="L5446" title="All 2 branches missed.">					if (!&quot;0&quot;.equalsIgnoreCase(lottoPurchaseBean.getLastSoldTicketNo())) {</span>
<span class="nc" id="L5447">						Util.insertLastSoldTicketTeminal(lottoPurchaseBean.getUserId(),</span>
								lottoPurchaseBean.getLastSoldTicketNo(), lottoPurchaseBean.getGameId(), con);
					}
				}

<span class="nc" id="L5452">				double totPurAmt = lottoPurchaseBean.getPicknumbers().length</span>
						* Util.getUnitPrice(lottoPurchaseBean.getGame_no(), null) * lottoPurchaseBean.getNoOfDraws();

<span class="nc" id="L5455">				logger.debug(&quot;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&quot; + totPurAmt);</span>

<span class="nc" id="L5457">				lottoPurchaseBean.setTotalPurchaseAmt(totPurAmt);</span>

<span class="nc" id="L5459">				logger.debug(&quot;Inside  FE1*******&quot;);</span>
				// rg calling
<span class="nc" id="L5461">				boolean isFraud = ResponsibleGaming.respGaming(userBean, &quot;DG_SALE&quot;, totPurAmt + &quot;&quot;);</span>
<span class="nc bnc" id="L5462" title="All 2 branches missed.">				if (!isFraud) {</span>

<span class="nc" id="L5464">					balDed = orgOnLineSaleCreditUpdation.drawTcketSaleBalDeduction(userBean,</span>
							lottoPurchaseBean.getGame_no(), lottoPurchaseBean.getTotalPurchaseAmt(),
							lottoPurchaseBean.getPlrMobileNumber(), con);
<span class="nc" id="L5467">					oldTotalPurchaseAmt = lottoPurchaseBean.getTotalPurchaseAmt();</span>

<span class="nc" id="L5469">					logger.debug(&quot;Total Purchase Amt inside DrawGameRPOSHelper Just Before  getting Success :&quot;</span>
							+ oldTotalPurchaseAmt);

				} else {
<span class="nc" id="L5473">					logger.debug(&quot;Responsing Gaming not allowed to sale&quot;);</span>
<span class="nc" id="L5474">					lottoPurchaseBean.setSaleStatus(&quot;FRAUD&quot;);</span>
				}

<span class="nc" id="L5477">			} else {</span>
<span class="nc" id="L5478">				logger.debug(&quot;Data validation returns false&quot;);</span>
<span class="nc" id="L5479">				lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
			}
<span class="nc" id="L5481">		} catch (Exception e) {</span>
<span class="nc" id="L5482">			e.printStackTrace();</span>
			// commented by amit as not relevant here

			/*
			 * lottoPurchaseBean = (LottoPurchaseBean) sRes.getResponseData();
			 * String ticketNo = lottoPurchaseBean.getTicket_no(); String
			 * cancelChannel = lottoPurchaseBean.getPurchaseChannel();
			 * Map&lt;Integer, Map&lt;Integer, String&gt;&gt; drawIdTableMap =
			 * lottoPurchaseBean .getDrawIdTableMap(); int gameNo =
			 * lottoPurchaseBean.getGame_no(); int partyId =
			 * lottoPurchaseBean.getPartyId(); String partyType =
			 * lottoPurchaseBean.getPartyType(); String refTransId =
			 * lottoPurchaseBean.getRefTransId();
			 * 
			 * cancelTicket(ticketNo, cancelChannel, drawIdTableMap, gameNo,
			 * partyId, partyType, refTransId);
			 */
<span class="nc" id="L5499">		}</span>

		try {
<span class="nc bnc" id="L5502" title="All 2 branches missed.">			if (balDed &gt; 0) {</span>
<span class="nc" id="L5503">				lottoPurchaseBean.setRefTransId(balDed + &quot;&quot;);</span>
<span class="nc" id="L5504">				sRes = delegate.getResponse(sReq);</span>

<span class="nc bnc" id="L5506" title="All 2 branches missed.">				if (sRes.getIsSuccess()) {</span>
<span class="nc" id="L5507">					lottoPurchaseBean = (LottoPurchaseBean) sRes.getResponseData();</span>
<span class="nc" id="L5508">					modifiedTotalPurchaseAmt = lottoPurchaseBean.getTotalPurchaseAmt();</span>
<span class="nc" id="L5509">					logger.debug(&quot;Total Purchase Amt inside DrawGameRPOSHelper After getting Success :&quot;</span>
							+ modifiedTotalPurchaseAmt);
<span class="nc" id="L5511">					con = DBConnect.getConnection();</span>
<span class="nc bnc" id="L5512" title="All 2 branches missed.">					if (oldTotalPurchaseAmt != modifiedTotalPurchaseAmt) {</span>
<span class="nc" id="L5513">						balDed = orgOnLineSaleCreditUpdation.drawTcketSaleBalDedUpdate(userBean,</span>
								lottoPurchaseBean.getGame_no(), modifiedTotalPurchaseAmt, oldTotalPurchaseAmt, balDed,
								con);

					}
<span class="nc" id="L5518">					int tickUpd = orgOnLineSaleCreditUpdation.drawTicketSaleTicketUpdate(balDed,</span>
							lottoPurchaseBean.getTicket_no(), lottoPurchaseBean.getGame_no(), userBean,
							lottoPurchaseBean.getPurchaseChannel(), con);

<span class="nc bnc" id="L5522" title="All 2 branches missed.">					if (tickUpd == 1) {</span>
<span class="nc" id="L5523">						status = &quot;SUCCESS&quot;;</span>
						// lottoPurchaseBean.setAdvMsg(Util.getAdvMessage(userBean.getUserOrgId(),
						// lottoPurchaseBean.getGame_no(), &quot;PLAYER&quot;, &quot;SALE&quot;,
						// &quot;DG&quot;));
<span class="nc" id="L5527">						lottoPurchaseBean.setAdvMsg(</span>
								Util.getDGSaleAdvMessage(userBean.getUserOrgId(), lottoPurchaseBean.getGame_no()));
<span class="nc" id="L5529">						lottoPurchaseBean.setSaleStatus(status);</span>
<span class="nc bnc" id="L5530" title="All 2 branches missed.">						if (!lottoPurchaseBean.getBarcodeType().equals(&quot;applet&quot;)) {</span>
<span class="nc" id="L5531">							new IDBarcode()</span>
									.getBarcode(lottoPurchaseBean.getTicket_no() + lottoPurchaseBean.getReprintCount());
						}

						// call promo purchase process here
<span class="nc" id="L5536">						List&lt;RafflePurchaseBean&gt; rafflePurchaseBeanList = new ArrayList&lt;RafflePurchaseBean&gt;();</span>
						// CommonFunctionsHelper commonHelper = new
						// CommonFunctionsHelper();

<span class="nc" id="L5540">						List&lt;PromoGameBean&gt; promoGameslist = Util.promoGameBeanMap.get(lottoPurchaseBean.getGame_no());</span>

						// String gameType =
						// getGameType(fortunePurchaseBean.getGame_no());
						// List&lt;PromoGameBean&gt; promoGameslist =
						// commonHelper.getAvailablePromoGames(gameType);

<span class="nc bnc" id="L5547" title="All 2 branches missed.">						for (int i = 0; i &lt; promoGameslist.size(); i++) {</span>
<span class="nc" id="L5548">							PromoGameBean promobean = promoGameslist.get(i);</span>
<span class="nc bnc" id="L5549" title="All 2 branches missed.">							if (promobean.getPromoGametype().equalsIgnoreCase(&quot;RAFFLE&quot;)) {</span>
<span class="nc" id="L5550">								lottoPurchaseBean.setRaffleNo(promobean.getPromoGameNo());</span>
<span class="nc" id="L5551">								RafflePurchaseBean rafflePurchaseBean = (RafflePurchaseBean) rafflePurchaseTicket(</span>
										userBean, lottoPurchaseBean, true);
<span class="nc" id="L5553">								rafflePurchaseBean.setRaffleTicketType(promobean.getPromoTicketType());</span>
<span class="nc bnc" id="L5554" title="All 2 branches missed.">								if (rafflePurchaseBean.getSaleStatus().equalsIgnoreCase(&quot;FAILED&quot;)) {</span>
<span class="nc" id="L5555">									status = &quot;FAILED&quot;;</span>
<span class="nc" id="L5556">									lottoPurchaseBean.setSaleStatus(status);</span>
									// Code for canceling the Ticket to
									// be send to Draw Game Engine
<span class="nc" id="L5559">									cancelTicket(lottoPurchaseBean.getTicket_no() + lottoPurchaseBean.getReprintCount(),</span>
											lottoPurchaseBean.getPurchaseChannel(),
											lottoPurchaseBean.getDrawIdTableMap(), lottoPurchaseBean.getGame_no(),
											lottoPurchaseBean.getPartyId(), lottoPurchaseBean.getPartyType(),
											lottoPurchaseBean.getRefMerchantId(), userBean,
											lottoPurchaseBean.getRefTransId());
<span class="nc" id="L5565">									lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L5566">									return lottoPurchaseBean;</span>
<span class="nc bnc" id="L5567" title="All 2 branches missed.">								} else if (rafflePurchaseBean.getSaleStatus().equalsIgnoreCase(&quot;SUCCESS&quot;)) {</span>
									// here insert entry into the promo
									// ticket mapping table
<span class="nc" id="L5570">									int tktlen = rafflePurchaseBean.getRaffleTicket_no().length();</span>
<span class="nc" id="L5571">									orgOnLineSaleCreditUpdation.drawTicketNPromoMappigUpdate(1,</span>
											rafflePurchaseBean.getGame_no(), rafflePurchaseBean.getParentTktNo(),
											rafflePurchaseBean.getRaffleTicket_no().substring(0, tktlen - 2));
<span class="nc" id="L5574">									rafflePurchaseBeanList.add(rafflePurchaseBean);</span>
								}
							}
						}
						/*
						 * String gameType =
						 * getGameType(lottoPurchaseBean.getGame_no());
						 * List&lt;PromoGameBean&gt; promoGameslist =
						 * commonHelper.getAvailablePromoGames(gameType);
						 * 
						 * for(int i=0;i&lt;promoGameslist.size();i++){
						 * PromoGameBean promobean=promoGameslist.get(i);
						 * if(promobean.getPromoGametype().equalsIgnoreCase(
						 * &quot;RAFFLE&quot;)){ lottoPurchaseBean.setRaffleNo(promobean.
						 * getPromoGameNo()); RafflePurchaseBean
						 * rafflePurchaseBean = (RafflePurchaseBean)
						 * rafflePurchaseTicket( userBean,
						 * lottoPurchaseBean,true);
						 * rafflePurchaseBean.setRaffleTicketType(promobean.
						 * getPromoTicketType()); if
						 * (rafflePurchaseBean.getSaleStatus()
						 * .equalsIgnoreCase(&quot;FAILED&quot;)) { status = &quot;FAILED&quot;;
						 * lottoPurchaseBean .setSaleStatus(status); // Code for
						 * cancelling the Ticket to be send to Draw Game Engine
						 * cancelTicket(lottoPurchaseBean.getTicket_no(),
						 * lottoPurchaseBean.getPurchaseChannel(),
						 * lottoPurchaseBean.getDrawIdTableMap(),
						 * lottoPurchaseBean.getGame_no(),
						 * lottoPurchaseBean.getPartyId(),
						 * lottoPurchaseBean.getPartyType(),
						 * lottoPurchaseBean.getRefMerchantId(), userBean,
						 * lottoPurchaseBean .getRefTransId());
						 * lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;); return
						 * lottoPurchaseBean; }else if
						 * (rafflePurchaseBean.getSaleStatus().equalsIgnoreCase(
						 * &quot;SUCCESS&quot;)){ //here insert entry into the promo
						 * ticket mapping table int
						 * tktlen=rafflePurchaseBean.getRaffleTicket_no().length
						 * (); orgOnLineSaleCreditUpdation.
						 * drawTicketNPromoMappigUpdate(1,
						 * rafflePurchaseBean.getGame_no(),
						 * rafflePurchaseBean.getParentTktNo(),
						 * (rafflePurchaseBean.getRaffleTicket_no()).substring(
						 * 0, tktlen - 2));
						 * rafflePurchaseBeanList.add(rafflePurchaseBean); } } }
						 */

<span class="nc" id="L5621">						lottoPurchaseBean.setRafflePurchaseBeanList(rafflePurchaseBeanList);</span>

<span class="nc" id="L5623">						return lottoPurchaseBean;</span>
					} else {
<span class="nc" id="L5625">						status = &quot;FAILED&quot;;</span>
<span class="nc" id="L5626">						lottoPurchaseBean.setSaleStatus(status);</span>
						// Code for cancelling the Ticket to be send to
						// Draw
						// Game Engine
<span class="nc" id="L5630">						cancelTicket(lottoPurchaseBean.getTicket_no(), lottoPurchaseBean.getPurchaseChannel(),</span>
								lottoPurchaseBean.getDrawIdTableMap(), lottoPurchaseBean.getGame_no(),
								lottoPurchaseBean.getPartyId(), lottoPurchaseBean.getPartyType(),
								lottoPurchaseBean.getRefMerchantId(), userBean, lottoPurchaseBean.getRefTransId());

<span class="nc" id="L5635">						return lottoPurchaseBean;</span>
					}
				} else {
<span class="nc" id="L5638">					lottoPurchaseBean = (LottoPurchaseBean) sRes.getResponseData();</span>
<span class="nc bnc" id="L5639" title="All 2 branches missed.">					if (lottoPurchaseBean.getSaleStatus() == null) {</span>
<span class="nc" id="L5640">						lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);// Error</span>
<span class="nc" id="L5641">						orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, lottoPurchaseBean.getGame_no(),</span>
								&quot;FAILED&quot;, balDed);
<span class="nc" id="L5643">						return lottoPurchaseBean;</span>
<span class="nc bnc" id="L5644" title="All 2 branches missed.">					} else if (&quot;ERROR_TICKET_LIMIT&quot;.equalsIgnoreCase(lottoPurchaseBean.getSaleStatus())) {</span>
<span class="nc" id="L5645">						orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, lottoPurchaseBean.getGame_no(),</span>
								&quot;FAILED&quot;, balDed);
<span class="nc" id="L5647">						return lottoPurchaseBean;</span>
					} else {
<span class="nc" id="L5649">						orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, lottoPurchaseBean.getGame_no(),</span>
								&quot;FAILED&quot;, balDed);
<span class="nc" id="L5651">						return lottoPurchaseBean;</span>
					}
				}
			} else {

<span class="nc" id="L5656">				status = getStatusIfErrorInTransaction(status, balDed);</span>
<span class="nc" id="L5657">				lottoPurchaseBean.setSaleStatus(status);</span>
<span class="nc" id="L5658">				return lottoPurchaseBean;</span>
			}
<span class="nc" id="L5660">		} catch (Exception e) {</span>
			// TODO: handle exception
		}
<span class="nc" id="L5663">		return lottoPurchaseBean;</span>
	}

	// for tanzania lotto
	public LottoPurchaseBean tanzaniaLottoPurchaseTicket(UserInfoBean userBean, LottoPurchaseBean lottoPurchaseBean)
			throws Exception {

<span class="nc" id="L5670">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L5671">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L5672">		sReq.setServiceName(ServiceName.TANZANIALOTTO);</span>
<span class="nc" id="L5673">		sReq.setServiceMethod(ServiceMethodName.TANZANIALOTTO_PURCHASE_TICKET);</span>
<span class="nc" id="L5674">		sReq.setServiceData(lottoPurchaseBean);</span>
<span class="nc" id="L5675">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L5676">		lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L5677">		double oldTotalPurchaseAmt = 0.0;</span>
<span class="nc" id="L5678">		double modifiedTotalPurchaseAmt = 0.0;</span>
<span class="nc" id="L5679">		String status = &quot;&quot;;</span>
<span class="nc" id="L5680">		long balDed = 0;</span>
<span class="nc" id="L5681">		Connection con = null;</span>
		try {
<span class="nc bnc" id="L5683" title="All 2 branches missed.">			if (tanzaniaLottoDataValidation(lottoPurchaseBean)) {</span>

<span class="nc" id="L5685">				con = DBConnect.getConnection();</span>
				// here insert the last sold tikcet on terminal or by third
				// party

<span class="nc bnc" id="L5689" title="All 2 branches missed.">				if (lottoPurchaseBean.getLastSoldTicketNo() != null) {</span>
<span class="nc bnc" id="L5690" title="All 2 branches missed.">					if (!&quot;0&quot;.equalsIgnoreCase(lottoPurchaseBean.getLastSoldTicketNo())) {</span>
<span class="nc" id="L5691">						Util.insertLastSoldTicketTeminal(lottoPurchaseBean.getUserId(),</span>
								lottoPurchaseBean.getLastSoldTicketNo(), lottoPurchaseBean.getGameId(), con);
					}
				}
<span class="nc" id="L5695">				double totPurAmt = lottoPurchaseBean.getPicknumbers().length</span>
						* Util.getUnitPrice(lottoPurchaseBean.getGame_no(), null) * lottoPurchaseBean.getNoOfDraws();

<span class="nc" id="L5698">				logger.debug(&quot;!!totPurAmt!!!!&quot; + totPurAmt);</span>

<span class="nc" id="L5700">				lottoPurchaseBean.setTotalPurchaseAmt(totPurAmt);</span>
<span class="nc" id="L5701">				lottoPurchaseBean.setUnitPrice(Util.getUnitPrice(lottoPurchaseBean.getGame_no(), null));</span>

<span class="nc" id="L5703">				logger.debug(&quot;Inside  FE1*******&quot;);</span>
				// rg calling
<span class="nc" id="L5705">				boolean isFraud = ResponsibleGaming.respGaming(userBean, &quot;DG_SALE&quot;, totPurAmt + &quot;&quot;);</span>
<span class="nc bnc" id="L5706" title="All 2 branches missed.">				if (!isFraud) {</span>

<span class="nc" id="L5708">					balDed = orgOnLineSaleCreditUpdation.drawTcketSaleBalDeduction(userBean,</span>
							lottoPurchaseBean.getGame_no(), lottoPurchaseBean.getTotalPurchaseAmt(),
							lottoPurchaseBean.getPlrMobileNumber(), con);
<span class="nc" id="L5711">					oldTotalPurchaseAmt = lottoPurchaseBean.getTotalPurchaseAmt();</span>

<span class="nc" id="L5713">					logger.debug(&quot;Total Purchase Amt inside DrawGameRPOSHelper Just Before  getting Success :&quot;</span>
							+ oldTotalPurchaseAmt);
				} else {
<span class="nc" id="L5716">					logger.debug(&quot;Responsing Gaming not allowed to sale&quot;);</span>
<span class="nc" id="L5717">					lottoPurchaseBean.setSaleStatus(&quot;FRAUD&quot;);</span>
				}
<span class="nc" id="L5719">			} else {</span>
<span class="nc" id="L5720">				logger.debug(&quot;Data validation returns false&quot;);</span>
<span class="nc" id="L5721">				lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
			}
<span class="nc" id="L5723">		} catch (Exception e) {</span>
<span class="nc" id="L5724">			e.printStackTrace();</span>
			// commented by amit as not relevant here

			/*
			 * lottoPurchaseBean = (LottoPurchaseBean) sRes.getResponseData();
			 * String ticketNo = lottoPurchaseBean.getTicket_no(); String
			 * cancelChannel = lottoPurchaseBean.getPurchaseChannel();
			 * Map&lt;Integer, Map&lt;Integer, String&gt;&gt; drawIdTableMap =
			 * lottoPurchaseBean .getDrawIdTableMap(); int gameNo =
			 * lottoPurchaseBean.getGame_no(); int partyId =
			 * lottoPurchaseBean.getPartyId(); String partyType =
			 * lottoPurchaseBean.getPartyType(); String refTransId =
			 * lottoPurchaseBean.getRefTransId();
			 * 
			 * cancelTicket(ticketNo, cancelChannel, drawIdTableMap, gameNo,
			 * partyId, partyType, refTransId);
			 */
<span class="nc" id="L5741">		}</span>

		try {

<span class="nc bnc" id="L5745" title="All 2 branches missed.">			if (balDed &gt; 0) {</span>
<span class="nc" id="L5746">				lottoPurchaseBean.setRefTransId(balDed + &quot;&quot;);</span>
<span class="nc" id="L5747">				sRes = delegate.getResponse(sReq);</span>

<span class="nc bnc" id="L5749" title="All 2 branches missed.">				if (sRes.getIsSuccess()) {</span>
<span class="nc" id="L5750">					lottoPurchaseBean = (LottoPurchaseBean) sRes.getResponseData();</span>
<span class="nc" id="L5751">					modifiedTotalPurchaseAmt = lottoPurchaseBean.getTotalPurchaseAmt();</span>
<span class="nc" id="L5752">					logger.debug(&quot;Total Purchase Amt inside DrawGameRPOSHelper After getting Success :&quot;</span>
							+ modifiedTotalPurchaseAmt);
<span class="nc" id="L5754">					con = DBConnect.getConnection();</span>
<span class="nc bnc" id="L5755" title="All 2 branches missed.">					if (oldTotalPurchaseAmt != modifiedTotalPurchaseAmt) {</span>
<span class="nc" id="L5756">						balDed = orgOnLineSaleCreditUpdation.drawTcketSaleBalDedUpdate(userBean,</span>
								lottoPurchaseBean.getGame_no(), modifiedTotalPurchaseAmt, oldTotalPurchaseAmt, balDed,
								con);

					}
<span class="nc" id="L5761">					int tickUpd = orgOnLineSaleCreditUpdation.drawTicketSaleTicketUpdate(balDed,</span>
							lottoPurchaseBean.getTicket_no(), lottoPurchaseBean.getGame_no(), userBean,
							lottoPurchaseBean.getPurchaseChannel(), con);

<span class="nc bnc" id="L5765" title="All 2 branches missed.">					if (tickUpd == 1) {</span>
<span class="nc" id="L5766">						status = &quot;SUCCESS&quot;;</span>
<span class="nc" id="L5767">						lottoPurchaseBean.setAdvMsg(Util.getAdvMessage(userBean.getUserOrgId(),</span>
								lottoPurchaseBean.getGame_no(), &quot;PLAYER&quot;, &quot;SALE&quot;, &quot;DG&quot;));
<span class="nc" id="L5769">						lottoPurchaseBean.setSaleStatus(status);</span>
<span class="nc bnc" id="L5770" title="All 2 branches missed.">						if (!lottoPurchaseBean.getBarcodeType().equals(&quot;applet&quot;)) {</span>
<span class="nc" id="L5771">							IDBarcode</span>
									.getBarcode(lottoPurchaseBean.getTicket_no() + lottoPurchaseBean.getReprintCount());
						}

						// call promo purchase process here
<span class="nc" id="L5776">						List&lt;RafflePurchaseBean&gt; rafflePurchaseBeanList = new ArrayList&lt;RafflePurchaseBean&gt;();</span>
						// CommonFunctionsHelper commonHelper = new
						// CommonFunctionsHelper();

<span class="nc" id="L5780">						List&lt;PromoGameBean&gt; promoGameslist = Util.promoGameBeanMap.get(lottoPurchaseBean.getGame_no());</span>

						// String gameType =
						// getGameType(fortunePurchaseBean.getGame_no());
						// List&lt;PromoGameBean&gt; promoGameslist =
						// commonHelper.getAvailablePromoGames(gameType);

<span class="nc bnc" id="L5787" title="All 2 branches missed.">						for (int i = 0; i &lt; promoGameslist.size(); i++) {</span>
<span class="nc" id="L5788">							PromoGameBean promobean = promoGameslist.get(i);</span>
<span class="nc bnc" id="L5789" title="All 2 branches missed.">							if (promobean.getPromoGametype().equalsIgnoreCase(&quot;RAFFLE&quot;)) {</span>
<span class="nc" id="L5790">								lottoPurchaseBean.setRaffleNo(promobean.getPromoGameNo());</span>
<span class="nc" id="L5791">								RafflePurchaseBean rafflePurchaseBean = (RafflePurchaseBean) rafflePurchaseTicket(</span>
										userBean, lottoPurchaseBean, true);
<span class="nc" id="L5793">								rafflePurchaseBean.setRaffleTicketType(promobean.getPromoTicketType());</span>
<span class="nc bnc" id="L5794" title="All 2 branches missed.">								if (rafflePurchaseBean.getSaleStatus().equalsIgnoreCase(&quot;FAILED&quot;)) {</span>
<span class="nc" id="L5795">									status = &quot;FAILED&quot;;</span>
<span class="nc" id="L5796">									lottoPurchaseBean.setSaleStatus(status);</span>
									// Code for canceling the Ticket to
									// be send to Draw Game Engine
<span class="nc" id="L5799">									cancelTicket(lottoPurchaseBean.getTicket_no() + lottoPurchaseBean.getReprintCount(),</span>
											lottoPurchaseBean.getPurchaseChannel(),
											lottoPurchaseBean.getDrawIdTableMap(), lottoPurchaseBean.getGame_no(),
											lottoPurchaseBean.getPartyId(), lottoPurchaseBean.getPartyType(),
											lottoPurchaseBean.getRefMerchantId(), userBean,
											lottoPurchaseBean.getRefTransId());
<span class="nc" id="L5805">									lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L5806">									return lottoPurchaseBean;</span>
<span class="nc bnc" id="L5807" title="All 2 branches missed.">								} else if (rafflePurchaseBean.getSaleStatus().equalsIgnoreCase(&quot;SUCCESS&quot;)) {</span>
									// here insert entry into the promo
									// ticket mapping table
<span class="nc" id="L5810">									int tktlen = rafflePurchaseBean.getRaffleTicket_no().length();</span>
<span class="nc" id="L5811">									orgOnLineSaleCreditUpdation.drawTicketNPromoMappigUpdate(1,</span>
											rafflePurchaseBean.getGame_no(), rafflePurchaseBean.getParentTktNo(),
											rafflePurchaseBean.getRaffleTicket_no().substring(0, tktlen - 2));
<span class="nc" id="L5814">									rafflePurchaseBeanList.add(rafflePurchaseBean);</span>
								}
							}
						}
						/*
						 * String gameType =
						 * getGameType(lottoPurchaseBean.getGame_no());
						 * List&lt;PromoGameBean&gt; promoGameslist =
						 * commonHelper.getAvailablePromoGames(gameType);
						 * 
						 * for(int i=0;i&lt;promoGameslist.size();i++){
						 * PromoGameBean promobean=promoGameslist.get(i);
						 * if(promobean.getPromoGametype().equalsIgnoreCase(
						 * &quot;RAFFLE&quot;)){ lottoPurchaseBean.setRaffleNo(promobean.
						 * getPromoGameNo()); RafflePurchaseBean
						 * rafflePurchaseBean = (RafflePurchaseBean)
						 * rafflePurchaseTicket( userBean,
						 * lottoPurchaseBean,true);
						 * rafflePurchaseBean.setRaffleTicketType(promobean.
						 * getPromoTicketType()); if
						 * (rafflePurchaseBean.getSaleStatus()
						 * .equalsIgnoreCase(&quot;FAILED&quot;)) { status = &quot;FAILED&quot;;
						 * lottoPurchaseBean .setSaleStatus(status); // Code for
						 * cancelling the Ticket to be send to Draw Game Engine
						 * cancelTicket(lottoPurchaseBean.getTicket_no(),
						 * lottoPurchaseBean.getPurchaseChannel(),
						 * lottoPurchaseBean.getDrawIdTableMap(),
						 * lottoPurchaseBean.getGame_no(),
						 * lottoPurchaseBean.getPartyId(),
						 * lottoPurchaseBean.getPartyType(),
						 * lottoPurchaseBean.getRefMerchantId(), userBean,
						 * lottoPurchaseBean .getRefTransId());
						 * lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;); return
						 * lottoPurchaseBean; }else if
						 * (rafflePurchaseBean.getSaleStatus().equalsIgnoreCase(
						 * &quot;SUCCESS&quot;)){ //here insert entry into the promo
						 * ticket mapping table int
						 * tktlen=rafflePurchaseBean.getRaffleTicket_no().length
						 * (); orgOnLineSaleCreditUpdation.
						 * drawTicketNPromoMappigUpdate(1,
						 * rafflePurchaseBean.getGame_no(),
						 * rafflePurchaseBean.getParentTktNo(),
						 * (rafflePurchaseBean.getRaffleTicket_no()).substring(
						 * 0, tktlen - 2));
						 * rafflePurchaseBeanList.add(rafflePurchaseBean); } } }
						 */

<span class="nc" id="L5861">						lottoPurchaseBean.setRafflePurchaseBeanList(rafflePurchaseBeanList);</span>

<span class="nc" id="L5863">						return lottoPurchaseBean;</span>
					} else {
<span class="nc" id="L5865">						status = &quot;FAILED&quot;;</span>
<span class="nc" id="L5866">						lottoPurchaseBean.setSaleStatus(status);</span>
						// Code for cancelling the Ticket to be send to
						// Draw
						// Game Engine
<span class="nc" id="L5870">						cancelTicket(lottoPurchaseBean.getTicket_no(), lottoPurchaseBean.getPurchaseChannel(),</span>
								lottoPurchaseBean.getDrawIdTableMap(), lottoPurchaseBean.getGame_no(),
								lottoPurchaseBean.getPartyId(), lottoPurchaseBean.getPartyType(),
								lottoPurchaseBean.getRefMerchantId(), userBean, lottoPurchaseBean.getRefTransId());

<span class="nc" id="L5875">						return lottoPurchaseBean;</span>
					}
				} else {
<span class="nc" id="L5878">					lottoPurchaseBean = (LottoPurchaseBean) sRes.getResponseData();</span>
<span class="nc bnc" id="L5879" title="All 2 branches missed.">					if (lottoPurchaseBean.getSaleStatus() == null) {</span>
<span class="nc" id="L5880">						lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);// Error</span>
<span class="nc" id="L5881">						orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, lottoPurchaseBean.getGame_no(),</span>
								&quot;FAILED&quot;, balDed);
<span class="nc" id="L5883">						return lottoPurchaseBean;</span>
<span class="nc bnc" id="L5884" title="All 2 branches missed.">					} else if (&quot;ERROR_TICKET_LIMIT&quot;.equalsIgnoreCase(lottoPurchaseBean.getSaleStatus())) {</span>
<span class="nc" id="L5885">						orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, lottoPurchaseBean.getGame_no(),</span>
								&quot;FAILED&quot;, balDed);
<span class="nc" id="L5887">						return lottoPurchaseBean;</span>
					} else {
<span class="nc" id="L5889">						orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, lottoPurchaseBean.getGame_no(),</span>
								&quot;FAILED&quot;, balDed);
<span class="nc" id="L5891">						return lottoPurchaseBean;</span>
					}

				}
			} else {

<span class="nc" id="L5897">				status = getStatusIfErrorInTransaction(status, balDed);</span>
<span class="nc" id="L5898">				lottoPurchaseBean.setSaleStatus(status);</span>
<span class="nc" id="L5899">				return lottoPurchaseBean;</span>
			}
<span class="nc" id="L5901">		} catch (Exception e) {</span>
			// TODO: handle exception
		}
<span class="nc" id="L5904">		return lottoPurchaseBean;</span>
	}

	// ZimLottotwo Data Validation
	public boolean zimLottoTwoDataValidation(LottoPurchaseBean lottoPurchaseBean) {
<span class="nc" id="L5909">		int noOfDraws = lottoPurchaseBean.getNoOfDraws();</span>
<span class="nc" id="L5910">		String playType = lottoPurchaseBean.getPlayType();</span>
<span class="nc bnc" id="L5911" title="All 2 branches missed.">		if (&quot;Direct6&quot;.equals(playType)) {</span>
<span class="nc" id="L5912">			String[] picknumbers = lottoPurchaseBean.getPicknumbers();</span>
			Set&lt;Integer&gt; picknumSet;
			String pickNum[];
<span class="nc" id="L5915">			int noOfPanels = picknumbers.length;</span>
<span class="nc" id="L5916">			logger.debug(&quot;no of Panels: &quot; + noOfPanels);</span>
<span class="nc bnc" id="L5917" title="All 4 branches missed.">			if (noOfDraws &gt; 0 &amp;&amp; noOfPanels &gt; 0) {</span>
<span class="nc bnc" id="L5918" title="All 2 branches missed.">				for (int i = 0; i &lt; noOfPanels; i++) {</span>
<span class="nc bnc" id="L5919" title="All 2 branches missed.">					if (picknumbers[i].equalsIgnoreCase(&quot;QP&quot;)) {</span>
<span class="nc" id="L5920">						logger.debug(&quot;quick pick Selected&quot;);</span>

					} else {
<span class="nc" id="L5923">						logger.debug(&quot;not quick pick&quot;);</span>
<span class="nc" id="L5924">						logger.debug(&quot;Player picked Data:&quot; + picknumbers[i]);</span>
<span class="nc" id="L5925">						pickNum = picknumbers[i].split(&quot;,&quot;);</span>
<span class="nc" id="L5926">						picknumSet = new HashSet&lt;Integer&gt;();</span>
<span class="nc bnc" id="L5927" title="All 2 branches missed.">						for (String element : pickNum) {</span>
<span class="nc" id="L5928">							picknumSet.add(Integer.parseInt(element));</span>
						}
<span class="nc bnc" id="L5930" title="All 4 branches missed.">						if (pickNum.length != picknumSet.size()</span>
								|| pickNum.length &gt; com.skilrock.lms.dge.gameconstants.ZimlottotwoConstants.MAX_PLAYER_PICKED) {
<span class="nc" id="L5932">							logger.debug(&quot;picNum.Length: &quot; + pickNum.length + &quot;Set length:  &quot; + picknumSet.size());</span>
<span class="nc" id="L5933">							return false;</span>
						}
					}
				}
<span class="nc" id="L5937">				return true;</span>
			}
<span class="nc bnc" id="L5939" title="All 2 branches missed.">		} else if (&quot;Perm6&quot;.equals(playType)) {</span>
<span class="nc" id="L5940">			return true;</span>
		}
<span class="nc" id="L5942">		return false;</span>
	}

	// by sumit singla

	public LottoPurchaseBean zimLottoThreePurchaseTicket(UserInfoBean userBean, LottoPurchaseBean lottoPurchaseBean)
			throws Exception {

<span class="nc" id="L5950">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L5951">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L5952">		sReq.setServiceName(ServiceName.ZIMLOTTOTHREE);</span>
<span class="nc" id="L5953">		sReq.setServiceMethod(ServiceMethodName.ZIMLOTTOTHREE_PURCHASE_TICKET);</span>
<span class="nc" id="L5954">		sReq.setServiceData(lottoPurchaseBean);</span>
<span class="nc" id="L5955">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L5956">		lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L5957">		double oldTotalPurchaseAmt = 0.0;</span>
<span class="nc" id="L5958">		double modifiedTotalPurchaseAmt = 0.0;</span>
<span class="nc" id="L5959">		String status = &quot;&quot;;</span>
<span class="nc" id="L5960">		long balDed = 0;</span>
<span class="nc" id="L5961">		Connection con = null;</span>
		try {
<span class="nc bnc" id="L5963" title="All 2 branches missed.">			if (zimLottoTwoDataValidation(lottoPurchaseBean)) {</span>

<span class="nc" id="L5965">				con = DBConnect.getConnection();</span>

				// here insert the last sold tikcet on terminal or by third
				// party

<span class="nc bnc" id="L5970" title="All 2 branches missed.">				if (lottoPurchaseBean.getLastSoldTicketNo() != null) {</span>
<span class="nc bnc" id="L5971" title="All 2 branches missed.">					if (!&quot;0&quot;.equalsIgnoreCase(lottoPurchaseBean.getLastSoldTicketNo())) {</span>
<span class="nc" id="L5972">						Util.insertLastSoldTicketTeminal(lottoPurchaseBean.getUserId(),</span>
								lottoPurchaseBean.getLastSoldTicketNo(), lottoPurchaseBean.getGameId(), con);
					}
				}
<span class="nc" id="L5976">				int noOfLines = calculateNoOfLines(lottoPurchaseBean);</span>
<span class="nc" id="L5977">				double unitPrice = Util.getUnitPrice(lottoPurchaseBean.getGame_no(), lottoPurchaseBean.getPlayType());</span>
<span class="nc" id="L5978">				lottoPurchaseBean.setUnitPrice(unitPrice);</span>
<span class="nc" id="L5979">				double totPurAmt = 0.0;</span>
<span class="nc bnc" id="L5980" title="All 2 branches missed.">				if (lottoPurchaseBean.isPromotkt()) {</span>
<span class="nc" id="L5981">					lottoPurchaseBean.setTotalPurchaseAmt(totPurAmt);</span>
				} else {
<span class="nc" id="L5983">					totPurAmt = noOfLines * unitPrice * lottoPurchaseBean.getNoOfDraws();</span>
<span class="nc" id="L5984">					totPurAmt = CommonMethods.fmtToTwoDecimal(totPurAmt);</span>
				}

<span class="nc" id="L5987">				logger.debug(&quot;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&quot; + totPurAmt);</span>

<span class="nc" id="L5989">				lottoPurchaseBean.setTotalPurchaseAmt(totPurAmt);</span>
<span class="nc bnc" id="L5990" title="All 2 branches missed.">				if (!userBean.getUserType().equals(&quot;RETAILER&quot;)) {</span>
<span class="nc" id="L5991">					return lottoPurchaseBean;</span>
				}

<span class="nc" id="L5994">				logger.debug(&quot;Inside  FE1*******&quot;);</span>
				// rg calling
<span class="nc" id="L5996">				boolean isFraud = ResponsibleGaming.respGaming(userBean, &quot;DG_SALE&quot;, totPurAmt + &quot;&quot;);</span>
<span class="nc bnc" id="L5997" title="All 2 branches missed.">				if (!isFraud) {</span>

<span class="nc" id="L5999">					balDed = orgOnLineSaleCreditUpdation.drawTcketSaleBalDeduction(userBean,</span>
							lottoPurchaseBean.getGame_no(), lottoPurchaseBean.getTotalPurchaseAmt(),
							lottoPurchaseBean.getPlrMobileNumber(), con);
<span class="nc" id="L6002">					oldTotalPurchaseAmt = lottoPurchaseBean.getTotalPurchaseAmt();</span>

<span class="nc" id="L6004">					logger.debug(&quot;Total Purchase Amt inside DrawGameRPOSHelper Just Before  getting Success :&quot;</span>
							+ oldTotalPurchaseAmt);
				} else {
<span class="nc" id="L6007">					logger.debug(&quot;Responsing Gaming not allowed to sale&quot;);</span>
<span class="nc" id="L6008">					lottoPurchaseBean.setSaleStatus(&quot;FRAUD&quot;);</span>
				}
<span class="nc" id="L6010">			} else {</span>
<span class="nc" id="L6011">				logger.debug(&quot;Data validation returns false&quot;);</span>
<span class="nc" id="L6012">				lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
			}
<span class="nc" id="L6014">		} catch (Exception e) {</span>
<span class="nc" id="L6015">			e.printStackTrace();</span>
			// commented by amit as not relevant here

			/*
			 * lottoPurchaseBean = (LottoPurchaseBean) sRes.getResponseData();
			 * String ticketNo = lottoPurchaseBean.getTicket_no(); String
			 * cancelChannel = lottoPurchaseBean.getPurchaseChannel();
			 * Map&lt;Integer, Map&lt;Integer, String&gt;&gt; drawIdTableMap =
			 * lottoPurchaseBean .getDrawIdTableMap(); int gameNo =
			 * lottoPurchaseBean.getGame_no(); int partyId =
			 * lottoPurchaseBean.getPartyId(); String partyType =
			 * lottoPurchaseBean.getPartyType(); String refTransId =
			 * lottoPurchaseBean.getRefTransId();
			 * 
			 * cancelTicket(ticketNo, cancelChannel, drawIdTableMap, gameNo,
			 * partyId, partyType, refTransId);
			 */
<span class="nc" id="L6032">		}</span>

		try {
<span class="nc bnc" id="L6035" title="All 2 branches missed.">			if (balDed &gt; 0) {</span>
<span class="nc" id="L6036">				lottoPurchaseBean.setRefTransId(balDed + &quot;&quot;);</span>
<span class="nc" id="L6037">				sRes = delegate.getResponse(sReq);</span>

<span class="nc bnc" id="L6039" title="All 2 branches missed.">				if (sRes.getIsSuccess()) {</span>
<span class="nc" id="L6040">					lottoPurchaseBean = (LottoPurchaseBean) sRes.getResponseData();</span>
<span class="nc" id="L6041">					modifiedTotalPurchaseAmt = lottoPurchaseBean.getTotalPurchaseAmt();</span>

					// rouding

<span class="nc" id="L6045">					modifiedTotalPurchaseAmt = CommonMethods.roundDrawTktAmt(modifiedTotalPurchaseAmt);</span>

<span class="nc" id="L6047">					logger.debug(&quot;Total Purchase Amt inside DrawGameRPOSHelper After getting Success :&quot;</span>
							+ modifiedTotalPurchaseAmt);
<span class="nc" id="L6049">					con = DBConnect.getConnection();</span>
<span class="nc bnc" id="L6050" title="All 2 branches missed.">					if (oldTotalPurchaseAmt != modifiedTotalPurchaseAmt) {</span>
<span class="nc" id="L6051">						lottoPurchaseBean.setTotalPurchaseAmt(modifiedTotalPurchaseAmt);</span>
<span class="nc" id="L6052">						balDed = orgOnLineSaleCreditUpdation.drawTcketSaleBalDedUpdate(userBean,</span>
								lottoPurchaseBean.getGame_no(), modifiedTotalPurchaseAmt, oldTotalPurchaseAmt, balDed,
								con);

					}
<span class="nc" id="L6057">					int tickUpd = orgOnLineSaleCreditUpdation.drawTicketSaleTicketUpdate(balDed,</span>
							lottoPurchaseBean.getTicket_no(), lottoPurchaseBean.getGame_no(), userBean,
							lottoPurchaseBean.getPurchaseChannel(), con);

<span class="nc bnc" id="L6061" title="All 2 branches missed.">					if (tickUpd == 1) {</span>
<span class="nc" id="L6062">						status = &quot;SUCCESS&quot;;</span>
						// lottoPurchaseBean.setAdvMsg(Util.getAdvMessage(userBean.getUserOrgId(),
						// lottoPurchaseBean.getGame_no(), &quot;PLAYER&quot;, &quot;SALE&quot;,
						// &quot;DG&quot;));
<span class="nc" id="L6066">						lottoPurchaseBean.setAdvMsg(</span>
								Util.getDGSaleAdvMessage(userBean.getUserOrgId(), lottoPurchaseBean.getGame_no()));

<span class="nc" id="L6069">						lottoPurchaseBean.setSaleStatus(status);</span>
<span class="nc bnc" id="L6070" title="All 2 branches missed.">						if (!lottoPurchaseBean.getBarcodeType().equals(&quot;applet&quot;)) {</span>
<span class="nc" id="L6071">							IDBarcode</span>
									.getBarcode(lottoPurchaseBean.getTicket_no() + lottoPurchaseBean.getReprintCount());
						}

						// call promo purchase process here
<span class="nc" id="L6076">						List&lt;RafflePurchaseBean&gt; rafflePurchaseBeanList = new ArrayList&lt;RafflePurchaseBean&gt;();</span>
						// CommonFunctionsHelper commonHelper = new
						// CommonFunctionsHelper();

<span class="nc" id="L6080">						List&lt;PromoGameBean&gt; promoGameslist = Util.promoGameBeanMap.get(lottoPurchaseBean.getGame_no());</span>

						// String gameType =
						// getGameType(fortunePurchaseBean.getGame_no());
						// List&lt;PromoGameBean&gt; promoGameslist =
						// commonHelper.getAvailablePromoGames(gameType);

<span class="nc bnc" id="L6087" title="All 2 branches missed.">						for (int i = 0; i &lt; promoGameslist.size(); i++) {</span>
<span class="nc" id="L6088">							PromoGameBean promobean = promoGameslist.get(i);</span>
<span class="nc bnc" id="L6089" title="All 2 branches missed.">							if (promobean.getPromoGametype().equalsIgnoreCase(&quot;RAFFLE&quot;)) {</span>
<span class="nc" id="L6090">								lottoPurchaseBean.setRaffleNo(promobean.getPromoGameNo());</span>
<span class="nc" id="L6091">								RafflePurchaseBean rafflePurchaseBean = (RafflePurchaseBean) rafflePurchaseTicket(</span>
										userBean, lottoPurchaseBean, true);
<span class="nc" id="L6093">								rafflePurchaseBean.setRaffleTicketType(promobean.getPromoTicketType());</span>
<span class="nc bnc" id="L6094" title="All 2 branches missed.">								if (rafflePurchaseBean.getSaleStatus().equalsIgnoreCase(&quot;FAILED&quot;)) {</span>
<span class="nc" id="L6095">									status = &quot;FAILED&quot;;</span>
<span class="nc" id="L6096">									lottoPurchaseBean.setSaleStatus(status);</span>
									// Code for cancelling the Ticket to
									// be send to Draw Game Engine
<span class="nc" id="L6099">									cancelTicket(lottoPurchaseBean.getTicket_no() + lottoPurchaseBean.getReprintCount(),</span>
											lottoPurchaseBean.getPurchaseChannel(),
											lottoPurchaseBean.getDrawIdTableMap(), lottoPurchaseBean.getGame_no(),
											lottoPurchaseBean.getPartyId(), lottoPurchaseBean.getPartyType(),
											lottoPurchaseBean.getRefMerchantId(), userBean,
											lottoPurchaseBean.getRefTransId());
<span class="nc" id="L6105">									lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L6106">									return lottoPurchaseBean;</span>
<span class="nc bnc" id="L6107" title="All 2 branches missed.">								} else if (rafflePurchaseBean.getSaleStatus().equalsIgnoreCase(&quot;SUCCESS&quot;)) {</span>
									// here insert entry into the promo
									// ticket mapping table
<span class="nc" id="L6110">									int tktlen = rafflePurchaseBean.getRaffleTicket_no().length();</span>
<span class="nc" id="L6111">									orgOnLineSaleCreditUpdation.drawTicketNPromoMappigUpdate(1,</span>
											rafflePurchaseBean.getGame_no(), rafflePurchaseBean.getParentTktNo(),
											rafflePurchaseBean.getRaffleTicket_no().substring(0, tktlen - 2));
<span class="nc" id="L6114">									rafflePurchaseBeanList.add(rafflePurchaseBean);</span>
								}
							}
						}
						/*
						 * String gameType =
						 * getGameType(lottoPurchaseBean.getGame_no());
						 * List&lt;PromoGameBean&gt; promoGameslist =
						 * commonHelper.getAvailablePromoGames(gameType);
						 * 
						 * for(int i=0;i&lt;promoGameslist.size();i++){
						 * PromoGameBean promobean=promoGameslist.get(i);
						 * if(promobean.getPromoGametype().equalsIgnoreCase(
						 * &quot;RAFFLE&quot;)){ lottoPurchaseBean.setRaffleNo(promobean.
						 * getPromoGameNo()); RafflePurchaseBean
						 * rafflePurchaseBean = (RafflePurchaseBean)
						 * rafflePurchaseTicket( userBean,
						 * lottoPurchaseBean,true);
						 * rafflePurchaseBean.setRaffleTicketType(promobean.
						 * getPromoTicketType()); if
						 * (rafflePurchaseBean.getSaleStatus()
						 * .equalsIgnoreCase(&quot;FAILED&quot;)) { status = &quot;FAILED&quot;;
						 * lottoPurchaseBean .setSaleStatus(status); // Code for
						 * cancelling the Ticket to be send to Draw Game Engine
						 * cancelTicket(lottoPurchaseBean.getTicket_no(),
						 * lottoPurchaseBean.getPurchaseChannel(),
						 * lottoPurchaseBean.getDrawIdTableMap(),
						 * lottoPurchaseBean.getGame_no(),
						 * lottoPurchaseBean.getPartyId(),
						 * lottoPurchaseBean.getPartyType(),
						 * lottoPurchaseBean.getRefMerchantId(), userBean,
						 * lottoPurchaseBean .getRefTransId());
						 * lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;); return
						 * lottoPurchaseBean; }else if
						 * (rafflePurchaseBean.getSaleStatus().equalsIgnoreCase(
						 * &quot;SUCCESS&quot;)){ //here insert entry into the promo
						 * ticket mapping table int
						 * tktlen=rafflePurchaseBean.getRaffleTicket_no().length
						 * (); orgOnLineSaleCreditUpdation.
						 * drawTicketNPromoMappigUpdate(1,
						 * rafflePurchaseBean.getGame_no(),
						 * rafflePurchaseBean.getParentTktNo(),
						 * (rafflePurchaseBean.getRaffleTicket_no()).substring(
						 * 0, tktlen - 2));
						 * rafflePurchaseBeanList.add(rafflePurchaseBean); } } }
						 */

<span class="nc" id="L6161">						lottoPurchaseBean.setRafflePurchaseBeanList(rafflePurchaseBeanList);</span>

<span class="nc" id="L6163">						return lottoPurchaseBean;</span>
					} else {
<span class="nc" id="L6165">						status = &quot;FAILED&quot;;</span>
<span class="nc" id="L6166">						lottoPurchaseBean.setSaleStatus(status);</span>
						// Code for cancelling the Ticket to be send to
						// Draw
						// Game Engine
<span class="nc" id="L6170">						cancelTicket(lottoPurchaseBean.getTicket_no(), lottoPurchaseBean.getPurchaseChannel(),</span>
								lottoPurchaseBean.getDrawIdTableMap(), lottoPurchaseBean.getGame_no(),
								lottoPurchaseBean.getPartyId(), lottoPurchaseBean.getPartyType(),
								lottoPurchaseBean.getRefMerchantId(), userBean, lottoPurchaseBean.getRefTransId());

<span class="nc" id="L6175">						return lottoPurchaseBean;</span>
					}
				} else {

<span class="nc" id="L6179">					lottoPurchaseBean = (LottoPurchaseBean) sRes.getResponseData();</span>
<span class="nc bnc" id="L6180" title="All 2 branches missed.">					if (lottoPurchaseBean.getSaleStatus() == null) {</span>
<span class="nc" id="L6181">						lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);// Error</span>
<span class="nc" id="L6182">						orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, lottoPurchaseBean.getGame_no(),</span>
								&quot;FAILED&quot;, balDed);
<span class="nc" id="L6184">						return lottoPurchaseBean;</span>
<span class="nc bnc" id="L6185" title="All 2 branches missed.">					} else if (&quot;ERROR_TICKET_LIMIT&quot;.equalsIgnoreCase(lottoPurchaseBean.getSaleStatus())) {</span>
<span class="nc" id="L6186">						orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, lottoPurchaseBean.getGame_no(),</span>
								&quot;FAILED&quot;, balDed);
<span class="nc" id="L6188">						return lottoPurchaseBean;</span>
					} else {
<span class="nc" id="L6190">						orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, lottoPurchaseBean.getGame_no(),</span>
								&quot;FAILED&quot;, balDed);
<span class="nc" id="L6192">						return lottoPurchaseBean;</span>
					}
				}
			} else {

<span class="nc" id="L6197">				status = getStatusIfErrorInTransaction(status, balDed);</span>
<span class="nc" id="L6198">				lottoPurchaseBean.setSaleStatus(status);</span>
<span class="nc" id="L6199">				return lottoPurchaseBean;</span>
			}
<span class="nc" id="L6201">		} catch (Exception e) {</span>
			// TODO: handle exception
		}
<span class="nc" id="L6204">		return lottoPurchaseBean;</span>
	}

	public LottoPurchaseBean zimLottoTwoPurchaseTicket(UserInfoBean userBean, LottoPurchaseBean lottoPurchaseBean)
			throws Exception {
<span class="nc" id="L6209">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L6210">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L6211">		sReq.setServiceName(ServiceName.ZIMLOTTOTWO);</span>
<span class="nc" id="L6212">		sReq.setServiceMethod(ServiceMethodName.ZIMLOTTOTWO_PURCHASE_TICKET);</span>
<span class="nc" id="L6213">		sReq.setServiceData(lottoPurchaseBean);</span>
<span class="nc" id="L6214">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L6215">		double lmsTicketPrice = 0.0;</span>
<span class="nc" id="L6216">		double dgeTicketPrice = 0.0;</span>
<span class="nc" id="L6217">		double modifiedTotalPurchaseAmt = 0.0;</span>
<span class="nc" id="L6218">		String status = &quot;&quot;;</span>
<span class="nc" id="L6219">		long balDed = 0;</span>
<span class="nc" id="L6220">		Connection con = null;</span>

		try {
<span class="nc bnc" id="L6223" title="All 2 branches missed.">			if (zimLottoTwoDataValidation(lottoPurchaseBean)) {</span>
				// lottoPurchaseBean.setAdvMsg(Util.getAdvMessage(userBean.getUserOrgId(),
				// lottoPurchaseBean.getGame_no(), &quot;PLAYER&quot;, &quot;SALE&quot;, &quot;DG&quot;));
<span class="nc" id="L6226">				lottoPurchaseBean</span>
						.setAdvMsg(Util.getDGSaleAdvMessage(userBean.getUserOrgId(), lottoPurchaseBean.getGame_no()));

<span class="nc" id="L6229">				lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L6230">				int noOfLines = lottoPurchaseBean.getPicknumbers().length;</span>

<span class="nc" id="L6232">				con = DBConnect.getConnection();</span>

				// here insert the last sold tikcet on terminal or by third
				// party

<span class="nc bnc" id="L6237" title="All 2 branches missed.">				if (lottoPurchaseBean.getLastSoldTicketNo() != null) {</span>
<span class="nc bnc" id="L6238" title="All 2 branches missed.">					if (!&quot;0&quot;.equalsIgnoreCase(lottoPurchaseBean.getLastSoldTicketNo())) {</span>
<span class="nc" id="L6239">						Util.insertLastSoldTicketTeminal(lottoPurchaseBean.getUserId(),</span>
								lottoPurchaseBean.getLastSoldTicketNo(), lottoPurchaseBean.getGameId(), con);
					}
				}
<span class="nc bnc" id="L6243" title="All 2 branches missed.">				if (&quot;Perm6&quot;.equals(lottoPurchaseBean.getPlayType())) {</span>
<span class="nc" id="L6244">					int n = lottoPurchaseBean.getNoPicked();</span>
<span class="nc bnc" id="L6245" title="All 2 branches missed.">					if (n &lt; 7) {</span>
<span class="nc" id="L6246">						lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L6247">						return lottoPurchaseBean;</span>
					}
<span class="nc" id="L6249">					noOfLines = (n * (n - 1) * (n - 2) * (n - 3) * (n - 4) * (n - 5)) / 720;</span>
				}
<span class="nc" id="L6251">				lottoPurchaseBean.setNoOfLines(noOfLines);</span>
<span class="nc" id="L6252">				double unitPrice = Util.getUnitPrice(lottoPurchaseBean.getGame_no(), lottoPurchaseBean.getPlayType());</span>
<span class="nc" id="L6253">				lottoPurchaseBean.setUnitPrice(unitPrice);</span>
<span class="nc" id="L6254">				dgeTicketPrice = noOfLines * unitPrice * lottoPurchaseBean.getNoOfDraws();</span>
				// rouding
<span class="nc" id="L6256">				lmsTicketPrice = CommonMethods.roundDrawTktAmt(dgeTicketPrice);</span>

<span class="nc" id="L6258">				lmsTicketPrice = CommonMethods.fmtToTwoDecimal(lmsTicketPrice);</span>

<span class="nc" id="L6260">				logger.debug(&quot;DGE Ticket Price&quot; + dgeTicketPrice);</span>
<span class="nc" id="L6261">				logger.debug(&quot;LMS Ticket Price&quot; + lmsTicketPrice);</span>
<span class="nc" id="L6262">				lottoPurchaseBean.setTotalPurchaseAmt(dgeTicketPrice);</span>

<span class="nc" id="L6264">				logger.debug(&quot;Inside  FE1*******&quot;);</span>
				// rg calling
<span class="nc" id="L6266">				boolean isFraud = ResponsibleGaming.respGaming(userBean, &quot;DG_SALE&quot;, lmsTicketPrice + &quot;&quot;);</span>
<span class="nc bnc" id="L6267" title="All 2 branches missed.">				if (!isFraud) {</span>
<span class="nc" id="L6268">					balDed = orgOnLineSaleCreditUpdation.drawTcketSaleBalDeduction(userBean,</span>
							lottoPurchaseBean.getGame_no(), lmsTicketPrice, lottoPurchaseBean.getPlrMobileNumber(),
							con);

<span class="nc" id="L6272">					logger.debug(&quot;Total Purchase Amt inside DrawGameRPOSHelper Just Before  getting Success :&quot;</span>
							+ lmsTicketPrice);
				} else {
<span class="nc" id="L6275">					logger.debug(&quot;Responsing Gaming not allowed to sale&quot;);</span>
<span class="nc" id="L6276">					lottoPurchaseBean.setSaleStatus(&quot;FRAUD&quot;);</span>
				}
<span class="nc" id="L6278">			} else {</span>
<span class="nc" id="L6279">				logger.debug(&quot;Data validation returns false&quot;);</span>
<span class="nc" id="L6280">				lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
			}
<span class="nc" id="L6282">		} catch (Exception e) {</span>
<span class="nc" id="L6283">			e.printStackTrace();</span>
			// commented by amit as not relevant here

			/*
			 * lottoPurchaseBean = (LottoPurchaseBean) sRes.getResponseData();
			 * String ticketNo = lottoPurchaseBean.getTicket_no(); String
			 * cancelChannel = lottoPurchaseBean.getPurchaseChannel();
			 * Map&lt;Integer, Map&lt;Integer, String&gt;&gt; drawIdTableMap =
			 * lottoPurchaseBean .getDrawIdTableMap(); int gameNo =
			 * lottoPurchaseBean.getGame_no(); int partyId =
			 * lottoPurchaseBean.getPartyId(); String partyType =
			 * lottoPurchaseBean.getPartyType(); String refTransId =
			 * lottoPurchaseBean.getRefTransId();
			 * 
			 * cancelTicket(ticketNo, cancelChannel, drawIdTableMap, gameNo,
			 * partyId, partyType, refTransId);
			 */
<span class="nc" id="L6300">		}</span>

		try {
<span class="nc bnc" id="L6303" title="All 2 branches missed.">			if (balDed &gt; 0) {</span>
<span class="nc" id="L6304">				lottoPurchaseBean.setRefTransId(balDed + &quot;&quot;);</span>
<span class="nc" id="L6305">				sRes = delegate.getResponse(sReq);</span>

<span class="nc bnc" id="L6307" title="All 2 branches missed.">				if (sRes.getIsSuccess()) {</span>
<span class="nc" id="L6308">					lottoPurchaseBean = (LottoPurchaseBean) sRes.getResponseData();</span>
<span class="nc" id="L6309">					modifiedTotalPurchaseAmt = lottoPurchaseBean.getTotalPurchaseAmt();</span>

<span class="nc" id="L6311">					logger.debug(&quot;Total Purchase Amt inside DrawGameRPOSHelper After getting Success :&quot;</span>
							+ modifiedTotalPurchaseAmt);
<span class="nc" id="L6313">					con = DBConnect.getConnection();</span>
<span class="nc bnc" id="L6314" title="All 2 branches missed.">					if (dgeTicketPrice != modifiedTotalPurchaseAmt) {</span>

						// rouding

<span class="nc" id="L6318">						modifiedTotalPurchaseAmt = CommonMethods.roundDrawTktAmt(modifiedTotalPurchaseAmt);</span>

<span class="nc" id="L6320">						lottoPurchaseBean.setTotalPurchaseAmt(modifiedTotalPurchaseAmt);</span>
<span class="nc" id="L6321">						balDed = orgOnLineSaleCreditUpdation.drawTcketSaleBalDedUpdate(userBean,</span>
								lottoPurchaseBean.getGame_no(), modifiedTotalPurchaseAmt, lmsTicketPrice, balDed, con);

					}
<span class="nc" id="L6325">					int tickUpd = orgOnLineSaleCreditUpdation.drawTicketSaleTicketUpdate(balDed,</span>
							lottoPurchaseBean.getTicket_no(), lottoPurchaseBean.getGame_no(), userBean,
							lottoPurchaseBean.getPurchaseChannel(), con);

<span class="nc bnc" id="L6329" title="All 2 branches missed.">					if (tickUpd == 1) {</span>
<span class="nc" id="L6330">						status = &quot;SUCCESS&quot;;</span>
<span class="nc" id="L6331">						lottoPurchaseBean.setSaleStatus(status);</span>
<span class="nc bnc" id="L6332" title="All 2 branches missed.">						if (!lottoPurchaseBean.getBarcodeType().equals(&quot;applet&quot;)) {</span>
<span class="nc" id="L6333">							IDBarcode</span>
									.getBarcode(lottoPurchaseBean.getTicket_no() + lottoPurchaseBean.getReprintCount());
						}

						// call promo purchase process here
<span class="nc" id="L6338">						List&lt;RafflePurchaseBean&gt; rafflePurchaseBeanList = new ArrayList&lt;RafflePurchaseBean&gt;();</span>
						// CommonFunctionsHelper commonHelper = new
						// CommonFunctionsHelper();

<span class="nc" id="L6342">						List&lt;PromoGameBean&gt; promoGameslist = Util.promoGameBeanMap.get(lottoPurchaseBean.getGame_no());</span>

						// String gameType =
						// getGameType(fortunePurchaseBean.getGame_no());
						// List&lt;PromoGameBean&gt; promoGameslist =
						// commonHelper.getAvailablePromoGames(gameType);

<span class="nc" id="L6349">						boolean isLoopAgain = true;</span>

<span class="nc bnc" id="L6351" title="All 2 branches missed.">						for (int i = 0; i &lt; promoGameslist.size(); i++) {</span>
<span class="nc" id="L6352">							PromoGameBean promobean = promoGameslist.get(i);</span>
<span class="nc" id="L6353">							List&lt;LottoPurchaseBean&gt; lottoBeanList = new ArrayList&lt;LottoPurchaseBean&gt;();</span>
<span class="nc bnc" id="L6354" title="All 2 branches missed.">							for (int k = 0; k &lt; promobean.getNoOfPromoTickets(); k++) {</span>
<span class="nc bnc" id="L6355" title="All 2 branches missed.">								if (promobean.getPromoGametype().equalsIgnoreCase(&quot;RAFFLE&quot;)) {</span>
<span class="nc" id="L6356">									lottoPurchaseBean.setRaffleNo(promobean.getPromoGameNo());</span>
<span class="nc" id="L6357">									RafflePurchaseBean rafflePurchaseBean = (RafflePurchaseBean) rafflePurchaseTicket(</span>
											userBean, lottoPurchaseBean, true);
<span class="nc" id="L6359">									rafflePurchaseBean.setRaffleTicketType(promobean.getPromoTicketType());</span>
<span class="nc bnc" id="L6360" title="All 2 branches missed.">									if (rafflePurchaseBean.getSaleStatus().equalsIgnoreCase(&quot;FAILED&quot;)) {</span>
<span class="nc" id="L6361">										status = &quot;FAILED&quot;;</span>
<span class="nc" id="L6362">										lottoPurchaseBean.setSaleStatus(status);</span>
										// Code for cancelling the Ticket to
										// be send to Draw Game Engine
<span class="nc" id="L6365">										cancelTicket(</span>
												lottoPurchaseBean.getTicket_no() + lottoPurchaseBean.getReprintCount(),
												lottoPurchaseBean.getPurchaseChannel(),
												lottoPurchaseBean.getDrawIdTableMap(), lottoPurchaseBean.getGame_no(),
												lottoPurchaseBean.getPartyId(), lottoPurchaseBean.getPartyType(),
												lottoPurchaseBean.getRefMerchantId(), userBean,
												lottoPurchaseBean.getRefTransId());
<span class="nc" id="L6372">										lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L6373">										return lottoPurchaseBean;</span>
<span class="nc bnc" id="L6374" title="All 2 branches missed.">									} else if (rafflePurchaseBean.getSaleStatus().equalsIgnoreCase(&quot;SUCCESS&quot;)) {</span>
										// here insert entry into the promo
										// ticket mapping table
<span class="nc" id="L6377">										int tktlen = rafflePurchaseBean.getRaffleTicket_no().length();</span>
<span class="nc" id="L6378">										orgOnLineSaleCreditUpdation.drawTicketNPromoMappigUpdate(1,</span>
												rafflePurchaseBean.getGame_no(), rafflePurchaseBean.getParentTktNo(),
												rafflePurchaseBean.getRaffleTicket_no().substring(0, tktlen - 2));
<span class="nc" id="L6381">										rafflePurchaseBeanList.add(rafflePurchaseBean);</span>
									}
<span class="nc bnc" id="L6383" title="All 2 branches missed.">								} else if (promobean.getPromoGametype().equalsIgnoreCase(&quot;Zimlottothree&quot;)) {</span>

<span class="nc bnc" id="L6385" title="All 2 branches missed.">									if (isLoopAgain) {</span>
										// call winfast purchase process
<span class="nc" id="L6387">										int gameId = Util.getGameId(&quot;Zimlottothree&quot;);</span>
<span class="nc" id="L6388">										LottoPurchaseBean drawGamePurchaseBean = new LottoPurchaseBean();</span>
										// drawGamePurchaseBean.setIsQP(1);
										// drawGamePurchaseBean.setTotalNoOfPanels(1);
										// drawGamePurchaseBean.setSymbols(symbols);
										// drawGamePurchaseBean.setNoOfPanels(&quot;1&quot;);

										// drawGamePurchaseBean.setBetAmountMultiple(betAmountMultiple);
<span class="nc" id="L6395">										drawGamePurchaseBean.setDrawIdTableMap(lottoPurchaseBean.getDrawIdTableMap());</span>
<span class="nc" id="L6396">										drawGamePurchaseBean.setGame_no(gameId);</span>
<span class="nc" id="L6397">										drawGamePurchaseBean.setGameDispName(Util.getGameDisplayName(gameId));</span>
										// drawGamePurchaseBean.setIsQuickPick(isQuickPickNew);
<span class="nc" id="L6399">										drawGamePurchaseBean.setNoOfDraws(2);</span>
<span class="nc" id="L6400">										drawGamePurchaseBean.setPartyId(userBean.getUserOrgId());</span>
<span class="nc" id="L6401">										drawGamePurchaseBean.setPartyType(userBean.getUserType());</span>
<span class="nc" id="L6402">										drawGamePurchaseBean.setUserId(userBean.getUserId());</span>
<span class="nc" id="L6403">										drawGamePurchaseBean.setRefMerchantId(lottoPurchaseBean.getRefMerchantId());</span>
<span class="nc" id="L6404">										drawGamePurchaseBean.setPurchaseChannel(lottoPurchaseBean.getPurchaseChannel());</span>
<span class="nc" id="L6405">										drawGamePurchaseBean.setPromotkt(true);</span>
<span class="nc" id="L6406">										drawGamePurchaseBean.setNoPicked(lottoPurchaseBean.getNoPicked());</span>
<span class="nc" id="L6407">										drawGamePurchaseBean.setPlrMobileNumber(lottoPurchaseBean.getPlrMobileNumber());</span>

<span class="nc" id="L6409">										StringBuilder sb = new StringBuilder(&quot;QP&quot;);</span>
<span class="nc bnc" id="L6410" title="All 2 branches missed.">										if (&quot;Direct6&quot;.equalsIgnoreCase(lottoPurchaseBean.getPlayType())) {</span>
<span class="nc bnc" id="L6411" title="All 2 branches missed.">											for (int m = 1; m &lt; lottoPurchaseBean.getNoOfLines()</span>
<span class="nc" id="L6412">													* promobean.getNoOfPromoTickets(); m++) {</span>
<span class="nc" id="L6413">												sb.append(&quot;NxtQP&quot;);</span>
											}
										}
<span class="nc" id="L6416">										String pickedNumbers = sb.toString();</span>
<span class="nc" id="L6417">										String[] picknumbers = pickedNumbers.split(&quot;Nxt&quot;);</span>
<span class="nc" id="L6418">										drawGamePurchaseBean.setPickedNumbers(pickedNumbers);</span>
<span class="nc" id="L6419">										drawGamePurchaseBean.setPicknumbers(picknumbers);</span>

<span class="nc" id="L6421">										drawGamePurchaseBean.setPlayType(lottoPurchaseBean.getPlayType());</span>
										// if (drawIdArr != null) {
										// drawGamePurchaseBean.setDrawDateTime(Arrays.asList(drawIdArr));
										// }
<span class="nc" id="L6425">										drawGamePurchaseBean.setIsAdvancedPlay(0);</span>
<span class="nc" id="L6426">										LottoPurchaseBean lottoBean = zimLottoThreePurchaseTicket(userBean,</span>
												drawGamePurchaseBean);
<span class="nc bnc" id="L6428" title="All 2 branches missed.">										if (&quot;SUCCESS&quot;.equalsIgnoreCase(lottoBean.getSaleStatus())) {</span>
<span class="nc" id="L6429">											orgOnLineSaleCreditUpdation.drawTicketNPromoMappigUpdate(1,</span>
													lottoPurchaseBean.getGame_no(), lottoPurchaseBean.getTicket_no(),
													lottoBean.getTicket_no());
										} else {
<span class="nc" id="L6433">											lottoPurchaseBean.setPromoSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L6434">											return lottoPurchaseBean;</span>
										}

<span class="nc" id="L6437">										lottoBeanList.add(lottoBean);</span>
<span class="nc" id="L6438">										logger.debug(&quot;Promo Bean Data for zim lotto Three&quot; + lottoBean);</span>
										// kenoPurchaseBean.setFortunePurchaseBean(fortuneBean);
<span class="nc" id="L6440">										lottoPurchaseBean.setPromoPurchaseBeanList(lottoBeanList);</span>

									}
<span class="nc bnc" id="L6443" title="All 2 branches missed.">									if (&quot;Direct6&quot;.equalsIgnoreCase(lottoPurchaseBean.getPlayType()))</span>
<span class="nc" id="L6444">										isLoopAgain = false;</span>
								}
							}
						}
						/*
						 * String gameType =
						 * getGameType(lottoPurchaseBean.getGame_no());
						 * List&lt;PromoGameBean&gt; promoGameslist =
						 * commonHelper.getAvailablePromoGames(gameType);
						 * 
						 * for(int i=0;i&lt;promoGameslist.size();i++){
						 * PromoGameBean promobean=promoGameslist.get(i);
						 * if(promobean.getPromoGametype().equalsIgnoreCase(
						 * &quot;RAFFLE&quot;)){ lottoPurchaseBean.setRaffleNo(promobean.
						 * getPromoGameNo()); RafflePurchaseBean
						 * rafflePurchaseBean = (RafflePurchaseBean)
						 * rafflePurchaseTicket( userBean,
						 * lottoPurchaseBean,true);
						 * rafflePurchaseBean.setRaffleTicketType(promobean.
						 * getPromoTicketType()); if
						 * (rafflePurchaseBean.getSaleStatus()
						 * .equalsIgnoreCase(&quot;FAILED&quot;)) { status = &quot;FAILED&quot;;
						 * lottoPurchaseBean .setSaleStatus(status); // Code for
						 * cancelling the Ticket to be send to Draw Game Engine
						 * cancelTicket(lottoPurchaseBean.getTicket_no(),
						 * lottoPurchaseBean.getPurchaseChannel(),
						 * lottoPurchaseBean.getDrawIdTableMap(),
						 * lottoPurchaseBean.getGame_no(),
						 * lottoPurchaseBean.getPartyId(),
						 * lottoPurchaseBean.getPartyType(),
						 * lottoPurchaseBean.getRefMerchantId(), userBean,
						 * lottoPurchaseBean .getRefTransId());
						 * lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;); return
						 * lottoPurchaseBean; }else if
						 * (rafflePurchaseBean.getSaleStatus().equalsIgnoreCase(
						 * &quot;SUCCESS&quot;)){ //here insert entry into the promo
						 * ticket mapping table int
						 * tktlen=rafflePurchaseBean.getRaffleTicket_no().length
						 * (); orgOnLineSaleCreditUpdation.
						 * drawTicketNPromoMappigUpdate(1,
						 * rafflePurchaseBean.getGame_no(),
						 * rafflePurchaseBean.getParentTktNo(),
						 * (rafflePurchaseBean.getRaffleTicket_no()).substring(
						 * 0, tktlen - 2));
						 * rafflePurchaseBeanList.add(rafflePurchaseBean); } } }
						 */

<span class="nc" id="L6491">						lottoPurchaseBean.setRafflePurchaseBeanList(rafflePurchaseBeanList);</span>

<span class="nc" id="L6493">						return lottoPurchaseBean;</span>
					} else {
<span class="nc" id="L6495">						status = &quot;FAILED&quot;;</span>
<span class="nc" id="L6496">						lottoPurchaseBean.setSaleStatus(status);</span>
						// Code for cancelling the Ticket to be send to
						// Draw
						// Game Engine
<span class="nc" id="L6500">						cancelTicket(lottoPurchaseBean.getTicket_no(), lottoPurchaseBean.getPurchaseChannel(),</span>
								lottoPurchaseBean.getDrawIdTableMap(), lottoPurchaseBean.getGame_no(),
								lottoPurchaseBean.getPartyId(), lottoPurchaseBean.getPartyType(),
								lottoPurchaseBean.getRefMerchantId(), userBean, lottoPurchaseBean.getRefTransId());

<span class="nc" id="L6505">						return lottoPurchaseBean;</span>
					}
				} else {

<span class="nc" id="L6509">					lottoPurchaseBean = (LottoPurchaseBean) sRes.getResponseData();</span>
<span class="nc bnc" id="L6510" title="All 2 branches missed.">					if (lottoPurchaseBean.getSaleStatus() == null) {</span>
<span class="nc" id="L6511">						lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);// Error</span>
<span class="nc" id="L6512">						orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, lottoPurchaseBean.getGame_no(),</span>
								&quot;FAILED&quot;, balDed);
<span class="nc" id="L6514">						return lottoPurchaseBean;</span>
<span class="nc bnc" id="L6515" title="All 2 branches missed.">					} else if (&quot;ERROR_TICKET_LIMIT&quot;.equalsIgnoreCase(lottoPurchaseBean.getSaleStatus())) {</span>
<span class="nc" id="L6516">						orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, lottoPurchaseBean.getGame_no(),</span>
								&quot;FAILED&quot;, balDed);
<span class="nc" id="L6518">						return lottoPurchaseBean;</span>
					} else {
<span class="nc" id="L6520">						orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, lottoPurchaseBean.getGame_no(),</span>
								&quot;FAILED&quot;, balDed);
<span class="nc" id="L6522">						return lottoPurchaseBean;</span>
					}
				}
			} else {

<span class="nc" id="L6527">				status = getStatusIfErrorInTransaction(status, balDed);</span>
<span class="nc" id="L6528">				lottoPurchaseBean.setSaleStatus(status);</span>
<span class="nc" id="L6529">				return lottoPurchaseBean;</span>
			}
<span class="nc" id="L6531">		} catch (Exception e) {</span>
			// TODO: handle exception
		}
<span class="nc" id="L6534">		return lottoPurchaseBean;</span>
	}

	public LottoPurchaseBean zimLottoBonusPurchaseTicketLATEST(UserInfoBean userBean,
			LottoPurchaseBean lottoPurchaseBean) throws Exception {

		// ServiceResponse sRes = new ServiceResponse();
<span class="nc" id="L6541">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L6542">		sReq.setServiceName(ServiceName.ZIMLOTTOBONUS_MGMT);</span>
<span class="nc" id="L6543">		sReq.setServiceMethod(ServiceMethodName.ZIMLOTTOBONUS_PURCHASE_TICKET);</span>
		// sReq.setServiceData(lottoPurchaseBean);
<span class="nc" id="L6545">		LottoRequestBean requestBean = new LottoRequestBean();</span>
<span class="nc" id="L6546">		sReq.setServiceData(requestBean);</span>
<span class="nc" id="L6547">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L6548">		double dgeTicketPrice = 0.0;</span>
<span class="nc" id="L6549">		double lmsTicketPrice = 0.0;</span>
<span class="nc" id="L6550">		String status = &quot;&quot;;</span>
<span class="nc" id="L6551">		long balDed = 0;</span>
<span class="nc" id="L6552">		Connection con = null;</span>

		try {

<span class="nc" id="L6556">			lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L6557">			int noOfLines = lottoPurchaseBean.getPicknumbers().length;</span>
<span class="nc" id="L6558">			con = getConnectionObject();</span>

<span class="nc bnc" id="L6560" title="All 2 branches missed.">			if (&quot;TERMINAL&quot;.equals(lottoPurchaseBean.getDeviceType())) {</span>
<span class="nc" id="L6561">				int autoCancelHoldDays = Integer.parseInt(Utility.getPropertyValue(&quot;AUTO_CANCEL_CLOSER_DAYS&quot;));</span>
<span class="nc" id="L6562">				checkLastPrintedTicketStatusAndUpdate(userBean, Long.parseLong(lottoPurchaseBean.getLastSoldTicketNo()),</span>
						lottoPurchaseBean.getDeviceType(), lottoPurchaseBean.getRefMerchantId(), autoCancelHoldDays,
						lottoPurchaseBean.getActionName(), lottoPurchaseBean.getLastGameId(), con);
			}

<span class="nc bnc" id="L6567" title="All 2 branches missed.">			if (&quot;Perm6&quot;.equals(lottoPurchaseBean.getPlayType())) {</span>
<span class="nc" id="L6568">				int n = lottoPurchaseBean.getNoPicked();</span>
<span class="nc bnc" id="L6569" title="All 2 branches missed.">				if (n &lt; 7) {</span>
<span class="nc" id="L6570">					lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L6571">					return lottoPurchaseBean;</span>
				}
<span class="nc" id="L6573">				noOfLines = (n * (n - 1) * (n - 2) * (n - 3) * (n - 4) * (n - 5)) / 720;</span>
			}
<span class="nc" id="L6575">			lottoPurchaseBean.setNoOfLines(noOfLines);</span>
<span class="nc" id="L6576">			double unitPrice = Util.getUnitPrice(lottoPurchaseBean.getGameId(), lottoPurchaseBean.getPlayType());</span>
<span class="nc" id="L6577">			lottoPurchaseBean.setUnitPrice(unitPrice);</span>
<span class="nc" id="L6578">			dgeTicketPrice = noOfLines * unitPrice * lottoPurchaseBean.getNoOfDraws();</span>
			// rouding
<span class="nc" id="L6580">			lmsTicketPrice = CommonMethods.roundDrawTktAmt(dgeTicketPrice);</span>

<span class="nc" id="L6582">			lmsTicketPrice = CommonMethods.fmtToTwoDecimal(lmsTicketPrice);</span>

<span class="nc" id="L6584">			logger.debug(&quot;Dge Purchase Amount - &quot; + dgeTicketPrice);</span>
<span class="nc" id="L6585">			logger.debug(&quot;LMS Purchase Amount - &quot; + lmsTicketPrice);</span>

<span class="nc" id="L6587">			lottoPurchaseBean.setTotalPurchaseAmt(dgeTicketPrice);</span>

<span class="nc" id="L6589">			logger.debug(&quot;Inside  FE1*******&quot;);</span>
			// rg calling
<span class="nc" id="L6591">			boolean isFraud = ResponsibleGaming.respGaming(userBean, &quot;DG_SALE&quot;, lmsTicketPrice + &quot;&quot;, con);</span>
<span class="nc bnc" id="L6592" title="All 2 branches missed.">			if (!isFraud) {</span>
<span class="nc" id="L6593">				balDed = orgOnLineSaleCreditUpdation.drawTcketSaleBalDeduction(userBean, lottoPurchaseBean.getGameId(),</span>
						lmsTicketPrice, lottoPurchaseBean.getPlrMobileNumber(), con);

<span class="nc" id="L6596">				logger.debug(</span>
						&quot;Total Purchase Amt inside DrawGameRPOSHelper Just Before  getting Success :&quot; + lmsTicketPrice);

<span class="nc bnc" id="L6599" title="All 2 branches missed.">				if (balDed &gt; 0) {</span>
<span class="nc" id="L6600">					logger.debug(&quot;in keno if----------------&quot;);</span>
<span class="nc" id="L6601">					lottoPurchaseBean.setRefTransId(balDed + &quot;&quot;);</span>
<span class="nc" id="L6602">					con.commit();</span>
				} else {
<span class="nc" id="L6604">					status = getStatusIfErrorInTransaction(status, balDed);</span>
<span class="nc" id="L6605">					lottoPurchaseBean.setSaleStatus(status);</span>
<span class="nc" id="L6606">					return lottoPurchaseBean;</span>
				}
			} else {
<span class="nc" id="L6609">				logger.debug(&quot;Responsing Gaming not allowed to sale&quot;);</span>
<span class="nc" id="L6610">				lottoPurchaseBean.setSaleStatus(&quot;FRAUD&quot;);</span>
<span class="nc" id="L6611">				return lottoPurchaseBean;</span>
			}

<span class="nc" id="L6614">		} catch (SQLException se) {</span>
<span class="nc" id="L6615">			se.printStackTrace();</span>
<span class="nc" id="L6616">			throw new LMSException();</span>
<span class="nc" id="L6617">		} catch (Exception e) {</span>
<span class="nc" id="L6618">			e.printStackTrace();</span>
<span class="nc" id="L6619">			throw new LMSException();</span>
		} finally {
<span class="nc" id="L6621">			DBConnect.closeCon(con);</span>
<span class="nc" id="L6622">		}</span>

		try {
<span class="nc" id="L6625">			lottoPurchaseBean.setRefTransId(balDed + &quot;&quot;);</span>
<span class="nc" id="L6626">			requestBean.setDrawIdTableMap(lottoPurchaseBean.getDrawIdTableMap());</span>
<span class="nc" id="L6627">			requestBean.setDrawDateTime(lottoPurchaseBean.getDrawDateTime());</span>
<span class="nc" id="L6628">			requestBean.setGame_no(lottoPurchaseBean.getGame_no());</span>
<span class="nc" id="L6629">			requestBean.setGameId(lottoPurchaseBean.getGameId());</span>
<span class="nc" id="L6630">			requestBean.setIsAdvancedPlay(lottoPurchaseBean.getIsAdvancedPlay());</span>
<span class="nc" id="L6631">			requestBean.setNoOfDraws(lottoPurchaseBean.getNoOfDraws());</span>
<span class="nc" id="L6632">			requestBean.setNoPicked(lottoPurchaseBean.getNoPicked());</span>
<span class="nc" id="L6633">			requestBean.setPartyId(lottoPurchaseBean.getPartyId());</span>
<span class="nc" id="L6634">			requestBean.setPartyType(lottoPurchaseBean.getPartyType());</span>
<span class="nc" id="L6635">			requestBean.setPlayerData(lottoPurchaseBean.getPickedNumbers());</span>
<span class="nc" id="L6636">			requestBean.setPickedNumbers(lottoPurchaseBean.getPickedNumbers());</span>
<span class="nc" id="L6637">			requestBean.setPlayType(lottoPurchaseBean.getPlayType());</span>
<span class="nc" id="L6638">			requestBean.setPurchaseChannel(lottoPurchaseBean.getPurchaseChannel());</span>
<span class="nc" id="L6639">			requestBean.setRefMerchantId(lottoPurchaseBean.getRefMerchantId());</span>
<span class="nc" id="L6640">			requestBean.setRefTransId(lottoPurchaseBean.getRefTransId());</span>
<span class="nc" id="L6641">			requestBean.setUserId(lottoPurchaseBean.getUserId());</span>
<span class="nc" id="L6642">			requestBean.setUserMappingId(lottoPurchaseBean.getUserMappingId());</span>
<span class="nc" id="L6643">			requestBean.setServiceId(lottoPurchaseBean.getServiceId());</span>
<span class="nc" id="L6644">			requestBean.setPicknumbers(lottoPurchaseBean.getPicknumbers());</span>
<span class="nc" id="L6645">			requestBean.setPromotkt(lottoPurchaseBean.isPromotkt());</span>
<span class="nc" id="L6646">			requestBean.setUnitPrice(lottoPurchaseBean.getUnitPrice());</span>
<span class="nc" id="L6647">			requestBean.setTotalPurchaseAmt(lottoPurchaseBean.getTotalPurchaseAmt());</span>

<span class="nc" id="L6649">			String responseString = delegate.getResponseString(sReq);</span>
<span class="nc" id="L6650">			LottoResponseBean responseBean = new Gson().fromJson(responseString, LottoResponseBean.class);</span>

<span class="nc bnc" id="L6652" title="All 2 branches missed.">			if (responseBean.getIsSuccess()) {</span>
<span class="nc" id="L6653">				lottoPurchaseBean.setSaleStatus(responseBean.getSaleStatus());</span>
<span class="nc" id="L6654">				lottoPurchaseBean.setTicket_no(responseBean.getTicketNo());</span>
<span class="nc" id="L6655">				lottoPurchaseBean.setBarcodeCount(responseBean.getBarcodeCount());</span>
<span class="nc" id="L6656">				lottoPurchaseBean.setNoOfDraws(responseBean.getNoOfDraws());</span>
<span class="nc" id="L6657">				lottoPurchaseBean.setPurchaseTime(responseBean.getPurchaseTime());</span>
<span class="nc" id="L6658">				lottoPurchaseBean.setReprintCount(responseBean.getReprintCount());</span>
<span class="nc" id="L6659">				lottoPurchaseBean.setPlayerPicked(responseBean.getPlayerPicked());</span>
<span class="nc" id="L6660">				lottoPurchaseBean.setTotalPurchaseAmt(responseBean.getTotalPurchaseAmt());</span>
<span class="nc" id="L6661">				lottoPurchaseBean.setDrawDateTime(responseBean.getDrawDateTime());</span>
<span class="nc" id="L6662">				lottoPurchaseBean.setIsQuickPick(responseBean.getIsQuickPick());</span>
<span class="nc" id="L6663">				lottoPurchaseBean.setPanel_id(responseBean.getPanel_id());</span>
				// lottoPurchaseBean = new Gson().fromJson(responseString,
				// elementType);
<span class="nc" id="L6666">				double fromDgeTicketPrice = lottoPurchaseBean.getTotalPurchaseAmt();</span>

				// rouding

<span class="nc" id="L6670">				lottoPurchaseBean.setTotalPurchaseAmt(lmsTicketPrice);</span>

<span class="nc" id="L6672">				logger.debug(</span>
						&quot;Total Purchase Amt inside DrawGameRPOSHelper After getting Success :&quot; + fromDgeTicketPrice);
<span class="nc" id="L6674">				con = getConnectionObject();</span>
<span class="nc bnc" id="L6675" title="All 2 branches missed.">				if (fromDgeTicketPrice != dgeTicketPrice) {</span>
<span class="nc" id="L6676">					fromDgeTicketPrice = CommonMethods.roundDrawTktAmt(fromDgeTicketPrice);</span>
<span class="nc" id="L6677">					lottoPurchaseBean.setTotalPurchaseAmt(fromDgeTicketPrice);</span>
<span class="nc" id="L6678">					balDed = orgOnLineSaleCreditUpdation.drawTcketSaleBalDedUpdate(userBean,</span>
							lottoPurchaseBean.getGameId(), fromDgeTicketPrice, lmsTicketPrice, balDed, con);

				}
<span class="nc" id="L6682">				int tickUpd = 1;// orgOnLineSaleCreditUpdation.drawTicketSaleTicketUpdate(balDed,lottoPurchaseBean.getTicket_no(),lottoPurchaseBean.getGameId(),</span>
								// userBean,lottoPurchaseBean.getPurchaseChannel(),con);

<span class="nc bnc" id="L6685" title="All 2 branches missed.">				if (tickUpd == 1) {</span>
<span class="nc" id="L6686">					AjaxRequestHelper ajxHelper = new AjaxRequestHelper();</span>
<span class="nc" id="L6687">					ajxHelper.getAvlblCreditAmt(userBean, con);</span>
<span class="nc" id="L6688">					status = &quot;SUCCESS&quot;;</span>
<span class="nc" id="L6689">					lottoPurchaseBean.setSaleStatus(status);</span>
<span class="nc" id="L6690">					lottoPurchaseBean.setAdvMsg(</span>
							Util.getDGSaleAdvMessage(userBean.getUserOrgId(), lottoPurchaseBean.getGameId()));

<span class="nc bnc" id="L6693" title="All 2 branches missed.">					if (!&quot;applet&quot;.equals(lottoPurchaseBean.getBarcodeType())) {</span>
<span class="nc" id="L6694">						IDBarcode.getBarcode(lottoPurchaseBean.getTicket_no() + lottoPurchaseBean.getReprintCount());</span>
					}
<span class="nc" id="L6696">					con.commit();</span>
					// call promo purchase process here
<span class="nc" id="L6698">					List&lt;RafflePurchaseBean&gt; rafflePurchaseBeanList = new ArrayList&lt;RafflePurchaseBean&gt;();</span>
					// CommonFunctionsHelper commonHelper = new
					// CommonFunctionsHelper();

<span class="nc" id="L6702">					List&lt;PromoGameBean&gt; promoGameslist = Util.promoGameBeanMap.get(lottoPurchaseBean.getGameId());</span>
					// String gameType =
					// getGameType(fortunePurchaseBean.getGame_no());
					// List&lt;PromoGameBean&gt; promoGameslist =
					// commonHelper.getAvailablePromoGames(gameType);
<span class="nc" id="L6707">					boolean isLoopAgain = true;</span>
<span class="nc bnc" id="L6708" title="All 2 branches missed.">					for (int i = 0; i &lt; promoGameslist.size(); i++) {</span>
<span class="nc" id="L6709">						PromoGameBean promobean = promoGameslist.get(i);</span>
<span class="nc" id="L6710">						List&lt;LottoPurchaseBean&gt; lottoBeanList = new ArrayList&lt;LottoPurchaseBean&gt;();</span>
<span class="nc bnc" id="L6711" title="All 2 branches missed.">						for (int k = 0; k &lt; promobean.getNoOfPromoTickets(); k++) {</span>
<span class="nc bnc" id="L6712" title="All 2 branches missed.">							if (promobean.getPromoGametype().equalsIgnoreCase(&quot;RAFFLE&quot;)) {</span>
<span class="nc" id="L6713">								lottoPurchaseBean.setRaffleNo(promobean.getPromoGameNo());</span>
<span class="nc" id="L6714">								RafflePurchaseBean rafflePurchaseBean = (RafflePurchaseBean) rafflePurchaseTicket(</span>
										userBean, lottoPurchaseBean, true);
<span class="nc" id="L6716">								rafflePurchaseBean.setRaffleTicketType(promobean.getPromoTicketType());</span>
<span class="nc bnc" id="L6717" title="All 2 branches missed.">								if (rafflePurchaseBean.getSaleStatus().equalsIgnoreCase(&quot;FAILED&quot;)) {</span>
<span class="nc" id="L6718">									status = &quot;FAILED&quot;;</span>
<span class="nc" id="L6719">									lottoPurchaseBean.setSaleStatus(status);</span>
									// Code for cancelling the Ticket to
									// be send to Draw Game Engine
<span class="nc" id="L6722">									cancelTicket(lottoPurchaseBean.getTicket_no() + lottoPurchaseBean.getReprintCount(),</span>
											lottoPurchaseBean.getPurchaseChannel(),
											lottoPurchaseBean.getDrawIdTableMap(), lottoPurchaseBean.getGame_no(),
											lottoPurchaseBean.getPartyId(), lottoPurchaseBean.getPartyType(),
											lottoPurchaseBean.getRefMerchantId(), userBean,
											lottoPurchaseBean.getRefTransId());
<span class="nc" id="L6728">									lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L6729">									return lottoPurchaseBean;</span>
<span class="nc bnc" id="L6730" title="All 2 branches missed.">								} else if (rafflePurchaseBean.getSaleStatus().equalsIgnoreCase(&quot;SUCCESS&quot;)) {</span>
									// here insert entry into the promo
									// ticket mapping table
<span class="nc" id="L6733">									int tktlen = rafflePurchaseBean.getRaffleTicket_no().length();</span>
<span class="nc" id="L6734">									orgOnLineSaleCreditUpdation.drawTicketNPromoMappigUpdate(1,</span>
											rafflePurchaseBean.getGame_no(), rafflePurchaseBean.getParentTktNo(),
											rafflePurchaseBean.getRaffleTicket_no().substring(0, tktlen - 2));
<span class="nc" id="L6737">									rafflePurchaseBeanList.add(rafflePurchaseBean);</span>
								}
							} /*
								 * else if (promobean.getPromoGameName().
								 * equalsIgnoreCase( &quot;Zimlottobonusfree&quot;)) { //
								 * call winfast purchase process
								 * 
								 * if(isLoopAgain){ int gameNo =
								 * promobean.getPromoGameNo(); int gameId =
								 * Util.getGameIdFromGameNumber(gameNo);
								 * LottoPurchaseBean drawGamePurchaseBean = new
								 * LottoPurchaseBean();
								 * //drawGamePurchaseBean.setIsQP(1);
								 * //drawGamePurchaseBean.setTotalNoOfPanels(1);
								 * // drawGamePurchaseBean.setSymbols(symbols);
								 * //drawGamePurchaseBean.setNoOfPanels(&quot;1&quot;);
								 * 
								 * // drawGamePurchaseBean.setBetAmountMultiple(
								 * betAmountMultiple);
								 * drawGamePurchaseBean.setDrawIdTableMap(
								 * lottoPurchaseBean .getDrawIdTableMap());
								 * drawGamePurchaseBean.setGame_no(gameNo);
								 * drawGamePurchaseBean.setGameId(gameId);
								 * drawGamePurchaseBean.setGameDispName(Util
								 * .getGameMap().get(gameId).getGameName()); //
								 * drawGamePurchaseBean.setIsQuickPick(
								 * isQuickPickNew);
								 * drawGamePurchaseBean.setNoOfDraws(promobean.
								 * getNoOfDraws());
								 * drawGamePurchaseBean.setPartyId(userBean.
								 * getUserOrgId());
								 * drawGamePurchaseBean.setPartyType(userBean.
								 * getUserType());
								 * drawGamePurchaseBean.setUserId(userBean.
								 * getUserId());
								 * drawGamePurchaseBean.setRefMerchantId(
								 * lottoPurchaseBean .getRefMerchantId());
								 * drawGamePurchaseBean.setPurchaseChannel(
								 * lottoPurchaseBean .getPurchaseChannel());
								 * drawGamePurchaseBean.setPromotkt(true);
								 * drawGamePurchaseBean.setNoPicked(
								 * lottoPurchaseBean.getNoPicked());
								 * drawGamePurchaseBean.setServiceId(
								 * lottoPurchaseBean.getServiceId());
								 * drawGamePurchaseBean.setUserMappingId(
								 * lottoPurchaseBean.getUserMappingId());
								 * drawGamePurchaseBean.setPlrMobileNumber(
								 * lottoPurchaseBean.getPlrMobileNumber());
								 * StringBuilder sb=new StringBuilder(&quot;QP&quot;);
								 * if(&quot;Direct6&quot;.equalsIgnoreCase(
								 * lottoPurchaseBean.getPlayType())){ for(int
								 * m=1;m&lt;lottoPurchaseBean.getNoOfLines()*
								 * promobean.getNoOfPromoTickets();m++){
								 * sb.append(&quot;NxtQP&quot;); } }else
								 * if(&quot;Perm6&quot;.equalsIgnoreCase(lottoPurchaseBean
								 * .getPlayType())){ for(int
								 * m=1;m&lt;promobean.getNoOfPromoTickets();m++){
								 * sb.append(&quot;NxtQP&quot;); } } String
								 * pickedNumbers=sb.toString();isDrawAvailable(
								 * lottoPurchaseBean.getGameId()) String[]
								 * picknumbers = pickedNumbers.split(&quot;Nxt&quot;);
								 * drawGamePurchaseBean.setPickedNumbers(
								 * pickedNumbers);
								 * drawGamePurchaseBean.setPicknumbers(
								 * picknumbers);
								 * 
								 * drawGamePurchaseBean.setPlayType(
								 * lottoPurchaseBean.getPlayType()); // if
								 * (drawIdArr != null) { //
								 * drawGamePurchaseBean.setDrawDateTime(Arrays.
								 * asList(drawIdArr)); // }
								 * drawGamePurchaseBean.setIsAdvancedPlay(0);
								 * LottoPurchaseBean lottoBean =
								 * ZimLottoBonusFreeHelper.
								 * zimLottoBonusFreePurchaseTicket( userBean,
								 * drawGamePurchaseBean, lottoPurchaseBean); if
								 * (&quot;SUCCESS&quot;.equalsIgnoreCase(lottoBean.
								 * getSaleStatus())) {
								 * orgOnLineSaleCreditUpdation
								 * .drawTicketNPromoMappigUpdate(1,
								 * lottoPurchaseBean .getGame_no(),
								 * lottoPurchaseBean .getTicket_no(),
								 * lottoBean.getTicket_no()); } else {
								 * lottoPurchaseBean.setPromoSaleStatus(&quot;FAILED&quot;
								 * ); return lottoPurchaseBean; }
								 * 
								 * lottoBeanList.add(lottoBean); logger.
								 * debug(&quot;Promo Bean Data for zim lotto Three&quot;
								 * +lottoBean); //
								 * kenoPurchaseBean.setFortunePurchaseBean(
								 * fortuneBean);
								 * lottoPurchaseBean.setPromoPurchaseBeanList(
								 * lottoBeanList); isLoopAgain=false;
								 * 
								 * } if(&quot;Direct6&quot;.equalsIgnoreCase(
								 * lottoPurchaseBean.getPlayType()))
								 * isLoopAgain=false; }
								 */
						}
					}
<span class="nc" id="L6837">					lottoPurchaseBean.setRafflePurchaseBeanList(rafflePurchaseBeanList);</span>

<span class="nc" id="L6839">					return lottoPurchaseBean;</span>
				} else {
<span class="nc" id="L6841">					status = &quot;FAILED&quot;;</span>
<span class="nc" id="L6842">					lottoPurchaseBean.setSaleStatus(status);</span>
					// Code for cancelling the Ticket to be send to
					// Draw
					// Game Engine
<span class="nc" id="L6846">					cancelTicket(lottoPurchaseBean.getTicket_no() + lottoPurchaseBean.getReprintCount(),</span>
							lottoPurchaseBean.getPurchaseChannel(), lottoPurchaseBean.getDrawIdTableMap(),
							lottoPurchaseBean.getGame_no(), lottoPurchaseBean.getPartyId(),
							lottoPurchaseBean.getPartyType(), lottoPurchaseBean.getRefMerchantId(), userBean,
							lottoPurchaseBean.getRefTransId());

<span class="nc" id="L6852">					return lottoPurchaseBean;</span>
				}
			} else {
<span class="nc" id="L6855">				lottoPurchaseBean.setSaleStatus(responseBean.getSaleStatus());</span>
				// lottoPurchaseBean = new Gson().fromJson(responseString,
				// elementType);
<span class="nc bnc" id="L6858" title="All 2 branches missed.">				if (lottoPurchaseBean.getSaleStatus() == null) {</span>
<span class="nc" id="L6859">					lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);// Error</span>
<span class="nc" id="L6860">					orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, lottoPurchaseBean.getGameId(), &quot;FAILED&quot;,</span>
							balDed);
<span class="nc" id="L6862">					return lottoPurchaseBean;</span>
<span class="nc bnc" id="L6863" title="All 2 branches missed.">				} else if (&quot;ERROR_TICKET_LIMIT&quot;.equalsIgnoreCase(lottoPurchaseBean.getSaleStatus())) {</span>
<span class="nc" id="L6864">					orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, lottoPurchaseBean.getGameId(), &quot;FAILED&quot;,</span>
							balDed);
<span class="nc" id="L6866">					return lottoPurchaseBean;</span>
				} else {
<span class="nc" id="L6868">					orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, lottoPurchaseBean.getGameId(), &quot;FAILED&quot;,</span>
							balDed);
<span class="nc" id="L6870">					return lottoPurchaseBean;</span>
				}
			}
<span class="nc" id="L6873">		} catch (Exception e) {</span>
<span class="nc" id="L6874">			e.printStackTrace();</span>
			// lottoPurchaseBean = new Gson().fromJson(responseString,
			// elementType);
<span class="nc bnc" id="L6877" title="All 2 branches missed.">			if (lottoPurchaseBean.getSaleStatus() == null) {</span>
<span class="nc" id="L6878">				lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);// Error</span>
<span class="nc" id="L6879">				orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, lottoPurchaseBean.getGameId(), &quot;FAILED&quot;,</span>
						balDed);
<span class="nc" id="L6881">				return lottoPurchaseBean;</span>
			} else {
<span class="nc" id="L6883">				orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, lottoPurchaseBean.getGameId(), &quot;FAILED&quot;,</span>
						balDed);
<span class="nc" id="L6885">				return lottoPurchaseBean;</span>
			}

		} finally {
<span class="nc" id="L6889">			DBConnect.closeCon(con);</span>
		}
	}

	public LottoPurchaseBean zimLottoBonusPurchaseTicket(UserInfoBean userBean, LottoPurchaseBean lottoPurchaseBean)
			throws Exception {
<span class="fc" id="L6895">		Connection connection = null;</span>
		try {
<span class="pc bpc" id="L6897" title="1 of 4 branches missed.">			if (!checkDrawAvailabilityLotto(lottoPurchaseBean) || !validateZimLottoBonusData(lottoPurchaseBean)) {</span>
<span class="fc" id="L6898">				return lottoPurchaseBean;</span>
			}
<span class="fc" id="L6900">			lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
<span class="fc" id="L6901">			connection = getConnectionObject();</span>
<span class="fc" id="L6902">			calculateNoOfLines(lottoPurchaseBean);</span>
<span class="pc bpc" id="L6903" title="1 of 2 branches missed.">			if (calculateNoOfLines(lottoPurchaseBean) == -1) {</span>
<span class="nc" id="L6904">				return lottoPurchaseBean;</span>
			}
<span class="fc" id="L6906">			lottoPurchaseBean</span>
					.setUnitPrice(Util.getUnitPrice(lottoPurchaseBean.getGameId(), lottoPurchaseBean.getPlayType()));
<span class="fc" id="L6908">			totalPurchaseAmount = calculateTotalPurchaseAmount(lottoPurchaseBean);</span>
<span class="fc" id="L6909">			logger.debug(&quot;Inside  FE1*******&quot;);</span>
			// Responsible Gaming calling
<span class="fc" id="L6911">			boolean isFraud = ResponsibleGaming.respGaming(userBean, &quot;DG_SALE&quot;, totalPurchaseAmount + &quot;&quot;, connection);</span>
<span class="fc bfc" id="L6912" title="All 2 branches covered.">			if (isFraud) {</span>
<span class="fc" id="L6913">				logger.debug(&quot;Responsing Gaming not allowed to sale&quot;);</span>
<span class="fc" id="L6914">				lottoPurchaseBean.setSaleStatus(&quot;FRAUD&quot;);</span>
<span class="fc" id="L6915">				return lottoPurchaseBean;</span>
			}
<span class="fc bfc" id="L6917" title="All 2 branches covered.">			if (!getSaleBalanceDeduction(userBean, lottoPurchaseBean, connection)) {</span>
<span class="fc" id="L6918">				return lottoPurchaseBean;</span>
			}
<span class="nc" id="L6920">		} catch (SQLException se) {</span>
<span class="nc" id="L6921">			se.printStackTrace();</span>
<span class="nc" id="L6922">			throw new LMSException();</span>
<span class="fc" id="L6923">		} catch (Exception e) {</span>
<span class="fc" id="L6924">			e.printStackTrace();</span>
<span class="fc" id="L6925">			throw new LMSException();</span>
		} finally {
<span class="pc" id="L6927">			DBConnect.closeCon(connection);</span>
<span class="fc" id="L6928">		}</span>

		try {
<span class="fc" id="L6931">			String responseString = prepareZimLottoBonusServiceResponse(lottoPurchaseBean);</span>
<span class="fc bfc" id="L6932" title="All 2 branches covered.">			if (serviceResponse.getIsSuccess()) {</span>
<span class="fc" id="L6933">				return processSuccessfulServiceResponse(userBean, responseString);</span>
			} else {
<span class="fc" id="L6935">				lottoPurchaseBean = new Gson().fromJson(responseString, new TypeToken&lt;LottoPurchaseBean&gt;() {</span>
				}.getType());
<span class="fc" id="L6937">				updateSaleStatusWhenServiceResponseIsFalse(userBean, lottoPurchaseBean);</span>
<span class="fc" id="L6938">				return lottoPurchaseBean;</span>
			}
<span class="nc" id="L6940">		} catch (SQLException se) {</span>
<span class="nc" id="L6941">			se.printStackTrace();</span>
<span class="fc" id="L6942">		} catch (Exception e) {</span>
<span class="fc" id="L6943">			e.printStackTrace();</span>
<span class="nc" id="L6944">		}</span>
<span class="fc" id="L6945">		return lottoPurchaseBean;</span>
	}

	/**
	 * 
	 * @param userBean
	 * @param responseString
	 * @return
	 * @throws SQLException
	 * @throws LMSException
	 * @throws Exception
	 */
	private LottoPurchaseBean processSuccessfulServiceResponse(UserInfoBean userBean, String responseString)
			throws SQLException, LMSException, Exception {
<span class="fc" id="L6959">		Connection serviceConnection = getConnectionObject();</span>
<span class="fc" id="L6960">		LottoPurchaseBean lottoPurchaseBean = new Gson().fromJson(responseString, new TypeToken&lt;LottoPurchaseBean&gt;() {</span>
		}.getType());
		try {
			// LottoPurchaseBean lottoPurchaseBean;
<span class="fc" id="L6964">			modifiedTotalPurchaseAmount = lottoPurchaseBean.getTotalPurchaseAmt();</span>
			// rounding
<span class="fc" id="L6966">			logger.debug(&quot;Total Purchase Amt inside DrawGameRPOSHelper After getting Success :&quot;</span>
					+ modifiedTotalPurchaseAmount);
<span class="pc bpc" id="L6968" title="1 of 2 branches missed.">			if (oldTotalPurchaseAmount != modifiedTotalPurchaseAmount) {</span>
<span class="nc" id="L6969">				updateSaleBalanceDeduction(userBean, lottoPurchaseBean, serviceConnection);</span>
			}
<span class="fc" id="L6971">			int ticketUpdate = orgOnLineSaleCreditUpdation.drawTicketSaleTicketUpdate(balanceDeduction,</span>
					lottoPurchaseBean.getTicket_no(), lottoPurchaseBean.getGameId(), userBean,
					lottoPurchaseBean.getPurchaseChannel(), serviceConnection);
<span class="pc bpc" id="L6974" title="1 of 2 branches missed.">			if (ticketUpdate == 1) {</span>
<span class="fc" id="L6975">				processSuccessfulTicketUpdate(userBean, lottoPurchaseBean, serviceConnection);</span>
			} else {
<span class="nc" id="L6977">				lottoPurchaseBean = cancelTicket(userBean, lottoPurchaseBean);</span>
<span class="nc" id="L6978">				return lottoPurchaseBean;</span>
			}
<span class="nc" id="L6980">		} catch (SQLException se) {</span>
<span class="nc" id="L6981">			se.printStackTrace();</span>
		} finally {
<span class="pc" id="L6983">			DBConnect.closeCon(serviceConnection);</span>
<span class="pc" id="L6984">		}</span>
<span class="fc" id="L6985">		return lottoPurchaseBean;</span>
	}

	/**
	 * 
	 * @param userBean
	 * @param lottoPurchaseBean
	 * @param connection2
	 * @throws SQLException
	 * @throws LMSException
	 * @throws Exception
	 */
	private void processSuccessfulTicketUpdate(UserInfoBean userBean, LottoPurchaseBean lottoPurchaseBean,
			Connection connection2) throws SQLException, LMSException, Exception {
<span class="fc" id="L6999">		ajaxHelper.getAvlblCreditAmt(userBean, connection2);</span>
<span class="fc" id="L7000">		status = &quot;SUCCESS&quot;;</span>
<span class="fc" id="L7001">		lottoPurchaseBean.setSaleStatus(status);</span>
<span class="fc" id="L7002">		lottoPurchaseBean.setAdvMsg(Util.getDGSaleAdvMessage(userBean.getUserOrgId(), lottoPurchaseBean.getGameId()));</span>
<span class="pc bpc" id="L7003" title="1 of 2 branches missed.">		if (!&quot;applet&quot;.equals(lottoPurchaseBean.getBarcodeType())) {</span>
<span class="fc" id="L7004">			IDBarcode.getBarcode(lottoPurchaseBean.getTicket_no() + lottoPurchaseBean.getReprintCount());</span>
		}
<span class="fc" id="L7006">		connection2.commit();</span>
		// call promo purchase process here
<span class="fc" id="L7008">		lottoPurchaseBean = promoPurchaseTicket(userBean, lottoPurchaseBean);</span>
<span class="fc" id="L7009">	}</span>

	/**
	 * 
	 * @param lottoPurchaseBean
	 * @return
	 */
	private boolean validateZimLottoBonusData(LottoPurchaseBean lottoPurchaseBean) {
<span class="fc bfc" id="L7017" title="All 2 branches covered.">		if (!DrawGameValidation.zimLottoBonusDataValidation(lottoPurchaseBean)) {</span>
<span class="fc" id="L7018">			logger.debug(&quot;Data validation returns false&quot;);</span>
<span class="fc" id="L7019">			lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
<span class="fc" id="L7020">			return false;</span>
		}
<span class="fc" id="L7022">		return true;</span>
	}

	/**
	 * 
	 * @param lottoPurchaseBean
	 * @return
	 */
	private boolean checkDrawAvailabilityLotto(LottoPurchaseBean lottoPurchaseBean) {
<span class="pc bpc" id="L7031" title="2 of 4 branches missed.">		if (isDrawAvailable(lottoPurchaseBean.getGameId()) || chkFreezeTimeSale(lottoPurchaseBean.getGameId())) {</span>
<span class="nc" id="L7032">			lottoPurchaseBean.setSaleStatus(&quot;NO_DRAWS&quot;);</span>
<span class="nc" id="L7033">			return false;</span>
		}
<span class="fc" id="L7035">		return true;</span>
	}

	/**
	 * 
	 * @param userBean
	 * @param lottoPurchaseBean
	 */
	private void updateSaleStatusWhenServiceResponseIsFalse(UserInfoBean userBean,
			LottoPurchaseBean lottoPurchaseBean) {
<span class="pc bpc" id="L7045" title="1 of 2 branches missed.">		if (lottoPurchaseBean.getSaleStatus() == null) {</span>
<span class="nc" id="L7046">			lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);// Error</span>
<span class="nc" id="L7047">			orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, lottoPurchaseBean.getGameId(), &quot;FAILED&quot;,</span>
					balanceDeduction);
<span class="pc bpc" id="L7049" title="1 of 2 branches missed.">		} else if (&quot;ERROR_TICKET_LIMIT&quot;.equalsIgnoreCase(lottoPurchaseBean.getSaleStatus())) {</span>
<span class="nc" id="L7050">			orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, lottoPurchaseBean.getGameId(), &quot;FAILED&quot;,</span>
					balanceDeduction);
		} else {
<span class="fc" id="L7053">			orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, lottoPurchaseBean.getGameId(), &quot;FAILED&quot;,</span>
					balanceDeduction);
		}
<span class="fc" id="L7056">	}</span>

	/**
	 * 
	 * @param userBean
	 * @param lottoPurchaseBean
	 * @return
	 * @throws LMSException
	 */
	private LottoPurchaseBean cancelTicket(UserInfoBean userBean, LottoPurchaseBean lottoPurchaseBean)
			throws LMSException {
<span class="fc" id="L7067">		status = &quot;FAILED&quot;;</span>
<span class="fc" id="L7068">		lottoPurchaseBean.setSaleStatus(status);</span>
		// Code for cancelling the Ticket to be send to Draw Game Engine
<span class="nc" id="L7070">		cancelTicket(lottoPurchaseBean.getTicket_no(), lottoPurchaseBean.getPurchaseChannel(),</span>
				lottoPurchaseBean.getDrawIdTableMap(), lottoPurchaseBean.getGame_no(), lottoPurchaseBean.getPartyId(),
				lottoPurchaseBean.getPartyType(), lottoPurchaseBean.getRefMerchantId(), userBean,
				lottoPurchaseBean.getRefTransId());

<span class="nc" id="L7075">		return lottoPurchaseBean;</span>
	}

	/**
	 * 
	 * @param userBean
	 * @param lottoPurchaseBean
	 * @param connection
	 */
	private void updateSaleBalanceDeduction(UserInfoBean userBean, LottoPurchaseBean lottoPurchaseBean,
			Connection connection) {
<span class="nc" id="L7086">		lottoPurchaseBean.setRefTransId(balanceDeduction + &quot;&quot;);</span>
<span class="nc" id="L7087">		lottoPurchaseBean.setTotalPurchaseAmt(modifiedTotalPurchaseAmount);</span>
<span class="nc" id="L7088">		balanceDeduction = orgOnLineSaleCreditUpdation.drawTcketSaleBalDedUpdate(userBean,</span>
				lottoPurchaseBean.getGameId(), modifiedTotalPurchaseAmount, oldTotalPurchaseAmount, balanceDeduction,
				connection);
<span class="nc" id="L7091">	}</span>

	/**
	 * 
	 * @return
	 * @throws SQLException
	 */
	private static Connection getConnectionObject() throws SQLException {
		Connection connection;
<span class="fc" id="L7100">		connection = DBConnect.getConnection();</span>
<span class="fc" id="L7101">		connection.setAutoCommit(false);</span>
<span class="fc" id="L7102">		return connection;</span>
	}

	/**
	 * 
	 * @param lottoPurchaseBean
	 * @return
	 */
	private String prepareZimLottoBonusServiceResponse(LottoPurchaseBean lottoPurchaseBean) {
<span class="fc" id="L7111">		serviceRequest.setServiceName(ServiceName.ZIMLOTTOBONUS_MGMT);</span>
<span class="fc" id="L7112">		serviceRequest.setServiceMethod(ServiceMethodName.ZIMLOTTOBONUS_PURCHASE_TICKET);</span>
<span class="fc" id="L7113">		serviceRequest.setServiceData(lottoPurchaseBean);</span>
<span class="fc" id="L7114">		serviceResponse = delegate.getResponse(serviceRequest);</span>
<span class="fc" id="L7115">		String responseString = serviceResponse.getResponseData().toString();</span>
<span class="fc" id="L7116">		return responseString;</span>
	}

	/**
	 * 
	 * @param userBean
	 * @param lottoPurchaseBean
	 * @param connection
	 * @return
	 * @throws SQLException
	 */
	private boolean getSaleBalanceDeduction(UserInfoBean userBean, LottoPurchaseBean lottoPurchaseBean,
			Connection connection) throws SQLException {

<span class="fc" id="L7130">		balanceDeduction = orgOnLineSaleCreditUpdation.drawTcketSaleBalDeduction(userBean,</span>
				lottoPurchaseBean.getGameId(), lottoPurchaseBean.getTotalPurchaseAmt(),
				lottoPurchaseBean.getPlrMobileNumber(), connection);
<span class="fc" id="L7133">		oldTotalPurchaseAmount = lottoPurchaseBean.getTotalPurchaseAmt();</span>

<span class="fc" id="L7135">		logger.debug(</span>
				&quot;Total Purchase Amt inside DrawGameRPOSHelper Just Before  getting Success :&quot; + oldTotalPurchaseAmount);

<span class="fc bfc" id="L7138" title="All 2 branches covered.">		if (balanceDeduction &gt; 0) {</span>
<span class="fc" id="L7139">			logger.debug(&quot;in keno if----------------&quot;);</span>
<span class="fc" id="L7140">			lottoPurchaseBean.setRefTransId(balanceDeduction + &quot;&quot;);</span>
<span class="fc" id="L7141">			connection.commit();</span>
		} else {
<span class="fc bfc" id="L7143" title="All 2 branches covered.">			if (balanceDeduction == -1) {</span>
<span class="fc" id="L7144">				status = &quot;AGT_INS_BAL&quot;;// Agent has insufficient Balance</span>
<span class="fc bfc" id="L7145" title="All 2 branches covered.">			} else if (balanceDeduction == -2) {</span>
<span class="fc" id="L7146">				status = &quot;FAILED&quot;;// Error LMS</span>
<span class="pc bpc" id="L7147" title="1 of 2 branches missed.">			} else if (balanceDeduction == 0) {</span>
<span class="fc" id="L7148">				status = &quot;RET_INS_BAL&quot;;// Retailer has insufficient Balance</span>
			}
<span class="fc" id="L7150">			lottoPurchaseBean.setSaleStatus(status);</span>
<span class="fc" id="L7151">			return false;</span>
		}
<span class="fc" id="L7153">		return true;</span>
	}

	/**
	 * 
	 * @param lottoPurchaseBean
	 * @return
	 */
	private double calculateTotalPurchaseAmount(LottoPurchaseBean lottoPurchaseBean) {
<span class="fc" id="L7162">		double totalPurchaseAmount = 0.0;</span>
<span class="fc" id="L7163">		double unitPrice = lottoPurchaseBean.getUnitPrice();</span>
<span class="fc" id="L7164">		int noOfLines = lottoPurchaseBean.getNoOfLines();</span>
<span class="pc bpc" id="L7165" title="1 of 2 branches missed.">		if (&quot;LMS_WEB&quot;.equalsIgnoreCase(lottoPurchaseBean.getPurchaseChannel())) {</span>
<span class="fc" id="L7166">			totalPurchaseAmount = noOfLines * unitPrice * lottoPurchaseBean.getNoOfDraws()</span>
					* lottoPurchaseBean.getBetAmtMultiple();
		} else {
<span class="nc" id="L7169">			totalPurchaseAmount = noOfLines * unitPrice * lottoPurchaseBean.getNoOfDraws();</span>
		}
<span class="fc" id="L7171">		totalPurchaseAmount = CommonMethods.fmtToTwoDecimal(totalPurchaseAmount);</span>

<span class="fc" id="L7173">		logger.debug(&quot;Total Purchase Amount - &quot; + totalPurchaseAmount);</span>

<span class="fc" id="L7175">		lottoPurchaseBean.setTotalPurchaseAmt(totalPurchaseAmount);</span>
<span class="fc" id="L7176">		return totalPurchaseAmount;</span>
	}

	/**
	 * 
	 * @param lottoPurchaseBean
	 * @return
	 */
	private int calculateNoOfLines(LottoPurchaseBean lottoPurchaseBean) {
<span class="fc" id="L7185">		int noOfLines = lottoPurchaseBean.getPicknumbers().length;</span>
<span class="fc bfc" id="L7186" title="All 2 branches covered.">		if (&quot;Perm6&quot;.equals(lottoPurchaseBean.getPlayType())) {</span>
<span class="fc" id="L7187">			int n = lottoPurchaseBean.getNoPicked();</span>
<span class="pc bpc" id="L7188" title="1 of 2 branches missed.">			if (n &lt; 7) {</span>
<span class="nc" id="L7189">				lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L7190">				return -1;</span>
			}
<span class="fc" id="L7192">			noOfLines = (n * (n - 1) * (n - 2) * (n - 3) * (n - 4) * (n - 5)) / 720;</span>
		}
<span class="fc" id="L7194">		lottoPurchaseBean.setNoOfLines(noOfLines);</span>
<span class="fc" id="L7195">		return noOfLines;</span>
	}

	/**
	 * 
	 * @param userBean
	 * @param lottoPurchaseBean
	 * @return
	 * @throws LMSException
	 * @throws SQLException
	 * @throws Exception
	 */
	private LottoPurchaseBean promoPurchaseTicket(UserInfoBean userBean, LottoPurchaseBean lottoPurchaseBean)
			throws LMSException, SQLException, Exception {
		String status;
<span class="fc" id="L7210">		List&lt;RafflePurchaseBean&gt; rafflePurchaseBeanList = new ArrayList&lt;RafflePurchaseBean&gt;();</span>
<span class="fc" id="L7211">		List&lt;PromoGameBean&gt; promoGameslist = Util.promoGameBeanMap.get(lottoPurchaseBean.getGameId());</span>

<span class="fc" id="L7213">		boolean isLoopAgain = true;</span>
<span class="pc bpc" id="L7214" title="1 of 2 branches missed.">		for (int i = 0; i &lt; promoGameslist.size(); i++) {</span>
<span class="nc" id="L7215">			PromoGameBean promobean = promoGameslist.get(i);</span>
<span class="nc" id="L7216">			List&lt;LottoPurchaseBean&gt; lottoBeanList = new ArrayList&lt;LottoPurchaseBean&gt;();</span>
<span class="nc bnc" id="L7217" title="All 2 branches missed.">			for (int k = 0; k &lt; promobean.getNoOfPromoTickets(); k++) {</span>
<span class="nc bnc" id="L7218" title="All 2 branches missed.">				if (promobean.getPromoGametype().equalsIgnoreCase(&quot;RAFFLE&quot;)) {</span>
<span class="nc" id="L7219">					lottoPurchaseBean.setRaffleNo(promobean.getPromoGameNo());</span>
<span class="nc" id="L7220">					RafflePurchaseBean rafflePurchaseBean = (RafflePurchaseBean) rafflePurchaseTicket(userBean,</span>
							lottoPurchaseBean, true);
<span class="nc" id="L7222">					rafflePurchaseBean.setRaffleTicketType(promobean.getPromoTicketType());</span>
<span class="nc bnc" id="L7223" title="All 2 branches missed.">					if (rafflePurchaseBean.getSaleStatus().equalsIgnoreCase(&quot;FAILED&quot;)) {</span>
<span class="nc" id="L7224">						status = &quot;FAILED&quot;;</span>
<span class="nc" id="L7225">						lottoPurchaseBean.setSaleStatus(status);</span>
						// Code for cancelling the Ticket to
						// be send to Draw Game Engine
<span class="nc" id="L7228">						cancelTicket(lottoPurchaseBean.getTicket_no() + lottoPurchaseBean.getReprintCount(),</span>
								lottoPurchaseBean.getPurchaseChannel(), lottoPurchaseBean.getDrawIdTableMap(),
								lottoPurchaseBean.getGame_no(), lottoPurchaseBean.getPartyId(),
								lottoPurchaseBean.getPartyType(), lottoPurchaseBean.getRefMerchantId(), userBean,
								lottoPurchaseBean.getRefTransId());
<span class="nc" id="L7233">						lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L7234">						return lottoPurchaseBean;</span>
<span class="nc bnc" id="L7235" title="All 2 branches missed.">					} else if (rafflePurchaseBean.getSaleStatus().equalsIgnoreCase(&quot;SUCCESS&quot;)) {</span>
						// here insert entry into the promo
						// ticket mapping table
<span class="nc" id="L7238">						int tktlen = rafflePurchaseBean.getRaffleTicket_no().length();</span>
<span class="nc" id="L7239">						orgOnLineSaleCreditUpdation.drawTicketNPromoMappigUpdate(1, rafflePurchaseBean.getGame_no(),</span>
								rafflePurchaseBean.getParentTktNo(),
								rafflePurchaseBean.getRaffleTicket_no().substring(0, tktlen - 2));
<span class="nc" id="L7242">						rafflePurchaseBeanList.add(rafflePurchaseBean);</span>
					}
<span class="nc bnc" id="L7244" title="All 2 branches missed.">				} else if (promobean.getPromoGameName().equalsIgnoreCase(&quot;Zimlottobonusfree&quot;)) {</span>
					// call winfast purchase process

<span class="nc bnc" id="L7247" title="All 2 branches missed.">					if (isLoopAgain) {</span>
<span class="nc" id="L7248">						int gameNo = promobean.getPromoGameNo();</span>
<span class="nc" id="L7249">						int gameId = Util.getGameIdFromGameNumber(gameNo);</span>
<span class="nc" id="L7250">						LottoPurchaseBean drawGamePurchaseBean = new LottoPurchaseBean();</span>
						// drawGamePurchaseBean.setIsQP(1);
						// drawGamePurchaseBean.setTotalNoOfPanels(1);
						// drawGamePurchaseBean.setSymbols(symbols);
						// drawGamePurchaseBean.setNoOfPanels(&quot;1&quot;);
						// drawGamePurchaseBean.setBetAmountMultiple(betAmountMultiple);
<span class="nc" id="L7256">						drawGamePurchaseBean.setDrawIdTableMap(lottoPurchaseBean.getDrawIdTableMap());</span>
<span class="nc" id="L7257">						drawGamePurchaseBean.setGame_no(gameNo);</span>
<span class="nc" id="L7258">						drawGamePurchaseBean.setGameId(gameId);</span>
<span class="nc" id="L7259">						drawGamePurchaseBean.setGameDispName(Util.getGameDisplayName(gameNo));</span>
						// drawGamePurchaseBean.setIsQuickPick(isQuickPickNew);
<span class="nc" id="L7261">						drawGamePurchaseBean.setNoOfDraws(promobean.getNoOfDraws());</span>
<span class="nc" id="L7262">						drawGamePurchaseBean.setPartyId(userBean.getUserOrgId());</span>
<span class="nc" id="L7263">						drawGamePurchaseBean.setPartyType(userBean.getUserType());</span>
<span class="nc" id="L7264">						drawGamePurchaseBean.setUserId(userBean.getUserId());</span>
<span class="nc" id="L7265">						drawGamePurchaseBean.setRefMerchantId(lottoPurchaseBean.getRefMerchantId());</span>
<span class="nc" id="L7266">						drawGamePurchaseBean.setPurchaseChannel(lottoPurchaseBean.getPurchaseChannel());</span>
<span class="nc" id="L7267">						drawGamePurchaseBean.setPromotkt(true);</span>
<span class="nc" id="L7268">						drawGamePurchaseBean.setNoPicked(lottoPurchaseBean.getNoPicked());</span>
<span class="nc" id="L7269">						drawGamePurchaseBean.setServiceId(lottoPurchaseBean.getServiceId());</span>
<span class="nc" id="L7270">						drawGamePurchaseBean.setUserMappingId(lottoPurchaseBean.getUserMappingId());</span>
<span class="nc" id="L7271">						drawGamePurchaseBean.setPlrMobileNumber(lottoPurchaseBean.getPlrMobileNumber());</span>
<span class="nc" id="L7272">						StringBuilder sb = new StringBuilder(&quot;QP&quot;);</span>
<span class="nc bnc" id="L7273" title="All 2 branches missed.">						if (&quot;Direct6&quot;.equalsIgnoreCase(lottoPurchaseBean.getPlayType())) {</span>
<span class="nc bnc" id="L7274" title="All 2 branches missed.">							for (int m = 1; m &lt; lottoPurchaseBean.getNoOfLines()</span>
<span class="nc" id="L7275">									* promobean.getNoOfPromoTickets(); m++) {</span>
<span class="nc" id="L7276">								sb.append(&quot;NxtQP&quot;);</span>
							}
<span class="nc bnc" id="L7278" title="All 2 branches missed.">						} else if (&quot;Perm6&quot;.equalsIgnoreCase(lottoPurchaseBean.getPlayType())) {</span>
<span class="nc bnc" id="L7279" title="All 2 branches missed.">							for (int m = 1; m &lt; promobean.getNoOfPromoTickets(); m++) {</span>
<span class="nc" id="L7280">								sb.append(&quot;NxtQP&quot;);</span>
							}
						}
<span class="nc" id="L7283">						String pickedNumbers = sb.toString();</span>
<span class="nc" id="L7284">						String[] picknumbers = pickedNumbers.split(&quot;Nxt&quot;);</span>
<span class="nc" id="L7285">						drawGamePurchaseBean.setPickedNumbers(pickedNumbers);</span>
<span class="nc" id="L7286">						drawGamePurchaseBean.setPicknumbers(picknumbers);</span>

<span class="nc" id="L7288">						drawGamePurchaseBean.setPlayType(lottoPurchaseBean.getPlayType());</span>
						// if (drawIdArr != null) {
						// drawGamePurchaseBean.setDrawDateTime(Arrays.asList(drawIdArr));
						// }
<span class="nc" id="L7292">						drawGamePurchaseBean.setIsAdvancedPlay(0);</span>
<span class="nc" id="L7293">						LottoPurchaseBean lottoBean = ZimLottoBonusFreeHelper.zimLottoBonusFreePurchaseTicket(userBean,</span>
								drawGamePurchaseBean);
<span class="nc bnc" id="L7295" title="All 2 branches missed.">						if (&quot;SUCCESS&quot;.equalsIgnoreCase(lottoBean.getSaleStatus())) {</span>
<span class="nc" id="L7296">							orgOnLineSaleCreditUpdation.drawTicketNPromoMappigUpdate(1, lottoPurchaseBean.getGame_no(),</span>
									lottoPurchaseBean.getTicket_no(), lottoBean.getTicket_no());
						} else {
<span class="nc" id="L7299">							lottoPurchaseBean.setPromoSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L7300">							return lottoPurchaseBean;</span>
						}

<span class="nc" id="L7303">						lottoBeanList.add(lottoBean);</span>
<span class="nc" id="L7304">						logger.debug(&quot;Promo Bean Data for zim lotto Three&quot; + lottoBean);</span>
						// kenoPurchaseBean.setFortunePurchaseBean(fortuneBean);
<span class="nc" id="L7306">						lottoPurchaseBean.setPromoPurchaseBeanList(lottoBeanList);</span>
<span class="nc" id="L7307">						isLoopAgain = false;</span>

					}
<span class="nc bnc" id="L7310" title="All 2 branches missed.">					if (&quot;Direct6&quot;.equalsIgnoreCase(lottoPurchaseBean.getPlayType()))</span>
<span class="nc" id="L7311">						isLoopAgain = false;</span>
				}
			}
		}

<span class="fc" id="L7316">		lottoPurchaseBean.setRafflePurchaseBeanList(rafflePurchaseBeanList);</span>

<span class="fc" id="L7318">		return lottoPurchaseBean;</span>
	}

	public LottoPurchaseBean zimLottoBonusTwoPurchaseTicket(UserInfoBean userBean, LottoPurchaseBean lottoPurchaseBean)
			throws Exception {

		// ServiceResponse sRes = new ServiceResponse();
<span class="nc" id="L7325">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L7326">		sReq.setServiceName(ServiceName.ZIMLOTTOBONUSTWO_MGMT);</span>
<span class="nc" id="L7327">		sReq.setServiceMethod(ServiceMethodName.ZIMLOTTOBONUSTWO_PURCHASE_TICKET);</span>
		// sReq.setServiceData(lottoPurchaseBean);
<span class="nc" id="L7329">		LottoRequestBean requestBean = new LottoRequestBean();</span>
<span class="nc" id="L7330">		sReq.setServiceData(requestBean);</span>
<span class="nc" id="L7331">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L7332">		double dgeTicketPrice = 0.0;</span>
<span class="nc" id="L7333">		double lmsTicketPrice = 0.0;</span>
<span class="nc" id="L7334">		String status = &quot;&quot;;</span>
<span class="nc" id="L7335">		long balDed = 0;</span>
<span class="nc" id="L7336">		Connection con = null;</span>

		try {

<span class="nc" id="L7340">			lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L7341">			int noOfLines = lottoPurchaseBean.getPicknumbers().length;</span>
<span class="nc" id="L7342">			con = getConnectionObject();</span>

<span class="nc bnc" id="L7344" title="All 2 branches missed.">			if (&quot;TERMINAL&quot;.equals(lottoPurchaseBean.getDeviceType())) {</span>
<span class="nc" id="L7345">				int autoCancelHoldDays = Integer.parseInt(Utility.getPropertyValue(&quot;AUTO_CANCEL_CLOSER_DAYS&quot;));</span>
<span class="nc" id="L7346">				checkLastPrintedTicketStatusAndUpdate(userBean, Long.parseLong(lottoPurchaseBean.getLastSoldTicketNo()),</span>
						lottoPurchaseBean.getDeviceType(), lottoPurchaseBean.getRefMerchantId(), autoCancelHoldDays,
						lottoPurchaseBean.getActionName(), lottoPurchaseBean.getLastGameId(), con);
			}

<span class="nc bnc" id="L7351" title="All 2 branches missed.">			if (&quot;Perm6&quot;.equals(lottoPurchaseBean.getPlayType())) {</span>
<span class="nc" id="L7352">				int n = lottoPurchaseBean.getNoPicked();</span>
<span class="nc bnc" id="L7353" title="All 2 branches missed.">				if (n &lt; 7) {</span>
<span class="nc" id="L7354">					lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L7355">					return lottoPurchaseBean;</span>
				}
<span class="nc" id="L7357">				noOfLines = (n * (n - 1) * (n - 2) * (n - 3) * (n - 4) * (n - 5)) / 720;</span>
			}
<span class="nc" id="L7359">			lottoPurchaseBean.setNoOfLines(noOfLines);</span>
<span class="nc" id="L7360">			double unitPrice = Util.getUnitPrice(lottoPurchaseBean.getGameId(), lottoPurchaseBean.getPlayType());</span>
<span class="nc" id="L7361">			lottoPurchaseBean.setUnitPrice(unitPrice);</span>
<span class="nc" id="L7362">			dgeTicketPrice = noOfLines * unitPrice * lottoPurchaseBean.getNoOfDraws();</span>
			// rouding
<span class="nc" id="L7364">			lmsTicketPrice = CommonMethods.roundDrawTktAmt(dgeTicketPrice);</span>

<span class="nc" id="L7366">			lmsTicketPrice = CommonMethods.fmtToTwoDecimal(lmsTicketPrice);</span>

<span class="nc" id="L7368">			logger.debug(&quot;Dge Purchase Amount - &quot; + dgeTicketPrice);</span>
<span class="nc" id="L7369">			logger.debug(&quot;LMS Purchase Amount - &quot; + lmsTicketPrice);</span>

<span class="nc" id="L7371">			lottoPurchaseBean.setTotalPurchaseAmt(dgeTicketPrice);</span>

<span class="nc" id="L7373">			logger.debug(&quot;Inside  FE1*******&quot;);</span>
			// rg calling
<span class="nc" id="L7375">			boolean isFraud = ResponsibleGaming.respGaming(userBean, &quot;DG_SALE&quot;, lmsTicketPrice + &quot;&quot;, con);</span>
<span class="nc bnc" id="L7376" title="All 2 branches missed.">			if (!isFraud) {</span>
<span class="nc" id="L7377">				balDed = orgOnLineSaleCreditUpdation.drawTcketSaleBalDeduction(userBean, lottoPurchaseBean.getGameId(),</span>
						lmsTicketPrice, lottoPurchaseBean.getPlrMobileNumber(), con);

<span class="nc" id="L7380">				logger.debug(</span>
						&quot;Total Purchase Amt inside DrawGameRPOSHelper Just Before  getting Success :&quot; + lmsTicketPrice);

<span class="nc bnc" id="L7383" title="All 2 branches missed.">				if (balDed &gt; 0) {</span>
<span class="nc" id="L7384">					logger.debug(&quot;in keno if----------------&quot;);</span>
<span class="nc" id="L7385">					lottoPurchaseBean.setRefTransId(balDed + &quot;&quot;);</span>
<span class="nc" id="L7386">					con.commit();</span>
				} else {
<span class="nc" id="L7388">					status = getStatusIfErrorInTransaction(status, balDed);</span>
<span class="nc" id="L7389">					lottoPurchaseBean.setSaleStatus(status);</span>
<span class="nc" id="L7390">					return lottoPurchaseBean;</span>
				}
			} else {
<span class="nc" id="L7393">				logger.debug(&quot;Responsing Gaming not allowed to sale&quot;);</span>
<span class="nc" id="L7394">				lottoPurchaseBean.setSaleStatus(&quot;FRAUD&quot;);</span>
<span class="nc" id="L7395">				return lottoPurchaseBean;</span>
			}

<span class="nc" id="L7398">		} catch (SQLException se) {</span>
<span class="nc" id="L7399">			se.printStackTrace();</span>
<span class="nc" id="L7400">			throw new LMSException();</span>
<span class="nc" id="L7401">		} catch (Exception e) {</span>
<span class="nc" id="L7402">			e.printStackTrace();</span>
<span class="nc" id="L7403">			throw new LMSException();</span>
		} finally {
<span class="nc" id="L7405">			DBConnect.closeCon(con);</span>
<span class="nc" id="L7406">		}</span>

		try {
<span class="nc" id="L7409">			lottoPurchaseBean.setRefTransId(balDed + &quot;&quot;);</span>
<span class="nc" id="L7410">			requestBean.setDrawIdTableMap(lottoPurchaseBean.getDrawIdTableMap());</span>
<span class="nc" id="L7411">			requestBean.setDrawDateTime(lottoPurchaseBean.getDrawDateTime());</span>
<span class="nc" id="L7412">			requestBean.setGame_no(lottoPurchaseBean.getGame_no());</span>
<span class="nc" id="L7413">			requestBean.setGameId(lottoPurchaseBean.getGameId());</span>
<span class="nc" id="L7414">			requestBean.setIsAdvancedPlay(lottoPurchaseBean.getIsAdvancedPlay());</span>
<span class="nc" id="L7415">			requestBean.setNoOfDraws(lottoPurchaseBean.getNoOfDraws());</span>
<span class="nc" id="L7416">			requestBean.setNoPicked(lottoPurchaseBean.getNoPicked());</span>
<span class="nc" id="L7417">			requestBean.setPartyId(lottoPurchaseBean.getPartyId());</span>
<span class="nc" id="L7418">			requestBean.setPartyType(lottoPurchaseBean.getPartyType());</span>
<span class="nc" id="L7419">			requestBean.setPlayerData(lottoPurchaseBean.getPickedNumbers());</span>
<span class="nc" id="L7420">			requestBean.setPickedNumbers(lottoPurchaseBean.getPickedNumbers());</span>
<span class="nc" id="L7421">			requestBean.setPlayType(lottoPurchaseBean.getPlayType());</span>
<span class="nc" id="L7422">			requestBean.setPurchaseChannel(lottoPurchaseBean.getPurchaseChannel());</span>
<span class="nc" id="L7423">			requestBean.setRefMerchantId(lottoPurchaseBean.getRefMerchantId());</span>
<span class="nc" id="L7424">			requestBean.setRefTransId(lottoPurchaseBean.getRefTransId());</span>
<span class="nc" id="L7425">			requestBean.setUserId(lottoPurchaseBean.getUserId());</span>
<span class="nc" id="L7426">			requestBean.setUserMappingId(lottoPurchaseBean.getUserMappingId());</span>
<span class="nc" id="L7427">			requestBean.setServiceId(lottoPurchaseBean.getServiceId());</span>
<span class="nc" id="L7428">			requestBean.setPicknumbers(lottoPurchaseBean.getPicknumbers());</span>
<span class="nc" id="L7429">			requestBean.setPromotkt(lottoPurchaseBean.isPromotkt());</span>
<span class="nc" id="L7430">			requestBean.setUnitPrice(lottoPurchaseBean.getUnitPrice());</span>
<span class="nc" id="L7431">			requestBean.setTotalPurchaseAmt(lottoPurchaseBean.getTotalPurchaseAmt());</span>

<span class="nc" id="L7433">			String responseString = delegate.getResponseString(sReq);</span>
<span class="nc" id="L7434">			LottoResponseBean responseBean = new Gson().fromJson(responseString, LottoResponseBean.class);</span>

<span class="nc bnc" id="L7436" title="All 2 branches missed.">			if (responseBean.getIsSuccess()) {</span>
<span class="nc" id="L7437">				lottoPurchaseBean.setSaleStatus(responseBean.getSaleStatus());</span>
<span class="nc" id="L7438">				lottoPurchaseBean.setTicket_no(responseBean.getTicketNo());</span>
<span class="nc" id="L7439">				lottoPurchaseBean.setBarcodeCount(responseBean.getBarcodeCount());</span>
<span class="nc" id="L7440">				lottoPurchaseBean.setNoOfDraws(responseBean.getNoOfDraws());</span>
<span class="nc" id="L7441">				lottoPurchaseBean.setPurchaseTime(responseBean.getPurchaseTime());</span>
<span class="nc" id="L7442">				lottoPurchaseBean.setReprintCount(responseBean.getReprintCount());</span>
<span class="nc" id="L7443">				lottoPurchaseBean.setPlayerPicked(responseBean.getPlayerPicked());</span>
<span class="nc" id="L7444">				lottoPurchaseBean.setTotalPurchaseAmt(responseBean.getTotalPurchaseAmt());</span>
<span class="nc" id="L7445">				lottoPurchaseBean.setDrawDateTime(responseBean.getDrawDateTime());</span>
<span class="nc" id="L7446">				lottoPurchaseBean.setIsQuickPick(responseBean.getIsQuickPick());</span>
<span class="nc" id="L7447">				lottoPurchaseBean.setPanel_id(responseBean.getPanel_id());</span>
				// lottoPurchaseBean = new Gson().fromJson(responseString,
				// elementType);
<span class="nc" id="L7450">				double fromDgeTicketPrice = lottoPurchaseBean.getTotalPurchaseAmt();</span>

				// rouding

<span class="nc" id="L7454">				lottoPurchaseBean.setTotalPurchaseAmt(lmsTicketPrice);</span>

<span class="nc" id="L7456">				logger.debug(</span>
						&quot;Total Purchase Amt inside DrawGameRPOSHelper After getting Success :&quot; + fromDgeTicketPrice);
<span class="nc" id="L7458">				con = getConnectionObject();</span>
<span class="nc bnc" id="L7459" title="All 2 branches missed.">				if (fromDgeTicketPrice != dgeTicketPrice) {</span>
<span class="nc" id="L7460">					fromDgeTicketPrice = CommonMethods.roundDrawTktAmt(fromDgeTicketPrice);</span>
<span class="nc" id="L7461">					lottoPurchaseBean.setTotalPurchaseAmt(fromDgeTicketPrice);</span>
<span class="nc" id="L7462">					balDed = orgOnLineSaleCreditUpdation.drawTcketSaleBalDedUpdate(userBean,</span>
							lottoPurchaseBean.getGameId(), fromDgeTicketPrice, lmsTicketPrice, balDed, con);

				}
<span class="nc" id="L7466">				int tickUpd = orgOnLineSaleCreditUpdation.drawTicketSaleTicketUpdate(balDed,</span>
						lottoPurchaseBean.getTicket_no(), lottoPurchaseBean.getGameId(), userBean,
						lottoPurchaseBean.getPurchaseChannel(), con);

<span class="nc bnc" id="L7470" title="All 2 branches missed.">				if (tickUpd == 1) {</span>
<span class="nc" id="L7471">					AjaxRequestHelper ajxHelper = new AjaxRequestHelper();</span>
<span class="nc" id="L7472">					ajxHelper.getAvlblCreditAmt(userBean, con);</span>
<span class="nc" id="L7473">					status = &quot;SUCCESS&quot;;</span>
<span class="nc" id="L7474">					lottoPurchaseBean.setSaleStatus(status);</span>
<span class="nc" id="L7475">					lottoPurchaseBean.setAdvMsg(</span>
							Util.getDGSaleAdvMessage(userBean.getUserOrgId(), lottoPurchaseBean.getGameId()));

<span class="nc bnc" id="L7478" title="All 2 branches missed.">					if (!&quot;applet&quot;.equals(lottoPurchaseBean.getBarcodeType())) {</span>
<span class="nc" id="L7479">						IDBarcode.getBarcode(lottoPurchaseBean.getTicket_no() + lottoPurchaseBean.getReprintCount());</span>
					}
<span class="nc" id="L7481">					con.commit();</span>
					// call promo purchase process here
<span class="nc" id="L7483">					List&lt;RafflePurchaseBean&gt; rafflePurchaseBeanList = new ArrayList&lt;RafflePurchaseBean&gt;();</span>
					// CommonFunctionsHelper commonHelper = new
					// CommonFunctionsHelper();

<span class="nc" id="L7487">					List&lt;PromoGameBean&gt; promoGameslist = Util.promoGameBeanMap.get(lottoPurchaseBean.getGameId());</span>
					// String gameType =
					// getGameType(fortunePurchaseBean.getGame_no());
					// List&lt;PromoGameBean&gt; promoGameslist =
					// commonHelper.getAvailablePromoGames(gameType);
<span class="nc" id="L7492">					boolean isLoopAgain = true;</span>
<span class="nc bnc" id="L7493" title="All 2 branches missed.">					for (int i = 0; i &lt; promoGameslist.size(); i++) {</span>
<span class="nc" id="L7494">						PromoGameBean promobean = promoGameslist.get(i);</span>
<span class="nc" id="L7495">						List&lt;LottoPurchaseBean&gt; lottoBeanList = new ArrayList&lt;LottoPurchaseBean&gt;();</span>
<span class="nc bnc" id="L7496" title="All 2 branches missed.">						for (int k = 0; k &lt; promobean.getNoOfPromoTickets(); k++) {</span>
<span class="nc bnc" id="L7497" title="All 2 branches missed.">							if (promobean.getPromoGametype().equalsIgnoreCase(&quot;RAFFLE&quot;)) {</span>
<span class="nc" id="L7498">								lottoPurchaseBean.setRaffleNo(promobean.getPromoGameNo());</span>
<span class="nc" id="L7499">								RafflePurchaseBean rafflePurchaseBean = (RafflePurchaseBean) rafflePurchaseTicket(</span>
										userBean, lottoPurchaseBean, true);
<span class="nc" id="L7501">								rafflePurchaseBean.setRaffleTicketType(promobean.getPromoTicketType());</span>
<span class="nc bnc" id="L7502" title="All 2 branches missed.">								if (rafflePurchaseBean.getSaleStatus().equalsIgnoreCase(&quot;FAILED&quot;)) {</span>
<span class="nc" id="L7503">									status = &quot;FAILED&quot;;</span>
<span class="nc" id="L7504">									lottoPurchaseBean.setSaleStatus(status);</span>
									// Code for cancelling the Ticket to
									// be send to Draw Game Engine
<span class="nc" id="L7507">									cancelTicket(lottoPurchaseBean.getTicket_no() + lottoPurchaseBean.getReprintCount(),</span>
											lottoPurchaseBean.getPurchaseChannel(),
											lottoPurchaseBean.getDrawIdTableMap(), lottoPurchaseBean.getGame_no(),
											lottoPurchaseBean.getPartyId(), lottoPurchaseBean.getPartyType(),
											lottoPurchaseBean.getRefMerchantId(), userBean,
											lottoPurchaseBean.getRefTransId());
<span class="nc" id="L7513">									lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L7514">									return lottoPurchaseBean;</span>
<span class="nc bnc" id="L7515" title="All 2 branches missed.">								} else if (rafflePurchaseBean.getSaleStatus().equalsIgnoreCase(&quot;SUCCESS&quot;)) {</span>
									// here insert entry into the promo
									// ticket mapping table
<span class="nc" id="L7518">									int tktlen = rafflePurchaseBean.getRaffleTicket_no().length();</span>
<span class="nc" id="L7519">									orgOnLineSaleCreditUpdation.drawTicketNPromoMappigUpdate(1,</span>
											rafflePurchaseBean.getGame_no(), rafflePurchaseBean.getParentTktNo(),
											rafflePurchaseBean.getRaffleTicket_no().substring(0, tktlen - 2));
<span class="nc" id="L7522">									rafflePurchaseBeanList.add(rafflePurchaseBean);</span>
								}
<span class="nc bnc" id="L7524" title="All 2 branches missed.">							} else if (promobean.getPromoGameName().equalsIgnoreCase(&quot;Zimlottobonustwofree&quot;)) {</span>
								// call winfast purchase process

<span class="nc bnc" id="L7527" title="All 2 branches missed.">								if (isLoopAgain) {</span>
<span class="nc" id="L7528">									int gameNo = promobean.getPromoGameNo();</span>
<span class="nc" id="L7529">									int gameId = Util.getGameIdFromGameNumber(gameNo);</span>
<span class="nc" id="L7530">									LottoPurchaseBean drawGamePurchaseBean = new LottoPurchaseBean();</span>
									// drawGamePurchaseBean.setIsQP(1);
									// drawGamePurchaseBean.setTotalNoOfPanels(1);
									// drawGamePurchaseBean.setSymbols(symbols);
									// drawGamePurchaseBean.setNoOfPanels(&quot;1&quot;);

									// drawGamePurchaseBean.setBetAmountMultiple(betAmountMultiple);
<span class="nc" id="L7537">									drawGamePurchaseBean.setDrawIdTableMap(lottoPurchaseBean.getDrawIdTableMap());</span>
<span class="nc" id="L7538">									drawGamePurchaseBean.setGame_no(gameNo);</span>
<span class="nc" id="L7539">									drawGamePurchaseBean.setGameId(gameId);</span>
<span class="nc" id="L7540">									drawGamePurchaseBean.setGameDispName(Util.getGameMap().get(gameId).getGameName());</span>
									// drawGamePurchaseBean.setIsQuickPick(isQuickPickNew);
<span class="nc" id="L7542">									drawGamePurchaseBean.setNoOfDraws(promobean.getNoOfDraws());</span>
<span class="nc" id="L7543">									drawGamePurchaseBean.setPartyId(userBean.getUserOrgId());</span>
<span class="nc" id="L7544">									drawGamePurchaseBean.setPartyType(userBean.getUserType());</span>
<span class="nc" id="L7545">									drawGamePurchaseBean.setUserId(userBean.getUserId());</span>
<span class="nc" id="L7546">									drawGamePurchaseBean.setRefMerchantId(lottoPurchaseBean.getRefMerchantId());</span>
<span class="nc" id="L7547">									drawGamePurchaseBean.setPurchaseChannel(lottoPurchaseBean.getPurchaseChannel());</span>
<span class="nc" id="L7548">									drawGamePurchaseBean.setPromotkt(true);</span>
<span class="nc" id="L7549">									drawGamePurchaseBean.setNoPicked(lottoPurchaseBean.getNoPicked());</span>
<span class="nc" id="L7550">									drawGamePurchaseBean.setServiceId(lottoPurchaseBean.getServiceId());</span>
<span class="nc" id="L7551">									drawGamePurchaseBean.setUserMappingId(lottoPurchaseBean.getUserMappingId());</span>
<span class="nc" id="L7552">									drawGamePurchaseBean.setPlrMobileNumber(lottoPurchaseBean.getPlrMobileNumber());</span>
<span class="nc" id="L7553">									StringBuilder sb = new StringBuilder(&quot;QP&quot;);</span>
<span class="nc bnc" id="L7554" title="All 2 branches missed.">									if (&quot;Direct6&quot;.equalsIgnoreCase(lottoPurchaseBean.getPlayType())) {</span>
<span class="nc bnc" id="L7555" title="All 2 branches missed.">										for (int m = 1; m &lt; lottoPurchaseBean.getNoOfLines()</span>
<span class="nc" id="L7556">												* promobean.getNoOfPromoTickets(); m++) {</span>
<span class="nc" id="L7557">											sb.append(&quot;NxtQP&quot;);</span>
										}
<span class="nc bnc" id="L7559" title="All 2 branches missed.">									} else if (&quot;Perm6&quot;.equalsIgnoreCase(lottoPurchaseBean.getPlayType())) {</span>
<span class="nc bnc" id="L7560" title="All 2 branches missed.">										for (int m = 1; m &lt; promobean.getNoOfPromoTickets(); m++) {</span>
<span class="nc" id="L7561">											sb.append(&quot;NxtQP&quot;);</span>
										}
									}
<span class="nc" id="L7564">									String pickedNumbers = sb.toString();</span>
<span class="nc" id="L7565">									String[] picknumbers = pickedNumbers.split(&quot;Nxt&quot;);</span>
<span class="nc" id="L7566">									drawGamePurchaseBean.setPickedNumbers(pickedNumbers);</span>
<span class="nc" id="L7567">									drawGamePurchaseBean.setPicknumbers(picknumbers);</span>

<span class="nc" id="L7569">									drawGamePurchaseBean.setPlayType(lottoPurchaseBean.getPlayType());</span>
									// if (drawIdArr != null) {
									// drawGamePurchaseBean.setDrawDateTime(Arrays.asList(drawIdArr));
									// }
<span class="nc" id="L7573">									drawGamePurchaseBean.setIsAdvancedPlay(0);</span>
<span class="nc" id="L7574">									LottoPurchaseBean lottoBean = ZimLottoBonusTwoFreeHelper</span>
											.zimLottoBonusTwoFreePurchaseTicket(userBean, drawGamePurchaseBean,
													lottoPurchaseBean);
<span class="nc bnc" id="L7577" title="All 2 branches missed.">									if (&quot;SUCCESS&quot;.equalsIgnoreCase(lottoBean.getSaleStatus())) {</span>
<span class="nc" id="L7578">										orgOnLineSaleCreditUpdation.drawTicketNPromoMappigUpdate(1,</span>
												lottoPurchaseBean.getGame_no(), lottoPurchaseBean.getTicket_no(),
												lottoBean.getTicket_no());
									} else {
<span class="nc" id="L7582">										lottoPurchaseBean.setPromoSaleStatus(&quot;FAILED&quot;);</span>
<span class="nc" id="L7583">										return lottoPurchaseBean;</span>
									}

<span class="nc" id="L7586">									lottoBeanList.add(lottoBean);</span>
<span class="nc" id="L7587">									logger.debug(&quot;Promo Bean Data for zim lotto Three&quot; + lottoBean);</span>
									// kenoPurchaseBean.setFortunePurchaseBean(fortuneBean);
<span class="nc" id="L7589">									lottoPurchaseBean.setPromoPurchaseBeanList(lottoBeanList);</span>
<span class="nc" id="L7590">									isLoopAgain = false;</span>

								}
<span class="nc bnc" id="L7593" title="All 2 branches missed.">								if (&quot;Direct6&quot;.equalsIgnoreCase(lottoPurchaseBean.getPlayType()))</span>
<span class="nc" id="L7594">									isLoopAgain = false;</span>
							}
						}
					}
<span class="nc" id="L7598">					lottoPurchaseBean.setRafflePurchaseBeanList(rafflePurchaseBeanList);</span>

<span class="nc" id="L7600">					return lottoPurchaseBean;</span>
				} else {
<span class="nc" id="L7602">					status = &quot;FAILED&quot;;</span>
<span class="nc" id="L7603">					lottoPurchaseBean.setSaleStatus(status);</span>
					// Code for cancelling the Ticket to be send to
					// Draw
					// Game Engine
<span class="nc" id="L7607">					cancelTicket(lottoPurchaseBean.getTicket_no() + lottoPurchaseBean.getReprintCount(),</span>
							lottoPurchaseBean.getPurchaseChannel(), lottoPurchaseBean.getDrawIdTableMap(),
							lottoPurchaseBean.getGame_no(), lottoPurchaseBean.getPartyId(),
							lottoPurchaseBean.getPartyType(), lottoPurchaseBean.getRefMerchantId(), userBean,
							lottoPurchaseBean.getRefTransId());

<span class="nc" id="L7613">					return lottoPurchaseBean;</span>
				}
			} else {
<span class="nc" id="L7616">				lottoPurchaseBean.setSaleStatus(responseBean.getSaleStatus());</span>
				// lottoPurchaseBean = new Gson().fromJson(responseString,
				// elementType);
<span class="nc bnc" id="L7619" title="All 2 branches missed.">				if (lottoPurchaseBean.getSaleStatus() == null) {</span>
<span class="nc" id="L7620">					lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);// Error</span>
<span class="nc" id="L7621">					orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, lottoPurchaseBean.getGameId(), &quot;FAILED&quot;,</span>
							balDed);
<span class="nc" id="L7623">					return lottoPurchaseBean;</span>
<span class="nc bnc" id="L7624" title="All 2 branches missed.">				} else if (&quot;ERROR_TICKET_LIMIT&quot;.equalsIgnoreCase(lottoPurchaseBean.getSaleStatus())) {</span>
<span class="nc" id="L7625">					orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, lottoPurchaseBean.getGameId(), &quot;FAILED&quot;,</span>
							balDed);
<span class="nc" id="L7627">					return lottoPurchaseBean;</span>
				} else {
<span class="nc" id="L7629">					orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, lottoPurchaseBean.getGameId(), &quot;FAILED&quot;,</span>
							balDed);
<span class="nc" id="L7631">					return lottoPurchaseBean;</span>
				}
			}
<span class="nc" id="L7634">		} catch (Exception e) {</span>
<span class="nc" id="L7635">			e.printStackTrace();</span>
			// lottoPurchaseBean = new Gson().fromJson(responseString,
			// elementType);
<span class="nc bnc" id="L7638" title="All 2 branches missed.">			if (lottoPurchaseBean.getSaleStatus() == null) {</span>
<span class="nc" id="L7639">				lottoPurchaseBean.setSaleStatus(&quot;FAILED&quot;);// Error</span>
<span class="nc" id="L7640">				orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, lottoPurchaseBean.getGameId(), &quot;FAILED&quot;,</span>
						balDed);
<span class="nc" id="L7642">				return lottoPurchaseBean;</span>
			} else {
<span class="nc" id="L7644">				orgOnLineSaleCreditUpdation.drawTicketSaleRefund(userBean, lottoPurchaseBean.getGameId(), &quot;FAILED&quot;,</span>
						balDed);
<span class="nc" id="L7646">				return lottoPurchaseBean;</span>
			}

		} finally {
<span class="nc" id="L7650">			DBConnect.closeCon(con);</span>
		}
	}

	public static String fetchCurrentVersion(String userName) { // For Embedded
		// only...
<span class="nc" id="L7656">		logger.debug(&quot;in fetchCurrentVersion() method&quot;);</span>
<span class="nc" id="L7657">		String version = null;</span>
<span class="nc" id="L7658">		Connection con = DBConnect.getConnection();</span>
		try {
<span class="nc" id="L7660">			String query = &quot;SELECT rom.current_version FROM st_lms_ret_offline_master rom, st_lms_user_master um WHERE um.user_id = rom.user_id AND um.user_name = ?&quot;;</span>
<span class="nc" id="L7661">			PreparedStatement pstmt = con.prepareStatement(query);</span>
<span class="nc" id="L7662">			pstmt.setString(1, userName);</span>
<span class="nc" id="L7663">			ResultSet rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L7664" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L7665">				version = rs.getString(&quot;current_version&quot;);</span>
			}
<span class="nc" id="L7667">		} catch (Exception ex) {</span>
<span class="nc" id="L7668">			logger.debug(ex);</span>
<span class="nc" id="L7669">			ex.printStackTrace();</span>
		} finally {
<span class="nc" id="L7671">			try {</span>
<span class="nc bnc" id="L7672" title="All 12 branches missed.">				if (con != null &amp;&amp; !con.isClosed()) {</span>
<span class="nc" id="L7673">					con.close();</span>
				}
<span class="nc" id="L7675">			} catch (SQLException e) {</span>
<span class="nc" id="L7676">				e.printStackTrace();</span>
<span class="nc" id="L7677">			}</span>
<span class="nc" id="L7678">		}</span>
<span class="nc" id="L7679">		return version;</span>
	}

	public static String embdDgData(boolean isOffline, Map&lt;Integer, Map&lt;Integer, String&gt;&gt; drawIdTableMap, int userId,
			int orgId, double version) throws LMSException {
<span class="nc" id="L7684">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L7685">		String addQry = &quot;&quot;;</span>
<span class="nc" id="L7686">		StringBuilder returnData = null;</span>

<span class="nc" id="L7688">		Map&lt;Integer, StringBuilder&gt; gameData = new HashMap&lt;Integer, StringBuilder&gt;();</span>
<span class="nc" id="L7689">		Map&lt;Integer, Integer&gt; offlineFzTimeMap = new HashMap&lt;Integer, Integer&gt;();</span>
<span class="nc" id="L7690">		Map&lt;Integer, Double&gt; retSaleComm = new HashMap&lt;Integer, Double&gt;();</span>
<span class="nc" id="L7691">		OfflineRetailerBean retBean = new OfflineRetailerBean();</span>
<span class="nc" id="L7692">		retBean.setVersion(version);</span>
		try {
<span class="nc" id="L7694">			boolean displayBetName = &quot;PHILIP&quot;.equals(Utility.getPropertyValue(&quot;COUNTRY_DEPLOYED&quot;));</span>

<span class="nc" id="L7696">			returnData = new StringBuilder(&quot;&quot;);</span>
<span class="nc" id="L7697">			boolean status = DrawGameRPOSHelper.checkMandatoryDownload(userId, version, con);</span>
<span class="nc bnc" id="L7698" title="All 2 branches missed.">			if (!status) {</span>
<span class="nc" id="L7699">				returnData.append(&quot;NO_ENTRY&quot;);</span>
<span class="nc" id="L7700">				return returnData.toString();</span>
			}

<span class="nc" id="L7703">			PreparedStatement Offpstmt = con.prepareStatement(</span>
					&quot;select user_id from st_lms_ret_offline_master where user_id=? and is_offline='YES'&quot;);
<span class="nc" id="L7705">			Offpstmt.setInt(1, userId);</span>
<span class="nc" id="L7706">			ResultSet offRs = Offpstmt.executeQuery();</span>
<span class="nc bnc" id="L7707" title="All 2 branches missed.">			if (offRs.next()) {</span>
<span class="nc" id="L7708">				isOffline = true;</span>
			}

<span class="nc bnc" id="L7711" title="All 2 branches missed.">			if (isOffline) {</span>
<span class="nc" id="L7712">				addQry = &quot; (is_offline = 'Y' and game_nbr in(select promo_game_id from st_dg_promo_scheme ps inner join st_dg_game_master gm on sale_game_id=game_nbr where ps.status='ACTIVE')) or &quot;;</span>
			}

<span class="nc" id="L7715">			String selQry = &quot;select game_id,game_name_dev,game_name,game_nbr,offline_freeze_time,retailer_sale_comm_rate,ifnull(promo_game_type,'STANDARD') game_type,ifnull(raffle_ticket_type,0) raffle_ticket_type from st_dg_game_master left outer join st_dg_promo_scheme ps on game_id=promo_game_id and ps.status='ACTIVE' where &quot;</span>
					+ addQry + &quot; game_status='OPEN' and is_sale_allowed_through_terminal='Y' order by game_nbr&quot;;

<span class="nc" id="L7718">			PreparedStatement pstmt = con.prepareStatement(selQry);</span>
<span class="nc" id="L7719">			ResultSet rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L7720" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L7721">				String gameName = rs.getString(&quot;game_name_dev&quot;);</span>
<span class="nc bnc" id="L7722" title="All 4 branches missed.">				if (version &lt; 5.8 &amp;&amp; &quot;SuperTwo&quot;.equalsIgnoreCase(gameName)) {</span>
<span class="nc" id="L7723">					continue;</span>
				}
<span class="nc bnc" id="L7725" title="All 2 branches missed.">				if (/* &quot;Zerotonine&quot;.equalsIgnoreCase(gameName) || */ &quot;OneToTwelve&quot;.equalsIgnoreCase(gameName)) {</span>
<span class="nc" id="L7726">					continue;</span>
				}

<span class="nc" id="L7729">				returnData = new StringBuilder(&quot;&quot;);</span>
<span class="nc" id="L7730">				int gameId = rs.getInt(&quot;game_id&quot;);</span>

<span class="nc" id="L7732">				returnData.append(gameName + &quot;,&quot;);</span>
<span class="nc" id="L7733">				returnData.append(rs.getString(&quot;game_name&quot;) + &quot;,&quot;);</span>
<span class="nc" id="L7734">				returnData.append(rs.getInt(&quot;game_nbr&quot;) + &quot;,&quot;);</span>
<span class="nc" id="L7735">				String gameType = rs.getString(&quot;game_type&quot;);</span>

<span class="nc bnc" id="L7737" title="All 2 branches missed.">				if (&quot;STANDARD&quot;.equalsIgnoreCase(gameType)) {</span>
<span class="nc" id="L7738">					returnData.append(&quot;0,&quot;);</span>
<span class="nc bnc" id="L7739" title="All 2 branches missed.">				} else if (&quot;RAFFLE&quot;.equalsIgnoreCase(gameType)) {</span>
<span class="nc" id="L7740">					returnData.append(&quot;1,&quot;);</span>
<span class="nc bnc" id="L7741" title="All 2 branches missed.">				} else if (&quot;PROMO&quot;.equalsIgnoreCase(gameType)) {</span>
<span class="nc" id="L7742">					returnData.append(&quot;2,&quot;);</span>
				}

<span class="nc bnc" id="L7745" title="All 2 branches missed.">				if (version &gt; 5.6) {</span>
<span class="nc" id="L7746">					String raffleType = rs.getString(&quot;raffle_ticket_type&quot;);</span>
<span class="nc bnc" id="L7747" title="All 2 branches missed.">					if (&quot;REFERENCE&quot;.equalsIgnoreCase(raffleType)) {</span>
<span class="nc" id="L7748">						returnData.append(&quot;2,&quot;);</span>
<span class="nc bnc" id="L7749" title="All 2 branches missed.">					} else if (&quot;ORIGINAL&quot;.equalsIgnoreCase(raffleType)) {</span>
<span class="nc" id="L7750">						returnData.append(&quot;1,&quot;);</span>
					} else {
<span class="nc" id="L7752">						returnData.append(&quot;0,&quot;);</span>
					}
				}
<span class="nc" id="L7755">				returnData.append(&quot;totalDraw,&quot;); // Number</span>
				// of
				// Active
				// Draws

<span class="nc bnc" id="L7760" title="All 4 branches missed.">				if (version &lt;= 6.5 &amp;&amp; &quot;FortuneTwo&quot;.equalsIgnoreCase(gameName)) {</span>
<span class="nc" id="L7761">					Map&lt;String, BetDetailsBean&gt; priceMap = Util.getGameMap().get(gameId).getPriceMap();</span>
<span class="nc" id="L7762">					Iterator&lt;String&gt; betTypeIter = priceMap.keySet().iterator();</span>
<span class="nc" id="L7763">					String betType = null;</span>
<span class="nc bnc" id="L7764" title="All 2 branches missed.">					while (betTypeIter.hasNext()) {</span>
<span class="nc" id="L7765">						betType = betTypeIter.next();</span>
<span class="nc bnc" id="L7766" title="All 2 branches missed.">						if (!(betType.contains(&quot;Banker&quot;))) {</span>
<span class="nc" id="L7767">							returnData.append(priceMap.get(betType).getUnitPrice() + &quot;:&quot;);</span>
						}
					}
<span class="nc" id="L7770">					returnData.deleteCharAt(returnData.length() - 1);</span>
<span class="nc" id="L7771">					returnData.append(&quot;,&quot;);</span>

<span class="nc bnc" id="L7773" title="All 4 branches missed.">				} else if (version &lt;= 6.5 &amp;&amp; &quot;FortuneThree&quot;.equalsIgnoreCase(gameName)) {</span>
<span class="nc" id="L7774">					Map&lt;String, BetDetailsBean&gt; priceMap = Util.getGameMap().get(gameId).getPriceMap();</span>
<span class="nc" id="L7775">					Iterator&lt;String&gt; betTypeIter = priceMap.keySet().iterator();</span>
<span class="nc" id="L7776">					String betType = null;</span>
<span class="nc bnc" id="L7777" title="All 2 branches missed.">					while (betTypeIter.hasNext()) {</span>
<span class="nc" id="L7778">						betType = betTypeIter.next();</span>
<span class="nc bnc" id="L7779" title="All 2 branches missed.">						if (!(betType.contains(&quot;Banker&quot;))) {</span>
<span class="nc" id="L7780">							returnData.append(priceMap.get(betType).getUnitPrice() + &quot;:&quot;);</span>
						}
					}
<span class="nc" id="L7783">					returnData.deleteCharAt(returnData.length() - 1);</span>
<span class="nc" id="L7784">					returnData.append(&quot;,&quot;);</span>
<span class="nc" id="L7785">				}</span>

				else {
					// returnData.append(Util.convertCollToStr(new
					// TreeMap&lt;String,
					// BetDetailsBean&gt;(Util.getGameMap().get(gameName).getPriceMap()).values()).replace(&quot;,
					// &quot;, &quot;:&quot;) + &quot;,&quot;);

<span class="nc" id="L7793">					Map&lt;String, BetDetailsBean&gt; map1 = new TreeMap&lt;String, BetDetailsBean&gt;(</span>
							Util.getGameMap().get(gameId).getPriceMap());
<span class="nc" id="L7795">					ValueComparator comparator = new ValueComparator(map1);</span>
<span class="nc" id="L7796">					Map&lt;String, BetDetailsBean&gt; map2 = new TreeMap&lt;String, BetDetailsBean&gt;(comparator);</span>
<span class="nc" id="L7797">					map2.putAll(map1);</span>
<span class="nc" id="L7798">					Iterator iterator = map2.entrySet().iterator();</span>
					// Iterator&lt;String&gt; iterator = map2.keySet().iterator();
<span class="nc bnc" id="L7800" title="All 2 branches missed.">					while (iterator.hasNext()) {</span>
<span class="nc" id="L7801">						Map.Entry pair = (Map.Entry) iterator.next();</span>
<span class="nc" id="L7802">						BetDetailsBean bean = (BetDetailsBean) pair.getValue();</span>
<span class="nc bnc" id="L7803" title="All 2 branches missed.">						if (&quot;ACTIVE&quot;.equals(bean.getBetStatus())) {</span>
<span class="nc bnc" id="L7804" title="All 2 branches missed.">							String betDispNameAppender = (displayBetName) ? &quot;~&quot; + bean.getBetDispName() : &quot;&quot;;</span>
<span class="nc bnc" id="L7805" title="All 4 branches missed.">							if (!(&quot;KenoTwo&quot;.equalsIgnoreCase(gameName) &amp;&amp; pair.getKey().toString().contains(&quot;Direct&quot;)))</span>
								// returnData.append(bean.getUnitPrice()).append(&quot;~&quot;).append(bean.getMaxBetAmtMultiple()).append(&quot;~&quot;).append((bean.getBetStatus()
								// ==
								// null)?&quot;&quot;:(bean.getBetStatus().equals(&quot;ACTIVE&quot;))?1:0).append(&quot;(&quot;).append(bean.getBetCode()).append(&quot;-&quot;).append(bean.getBetOrder()).append(&quot;)&quot;).append(&quot;:&quot;);
<span class="nc" id="L7809">								returnData.append(bean.getBetCode()).append(&quot;~&quot;).append(bean.getUnitPrice()).append(&quot;~&quot;)</span>
										.append(bean.getMaxBetAmtMultiple()).append(betDispNameAppender).append(&quot;:&quot;);
						}
<span class="nc" id="L7812">					}</span>
<span class="nc" id="L7813">					returnData.deleteCharAt(returnData.length() - 1);</span>
<span class="nc" id="L7814">					returnData.append(&quot;,&quot;);</span>
				}

<span class="nc" id="L7817">				gameData.put(gameId, returnData);</span>
<span class="nc" id="L7818">				offlineFzTimeMap.put(gameId, rs.getInt(&quot;offline_freeze_time&quot;));</span>
<span class="nc" id="L7819">				retSaleComm.put(gameId, Util.getSaleCommVariance(orgId, rs.getInt(&quot;game_id&quot;)));</span>
<span class="nc" id="L7820">			}</span>

<span class="nc" id="L7822">			retBean.setUserId(userId);</span>
<span class="nc" id="L7823">			retBean.setGameData(gameData);</span>
<span class="nc" id="L7824">			retBean.setOffline(isOffline);</span>
<span class="nc" id="L7825">			retBean.setOfflineFzTimeMap(offlineFzTimeMap);</span>
<span class="nc" id="L7826">			retBean.setRetSaleComm(retSaleComm);</span>
<span class="nc" id="L7827">			retBean.setPartyType(&quot;RETAILER&quot;);</span>
<span class="nc bnc" id="L7828" title="All 2 branches missed.">			retBean.setStatusWithDrawInfo(</span>
					Utility.getPropertyValue(&quot;COUNTRY_DEPLOYED&quot;).equalsIgnoreCase(&quot;GHANA&quot;) ? true : false);

<span class="nc" id="L7831">		} catch (Exception e) {</span>
<span class="nc" id="L7832">			e.printStackTrace();</span>
<span class="nc" id="L7833">			throw new LMSException(&quot;Some Error&quot;);</span>
		} finally {
<span class="nc" id="L7835">			DBConnect.closeCon(con);</span>
<span class="nc" id="L7836">		}</span>

		try {
<span class="nc" id="L7839">			IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L7840">			ServiceRequest req = new ServiceRequest();</span>
<span class="nc" id="L7841">			req.setServiceName(ServiceName.DRAWGAME);</span>
<span class="nc" id="L7842">			req.setServiceMethod(ServiceMethodName.FETCH_DG_DATA_OFFLINE);</span>
<span class="nc" id="L7843">			req.setServiceData(retBean);</span>

<span class="nc" id="L7845">			ServiceResponse resp = delegate.getResponse(req);</span>

<span class="nc" id="L7847">			String responseString = resp.getResponseData().toString();</span>
<span class="nc" id="L7848">			Type elementType = new TypeToken&lt;OfflineRetailerBean&gt;() {</span>
			}.getType();

<span class="nc bnc" id="L7851" title="All 2 branches missed.">			if (resp.getIsSuccess()) {</span>
<span class="nc" id="L7852">				retBean = new Gson().fromJson(responseString, elementType);</span>
			} else {
<span class="nc" id="L7854">				throw new LMSException(&quot;Some Error&quot;);</span>
			}

<span class="nc" id="L7857">			gameData = retBean.getGameData();</span>
<span class="nc" id="L7858">			returnData = new StringBuilder(&quot;&quot;);</span>
<span class="nc" id="L7859">			Iterator&lt;Map.Entry&lt;Integer, StringBuilder&gt;&gt; itr = gameData.entrySet().iterator();</span>
<span class="nc bnc" id="L7860" title="All 2 branches missed.">			while (itr.hasNext()) {</span>
<span class="nc" id="L7861">				Map.Entry&lt;Integer, StringBuilder&gt; pair = itr.next();</span>
<span class="nc" id="L7862">				returnData.append(pair.getValue() + &quot;#&quot;);</span>
<span class="nc" id="L7863">			}</span>
<span class="nc" id="L7864">			returnData.deleteCharAt(returnData.length() - 1);</span>

<span class="nc bnc" id="L7866" title="All 2 branches missed.">			if (isOffline) {</span>
				try {
<span class="nc" id="L7868">					con = DBConnect.getConnection();</span>
<span class="nc" id="L7869">					returnData.append(&quot;|PromoInfo:&quot;);</span>
<span class="nc" id="L7870">					String selQry = &quot;select scheme_id,sale_game_id,promo_game_id,sale_ticket_amt,if(valid_for_draw='INDOOR',1,if(valid_for_draw='OUTDOOR',0,2)) valid_for_draw from st_dg_promo_scheme where status='ACTIVE'&quot;;</span>
<span class="nc" id="L7871">					PreparedStatement pstmt = con.prepareStatement(selQry);</span>
<span class="nc" id="L7872">					ResultSet rs = pstmt.executeQuery();</span>
<span class="nc" id="L7873">					boolean isPromo = false;</span>
<span class="nc bnc" id="L7874" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L7875">						isPromo = true;</span>
<span class="nc" id="L7876">						returnData.append(rs.getString(&quot;scheme_id&quot;) + &quot;,&quot;);</span>
<span class="nc" id="L7877">						returnData.append(rs.getString(&quot;sale_game_id&quot;) + &quot;,&quot;);</span>
<span class="nc" id="L7878">						returnData.append(rs.getString(&quot;promo_game_id&quot;) + &quot;,&quot;);</span>
<span class="nc" id="L7879">						returnData.append(rs.getString(&quot;sale_ticket_amt&quot;) + &quot;,&quot;);</span>
<span class="nc" id="L7880">						returnData.append(rs.getString(&quot;valid_for_draw&quot;) + &quot;#&quot;);</span>
					}
<span class="nc bnc" id="L7882" title="All 2 branches missed.">					if (isPromo) {</span>
<span class="nc" id="L7883">						returnData.deleteCharAt(returnData.length() - 1);</span>
					} else {
<span class="nc" id="L7885">						returnData.delete(returnData.length() - &quot;|PromoInfo:&quot;.length(), returnData.length());</span>
					}
<span class="nc" id="L7887">				} catch (Exception e) {</span>
<span class="nc" id="L7888">					e.printStackTrace();</span>
<span class="nc" id="L7889">					throw new LMSException(&quot;Some Error&quot;);</span>
				} finally {
<span class="nc" id="L7891">					DBConnect.closeCon(con);</span>
<span class="nc" id="L7892">				}</span>
			}
<span class="nc" id="L7894">			logger.debug(&quot;***Game Info for Ret User**&quot; + userId + &quot;****&quot; + returnData + &quot;****&quot;);</span>
<span class="nc" id="L7895">		} catch (Exception e) {</span>
<span class="nc" id="L7896">			e.printStackTrace();</span>
<span class="nc" id="L7897">			throw new LMSException(&quot;Some Error&quot;);</span>
<span class="nc" id="L7898">		}</span>
<span class="nc" id="L7899">		return returnData.toString();</span>
	}

	public String getTicketNumberFrmTxnId(String txnId, int userOrgId) {

<span class="nc" id="L7904">		Connection connection = DBConnect.getConnection();</span>
<span class="nc" id="L7905">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L7906">		ResultSet rs = null;</span>
<span class="nc" id="L7907">		int gameNo = 0;</span>
<span class="nc" id="L7908">		String ticketNumber = null;</span>
<span class="nc" id="L7909">		double mrpAmt = 0.0;</span>
		try {
<span class="nc" id="L7911">			String gameNoQry = &quot;select game_id from st_lms_retailer_transaction_master where retailer_org_id=&quot;</span>
					+ userOrgId + &quot;  and  transaction_id =&quot; + txnId;
<span class="nc" id="L7913">			pstmt = connection.prepareStatement(gameNoQry);</span>
<span class="nc" id="L7914">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L7915" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L7916">				gameNo = rs.getInt(&quot;game_id&quot;);</span>
			}
<span class="nc" id="L7918">			pstmt = connection.prepareStatement(</span>
					&quot;select ticket_nbr,mrp_amt from st_dg_ret_sale_&quot; + gameNo + &quot; where transaction_id=&quot; + txnId);
<span class="nc" id="L7920">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L7921" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L7922">				ticketNumber = rs.getString(&quot;ticket_nbr&quot;);</span>
<span class="nc" id="L7923">				mrpAmt = rs.getDouble(&quot;mrp_amt&quot;);</span>
			}
<span class="nc bnc" id="L7925" title="All 2 branches missed.">			if (mrpAmt &gt; 0) {</span>
				// sale ticket
			} else {
<span class="nc" id="L7928">				rs = pstmt</span>
						.executeQuery(&quot;select sale_ticket_nbr from ge_sale_promo_ticket_mapping where promo_ticket_nbr=&quot;
								+ ticketNumber);
<span class="nc bnc" id="L7931" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L7932">					ticketNumber = rs.getString(&quot;sale_ticket_nbr&quot;);</span>
				}
			}
<span class="nc" id="L7935">		} catch (Exception e) {</span>
<span class="nc" id="L7936">			e.printStackTrace();</span>
<span class="nc" id="L7937">		}</span>
<span class="nc" id="L7938">		return ticketNumber;</span>
	}

	public List&lt;String&gt; getTransactionType(List&lt;Long&gt; lmsTranxIdList) {
<span class="nc" id="L7942">		List&lt;String&gt; returnList = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L7943">		Connection con = DBConnect.getConnection();</span>
		try {
<span class="nc" id="L7945">			String returnType = null;</span>
<span class="nc" id="L7946">			int gameNo = 0;</span>
<span class="nc" id="L7947">			String gameNameDev = null;</span>
<span class="nc" id="L7948">			PreparedStatement pstmt = con.prepareStatement(</span>
					&quot;select transaction_type, game_id from st_lms_retailer_transaction_master where transaction_id = ?&quot;);

<span class="nc bnc" id="L7951" title="All 2 branches missed.">			for (int i = 0; i &lt; lmsTranxIdList.size(); i++) {</span>
<span class="nc" id="L7952">				pstmt.setString(1, lmsTranxIdList.get(i) + &quot;&quot;);</span>
<span class="nc" id="L7953">				logger.debug(&quot;***getTransactionType query : &quot; + pstmt + &quot;******&quot;);</span>
<span class="nc" id="L7954">				ResultSet rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L7956" title="All 2 branches missed.">				if (rs.next()) {</span>
<span class="nc" id="L7957">					returnType = rs.getString(&quot;transaction_type&quot;);</span>
<span class="nc" id="L7958">					gameNo = rs.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L7959">					gameNameDev = Util.getGameName(gameNo);</span>
<span class="nc" id="L7960">					returnType = returnType + &quot;_&quot; + gameNameDev.toUpperCase();</span>
				}

<span class="nc" id="L7963">				returnList.add(returnType);</span>
			}

<span class="nc" id="L7966">		} catch (Exception e) {</span>
<span class="nc" id="L7967">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L7969">			DBConnect.closeCon(con);</span>
<span class="nc" id="L7970">		}</span>

<span class="nc" id="L7972">		return returnList;</span>
	}

	public static Object getTransactionStatusAndData(UserInfoBean userBean, List&lt;Long&gt; lmsTranxIdList,
			List&lt;String&gt; lmsTranxIdTypeList) {
<span class="nc bnc" id="L7977" title="All 2 branches missed.">		if (&quot;DG_SALE_KENO&quot;.equalsIgnoreCase(lmsTranxIdTypeList.get(0))) {</span>
<span class="nc" id="L7978">			KenoPurchaseBean kenoBean = kenoSaleTxnStatusAndData(userBean, lmsTranxIdList.get(0) + &quot;&quot;);</span>
<span class="nc" id="L7979">			return kenoBean;</span>
<span class="nc bnc" id="L7980" title="All 2 branches missed.">		} else if (&quot;DG_SALE_TANZANIALOTTO&quot;.equalsIgnoreCase(lmsTranxIdTypeList.get(0))) {</span>
<span class="nc" id="L7981">			LottoPurchaseBean lottoBean = tanzanialottoSaleTxnStatusAndData(userBean, lmsTranxIdList.get(0) + &quot;&quot;);</span>
<span class="nc" id="L7982">			return lottoBean;</span>
<span class="nc bnc" id="L7983" title="All 2 branches missed.">		} else if (&quot;DG_SALE_BONUSBALLLOTTO&quot;.equalsIgnoreCase(lmsTranxIdTypeList.get(0))) {</span>
<span class="nc" id="L7984">			LottoPurchaseBean lottoBean = bonusBalllottoSaleTxnStatusAndData(userBean, lmsTranxIdList.get(0) + &quot;&quot;);</span>
<span class="nc" id="L7985">			return lottoBean;</span>
<span class="nc bnc" id="L7986" title="All 2 branches missed.">		} else if (lmsTranxIdTypeList.get(0).contains(&quot;DG_REFUND_CANCEL&quot;)) {</span>
<span class="nc" id="L7987">			CancelTicketBean cancelBean = cancelTxnStatusAndData(userBean, lmsTranxIdList.get(0) + &quot;&quot;);</span>
<span class="nc" id="L7988">			return cancelBean;</span>
<span class="nc bnc" id="L7989" title="All 2 branches missed.">		} else if (lmsTranxIdTypeList.get(0).contains(&quot;PWT&quot;)) {</span>
<span class="nc" id="L7990">			PWTApiBean pwtBean = pwtTxnStatusAndData(userBean, lmsTranxIdList);</span>
<span class="nc" id="L7991">			return pwtBean;</span>
		}

<span class="nc" id="L7994">		return null;</span>
	}

	public static List&lt;Long&gt; getLMSTxnIdList(int retOrgId, String refTxnId) {
<span class="nc" id="L7998">		List&lt;Long&gt; returnList = new ArrayList&lt;Long&gt;();</span>
<span class="nc" id="L7999">		Connection con = DBConnect.getConnection();</span>
		try {
<span class="nc" id="L8001">			PreparedStatement pstmt = con.prepareStatement(</span>
					&quot;select lms_txn_id, mobile_no from st_lms_tp_txn_mapping where retailer_org_id=? and tp_ref_txn_id=?&quot;);
<span class="nc" id="L8003">			pstmt.setInt(1, retOrgId);</span>
<span class="nc" id="L8004">			pstmt.setString(2, refTxnId);</span>
<span class="nc" id="L8005">			logger.debug(&quot;******getLMSTxnIdAndMobileNo query:&quot; + pstmt);</span>
<span class="nc" id="L8006">			ResultSet rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L8008" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L8009">				returnList.add(rs.getLong(&quot;lms_txn_id&quot;));</span>
				// returnData = rs.getString(&quot;lms_txn_id&quot;) + &quot;Nxt&quot; +
				// rs.getString(&quot;mobile_no&quot;);
			}
<span class="nc" id="L8013">		} catch (Exception e) {</span>
<span class="nc" id="L8014">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L8016">			DBConnect.closeCon(con);</span>
<span class="nc" id="L8017">		}</span>
<span class="nc" id="L8018">		return returnList;</span>
	}

	public static String getMobileNo(int retOrgId, String refTxnId) {
<span class="nc" id="L8022">		String mobileNo = null;</span>
<span class="nc" id="L8023">		Connection con = DBConnect.getConnection();</span>
		try {
<span class="nc" id="L8025">			PreparedStatement pstmt = con.prepareStatement(</span>
					&quot;select lms_txn_id, mobile_no from st_lms_tp_txn_mapping where retailer_org_id=? and tp_ref_txn_id=?&quot;);
<span class="nc" id="L8027">			pstmt.setInt(1, retOrgId);</span>
<span class="nc" id="L8028">			pstmt.setString(2, refTxnId);</span>
<span class="nc" id="L8029">			logger.debug(&quot;******getMobileNo query:&quot; + pstmt);</span>
<span class="nc" id="L8030">			ResultSet rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L8032" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L8033">				mobileNo = rs.getString(&quot;mobile_no&quot;);</span>
			}
<span class="nc" id="L8035">		} catch (Exception e) {</span>
<span class="nc" id="L8036">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L8038">			DBConnect.closeCon(con);</span>
<span class="nc" id="L8039">		}</span>
<span class="nc" id="L8040">		return mobileNo;</span>
	}

	public static KenoPurchaseBean kenoSaleTxnStatusAndData(UserInfoBean userBean, String lmsTranxIdToReprint) {
<span class="nc" id="L8044">		KenoPurchaseBean kenoBean = new KenoPurchaseBean();</span>
<span class="nc" id="L8045">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L8046">		int gameNo = 0;</span>
<span class="nc" id="L8047">		String ticketNo = null;</span>
		try {
<span class="nc" id="L8049">			PreparedStatement pstmt = con.prepareStatement(</span>
					&quot;select retailer_user_id, retailer_org_id, game_id, transaction_date, transaction_type from st_lms_retailer_transaction_master where transaction_id=?&quot;);
<span class="nc" id="L8051">			pstmt.setString(1, lmsTranxIdToReprint);</span>
<span class="nc" id="L8052">			logger.debug(&quot;kenoSaleTxnStatusAndData query :&quot; + pstmt);</span>
<span class="nc" id="L8053">			ResultSet rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L8055" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L8056">				int retUserId = rs.getInt(&quot;retailer_user_id&quot;);</span>
<span class="nc" id="L8057">				int retOrgId = rs.getInt(&quot;retailer_org_id&quot;);</span>
<span class="nc" id="L8058">				gameNo = rs.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L8059">				String txnTime = rs.getString(&quot;transaction_date&quot;);</span>

<span class="nc" id="L8061">				kenoBean.setGame_no(gameNo);</span>
<span class="nc" id="L8062">				kenoBean.setGameDispName(Util.getGameDisplayName(gameNo));</span>
<span class="nc" id="L8063">				kenoBean.setPartyId(retOrgId);</span>
<span class="nc" id="L8064">				kenoBean.setUserId(retUserId);</span>
			}

<span class="nc" id="L8067">			pstmt = con.prepareStatement(&quot;select ticket_nbr from st_dg_ret_sale_? where transaction_id=?&quot;);</span>
<span class="nc" id="L8068">			pstmt.setInt(1, gameNo);</span>
<span class="nc" id="L8069">			pstmt.setString(2, lmsTranxIdToReprint);</span>
<span class="nc" id="L8070">			logger.debug(&quot;kenoSaleTxnStatusAndData ticket query :&quot; + pstmt);</span>
<span class="nc" id="L8071">			rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L8073" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L8074">				ticketNo = rs.getString(&quot;ticket_nbr&quot;);</span>
<span class="nc" id="L8075">				kenoBean.setTicket_no(ticketNo);</span>
			}

<span class="nc" id="L8078">			ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L8079">			ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L8080">			sReq.setServiceName(ServiceName.KENO);</span>
<span class="nc" id="L8081">			sReq.setServiceMethod(ServiceMethodName.KENO_SALE_TXN_STATUS_AND_DATA);</span>
<span class="nc" id="L8082">			sReq.setServiceData(kenoBean);</span>
<span class="nc" id="L8083">			IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L8084">			sRes = delegate.getResponse(sReq);</span>

<span class="nc bnc" id="L8086" title="All 2 branches missed.">			if (sRes.getIsSuccess()) {</span>
<span class="nc" id="L8087">				kenoBean = (KenoPurchaseBean) sRes.getResponseData();</span>
			}

<span class="nc" id="L8090">			kenoBean.setAdvMsg(Util.getAdvMessage(userBean.getUserOrgId(), gameNo, &quot;PLAYER&quot;, &quot;SALE&quot;, &quot;DG&quot;));</span>

			// -- Raffle Data
<span class="nc" id="L8093">			DrawGameRPOSHelper helper = new DrawGameRPOSHelper();</span>

<span class="nc bnc" id="L8095" title="All 4 branches missed.">			if (lmsTranxIdToReprint != null &amp;&amp; Integer.parseInt(lmsTranxIdToReprint) &gt; 0) {</span>
<span class="nc" id="L8096">				ticketNo = helper.getTicketNumberFrmTxnId(lmsTranxIdToReprint, userBean.getUserOrgId());</span>

			}

<span class="nc" id="L8100">			int mainTktGamenbr = helper.getGamenoFromTktnumber(ticketNo + &quot;00&quot;);</span>
<span class="nc" id="L8101">			List&lt;RafflePurchaseBean&gt; rafflePurchaseBeanList = new ArrayList&lt;RafflePurchaseBean&gt;();</span>
<span class="nc" id="L8102">			List&lt;String&gt; promoTicketList = orgOnLineSaleCreditUpdation.getAssociatedPromoTicket(ticketNo);</span>

<span class="nc bnc" id="L8104" title="All 4 branches missed.">			if (promoTicketList != null &amp;&amp; promoTicketList.size() &gt; 0) {</span>
<span class="nc" id="L8105">				String proMoTktNumber = promoTicketList.get(0);</span>
<span class="nc" id="L8106">				mainTktGamenbr = helper.getGamenoFromTktnumber(promoTicketList.get(0) + &quot;00&quot;);</span>
<span class="nc" id="L8107">				String gameType = Util.getGameType(mainTktGamenbr);</span>

<span class="nc bnc" id="L8109" title="All 2 branches missed.">				if (&quot;RAFFLE&quot;.equalsIgnoreCase(gameType)) {</span>
<span class="nc" id="L8110">					boolean isFirstTime = true;</span>
<span class="nc" id="L8111">					boolean isPwt = false;</span>
<span class="nc" id="L8112">					String tktNumber = proMoTktNumber + &quot;00&quot;;</span>

					String saleStatus;
<span class="nc" id="L8115">					sRes = new ServiceResponse();</span>
<span class="nc" id="L8116">					sReq = new ServiceRequest();</span>
<span class="nc" id="L8117">					delegate = ServiceDelegate.getInstance();</span>

<span class="nc" id="L8119">					RafflePurchaseBean rafflePurchaseBean = null;</span>
					// RafflePurchaseBean raffleGameBean = null;

<span class="nc" id="L8122">					ReprintBean reprintbean = new ReprintBean();</span>
<span class="nc" id="L8123">					String raffleTicketType = getRaffleTktTypeFromgameNbr(mainTktGamenbr, con);</span>
<span class="nc bnc" id="L8124" title="All 4 branches missed.">					if (isFirstTime || raffleTicketType.equalsIgnoreCase(&quot;REFERENCE&quot;)) {</span>
<span class="nc" id="L8125">						reprintbean.setPwt(isPwt);</span>
<span class="nc" id="L8126">						reprintbean.setTicketNumber(tktNumber);</span>
<span class="nc" id="L8127">						sReq.setServiceData(reprintbean);</span>
<span class="nc" id="L8128">						sReq.setServiceName(&quot;raffleGame&quot; + &quot;Module&quot;);</span>
<span class="nc" id="L8129">						sReq.setServiceMethod(&quot;getRaffleSaleTxnStatusAndData&quot;);</span>
<span class="nc" id="L8130">						sRes = delegate.getResponse(sReq);</span>
<span class="nc bnc" id="L8131" title="All 2 branches missed.">						if (sRes.getIsSuccess()) {</span>
<span class="nc" id="L8132">							rafflePurchaseBean = (RafflePurchaseBean) sRes.getResponseData();</span>
<span class="nc" id="L8133">							saleStatus = rafflePurchaseBean.getSaleStatus();</span>
<span class="nc" id="L8134">							rafflePurchaseBean.setRaffleTicketType(raffleTicketType);</span>
<span class="nc" id="L8135">							rafflePurchaseBean.setGame_no(kenoBean.getGame_no()); // to</span>
																					// be
																					// asked
						}
					}
<span class="nc" id="L8140">					rafflePurchaseBeanList.add(rafflePurchaseBean);</span>
				}
<span class="nc" id="L8142">				kenoBean.setRafflePurchaseBeanList(rafflePurchaseBeanList);</span>
			}
<span class="nc" id="L8144">		} catch (Exception e) {</span>
<span class="nc" id="L8145">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L8147">			DBConnect.closeCon(con);</span>
<span class="nc" id="L8148">		}</span>
<span class="nc" id="L8149">		return kenoBean;</span>
	}

	public static LottoPurchaseBean tanzanialottoSaleTxnStatusAndData(UserInfoBean userBean,
			String lmsTranxIdToReprint) {
<span class="nc" id="L8154">		LottoPurchaseBean lottoBean = new LottoPurchaseBean();</span>
<span class="nc" id="L8155">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L8156">		int gameNo = 0;</span>
<span class="nc" id="L8157">		String ticketNo = null;</span>
		try {
<span class="nc" id="L8159">			PreparedStatement pstmt = con.prepareStatement(</span>
					&quot;select retailer_user_id, retailer_org_id, game_id, transaction_date, transaction_type from st_lms_retailer_transaction_master where transaction_id=?&quot;);
<span class="nc" id="L8161">			pstmt.setString(1, lmsTranxIdToReprint);</span>
<span class="nc" id="L8162">			logger.debug(&quot;tanzanialottoSaleTxnStatusAndData query :&quot; + pstmt);</span>
<span class="nc" id="L8163">			ResultSet rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L8165" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L8166">				int retUserId = rs.getInt(&quot;retailer_user_id&quot;);</span>
<span class="nc" id="L8167">				int retOrgId = rs.getInt(&quot;retailer_org_id&quot;);</span>
<span class="nc" id="L8168">				gameNo = rs.getShort(&quot;game_id&quot;);</span>
				// String txnTime = rs.getString(&quot;transaction_date&quot;);

<span class="nc" id="L8171">				lottoBean.setGame_no(gameNo);</span>
<span class="nc" id="L8172">				lottoBean.setGameDispName(Util.getGameDisplayName(gameNo));</span>
<span class="nc" id="L8173">				lottoBean.setPartyId(retOrgId);</span>
<span class="nc" id="L8174">				lottoBean.setUserId(retUserId);</span>
			}

<span class="nc" id="L8177">			pstmt = con.prepareStatement(&quot;select ticket_nbr from st_dg_ret_sale_? where transaction_id=?&quot;);</span>
<span class="nc" id="L8178">			pstmt.setInt(1, gameNo);</span>
<span class="nc" id="L8179">			pstmt.setString(2, lmsTranxIdToReprint);</span>
<span class="nc" id="L8180">			logger.debug(&quot;kenoSaleTxnStatusAndData ticket query :&quot; + pstmt);</span>
<span class="nc" id="L8181">			rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L8183" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L8184">				ticketNo = rs.getString(&quot;ticket_nbr&quot;);</span>
<span class="nc" id="L8185">				lottoBean.setTicket_no(ticketNo);</span>
			}

<span class="nc" id="L8188">			ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L8189">			ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L8190">			sReq.setServiceName(ServiceName.TANZANIALOTTO);</span>
<span class="nc" id="L8191">			sReq.setServiceMethod(ServiceMethodName.TANZANIALOTTO_SALE_TXN_STATUS_AND_DATA);</span>
<span class="nc" id="L8192">			sReq.setServiceData(lottoBean);</span>
<span class="nc" id="L8193">			IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L8194">			sRes = delegate.getResponse(sReq);</span>

<span class="nc bnc" id="L8196" title="All 2 branches missed.">			if (sRes.getIsSuccess()) {</span>
<span class="nc" id="L8197">				lottoBean = (LottoPurchaseBean) sRes.getResponseData();</span>
			}

<span class="nc" id="L8200">			lottoBean.setAdvMsg(Util.getAdvMessage(userBean.getUserOrgId(), gameNo, &quot;PLAYER&quot;, &quot;SALE&quot;, &quot;DG&quot;));</span>

			// -- Raffle Data
<span class="nc" id="L8203">			DrawGameRPOSHelper helper = new DrawGameRPOSHelper();</span>

<span class="nc bnc" id="L8205" title="All 4 branches missed.">			if (lmsTranxIdToReprint != null &amp;&amp; Integer.parseInt(lmsTranxIdToReprint) &gt; 0) {</span>
<span class="nc" id="L8206">				ticketNo = helper.getTicketNumberFrmTxnId(lmsTranxIdToReprint, userBean.getUserOrgId());</span>

			}

<span class="nc" id="L8210">			int mainTktGamenbr = helper.getGamenoFromTktnumber(ticketNo + &quot;00&quot;);</span>
<span class="nc" id="L8211">			List&lt;RafflePurchaseBean&gt; rafflePurchaseBeanList = new ArrayList&lt;RafflePurchaseBean&gt;();</span>
<span class="nc" id="L8212">			List&lt;String&gt; promoTicketList = orgOnLineSaleCreditUpdation.getAssociatedPromoTicket(ticketNo);</span>

<span class="nc bnc" id="L8214" title="All 4 branches missed.">			if (promoTicketList != null &amp;&amp; promoTicketList.size() &gt; 0) {</span>
<span class="nc" id="L8215">				String proMoTktNumber = promoTicketList.get(0);</span>
<span class="nc" id="L8216">				mainTktGamenbr = helper.getGamenoFromTktnumber(promoTicketList.get(0) + &quot;00&quot;);</span>
<span class="nc" id="L8217">				String gameType = Util.getGameType(mainTktGamenbr);</span>

<span class="nc bnc" id="L8219" title="All 2 branches missed.">				if (&quot;RAFFLE&quot;.equalsIgnoreCase(gameType)) {</span>
<span class="nc" id="L8220">					boolean isFirstTime = true;</span>
<span class="nc" id="L8221">					boolean isPwt = false;</span>
<span class="nc" id="L8222">					String tktNumber = proMoTktNumber + &quot;00&quot;;</span>

					String saleStatus;
<span class="nc" id="L8225">					sRes = new ServiceResponse();</span>
<span class="nc" id="L8226">					sReq = new ServiceRequest();</span>
<span class="nc" id="L8227">					delegate = ServiceDelegate.getInstance();</span>

<span class="nc" id="L8229">					RafflePurchaseBean rafflePurchaseBean = null;</span>
					// RafflePurchaseBean raffleGameBean = null;

<span class="nc" id="L8232">					ReprintBean reprintbean = new ReprintBean();</span>
<span class="nc" id="L8233">					String raffleTicketType = getRaffleTktTypeFromgameNbr(mainTktGamenbr, con);</span>
<span class="nc bnc" id="L8234" title="All 4 branches missed.">					if (isFirstTime || raffleTicketType.equalsIgnoreCase(&quot;REFERENCE&quot;)) {</span>
<span class="nc" id="L8235">						reprintbean.setPwt(isPwt);</span>
<span class="nc" id="L8236">						reprintbean.setTicketNumber(tktNumber);</span>
<span class="nc" id="L8237">						sReq.setServiceData(reprintbean);</span>
<span class="nc" id="L8238">						sReq.setServiceName(&quot;raffleGame&quot; + &quot;Module&quot;);</span>
<span class="nc" id="L8239">						sReq.setServiceMethod(&quot;getRaffleSaleTxnStatusAndData&quot;);</span>
<span class="nc" id="L8240">						sRes = delegate.getResponse(sReq);</span>
<span class="nc bnc" id="L8241" title="All 2 branches missed.">						if (sRes.getIsSuccess()) {</span>
<span class="nc" id="L8242">							rafflePurchaseBean = (RafflePurchaseBean) sRes.getResponseData();</span>
<span class="nc" id="L8243">							saleStatus = rafflePurchaseBean.getSaleStatus();</span>
<span class="nc" id="L8244">							rafflePurchaseBean.setRaffleTicketType(raffleTicketType);</span>
<span class="nc" id="L8245">							rafflePurchaseBean.setGame_no(lottoBean.getGame_no()); // to</span>
																					// be
																					// asked
						}
					}
<span class="nc" id="L8250">					rafflePurchaseBeanList.add(rafflePurchaseBean);</span>
				}
<span class="nc" id="L8252">				lottoBean.setRafflePurchaseBeanList(rafflePurchaseBeanList);</span>
			}
<span class="nc" id="L8254">		} catch (Exception e) {</span>
<span class="nc" id="L8255">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L8257">			DBConnect.closeCon(con);</span>
<span class="nc" id="L8258">		}</span>
<span class="nc" id="L8259">		return lottoBean;</span>
	}

	public static LottoPurchaseBean bonusBalllottoSaleTxnStatusAndData(UserInfoBean userBean,
			String lmsTranxIdToReprint) {
<span class="nc" id="L8264">		LottoPurchaseBean lottoBean = new LottoPurchaseBean();</span>
<span class="nc" id="L8265">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L8266">		int gameNo = 0;</span>
<span class="nc" id="L8267">		String ticketNo = null;</span>
		try {
<span class="nc" id="L8269">			PreparedStatement pstmt = con.prepareStatement(</span>
					&quot;select retailer_user_id, retailer_org_id, game_id, transaction_date, transaction_type from st_lms_retailer_transaction_master where transaction_id=?&quot;);
<span class="nc" id="L8271">			pstmt.setString(1, lmsTranxIdToReprint);</span>
<span class="nc" id="L8272">			logger.debug(&quot;bonusBalllottoSaleTxnStatusAndData query :&quot; + pstmt);</span>
<span class="nc" id="L8273">			ResultSet rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L8275" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L8276">				int retUserId = rs.getInt(&quot;retailer_user_id&quot;);</span>
<span class="nc" id="L8277">				int retOrgId = rs.getInt(&quot;retailer_org_id&quot;);</span>
<span class="nc" id="L8278">				gameNo = rs.getInt(&quot;game_id&quot;);</span>
				// String txnTime = rs.getString(&quot;transaction_date&quot;);

<span class="nc" id="L8281">				lottoBean.setGame_no(gameNo);</span>
<span class="nc" id="L8282">				lottoBean.setGameDispName(Util.getGameDisplayName(gameNo));</span>
<span class="nc" id="L8283">				lottoBean.setPartyId(retOrgId);</span>
<span class="nc" id="L8284">				lottoBean.setUserId(retUserId);</span>
			}

<span class="nc" id="L8287">			pstmt = con.prepareStatement(&quot;select ticket_nbr from st_dg_ret_sale_? where transaction_id=?&quot;);</span>
<span class="nc" id="L8288">			pstmt.setInt(1, gameNo);</span>
<span class="nc" id="L8289">			pstmt.setString(2, lmsTranxIdToReprint);</span>
<span class="nc" id="L8290">			logger.debug(&quot;bonusBalllottoSaleTxnStatusAndData ticket query :&quot; + pstmt);</span>
<span class="nc" id="L8291">			rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L8293" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L8294">				ticketNo = rs.getString(&quot;ticket_nbr&quot;);</span>
<span class="nc" id="L8295">				lottoBean.setTicket_no(ticketNo);</span>
			}

<span class="nc" id="L8298">			ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L8299">			ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L8300">			sReq.setServiceName(ServiceName.BUNUSBALLLOTTO);</span>
<span class="nc" id="L8301">			sReq.setServiceMethod(ServiceMethodName.BONUSBALLLOTTO_SALE_TXN_STATUS_AND_DATA);</span>
<span class="nc" id="L8302">			sReq.setServiceData(lottoBean);</span>
<span class="nc" id="L8303">			IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L8304">			sRes = delegate.getResponse(sReq);</span>

<span class="nc bnc" id="L8306" title="All 2 branches missed.">			if (sRes.getIsSuccess()) {</span>
<span class="nc" id="L8307">				lottoBean = (LottoPurchaseBean) sRes.getResponseData();</span>
			}

<span class="nc" id="L8310">			lottoBean.setAdvMsg(Util.getAdvMessage(userBean.getUserOrgId(), gameNo, &quot;PLAYER&quot;, &quot;SALE&quot;, &quot;DG&quot;));</span>

			// -- Raffle Data
<span class="nc" id="L8313">			DrawGameRPOSHelper helper = new DrawGameRPOSHelper();</span>

<span class="nc bnc" id="L8315" title="All 4 branches missed.">			if (lmsTranxIdToReprint != null &amp;&amp; Integer.parseInt(lmsTranxIdToReprint) &gt; 0) {</span>
<span class="nc" id="L8316">				ticketNo = helper.getTicketNumberFrmTxnId(lmsTranxIdToReprint, userBean.getUserOrgId());</span>

			}

<span class="nc" id="L8320">			int mainTktGamenbr = helper.getGamenoFromTktnumber(ticketNo + &quot;00&quot;);</span>
<span class="nc" id="L8321">			List&lt;RafflePurchaseBean&gt; rafflePurchaseBeanList = new ArrayList&lt;RafflePurchaseBean&gt;();</span>
<span class="nc" id="L8322">			List&lt;String&gt; promoTicketList = orgOnLineSaleCreditUpdation.getAssociatedPromoTicket(ticketNo);</span>

<span class="nc bnc" id="L8324" title="All 4 branches missed.">			if (promoTicketList != null &amp;&amp; promoTicketList.size() &gt; 0) {</span>
<span class="nc" id="L8325">				String proMoTktNumber = promoTicketList.get(0);</span>
<span class="nc" id="L8326">				mainTktGamenbr = helper.getGamenoFromTktnumber(promoTicketList.get(0) + &quot;00&quot;);</span>
<span class="nc" id="L8327">				String gameType = Util.getGameType(mainTktGamenbr);</span>

<span class="nc bnc" id="L8329" title="All 2 branches missed.">				if (&quot;RAFFLE&quot;.equalsIgnoreCase(gameType)) {</span>
<span class="nc" id="L8330">					boolean isFirstTime = true;</span>
<span class="nc" id="L8331">					boolean isPwt = false;</span>
<span class="nc" id="L8332">					String tktNumber = proMoTktNumber + &quot;00&quot;;</span>

					String saleStatus;
<span class="nc" id="L8335">					sRes = new ServiceResponse();</span>
<span class="nc" id="L8336">					sReq = new ServiceRequest();</span>
<span class="nc" id="L8337">					delegate = ServiceDelegate.getInstance();</span>

<span class="nc" id="L8339">					RafflePurchaseBean rafflePurchaseBean = null;</span>
					// RafflePurchaseBean raffleGameBean = null;

<span class="nc" id="L8342">					ReprintBean reprintbean = new ReprintBean();</span>
<span class="nc" id="L8343">					String raffleTicketType = getRaffleTktTypeFromgameNbr(mainTktGamenbr, con);</span>
<span class="nc bnc" id="L8344" title="All 4 branches missed.">					if (isFirstTime || raffleTicketType.equalsIgnoreCase(&quot;REFERENCE&quot;)) {</span>
<span class="nc" id="L8345">						reprintbean.setPwt(isPwt);</span>
<span class="nc" id="L8346">						reprintbean.setTicketNumber(tktNumber);</span>
<span class="nc" id="L8347">						sReq.setServiceData(reprintbean);</span>
<span class="nc" id="L8348">						sReq.setServiceName(&quot;raffleGame&quot; + &quot;Module&quot;);</span>
<span class="nc" id="L8349">						sReq.setServiceMethod(&quot;getRaffleSaleTxnStatusAndData&quot;);</span>
<span class="nc" id="L8350">						sRes = delegate.getResponse(sReq);</span>
<span class="nc bnc" id="L8351" title="All 2 branches missed.">						if (sRes.getIsSuccess()) {</span>
<span class="nc" id="L8352">							rafflePurchaseBean = (RafflePurchaseBean) sRes.getResponseData();</span>
<span class="nc" id="L8353">							saleStatus = rafflePurchaseBean.getSaleStatus();</span>
<span class="nc" id="L8354">							rafflePurchaseBean.setRaffleTicketType(raffleTicketType);</span>
<span class="nc" id="L8355">							rafflePurchaseBean.setGame_no(lottoBean.getGame_no()); // to</span>
																					// be
																					// asked
						}
					}
<span class="nc" id="L8360">					rafflePurchaseBeanList.add(rafflePurchaseBean);</span>
				}
<span class="nc" id="L8362">				lottoBean.setRafflePurchaseBeanList(rafflePurchaseBeanList);</span>
			}
<span class="nc" id="L8364">		} catch (Exception e) {</span>
<span class="nc" id="L8365">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L8367">			DBConnect.closeCon(con);</span>
<span class="nc" id="L8368">		}</span>
<span class="nc" id="L8369">		return lottoBean;</span>
	}

	public static CancelTicketBean cancelTxnStatusAndData(UserInfoBean userBean, String lmsTranxIdToReprint) {
<span class="nc" id="L8373">		CancelTicketBean cancelBean = new CancelTicketBean();</span>
<span class="nc" id="L8374">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L8375">		int gameNo = 0;</span>
<span class="nc" id="L8376">		String ticketNo = null;</span>
		try {
<span class="nc" id="L8378">			PreparedStatement pstmt = con.prepareStatement(</span>
					&quot;select retailer_user_id, retailer_org_id, game_id, transaction_date, transaction_type from st_lms_retailer_transaction_master where transaction_id=?&quot;);
<span class="nc" id="L8380">			pstmt.setString(1, lmsTranxIdToReprint);</span>
<span class="nc" id="L8381">			logger.debug(&quot;cancelTxnStatusAndData query :&quot; + pstmt);</span>
<span class="nc" id="L8382">			ResultSet rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L8384" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L8385">				int retUserId = rs.getInt(&quot;retailer_user_id&quot;);</span>
<span class="nc" id="L8386">				int retOrgId = rs.getInt(&quot;retailer_org_id&quot;);</span>
<span class="nc" id="L8387">				gameNo = rs.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L8388">				String txnTime = rs.getString(&quot;transaction_date&quot;);</span>

<span class="nc" id="L8390">				cancelBean.setGameNo(gameNo);</span>
			}

<span class="nc" id="L8393">			pstmt = con.prepareStatement(&quot;select ticket_nbr from st_dg_ret_sale_refund_? where transaction_id=?&quot;);</span>
<span class="nc" id="L8394">			pstmt.setInt(1, gameNo);</span>
<span class="nc" id="L8395">			pstmt.setString(2, lmsTranxIdToReprint);</span>
<span class="nc" id="L8396">			logger.debug(&quot;cancelTxnStatusAndData ticket query :&quot; + pstmt);</span>
<span class="nc" id="L8397">			rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L8399" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L8400">				ticketNo = rs.getString(&quot;ticket_nbr&quot;);</span>
<span class="nc" id="L8401">				cancelBean.setTicketNo(ticketNo);</span>
			}

<span class="nc" id="L8404">			ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L8405">			ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L8406">			sReq.setServiceName(ServiceName.DRAWGAME);</span>
<span class="nc" id="L8407">			sReq.setServiceMethod(ServiceMethodName.CANCEL_TXN_STATUS_AND_DATA);</span>
<span class="nc" id="L8408">			sReq.setServiceData(cancelBean);</span>
<span class="nc" id="L8409">			IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L8410">			sRes = delegate.getResponse(sReq);</span>

<span class="nc bnc" id="L8412" title="All 2 branches missed.">			if (sRes.getIsSuccess()) {</span>
<span class="nc" id="L8413">				cancelBean = (CancelTicketBean) sRes.getResponseData();</span>
			}

<span class="nc" id="L8416">			cancelBean.setAdvMsg(Util.getAdvMessage(userBean.getUserOrgId(), gameNo, &quot;PLAYER&quot;, &quot;CANCEL&quot;, &quot;DG&quot;));</span>

<span class="nc" id="L8418">		} catch (Exception e) {</span>
<span class="nc" id="L8419">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L8421">			DBConnect.closeCon(con);</span>
<span class="nc" id="L8422">		}</span>
<span class="nc" id="L8423">		return cancelBean;</span>
	}

	public static PWTApiBean pwtTxnStatusAndData(UserInfoBean userBean, List&lt;Long&gt; lmsTranxIdList) {
<span class="nc" id="L8427">		PWTApiBean pwtApiBean = new PWTApiBean();</span>
<span class="nc" id="L8428">		Connection con = DBConnect.getConnection();</span>
		try {
<span class="nc" id="L8430">			PreparedStatement pstmt = null;</span>
<span class="nc" id="L8431">			double pwtAmt = 0.0;</span>
<span class="nc" id="L8432">			int gameNo = 0;</span>
<span class="nc bnc" id="L8433" title="All 2 branches missed.">			for (int i = 0; i &lt; lmsTranxIdList.size(); i++) {</span>
<span class="nc" id="L8434">				pstmt = con.prepareStatement(</span>
						&quot;select retailer_user_id, retailer_org_id, game_id, transaction_date, transaction_type from st_lms_retailer_transaction_master where transaction_id=?&quot;);
<span class="nc" id="L8436">				pstmt.setString(1, lmsTranxIdList.get(i) + &quot;&quot;);</span>
<span class="nc" id="L8437">				logger.debug(&quot;pwtTxnStatusAndData query :&quot; + pstmt);</span>
<span class="nc" id="L8438">				ResultSet rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L8440" title="All 2 branches missed.">				if (rs.next()) {</span>
<span class="nc" id="L8441">					int retUserId = rs.getInt(&quot;retailer_user_id&quot;);</span>
<span class="nc" id="L8442">					int retOrgId = rs.getInt(&quot;retailer_org_id&quot;);</span>
<span class="nc" id="L8443">					gameNo = rs.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L8444">					String txnTime = rs.getString(&quot;transaction_date&quot;);</span>
				}

<span class="nc" id="L8447">				pstmt = con.prepareStatement(</span>
						&quot;select retailer_user_id, retailer_org_id, draw_id, panel_id, game_id, pwt_amt, status from st_dg_ret_pwt_? where transaction_id = ?&quot;);
<span class="nc" id="L8449">				pstmt.setInt(1, gameNo);</span>
<span class="nc" id="L8450">				pstmt.setString(2, lmsTranxIdList.get(i) + &quot;&quot;);</span>
<span class="nc" id="L8451">				logger.debug(&quot;pwtTxnStatusAndData ticket query :&quot; + pstmt);</span>
<span class="nc" id="L8452">				rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L8454" title="All 2 branches missed.">				if (rs.next()) {</span>
<span class="nc" id="L8455">					int drawId = rs.getInt(&quot;draw_id&quot;);</span>
<span class="nc" id="L8456">					int panelId = rs.getInt(&quot;panel_id&quot;);</span>
<span class="nc" id="L8457">					int gameId = rs.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L8458">					pwtAmt = pwtAmt + rs.getDouble(&quot;pwt_amt&quot;);</span>
<span class="nc" id="L8459">					String status = rs.getString(&quot;status&quot;);</span>
				}
			}

<span class="nc" id="L8463">			pwtApiBean.setTotalWinning(pwtAmt + &quot;&quot;);</span>

<span class="nc" id="L8465">		} catch (Exception e) {</span>
<span class="nc" id="L8466">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L8468">			DBConnect.closeCon(con);</span>
<span class="nc" id="L8469">		}</span>
<span class="nc" id="L8470">		return pwtApiBean;</span>
	}

	/**
	 * Use When Connection is not Available
	 * 
	 * @param userBean
	 * @param lastPrintedTicket
	 * @param interfaceType
	 * @param refMerchantId
	 * @param autoCancelHoldDays
	 * @param actionName
	 * @param gameId
	 * @throws LMSException
	 */
	public void checkLastPrintedTicketStatusAndUpdate(UserInfoBean userBean, long lastPrintedTicket,
			String interfaceType, String refMerchantId, int autoCancelHoldDays, String actionName, int gameId)
			throws LMSException {
<span class="nc" id="L8488">		Connection con = null;</span>
		/*
		 * PreparedStatement pstmt = null; ResultSet rs = null;
		 * PreparedStatement insPstmt=null;
		 * 
		 * long lastSoldTicket=0; String ticketstatus=null;
		 */

		try {
<span class="nc" id="L8497">			con = getConnectionObject();</span>
			/// Method Called With Connection
<span class="nc" id="L8499">			checkLastPrintedTicketStatusAndUpdate(userBean, lastPrintedTicket, interfaceType, refMerchantId,</span>
					autoCancelHoldDays, actionName, gameId, con);
			/*
			 * if(&quot;TERMINAL&quot;.equals(interfaceType)){ pstmt=con.
			 * prepareStatement(&quot;select terminal_ticket_number,terminal_ticket_status from st_dg_last_sold_ticket where ret_org_id=?&quot;
			 * ); pstmt.setInt(1, userBean.getUserOrgId());
			 * rs=pstmt.executeQuery(); if(rs.next()){
			 * lastSoldTicket=rs.getLong(&quot;terminal_ticket_number&quot;);
			 * ticketstatus=rs.getString(&quot;terminal_ticket_status&quot;); }else {
			 * throw new LMSException(&quot;DATA_ERROR&quot;); }
			 * 
			 * }else if(&quot;WEB&quot;.equals(interfaceType)){ pstmt=con.
			 * prepareStatement(&quot;select web_ticket_number,web_ticket_status from st_dg_last_sold_ticket where ret_org_id=?&quot;
			 * ); pstmt.setInt(1, userBean.getUserOrgId());
			 * rs=pstmt.executeQuery(); if(rs.next()){
			 * lastSoldTicket=rs.getLong(&quot;web_ticket_number&quot;);
			 * ticketstatus=rs.getString(&quot;web_ticket_status&quot;); }else { throw new
			 * LMSException(&quot;DATA_ERROR&quot;); // Next Sale not allowed } }
			 * 
			 * logger.debug(&quot;SALE_AUTO_CANCEL_LOGS: lastSoldTicket&quot;
			 * +lastSoldTicket+&quot; last printed tickets&quot;+lastPrintedTicket);
			 * 
			 * 
			 * if(lastPrintedTicket !=0 &amp;&amp; lastSoldTicket ==0 ){ throw new
			 * LMSException(&quot;DATA_ERROR&quot;); // Next Sale not allowed }else
			 * if(lastPrintedTicket ==0 &amp;&amp; lastSoldTicket !=0 ){ //No Action
			 * sale Continue }else if(lastPrintedTicket == lastSoldTicket &amp;&amp;
			 * &quot;SOLD&quot;.equals(ticketstatus)){ insPstmt=con.
			 * prepareStatement(&quot;insert into st_dg_printed_tickets_?(retailer_org_id,ticket_nbr,channel,notification_time,action_name)values(?,?,?,?,?)&quot;
			 * ); insPstmt.setInt(1, gameId); insPstmt.setInt(2,
			 * userBean.getUserOrgId()); insPstmt.setLong(3, lastPrintedTicket);
			 * insPstmt.setString(4, interfaceType); insPstmt.setTimestamp(5,
			 * Util.getCurrentTimeStamp()); insPstmt.setString(6, actionName);
			 * insPstmt.executeUpdate();
			 * 
			 * insPstmt=con.
			 * prepareStatement(&quot;update st_dg_last_sold_ticket set &quot;
			 * +interfaceType.toLowerCase()
			 * +&quot;_ticket_status='PRINTED' where ret_org_id=?&quot;);
			 * insPstmt.setInt(1, userBean.getUserOrgId());
			 * insPstmt.executeUpdate(); }else if(lastPrintedTicket !=
			 * lastSoldTicket &amp;&amp; &quot;SOLD&quot;.equals(ticketstatus)){ //auto cancel
			 * ticket CancelTicketBean cancelTicketBean = new
			 * CancelTicketBean();
			 * //cancelTicketBean.setDrawIdTableMap(drawIdTableMap);
			 * cancelTicketBean.setTicketNo(lastSoldTicket +
			 * Util.getRpcAppenderForTickets(String.valueOf(lastSoldTicket).
			 * length())); cancelTicketBean.setPartyId(userBean.getUserOrgId());
			 * cancelTicketBean.setPartyType(userBean.getUserType());
			 * cancelTicketBean.setUserId(userBean.getUserId());
			 * cancelTicketBean.setCancelChannel(&quot;LMS_Terminal&quot;);
			 * cancelTicketBean.setRefMerchantId(refMerchantId);
			 * cancelTicketBean.setAutoCancel(true);
			 * cancelTicketBean.setHoldAutoCancel(true);
			 * cancelTicketBean.setAutoCancelHoldDays(autoCancelHoldDays); //
			 * cancel code pending for review and prefer create new method for
			 * auto cancel
			 * 
			 * cancelTicketBean = cancelTicket(cancelTicketBean, userBean,
			 * true,&quot;CANCEL_MISMATCH&quot;); logger.debug(&quot;SALE_AUTO_CANCEL_LOGS:&quot; +
			 * &quot;is cancelled &quot; + cancelTicketBean.isValid() + &quot; :Ticket_number&quot;
			 * + lastSoldTicket);
			 * 
			 * 
			 * //insert last printed tickets insPstmt=con.
			 * prepareStatement(&quot;insert into st_dg_printed_tickets_?(retailer_org_id,ticket_nbr,channel,notification_time,action_name)values(?,?,?,?,?)&quot;
			 * ); insPstmt.setInt(1, gameId); insPstmt.setInt(2,
			 * userBean.getUserOrgId()); insPstmt.setLong(3, lastPrintedTicket);
			 * insPstmt.setString(4, interfaceType); insPstmt.setTimestamp(5,
			 * Util.getCurrentTimeStamp()); insPstmt.setString(6, actionName);
			 * insPstmt.executeUpdate();
			 * 
			 * //status update cancelled insPstmt=con.
			 * prepareStatement(&quot;update st_dg_last_sold_ticket set &quot;
			 * +interfaceType.toLowerCase()
			 * +&quot;_ticket_status='CANCELLED' where ret_org_id=?&quot;);
			 * insPstmt.setInt(1, userBean.getUserOrgId());
			 * insPstmt.executeUpdate();
			 * 
			 * 
			 * } con.commit();
			 */
<span class="nc" id="L8581">		} catch (Exception e) {</span>
<span class="nc" id="L8582">			e.printStackTrace();</span>
<span class="nc" id="L8583">			throw new LMSException(&quot;SQL_ERROR&quot;);</span>
		} finally {
<span class="nc" id="L8585">			DBConnect.closeCon(con);</span>
<span class="nc" id="L8586">		}</span>

<span class="nc" id="L8588">	}</span>

	public void getUnsoldTkts(int gameNo, String startDate, String endDate) {
<span class="nc" id="L8591">		logger.debug(&quot;data to getUnsoldTkts: &quot; + gameNo + &quot;,&quot; + startDate + &quot;,&quot; + endDate);</span>
<span class="nc" id="L8592">		ArrayList&lt;CancelTicketBean&gt; tktList = new ArrayList&lt;CancelTicketBean&gt;();</span>
<span class="nc" id="L8593">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L8594">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L8595">		ResultSet rs = null;</span>
<span class="nc" id="L8596">		String refMerchantId = (String) LMSUtility.sc.getAttribute(&quot;REF_MERCHANT_ID&quot;);</span>
		UserInfoBean userBean;
		CancelTicketBean cancelBean;
		try {
<span class="nc" id="L8600">			String query = &quot;select sale_tkt, retailer_user_id, retailer_org_id, parent_id, organization_type from (select sale_tkt, retailer_user_id, retailer_org_id, parent_id, organization_type from&quot;</span>
					+ &quot; (select ticket_nbr sale_tkt, rtm.retailer_user_id, rtm.retailer_org_id, om.parent_id, um.organization_type from st_dg_ret_sale_&quot;
					+ gameNo
					+ &quot; sale inner join st_lms_retailer_transaction_master rtm inner join st_lms_transaction_master tm inner join st_lms_organization_master om inner join st_lms_user_master um on um.user_id = rtm.retailer_user_id and om.organization_id = rtm.retailer_org_id and sale.transaction_id=rtm.transaction_id and rtm.transaction_id=tm.transaction_id&quot;
					+ &quot; where transaction_date&gt;='&quot; + startDate + &quot;' and transaction_date&lt;='&quot; + endDate
					+ &quot;' and interface='TERMINAL') sale left outer join (select ticket_nbr refund_tkt from st_dg_ret_sale_refund_&quot;
					+ gameNo
					+ &quot; sale inner join st_lms_retailer_transaction_master rtm inner join st_lms_transaction_master tm on sale.transaction_id=rtm.transaction_id and rtm.transaction_id=tm.transaction_id where transaction_date&gt;='&quot;
					+ startDate + &quot;' and transaction_date&lt;='&quot; + endDate
					+ &quot;' and interface='TERMINAL') refund on sale_tkt=refund_tkt where refund_tkt is null) sale left outer join (select ticket_nbr term_tkt from st_dg_terminal_sale_ticket_&quot;
					+ gameNo + &quot; where purchase_time&gt;='&quot; + startDate + &quot;' and purchase_time&lt;='&quot; + endDate
					+ &quot;') termSale on  sale_tkt=term_tkt where term_tkt is null&quot;;
<span class="nc" id="L8612">			logger.debug(&quot;query to fetch unsold tickets: &quot; + query);</span>
<span class="nc" id="L8613">			pstmt = con.prepareStatement(query);</span>
<span class="nc" id="L8614">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L8615" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L8616">				userBean = new UserInfoBean();</span>
<span class="nc" id="L8617">				cancelBean = new CancelTicketBean();</span>
<span class="nc" id="L8618">				String tktNo = rs.getString(&quot;sale_tkt&quot;);</span>
<span class="nc" id="L8619">				userBean.setUserId(rs.getInt(&quot;retailer_user_id&quot;));</span>
<span class="nc" id="L8620">				userBean.setUserOrgId(rs.getInt(&quot;retailer_org_id&quot;));</span>
<span class="nc" id="L8621">				userBean.setParentOrgId(rs.getInt(&quot;parent_id&quot;));</span>
<span class="nc" id="L8622">				cancelBean.setTicketNo(tktNo + &quot;00&quot;);</span>
<span class="nc" id="L8623">				cancelBean.setGameNo(gameNo);</span>
<span class="nc" id="L8624">				cancelBean.setPartyId(userBean.getUserOrgId());</span>
<span class="nc" id="L8625">				cancelBean.setPartyType(rs.getString(&quot;organization_type&quot;));</span>
<span class="nc" id="L8626">				cancelBean.setUserId(userBean.getUserId());</span>
<span class="nc" id="L8627">				cancelBean.setCancelChannel(&quot;LMS_Terminal&quot;);</span>
<span class="nc" id="L8628">				cancelBean.setRefMerchantId(refMerchantId);</span>
<span class="nc" id="L8629">				cancelBean.setAutoCancel(&quot;CANCEL_PRINTER&quot;);</span>
<span class="nc" id="L8630">				cancelBean.setAutoCancel(true);</span>
<span class="nc bnc" id="L8631" title="All 2 branches missed.">				if (!getLastSoldTicketNO(userBean, &quot;LMS_Terminal&quot;).equals(tktNo)) {</span>
<span class="nc" id="L8632">					cancelTicket(cancelBean, userBean, true, &quot;CANCEL_MISMATCH&quot;);</span>
				}
<span class="nc" id="L8634">			}</span>
			/*
			 * if(!tktList.isEmpty()){ IServiceDelegate delegate =
			 * ServiceDelegate.getInstance(); ServiceRequest req = new
			 * ServiceRequest(); req.setServiceName(ServiceName.DRAWGAME);
			 * req.setServiceMethod(ServiceMethodName.DRAW_CANCEL_AFTER_FREEZE);
			 * req.setServiceData(tktList); delegate.getResponse(req); }
			 */
<span class="nc" id="L8642">		} catch (Exception e) {</span>
<span class="nc" id="L8643">			e.printStackTrace();</span>
<span class="nc" id="L8644">		}</span>
<span class="nc" id="L8645">	}</span>

	public void insertLastSoldTicket(int userOrgId, String ticketNo) {

<span class="nc" id="L8649">		String query = &quot;update st_dg_last_sold_ticket set ticket_number = &quot; + ticketNo + &quot; where ret_org_id = &quot;</span>
				+ userOrgId;
<span class="nc" id="L8651">		int rowInserted = 0;</span>
<span class="nc" id="L8652">		PreparedStatement pstmt = null;</span>
		try {
<span class="nc" id="L8654">			Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L8655">			con.setAutoCommit(false);</span>
<span class="nc" id="L8656">			pstmt = con.prepareStatement(query);</span>
<span class="nc" id="L8657">			pstmt.executeUpdate();</span>

<span class="nc" id="L8659">			logger.debug(&quot;Last Sold ticket Insertion query &gt;&gt;&quot; + pstmt);</span>
<span class="nc" id="L8660">			rowInserted = pstmt.executeUpdate();</span>
<span class="nc bnc" id="L8661" title="All 2 branches missed.">			if (rowInserted &gt; 0) {</span>
<span class="nc" id="L8662">				con.commit();</span>
			}
<span class="nc" id="L8664">			DBConnect.closeCon(con);</span>
<span class="nc" id="L8665">		} catch (Exception e) {</span>
<span class="nc" id="L8666">			e.printStackTrace();</span>
<span class="nc" id="L8667">		}</span>
<span class="nc" id="L8668">	}</span>

	/**
	 * Use with Connection Parameter
	 * 
	 * @param userBean
	 * @param lastPrintedTicket
	 * @param interfaceType
	 * @param refMerchantId
	 * @param autoCancelHoldDays
	 * @param actionName
	 * @param gameId
	 * @param con
	 * @throws LMSException
	 */
	public void checkLastPrintedTicketStatusAndUpdate(UserInfoBean userBean, long lastPrintedTicket,
			String interfaceType, String refMerchantId, int autoCancelHoldDays, String actionName, int gameId,
			Connection con) throws LMSException {

<span class="nc" id="L8687">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L8688">		ResultSet rs = null;</span>
<span class="nc" id="L8689">		PreparedStatement insPstmt = null;</span>

<span class="nc" id="L8691">		long lastSoldTicket = 0;</span>
<span class="nc" id="L8692">		String ticketstatus = null;</span>

		try {

<span class="nc bnc" id="L8696" title="All 2 branches missed.">			if (&quot;TERMINAL&quot;.equals(interfaceType)) {</span>
<span class="nc" id="L8697">				pstmt = con.prepareStatement(</span>
						&quot;select terminal_ticket_number,terminal_ticket_status from st_dg_last_sold_ticket where ret_org_id=?&quot;);
<span class="nc" id="L8699">				pstmt.setInt(1, userBean.getUserOrgId());</span>
<span class="nc" id="L8700">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L8701" title="All 2 branches missed.">				if (rs.next()) {</span>
<span class="nc" id="L8702">					lastSoldTicket = rs.getLong(&quot;terminal_ticket_number&quot;);</span>
<span class="nc" id="L8703">					ticketstatus = rs.getString(&quot;terminal_ticket_status&quot;);</span>
				} else {
<span class="nc" id="L8705">					throw new LMSException(&quot;DATA_ERROR&quot;);</span>
				}

<span class="nc bnc" id="L8708" title="All 2 branches missed.">			} else if (&quot;WEB&quot;.equals(interfaceType)) {</span>
<span class="nc" id="L8709">				pstmt = con.prepareStatement(</span>
						&quot;select web_ticket_number,web_ticket_status from st_dg_last_sold_ticket where ret_org_id=?&quot;);
<span class="nc" id="L8711">				pstmt.setInt(1, userBean.getUserOrgId());</span>
<span class="nc" id="L8712">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L8713" title="All 2 branches missed.">				if (rs.next()) {</span>
<span class="nc" id="L8714">					lastSoldTicket = rs.getLong(&quot;web_ticket_number&quot;);</span>
<span class="nc" id="L8715">					ticketstatus = rs.getString(&quot;web_ticket_status&quot;);</span>
				} else {
<span class="nc" id="L8717">					throw new LMSException(&quot;DATA_ERROR&quot;); // Next Sale not</span>
															// allowed
				}
			}

<span class="nc" id="L8722">			logger.info(&quot;SALE_AUTO_CANCEL_LOGS: lastSoldTicket&quot; + lastSoldTicket + &quot; last printed tickets&quot;</span>
					+ lastPrintedTicket);

<span class="nc bnc" id="L8725" title="All 4 branches missed.">			if (lastPrintedTicket != 0 &amp;&amp; lastSoldTicket == 0) {</span>
				// throw new LMSException(&quot;DATA_ERROR&quot;); // Next Sale not
				// allowed
<span class="nc" id="L8728">				logger.info(&quot;ERROR_USER_NAME: &quot; + userBean.getUserName());</span>
				try {
<span class="nc" id="L8730">					checkTicketIfValid(lastPrintedTicket, gameId, con);</span>
<span class="nc" id="L8731">				} catch (LMSException e) {</span>
<span class="nc" id="L8732">					logger.info(&quot;INSIDE LMS EXCEPTION  ERROR_USER_NAME: &quot; + userBean.getUserName());</span>
<span class="nc bnc" id="L8733" title="All 2 branches missed.">					if (e.getErrorCode() != LMSErrors.INVALID_SERVICE_ON_TICKET_ERROR_CODE) {</span>
<span class="nc" id="L8734">						logger.info(&quot;INSIDE  LMSErrors.INVALID_SERVICE_ON_TICKET_ERROR_CODE BLOCK  ERROR_USER_NAME: &quot;</span>
								+ userBean.getUserName());
						return; // Next Sale allowed
					}
<span class="nc" id="L8738">				}</span>
<span class="nc" id="L8739">				throw new LMSException(&quot;DATA_ERROR&quot;); // Next Sale not allowed</span>
<span class="nc bnc" id="L8740" title="All 4 branches missed.">			} else if (lastPrintedTicket == 0 &amp;&amp; lastSoldTicket != 0) {</span>
				// No Action sale Continue
<span class="nc bnc" id="L8742" title="All 4 branches missed.">			} else if (lastPrintedTicket == lastSoldTicket &amp;&amp; &quot;SOLD&quot;.equals(ticketstatus)) {</span>
<span class="nc" id="L8743">				insPstmt = con.prepareStatement(</span>
						&quot;insert into st_dg_printed_tickets_?(retailer_org_id,ticket_nbr,channel,notification_time,action_name)values(?,?,?,?,?)&quot;);
<span class="nc" id="L8745">				insPstmt.setInt(1, gameId);</span>
<span class="nc" id="L8746">				insPstmt.setInt(2, userBean.getUserOrgId());</span>
<span class="nc" id="L8747">				insPstmt.setLong(3, lastPrintedTicket);</span>
<span class="nc" id="L8748">				insPstmt.setString(4, interfaceType);</span>
<span class="nc" id="L8749">				insPstmt.setTimestamp(5, Util.getCurrentTimeStamp());</span>
<span class="nc" id="L8750">				insPstmt.setString(6, actionName);</span>
<span class="nc" id="L8751">				insPstmt.executeUpdate();</span>

<span class="nc" id="L8753">				insPstmt = con.prepareStatement(&quot;update st_dg_last_sold_ticket set &quot; + interfaceType.toLowerCase()</span>
						+ &quot;_ticket_status='PRINTED' where ret_org_id=?&quot;);
<span class="nc" id="L8755">				insPstmt.setInt(1, userBean.getUserOrgId());</span>
<span class="nc" id="L8756">				insPstmt.executeUpdate();</span>
<span class="nc bnc" id="L8757" title="All 4 branches missed.">			} else if (lastPrintedTicket != lastSoldTicket &amp;&amp; &quot;SOLD&quot;.equals(ticketstatus)) {</span>

				// CHECK IF TKT EXISTS IN SYSTEM ??
<span class="nc" id="L8760">				checkTicketIfValid(lastPrintedTicket, gameId, con);</span>

				// auto cancel ticket
<span class="nc" id="L8763">				CancelTicketBean cancelTicketBean = new CancelTicketBean();</span>
				// cancelTicketBean.setDrawIdTableMap(drawIdTableMap);
<span class="nc" id="L8765">				cancelTicketBean.setTicketNo(</span>
						lastSoldTicket + Util.getRpcAppenderForTickets(String.valueOf(lastSoldTicket).length()));
<span class="nc" id="L8767">				cancelTicketBean.setPartyId(userBean.getUserOrgId());</span>
<span class="nc" id="L8768">				cancelTicketBean.setPartyType(userBean.getUserType());</span>
<span class="nc" id="L8769">				cancelTicketBean.setUserId(userBean.getUserId());</span>
<span class="nc" id="L8770">				cancelTicketBean.setCancelChannel(&quot;LMS_Terminal&quot;);</span>
<span class="nc" id="L8771">				cancelTicketBean.setRefMerchantId(refMerchantId);</span>
<span class="nc" id="L8772">				cancelTicketBean.setAutoCancel(true);</span>
<span class="nc" id="L8773">				cancelTicketBean.setHoldAutoCancel(true);</span>
<span class="nc" id="L8774">				cancelTicketBean.setAutoCancelHoldDays(autoCancelHoldDays);</span>
				// cancel code pending for review and prefer create new method
				// for auto cancel

<span class="nc" id="L8778">				cancelTicketBean = cancelTicket(cancelTicketBean, userBean, true, &quot;CANCEL_MISMATCH&quot;);</span>
<span class="nc" id="L8779">				logger.debug(&quot;SALE_AUTO_CANCEL_LOGS:&quot; + &quot;is cancelled &quot; + cancelTicketBean.isValid() + &quot; :Ticket_number&quot;</span>
						+ lastSoldTicket);

				// insert last printed tickets
<span class="nc" id="L8783">				insPstmt = con.prepareStatement(</span>
						&quot;insert into st_dg_printed_tickets_?(retailer_org_id,ticket_nbr,channel,notification_time,action_name)values(?,?,?,?,?)&quot;);
<span class="nc" id="L8785">				insPstmt.setInt(1, gameId);</span>
<span class="nc" id="L8786">				insPstmt.setInt(2, userBean.getUserOrgId());</span>
<span class="nc" id="L8787">				insPstmt.setLong(3, lastPrintedTicket);</span>
<span class="nc" id="L8788">				insPstmt.setString(4, interfaceType);</span>
<span class="nc" id="L8789">				insPstmt.setTimestamp(5, Util.getCurrentTimeStamp());</span>
<span class="nc" id="L8790">				insPstmt.setString(6, actionName);</span>
<span class="nc" id="L8791">				insPstmt.executeUpdate();</span>

				// status update cancelled
<span class="nc" id="L8794">				insPstmt = con.prepareStatement(&quot;update st_dg_last_sold_ticket set &quot; + interfaceType.toLowerCase()</span>
						+ &quot;_ticket_status='CANCELLED' where ret_org_id=?&quot;);
<span class="nc" id="L8796">				insPstmt.setInt(1, userBean.getUserOrgId());</span>
<span class="nc" id="L8797">				insPstmt.executeUpdate();</span>

			}
<span class="nc" id="L8800">			con.commit();</span>
<span class="nc" id="L8801">		} catch (Exception e) {</span>
<span class="nc" id="L8802">			logger.error(&quot;Exception &quot;, e);</span>
			// e.printStackTrace();

			try {
<span class="nc" id="L8806">				con.rollback();</span>
<span class="nc" id="L8807">			} catch (SQLException er) {</span>
<span class="nc" id="L8808">				logger.error(&quot;SQLException &quot;, er);</span>
				// er.printStackTrace();
<span class="nc" id="L8810">			}</span>
<span class="nc" id="L8811">			throw new LMSException(&quot;SQL_ERROR&quot;);</span>
		} finally {
<span class="nc" id="L8813">			DBConnect.closeRs(rs);</span>
<span class="nc" id="L8814">			DBConnect.closePstmt(pstmt);</span>
<span class="nc" id="L8815">			DBConnect.closePstmt(insPstmt);</span>
<span class="nc" id="L8816">		}</span>
<span class="nc" id="L8817">	}</span>

	public void insertEntryIntoPrintedTktTableForWeb(int gameId, int userOrgId, long lastPrintedTkt,
			String interfaceType, Timestamp currentTimestamp, String actionName) throws Exception {
<span class="nc" id="L8821">		PreparedStatement insPstmt = null;</span>
<span class="nc" id="L8822">		PreparedStatement selPstmt = null;</span>
<span class="nc" id="L8823">		ResultSet rsSelPstmt = null;</span>
<span class="nc" id="L8824">		Connection con = null;</span>
		try {

<span class="nc bnc" id="L8827" title="All 2 branches missed.">			if (lastPrintedTkt != 0) {</span>
				// No Action sale Continue

<span class="nc" id="L8830">				con = getConnectionObject();</span>

<span class="nc" id="L8832">				selPstmt = con.prepareStatement(</span>
						&quot;SELECT auto_id FROM st_dg_last_sold_ticket lst, st_dg_printed_tickets_? pt where lst.web_ticket_number = ? and  pt.ticket_nbr = ? and lst.web_ticket_status='PRINTED'&quot;);
<span class="nc" id="L8834">				selPstmt.setInt(1, gameId);</span>
<span class="nc" id="L8835">				selPstmt.setLong(2, lastPrintedTkt);</span>
<span class="nc" id="L8836">				selPstmt.setLong(3, lastPrintedTkt);</span>
<span class="nc" id="L8837">				rsSelPstmt = selPstmt.executeQuery();</span>

<span class="nc bnc" id="L8839" title="All 2 branches missed.">				if (!rsSelPstmt.next()) {</span>
<span class="nc" id="L8840">					insPstmt = con.prepareStatement(</span>
							&quot;insert into st_dg_printed_tickets_?(retailer_org_id,ticket_nbr,channel,notification_time,action_name)values(?,?,?,?,?)&quot;);
<span class="nc" id="L8842">					insPstmt.setInt(1, gameId);</span>
<span class="nc" id="L8843">					insPstmt.setInt(2, userOrgId);</span>
<span class="nc" id="L8844">					insPstmt.setLong(3, lastPrintedTkt);</span>
<span class="nc" id="L8845">					insPstmt.setString(4, interfaceType);</span>
<span class="nc" id="L8846">					insPstmt.setTimestamp(5, currentTimestamp);</span>
<span class="nc" id="L8847">					insPstmt.setString(6, actionName);</span>
<span class="nc" id="L8848">					insPstmt.executeUpdate();</span>

<span class="nc" id="L8850">					insPstmt = con.prepareStatement(&quot;update st_dg_last_sold_ticket set &quot; + interfaceType.toLowerCase()</span>
							+ &quot;_ticket_status='PRINTED' where ret_org_id=?&quot;);
<span class="nc" id="L8852">					insPstmt.setInt(1, userOrgId);</span>
<span class="nc" id="L8853">					insPstmt.executeUpdate();</span>
<span class="nc" id="L8854">					con.commit();</span>
<span class="nc" id="L8855">					logger.debug(&quot;Cancel MISMATCH Case by WEB for userOrgId = &quot; + userOrgId + &quot;; timestamp = &quot;</span>
							+ currentTimestamp + &quot;&quot;);
				}
			}
<span class="nc" id="L8859">		} catch (Exception e) {</span>
<span class="nc" id="L8860">			e.printStackTrace();</span>
<span class="nc" id="L8861">			throw e;</span>
		} finally {
<span class="nc" id="L8863">			DBConnect.closeCon(con);</span>
<span class="nc" id="L8864">		}</span>
<span class="nc" id="L8865">	}</span>

	private void checkTicketIfValid(long tktNbr, int gameId, Connection con) throws LMSException {

<span class="nc" id="L8869">		ResultSet rs = null;</span>
<span class="nc" id="L8870">		String checkQuery = null;</span>
<span class="nc" id="L8871">		String serviceCode = null;</span>
<span class="nc" id="L8872">		PreparedStatement pstmt = null;</span>
		try {
			// CAN ALSO CHECK VALIDATE TIKCET Util.validateTkt(tktNum);
<span class="nc" id="L8875">			logger.info(&quot;INSIDE TKT VALIDATE... &quot;);</span>
			// GET SERVICE CODE FROM SERVICE ID AND DECIDE THE SALE TABLE (EX:-
			// if DG then , st_dg_ret_sale_GAMEID)
<span class="nc" id="L8878">			serviceCode = &quot;DG&quot;;</span>
<span class="nc bnc" id="L8879" title="All 2 branches missed.">			if (serviceCode == null) {</span>
<span class="nc" id="L8880">				throw new LMSException(LMSErrors.INVALID_SERVICE_ON_TICKET_ERROR_CODE,</span>
						LMSErrors.INVALID_SERVICE_ON_TICKET_ERROR_MESSAGE);
<span class="nc bnc" id="L8882" title="All 2 branches missed.">			} else if (serviceCode.equalsIgnoreCase(&quot;DG&quot;)) {</span>
<span class="nc" id="L8883">				checkQuery = &quot;select transaction_id from st_dg_ret_sale_? where ticket_nbr = ?&quot;;</span>
<span class="nc bnc" id="L8884" title="All 2 branches missed.">			} else if (serviceCode.equalsIgnoreCase(&quot;SL&quot;)) {</span>
				// DECIDE THE QUREY OR SALE TABLE HERE
			} else {
<span class="nc" id="L8887">				throw new LMSException(LMSErrors.INVALID_SERVICE_ON_TICKET_ERROR_CODE,</span>
						LMSErrors.INVALID_SERVICE_ON_TICKET_ERROR_MESSAGE);
			}

<span class="nc" id="L8891">			pstmt = con.prepareStatement(checkQuery);</span>
<span class="nc" id="L8892">			pstmt.setInt(1, gameId);</span>
<span class="nc" id="L8893">			pstmt.setString(2, String.valueOf(tktNbr));</span>
<span class="nc" id="L8894">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L8895" title="All 2 branches missed.">			if (!rs.next()) {</span>
<span class="nc" id="L8896">				throw new LMSException(LMSErrors.INVALID_TICKET_ERROR_CODE, LMSErrors.INVALID_TICKET_ERROR_MESSAGE);</span>
			}
<span class="nc" id="L8898">		} catch (LMSException e) {</span>
<span class="nc" id="L8899">			throw e;</span>
<span class="nc" id="L8900">		} catch (Exception e) {</span>
<span class="nc" id="L8901">			throw new LMSException(LMSErrors.GENERAL_EXCEPTION_ERROR_CODE, LMSErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
		} finally {
<span class="nc" id="L8903">			DBConnect.closeRs(rs);</span>
<span class="nc" id="L8904">			DBConnect.closePstmt(pstmt);</span>
<span class="nc" id="L8905">		}</span>
<span class="nc" id="L8906">	}</span>

	public static String embdDgData(boolean isOffline, Map&lt;Integer, Map&lt;Integer, String&gt;&gt; drawIdTableMap, int userId,
			int orgId, double version, Connection con) throws LMSException {
		/// Connection con = DBConnect.getConnection();
<span class="nc" id="L8911">		String addQry = &quot;&quot;;</span>
<span class="nc" id="L8912">		StringBuilder returnData = null;</span>
<span class="nc bnc" id="L8913" title="All 2 branches missed.">		if (isOffline) {</span>
<span class="nc" id="L8914">			addQry = &quot; (is_offline = 'Y' and game_nbr in(select promo_game_id from st_dg_promo_scheme ps inner join st_dg_game_master gm on sale_game_id=game_nbr where ps.status='ACTIVE')) or &quot;;</span>
		}

<span class="nc" id="L8917">		Map&lt;Integer, StringBuilder&gt; gameData = new HashMap&lt;Integer, StringBuilder&gt;();</span>
<span class="nc" id="L8918">		Map&lt;Integer, Integer&gt; offlineFzTimeMap = new HashMap&lt;Integer, Integer&gt;();</span>
<span class="nc" id="L8919">		Map&lt;Integer, Double&gt; retSaleComm = new HashMap&lt;Integer, Double&gt;();</span>
<span class="nc" id="L8920">		OfflineRetailerBean retBean = new OfflineRetailerBean();</span>
<span class="nc" id="L8921">		retBean.setVersion(version);</span>
		try {
<span class="nc" id="L8923">			String selQry = &quot;select game_id,game_name_dev,game_name,game_nbr,offline_freeze_time,retailer_sale_comm_rate,ifnull(promo_game_type,'STANDARD') game_type,ifnull(raffle_ticket_type,0) raffle_ticket_type from st_dg_game_master left outer join st_dg_promo_scheme ps on game_id=promo_game_id and ps.status='ACTIVE' where &quot;</span>
					+ addQry + &quot; game_status!='SALE_CLOSE' order by game_nbr&quot;;

<span class="nc" id="L8926">			PreparedStatement pstmt = con.prepareStatement(selQry);</span>
<span class="nc" id="L8927">			ResultSet rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L8928" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L8929">				String gameName = rs.getString(&quot;game_name_dev&quot;);</span>
<span class="nc bnc" id="L8930" title="All 4 branches missed.">				if (version &lt; 5.8 &amp;&amp; &quot;SuperTwo&quot;.equalsIgnoreCase(gameName)) {</span>
<span class="nc" id="L8931">					continue;</span>
				}

<span class="nc" id="L8934">				returnData = new StringBuilder(&quot;&quot;);</span>
<span class="nc" id="L8935">				int gameId = rs.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L8936">				returnData.append(gameName + &quot;,&quot;);</span>
<span class="nc" id="L8937">				returnData.append(rs.getString(&quot;game_name&quot;) + &quot;,&quot;);</span>
<span class="nc" id="L8938">				returnData.append(gameId + &quot;,&quot;);</span>
<span class="nc" id="L8939">				String gameType = rs.getString(&quot;game_type&quot;);</span>

<span class="nc bnc" id="L8941" title="All 2 branches missed.">				if (&quot;STANDARD&quot;.equalsIgnoreCase(gameType)) {</span>
<span class="nc" id="L8942">					returnData.append(&quot;0,&quot;);</span>
<span class="nc bnc" id="L8943" title="All 2 branches missed.">				} else if (&quot;RAFFLE&quot;.equalsIgnoreCase(gameType)) {</span>
<span class="nc" id="L8944">					returnData.append(&quot;1,&quot;);</span>
<span class="nc bnc" id="L8945" title="All 2 branches missed.">				} else if (&quot;PROMO&quot;.equalsIgnoreCase(gameType)) {</span>
<span class="nc" id="L8946">					returnData.append(&quot;2,&quot;);</span>
				}

<span class="nc bnc" id="L8949" title="All 2 branches missed.">				if (version &gt; 5.6) {</span>
<span class="nc" id="L8950">					String raffleType = rs.getString(&quot;raffle_ticket_type&quot;);</span>
<span class="nc bnc" id="L8951" title="All 2 branches missed.">					if (&quot;REFERENCE&quot;.equalsIgnoreCase(raffleType)) {</span>
<span class="nc" id="L8952">						returnData.append(&quot;2,&quot;);</span>
<span class="nc bnc" id="L8953" title="All 2 branches missed.">					} else if (&quot;ORIGINAL&quot;.equalsIgnoreCase(raffleType)) {</span>
<span class="nc" id="L8954">						returnData.append(&quot;1,&quot;);</span>
					} else {
<span class="nc" id="L8956">						returnData.append(&quot;0,&quot;);</span>
					}
				}
<span class="nc" id="L8959">				returnData.append(&quot;totalDraw,&quot;); // Number</span>
				// of
				// Active
				// Draws

<span class="nc bnc" id="L8964" title="All 4 branches missed.">				if (version &lt;= 6.5 &amp;&amp; &quot;FortuneTwo&quot;.equalsIgnoreCase(gameName)) {</span>
<span class="nc" id="L8965">					Map&lt;String, BetDetailsBean&gt; priceMap = Util.getGameMap().get(gameId).getPriceMap();</span>
<span class="nc" id="L8966">					Iterator&lt;String&gt; betTypeIter = priceMap.keySet().iterator();</span>
<span class="nc" id="L8967">					String betType = null;</span>
<span class="nc bnc" id="L8968" title="All 2 branches missed.">					while (betTypeIter.hasNext()) {</span>
<span class="nc" id="L8969">						betType = betTypeIter.next();</span>
<span class="nc bnc" id="L8970" title="All 2 branches missed.">						if (!(betType.contains(&quot;Banker&quot;))) {</span>
<span class="nc" id="L8971">							returnData.append(priceMap.get(betType).getUnitPrice() + &quot;:&quot;);</span>
						}
					}
<span class="nc" id="L8974">					returnData.deleteCharAt(returnData.length() - 1);</span>
<span class="nc" id="L8975">					returnData.append(&quot;,&quot;);</span>

<span class="nc bnc" id="L8977" title="All 4 branches missed.">				} else if (version &lt;= 6.5 &amp;&amp; &quot;FortuneThree&quot;.equalsIgnoreCase(gameName)) {</span>
<span class="nc" id="L8978">					Map&lt;String, BetDetailsBean&gt; priceMap = Util.getGameMap().get(gameId).getPriceMap();</span>
<span class="nc" id="L8979">					Iterator&lt;String&gt; betTypeIter = priceMap.keySet().iterator();</span>
<span class="nc" id="L8980">					String betType = null;</span>
<span class="nc bnc" id="L8981" title="All 2 branches missed.">					while (betTypeIter.hasNext()) {</span>
<span class="nc" id="L8982">						betType = betTypeIter.next();</span>
<span class="nc bnc" id="L8983" title="All 2 branches missed.">						if (!(betType.contains(&quot;Banker&quot;))) {</span>
<span class="nc" id="L8984">							returnData.append(priceMap.get(betType).getUnitPrice() + &quot;:&quot;);</span>
						}
					}
<span class="nc" id="L8987">					returnData.deleteCharAt(returnData.length() - 1);</span>
<span class="nc" id="L8988">					returnData.append(&quot;,&quot;);</span>
<span class="nc" id="L8989">				}</span>

				else {
					// returnData.append(Util.convertCollToStr(new
					// TreeMap&lt;String,
					// BetDetailsBean&gt;(Util.getGameMap().get(gameName).getPriceMap()).values()).replace(&quot;,
					// &quot;, &quot;:&quot;) + &quot;,&quot;);

<span class="nc" id="L8997">					Map&lt;String, BetDetailsBean&gt; map1 = new TreeMap&lt;String, BetDetailsBean&gt;(</span>
							Util.getGameMap().get(gameId).getPriceMap());
<span class="nc" id="L8999">					ValueComparator comparator = new ValueComparator(map1);</span>
<span class="nc" id="L9000">					Map&lt;String, BetDetailsBean&gt; map2 = new TreeMap&lt;String, BetDetailsBean&gt;(comparator);</span>
<span class="nc" id="L9001">					map2.putAll(map1);</span>
<span class="nc" id="L9002">					Iterator&lt;String&gt; iterator = map2.keySet().iterator();</span>
<span class="nc bnc" id="L9003" title="All 2 branches missed.">					while (iterator.hasNext()) {</span>
<span class="nc" id="L9004">						BetDetailsBean bean = map1.get(iterator.next());</span>
<span class="nc bnc" id="L9005" title="All 2 branches missed.">						if (&quot;ACTIVE&quot;.equals(bean.getBetStatus()))</span>
							// returnData.append(bean.getUnitPrice()).append(&quot;~&quot;).append(bean.getMaxBetAmtMultiple()).append(&quot;~&quot;).append((bean.getBetStatus()
							// ==
							// null)?&quot;&quot;:(bean.getBetStatus().equals(&quot;ACTIVE&quot;))?1:0).append(&quot;(&quot;).append(bean.getBetCode()).append(&quot;-&quot;).append(bean.getBetOrder()).append(&quot;)&quot;).append(&quot;:&quot;);
<span class="nc" id="L9009">							returnData.append(bean.getBetCode()).append(&quot;~&quot;).append(bean.getUnitPrice()).append(&quot;~&quot;)</span>
									.append(bean.getMaxBetAmtMultiple()).append(&quot;:&quot;);
<span class="nc" id="L9011">					}</span>
<span class="nc" id="L9012">					returnData.deleteCharAt(returnData.length() - 1);</span>
<span class="nc" id="L9013">					returnData.append(&quot;,&quot;);</span>
				}

<span class="nc" id="L9016">				gameData.put(gameId, returnData);</span>
<span class="nc" id="L9017">				offlineFzTimeMap.put(gameId, rs.getInt(&quot;offline_freeze_time&quot;));</span>
<span class="nc" id="L9018">				retSaleComm.put(gameId, Util.getSaleCommVariance(orgId, rs.getInt(&quot;game_id&quot;)));</span>
<span class="nc" id="L9019">			}</span>

<span class="nc" id="L9021">			retBean.setUserId(userId);</span>
<span class="nc" id="L9022">			retBean.setGameData(gameData);</span>
<span class="nc" id="L9023">			retBean.setOffline(isOffline);</span>
<span class="nc" id="L9024">			retBean.setOfflineFzTimeMap(offlineFzTimeMap);</span>
<span class="nc" id="L9025">			retBean.setRetSaleComm(retSaleComm);</span>
<span class="nc" id="L9026">			retBean.setPartyType(&quot;RETAILER&quot;);</span>
<span class="nc" id="L9027">			IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L9028">			ServiceRequest req = new ServiceRequest();</span>
<span class="nc" id="L9029">			req.setServiceName(ServiceName.DRAWGAME);</span>
<span class="nc" id="L9030">			req.setServiceMethod(ServiceMethodName.FETCH_DG_DATA_OFFLINE);</span>
<span class="nc" id="L9031">			req.setServiceData(retBean);</span>

<span class="nc" id="L9033">			ServiceResponse resp = delegate.getResponse(req);</span>
<span class="nc bnc" id="L9034" title="All 2 branches missed.">			if (resp.getIsSuccess()) {</span>
<span class="nc" id="L9035">				retBean = (OfflineRetailerBean) resp.getResponseData();</span>
			} else {
<span class="nc" id="L9037">				throw new LMSException(&quot;Some Error&quot;);</span>
			}

<span class="nc" id="L9040">			gameData = retBean.getGameData();</span>
<span class="nc" id="L9041">			returnData = new StringBuilder(&quot;&quot;);</span>
<span class="nc" id="L9042">			Iterator&lt;Map.Entry&lt;Integer, StringBuilder&gt;&gt; itr = gameData.entrySet().iterator();</span>
<span class="nc bnc" id="L9043" title="All 2 branches missed.">			while (itr.hasNext()) {</span>
<span class="nc" id="L9044">				Map.Entry&lt;Integer, StringBuilder&gt; pair = itr.next();</span>
<span class="nc" id="L9045">				returnData.append(pair.getValue() + &quot;#&quot;);</span>
<span class="nc" id="L9046">			}</span>
<span class="nc" id="L9047">			returnData.deleteCharAt(returnData.length() - 1);</span>

<span class="nc bnc" id="L9049" title="All 2 branches missed.">			if (isOffline) {</span>
<span class="nc" id="L9050">				returnData.append(&quot;|PromoInfo:&quot;);</span>
<span class="nc" id="L9051">				selQry = &quot;select scheme_id,sale_game_id,promo_game_id,sale_ticket_amt,if(valid_for_draw='INDOOR',1,if(valid_for_draw='OUTDOOR',0,2)) valid_for_draw from st_dg_promo_scheme where status='ACTIVE'&quot;;</span>
<span class="nc" id="L9052">				pstmt = con.prepareStatement(selQry);</span>
<span class="nc" id="L9053">				rs = pstmt.executeQuery();</span>
<span class="nc" id="L9054">				boolean isPromo = false;</span>
<span class="nc bnc" id="L9055" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L9056">					isPromo = true;</span>
<span class="nc" id="L9057">					returnData.append(rs.getString(&quot;scheme_id&quot;) + &quot;,&quot;);</span>
<span class="nc" id="L9058">					returnData.append(rs.getString(&quot;sale_game_id&quot;) + &quot;,&quot;);</span>
<span class="nc" id="L9059">					returnData.append(rs.getString(&quot;promo_game_id&quot;) + &quot;,&quot;);</span>
<span class="nc" id="L9060">					returnData.append(rs.getString(&quot;sale_ticket_amt&quot;) + &quot;,&quot;);</span>
<span class="nc" id="L9061">					returnData.append(rs.getString(&quot;valid_for_draw&quot;) + &quot;#&quot;);</span>
				}
<span class="nc bnc" id="L9063" title="All 2 branches missed.">				if (isPromo) {</span>
<span class="nc" id="L9064">					returnData.deleteCharAt(returnData.length() - 1);</span>
				} else {
<span class="nc" id="L9066">					returnData.delete(returnData.length() - &quot;|PromoInfo:&quot;.length(), returnData.length());</span>
				}
			}
<span class="nc" id="L9069">			logger.debug(&quot;***Game Info for Ret User**&quot; + userId + &quot;****&quot; + returnData + &quot;****&quot;);</span>
<span class="nc" id="L9070">		} catch (Exception e) {</span>
<span class="nc" id="L9071">			e.printStackTrace();</span>
<span class="nc" id="L9072">			throw new LMSException(&quot;Some Error&quot;);</span>
<span class="nc" id="L9073">		} finally {</span>
			// DBConnect.closeCon(con);
<span class="nc" id="L9075">		}</span>
<span class="nc" id="L9076">		return returnData.toString();</span>
	}

	public static Map&lt;Integer, List&lt;PromoGameBean&gt;&gt; getPromoGameBeanMap(Connection con) throws SQLException {

<span class="nc" id="L9081">		Map&lt;Integer, List&lt;PromoGameBean&gt;&gt; promoGameBeanMap = new HashMap&lt;Integer, List&lt;PromoGameBean&gt;&gt;();</span>
<span class="nc" id="L9082">		Statement stmt = con.createStatement();</span>
<span class="nc" id="L9083">		ResultSet gameRs = stmt.executeQuery(</span>
				&quot;select game_id,game_name_dev,game_name from st_dg_game_master where game_status !='SALE_CLOSE'&quot;);
<span class="nc bnc" id="L9085" title="All 2 branches missed.">		while (gameRs.next()) {</span>
<span class="nc" id="L9086">			PreparedStatement promoPstmt = con.prepareStatement(</span>
					&quot;select promo_game_id,promo_ticket_type,promo_game_type,no_of_free_tickets,no_of_draws,game_name_dev as promo_game_name,game_name promo_display_name from st_dg_promo_scheme ps,st_dg_game_master gm where ps.scheme_id=gm.game_id and sale_game_id=&quot;
							+ gameRs.getShort(&quot;game_id&quot;) + &quot;  and status='ACTIVE'&quot;);
<span class="nc" id="L9089">			ResultSet rs = promoPstmt.executeQuery();</span>
<span class="nc" id="L9090">			PromoGameBean promoBean = null;</span>
<span class="nc" id="L9091">			List&lt;PromoGameBean&gt; promoGameList = new ArrayList&lt;PromoGameBean&gt;();</span>
<span class="nc" id="L9092">			String gameName = gameRs.getString(&quot;game_name&quot;);</span>
<span class="nc bnc" id="L9093" title="All 2 branches missed.">			while (rs.next()) {</span>

<span class="nc" id="L9095">				promoBean = new PromoGameBean();</span>
<span class="nc" id="L9096">				promoBean.setPromoGameNo(rs.getInt(&quot;promo_game_id&quot;));</span>
<span class="nc" id="L9097">				promoBean.setPromoGametype(rs.getString(&quot;promo_game_type&quot;));</span>
<span class="nc" id="L9098">				promoBean.setPromoTicketType(rs.getString(&quot;promo_ticket_type&quot;));</span>
<span class="nc" id="L9099">				promoBean.setPromoGameDisplayName(rs.getString(&quot;promo_display_name&quot;));</span>
<span class="nc bnc" id="L9100" title="All 2 branches missed.">				if (rs.getString(&quot;promo_game_name&quot;) != null) {</span>
<span class="nc" id="L9101">					promoBean.setPromoGameName(rs.getString(&quot;promo_game_name&quot;));</span>
				}
<span class="nc bnc" id="L9103" title="All 2 branches missed.">				if (rs.getString(&quot;no_of_free_tickets&quot;) != null) {</span>
<span class="nc" id="L9104">					promoBean.setNoOfPromoTickets(rs.getInt(&quot;no_of_free_tickets&quot;));</span>
				}
<span class="nc bnc" id="L9106" title="All 2 branches missed.">				if (rs.getString(&quot;no_of_draws&quot;) != null) {</span>
<span class="nc" id="L9107">					promoBean.setNoOfDraws(rs.getInt(&quot;no_of_draws&quot;));</span>
				}
<span class="nc bnc" id="L9109" title="All 2 branches missed.">				if (gameName != null) {</span>
<span class="nc" id="L9110">					promoBean.setMainGameName(gameName);</span>
				}

<span class="nc" id="L9113">				promoGameList.add(promoBean);</span>
			}
<span class="nc" id="L9115">			promoGameBeanMap.put(gameRs.getInt(&quot;game_id&quot;), promoGameList);</span>

<span class="nc" id="L9117">		}</span>
<span class="nc" id="L9118">		return promoGameBeanMap;</span>
	}

	public String buildTwelveByTwentyFourData(KenoPurchaseBean kenoPurchaseBean, UserInfoBean userBean) {
<span class="nc" id="L9122">		String time = kenoPurchaseBean.getPurchaseTime().replace(&quot; &quot;, &quot;|Time:&quot;).replace(&quot;.0&quot;, &quot;&quot;);</span>
<span class="nc" id="L9123">		double bal = userBean.getAvailableCreditLimit() - userBean.getClaimableBal();</span>
<span class="nc" id="L9124">		String advMsgString = Utility.getPropertyValue(&quot;ADV_MESSAGE_FOR_PROMO_GAME&quot;);</span>
<span class="nc" id="L9125">		String topAdvMsg = &quot;&quot;;</span>
<span class="nc" id="L9126">		String bottomAdvMsg = &quot;&quot;;</span>
<span class="nc" id="L9127">		String tempMsg = &quot;&quot;;</span>

<span class="nc" id="L9129">		NumberFormat nf = NumberFormat.getInstance();</span>
<span class="nc" id="L9130">		nf.setMinimumFractionDigits(2);</span>

<span class="nc" id="L9132">		String balance = nf.format(bal).replaceAll(&quot;,&quot;, &quot;&quot;);</span>

<span class="nc" id="L9134">		int listSize = kenoPurchaseBean.getDrawDateTime().size();</span>
<span class="nc" id="L9135">		StringBuilder drawTimeBuild = new StringBuilder(&quot;&quot;);</span>

<span class="nc bnc" id="L9137" title="All 2 branches missed.">		for (int i = 0; i &lt; listSize; i++) {</span>
<span class="nc" id="L9138">			drawTimeBuild.append((&quot;|DrawDate:&quot; + kenoPurchaseBean.getDrawDateTime().get(i)).replaceFirst(&quot; &quot;, &quot;#&quot;)</span>
					.replace(&quot;#&quot;, &quot;|DrawTime:&quot;).replace(&quot;&amp;&quot;, &quot;|DrawId:&quot;).replace(&quot;.0&quot;, &quot;&quot;));
		}
<span class="nc" id="L9141">		StringBuilder finalData = new StringBuilder(&quot;&quot;);</span>
<span class="nc" id="L9142">		finalData.append(&quot;|PromoTkt:&quot;);</span>

		// if (userBean.getTerminalBuildVersion() &lt;
		// Double.parseDouble(Utility.getPropertyValue(&quot;CURRENT_TERMINAL_BUILD_VERSION&quot;))
		// &amp;&amp; &quot;NIGERIA&quot;.equals(countryDeployed))
		// finalData.append(&quot;TicketNo:&quot; + kenoPurchaseBean.getTicket_no() +
		// kenoPurchaseBean.getReprintCount() +
		// ((kenoPurchaseBean.getTicket_no() +
		// kenoPurchaseBean.getReprintCount()).length() ==
		// ConfigurationVariables.tktLenB &amp;&amp;
		// LMSFilterDispatcher.isBarCodeRequired ?
		// kenoPurchaseBean.getBarcodeCount() : &quot;&quot;) + &quot;|Date:&quot; + time);
		// else
<span class="nc bnc" id="L9155" title="All 2 branches missed.">		finalData.append(&quot;TicketNo:&quot; + kenoPurchaseBean.getTicket_no() + kenoPurchaseBean.getReprintCount() + &quot;|brCd:&quot;</span>
				+ kenoPurchaseBean.getTicket_no() + kenoPurchaseBean.getReprintCount()
				+ ((ConfigurationVariables.currentTktLen == ConfigurationVariables.tktLenB
						&amp;&amp; LMSFilterDispatcher.isBarCodeRequired) ? kenoPurchaseBean.getBarcodeCount() : &quot;&quot;)
				+ &quot;|Date:&quot; + time);
<span class="nc" id="L9160">		int noOfPanels = kenoPurchaseBean.getNoOfPanel();</span>
<span class="nc" id="L9161">		String[] playTypeStr = kenoPurchaseBean.getPlayType();</span>
<span class="nc bnc" id="L9162" title="All 2 branches missed.">		for (int i = 0; i &lt; noOfPanels; i++) {</span>
<span class="nc" id="L9163">			String panelPrice = &quot;|PanelPrice:&quot;</span>
					+ nf.format(kenoPurchaseBean.getBetAmountMultiple()[i] * kenoPurchaseBean.getUnitPrice()[i]
							* kenoPurchaseBean.getNoOfLines()[i] * kenoPurchaseBean.getNoOfDraws()).replaceAll(&quot;,&quot;, &quot;&quot;);
<span class="nc" id="L9166">			finalData.append(&quot;|PlayType:&quot; + playTypeStr[i] + &quot;|Num:&quot; + kenoPurchaseBean.getPlayerData()[i] + panelPrice</span>
					+ &quot;|QP:&quot; + kenoPurchaseBean.getIsQuickPick()[i]);
		}
<span class="nc" id="L9169">		finalData.append(&quot;|TicketCost:&quot;).append(nf.format(kenoPurchaseBean.getTotalPurchaseAmt()).replaceAll(&quot;,&quot;, &quot;&quot;))</span>
				.append(drawTimeBuild.toString()).append(&quot;|balance:&quot;).append(balance).append(&quot;|&quot;);
		// 15@TOP~Top Message1|Top Message2&amp;Bottom~Bottom Message1|Bottom
		// Message2
<span class="nc bnc" id="L9173" title="All 2 branches missed.">		if (advMsgString != null) {</span>
<span class="nc" id="L9174">			String gameArr[] = advMsgString.split(&quot;#&quot;); // 15@TOP~Top</span>
														// Message1|Top
														// Message2&amp;Bottom~Bottom
														// Message1|Bottom
														// Message2
<span class="nc bnc" id="L9179" title="All 2 branches missed.">			for (int iLoop = 0; iLoop &lt; gameArr.length; iLoop++) {</span>
<span class="nc" id="L9180">				String gameWiseArr[] = gameArr[iLoop].split(&quot;@&quot;);</span>
<span class="nc bnc" id="L9181" title="All 2 branches missed.">				if (Integer.parseInt(gameWiseArr[0]) == kenoPurchaseBean.getGameId()) { // TOP~Top</span>
																						// Message1|Top
																						// Message2&amp;Bottom~Bottom
																						// Message1|Bottom
																						// Message2
<span class="nc" id="L9186">					String msgArr[] = gameWiseArr[1].split(&quot;&amp;&quot;);</span>
<span class="nc bnc" id="L9187" title="All 2 branches missed.">					for (int jLoop = 0; jLoop &lt; msgArr.length; jLoop++) {</span>
<span class="nc" id="L9188">						tempMsg = &quot;&quot;;</span>
<span class="nc" id="L9189">						String msgType[] = msgArr[jLoop].split(&quot;~&quot;);</span>
<span class="nc" id="L9190">						String msg[] = msgType[1].split(&quot;\\|&quot;);</span>
<span class="nc bnc" id="L9191" title="All 2 branches missed.">						for (int kLoop = 0; kLoop &lt; msg.length; kLoop++) {</span>
<span class="nc" id="L9192">							tempMsg += msg[kLoop] + &quot;~&quot;;</span>
						}
<span class="nc" id="L9194">						tempMsg = tempMsg.substring(0, tempMsg.length() - 1);</span>
<span class="nc bnc" id="L9195" title="All 2 branches missed.">						if (&quot;TOP&quot;.equalsIgnoreCase(msgType[0])) {</span>
<span class="nc" id="L9196">							topAdvMsg = &quot;topAdvMsg:&quot; + tempMsg + &quot;|&quot;;</span>
<span class="nc bnc" id="L9197" title="All 2 branches missed.">						} else if (&quot;Bottom&quot;.equalsIgnoreCase(msgType[0])) {</span>
<span class="nc" id="L9198">							bottomAdvMsg = &quot;bottomAdvMsg:&quot; + tempMsg + &quot;|&quot;;</span>
						}
					}
				}
			}
		}
<span class="nc" id="L9204">		return finalData.toString() + topAdvMsg + bottomAdvMsg;</span>
	}

	public void cancelPromoTkts(UserInfoBean userInfoBean, KenoPurchaseBean promoPurchaseBean) throws LMSException {
<span class="nc" id="L9208">		CancelTicketBean cancelTicketBean = null;</span>
<span class="nc" id="L9209">		int barCodeCount = -1;</span>
<span class="nc" id="L9210">		String ticketNo = null;</span>

		try {
			// Cancelling Promo Tkt
<span class="nc" id="L9214">			ticketNo = promoPurchaseBean.getTicket_no()</span>
					+ Util.getRpcAppenderForTickets(promoPurchaseBean.getTicket_no().length());
<span class="nc" id="L9216">			cancelTicketBean = new CancelTicketBean();</span>
<span class="nc" id="L9217">			cancelTicketBean.setBarCodeCount(barCodeCount);</span>
<span class="nc" id="L9218">			cancelTicketBean.setTicketNo(ticketNo);</span>
<span class="nc" id="L9219">			cancelTicketBean.setPartyId(userInfoBean.getUserOrgId());</span>
<span class="nc" id="L9220">			cancelTicketBean.setPartyType(userInfoBean.getUserType());</span>
<span class="nc" id="L9221">			cancelTicketBean.setUserId(userInfoBean.getUserId());</span>
<span class="nc" id="L9222">			cancelTicketBean.setCancelChannel(promoPurchaseBean.getPurchaseChannel());</span>
<span class="nc" id="L9223">			cancelTicketBean.setRefMerchantId(promoPurchaseBean.getRefMerchantId());</span>
<span class="nc" id="L9224">			cancelTicketBean.setAutoCancel(true);</span>
<span class="nc" id="L9225">			cancelTicketBean = cancelTicket(cancelTicketBean, userInfoBean, true, &quot;CANCEL_SERVER&quot;);</span>

			/*
			 * //Cancelling Main Tkt, Will Also Cancel Attached Promo Tkt
			 * ticketNo = mainPurchaseBean.getTicket_no() +
			 * Util.getRpcAppenderForTickets(mainPurchaseBean.getTicket_no().
			 * length()); cancelTicketBean = new CancelTicketBean();
			 * cancelTicketBean.setBarCodeCount(barCodeCount);
			 * cancelTicketBean.setTicketNo(ticketNo);
			 * cancelTicketBean.setPartyId(userInfoBean.getUserOrgId());
			 * cancelTicketBean.setPartyType(userInfoBean.getUserType());
			 * cancelTicketBean.setUserId(userInfoBean.getUserId());
			 * cancelTicketBean.setCancelChannel(mainPurchaseBean.
			 * getPurchaseChannel());
			 * cancelTicketBean.setRefMerchantId(mainPurchaseBean.
			 * getRefMerchantId()); cancelTicketBean.setAutoCancel(true);
			 * cancelTicketBean = cancelTicket(cancelTicketBean, userInfoBean,
			 * true, &quot;CANCEL_SERVER&quot;);
			 */

<span class="nc" id="L9245">		} catch (Exception e) {</span>
<span class="nc" id="L9246">			e.printStackTrace();</span>
<span class="nc" id="L9247">			throw new LMSException(LMSErrors.GENERAL_EXCEPTION_ERROR_CODE, LMSErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="nc" id="L9248">		}</span>
<span class="nc" id="L9249">	}</span>

	public static boolean checkMandatoryDownload(int userId, double terminal_version, Connection con) {

<span class="nc" id="L9253">		boolean status = false;</span>
<span class="nc" id="L9254">		Statement st = null;</span>
<span class="nc" id="L9255">		ResultSet rs = null;</span>
<span class="nc" id="L9256">		String isMandatory = &quot;&quot;;</span>
<span class="nc" id="L9257">		String isDownloadAvailable = &quot;&quot;;</span>
<span class="nc" id="L9258">		double version = 0.00;</span>

		try {
<span class="nc" id="L9261">			String checkMandatoryDownload = &quot;select hd.isMandatory mandatory, rom.is_download_available download_available, rom.expected_version current_version  from st_lms_ret_offline_master rom inner join st_lms_htpos_download hd on rom.expected_version = hd.version where rom.user_id = &quot;</span>
					+ userId
					+ &quot; and device_id = (select device_id from st_lms_htpos_device_master where device_type = rom.device_type);&quot;;

<span class="nc" id="L9265">			st = con.createStatement();</span>

<span class="nc" id="L9267">			rs = st.executeQuery(checkMandatoryDownload);</span>

<span class="nc bnc" id="L9269" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L9270">				isMandatory = rs.getString(&quot;mandatory&quot;);</span>
<span class="nc" id="L9271">				isDownloadAvailable = rs.getString(&quot;download_available&quot;);</span>
<span class="nc" id="L9272">				version = rs.getDouble(&quot;current_version&quot;);</span>
			}

<span class="nc bnc" id="L9275" title="All 8 branches missed.">			status = (terminal_version == version || terminal_version &gt; version) ? true</span>
					: (&quot;YES&quot;.equalsIgnoreCase(isDownloadAvailable)
							? (&quot;YES&quot;.equalsIgnoreCase(isMandatory) ? false : true) : true);

<span class="nc" id="L9279">		} catch (Exception e) {</span>
			// TODO: handle exception
<span class="nc" id="L9281">		}</span>
<span class="nc" id="L9282">		return status;</span>
	}

	public static PwtVerifyTicketBean payTpPwt(String verCode, PwtVerifyTicketBean pwtBean, UserInfoBean userInfoBean)
			throws LMSException {
<span class="nc" id="L9287">		JSONObject requestObject = new JSONObject();</span>
<span class="nc" id="L9288">		ServiceRequest sReq = null;</span>
<span class="nc" id="L9289">		Connection con = null;</span>
		List&lt;Long&gt; refTransId;
		try {
<span class="nc" id="L9292">			con = getConnectionObject();</span>
<span class="nc" id="L9293">			refTransId = pwtMgmtDaoImpl.getInstance().payTpPwtProcessAtLMS(verCode, pwtBean, userInfoBean, con);</span>
<span class="nc" id="L9294">			pwtBean.setRecieptNumber(String.valueOf(refTransId));</span>
<span class="nc" id="L9295">			boolean isSuccess = false;</span>
<span class="nc" id="L9296">			boolean isFraud = ResponsibleGaming.respGaming(userInfoBean, &quot;DG_PWT&quot;, &quot;&quot; + pwtBean.getTotalWinAmt());</span>
<span class="nc bnc" id="L9297" title="All 2 branches missed.">			if (!isFraud) {</span>
<span class="nc bnc" id="L9298" title="All 2 branches missed.">				if (refTransId.size() &gt; 0) {</span>
<span class="nc" id="L9299">					sReq = new ServiceRequest();</span>
<span class="nc" id="L9300">					sReq.setServiceName(ServiceName.PWT_MGMT);</span>
<span class="nc" id="L9301">					sReq.setServiceMethod(ServiceMethodName.DRAWGAME_PWT_TP_UPDATE);</span>
<span class="nc" id="L9302">					requestObject.put(&quot;ticketNumber&quot;, pwtBean.getTicketNumber());</span>
<span class="nc" id="L9303">					requestObject.put(&quot;verificationCode&quot;, verCode);</span>
					// requestObject.put(&quot;merchantCode&quot;,
					// pwtBean.getMerchantCode());
<span class="nc" id="L9306">					requestObject.put(&quot;merchantCode&quot;, &quot;LMS&quot;); // This need to</span>
																// change and
																// get
																// merchant-Id
																// from
																// transaction
																// manager at
																// DGE.
<span class="nc" id="L9314">					requestObject.put(&quot;refMerchantId&quot;, &quot;WGRL&quot;);</span>
<span class="nc" id="L9315">					requestObject.put(&quot;partyId&quot;, userInfoBean.getUserOrgId());</span>
<span class="nc" id="L9316">					requestObject.put(&quot;channelType&quot;, userInfoBean.getChannel());</span>
<span class="nc" id="L9317">					requestObject.put(&quot;refTransId&quot;,</span>
							refTransId.toString().replace(&quot;[&quot;, &quot;&quot;).replace(&quot;]&quot;, &quot;&quot;).replace(&quot; &quot;, &quot;&quot;));
<span class="nc" id="L9319">					requestObject.put(&quot;userId&quot;, userInfoBean.getUserId());</span>
<span class="nc" id="L9320">					sReq.setServiceData(requestObject);</span>
<span class="nc" id="L9321">					IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L9322">					String responseString = delegate.getResponseString(sReq);</span>
					// String
					// responseString=&quot;{\&quot;responseCode\&quot;:0,\&quot;winningAmt\&quot;:45.0,\&quot;purchaseTime\&quot;:\&quot;2015-03-12
					// 15:15:52\&quot;,\&quot;purchaseAmt\&quot;:5.5,\&quot;refTxnId\&quot;:\&quot;565\&quot;}&quot;;
<span class="nc" id="L9326">					JsonObject data = new JsonParser().parse(responseString).getAsJsonObject();</span>
<span class="nc bnc" id="L9327" title="All 2 branches missed.">					if (data.get(&quot;responseCode&quot;).getAsInt() == 0) {</span>
<span class="nc" id="L9328">						isSuccess = pwtMgmtDaoImpl.getInstance().updatePlayerPwtMerchantTransaction(pwtBean,</span>
								data.get(&quot;refTxnId&quot;).getAsString(), con);
<span class="nc" id="L9330">						pwtMgmtDaoImpl.getInstance().updateMerchantCode(pwtBean, con);</span>
<span class="nc" id="L9331">						con.commit();</span>
<span class="nc bnc" id="L9332" title="All 2 branches missed.">						if (!isSuccess) {</span>
<span class="nc" id="L9333">							throw new LMSException(LMSErrors.TRANSACTION_NOT_AVAILABLE_ERROR_CODE,</span>
									LMSErrors.TRANSACTION_NOT_AVAILABLE_ERROR_MESSAGE);
						}
					} else {
						// con.rollback();
<span class="nc" id="L9338">						throw new LMSException(data.get(&quot;responseCode&quot;).getAsInt(),</span>
								data.get(&quot;responseMsg&quot;).getAsString());
					}
<span class="nc" id="L9341">				}</span>
			} else {
<span class="nc" id="L9343">				throw new LMSException(EmbeddedErrors.PWT_LIMIT_EXCEED_ERROR_CODE, EmbeddedErrors.PWT_LIMIT_EXCEED);</span>
			}
<span class="nc" id="L9345">		} catch (LMSException el) {</span>
<span class="nc" id="L9346">			throw el;</span>
<span class="nc" id="L9347">		} catch (Exception e) {</span>
<span class="nc" id="L9348">			e.printStackTrace();</span>
<span class="nc" id="L9349">			throw new LMSException(LMSErrors.GENERAL_EXCEPTION_ERROR_CODE, LMSErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
		} finally {
<span class="nc" id="L9351">			DBConnect.closeCon(con);</span>
<span class="nc" id="L9352">		}</span>
<span class="nc" id="L9353">		return pwtBean;</span>
	}
}

class ValueComparator implements Comparator&lt;String&gt; {
	Map&lt;String, BetDetailsBean&gt; map;

<span class="nc" id="L9360">	public ValueComparator(Map&lt;String, BetDetailsBean&gt; map) {</span>
<span class="nc" id="L9361">		this.map = map;</span>
<span class="nc" id="L9362">	}</span>

	public int compare(String a, String b) {
<span class="nc bnc" id="L9365" title="All 2 branches missed.">		if (map.get(a).getBetOrder() &lt; map.get(b).getBetOrder()) {</span>
<span class="nc" id="L9366">			return -1;</span>
		} else {
<span class="nc" id="L9368">			return 1;</span>
		}
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>