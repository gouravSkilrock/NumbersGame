<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Util.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lms</a> &gt; <a href="index.source.html" class="el_package">com.skilrock.lms.web.drawGames.common</a> &gt; <span class="el_source">Util.java</span></div><h1>Util.java</h1><pre class="source lang-java linenums">package com.skilrock.lms.web.drawGames.common;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.io.OutputStreamWriter;
import java.net.URL;
import java.net.URLConnection;
import java.net.URLEncoder;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.sql.Timestamp;
import java.text.DateFormat;
import java.text.NumberFormat;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.SortedSet;
import java.util.TreeMap;
import java.util.TreeSet;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import java.util.zip.CRC32;
import java.util.zip.Checksum;

import javax.servlet.ServletContext;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.apache.struts2.ServletActionContext;

import com.opensymphony.xwork2.ActionSupport;
import com.skilrock.lms.ajax.AjaxRequestHelper;
import com.skilrock.lms.beans.MessageDetailsBean;
import com.skilrock.lms.beans.OrgDataBean;
import com.skilrock.lms.beans.PromoGameBean;
import com.skilrock.lms.beans.ResponsibleGamingBean;
import com.skilrock.lms.common.ConfigurationVariables;
import com.skilrock.lms.common.Utility;
import com.skilrock.lms.common.db.DBConnect;
import com.skilrock.lms.common.exception.LMSErrors;
import com.skilrock.lms.common.exception.LMSException;
import com.skilrock.lms.common.filter.LMSFilterDispatcher;
import com.skilrock.lms.common.utility.LMSUtility;
import com.skilrock.lms.coreEngine.drawGames.playMgmt.ServerStartUpData;
import com.skilrock.lms.dge.beans.DrawDetailsBean;
import com.skilrock.lms.dge.beans.FortunePurchaseBean;
import com.skilrock.lms.dge.beans.GameMasterLMSBean;
import com.skilrock.lms.dge.beans.KenoPurchaseBean;
import com.skilrock.lms.dge.beans.LottoPurchaseBean;
import com.skilrock.lms.dge.beans.RaffleDrawIdBean;
import com.skilrock.lms.dge.beans.RafflePurchaseBean;
import com.skilrock.lms.dge.beans.ValidateTicketBean;
import com.skilrock.lms.embedded.drawGames.common.CommonMethods;


<span class="nc" id="L68">public class Util extends ActionSupport {</span>

<span class="nc" id="L70">	public static Map&lt;String, Map&lt;Long, String&gt;&gt; drawIdDateMap = null;</span>
<span class="nc" id="L71">	public static Map&lt;Integer, Map&lt;Integer, String&gt;&gt; drawIdTableMap = null;</span>
<span class="nc" id="L72">	public static TreeMap&lt;Integer, List&lt;List&gt;&gt; gameData = null;</span>
<span class="nc" id="L73">	private static Map&lt;Integer, GameMasterLMSBean&gt; gameMap = null;</span>
<span class="nc" id="L74">	private static Map&lt;Integer, GameMasterLMSBean&gt; sleGameMap = null;</span>
<span class="nc" id="L75">	private static Map&lt;Integer, GameMasterLMSBean&gt; lmsGameMap = null;</span>
<span class="nc" id="L76">	private static Map&lt;Integer, GameMasterLMSBean&gt; iwGameMap = null;</span>
<span class="nc" id="L77">	private static Map&lt;Integer, GameMasterLMSBean&gt; vsGameMap = null;</span>
<span class="nc" id="L78">	public static Map&lt;Integer, Double&gt; jackPotMap = null;</span>
<span class="nc" id="L79">	public static Map&lt;Integer, Map&lt;Integer, DrawDetailsBean&gt;&gt; drawDetailsMap = null;</span>
<span class="nc" id="L80">	public static Map&lt;Integer, List&lt;String&gt;&gt; drawNameListMap = null;</span>
	// added by yogesh
<span class="nc" id="L82">	public static Map&lt;Integer, Map&lt;Integer, OrgDataBean&gt;&gt; orgDataMap = null;</span>
<span class="nc" id="L83">	public static Map&lt;Integer, Map&lt;Integer, OrgDataBean&gt;&gt; sleOrgDataMap = null;</span>
<span class="nc" id="L84">	public static Map&lt;Integer, Map&lt;Integer, OrgDataBean&gt;&gt; iwOrgDataMap = null;</span>
<span class="nc" id="L85">	public static Map&lt;Integer, Map&lt;Integer, OrgDataBean&gt;&gt; vsOrgDataMap = null;</span>
<span class="nc" id="L86">	public static Map&lt;Integer, Map&lt;Integer, List&lt;MessageDetailsBean&gt;&gt;&gt; advMsgDataMap = null;</span>
<span class="nc" id="L87">	public static Map&lt;Integer,List&lt;PromoGameBean&gt;&gt; promoGameBeanMap=null;</span>
<span class="nc" id="L88">	public static Map&lt;String, ResponsibleGamingBean&gt; respGamingCriteriaStatusMap=null;</span>
<span class="nc" id="L89">	public static Map&lt;Integer, String&gt; catMap = null;</span>
<span class="nc" id="L90">	public static Map&lt;String, Integer&gt; serviceCodeIDMap = null;</span>
<span class="nc" id="L91">	static Log logger = LogFactory.getLog(Util.class);</span>
<span class="nc" id="L92">	public static boolean onfreezeSale = true;</span>
	//private static boolean isGameMapSet = false;
	/**
	 * 
	 */
	
	static {
<span class="nc" id="L99">		setCategoryMapDetails();</span>
<span class="nc" id="L100">		setServiceCodeIdMap();</span>
	}
	/*static {
		logger.info(&quot;Game Map initialization starts....&quot;);
		setGameMapOnFirstCall();
		logger.info(&quot;Game Map initialization ends....&quot;);
	}*/
	
	private static final long serialVersionUID = 1L;

	public static String convertCollToStr(Object obj) {
<span class="nc" id="L111">		return obj.toString().replace(&quot;[&quot;, &quot;&quot;).replace(&quot;]&quot;, &quot;&quot;)</span>
				.replace(&quot;{&quot;, &quot;&quot;).replace(&quot;}&quot;, &quot;&quot;);
	}
	

	private static void setGameMapOnFirstCall() {
<span class="nc" id="L117">		ServerStartUpData.onStartGameData(LMSUtility.sc);</span>
		
<span class="nc" id="L119">	}</span>


	public static int fetchOrgIdOfUser(int userId) {
<span class="nc" id="L123">		int orgId = 0;</span>
<span class="nc" id="L124">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L125">		Statement stmt = null;</span>
<span class="nc" id="L126">		ResultSet rs = null;</span>
		try {
<span class="nc" id="L128">			stmt = con.createStatement();</span>
<span class="nc" id="L129">			rs = stmt</span>
					.executeQuery(&quot;select organization_id from st_lms_user_master where user_id = &quot;
							+ userId);
<span class="nc bnc" id="L132" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L133">				orgId = rs.getInt(&quot;organization_id&quot;);</span>
			}
<span class="nc" id="L135">		} catch (Exception e) {</span>
<span class="nc" id="L136">			e.printStackTrace();</span>
			// throw new LMSException(e);
		} finally {
<span class="nc" id="L139">			try {</span>
<span class="nc bnc" id="L140" title="All 12 branches missed.">				if (con != null &amp;&amp; !con.isClosed()) {</span>
<span class="nc" id="L141">					con.close();</span>
				}
<span class="nc" id="L143">			} catch (Exception e) {</span>
<span class="nc" id="L144">				e.printStackTrace();</span>
<span class="nc" id="L145">			}</span>
<span class="nc" id="L146">		}</span>
<span class="nc" id="L147">		return orgId;</span>
	}

	public static int getAdvMsgs(Map&lt;String, List&lt;String&gt;&gt; advMsgMap,
			StringBuilder topMsgsStr, StringBuilder bottomMsgsStr,
			int appletHeight) {
<span class="nc" id="L153">		String advtMsgEnable = (String) ServletActionContext</span>
				.getServletContext().getAttribute(&quot;ADVT_MSG&quot;);
<span class="nc bnc" id="L155" title="All 6 branches missed.">		if (advtMsgEnable != null &amp;&amp; !&quot;NULL&quot;.equalsIgnoreCase(advtMsgEnable)</span>
				&amp;&amp; &quot;YES&quot;.equalsIgnoreCase(advtMsgEnable.trim())) {
<span class="nc bnc" id="L157" title="All 2 branches missed.">			if (advMsgMap != null) {</span>
<span class="nc" id="L158">				List&lt;String&gt; topMsgsList = advMsgMap.get(&quot;TOP&quot;);</span>
<span class="nc" id="L159">				List&lt;String&gt; bottomMsgsList = advMsgMap.get(&quot;BOTTOM&quot;);</span>
<span class="nc" id="L160">				int msgLen = 0;</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">				if (topMsgsList != null) {</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">					for (int i = 0; i &lt; topMsgsList.size(); i++) {</span>
<span class="nc" id="L163">						topMsgsStr = topMsgsStr</span>
								.append(topMsgsList.get(i) + &quot;~&quot;);
<span class="nc" id="L165">						msgLen = topMsgsList.get(i).length();</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">						if (msgLen &gt; 17) {</span>
<span class="nc" id="L167">							appletHeight = appletHeight + 11 * (msgLen / 17)</span>
									+ 11;
						} else {
<span class="nc" id="L170">							appletHeight = appletHeight + 22;</span>
						}
					}
<span class="nc bnc" id="L173" title="All 2 branches missed.">					if (topMsgsStr.length() &gt; 0) {</span>
<span class="nc" id="L174">						topMsgsStr.deleteCharAt(topMsgsStr.length() - 1);</span>
					}
				}
<span class="nc bnc" id="L177" title="All 2 branches missed.">				if (bottomMsgsList != null) {</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">					for (int i = 0; i &lt; bottomMsgsList.size(); i++) {</span>
<span class="nc" id="L179">						bottomMsgsStr = bottomMsgsStr.append(bottomMsgsList</span>
								.get(i)
								+ &quot;~&quot;);
<span class="nc" id="L182">						msgLen = bottomMsgsList.get(i).length();</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">						if (msgLen &gt; 17) {</span>
<span class="nc" id="L184">							appletHeight = appletHeight + 11 * (msgLen / 17)</span>
									+ 11;
						} else {
<span class="nc" id="L187">							appletHeight = appletHeight + 22;</span>
						}
					}
<span class="nc bnc" id="L190" title="All 2 branches missed.">					if (bottomMsgsStr.length() &gt; 0) {</span>
<span class="nc" id="L191">						bottomMsgsStr.deleteCharAt(bottomMsgsStr.length() - 1);</span>
					}
				}
			}
		}
<span class="nc" id="L196">		return appletHeight;</span>
	}

	public static String getDGIP(String project) {
<span class="nc" id="L200">		ServletContext sc = ServletActionContext.getServletContext();</span>
<span class="nc" id="L201">		return (String) sc.getAttribute(&quot;HOST&quot;) + &quot;://&quot;</span>
				+ (String) sc.getAttribute(project)
				+ (String) sc.getAttribute(&quot;PORT&quot;);
	}

	public static String getGameDisplayName(int gameId) {
<span class="nc" id="L207">		Iterator&lt;Map.Entry&lt;Integer, GameMasterLMSBean&gt;&gt; gameNumItr = getGameMap()</span>
				.entrySet().iterator();
<span class="nc bnc" id="L209" title="All 2 branches missed.">		while (gameNumItr.hasNext()) {</span>
<span class="nc" id="L210">			Map.Entry&lt;Integer, GameMasterLMSBean&gt; gameNumpair = gameNumItr</span>
					.next();
<span class="nc bnc" id="L212" title="All 2 branches missed.">			if (gameId == gameNumpair.getValue().getGameId()) {</span>
<span class="nc" id="L213">				return gameNumpair.getValue().getGameName();</span>
			}
<span class="nc" id="L215">		}</span>
<span class="nc" id="L216">		return null;</span>
	}

	public static GameMasterLMSBean getGameMasterLMSBean(int gameId) {
<span class="nc" id="L220">		return getGameMap().get(gameId);</span>
	}
	
	public static GameMasterLMSBean getSLEGameMasterLMSBean(int gameId) {
<span class="nc" id="L224">		return sleGameMap.get(gameId);</span>
	}

	public static double getSaleCommVariance(int organizationId, int gameId) {
<span class="nc" id="L228">		return (orgDataMap.get(organizationId)).get(gameId).getSaleCommVar();</span>
	}

	public static double getSLESaleCommVariance(int organizationId, int gameId) {
<span class="nc" id="L232">		return (sleOrgDataMap.get(organizationId)).get(gameId).getSaleCommVar();</span>
	}

	public static double getSLEPwtCommVariance(int organizationId, int gameId) {
<span class="nc" id="L236">		return (sleOrgDataMap.get(organizationId)).get(gameId).getPwtCommVar();</span>
	}
	
	public static double getIWSaleCommVariance(int organizationId, int gameId) {
<span class="nc" id="L240">		return (iwOrgDataMap.get(organizationId)).get(gameId).getSaleCommVar();</span>
	}

	public static double getIWPwtCommVariance(int organizationId, int gameId) {
<span class="nc" id="L244">		return (iwOrgDataMap.get(organizationId)).get(gameId).getPwtCommVar();</span>
	}
	
	public static double getVSSaleCommVariance(int organizationId, int gameId) {
<span class="nc" id="L248">		return (vsOrgDataMap.get(organizationId)).get(gameId).getSaleCommVar();</span>
	}

	public static double getVSPwtCommVariance(int organizationId, int gameId) {
<span class="nc" id="L252">		return (vsOrgDataMap.get(organizationId)).get(gameId).getPwtCommVar();</span>
	}
	
	public static GameMasterLMSBean getIWGameMasterLMSBean(int gameId) {
<span class="nc" id="L256">		return iwGameMap.get(gameId);</span>
	}
	
	public static GameMasterLMSBean getVSGameMasterLMSBean(int gameId) {
<span class="nc" id="L260">		return vsGameMap.get(gameId);</span>
	}

	public static void updateSaleCommVariance(int organizationId, int gameId,
			double updatedCommVar) {
<span class="nc" id="L265">		(orgDataMap.get(organizationId)).get(gameId).setSaleCommVar(</span>
				updatedCommVar);
<span class="nc" id="L267">	}</span>
	
	public static void updateSaleCommVarianceIW(int organizationId, int gameId, double updatedCommVar) {
<span class="nc" id="L270">		(iwOrgDataMap.get(organizationId)).get(gameId).setSaleCommVar(updatedCommVar);</span>
<span class="nc" id="L271">	}</span>
	
	public static void updateSaleCommVarianceVS(int organizationId, int gameId, double updatedCommVar) {
<span class="nc" id="L274">		(vsOrgDataMap.get(organizationId)).get(gameId).setSaleCommVar(updatedCommVar);</span>
<span class="nc" id="L275">	}</span>

	
	public static int getGameIdFromGameNumber(int gameNumber) {
<span class="nc" id="L279">		Iterator&lt;Map.Entry&lt;Integer, GameMasterLMSBean&gt;&gt; gameNumItr = getGameMap()</span>
				.entrySet().iterator();
<span class="nc bnc" id="L281" title="All 2 branches missed.">		while (gameNumItr.hasNext()) {</span>
<span class="nc" id="L282">			Map.Entry&lt;Integer, GameMasterLMSBean&gt; gameNumpair = gameNumItr</span>
					.next();
<span class="nc bnc" id="L284" title="All 6 branches missed.">			if(gameNumpair.getValue().getGameStatus() != null &amp;&amp; (gameNumpair.getValue().getGameStatus().equals(&quot;OPEN&quot;) || gameNumpair.getValue().getGameStatus().equals(&quot;SALE_HOLD&quot;))) {</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">			if (gameNumber == gameNumpair.getValue().getGameNo()) {</span>
<span class="nc" id="L286">				return gameNumpair.getValue().getGameId();</span>
			}
			}
<span class="nc" id="L289">		}</span>
<span class="nc" id="L290">		return 0;</span>
	}
	public static int getGameIdFromLmsGameNumber(int gameNumber) {
<span class="nc" id="L293">		Iterator&lt;Map.Entry&lt;Integer, GameMasterLMSBean&gt;&gt; gameNumItr = getLmsGameMap()</span>
				.entrySet().iterator();
<span class="nc bnc" id="L295" title="All 2 branches missed.">		while (gameNumItr.hasNext()) {</span>
<span class="nc" id="L296">			Map.Entry&lt;Integer, GameMasterLMSBean&gt; gameNumpair = gameNumItr</span>
					.next();
<span class="nc bnc" id="L298" title="All 4 branches missed.">			if(gameNumpair.getValue().getGameStatus().equals(&quot;OPEN&quot;)||gameNumpair.getValue().getGameStatus().equals(&quot;SALE_HOLD&quot;)){</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">			if (gameNumber == gameNumpair.getValue().getGameNo()) {</span>
<span class="nc" id="L300">				return gameNumpair.getValue().getGameId();</span>
			}
			}
<span class="nc" id="L303">		}</span>
<span class="nc" id="L304">		return 0;</span>
	}

	public static Map&lt;Integer, GameMasterLMSBean&gt; getGameMap() {
<span class="nc bnc" id="L308" title="All 2 branches missed.">		if (gameMap == null) {</span>
<span class="nc" id="L309">			setGameMapOnFirstCall();</span>
		}
<span class="nc" id="L311">		return gameMap;</span>
	}
	
	public static Map&lt;Integer, GameMasterLMSBean&gt; getSLEGameMap() {
<span class="nc" id="L315">		return sleGameMap;</span>
	}
	
	public static Map&lt;Integer, GameMasterLMSBean&gt; getLmsGameMap() {
<span class="nc bnc" id="L319" title="All 2 branches missed.">		if (lmsGameMap == null) {</span>
<span class="nc" id="L320">			setGameMapOnFirstCall();</span>
		}
<span class="nc" id="L322">		return lmsGameMap;</span>
	}
	
	public static Map&lt;Integer, GameMasterLMSBean&gt; getIWGameMap() {
<span class="nc" id="L326">		return iwGameMap;</span>
	}
	
	public static Map&lt;Integer, GameMasterLMSBean&gt; getVSGameMap() {
<span class="nc" id="L330">		return vsGameMap;</span>
	}

	public static String getGameName(int gameId) {
<span class="nc" id="L334">		Iterator&lt;Map.Entry&lt;Integer, GameMasterLMSBean&gt;&gt; gameNumItr = getGameMap()</span>
				.entrySet().iterator();
<span class="nc bnc" id="L336" title="All 2 branches missed.">		while (gameNumItr.hasNext()) {</span>
<span class="nc" id="L337">			Map.Entry&lt;Integer, GameMasterLMSBean&gt; gameNumpair = gameNumItr</span>
					.next();
<span class="nc bnc" id="L339" title="All 2 branches missed.">			if (gameId == gameNumpair.getValue().getGameId()) {</span>
<span class="nc" id="L340">				return gameNumpair.getValue().getGameNameDev();</span>
			}
<span class="nc" id="L342">		}</span>
<span class="nc" id="L343">		return null;</span>
	}

	public static int getGameNumberFromGameId(int gameId) {
<span class="nc" id="L347">		Iterator&lt;Map.Entry&lt;Integer, GameMasterLMSBean&gt;&gt; gameNumItr = getGameMap()</span>
				.entrySet().iterator();
<span class="nc bnc" id="L349" title="All 2 branches missed.">		while (gameNumItr.hasNext()) {</span>
<span class="nc" id="L350">			Map.Entry&lt;Integer, GameMasterLMSBean&gt; gameNumpair = gameNumItr</span>
					.next();
<span class="nc bnc" id="L352" title="All 4 branches missed.">			if(gameNumpair.getValue().getGameStatus()!=null &amp;&amp; gameNumpair.getValue().getGameStatus().equals(&quot;OPEN&quot;)){</span>
<span class="nc bnc" id="L353" title="All 2 branches missed.">			if (gameId == gameNumpair.getValue().getGameId()) {</span>
<span class="nc" id="L354">				return gameNumpair.getValue().getGameNo();</span>
			}
			}
<span class="nc" id="L357">		}</span>
<span class="nc" id="L358">		return 0;</span>
	}


	public static int getGameId(String gameDevName){
<span class="nc" id="L363">		Iterator&lt;Map.Entry&lt;Integer, GameMasterLMSBean&gt;&gt; gameNumItr = getGameMap()</span>
		.entrySet().iterator();
<span class="nc bnc" id="L365" title="All 2 branches missed.">		while (gameNumItr.hasNext()) {</span>
<span class="nc" id="L366">			Map.Entry&lt;Integer, GameMasterLMSBean&gt; gameNumpair = gameNumItr</span>
			.next();
<span class="nc" id="L368">			System.out.println(gameNumpair.getValue().getGameNameDev());</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">			if(gameNumpair.getValue().getGameStatus().equals(&quot;OPEN&quot;)){</span>
<span class="nc bnc" id="L370" title="All 2 branches missed.">			if (gameDevName.equals(gameNumpair.getValue().getGameNameDev())) {</span>
<span class="nc" id="L371">				return gameNumpair.getValue().getGameId();</span>
			}
		}
<span class="nc" id="L374">	}</span>
<span class="nc" id="L375">	return 0;</span>
	}
	
	/*public static List&lt;Integer&gt; getGameNumberList() {
		List&lt;Integer&gt; gameNumList = new ArrayList&lt;Integer&gt;();
		Iterator&lt;Map.Entry&lt;Integer, GameMasterLMSBean&gt;&gt; gameNumItr = gameMap
				.entrySet().iterator();
		while (gameNumItr.hasNext()) {
			Map.Entry&lt;Integer, GameMasterLMSBean&gt; gameNumpair = gameNumItr
					.next();
			gameNumList.add(gameNumpair.getValue().getGameNo());
		}
		return gameNumList;
	}*/
	
	public static List&lt;Integer&gt; getGameNumberList() {
<span class="nc" id="L391">		List&lt;Integer&gt; gameNumList = new ArrayList&lt;Integer&gt;();</span>
<span class="nc" id="L392">		Iterator&lt;Map.Entry&lt;Integer, GameMasterLMSBean&gt;&gt; gameNumItr = getGameMap()</span>
				.entrySet().iterator();
<span class="nc bnc" id="L394" title="All 2 branches missed.">		while (gameNumItr.hasNext()) {</span>
<span class="nc" id="L395">			Map.Entry&lt;Integer, GameMasterLMSBean&gt; gameNumpair = gameNumItr</span>
					.next();
<span class="nc" id="L397">			gameNumList.add(gameNumpair.getValue().getGameId());</span>
<span class="nc" id="L398">		}</span>
<span class="nc" id="L399">		return gameNumList;</span>
	}
	
	public static List&lt;Integer&gt; getLMSGameNumberList() {
<span class="nc" id="L403">		List&lt;Integer&gt; gameNumList = new ArrayList&lt;Integer&gt;();</span>
<span class="nc" id="L404">		Iterator&lt;Map.Entry&lt;Integer, GameMasterLMSBean&gt;&gt; gameNumItr = getLmsGameMap()</span>
				.entrySet().iterator();
<span class="nc bnc" id="L406" title="All 2 branches missed.">		while (gameNumItr.hasNext()) {</span>
<span class="nc" id="L407">			Map.Entry&lt;Integer, GameMasterLMSBean&gt; gameNumpair = gameNumItr</span>
					.next();
<span class="nc" id="L409">			gameNumList.add(gameNumpair.getValue().getGameId());</span>
<span class="nc" id="L410">		}</span>
<span class="nc" id="L411">		return gameNumList;</span>
	}
	
	public static List&lt;Integer&gt; getCategoryNumberList(Connection con) throws SQLException {
<span class="nc" id="L415">		List&lt;Integer&gt; categoryNumList = new ArrayList&lt;Integer&gt;();</span>
		try
		{
<span class="nc" id="L418">		PreparedStatement pStatement = con.prepareStatement(&quot;select category_id from st_cs_product_category_master where status='ACTIVE'&quot;);</span>
<span class="nc" id="L419">		ResultSet rs = pStatement.executeQuery();</span>
<span class="nc bnc" id="L420" title="All 2 branches missed.">		while (rs.next()) {</span>
<span class="nc" id="L421">			categoryNumList.add(rs.getInt(&quot;category_id&quot;));</span>
		}
		}
<span class="nc" id="L424">		catch (Exception e) {</span>
<span class="nc" id="L425">			e.printStackTrace();</span>
			// throw new LMSException(e);
<span class="nc" id="L427">		} </span>
<span class="nc" id="L428">		return categoryNumList;</span>
	}
	
	public static List&lt;Integer&gt; getWalletNumberList(Connection con) throws SQLException {
<span class="nc" id="L432">		List&lt;Integer&gt; walletNumList = new ArrayList&lt;Integer&gt;();</span>
		try
		{
<span class="nc" id="L435">		PreparedStatement pStatement = con.prepareStatement(&quot;select wallet_id from st_ola_wallet_master where wallet_status='ACTIVE'&quot;);</span>
<span class="nc" id="L436">		ResultSet rs = pStatement.executeQuery();</span>
<span class="nc bnc" id="L437" title="All 2 branches missed.">		while (rs.next()) {</span>
<span class="nc" id="L438">			walletNumList.add(rs.getInt(&quot;wallet_id&quot;));</span>
		}
		}
<span class="nc" id="L441">		catch (Exception e) {</span>
<span class="nc" id="L442">			e.printStackTrace();</span>
<span class="nc" id="L443">		} </span>
<span class="nc" id="L444">		return walletNumList;</span>
	}

	public static String getGameType(int gameId) {
<span class="nc" id="L448">		String gameName = getGameName(gameId);</span>
<span class="nc bnc" id="L449" title="All 2 branches missed.">		if (gameName != null) {</span>
<span class="nc bnc" id="L450" title="All 10 branches missed.">			if (gameName.equals(&quot;Fortune&quot;) || gameName.equals(&quot;Zerotonine&quot;) || gameName.equals(&quot;OneToTwelve&quot;)</span>
					|| gameName.equals(&quot;Card16&quot;) || gameName.equals(&quot;Card12&quot;)) {
<span class="nc" id="L452">				return &quot;Fortune&quot;;</span>
<span class="nc bnc" id="L453" title="All 24 branches missed.">			} else if (gameName.equals(&quot;Lotto&quot;) || gameName.equals(&quot;Zimlotto&quot;)</span>
					|| gameName.equals(&quot;Zimlottotwo&quot;)
					|| gameName.equals(&quot;Zimlottothree&quot;)
					|| gameName.equals(&quot;ZimLottoBonus&quot;)
					|| gameName.equals(&quot;ZimLottoBonusFree&quot;)
					|| gameName.equals(&quot;ZimLottoBonusTwo&quot;)
					|| gameName.equals(&quot;ZimLottoBonusTwoFree&quot;)
					|| gameName.equals(&quot;Fastlotto&quot;)
					|| gameName.equals(&quot;Tanzanialotto&quot;)
					|| gameName.equals(&quot;BonusBalllotto&quot;)
					|| gameName.equals(&quot;BonusBallTwo&quot;)) {
<span class="nc" id="L464">				return &quot;Lotto&quot;;</span>
<span class="nc bnc" id="L465" title="All 30 branches missed.">			} else if (gameName.equals(&quot;Keno&quot;) || gameName.equals(&quot;KenoTwo&quot;) || gameName.equals(&quot;KenoFour&quot;) || gameName.equals(&quot;KenoFive&quot;)  || gameName.equals(&quot;KenoSix&quot;) || gameName.equals(&quot;KenoSeven&quot;)</span>

					|| gameName.equals(&quot;KenoEight&quot;) || &quot;Super2&quot;.equals(gameName) || &quot;SuperTwo&quot;.equals(gameName) || &quot;TwelveByTwentyFour&quot;.equals(gameName) || &quot;TenByTwenty&quot;.equals(gameName) || gameName.equals(&quot;MiniRoulette&quot;) || gameName.equals(&quot;FullRoulette&quot;)||&quot;TenByThirty&quot;.equals(gameName) || &quot;KenoNine&quot;.equals(gameName)) {

<span class="nc" id="L469">				return &quot;Keno&quot;;</span>
<span class="nc bnc" id="L470" title="All 8 branches missed.">			} else if (&quot;RaffleGame&quot;.equals(gameName)</span>
					|| &quot;RaffleGame1&quot;.equals(gameName) || &quot;DGRaffle&quot;.equalsIgnoreCase(gameName) || &quot;SERaffle&quot;.equalsIgnoreCase(gameName)) {
<span class="nc" id="L472">				return &quot;RAFFLE&quot;;</span>
<span class="nc bnc" id="L473" title="All 2 branches missed.">			} else if (&quot;FortuneTwo&quot;.equalsIgnoreCase(gameName)) {</span>
<span class="nc" id="L474">				return &quot;FortuneTwo&quot;;</span>
<span class="nc bnc" id="L475" title="All 2 branches missed.">			} else if (&quot;FortuneThree&quot;.equalsIgnoreCase(gameName)){</span>
<span class="nc" id="L476">				return &quot;FortuneThree&quot;;</span>
<span class="nc bnc" id="L477" title="All 6 branches missed.">			} else if (&quot;RainbowGame&quot;.equalsIgnoreCase(gameName) || gameName.equals(&quot;PickFour&quot;) || gameName.equals(&quot;PickThree&quot;)){</span>
<span class="nc" id="L478">				return &quot;Rainbow&quot;;</span>
			}
		}
<span class="nc" id="L481">		return null;</span>
	}

	// ------Added on 01/07/10-----

	public static int getOfflineFileGameNo(String fileName) {
<span class="nc bnc" id="L487" title="All 2 branches missed.">		return fileName.contains(&quot;_&quot;) ? Integer</span>
				.parseInt(fileName.split(&quot;_&quot;)[1]) : Integer.parseInt(fileName
				.charAt(4)
				+ &quot;&quot;);
	}

	public static String getOrgName(int userOrgId) {
<span class="nc" id="L494">		String orgName = null;</span>
<span class="nc" id="L495">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L496">		Statement stmt = null;</span>
<span class="nc" id="L497">		ResultSet rs = null;</span>
		try {
<span class="nc" id="L499">			stmt = con.createStatement();</span>
<span class="nc" id="L500">			rs = stmt</span>
					.executeQuery(&quot;select name from st_lms_organization_master where organization_id = '&quot;
							+ userOrgId + &quot;'&quot;);
<span class="nc bnc" id="L503" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L504">				orgName = rs.getString(&quot;name&quot;).toUpperCase();</span>
			}
<span class="nc" id="L506">			logger.debug(&quot;orgName-------&quot; + orgName);</span>
<span class="nc" id="L507">		} catch (Exception e) {</span>
<span class="nc" id="L508">			e.printStackTrace();</span>
			// throw new LMSException(e);
		} finally {
<span class="nc" id="L511">			try {</span>
<span class="nc bnc" id="L512" title="All 12 branches missed.">				if (con != null &amp;&amp; !con.isClosed()) {</span>
<span class="nc" id="L513">					con.close();</span>
				}
<span class="nc" id="L515">			} catch (Exception e) {</span>
<span class="nc" id="L516">				e.printStackTrace();</span>
<span class="nc" id="L517">			}</span>
<span class="nc" id="L518">		}</span>
<span class="nc" id="L519">		return orgName;</span>
	}

	//this method is depricated and not used commented on 11 april 2013 by sumit
	/*public static int getRandomNo(int startRange, int endRange) {
		// int randomNo = (int) ((Math.random() * (endRange - startRange)) +
		// startRange);
		int randomNo = RNGUtilities.generateRandomNumber(startRange, endRange);
		return randomNo;
	}*/
	//this method is depricated and not used commented on 11 april 2013 by sumit
	/*public static String getRandomNoKeno(int startRange, int endRange,
			int noOfQP) {
		String randStr = &quot;&quot;;
		Set randSet = new TreeSet();
		while (randSet.size() != noOfQP) {
			// randStr=&quot;&quot;+(int)((Math.random() * (endRange - startRange)) +
			// startRange);
			randStr = &quot;&quot;
					+ RNGUtilities.generateRandomNumber(startRange, endRange);
			randSet.add(randStr.length() &gt; 1 ? randStr : &quot;0&quot; + randStr);
		}

		return randSet.toString().replace(&quot;[&quot;, &quot;&quot;).replace(&quot;]&quot;, &quot;&quot;).replace(
				&quot; &quot;, &quot;&quot;);
	}*/

	public static double getUnitPrice(int gameId, String betType) {
<span class="nc" id="L547">		Double amount = (getGameMap().get(gameId).getPriceMap().get(</span>
				betType).getUnitPrice());
<span class="nc bnc" id="L549" title="All 2 branches missed.">		return amount == null ? 0.0 : amount;</span>
	}

	public static int maxPickedGameWise(int gameNo) {
<span class="nc" id="L553">		int maxPicked = 1; // For Fortune type Games</span>
<span class="nc" id="L554">		String gameDevName = getGameName(gameNo);</span>
<span class="nc bnc" id="L555" title="All 2 branches missed.">		if (&quot;keno&quot;.equalsIgnoreCase(gameDevName)) {</span>
<span class="nc" id="L556">			maxPicked = 5;</span>
<span class="nc bnc" id="L557" title="All 2 branches missed.">		} else if (&quot;lotto&quot;.equalsIgnoreCase(gameDevName)) {</span>
<span class="nc" id="L558">			maxPicked = 6;</span>
<span class="nc bnc" id="L559" title="All 2 branches missed.">		} else if (&quot;zimlotto&quot;.equalsIgnoreCase(gameDevName)) {</span>
<span class="nc" id="L560">			maxPicked = 6;</span>
<span class="nc bnc" id="L561" title="All 2 branches missed.">		} else if (&quot;zimlottotwo&quot;.equalsIgnoreCase(gameDevName)) {</span>
<span class="nc" id="L562">			maxPicked = 6;</span>
<span class="nc bnc" id="L563" title="All 2 branches missed.">		}else if (&quot;zimlottothree&quot;.equalsIgnoreCase(gameDevName)) {</span>
<span class="nc" id="L564">			maxPicked = 6;</span>
<span class="nc bnc" id="L565" title="All 2 branches missed.">		} else if (&quot;fastlotto&quot;.equalsIgnoreCase(gameDevName)) {</span>
<span class="nc" id="L566">			maxPicked = 5;</span>
<span class="nc bnc" id="L567" title="All 2 branches missed.">		} else if (&quot;KenoTwo&quot;.equalsIgnoreCase(gameDevName)) {</span>
<span class="nc" id="L568">			maxPicked = 5;</span>
		}
<span class="nc" id="L570">		return maxPicked;</span>
	}

	public static void setGameMap(Map&lt;Integer, GameMasterLMSBean&gt; gameMap) {
<span class="nc" id="L574">		Util.gameMap = gameMap;</span>
<span class="nc" id="L575">		Collections.unmodifiableMap(Util.gameMap);</span>
<span class="nc" id="L576">	}</span>
	
	public static void setSLEGameMap(Map&lt;Integer, GameMasterLMSBean&gt; gameMap) {
<span class="nc" id="L579">		Util.sleGameMap = gameMap;</span>
<span class="nc" id="L580">		Collections.unmodifiableMap(Util.sleGameMap);</span>
<span class="nc" id="L581">	}</span>
	
	public static void setLmsGameMap(Map&lt;Integer, GameMasterLMSBean&gt; lmsGameMap) {
<span class="nc" id="L584">		Util.lmsGameMap = lmsGameMap;</span>
<span class="nc" id="L585">		Collections.unmodifiableMap(Util.lmsGameMap);</span>
<span class="nc" id="L586">	}</span>
	
	public static void setIWGameMap(Map&lt;Integer, GameMasterLMSBean&gt; gameMap) {
<span class="nc" id="L589">		Util.iwGameMap = gameMap;</span>
<span class="nc" id="L590">		Collections.unmodifiableMap(Util.iwGameMap);</span>
<span class="nc" id="L591">	}</span>
	
	public static void setVSGameMap(Map&lt;Integer, GameMasterLMSBean&gt; gameMap) {
<span class="nc" id="L594">		Util.vsGameMap = gameMap;</span>
<span class="nc" id="L595">		Collections.unmodifiableMap(Util.vsGameMap);</span>
<span class="nc" id="L596">	}</span>

	public static boolean validateNumber(int startRange, int endRange,
			String data, boolean isDuplicate) {

<span class="nc" id="L601">		String[] dataArr = data.split(&quot;,&quot;);</span>
<span class="nc" id="L602">		SortedSet&lt;Integer&gt; dataSet = new TreeSet&lt;Integer&gt;();</span>
<span class="nc" id="L603">		boolean isValid = true;</span>
<span class="nc bnc" id="L604" title="All 2 branches missed.">		for (String element : dataArr) {</span>
<span class="nc" id="L605">			dataSet.add(Integer.parseInt(element));</span>
		}

<span class="nc bnc" id="L608" title="All 2 branches missed.">		if (!isDuplicate) {</span>
<span class="nc bnc" id="L609" title="All 2 branches missed.">			if (dataArr.length != dataSet.size()) {</span>
<span class="nc" id="L610">				isValid = false;</span>
			}
		}

<span class="nc bnc" id="L614" title="All 4 branches missed.">		if (dataSet.last() &gt; endRange || dataSet.first() &lt; startRange) {</span>
<span class="nc" id="L615">			isValid = false;</span>
		}

<span class="nc" id="L618">		return isValid;</span>
	}

	public static boolean checkSpecialCharacter(String data) {
		
<span class="nc" id="L623">		Pattern pattern = Pattern.compile(&quot;[^,0-9,a-z,A-Z]&quot;);</span>
<span class="nc" id="L624">		  Matcher matcher = pattern.matcher(data);</span>
<span class="nc" id="L625">		  boolean b=matcher.find();</span>
<span class="nc" id="L626">		  System.out.print(b);</span>
<span class="nc" id="L627">		return b;</span>
	}
	
	public static ValidateTicketBean validateTkt(String tktNum) {
<span class="nc" id="L631">		int retIdLen = 0;</span>
<span class="nc" id="L632">		int gameNo = 0;</span>
<span class="nc" id="L633">		int tktLen = 0;</span>
<span class="nc" id="L634">		int day = 0;</span>
<span class="nc" id="L635">		String gameName = null;</span>
<span class="nc" id="L636">		String tktBuf = null;</span>
<span class="nc" id="L637">		String ticketNumInDB=null;</span>
<span class="nc" id="L638">		String reprintCount = null;</span>
<span class="nc" id="L639">		ValidateTicketBean tktBean = new ValidateTicketBean();</span>
<span class="nc" id="L640">		tktBean.setValid(false);</span>
<span class="nc bnc" id="L641" title="All 6 branches missed.">		if (tktNum != null</span>
				&amp;&amp; (tktNum.length() == ConfigurationVariables.tktLenA || tktNum
						.length() == ConfigurationVariables.tktLenB)) {
<span class="nc bnc" id="L644" title="All 2 branches missed.">			if (tktNum.length() == ConfigurationVariables.tktLenA) {</span>
<span class="nc" id="L645">				tktLen = ConfigurationVariables.tktLenA;</span>
<span class="nc" id="L646">				retIdLen = ConfigurationVariables.retIdLenA;</span>
<span class="nc" id="L647">				tktBuf = tktNum.substring(retIdLen, retIdLen</span>
						+ ConfigurationVariables.gameNoLenA);
<span class="nc" id="L649">				reprintCount = tktNum.substring(tktLen - 2, tktLen);</span>
<span class="nc" id="L650">				ticketNumInDB=tktNum.substring(0, tktLen - 2);</span>
<span class="nc bnc" id="L651" title="All 2 branches missed.">			} else if (tktNum.length() == ConfigurationVariables.tktLenB) {</span>
<span class="nc" id="L652">				tktLen = ConfigurationVariables.tktLenB;</span>
<span class="nc" id="L653">				retIdLen = ConfigurationVariables.retIdLenB;</span>
<span class="nc" id="L654">				tktBuf = tktNum.substring(retIdLen, retIdLen</span>
						+ ConfigurationVariables.gameNoLenB);
<span class="nc" id="L656">				reprintCount = tktNum.substring(tktLen - 1, tktLen);</span>
<span class="nc" id="L657">				ticketNumInDB=tktNum.substring(0, tktLen - 1);</span>
			}
<span class="nc" id="L659">			gameNo = Integer.parseInt(tktBuf);</span>
<span class="nc" id="L660">			day = Integer.parseInt(tktNum.substring(retIdLen + tktBuf.length(),</span>
					retIdLen + tktBuf.length() + 3));
<span class="nc" id="L662">			gameName = getGameName(getGameIdFromLmsGameNumber(gameNo));</span>
<span class="nc bnc" id="L663" title="All 2 branches missed.">			if (gameName != null) {</span>
<span class="nc" id="L664">				tktBean.setGameName(gameName);</span>
<span class="nc" id="L665">				tktBean.setGameNo(gameNo);</span>
<span class="nc" id="L666">				tktBean.setReprintCount(reprintCount);</span>
<span class="nc" id="L667">				tktBean.setTicketNumInDB(ticketNumInDB);</span>
<span class="nc" id="L668">				tktBean.setValid(true);</span>
			}
<span class="nc bnc" id="L670" title="All 2 branches missed.">			if (day &gt; 366) {</span>
				//tktBean.setValid(false);
			}
<span class="nc" id="L673">			tktBean.setDayOfTicket(day);</span>
		}
<span class="nc" id="L675">		logger.debug(tktBean.getGameNo() + &quot;**Validate&quot;</span>
				+ tktBean.getTicketNumInDB() + &quot;**&quot; + tktBean.getReprintCount()
				+ &quot;**&quot; + tktBean.isValid());
<span class="nc" id="L678">		return tktBean;</span>
	}

	public static int getRaffData(
			List&lt;RafflePurchaseBean&gt; rafflePurchaseBeanList,
			StringBuilder raffleData, int appletHeight) {
<span class="nc bnc" id="L684" title="All 2 branches missed.">		if(rafflePurchaseBeanList != null){</span>
<span class="nc" id="L685">			RafflePurchaseBean bean = null;</span>
<span class="nc bnc" id="L686" title="All 2 branches missed.">			if (rafflePurchaseBeanList.size() &gt; 0) {</span>
<span class="nc" id="L687">				raffleData.deleteCharAt(raffleData.length() - 1);</span>
			}
<span class="nc bnc" id="L689" title="All 2 branches missed.">			for (int i = 0; i &lt; rafflePurchaseBeanList.size(); i++) {</span>
<span class="nc" id="L690">				bean = rafflePurchaseBeanList.get(i);</span>
<span class="nc" id="L691">				String raffTktType = bean.getRaffleTicketType();</span>
<span class="nc" id="L692">				raffleData.append(&quot;raffTktType-sprtr-&quot; + raffTktType</span>
						+ &quot;#raffTktNo-sprtr-&quot; + bean.getRaffleTicket_no()
						+ &quot;#raffDrawTime-sprtr-&quot; + bean.getDrawDateTime()
						+ &quot;#raffDispName-sprtr-&quot; + bean.getGameDispName() + &quot;Nxt&quot;);
<span class="nc bnc" id="L696" title="All 2 branches missed.">				if (&quot;ORIGINAL&quot;.equalsIgnoreCase(raffTktType)) {</span>
<span class="nc" id="L697">					appletHeight = appletHeight + 250;</span>
<span class="nc bnc" id="L698" title="All 2 branches missed.">				} else if (&quot;REFERENCE&quot;.equalsIgnoreCase(raffTktType)) {</span>
<span class="nc" id="L699">					appletHeight = appletHeight + 44;</span>
				}
			}
<span class="nc bnc" id="L702" title="All 2 branches missed.">			if (bean != null) {</span>
<span class="nc" id="L703">				raffleData.delete(raffleData.length() - 3, raffleData.length());</span>
			}
		}
<span class="nc" id="L706">		return appletHeight;</span>
	}

	public static int getPromoData(
			List&lt;LottoPurchaseBean&gt; promoPurchaseBeanList,
			StringBuilder finalPromoData, int appletHeight) {
		 
<span class="nc bnc" id="L713" title="All 2 branches missed.">			for(int j=0;j&lt;promoPurchaseBeanList.size();j++){</span>
<span class="nc" id="L714">				LottoPurchaseBean lottoBean=promoPurchaseBeanList.get(j);</span>
<span class="nc" id="L715">			String time = lottoBean.getPurchaseTime()</span>
			.replace(&quot; &quot;, &quot;|Time:&quot;).replace(&quot;.0&quot;, &quot;&quot;);
<span class="nc" id="L717">          	int listSize = lottoBean.getDrawDateTime().size();</span>
<span class="nc" id="L718">			StringBuilder drawTimeBuild = new StringBuilder(&quot;&quot;);</span>
<span class="nc bnc" id="L719" title="All 2 branches missed.">			for (int i = 0; i &lt; listSize; i++) {</span>
<span class="nc" id="L720">				drawTimeBuild.append((&quot;|DrawDate:&quot; + lottoBean</span>
						.getDrawDateTime().get(i)).replace(&quot; &quot;, &quot;|DrawTime:&quot;)
						.replace(&quot;.0&quot;, &quot;&quot;));
			}
<span class="nc" id="L724">			StringBuilder stBuilder = new StringBuilder(&quot;&quot;);</span>
<span class="nc bnc" id="L725" title="All 2 branches missed.">			for (int i = 0; i &lt; lottoBean.getPlayerPicked().size(); i++) {</span>
<span class="nc" id="L726">				stBuilder.append(&quot;|Num:&quot;</span>
						+ lottoBean.getPlayerPicked().get(i) + &quot;|QP:&quot;
						+ lottoBean.getIsQuickPick()[i]);
			}

<span class="nc" id="L731">			List&lt;RafflePurchaseBean&gt; rafflePurchaseBeanList = lottoBean</span>
			.getRafflePurchaseBeanList();
<span class="nc" id="L733">			String raffleData = CommonMethods</span>
			.buildRaffleData(rafflePurchaseBeanList);
			
<span class="nc" id="L736">			String finalData = &quot;PromoTkt:&quot; + &quot;TicketNo:&quot;</span>
					+ lottoBean.getTicket_no() + lottoBean.getReprintCount()
					+ &quot;|Date:&quot; + time 
					+ &quot;|PlayType:&quot; + lottoBean.getPlayType()
					+ stBuilder.toString()+ &quot;|TicketCost:&quot;
					+ lottoBean.getTotalPurchaseAmt() + drawTimeBuild.toString()
					+ &quot;|&quot;
					+ raffleData;
<span class="nc" id="L744">			finalPromoData.append(finalData);</span>
			}
		
		
<span class="nc" id="L748">		return appletHeight;</span>
	}
	public static int getRaffPWTData(
			List&lt;RaffleDrawIdBean&gt; raffleDrawIdBeanList,
			StringBuilder raffleData, int appletHeight) {
<span class="nc" id="L753">		RaffleDrawIdBean bean = null;</span>
<span class="nc bnc" id="L754" title="All 2 branches missed.">		if (raffleDrawIdBeanList.size() &gt; 0) {</span>
<span class="nc" id="L755">			raffleData.deleteCharAt(raffleData.length() - 1);</span>
		}
<span class="nc bnc" id="L757" title="All 2 branches missed.">		for (int i = 0; i &lt; raffleDrawIdBeanList.size(); i++) {</span>
<span class="nc" id="L758">			bean = raffleDrawIdBeanList.get(i);</span>
<span class="nc" id="L759">			String status = bean.getStatus();</span>
<span class="nc" id="L760">			String pwtStatus = bean.getPwtStatus();</span>
<span class="nc" id="L761">			double totalRaffleAmount = 0.0;</span>

<span class="nc bnc" id="L763" title="All 2 branches missed.">			if (&quot;FRAUD&quot;.equalsIgnoreCase(status)) {</span>
<span class="nc" id="L764">				raffleData.append(&quot;Cannot Verify.Invalid PWT&quot;);</span>
<span class="nc bnc" id="L765" title="All 2 branches missed.">			} else if (&quot;TICKET_EXPIRED&quot;.equalsIgnoreCase(status)) {</span>
<span class="nc" id="L766">				raffleData.append(&quot;Expired or Invalid Ticket&quot;);</span>
<span class="nc bnc" id="L767" title="All 2 branches missed.">			} else if (&quot;RES_AWAITED&quot;.equalsIgnoreCase(status)) {</span>
<span class="nc" id="L768">				raffleData.append(&quot;Awaited~&quot; + bean.getDrawDateTime());</span>
<span class="nc bnc" id="L769" title="All 2 branches missed.">			} else if (&quot;NON_WIN&quot;.equalsIgnoreCase(status)) {</span>
<span class="nc" id="L770">				raffleData.append(&quot;TRY AGAIN~&quot; + bean.getDrawDateTime());</span>
<span class="nc bnc" id="L771" title="All 2 branches missed.">			} else if (&quot;NORMAL_PAY&quot;.equalsIgnoreCase(status)) {</span>
				/*
				 * totalRaffleAmount = totalRaffleAmount +
				 * Double.parseDouble(bean.getWinningAmt());
				 */
<span class="nc" id="L776">				raffleData.append(&quot;WIN &quot; + bean.getWinningAmt() + &quot;~&quot;</span>
						+ bean.getDrawDateTime() + &quot;~&quot; + bean.getWinningAmt());
<span class="nc bnc" id="L778" title="All 2 branches missed.">			} else if (&quot;CLAIMED&quot;.equalsIgnoreCase(status)) {</span>
<span class="nc" id="L779">				raffleData.append(&quot;CLAIMED~&quot; + bean.getDrawDateTime());</span>
<span class="nc bnc" id="L780" title="All 2 branches missed.">			} else if (&quot;PND_PAY&quot;.equalsIgnoreCase(pwtStatus)) {</span>
<span class="nc" id="L781">				raffleData.append(&quot;Cannot Verify.High Prize&quot;);</span>
<span class="nc bnc" id="L782" title="All 2 branches missed.">			} else if (&quot;HIGH_PRIZE&quot;.equalsIgnoreCase(pwtStatus)) {</span>
<span class="nc" id="L783">				raffleData.append(&quot;Cannot Verify.High Prize&quot;);</span>
<span class="nc bnc" id="L784" title="All 2 branches missed.">			} else if (&quot;OUT_VERIFY_LIMIT&quot;.equalsIgnoreCase(pwtStatus)) {</span>
<span class="nc" id="L785">				raffleData.append(&quot;Cannot Verify.High Prize&quot;);</span>
<span class="nc bnc" id="L786" title="All 2 branches missed.">			} else if (&quot;OUT_PAY_LIMIT&quot;.equalsIgnoreCase(pwtStatus)) {</span>
<span class="nc" id="L787">				raffleData.append(&quot;Cannot Verify.High Prize&quot;);</span>
			}
<span class="nc" id="L789">			raffleData.append(&quot;Nxt&quot;);</span>
<span class="nc" id="L790">			appletHeight = appletHeight + 155;</span>
		}
<span class="nc bnc" id="L792" title="All 2 branches missed.">		if (bean != null) {</span>
<span class="nc" id="L793">			raffleData.delete(raffleData.length() - 3, raffleData.length());</span>
		}

<span class="nc" id="L796">		return appletHeight;</span>
	}

	public static String getPromoData(Object bean, String promoOriginalData) {
<span class="nc" id="L800">		StringBuilder finalData = new StringBuilder(&quot;&quot;);</span>
<span class="nc bnc" id="L801" title="All 2 branches missed.">		if (bean != null) {</span>
<span class="nc bnc" id="L802" title="All 2 branches missed.">			if (bean instanceof List) {</span>
				// To Be Implemented Later...
			} else {
<span class="nc" id="L805">				int barcodeCount=-1;</span>
<span class="nc" id="L806">				String gameName = &quot;&quot;;</span>
<span class="nc" id="L807">				String tktNo = &quot;&quot;;</span>
<span class="nc" id="L808">				String rpcCount = &quot;&quot;;</span>
<span class="nc" id="L809">				String saleStatus = &quot;&quot;;</span>
<span class="nc" id="L810">				String purchaseTime = &quot;&quot;;</span>
<span class="nc" id="L811">				String gameDispName = &quot;&quot;;</span>
<span class="nc" id="L812">				List drawDateList = null;</span>
<span class="nc" id="L813">				StringBuilder drawDateTime = new StringBuilder(&quot;&quot;);</span>
<span class="nc" id="L814">				StringBuilder pickNumStr = new StringBuilder(&quot;&quot;);</span>
<span class="nc" id="L815">				int expiryPeriod = 0;</span>
<span class="nc" id="L816">				int noOfDraws = 0;</span>
<span class="nc" id="L817">				double totPurchaseAmt = 0.0;</span>
<span class="nc" id="L818">				StringBuilder topMsgsStr = new StringBuilder(&quot; &quot;);</span>
<span class="nc" id="L819">				StringBuilder bottomMsgsStr = new StringBuilder(&quot; &quot;);</span>
<span class="nc" id="L820">				StringBuilder raffleData = new StringBuilder(&quot; &quot;);</span>
<span class="nc" id="L821">				int totalQuantity = 0;</span>
<span class="nc" id="L822">				StringBuilder gameDependentData = new StringBuilder(&quot;&quot;);</span>

<span class="nc bnc" id="L824" title="All 2 branches missed.">				if (bean instanceof FortunePurchaseBean) {</span>
<span class="nc" id="L825">					FortunePurchaseBean fortuneBean = (FortunePurchaseBean) bean;</span>
<span class="nc" id="L826">					gameName = Util.getGameName(fortuneBean.getGame_no());</span>
<span class="nc" id="L827">					tktNo = fortuneBean.getTicket_no();</span>
<span class="nc" id="L828">					rpcCount = fortuneBean.getReprintCount();</span>
<span class="nc" id="L829">					saleStatus = fortuneBean.getSaleStatus();</span>
<span class="nc" id="L830">					purchaseTime = fortuneBean.getPurchaseTime();</span>
<span class="nc" id="L831">					gameDispName = fortuneBean.getGameDispName();</span>
<span class="nc" id="L832">					drawDateList = fortuneBean.getDrawDateTime();</span>

<span class="nc" id="L834">					List&lt;Integer&gt; pickedNumbers = fortuneBean</span>
							.getPickedNumbers();
<span class="nc" id="L836">					pickNumStr = new StringBuilder(&quot;&quot;);</span>
<span class="nc bnc" id="L837" title="All 2 branches missed.">					for (int pickNum : pickedNumbers) {</span>
<span class="nc" id="L838">						pickNumStr.append(pickNum + &quot;,&quot;);</span>
<span class="nc" id="L839">					}</span>
<span class="nc bnc" id="L840" title="All 2 branches missed.">					if (pickNumStr.length() &gt; 0) {</span>
<span class="nc" id="L841">						pickNumStr.deleteCharAt(pickNumStr.length() - 1);</span>
					}

<span class="nc" id="L844">					int[] betAmtMulti = fortuneBean.getBetAmountMultiple();</span>
<span class="nc" id="L845">					StringBuilder betAmtStr = new StringBuilder(&quot;&quot;);</span>
<span class="nc bnc" id="L846" title="All 2 branches missed.">					for (int betAmt : betAmtMulti) {</span>
<span class="nc" id="L847">						betAmtStr.append(betAmt + &quot;,&quot;);</span>
<span class="nc" id="L848">						totalQuantity = totalQuantity + betAmt;</span>
					}
<span class="nc bnc" id="L850" title="All 2 branches missed.">					if (betAmtStr.length() &gt; 0) {</span>
<span class="nc" id="L851">						betAmtStr.deleteCharAt(betAmtStr.length() - 1);</span>
					}

<span class="nc" id="L854">					expiryPeriod = Util.getGameMap().get(</span>
							Util.getGameName(fortuneBean.getGame_no()))
							.getTicketExpiryPeriod();
<span class="nc" id="L857">					noOfDraws = fortuneBean.getNoOfDraws();</span>
<span class="nc" id="L858">					totPurchaseAmt = fortuneBean.getTotalPurchaseAmt();</span>

<span class="nc" id="L860">					int appHeight = 0;</span>
<span class="nc bnc" id="L861" title="All 2 branches missed.">					if (fortuneBean.getAdvMsg() != null) {</span>
<span class="nc" id="L862">						appHeight = getAdvMsgs(fortuneBean.getAdvMsg(),</span>
								topMsgsStr, bottomMsgsStr, appHeight);
					}

<span class="nc bnc" id="L866" title="All 2 branches missed.">					if (fortuneBean.getRafflePurchaseBeanList() != null) {</span>
<span class="nc" id="L867">						appHeight = getRaffData(fortuneBean</span>
								.getRafflePurchaseBeanList(), raffleData,
								appHeight);
					}

<span class="nc" id="L872">					gameDependentData.append(&quot;|isQP=&quot; + fortuneBean.getIsQP()</span>
							+ &quot;|betAmountMultiple=&quot; + betAmtStr
							+ &quot;|totalQuantity=&quot; + totalQuantity);

<span class="nc bnc" id="L876" title="All 2 branches missed.">				} else if (bean instanceof LottoPurchaseBean) {</span>
<span class="nc" id="L877">					LottoPurchaseBean lottoBean = (LottoPurchaseBean) bean;</span>
<span class="nc" id="L878">					gameName = &quot;Zimlottotwo&quot;;</span>
<span class="nc" id="L879">					tktNo = lottoBean.getTicket_no();</span>
<span class="nc" id="L880">					rpcCount = lottoBean.getReprintCount();</span>
<span class="nc" id="L881">					saleStatus = lottoBean.getSaleStatus();</span>
<span class="nc" id="L882">					purchaseTime = lottoBean.getPurchaseTime();</span>
<span class="nc" id="L883">					gameDispName = lottoBean.getGameDispName();</span>
<span class="nc" id="L884">					drawDateList = lottoBean.getDrawDateTime();</span>
<span class="nc" id="L885">					barcodeCount = lottoBean.getBarcodeCount();</span>
<span class="nc" id="L886">					List&lt;String&gt; pickedNumbers = lottoBean.getPlayerPicked();</span>
<span class="nc" id="L887">					pickNumStr = new StringBuilder(&quot;&quot;);</span>
<span class="nc bnc" id="L888" title="All 2 branches missed.">					for (String pickNum : pickedNumbers) {</span>
<span class="nc" id="L889">						pickNumStr.append(pickNum + &quot;;&quot;);</span>
<span class="nc" id="L890">					}</span>
<span class="nc bnc" id="L891" title="All 2 branches missed.">					if (pickNumStr.length() &gt; 0) {</span>
<span class="nc" id="L892">						pickNumStr.deleteCharAt(pickNumStr.length() - 1);</span>
					}

					/*
					expiryPeriod = Util.getGameMap().get(
							Util.getGameName(lottoBean.getGame_no()))
							.getTicketExpiryPeriod();
					*/
<span class="nc" id="L900">					expiryPeriod = Util.getGameMap().get(lottoBean.getGameId())</span>
							.getTicketExpiryPeriod();
<span class="nc" id="L902">					noOfDraws = lottoBean.getNoOfDraws();</span>
<span class="nc" id="L903">					totPurchaseAmt = lottoBean.getTotalPurchaseAmt();</span>

<span class="nc" id="L905">					int appHeight = 0;</span>
<span class="nc bnc" id="L906" title="All 2 branches missed.">					if (lottoBean.getAdvMsg() != null) {</span>
<span class="nc" id="L907">						appHeight = getAdvMsgs(lottoBean.getAdvMsg(),</span>
								topMsgsStr, bottomMsgsStr, appHeight);
					}

<span class="nc bnc" id="L911" title="All 2 branches missed.">					if (lottoBean.getRafflePurchaseBeanList() != null) {</span>
<span class="nc" id="L912">						appHeight = getRaffData(lottoBean</span>
								.getRafflePurchaseBeanList(), raffleData,
								appHeight);
					}
<span class="nc bnc" id="L916" title="All 2 branches missed.">					if(&quot;Perm6&quot;.equalsIgnoreCase(lottoBean.getPlayType())){</span>
<span class="nc" id="L917">						totalQuantity=lottoBean.getNoOfLines();</span>
					}else{
<span class="nc" id="L919">					totalQuantity = lottoBean.getPanel_id().length;</span>
					}
<span class="nc" id="L921">					StringBuilder quickPickStr = new StringBuilder(&quot;&quot;);</span>
<span class="nc bnc" id="L922" title="All 2 branches missed.">					for (int quickPick : lottoBean.getIsQuickPick()) {</span>
<span class="nc" id="L923">						quickPickStr.append(quickPick + &quot;,&quot;);</span>
					}
<span class="nc bnc" id="L925" title="All 2 branches missed.">					if (quickPickStr.length() &gt; 0) {</span>
<span class="nc" id="L926">						quickPickStr.deleteCharAt(quickPickStr.length() - 1);</span>
					}

<span class="nc" id="L929">					gameDependentData.append(&quot;|isQuickPickArray=&quot; + quickPickStr</span>
							+ &quot;|totalQuantity=&quot; + totalQuantity + &quot;|playType=&quot; +lottoBean.getPlayType());
<span class="nc bnc" id="L931" title="All 2 branches missed.">				} else if (bean instanceof KenoPurchaseBean) {</span>
<span class="nc" id="L932">					KenoPurchaseBean kenoBean = (KenoPurchaseBean) bean;</span>
<span class="nc" id="L933">					gameName = Util.getGameName(kenoBean.getGame_no());</span>
<span class="nc" id="L934">					tktNo = kenoBean.getTicket_no();</span>
<span class="nc" id="L935">					rpcCount = kenoBean.getReprintCount();</span>
<span class="nc" id="L936">					saleStatus = kenoBean.getSaleStatus();</span>
<span class="nc" id="L937">					purchaseTime = kenoBean.getPurchaseTime();</span>
<span class="nc" id="L938">					gameDispName = kenoBean.getGameDispName();</span>
<span class="nc" id="L939">					drawDateList = kenoBean.getDrawDateTime();</span>
<span class="nc" id="L940">					expiryPeriod = Util.getGameMap().get(</span>
							Util.getGameName(kenoBean.getGame_no()))
							.getTicketExpiryPeriod();
<span class="nc" id="L943">					noOfDraws = kenoBean.getNoOfDraws();</span>
<span class="nc" id="L944">					totPurchaseAmt = kenoBean.getTotalPurchaseAmt();</span>

<span class="nc" id="L946">					int appHeight = 0;</span>
<span class="nc bnc" id="L947" title="All 2 branches missed.">					if (kenoBean.getAdvMsg() != null) {</span>
<span class="nc" id="L948">						appHeight = getAdvMsgs(kenoBean.getAdvMsg(),</span>
								topMsgsStr, bottomMsgsStr, appHeight);
					}

<span class="nc bnc" id="L952" title="All 2 branches missed.">					if (kenoBean.getRafflePurchaseBeanList() != null) {</span>
<span class="nc" id="L953">						appHeight = getRaffData(kenoBean</span>
								.getRafflePurchaseBeanList(), raffleData,
								appHeight);
					}

<span class="nc" id="L958">					String[] playerDataApp = kenoBean.getPlayerData();</span>
<span class="nc" id="L959">					String[] playType = kenoBean.getPlayType();</span>
<span class="nc" id="L960">					int[] noOfLines = kenoBean.getNoOfLines();</span>
<span class="nc" id="L961">					double[] unitPrice = kenoBean.getUnitPrice();</span>
<span class="nc" id="L962">					int[] betAmtMul = kenoBean.getBetAmountMultiple();</span>
<span class="nc" id="L963">					int[] isQP = kenoBean.getIsQuickPick();</span>
<span class="nc" id="L964">					double[] panelPrice = new double[playType.length];</span>

<span class="nc" id="L966">					StringBuilder playerDataStr = new StringBuilder(&quot; &quot;);</span>
<span class="nc" id="L967">					StringBuilder playTypeStr = new StringBuilder(&quot; &quot;);</span>
<span class="nc" id="L968">					StringBuilder noOfLinesStr = new StringBuilder(&quot; &quot;);</span>
<span class="nc" id="L969">					StringBuilder unitPriceStr = new StringBuilder(&quot; &quot;);</span>
<span class="nc" id="L970">					StringBuilder isQPStr = new StringBuilder(&quot; &quot;);</span>
<span class="nc" id="L971">					StringBuilder panelPriceStr = new StringBuilder(&quot; &quot;);</span>

<span class="nc bnc" id="L973" title="All 2 branches missed.">					if (playerDataApp.length &gt; 0) {</span>
<span class="nc" id="L974">						playerDataStr.deleteCharAt(playerDataStr.length() - 1);</span>
<span class="nc" id="L975">						playTypeStr.deleteCharAt(playTypeStr.length() - 1);</span>
<span class="nc" id="L976">						noOfLinesStr.deleteCharAt(noOfLinesStr.length() - 1);</span>
<span class="nc" id="L977">						unitPriceStr.deleteCharAt(unitPriceStr.length() - 1);</span>
<span class="nc" id="L978">						isQPStr.deleteCharAt(isQPStr.length() - 1);</span>
<span class="nc" id="L979">						panelPriceStr.deleteCharAt(panelPriceStr.length() - 1);</span>

<span class="nc bnc" id="L981" title="All 2 branches missed.">						for (int panelId = 0; panelId &lt; playerDataApp.length; panelId++) {</span>
<span class="nc" id="L982">							playerDataStr.append(playerDataApp[panelId] + &quot;~&quot;);</span>
<span class="nc" id="L983">							playTypeStr.append(playType[panelId] + &quot;~&quot;);</span>
<span class="nc" id="L984">							noOfLinesStr.append(noOfLines[panelId] + &quot;~&quot;);</span>
<span class="nc" id="L985">							unitPriceStr</span>
									.append((unitPrice[panelId] * betAmtMul[panelId])
											+ &quot;~&quot;);
<span class="nc" id="L988">							isQPStr.append(isQP[panelId] + &quot;~&quot;);</span>
<span class="nc" id="L989">							panelPriceStr</span>
									.append((unitPrice[panelId]
											* betAmtMul[panelId]
											* noOfLines[panelId] * noOfDraws)
											+ &quot;~&quot;);

						}

<span class="nc" id="L997">						playerDataStr.deleteCharAt(playerDataStr.length() - 1);</span>
<span class="nc" id="L998">						playTypeStr.deleteCharAt(playTypeStr.length() - 1);</span>
<span class="nc" id="L999">						noOfLinesStr.deleteCharAt(noOfLinesStr.length() - 1);</span>
<span class="nc" id="L1000">						unitPriceStr.deleteCharAt(unitPriceStr.length() - 1);</span>
<span class="nc" id="L1001">						isQPStr.deleteCharAt(isQPStr.length() - 1);</span>
<span class="nc" id="L1002">						panelPriceStr.deleteCharAt(panelPriceStr.length() - 1);</span>
					}

<span class="nc" id="L1005">					pickNumStr = playerDataStr;</span>

<span class="nc" id="L1007">					gameDependentData.append(&quot;|isQP=&quot; + isQPStr</span>
							+ &quot;|totalQuantity=&quot; + noOfLinesStr + &quot;|playType=&quot;
							+ playTypeStr + &quot;|unitPriceStr=&quot; + unitPriceStr
							+ &quot;|panelPriceStr=&quot; + panelPriceStr);
				}
<span class="nc bnc" id="L1012" title="All 2 branches missed.">				for (int i = 0; i &lt; drawDateList.size(); i++) {</span>
<span class="nc" id="L1013">					drawDateTime.append(drawDateList.get(i).toString().split(&quot;&amp;&quot;)[0] + &quot;,&quot;);</span>
				}
<span class="nc bnc" id="L1015" title="All 2 branches missed.">				if (drawDateTime.length() &gt; 0) {</span>
<span class="nc" id="L1016">					drawDateTime.deleteCharAt(drawDateTime.length() - 1);</span>
				}

<span class="nc bnc" id="L1019" title="All 4 branches missed.">				finalData.append(&quot;data=&quot; + tktNo + rpcCount + (barcodeCount!=-1 &amp;&amp; LMSFilterDispatcher.isBarCodeRequired?barcodeCount:&quot;&quot;)+&quot;|gameName=&quot;</span>
						+ gameName + &quot;|mode=Buy&quot; + &quot;|saleStatus=&quot; + saleStatus
						+ promoOriginalData + &quot;|reprintCount=&quot; + rpcCount
						+ &quot;|purchaseTime=&quot; + purchaseTime + &quot;|gameDispName=&quot;
						+ gameDispName + &quot;|ticketNumber=&quot; + tktNo
						+ &quot;|drawDateTime=&quot; + drawDateTime + &quot;|pickedNumbers=&quot;
						+ pickNumStr + &quot;|expiryPeriod=&quot; + expiryPeriod
						+ &quot;|noOfDraws=&quot; + noOfDraws + &quot;|totalPurchaseAmt=&quot;
						+ totPurchaseAmt + &quot;|topAdvMsg=&quot; + topMsgsStr
						+ &quot;|bottomAdvMsg=&quot; + bottomMsgsStr + &quot;|raffleData=&quot;
						+ raffleData + gameDependentData);
			}
		}
<span class="nc" id="L1032">		return finalData.toString();</span>
	}

	public static String getOrgNameFromTktNo(String tktNum, String orgType) {
<span class="nc bnc" id="L1036" title="All 6 branches missed.">		if (tktNum != null</span>
				&amp;&amp; (tktNum.length() == ConfigurationVariables.tktLenA || tktNum
						.length() == ConfigurationVariables.tktLenB)) {
<span class="nc" id="L1039">			String userId = null;</span>
<span class="nc" id="L1040">			String orgName = null;</span>
<span class="nc bnc" id="L1041" title="All 2 branches missed.">			if (tktNum.length() == ConfigurationVariables.tktLenA) {</span>
<span class="nc" id="L1042">				userId = String.valueOf(getUserIdFromTicket(tktNum));</span>
<span class="nc bnc" id="L1043" title="All 2 branches missed.">			} else if (tktNum.length() == ConfigurationVariables.tktLenB) {</span>
				//userId = tktNum.substring(0, ConfigurationVariables.retIdLenB);
<span class="nc" id="L1045">				userId = String.valueOf(getUserIdFromTicket(tktNum));</span>
			}
<span class="nc bnc" id="L1047" title="All 2 branches missed.">			if (userId != null) {</span>
<span class="nc" id="L1048">				orgName = AjaxRequestHelper.getOrgNameFromUserId(Integer</span>
						.parseInt(userId), orgType);
<span class="nc" id="L1050">				return orgName;</span>
			}

		}

<span class="nc" id="L1055">		return null;</span>
	}

	/*public static String getOrgNameFromTktNoTemp(String tktNum, String orgType) {
		if (tktNum != null
				&amp;&amp; (tktNum.length() == ConfigurationVariables.tktLenA || tktNum
						.length() == ConfigurationVariables.tktLenB)) {
			String userId = null;
			String orgName = null;
			if (tktNum.length() == ConfigurationVariables.tktLenA) {
				userId =String.valueOf(getUserIdFromTicket(tktNum));
			} else if (tktNum.length() == ConfigurationVariables.tktLenB) {
				userId = tktNum.substring(0, ConfigurationVariables.retIdLenB);
			}
			if (userId != null) {
				orgName = AjaxRequestHelper.getOrgNameFromUserId(Integer
						.parseInt(userId), orgType);
				return orgName;
			}

		}

		return null;
	}*/
	
	
	
	public static Map&lt;Integer, String&gt; fetchActiveScratchGameList() {
<span class="nc" id="L1083">		Map&lt;Integer, String&gt; gMap = new HashMap&lt;Integer, String&gt;();</span>
<span class="nc" id="L1084">		Connection con = DBConnect.getConnection();</span>

		try {
<span class="nc" id="L1087">			Statement pstmt = con.createStatement();</span>
<span class="nc" id="L1088">			ResultSet rs = pstmt</span>
					.executeQuery(&quot;select game_nbr,game_name from st_se_game_master where game_status = 'OPEN'&quot;);
<span class="nc bnc" id="L1090" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1091">				gMap.put(rs.getInt(&quot;game_nbr&quot;), rs.getString(&quot;game_name&quot;));</span>
			}
<span class="nc" id="L1093">		} catch (Exception e) {</span>
<span class="nc" id="L1094">			e.printStackTrace();</span>
<span class="nc" id="L1095">			return null;</span>
<span class="nc" id="L1096">		}</span>
<span class="nc" id="L1097">		return gMap;</span>
	}

	public static int getGamenoFromTktnumber(String tktNum) {

<span class="nc" id="L1102">		int retIdLen = 0;</span>
<span class="nc" id="L1103">		int gameNo = 0;</span>
<span class="nc" id="L1104">		int tktLen = 0;</span>
<span class="nc" id="L1105">		String tktBuf = null;</span>

<span class="nc bnc" id="L1107" title="All 6 branches missed.">		if (tktNum != null</span>
				&amp;&amp; (tktNum.length() == ConfigurationVariables.tktLenA || tktNum
						.length() == ConfigurationVariables.tktLenB)) {
<span class="nc bnc" id="L1110" title="All 2 branches missed.">			if (tktNum.length() == ConfigurationVariables.tktLenA) {</span>
<span class="nc" id="L1111">				tktLen = ConfigurationVariables.tktLenA;</span>
<span class="nc" id="L1112">				retIdLen = ConfigurationVariables.retIdLenA;</span>
<span class="nc" id="L1113">				tktBuf = tktNum.substring(retIdLen, retIdLen</span>
						+ ConfigurationVariables.gameNoLenA);
<span class="nc bnc" id="L1115" title="All 2 branches missed.">			} else if (tktNum.length() == ConfigurationVariables.tktLenB) {</span>
<span class="nc" id="L1116">				tktLen = ConfigurationVariables.tktLenB;</span>
<span class="nc" id="L1117">				retIdLen = ConfigurationVariables.retIdLenB;</span>
<span class="nc" id="L1118">				tktBuf = tktNum.substring(retIdLen, retIdLen</span>
						+ ConfigurationVariables.gameNoLenB);
			}
<span class="nc" id="L1121">			gameNo = Integer.parseInt(tktBuf);</span>
		}
<span class="nc" id="L1123">		return gameNo;</span>

	}
	
	public static int getserviceIdFromTktNumber(String tktNum) throws LMSException {

<span class="nc" id="L1129">		int serviceId = 0;</span>
<span class="nc" id="L1130">		int randomDigits = 0;</span>

		try{
<span class="nc bnc" id="L1133" title="All 4 branches missed.">			if (tktNum != null	&amp;&amp; (tktNum.length() == ConfigurationVariables.tktLenB)) {</span>
<span class="nc" id="L1134">				randomDigits = ConfigurationVariables.RANDOM_RET_ID_B_RAND_DIGIT;</span>
<span class="nc" id="L1135">				serviceId = Integer.parseInt(tktNum.substring(randomDigits, (randomDigits + ConfigurationVariables.gameNoLenB)));</span>
			}else{
<span class="nc" id="L1137">				throw new LMSException(LMSErrors.INVALID_TICKET_ERROR_CODE , LMSErrors.INVALID_TICKET_ERROR_MESSAGE);</span>
			}
<span class="nc" id="L1139">		}catch (LMSException e) {</span>
<span class="nc" id="L1140">			throw e;</span>
<span class="nc" id="L1141">		}catch (Exception e) {</span>
<span class="nc" id="L1142">			throw new LMSException(LMSErrors.GENERAL_EXCEPTION_ERROR_CODE , LMSErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="nc" id="L1143">		}</span>
<span class="nc" id="L1144">		return serviceId;</span>
	}
	
	public static boolean checkDupRefTransId(String tpTxnId,int userOrgId){
<span class="nc" id="L1148">		String fetchRefTransId = &quot;select count(*) from st_lms_tp_txn_mapping where tp_ref_txn_id=&quot;+tpTxnId+&quot; and retailer_org_id=&quot;+userOrgId;</span>
<span class="nc" id="L1149">		boolean isDuplicate=true;</span>
		
		try{
<span class="nc" id="L1152">			Connection con = DBConnect.getConnection();</span>
			
			/*pstmt = con.prepareStatement(&quot;Select lms_txn_id from st_lms_tp_txn_mapping where tp_ref_txn_id = &quot;+tpTxnId);
			ResultSet rs = pstmt.executeQuery();
			if(rs.next()){//tp txn id already exists in DB
				return -1;
			}*/
<span class="nc" id="L1159">			Statement stmt = con.createStatement();</span>
<span class="nc" id="L1160">			ResultSet rs=stmt.executeQuery(fetchRefTransId);</span>
			
<span class="nc bnc" id="L1162" title="All 2 branches missed.">			if(rs.next()){</span>
<span class="nc bnc" id="L1163" title="All 2 branches missed.">				if(rs.getInt(1)==0){</span>
<span class="nc" id="L1164">					isDuplicate=false;</span>
				}
				}
<span class="nc" id="L1167">			DBConnect.closeCon(con);</span>
<span class="nc" id="L1168">		}catch (Exception e) {</span>
<span class="nc" id="L1169">			e.printStackTrace();</span>
<span class="nc" id="L1170">			return true;</span>
<span class="nc" id="L1171">		}</span>
		
<span class="nc" id="L1173">		return isDuplicate;</span>
	}

	public static String getTickNumberFromTransTickNo(long transTickNumber,
			int gameId, String query, Connection con) throws SQLException,
			LMSException {
		
<span class="nc" id="L1180">		String ticketNumber = &quot;&quot;;</span>
<span class="nc" id="L1181">		Statement stmt = con.createStatement();</span>
<span class="nc" id="L1182">		ResultSet rs = stmt.executeQuery(query);</span>
<span class="nc bnc" id="L1183" title="All 2 branches missed.">		if (rs.next()) {</span>
<span class="nc" id="L1184">			ticketNumber = rs.getString(&quot;ticket_nbr&quot;)  + getRpcAppenderForTickets(rs.getString(&quot;ticket_nbr&quot;).length());</span>
		}
<span class="nc" id="L1186">		return ticketNumber;</span>
	}
	
	
	public static int getMappingIdFromTxId(Timestamp txDateDate, int userId,
			Connection con) throws Exception {
		
<span class="nc" id="L1193">		int mappingId = 0;</span>
<span class="nc" id="L1194">		ResultSet rs = null;</span>
<span class="nc" id="L1195">		con = DBConnect.getConnection();</span>
<span class="nc" id="L1196">		PreparedStatement pstmt = con.prepareStatement(&quot;select user_mapping_id from st_lms_user_random_id_mapping_history where user_id  = ? and date(mapping_id_gen_date)&lt;= date(?) order by mapping_id_gen_date DESC limit 1&quot;);</span>
<span class="nc" id="L1197">		pstmt.setInt(1, userId);</span>
<span class="nc" id="L1198">		pstmt.setTimestamp(2, txDateDate);</span>
<span class="nc" id="L1199">		rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1200" title="All 2 branches missed.">		if (rs.next()) {</span>
<span class="nc" id="L1201">			mappingId = rs.getInt(&quot;user_mapping_id&quot;);</span>
		} else {
<span class="nc" id="L1203">			throw new LMSException(); // TEMP</span>
		}
<span class="nc" id="L1205">		return mappingId;</span>
	}
	
	public static int storeTPTxnId(int userOrgId,String lmsTxnId,String tpTxnId,String mobileNo){
<span class="nc" id="L1209">		String query = &quot;insert into st_lms_tp_txn_mapping (retailer_org_id,lms_txn_id,tp_ref_txn_id,mobile_no) values (?,?,?,?)&quot;;</span>
<span class="nc" id="L1210">		int rowInserted = 0;</span>
<span class="nc" id="L1211">		PreparedStatement pstmt  = null;</span>
		try{
<span class="nc" id="L1213">			Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L1214">			con.setAutoCommit(false);</span>
			/*pstmt = con.prepareStatement(&quot;Select lms_txn_id from st_lms_tp_txn_mapping where tp_ref_txn_id = &quot;+tpTxnId);
			ResultSet rs = pstmt.executeQuery();
			if(rs.next()){//tp txn id already exists in DB
				return -1;
			}*/
<span class="nc" id="L1220">			pstmt  = con.prepareStatement(query);</span>
<span class="nc" id="L1221">			pstmt.setInt(1, userOrgId);</span>
<span class="nc" id="L1222">			pstmt.setString(2, lmsTxnId);</span>
<span class="nc" id="L1223">			pstmt.setString(3, tpTxnId);</span>
<span class="nc" id="L1224">			pstmt.setString(4, mobileNo);</span>
<span class="nc" id="L1225">			logger.debug(&quot;TP API Insertion query &gt;&gt;&quot;+pstmt);</span>
<span class="nc" id="L1226">			rowInserted = pstmt.executeUpdate();</span>
<span class="nc bnc" id="L1227" title="All 2 branches missed.">			if(rowInserted &gt; 0 ){</span>
<span class="nc" id="L1228">				con.commit();</span>
			}
<span class="nc" id="L1230">			DBConnect.closeCon(con);</span>
<span class="nc" id="L1231">		}catch (Exception e) {</span>
<span class="nc" id="L1232">			e.printStackTrace();</span>
<span class="nc" id="L1233">			return 0;</span>
<span class="nc" id="L1234">		}</span>
		
<span class="nc" id="L1236">		return rowInserted;</span>
	}
	
	public static int insertLastSoldTicketTeminal(int userOrgId,String ticketNo,int gameId,Connection con) throws LMSException{
		
		//needs to be add new column interface type in st_dg_terminal_sale_ticket_gameId
<span class="nc" id="L1242">		String query = &quot;insert into st_dg_terminal_sale_ticket_&quot; + gameId +&quot; (Retailer_org_id,ticket_nbr,purchase_time) values (?,?,?)&quot;;</span>
<span class="nc" id="L1243">		int rowInserted = 0;</span>
<span class="nc" id="L1244">		PreparedStatement pstmt  = null;</span>
		try{
			
<span class="nc" id="L1247">			pstmt  = con.prepareStatement(query);</span>
<span class="nc" id="L1248">			pstmt.setInt(1,userOrgId);</span>
			//pstmt.setString(2, ticketNo.substring(0, ticketNo.length() - 2));
<span class="nc" id="L1250">			pstmt.setString(2, ticketNo);</span>
<span class="nc" id="L1251">			pstmt.setString(3, Util.getCurrentTimeString());</span>
			
<span class="nc" id="L1253">			logger.debug(&quot;Last Sold ticket Insertion query &gt;&gt;&quot;+pstmt);</span>
<span class="nc" id="L1254">			rowInserted = pstmt.executeUpdate();</span>
			
<span class="nc" id="L1256">		}catch (Exception e) {</span>
<span class="nc" id="L1257">			e.printStackTrace();</span>
<span class="nc" id="L1258">			throw new LMSException(&quot;&quot;);</span>
<span class="nc" id="L1259">		}</span>
		
<span class="nc" id="L1261">		return rowInserted;</span>
	}
	
	public static String sendMsgToUsers(String phnNo, String msg){
<span class="nc" id="L1265">		String finalResp = &quot;&quot;;</span>
<span class="nc" id="L1266">		String urlName = null;</span>
<span class="nc" id="L1267">		String urlData = null;</span>
		try{
<span class="nc" id="L1269">			String smsAPICountry = (String) ServletActionContext.getServletContext().getAttribute(&quot;SMS_API_COUNTRY&quot;);</span>
<span class="nc bnc" id="L1270" title="All 4 branches missed.">			if (smsAPICountry != null &amp;&amp; !&quot;NULL&quot;.equalsIgnoreCase(smsAPICountry)) {</span>
<span class="nc bnc" id="L1271" title="All 2 branches missed.">				if(&quot;KENYA&quot;.equalsIgnoreCase(smsAPICountry)){</span>
					//urlName = &quot;http://push1.maccesssmspush.com/servlet/com.aclwireless.pushconnectivity.listeners.TextListener&quot;;
					//urlData = &quot;userId:aclint1|pass:aclint1|appid:aclint1|subappid:aclint1|msgtype:1|contenttype:1|selfid:true|to:&quot;+phnNo+&quot;|from:DEMO|dlrreq:true|text:&quot;+msg;
<span class="nc" id="L1274">					String userName = &quot;demoint&quot;;</span>
<span class="nc" id="L1275">					String pwd = &quot;demoint1981&quot;;</span>
					
<span class="nc" id="L1277">					urlName = &quot;http://203.122.58.168/prepaidgetbroadcast/PrepaidGetBroadcast&quot;;</span>
<span class="nc" id="L1278">					urlData = &quot;userid:&quot;+userName+&quot;|pwd:&quot;+pwd+&quot;|msgtype:s|ctype:1|sender:sender|pno:&quot;+phnNo+&quot;|msgtxt:&quot;+msg+&quot;|alert:0&quot;;</span>
					
<span class="nc" id="L1280">					String apiResp = callSMSAPI(urlName, urlData);</span>
<span class="nc" id="L1281">					logger.debug(&quot;SMS API Response:&quot; + apiResp);</span>
					
<span class="nc" id="L1283">					finalResp = formatSMSResponse(apiResp, smsAPICountry);</span>
<span class="nc" id="L1284">					logger.debug(&quot;SMS Foramatted Response:&quot; + finalResp);</span>
<span class="nc bnc" id="L1285" title="All 2 branches missed.">				} else if(&quot;ZIMBABWE&quot;.equalsIgnoreCase(smsAPICountry)){</span>
					
				}
			}
			
			
<span class="nc" id="L1291">		} catch (Exception e) {</span>
<span class="nc" id="L1292">			e.printStackTrace();</span>
<span class="nc" id="L1293">		}</span>
<span class="nc" id="L1294">		return finalResp;</span>
	}
	
	public static String callSMSAPI(String urlName, String urlData){
<span class="nc" id="L1298">		String result = &quot;&quot;;</span>
		try {
<span class="nc" id="L1300">			String dataArr[] = urlData.split(&quot;\\|&quot;);</span>
<span class="nc" id="L1301">			StringBuilder urlStr = new StringBuilder(&quot;&quot;);</span>
<span class="nc bnc" id="L1302" title="All 2 branches missed.">			for (String data : dataArr) {</span>
<span class="nc" id="L1303">				String encodeData[] = data.split(&quot;:&quot;);</span>
<span class="nc" id="L1304">				urlStr.append(URLEncoder.encode(encodeData[0], &quot;UTF-8&quot;) + &quot;=&quot;</span>
						+ URLEncoder.encode(encodeData[1], &quot;UTF-8&quot;) + &quot;&amp;&quot;);
			}
<span class="nc" id="L1307">			urlStr.deleteCharAt(urlStr.length() - 1);</span>
		
			// Send data
<span class="nc" id="L1310">			URL url = new URL(urlName);</span>
<span class="nc" id="L1311">			URLConnection conn = url.openConnection();</span>
<span class="nc" id="L1312">			conn.setDoOutput(true);</span>
<span class="nc" id="L1313">			OutputStreamWriter wr = new OutputStreamWriter(conn</span>
					.getOutputStream());
<span class="nc" id="L1315">			wr.write(urlStr.toString());</span>
<span class="nc" id="L1316">			wr.flush();</span>
		
			// Get the response
<span class="nc" id="L1319">			BufferedReader rd = new BufferedReader(new InputStreamReader(conn</span>
					.getInputStream()));
<span class="nc" id="L1321">			result = rd.readLine();</span>
<span class="nc" id="L1322">			rd.close();</span>
<span class="nc" id="L1323">			wr.close();</span>
<span class="nc" id="L1324">			logger.debug(&quot;URL Name:&quot; + urlName);</span>
<span class="nc" id="L1325">			logger.debug(&quot;URL Data:&quot; + urlData);</span>
<span class="nc" id="L1326">		} catch (Exception e) {</span>
<span class="nc" id="L1327">			e.printStackTrace();</span>
<span class="nc" id="L1328">		}</span>
<span class="nc" id="L1329">		return result;</span>
	}
	
	public static String formatSMSResponse(String apiResp, String smsAPICountry){
<span class="nc" id="L1333">		String finalResp = null;</span>
		
<span class="nc" id="L1335">		finalResp = apiResp;</span>
		
<span class="nc" id="L1337">		return finalResp;</span>
	}
	
	public static List&lt;String&gt; rec(int start, int elementToChoose,
			int returnCnt, String[] indexArr, String[] elements,
			StringBuffer stbuff, List&lt;String&gt; comboList) {

<span class="nc bnc" id="L1344" title="All 2 branches missed.">		if (returnCnt == elementToChoose) {</span>
<span class="nc" id="L1345">			return comboList;</span>
		}
<span class="nc" id="L1347">		returnCnt++;</span>
<span class="nc bnc" id="L1348" title="All 2 branches missed.">		for (int i = start; i &lt; elements.length; i++) {</span>

<span class="nc" id="L1350">			indexArr[returnCnt - 1] = &quot;&quot; + i;</span>
<span class="nc bnc" id="L1351" title="All 2 branches missed.">			if (returnCnt == elementToChoose) {</span>

<span class="nc" id="L1353">				stbuff = new StringBuffer();</span>
<span class="nc bnc" id="L1354" title="All 2 branches missed.">				for (String element : indexArr) {</span>
<span class="nc" id="L1355">					stbuff.append(&quot;,&quot; + elements[Integer.parseInt(element)]);</span>
				}
<span class="nc" id="L1357">				stbuff.delete(0, 1);</span>
<span class="nc" id="L1358">				comboList.add(stbuff.toString());</span>
<span class="nc" id="L1359">				comboList.add(&quot;Nxt&quot;);</span>
			}

<span class="nc" id="L1362">			rec(++start, elementToChoose, returnCnt, indexArr, elements,</span>
					stbuff, comboList);
		}
<span class="nc" id="L1365">		return comboList;</span>
	}

	// NEW CODE SHOBHIT
	public static Map&lt;String, List&lt;String&gt;&gt; getDGSaleAdvMessage(int orgId, int gameId) throws SQLException
	{
<span class="nc" id="L1371">		Map&lt;String, List&lt;String&gt;&gt; msgMap = new HashMap&lt;String, List&lt;String&gt;&gt;();</span>

<span class="nc" id="L1373">		Set&lt;MessageDetailsBean&gt; msgSet = new HashSet&lt;MessageDetailsBean&gt;();</span>
<span class="nc bnc" id="L1374" title="All 4 branches missed.">		if(advMsgDataMap.get(orgId) != null &amp;&amp; advMsgDataMap.get(orgId).get(gameId) != null)</span>
<span class="nc" id="L1375">			msgSet.addAll(advMsgDataMap.get(orgId).get(gameId));</span>
<span class="nc bnc" id="L1376" title="All 4 branches missed.">		if(advMsgDataMap.get(-1) != null &amp;&amp; advMsgDataMap.get(-1).get(gameId) != null)</span>
<span class="nc" id="L1377">			msgSet.addAll(advMsgDataMap.get(-1).get(gameId));</span>

<span class="nc" id="L1379">		String msgLocation = null;</span>
<span class="nc bnc" id="L1380" title="All 2 branches missed.">		for(MessageDetailsBean bean : msgSet)</span>
		{
<span class="nc" id="L1382">			msgLocation = bean.getMessageLocation();</span>
<span class="nc bnc" id="L1383" title="All 2 branches missed.">			if(msgMap.containsKey(msgLocation))</span>
			{
<span class="nc" id="L1385">				msgMap.get(msgLocation).add(bean.getMessageText());</span>
			}
			else
			{
<span class="nc" id="L1389">				List&lt;String&gt; tempList = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L1390">				tempList.add(bean.getMessageText());</span>
<span class="nc" id="L1391">				msgMap.put(msgLocation, tempList);</span>
			}
<span class="nc" id="L1393">		}</span>

<span class="nc" id="L1395">		return msgMap;</span>
	}

	
	public static Map&lt;String, List&lt;String&gt;&gt; getAdvMessage(int orgId, int gameId,
			String forOrgType, String activity, String serviceType) throws SQLException {
<span class="nc" id="L1401">		Map&lt;String, List&lt;String&gt;&gt; msgMap = new HashMap&lt;String, List&lt;String&gt;&gt;();</span>
<span class="nc" id="L1402">		Connection con = DBConnect.getConnection();</span>
		
		try{
<span class="nc" id="L1405">			msgMap=getAdvMessage(orgId,gameId,forOrgType,activity,serviceType,con);</span>
<span class="nc" id="L1406">		}catch (SQLException se) {</span>
			
		}finally{
<span class="nc" id="L1409">			DBConnect.closeCon(con);</span>
<span class="nc" id="L1410">		}</span>
		
<span class="nc" id="L1412">		return msgMap;</span>
	}
	
	
	@SuppressWarnings(&quot;unchecked&quot;)
	public static Map&lt;String, List&lt;String&gt;&gt; getAdvMessage(int orgId, int gameId,
			String forOrgType, String activity, String serviceType,Connection con) throws SQLException {
<span class="nc" id="L1419">		Map&lt;String, List&lt;String&gt;&gt; msgMap = new HashMap&lt;String, List&lt;String&gt;&gt;();</span>
<span class="nc" id="L1420">		int serviceId = ((Map&lt;String, Integer&gt;)LMSUtility.sc.getAttribute(&quot;SERVICES_CODE_ID_MAP&quot;)).get(serviceType);</span>
		
<span class="nc" id="L1422">		Statement drawStmt = con.createStatement();</span>
<span class="nc" id="L1423">		String msgLocation = null;</span>
<span class="nc" id="L1424">		String query = &quot;select msg_text,org_id,game_id,activity,msg_location  from st_dg_adv_msg_org_mapping mop,st_dg_adv_msg_master mm where (org_id=&quot;</span>
				+ orgId
				+ &quot; or org_id=-1) and mm.msg_id = mop.msg_id and mm.status='ACTIVE'  and service_id=&quot;+serviceId+&quot;  and msg_for='&quot;
				+ forOrgType + &quot;'&quot;;
<span class="nc" id="L1428">		StringBuilder whereClause = new StringBuilder(&quot;&quot;);</span>
<span class="nc bnc" id="L1429" title="All 2 branches missed.">		if (gameId != 0) {</span>
<span class="nc" id="L1430">			whereClause.append(&quot; and mop.game_id=&quot; + gameId);</span>
		}
<span class="nc bnc" id="L1432" title="All 2 branches missed.">		if (activity != null) {</span>
<span class="nc" id="L1433">			whereClause.append(&quot; and (mm.activity='&quot; + activity</span>
					+ &quot;' or mm.activity='ALL')&quot;);
		}
<span class="nc" id="L1436">		logger.debug(query + whereClause);</span>
<span class="nc" id="L1437">		ResultSet retRs = drawStmt.executeQuery(query + whereClause);</span>
<span class="nc bnc" id="L1438" title="All 2 branches missed.">		while (retRs.next()) {</span>
<span class="nc" id="L1439">			msgLocation = retRs.getString(&quot;msg_location&quot;);</span>
<span class="nc bnc" id="L1440" title="All 2 branches missed.">			if (msgMap.containsKey(msgLocation)) {</span>
<span class="nc" id="L1441">				msgMap.get(msgLocation).add(retRs.getString(&quot;msg_text&quot;));</span>
			} else {
<span class="nc" id="L1443">				List&lt;String&gt; tempList = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L1444">				tempList.add(retRs.getString(&quot;msg_text&quot;));</span>
<span class="nc" id="L1445">				msgMap.put(retRs.getString(&quot;msg_location&quot;), tempList);</span>
<span class="nc" id="L1446">			}</span>
		}
		
<span class="nc" id="L1449">		return msgMap;</span>
	}
	
	
	public static void setHeartBeatAndSaleTime(int orgId,String taskName,Connection con) {		
<span class="nc" id="L1454">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L1455">		String query =null;</span>
		try{
<span class="nc bnc" id="L1457" title="All 2 branches missed.">			if(taskName.equals(&quot;SALE&quot;)){</span>
<span class="nc" id="L1458">				query = &quot;update st_lms_ret_offline_master set last_HBT_time=?,dg_last_sale_time=? where organization_id=?&quot;;</span>
<span class="nc bnc" id="L1459" title="All 2 branches missed.">			} else if(taskName.equals(&quot;PWT&quot;)){</span>
<span class="nc" id="L1460">				query = &quot;update st_lms_ret_offline_master set last_HBT_time=?,dg_last_pwt_time=? where organization_id=?&quot;;</span>
<span class="nc bnc" id="L1461" title="All 2 branches missed.">			}else if(taskName.equals(&quot;OLA_DEP&quot;)){</span>
<span class="nc" id="L1462">				query = &quot;update st_lms_ret_offline_master set last_HBT_time=?,ola_last_deposit_time=? where organization_id=?&quot;;</span>
<span class="nc bnc" id="L1463" title="All 2 branches missed.">			}else if(taskName.equals(&quot;OLA_WITH&quot;)){</span>
<span class="nc" id="L1464">				query = &quot;update st_lms_ret_offline_master set last_HBT_time=?,ola_last_withdrawal_time=? where organization_id=?&quot;;</span>
<span class="nc bnc" id="L1465" title="All 2 branches missed.">			}else if(taskName.equals(&quot;SLE_SALE&quot;)){</span>
<span class="nc" id="L1466">				query = &quot;update st_lms_ret_offline_master set last_HBT_time=?,sle_last_sale_time=? where organization_id=?&quot;;</span>
<span class="nc bnc" id="L1467" title="All 2 branches missed.">			}else if(taskName.equals(&quot;SLE_PWT&quot;)){</span>
<span class="nc" id="L1468">				query = &quot;update st_lms_ret_offline_master set last_HBT_time=?,sle_last_pwt_time=? where organization_id=?&quot;;</span>
<span class="nc bnc" id="L1469" title="All 2 branches missed.">			} else if (&quot;IW_SALE&quot;.equals(taskName)) {</span>
<span class="nc" id="L1470">				query = &quot;update st_lms_ret_offline_master set last_HBT_time=?,iw_last_sale_time=? where organization_id=?&quot;;</span>
<span class="nc bnc" id="L1471" title="All 2 branches missed.">			} else if (&quot;IW_PWT&quot;.equals(taskName)) {</span>
<span class="nc" id="L1472">				query = &quot;update st_lms_ret_offline_master set last_HBT_time=?, iw_last_pwt_time=? where organization_id=?&quot;;</span>
<span class="nc bnc" id="L1473" title="All 2 branches missed.">			}else if (&quot;VS_SALE&quot;.equals(taskName)) {</span>
<span class="nc" id="L1474">				query = &quot;update st_lms_ret_offline_master set last_HBT_time=?, vs_last_sale_time=? where organization_id=?&quot;;</span>
<span class="nc bnc" id="L1475" title="All 2 branches missed.">			} else if (&quot;VS_PWT&quot;.equals(taskName)) {</span>
<span class="nc" id="L1476">				query = &quot;update st_lms_ret_offline_master set last_HBT_time=?, vs_last_pwt_time=? where organization_id=?&quot;;</span>
			}
<span class="nc" id="L1478">			pstmt = con.prepareStatement(query);</span>
<span class="nc" id="L1479">			pstmt.setTimestamp(1, Util.getCurrentTimeStamp());</span>
<span class="nc" id="L1480">			pstmt.setTimestamp(2, Util.getCurrentTimeStamp());</span>
<span class="nc" id="L1481">			pstmt.setInt(3, orgId);</span>
<span class="nc" id="L1482">			pstmt.executeUpdate();			</span>
<span class="nc" id="L1483">		}catch(SQLException e){</span>
<span class="nc" id="L1484">			logger.error(e);</span>
<span class="nc" id="L1485">			e.printStackTrace();</span>
<span class="nc" id="L1486">		}</span>
<span class="nc" id="L1487">	}</span>
	
	public static int getUserIdFromTicket(String ticketNumber) {
<span class="nc" id="L1490">		int userId=0;</span>
		try{
<span class="nc" id="L1492">		userId = getUserIDForTicketNumber(ticketNumber); </span>
<span class="nc" id="L1493">		}catch (Exception e) {</span>
<span class="nc" id="L1494">			logger.error(&quot;Exception : - &quot; , e);</span>
<span class="nc" id="L1495">		}</span>
<span class="nc" id="L1496">		return userId;</span>
	}

	public static int getUserIdFromTicket(String ticketNumber, Connection connection) {
<span class="nc" id="L1500">		int userId = 0;</span>
		try {
<span class="nc" id="L1502">			userId = getUserIDForTicketNumber(ticketNumber, connection); </span>
<span class="nc" id="L1503">		} catch (Exception e) {</span>
<span class="nc" id="L1504">			logger.error(&quot;Exception : - &quot; , e);</span>
<span class="nc" id="L1505">		}</span>

<span class="nc" id="L1507">		return userId;</span>
	}

	/**
	 * 
	 * @param ticketNumber
	 * @return
	 * @throws LMSException
	 */
	private static int getUserIDForTicketNumber(String ticketNumber) throws LMSException {
<span class="nc" id="L1517">		int userId = 0;</span>
<span class="nc" id="L1518">		Connection con = null;</span>
		try {
<span class="nc" id="L1520">			 con = DBConnect.getConnection();</span>
<span class="nc" id="L1521">			 userId = getUserIDForTicketNumber(ticketNumber, con);</span>
<span class="nc" id="L1522">		}catch (LMSException e) {</span>
<span class="nc" id="L1523">			logger.error(&quot;LMSException :- &quot; , e);</span>
<span class="nc" id="L1524">			throw e;</span>
<span class="nc" id="L1525">		}catch (Exception e) {</span>
<span class="nc" id="L1526">			logger.error(&quot;Exception :- &quot; , e);</span>
<span class="nc" id="L1527">			throw new LMSException(LMSErrors.GENERAL_EXCEPTION_ERROR_CODE , LMSErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
		}finally{
<span class="nc" id="L1529">		DBConnect.closeCon(con);</span>
<span class="nc" id="L1530">	}</span>
<span class="nc" id="L1531">		return userId;</span>
	}

	private static int getUserIDForTicketNumber(String ticketNumber, Connection connection) throws LMSException {

<span class="nc" id="L1536">		int userId = 0;</span>
<span class="nc" id="L1537">		int gameId = 0;</span>
<span class="nc" id="L1538">		int gameNbr = 0;</span>
<span class="nc" id="L1539">		int serviceId = 0; </span>
<span class="nc" id="L1540">		String serviceCode = null;</span>
		
<span class="nc" id="L1542">		String tktNbr = null;</span>
<span class="nc" id="L1543">		String checkQuery = null;</span>
<span class="nc" id="L1544">		Timestamp tktFormatChngDate = null;</span>
		
<span class="nc" id="L1546">		ResultSet rs = null;</span>
<span class="nc" id="L1547">		PreparedStatement pstmt = null;</span>
		try {
<span class="nc" id="L1549">			tktFormatChngDate = new Timestamp(new SimpleDateFormat(&quot;yyyy-MM-dd&quot;).parse(Utility.getPropertyValue(&quot;USER_MAPPING_ID_DEPLOYMENT_DATE&quot;)).getTime());</span>
<span class="nc" id="L1550">			 tktNbr =  getTicketNumber(ticketNumber, 3);</span>
<span class="nc bnc" id="L1551" title="All 4 branches missed.">			 if(&quot;&quot;.equalsIgnoreCase(tktNbr) || &quot;ERROR&quot;.equalsIgnoreCase(tktNbr)) </span>
<span class="nc" id="L1552">				 throw new LMSException(LMSErrors.INVALID_TICKET_ERROR_CODE,LMSErrors.INVALID_TICKET_ERROR_MESSAGE);</span>
			 
<span class="nc" id="L1554">			 serviceId = getserviceIdFromTktNumber(tktNbr);</span>
			 // GET SERVICE CODE FROM SERVICE ID AND DECIDE THE SALE TABLE  if DG then , st_dg_ret_sale_GAMEID
<span class="nc" id="L1556">			 serviceCode = getServiceCodeFromId(serviceId , connection);</span>

<span class="nc bnc" id="L1558" title="All 2 branches missed.">			 if(!&quot;SLE&quot;.equals(serviceCode)) {</span>
<span class="nc" id="L1559">				 gameNbr = getGamenoFromTktnumber(tktNbr);</span>
<span class="nc" id="L1560">				 gameId = Util.getGameIdFromGameNumber(gameNbr);</span>
<span class="nc bnc" id="L1561" title="All 2 branches missed.">				 if(gameId == 0)</span>
<span class="nc" id="L1562">					 throw new LMSException(LMSErrors.INVALID_TICKET_ERROR_CODE,LMSErrors.INVALID_TICKET_ERROR_MESSAGE);</span>
			 	}
			 
<span class="nc bnc" id="L1565" title="All 2 branches missed.">			 if(tktFormatChngDate.before(getDateOfTransaction(tktNbr))){</span>

<span class="nc bnc" id="L1567" title="All 2 branches missed.">				 if(serviceCode == null){</span>
<span class="nc" id="L1568">					throw new LMSException(LMSErrors.INVALID_SERVICE_ON_TICKET_ERROR_CODE , LMSErrors.INVALID_SERVICE_ON_TICKET_ERROR_MESSAGE);</span>
<span class="nc bnc" id="L1569" title="All 2 branches missed.">				 }else if(serviceCode.equalsIgnoreCase(&quot;DG&quot;)){</span>
<span class="nc" id="L1570">					checkQuery = &quot;select retailer_user_id user_id , transaction_date from st_dg_ret_sale_? sale , st_lms_retailer_transaction_master tx where sale.transaction_id = tx.transaction_id and ticket_nbr = ?&quot;;</span>
<span class="nc" id="L1571">					pstmt = connection.prepareStatement(checkQuery);</span>
<span class="nc" id="L1572">					pstmt.setInt(1, gameId);</span>
<span class="nc" id="L1573">					pstmt.setString(2 , tktNbr.substring(0,tktNbr.length()-1));</span>
<span class="nc bnc" id="L1574" title="All 2 branches missed.">				 }else if(&quot;SLE&quot;.equals(serviceCode)){</span>
<span class="nc" id="L1575">					checkQuery = &quot;select retailer_user_id user_id from st_sle_ret_sale sale inner join st_lms_retailer_transaction_master tx on sale.transaction_id = tx.transaction_id and ticket_nbr = ?&quot;;</span>
<span class="nc" id="L1576">					pstmt = connection.prepareStatement(checkQuery);</span>
<span class="nc" id="L1577">					pstmt.setString(1 , tktNbr.substring(0,tktNbr.length()-1));</span>
				 }else{
<span class="nc" id="L1579">					 throw new LMSException(LMSErrors.INVALID_SERVICE_ON_TICKET_ERROR_CODE ,LMSErrors.INVALID_SERVICE_ON_TICKET_ERROR_MESSAGE);</span>
				 }

<span class="nc" id="L1582">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1583" title="All 2 branches missed.">				if(rs.next()){</span>
<span class="nc" id="L1584">					userId =  rs.getInt(&quot;user_id&quot;);</span>
				}else{
<span class="nc" id="L1586">					throw new LMSException(LMSErrors.INVALID_TICKET_ERROR_CODE,LMSErrors.INVALID_TICKET_ERROR_MESSAGE);</span>
				}
			 }else{
<span class="nc bnc" id="L1589" title="All 4 branches missed.">				 if (ticketNumber.length() ==ConfigurationVariables.currentTktLen &amp;&amp; ticketNumber.length() == ConfigurationVariables.tktLenB) {</span>
<span class="nc" id="L1590">						userId=Integer.parseInt(ticketNumber.substring(0,ConfigurationVariables.retIdLenB));</span>
					}else{
<span class="nc" id="L1592">						throw new LMSException(LMSErrors.INVALID_TICKET_ERROR_CODE,LMSErrors.INVALID_TICKET_ERROR_MESSAGE);</span>
					}
				}
<span class="nc" id="L1595">		}catch (LMSException e) {</span>
<span class="nc" id="L1596">			logger.error(&quot;LMSException :- &quot; , e);</span>
<span class="nc" id="L1597">			throw e;</span>
<span class="nc" id="L1598">		}catch (SQLException e) {</span>
<span class="nc" id="L1599">			logger.error(&quot;SQLException :- &quot; , e);</span>
<span class="nc" id="L1600">			throw new LMSException(LMSErrors.SQL_EXCEPTION_ERROR_CODE , LMSErrors.SQL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="nc" id="L1601">		}catch (Exception e) {</span>
<span class="nc" id="L1602">			logger.error(&quot;Exception :- &quot; , e);</span>
<span class="nc" id="L1603">			throw new LMSException(LMSErrors.GENERAL_EXCEPTION_ERROR_CODE , LMSErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
		}finally{
<span class="nc" id="L1605">			DBConnect.closeConnection(pstmt, rs);</span>
<span class="nc" id="L1606">		}</span>
<span class="nc" id="L1607">		return userId;</span>
	}

	public static String getServiceCodeFromId(int serviceId , Connection con){

<span class="nc" id="L1612">		ResultSet rs = null;</span>
<span class="nc" id="L1613">		Statement stmt = null;</span>
<span class="nc" id="L1614">		String serviceCode = null;</span>
		try {
			
<span class="nc" id="L1617">			stmt = con.createStatement();</span>
<span class="nc" id="L1618">			rs = stmt.executeQuery(&quot;select SQL_CACHE service_code from st_lms_service_master where service_id = &quot;+serviceId);</span>
<span class="nc bnc" id="L1619" title="All 2 branches missed.">			if(rs.next()){</span>
<span class="nc" id="L1620">				serviceCode = rs.getString(&quot;service_code&quot;);</span>
			}
<span class="nc" id="L1622">		} catch (Exception e) {</span>
<span class="nc" id="L1623">			e.printStackTrace();</span>
		}finally{
<span class="nc" id="L1625">			DBConnect.closeConnection(stmt, rs);</span>
<span class="nc" id="L1626">		}</span>

<span class="nc" id="L1628">		return serviceCode;</span>
	}
	
	public static String getTicketNumberFormat(String ticketNumber) throws LMSException{
<span class="nc" id="L1632">		Timestamp tktFormatChngDate = null;</span>
		
		try{
<span class="nc" id="L1635">				tktFormatChngDate = new Timestamp(new SimpleDateFormat(&quot;yyyy-MM-dd&quot;).parse(Utility.getPropertyValue(&quot;USER_MAPPING_ID_DEPLOYMENT_DATE&quot;)).getTime());</span>
<span class="nc bnc" id="L1636" title="All 2 branches missed.">				 if(tktFormatChngDate.before(getDateOfTransaction(ticketNumber))){</span>
<span class="nc" id="L1637">					 return &quot;NEWTKTFORMAT&quot;;</span>
				 }else{
<span class="nc" id="L1639">					 return &quot;OLDTKTFORMAT&quot;;</span>
				 }			
			
<span class="nc" id="L1642">		}catch(LMSException e){</span>
<span class="nc" id="L1643">			logger.error(&quot;LMSException :- &quot; , e);</span>
<span class="nc" id="L1644">			throw e;</span>
<span class="nc" id="L1645">		}catch(Exception e){</span>
<span class="nc" id="L1646">			logger.error(&quot;LMSException :- &quot; , e);</span>
<span class="nc" id="L1647">			throw new LMSException(LMSErrors.GENERAL_EXCEPTION_ERROR_CODE , LMSErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
		}
	}
	
	public static Timestamp getDateOfTransaction(String tktNum) throws LMSException {
<span class="nc" id="L1652">		int day = 0;</span>
<span class="nc" id="L1653">		Timestamp dateOfTransaction = null;</span>
<span class="nc bnc" id="L1654" title="All 4 branches missed.">		if (tktNum != null &amp;&amp; tktNum.length() == ConfigurationVariables.tktLenB) {</span>
<span class="nc" id="L1655">			int range = ConfigurationVariables.retIdLenB+ ConfigurationVariables.gameNoLenB;</span>
<span class="nc" id="L1656">			day = Integer.parseInt(tktNum.substring(range, (range+3)));</span>
<span class="nc" id="L1657">			Calendar cal = Calendar.getInstance();</span>
<span class="nc" id="L1658">			int expiryPeriod = cal.get(Calendar.DAY_OF_YEAR) - day;</span>
<span class="nc bnc" id="L1659" title="All 2 branches missed.">			if (expiryPeriod &lt; 0) {</span>
<span class="nc" id="L1660">				cal.set(cal.get(Calendar.YEAR) - 1, 1, 1);</span>
<span class="nc" id="L1661">				cal.set(Calendar.DAY_OF_YEAR, day);</span>
			}else{
<span class="nc" id="L1663">				cal.set(Calendar.DAY_OF_YEAR, day);</span>
			}
<span class="nc" id="L1665">			cal.set(Calendar.HOUR, 00);</span>
<span class="nc" id="L1666">			cal.set(Calendar.MINUTE, 00);</span>
<span class="nc" id="L1667">			cal.set(Calendar.SECOND, 00);</span>
<span class="nc" id="L1668">			dateOfTransaction = new Timestamp(cal.getTimeInMillis());</span>
			/*if (day &gt; 366) {
				throw new LMSException(LMSErrors.INVALID_TICKET_ERROR_CODE , LMSErrors.INVALID_TICKET_ERROR_MESSAGE);
			} else {
				Calendar cal = Calendar.getInstance();
				int expiryPeriod = cal.get(Calendar.DAY_OF_YEAR) - day;
				if (expiryPeriod &lt; 0) {
					cal.set(cal.get(Calendar.YEAR) - 1, 1, 1);
					cal.set(Calendar.DAY_OF_YEAR, day);
				}else{
					cal.set(Calendar.DAY_OF_YEAR, day);
				}
				cal.set(Calendar.HOUR, 00);
				cal.set(Calendar.MINUTE, 00);
				cal.set(Calendar.SECOND, 00);
				dateOfTransaction = new Timestamp(cal.getTimeInMillis());
			}*/
<span class="nc" id="L1685">		}else{</span>
<span class="nc" id="L1686">			throw new LMSException(LMSErrors.INVALID_TICKET_ERROR_CODE , LMSErrors.INVALID_TICKET_ERROR_MESSAGE);</span>
		}
<span class="nc" id="L1688">		return dateOfTransaction;</span>
	}
	
	public static boolean canClaimAnywhere(String ticketNo, boolean isAgent,
			int userOrgId) {

<span class="nc" id="L1694">		int userId = 0;</span>
<span class="nc" id="L1695">		int organizationId = 0;</span>
<span class="nc" id="L1696">		boolean canClaim = false;</span>
		
<span class="nc" id="L1698">		ResultSet rs = null;</span>
<span class="nc" id="L1699">		Connection con = null;</span>
<span class="nc" id="L1700">		PreparedStatement pstmt = null;</span>
		try {

<span class="nc" id="L1703">			userId = Util.getUserIdFromTicket(ticketNo);</span>
<span class="nc" id="L1704">			String retQuery = &quot;(select organization_id from st_lms_user_master where user_id=&quot;</span>
					+ userId + &quot;)&quot;;
<span class="nc" id="L1706">			String agtQuery = &quot;(select parent_id organization_id from st_lms_organization_master where organization_id=&quot;</span>
					+ retQuery + &quot;)&quot;;

<span class="nc" id="L1709">			con = DBConnect.getConnection();</span>
<span class="nc" id="L1710">			pstmt = con</span>
					.prepareStatement(&quot;select claim_any_ticket from st_lms_oranization_limits where organization_id=?&quot;);
<span class="nc" id="L1712">			pstmt.setInt(1, userOrgId);</span>
<span class="nc" id="L1713">			rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L1715" title="All 4 branches missed.">			if (rs.next() &amp;&amp; rs.getBoolean(1)) {</span>
<span class="nc" id="L1716">				canClaim = true;</span>
			} else {
<span class="nc bnc" id="L1718" title="All 2 branches missed.">				if (isAgent)</span>
<span class="nc" id="L1719">					pstmt = con.prepareStatement(agtQuery);</span>
				else
<span class="nc" id="L1721">					pstmt = con.prepareStatement(retQuery);</span>

<span class="nc" id="L1723">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1724" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L1725">					organizationId = rs.getInt(1);</span>
				}
<span class="nc bnc" id="L1727" title="All 2 branches missed.">				if (organizationId == userOrgId)</span>
<span class="nc" id="L1728">					canClaim = true;</span>
			}
<span class="nc" id="L1730">		} catch (SQLException e) {</span>
<span class="nc" id="L1731">			logger.error(&quot;SQLException&quot; , e);</span>
<span class="nc" id="L1732">		}catch (Exception e) {</span>
<span class="nc" id="L1733">			logger.error(&quot;Exception&quot; , e);</span>
		}finally{
<span class="nc" id="L1735">		DBConnect.closeConnection(con, pstmt, rs);</span>
<span class="nc" id="L1736">	}</span>
<span class="nc" id="L1737">		return canClaim;</span>
	}
	
	public static String getTicketNumber(String ticketNumber, int InpType) {
<span class="nc" id="L1741">		String originalTicket = &quot;&quot;;</span>
<span class="nc bnc" id="L1742" title="All 4 branches missed.">		if (ticketNumber != null &amp;&amp; ticketNumber != &quot;&quot;) {</span>
<span class="nc" id="L1743">			int ticketLength = ticketNumber.length();</span>
<span class="nc bnc" id="L1744" title="All 4 branches missed.">			switch (InpType) {</span>
			case 1:
<span class="nc bnc" id="L1746" title="All 2 branches missed.">				if (ticketLength == com.skilrock.lms.common.ConfigurationVariables.barcodeCount) {</span>
<span class="nc" id="L1747">					originalTicket = Util.getTicketNumberForBarCode(ticketNumber);</span>
				}
				break;
			case 2:
<span class="nc bnc" id="L1751" title="All 4 branches missed.">				if (ticketLength == ConfigurationVariables.tktLenA</span>
						|| ticketLength == ConfigurationVariables.tktLenB) 
<span class="nc" id="L1753">					originalTicket = ticketNumber;</span>
				
				break;
			case 3:
<span class="nc bnc" id="L1757" title="All 2 branches missed.">				if (ticketLength == com.skilrock.lms.common.ConfigurationVariables.barcodeCount) {</span>
<span class="nc" id="L1758">					originalTicket = Util.getTicketNumberForBarCode(ticketNumber);</span>
<span class="nc bnc" id="L1759" title="All 4 branches missed.">				} else if (ticketLength == ConfigurationVariables.tktLenA</span>
						|| ticketLength == ConfigurationVariables.tktLenB) {
<span class="nc" id="L1761">					originalTicket = ticketNumber;</span>
				}
				break;
			default:
<span class="nc" id="L1765">				originalTicket = &quot;ERROR&quot;;</span>
				break;
			}
		}
<span class="nc" id="L1769">		return originalTicket;</span>
	}
	
	public static String getTicketNumberForBarCode(String ticketNumber) {
<span class="nc" id="L1773">		return ticketNumber.substring(0, com.skilrock.lms.common.ConfigurationVariables.barcodeCount</span>
				- com.skilrock.lms.common.ConfigurationVariables.barcodeRandomLength);
	}
	
	public static String getBarCodeCountFromTicketNumber(String ticketNumber) {
<span class="nc" id="L1778">		return ticketNumber.substring(com.skilrock.lms.common.ConfigurationVariables.barcodeCount</span>
				- com.skilrock.lms.common.ConfigurationVariables.barcodeRandomLength,com.skilrock.lms.common.ConfigurationVariables.barcodeCount);
	}
	
	public static String getBalInString(double bal){
<span class="nc" id="L1783">		NumberFormat nf = NumberFormat.getInstance();</span>
<span class="nc" id="L1784">		nf.setMinimumFractionDigits(2);</span>
<span class="nc" id="L1785">		return nf.format(bal).replaceAll(&quot;,&quot;, &quot;&quot;);</span>
	}
	
	public static String getCurrentTimeString(){
<span class="nc" id="L1789">		return new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;).format(Calendar.getInstance().getTime());</span>
	}
	
	public static Timestamp getCurrentTimeStamp(){
<span class="nc" id="L1793">		return new Timestamp(Calendar.getInstance().getTimeInMillis());</span>
	}
	
	public static String getDateTimeFormat(Timestamp dateTime){
<span class="nc" id="L1797">		SimpleDateFormat sd=new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;);</span>
<span class="nc" id="L1798">		return sd.format(dateTime);</span>
	}
	
<span class="nc" id="L1801">	public static long id=0;</span>
	public static synchronized long getAuditTrailId(){
		
<span class="nc" id="L1804">		return id++;</span>
	}
<span class="nc" id="L1806">	private static long activityId=0;</span>
	public static synchronized long getActivityId(){
		
<span class="nc" id="L1809">		return ++activityId;</span>
	}
	public static Long getCheckSum(String chkSumStr){
<span class="nc" id="L1812">		byte bytes[] = chkSumStr.getBytes();</span>
<span class="nc" id="L1813">       Checksum checksum = new CRC32();</span>
<span class="nc" id="L1814">        checksum.update(bytes,0,bytes.length);</span>
<span class="nc" id="L1815">        Long lngChecksum = checksum.getValue();</span>
<span class="nc" id="L1816">        return lngChecksum;</span>
	}
	
	public static void setRespGamingCriteriaStatusMap(){

<span class="nc" id="L1821">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L1822">		Statement stmt = null;</span>
<span class="nc" id="L1823">		ResultSet rs = null;</span>
<span class="nc" id="L1824">		ResponsibleGamingBean respCritBean=null;</span>
		try {
<span class="nc" id="L1826">			respGamingCriteriaStatusMap=new HashMap&lt;String, ResponsibleGamingBean&gt;();</span>
<span class="nc" id="L1827">			stmt = con.createStatement();</span>
<span class="nc" id="L1828">			rs = stmt</span>
					.executeQuery(&quot;select criteria_type,criteria,criteria_limit,crit_status,organization_type,crit_action from st_lms_rg_criteria_limit&quot;);
<span class="nc bnc" id="L1830" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1831">					respCritBean=new ResponsibleGamingBean();</span>
<span class="nc" id="L1832">					respCritBean.setCriteriaLimit((rs.getDouble(&quot;criteria_limit&quot;)));</span>
<span class="nc" id="L1833">					respCritBean.setStatus(rs.getString(&quot;crit_status&quot;));</span>
<span class="nc" id="L1834">					respCritBean.setOrgType(rs.getString(&quot;organization_type&quot;));</span>
<span class="nc" id="L1835">					respCritBean.setCriAction((rs.getString(&quot;crit_action&quot;)));</span>
<span class="nc" id="L1836">					respGamingCriteriaStatusMap.put(rs.getString(&quot;criteria&quot;)+rs.getString(&quot;criteria_type&quot;), respCritBean);</span>
					
			}
			
<span class="nc" id="L1840">		} catch (Exception e) {</span>
<span class="nc" id="L1841">			e.printStackTrace();</span>
			// throw new LMSException(e);
		} finally {
<span class="nc" id="L1844">			try {</span>
<span class="nc bnc" id="L1845" title="All 12 branches missed.">				if (con != null &amp;&amp; !con.isClosed()) {</span>
<span class="nc" id="L1846">					con.close();</span>
				}
<span class="nc" id="L1848">			} catch (Exception e) {</span>
<span class="nc" id="L1849">				e.printStackTrace();</span>
<span class="nc" id="L1850">			}</span>
<span class="nc" id="L1851">		}</span>
		
<span class="nc" id="L1853">	}</span>
	public static int fetchUserIdFormOrgId(int orgId) {
<span class="nc" id="L1855">		int userId = 0;</span>
<span class="nc" id="L1856">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L1857">		Statement stmt = null;</span>
<span class="nc" id="L1858">		ResultSet rs = null;</span>
		try {
<span class="nc" id="L1860">			stmt = con.createStatement();</span>
<span class="nc" id="L1861">			rs = stmt</span>
					.executeQuery(&quot;select user_id from st_lms_user_master where organization_id = &quot;
							+ orgId);
<span class="nc bnc" id="L1864" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1865">				userId = rs.getInt(&quot;user_id&quot;);</span>
			}
<span class="nc" id="L1867">		} catch (Exception e) {</span>
<span class="nc" id="L1868">			e.printStackTrace();</span>
			// throw new LMSException(e);
		} finally {
<span class="nc" id="L1871">			try {</span>
<span class="nc bnc" id="L1872" title="All 12 branches missed.">				if (con != null &amp;&amp; !con.isClosed()) {</span>
<span class="nc" id="L1873">					con.close();</span>
				}
<span class="nc" id="L1875">			} catch (Exception e) {</span>
<span class="nc" id="L1876">				e.printStackTrace();</span>
<span class="nc" id="L1877">			}</span>
<span class="nc" id="L1878">		}</span>
<span class="nc" id="L1879">		return userId;</span>
	}
	
	public static int getDivValueForLastSoldTkt(int lastTktNoLen){
<span class="nc bnc" id="L1883" title="All 2 branches missed.">		return (lastTktNoLen==ConfigurationVariables.tktLenA?100:10);</span>
	}
	
	public static String getRpcAppenderForTickets(int ticketNoLen){
<span class="nc bnc" id="L1887" title="All 2 branches missed.">		return (ticketNoLen==14?&quot;00&quot;:&quot;0&quot;);</span>
	}
	
	public static String getTktWithoutRpcNBarCodeCount(String ticketNumber , int len){
<span class="nc bnc" id="L1891" title="All 4 branches missed.">		return len==ConfigurationVariables.barcodeCount?ticketNumber.substring(0, len - 3): </span>
						(len==ConfigurationVariables.tktLenB?ticketNumber.substring(0, len - 1):
																ticketNumber.substring(0, len - 2));
	}

	public static int getRowCount(ResultSet resultSet) {
<span class="nc bnc" id="L1897" title="All 2 branches missed.">		if (resultSet == null) {</span>
<span class="nc" id="L1898">			return 0;</span>
		}
		try {
<span class="nc" id="L1901">			resultSet.last();</span>
<span class="nc" id="L1902">			return resultSet.getRow();</span>
<span class="nc" id="L1903">		} catch (SQLException exp) {</span>
<span class="nc" id="L1904">			exp.printStackTrace();</span>
		} finally {
<span class="nc" id="L1906">			try {</span>
<span class="nc" id="L1907">				resultSet.beforeFirst();</span>
<span class="nc" id="L1908">			} catch (SQLException exp) {</span>
<span class="nc" id="L1909">				exp.printStackTrace();</span>
<span class="nc" id="L1910">			}</span>
<span class="nc" id="L1911">		}</span>
<span class="nc" id="L1912">		return 0;</span>
	}
	
	public static boolean isBoAuthorizedToClaimTicket(String ticketNo) {

<span class="nc" id="L1917">		int userId = 0;</span>
<span class="nc" id="L1918">		int organizationId = 0;</span>
<span class="nc" id="L1919">		boolean canClaim=false;</span>
<span class="nc" id="L1920">		ResultSet rs = null;</span>
<span class="nc" id="L1921">		Connection con = null;</span>
<span class="nc" id="L1922">		String tktNbr = null;</span>
<span class="nc" id="L1923">		PreparedStatement pstmt = null;</span>
		try {
<span class="nc" id="L1925">			tktNbr = Util.getTicketNumber(ticketNo, 3); </span>
<span class="nc" id="L1926">			userId = Util.getUserIdFromTicket(tktNbr);</span>
<span class="nc" id="L1927">			con = DBConnect.getConnection();</span>
<span class="nc" id="L1928">			pstmt=con.prepareStatement(&quot;select parent_id organization_id from st_lms_organization_master where organization_id=(select organization_id from st_lms_user_master where user_id=?)&quot;);</span>
<span class="nc" id="L1929">			pstmt.setInt(1, userId);</span>
<span class="nc" id="L1930">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1931" title="All 2 branches missed.">			if (rs.next()) </span>
<span class="nc" id="L1932">				organizationId = rs.getInt(&quot;organization_id&quot;);</span>
			else
<span class="nc" id="L1934">				return true;</span>
			
<span class="nc" id="L1936">			pstmt=con.prepareStatement(&quot;select is_acting_as_bo_for_pwt from st_lms_oranization_limits where organization_id=?&quot;);</span>
<span class="nc" id="L1937">			pstmt.setInt(1, organizationId);</span>
<span class="nc" id="L1938">			rs = pstmt.executeQuery();</span>
			
<span class="nc bnc" id="L1940" title="All 2 branches missed.">			if (rs.next()) </span>
<span class="nc" id="L1941">				canClaim = rs.getBoolean(&quot;is_acting_as_bo_for_pwt&quot;);</span>
		
<span class="nc" id="L1943">		} catch (SQLException e) {</span>
<span class="nc" id="L1944">			e.printStackTrace();</span>
	}
		finally{
<span class="nc" id="L1947">			DBConnect.closeConnection(con, pstmt, rs);</span>
<span class="nc" id="L1948">		}</span>
<span class="nc" id="L1949">		return canClaim;</span>
	}
	
	// sets The category map , not for any other purpose.
	public static void setCategoryMapDetails() {

<span class="nc" id="L1955">			ResultSet rs = null;</span>
<span class="nc" id="L1956">			Connection con = null;</span>
<span class="nc" id="L1957">			Statement stmt = null;</span>
			try {
<span class="nc" id="L1959">				con = DBConnect.getConnection();</span>
<span class="nc" id="L1960">				stmt = con.createStatement();</span>
<span class="nc" id="L1961">				rs = stmt.executeQuery(&quot;select category_id,category_code from st_cs_product_category_master&quot;);</span>
<span class="nc" id="L1962">				catMap = new HashMap&lt;Integer, String&gt;();</span>
<span class="nc bnc" id="L1963" title="All 2 branches missed.">				while (rs.next())</span>
<span class="nc" id="L1964">					catMap.put(rs.getInt(&quot;category_id&quot;), rs.getString(&quot;category_code&quot;));</span>
<span class="nc" id="L1965">			} catch (Exception e) {</span>
<span class="nc" id="L1966">				logger.error(&quot;Exception :- &quot; + e);</span>
			}finally{
<span class="nc" id="L1968">				DBConnect.closeConnection(con, stmt, rs);</span>
<span class="nc" id="L1969">			}</span>
<span class="nc" id="L1970">	}</span>
	
	public static String getCategoryName(int categoryId){
<span class="nc" id="L1973">		return catMap.get(categoryId);</span>
	}

	
	public static void setServiceCodeIdMap() {
<span class="nc" id="L1978">		ResultSet rs = null;</span>
<span class="nc" id="L1979">		Connection con = null;</span>
<span class="nc" id="L1980">		Statement stmt = null;</span>
		try {
<span class="nc" id="L1982">			con = DBConnect.getConnection();</span>
<span class="nc" id="L1983">			stmt = con.createStatement();</span>
<span class="nc" id="L1984">			rs = stmt.executeQuery(&quot;select service_code, service_id from st_lms_service_master where status='ACTIVE' and service_code&lt;&gt;'MGMT'&quot;);</span>
<span class="nc" id="L1985">			serviceCodeIDMap = new HashMap&lt;String, Integer&gt;();</span>
<span class="nc bnc" id="L1986" title="All 2 branches missed.">			while (rs.next()){</span>
<span class="nc" id="L1987">				serviceCodeIDMap.put(rs.getString(&quot;service_code&quot;)  , rs.getInt(&quot;service_id&quot;));</span>
			}
<span class="nc" id="L1989">		} catch (SQLException e) {</span>
<span class="nc" id="L1990">			logger.error(&quot;SQLException :- &quot;,e);</span>
<span class="nc" id="L1991">		}catch (Exception e) {</span>
<span class="nc" id="L1992">			logger.error(&quot;Exception :- &quot;,e);</span>
		}finally{
<span class="nc" id="L1994">			DBConnect.closeConnection(con, stmt, rs);</span>
<span class="nc" id="L1995">		}</span>
<span class="nc" id="L1996">	}</span>
	public static int getServiceIdFormCode(String serviceCode){
<span class="nc" id="L1998">		int serviceId = 0;</span>
<span class="nc bnc" id="L1999" title="All 2 branches missed.">		if(serviceCodeIDMap.containsKey(serviceCode)){</span>
<span class="nc" id="L2000">			serviceId =  serviceCodeIDMap.get(serviceCode);</span>
		}
<span class="nc" id="L2002">		return serviceId;</span>
	}
	
	public static int getLen(int id){
<span class="nc" id="L2006">		int length = (int)(Math.log10(id)+1);</span>
<span class="nc" id="L2007">		return length;</span>
	} 

	public static int getLen(long id){
<span class="nc" id="L2011">		int length = (int)(Math.log10(id)+1);</span>
<span class="nc" id="L2012">		return length;</span>
	} 

	public static boolean canClaimRetailer(String ticketNumber, int retOrgId, int parentOrgId, Connection connection) {
<span class="nc" id="L2016">		boolean canClaim = false;</span>
		try {
<span class="nc" id="L2018">			int userId = Util.getUserIdFromTicket(ticketNumber, connection);</span>
<span class="nc" id="L2019">			canClaim = canClaimRetailer(userId, retOrgId, parentOrgId, connection);</span>
<span class="nc" id="L2020">		} catch (Exception e) {</span>
<span class="nc" id="L2021">			logger.error(&quot;Exception - &quot;, e);</span>
<span class="nc" id="L2022">		}</span>

<span class="nc" id="L2024">		return canClaim;</span>
	}

	public static boolean canClaimRetailerIW(int userId, int retOrgId, int parentOrgId, Connection connection) {
<span class="nc" id="L2028">		int ticketRetOrgId = 0;</span>
<span class="nc" id="L2029">		int ticketParentOrgId = 0;</span>
<span class="nc" id="L2030">		String selfClaim = null;</span>
<span class="nc" id="L2031">		String otherClaim = null;</span>
<span class="nc" id="L2032">		String claimAtSelfRet = null;</span>
<span class="nc" id="L2033">		String claimAtOtherRetSameAgt = null;</span>
<span class="nc" id="L2034">		String claimAtOtherRet = null;</span>
<span class="nc" id="L2035">		boolean canClaim = false;</span>

<span class="nc" id="L2037">		Statement stmt = null;</span>
<span class="nc" id="L2038">		ResultSet rs = null;</span>
		try {
<span class="nc" id="L2040">			stmt = connection.createStatement();</span>

<span class="nc" id="L2042">			String query = &quot;SELECT organization_id FROM st_lms_user_master WHERE user_id=&quot;+userId;</span>
<span class="nc" id="L2043">			rs = stmt.executeQuery(query);</span>
<span class="nc bnc" id="L2044" title="All 2 branches missed.">			if(rs.next()) {</span>
<span class="nc" id="L2045">				ticketRetOrgId = rs.getInt(&quot;organization_id&quot;);</span>
			}

//			query = &quot;SELECT self_claim, other_claim FROM st_lms_oranization_limits WHERE organization_id=&quot;+retOrgId;
//			rs = stmt.executeQuery(query);
//			while(rs.next()) {
//				selfClaim = rs.getString(&quot;self_claim&quot;);
//				otherClaim = rs.getString(&quot;other_claim&quot;);
//			}
//
//			query = &quot;SELECT claim_at_self_ret, claim_at_other_ret_same_agt, claim_at_other_ret FROM st_lms_ret_sold_claim_criteria WHERE organization_id=&quot;+ticketRetOrgId;
//			rs = stmt.executeQuery(query);
//			while(rs.next()) {
//				claimAtSelfRet = rs.getString(&quot;claim_at_self_ret&quot;);
//				claimAtOtherRetSameAgt = rs.getString(&quot;claim_at_other_ret_same_agt&quot;);
//				claimAtOtherRet = rs.getString(&quot;claim_at_other_ret&quot;);
//			}
//
//			if (&quot;NO&quot;.equalsIgnoreCase(selfClaim) &amp;&amp; &quot;NO&quot;.equalsIgnoreCase(otherClaim)) {
//				return false;
//			}

//			query = &quot;SELECT parent_id FROM st_lms_organization_master WHERE organization_id=&quot;+ticketRetOrgId;
//			rs = stmt.executeQuery(query);
//			if(rs.next()) {
//				ticketParentOrgId = rs.getInt(&quot;parent_id&quot;);
//			}

<span class="nc bnc" id="L2073" title="All 2 branches missed.">			if (ticketRetOrgId == retOrgId) {</span>
<span class="nc" id="L2074">				canClaim = true;</span>
			} else {
<span class="nc" id="L2076">				canClaim = false;</span>
			}
<span class="nc" id="L2078">		} catch (SQLException se) {</span>
<span class="nc" id="L2079">			logger.error(&quot;SQLException - &quot;, se);</span>
<span class="nc" id="L2080">		} catch (Exception e) {</span>
<span class="nc" id="L2081">			logger.error(&quot;Exception - &quot;, e);</span>
		} finally {
<span class="nc" id="L2083">			DBConnect.closeStmt(stmt);</span>
<span class="nc" id="L2084">			DBConnect.closeRs(rs);</span>
<span class="nc" id="L2085">		}</span>

<span class="nc" id="L2087">		return canClaim;</span>
	}
	
	public static boolean canClaimRetailer(int userId, int retOrgId, int parentOrgId, Connection connection) {
<span class="nc" id="L2091">		int ticketRetOrgId = 0;</span>
<span class="nc" id="L2092">		int ticketParentOrgId = 0;</span>
<span class="nc" id="L2093">		String selfClaim = null;</span>
<span class="nc" id="L2094">		String otherClaim = null;</span>
<span class="nc" id="L2095">		String claimAtSelfRet = null;</span>
<span class="nc" id="L2096">		String claimAtOtherRetSameAgt = null;</span>
<span class="nc" id="L2097">		String claimAtOtherRet = null;</span>
<span class="nc" id="L2098">		boolean canClaim = false;</span>

<span class="nc" id="L2100">		Statement stmt = null;</span>
<span class="nc" id="L2101">		ResultSet rs = null;</span>
		try {
<span class="nc" id="L2103">			stmt = connection.createStatement();</span>

<span class="nc" id="L2105">			String query = &quot;SELECT organization_id FROM st_lms_user_master WHERE user_id=&quot;+userId;</span>
<span class="nc" id="L2106">			rs = stmt.executeQuery(query);</span>
<span class="nc bnc" id="L2107" title="All 2 branches missed.">			if(rs.next()) {</span>
<span class="nc" id="L2108">				ticketRetOrgId = rs.getInt(&quot;organization_id&quot;);</span>
			}

<span class="nc" id="L2111">			query = &quot;SELECT self_claim, other_claim FROM st_lms_oranization_limits WHERE organization_id=&quot;+retOrgId;</span>
<span class="nc" id="L2112">			rs = stmt.executeQuery(query);</span>
<span class="nc bnc" id="L2113" title="All 2 branches missed.">			while(rs.next()) {</span>
<span class="nc" id="L2114">				selfClaim = rs.getString(&quot;self_claim&quot;);</span>
<span class="nc" id="L2115">				otherClaim = rs.getString(&quot;other_claim&quot;);</span>
			}

<span class="nc" id="L2118">			query = &quot;SELECT claim_at_self_ret, claim_at_other_ret_same_agt, claim_at_other_ret FROM st_lms_ret_sold_claim_criteria WHERE organization_id=&quot;+ticketRetOrgId;</span>
<span class="nc" id="L2119">			rs = stmt.executeQuery(query);</span>
<span class="nc bnc" id="L2120" title="All 2 branches missed.">			while(rs.next()) {</span>
<span class="nc" id="L2121">				claimAtSelfRet = rs.getString(&quot;claim_at_self_ret&quot;);</span>
<span class="nc" id="L2122">				claimAtOtherRetSameAgt = rs.getString(&quot;claim_at_other_ret_same_agt&quot;);</span>
<span class="nc" id="L2123">				claimAtOtherRet = rs.getString(&quot;claim_at_other_ret&quot;);</span>
			}

<span class="nc bnc" id="L2126" title="All 4 branches missed.">			if (&quot;NO&quot;.equalsIgnoreCase(selfClaim) &amp;&amp; &quot;NO&quot;.equalsIgnoreCase(otherClaim)) {</span>
<span class="nc" id="L2127">				return false;</span>
			}

<span class="nc" id="L2130">			query = &quot;SELECT parent_id FROM st_lms_organization_master WHERE organization_id=&quot;+ticketRetOrgId;</span>
<span class="nc" id="L2131">			rs = stmt.executeQuery(query);</span>
<span class="nc bnc" id="L2132" title="All 2 branches missed.">			if(rs.next()) {</span>
<span class="nc" id="L2133">				ticketParentOrgId = rs.getInt(&quot;parent_id&quot;);</span>
			}

<span class="nc bnc" id="L2136" title="All 2 branches missed.">			if (ticketRetOrgId == retOrgId) {</span>
<span class="nc bnc" id="L2137" title="All 4 branches missed.">				canClaim = (&quot;YES&quot;.equalsIgnoreCase(selfClaim) &amp;&amp; &quot;YES&quot;.equalsIgnoreCase(claimAtSelfRet)) ? true : false;</span>
			} else {
<span class="nc bnc" id="L2139" title="All 2 branches missed.">				if (ticketParentOrgId == parentOrgId) {</span>
<span class="nc bnc" id="L2140" title="All 4 branches missed.">					canClaim = (&quot;YES&quot;.equalsIgnoreCase(otherClaim) &amp;&amp; &quot;YES&quot;.equalsIgnoreCase(claimAtOtherRetSameAgt)) ? true : false;</span>
				} else {
<span class="nc bnc" id="L2142" title="All 4 branches missed.">					canClaim = (&quot;YES&quot;.equalsIgnoreCase(otherClaim) &amp;&amp; &quot;YES&quot;.equalsIgnoreCase(claimAtOtherRet)) ? true : false;</span>
				}
			}
<span class="nc" id="L2145">		} catch (SQLException se) {</span>
<span class="nc" id="L2146">			logger.error(&quot;SQLException - &quot;, se);</span>
<span class="nc" id="L2147">		} catch (Exception e) {</span>
<span class="nc" id="L2148">			logger.error(&quot;Exception - &quot;, e);</span>
		} finally {
<span class="nc" id="L2150">			DBConnect.closeStmt(stmt);</span>
<span class="nc" id="L2151">			DBConnect.closeRs(rs);</span>
<span class="nc" id="L2152">		}</span>

<span class="nc" id="L2154">		return canClaim;</span>
	}

	public static boolean canClaimAgent(String ticketNumber, int agentOrgId, Connection connection) {
<span class="nc" id="L2158">		boolean canClaim = false;</span>
		try {
<span class="nc" id="L2160">			int retUserId = Util.getUserIdFromTicket(ticketNumber, connection);</span>
<span class="nc" id="L2161">			canClaim = canClaimAgent(retUserId, agentOrgId, connection);</span>
<span class="nc" id="L2162">		} catch (Exception e) {</span>
<span class="nc" id="L2163">			logger.error(&quot;Exception - &quot;, e);</span>
<span class="nc" id="L2164">		}</span>

<span class="nc" id="L2166">		return canClaim;</span>
	}

	public static boolean canClaimAgent(int retUserId, int claimAgentOrgId, Connection connection) {
<span class="nc" id="L2170">		int parentOrgId = 0;</span>
<span class="nc" id="L2171">		String selfClaim = null;</span>
<span class="nc" id="L2172">		String otherClaim = null;</span>
<span class="nc" id="L2173">		String claimAtSelfAgt = null;</span>
<span class="nc" id="L2174">		String claimAtOtherAgt = null;</span>
<span class="nc" id="L2175">		boolean canClaim = false;</span>
<span class="nc" id="L2176">		int agentOrgId = 0;</span>

<span class="nc" id="L2178">		ResultSet rs = null;</span>
<span class="nc" id="L2179">		Statement stmt = null;</span>
		try {
<span class="nc" id="L2181">			stmt = connection.createStatement();</span>
<span class="nc" id="L2182">			rs = stmt.executeQuery(&quot;select p.organization_id from st_lms_user_master p inner join st_lms_user_master c on c.parent_user_id = p.user_id where c.user_id = &quot; + retUserId + &quot;;&quot;);</span>
<span class="nc bnc" id="L2183" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L2184">				agentOrgId = rs.getInt(&quot;organization_id&quot;);</span>
			} else
<span class="nc" id="L2186">				return false;</span>
			
<span class="nc" id="L2188">			String query = &quot;SELECT self_claim, other_claim FROM st_lms_oranization_limits WHERE organization_id=&quot; + agentOrgId;</span>
			
<span class="nc" id="L2190">			rs = stmt.executeQuery(query);</span>
<span class="nc bnc" id="L2191" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L2192">				selfClaim = rs.getString(&quot;self_claim&quot;);</span>
<span class="nc" id="L2193">				otherClaim = rs.getString(&quot;other_claim&quot;);</span>
			}

<span class="nc bnc" id="L2196" title="All 6 branches missed.">			if (&quot;NO&quot;.equalsIgnoreCase(selfClaim) &amp;&amp; &quot;NO&quot;.equalsIgnoreCase(otherClaim) &amp;&amp; rs.next()) {</span>
<span class="nc" id="L2197">				return false;</span>
			} else {
<span class="nc" id="L2199">				String agtQuery = &quot;SELECT parent_id FROM st_lms_organization_master WHERE organization_id=(SELECT organization_id FROM st_lms_user_master WHERE user_id=&quot;+retUserId+&quot;);&quot;;</span>
<span class="nc" id="L2200">				rs = stmt.executeQuery(agtQuery);</span>
<span class="nc bnc" id="L2201" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L2202">					parentOrgId = rs.getInt(&quot;parent_id&quot;);</span>
				}

<span class="nc" id="L2205">				String retQuery = &quot;SELECT claim_at_self_agt, claim_at_other_agt FROM st_lms_ret_sold_claim_criteria WHERE organization_id=(SELECT organization_id FROM st_lms_user_master WHERE user_id=&quot;+retUserId+&quot;);&quot;;</span>
<span class="nc" id="L2206">				rs = stmt.executeQuery(retQuery);</span>
<span class="nc bnc" id="L2207" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L2208">					claimAtSelfAgt = rs.getString(&quot;claim_at_self_agt&quot;);</span>
<span class="nc" id="L2209">					claimAtOtherAgt = rs.getString(&quot;claim_at_other_agt&quot;);</span>
				}

<span class="nc bnc" id="L2212" title="All 2 branches missed.">				if (parentOrgId == claimAgentOrgId) {</span>
<span class="nc bnc" id="L2213" title="All 4 branches missed.">					canClaim = (&quot;YES&quot;.equalsIgnoreCase(selfClaim) &amp;&amp; &quot;YES&quot;.equalsIgnoreCase(claimAtSelfAgt)) ? true : false;</span>
				} else {
<span class="nc bnc" id="L2215" title="All 4 branches missed.">					canClaim = (&quot;YES&quot;.equalsIgnoreCase(otherClaim) &amp;&amp; &quot;YES&quot;.equalsIgnoreCase(claimAtOtherAgt)) ? true : false;</span>
				}
			}
<span class="nc" id="L2218">		} catch (SQLException se) {</span>
<span class="nc" id="L2219">			logger.error(&quot;SQLException - &quot;, se);</span>
<span class="nc" id="L2220">		} catch (Exception e) {</span>
<span class="nc" id="L2221">			logger.error(&quot;Exception - &quot;, e);</span>
		} finally {
<span class="nc" id="L2223">			DBConnect.closeStmt(stmt);</span>
<span class="nc" id="L2224">			DBConnect.closeRs(rs);</span>
<span class="nc" id="L2225">		}</span>

<span class="nc" id="L2227">		return canClaim;</span>
	}
	
	public static boolean canClaimAgentIW(int retUserId, int claimAgentOrgId, Connection connection) {
<span class="nc" id="L2231">		int parentOrgId = 0;</span>
<span class="nc" id="L2232">		String selfClaim = null;</span>
<span class="nc" id="L2233">		String otherClaim = null;</span>
<span class="nc" id="L2234">		String claimAtSelfAgt = null;</span>
<span class="nc" id="L2235">		String claimAtOtherAgt = null;</span>
<span class="nc" id="L2236">		boolean canClaim = false;</span>
<span class="nc" id="L2237">		int agentOrgId = 0;</span>

<span class="nc" id="L2239">		ResultSet rs = null;</span>
<span class="nc" id="L2240">		Statement stmt = null;</span>
		try {
<span class="nc" id="L2242">			stmt = connection.createStatement();</span>
<span class="nc" id="L2243">			rs = stmt.executeQuery(&quot;select p.organization_id from st_lms_user_master p inner join st_lms_user_master c on c.parent_user_id = p.user_id where c.user_id = &quot; + retUserId + &quot;;&quot;);</span>
<span class="nc bnc" id="L2244" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L2245">				agentOrgId = rs.getInt(&quot;organization_id&quot;);</span>
			} else
<span class="nc" id="L2247">				return false;</span>
			
//			String query = &quot;SELECT self_claim, other_claim FROM st_lms_oranization_limits WHERE organization_id=&quot; + agentOrgId;
//			
//			rs = stmt.executeQuery(query);
//			if (rs.next()) {
//				selfClaim = rs.getString(&quot;self_claim&quot;);
//				otherClaim = rs.getString(&quot;other_claim&quot;);
//			}
//
//			if (&quot;NO&quot;.equalsIgnoreCase(selfClaim) &amp;&amp; &quot;NO&quot;.equalsIgnoreCase(otherClaim) &amp;&amp; rs.next()) {
//				return false;
//			} else {
//				String agtQuery = &quot;SELECT parent_id FROM st_lms_organization_master WHERE organization_id=(SELECT organization_id FROM st_lms_user_master WHERE user_id=&quot;+retUserId+&quot;);&quot;;
//				rs = stmt.executeQuery(agtQuery);
//				while (rs.next()) {
//					parentOrgId = rs.getInt(&quot;parent_id&quot;);
//				}
//
//				String retQuery = &quot;SELECT claim_at_self_agt, claim_at_other_agt FROM st_lms_ret_sold_claim_criteria WHERE organization_id=(SELECT organization_id FROM st_lms_user_master WHERE user_id=&quot;+retUserId+&quot;);&quot;;
//				rs = stmt.executeQuery(retQuery);
//				while (rs.next()) {
//					claimAtSelfAgt = rs.getString(&quot;claim_at_self_agt&quot;);
//					claimAtOtherAgt = rs.getString(&quot;claim_at_other_agt&quot;);
//				}
//
//				if (parentOrgId == claimAgentOrgId) {
//					canClaim = (&quot;YES&quot;.equalsIgnoreCase(selfClaim) &amp;&amp; &quot;YES&quot;.equalsIgnoreCase(claimAtSelfAgt)) ? true : false;
//				} else {
//					canClaim = (&quot;YES&quot;.equalsIgnoreCase(otherClaim) &amp;&amp; &quot;YES&quot;.equalsIgnoreCase(claimAtOtherAgt)) ? true : false;
//				}
//			}
			
<span class="nc bnc" id="L2280" title="All 2 branches missed.">			if (agentOrgId == claimAgentOrgId)</span>
<span class="nc" id="L2281">				canClaim = true;</span>
			else
<span class="nc" id="L2283">				canClaim = false;</span>
<span class="nc" id="L2284">		} catch (SQLException se) {</span>
<span class="nc" id="L2285">			logger.error(&quot;SQLException - &quot;, se);</span>
<span class="nc" id="L2286">		} catch (Exception e) {</span>
<span class="nc" id="L2287">			logger.error(&quot;Exception - &quot;, e);</span>
		} finally {
<span class="nc" id="L2289">			DBConnect.closeStmt(stmt);</span>
<span class="nc" id="L2290">			DBConnect.closeRs(rs);</span>
<span class="nc" id="L2291">		}</span>

<span class="nc" id="L2293">		return canClaim;</span>
	}

	public static boolean canClaimBO(String ticketNumber, Connection connection) {
<span class="nc" id="L2297">		boolean canClaim = false;</span>
		try {
<span class="nc" id="L2299">			int userId = getUserIdFromTicket(ticketNumber, connection);</span>
<span class="nc" id="L2300">			canClaim = canClaimBO(userId, connection);</span>
<span class="nc" id="L2301">		} catch (Exception e) {</span>
<span class="nc" id="L2302">			logger.error(&quot;Exception - &quot;, e);</span>
<span class="nc" id="L2303">		}</span>

<span class="nc" id="L2305">		return canClaim;</span>
	}

	public static boolean canClaimBO(int userId, Connection connection) {
<span class="nc" id="L2309">		String claimAtBo = null;</span>
<span class="nc" id="L2310">		Statement stmt = null;</span>
<span class="nc" id="L2311">		ResultSet rs = null;</span>
<span class="nc" id="L2312">		boolean canClaim = false;</span>
		try {
<span class="nc" id="L2314">			stmt = connection.createStatement();</span>
<span class="nc" id="L2315">			String query = &quot;SELECT claim_at_bo FROM st_lms_ret_sold_claim_criteria WHERE organization_id=(SELECT organization_id FROM st_lms_user_master WHERE user_id=&quot;+userId+&quot;);&quot;;</span>
<span class="nc" id="L2316">			rs = stmt.executeQuery(query);</span>
<span class="nc bnc" id="L2317" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L2318">				claimAtBo = rs.getString(&quot;claim_at_bo&quot;);</span>
			}

<span class="nc bnc" id="L2321" title="All 2 branches missed.">			canClaim = (&quot;YES&quot;.equalsIgnoreCase(claimAtBo)) ? true : false;</span>
<span class="nc" id="L2322">		} catch (SQLException se) {</span>
<span class="nc" id="L2323">			logger.error(&quot;SQLException - &quot;, se);</span>
<span class="nc" id="L2324">		} catch (Exception e) {</span>
<span class="nc" id="L2325">			logger.error(&quot;Exception - &quot;, e);</span>
		} finally {
<span class="nc" id="L2327">			DBConnect.closeStmt(stmt);</span>
<span class="nc" id="L2328">			DBConnect.closeRs(rs);</span>
<span class="nc" id="L2329">		}</span>

<span class="nc" id="L2331">		return canClaim;</span>
	}

	public static String changeFormat(String oldFormat, String newFormat, String data) throws ParseException{
		
<span class="nc" id="L2336">		DateFormat formatter = new SimpleDateFormat(oldFormat);</span>
<span class="nc" id="L2337">		Date oldFormatedDate = formatter.parse(data);</span>
<span class="nc" id="L2338">		return new SimpleDateFormat(newFormat).format(oldFormatedDate);</span>
	}

	public static String getUserTypeFromUsername(String username){

<span class="nc" id="L2343">		ResultSet rs = null;</span>
<span class="nc" id="L2344">		Statement stmt = null;</span>
<span class="nc" id="L2345">		String userType = null;</span>
<span class="nc" id="L2346">		Connection conn = null ;</span>
		try {
<span class="nc" id="L2348">			conn = DBConnect.getConnection();</span>
<span class="nc" id="L2349">			stmt = conn.createStatement();</span>
<span class="nc" id="L2350">			rs = stmt.executeQuery(&quot;select organization_type from st_lms_user_master where user_name = '&quot;+username+&quot;';&quot;);</span>
<span class="nc bnc" id="L2351" title="All 2 branches missed.">			if(rs.next()){</span>
<span class="nc" id="L2352">				userType = rs.getString(&quot;organization_type&quot;);</span>
			}
<span class="nc" id="L2354">		} catch (Exception e) {</span>
<span class="nc" id="L2355">			e.printStackTrace();</span>
		}finally{
<span class="nc" id="L2357">			DBConnect.closeConnection(conn, stmt, rs);</span>
<span class="nc" id="L2358">		}</span>

<span class="nc" id="L2360">		return userType;</span>
	}

	public static Map&lt;Integer, String&gt; fetchAllBOUsers() {
<span class="nc" id="L2364">		Map&lt;Integer, String&gt; boUsers = new HashMap&lt;Integer, String&gt;(); </span>

<span class="nc" id="L2366">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L2367">		Statement stmt = null;</span>
<span class="nc" id="L2368">		ResultSet rs = null;</span>
		try {
<span class="nc" id="L2370">			stmt = con.createStatement();</span>
<span class="nc" id="L2371">			rs = stmt</span>
					.executeQuery(&quot;select um.user_id user_id, concat(cd.first_name, ' ', cd.last_name) org_name from st_lms_user_master um inner join st_lms_user_contact_details cd on um.user_id = cd.user_id where um.organization_type = 'BO' ;&quot;);
<span class="nc bnc" id="L2373" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L2374">				boUsers.put(rs.getInt(&quot;user_id&quot;), rs.getString(&quot;org_name&quot;));</span>
			}
<span class="nc" id="L2376">		} catch (Exception e) {</span>
<span class="nc" id="L2377">			e.printStackTrace();</span>
			// throw new LMSException(e);
		} finally {
<span class="nc" id="L2380">			DBConnect.closeResource(con, stmt, rs);</span>
<span class="nc" id="L2381">		}</span>

<span class="nc" id="L2383">		return boUsers;</span>
	}
	
	
	public static int fetchUserIdFromUserName(String userName) throws LMSException {
<span class="nc" id="L2388">		int userId = 0;</span>

<span class="nc" id="L2390">		Connection con = null;</span>
<span class="nc" id="L2391">		Statement stmt = null;</span>
<span class="nc" id="L2392">		ResultSet rs = null;</span>

		try {
<span class="nc" id="L2395">			con = DBConnect.getConnection();</span>
<span class="nc" id="L2396">			stmt = con.createStatement();</span>
<span class="nc" id="L2397">			rs = stmt.executeQuery(&quot;select user_id from st_lms_user_master where user_name = '&quot; + userName + &quot;';&quot;);</span>
<span class="nc bnc" id="L2398" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L2399">				userId = rs.getInt(&quot;user_id&quot;);</span>
			} else {
<span class="nc" id="L2401">				throw new LMSException(LMSErrors.USER_NAME_DOES_NOT_EXISTS_CODE, LMSErrors.USER_NAME_DOES_NOT_EXISTS_MESSAGE);</span>
			}
<span class="nc" id="L2403">		} catch (Exception e) {</span>
<span class="nc" id="L2404">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L2406">			DBConnect.closeCon(con);</span>
<span class="nc" id="L2407">		}</span>
<span class="nc" id="L2408">		return userId;</span>
	}
	
	
	public static void setEbetSaleRequestStatusDone(String tokenId,int retailerId) 
	{
<span class="nc" id="L2414">		PreparedStatement ps = null;</span>
<span class="nc" id="L2415">		Connection con = null;</span>
		try {
<span class="nc" id="L2417">			con = DBConnect.getConnection();</span>
			
<span class="nc" id="L2419">			setEbetSaleRequestStatusDone(tokenId, retailerId,con);</span>
<span class="nc" id="L2420">		}catch (Exception e) {</span>
<span class="nc" id="L2421">			logger.error(&quot;ERROR&quot;,e);</span>
		} finally {
<span class="nc" id="L2423">			DBConnect.closeResource(con, ps);</span>
<span class="nc" id="L2424">		}</span>
		
<span class="nc" id="L2426">	}</span>
		
		public static void setEbetSaleRequestStatusDone(String tokenId,int retailerId,Connection con) 
		{
<span class="nc" id="L2430">			PreparedStatement ps = null;</span>
			try {
				
<span class="nc" id="L2433">			   String query = &quot;UPDATE st_lms_ebet_sale_request AS esr,st_lms_ebet_retailer_mappping AS erm SET esr.processed_datetime=?,esr.status=? WHERE esr.organization_id=? AND esr.status=? AND esr.token_id=?&quot;;</span>
<span class="nc" id="L2434">				ps = con.prepareStatement(query);</span>
<span class="nc" id="L2435">				ps.setString(1, Util.getCurrentTimeString());</span>
<span class="nc" id="L2436">				ps.setString(2, &quot;DONE&quot;);</span>
<span class="nc" id="L2437">				ps.setInt(3, retailerId);</span>
<span class="nc" id="L2438">				ps.setString(4,&quot;Initiated&quot;);</span>
<span class="nc" id="L2439">				ps.setString(5,tokenId);</span>
<span class="nc" id="L2440">				logger.info(&quot;ps**************** &quot;+ps);</span>
<span class="nc" id="L2441">				ps.execute();</span>
<span class="nc" id="L2442">			}catch (SQLException e) {</span>
<span class="nc" id="L2443">				logger.error(&quot;SQLERROR&quot;,e);</span>
			} finally {
<span class="nc" id="L2445">				DBConnect.closeResource(ps);</span>
<span class="nc" id="L2446">			}</span>
			
<span class="nc" id="L2448">		}			</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>