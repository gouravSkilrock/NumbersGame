<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DrawGameRPOS.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lms</a> &gt; <a href="index.source.html" class="el_package">com.skilrock.lms.web.drawGames.common</a> &gt; <span class="el_source">DrawGameRPOS.java</span></div><h1>DrawGameRPOS.java</h1><pre class="source lang-java linenums">package com.skilrock.lms.web.drawGames.common;

import java.awt.Toolkit;
import java.io.IOException;
import java.io.PrintWriter;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.TreeMap;

import javax.servlet.ServletContext;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.apache.struts2.ServletActionContext;

import com.opensymphony.xwork2.ActionContext;
import com.skilrock.lms.beans.UserInfoBean;
import com.skilrock.lms.common.BaseAction;
import com.skilrock.lms.common.ConfigurationVariables;
import com.skilrock.lms.common.Utility;
import com.skilrock.lms.common.exception.LMSErrors;
import com.skilrock.lms.common.exception.LMSException;
import com.skilrock.lms.common.filter.LMSFilterDispatcher;
import com.skilrock.lms.common.utility.LMSUtility;
import com.skilrock.lms.coreEngine.drawGames.playMgmt.DrawGameOfflineHelper;
import com.skilrock.lms.coreEngine.drawGames.playMgmt.DrawGameRPOSHelper;
import com.skilrock.lms.coreEngine.drawGames.playMgmt.ServerStartUpData;
import com.skilrock.lms.dge.beans.CancelTicketBean;
import com.skilrock.lms.dge.beans.DrawDetailsBean;
import com.skilrock.lms.dge.beans.DrawIdBean;
import com.skilrock.lms.dge.beans.FortunePurchaseBean;
import com.skilrock.lms.dge.beans.KenoPurchaseBean;
import com.skilrock.lms.dge.beans.LottoPurchaseBean;
import com.skilrock.lms.dge.beans.MainPWTDrawBean;
import com.skilrock.lms.dge.beans.PWTDrawBean;
import com.skilrock.lms.dge.beans.WebReprint;
import com.skilrock.lms.rest.common.TransactionManager;

import net.sf.json.JSONArray;
import net.sf.json.JSONObject;
import net.sf.json.JSONSerializer;

public class DrawGameRPOS extends BaseAction {

	private static final String INTERFACE_TYPE_WEB = &quot;WEB&quot;;
	private static final String EXCEPTION_OCCURRED = &quot;Exception Occurred&quot;;
	/**
	 * 
	 */
	private static final long serialVersionUID = 1L;

	public DrawGameRPOS(DrawGameRPOSHelper drawGameRPOSHelper, WebReprintFactory webReprintFactory){
<span class="fc" id="L59">		super(DrawGameRPOS.class.getName());</span>
<span class="fc" id="L60">		this.drawGameRPOSHelper = drawGameRPOSHelper;</span>
<span class="fc" id="L61">		this.webReprintFactory = webReprintFactory;</span>
<span class="fc" id="L62">	}</span>
	
	public DrawGameRPOS() {
<span class="nc" id="L65">		super(DrawGameRPOS.class.getName());</span>
<span class="nc" id="L66">		drawGameRPOSHelper = new DrawGameRPOSHelper();</span>
<span class="nc" id="L67">		webReprintFactory = new WebReprintFactory();</span>
<span class="nc" id="L68">	}</span>

	public static void onStartNewData() {
<span class="nc" id="L71">		new DrawGameRPOS().newData();</span>
<span class="nc" id="L72">	}</span>
	
	private DrawGameRPOSHelper drawGameRPOSHelper;
	private WebReprintFactory webReprintFactory;
	JSONObject jsonResponse;
	private Object gameBean;
	private UserInfoBean userInfoBean;
	private WebReprint webReprint;
	private String gameBeanType;
	private String actionName;
	private int gameId;
	private long lastPrintedTicket;
	private long lastTicketNumber;
	private boolean isReprintFirstTime;
	private WebReprintContext webReprintContext;
	private JSONObject requestData;
	private PrintWriter printWriter;
	
	private boolean autoCancel;
	TreeMap drawGameData;
	private Map&lt;String, Map&lt;Integer, DrawDetailsBean&gt;&gt; drawGameNewData;
	private String endRange;
	private String errMsg;
	private String firstName;
	private FortunePurchaseBean fortuneBean;
	TreeMap freezeTimeMap;
	private int gameNo;
	private String idNumber;
	private String idType;
	private String isRG;
	private String jreVersion;
	private KenoPurchaseBean kenoPurchaseBean;
	private KenoPurchaseBean kenoTwoPurchaseBean;
	private KenoPurchaseBean twelveByTwentyFourPurchaseBean;
	private String lastName;
<span class="pc" id="L107">	Log logger = LogFactory.getLog(DrawGameRPOS.class);</span>
	private LottoPurchaseBean lottoPurchaseBean;
	private String pickNum;
	private HttpServletResponse response;
	String serverTime;
	private HttpServletRequest servletRequest;
<span class="pc" id="L113">	HttpSession session = null;</span>
	private String startRange;
	private String ticketNo;
	private String pickNumStr;
	Map unitPrice;
	private String purchaseData;

	private String winNum;
	private String cancelType;
	private String json;
	private long LSTktNo;
	private String userName;

	public String getJson() {
<span class="nc" id="L127">		return json;</span>
	}

	public void setJson(String json) {
<span class="fc" id="L131">		this.json = json;</span>
<span class="fc" id="L132">	}</span>

	/*public void cancelTicket() throws Exception {
		logger.info(&quot;Inside cancelTicket&quot;);
		PrintWriter out = getResponse().getWriter();
		ServletContext sc = ServletActionContext.getServletContext();
		session = servletRequest.getSession();
		UserInfoBean userInfoBean = (UserInfoBean) session
				.getAttribute(&quot;USER_INFO&quot;);
		String refMerchantId = (String) sc.getAttribute(&quot;REF_MERCHANT_ID&quot;);

		if(!isAutoCancel()){
			cancelType=&quot;manual&quot;;
		} else if(cancelType != null &amp;&amp; &quot;dataError&quot;.equals(cancelType)){
			// DO NOTHING
		}else{
			cancelType=&quot;&quot;;
		}
		
		String cancelChannel = &quot;LMS_Web&quot;;
		CancelTicketBean cancelTicketBean = new CancelTicketBean();
		Map&lt;Integer, Map&lt;Integer, String&gt;&gt; drawIdTableMap = (Map&lt;Integer, Map&lt;Integer, String&gt;&gt;) sc.getAttribute(&quot;drawIdTableMap&quot;);
		logger.debug(&quot; ticketNo = &quot; + ticketNo
				+ &quot; drawIdTableMap in cancel ticket &quot; + drawIdTableMap);
		DrawGameRPOSHelper helper = new DrawGameRPOSHelper();
		cancelTicketBean.setDrawIdTableMap(drawIdTableMap);
		
		cancelTicketBean.setCancelDuaraion(&quot;true&quot;.equalsIgnoreCase((String)sc.getAttribute(&quot;IS_CANCEL_DURATION&quot;)));
		cancelTicketBean.setCancelDuration(Integer.parseInt((String)sc.getAttribute(&quot;CANCEL_DURATION&quot;)));
		
		if (&quot;LAST_SOLD_TICKET&quot;.equalsIgnoreCase((String) sc
				.getAttribute(&quot;CANCEL_TYPE&quot;))) {
			ticketNo = helper.getLastSoldTicketNO(userInfoBean,&quot;WEB&quot;);
			if(ticketNo!= null){
				ticketNo = ticketNo + Util.getRpcAppenderForTickets(ticketNo.length());
			}
			cancelTicketBean.setCancelType(&quot;LAST_SOLD_TICKET&quot;);
		}
		if (ticketNo == null) {
			out.print(&quot;Ticket Cannot Be Cancelled &quot;);
		} else {
			
			cancelTicketBean.setTicketNo(ticketNo);
			cancelTicketBean.setPartyId(userInfoBean.getUserOrgId());
			cancelTicketBean.setUserId(userInfoBean.getUserId());
			cancelTicketBean.setPartyType(userInfoBean.getUserType());
			cancelTicketBean.setCancelChannel(cancelChannel);
			cancelTicketBean.setRefMerchantId(refMerchantId);
			cancelTicketBean.setAutoCancel(isAutoCancel());

			cancelTicketBean = helper.cancelTicket(cancelTicketBean,
					userInfoBean, isAutoCancel(),cancelType);

			if (cancelTicketBean.isValid()) {
				if (&quot;LAST_SOLD_TICKET&quot;.equalsIgnoreCase(cancelTicketBean
						.getCancelType())) {
					String tktNum = cancelTicketBean.getTicketNo();

					cancelTicketBean.setTicketNo(tktNum.substring(0, tktNum
							.length() - 1)
							+ cancelTicketBean.getReprintCount());
				}
				
				int appletHeight = 150;
				StringBuilder topMsgsStrCancel = new StringBuilder(&quot; &quot;);
				StringBuilder bottomMsgsStrCancel = new StringBuilder(&quot; &quot;);
				
				if(cancelTicketBean.getRefundAmount() &gt; 0.0){
					appletHeight = UtilApplet.getAdvMsgs(cancelTicketBean.getAdvMsg(), topMsgsStrCancel, bottomMsgsStrCancel, appletHeight);	
				}
				
				out.print(&quot;cancelTime=&quot; + cancelTicketBean.getCancelTime()
						+ &quot;|orgName=&quot; + sc.getAttribute(&quot;ORG_NAME_JSP&quot;)
						+ &quot;|currSymbol=&quot; + sc.getAttribute(&quot;CURRENCY_SYMBOL&quot;)
						+ &quot;|gameName=&quot; + Util.getGameName(Util.getGameIdFromGameNumber(cancelTicketBean.getGameNo()))
						+ &quot;|gameDispName=&quot; + Util.getGameDisplayName(Util.getGameIdFromGameNumber(cancelTicketBean.getGameNo()))
						+ &quot;|topAdvMsgCancel=&quot; + topMsgsStrCancel
						+ &quot;|bottomAdvMsgCancel=&quot; + bottomMsgsStrCancel
						+ &quot;|tktNo=&quot; + cancelTicketBean.getTicketNo()
						+ &quot;|refundAmt=&quot; + cancelTicketBean.getRefundAmount()
						+ &quot;|ctr=&quot; + appletHeight);
			} else if (cancelTicketBean.isError()) { // RG Limit fail
				logger.debug(&quot;********&quot; + cancelTicketBean.getErrMsg());
				out.print(cancelTicketBean.getErrMsg());
			} else {
				out.print(&quot;Ticket Cannot Be Cancelled or Invalid Ticket&quot;);
			}
		}
	}*/

	@SuppressWarnings(&quot;unchecked&quot;)
	public void cancelTicket() {
<span class="nc" id="L224">		logger.info(&quot;-- Inside Cancel Ticket JSON --&quot;);</span>

<span class="nc" id="L226">		PrintWriter out = null;</span>
<span class="nc" id="L227">		JSONObject responseObject = new JSONObject();</span>
<span class="nc" id="L228">		String parentOrgName = null;</span>
		try {
<span class="nc" id="L230">			JSONObject requestData = (JSONObject) JSONSerializer.toJSON(json);</span>
<span class="nc" id="L231">			String ticketNumber=requestData.get(&quot;ticketNumber&quot;).toString();</span>
			
<span class="nc bnc" id="L233" title="All 2 branches missed.">			if(ticketNumber!=&quot;null&quot;)</span>
<span class="nc" id="L234">                ticketNo = (String) requestData.get(&quot;ticketNumber&quot;);</span>
<span class="nc" id="L235">			autoCancel = (Boolean) requestData.get(&quot;autoCancel&quot;);</span>
<span class="nc" id="L236">			logger.info(&quot;Ticket Number - &quot;+ticketNo+&quot; | Auto Cancel - &quot;+autoCancel);</span>

<span class="nc" id="L238">			out = getResponse().getWriter();</span>

			//session = servletRequest.getSession();
<span class="nc" id="L241">			UserInfoBean userInfoBean = null;</span>
<span class="nc" id="L242">			String userName = (String) requestData.get(&quot;userName&quot;);</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">			if(userName == null){</span>
<span class="nc" id="L244">				session = servletRequest.getSession();</span>
<span class="nc" id="L245">				userInfoBean = (UserInfoBean) session.getAttribute(&quot;USER_INFO&quot;);</span>
			} else{
<span class="nc" id="L247">				userInfoBean = getUserBean(userName);</span>
			}
<span class="nc" id="L249">			parentOrgName = userInfoBean.getParentOrgName();</span>
<span class="nc" id="L250">			ServletContext sc = ServletActionContext.getServletContext();</span>
<span class="nc" id="L251">			String refMerchantId = (String) sc.getAttribute(&quot;REF_MERCHANT_ID&quot;);</span>

<span class="nc" id="L253">			TransactionManager.setResponseData(&quot;true&quot;);</span>
			
<span class="nc bnc" id="L255" title="All 2 branches missed.">			if(!autoCancel) {</span>
<span class="nc" id="L256">				cancelType = &quot;manual&quot;;</span>
<span class="nc bnc" id="L257" title="All 4 branches missed.">			} else if(cancelType != null &amp;&amp; &quot;dataError&quot;.equals(cancelType)) {</span>
			} else {
<span class="nc" id="L259">				cancelType = &quot;&quot;;</span>
			}

<span class="nc" id="L262">			String cancelChannel = &quot;LMS_Web&quot;;</span>
<span class="nc" id="L263">			CancelTicketBean cancelTicketBean = new CancelTicketBean();</span>
<span class="nc" id="L264">			Map&lt;Integer, Map&lt;Integer, String&gt;&gt; drawIdTableMap = (Map&lt;Integer, Map&lt;Integer, String&gt;&gt;) sc.getAttribute(&quot;drawIdTableMap&quot;);</span>
<span class="nc" id="L265">			DrawGameRPOSHelper helper = new DrawGameRPOSHelper();</span>
<span class="nc" id="L266">			cancelTicketBean.setDrawIdTableMap(drawIdTableMap);</span>
<span class="nc" id="L267">			cancelTicketBean.setCancelDuaraion(&quot;true&quot;.equalsIgnoreCase((String)sc.getAttribute(&quot;IS_CANCEL_DURATION&quot;)));</span>
<span class="nc" id="L268">			cancelTicketBean.setCancelDuration(Integer.parseInt((String)sc.getAttribute(&quot;CANCEL_DURATION&quot;)));</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">			if (&quot;LAST_SOLD_TICKET&quot;.equalsIgnoreCase((String) sc.getAttribute(&quot;CANCEL_TYPE&quot;))) {</span>
<span class="nc" id="L270">				ticketNo = helper.getLastSoldTicketNO(userInfoBean,INTERFACE_TYPE_WEB);</span>
<span class="nc bnc" id="L271" title="All 2 branches missed.">				if(ticketNo!= null)</span>
<span class="nc" id="L272">					ticketNo = ticketNo + Util.getRpcAppenderForTickets(ticketNo.length());</span>

<span class="nc" id="L274">				cancelTicketBean.setCancelType(&quot;LAST_SOLD_TICKET&quot;);</span>
			}
<span class="nc bnc" id="L276" title="All 2 branches missed.">			if (ticketNo == null) {</span>
<span class="nc" id="L277">				throw new LMSException(LMSErrors.INVALID_CANCEL_TICKET_DATA_ERROR_CODE, LMSErrors.INVALID_CANCEL_TICKET_DATA_ERROR_MESSAGE);</span>
			} else {
<span class="nc" id="L279">				cancelTicketBean.setTicketNo(ticketNo);</span>
<span class="nc" id="L280">				cancelTicketBean.setPartyId(userInfoBean.getUserOrgId());</span>
<span class="nc" id="L281">				cancelTicketBean.setUserId(userInfoBean.getUserId());</span>
<span class="nc" id="L282">				cancelTicketBean.setPartyType(userInfoBean.getUserType());</span>
<span class="nc" id="L283">				cancelTicketBean.setCancelChannel(cancelChannel);</span>
<span class="nc" id="L284">				cancelTicketBean.setRefMerchantId(refMerchantId);</span>
<span class="nc" id="L285">				cancelTicketBean.setAutoCancel(isAutoCancel());</span>

<span class="nc" id="L287">				cancelTicketBean = helper.cancelTicket(cancelTicketBean, userInfoBean, isAutoCancel(),cancelType);</span>

<span class="nc bnc" id="L289" title="All 2 branches missed.">				if (cancelTicketBean.isValid()) {</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">					if (&quot;LAST_SOLD_TICKET&quot;.equalsIgnoreCase(cancelTicketBean.getCancelType())) {</span>
<span class="nc" id="L291">						String tktNum = cancelTicketBean.getTicketNo();</span>
<span class="nc" id="L292">						cancelTicketBean.setTicketNo(tktNum.substring(0, tktNum.length() - 1) + cancelTicketBean.getReprintCount());</span>
					}

<span class="nc" id="L295">					JSONObject mainData = new JSONObject();</span>
<span class="nc" id="L296">					mainData.put(&quot;ticketNumber&quot;, cancelTicketBean.getTicketNo());</span>
<span class="nc" id="L297">					mainData.put(&quot;orgName&quot;, sc.getAttribute(&quot;ORG_NAME_JSP&quot;));</span>
<span class="nc" id="L298">					mainData.put(&quot;gameName&quot;, Util.getGameName(Util.getGameIdFromGameNumber(cancelTicketBean.getGameNo())));</span>
<span class="nc" id="L299">					mainData.put(&quot;gameDispName&quot;, Util.getGameDisplayName(Util.getGameIdFromGameNumber(cancelTicketBean.getGameNo())));</span>
<span class="nc" id="L300">					mainData.put(&quot;refundAmount&quot;, cancelTicketBean.getRefundAmount());</span>
<span class="nc" id="L301">					mainData.put(&quot;cancelTime&quot;, cancelTicketBean.getCancelTime());</span>
<span class="nc" id="L302">					mainData.put(&quot;advMessage&quot;, cancelTicketBean.getAdvMsg());</span>
<span class="nc" id="L303">					mainData.put(&quot;currencySymbol&quot;, sc.getAttribute(&quot;CURRENCY_SYMBOL&quot;));</span>
<span class="nc" id="L304">					mainData.put(&quot;parentOrgName&quot;, parentOrgName);</span>
<span class="nc" id="L305">					responseObject.put(&quot;isSuccess&quot;, true);</span>
<span class="nc" id="L306">					responseObject.put(&quot;errorMsg&quot;, &quot;&quot;);</span>
<span class="nc" id="L307">					responseObject.put(&quot;mainData&quot;, mainData);</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">				} else if (cancelTicketBean.isError()) {</span>
<span class="nc bnc" id="L309" title="All 4 branches missed.">					if(cancelTicketBean.getErrMsg() != null &amp;&amp; cancelTicketBean.getErrMsg().contains(&quot;|&quot;)){</span>
<span class="nc" id="L310">						throw new LMSException(cancelTicketBean.getErrMsg().split(&quot;\\|&quot;)[0]);</span>
					} else 
<span class="nc" id="L312">						throw new LMSException(cancelTicketBean.getErrMsg());</span>
				} else {
<span class="nc" id="L314">					throw new LMSException(LMSErrors.INVALID_CANCEL_TICKET_DATA_ERROR_CODE, LMSErrors.INVALID_CANCEL_TICKET_DATA_ERROR_MESSAGE);</span>
				}
			}
<span class="nc" id="L317">		} catch(LMSException e) {</span>
<span class="nc" id="L318">			e.printStackTrace();</span>
<span class="nc" id="L319">			responseObject.put(&quot;isSuccess&quot;, false);</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">			if(e.getMessage() !=null){</span>
<span class="nc" id="L321">				responseObject.put(&quot;errorCode&quot;, LMSErrors.GENERAL_EXCEPTION_ERROR_CODE);</span>
<span class="nc" id="L322">				responseObject.put(&quot;errorMsg&quot;, e.getMessage());</span>
			} else{		
<span class="nc" id="L324">				responseObject.put(&quot;errorCode&quot;, e.getErrorCode());</span>
<span class="nc" id="L325">				responseObject.put(&quot;errorMsg&quot;, e.getErrorMessage());</span>
			}
<span class="nc" id="L327">		} catch(Exception e) {</span>
<span class="nc" id="L328">			e.printStackTrace();</span>

<span class="nc" id="L330">			responseObject.put(&quot;isSuccess&quot;, false);</span>
<span class="nc" id="L331">			responseObject.put(&quot;errorCode&quot;, LMSErrors.GENERAL_EXCEPTION_ERROR_CODE);</span>
<span class="nc" id="L332">			responseObject.put(&quot;errorMsg&quot;, LMSErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="nc" id="L333">		}</span>

<span class="nc" id="L335">		logger.info(&quot;CancelTicket Response Data - &quot; + responseObject);</span>
<span class="nc" id="L336">		out.print(responseObject);</span>
<span class="nc" id="L337">		out.flush();</span>
<span class="nc" id="L338">		out.close();</span>
<span class="nc" id="L339">	}</span>

	@SuppressWarnings(&quot;unchecked&quot;)
	public String fetchDrawGameData() throws Exception {
<span class="nc" id="L343">			return SUCCESS;</span>
	}

	public void fetchDrawGameUpdatedData() throws Exception {
<span class="nc" id="L347">		ServletContext sc = ServletActionContext.getServletContext();</span>
<span class="nc" id="L348">		PrintWriter out = getResponse().getWriter();</span>
<span class="nc" id="L349">		Date date = new Date();</span>
<span class="nc" id="L350">		StringBuilder rData = new StringBuilder(date.toString() + &quot;=&quot;</span>
				+ date.getTime() + &quot;ServerDate&quot;);
<span class="nc" id="L352">		Iterator iter = ((TreeMap) sc.getAttribute(&quot;GAME_DATA&quot;)).entrySet()</span>
				.iterator();
<span class="nc bnc" id="L354" title="All 2 branches missed.">		while (iter.hasNext()) {</span>
<span class="nc" id="L355">			Map.Entry pair = (Map.Entry) iter.next();</span>
<span class="nc" id="L356">			List&lt;List&gt; drawList = (List&lt;List&gt;) pair.getValue();</span>
<span class="nc" id="L357">			String nxtDrwTime = drawList.get(0).toString().replace(&quot;[&quot;, &quot;&quot;)</span>
					.replace(&quot;]&quot;, &quot;&quot;);
<span class="nc" id="L359">			List&lt;String&gt; winList = (List&lt;String&gt;) drawList.get(1);</span>
<span class="nc" id="L360">			Iterator winItr = winList.iterator();</span>
<span class="nc" id="L361">			String winData = &quot;&quot;;</span>
<span class="nc bnc" id="L362" title="All 2 branches missed.">			while (winItr.hasNext()) {</span>
<span class="nc" id="L363">				winData = winData + winItr.next() + &quot; Nxt &quot;;</span>
			}
			
			//sachin
<span class="nc" id="L367">			Map&lt;Integer, Map&lt;Integer, DrawDetailsBean&gt;&gt; drawDetailsMap = (Map&lt;Integer, Map&lt;Integer, DrawDetailsBean&gt;&gt;) ServletActionContext</span>
			.getServletContext().getAttribute(&quot;drawDetailsMap&quot;);
<span class="nc" id="L369">			StringBuilder drawIdData = new StringBuilder(); </span>
<span class="nc" id="L370">			Map&lt;Integer, DrawDetailsBean&gt; innerMap = drawDetailsMap.get( pair.getKey());</span>
<span class="nc bnc" id="L371" title="All 4 branches missed.">			if (innerMap != null &amp;&amp; innerMap.size() &gt; 0) {</span>
<span class="nc" id="L372">				Iterator&lt;Map.Entry&lt;Integer, DrawDetailsBean&gt;&gt; innerIter = innerMap</span>
					.entrySet().iterator();
<span class="nc" id="L374">				DrawDetailsBean drawBean = null;</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">				while (innerIter.hasNext()) {</span>
<span class="nc" id="L376">					Map.Entry&lt;Integer, DrawDetailsBean&gt; innerEntryMap = innerIter</span>
					.next();
<span class="nc" id="L378">					drawBean = innerEntryMap.getValue();</span>
<span class="nc" id="L379">					drawIdData.append(drawBean.getDrawId()+&quot;,&quot;+drawBean.getDrawName()+&quot;,&quot;+drawBean.getDrawDateTime().getTime()+&quot;:&quot;);</span>
<span class="nc" id="L380">				}</span>
		}
			
			
			
			// vaibhav
<span class="nc" id="L386">			String gameStatus = drawList.get(2).toString().replace(&quot;[&quot;, &quot;&quot;)</span>
					.replace(&quot;]&quot;, &quot;&quot;);
<span class="nc" id="L388">			rData.append(Util.getGameName((Integer) pair.getKey())</span>
					.toLowerCase()
					+ &quot;UPD&quot;
					+ nxtDrwTime
					+ &quot;UPD&quot;
					+ winData
					+ &quot;UPD&quot;
					+ drawIdData
					+ &quot;UPD&quot;
					+ gameStatus
					+ &quot;Game&quot;);
			// rData.append(pair.getKey() + &quot;UPD&quot; + nxtDrwTime + &quot;UPD&quot; + winData
			// + &quot;Game&quot;);
<span class="nc" id="L401">		}</span>
<span class="nc" id="L402">		logger.debug(&quot;Ajax Call fetchDrawGameUpdatedData&quot; + rData);</span>
<span class="nc" id="L403">		out.print(rData);</span>
<span class="nc" id="L404">	}</span>

	public void fetchServerTime() throws IOException {
<span class="nc" id="L407">		String combinedData = null;</span>
<span class="nc" id="L408">		PrintWriter out = getResponse().getWriter();</span>
<span class="nc" id="L409">		Date date = new Date();</span>
<span class="nc" id="L410">		combinedData = date.toString() + &quot;=&quot; + date.getTime();</span>
<span class="nc" id="L411">		logger.debug(&quot;Combined Data: &quot; + combinedData);</span>
<span class="nc" id="L412">		out.print(combinedData);</span>
<span class="nc" id="L413">	}</span>

	public TreeMap getDrawGameData() {
<span class="nc" id="L416">		return drawGameData;</span>
	}

	public Map&lt;String, Map&lt;Integer, DrawDetailsBean&gt;&gt; getDrawGameNewData() {
<span class="nc" id="L420">		return drawGameNewData;</span>
	}

	public String getEndRange() {
<span class="nc" id="L424">		return endRange;</span>
	}

	public String getErrMsg() {
<span class="nc" id="L428">		return errMsg;</span>
	}

	public String getFirstName() {
<span class="nc" id="L432">		return firstName;</span>
	}

	public FortunePurchaseBean getFortuneBean() {
<span class="nc" id="L436">		return fortuneBean;</span>
	}

	public TreeMap getFreezeTimeMap() {
<span class="nc" id="L440">		return freezeTimeMap;</span>
	}

	public int getGameNo() {
<span class="nc" id="L444">		return gameNo;</span>
	}

	// public vo

	public String getIdNumber() {
<span class="nc" id="L450">		return idNumber;</span>
	}

	public String getIdType() {
<span class="nc" id="L454">		return idType;</span>
	}

	public String getIsRG() {
<span class="nc" id="L458">		return isRG;</span>
	}

	public String getJreVersion() {
<span class="nc" id="L462">		return jreVersion;</span>
	}

	public KenoPurchaseBean getKenoPurchaseBean() {
<span class="nc" id="L466">		return kenoPurchaseBean;</span>
	}

	public String getLastName() {
<span class="nc" id="L470">		return lastName;</span>
	}

	public LottoPurchaseBean getLottoPurchaseBean() {
<span class="nc" id="L474">		return lottoPurchaseBean;</span>
	}

	public String getPickNum() {
<span class="nc" id="L478">		return pickNum;</span>
	}

	public HttpServletResponse getResponse() {
<span class="nc" id="L482">		return response;</span>
	}

	public String getServerTime() {
<span class="nc" id="L486">		return serverTime;</span>
	}

	public HttpServletRequest getServletRequest() {
<span class="nc" id="L490">		return servletRequest;</span>
	}

	public String getStartRange() {
<span class="nc" id="L494">		return startRange;</span>
	}

	public String getTicketNo() {
<span class="nc" id="L498">		return ticketNo;</span>
	}

	public Map getUnitPrice() {
<span class="nc" id="L502">		return unitPrice;</span>
	}

	public String getWinNum() {
<span class="nc" id="L506">		return winNum;</span>
	}

	public boolean isAutoCancel() {
<span class="nc" id="L510">		return autoCancel;</span>
	}

	public void newData() {
		//ServletContext sc = ServletActionContext.getServletContext();
<span class="nc" id="L515">		ServletContext sc = LMSUtility.sc;</span>
		//DrawGameRPOSHelper helper = new DrawGameRPOSHelper();
<span class="nc" id="L517">		/*List updatedDataList = */ServerStartUpData.getUpdatedData(sc);</span>
		/*sc.setAttribute(&quot;GAME_DATA&quot;, (TreeMap&lt;Integer, List&lt;List&gt;&gt;) updatedDataList.get(1));
		sc.setAttribute(&quot;drawIdTableMap&quot;, (Map&lt;Integer, Map&lt;Integer, String&gt;&gt;) updatedDataList.get(0));
		sc.setAttribute(&quot;jackPotMap&quot;, (Map&lt;Integer, Double&gt;) updatedDataList.get(3));
		sc.setAttribute(&quot;drawIdDateMap&quot;,(Map&lt;String, Map&lt;Long, String&gt;&gt;) updatedDataList.get(4));
		sc.setAttribute(&quot;drawDetailsMap&quot;,(Map&lt;String, Map&lt;Integer, DrawDetailsBean&gt;&gt;) updatedDataList.get(5));
		logger.debug(&quot;*jackPotMap**rpos*&quot;+ (Map&lt;Integer, Double&gt;) updatedDataList.get(3));

		Util.drawIdTableMap = (Map&lt;Integer, Map&lt;Integer, String&gt;&gt;) updatedDataList.get(0);
		Util.gameData = (TreeMap&lt;Integer, List&lt;List&gt;&gt;) updatedDataList.get(1);
		Util.jackPotMap = (Map&lt;Integer, Double&gt;) updatedDataList.get(3);
		Util.drawIdDateMap = (Map&lt;String, Map&lt;Long, String&gt;&gt;) updatedDataList.get(4);
		Util.drawDetailsMap = (Map&lt;Integer, Map&lt;Integer, DrawDetailsBean&gt;&gt;) updatedDataList.get(5);*/

<span class="nc bnc" id="L531" title="All 2 branches missed.">		if (&quot;Yes&quot;.equalsIgnoreCase((String) sc.getAttribute(&quot;RET_OFFLINE&quot;))) {</span>
<span class="nc" id="L532">			logger.debug(&quot;&lt;-------------Step1-------------&gt;&quot;);</span>
<span class="nc bnc" id="L533" title="All 2 branches missed.">			if (gameNo != 0) {</span>
<span class="nc" id="L534">				logger.debug(&quot;&lt;-------------Step2-------------&gt;&quot;);</span>
<span class="nc" id="L535">				DrawGameOfflineHelper.checkUserAFUStatus(gameNo);</span>
			}
		}

<span class="nc" id="L539">	}</span>

	public String payPwtTicket(){
<span class="nc" id="L542">		PrintWriter out = null;</span>
<span class="nc" id="L543">		JSONObject jsonResponse = new JSONObject();</span>
<span class="nc" id="L544">		String parentOrgName = null;</span>
		try{	
<span class="nc" id="L546">			response.setContentType(&quot;application/json&quot;);</span>
<span class="nc" id="L547">			out = response.getWriter();</span>
<span class="nc" id="L548">			UserInfoBean userInfoBean = null;</span>
			
<span class="nc" id="L550">			String highPrizeCriteria = (String) LMSUtility.sc.getAttribute(&quot;HIGH_PRIZE_CRITERIA&quot;);</span>
<span class="nc" id="L551">			String highPrizeAmt = (String) LMSUtility.sc.getAttribute(&quot;HIGH_PRIZE_AMT&quot;);</span>
<span class="nc" id="L552">			String highPrizeScheme = (String) LMSUtility.sc.getAttribute(&quot;DRAW_GAME_HIGH_PRIZE_SCHEME&quot;);</span>
	
<span class="nc" id="L554">			JSONObject requestData = (JSONObject) JSONSerializer.toJSON(json);</span>
<span class="nc" id="L555">			String userName = (String) requestData.get(&quot;userName&quot;);</span>
<span class="nc bnc" id="L556" title="All 2 branches missed.">			if(userName == null){</span>
<span class="nc" id="L557">				session = servletRequest.getSession();</span>
<span class="nc" id="L558">				userInfoBean = (UserInfoBean) session.getAttribute(&quot;USER_INFO&quot;);</span>
			} else{
<span class="nc" id="L560">				session = getSession(userName);</span>
<span class="nc" id="L561">				userInfoBean = getUserBean(userName);</span>
			}
<span class="nc" id="L563">			parentOrgName = userInfoBean.getParentOrgName();</span>
			
			//MainPWTDrawBean drawScheduleBean = (MainPWTDrawBean) requestData.get(&quot;mainData&quot;);
			//MainPWTDrawBean drawScheduleBean = new Gson().fromJson(data.get(&quot;mainData&quot;).toString(), new TypeToken&lt;MainPWTDrawBean&gt;() {}.getType());
<span class="nc" id="L567">			MainPWTDrawBean drawScheduleBean = (MainPWTDrawBean)session.getAttribute(&quot;WinningBean&quot;);</span>
			
<span class="nc" id="L569">			DrawGameRPOSHelper helper = new DrawGameRPOSHelper();</span>
	
<span class="nc" id="L571">			int gameId=0;</span>
<span class="nc" id="L572">			long lastPrintedTicket=0;</span>
<span class="nc" id="L573">			ServletContext sc = LMSUtility.sc;</span>
<span class="nc" id="L574">			String refMerchantId = (String) sc.getAttribute(&quot;REF_MERCHANT_ID&quot;);</span>
<span class="nc" id="L575">			int autoCancelHoldDays=Integer.parseInt((String) sc.getAttribute(&quot;AUTO_CANCEL_CLOSER_DAYS&quot;));</span>
			
<span class="nc" id="L577">			String actionName=ActionContext.getContext().getName();</span>
<span class="nc" id="L578">			DrawGameRPOSHelper drawGameRPOSHelper = new DrawGameRPOSHelper();</span>
			//drawGameRPOSHelper.checkLastPrintedTicketStatusAndUpdate(userInfoBean,lastPrintedTicket,&quot;WEB&quot;,refMerchantId,autoCancelHoldDays,actionName,gameId);
			try{
<span class="nc" id="L581">				long LSTktNo =  CookieMgmtForTicketNumber.getTicketNumberFromCookie(servletRequest, userInfoBean.getUserName());</span>
<span class="nc bnc" id="L582" title="All 2 branches missed.">				if(LSTktNo !=0){</span>
<span class="nc" id="L583">					lastPrintedTicket = LSTktNo/Util.getDivValueForLastSoldTkt(String.valueOf(LSTktNo).length());</span>
<span class="nc" id="L584">					gameId = Util.getGameIdFromGameNumber(Util.getGamenoFromTktnumber(String.valueOf(LSTktNo)));</span>
				}
<span class="nc" id="L586">				drawGameRPOSHelper.insertEntryIntoPrintedTktTableForWeb(gameId, userInfoBean.getUserOrgId(), lastPrintedTicket, INTERFACE_TYPE_WEB, Util.getCurrentTimeStamp(), actionName);</span>
<span class="nc" id="L587">			}catch(Exception e){</span>
				//e.printStackTrace();
<span class="nc" id="L589">			}</span>
<span class="nc" id="L590">			MainPWTDrawBean pwtWinningBean = helper.payPwtTicket(drawScheduleBean,</span>
					userInfoBean,highPrizeCriteria,highPrizeAmt,highPrizeScheme);
	
<span class="nc bnc" id="L593" title="All 2 branches missed.">			if (&quot;PWT_LIMIT_EXCEED&quot;.equalsIgnoreCase(drawScheduleBean.getStatus())) {</span>
<span class="nc" id="L594">				pwtWinningBean.setStatus(&quot;PWT_LIMIT_EXCEED&quot;);</span>
<span class="nc" id="L595">				throw new LMSException(LMSErrors.RG_LIMIT_EXCEPTION_ERROR_CODE, LMSErrors.RG_LIMIT_EXCEPTION_ERROR_MESSAGE);</span>
<span class="nc bnc" id="L596" title="All 2 branches missed.">			} else if (&quot;INVALID_PWT_LIMIT_EXCEED&quot;.equalsIgnoreCase(drawScheduleBean.getStatus())) {</span>
<span class="nc" id="L597">				pwtWinningBean.setStatus(&quot;INVALID_PWT_LIMIT_EXCEED&quot;);</span>
<span class="nc" id="L598">				throw new LMSException(LMSErrors.RG_LIMIT_EXCEPTION_ERROR_CODE, LMSErrors.RG_LIMIT_EXCEPTION_ERROR_MESSAGE);</span>
			}
<span class="nc bnc" id="L600" title="All 2 branches missed.">			else if (pwtWinningBean.getStatus().equalsIgnoreCase(&quot;ERROR&quot;)) {</span>
<span class="nc" id="L601">				throw new LMSException(LMSErrors.GENERAL_EXCEPTION_ERROR_CODE, LMSErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
			} else {
				/*jsonResponse.put(&quot;isSuccess&quot;, true);
				jsonResponse.put(&quot;mainData&quot;, pwtWinningBean);
				jsonResponse.put(&quot;userName&quot;, userInfoBean.getUserName());
				jsonResponse.put(&quot;orgName&quot;, userInfoBean.getOrgName());
				jsonResponse.put(&quot;errorMsg&quot;, &quot;&quot;);*/
<span class="nc" id="L608">				jsonResponse = parseWinningData(pwtWinningBean, userInfoBean, true,parentOrgName);</span>
			}
			
<span class="nc" id="L611">		}catch (LMSException e) {</span>
<span class="nc" id="L612">			jsonResponse.put(&quot;isSuccess&quot;, false);</span>
<span class="nc" id="L613">			jsonResponse.put(&quot;errorCode&quot;,e.getErrorCode());</span>
<span class="nc" id="L614">			jsonResponse.put(&quot;errorMsg&quot;, e.getErrorMessage());	</span>
<span class="nc" id="L615">		}catch (Exception e) {</span>
<span class="nc" id="L616">			e.printStackTrace();</span>
<span class="nc" id="L617">		 	jsonResponse.put(&quot;isSuccess&quot;, false);</span>
<span class="nc" id="L618">			jsonResponse.put(&quot;errorCode&quot;, LMSErrors.GENERAL_EXCEPTION_ERROR_CODE);</span>
<span class="nc" id="L619">			jsonResponse.put(&quot;errorMsg&quot;, LMSErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
	
<span class="nc" id="L621">	}</span>
<span class="nc" id="L622">	logger.info(&quot;Response Data : {}&quot;+ jsonResponse);</span>
<span class="nc" id="L623">	out.print(jsonResponse);</span>
<span class="nc" id="L624">	out.flush();</span>
<span class="nc" id="L625">	out.close();</span>


<span class="nc" id="L628">	return SUCCESS;</span>
	}

	public String prizeWinningTicket(){
		
<span class="nc" id="L633">		PrintWriter out = null;</span>
<span class="nc" id="L634">		JSONObject jsonResponse = new JSONObject();</span>
<span class="nc" id="L635">		String parentOrgName = null;</span>
		try{
<span class="nc" id="L637">			response.setContentType(&quot;application/json&quot;);</span>
<span class="nc" id="L638">			out = response.getWriter();</span>
<span class="nc" id="L639">			logger.info(&quot;Inside prizeWinningTicket&quot;);</span>
<span class="nc" id="L640">			UserInfoBean userInfoBean = null;</span>
<span class="nc" id="L641">			ServletContext sc = ServletActionContext.getServletContext();</span>
<span class="nc" id="L642">			String refMerchantId = (String) sc.getAttribute(&quot;REF_MERCHANT_ID&quot;);</span>
			
<span class="nc" id="L644">			JSONObject requestData = (JSONObject) JSONSerializer.toJSON(json);</span>
<span class="nc" id="L645">			String ticketNumber = (String) requestData.get(&quot;ticketNumber&quot;);</span>
			
<span class="nc" id="L647">			String userName = (String) requestData.get(&quot;userName&quot;);</span>
<span class="nc bnc" id="L648" title="All 2 branches missed.">			if(userName == null){</span>
<span class="nc" id="L649">				session = servletRequest.getSession();</span>
<span class="nc" id="L650">				userInfoBean = (UserInfoBean) session.getAttribute(&quot;USER_INFO&quot;);</span>
			} else{
<span class="nc" id="L652">				session = getSession(userName);</span>
<span class="nc" id="L653">				userInfoBean = getUserBean(userName);</span>
			}
<span class="nc" id="L655">			parentOrgName = userInfoBean.getParentOrgName();</span>
		
<span class="nc" id="L657">			int gameId=0;</span>
<span class="nc" id="L658">			long lastPrintedTicket=0;</span>
			
<span class="nc" id="L660">			String actionName=ActionContext.getContext().getName();</span>
<span class="nc" id="L661">			DrawGameRPOSHelper drawGameRPOSHelper = new DrawGameRPOSHelper();</span>
			//drawGameRPOSHelper.checkLastPrintedTicketStatusAndUpdate(userInfoBean,lastPrintedTicket,&quot;WEB&quot;,refMerchantId,autoCancelHoldDays,actionName,gameId);
			try{
<span class="nc" id="L664">				long LSTktNo =  CookieMgmtForTicketNumber.getTicketNumberFromCookie(servletRequest, userInfoBean.getUserName());</span>
<span class="nc bnc" id="L665" title="All 2 branches missed.">				if(LSTktNo !=0){</span>
<span class="nc" id="L666">					lastPrintedTicket = LSTktNo/Util.getDivValueForLastSoldTkt(String.valueOf(LSTktNo).length());</span>
<span class="nc" id="L667">					gameId = Util.getGameIdFromGameNumber(Util.getGamenoFromTktnumber(String.valueOf(LSTktNo)));</span>
				}
<span class="nc" id="L669">				drawGameRPOSHelper.insertEntryIntoPrintedTktTableForWeb(gameId, userInfoBean.getUserOrgId(), lastPrintedTicket, INTERFACE_TYPE_WEB, Util.getCurrentTimeStamp(), actionName);</span>
<span class="nc" id="L670">			}catch(Exception e){</span>
				//e.printStackTrace();
<span class="nc" id="L672">			}</span>
			
<span class="nc" id="L674">			MainPWTDrawBean mainPwtBean = new MainPWTDrawBean();</span>
<span class="nc" id="L675">			mainPwtBean.setInpType(Integer.parseInt((String) sc.getAttribute(&quot;InpType&quot;)));</span>
<span class="nc" id="L676">			mainPwtBean.setTicketNo(ticketNumber);</span>
	
<span class="nc" id="L678">			DrawGameRPOSHelper helper = new DrawGameRPOSHelper();</span>
<span class="nc" id="L679">			logger.debug(&quot;Before--&quot; + new Date());</span>
<span class="nc" id="L680">			MainPWTDrawBean mainWinningBean = helper.prizeWinningTicket(</span>
					mainPwtBean, userInfoBean, refMerchantId);
	
<span class="nc bnc" id="L683" title="All 2 branches missed.">			if (mainWinningBean.getTotlticketAmount() &gt; 0.0) {</span>
<span class="nc" id="L684">				logger.debug(&quot;Creating beep sound with amount:::&quot;</span>
						+ mainWinningBean.getTotlticketAmount());
<span class="nc" id="L686">				Toolkit.getDefaultToolkit().beep();</span>
			}
		
<span class="nc bnc" id="L689" title="All 2 branches missed.">			if (&quot;ERROR&quot;.equalsIgnoreCase(mainWinningBean.getStatus())) {</span>
<span class="nc" id="L690">				throw new LMSException(LMSErrors.GENERAL_EXCEPTION_ERROR_CODE, LMSErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="nc bnc" id="L691" title="All 2 branches missed.">			} else if (&quot;FRAUD&quot;.equalsIgnoreCase(mainWinningBean.getStatus())) {</span>
<span class="nc" id="L692">				throw new LMSException(LMSErrors.GENERAL_EXCEPTION_ERROR_CODE, LMSErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="nc bnc" id="L693" title="All 2 branches missed.">			} else if (&quot;ERROR_INVALID&quot;.equalsIgnoreCase(mainWinningBean.getStatus())) {</span>
<span class="nc" id="L694">				throw new LMSException(LMSErrors.INVALID_TICKET_ERROR_CODE, LMSErrors.INVALID_TICKET_ERROR_MESSAGE);</span>
<span class="nc bnc" id="L695" title="All 2 branches missed.">			} else if (&quot;CANCELLED&quot;.equalsIgnoreCase(mainWinningBean.getStatus())) {</span>
<span class="nc" id="L696">				throw new LMSException(LMSErrors.TICKET_CANCELLED_ERROR_CODE, LMSErrors.TICKET_CANCELLED_ERROR_MESSAGE);</span>
<span class="nc bnc" id="L697" title="All 2 branches missed.">			} else if (&quot;ALREADY_CANCELLED&quot;.equalsIgnoreCase(mainWinningBean.getStatus())) {</span>
<span class="nc" id="L698">				throw new LMSException(LMSErrors.TICKET_ALREADY_CANCELLED_ERROR_CODE, LMSErrors.TICKET_ALREADY_CANCELLED_ERROR_MESSAGE);</span>
<span class="nc bnc" id="L699" title="All 2 branches missed.">			}else if(&quot;TICKET_EXPIRED&quot;.equalsIgnoreCase(mainWinningBean.getStatus())){</span>
<span class="nc" id="L700">				throw new LMSException(LMSErrors.TICKET_EXPIRED_ERROR_CODE, LMSErrors.TICKET_EXPIRED_ERROR_MESSAGE);</span>
<span class="nc bnc" id="L701" title="All 2 branches missed.">			} else if (!mainWinningBean.isValid()) {</span>
<span class="nc" id="L702">				throw new LMSException(LMSErrors.GENERAL_EXCEPTION_ERROR_CODE, LMSErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="nc bnc" id="L703" title="All 2 branches missed.">			} if (&quot;UN_AUTH&quot;.equalsIgnoreCase(mainWinningBean.getStatus())) {</span>
<span class="nc" id="L704">				throw new LMSException(LMSErrors.UNAUTHORIZED_PWT_CLAIM_ERROR_CODE, LMSErrors.UNAUTHORIZED_PWT_CLAIM_ERROR_MESSAGE);</span>
<span class="nc bnc" id="L705" title="All 2 branches missed.">			}else if(&quot;HIGH_PRIZE&quot;.equalsIgnoreCase(mainWinningBean.getStatus())){</span>
<span class="nc" id="L706">				throw new LMSException(LMSErrors.HIGH_PRIZE_PWT_ERROR_CODE, LMSErrors.HIGH_PRIZE_PWT_ERROR_MESSAGE);</span>
<span class="nc bnc" id="L707" title="All 2 branches missed.">			}else if(&quot;OUT_VERIFY_LIMIT&quot;.equalsIgnoreCase(mainWinningBean.getStatus())){</span>
<span class="nc" id="L708">				throw new LMSException(LMSErrors.OUT_VERIFY_LIMIT_ERROR_CODE, LMSErrors.OUT_VERIFY_LIMIT_ERROR_MESSAGE);</span>
<span class="nc bnc" id="L709" title="All 2 branches missed.">			}else if(&quot;OUT_PAY_LIMIT&quot;.equalsIgnoreCase(mainWinningBean.getStatus())){</span>
<span class="nc" id="L710">				throw new LMSException(LMSErrors.OUT_PAY_LIMIT_ERROR_CODE, LMSErrors.OUT_PAY_LIMIT_ERROR_MESSAGE);</span>
			}else{
<span class="nc" id="L712">				session.setAttribute(&quot;WinningBean&quot;, mainWinningBean);</span>
				/*jsonResponse.put(&quot;isSuccess&quot;, true);
				jsonResponse.put(&quot;mainData&quot;, mainWinningBean);
				jsonResponse.put(&quot;errorMsg&quot;, &quot;&quot;);*/
<span class="nc" id="L716">				jsonResponse = parseWinningData(mainWinningBean, userInfoBean, false, parentOrgName);</span>
			}
		
<span class="nc" id="L719">		}catch (LMSException e) {</span>
<span class="nc" id="L720">			jsonResponse.put(&quot;isSuccess&quot;, false);</span>
<span class="nc" id="L721">			jsonResponse.put(&quot;errorCode&quot;,e.getErrorCode());</span>
<span class="nc" id="L722">			jsonResponse.put(&quot;errorMsg&quot;, e.getErrorMessage());	</span>
<span class="nc" id="L723">		}catch (Exception e) {</span>
<span class="nc" id="L724">			e.printStackTrace();</span>
<span class="nc" id="L725">		 	jsonResponse.put(&quot;isSuccess&quot;, false);</span>
<span class="nc" id="L726">			jsonResponse.put(&quot;errorCode&quot;, LMSErrors.GENERAL_EXCEPTION_ERROR_CODE);</span>
<span class="nc" id="L727">			jsonResponse.put(&quot;errorMsg&quot;, LMSErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
		
<span class="nc" id="L729">		}</span>
<span class="nc" id="L730">		logger.info(&quot;Response Data : {}&quot;+ jsonResponse);</span>
<span class="nc" id="L731">		out.print(jsonResponse);</span>
<span class="nc" id="L732">		out.flush();</span>
<span class="nc" id="L733">		out.close();</span>


<span class="nc" id="L736">		return SUCCESS;</span>
	}

	private JSONObject parseWinningData(MainPWTDrawBean winningBean, UserInfoBean userBean, boolean isPay, String parentOrgName) throws LMSException {
<span class="nc" id="L740">		SimpleDateFormat inputFormat = null;</span>
<span class="nc" id="L741">		SimpleDateFormat dateFormat = null;</span>
<span class="nc" id="L742">		SimpleDateFormat timeFormat = null;</span>

<span class="nc" id="L744">		JSONObject responseObject = new JSONObject();</span>
<span class="nc" id="L745">		JSONArray drawArray = new JSONArray();</span>
<span class="nc" id="L746">		JSONObject drawObject = null;</span>
		try {
<span class="nc" id="L748">			responseObject = new JSONObject();</span>
<span class="nc" id="L749">			drawArray = new JSONArray();</span>
<span class="nc" id="L750">			drawObject = null;</span>

<span class="nc" id="L752">			inputFormat = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;);</span>
			//dateFormat = new SimpleDateFormat(&quot;dd-MM-yyyy&quot;);
<span class="nc" id="L754">			dateFormat = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span>
<span class="nc" id="L755">			timeFormat = new SimpleDateFormat(&quot;HH:mm:ss&quot;);</span>

<span class="nc" id="L757">			double totalWinAmt = 0.00;</span>
<span class="nc" id="L758">			String reprintCountPwt = null;</span>
<span class="nc bnc" id="L759" title="All 2 branches missed.">			for(PWTDrawBean pwtBean : winningBean.getWinningBeanList()) {</span>
<span class="nc" id="L760">				reprintCountPwt = pwtBean.getReprintCount();</span>
<span class="nc bnc" id="L761" title="All 2 branches missed.">				for(DrawIdBean drawBean : pwtBean.getDrawWinList()) {</span>
<span class="nc" id="L762">					String winAmt = drawBean.getWinningAmt();</span>
<span class="nc bnc" id="L763" title="All 4 branches missed.">					if(winAmt != null &amp;&amp; winAmt.length()&gt;0)</span>
<span class="nc" id="L764">						totalWinAmt += Double.parseDouble(drawBean.getWinningAmt());</span>

<span class="nc" id="L766">					Date inputDate = inputFormat.parse(drawBean.getDrawDateTime().split(&quot;\\*&quot;)[0]);</span>
<span class="nc" id="L767">					drawObject = new JSONObject();</span>
<span class="nc bnc" id="L768" title="All 4 branches missed.">					if(drawBean.getDrawname()!= null &amp;&amp; !&quot;null&quot;.equalsIgnoreCase(drawBean.getDrawname())){</span>
<span class="nc" id="L769">						drawObject.put(&quot;drawName&quot;, drawBean.getDrawname());</span>
					}
<span class="nc" id="L771">					drawObject.put(&quot;drawDate&quot;, dateFormat.format(inputDate));</span>
<span class="nc" id="L772">					drawObject.put(&quot;drawTime&quot;, timeFormat.format(inputDate));					</span>
<span class="nc bnc" id="L773" title="All 4 branches missed.">					drawObject.put(&quot;winStatus&quot;, &quot;RES_AWAITED&quot;.equalsIgnoreCase(drawBean.getStatus())?&quot;Result Awaited!!&quot;:&quot;NORMAL_PAY&quot;.equalsIgnoreCase(drawBean.getStatus())?&quot;Win!!&quot;:drawBean.getStatus());</span>
<span class="nc" id="L774">					drawObject.put(&quot;winningAmt&quot;, drawBean.getWinningAmt());</span>
<span class="nc" id="L775">					drawArray.add(drawObject);</span>
<span class="nc" id="L776">				}</span>
<span class="nc" id="L777">			}</span>

			

<span class="nc" id="L781">			responseObject.put(&quot;isSuccess&quot;, true);</span>
<span class="nc" id="L782">			responseObject.put(&quot;advMsg&quot;, winningBean.getAdvMsg());</span>
<span class="nc" id="L783">			responseObject.put(&quot;gameName&quot;, Util.getGameDisplayName(winningBean.getGameId()));</span>
<span class="nc" id="L784">			responseObject.put(&quot;gameDevName&quot;, Util.getGameMap().get(winningBean.getGameId()).getGameNameDev());</span>
<span class="nc" id="L785">			responseObject.put(&quot;ticketNumber&quot;, winningBean.getTicketNo());</span>
<span class="nc bnc" id="L786" title="All 2 branches missed.">			responseObject.put(&quot;barcodeCount&quot;, winningBean.getTicketNo()+((ConfigurationVariables.currentTktLen == ConfigurationVariables.tktLenB &amp;&amp; LMSFilterDispatcher.isBarCodeRequired)? winningBean.getBarcodeCount():&quot;&quot;));</span>
<span class="nc" id="L787">			responseObject.put(&quot;totalWinAmt&quot;, totalWinAmt);</span>
<span class="nc" id="L788">			responseObject.put(&quot;totalPay&quot;, totalWinAmt);</span>
<span class="nc" id="L789">			responseObject.put(&quot;orgName&quot;, Utility.getPropertyValue(&quot;ORG_NAME_JSP&quot;));</span>
<span class="nc" id="L790">			responseObject.put(&quot;retailerName&quot;, userBean.getUserName());</span>
<span class="nc" id="L791">			responseObject.put(&quot;reprintCountPwt&quot;, reprintCountPwt);</span>
<span class="nc" id="L792">			responseObject.put(&quot;currencySymbol&quot;, Utility.getPropertyValue(&quot;CURRENCY_SYMBOL&quot;));</span>
<span class="nc" id="L793">			responseObject.put(&quot;drawData&quot;, drawArray);</span>

<span class="nc bnc" id="L795" title="All 2 branches missed.">			if (isPay) {</span>
				/*
				 * Object purchaseBean = winningBean.getPurchaseBean();
				 * if(purchaseBean instanceof KenoPurchaseBean) { Date
				 * purchaseDate =
				 * inputFormat.parse(kenoPurchaseBean.getPurchaseTime());
				 * 
				 * KenoPurchaseBean kenoBean = (KenoPurchaseBean) purchaseBean;
				 * reprintObject.put(&quot;orgName&quot;,
				 * Utility.getPropertyValue(&quot;ORG_NAME_JSP&quot;));
				 * reprintObject.put(&quot;advMsg&quot;, kenoBean.getAdvMsg());
				 * reprintObject.put(&quot;retailerName&quot;, userBean.getUserName());
				 * reprintObject.put(&quot;ticketNumber&quot;, kenoBean.getTicket_no() +
				 * kenoBean.getReprintCount()); reprintObject.put(&quot;brCd&quot;,
				 * kenoBean.getTicket_no() + kenoBean.getReprintCount() +
				 * kenoBean.getBarcodeCount()); reprintObject.put(&quot;gameName&quot;,
				 * Util.getGameDisplayName(winningBean.getGameId()));
				 * reprintObject.put(&quot;purchaseDate&quot;,
				 * dateFormat.format(purchaseDate));
				 * reprintObject.put(&quot;purchaseTime&quot;,
				 * timeFormat.format(purchaseDate));
				 * reprintObject.put(&quot;purchaseAmt&quot;,
				 * kenoBean.getTotalPurchaseAmt()); reprintObject.put(&quot;isQp&quot;,
				 * kenoBean.getIsQuickPick()[0]); reprintObject.put(&quot;betName&quot;,
				 * kenoBean.getBetDispName()); reprintObject.put(&quot;&quot;, );
				 * reprintObject.put(&quot;&quot;, ); reprintObject.put(&quot;&quot;, );
				 * reprintObject.put(&quot;&quot;, );
				 * 
				 * drawArray = new JSONArray(); for(String drawNameDateTime :
				 * kenoPurchaseBean.getDrawDateTime()) { drawObject = new
				 * JSONObject();
				 * 
				 * Date inputDate =
				 * inputFormat.parse(drawNameDateTime.split(&quot;\\*&quot;)[0]); String
				 * drawName = (drawNameDateTime.split(&quot;\\*&quot;)[1]).split(&quot;&amp;&quot;)[0];
				 * drawObject.put(&quot;drawName&quot;, drawName);
				 * drawObject.put(&quot;drawDate&quot;, dateFormat.format(inputDate));
				 * drawObject.put(&quot;drawTime&quot;, timeFormat.format(inputDate));
				 * drawArray.add(drawObject); } reprintObject.put(&quot;drawData&quot;,
				 * drawArray); }
				 */

<span class="nc" id="L837">				responseObject.put(&quot;isReprint&quot;, winningBean.isReprint());</span>
<span class="nc" id="L838">				JSONArray betTypeArray = new JSONArray();</span>
<span class="nc" id="L839">				JSONObject betTypeDataRes = null;</span>
<span class="nc" id="L840">				boolean isQP = false;</span>
<span class="nc" id="L841">				Object objBean = winningBean.getPurchaseBean();</span>

<span class="nc bnc" id="L843" title="All 2 branches missed.">				if (objBean instanceof KenoPurchaseBean) {</span>
<span class="nc" id="L844">					KenoPurchaseBean bean = (KenoPurchaseBean) winningBean</span>
							.getPurchaseBean();

<span class="nc bnc" id="L847" title="All 2 branches missed.">					for (int i = 0; i &lt; bean.getPlayerData().length; i++) {</span>
<span class="nc" id="L848">						betTypeDataRes = new JSONObject();</span>
<span class="nc bnc" id="L849" title="All 2 branches missed.">						isQP = bean.getIsQuickPick()[i] == 1 ? true : false;</span>
<span class="nc" id="L850">						betTypeDataRes.put(&quot;isQp&quot;, isQP);</span>
<span class="nc" id="L851">						betTypeDataRes.put(&quot;betName&quot;, bean.getPlayType()[i]);</span>
<span class="nc" id="L852">						betTypeDataRes.put(&quot;pickedNumbers&quot;, bean.getPlayerData()[i]);</span>
<span class="nc" id="L853">						betTypeDataRes.put(&quot;numberPicked&quot;,bean.getPlayerData()[i].split(&quot;,&quot;).length);</span>
<span class="nc" id="L854">						betTypeDataRes.put(&quot;unitPrice&quot;, bean.getUnitPrice()[i]);</span>
<span class="nc" id="L855">						betTypeDataRes.put(&quot;noOfLines&quot;, bean.getNoOfLines()[i]);</span>
<span class="nc" id="L856">						betTypeDataRes.put(&quot;betAmtMul&quot;, bean.getBetAmountMultiple()[i]);</span>
<span class="nc" id="L857">						double panelPrice = bean.getUnitPrice()[i] * bean.getNoOfDraws();</span>
<span class="nc" id="L858">						betTypeDataRes.put(&quot;panelPrice&quot;, panelPrice);</span>
<span class="nc" id="L859">						betTypeArray.add(betTypeDataRes);</span>
					}
<span class="nc" id="L861">					bean.setTicket_no(bean.getTicket_no()+bean.getReprintCount());</span>
<span class="nc" id="L862">					responseObject.put(&quot;reprintData&quot;, bean);</span>
				}
<span class="nc bnc" id="L864" title="All 2 branches missed.">				if (objBean instanceof FortunePurchaseBean) {</span>
<span class="nc" id="L865">					FortunePurchaseBean bean = (FortunePurchaseBean) winningBean.getPurchaseBean();</span>

<span class="nc" id="L867">					isQP = false;</span>
<span class="nc bnc" id="L868" title="All 2 branches missed.">					for (int i = 0; i &lt; bean.getBetAmountMultiple().length; i++) {</span>
<span class="nc" id="L869">						betTypeDataRes = new JSONObject();</span>
<span class="nc bnc" id="L870" title="All 2 branches missed.">						isQP = bean.getIsQuickPick()[i] == 1 ? true : false;</span>
<span class="nc" id="L871">						betTypeDataRes.put(&quot;isQp&quot;, isQP);</span>
<span class="nc" id="L872">						betTypeDataRes.put(&quot;betName&quot;, &quot;oneToTwelve&quot;);</span>
<span class="nc" id="L873">						betTypeDataRes.put(&quot;pickedNumbers&quot;, bean.getPickedNumbers().get(i).toString());</span>
<span class="nc" id="L874">						betTypeDataRes.put(&quot;unitPrice&quot;, bean.getUnitPrice());</span>
<span class="nc" id="L875">						betTypeDataRes.put(&quot;noOfLines&quot;, &quot;1&quot;);</span>
<span class="nc" id="L876">						betTypeDataRes.put(&quot;betAmtMul&quot;, bean.getBetAmountMultiple()[i]);</span>
<span class="nc" id="L877">						double panelPrice = bean.getBetAmountMultiple()[i] * bean.getUnitPrice() * 1 * bean.getNoOfDraws();</span>
<span class="nc" id="L878">						betTypeDataRes.put(&quot;panelPrice&quot;, panelPrice);</span>
<span class="nc" id="L879">						betTypeArray.add(betTypeDataRes);</span>
					}
<span class="nc" id="L881">					bean.setTicket_no(bean.getTicket_no()+bean.getReprintCount());</span>
<span class="nc" id="L882">					responseObject.put(&quot;reprintData&quot;, bean);</span>
<span class="nc bnc" id="L883" title="All 2 branches missed.">				}else if (objBean instanceof LottoPurchaseBean) {</span>
<span class="nc" id="L884">					LottoPurchaseBean bean = (LottoPurchaseBean) winningBean.getPurchaseBean();</span>
<span class="nc" id="L885">					isQP = false;</span>
<span class="nc bnc" id="L886" title="All 2 branches missed.">					for (int i = 0; i &lt; bean.getBetAmountMultiple().length; i++) {</span>
<span class="nc" id="L887">						betTypeDataRes = new JSONObject();</span>
<span class="nc bnc" id="L888" title="All 2 branches missed.">						isQP = bean.getIsQuickPick()[i] == 1 ? true : false;</span>
<span class="nc" id="L889">						betTypeDataRes.put(&quot;isQp&quot;, isQP);</span>
<span class="nc" id="L890">						betTypeDataRes.put(&quot;betName&quot;, &quot;oneToTwelve&quot;);</span>
<span class="nc" id="L891">						betTypeDataRes.put(&quot;pickedNumbers&quot;, bean.getPlayerPicked());</span>
<span class="nc" id="L892">						betTypeDataRes.put(&quot;unitPrice&quot;, bean.getUnitPrice());</span>
<span class="nc" id="L893">						betTypeDataRes.put(&quot;noOfLines&quot;, &quot;1&quot;);</span>
<span class="nc" id="L894">						betTypeDataRes.put(&quot;betAmtMul&quot;, bean.getBetAmountMultiple()[i]);</span>
<span class="nc" id="L895">						double panelPrice = bean.getBetAmountMultiple()[i] * bean.getUnitPrice() * 1 * bean.getNoOfDraws();</span>
<span class="nc" id="L896">						betTypeDataRes.put(&quot;panelPrice&quot;, panelPrice);</span>
<span class="nc" id="L897">						betTypeArray.add(betTypeDataRes);</span>
					}
<span class="nc" id="L899">					bean.setTicket_no(bean.getTicket_no()+bean.getReprintCount());</span>
<span class="nc" id="L900">					responseObject.put(&quot;reprintData&quot;, bean);</span>
				}
<span class="nc" id="L902">				responseObject.put(&quot;betTypeData&quot;, betTypeArray);</span>
<span class="nc" id="L903">				responseObject.put(&quot;parentOrgName&quot;, parentOrgName);</span>
			}
<span class="nc" id="L905">		} catch (Exception ex) {</span>
<span class="nc" id="L906">			throw new LMSException(LMSErrors.GENERAL_EXCEPTION_ERROR_CODE, LMSErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="nc" id="L907">		}</span>

<span class="nc" id="L909">		return responseObject;</span>
	}

	public void registerPlayer() throws IOException {
<span class="nc" id="L913">		session = servletRequest.getSession();</span>
<span class="nc" id="L914">		UserInfoBean userInfoBean = (UserInfoBean) session</span>
				.getAttribute(&quot;USER_INFO&quot;);
<span class="nc" id="L916">		DrawGameRPOSHelper helper = new DrawGameRPOSHelper();</span>
<span class="nc" id="L917">		PWTDrawBean pwtBean = helper.registerPlayer(firstName, lastName,</span>
				idNumber, idType,
				(PWTDrawBean) session.getAttribute(&quot;PWT_RES&quot;), userInfoBean);
<span class="nc" id="L920">		PrintWriter out = getResponse().getWriter();</span>
<span class="nc bnc" id="L921" title="All 2 branches missed.">		if (pwtBean.getStatus().equals(&quot;SUCCESS&quot;)) {</span>
<span class="nc" id="L922">			out.print(&quot;Registration Successful&quot;);</span>
		} else {
<span class="nc" id="L924">			out.print(&quot;Error&quot;);</span>
		}
<span class="nc" id="L926">	}</span>

	/*public String reprintTicket() throws Exception {

		session = servletRequest.getSession();
		logger.info(&quot;Inside reprintTicket&quot;);
		UserInfoBean userInfoBean = (UserInfoBean) session
				.getAttribute(&quot;USER_INFO&quot;);
		logger.debug(&quot;Before--&quot; + new Date());
		errMsg = &quot;Last Transaction Not Sale&quot;;
		DrawGameRPOSHelper helper = new DrawGameRPOSHelper();
		Object gameBean = null;
		
		
		int gameId=0;
		long lastPrintedTicket=0;
		ServletContext  sc = LMSUtility.sc;
		String refMerchantId = (String) sc.getAttribute(&quot;REF_MERCHANT_ID&quot;);
		int autoCancelHoldDays=Integer.parseInt((String) sc.getAttribute(&quot;AUTO_CANCEL_CLOSER_DAYS&quot;));
		
		String actionName=ActionContext.getContext().getName();
		DrawGameRPOSHelper drawGameRPOSHelper = new DrawGameRPOSHelper();
		//drawGameRPOSHelper.checkLastPrintedTicketStatusAndUpdate(userInfoBean,lastPrintedTicket,&quot;WEB&quot;,refMerchantId,autoCancelHoldDays,actionName,gameId);
		try{
			long LSTktNo =  CookieMgmtForTicketNumber.getTicketNumberFromCookie(servletRequest, userInfoBean.getUserName());
			if(LSTktNo !=0){
				lastPrintedTicket = LSTktNo/Util.getDivValueForLastSoldTkt(String.valueOf(LSTktNo).length());
				gameId = Util.getGameIdFromGameNumber(Util.getGamenoFromTktnumber(String.valueOf(LSTktNo)));
			}
			drawGameRPOSHelper.insertEntryIntoPrintedTktTableForWeb(gameId, userInfoBean.getUserOrgId(), lastPrintedTicket, &quot;WEB&quot;, Util.getCurrentTimeStamp(), actionName);
		}catch(Exception e){
			//e.printStackTrace();
		}
		
		
		if (ticketNo == null) {
			gameBean = helper.reprintTicket(userInfoBean,false,null,true,null,&quot;WEB&quot;);
		} else {
			gameBean = helper.reprintTicket(userInfoBean,false,ticketNo,false,null,&quot;WEB&quot;);
		}
		logger.debug(&quot;******gameBean::&quot; + gameBean);
		isRG = &quot;false&quot;;
		if (gameBean instanceof FortunePurchaseBean) {
			logger.debug(&quot; FortunePurchaseBean reprint &quot;);
			FortunePurchaseBean fortuneBean = (FortunePurchaseBean) gameBean;
			setFortuneBean(fortuneBean);
			return Util.getGameName(fortuneBean.getGame_no()).toUpperCase()
					+ &quot;_REPRINT&quot;;
		} else if (gameBean instanceof LottoPurchaseBean) {

			LottoPurchaseBean lottoPurchaseBean = (LottoPurchaseBean) gameBean;
			setLottoPurchaseBean(lottoPurchaseBean);
			
			//added for numbers wrong print in ticket
			StringBuilder sb=new StringBuilder();
			if(lottoPurchaseBean.getPlayerPicked().size()&gt;0){
				for(int i=0;i&lt;lottoPurchaseBean.getPlayerPicked().size();i++){
					sb.append(lottoPurchaseBean.getPlayerPicked().get(i)+ &quot;;&quot;);
				}
			}
			setPickNumStr(sb.toString());
			
			setPurchaseData(StringifyGameResponseForApplet.stringifyGameResponseForApplet(userInfoBean , lottoPurchaseBean));
			return Util.getGameName(lottoPurchaseBean.getGameId())
					.toUpperCase()
					+ &quot;_REPRINT&quot;;
		} else if (gameBean instanceof KenoPurchaseBean) {
			logger.debug(&quot; kenoPurchaseBean reprint &quot;);
			KenoPurchaseBean kenoPurchaseBean = (KenoPurchaseBean) gameBean;
			setKenoTwoPurchaseBean(kenoPurchaseBean);
			setKenoPurchaseBean(kenoPurchaseBean);
			setTwelveByTwentyFourPurchaseBean(kenoPurchaseBean);
			return Util.getGameName(kenoPurchaseBean.getGameId())
					.toUpperCase()
					+ &quot;_REPRINT&quot;;
		} else if (gameBean instanceof String
				&amp;&amp; &quot;RG_RPERINT&quot;.equals(gameBean.toString())) {
			isRG = &quot;true&quot;;
			errMsg = DGErrorMsg.buyErrMsg(gameBean.toString());
		} else if (gameBean instanceof String) {
			if (gameBean.toString().indexOf(&quot;ErrorCode&quot;) &gt; -1) {
				errMsg = gameBean.toString().split(&quot;\\|ErrorCode&quot;)[0];
		    } else {
			errMsg = (String) gameBean;
			}
		}

		return ERROR;
	}*/

	public void reprintTicket() {
		try {
<span class="fc" id="L1018">			logger.info(&quot;Data Received For Reprint :&quot; +json);</span>
<span class="fc" id="L1019">			printWriter = response.getWriter();</span>
<span class="fc" id="L1020">			getRequiredInformationForTicketReprint();</span>
<span class="fc" id="L1021">			drawGameRPOSHelper.insertEntryIntoPrintedTktTableForWeb(gameId, userInfoBean.getUserOrgId(), lastPrintedTicket, INTERFACE_TYPE_WEB, Util.getCurrentTimeStamp(), actionName);</span>
<span class="fc bfc" id="L1022" title="All 2 branches covered.">			isReprintFirstTime = (ticketNo == null) ? true : false;</span>
<span class="fc" id="L1023">			gameBean = drawGameRPOSHelper.reprintTicket(userInfoBean, false, ticketNo, isReprintFirstTime, null, INTERFACE_TYPE_WEB);</span>
<span class="fc bfc" id="L1024" title="All 2 branches covered.">			if(gameBean != null){</span>
<span class="fc" id="L1025">				gameBeanType = gameBean.getClass().getSimpleName();</span>
			}else{
<span class="fc" id="L1027">				gameBeanType = &quot;default&quot;;</span>
			}
<span class="fc" id="L1029">			webReprintContext = webReprintFactory.fetchReprintGameTypeInstance(gameBeanType);</span>
<span class="fc" id="L1030">			prepareWebReprintBean();</span>
<span class="fc" id="L1031">			jsonResponse = webReprintContext.reprintTicket(webReprint);</span>
<span class="fc" id="L1032">		} catch(LMSException e) {</span>
<span class="fc" id="L1033">			logger.error(EXCEPTION_OCCURRED, e);</span>
<span class="fc" id="L1034">			jsonResponse = prepareFailureResponse(e.getErrorCode(), e.getErrorMessage());</span>
<span class="fc" id="L1035">		} catch(Exception e) {</span>
<span class="fc" id="L1036">			logger.error(EXCEPTION_OCCURRED, e);</span>
<span class="fc" id="L1037">			jsonResponse = prepareFailureResponse(LMSErrors.GENERAL_EXCEPTION_ERROR_CODE,LMSErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="fc" id="L1038">		}</span>
<span class="fc" id="L1039">		logger.info(&quot;ReprintTicket Response Data - &quot; + jsonResponse);</span>
<span class="fc" id="L1040">		printWriter.print(jsonResponse);</span>
<span class="fc" id="L1041">		printWriter.flush();</span>
<span class="fc" id="L1042">		printWriter.close();</span>
<span class="fc" id="L1043">	}</span>

	private void getRequiredInformationForTicketReprint() throws LMSException, Exception {
<span class="fc" id="L1046">		jsonResponse = new JSONObject();</span>
<span class="fc bfc" id="L1047" title="All 2 branches covered.">		if (json != null){</span>
<span class="fc" id="L1048">			requestData = (JSONObject) JSONSerializer.toJSON(json);</span>
<span class="fc" id="L1049">			userName = (String) requestData.get(&quot;userName&quot;);</span>
		}
<span class="fc bfc" id="L1051" title="All 2 branches covered.">		if(userName == null){</span>
<span class="fc" id="L1052">			getUserInformationFromSessionIfUserNameIsNull();</span>
		} else{
<span class="fc" id="L1054">			getUserInformationFromSessionIfUserNameNotNull();</span>
		}
<span class="fc" id="L1056">		actionName = ActionContext.getContext().getName();</span>
<span class="fc" id="L1057">		lastTicketNumber =  CookieMgmtForTicketNumber.getTicketNumberFromCookie(servletRequest, userInfoBean.getUserName());</span>
<span class="fc bfc" id="L1058" title="All 2 branches covered.">		if(lastTicketNumber != 0) {</span>
<span class="fc" id="L1059">			lastPrintedTicket = lastTicketNumber/Util.getDivValueForLastSoldTkt(String.valueOf(lastTicketNumber).length());</span>
<span class="fc" id="L1060">			gameId = Util.getGameIdFromGameNumber(Util.getGamenoFromTktnumber(String.valueOf(lastTicketNumber)));</span>
		}
<span class="fc" id="L1062">	}</span>

	private void getUserInformationFromSessionIfUserNameIsNull() {
<span class="fc" id="L1065">		session = servletRequest.getSession();</span>
<span class="fc" id="L1066">		userInfoBean = (UserInfoBean) session.getAttribute(&quot;USER_INFO&quot;);</span>
<span class="fc" id="L1067">	}</span>
	
	private void getUserInformationFromSessionIfUserNameNotNull() throws LMSException {
<span class="fc" id="L1070">		userName = (String)requestData.get(&quot;userName&quot;);</span>
<span class="fc" id="L1071">		session = getSession(userName);</span>
<span class="fc" id="L1072">		userInfoBean = getUserBean(userName);</span>
<span class="fc" id="L1073">	}</span>

	private void prepareWebReprintBean() {
<span class="fc" id="L1076">		webReprint = new WebReprint();</span>
<span class="fc" id="L1077">		webReprint.setGameBean(gameBean);</span>
<span class="fc" id="L1078">		webReprint.setUserInfoBean(userInfoBean);</span>
<span class="fc" id="L1079">	}</span>
	
	private JSONObject prepareFailureResponse(int errorCode, String errorMessage){
<span class="fc" id="L1082">		JSONObject jsonResponse = new JSONObject();</span>
<span class="fc" id="L1083">		jsonResponse.put(&quot;isSuccess&quot;, false);</span>
<span class="fc" id="L1084">		jsonResponse.put(&quot;errorCode&quot;, errorCode);</span>
<span class="fc" id="L1085">		jsonResponse.put(&quot;errorMsg&quot;, errorMessage);</span>
<span class="fc" id="L1086">		return jsonResponse;</span>
	}
	
	public void setAutoCancel(boolean autoCancel) {
<span class="nc" id="L1090">		this.autoCancel = autoCancel;</span>
<span class="nc" id="L1091">	}</span>

	public void setDrawGameData(TreeMap drawGameData) {
<span class="nc" id="L1094">		this.drawGameData = drawGameData;</span>
<span class="nc" id="L1095">	}</span>

	public void setDrawGameNewData(Map&lt;String, Map&lt;Integer, DrawDetailsBean&gt;&gt; drawGameNewData) {
<span class="nc" id="L1098">		this.drawGameNewData = drawGameNewData;</span>
<span class="nc" id="L1099">	}</span>

	public void setEndRange(String endRange) {
<span class="nc" id="L1102">		this.endRange = endRange;</span>
<span class="nc" id="L1103">	}</span>

	public void setErrMsg(String errMsg) {
<span class="nc" id="L1106">		this.errMsg = errMsg;</span>
<span class="nc" id="L1107">	}</span>

	public void setFirstName(String firstName) {
<span class="nc" id="L1110">		this.firstName = firstName;</span>
<span class="nc" id="L1111">	}</span>

	public void setFortuneBean(FortunePurchaseBean fortuneBean) {
<span class="nc" id="L1114">		this.fortuneBean = fortuneBean;</span>
<span class="nc" id="L1115">	}</span>

	public void setFreezeTimeMap(TreeMap freezeTimeMap) {
<span class="nc" id="L1118">		this.freezeTimeMap = freezeTimeMap;</span>
<span class="nc" id="L1119">	}</span>

	public void setGameNo(int gameNo) {
<span class="nc" id="L1122">		this.gameNo = gameNo;</span>
<span class="nc" id="L1123">	}</span>

	public void setIdNumber(String idNumber) {
<span class="nc" id="L1126">		this.idNumber = idNumber;</span>
<span class="nc" id="L1127">	}</span>

	public void setIdType(String idType) {
<span class="nc" id="L1130">		this.idType = idType;</span>
<span class="nc" id="L1131">	}</span>

	public void setIsRG(String isRG) {
<span class="nc" id="L1134">		this.isRG = isRG;</span>
<span class="nc" id="L1135">	}</span>

	/**
	 * This method sets the applet jre version into session
	 * 
	 * @throws Exception
	 */
	public void setJreVersion() throws Exception {
<span class="nc" id="L1143">		session = servletRequest.getSession();</span>
<span class="nc" id="L1144">		session.setAttribute(&quot;jre_version&quot;, jreVersion);</span>
<span class="nc" id="L1145">	}</span>

	public void setJreVersion(String jreVersion) {
<span class="nc" id="L1148">		this.jreVersion = jreVersion;</span>
<span class="nc" id="L1149">	}</span>

	public void setKenoPurchaseBean(KenoPurchaseBean kenoPurchaseBean) {
<span class="nc" id="L1152">		this.kenoPurchaseBean = kenoPurchaseBean;</span>
<span class="nc" id="L1153">	}</span>

	public void setLastName(String lastName) {
<span class="nc" id="L1156">		this.lastName = lastName;</span>
<span class="nc" id="L1157">	}</span>

	public void setLottoPurchaseBean(LottoPurchaseBean lottoPurchaseBean) {
<span class="nc" id="L1160">		this.lottoPurchaseBean = lottoPurchaseBean;</span>
<span class="nc" id="L1161">	}</span>

	public void setPickNum(String pickNum) {
<span class="nc" id="L1164">		this.pickNum = pickNum;</span>
<span class="nc" id="L1165">	}</span>

	public void setServerTime(String serverTime) {
<span class="nc" id="L1168">		this.serverTime = serverTime;</span>
<span class="nc" id="L1169">	}</span>

	public void setServletRequest(HttpServletRequest servletRequest) {
<span class="fc" id="L1172">		this.servletRequest = servletRequest;</span>

<span class="fc" id="L1174">	}</span>

	public void setServletResponse(HttpServletResponse response) {
<span class="fc" id="L1177">		this.response = response;</span>

<span class="fc" id="L1179">	}</span>

	public void setStartRange(String startRange) {
<span class="nc" id="L1182">		this.startRange = startRange;</span>
<span class="nc" id="L1183">	}</span>

	public void setTicketNo(String ticketNo) {
<span class="fc" id="L1186">		this.ticketNo = ticketNo;</span>
<span class="fc" id="L1187">	}</span>

	public void setUnitPrice(Map unitPrice) {
<span class="nc" id="L1190">		this.unitPrice = unitPrice;</span>
<span class="nc" id="L1191">	}</span>

	public void setWinNum(String winNum) {
<span class="nc" id="L1194">		this.winNum = winNum;</span>
<span class="nc" id="L1195">	}</span>

	public KenoPurchaseBean getKenoTwoPurchaseBean() {
<span class="nc" id="L1198">		return kenoTwoPurchaseBean;</span>
	}

	public void setKenoTwoPurchaseBean(KenoPurchaseBean kenoTwoPurchaseBean) {
<span class="nc" id="L1202">		this.kenoTwoPurchaseBean = kenoTwoPurchaseBean;</span>
<span class="nc" id="L1203">	}</span>

	public KenoPurchaseBean getTwelveByTwentyFourPurchaseBean() {
<span class="nc" id="L1206">		return twelveByTwentyFourPurchaseBean;</span>
	}

	public void setTwelveByTwentyFourPurchaseBean(
			KenoPurchaseBean twelveByTwentyFourPurchaseBean) {
<span class="nc" id="L1211">		this.twelveByTwentyFourPurchaseBean = twelveByTwentyFourPurchaseBean;</span>
<span class="nc" id="L1212">	}</span>

	public void setPickNumStr(String pickNumStr) {
<span class="nc" id="L1215">		this.pickNumStr = pickNumStr;</span>
<span class="nc" id="L1216">	}</span>

	public String getPickNumStr() {
<span class="nc" id="L1219">		return pickNumStr;</span>
	}

	public String getPurchaseData() {
<span class="nc" id="L1223">		return purchaseData;</span>
	}

	public void setPurchaseData(String purchaseData) {
<span class="nc" id="L1227">		this.purchaseData = purchaseData;</span>
<span class="nc" id="L1228">	}</span>

	public String getCancelType() {
<span class="nc" id="L1231">		return cancelType;</span>
	}

	public void setCancelType(String cancelType) {
<span class="nc" id="L1235">		this.cancelType = cancelType;</span>
<span class="nc" id="L1236">	}</span>

	public long getLSTktNo() {
<span class="nc" id="L1239">		return LSTktNo;</span>
	}

	public void setLSTktNo(long lSTktNo) {
<span class="nc" id="L1243">		LSTktNo = lSTktNo;</span>
<span class="nc" id="L1244">	}</span>

	public String getUserName() {
<span class="nc" id="L1247">		return userName;</span>
	}

	public void setUserName(String userName) {
<span class="nc" id="L1251">		this.userName = userName;</span>
<span class="nc" id="L1252">	}</span>
	
	

	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>