<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GraphReportAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lms</a> &gt; <a href="index.source.html" class="el_package">com.skilrock.lms.web.reportsMgmt.common</a> &gt; <span class="el_source">GraphReportAction.java</span></div><h1>GraphReportAction.java</h1><pre class="source lang-java linenums">package com.skilrock.lms.web.reportsMgmt.common;

import java.io.File;
import java.io.IOException;
import java.io.OutputStream;
import java.io.PrintWriter;
import java.sql.Connection;
import java.sql.Timestamp;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.apache.struts2.ServletActionContext;
import org.apache.struts2.interceptor.ServletRequestAware;
import org.apache.struts2.interceptor.ServletResponseAware;

import com.opensymphony.xwork2.ActionSupport;
import com.skilrock.lms.beans.UserInfoBean;
import com.skilrock.lms.coreEngine.reportsMgmt.common.GraphReportHelper;

/**
 * This class is for Generating the Reports in Pdf format using Jasper Reports
 * 
 * @author Skilrock Technologies
 * 
 */
<span class="nc" id="L40">public class GraphReportAction extends ActionSupport implements</span>
		ServletRequestAware, ServletResponseAware {
	/**
	 * 
	 */
	private static final long serialVersionUID = 1L;
<span class="nc" id="L46">	Connection connection = null;</span>
<span class="nc" id="L47">	String file = null;</span>
	private String fromDate;
<span class="nc" id="L49">	private String gameStatus = null;</span>
<span class="nc" id="L50">	GraphReportHelper graphHelper = new GraphReportHelper();</span>
<span class="nc" id="L51">	Log logger = LogFactory.getLog(GraphReportAction.class);</span>
<span class="nc" id="L52">	byte[] path = null;</span>
<span class="nc" id="L53">	String query = null;</span>
<span class="nc" id="L54">	private String reportType = &quot;&quot;;</span>
	HttpServletRequest request;
	HttpServletResponse response;
	private List selectedGames;

	private List selectGames;
<span class="nc" id="L60">	private String selectMonth = null;</span>
<span class="nc" id="L61">	private String selectYear = null;</span>
<span class="nc" id="L62">	String singleGame = null;</span>
<span class="nc" id="L63">	private String status = null;</span>
	private String toDate;
	private String reportData;
	private String reportName;
	/**
	 * This method is for Generating the PDF Reports
	 * 
	 * @return String
	 * @throws Exception
	 */
	public String createReport() throws Exception {
<span class="nc" id="L74">		reportType = getReportType();</span>
<span class="nc" id="L75">		HttpSession session = getRequest().getSession();</span>
		// DateFormat dateFormat = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);
<span class="nc" id="L77">		String formatString = (String) session.getAttribute(&quot;date_format&quot;);</span>
<span class="nc" id="L78">		SimpleDateFormat dateFormat = new SimpleDateFormat(formatString);</span>
<span class="nc" id="L79">		Date sqlfmtFromDate = null;</span>
<span class="nc" id="L80">		Date sqlfmtToDate = null;</span>
<span class="nc" id="L81">		Timestamp fmtFromDate = null;</span>
<span class="nc" id="L82">		Timestamp fmtToDate = null;</span>
<span class="nc" id="L83">		Calendar calendar = Calendar.getInstance();</span>
<span class="nc" id="L84">		HashMap parameterMap = new HashMap();</span>
<span class="nc" id="L85">		UserInfoBean userBean = null;</span>
<span class="nc" id="L86">		String orgName = null;</span>
<span class="nc" id="L87">		userBean = (UserInfoBean) session.getAttribute(&quot;USER_INFO&quot;);</span>
<span class="nc" id="L88">		orgName = userBean.getOrgName();</span>
<span class="nc" id="L89">		logger.debug(&quot;orgName&quot; + orgName);</span>
<span class="nc" id="L90">		System.out.println(&quot;{{{{{{{{{{{{{{{{{{{{{  &quot; + orgName);</span>
<span class="nc" id="L91">		parameterMap.put(&quot;orgName&quot;, orgName);</span>
		// calendar.set(arg0, arg1, arg2);

		// System.out.println(&quot;hello&quot;);
<span class="nc" id="L95">		logger.debug(&quot;SelectGames &quot; + getSelectGames() + &quot;  Selected Games &quot;</span>
				+ getSelectedGames() + &quot;Report Type&quot; + getReportType()
				+ &quot;Single Game&quot; + getSingleGame());
<span class="nc" id="L98">		logger.debug(&quot;Selected Month &quot; + getSelectMonth() + &quot;From Date&quot;</span>
				+ getFromDate() + &quot;TO Date&quot; + getToDate() + &quot;Year &quot;
				+ getSelectYear());
		// System.out.println(&quot;SelectGames &quot;+getSelectGames()+&quot; Selected Games
		// &quot;+getSelectedGames()+&quot;Report Type&quot;+getReportType()+&quot;Single
		// Game&quot;+getSingleGame());
		// System.out.println(&quot;Selected Month &quot;+getSelectMonth()+&quot;From
		// Date&quot;+getFromDate()+&quot;TO Date&quot;+getToDate()+&quot;Year &quot;+getSelectYear());
<span class="nc bnc" id="L106" title="All 2 branches missed.">		if (getSelectedGames() != null) {</span>
<span class="nc" id="L107">			selectedGames = new ArrayList(getSelectedGames());</span>
<span class="nc" id="L108">			logger.debug(&quot;Size : &quot; + selectedGames.size());</span>
			// System.out.println(&quot;Size : &quot;+selectedGames.size());
		}
<span class="nc bnc" id="L111" title="All 2 branches missed.">		if (!getSelectMonth().equals(&quot;--Please Select--&quot;)) {</span>
			// System.out.println(&quot;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&quot;);
<span class="nc" id="L113">			String day = &quot;&quot;;</span>
			// try{
			/*
			 * if(getSelectMonth().equals(&quot;01&quot;)||getSelectMonth().equals(&quot;03&quot;)||getSelectMonth().equals(&quot;05&quot;)||getSelectMonth().equals(&quot;07&quot;)||getSelectMonth().equals(&quot;08&quot;)||getSelectMonth().equals(&quot;10&quot;)||getSelectMonth().equals(&quot;12&quot;)){
			 * day = &quot;31&quot;; } else
			 * if(getSelectMonth().equals(&quot;04&quot;)||getSelectMonth().equals(&quot;06&quot;)||getSelectMonth().equals(&quot;09&quot;)||getSelectMonth().equals(&quot;11&quot;)){
			 * day = &quot;30&quot;; } else if(getSelectMonth().equals(&quot;02&quot;)){ day = &quot;28&quot;; }
			 */

			// System.out.println(&quot;dateFormat &quot;+dateFormat.toPattern()+&quot;
			// pppppp&quot;);
<span class="nc" id="L124">			Calendar calendar2 = Calendar.getInstance();</span>

<span class="nc" id="L126">			calendar2.set(Integer.parseInt(getSelectYear()), Integer</span>
					.parseInt(getSelectMonth()) - 1, Integer.parseInt(&quot;1&quot;), 0,
					0, 0);
<span class="nc" id="L129">			sqlfmtFromDate = calendar2.getTime();</span>

<span class="nc" id="L131">			calendar2.add(Calendar.MONTH, 1);</span>
<span class="nc" id="L132">			sqlfmtToDate = calendar2.getTime();</span>
			/*
			 * int dayNo=calendar2.getActualMaximum(Calendar.DAY_OF_MONTH);
			 * 
			 * 
			 * 
			 * sqlfmtToDate =
			 * dateFormat.parse(&quot;1&quot;+&quot;-&quot;+getSelectMonth()+&quot;-&quot;+getSelectYear() );
			 * sqlfmtFromDate =
			 * dateFormat.parse(&quot;1&quot;+&quot;-&quot;+getSelectMonth()+&quot;-&quot;+getSelectYear() );
			 */
<span class="nc" id="L143">			fmtFromDate = new Timestamp(sqlfmtFromDate.getTime());</span>
<span class="nc" id="L144">			fmtToDate = new Timestamp(sqlfmtToDate.getTime());</span>
<span class="nc" id="L145">			logger.debug(sqlfmtToDate + &quot;    sqlfmtFromDate ??????????? &quot;</span>
					+ sqlfmtFromDate);
<span class="nc" id="L147">			logger.debug(fmtToDate + &quot;    fmtFromDate ??????????? &quot;</span>
					+ fmtFromDate);
<span class="nc" id="L149">			System.out.println(sqlfmtToDate + &quot;    sqlfmtFromDate ??????????? &quot;</span>
					+ sqlfmtFromDate);
<span class="nc" id="L151">			System.out.println(fmtToDate + &quot;    fmtFromDate ??????????? &quot;</span>
					+ fmtFromDate);
			/*
			 * } catch (ParseException e){ System.out.println(&quot;ParseException &quot; ); }
			 */

<span class="nc" id="L157">		} else {</span>
			try {

<span class="nc bnc" id="L160" title="All 2 branches missed.">				if (!getToDate().equals(&quot;&quot;)) {</span>
<span class="nc" id="L161">					sqlfmtToDate = dateFormat.parse(getToDate());</span>
<span class="nc" id="L162">					calendar.setTime(sqlfmtToDate);</span>
<span class="nc" id="L163">					calendar.add(Calendar.DAY_OF_MONTH, 1);</span>
<span class="nc" id="L164">					sqlfmtToDate = calendar.getTime();</span>
				} else {
					// Date date = new Date();
					// sqlfmtToDate= new java.sql.Date(date.getTime());
<span class="nc" id="L168">					Calendar calendar2 = Calendar.getInstance();</span>

<span class="nc" id="L170">					calendar.set(calendar2.get(Calendar.YEAR), calendar2</span>
							.get(Calendar.MONTH), calendar2.get(Calendar.DATE),
							0, 0, 0);
<span class="nc" id="L173">					calendar.add(Calendar.DAY_OF_MONTH, 1);</span>

<span class="nc" id="L175">					sqlfmtToDate = calendar.getTime();</span>
				}
<span class="nc" id="L177">				logger.debug(&quot;dateFormat  &quot; + dateFormat);</span>
<span class="nc" id="L178">				System.out.println(&quot;dateFormat  &quot; + dateFormat);</span>
<span class="nc" id="L179">				sqlfmtFromDate = dateFormat.parse(getFromDate());</span>

<span class="nc" id="L181">				logger.debug(sqlfmtToDate + &quot;    sqlfmtFromDate  &quot;</span>
						+ sqlfmtFromDate);
<span class="nc" id="L183">				System.out.println(sqlfmtToDate + &quot;    sqlfmtFromDate  &quot;</span>
						+ sqlfmtFromDate);
<span class="nc" id="L185">				fmtFromDate = new Timestamp(sqlfmtFromDate.getTime());</span>
<span class="nc" id="L186">				fmtToDate = new Timestamp(sqlfmtToDate.getTime());</span>
<span class="nc" id="L187">			} catch (ParseException e) {</span>
<span class="nc" id="L188">				System.out.println(&quot;hello3333&quot;);</span>
<span class="nc" id="L189">			}</span>

		}

<span class="nc" id="L193">		logger.debug(&quot;Changed From Date&quot; + fmtFromDate + &quot;Changed TO Date&quot;</span>
				+ fmtToDate);
<span class="nc" id="L195">		System.out.println(&quot;Changed From Date&quot; + fmtFromDate</span>
				+ &quot;Changed TO Date&quot; + fmtToDate);

<span class="nc" id="L198">		String root = ServletActionContext.getServletContext().getRealPath(&quot;/&quot;);</span>
<span class="nc" id="L199">		File directory = new File(&quot;&quot; + root + &quot;/REPORTS&quot;);</span>
<span class="nc" id="L200">		boolean exists = directory.exists();</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">		if (!exists) {</span>
<span class="nc" id="L202">			directory.mkdirs();</span>
		}

<span class="nc bnc" id="L205" title="All 2 branches missed.">		if (reportType.equalsIgnoreCase(&quot;Monthly Sale Gamewise&quot;)) {</span>
<span class="nc" id="L206">			System.out.println(&quot;hello4444444&quot;);</span>
<span class="nc" id="L207">			String queryToAppend = &quot;(&quot;;</span>
<span class="nc" id="L208">			int j = 1;</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">			for (int i = 0; i &lt; selectedGames.size() - 1; i++) {</span>
<span class="nc" id="L210">				queryToAppend = queryToAppend + &quot;b.game_id = '&quot;</span>
						+ selectedGames.get(i) + &quot;' or &quot;;
<span class="nc" id="L212">				j++;</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">				if (j == selectedGames.size()) {</span>
<span class="nc" id="L214">					break;</span>
				}
			}
<span class="nc" id="L217">			queryToAppend = queryToAppend + &quot; b.game_id = '&quot;</span>
					+ selectedGames.get(j - 1) + &quot;' )&quot;;

<span class="nc" id="L220">			query = &quot;select sgm1.game_nbr, netAmount,month from st_se_game_master sgm1,(select game_id ,ifnull((mrp_amt - mrp_amt2),mrp_amt) as netAmount,month from (select sale_table.game_id,mrp_amt,mrp_amt2,month from (select b.game_id,sum(b.mrp_amt) as mrp_amt,b.transaction_type, b.transaction_id as id2, month from st_se_bo_agent_transaction b, (select  transaction_id, monthname(transaction_date)as month  from st_lms_bo_transaction_master where transaction_type='sale' and transaction_date &gt; '&quot;</span>
					+ fmtFromDate
					+ &quot;'       and transaction_date &lt; '&quot;
					+ fmtToDate
					+ &quot;')        a where a.transaction_id=b.transaction_id and &quot;
					+ queryToAppend
					+ &quot; group by game_id) sale_table , (select mrp_amt2 , game_id from (select mrp_amt2, temp1.game_id,temp2.id2,temp2.transaction_type,temp2.month from ( select b.game_id,sum(b.mrp_amt) as mrp_amt1,b.transaction_type, b.transaction_id as id2, a.month from st_se_bo_agent_transaction b, (select  transaction_id, month(transaction_date)as month  from st_lms_bo_transaction_master where transaction_type='sale' and transaction_date &gt; '&quot;
					+ fmtFromDate
					+ &quot;' and transaction_date &lt; '&quot;
					+ fmtToDate
					+ &quot;' )a where a.transaction_id=b.transaction_id and &quot;
					+ queryToAppend
					+ &quot; group by game_id ) temp1 left join (select b.game_id,sum(b.mrp_amt) as mrp_amt2,b.transaction_type, b.transaction_id as id2, a.month from st_se_bo_agent_transaction b, (select  transaction_id, month(transaction_date)as month  from st_lms_bo_transaction_master where transaction_type='sale_ret' and transaction_date &gt; '&quot;
					+ fmtFromDate
					+ &quot;' and transaction_date &lt; '&quot;
					+ fmtToDate
					+ &quot;')a where a.transaction_id=b.transaction_id  and &quot;
					+ queryToAppend
					+ &quot; group by game_id ) temp2 on temp1.game_id=temp2.game_id) sale_return) tb2 where sale_table.game_id =  tb2.game_id) tb3) table4 where table4.game_id = sgm1.game_id order by game_nbr &quot;;
<span class="nc" id="L239">			logger.debug(query);</span>
<span class="nc" id="L240">			System.out.println(query);</span>
<span class="nc" id="L241">			file = root</span>
					+ &quot;com/skilrock/lms/web/reportsMgmt/compiledReports/NetSaleGameWiseBar.jasper&quot;;
<span class="nc" id="L243">			path = graphHelper.generateReport(query, file, parameterMap);</span>
			// session.setAttribute(&quot;GENERATED_REPORT_PATH&quot;, path) ;
<span class="nc bnc" id="L245" title="All 2 branches missed.">		} else if (reportType.equalsIgnoreCase(&quot;GameWise Sale&quot;)) {</span>
<span class="nc" id="L246">			String queryToAppend = &quot;(&quot;;</span>
<span class="nc" id="L247">			int j = 1;</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">			for (int i = 0; i &lt; selectedGames.size() - 1; i++) {</span>
<span class="nc" id="L249">				queryToAppend = queryToAppend + &quot;game_id = '&quot;</span>
						+ selectedGames.get(i) + &quot;' or &quot;;
<span class="nc" id="L251">				j++;</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">				if (j == selectedGames.size()) {</span>
<span class="nc" id="L253">					break;</span>
				}
			}
<span class="nc" id="L256">			queryToAppend = queryToAppend + &quot; game_id = '&quot;</span>
					+ selectedGames.get(j - 1) + &quot;' )&quot;;

<span class="nc" id="L259">			query = &quot;select game_nbr , netAmount,month from st_se_game_master , (select ifnull((mrp_amt1 - mrp_amt2),mrp_amt1) as netAmount , game_id,month from (select mrp_amt2, temp1.game_id,temp2.id2,temp2.transaction_type,temp1.month,temp1.mrp_amt1 from ( select b.game_id,sum(b.mrp_amt) as mrp_amt1,b.transaction_type, b.transaction_id as id2, a.month from st_se_bo_agent_transaction b, (select  transaction_id, MONTHNAME(transaction_date)as month  from st_lms_bo_transaction_master where transaction_type='sale' and transaction_date &gt; '&quot;</span>
					+ fmtFromDate
					+ &quot;' and transaction_date &lt; '&quot;
					+ fmtToDate
					+ &quot;' )a where a.transaction_id=b.transaction_id  and &quot;
					+ queryToAppend
					+ &quot; group by game_id ) temp1 left join (select b.game_id,sum(b.mrp_amt) as mrp_amt2,b.transaction_type, b.transaction_id as id2, a.month from st_se_bo_agent_transaction b, (select  transaction_id, MONTHNAME(transaction_date)as month  from st_lms_bo_transaction_master where transaction_type='sale_ret' and transaction_date &gt; '&quot;
					+ fmtFromDate
					+ &quot;' and transaction_date &lt; '&quot;
					+ fmtToDate
					+ &quot;' )a where a.transaction_id=b.transaction_id and &quot;
					+ queryToAppend
					+ &quot; group by game_id ) temp2 on temp1.game_id=temp2.game_id) sale_return) sale_net where st_se_game_master.game_id = sale_net.game_id order by game_nbr &quot;;
<span class="nc" id="L272">			logger.debug(query);</span>
<span class="nc" id="L273">			System.out.println(query);</span>
<span class="nc" id="L274">			file = root</span>
					+ &quot;com/skilrock/lms/web/reportsMgmt/compiledReports/MonthlySaleGameWiseLine.jasper&quot;;
<span class="nc" id="L276">			path = graphHelper.generateReport(query, file, parameterMap);</span>
			// session.setAttribute(&quot;GENERATED_REPORT_PATH&quot;, path) ;

<span class="nc bnc" id="L279" title="All 2 branches missed.">		} else if (reportType</span>
				.equalsIgnoreCase(&quot;Sale of Game Monthly PriceWise&quot;)) {
<span class="nc" id="L281">			query = &quot;select ticket_price , MONTHNAME(transaction_date)as month, SUM(netAmount) Amount from st_se_game_master sgm , (select sale.game_id,sale.transaction_date,ifnull((saleAmt - saleretAmt),saleAmt) as netAmount from (select game_id,transaction_date,SUM(mrp_amt) as saleAmt from (select game_id , transaction_date, transaction_type,mrp_amt from st_se_bo_agent_transaction sbat, (select transaction_id , transaction_date from st_lms_bo_transaction_master where (transaction_type='SALE' or transaction_type='SALE_RET') and transaction_date &gt; '&quot;</span>
					+ fmtFromDate
					+ &quot;' and transaction_date &lt; '&quot;
					+ fmtToDate
					+ &quot;') trans_id_tab where sbat.transaction_id=trans_id_tab.transaction_id) trans_both where transaction_type = 'sale' group by game_id) sale left join (select game_id,transaction_date,SUM(mrp_amt) as saleretAmt from (select game_id , transaction_date, transaction_type,mrp_amt from st_se_bo_agent_transaction sbat, (select transaction_id , transaction_date from st_lms_bo_transaction_master where (transaction_type='SALE' or transaction_type='SALE_RET') and transaction_date &gt; '&quot;
					+ fmtFromDate
					+ &quot;' and transaction_date &lt; '&quot;
					+ fmtToDate
					+ &quot;') trans_id_tab where sbat.transaction_id=trans_id_tab.transaction_id) trans_both where transaction_type = 'sale_ret' group by game_id) sale_ret on sale_ret.game_id = sale.game_id) netSale where sgm.game_id = netSale.game_id group by ticket_price order by ticket_price &quot;;
<span class="nc" id="L290">			System.out.println(query);</span>
<span class="nc" id="L291">			logger.debug(query);</span>
<span class="nc" id="L292">			file = root</span>
					+ &quot;com/skilrock/lms/web/reportsMgmt/compiledReports/MonthlySalePricewisePie.jasper&quot;;
<span class="nc" id="L294">			path = graphHelper.generateReport(query, file, parameterMap);</span>
			// session.setAttribute(&quot;GENERATED_REPORT_PATH&quot;, path) ;
<span class="nc bnc" id="L296" title="All 2 branches missed.">		} else if (reportType.equalsIgnoreCase(&quot;Game Pwt Status&quot;)) {</span>
<span class="nc" id="L297">			query = &quot;select game_nbr as game_id,pwt_amt,status from st_se_game_master sgm , (select game_id,sum(pwt_amt) as pwt_amt,status from st_pwt_inv  where game_id= '&quot;</span>
					+ getSingleGame()
					+ &quot;' group by status ) result where sgm.game_id = result.game_id order by status&quot;;
<span class="nc" id="L300">			System.out.println(query);</span>
<span class="nc" id="L301">			logger.debug(query);</span>
<span class="nc" id="L302">			file = root</span>
					+ &quot;com/skilrock/lms/web/reportsMgmt/compiledReports/GamePWTStatusPie.jasper&quot;;
<span class="nc" id="L304">			path = graphHelper.generateReport(query, file, parameterMap);</span>
			// session.setAttribute(&quot;GENERATED_REPORT_PATH&quot;, path) ;
<span class="nc bnc" id="L306" title="All 2 branches missed.">		} else if (reportType.equalsIgnoreCase(&quot;PWT Status Gamewise&quot;)) {</span>

<span class="nc" id="L308">			String queryToAppend = &quot;(&quot;;</span>
<span class="nc" id="L309">			int j = 1;</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">			for (int i = 0; i &lt; selectedGames.size() - 1; i++) {</span>
<span class="nc" id="L311">				queryToAppend = queryToAppend + &quot;game_id = '&quot;</span>
						+ selectedGames.get(i) + &quot;' or &quot;;
<span class="nc" id="L313">				j++;</span>
<span class="nc bnc" id="L314" title="All 2 branches missed.">				if (j == selectedGames.size()) {</span>
<span class="nc" id="L315">					break;</span>
				}
			}
<span class="nc" id="L318">			queryToAppend = queryToAppend + &quot; game_id = '&quot;</span>
					+ selectedGames.get(j - 1) + &quot;' )&quot;;

<span class="nc" id="L321">			query = &quot;select game_nbr as game_id , pwt_amt,status from st_se_game_master sgm , (select game_id,sum(pwt_amt) as pwt_amt,status from st_pwt_inv where &quot;</span>
					+ queryToAppend
					+ &quot; group by game_id,status) result where sgm.game_id = result.game_id order by game_id,status&quot;;
<span class="nc" id="L324">			System.out.println(query);</span>
<span class="nc" id="L325">			logger.debug(query);</span>
<span class="nc" id="L326">			file = root</span>
					+ &quot;com/skilrock/lms/web/reportsMgmt/compiledReports/PWTStatusGameWiseBar.jasper&quot;;
<span class="nc" id="L328">			path = graphHelper.generateReport(query, file, parameterMap);</span>
			// session.setAttribute(&quot;GENERATED_REPORT_PATH&quot;, path) ;
<span class="nc" id="L330">		}</span>

<span class="nc bnc" id="L332" title="All 2 branches missed.">		else if (reportType.equalsIgnoreCase(&quot;Inventory Status&quot;)) {</span>
<span class="nc" id="L333">			String queryToAppend = &quot;and (&quot;;</span>
<span class="nc" id="L334">			int j = 1;</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">			for (int i = 0; i &lt; selectedGames.size() - 1; i++) {</span>
<span class="nc" id="L336">				queryToAppend = queryToAppend + &quot;game_id = '&quot;</span>
						+ selectedGames.get(i) + &quot;' or &quot;;
<span class="nc" id="L338">				j++;</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">				if (j == selectedGames.size()) {</span>
<span class="nc" id="L340">					break;</span>
				}
			}
<span class="nc" id="L343">			queryToAppend = queryToAppend + &quot; game_id = '&quot;</span>
					+ selectedGames.get(j - 1) + &quot;' )&quot;;
<span class="nc" id="L345">			query = &quot;select total_tick, current_owner , game_nbr from ( select (COUNT(book_nbr)*nbr_of_tickets_per_book) as total_tick, game_id , current_owner,nbr_of_tickets_per_book,game_nbr from( select game_master.game_nbr , sgis.game_id, book_nbr , current_owner,nbr_of_tickets_per_book from st_se_game_inv_status sgis , (select game_nbr, game_id , nbr_of_tickets_per_book from st_se_game_master where game_status='OPEN' &quot;</span>
					+ queryToAppend
					+ &quot; ) game_master where  sgis.game_id = game_master.game_id) agent where current_owner='BO' group by game_id union select * from ( select (COUNT(book_nbr)*nbr_of_tickets_per_book) as total_tick, game_id , current_owner,nbr_of_tickets_per_book,game_nbr from( select game_master.game_nbr , sgis.game_id, book_nbr , current_owner,nbr_of_tickets_per_book from st_se_game_inv_status sgis , (select game_nbr, game_id , nbr_of_tickets_per_book from st_se_game_master where game_status='OPEN' &quot;
					+ queryToAppend
					+ &quot; ) game_master where  sgis.game_id = game_master.game_id) agent where current_owner='AGENT' group by game_id ) agent1 union select (COUNT(book_nbr)*nbr_of_tickets_per_book) as total_tick, game_id , current_owner,nbr_of_tickets_per_book,game_nbr from( select game_master.game_nbr , sgis.game_id, book_nbr , current_owner,nbr_of_tickets_per_book from st_se_game_inv_status sgis , (select game_nbr, game_id , nbr_of_tickets_per_book from st_se_game_master where game_status='OPEN' &quot;
					+ queryToAppend
					+ &quot; ) game_master where  sgis.game_id = game_master.game_id) agent where current_owner='RETAILER' group by game_id) inventory order by game_nbr,current_owner&quot;;
<span class="nc" id="L352">			System.out.println(query);</span>
<span class="nc" id="L353">			logger.debug(query);</span>
<span class="nc" id="L354">			file = root</span>
					+ &quot;com/skilrock/lms/web/reportsMgmt/compiledReports/InventoryStatusGameWiseBar.jasper&quot;;
<span class="nc" id="L356">			path = graphHelper.generateReport(query, file, parameterMap);</span>
			// session.setAttribute(&quot;GENERATED_REPORT_PATH&quot;, path) ;
<span class="nc" id="L358">		}</span>

<span class="nc bnc" id="L360" title="All 2 branches missed.">		else if (reportType.equalsIgnoreCase(&quot;Yearly Sale Pricewise&quot;)) {</span>
<span class="nc" id="L361">			query = &quot;select ticket_price , MONTHNAME(transaction_date) as month, SUM(netAmount) Amount from st_se_game_master sgm , (select sale.game_id,sale.transaction_date,ifnull((saleAmt - saleretAmt),saleAmt) as netAmount from (select game_id,transaction_date,SUM(mrp_amt) as saleAmt from (select game_id , transaction_date, transaction_type,mrp_amt from st_se_bo_agent_transaction sbat, (select transaction_id , transaction_date from st_lms_bo_transaction_master where (transaction_type='SALE' or transaction_type='SALE_RET') and transaction_date &gt; '&quot;</span>
					+ fmtFromDate
					+ &quot;' and transaction_date &lt; '&quot;
					+ fmtToDate
					+ &quot;') trans_id_tab where sbat.transaction_id=trans_id_tab.transaction_id) trans_both where transaction_type = 'sale' group by game_id) sale left join (select game_id,transaction_date,SUM(mrp_amt) as saleretAmt from (select game_id , transaction_date, transaction_type,mrp_amt from st_se_bo_agent_transaction sbat, (select transaction_id , transaction_date from st_lms_bo_transaction_master where (transaction_type='SALE' or transaction_type='SALE_RET') and transaction_date &gt; '&quot;
					+ fmtFromDate
					+ &quot;' and transaction_date &lt; '&quot;
					+ fmtToDate
					+ &quot;') trans_id_tab where sbat.transaction_id=trans_id_tab.transaction_id) trans_both where transaction_type = 'sale_ret' group by game_id) sale_ret on sale_ret.game_id = sale.game_id) netSale where sgm.game_id = netSale.game_id group by ticket_price order by month  DESC &quot;;
<span class="nc" id="L370">			System.out.println(query);</span>
<span class="nc" id="L371">			logger.debug(query);</span>
<span class="nc" id="L372">			file = root</span>
					+ &quot;com/skilrock/lms/web/reportsMgmt/compiledReports/MonthlySalebyPriceLine22.jasper&quot;;
<span class="nc" id="L374">			path = graphHelper.generateReport(query, file, parameterMap);</span>
			// session.setAttribute(&quot;GENERATED_REPORT_PATH&quot;, path) ;
		}

		// session.setAttribute(&quot;GENERATED_BYTES&quot;, path) ;
		// if(path.length&gt;800){
		// getResponsePDF(path);
		// }
<span class="nc" id="L382">		return getResponsePDF(path);</span>
	}

	public String displayReport() {
<span class="nc" id="L386">		logger.info(&quot;inside displayReport&quot;);</span>
<span class="nc" id="L387">		HttpSession session = getRequest().getSession();</span>
<span class="nc" id="L388">		session.setAttribute(&quot;graphDate&quot;, new java.sql.Date(new Date()</span>
				.getTime()).toString());
<span class="nc" id="L390">		Map m = new LinkedHashMap();</span>
<span class="nc" id="L391">		m.putAll(graphHelper.getDefaultSelectGames(&quot;--Please Select--&quot;));</span>
		// System.out.println(m);
<span class="nc" id="L393">		logger.debug(&quot;Map: &quot; + m);</span>
<span class="nc" id="L394">		session.setAttribute(&quot;defaultGames&quot;, m);</span>

<span class="nc" id="L396">		return SUCCESS;</span>
	}

	/**
	 * This method send the currently present Games for the User Interface
	 * 
	 * @return Map of Games
	 */
	public void getDefaultGames() throws Exception {
<span class="nc" id="L405">		logger.info(&quot;Inside getDefaultGames&quot;);</span>
<span class="nc" id="L406">		HttpSession session = getRequest().getSession();</span>
<span class="nc" id="L407">		Map m = new LinkedHashMap();</span>
<span class="nc" id="L408">		m.putAll(graphHelper.getDefaultSelectGames(getGameStatus()));</span>
		// System.out.println(m);
<span class="nc" id="L410">		logger.debug(&quot;Map:  &quot; + m);</span>
<span class="nc" id="L411">		session.setAttribute(&quot;defaultGames&quot;, m);</span>

<span class="nc" id="L413">		PrintWriter out = getResponse().getWriter();</span>
<span class="nc" id="L414">		String html = &quot;&quot;;</span>
<span class="nc" id="L415">		html = &quot;&lt;select name=\&quot;selectOptionManual\&quot;&gt;&lt;OPTION VALUE='---Please Select---'&gt;---Please Select---&lt;OPTION VALUE=''&gt; &quot;;</span>

<span class="nc" id="L417">		int i = 0;</span>
<span class="nc bnc" id="L418" title="All 2 branches missed.">		for (Iterator it = m.keySet().iterator(); it.hasNext();) {</span>
<span class="nc" id="L419">			int key = (Integer) it.next();</span>
<span class="nc" id="L420">			int val = (Integer) m.get(key);</span>
<span class="nc" id="L421">			i++;</span>
<span class="nc" id="L422">			html += &quot;&lt;option value=\&quot;&quot; + key + &quot;\&quot;&gt;&quot; + val + &quot;&lt;/option&gt;&quot;;</span>
<span class="nc" id="L423">			logger.debug(&quot;key &quot; + key + &quot;  value &quot; + val);</span>
			// System.out.println(&quot;key &quot;+key +&quot; value &quot;+val);
<span class="nc" id="L425">		}</span>
<span class="nc" id="L426">		html += &quot;&lt;/select&gt;&quot;;</span>
		// System.out.println(html);
<span class="nc" id="L428">		logger.debug(html);</span>
<span class="nc" id="L429">		response.setContentType(&quot;text/html&quot;);</span>

<span class="nc" id="L431">		out.print(html);</span>
<span class="nc" id="L432">	}</span>

	public void getDefaultGames2() throws Exception {
<span class="nc" id="L435">		HttpSession session = getRequest().getSession();</span>
<span class="nc" id="L436">		Map m = new LinkedHashMap();</span>
<span class="nc" id="L437">		m.putAll(graphHelper.getDefaultSelectGames(getGameStatus()));</span>
		// System.out.println(m);
<span class="nc" id="L439">		logger.debug(&quot;Map:  &quot; + m);</span>
<span class="nc" id="L440">		session.setAttribute(&quot;defaultGames&quot;, m);</span>

<span class="nc" id="L442">	}</span>

	public String getFile() {
<span class="nc" id="L445">		return file;</span>
	}

	public String getFromDate() {
<span class="nc" id="L449">		return fromDate;</span>
	}

	public String getGameStatus() {
<span class="nc bnc" id="L453" title="All 2 branches missed.">		if (gameStatus.equals(&quot;Open&quot;)) {</span>

<span class="nc" id="L455">			gameStatus = &quot;OPEN&quot;;</span>
<span class="nc bnc" id="L456" title="All 2 branches missed.">		} else if (gameStatus.equals(&quot;Close&quot;)) {</span>

<span class="nc" id="L458">			gameStatus = &quot;CLOSE&quot;;</span>
<span class="nc bnc" id="L459" title="All 2 branches missed.">		} else if (gameStatus.equals(&quot;Sale Hold&quot;)) {</span>

<span class="nc" id="L461">			gameStatus = &quot;SALE_HOLD&quot;;</span>
<span class="nc bnc" id="L462" title="All 2 branches missed.">		} else if (gameStatus.equals(&quot;Sale Closed&quot;)) {</span>

<span class="nc" id="L464">			gameStatus = &quot;SALE_CLOSE&quot;;</span>
<span class="nc bnc" id="L465" title="All 2 branches missed.">		} else if (gameStatus.equals(&quot;Terminated&quot;)) {</span>

<span class="nc" id="L467">			gameStatus = &quot;TERMINATE&quot;;</span>
		}

<span class="nc" id="L470">		return gameStatus;</span>
	}

	/**
	 * This method is for Generating the PDF Reports
	 * 
	 * @return String
	 * @throws Exception
	 */
	public String getPDF() throws Exception {
<span class="nc" id="L480">		logger.debug(&quot;In PDF Generation in Graph Action   getPDF&quot;);</span>
		// System.out.println(&quot;In PDF Generation in Graph Action getPDF&quot;);
<span class="nc" id="L482">		HttpSession session = getRequest().getSession();</span>
		try {

<span class="nc" id="L485">			response.setContentType(&quot;application/pdf&quot;);</span>
<span class="nc" id="L486">			OutputStream OutStrm = response.getOutputStream();</span>
<span class="nc" id="L487">			OutStrm.write((byte[]) session.getAttribute(&quot;GENERATED_BYTES&quot;));</span>
<span class="nc" id="L488">			OutStrm.flush();</span>
<span class="nc" id="L489">			return null;</span>
			// OutStrm.close();
<span class="nc" id="L491">		} catch (Exception e) {</span>
<span class="nc" id="L492">			logger</span>
					.error(&quot;Error in Output Stream in Graph Report Action getPDF() Method&quot;);
			// System.out.println(&quot;Error in Output Stream in Graph Report Action
			// getPDF() Method&quot;);
			// e.printStackTrace();
		}
		/*
		 * PrintWriter out = getResponse().getWriter();
		 * response.setContentType(&quot;application/pdf&quot;); out.print(data);
		 * out.flush();
		 */
<span class="nc" id="L503">		return SUCCESS;</span>
	}

	public void getPDFReport(byte[] dataSession) {
<span class="nc" id="L507">		logger.info(&quot;inside getPDFReport   &quot; + dataSession.length);</span>
		// System.out.println(&quot;inside getPDFReport &quot;+dataSession.length);
<span class="nc" id="L509">		HttpServletRequest sc = ServletActionContext.getRequest();</span>

<span class="nc" id="L511">		HttpSession session = sc.getSession();</span>
		// System.out.println(&quot;I am in Action66666666666666666666666666666&quot;);
<span class="nc" id="L513">		session.setAttribute(&quot;GENERATED_BYTES&quot;, dataSession);</span>
<span class="nc" id="L514">	}</span>

	public String getQuery() {
<span class="nc" id="L517">		return query;</span>
	}

	public String getReportType() {
<span class="nc" id="L521">		return reportType;</span>
	}

	public HttpServletRequest getRequest() {
<span class="nc" id="L525">		return request;</span>
	}

	public HttpServletResponse getResponse() {
<span class="nc" id="L529">		return response;</span>
	}

	/**
	 * This method is for Generating the PDF Reports
	 * 
	 * @param data
	 *            Byte Array generated by Jasper Compiler
	 * @return String
	 * @throws Exception
	 */
	public String getResponsePDF(byte[] data) {
<span class="nc" id="L541">		logger</span>
				.debug(&quot;In PDF Generation in Graph Action    getResponsePDF graph action&quot;);
		// System.out.println(&quot;In PDF Generation in Graph Action getResponsePDF
		// graph action&quot;);
		try {

<span class="nc bnc" id="L547" title="All 2 branches missed.">			if (data.length &gt; 800) {</span>
<span class="nc" id="L548">				response.setContentType(&quot;application/pdf&quot;);</span>
<span class="nc" id="L549">				OutputStream OutStrm = response.getOutputStream();</span>
<span class="nc" id="L550">				OutStrm.write(data);</span>
<span class="nc" id="L551">				OutStrm.flush();</span>
<span class="nc" id="L552">				return null;</span>
			}
			// OutStrm.close();
<span class="nc" id="L555">		} catch (java.lang.IllegalStateException e) {</span>
<span class="nc" id="L556">			logger</span>
					.error(&quot;Error in Output1 Stream in Graph Report Action getResponsePDF Method&quot;);
			// System.out.println(&quot;Error in Output1 Stream in Graph Report
			// Action getResponsePDF Method&quot;);
			// e.printStackTrace();
<span class="nc" id="L561">		} catch (IOException e2) {</span>
<span class="nc" id="L562">			logger</span>
					.error(&quot;Error in Output2 Stream in Graph Report Action getResponsePDF Method&quot;);
			// System.out.println(&quot;Error in Output2 Stream in Graph Report
			// Action getResponsePDF Method&quot;);
<span class="nc" id="L566">			e2.printStackTrace();</span>
<span class="nc" id="L567">		}</span>

		/*
		 * PrintWriter out = getResponse().getWriter();
		 * response.setContentType(&quot;application/pdf&quot;); out.print(data);
		 * out.flush();
		 */
		/*
		 * if(data.length&gt;0){ return null; }
		 */
<span class="nc" id="L577">		return SUCCESS;</span>
	}

	public List getSelectedGames() {
<span class="nc" id="L581">		return selectedGames;</span>
	}

	public List getSelectGames() {
<span class="nc" id="L585">		return selectGames;</span>
	}

	public String getSelectMonth() {
<span class="nc" id="L589">		return selectMonth;</span>
	}

	public String getSelectYear() {
<span class="nc" id="L593">		return selectYear;</span>
	}

	public String getSingleGame() {
<span class="nc" id="L597">		return singleGame;</span>
	}

	public String getStatus() {
<span class="nc" id="L601">		return status;</span>
	}

	public String getToDate() {
<span class="nc" id="L605">		return toDate;</span>
	}

	/**
	 * This method send the List of year for selecting on Graph Report Page.
	 * 
	 * @return Map
	 */
	public Map getYear() {

<span class="nc" id="L615">		String depDate = (String) ServletActionContext.getServletContext()</span>
				.getAttribute(&quot;DEPLOYMENT_DATE&quot;);
<span class="nc" id="L617">		final int GRAPH_STARTING_YEAR = Integer.parseInt(depDate</span>
				.substring(0, 4));

<span class="nc" id="L620">		Calendar rightNow = Calendar.getInstance();</span>
<span class="nc" id="L621">		int YR = rightNow.get(Calendar.YEAR);</span>
<span class="nc" id="L622">		logger.debug(&quot;Date in Map&quot; + YR + &quot;Star  &quot; + GRAPH_STARTING_YEAR);</span>
		// System.out.println(&quot;Date in Map&quot;+YR+&quot;Star &quot;+GRAPH_STARTING_YEAR);
<span class="nc" id="L624">		Map m = new LinkedHashMap();</span>
<span class="nc bnc" id="L625" title="All 2 branches missed.">		for (int k = GRAPH_STARTING_YEAR; k &lt;= YR; k++) {</span>
<span class="nc" id="L626">			m.put(new Integer(k), new Integer(k));</span>
		}
<span class="nc" id="L628">		logger.debug(&quot;Map: &quot; + m);</span>
		// System.out.println(m);
<span class="nc" id="L630">		return m;</span>
	}

	private String startDate;
	private String endDate;

	public String getStartDate() {
<span class="nc" id="L637">		return startDate;</span>
	}

	public void setStartDate(String startDate) {
<span class="nc" id="L641">		this.startDate = startDate;</span>
<span class="nc" id="L642">	}</span>

	public String getEndDate() {
<span class="nc" id="L645">		return endDate;</span>
	}

	public void setEndDate(String endDate) {
<span class="nc" id="L649">		this.endDate = endDate;</span>
<span class="nc" id="L650">	}</span>

	public void exportAsExcel() throws IOException {
<span class="nc" id="L653">		response.setContentType(&quot;application/vnd.ms-excel&quot;);</span>
<span class="nc" id="L654">		response.setHeader(&quot;Content-Disposition&quot;,</span>
				&quot;attachment; filename=&quot;+reportName+&quot;.xls&quot;);
<span class="nc" id="L656">		PrintWriter out = response.getWriter();</span>
<span class="nc bnc" id="L657" title="All 2 branches missed.">		if (reportData != null) {</span>
<span class="nc" id="L658">			reportData = reportData.replaceAll(&quot;&lt;tbody&gt;&quot;, &quot;&quot;).replaceAll(</span>
					&quot;&lt;/tbody&gt;&quot;, &quot;&quot;).trim();
			//out.write(&quot;&lt;table border='1' width='100%' &gt;&quot; + reportData
					//+ &quot;&lt;/table&gt;&quot;);
<span class="nc bnc" id="L662" title="All 4 branches missed.">			String appender = (startDate == null || endDate == null) ? &quot;&quot; : &quot;&lt;table border='1' width='100%' &gt;&lt;tr&gt;&lt;td&gt;Start Date&lt;/td&gt;&lt;td&gt;&quot;+startDate+&quot;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;End Date&lt;/td&gt;&lt;td&gt;&quot;+endDate+&quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;;</span>
<span class="nc" id="L663">			out.write(appender + reportData);</span>
		}
<span class="nc" id="L665">	}</span>

	public void exportAsExcelWithoutTable() throws IOException {
<span class="nc" id="L668">		response.setContentType(&quot;application/vnd.ms-excel&quot;);</span>
<span class="nc" id="L669">		response.setHeader(&quot;Content-Disposition&quot;,</span>
				&quot;attachment; filename=&quot;+reportName+&quot;.xls&quot;);
<span class="nc" id="L671">		PrintWriter out = response.getWriter();</span>
<span class="nc bnc" id="L672" title="All 2 branches missed.">		if (reportData != null) {</span>
<span class="nc" id="L673">			reportData = reportData.replaceAll(&quot;&lt;tbody&gt;&quot;, &quot;&quot;).replaceAll(</span>
					&quot;&lt;/tbody&gt;&quot;, &quot;&quot;).trim();
<span class="nc" id="L675">			out.write(reportData);</span>
		}
<span class="nc" id="L677">		out.flush();</span>
<span class="nc" id="L678">		out.close();</span>
<span class="nc" id="L679">	}</span>

	public void setFile(String file) {
<span class="nc" id="L682">		this.file = file;</span>
<span class="nc" id="L683">	}</span>

	public void setFromDate(String fromDate) {
<span class="nc" id="L686">		this.fromDate = fromDate;</span>
<span class="nc" id="L687">	}</span>

	public void setGameStatus(String gameStatus) {
<span class="nc" id="L690">		this.gameStatus = gameStatus;</span>
<span class="nc" id="L691">	}</span>

	public void setQuery(String query) {
<span class="nc" id="L694">		this.query = query;</span>
<span class="nc" id="L695">	}</span>

	public void setReportType(String reportType) {
<span class="nc" id="L698">		this.reportType = reportType;</span>
<span class="nc" id="L699">	}</span>

	public void setSelectedGames(List selectedGames) {
<span class="nc" id="L702">		this.selectedGames = selectedGames;</span>
<span class="nc" id="L703">	}</span>

	public void setSelectGames(List selectGames) {
<span class="nc" id="L706">		this.selectGames = selectGames;</span>
<span class="nc" id="L707">	}</span>

	public void setSelectMonth(String selectMonth) {
<span class="nc" id="L710">		this.selectMonth = selectMonth;</span>
<span class="nc" id="L711">	}</span>

	public void setSelectYear(String selectYear) {
<span class="nc" id="L714">		this.selectYear = selectYear;</span>
<span class="nc" id="L715">	}</span>

	public void setServletRequest(HttpServletRequest request) {
<span class="nc" id="L718">		this.request = request;</span>

<span class="nc" id="L720">	}</span>

	public void setServletResponse(HttpServletResponse response) {
<span class="nc" id="L723">		this.response = response;</span>

<span class="nc" id="L725">	}</span>

	public void setSingleGame(String singleGame) {
<span class="nc" id="L728">		this.singleGame = singleGame;</span>
<span class="nc" id="L729">	}</span>

	public void setStatus(String status) {
<span class="nc" id="L732">		this.status = status;</span>
<span class="nc" id="L733">	}</span>

	public void setToDate(String toDate) {
<span class="nc" id="L736">		this.toDate = toDate;</span>
<span class="nc" id="L737">	}</span>

	public String getReportData() {
<span class="nc" id="L740">		return reportData;</span>
	}

	public void setReportData(String reportData) {
<span class="nc" id="L744">		this.reportData = reportData;</span>
<span class="nc" id="L745">	}</span>

	public String getReportName() {
<span class="nc" id="L748">		return reportName;</span>
	}

	public void setReportName(String reportName) {
<span class="nc" id="L752">		this.reportName = reportName;</span>
<span class="nc" id="L753">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>