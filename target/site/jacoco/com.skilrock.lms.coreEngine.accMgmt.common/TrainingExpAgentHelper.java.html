<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TrainingExpAgentHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lms</a> &gt; <a href="index.source.html" class="el_package">com.skilrock.lms.coreEngine.accMgmt.common</a> &gt; <span class="el_source">TrainingExpAgentHelper.java</span></div><h1>TrainingExpAgentHelper.java</h1><pre class="source lang-java linenums">package com.skilrock.lms.coreEngine.accMgmt.common;

import java.net.URLEncoder;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.sql.Timestamp;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.TimeZone;

import javax.servlet.ServletContext;
import javax.servlet.http.HttpServletRequest;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.apache.struts2.ServletActionContext;

import com.ManualRequest;
import com.google.gson.Gson;
import com.google.gson.reflect.TypeToken;
import com.skilrock.lms.beans.IWIncentiveDataBean;
import com.skilrock.lms.beans.IWTrainingExpBean;
import com.skilrock.lms.beans.IWTrainingExpDataBean;
import com.skilrock.lms.beans.SalePwtReportsBean;
import com.skilrock.lms.beans.ServiceRequest;
import com.skilrock.lms.beans.TrainingExpenseBean;
import com.skilrock.lms.beans.UserInfoBean;
import com.skilrock.lms.common.Utility;
import com.skilrock.lms.common.db.DBConnect;
import com.skilrock.lms.common.db.QueryManager;
import com.skilrock.lms.common.db.TableConstants;
import com.skilrock.lms.common.exception.LMSErrors;
import com.skilrock.lms.common.exception.LMSException;
import com.skilrock.lms.common.filter.LMSFilterDispatcher;
import com.skilrock.lms.common.utility.GenerateRecieptNo;
import com.skilrock.lms.common.utility.OrgCreditUpdation;
import com.skilrock.lms.coreEngine.service.ServiceDelegateIW;
import com.skilrock.lms.web.drawGames.common.Util;

<span class="nc" id="L51">public class TrainingExpAgentHelper {</span>

<span class="nc" id="L53">	static Log logger = LogFactory.getLog(TrainingExpAgentHelper.class);</span>

	public static void main(String[] args) throws LMSException, SQLException {
		//Connection con=DBConnect.getConnection();
		//new TrainingExpAgentHelper().drawSaleAgentWiseTimeWiseNew(new Timestamp(2013, 11, 25, 14, 00, 00, 00),new Timestamp(2013, 11, 25, 16, 00, 00, 00), 2);
	/*	try {
			//new TrainingExpAgentHelper().submitWeeklyTrngExpForAgents();
		} catch (Exception e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}*/
<span class="nc" id="L64">	} </span>

	public Map&lt;String, TrainingExpenseBean&gt; fetchMenuData(String trngExpType, String startDate, String endDate, int serviceId, int gameNo) throws LMSException {
<span class="nc" id="L67">		Connection con = null;</span>
<span class="nc" id="L68">		Map&lt;String, TrainingExpenseBean&gt; map = new LinkedHashMap&lt;String, TrainingExpenseBean&gt;();</span>
<span class="nc" id="L69">		con = DBConnect.getConnection();</span>

<span class="nc" id="L71">		TrainingExpenseBean tempBean = null;</span>

		try {
<span class="nc" id="L74">			String orgCodeQry = &quot; a.name orgCode &quot;;</span>

<span class="nc bnc" id="L76" title="All 2 branches missed.">			if ((LMSFilterDispatcher.orgFieldType).equalsIgnoreCase(&quot;CODE&quot;)) {</span>
<span class="nc" id="L77">				orgCodeQry = &quot; a.org_code orgCode &quot;;</span>

<span class="nc bnc" id="L79" title="All 2 branches missed.">			} else if ((LMSFilterDispatcher.orgFieldType).equalsIgnoreCase(&quot;CODE_NAME&quot;)) {</span>
<span class="nc" id="L80">				orgCodeQry = &quot; concat(a.org_code,'_',a.name)  orgCode &quot;;</span>

<span class="nc bnc" id="L82" title="All 2 branches missed.">			} else if ((LMSFilterDispatcher.orgFieldType).equalsIgnoreCase(&quot;NAME_CODE&quot;)) {</span>
<span class="nc" id="L83">				orgCodeQry = &quot; concat(a.name,'_',a.org_code)  orgCode&quot;;</span>

			}
<span class="nc" id="L86">			Calendar cal = Calendar.getInstance();</span>
<span class="nc" id="L87">			SimpleDateFormat sdf = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span>
<span class="nc" id="L88">			cal.setTimeInMillis(sdf.parse(endDate).getTime());</span>
<span class="nc" id="L89">			cal.add(Calendar.DAY_OF_MONTH, +1);</span>
<span class="nc" id="L90">			String endDate1 = new Timestamp(sdf.parse(new java.sql.Date(cal.getTimeInMillis()).toString()).getTime()).toString().split(&quot; &quot;)[0];</span>
<span class="nc" id="L91">			String searchDate = null;</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">			if (&quot;weekly&quot;.equalsIgnoreCase(trngExpType)) {</span>
<span class="nc" id="L93">				searchDate = endDate1;</span>
			} else {
<span class="nc" id="L95">				searchDate = endDate.split(&quot; &quot;)[0];</span>
			}
<span class="nc" id="L97">			String childDataQry = null;</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">			if (&quot;daily&quot;.equalsIgnoreCase(trngExpType)) {</span>
<span class="nc" id="L99">				childDataQry = &quot;select b.id,&quot; + orgCodeQry + &quot;,b.agent_org_id,b.mrp_sale,b.training_exp_per,b.training_exp_amt,time_slotted_mrp_sale,extra_training_exp_per,extra_training_exp_amt,b.incentive_mrp,b.incentive_per,b.incentive_amt,b.credit_note_number,b.incentive_credit_note_number,b.status,b.updated_date from st_lms_organization_master a,st_lms_agent_&quot; + trngExpType.toLowerCase() + &quot;_training_exp b where b.agent_org_id=a.organization_id and date(b.date)= '&quot; + searchDate + &quot;' and service_id = &quot; + serviceId + &quot; and game_id=&quot; + gameNo + &quot; order by &quot; + QueryManager.getAppendOrgOrder();</span>
			} else {
				/*
				 * childDataQry = &quot;select b.id,&quot;+orgCodeQry+
				 * &quot;,b.agent_org_id,b.mrp_sale,b.training_exp_per,b.training_exp_amt,b.credit_note_number,b.status,b.updated_date from st_lms_organization_master a,st_lms_agent_&quot;
				 * + trngExpType.toLowerCase() +
				 * &quot;_training_exp b where b.agent_org_id=a.organization_id and date(b.date)= '&quot;
				 * + searchDate +
				 * &quot;' and game_id=&quot;+gameNo+&quot; order by &quot;+QueryManager
				 * .getAppendOrgOrder();
				 */
<span class="nc" id="L110">				childDataQry = &quot;select b.id,&quot; + orgCodeQry + &quot;,b.agent_org_id,b.mrp_sale,b.training_exp_per,b.training_exp_amt,time_slotted_mrp_sale,extra_training_exp_per,extra_training_exp_amt,b.incentive_mrp,b.incentive_per,b.incentive_amt,b.credit_note_number,b.incentive_credit_note_number,b.status,b.updated_date from st_lms_organization_master a,st_lms_agent_&quot; + trngExpType.toLowerCase() + &quot;_training_exp b where b.agent_org_id=a.organization_id and date(b.date)= '&quot; + searchDate + &quot;' and service_id = &quot; + serviceId + &quot; and game_id=&quot; + gameNo + &quot; order by &quot; + QueryManager.getAppendOrgOrder();</span>
			}

<span class="nc" id="L113">			PreparedStatement pstmt = con.prepareStatement(childDataQry);</span>
<span class="nc" id="L114">			System.out.println(&quot;query fetching training data :&quot; + childDataQry);</span>
<span class="nc" id="L115">			ResultSet rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L117">				tempBean = new TrainingExpenseBean();</span>
<span class="nc" id="L118">				tempBean.setTaskId(rs.getInt(&quot;id&quot;));</span>
<span class="nc" id="L119">				tempBean.setOrgId(rs.getInt(&quot;agent_org_id&quot;));</span>
<span class="nc" id="L120">				tempBean.setOrgName(rs.getString(&quot;orgCode&quot;));</span>
<span class="nc" id="L121">				tempBean.setStatus(rs.getString(&quot;status&quot;));</span>
<span class="nc" id="L122">				tempBean.setSaleAmt(rs.getDouble(&quot;mrp_sale&quot;));</span>
<span class="nc" id="L123">				tempBean.setTrainingAmt(rs.getDouble(&quot;training_exp_amt&quot;));</span>
<span class="nc" id="L124">				tempBean.setTrainingPer(rs.getDouble(&quot;training_exp_per&quot;));</span>
<span class="nc bnc" id="L125" title="All 4 branches missed.">				if(rs.getString(&quot;credit_note_number&quot;) == null &amp;&amp; &quot;DONE&quot;.equalsIgnoreCase(rs.getString(&quot;status&quot;))){</span>
<span class="nc" id="L126">					tempBean.setCrNote(&quot;N.A.&quot;);</span>
				}else{
<span class="nc" id="L128">					tempBean.setCrNote(rs.getString(&quot;credit_note_number&quot;));	</span>
				}
				
				/*
				 * if(&quot;daily&quot;.equalsIgnoreCase(trngExpType)){
				 * tempBean.setTimeSlottedMrpSale
				 * (rs.getDouble(&quot;time_slotted_mrp_sale&quot;));
				 * tempBean.setExtraTrainingPer
				 * (rs.getDouble(&quot;extra_training_exp_per&quot;));
				 * tempBean.setExtraTrainingAmt
				 * (rs.getDouble(&quot;extra_training_exp_amt&quot;)); }
				 */
<span class="nc" id="L140">				tempBean.setTimeSlottedMrpSale(rs.getDouble(&quot;time_slotted_mrp_sale&quot;));</span>
<span class="nc" id="L141">				tempBean.setExtraTrainingPer(rs.getDouble(&quot;extra_training_exp_per&quot;));</span>
<span class="nc" id="L142">				tempBean.setExtraTrainingAmt(rs.getDouble(&quot;extra_training_exp_amt&quot;));</span>
<span class="nc" id="L143">				tempBean.setIncentiveMrp(rs.getDouble(&quot;incentive_mrp&quot;));</span>
<span class="nc" id="L144">				tempBean.setIncentivePer(rs.getDouble(&quot;incentive_per&quot;));</span>
<span class="nc" id="L145">				tempBean.setIncentiveAmt(rs.getDouble(&quot;incentive_amt&quot;));</span>
<span class="nc bnc" id="L146" title="All 4 branches missed.">				if(rs.getString(&quot;incentive_credit_note_number&quot;) == null &amp;&amp; &quot;DONE&quot;.equalsIgnoreCase(rs.getString(&quot;status&quot;))){</span>
<span class="nc" id="L147">					tempBean.setIncentiveCrNote(&quot;N.A.&quot;);</span>
				}else{
<span class="nc" id="L149">					tempBean.setIncentiveCrNote(rs.getString(&quot;incentive_credit_note_number&quot;));</span>
				}
				
				
//				tempBean.setIncentiveCrNote((rs.getString(&quot;incentive_credit_note_number&quot;) != null ? rs.getString(&quot;incentive_credit_note_number&quot;) : ((rs.getString(&quot;credit_note_number&quot;)) != null ? rs.getString(&quot;incentive_credit_note_number&quot;) : &quot;N.A.&quot;)));
<span class="nc" id="L154">				String tempDate = rs.getString(&quot;updated_date&quot;);</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">				if (tempDate != null) {</span>
<span class="nc" id="L156">					tempDate = tempDate.substring(0, tempDate.lastIndexOf('.'));</span>
				}
<span class="nc" id="L158">				tempBean.setUpdateDate(tempDate);</span>
<span class="nc" id="L159">				map.put(rs.getString(&quot;agent_org_id&quot;), tempBean);</span>
<span class="nc" id="L160">			}</span>
<span class="nc" id="L161">		} catch (Exception e) {</span>
<span class="nc" id="L162">			logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L163">			e.printStackTrace();</span>
<span class="nc" id="L164">			throw new LMSException(e);</span>
		} finally {
<span class="nc" id="L166">			try {</span>
<span class="nc bnc" id="L167" title="All 8 branches missed.">				if (con != null &amp;&amp; !con.isClosed()) {</span>
<span class="nc" id="L168">					con.close();</span>
				}
<span class="nc" id="L170">			} catch (SQLException e) {</span>
<span class="nc" id="L171">				logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L172">				e.printStackTrace();</span>
<span class="nc" id="L173">				throw new LMSException(e);</span>
<span class="nc" id="L174">			}</span>
		}
<span class="nc" id="L176">		System.out.println(map);</span>
<span class="nc" id="L177">		return map;</span>
	}

	public String updateAgentData(int taskId[], UserInfoBean userBean, String trngExpType, String fromDate, String toDate, int serviceId, int gameNo) throws LMSException {
<span class="nc" id="L181">		StringBuilder trExpResp = new StringBuilder();</span>
<span class="nc" id="L182">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L183">		Statement statement = null;</span>
<span class="nc" id="L184">		StringBuilder taskIds = new StringBuilder();</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">		for (int i = 0; i &lt; taskId.length; i++) {</span>
<span class="nc" id="L186">			taskIds.append(taskId[i] + &quot;,&quot;);</span>
		}
<span class="nc" id="L188">		taskIds.deleteCharAt(taskIds.length() - 1);</span>
<span class="nc" id="L189">		Timestamp updTime = new Timestamp(new Date().getTime());</span>
		try {
			// con.setAutoCommit(false);
<span class="nc" id="L192">			statement = con.createStatement();</span>
<span class="nc" id="L193">			String selectQry = &quot;select id,date,agent_org_id,training_exp_amt+extra_training_exp_amt training_exp_amt,incentive_per,incentive_amt,updated_mode from st_lms_agent_&quot; + trngExpType.toLowerCase() + &quot;_training_exp where id in (&quot; + taskIds + &quot;) and service_id = &quot; + serviceId + &quot; and status!='DONE'&quot;;</span>
<span class="nc" id="L194">			ResultSet rs = statement.executeQuery(selectQry);</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L196">				con.setAutoCommit(false);</span>
<span class="nc bnc" id="L197" title="All 2 branches missed.">				if(rs.getDouble(&quot;training_exp_amt&quot;) != 0.0)</span>
<span class="nc" id="L198">					updateTrngExpAgentDataIW(updTime, fromDate, toDate, rs.getInt(&quot;id&quot;), rs.getInt(&quot;agent_org_id&quot;), rs.getDouble(&quot;training_exp_amt&quot;), userBean, &quot;MANUAL&quot;, trngExpType, gameNo, serviceId, con);</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">				if(rs.getDouble(&quot;incentive_amt&quot;) &gt; 0.00){</span>
					
<span class="nc" id="L201">					updateAgentDataIWIncentive(updTime, fromDate, toDate, rs.getInt(&quot;id&quot;), rs.getInt(&quot;agent_org_id&quot;), rs.getDouble(&quot;incentive_amt&quot;), userBean, &quot;MANUAL&quot;, trngExpType, gameNo, serviceId, con);</span>
				}
<span class="nc" id="L203">				updateApprovalStatus(rs.getInt(&quot;id&quot;),con,trngExpType.toLowerCase());</span>
<span class="nc" id="L204">				con.commit();</span>
			}
<span class="nc" id="L206">			selectQry = &quot;select  id,status,credit_note_number,incentive_credit_note_number,updated_date from st_lms_agent_&quot; + trngExpType.toLowerCase() + &quot;_training_exp where id in (&quot; + taskIds + &quot;) and service_id = &quot; + serviceId;</span>
<span class="nc" id="L207">			rs = statement.executeQuery(selectQry);</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc bnc" id="L209" title="All 4 branches missed.">				trExpResp.append(rs.getInt(&quot;id&quot;) + &quot;,&quot; + rs.getString(&quot;status&quot;) + &quot;,&quot; + (rs.getString(&quot;credit_note_number&quot;) != null ? rs.getString(&quot;credit_note_number&quot;):&quot;N.A.&quot;) + &quot;,&quot;+rs.getString(&quot;updated_date&quot;).substring(0, rs.getString(&quot;updated_date&quot;).lastIndexOf('.'))+&quot;,&quot; + (rs.getString(&quot;incentive_credit_note_number&quot;) != null ? rs.getString(&quot;incentive_credit_note_number&quot;):&quot;N.A.&quot;) + &quot;Nxt&quot;);</span>
			}
			// con.commit();
<span class="nc" id="L212">			DBConnect.closeCon(con);</span>
<span class="nc" id="L213">		} catch (Exception e) {</span>
<span class="nc" id="L214">			e.printStackTrace();</span>
<span class="nc" id="L215">		}</span>
<span class="nc" id="L216">		System.out.println(trExpResp);</span>
<span class="nc" id="L217">		return trExpResp.toString();</span>
	}

	// method for automatically generating credit note to all agents by amit ..
	public void submitDailyTrainingExpForAgents(ServletContext sc) throws Exception {
<span class="nc" id="L222">		String isdailyTrngExp = (String) sc.getAttribute(&quot;IS_DAILY_TRAINING_EXP&quot;);</span>
<span class="nc" id="L223">		int serviceId = Util.getServiceIdFormCode(&quot;DG&quot;);</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">		if (&quot;YES&quot;.equalsIgnoreCase(isdailyTrngExp)) {</span>
<span class="nc" id="L225">			String trngExpMode = (String) sc.getAttribute(&quot;DAILY_TRAINING_EXP_MODE&quot;);</span>
<span class="nc" id="L226">			Connection con = DBConnect.getConnection();</span>
			try {
<span class="nc" id="L228">				con.setAutoCommit(false);</span>
<span class="nc" id="L229">				Statement stmt = con.createStatement();</span>
<span class="nc" id="L230">				ResultSet rs = stmt.executeQuery(&quot;select game_id from st_dg_game_master where game_status &lt;&gt; 'SALE_CLOSE'&quot;);</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L232">					int gameNo = rs.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L233">					Statement statement = null;</span>
<span class="nc" id="L234">					ResultSet resultSet = null;</span>
<span class="nc" id="L235">					PreparedStatement pstmt = null;</span>

<span class="nc" id="L237">					Timestamp startDate = null;</span>
<span class="nc" id="L238">					Timestamp endDate = null;</span>

<span class="nc" id="L240">					Calendar cal = Calendar.getInstance();</span>
<span class="nc" id="L241">					cal.add(Calendar.DAY_OF_MONTH, -1);// done for rescheduling of training expanses at 12:15 AM</span>
					/*
					 * String currDate = new
					 * java.sql.Date(cal.getTimeInMillis()) .toString();
					 * startDate = new Timestamp((new
					 * SimpleDateFormat(&quot;yyyy-MM-dd&quot;))
					 * .parse(currDate).getTime()); endDate = new Timestamp((new
					 * SimpleDateFormat(&quot;yyyy-MM-dd&quot;)).parse(
					 * currDate).getTime() + 24 * 60 * 60 * 1000 - 1000);
					 */
					// Timestamp currUpdateTime = new Timestamp(new
					// Date().getTime());

<span class="nc" id="L254">					UserInfoBean userBean = new UserInfoBean();</span>

<span class="nc" id="L256">					statement = con.createStatement();</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">					if (&quot;AUTO&quot;.equalsIgnoreCase(trngExpMode)) {</span>
<span class="nc" id="L258">						resultSet = statement.executeQuery(&quot;select user_id,organization_id,organization_type from st_lms_user_master where user_name='bomaster'&quot;);</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">						if (resultSet.next()) {</span>
<span class="nc" id="L260">							userBean.setUserOrgId(resultSet.getInt(TableConstants.ORGANIZATION_ID));</span>
<span class="nc" id="L261">							userBean.setUserId(resultSet.getInt(TableConstants.USER_ID));</span>
<span class="nc" id="L262">							userBean.setUserType(resultSet.getString(TableConstants.ORG_TYPE));</span>
						}
					}

<span class="nc" id="L266">					Date lastDateDone = new java.sql.Date(cal.getTimeInMillis());</span>
<span class="nc" id="L267">					Calendar calLastDate = Calendar.getInstance();</span>
<span class="nc" id="L268">					Calendar calStratDate = Calendar.getInstance();</span>
<span class="nc" id="L269">					calStratDate.setTime(lastDateDone);</span>
<span class="nc" id="L270">					pstmt = con.prepareStatement(&quot;select date(date) date from st_lms_agent_daily_training_exp where service_id = &quot;+serviceId+&quot; and game_id= &quot; + gameNo + &quot; order by date desc limit 1&quot;);</span>
<span class="nc" id="L271">					resultSet = pstmt.executeQuery();</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">					if (resultSet.next()) {</span>
<span class="nc" id="L273">						lastDateDone = resultSet.getDate(&quot;date&quot;);</span>
<span class="nc" id="L274">						calLastDate.setTime(lastDateDone);</span>
<span class="nc" id="L275">						calLastDate.add(Calendar.DAY_OF_MONTH, 1);</span>
<span class="nc" id="L276">						System.out.println(&quot;last daily training exapnses given for &quot; + lastDateDone);</span>
					} else {
<span class="nc" id="L278">						System.out.println(&quot;daily training expanses generating first time&quot;);</span>
<span class="nc" id="L279">						calLastDate.setTime(lastDateDone);</span>
						// first time destribution of training expenses
					}
<span class="nc" id="L282">					System.out.println(&quot;calLastDate&quot; + calLastDate.getTime());</span>
<span class="nc" id="L283">					System.out.println(&quot;calStratDate&quot; + calStratDate.getTime());</span>
<span class="nc" id="L284">					System.out.println(&quot;diff...&quot; + calLastDate.compareTo(calStratDate));</span>
<span class="nc" id="L285">					SimpleDateFormat sdf = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">					while (calLastDate.compareTo(calStratDate) &lt;= 0) {</span>
<span class="nc" id="L287">						Map&lt;Integer, Double&gt; agtTrngExpMap = fetchDailyTrainingExp(&quot;daily&quot;, sdf.format(calLastDate.getTime()), serviceId, gameNo);</span>
<span class="nc" id="L288">						Map&lt;Integer, Double&gt; agtExtraTrngExpMap = fetchExtraTrainingExp(&quot;daily&quot;, sdf.format(calLastDate.getTime()), gameNo, serviceId, con);</span>
<span class="nc" id="L289">						List&lt;Integer&gt; agtOrgIdList = new ArrayList&lt;Integer&gt;();</span>
<span class="nc" id="L290">						agtOrgIdList.addAll(agtTrngExpMap.keySet());</span>

<span class="nc" id="L292">						startDate = new Timestamp(sdf.parse(sdf.format(calLastDate.getTime())).getTime());</span>
<span class="nc" id="L293">						endDate = new Timestamp(sdf.parse(sdf.format(calLastDate.getTime())).getTime() + 24 * 60 * 60 * 1000 - 1000);</span>

<span class="nc" id="L295">						Map&lt;Integer, SalePwtReportsBean&gt; reportMap = drawSaleAgentWiseNew(startDate, endDate, gameNo);</span>

<span class="nc" id="L297">						String propertyValue = getPropertyValue(con, sdf.format(calLastDate.getTime()));</span>
						// 1#14:00:00_16:00:00~2#00:00:00_00:00:00

<span class="nc" id="L300">						String[] gameWiseTimingArr = propertyValue.split(&quot;~&quot;);</span>
<span class="nc" id="L301">						Map&lt;Integer, String&gt; gameSlotTimingMap = new HashMap&lt;Integer, String&gt;();</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">						for (String gameWiseTiming : gameWiseTimingArr) {</span>
<span class="nc" id="L303">							gameSlotTimingMap.put(Integer.parseInt(gameWiseTiming.split(&quot;#&quot;)[0]), gameWiseTiming.split(&quot;#&quot;)[1]);</span>
						}

<span class="nc" id="L306">						String slotTiming = gameSlotTimingMap.get(gameNo);</span>
<span class="nc" id="L307">						SimpleDateFormat simpleDateFormat = new SimpleDateFormat(&quot;HH:mm:ss&quot;, Locale.ROOT);</span>
<span class="nc" id="L308">						simpleDateFormat.setTimeZone(TimeZone.getTimeZone(&quot;UTC&quot;));</span>
<span class="nc" id="L309">						long startTimeSlot = simpleDateFormat.parse(slotTiming.split(&quot;_&quot;)[0]).getTime();</span>
<span class="nc" id="L310">						long endTimeSlot = simpleDateFormat.parse(slotTiming.split(&quot;_&quot;)[1]).getTime();</span>

<span class="nc" id="L312">						Timestamp startTimeSale = new Timestamp(sdf.parse(sdf.format(calLastDate.getTime())).getTime() + startTimeSlot);</span>
<span class="nc" id="L313">						Timestamp endTimeSale = new Timestamp(sdf.parse(sdf.format(calLastDate.getTime())).getTime() + endTimeSlot);</span>

<span class="nc" id="L315">						Map&lt;Integer, SalePwtReportsBean&gt; reportSaleTimeMap = drawSaleAgentWiseTimeWiseNew(startTimeSale, endTimeSale, gameNo);</span>

<span class="nc" id="L317">						System.out.println(&quot;total no. of agents &quot; + agtOrgIdList.size());</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">						if (agtOrgIdList.size() &gt; 0) {</span>
<span class="nc" id="L319">							pstmt = con.prepareStatement(&quot;select date from st_lms_agent_daily_training_exp tes where date(tes.date)='&quot; + new java.sql.Date(new Date().getTime()) + &quot;' and service_id = &quot;+serviceId+&quot; and game_id=&quot; + gameNo);</span>
<span class="nc" id="L320">							resultSet = pstmt.executeQuery();</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">							if (resultSet.next()) {</span>
<span class="nc" id="L322">								throw new LMSException(&quot;Daily expanses already given for the day ... &quot;);</span>
							}
<span class="nc bnc" id="L324" title="All 2 branches missed.">							for (int i = 0; i &lt; agtOrgIdList.size(); i++) {</span>
<span class="nc" id="L325">								SalePwtReportsBean tempBean = reportMap.get(agtOrgIdList.get(i));</span>
<span class="nc" id="L326">								SalePwtReportsBean tempBeanExtraTraining = reportSaleTimeMap.get(agtOrgIdList.get(i));</span>

<span class="nc bnc" id="L328" title="All 2 branches missed.">								if (tempBean != null) {</span>
<span class="nc" id="L329">									double agtMrpSale = tempBean.getSaleMrpAmt();</span>
<span class="nc" id="L330">									double trngExpAmt = (agtMrpSale * agtTrngExpMap.get(agtOrgIdList.get(i)) * 0.01);</span>

<span class="nc" id="L332">									double agtExtraMrpSale = tempBeanExtraTraining.getSaleMrpAmt();</span>

<span class="nc bnc" id="L334" title="All 2 branches missed.">									if (agtExtraMrpSale &lt; 0) {</span>
<span class="nc" id="L335">										agtExtraMrpSale = 0.0;</span>
									}

<span class="nc" id="L338">									double trngExtraExpAmt = (agtExtraMrpSale * agtExtraTrngExpMap.get(agtOrgIdList.get(i)) * 0.01);</span>

<span class="nc" id="L340">									double totalTrainingExp = trngExpAmt + trngExtraExpAmt;</span>
<span class="nc" id="L341">									System.out.println(&quot; agent_org_id :&quot; + agtOrgIdList.get(i) + &quot; agtMrpSale:&quot; + agtMrpSale + &quot; for the day:&quot; + startDate + &quot; trngExpAmt:&quot; + trngExpAmt + &quot; @: &quot; + agtTrngExpMap.get(agtOrgIdList.get(i)) + &quot; ExtraagtMrpSale:&quot; + agtExtraMrpSale + &quot; for the day:&quot; + startDate + &quot; ExtratrngExpAmt:&quot; + trngExtraExpAmt + &quot; @: &quot; + agtExtraTrngExpMap.get(agtOrgIdList.get(i)));</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">									if (totalTrainingExp != 0.0) {</span>
										// entry into daily training expense table

<span class="nc" id="L345">										pstmt = con.prepareStatement(QueryManager.insertAgtDailyTrngExp());</span>
<span class="nc" id="L346">										Calendar tempDate = (Calendar) calLastDate.clone();</span>
<span class="nc" id="L347">										tempDate.set(Calendar.HOUR_OF_DAY, 23);</span>
<span class="nc" id="L348">										tempDate.set(Calendar.MINUTE, 59);</span>
<span class="nc" id="L349">										tempDate.set(Calendar.SECOND, 59);</span>
<span class="nc" id="L350">										Timestamp updateTime = new Timestamp(tempDate.getTimeInMillis());</span>
<span class="nc" id="L351">										pstmt.setTimestamp(1, new Timestamp(calLastDate.getTimeInMillis()));</span>
<span class="nc" id="L352">										pstmt.setInt(2, agtOrgIdList.get(i));</span>
<span class="nc" id="L353">										pstmt.setInt(3, serviceId);</span>
<span class="nc" id="L354">										pstmt.setInt(4, gameNo);</span>
<span class="nc" id="L355">										pstmt.setDouble(5, agtMrpSale);</span>
<span class="nc" id="L356">										pstmt.setDouble(6, agtTrngExpMap.get(agtOrgIdList.get(i)));</span>
<span class="nc" id="L357">										pstmt.setDouble(7, trngExpAmt);</span>
<span class="nc" id="L358">										pstmt.setDouble(8, agtExtraMrpSale);</span>
<span class="nc" id="L359">										pstmt.setDouble(9, agtExtraTrngExpMap.get(agtOrgIdList.get(i)));</span>
<span class="nc" id="L360">										pstmt.setDouble(10, trngExtraExpAmt);</span>
<span class="nc" id="L361">										pstmt.setString(11, &quot;PENDING&quot;);</span>
<span class="nc" id="L362">										System.out.println(&quot;insertAgtTrngExp&gt;&gt;&quot; + pstmt);</span>
<span class="nc" id="L363">										pstmt.executeUpdate();</span>
<span class="nc" id="L364">										int taskId = 0;</span>
<span class="nc" id="L365">										resultSet = pstmt.getGeneratedKeys();</span>
<span class="nc bnc" id="L366" title="All 2 branches missed.">										if (resultSet.next())</span>
<span class="nc" id="L367">											taskId = resultSet.getInt(1);</span>
<span class="nc bnc" id="L368" title="All 2 branches missed.">										if (&quot;AUTO&quot;.equalsIgnoreCase(trngExpMode)) {</span>
<span class="nc" id="L369">											updateTrngExpAgentData(updateTime, updateTime.toString(), updateTime.toString(), taskId, agtOrgIdList.get(i), totalTrainingExp, userBean, trngExpMode, &quot;DAILY&quot;, gameNo, serviceId, con);</span>
<span class="nc" id="L370">											updateApprovalStatus(taskId,con,&quot;daily&quot;);	</span>
										}
									}
								}
							}
<span class="nc" id="L375">							calLastDate.add(Calendar.DAY_OF_MONTH, 1);</span>
						} else {
<span class="nc" id="L377">							calLastDate.add(Calendar.DAY_OF_MONTH, 1);</span>
						}
<span class="nc" id="L379">					}</span>
<span class="nc" id="L380">				}</span>
<span class="nc" id="L381">				con.commit();</span>
<span class="nc" id="L382">			} catch (SQLException e) {</span>
<span class="nc" id="L383">				logger.info(&quot;SQL Exception &quot;, e);</span>
<span class="nc" id="L384">				throw new LMSException(&quot;SQL Exception &quot; + e.getMessage());</span>
<span class="nc" id="L385">			} catch (Exception e) {</span>
<span class="nc" id="L386">				logger.info(&quot;Exception &quot;, e);</span>
<span class="nc" id="L387">				throw new LMSException(&quot;Exception&quot; + e.getMessage());</span>
			} finally {
<span class="nc" id="L389">				DBConnect.closeCon(con);</span>
<span class="nc" id="L390">			}</span>
		}
<span class="nc" id="L392">	}</span>
	
/*	public void submitDailyIWNonWinningTrainingExpForAgents(ServletContext sc, String incDurType) throws LMSException {
		String isdailyTrngExp = (String) sc.getAttribute(&quot;IS_&quot;+incDurType+&quot;_TRAINING_EXP&quot;);
		int serviceId = Util.getServiceIdFormCode(&quot;IW&quot;);
		ServiceRequest serviceRequest = null ;
		String response = null ;
		if (&quot;YES&quot;.equalsIgnoreCase(isdailyTrngExp)) {
			String trngExpMode = (String) sc.getAttribute(incDurType+&quot;_TRAINING_EXP_MODE&quot;);
			Connection con = DBConnect.getConnection();
			try {
				con.setAutoCommit(false);
				Statement stmt = con.createStatement();
				ResultSet rs = stmt.executeQuery(&quot;select game_id from st_iw_game_master where game_status &lt;&gt; 'SALE_CLOSE'&quot;);
				while (rs.next()) {
					int gameNo = rs.getInt(&quot;game_id&quot;);
					Statement statement = null;
					ResultSet resultSet = null;
					PreparedStatement pstmt = null;

					String startDate = null;
					String endDate = null;

					Calendar cal = Calendar.getInstance();
					cal.add(Calendar.DAY_OF_MONTH, &quot;DAILY&quot;.equalsIgnoreCase(incDurType) ? -1 : -7);// done for rescheduling of training expanses at 12:15 AM

					UserInfoBean userBean = new UserInfoBean();

					statement = con.createStatement();
					if (&quot;AUTO&quot;.equalsIgnoreCase(trngExpMode)) {
						resultSet = statement.executeQuery(&quot;select user_id,organization_id,organization_type from st_lms_user_master where user_name='bomaster'&quot;);
						if (resultSet.next()) {
							userBean.setUserOrgId(resultSet.getInt(TableConstants.ORGANIZATION_ID));
							userBean.setUserId(resultSet.getInt(TableConstants.USER_ID));
							userBean.setUserType(resultSet.getString(TableConstants.ORG_TYPE));
						}
					}
					Date lastDateDone = new java.sql.Date(cal.getTimeInMillis());
					Calendar calLastDate = Calendar.getInstance();
					Calendar calStratDate = Calendar.getInstance();
					calStratDate.setTime(lastDateDone);
					Timestamp updateTime = &quot;DAILY&quot;.equalsIgnoreCase(incDurType) ? new Timestamp(new java.sql.Date(new Date().getTime()).getTime()) :  new Timestamp((calStratDate.getTime()).getTime()+24 * 7 * 60 * 60 * 1000);
					
					pstmt = con.prepareStatement(&quot;select date(date) date from st_lms_agent_&quot;+incDurType.toLowerCase()+&quot;_training_exp tes where date(tes.date)='&quot; + updateTime + &quot;' and  service_id = &quot;+serviceId+&quot; and game_id= &quot; + gameNo + &quot; order by date desc limit 1&quot;);
					resultSet = pstmt.executeQuery();
					if (resultSet.next()) {
						lastDateDone = resultSet.getDate(&quot;date&quot;);
						calLastDate.setTime(lastDateDone);
						calLastDate.add(Calendar.DAY_OF_MONTH, &quot;DAILY&quot;.equalsIgnoreCase(incDurType) ? 1 : 7);
						System.out.println(&quot;last &quot;+incDurType+&quot; training exapnses given for &quot; + lastDateDone);
					} else {
						System.out.println(incDurType + &quot; training expanses generating first time&quot;);
						calLastDate.setTime(lastDateDone);
						// first time destribution of training expenses
					}
					System.out.println(&quot;calLastDate&quot; + calLastDate.getTime());
					System.out.println(&quot;calStratDate&quot; + calStratDate.getTime());
					System.out.println(&quot;diff...&quot; + calLastDate.compareTo(calStratDate));
					SimpleDateFormat sdf = new SimpleDateFormat(&quot;MM/dd/yyyy&quot;);
					SimpleDateFormat sdf1 = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);
					while (calLastDate.compareTo(calStratDate) &lt;= 0) {
						startDate = sdf.format(calLastDate.getTime())+&quot; 00:00:00&quot; ;
						endDate = sdf.format((calStratDate.getTime()).getTime()+(&quot;DAILY&quot;.equalsIgnoreCase(incDurType) ? 0 : (24 * 7 * 60 * 60 * 1000 - 1000)))+&quot; 23:59:59&quot; ;
						serviceRequest = new ServiceRequest();
						serviceRequest.setServiceName(&quot;/retailer/terminal/&quot;);
						serviceRequest.setServiceMethod(&quot;BORetailerDataCall&quot;);
						serviceRequest.setServiceData(&quot;?fromDate=&quot;+URLEncoder.encode(startDate, &quot;UTF-8&quot;)+&quot;&amp;toDate=&quot;+URLEncoder.encode(endDate, &quot;UTF-8&quot;));
						//serviceRequest.setServiceData(&quot;?fromDate=&quot;+URLEncoder.encode(&quot;03/01/2016 00:00:00&quot;, &quot;UTF-8&quot;)+&quot;&amp;toDate=&quot;+URLEncoder.encode(&quot;04/30/2016 23:59:59&quot;, &quot;UTF-8&quot;));
						response = ServiceDelegateIW.getInstance().getResponseStringForTrainingExpense(serviceRequest);
						//response = &quot;{  \&quot;responseCode\&quot;: \&quot;0\&quot;,  \&quot;dataArray\&quot;: [    {      \&quot;winning\&quot;: 0,      \&quot;userName\&quot;: \&quot;testr1\&quot;,      \&quot;sale\&quot;: 400    },    {      \&quot;winning\&quot;: 4050,      \&quot;userName\&quot;: \&quot;TEEJAY006\&quot;,      \&quot;sale\&quot;: 5670    }  ],  \&quot;responseMsg\&quot;: \&quot;Success\&quot;}&quot;;
						if (response == null) {
							throw new LMSException(LMSErrors.GENERAL_EXCEPTION_ERROR_CODE, LMSErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);
						}
						IWTrainingExpBean bean = new Gson().fromJson(response, new TypeToken&lt;IWTrainingExpBean&gt;() {}.getType());
						if(&quot;success&quot;.equalsIgnoreCase(bean.getResponseMsg()) &amp;&amp; bean.getDataArray().size() &gt; 0){
								prepareDataRecord(con, bean.getDataArray());
								Map&lt;Integer, Double&gt; agentWiseMap = clubDataAgentWise(con, bean.getDataArray(), gameNo, serviceId, incDurType, startDate, endDate);
								if(agentWiseMap.size() &gt; 0){
										if (&quot;AUTO&quot;.equalsIgnoreCase(trngExpMode)) {
											updateAllAgentData(sdf.format(calLastDate.getTime())+&quot; 00:00:00&quot;, sdf1.format((calStratDate.getTime()).getTime())+&quot; 23:59:59&quot;, incDurType, userBean, serviceId, gameNo, con);
										}
								}
						}
						calLastDate.add(Calendar.DAY_OF_MONTH, 1);
				}
				con.commit();
				}} catch (LMSException e) {
				logger.info(&quot;LMS Exception &quot;, e);
				throw e;
			} catch (Exception e) {
				logger.info(&quot;Exception &quot;, e);
				throw new LMSException(&quot;Exception&quot; + e.getMessage());
			} finally {
				DBConnect.closeCon(con);
			}
		}
	}*/
	
/*
 * This method will return the map which will contain the agentOrgId as key and the final incentive to be given as Value.
 * */
	public Map&lt;Integer, IWIncentiveDataBean&gt; clubDataAgentWise(Connection con, List&lt;IWTrainingExpDataBean&gt; dataArray, int gameId, int serviceId, String incDurType, Timestamp startDate, Timestamp endDate) {
<span class="nc" id="L494">		Statement preparedStatement = null;</span>
<span class="nc" id="L495">		Statement fetchTrngExpStatement = null;</span>
<span class="nc" id="L496">		PreparedStatement prepareUpdateStatement = null ;</span>
<span class="nc" id="L497">		PreparedStatement insPreStatement = null ;</span>
<span class="nc" id="L498">		ResultSet resultSet = null;</span>
<span class="nc" id="L499">		ResultSet resultSet1 = null;</span>
<span class="nc" id="L500">		Map&lt;Integer, IWIncentiveDataBean&gt; agentIncentiveMap = null;</span>
<span class="nc" id="L501">		Map&lt;String, IWTrainingExpDataBean&gt; retailerMap = null;</span>
<span class="nc" id="L502">		IWIncentiveDataBean inDataBean = null;</span>
<span class="nc" id="L503">		int agentOrgId = 0;</span>
<span class="nc" id="L504">		double incentivePercentage = 0.00;</span>
<span class="nc" id="L505">		double amountForIncentive = 0.00;</span>
<span class="nc" id="L506">		double calculatedIncentive = 0.00 ;</span>
		
		try {
<span class="nc" id="L509">			agentIncentiveMap = new HashMap&lt;Integer, IWIncentiveDataBean&gt;();</span>
<span class="nc" id="L510">			retailerMap = new HashMap&lt;String, IWTrainingExpDataBean&gt;();</span>
<span class="nc" id="L511">			StringBuilder userList = new StringBuilder() ;</span>
<span class="nc bnc" id="L512" title="All 2 branches missed.">			for (IWTrainingExpDataBean dataBean : dataArray) {</span>
<span class="nc" id="L513">				userList.append(&quot;'&quot;+dataBean.getUserName()+&quot;',&quot;);</span>
<span class="nc" id="L514">				retailerMap.put(dataBean.getUserName(), dataBean);</span>
<span class="nc" id="L515">			}</span>
<span class="nc" id="L516">			String insIncentivequery = &quot;INSERT INTO st_iw_retailer_&quot;+incDurType+&quot;_incentive_data(start_date,end_date,user_name, sale_amt, winning_amt,incentive_per,incentive_amt) VALUES(?,?,?,?,?,?,?)&quot; ;</span>
<span class="nc" id="L517">			String fetchTrainingExpenseQuery = &quot;select organization_id,value+incentive_exp_var incentive_train_exp from (select organization_id,name,ifnull(incentive_exp_var,0.0) incentive_exp_var from st_lms_organization_master left outer join (select var.agent_org_id,ifnull(hist_var,incentive_exp_var)incentive_exp_var from st_lms_agent_&quot;+incDurType+&quot;_trng_exp_var_mapping var left join (select agent_org_id,incentive_exp_var hist_var, service_id,game_id from(select agent_org_id,incentive_exp_var,updated_date, service_id,game_id from st_lms_agent_&quot;+incDurType+&quot;_trng_exp_var_mapping_history where date(updated_date) &gt; '&quot;+startDate+&quot;' and service_id = &quot;+serviceId+&quot; and game_id = &quot;+gameId+&quot; order by updated_date asc)aa group by agent_org_id) hist on var.agent_org_id=hist.agent_org_id and var.service_id=hist.service_id and var.game_id=hist.game_id  where var.service_id = &quot;+serviceId+&quot; and var.game_id=&quot;+gameId+&quot;) map on organization_id=map.agent_org_id where organization_type='AGENT') tr,(select incentive_exp_default value from st_lms_agent_default_&quot;+incDurType+&quot;_training_exp where service_id = &quot;+serviceId+&quot; and game_id=&quot;+gameId+&quot;) dtr;&quot;;</span>
<span class="nc" id="L518">			String query = &quot;select um1.user_name,group_concat(um.user_name) ret_user_name, um1.organization_id organization_id from st_lms_user_master um inner join st_lms_user_master um1 on um.parent_user_id = um1.user_id where um.user_name IN (&quot;+userList.substring(0, userList.length()-1)+&quot;) group by um1.user_name&quot;;</span>
<span class="nc" id="L519">			logger.info(&quot;insIncentivequery &quot;+insIncentivequery);</span>
<span class="nc" id="L520">			logger.info(&quot;fetchTrainingExpenseQuery &quot;+fetchTrainingExpenseQuery);</span>
<span class="nc" id="L521">			logger.info(&quot;query &quot;+query);</span>
<span class="nc" id="L522">			preparedStatement = con.createStatement();</span>
<span class="nc" id="L523">			fetchTrngExpStatement = con.createStatement();</span>
<span class="nc" id="L524">			insPreStatement = con.prepareStatement(insIncentivequery) ;</span>
<span class="nc" id="L525">			resultSet = preparedStatement.executeQuery(query);</span>
<span class="nc" id="L526">			resultSet1 = fetchTrngExpStatement.executeQuery(fetchTrainingExpenseQuery);</span>
<span class="nc bnc" id="L527" title="All 2 branches missed.">			while(resultSet1.next()){</span>
<span class="nc" id="L528">				inDataBean = new IWIncentiveDataBean();</span>
<span class="nc" id="L529">				inDataBean.setIncentivePer( resultSet1.getDouble(&quot;incentive_train_exp&quot;));</span>
<span class="nc" id="L530">				agentIncentiveMap.put(resultSet1.getInt(&quot;organization_id&quot;),inDataBean);</span>
			}
<span class="nc" id="L532">			logger.info(&quot;agentIncentiveMap size &quot;+agentIncentiveMap.size());</span>
<span class="nc bnc" id="L533" title="All 2 branches missed.">			while(resultSet.next()){</span>
<span class="nc" id="L534">				String[] userArray = resultSet.getString(&quot;ret_user_name&quot;).split(&quot;,&quot;);</span>
<span class="nc" id="L535">				agentOrgId = resultSet.getInt(&quot;organization_id&quot;); </span>
<span class="nc bnc" id="L536" title="All 2 branches missed.">				for (int i=0; i&lt; userArray.length; i++) {</span>
<span class="nc bnc" id="L537" title="All 4 branches missed.">					if(retailerMap.get(userArray[i]) != null &amp;&amp; agentIncentiveMap.containsKey(agentOrgId)){</span>
<span class="nc" id="L538">						incentivePercentage = agentIncentiveMap.get(agentOrgId).getIncentivePer();</span>
<span class="nc" id="L539">						amountForIncentive = retailerMap.get(userArray[i]).getSale() - retailerMap.get(userArray[i]).getWinning();</span>
<span class="nc bnc" id="L540" title="All 2 branches missed.">						calculatedIncentive = amountForIncentive &gt; 0.00 ? (amountForIncentive * incentivePercentage * 0.01) : 0.00 ;</span>
						
<span class="nc" id="L542">						insPreStatement.setTimestamp(1, startDate);</span>
<span class="nc" id="L543">						insPreStatement.setTimestamp(2, endDate);</span>
<span class="nc" id="L544">						insPreStatement.setString(3, userArray[i]);</span>
<span class="nc" id="L545">						insPreStatement.setDouble(4, retailerMap.get(userArray[i]).getSale());</span>
<span class="nc" id="L546">						insPreStatement.setDouble(5, retailerMap.get(userArray[i]).getWinning());</span>
<span class="nc" id="L547">						insPreStatement.setDouble(6, incentivePercentage);</span>
<span class="nc" id="L548">						insPreStatement.setDouble(7, calculatedIncentive);</span>
<span class="nc" id="L549">						insPreStatement.addBatch() ;</span>
<span class="nc" id="L550">						agentIncentiveMap.get(agentOrgId).setIncentiveAmt(agentIncentiveMap.get(agentOrgId).getIncentiveAmt() + calculatedIncentive);</span>
<span class="nc" id="L551">						agentIncentiveMap.get(agentOrgId).setIncentiveMrp(agentIncentiveMap.get(agentOrgId).getIncentiveMrp() + amountForIncentive);</span>
					}
				}
					
<span class="nc" id="L555">			}</span>
<span class="nc" id="L556">			logger.info(&quot;insPreStatement &quot;+insPreStatement.getFetchSize());</span>
<span class="nc" id="L557">			insPreStatement.executeBatch() ;</span>
			
<span class="nc" id="L559">		} catch (Exception e) {</span>
<span class="nc" id="L560">			e.printStackTrace();</span>
		}finally{
<span class="nc" id="L562">			DBConnect.closeResource(preparedStatement, fetchTrngExpStatement, prepareUpdateStatement, resultSet,insPreStatement) ;</span>
<span class="nc" id="L563">		}</span>
		
<span class="nc" id="L565">		return agentIncentiveMap ;</span>

	}

	public void submitDailyInstantWinTrainingExpForAgents(ServletContext sc) throws Exception {
<span class="nc" id="L570">		int serviceId = Util.getServiceIdFormCode(&quot;IW&quot;);</span>
<span class="nc" id="L571">			String trngExpMode = (String) sc.getAttribute(&quot;DAILY_TRAINING_EXP_MODE&quot;);</span>
<span class="nc" id="L572">			Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L573">			String response = null ;</span>
<span class="nc" id="L574">			Map&lt;Integer, SalePwtReportsBean&gt; reportMap = null;</span>
<span class="nc" id="L575">			Map&lt;Integer, SalePwtReportsBean&gt; reportSaleTimeMap = null;</span>
<span class="nc" id="L576">			Map&lt;Integer, Double&gt; agtTrngExpMap = null;</span>
<span class="nc" id="L577">			Map&lt;Integer, Double&gt; agtExtraTrngExpMap = null;</span>
<span class="nc" id="L578">			Map&lt;Integer, IWIncentiveDataBean&gt; agentWiseMap = null;</span>
			try {
<span class="nc" id="L580">				con.setAutoCommit(false);</span>
<span class="nc" id="L581">				Statement stmt = con.createStatement();			</span>
<span class="nc" id="L582">				ResultSet rs = stmt.executeQuery(&quot;select game_id from st_iw_game_master where game_status &lt;&gt; 'SALE_CLOSE'&quot;);</span>
<span class="nc bnc" id="L583" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L584">					int gameNo = rs.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L585">					Statement statement = null;</span>
<span class="nc" id="L586">					ResultSet resultSet = null;</span>
<span class="nc" id="L587">					PreparedStatement pstmt = null;</span>
<span class="nc" id="L588">					Timestamp startDate = null;</span>
<span class="nc" id="L589">					Timestamp endDate = null;</span>
<span class="nc" id="L590">					Calendar cal = Calendar.getInstance();</span>
<span class="nc" id="L591">					cal.add(Calendar.DAY_OF_MONTH, -1);// done for rescheduling of training expanses at 12:15 AM</span>
<span class="nc" id="L592">					UserInfoBean userBean = new UserInfoBean();</span>
<span class="nc" id="L593">					statement = con.createStatement();</span>
<span class="nc bnc" id="L594" title="All 2 branches missed.">					if (&quot;AUTO&quot;.equalsIgnoreCase(trngExpMode)) {</span>
<span class="nc" id="L595">						resultSet = statement.executeQuery(&quot;select user_id,organization_id,organization_type from st_lms_user_master where user_name='bomaster'&quot;);</span>
<span class="nc bnc" id="L596" title="All 2 branches missed.">						if (resultSet.next()) {</span>
<span class="nc" id="L597">							userBean.setUserOrgId(resultSet.getInt(TableConstants.ORGANIZATION_ID));</span>
<span class="nc" id="L598">							userBean.setUserId(resultSet.getInt(TableConstants.USER_ID));</span>
<span class="nc" id="L599">							userBean.setUserType(resultSet.getString(TableConstants.ORG_TYPE));</span>
						}
					}
<span class="nc" id="L602">					Date lastDateDone = new java.sql.Date(cal.getTimeInMillis());</span>
<span class="nc" id="L603">					Calendar calLastDate = Calendar.getInstance();</span>
<span class="nc" id="L604">					Calendar calStratDate = Calendar.getInstance();</span>
<span class="nc" id="L605">					calStratDate.setTime(lastDateDone);</span>
<span class="nc" id="L606">					pstmt = con.prepareStatement(&quot;select date(date) date from st_lms_agent_daily_training_exp where service_id = &quot;+serviceId+&quot; and game_id= &quot; + gameNo + &quot; order by date desc limit 1&quot;);</span>
<span class="nc" id="L607">					resultSet = pstmt.executeQuery();</span>
<span class="nc bnc" id="L608" title="All 2 branches missed.">					if (resultSet.next()) {</span>
<span class="nc" id="L609">						lastDateDone = resultSet.getDate(&quot;date&quot;);</span>
<span class="nc" id="L610">						calLastDate.setTime(lastDateDone);</span>
<span class="nc" id="L611">						calLastDate.add(Calendar.DAY_OF_MONTH, 1);</span>
<span class="nc" id="L612">						System.out.println(&quot;last daily training exapnses given for &quot; + lastDateDone);</span>
					} else {
<span class="nc" id="L614">						System.out.println(&quot;daily training expanses generating first time&quot;);</span>
<span class="nc" id="L615">						calLastDate.setTime(lastDateDone);</span>
					}
<span class="nc" id="L617">					System.out.println(&quot;calLastDate&quot; + calLastDate.getTime());</span>
<span class="nc" id="L618">					System.out.println(&quot;calStratDate&quot; + calStratDate.getTime());</span>
<span class="nc" id="L619">					System.out.println(&quot;diff...&quot; + calLastDate.compareTo(calStratDate));</span>
<span class="nc" id="L620">					SimpleDateFormat sdf = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span>
<span class="nc bnc" id="L621" title="All 2 branches missed.">					while (calLastDate.compareTo(calStratDate) &lt;= 0) {</span>
<span class="nc" id="L622">						startDate = new Timestamp(sdf.parse(sdf.format(calLastDate.getTime())).getTime());</span>
<span class="nc" id="L623">						endDate = new Timestamp(sdf.parse(sdf.format(calLastDate.getTime())).getTime() + 24 * 60 * 60 * 1000 - 1000);</span>
<span class="nc" id="L624">						List&lt;Integer&gt; agtOrgIdList = new ArrayList&lt;Integer&gt;();</span>
<span class="nc bnc" id="L625" title="All 2 branches missed.">						if(&quot;YES&quot;.equalsIgnoreCase(Utility.getPropertyValue(&quot;IS_DAILY_IW_INCENTIVE_EXPENSE_ENABLED&quot;))){</span>
<span class="nc" id="L626">								ServiceRequest serviceRequest = new ServiceRequest();</span>
<span class="nc" id="L627">								serviceRequest.setServiceName(&quot;/retailer/terminal/&quot;);</span>
<span class="nc" id="L628">								serviceRequest.setServiceMethod(&quot;BORetailerDataCall&quot;);</span>
<span class="nc" id="L629">								serviceRequest.setServiceData(&quot;?fromDate=&quot;+URLEncoder.encode(startDate.toString(), &quot;UTF-8&quot;)+&quot;&amp;toDate=&quot;+URLEncoder.encode(endDate.toString(), &quot;UTF-8&quot;));</span>
								//serviceRequest.setServiceData(&quot;?fromDate=&quot;+URLEncoder.encode(&quot;2016-03-01 00:00:00&quot;, &quot;UTF-8&quot;)+&quot;&amp;toDate=&quot;+URLEncoder.encode(&quot;2016-04-30 23:59:59&quot;, &quot;UTF-8&quot;));
<span class="nc" id="L631">								response = ServiceDelegateIW.getInstance().getResponseStringForTrainingExpense(serviceRequest);</span>
								//response = &quot;{  \&quot;responseCode\&quot;: \&quot;0\&quot;,  \&quot;dataArray\&quot;: [    {      \&quot;winning\&quot;: 20,      \&quot;userName\&quot;: \&quot;testr1\&quot;,      \&quot;sale\&quot;: 400    },    {      \&quot;winning\&quot;: 4050,      \&quot;userName\&quot;: \&quot;TEEJAY006\&quot;,      \&quot;sale\&quot;: 5670    }  ],  \&quot;responseMsg\&quot;: \&quot;Success\&quot;}&quot;;
<span class="nc bnc" id="L633" title="All 2 branches missed.">								if (response == null) {</span>
<span class="nc" id="L634">									throw new LMSException(LMSErrors.GENERAL_EXCEPTION_ERROR_CODE, LMSErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
								}
<span class="nc" id="L636">								IWTrainingExpBean bean = new Gson().fromJson(response, new TypeToken&lt;IWTrainingExpBean&gt;() {}.getType());</span>
<span class="nc bnc" id="L637" title="All 4 branches missed.">								if(&quot;success&quot;.equalsIgnoreCase(bean.getResponseMsg()) &amp;&amp; bean.getDataArray().size() &gt; 0){</span>
										//prepareDataRecord(con, bean.getDataArray());
<span class="nc" id="L639">										agentWiseMap = clubDataAgentWise(con, bean.getDataArray(), gameNo, serviceId, &quot;daily&quot;, startDate, endDate);</span>
<span class="nc" id="L640">										logger.info(&quot;agentWiseMap length : &quot;+agentWiseMap.size());</span>
<span class="nc bnc" id="L641" title="All 2 branches missed.">										if(agentWiseMap.size() &gt; 0)</span>
<span class="nc" id="L642">											agtOrgIdList.addAll(agentWiseMap.keySet());</span>
								}
						}
<span class="nc bnc" id="L645" title="All 2 branches missed.">						if(&quot;YES&quot;.equalsIgnoreCase(Utility.getPropertyValue(&quot;IS_DAILY_IW_TRAINING_EXPENSE_ENABLED&quot;))){</span>
<span class="nc" id="L646">							agtTrngExpMap = fetchDailyTrainingExp(&quot;daily&quot;, sdf.format(calLastDate.getTime()), serviceId, gameNo);</span>
<span class="nc" id="L647">							agtExtraTrngExpMap = fetchExtraTrainingExp(&quot;daily&quot;, sdf.format(calLastDate.getTime()), gameNo, serviceId, con);</span>
<span class="nc" id="L648">							reportMap = iwSaleAgentWiseNew(startDate, endDate, gameNo);</span>
<span class="nc" id="L649">							String propertyValue = getPropertyValue(con, sdf.format(calLastDate.getTime()));</span>
							// 1#14:00:00_16:00:00~2#00:00:00_00:00:00

<span class="nc" id="L652">							String[] gameWiseTimingArr = propertyValue.split(&quot;~&quot;);</span>
<span class="nc" id="L653">							Map&lt;Integer, String&gt; gameSlotTimingMap = new HashMap&lt;Integer, String&gt;();</span>
<span class="nc bnc" id="L654" title="All 2 branches missed.">							for (String gameWiseTiming : gameWiseTimingArr) {</span>
<span class="nc" id="L655">								gameSlotTimingMap.put(Integer.parseInt(gameWiseTiming.split(&quot;#&quot;)[0]), gameWiseTiming.split(&quot;#&quot;)[1]);</span>
							}
<span class="nc" id="L657">							String slotTiming = gameSlotTimingMap.get(gameNo);</span>
<span class="nc" id="L658">							SimpleDateFormat simpleDateFormat = new SimpleDateFormat(&quot;HH:mm:ss&quot;, Locale.ROOT);</span>
<span class="nc" id="L659">							simpleDateFormat.setTimeZone(TimeZone.getTimeZone(&quot;UTC&quot;));</span>
<span class="nc" id="L660">							long startTimeSlot = simpleDateFormat.parse(slotTiming.split(&quot;_&quot;)[0]).getTime();</span>
<span class="nc" id="L661">							long endTimeSlot = simpleDateFormat.parse(slotTiming.split(&quot;_&quot;)[1]).getTime();</span>

<span class="nc" id="L663">							Timestamp startTimeSale = new Timestamp(sdf.parse(sdf.format(calLastDate.getTime())).getTime() + startTimeSlot);</span>
<span class="nc" id="L664">							Timestamp endTimeSale = new Timestamp(sdf.parse(sdf.format(calLastDate.getTime())).getTime() + endTimeSlot);</span>

<span class="nc" id="L666">							reportSaleTimeMap = iwSaleAgentWiseTimeWiseNew(startTimeSale, endTimeSale, gameNo);</span>
<span class="nc bnc" id="L667" title="All 2 branches missed.">							if(agtOrgIdList.size() &lt; 1)</span>
<span class="nc" id="L668">								agtOrgIdList.addAll(agtTrngExpMap.keySet());</span>
						}
<span class="nc bnc" id="L670" title="All 2 branches missed.">						if (agtOrgIdList.size() &gt; 0) {</span>
<span class="nc" id="L671">							pstmt = con.prepareStatement(&quot;select date from st_lms_agent_daily_training_exp tes where date(tes.date)='&quot; + new java.sql.Date(new Date().getTime()) + &quot;' and service_id = &quot; + serviceId + &quot; and game_id=&quot; + gameNo);</span>
<span class="nc" id="L672">							resultSet = pstmt.executeQuery();</span>
<span class="nc bnc" id="L673" title="All 2 branches missed.">							if (resultSet.next()) {</span>
<span class="nc" id="L674">								throw new LMSException(&quot;Daily expanses already given for the day ... &quot;);</span>
							}
<span class="nc bnc" id="L676" title="All 2 branches missed.">							for (int i = 0; i &lt; agtOrgIdList.size(); i++) {</span>
<span class="nc" id="L677">								double agtMrpSale = 0.0;</span>
<span class="nc" id="L678">								double trainingExpPer = 0.0;</span>
<span class="nc" id="L679">								double trngExpAmt = 0.0;</span>
<span class="nc" id="L680">								double agtExtraMrpSale = 0.0;</span>
<span class="nc" id="L681">								double agtExtraTrainingExpPer = 0.0;</span>
<span class="nc" id="L682">								double trngExtraExpAmt = 0.0;</span>
<span class="nc" id="L683">								double totalTrainingExp = 0.0;</span>
<span class="nc" id="L684">								double incentiveAmt = 0.0;</span>
<span class="nc" id="L685">								double incentivePer = 0.0;</span>
<span class="nc" id="L686">								double incentiveMrp = 0.0;</span>
								
<span class="nc bnc" id="L688" title="All 2 branches missed.">								if(&quot;YES&quot;.equalsIgnoreCase(Utility.getPropertyValue(&quot;IS_DAILY_IW_TRAINING_EXPENSE_ENABLED&quot;))){</span>
<span class="nc" id="L689">									SalePwtReportsBean tempBean = reportMap.get(agtOrgIdList.get(i));</span>
<span class="nc" id="L690">									SalePwtReportsBean tempBeanExtraTraining = reportSaleTimeMap.get(agtOrgIdList.get(i));</span>
<span class="nc bnc" id="L691" title="All 2 branches missed.">									if (tempBean != null) {</span>
<span class="nc" id="L692">										agtMrpSale = tempBean.getSaleMrpAmt();</span>
<span class="nc" id="L693">										trngExpAmt = (agtMrpSale * agtTrngExpMap.get(agtOrgIdList.get(i)) * 0.01);</span>
<span class="nc" id="L694">										agtExtraMrpSale = tempBeanExtraTraining.getSaleMrpAmt();</span>
<span class="nc bnc" id="L695" title="All 2 branches missed.">										if (agtExtraMrpSale &lt; 0) {</span>
<span class="nc" id="L696">											agtExtraMrpSale = 0.0;</span>
										}
<span class="nc" id="L698">										trngExtraExpAmt = (agtExtraMrpSale * agtExtraTrngExpMap.get(agtOrgIdList.get(i)) * 0.01);</span>
<span class="nc" id="L699">										totalTrainingExp = trngExpAmt + trngExtraExpAmt;</span>
<span class="nc" id="L700">										trainingExpPer = agtTrngExpMap.get(agtOrgIdList.get(i));</span>
<span class="nc" id="L701">										agtExtraTrainingExpPer = agtExtraTrngExpMap.get(agtOrgIdList.get(i));</span>
									}
								} 
								
<span class="nc bnc" id="L705" title="All 2 branches missed.">								if(&quot;YES&quot;.equalsIgnoreCase(Utility.getPropertyValue(&quot;IS_DAILY_IW_INCENTIVE_EXPENSE_ENABLED&quot;))){</span>
<span class="nc bnc" id="L706" title="All 4 branches missed.">									if(agentWiseMap != null &amp;&amp; agentWiseMap.containsKey(agtOrgIdList.get(i))){</span>
<span class="nc" id="L707">										incentiveAmt = agentWiseMap.get(agtOrgIdList.get(i)).getIncentiveAmt();</span>
<span class="nc" id="L708">										incentivePer = agentWiseMap.get(agtOrgIdList.get(i)).getIncentivePer();</span>
<span class="nc" id="L709">										incentiveMrp = agentWiseMap.get(agtOrgIdList.get(i)).getIncentiveMrp();</span>
									}
								}
								//System.out.println(&quot; agent_org_id :&quot; + agtOrgIdList.get(i) + &quot; agtMrpSale:&quot; + agtMrpSale + &quot; for the day:&quot; + startDate + &quot; trngExpAmt:&quot; + trngExpAmt + &quot; @: &quot; + agtTrngExpMap.get(agtOrgIdList.get(i)) + &quot; ExtraagtMrpSale:&quot; + agtExtraMrpSale + &quot; for the day:&quot; + startDate + &quot; ExtratrngExpAmt:&quot; + trngExtraExpAmt + &quot; @: &quot; + agtExtraTrngExpMap.get(agtOrgIdList.get(i)));
<span class="nc bnc" id="L713" title="All 4 branches missed.">								if (totalTrainingExp != 0.0 || incentiveAmt &gt; 0.0) {</span>
										// entry into daily training expense table
<span class="nc" id="L715">										pstmt = con.prepareStatement(&quot;insert into st_lms_agent_daily_training_exp(date,agent_org_id, service_id,game_id,mrp_sale,training_exp_per,training_exp_amt,time_slotted_mrp_sale,extra_training_exp_per,extra_training_exp_amt,incentive_mrp,incentive_per,incentive_amt,status) values (?,?,?,?,?,?,?,?,?,?,?,?,?,?)&quot;);</span>
<span class="nc" id="L716">										Calendar tempDate = (Calendar) calLastDate.clone();</span>
<span class="nc" id="L717">										tempDate.set(Calendar.HOUR_OF_DAY, 23);</span>
<span class="nc" id="L718">										tempDate.set(Calendar.MINUTE, 59);</span>
<span class="nc" id="L719">										tempDate.set(Calendar.SECOND, 59);</span>
<span class="nc" id="L720">										Timestamp updateTime = new Timestamp(tempDate.getTimeInMillis());</span>
<span class="nc" id="L721">										pstmt.setTimestamp(1, new Timestamp(calLastDate.getTimeInMillis()));</span>
<span class="nc" id="L722">										pstmt.setInt(2, agtOrgIdList.get(i));</span>
<span class="nc" id="L723">										pstmt.setInt(3, serviceId);</span>
<span class="nc" id="L724">										pstmt.setInt(4, gameNo);</span>
<span class="nc" id="L725">										pstmt.setDouble(5, agtMrpSale);</span>
<span class="nc" id="L726">										pstmt.setDouble(6, trainingExpPer);</span>
<span class="nc" id="L727">										pstmt.setDouble(7, trngExpAmt);</span>
<span class="nc" id="L728">										pstmt.setDouble(8, agtExtraMrpSale);</span>
<span class="nc" id="L729">										pstmt.setDouble(9, agtExtraTrainingExpPer);</span>
<span class="nc" id="L730">										pstmt.setDouble(10, trngExtraExpAmt);</span>
<span class="nc" id="L731">										pstmt.setDouble(11, incentiveMrp);</span>
<span class="nc" id="L732">										pstmt.setDouble(12, incentivePer);</span>
<span class="nc" id="L733">										pstmt.setDouble(13, incentiveAmt);</span>
<span class="nc" id="L734">										pstmt.setString(14, &quot;PENDING&quot;);</span>
<span class="nc" id="L735">										System.out.println(&quot;insertAgtTrngExp&gt;&gt;&quot; + pstmt);</span>
<span class="nc" id="L736">										pstmt.executeUpdate();</span>
<span class="nc" id="L737">										int taskId = 0;</span>
<span class="nc" id="L738">										resultSet = pstmt.getGeneratedKeys();</span>
<span class="nc bnc" id="L739" title="All 2 branches missed.">										if (resultSet.next())</span>
<span class="nc" id="L740">											taskId = resultSet.getInt(1);</span>
<span class="nc bnc" id="L741" title="All 2 branches missed.">										if (&quot;AUTO&quot;.equalsIgnoreCase(trngExpMode)) {</span>
<span class="nc bnc" id="L742" title="All 2 branches missed.">											if(totalTrainingExp != 0.0)</span>
<span class="nc" id="L743">												updateTrngExpAgentData(updateTime, updateTime.toString(), updateTime.toString(), taskId, agtOrgIdList.get(i), totalTrainingExp, userBean, trngExpMode, &quot;DAILY&quot;, gameNo, serviceId, con);</span>
<span class="nc bnc" id="L744" title="All 2 branches missed.">											if(incentiveAmt &gt; 0.0)</span>
<span class="nc" id="L745">												updateAgentDataIWIncentive(updateTime, updateTime.toString(), updateTime.toString(), taskId, agtOrgIdList.get(i), incentiveAmt, userBean, trngExpMode, &quot;DAILY&quot;, gameNo, serviceId, con);</span>
<span class="nc" id="L746">											updateApprovalStatus(taskId,con,&quot;daily&quot;);	</span>
										}
									}
							}
<span class="nc" id="L750">							calLastDate.add(Calendar.DAY_OF_MONTH, 1);</span>
						} else {
<span class="nc" id="L752">							calLastDate.add(Calendar.DAY_OF_MONTH, 1);</span>
						}
<span class="nc" id="L754">					}</span>
<span class="nc" id="L755">				}</span>
<span class="nc" id="L756">				con.commit();</span>
<span class="nc" id="L757">			} catch (SQLException e) {</span>
<span class="nc" id="L758">				logger.info(&quot;SQL Exception &quot;, e);</span>
<span class="nc" id="L759">				throw new LMSException(&quot;SQL Exception &quot; + e.getMessage());</span>
<span class="nc" id="L760">			} catch (Exception e) {</span>
<span class="nc" id="L761">				logger.info(&quot;Exception &quot;, e);</span>
<span class="nc" id="L762">				throw new LMSException(&quot;Exception&quot; + e.getMessage());</span>
			} finally {
<span class="nc" id="L764">				DBConnect.closeCon(con);</span>
<span class="nc" id="L765">			}</span>
<span class="nc" id="L766">	}</span>
	
	public String getPropertyValue(Connection con,String expTime) throws LMSException{
<span class="nc" id="L769">		Statement stmt=null;</span>
<span class="nc" id="L770">		ResultSet rs=null;</span>
<span class="nc" id="L771">		String propertyValue=null;</span>
		try{
<span class="nc" id="L773">			stmt=con.createStatement();</span>
<span class="nc" id="L774">			rs=stmt.executeQuery(&quot;select value from st_lms_property_master_history where property_code='gameWiseSaleSlotTime' and date(update_date)&gt;'&quot;+expTime+&quot;' order by update_date asc limit 1&quot;);</span>
<span class="nc bnc" id="L775" title="All 2 branches missed.">			if(rs.next()){</span>
<span class="nc" id="L776">				propertyValue=rs.getString(&quot;value&quot;);</span>
			}else{
<span class="nc" id="L778">				rs=stmt.executeQuery(&quot;select value from st_lms_property_master where property_dev_name='SALE_SLOT_TIME'&quot;);</span>
<span class="nc bnc" id="L779" title="All 2 branches missed.">				if(rs.next()){</span>
<span class="nc" id="L780">					propertyValue=rs.getString(&quot;value&quot;);</span>
				}else{
<span class="nc" id="L782">					throw new LMSException();</span>
				}
			}
<span class="nc" id="L785">		}catch (SQLException e) {</span>
<span class="nc" id="L786">			e.printStackTrace();</span>
<span class="nc" id="L787">			throw new LMSException();</span>
<span class="nc" id="L788">		}</span>
<span class="nc" id="L789">		return propertyValue;</span>
	}
/**
 * @modified  transaction_id type changed to long from int
 *  By Neeraj
 *
 */
	public void updateTrngExpAgentData(Timestamp updateTime, String fromDate, String toDate, int taskId, int agtOrgId, double trngExpAmt, UserInfoBean userBean, String UpdateMode, String trngExpType,int gameNo, int serviceId, Connection con) throws Exception {
<span class="nc" id="L797">		PreparedStatement pstmt1 = null;</span>
<span class="nc" id="L798">		PreparedStatement pstmt2 = null;</span>
<span class="nc" id="L799">		PreparedStatement pstmt3 = null;</span>
<span class="nc" id="L800">		PreparedStatement pstmt4 = null;</span>
<span class="nc" id="L801">		PreparedStatement pstmt5 = null;</span>
<span class="nc" id="L802">		String reason=&quot;&quot;;</span>
<span class="nc bnc" id="L803" title="All 2 branches missed.">		String transactionType = trngExpAmt &gt; 0.0 ? &quot;CR_NOTE_CASH&quot;:&quot;DR_NOTE_CASH&quot;;</span>
<span class="nc bnc" id="L804" title="All 2 branches missed.">		double unsignTrngAmt =  trngExpAmt &gt; 0.0 ? trngExpAmt : (-1) * trngExpAmt;</span>
<span class="nc bnc" id="L805" title="All 2 branches missed.">		if (&quot;AUTO&quot;.equalsIgnoreCase(UpdateMode)) {</span>
<span class="nc" id="L806">			HttpServletRequest request = new ManualRequest();</span>
<span class="nc" id="L807">			request.setAttribute(&quot;code&quot;, &quot;MGMT&quot;);</span>
<span class="nc" id="L808">			request.setAttribute(&quot;interfaceType&quot;, &quot;WEB&quot;);</span>
<span class="nc" id="L809">			ServletActionContext.setRequest(request);</span>
		}
<span class="nc" id="L811">		String updateQry = null;</span>
		try {
<span class="nc" id="L813">			updateQry = &quot;update st_lms_agent_&quot; + trngExpType.toLowerCase() + &quot;_training_exp set credit_note_number=?, done_by_user_id=?,  updated_date=?, updated_mode=? where service_id = &quot; + serviceId + &quot; and agent_org_id=&quot; + agtOrgId + &quot; and id=&quot; + taskId;	</span>

			/*
			 * String updateBoRecieptGenMapping = QueryManager
			 * .updateST5BOReceiptGenMapping();
			 */
			// insert into LMS transaction master
<span class="nc" id="L820">			String queryLMSTrans = QueryManager.insertInLMSTransactionMaster();</span>
<span class="nc" id="L821">			pstmt1 = con.prepareStatement(queryLMSTrans);</span>
<span class="nc" id="L822">			pstmt1.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L823">			pstmt1.executeUpdate();</span>
<span class="nc" id="L824">			ResultSet rs1 = pstmt1.getGeneratedKeys();</span>
			// int transaction_id = -1;
<span class="nc" id="L826">			long transaction_id =-1;</span>
<span class="nc bnc" id="L827" title="All 2 branches missed.">			if (rs1.next()) {</span>
<span class="nc" id="L828">				transaction_id = rs1.getLong(1);</span>
			} else {
<span class="nc" id="L830">				throw new LMSException(&quot;Transaction id is not generated &quot;);</span>
			}
			
<span class="nc" id="L833">			String updateBoMaster = QueryManager.insertInBOTransactionMaster();</span>
<span class="nc" id="L834">			pstmt1 = con.prepareStatement(updateBoMaster);</span>
<span class="nc" id="L835">			pstmt1.setLong(1, transaction_id);</span>
<span class="nc" id="L836">			pstmt1.setInt(2, userBean.getUserId());</span>
<span class="nc" id="L837">			pstmt1.setInt(3, userBean.getUserOrgId());</span>
<span class="nc" id="L838">			pstmt1.setString(4, &quot;AGENT&quot;);</span>
<span class="nc" id="L839">			pstmt1.setInt(5, agtOrgId);</span>
<span class="nc" id="L840">			pstmt1.setTimestamp(6, updateTime);</span>
<span class="nc" id="L841">			pstmt1.setString(7,transactionType);</span>
<span class="nc" id="L842">			pstmt1.executeUpdate();</span>
<span class="nc" id="L843">			System.out.println(&quot;insertInBOTransactionMaster&gt;&gt;&gt;&quot; + pstmt1);</span>

<span class="nc" id="L845">			String updateCreditNote = &quot;insert into st_lms_bo_credit_note(transaction_id,agent_org_id,amount,transaction_type,remarks,reason) values(?,?,?,?,?,?)&quot;;</span>
<span class="nc" id="L846">			String updateDebitNote = &quot;insert into st_lms_bo_debit_note(transaction_id,agent_org_id,amount,transaction_type,remarks,reason) values(?,?,?,?,?,?)&quot; ;</span>
<span class="nc" id="L847">			String remarks = null;</span>
<span class="nc bnc" id="L848" title="All 2 branches missed.">			if (&quot;weekly&quot;.equalsIgnoreCase(trngExpType)) {</span>
<span class="nc" id="L849">				remarks = &quot;Given as Weekly Training expense for the week from &quot;</span>
						+ fromDate.split(&quot; &quot;)[0] + &quot; to &quot;
						+ toDate.split(&quot; &quot;)[0];
			} else {
<span class="nc" id="L853">				remarks = &quot;Given as Daily Training expense for the day &quot;</span>
						+ fromDate.split(&quot; &quot;)[0];
			}
<span class="nc bnc" id="L856" title="All 2 branches missed.">			if(trngExpAmt &gt; 0.0 ){</span>
<span class="nc" id="L857">				pstmt2 = con.prepareStatement(updateCreditNote);</span>
<span class="nc bnc" id="L858" title="All 2 branches missed.">				if(trngExpType.equalsIgnoreCase(&quot;WEEKLY&quot;))</span>
<span class="nc" id="L859">					reason=&quot;CR_WEEKLY_EXP&quot;;</span>
				else
<span class="nc" id="L861">					reason=&quot;CR_DAILY_EXP&quot;;</span>
			}else{
<span class="nc" id="L863">				pstmt2 = con.prepareStatement(updateDebitNote);</span>
<span class="nc bnc" id="L864" title="All 2 branches missed.">				if(trngExpType.equalsIgnoreCase(&quot;WEEKLY&quot;))</span>
<span class="nc" id="L865">					reason=&quot;DR_WEEKLY_TE_RETURN&quot;;</span>
				else
<span class="nc" id="L867">					reason=&quot;DR_DAILY_TE_RETURN&quot;;</span>
			}
<span class="nc" id="L869">			pstmt2.setLong(1, transaction_id);</span>
<span class="nc" id="L870">			pstmt2.setInt(2, agtOrgId);</span>
<span class="nc" id="L871">			pstmt2.setDouble(3, unsignTrngAmt);</span>
<span class="nc" id="L872">			pstmt2.setString(4, transactionType);</span>
<span class="nc" id="L873">			pstmt2.setString(5, remarks);</span>
<span class="nc" id="L874">			pstmt2.setString(6, reason);</span>
<span class="nc" id="L875">			System.out.println(&quot;st_lms_bo_credit/debit_note&gt;&gt;&gt;&quot; + pstmt2);</span>
<span class="nc" id="L876">			pstmt2.executeUpdate();</span>

<span class="nc" id="L878">			String fetchCreditNoteLastEntryQuery = &quot;SELECT * from st_lms_bo_receipts where receipt_type=? or receipt_type=? ORDER BY generated_id DESC LIMIT 1&quot;;</span>
<span class="nc" id="L879">			pstmt4 = con.prepareStatement(fetchCreditNoteLastEntryQuery);</span>
<span class="nc bnc" id="L880" title="All 2 branches missed.">			if(trngExpAmt &gt; 0.0){</span>
<span class="nc" id="L881">				pstmt4.setString(1, &quot;CR_NOTE_CASH&quot;);</span>
<span class="nc" id="L882">				pstmt4.setString(2, &quot;CR_NOTE&quot;);</span>
			}else{
<span class="nc" id="L884">				pstmt4.setString(1, &quot;DR_NOTE_CASH&quot;);</span>
<span class="nc" id="L885">				pstmt4.setString(2, &quot;DR_NOTE&quot;);</span>
			}
<span class="nc" id="L887">			ResultSet recieptRs = pstmt4.executeQuery();</span>
<span class="nc" id="L888">			String lastRecieptNoGenerated = null;</span>
<span class="nc bnc" id="L889" title="All 2 branches missed.">			if (recieptRs.next()) {</span>
<span class="nc" id="L890">				lastRecieptNoGenerated = recieptRs.getString(&quot;generated_id&quot;);</span>
			}
			// create receipt no.
<span class="nc" id="L893">			String autoGeneRecieptNo = GenerateRecieptNo.getRecieptNo(transactionType, lastRecieptNoGenerated, userBean.getUserType());</span>

			// insert in receipt master table
<span class="nc" id="L896">			pstmt2 = con.prepareStatement(QueryManager.insertInReceiptMaster());</span>
<span class="nc" id="L897">			pstmt2.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L898">			pstmt2.executeUpdate();</span>
<span class="nc" id="L899">			ResultSet rs2 = pstmt2.getGeneratedKeys();</span>
<span class="nc" id="L900">			int id = -1;</span>
<span class="nc bnc" id="L901" title="All 2 branches missed.">			if (rs2.next()) {</span>
<span class="nc" id="L902">				id = rs2.getInt(1);</span>
			} else {
<span class="nc" id="L904">				throw new LMSException(&quot;Error in reciept generation&quot;);</span>
			}

			// insert into BO receipt table
<span class="nc" id="L908">			pstmt2 = con.prepareStatement(QueryManager.insertInBOReceipts());</span>
<span class="nc" id="L909">			pstmt2.setInt(1, id);</span>
<span class="nc" id="L910">			pstmt2.setString(2, transactionType);</span>
<span class="nc" id="L911">			pstmt2.setInt(3, agtOrgId);</span>
<span class="nc" id="L912">			pstmt2.setString(4, &quot;AGENT&quot;);</span>
<span class="nc" id="L913">			pstmt2.setString(5, autoGeneRecieptNo);</span>
<span class="nc" id="L914">			pstmt2.setTimestamp(6, Util.getCurrentTimeStamp());</span>
<span class="nc" id="L915">			System.out.println(&quot;insertInBOReceipts&gt;&gt;&gt;&quot; + pstmt2);</span>
<span class="nc" id="L916">			pstmt2.executeUpdate();</span>

			// insert into receipt transaction mapping
<span class="nc" id="L919">			pstmt3 = con.prepareStatement(QueryManager.insertBOReceiptTrnMapping());</span>
<span class="nc" id="L920">			pstmt3.setInt(1, id);</span>
<span class="nc" id="L921">			pstmt3.setLong(2, transaction_id);</span>
<span class="nc" id="L922">			pstmt3.executeUpdate();</span>

			// update organization account details
			
<span class="nc" id="L926">			boolean isValid=OrgCreditUpdation.updateOrganizationBalWithValidate(unsignTrngAmt, &quot;TRANSACTION&quot;, transactionType, agtOrgId,</span>
					0, &quot;AGENT&quot;, 0, con);
<span class="nc bnc" id="L928" title="All 2 branches missed.">			if(!isValid)</span>
<span class="nc" id="L929">				throw new LMSException();</span>
			
			
			/*OrgCreditUpdation.updateCreditLimitForAgent(agtOrgId,
					transactionType, unsignTrngAmt, con);*/

			// update training expense table

<span class="nc" id="L937">			pstmt5 = con.prepareStatement(updateQry);</span>
<span class="nc" id="L938">			pstmt5.setString(1, autoGeneRecieptNo);</span>
<span class="nc" id="L939">			pstmt5.setInt(2, userBean.getUserId());</span>
			//pstmt5.setString(3, &quot;DONE&quot;);
<span class="nc" id="L941">			pstmt5.setTimestamp(3, updateTime);</span>
<span class="nc" id="L942">			pstmt5.setString(4, UpdateMode);</span>
<span class="nc" id="L943">			System.out.println(&quot;updating training Expense table.&gt;&gt;&gt;&gt;&quot; + pstmt5);</span>
<span class="nc bnc" id="L944" title="All 2 branches missed.">			if (pstmt5.executeUpdate() &lt; 1) {</span>
<span class="nc" id="L945">				throw new LMSException(&quot;training expense table not updated&quot;);</span>
			}
			// following code is commented temp....
			/*
			 * GraphReportHelper graphReportHelper = new GraphReportHelper();
			 * graphReportHelper.createTextReportBO(id, parentOrgName,
			 * userOrgID, (String) session.getAttribute(&quot;ROOT_PATH&quot;));
			 */
<span class="nc" id="L953">		} catch (Exception e) {</span>
<span class="nc" id="L954">			e.printStackTrace();</span>
<span class="nc" id="L955">		}</span>

<span class="nc" id="L957">	}</span>

	public void submitWeeklyTrngExpForAgents()	throws Exception {
<span class="nc" id="L960">		Connection con = null;</span>
<span class="nc" id="L961">		Statement statement = null;</span>
<span class="nc" id="L962">		Statement stmt = null;</span>
<span class="nc" id="L963">		ResultSet rs = null;</span>
<span class="nc" id="L964">		ResultSet resultSet = null;</span>
<span class="nc" id="L965">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L966">		int serviceId = Util.getServiceIdFormCode(&quot;DG&quot;);</span>
		try {
<span class="nc" id="L968">			String isweeklyTrngExp = Utility.getPropertyValue(&quot;IS_WEEKLY_TRAINING_EXP&quot;);// (String)sc.getAttribute(&quot;IS_WEEKLY_TRAINING_EXP&quot;);</span>
<span class="nc bnc" id="L969" title="All 2 branches missed.">			if (&quot;YES&quot;.equalsIgnoreCase(isweeklyTrngExp)) {</span>
<span class="nc" id="L970">				String trngExpMode = Utility.getPropertyValue(&quot;WEEKLY_TRAINING_EXP_MODE&quot;);// (String)sc.getAttribute(&quot;WEEKLY_TRAINING_EXP_MODE&quot;);</span>
<span class="nc" id="L971">				con = DBConnect.getConnection();</span>

<span class="nc" id="L973">				UserInfoBean userBean = new UserInfoBean();</span>
<span class="nc" id="L974">				statement = con.createStatement();</span>
<span class="nc bnc" id="L975" title="All 2 branches missed.">				if (&quot;AUTO&quot;.equalsIgnoreCase(trngExpMode)) {</span>
<span class="nc" id="L976">					resultSet = statement.executeQuery(&quot;select user_id,organization_id,organization_type from st_lms_user_master where user_name='bomaster'&quot;);</span>
<span class="nc bnc" id="L977" title="All 2 branches missed.">					if (resultSet.next()) {</span>
<span class="nc" id="L978">						userBean.setUserOrgId(resultSet.getInt(TableConstants.ORGANIZATION_ID));</span>
<span class="nc" id="L979">						userBean.setUserId(resultSet.getInt(TableConstants.USER_ID));</span>
<span class="nc" id="L980">						userBean.setUserType(resultSet.getString(TableConstants.ORG_TYPE));</span>
					}
				}
<span class="nc" id="L983">				DBConnect.closeRs(resultSet);</span>
<span class="nc" id="L984">				con.setAutoCommit(false);</span>
<span class="nc" id="L985">				stmt = con.createStatement();</span>
<span class="nc" id="L986">				rs = stmt.executeQuery(&quot;select game_id from st_dg_game_master  where game_status &lt;&gt; 'SALE_CLOSE' &quot;);</span>
<span class="nc" id="L987">				SimpleDateFormat simpleDateFormat = new SimpleDateFormat(&quot;HH:mm:ss&quot;, Locale.ROOT);</span>
<span class="nc" id="L988">				simpleDateFormat.setTimeZone(TimeZone.getTimeZone(&quot;UTC&quot;));</span>
<span class="nc bnc" id="L989" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L990">					int gameNo = rs.getInt(&quot;game_id&quot;);</span>
					// ResultSet resultSet = null;
<span class="nc" id="L992">					Timestamp weekStartDate = null;</span>
<span class="nc" id="L993">					Timestamp weekEndDate = null;</span>
<span class="nc" id="L994">					Timestamp updateTime = null;</span>
<span class="nc" id="L995">					Calendar cal = Calendar.getInstance();</span>
<span class="nc" id="L996">					cal.add(Calendar.DAY_OF_MONTH, -7);// done for rescheduling of training expanses at 12:15 AM</span>
<span class="nc" id="L997">					Date lastDateDone = new java.sql.Date(cal.getTimeInMillis());</span>

<span class="nc" id="L999">					Calendar calLastDate = Calendar.getInstance();</span>
<span class="nc" id="L1000">					Calendar calStartDate = Calendar.getInstance();</span>
<span class="nc" id="L1001">					calStartDate.setTime(lastDateDone);</span>
<span class="nc" id="L1002">					pstmt = con.prepareStatement(&quot;select date(date) date from st_lms_agent_weekly_training_exp where service_id = &quot;+serviceId+&quot; and game_id= &quot; + gameNo + &quot; order by date desc limit 1&quot;);</span>
<span class="nc" id="L1003">					resultSet = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1004" title="All 2 branches missed.">					if (resultSet.next()) {</span>
<span class="nc" id="L1005">						lastDateDone = resultSet.getDate(&quot;date&quot;);</span>
<span class="nc" id="L1006">						calLastDate.setTime(lastDateDone);</span>
<span class="nc" id="L1007">						logger.info(&quot;last weekly training exapnses given for &quot; + lastDateDone);</span>
					} else {
<span class="nc" id="L1009">						logger.info(&quot;weekly training expanses generating first time&quot;);</span>
<span class="nc" id="L1010">						calLastDate.setTime(lastDateDone);</span>
						// first time destribution of training expenses
					}
<span class="nc" id="L1013">					logger.info(&quot;calLastDate&quot; + calLastDate.getTime() + &quot; calStratDate&quot; + calStartDate.getTime() + &quot; diff...&quot; + calLastDate.compareTo(calStartDate));</span>
<span class="nc" id="L1014">					DBConnect.closeRs(resultSet);</span>
<span class="nc" id="L1015">					SimpleDateFormat sdf = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span>

<span class="nc" id="L1017">					Calendar startDate = Calendar.getInstance();</span>
<span class="nc" id="L1018">					Calendar endDate = Calendar.getInstance();</span>
					// while
					
<span class="nc bnc" id="L1021" title="All 2 branches missed.">					while (calLastDate.compareTo(calStartDate) &lt;= 0) {</span>
<span class="nc" id="L1022">						Map&lt;Integer, SalePwtReportsBean&gt; totalreportSaleTimeMap = new HashMap&lt;Integer, SalePwtReportsBean&gt;();</span>
<span class="nc" id="L1023">						long lastTime = sdf.parse(sdf.format(calLastDate.getTime())).getTime();</span>
<span class="nc" id="L1024">						weekStartDate = new Timestamp(lastTime);</span>
<span class="nc" id="L1025">						weekEndDate = new Timestamp(lastTime + 24 * 7 * 60 * 60 * 1000 - 1000);</span>
<span class="nc" id="L1026">						updateTime = new Timestamp(lastTime + 24 * 7 * 60 * 60 * 1000);</span>
<span class="nc" id="L1027">						startDate.setTimeInMillis(lastTime);</span>
<span class="nc" id="L1028">						endDate.setTimeInMillis(lastTime + 24 * 7 * 60 * 60 * 1000 - 1000);</span>
<span class="nc" id="L1029">						Map&lt;Integer, SalePwtReportsBean&gt; reportMap = drawSaleAgentWiseNew(weekStartDate, weekEndDate, gameNo);</span>
<span class="nc" id="L1030">						Map&lt;Integer, Double&gt; agtTrngExpMap = fetchTrainingExp(&quot;weekly&quot;, sdf.format(weekEndDate.getTime()), gameNo, serviceId);</span>
<span class="nc" id="L1031">						Map&lt;Integer, Double&gt; agtExtraTrngExpMap = fetchExtraTrainingExp(&quot;weekly&quot;, sdf.format(weekEndDate.getTime()), gameNo, serviceId, con);</span>
<span class="nc" id="L1032">						List&lt;Integer&gt; agtOrgIdList = new ArrayList&lt;Integer&gt;();</span>
<span class="nc" id="L1033">						agtOrgIdList.addAll(agtTrngExpMap.keySet());</span>
<span class="nc bnc" id="L1034" title="All 2 branches missed.">						while (startDate.compareTo(endDate) &lt;= 0) {</span>
<span class="nc" id="L1035">							String propertyValue = getPropertyValue(con, sdf.format(startDate.getTime()));</span>
							// 1#14:00:00_16:00:00~2#00:00:00_00:00:00

<span class="nc" id="L1038">							String[] gameWiseTimingArr = propertyValue.split(&quot;~&quot;);</span>
<span class="nc" id="L1039">							logger.debug(&quot;prop value&quot; + propertyValue);</span>
<span class="nc" id="L1040">							Map&lt;Integer, String&gt; gameSlotTimingMap = new HashMap&lt;Integer, String&gt;();</span>
<span class="nc bnc" id="L1041" title="All 2 branches missed.">							for (String gameWiseTiming : gameWiseTimingArr) {</span>
<span class="nc" id="L1042">								gameSlotTimingMap.put(Integer.parseInt(gameWiseTiming.split(&quot;#&quot;)[0]), gameWiseTiming.split(&quot;#&quot;)[1]);</span>
							}

<span class="nc" id="L1045">							String slotTiming = gameSlotTimingMap.get(gameNo);</span>

<span class="nc" id="L1047">							long startTimeSlot = simpleDateFormat.parse(slotTiming.split(&quot;_&quot;)[0]).getTime();</span>
<span class="nc" id="L1048">							long endTimeSlot = simpleDateFormat.parse(slotTiming.split(&quot;_&quot;)[1]).getTime();</span>

<span class="nc" id="L1050">							Timestamp startTimeSale = new Timestamp(sdf.parse(sdf.format(startDate.getTime())).getTime() + startTimeSlot);</span>
<span class="nc" id="L1051">							Timestamp endTimeSale = new Timestamp(sdf.parse(sdf.format(startDate.getTime())).getTime() + endTimeSlot);</span>

<span class="nc" id="L1053">							Map&lt;Integer, SalePwtReportsBean&gt; reportSaleTimeMap = drawSaleAgentWiseWeeklyTimeWiseNew(startTimeSale, endTimeSale, weekStartDate, weekEndDate, gameNo);</span>

<span class="nc" id="L1055">							Iterator itr = reportSaleTimeMap.entrySet().iterator();</span>
<span class="nc bnc" id="L1056" title="All 2 branches missed.">							while (itr.hasNext()) {</span>
<span class="nc" id="L1057">								Map.Entry&lt;Integer, SalePwtReportsBean&gt; entry = (Map.Entry&lt;Integer, SalePwtReportsBean&gt;) itr.next();</span>

<span class="nc bnc" id="L1059" title="All 2 branches missed.">								if (totalreportSaleTimeMap.containsKey(entry.getKey())) {</span>
<span class="nc" id="L1060">									SalePwtReportsBean bean = totalreportSaleTimeMap.get(entry.getKey());</span>
<span class="nc" id="L1061">									bean.setSaleMrpAmt(bean.getSaleMrpAmt() + reportSaleTimeMap.get(entry.getKey()).getSaleMrpAmt());</span>
<span class="nc" id="L1062">									bean.setSaleNetAmt(bean.getSaleNetAmt() + reportSaleTimeMap.get(entry.getKey()).getSaleNetAmt());</span>
<span class="nc" id="L1063">								} else {</span>
<span class="nc" id="L1064">									totalreportSaleTimeMap.put(entry.getKey(), entry.getValue());</span>
								}
<span class="nc" id="L1066">							}</span>
<span class="nc" id="L1067">							startDate.add(Calendar.DAY_OF_MONTH, 1);</span>
<span class="nc" id="L1068">						}</span>

<span class="nc" id="L1070">						logger.debug(&quot;total no. of agents &quot; + agtOrgIdList.size());</span>
<span class="nc bnc" id="L1071" title="All 2 branches missed.">						if (agtOrgIdList.size() &gt; 0) {</span>
<span class="nc" id="L1072">							pstmt = con.prepareStatement(&quot;select date from st_lms_agent_weekly_training_exp tes where date(tes.date)=date('&quot; + updateTime + &quot;') and service_id = &quot;+serviceId+&quot; and game_id=&quot; + gameNo);</span>
<span class="nc" id="L1073">							resultSet = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1074" title="All 2 branches missed.">							if (resultSet.next()) {</span>
<span class="nc" id="L1075">								throw new LMSException(&quot;Weekly expanses already given for this Week ... &quot;);</span>
							}
<span class="nc" id="L1077">							DBConnect.closeRs(resultSet);</span>
<span class="nc bnc" id="L1078" title="All 2 branches missed.">							for (int i = 0; i &lt; agtOrgIdList.size(); i++) {</span>
<span class="nc" id="L1079">								SalePwtReportsBean tempBean = reportMap.get(agtOrgIdList.get(i));</span>
<span class="nc" id="L1080">								SalePwtReportsBean tempBeanExtraTraining = totalreportSaleTimeMap.get(agtOrgIdList.get(i));</span>

<span class="nc bnc" id="L1082" title="All 2 branches missed.">								if (tempBean != null) {</span>
<span class="nc" id="L1083">									double agtMrpSale = tempBean.getSaleMrpAmt();</span>
<span class="nc" id="L1084">									double trngExpAmt = (agtMrpSale * agtTrngExpMap.get(agtOrgIdList.get(i)) * 0.01);</span>
<span class="nc" id="L1085">									double agtExtraMrpSale = tempBeanExtraTraining.getSaleMrpAmt();</span>

<span class="nc bnc" id="L1087" title="All 2 branches missed.">									if (agtExtraMrpSale &lt; 0) {</span>
<span class="nc" id="L1088">										agtExtraMrpSale = 0.0;</span>
									}
<span class="nc" id="L1090">									double trngExtraExpAmt = (agtExtraMrpSale * agtExtraTrngExpMap.get(agtOrgIdList.get(i)) * 0.01);</span>

<span class="nc" id="L1092">									logger.debug(&quot; agent_org_id :&quot; + agtOrgIdList.get(i) + &quot; agtMrpSale:&quot; + agtMrpSale + &quot; for the day:&quot; + startDate + &quot; trngExpAmt:&quot; + trngExpAmt + &quot; @: &quot; + agtTrngExpMap.get(agtOrgIdList.get(i)) + &quot; ExtraagtMrpSale:&quot; + agtExtraMrpSale + &quot; for the day:&quot; + startDate + &quot; ExtratrngExpAmt:&quot; + trngExtraExpAmt + &quot; @: &quot; + agtExtraTrngExpMap.get(agtOrgIdList.get(i)));</span>

<span class="nc" id="L1094">									double totalTrainingExp = trngExpAmt + trngExtraExpAmt;</span>

<span class="nc bnc" id="L1096" title="All 2 branches missed.">									if (totalTrainingExp &gt; 0.0) {</span>
										// entry into weekly training expense table
<span class="nc" id="L1098">										pstmt = con.prepareStatement(QueryManager.insertAgtWeeklyTrngExp());</span>
										/*
										 * Calendar tempDate = (Calendar)calLastDate.clone();
										 * tempDate.add(Calendar.DAY_OF_MONTH,1);
										 * tempDate.set(Calendar.HOUR_OF_DAY,00);
										 * tempDate.set(Calendar.MINUTE,00);
										 * tempDate.set(Calendar.SECOND,00);
										 */
										// Timestamp updateTime = new
										// Timestamp(tempDate.getTimeInMillis());
<span class="nc" id="L1108">										pstmt.setTimestamp(1, updateTime);</span>
<span class="nc" id="L1109">										pstmt.setInt(2, agtOrgIdList.get(i));</span>
<span class="nc" id="L1110">										pstmt.setInt(3, serviceId);</span>
<span class="nc" id="L1111">										pstmt.setInt(4, gameNo);</span>
<span class="nc" id="L1112">										pstmt.setDouble(5, agtMrpSale);</span>
<span class="nc" id="L1113">										pstmt.setDouble(6, agtTrngExpMap.get(agtOrgIdList.get(i)));</span>
<span class="nc" id="L1114">										pstmt.setDouble(7, trngExpAmt);</span>
<span class="nc" id="L1115">										pstmt.setDouble(8, agtExtraMrpSale);</span>
<span class="nc" id="L1116">										pstmt.setDouble(9, agtExtraTrngExpMap.get(agtOrgIdList.get(i)));</span>
<span class="nc" id="L1117">										pstmt.setDouble(10, trngExtraExpAmt);</span>
<span class="nc" id="L1118">										pstmt.setString(11, &quot;PENDING&quot;);</span>
<span class="nc" id="L1119">										logger.info(&quot;insertAgtTrngExp&gt;&gt;&quot; + pstmt);</span>
<span class="nc" id="L1120">										pstmt.executeUpdate();</span>
<span class="nc" id="L1121">										int taskId = 0;</span>
<span class="nc" id="L1122">										resultSet = pstmt.getGeneratedKeys();</span>

<span class="nc bnc" id="L1124" title="All 2 branches missed.">										if (resultSet.next())</span>
<span class="nc" id="L1125">											taskId = resultSet.getInt(1);</span>
<span class="nc bnc" id="L1126" title="All 2 branches missed.">										if (&quot;AUTO&quot;.equalsIgnoreCase(trngExpMode)) {</span>
<span class="nc" id="L1127">											updateTrngExpAgentData(updateTime, new Timestamp(sdf.parse(sdf.format(startDate.getTime())).getTime()).toString(), new Timestamp(sdf.parse(sdf.format(endDate.getTime())).getTime()).toString(), taskId, agtOrgIdList.get(i), totalTrainingExp, userBean, trngExpMode, &quot;WEEKLY&quot;, gameNo, serviceId, con);</span>
<span class="nc" id="L1128">											updateApprovalStatus(taskId,con,&quot;weekly&quot;);	</span>
										}
									}
								}
							}
<span class="nc" id="L1133">							calLastDate.add(Calendar.DAY_OF_MONTH, 7);</span>
						} else {
<span class="nc" id="L1135">							calLastDate.add(Calendar.DAY_OF_MONTH, 7);</span>
						}
<span class="nc" id="L1137">					}</span>
<span class="nc" id="L1138">				}</span>
<span class="nc" id="L1139">				con.commit();</span>
			}
<span class="nc" id="L1141">		} catch (SQLException e) {</span>
<span class="nc" id="L1142">			logger.info(&quot;SQL Exception &quot;, e);</span>
<span class="nc" id="L1143">			throw new LMSException(&quot;SQL Exception &quot; + e.getMessage());</span>
<span class="nc" id="L1144">		} catch (Exception e) {</span>
<span class="nc" id="L1145">			logger.info(&quot;Exception &quot;, e);</span>
<span class="nc" id="L1146">			throw new LMSException(&quot;Exception&quot; + e.getMessage());</span>
		} finally {
<span class="nc" id="L1148">			DBConnect.closeRs(resultSet);</span>
<span class="nc" id="L1149">			DBConnect.closeRs(rs);</span>
<span class="nc" id="L1150">			DBConnect.closePstmt(pstmt);</span>
<span class="nc" id="L1151">			DBConnect.closeStmt(stmt);</span>
<span class="nc" id="L1152">			DBConnect.closeStmt(statement);</span>
<span class="nc" id="L1153">			DBConnect.closeCon(con);</span>
<span class="nc" id="L1154">		}</span>
<span class="nc" id="L1155">	}</span>
	
	public void submitWeeklyTrngExpInstantWinForAgents() throws Exception {
<span class="nc" id="L1158">		Connection con = null;</span>
<span class="nc" id="L1159">		Statement statement = null;</span>
<span class="nc" id="L1160">		Statement stmt = null;</span>
<span class="nc" id="L1161">		ResultSet rs = null;</span>
<span class="nc" id="L1162">		ResultSet resultSet = null;</span>
<span class="nc" id="L1163">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L1164">		String response = null;</span>
<span class="nc" id="L1165">		Map&lt;Integer, IWIncentiveDataBean&gt; agentWiseMap = null;</span>
<span class="nc" id="L1166">		int serviceId = Util.getServiceIdFormCode(&quot;IW&quot;);</span>
<span class="nc" id="L1167">		Map&lt;Integer, SalePwtReportsBean&gt; reportMap = null;</span>
<span class="nc" id="L1168">		Map&lt;Integer, SalePwtReportsBean&gt; totalreportSaleTimeMap = null;</span>
<span class="nc" id="L1169">		Map&lt;Integer, Double&gt; agtTrngExpMap = null;</span>
<span class="nc" id="L1170">		Map&lt;Integer, Double&gt; agtExtraTrngExpMap = null;</span>
		try {
<span class="nc" id="L1172">				String trngExpMode = Utility.getPropertyValue(&quot;WEEKLY_TRAINING_EXP_MODE&quot;);// (String)sc.getAttribute(&quot;WEEKLY_TRAINING_EXP_MODE&quot;);</span>
<span class="nc" id="L1173">				con = DBConnect.getConnection();</span>
<span class="nc" id="L1174">				UserInfoBean userBean = new UserInfoBean();</span>
<span class="nc" id="L1175">				statement = con.createStatement();</span>
				
<span class="nc bnc" id="L1177" title="All 2 branches missed.">				if (&quot;AUTO&quot;.equalsIgnoreCase(trngExpMode)) {</span>
<span class="nc" id="L1178">					resultSet = statement.executeQuery(&quot;select user_id,organization_id,organization_type from st_lms_user_master where user_name='bomaster'&quot;);</span>
<span class="nc bnc" id="L1179" title="All 2 branches missed.">					if (resultSet.next()) {</span>
<span class="nc" id="L1180">						userBean.setUserOrgId(resultSet.getInt(TableConstants.ORGANIZATION_ID));</span>
<span class="nc" id="L1181">						userBean.setUserId(resultSet.getInt(TableConstants.USER_ID));</span>
<span class="nc" id="L1182">						userBean.setUserType(resultSet.getString(TableConstants.ORG_TYPE));</span>
					}
				}
<span class="nc" id="L1185">				DBConnect.closeRs(resultSet);</span>
<span class="nc" id="L1186">				con.setAutoCommit(false);</span>
<span class="nc" id="L1187">				stmt = con.createStatement();</span>
<span class="nc" id="L1188">				rs = stmt.executeQuery(&quot;select game_id from st_iw_game_master  where game_status &lt;&gt; 'SALE_CLOSE' &quot;);</span>
<span class="nc" id="L1189">				SimpleDateFormat simpleDateFormat = new SimpleDateFormat(&quot;HH:mm:ss&quot;, Locale.ROOT);</span>
<span class="nc" id="L1190">				simpleDateFormat.setTimeZone(TimeZone.getTimeZone(&quot;UTC&quot;));</span>
<span class="nc bnc" id="L1191" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L1192">					int gameNo = rs.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L1193">					Timestamp weekStartDate = null;</span>
<span class="nc" id="L1194">					Timestamp weekEndDate = null;</span>
<span class="nc" id="L1195">					Timestamp updateTime = null;</span>
<span class="nc" id="L1196">					Calendar cal = Calendar.getInstance();</span>
<span class="nc" id="L1197">					cal.add(Calendar.DAY_OF_MONTH, -7);// done for rescheduling of training expanses at 12:15 AM</span>
<span class="nc" id="L1198">					Date lastDateDone = new java.sql.Date(cal.getTimeInMillis());</span>

<span class="nc" id="L1200">					Calendar calLastDate = Calendar.getInstance();</span>
<span class="nc" id="L1201">					Calendar calStartDate = Calendar.getInstance();</span>
<span class="nc" id="L1202">					calStartDate.setTime(lastDateDone);</span>
<span class="nc" id="L1203">					pstmt = con.prepareStatement(&quot;select date(date) date from st_lms_agent_weekly_training_exp where service_id = &quot;+serviceId+&quot; and game_id=&quot; + gameNo + &quot; order by date desc limit 1&quot;);</span>
<span class="nc" id="L1204">					resultSet = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1205" title="All 2 branches missed.">					if (resultSet.next()) {</span>
<span class="nc" id="L1206">						lastDateDone = resultSet.getDate(&quot;date&quot;);</span>
<span class="nc" id="L1207">						calLastDate.setTime(lastDateDone);</span>
<span class="nc" id="L1208">						logger.info(&quot;last weekly training expenses of IW given for &quot; + lastDateDone);</span>
					} else {
<span class="nc" id="L1210">						logger.info(&quot;weekly training expanses generating first time for IW&quot;);</span>
<span class="nc" id="L1211">						calLastDate.setTime(lastDateDone);</span>
						// first time destribution of training expenses
					}
<span class="nc" id="L1214">					logger.info(&quot;calLastDate&quot; + calLastDate.getTime() + &quot; calStratDate&quot; + calStartDate.getTime() + &quot; diff...&quot; + calLastDate.compareTo(calStartDate));</span>
<span class="nc" id="L1215">					DBConnect.closeRs(resultSet);</span>
<span class="nc" id="L1216">					SimpleDateFormat sdf = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span>

<span class="nc" id="L1218">					Calendar startDate = Calendar.getInstance();</span>
<span class="nc" id="L1219">					Calendar endDate = Calendar.getInstance();</span>
					// while
<span class="nc bnc" id="L1221" title="All 2 branches missed.">					while (calLastDate.compareTo(calStartDate) &lt;= 0) {</span>
<span class="nc" id="L1222">						long lastTime = sdf.parse(sdf.format(calLastDate.getTime())).getTime();</span>
<span class="nc" id="L1223">						updateTime = new Timestamp(lastTime + 24 * 7 * 60 * 60 * 1000);</span>
<span class="nc" id="L1224">						weekStartDate = new Timestamp(lastTime);</span>
<span class="nc" id="L1225">						weekEndDate = new Timestamp(lastTime + 24 * 7 * 60 * 60 * 1000 - 1000);</span>
<span class="nc" id="L1226">						List&lt;Integer&gt; agtOrgIdList = new ArrayList&lt;Integer&gt;();</span>
						
<span class="nc bnc" id="L1228" title="All 2 branches missed.">						if(&quot;YES&quot;.equalsIgnoreCase(Utility.getPropertyValue(&quot;IS_WEEKLY_IW_INCENTIVE_EXPENSE_ENABLED&quot;))){</span>
<span class="nc" id="L1229">							ServiceRequest serviceRequest = new ServiceRequest();</span>
<span class="nc" id="L1230">							serviceRequest.setServiceName(&quot;/retailer/terminal/&quot;);</span>
<span class="nc" id="L1231">							serviceRequest.setServiceMethod(&quot;BORetailerDataCall&quot;);</span>
<span class="nc" id="L1232">							serviceRequest.setServiceData(&quot;?fromDate=&quot;+URLEncoder.encode(String.valueOf(weekStartDate), &quot;UTF-8&quot;)+&quot;&amp;toDate=&quot;+URLEncoder.encode(String.valueOf(weekEndDate), &quot;UTF-8&quot;));</span>
							//serviceRequest.setServiceData(&quot;?fromDate=&quot;+URLEncoder.encode(&quot;2016-03-07 00:00:00&quot;, &quot;UTF-8&quot;)+&quot;&amp;toDate=&quot;+URLEncoder.encode(&quot;2016-03-14 23:59:59&quot;, &quot;UTF-8&quot;));
<span class="nc" id="L1234">							response = ServiceDelegateIW.getInstance().getResponseStringForTrainingExpense(serviceRequest);</span>
							//response = &quot;{  \&quot;responseCode\&quot;: \&quot;0\&quot;,  \&quot;dataArray\&quot;: [    {      \&quot;winning\&quot;: 0,      \&quot;userName\&quot;: \&quot;testr1\&quot;,      \&quot;sale\&quot;: 400    },    {      \&quot;winning\&quot;: 4050,      \&quot;userName\&quot;: \&quot;TEEJAY006\&quot;,      \&quot;sale\&quot;: 5670    }  ],  \&quot;responseMsg\&quot;: \&quot;Success\&quot;}&quot;;
<span class="nc bnc" id="L1236" title="All 2 branches missed.">							if (response == null) {</span>
<span class="nc" id="L1237">								throw new LMSException(LMSErrors.GENERAL_EXCEPTION_ERROR_CODE, LMSErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
							}
<span class="nc" id="L1239">							IWTrainingExpBean bean = new Gson().fromJson(response, new TypeToken&lt;IWTrainingExpBean&gt;() {}.getType());</span>
<span class="nc bnc" id="L1240" title="All 4 branches missed.">							if(&quot;success&quot;.equalsIgnoreCase(bean.getResponseMsg()) &amp;&amp; bean.getDataArray().size() &gt; 0){</span>
									//prepareDataRecord(con, bean.getDataArray());
<span class="nc" id="L1242">									agentWiseMap = clubDataAgentWise(con, bean.getDataArray(), gameNo, serviceId, &quot;weekly&quot;, weekStartDate, weekEndDate);</span>
<span class="nc bnc" id="L1243" title="All 2 branches missed.">									if(agentWiseMap.size() &gt; 0)</span>
<span class="nc" id="L1244">										agtOrgIdList.addAll(agentWiseMap.keySet());</span>
							}
							
						}
						
<span class="nc bnc" id="L1249" title="All 2 branches missed.">						if(&quot;YES&quot;.equalsIgnoreCase(Utility.getPropertyValue(&quot;IS_WEEKLY_IW_TRAINING_EXPENSE_ENABLED&quot;))){</span>
<span class="nc" id="L1250">							totalreportSaleTimeMap = new HashMap&lt;Integer, SalePwtReportsBean&gt;();</span>
<span class="nc" id="L1251">							startDate.setTimeInMillis(lastTime);</span>
<span class="nc" id="L1252">							endDate.setTimeInMillis(lastTime + 24 * 7 * 60 * 60 * 1000 - 1000);</span>
<span class="nc" id="L1253">							reportMap = iwSaleAgentWiseNew(weekStartDate, weekEndDate, gameNo);</span>
<span class="nc" id="L1254">							agtTrngExpMap = fetchTrainingExp(&quot;weekly&quot;, sdf.format(weekEndDate.getTime()), gameNo, serviceId);</span>
<span class="nc" id="L1255">							agtExtraTrngExpMap = fetchExtraTrainingExp(&quot;weekly&quot;, sdf.format(weekEndDate.getTime()), gameNo, serviceId, con);</span>
<span class="nc bnc" id="L1256" title="All 2 branches missed.">							if(agtOrgIdList.size() &lt; 1)</span>
<span class="nc" id="L1257">								agtOrgIdList.addAll(agtTrngExpMap.keySet());</span>
							
<span class="nc bnc" id="L1259" title="All 2 branches missed.">							while (startDate.compareTo(endDate) &lt;= 0) {</span>
<span class="nc" id="L1260">								String propertyValue = getPropertyValue(con, sdf.format(startDate.getTime()));</span>
								// 1#14:00:00_16:00:00~2#00:00:00_00:00:00

<span class="nc" id="L1263">								String[] gameWiseTimingArr = propertyValue.split(&quot;~&quot;);</span>
<span class="nc" id="L1264">								logger.debug(&quot;prop value&quot; + propertyValue);</span>
<span class="nc" id="L1265">								Map&lt;Integer, String&gt; gameSlotTimingMap = new HashMap&lt;Integer, String&gt;();</span>
<span class="nc bnc" id="L1266" title="All 2 branches missed.">								for (String gameWiseTiming : gameWiseTimingArr) {</span>
<span class="nc" id="L1267">									gameSlotTimingMap.put(Integer.parseInt(gameWiseTiming.split(&quot;#&quot;)[0]), gameWiseTiming.split(&quot;#&quot;)[1]);</span>
								}

<span class="nc" id="L1270">								String slotTiming = gameSlotTimingMap.get(gameNo);</span>

<span class="nc" id="L1272">								long startTimeSlot = simpleDateFormat.parse(slotTiming.split(&quot;_&quot;)[0]).getTime();</span>
<span class="nc" id="L1273">								long endTimeSlot = simpleDateFormat.parse(slotTiming.split(&quot;_&quot;)[1]).getTime();</span>

<span class="nc" id="L1275">								Timestamp startTimeSale = new Timestamp(sdf.parse(sdf.format(startDate.getTime())).getTime() + startTimeSlot);</span>
<span class="nc" id="L1276">								Timestamp endTimeSale = new Timestamp(sdf.parse(sdf.format(startDate.getTime())).getTime() + endTimeSlot);</span>

<span class="nc" id="L1278">								Map&lt;Integer, SalePwtReportsBean&gt; reportSaleTimeMap = iwSaleAgentWiseWeeklyTimeWiseNew(startTimeSale, endTimeSale, weekStartDate, weekEndDate, gameNo);</span>

<span class="nc" id="L1280">								Iterator itr = reportSaleTimeMap.entrySet().iterator();</span>
<span class="nc bnc" id="L1281" title="All 2 branches missed.">								while (itr.hasNext()) {</span>
<span class="nc" id="L1282">									Map.Entry&lt;Integer, SalePwtReportsBean&gt; entry = (Map.Entry&lt;Integer, SalePwtReportsBean&gt;) itr.next();</span>

<span class="nc bnc" id="L1284" title="All 2 branches missed.">									if (totalreportSaleTimeMap.containsKey(entry.getKey())) {</span>
<span class="nc" id="L1285">										SalePwtReportsBean bean = totalreportSaleTimeMap.get(entry.getKey());</span>
<span class="nc" id="L1286">										bean.setSaleMrpAmt(bean.getSaleMrpAmt() + reportSaleTimeMap.get(entry.getKey()).getSaleMrpAmt());</span>
<span class="nc" id="L1287">										bean.setSaleNetAmt(bean.getSaleNetAmt() + reportSaleTimeMap.get(entry.getKey()).getSaleNetAmt());</span>
<span class="nc" id="L1288">									} else {</span>
<span class="nc" id="L1289">										totalreportSaleTimeMap.put(entry.getKey(), entry.getValue());</span>
									}
<span class="nc" id="L1291">								}</span>
<span class="nc" id="L1292">								startDate.add(Calendar.DAY_OF_MONTH, 1);</span>
<span class="nc" id="L1293">							}</span>

						}
<span class="nc" id="L1296">						logger.debug(&quot;total no. of agents &quot; + agtOrgIdList.size());</span>
<span class="nc bnc" id="L1297" title="All 2 branches missed.">						if (agtOrgIdList.size() &gt; 0) {</span>
<span class="nc" id="L1298">							pstmt = con.prepareStatement(&quot;select date from st_lms_agent_weekly_training_exp tes where date(tes.date)=date('&quot; + updateTime + &quot;') and service_id = &quot;+serviceId+&quot; and game_id=&quot; + gameNo);</span>
<span class="nc" id="L1299">							resultSet = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1300" title="All 2 branches missed.">							if (resultSet.next()) {</span>
<span class="nc" id="L1301">								throw new LMSException(&quot;Weekly expanses already given for this Week ... &quot;);</span>
							}
<span class="nc" id="L1303">							DBConnect.closeRs(resultSet);</span>
<span class="nc bnc" id="L1304" title="All 2 branches missed.">							for (int i = 0; i &lt; agtOrgIdList.size(); i++) {</span>
<span class="nc" id="L1305">								double agtMrpSale = 0.0;</span>
<span class="nc" id="L1306">								double trainingExpPer = 0.0;</span>
<span class="nc" id="L1307">								double trngExpAmt = 0.0;</span>
<span class="nc" id="L1308">								double agtExtraMrpSale = 0.0;</span>
<span class="nc" id="L1309">								double agtExtraTrainingExpPer = 0.0;</span>
<span class="nc" id="L1310">								double trngExtraExpAmt = 0.0;</span>
<span class="nc" id="L1311">								double totalTrainingExp = 0.0;</span>
<span class="nc" id="L1312">								double incentiveAmt = 0.0;</span>
<span class="nc" id="L1313">								double incentivePer = 0.0;</span>
<span class="nc" id="L1314">								double incentiveMrp = 0.0;</span>
								
<span class="nc bnc" id="L1316" title="All 2 branches missed.">								if(&quot;YES&quot;.equalsIgnoreCase(Utility.getPropertyValue(&quot;IS_WEEKLY_IW_TRAINING_EXPENSE_ENABLED&quot;))){</span>
<span class="nc" id="L1317">									SalePwtReportsBean tempBean = reportMap.get(agtOrgIdList.get(i));</span>
<span class="nc" id="L1318">									SalePwtReportsBean tempBeanExtraTraining = totalreportSaleTimeMap.get(agtOrgIdList.get(i));</span>
<span class="nc bnc" id="L1319" title="All 2 branches missed.">									if (tempBean != null) {</span>
<span class="nc" id="L1320">										agtMrpSale = tempBean.getSaleMrpAmt();</span>
<span class="nc" id="L1321">										trngExpAmt = (agtMrpSale * agtTrngExpMap.get(agtOrgIdList.get(i)) * 0.01);</span>
<span class="nc" id="L1322">										agtExtraMrpSale = tempBeanExtraTraining.getSaleMrpAmt();</span>
<span class="nc bnc" id="L1323" title="All 2 branches missed.">										if (agtExtraMrpSale &lt; 0) {</span>
<span class="nc" id="L1324">											agtExtraMrpSale = 0.0;</span>
										}
<span class="nc" id="L1326">										trngExtraExpAmt = (agtExtraMrpSale * agtExtraTrngExpMap.get(agtOrgIdList.get(i)) * 0.01);</span>
<span class="nc" id="L1327">										logger.debug(&quot; agent_org_id :&quot; + agtOrgIdList.get(i) + &quot; agtMrpSale:&quot; + agtMrpSale + &quot; for the day:&quot; + startDate + &quot; trngExpAmt:&quot; + trngExpAmt + &quot; @: &quot; + agtTrngExpMap.get(agtOrgIdList.get(i)) + &quot; ExtraagtMrpSale:&quot; + agtExtraMrpSale + &quot; for the day:&quot; + startDate + &quot; ExtratrngExpAmt:&quot; + trngExtraExpAmt + &quot; @: &quot; + agtExtraTrngExpMap.get(agtOrgIdList.get(i)));</span>
<span class="nc" id="L1328">										totalTrainingExp = trngExpAmt + trngExtraExpAmt;</span>
<span class="nc" id="L1329">										trainingExpPer = agtTrngExpMap.get(agtOrgIdList.get(i));</span>
<span class="nc" id="L1330">										agtExtraTrainingExpPer = agtExtraTrngExpMap.get(agtOrgIdList.get(i));</span>
									}
								}
<span class="nc bnc" id="L1333" title="All 2 branches missed.">								if(&quot;YES&quot;.equalsIgnoreCase(Utility.getPropertyValue(&quot;IS_WEEKLY_IW_INCENTIVE_EXPENSE_ENABLED&quot;))){</span>
<span class="nc bnc" id="L1334" title="All 4 branches missed.">									if(agentWiseMap != null &amp;&amp; agentWiseMap.containsKey(agtOrgIdList.get(i))){</span>
<span class="nc" id="L1335">										incentiveAmt = agentWiseMap.get(agtOrgIdList.get(i)).getIncentiveAmt();</span>
<span class="nc" id="L1336">										incentivePer = agentWiseMap.get(agtOrgIdList.get(i)).getIncentivePer();</span>
<span class="nc" id="L1337">										incentiveMrp = agentWiseMap.get(agtOrgIdList.get(i)).getIncentiveMrp();</span>
									}
								}
<span class="nc bnc" id="L1340" title="All 4 branches missed.">								if (totalTrainingExp &gt; 0.0 || incentiveAmt &gt; 0.0) {</span>
<span class="nc" id="L1341">										pstmt = con.prepareStatement(&quot;insert into st_lms_agent_weekly_training_exp (date,agent_org_id, service_id,game_id,mrp_sale,training_exp_per,training_exp_amt,time_slotted_mrp_sale,extra_training_exp_per,extra_training_exp_amt,incentive_mrp,incentive_per,incentive_amt,status) values (?,?,?,?,?,?,?,?,?,?,?,?,?,?)&quot;);</span>
<span class="nc" id="L1342">										pstmt.setTimestamp(1, updateTime);</span>
<span class="nc" id="L1343">										pstmt.setInt(2, agtOrgIdList.get(i));</span>
<span class="nc" id="L1344">										pstmt.setInt(3, serviceId);</span>
<span class="nc" id="L1345">										pstmt.setInt(4, gameNo);</span>
<span class="nc" id="L1346">										pstmt.setDouble(5, agtMrpSale);</span>
<span class="nc" id="L1347">										pstmt.setDouble(6,trainingExpPer);</span>
<span class="nc" id="L1348">										pstmt.setDouble(7, trngExpAmt);</span>
<span class="nc" id="L1349">										pstmt.setDouble(8, agtExtraMrpSale);</span>
<span class="nc" id="L1350">										pstmt.setDouble(9, agtExtraTrainingExpPer);</span>
<span class="nc" id="L1351">										pstmt.setDouble(10, trngExtraExpAmt);</span>
<span class="nc" id="L1352">										pstmt.setDouble(11, incentiveMrp);</span>
<span class="nc" id="L1353">										pstmt.setDouble(12, incentivePer);</span>
<span class="nc" id="L1354">										pstmt.setDouble(13, incentiveAmt);</span>
<span class="nc" id="L1355">										pstmt.setString(14, &quot;PENDING&quot;);</span>
<span class="nc" id="L1356">										logger.info(&quot;insertAgtTrngExp&gt;&gt;&quot; + pstmt);</span>
<span class="nc" id="L1357">										pstmt.executeUpdate();</span>
<span class="nc" id="L1358">										int taskId = 0;</span>
<span class="nc" id="L1359">										resultSet = pstmt.getGeneratedKeys();</span>

<span class="nc bnc" id="L1361" title="All 2 branches missed.">										if (resultSet.next())</span>
<span class="nc" id="L1362">											taskId = resultSet.getInt(1);</span>
										
<span class="nc bnc" id="L1364" title="All 2 branches missed.">										if (&quot;AUTO&quot;.equalsIgnoreCase(trngExpMode)) {</span>
<span class="nc bnc" id="L1365" title="All 2 branches missed.">											if(totalTrainingExp &gt; 0.0)</span>
<span class="nc" id="L1366">												updateTrngExpAgentData(updateTime, new Timestamp(sdf.parse(sdf.format(startDate.getTime())).getTime()).toString(), new Timestamp(sdf.parse(sdf.format(endDate.getTime())).getTime()).toString(), taskId, agtOrgIdList.get(i), totalTrainingExp, userBean, trngExpMode, &quot;WEEKLY&quot;, gameNo, serviceId, con);</span>
<span class="nc bnc" id="L1367" title="All 2 branches missed.">											if(incentiveAmt &gt; 0.0)</span>
<span class="nc" id="L1368">												updateAgentDataIWIncentive(updateTime, new Timestamp(sdf.parse(sdf.format(startDate.getTime())).getTime()).toString(), new Timestamp(sdf.parse(sdf.format(endDate.getTime())).getTime()).toString(), taskId, agtOrgIdList.get(i), incentiveAmt, userBean, trngExpMode, &quot;WEEKLY&quot;, gameNo, serviceId, con);</span>
<span class="nc" id="L1369">											updateApprovalStatus(taskId,con,&quot;weekly&quot;);	</span>
										}
									}
							}
<span class="nc" id="L1373">							calLastDate.add(Calendar.DAY_OF_MONTH, 7);</span>
						} else {
<span class="nc" id="L1375">							calLastDate.add(Calendar.DAY_OF_MONTH, 7);</span>
						}
<span class="nc" id="L1377">					}</span>
<span class="nc" id="L1378">				}</span>
<span class="nc" id="L1379">				con.commit();</span>
<span class="nc" id="L1380">		} catch (SQLException e) {</span>
<span class="nc" id="L1381">			logger.info(&quot;SQL Exception &quot;, e);</span>
<span class="nc" id="L1382">			throw new LMSException(&quot;SQL Exception &quot; + e.getMessage());</span>
<span class="nc" id="L1383">		} catch (Exception e) {</span>
<span class="nc" id="L1384">			logger.info(&quot;Exception &quot;, e);</span>
<span class="nc" id="L1385">			throw new LMSException(&quot;Exception&quot; + e.getMessage());</span>
		} finally {
<span class="nc" id="L1387">			DBConnect.closeRs(resultSet);</span>
<span class="nc" id="L1388">			DBConnect.closeRs(rs);</span>
<span class="nc" id="L1389">			DBConnect.closePstmt(pstmt);</span>
<span class="nc" id="L1390">			DBConnect.closeStmt(stmt);</span>
<span class="nc" id="L1391">			DBConnect.closeStmt(statement);</span>
<span class="nc" id="L1392">			DBConnect.closeCon(con);</span>
<span class="nc" id="L1393">		}</span>
<span class="nc" id="L1394">	}</span>

	private Map&lt;Integer, Double&gt; fetchTrainingExp(String type, String expDate, int gameNo, int serviceId) throws LMSException {
<span class="nc" id="L1397">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L1398">		PreparedStatement statement = null;</span>
<span class="nc" id="L1399">		ResultSet resultSet = null;</span>
<span class="nc" id="L1400">		Map&lt;Integer, Double&gt; agtTrngExpMap = new HashMap&lt;Integer, Double&gt;();</span>
		try {
<span class="nc bnc" id="L1402" title="All 2 branches missed.">			if (&quot;daily&quot;.equalsIgnoreCase(type)) {</span>
<span class="nc" id="L1403">				statement = con</span>
						.prepareStatement(&quot;select organization_id, value + training_exp_var train_exp from (select organization_id, name, ifnull(training_exp_var, 0.0) training_exp_var from st_lms_organization_master left outer join (select var.agent_org_id, ifnull(hist_var, training_exp_var)training_exp_var from st_lms_agent_&quot;
								+ type.toLowerCase()
								+ &quot;_trng_exp_var_mapping var left join (select agent_org_id,training_exp_var hist_var, service_id, game_id from (select agent_org_id,training_exp_var,updated_date, service_id,game_id from st_lms_agent_&quot;
								+ type.toLowerCase()
								+ &quot;_trng_exp_var_mapping_history where date(updated_date) &gt; ? and service_id = ? and game_id = ? order by updated_date asc)aa group by agent_org_id) hist on var.agent_org_id=hist.agent_org_id and var.game_id=hist.game_id  and var.service_id = hist.service_id where var.service_id = ? and var.game_id = ?) map on organization_id=map.agent_org_id where organization_type='AGENT') tr,(select training_exp_default value from st_lms_agent_default_&quot;
								+ type.toLowerCase()
								+ &quot;_training_exp where service_id = ? and game_id = ?) dtr;&quot;);
<span class="nc bnc" id="L1411" title="All 2 branches missed.">			} else if (&quot;weekly&quot;.equalsIgnoreCase(type)) {</span>
<span class="nc" id="L1412">				statement = con</span>
						.prepareStatement(&quot;select organization_id, value + training_exp_var train_exp from (select organization_id, name, ifnull(training_exp_var, 0.0) training_exp_var from st_lms_organization_master left outer join (select var.agent_org_id, ifnull(hist_var, training_exp_var)training_exp_var from st_lms_agent_&quot;
								+ type.toLowerCase()
								+ &quot;_trng_exp_var_mapping var left join (select agent_org_id,training_exp_var hist_var, aa.service_id, game_id from (select agent_org_id,training_exp_var,updated_date, service_id, game_id from st_lms_agent_&quot;
								+ type.toLowerCase()
								+ &quot;_trng_exp_var_mapping_history where date(updated_date) &gt; ? and service_id = ? and game_id = ? order by updated_date asc)aa group by agent_org_id) hist on var.agent_org_id=hist.agent_org_id and var.game_id=hist.game_id  where var.service_id  = ? and var.game_id = ?) map on organization_id=map.agent_org_id where organization_type='AGENT') tr,(select training_exp_default value from st_lms_agent_default_&quot;
								+ type.toLowerCase()
								+ &quot;_training_exp where service_id = ? and game_id = ?) dtr;&quot;);
			} else {
<span class="nc" id="L1421">				throw new LMSException(&quot;IN Valid Type&quot; + type);</span>
			}
<span class="nc" id="L1423">			statement.setString(1, expDate);</span>
<span class="nc" id="L1424">			statement.setInt(2, serviceId);</span>
<span class="nc" id="L1425">			statement.setInt(3, gameNo);</span>
<span class="nc" id="L1426">			statement.setInt(4, serviceId);</span>
<span class="nc" id="L1427">			statement.setInt(5, gameNo);</span>
<span class="nc" id="L1428">			statement.setInt(6, serviceId);</span>
<span class="nc" id="L1429">			statement.setInt(7, gameNo);</span>
<span class="nc" id="L1430">			resultSet = statement.executeQuery();</span>
<span class="nc bnc" id="L1431" title="All 2 branches missed.">			while (resultSet.next()) {</span>
<span class="nc" id="L1432">				agtTrngExpMap.put(resultSet.getInt(&quot;organization_id&quot;), resultSet.getDouble(&quot;train_exp&quot;));</span>
			}
<span class="nc" id="L1434">		} catch (SQLException e) {</span>
<span class="nc" id="L1435">			logger.error(&quot;SQL Exception&quot;, e);</span>
<span class="nc" id="L1436">			throw new LMSException(LMSErrors.SQL_EXCEPTION_ERROR_CODE, LMSErrors.SQL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="nc" id="L1437">		} catch (Exception e) {</span>
<span class="nc" id="L1438">			logger.error(&quot;Exception&quot;, e);</span>
			// e.printStackTrace();
<span class="nc" id="L1440">			throw new LMSException(LMSErrors.GENERAL_EXCEPTION_ERROR_CODE, LMSErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="nc" id="L1441">		}</span>
<span class="nc" id="L1442">		return agtTrngExpMap;</span>
	}

	private Map&lt;Integer, Double&gt; fetchDailyTrainingExp(String type, String expDate, int serviceId, int gameNo) {
<span class="nc" id="L1446">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L1447">		PreparedStatement statement = null;</span>
<span class="nc" id="L1448">		ResultSet resultSet = null;</span>
<span class="nc" id="L1449">		Map&lt;Integer, Double&gt; agtTrngExpMap = new HashMap&lt;Integer, Double&gt;();</span>
		try {
<span class="nc" id="L1451">			statement = con</span>
					.prepareStatement(&quot;select organization_id,value+training_exp_var train_exp from (select organization_id,name,ifnull(training_exp_var,0.0) training_exp_var from st_lms_organization_master left outer join (select var.agent_org_id,ifnull(hist_var,training_exp_var)training_exp_var from st_lms_agent_&quot;
							+ type.toLowerCase()
							+ &quot;_trng_exp_var_mapping var left join (select agent_org_id,training_exp_var hist_var, service_id,game_id from(select agent_org_id,training_exp_var,updated_date, service_id,game_id from st_lms_agent_&quot;
							+ type.toLowerCase()
							+ &quot;_trng_exp_var_mapping_history where date(updated_date) &gt; ? and service_id = ? and game_id=? order by updated_date asc)aa group by agent_org_id) hist on var.agent_org_id=hist.agent_org_id and var.service_id=hist.service_id and var.game_id=hist.game_id  where var.service_id = ? and var.game_id=?) map on organization_id=map.agent_org_id where organization_type='AGENT') tr,(select training_exp_default value from st_lms_agent_default_&quot;
							+ type.toLowerCase()
							+ &quot;_training_exp where service_id = ? and game_id=?) dtr;&quot;);
<span class="nc" id="L1459">			statement.setString(1, expDate);</span>
<span class="nc" id="L1460">			statement.setInt(2, serviceId);</span>
<span class="nc" id="L1461">			statement.setInt(3, gameNo);</span>
<span class="nc" id="L1462">			statement.setInt(4, serviceId);</span>
<span class="nc" id="L1463">			statement.setInt(5, gameNo);</span>
<span class="nc" id="L1464">			statement.setInt(6, serviceId);</span>
<span class="nc" id="L1465">			statement.setInt(7, gameNo);</span>
<span class="nc" id="L1466">			resultSet = statement.executeQuery();</span>
<span class="nc bnc" id="L1467" title="All 2 branches missed.">			while (resultSet.next()) {</span>
<span class="nc" id="L1468">				agtTrngExpMap.put(resultSet.getInt(&quot;organization_id&quot;), resultSet.getDouble(&quot;train_exp&quot;));</span>
			}
<span class="nc" id="L1470">		} catch (Exception e) {</span>
<span class="nc" id="L1471">			e.printStackTrace();</span>
<span class="nc" id="L1472">		}</span>
<span class="nc" id="L1473">		return agtTrngExpMap;</span>
	}
	
	private Map&lt;Integer, Double&gt; fetchExtraTrainingExp(String type, String expDate, int gameNo, int serviceId, Connection con) throws LMSException {
<span class="nc" id="L1477">		PreparedStatement statement = null;</span>
<span class="nc" id="L1478">		ResultSet resultSet = null;</span>
<span class="nc" id="L1479">		Map&lt;Integer, Double&gt; agtExtraTrngExpMap = new HashMap&lt;Integer, Double&gt;();</span>
		try {
<span class="nc bnc" id="L1481" title="All 2 branches missed.">			if (&quot;daily&quot;.equalsIgnoreCase(type)) {</span>
<span class="nc" id="L1482">				statement = con</span>
						.prepareStatement(&quot;select organization_id,value + extra_training_exp_var extra_train_exp from (select organization_id,name,ifnull(extra_training_exp_var,0.0) extra_training_exp_var from st_lms_organization_master left outer join (select var.agent_org_id,var.game_id,ifnull(hist_var,extra_training_exp_var)extra_training_exp_var from st_lms_agent_&quot;
								+ type.toLowerCase()
								+ &quot;_trng_exp_var_mapping var left join (select agent_org_id,extra_training_exp_var hist_var, service_id,game_id from(select agent_org_id,extra_training_exp_var,updated_date, service_id, game_id from st_lms_agent_&quot;
								+ type.toLowerCase()
								+ &quot;_trng_exp_var_mapping_history where date(updated_date) &gt; ? and service_id = ? and game_id = ? order by updated_date asc)aa group by agent_org_id) hist on var.agent_org_id=hist.agent_org_id and var.service_id=hist.service_id and var.game_id=hist.game_id  where var.service_id = ? and var.game_id = ?) map on organization_id=map.agent_org_id where organization_type='AGENT') tr,(select ifnull(training_exp_extra,0.0) value from st_lms_agent_default_&quot;
								+ type.toLowerCase()
								+ &quot;_training_exp where service_id = ? and game_id = ?) dtr;&quot;);
<span class="nc bnc" id="L1490" title="All 2 branches missed.">			} else if (&quot;weekly&quot;.equalsIgnoreCase(type)) {</span>
<span class="nc" id="L1491">				statement = con</span>
						.prepareStatement(&quot;select organization_id,value+extra_training_exp_var extra_train_exp from (select organization_id,name,ifnull(extra_training_exp_var,0.0) extra_training_exp_var from st_lms_organization_master left outer join (select var.agent_org_id,var.game_id,ifnull(hist_var,extra_training_exp_var)extra_training_exp_var from st_lms_agent_&quot;
								+ type.toLowerCase()
								+ &quot;_trng_exp_var_mapping var left join (select agent_org_id,extra_training_exp_var hist_var, service_id,game_id from(select agent_org_id,extra_training_exp_var,updated_date, service_id,game_id from st_lms_agent_&quot;
								+ type.toLowerCase()
								+ &quot;_trng_exp_var_mapping_history where date(updated_date) &gt; ? and service_id = ? and game_id = ? order by updated_date asc)aa group by agent_org_id) hist on var.agent_org_id=hist.agent_org_id and var.service_id = hist.service_id and var.game_id=hist.game_id  where var.service_id = ? and var.game_id = ?) map on organization_id=map.agent_org_id where organization_type='AGENT') tr,(select ifnull(training_exp_extra,0.0) value from st_lms_agent_default_&quot;
								+ type.toLowerCase()
								+ &quot;_training_exp where service_id = ?  and game_id = ?) dtr;&quot;);
			} else {
<span class="nc" id="L1500">				throw new LMSException(&quot;IN Valid Type&quot; + type);</span>
			}
<span class="nc" id="L1502">			statement.setString(1, expDate);</span>
<span class="nc" id="L1503">			statement.setInt(2, serviceId);</span>
<span class="nc" id="L1504">			statement.setInt(3, gameNo);</span>
<span class="nc" id="L1505">			statement.setInt(4, serviceId);</span>
<span class="nc" id="L1506">			statement.setInt(5, gameNo);</span>
<span class="nc" id="L1507">			statement.setInt(6, serviceId);</span>
<span class="nc" id="L1508">			statement.setInt(7, gameNo);</span>

<span class="nc" id="L1510">			resultSet = statement.executeQuery();</span>
<span class="nc bnc" id="L1511" title="All 2 branches missed.">			while (resultSet.next()) {</span>
<span class="nc" id="L1512">				agtExtraTrngExpMap.put(resultSet.getInt(&quot;organization_id&quot;), resultSet.getDouble(&quot;extra_train_exp&quot;));</span>
			}
<span class="nc" id="L1514">		} catch (SQLException e) {</span>
<span class="nc" id="L1515">			logger.error(&quot;SQL Exception&quot;, e);</span>
<span class="nc" id="L1516">			throw new LMSException(LMSErrors.SQL_EXCEPTION_ERROR_CODE, LMSErrors.SQL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="nc" id="L1517">		} catch (Exception e) {</span>
<span class="nc" id="L1518">			logger.error(&quot;Exception&quot;, e);</span>
			// e.printStackTrace();
<span class="nc" id="L1520">			throw new LMSException(LMSErrors.GENERAL_EXCEPTION_ERROR_CODE, LMSErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="nc" id="L1521">		}</span>
<span class="nc" id="L1522">		return agtExtraTrngExpMap;</span>
	}
	
	public void updateAllAgentData(String startDate, String endDate, String trngExpType, UserInfoBean userBean, int serviceId, int gameNo, Connection con) {
<span class="nc" id="L1526">		Statement statement = null;</span>
<span class="nc" id="L1527">		Timestamp updTime = new Timestamp(new Date().getTime());</span>
		try {
<span class="nc" id="L1529">			statement = con.createStatement();</span>
<span class="nc" id="L1530">			String selectQry = &quot;select id,date,agent_org_id,training_exp_amt+extra_training_exp_amt training_exp_amt,incentive_per,incentive_amt,updated_mode from st_lms_agent_&quot; + trngExpType.toLowerCase() + &quot;_training_exp where date&gt;='&quot; + startDate + &quot;' and date&lt;='&quot; + endDate + &quot;' and service_id = &quot; + serviceId + &quot; and status!='DONE'&quot;;	</span>
<span class="nc" id="L1531">			ResultSet rs = statement.executeQuery(selectQry);</span>
<span class="nc bnc" id="L1532" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc bnc" id="L1533" title="All 2 branches missed.">				if(rs.getDouble(&quot;training_exp_amt&quot;) != 0.0)</span>
<span class="nc" id="L1534">					updateTrngExpAgentDataIW(updTime, startDate, endDate, rs.getInt(&quot;id&quot;), rs.getInt(&quot;agent_org_id&quot;), rs.getDouble(&quot;training_exp_amt&quot;), userBean, &quot;MANUAL&quot;, trngExpType, gameNo, serviceId, con);</span>
<span class="nc bnc" id="L1535" title="All 2 branches missed.">				if(rs.getDouble(&quot;incentive_amt&quot;) &gt; 0.00){</span>
<span class="nc" id="L1536">					updateAgentDataIWIncentive(updTime, startDate, endDate, rs.getInt(&quot;id&quot;), rs.getInt(&quot;agent_org_id&quot;), rs.getDouble(&quot;incentive_amt&quot;), userBean, &quot;MANUAL&quot;, trngExpType, gameNo, serviceId, con);</span>
				}
<span class="nc" id="L1538">				updateApprovalStatus(rs.getInt(&quot;id&quot;),con,trngExpType.toLowerCase());</span>
			}
<span class="nc" id="L1540">		} catch (Exception e) {</span>
<span class="nc" id="L1541">			e.printStackTrace();</span>
		}finally{
<span class="nc" id="L1543">			DBConnect.closeResource(statement);</span>
<span class="nc" id="L1544">		}</span>
<span class="nc" id="L1545">	}</span>
	
	public void updateAllAgentData(String startDate, String endDate, String trngExpType, UserInfoBean userBean, int serviceId, int gameNo) {
<span class="nc" id="L1548">		Connection con = DBConnect.getConnection();</span>
		try{
<span class="nc" id="L1550">			con.setAutoCommit(false);</span>
<span class="nc" id="L1551">			updateAllAgentData(startDate, endDate, trngExpType, userBean, serviceId, gameNo, con);</span>
<span class="nc" id="L1552">			con.commit();</span>
<span class="nc" id="L1553">		}catch(Exception e){</span>
<span class="nc" id="L1554">			e.printStackTrace() ;</span>
		}finally{
<span class="nc" id="L1556">			DBConnect.closeResource(con);</span>
<span class="nc" id="L1557">		}</span>
		
<span class="nc" id="L1559">	}</span>

	public Map&lt;Integer, SalePwtReportsBean&gt; drawSaleAgentWise(
			Timestamp startDate, Timestamp endDate) throws SQLException {
<span class="nc" id="L1563">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L1564">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L1565">		ResultSet rs = null;</span>
<span class="nc" id="L1566">		SalePwtReportsBean reportsBean = null;</span>
<span class="nc" id="L1567">		Map&lt;Integer, SalePwtReportsBean&gt; reportMap = new HashMap&lt;Integer, SalePwtReportsBean&gt;();</span>
		try {
<span class="nc" id="L1569">			String indGameQry = &quot;(select sale.retailer_org_id,(ifnull(mrpAmt,0.0)-ifnull(mrpAmtRet,0.0))mrpAmt,(ifnull(netAmt,0.0)-ifnull(netAmtRet,0.0))netAmt from (select retailer_org_id,sum(mrp_amt) mrpAmt,sum(agent_net_amt) netAmt from st_dg_ret_sale_* where transaction_id in(select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_SALE','DG_SALE_OFFLINE') and transaction_date&gt;='&quot;</span>
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' )group by retailer_org_id) sale left outer join (select retailer_org_id,sum(mrp_amt) mrpAmtRet,sum(agent_net_amt) netAmtRet from st_dg_ret_sale_refund_* where transaction_id in(select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_REFUND_CANCEL','DG_REFUND_FAILED') and transaction_date&gt;='&quot;
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' )group by retailer_org_id) saleRet on sale.retailer_org_id=saleRet.retailer_org_id) union all &quot;;
<span class="nc" id="L1578">			StringBuilder saleQry = new StringBuilder(</span>
					&quot;select om.organization_id,name,ifnull(mrpAmt,0.0) mrpAmt,ifnull(netAmt,0.0) netAmt from st_lms_organization_master om right outer join (select parent_id,sum(mrpAmt) mrpAmt,sum(netAmt) netAmt from st_lms_organization_master,(select retailer_org_id,sum(mrpAmt) mrpAmt,sum(netAmt) netAmt from (&quot;);
<span class="nc" id="L1580">			String gameQry = &quot;select game_nbr from st_dg_game_master&quot;;</span>
<span class="nc" id="L1581">			PreparedStatement pstmtGame = con.prepareStatement(gameQry);</span>
<span class="nc" id="L1582">			ResultSet rsGame = pstmtGame.executeQuery();</span>

<span class="nc bnc" id="L1584" title="All 2 branches missed.">			while (rsGame.next()) {</span>
<span class="nc" id="L1585">				saleQry.append(indGameQry.replaceAll(&quot;\\*&quot;, rsGame</span>
						.getString(&quot;game_nbr&quot;)));
			}
<span class="nc" id="L1588">			saleQry.delete(saleQry.length() - 10, saleQry.length());</span>
<span class="nc" id="L1589">			saleQry</span>
					.append(&quot;) saleTlb group by retailer_org_id) saleTlb where retailer_org_id=organization_id group by parent_id) saleTlb on saleTlb.parent_id=om.organization_id&quot;);

<span class="nc" id="L1592">			pstmt = con.prepareStatement(saleQry.toString());</span>

<span class="nc" id="L1594">			logger.info(&quot;----Agent Qry---&quot; + pstmt);</span>
<span class="nc" id="L1595">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1596" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1597">				reportsBean = new SalePwtReportsBean();</span>
<span class="nc" id="L1598">				reportsBean.setGameName(rs.getString(&quot;name&quot;));</span>
<span class="nc" id="L1599">				reportsBean.setGameNo(rs.getInt(&quot;organization_id&quot;));</span>
<span class="nc" id="L1600">				reportsBean.setSaleMrpAmt(rs.getDouble(&quot;mrpAmt&quot;));</span>
<span class="nc" id="L1601">				reportsBean.setSaleNetAmt(rs.getDouble(&quot;netAmt&quot;));</span>
<span class="nc" id="L1602">				reportMap.put(rs.getInt(&quot;organization_id&quot;), reportsBean);</span>
			}
<span class="nc" id="L1604">		} catch (Exception e) {</span>
<span class="nc" id="L1605">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L1607">			con.close();</span>
<span class="nc" id="L1608">		}</span>
<span class="nc" id="L1609">		return reportMap;</span>
	}
	
	public Map&lt;Integer, SalePwtReportsBean&gt; drawSaleAgentWiseNew(
			Timestamp startDate, Timestamp endDate,int gameNo) throws SQLException {
<span class="nc" id="L1614">		Connection con = DBConnect.getConnection();</span>
		//PreparedStatement pstmt = null;
<span class="nc" id="L1616">		Statement pstmt = null;</span>
<span class="nc" id="L1617">		ResultSet rs = null;</span>
<span class="nc" id="L1618">		SalePwtReportsBean reportsBean = null;</span>
<span class="nc" id="L1619">		Map&lt;Integer, SalePwtReportsBean&gt; reportMap = new HashMap&lt;Integer, SalePwtReportsBean&gt;();</span>
		try {
<span class="nc" id="L1621">			String indGameQry = &quot;select netRetSale.organization_id,netRetSale.name,(ifnull(netRetSale.mrpAmt,0.0)-ifnull(netRetSaleRef.mrpAmt,0.0))mrpAmt,(ifnull(netRetSale.netAmt,0.0)-ifnull(netRetSaleRef.netAmt,0.0))netAmt from(select om.organization_id,om.name,ifnull(sale.mrpAmt,0.0) mrpAmt,ifnull(sale.netAmt,0.0) netAmt from st_lms_organization_master om left outer join(select retailer_org_id,sum(mrp_amt) mrpAmt,sum(agent_net_amt) netAmt from st_dg_ret_sale_* where transaction_id in(select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_SALE','DG_SALE_OFFLINE') and transaction_date&gt;='&quot;</span>
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' )group by retailer_org_id) sale on om.organization_id=sale.retailer_org_id where om.organization_type='RETAILER') netRetSale inner join (select om.organization_id,om.name,ifnull(saleRet.mrpAmtRet,0.0) mrpAmt,ifnull(saleRet.netAmtRet,0.0) netAmt from st_lms_organization_master om left outer join (select retailer_org_id,sum(mrp_amt) mrpAmtRet,sum(agent_net_amt) netAmtRet from st_dg_ret_sale_refund_* where transaction_id in(select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_REFUND_CANCEL','DG_REFUND_FAILED') and transaction_date&gt;='&quot;
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' )group by retailer_org_id) saleRet on om.organization_id=saleRet.retailer_org_id where om.organization_type='RETAILER') netRetSaleRef on netRetSale.organization_id=netRetSaleRef.organization_id union all &quot;;
<span class="nc" id="L1630">			StringBuilder saleQry = new StringBuilder(</span>
					&quot;select om.organization_id,name,ifnull(mrpAmt,0.0) mrpAmt,ifnull(netAmt,0.0) netAmt from st_lms_organization_master om right outer join (select parent_id,sum(mrpAmt) mrpAmt,sum(netAmt) netAmt from st_lms_organization_master oms,(select organization_id,sum(mrpAmt) mrpAmt,sum(netAmt) netAmt from(&quot;);
			
			
			

			
<span class="nc" id="L1637">				saleQry.append(indGameQry.replaceAll(&quot;\\*&quot;, String.valueOf(gameNo)));</span>
			
<span class="nc" id="L1639">			saleQry.delete(saleQry.length() - 10, saleQry.length());</span>
<span class="nc" id="L1640">			saleQry</span>
					.append(&quot;) saleTbl group by organization_id) saleTbl where saleTbl.organization_id = oms.organization_id group by parent_id)saleTlb on saleTlb.parent_id=om.organization_id&quot;);

			//pstmt = con.prepareStatement(saleQry.toString());
<span class="nc" id="L1644">			pstmt = con.createStatement();</span>

<span class="nc" id="L1646">			logger.info(&quot;----Agent new Qry---&quot; + saleQry.toString());</span>
			//rs = pstmt.executeQuery();
<span class="nc" id="L1648">			rs = pstmt.executeQuery(saleQry.toString());</span>
<span class="nc bnc" id="L1649" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1650">				reportsBean = new SalePwtReportsBean();</span>
<span class="nc" id="L1651">				reportsBean.setGameName(rs.getString(&quot;name&quot;));</span>
<span class="nc" id="L1652">				reportsBean.setGameNo(rs.getInt(&quot;organization_id&quot;));</span>
<span class="nc" id="L1653">				reportsBean.setSaleMrpAmt(rs.getDouble(&quot;mrpAmt&quot;));</span>
<span class="nc" id="L1654">				reportsBean.setSaleNetAmt(rs.getDouble(&quot;netAmt&quot;));</span>
<span class="nc" id="L1655">				reportMap.put(rs.getInt(&quot;organization_id&quot;), reportsBean);</span>
			}
<span class="nc" id="L1657">		} catch (Exception e) {</span>
<span class="nc" id="L1658">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L1660">			con.close();</span>
<span class="nc" id="L1661">		}</span>
<span class="nc" id="L1662">		return reportMap;</span>
	}
	
	public Map&lt;Integer, SalePwtReportsBean&gt; iwSaleAgentWiseNew(Timestamp startDate, Timestamp endDate, int gameNo) throws SQLException {
<span class="nc" id="L1666">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L1667">		Statement pstmt = null;</span>
<span class="nc" id="L1668">		ResultSet rs = null;</span>
<span class="nc" id="L1669">		SalePwtReportsBean reportsBean = null;</span>
<span class="nc" id="L1670">		Map&lt;Integer, SalePwtReportsBean&gt; reportMap = new HashMap&lt;Integer, SalePwtReportsBean&gt;();</span>
		try {
			// String indGameQry = &quot;select netRetSale.organization_id,netRetSale.name,(ifnull(netRetSale.mrpAmt,0.0)-ifnull(netRetSaleRef.mrpAmt,0.0))mrpAmt,(ifnull(netRetSale.netAmt,0.0)-ifnull(netRetSaleRef.netAmt,0.0))netAmt from(select om.organization_id,om.name,ifnull(sale.mrpAmt,0.0) mrpAmt,ifnull(sale.netAmt,0.0) netAmt from st_lms_organization_master om left outer join(select retailer_org_id,sum(mrp_amt) mrpAmt,sum(agent_net_amt) netAmt from st_iw_ret_sale where game_id = &quot;+gameNo+&quot; transaction_id in(select transaction_id from st_lms_retailer_transaction_master where transaction_type in('IW_SALE') and transaction_date&gt;='&quot;
			// + startDate
			// + &quot;' and transaction_date&lt;='&quot;
			// + endDate
			// + &quot;' )group by retailer_org_id) sale on om.organization_id=sale.retailer_org_id where om.organization_type='RETAILER') netRetSale inner join (select om.organization_id,om.name,ifnull(saleRet.mrpAmtRet,0.0) mrpAmt,ifnull(saleRet.netAmtRet,0.0) netAmt from st_lms_organization_master om left outer join (select retailer_org_id,sum(mrp_amt) mrpAmtRet,sum(agent_net_amt) netAmtRet from st_iw_ret_sale_refund where game_id = &quot;+gameNo+&quot; transaction_id in(select transaction_id from st_lms_retailer_transaction_master where transaction_type in('IW_REFUND_CANCEL','IW_REFUND_FAILED') and transaction_date&gt;='&quot;
			// + startDate
			// + &quot;' and transaction_date&lt;='&quot;
			// + endDate
			// + &quot;' )group by retailer_org_id) saleRet on om.organization_id=saleRet.retailer_org_id where om.organization_type='RETAILER') netRetSaleRef on netRetSale.organization_id=netRetSaleRef.organization_id union all &quot;;

<span class="nc" id="L1682">			StringBuilder saleQry = new StringBuilder(</span>
					&quot;select om.organization_id,name,ifnull(mrpAmt,0.0) mrpAmt,ifnull(netAmt,0.0) netAmt from st_lms_organization_master om right outer join (select parent_id,sum(mrpAmt) mrpAmt,sum(netAmt) netAmt from st_lms_organization_master oms,(select organization_id,sum(mrpAmt) mrpAmt,sum(netAmt) netAmt from(select netRetSale.organization_id,netRetSale.name,(ifnull(netRetSale.mrpAmt,0.0)-ifnull(netRetSaleRef.mrpAmt,0.0))mrpAmt,(ifnull(netRetSale.netAmt,0.0)-ifnull(netRetSaleRef.netAmt,0.0))netAmt from(select om.organization_id,om.name,ifnull(sale.mrpAmt,0.0) mrpAmt,ifnull(sale.netAmt,0.0) netAmt from st_lms_organization_master om left outer join(select retailer_org_id,sum(mrp_amt) mrpAmt,sum(agent_net_amt) netAmt from st_iw_ret_sale where game_id = &quot;)
					.append(gameNo)
					.append(&quot; and transaction_id in(select transaction_id from st_lms_retailer_transaction_master where transaction_type in('IW_SALE') and transaction_date&gt;='&quot;)
					.append(startDate)
					.append(&quot;' and transaction_date&lt;='&quot;)
					.append(endDate)
					.append(&quot;' )group by retailer_org_id) sale on om.organization_id=sale.retailer_org_id where om.organization_type='RETAILER') netRetSale inner join (select om.organization_id,om.name,ifnull(saleRet.mrpAmtRet,0.0) mrpAmt,ifnull(saleRet.netAmtRet,0.0) netAmt from st_lms_organization_master om left outer join (select retailer_org_id,sum(mrp_amt) mrpAmtRet,sum(agent_net_amt) netAmtRet from st_iw_ret_sale_refund where game_id = &quot;)
					.append(gameNo)
					.append(&quot; and transaction_id in(select transaction_id from st_lms_retailer_transaction_master where transaction_type in('IW_REFUND_CANCEL','IW_REFUND_FAILED') and transaction_date&gt;='&quot;)
					.append(startDate)
					.append(&quot;' and transaction_date&lt;='&quot;)
					.append(endDate)
					.append(&quot;' )group by retailer_org_id) saleRet on om.organization_id=saleRet.retailer_org_id where om.organization_type='RETAILER') netRetSaleRef on netRetSale.organization_id=netRetSaleRef.organization_id) saleTbl group by organization_id) saleTbl where saleTbl.organization_id = oms.organization_id group by parent_id)saleTlb on saleTlb.parent_id=om.organization_id&quot;);

<span class="nc" id="L1697">			pstmt = con.createStatement();</span>

<span class="nc" id="L1699">			logger.info(&quot;----Agent new Qry---&quot; + saleQry.toString());</span>
			// rs = pstmt.executeQuery();
<span class="nc" id="L1701">			rs = pstmt.executeQuery(saleQry.toString());</span>
<span class="nc bnc" id="L1702" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1703">				reportsBean = new SalePwtReportsBean();</span>
<span class="nc" id="L1704">				reportsBean.setGameName(rs.getString(&quot;name&quot;));</span>
<span class="nc" id="L1705">				reportsBean.setGameNo(rs.getInt(&quot;organization_id&quot;));</span>
<span class="nc" id="L1706">				reportsBean.setSaleMrpAmt(rs.getDouble(&quot;mrpAmt&quot;));</span>
<span class="nc" id="L1707">				reportsBean.setSaleNetAmt(rs.getDouble(&quot;netAmt&quot;));</span>
<span class="nc" id="L1708">				reportMap.put(rs.getInt(&quot;organization_id&quot;), reportsBean);</span>
			}
<span class="nc" id="L1710">		} catch (Exception e) {</span>
<span class="nc" id="L1711">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L1713">			con.close();</span>
<span class="nc" id="L1714">		}</span>
<span class="nc" id="L1715">		return reportMap;</span>
	}
	
	public Map&lt;Integer, SalePwtReportsBean&gt; drawSaleAgentWiseTimeWiseNew(
			Timestamp startDate, Timestamp endDate,int gameNo) throws SQLException, LMSException {
<span class="nc" id="L1720">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L1721">		PreparedStatement pstmt = null;</span>
		//Statement pstmt = null;
<span class="nc" id="L1723">		ResultSet rs = null;</span>
<span class="nc" id="L1724">		SalePwtReportsBean reportsBean = null;</span>
<span class="nc" id="L1725">		Map&lt;Integer, SalePwtReportsBean&gt; reportMap = new HashMap&lt;Integer, SalePwtReportsBean&gt;();</span>
		try {
			/*String indGameQry = &quot;select netRetSale.organization_id,netRetSale.name,(ifnull(netRetSale.mrpAmt,0.0)-ifnull(netRetSaleRef.mrpAmt,0.0))mrpAmt,(ifnull(netRetSale.netAmt,0.0)-ifnull(netRetSaleRef.netAmt,0.0))netAmt from(select om.organization_id,om.name,ifnull(sale.mrpAmt,0.0) mrpAmt,ifnull(sale.netAmt,0.0) netAmt from st_lms_organization_master om left outer join(select retailer_org_id,sum(mrp_amt) mrpAmt,sum(agent_net_amt) netAmt from st_dg_ret_sale_* where transaction_id in(select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_SALE','DG_SALE_OFFLINE') and transaction_date&gt;='&quot;
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' )group by retailer_org_id) sale on om.organization_id=sale.retailer_org_id where om.organization_type='RETAILER') netRetSale inner join (select om.organization_id,om.name,ifnull(saleRet.mrpAmtRet,0.0) mrpAmt,ifnull(saleRet.netAmtRet,0.0) netAmt from st_lms_organization_master om left outer join (select retailer_org_id,sum(mrp_amt) mrpAmtRet,sum(agent_net_amt) netAmtRet from st_dg_ret_sale_refund_* where transaction_id in(select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_REFUND_CANCEL','DG_REFUND_FAILED') and transaction_date&gt;='&quot;
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' )group by retailer_org_id) saleRet on om.organization_id=saleRet.retailer_org_id where om.organization_type='RETAILER') netRetSaleRef on netRetSale.organization_id=netRetSaleRef.organization_id union all &quot;;
			StringBuilder saleQry = new StringBuilder(
					&quot;select om.organization_id,name,ifnull(mrpAmt,0.0) mrpAmt,ifnull(netAmt,0.0) netAmt from st_lms_organization_master om right outer join (select parent_id,sum(mrpAmt) mrpAmt,sum(netAmt) netAmt from st_lms_organization_master oms,(select organization_id,sum(mrpAmt) mrpAmt,sum(netAmt) netAmt from(&quot;);
			
			
			

			
				saleQry.append(indGameQry.replaceAll(&quot;\\*&quot;, String.valueOf(gameNo)));
			
			saleQry.delete(saleQry.length() - 10, saleQry.length());
			saleQry
					.append(&quot;) saleTbl group by organization_id) saleTbl where saleTbl.organization_id = oms.organization_id group by parent_id)saleTlb on saleTlb.parent_id=om.organization_id&quot;);
*/
<span class="nc" id="L1749">			pstmt = con.prepareStatement(&quot;select om.organization_id,name,ifnull(mrpAmt,0.0) mrpAmt,ifnull(netAmt,0.0) netAmt from st_lms_organization_master om left outer join(select parent_id,sum(mrpAmt) mrpAmt,sum(netAmt) netAmt from st_lms_organization_master oms,(select retailer_org_id,sum(mrp_amt) mrpAmt,sum(agent_net_amt) netAmt from st_dg_ret_sale_? where transaction_id in(select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_SALE','DG_SALE_OFFLINE') and transaction_date&gt;=? and transaction_date&lt;=? and transaction_id not in(select ref_transaction_id from st_dg_ret_sale_refund_? refund inner join  st_lms_retailer_transaction_master rtm on refund.transaction_id=rtm.transaction_id where transaction_type in('DG_REFUND_CANCEL','DG_REFUND_FAILED') and date(transaction_date)=date(?)))group by retailer_org_id) saleTbl where saleTbl.retailer_org_id = oms.organization_id group by parent_id)saleTlb on saleTlb.parent_id=om.organization_id where om.organization_type='AGENT'&quot;);</span>
			//pstmt = con.createStatement();
<span class="nc" id="L1751">			pstmt.setInt(1, gameNo);</span>
<span class="nc" id="L1752">			pstmt.setTimestamp(2, startDate);</span>
<span class="nc" id="L1753">			pstmt.setTimestamp(3, endDate);</span>
<span class="nc" id="L1754">			pstmt.setInt(4, gameNo);</span>
<span class="nc" id="L1755">			pstmt.setTimestamp(5, startDate);</span>
<span class="nc" id="L1756">			logger.info(&quot;----Agent Time wise Qry---&quot; + pstmt);</span>
			//rs = pstmt.executeQuery();
<span class="nc" id="L1758">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1759" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1760">				reportsBean = new SalePwtReportsBean();</span>
<span class="nc" id="L1761">				reportsBean.setGameName(rs.getString(&quot;name&quot;));</span>
<span class="nc" id="L1762">				reportsBean.setGameNo(rs.getInt(&quot;organization_id&quot;));</span>
<span class="nc" id="L1763">				reportsBean.setSaleMrpAmt(rs.getDouble(&quot;mrpAmt&quot;));</span>
<span class="nc" id="L1764">				reportsBean.setSaleNetAmt(rs.getDouble(&quot;netAmt&quot;));</span>
<span class="nc" id="L1765">				reportMap.put(rs.getInt(&quot;organization_id&quot;), reportsBean);</span>
			}
<span class="nc" id="L1767">		} catch (Exception e) {</span>
<span class="nc" id="L1768">			e.printStackTrace();</span>
<span class="nc" id="L1769">			throw new LMSException();</span>
			
		} finally {
<span class="nc" id="L1772">			con.close();</span>
<span class="nc" id="L1773">		}</span>
<span class="nc" id="L1774">		return reportMap;</span>
	}
	
	public Map&lt;Integer, SalePwtReportsBean&gt; iwSaleAgentWiseTimeWiseNew(Timestamp startDate, Timestamp endDate, int gameNo) throws SQLException, LMSException {
<span class="nc" id="L1778">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L1779">		PreparedStatement pstmt = null;</span>
		// Statement pstmt = null;
<span class="nc" id="L1781">		ResultSet rs = null;</span>
<span class="nc" id="L1782">		SalePwtReportsBean reportsBean = null;</span>
<span class="nc" id="L1783">		Map&lt;Integer, SalePwtReportsBean&gt; reportMap = new HashMap&lt;Integer, SalePwtReportsBean&gt;();</span>
		try {
<span class="nc" id="L1785">			pstmt = con</span>
					.prepareStatement(&quot;select om.organization_id,name,ifnull(mrpAmt,0.0) mrpAmt,ifnull(netAmt,0.0) netAmt from st_lms_organization_master om left outer join(select parent_id,sum(mrpAmt) mrpAmt,sum(netAmt) netAmt from st_lms_organization_master oms,(select retailer_org_id,sum(mrp_amt) mrpAmt,sum(agent_net_amt) netAmt from st_iw_ret_sale where game_id = ? and transaction_id in(select transaction_id from st_lms_retailer_transaction_master where transaction_type in('IW_SALE') and transaction_date&gt;=? and transaction_date&lt;=? and transaction_id not in(select sale_ref_transaction_id from st_iw_ret_sale_refund refund inner join  st_lms_retailer_transaction_master rtm on refund.transaction_id=rtm.transaction_id where refund.game_id = ? and  transaction_type in('IW_REFUND_CANCEL','IW_REFUND_FAILED') and date(rtm.transaction_date)=date(?)))group by retailer_org_id) saleTbl where saleTbl.retailer_org_id = oms.organization_id group by parent_id)saleTlb on saleTlb.parent_id=om.organization_id where om.organization_type='AGENT';&quot;);
			// pstmt = con.createStatement();
<span class="nc" id="L1788">			pstmt.setInt(1, gameNo);</span>
<span class="nc" id="L1789">			pstmt.setTimestamp(2, startDate);</span>
<span class="nc" id="L1790">			pstmt.setTimestamp(3, endDate);</span>
<span class="nc" id="L1791">			pstmt.setInt(4, gameNo);</span>
<span class="nc" id="L1792">			pstmt.setTimestamp(5, startDate);</span>
<span class="nc" id="L1793">			logger.info(&quot;----Agent Time wise Qry---&quot; + pstmt);</span>
			// rs = pstmt.executeQuery();
<span class="nc" id="L1795">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1796" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1797">				reportsBean = new SalePwtReportsBean();</span>
<span class="nc" id="L1798">				reportsBean.setGameName(rs.getString(&quot;name&quot;));</span>
<span class="nc" id="L1799">				reportsBean.setGameNo(rs.getInt(&quot;organization_id&quot;));</span>
<span class="nc" id="L1800">				reportsBean.setSaleMrpAmt(rs.getDouble(&quot;mrpAmt&quot;));</span>
<span class="nc" id="L1801">				reportsBean.setSaleNetAmt(rs.getDouble(&quot;netAmt&quot;));</span>
<span class="nc" id="L1802">				reportMap.put(rs.getInt(&quot;organization_id&quot;), reportsBean);</span>
			}
<span class="nc" id="L1804">		} catch (Exception e) {</span>
<span class="nc" id="L1805">			e.printStackTrace();</span>
<span class="nc" id="L1806">			throw new LMSException();</span>
		} finally {
<span class="nc" id="L1808">			con.close();</span>
<span class="nc" id="L1809">		}</span>
<span class="nc" id="L1810">		return reportMap;</span>
	}
	
	public Map&lt;Integer, SalePwtReportsBean&gt; drawSaleAgentWiseWeeklyTimeWiseNew(Timestamp startDate,Timestamp toDate,
			Timestamp weekStartDate, Timestamp weekEndDate,int gameNo) throws SQLException, LMSException {
<span class="nc" id="L1815">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L1816">		PreparedStatement pstmt = null;</span>
		//Statement pstmt = null;
<span class="nc" id="L1818">		ResultSet rs = null;</span>
<span class="nc" id="L1819">		SalePwtReportsBean reportsBean = null;</span>
<span class="nc" id="L1820">		Map&lt;Integer, SalePwtReportsBean&gt; reportMap = new HashMap&lt;Integer, SalePwtReportsBean&gt;();</span>
		try {
			/*String indGameQry = &quot;select netRetSale.organization_id,netRetSale.name,(ifnull(netRetSale.mrpAmt,0.0)-ifnull(netRetSaleRef.mrpAmt,0.0))mrpAmt,(ifnull(netRetSale.netAmt,0.0)-ifnull(netRetSaleRef.netAmt,0.0))netAmt from(select om.organization_id,om.name,ifnull(sale.mrpAmt,0.0) mrpAmt,ifnull(sale.netAmt,0.0) netAmt from st_lms_organization_master om left outer join(select retailer_org_id,sum(mrp_amt) mrpAmt,sum(agent_net_amt) netAmt from st_dg_ret_sale_* where transaction_id in(select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_SALE','DG_SALE_OFFLINE') and transaction_date&gt;='&quot;
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' )group by retailer_org_id) sale on om.organization_id=sale.retailer_org_id where om.organization_type='RETAILER') netRetSale inner join (select om.organization_id,om.name,ifnull(saleRet.mrpAmtRet,0.0) mrpAmt,ifnull(saleRet.netAmtRet,0.0) netAmt from st_lms_organization_master om left outer join (select retailer_org_id,sum(mrp_amt) mrpAmtRet,sum(agent_net_amt) netAmtRet from st_dg_ret_sale_refund_* where transaction_id in(select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_REFUND_CANCEL','DG_REFUND_FAILED') and transaction_date&gt;='&quot;
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' )group by retailer_org_id) saleRet on om.organization_id=saleRet.retailer_org_id where om.organization_type='RETAILER') netRetSaleRef on netRetSale.organization_id=netRetSaleRef.organization_id union all &quot;;
			StringBuilder saleQry = new StringBuilder(
					&quot;select om.organization_id,name,ifnull(mrpAmt,0.0) mrpAmt,ifnull(netAmt,0.0) netAmt from st_lms_organization_master om right outer join (select parent_id,sum(mrpAmt) mrpAmt,sum(netAmt) netAmt from st_lms_organization_master oms,(select organization_id,sum(mrpAmt) mrpAmt,sum(netAmt) netAmt from(&quot;);
			
			
			

			
				saleQry.append(indGameQry.replaceAll(&quot;\\*&quot;, String.valueOf(gameNo)));
			
			saleQry.delete(saleQry.length() - 10, saleQry.length());
			saleQry
					.append(&quot;) saleTbl group by organization_id) saleTbl where saleTbl.organization_id = oms.organization_id group by parent_id)saleTlb on saleTlb.parent_id=om.organization_id&quot;);
*/
<span class="nc" id="L1844">			pstmt = con.prepareStatement(&quot; select om.organization_id,name,ifnull(mrpAmt,0.0) mrpAmt,ifnull(netAmt,0.0) netAmt from st_lms_organization_master om left outer join(select parent_id,sum(mrpAmt) mrpAmt,sum(netAmt) netAmt from st_lms_organization_master oms,(select retailer_org_id,sum(mrp_amt) mrpAmt,sum(agent_net_amt) netAmt from st_dg_ret_sale_? where transaction_id in(select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_SALE','DG_SALE_OFFLINE') and transaction_date&gt;=? and transaction_date&lt;=? and transaction_id  not in(select ref_transaction_id from st_dg_ret_sale_refund_? refund inner join  st_lms_retailer_transaction_master rtm on refund.transaction_id=rtm.transaction_id where transaction_type in('DG_REFUND_CANCEL','DG_REFUND_FAILED') and date(transaction_date)&gt;=date(?) and date(transaction_date)&lt;=date(?)))group by retailer_org_id) saleTbl where saleTbl.retailer_org_id = oms.organization_id group by parent_id)saleTlb on saleTlb.parent_id=om.organization_id where om.organization_type='AGENT'&quot;);</span>
			//pstmt = con.createStatement();
<span class="nc" id="L1846">			pstmt.setInt(1, gameNo);</span>
<span class="nc" id="L1847">			pstmt.setTimestamp(2, startDate);</span>
<span class="nc" id="L1848">			pstmt.setTimestamp(3, toDate);</span>
<span class="nc" id="L1849">			pstmt.setInt(4, gameNo);</span>
<span class="nc" id="L1850">			pstmt.setTimestamp(5, weekStartDate);</span>
<span class="nc" id="L1851">			pstmt.setTimestamp(6, weekEndDate);</span>
<span class="nc" id="L1852">			logger.info(&quot;----Agent Time wise Qry---&quot; + pstmt);</span>
			//rs = pstmt.executeQuery();
<span class="nc" id="L1854">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1855" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1856">				reportsBean = new SalePwtReportsBean();</span>
<span class="nc" id="L1857">				reportsBean.setGameName(rs.getString(&quot;name&quot;));</span>
<span class="nc" id="L1858">				reportsBean.setGameNo(rs.getInt(&quot;organization_id&quot;));</span>
<span class="nc" id="L1859">				reportsBean.setSaleMrpAmt(rs.getDouble(&quot;mrpAmt&quot;));</span>
<span class="nc" id="L1860">				reportsBean.setSaleNetAmt(rs.getDouble(&quot;netAmt&quot;));</span>
<span class="nc" id="L1861">				reportMap.put(rs.getInt(&quot;organization_id&quot;), reportsBean);</span>
			}
<span class="nc" id="L1863">		} catch (Exception e) {</span>
<span class="nc" id="L1864">			e.printStackTrace();</span>
<span class="nc" id="L1865">			throw new LMSException();</span>
			
		} finally {
<span class="nc" id="L1868">			con.close();</span>
<span class="nc" id="L1869">		}</span>
<span class="nc" id="L1870">		return reportMap;</span>
	}
	
	public Map&lt;Integer, SalePwtReportsBean&gt; iwSaleAgentWiseWeeklyTimeWiseNew(Timestamp startDate, Timestamp toDate, Timestamp weekStartDate, Timestamp weekEndDate, int gameNo) throws SQLException, LMSException {
<span class="nc" id="L1874">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L1875">		PreparedStatement pstmt = null;</span>
		// Statement pstmt = null;
<span class="nc" id="L1877">		ResultSet rs = null;</span>
<span class="nc" id="L1878">		SalePwtReportsBean reportsBean = null;</span>
<span class="nc" id="L1879">		Map&lt;Integer, SalePwtReportsBean&gt; reportMap = new HashMap&lt;Integer, SalePwtReportsBean&gt;();</span>
		try {
<span class="nc" id="L1881">			pstmt = con</span>
					.prepareStatement(&quot;select om.organization_id,name,ifnull(mrpAmt,0.0) mrpAmt,ifnull(netAmt,0.0) netAmt from st_lms_organization_master om left outer join(select parent_id,sum(mrpAmt) mrpAmt,sum(netAmt) netAmt from st_lms_organization_master oms,(select retailer_org_id,sum(mrp_amt) mrpAmt,sum(agent_net_amt) netAmt from st_iw_ret_sale where game_id = ? and transaction_id in(select transaction_id from st_lms_retailer_transaction_master where transaction_type in('IW_SALE') and transaction_date&gt;=? and transaction_date&lt;=? and transaction_id  not in(select sale_ref_transaction_id from st_iw_ret_sale_refund refund inner join  st_lms_retailer_transaction_master rtm on refund.transaction_id=rtm.transaction_id where refund.game_id = ? and transaction_type in('IW_REFUND_CANCEL','IW_REFUND_FAILED') and date(rtm.transaction_date)&gt;=date(?) and date(rtm.transaction_date)&lt;=date(?)))group by retailer_org_id) saleTbl where saleTbl.retailer_org_id = oms.organization_id group by parent_id)saleTlb on saleTlb.parent_id=om.organization_id where om.organization_type='AGENT';&quot;);
<span class="nc" id="L1883">			pstmt.setInt(1, gameNo);</span>
<span class="nc" id="L1884">			pstmt.setTimestamp(2, startDate);</span>
<span class="nc" id="L1885">			pstmt.setTimestamp(3, toDate);</span>
<span class="nc" id="L1886">			pstmt.setInt(4, gameNo);</span>
<span class="nc" id="L1887">			pstmt.setTimestamp(5, weekStartDate);</span>
<span class="nc" id="L1888">			pstmt.setTimestamp(6, weekEndDate);</span>
<span class="nc" id="L1889">			logger.info(&quot;---- IW Agent Time wise Qry---&quot; + pstmt);</span>
			// rs = pstmt.executeQuery();
<span class="nc" id="L1891">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1892" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1893">				reportsBean = new SalePwtReportsBean();</span>
<span class="nc" id="L1894">				reportsBean.setGameName(rs.getString(&quot;name&quot;));</span>
<span class="nc" id="L1895">				reportsBean.setGameNo(rs.getInt(&quot;organization_id&quot;));</span>
<span class="nc" id="L1896">				reportsBean.setSaleMrpAmt(rs.getDouble(&quot;mrpAmt&quot;));</span>
<span class="nc" id="L1897">				reportsBean.setSaleNetAmt(rs.getDouble(&quot;netAmt&quot;));</span>
<span class="nc" id="L1898">				reportMap.put(rs.getInt(&quot;organization_id&quot;), reportsBean);</span>
			}
<span class="nc" id="L1900">		} catch (Exception e) {</span>
<span class="nc" id="L1901">			e.printStackTrace();</span>
<span class="nc" id="L1902">			throw new LMSException();</span>
		} finally {
<span class="nc" id="L1904">			con.close();</span>
<span class="nc" id="L1905">		}</span>
<span class="nc" id="L1906">		return reportMap;</span>
	}
	
	public void updateTrngExpAgentDataIW(Timestamp updateTime, String fromDate, String toDate, int taskId, int agtOrgId, double trngExpAmt, UserInfoBean userBean, String UpdateMode, String trngExpType,int gameNo, int serviceId, Connection con) throws Exception {
<span class="nc" id="L1910">		PreparedStatement pstmt1 = null;</span>
<span class="nc" id="L1911">		PreparedStatement pstmt2 = null;</span>
<span class="nc" id="L1912">		PreparedStatement pstmt3 = null;</span>
<span class="nc" id="L1913">		PreparedStatement pstmt4 = null;</span>
<span class="nc" id="L1914">		PreparedStatement pstmt5 = null;</span>
<span class="nc" id="L1915">		String reason=&quot;&quot;;</span>
<span class="nc bnc" id="L1916" title="All 2 branches missed.">		String transactionType = trngExpAmt &gt; 0.0 ? &quot;CR_NOTE_CASH&quot;:&quot;DR_NOTE_CASH&quot;;</span>
<span class="nc bnc" id="L1917" title="All 2 branches missed.">		double unsignTrngAmt =  trngExpAmt &gt; 0.0 ? trngExpAmt : (-1) * trngExpAmt;</span>
<span class="nc bnc" id="L1918" title="All 2 branches missed.">		if (&quot;AUTO&quot;.equalsIgnoreCase(UpdateMode)) {</span>
<span class="nc" id="L1919">			HttpServletRequest request = new ManualRequest();</span>
<span class="nc" id="L1920">			request.setAttribute(&quot;code&quot;, &quot;MGMT&quot;);</span>
<span class="nc" id="L1921">			request.setAttribute(&quot;interfaceType&quot;, &quot;WEB&quot;);</span>
<span class="nc" id="L1922">			ServletActionContext.setRequest(request);</span>
		}
<span class="nc" id="L1924">		String updateQry = null;</span>
		try {
<span class="nc" id="L1926">			updateQry = &quot;update st_lms_agent_&quot; + trngExpType.toLowerCase() + &quot;_training_exp set credit_note_number=?, done_by_user_id=?, updated_date=?, updated_mode=? where service_id = &quot; + serviceId + &quot; and agent_org_id=&quot; + agtOrgId + &quot; and id=&quot; + taskId;	</span>

			/*
			 * String updateBoRecieptGenMapping = QueryManager
			 * .updateST5BOReceiptGenMapping();
			 */
			// insert into LMS transaction master
<span class="nc" id="L1933">			String queryLMSTrans = QueryManager.insertInLMSTransactionMaster();</span>
<span class="nc" id="L1934">			pstmt1 = con.prepareStatement(queryLMSTrans);</span>
<span class="nc" id="L1935">			pstmt1.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L1936">			pstmt1.executeUpdate();</span>
<span class="nc" id="L1937">			ResultSet rs1 = pstmt1.getGeneratedKeys();</span>
			// int transaction_id = -1;
<span class="nc" id="L1939">			long transaction_id =-1;</span>
<span class="nc bnc" id="L1940" title="All 2 branches missed.">			if (rs1.next()) {</span>
<span class="nc" id="L1941">				transaction_id = rs1.getLong(1);</span>
			} else {
<span class="nc" id="L1943">				throw new LMSException(&quot;Transaction id is not generated &quot;);</span>
			}
			
<span class="nc" id="L1946">			String updateBoMaster = QueryManager.insertInBOTransactionMaster();</span>
<span class="nc" id="L1947">			pstmt1 = con.prepareStatement(updateBoMaster);</span>
<span class="nc" id="L1948">			pstmt1.setLong(1, transaction_id);</span>
<span class="nc" id="L1949">			pstmt1.setInt(2, userBean.getUserId());</span>
<span class="nc" id="L1950">			pstmt1.setInt(3, userBean.getUserOrgId());</span>
<span class="nc" id="L1951">			pstmt1.setString(4, &quot;AGENT&quot;);</span>
<span class="nc" id="L1952">			pstmt1.setInt(5, agtOrgId);</span>
<span class="nc" id="L1953">			pstmt1.setTimestamp(6, updateTime);</span>
<span class="nc" id="L1954">			pstmt1.setString(7,transactionType);</span>
<span class="nc" id="L1955">			pstmt1.executeUpdate();</span>
<span class="nc" id="L1956">			System.out.println(&quot;insertInBOTransactionMaster&gt;&gt;&gt;&quot; + pstmt1);</span>

<span class="nc" id="L1958">			String updateCreditNote = &quot;insert into st_lms_bo_credit_note(transaction_id,agent_org_id,amount,transaction_type,remarks,reason) values(?,?,?,?,?,?)&quot;;</span>
<span class="nc" id="L1959">			String updateDebitNote = &quot;insert into st_lms_bo_debit_note(transaction_id,agent_org_id,amount,transaction_type,remarks,reason) values(?,?,?,?,?,?)&quot; ;</span>
<span class="nc" id="L1960">			String remarks = null;</span>
<span class="nc bnc" id="L1961" title="All 2 branches missed.">			if (&quot;weekly&quot;.equalsIgnoreCase(trngExpType)) {</span>
<span class="nc" id="L1962">				remarks = &quot;Given as Weekly Training expense for the week from &quot;</span>
						+ fromDate.split(&quot; &quot;)[0] + &quot; to &quot;
						+ toDate.split(&quot; &quot;)[0];
			} else {
<span class="nc" id="L1966">				remarks = &quot;Given as Daily Training expense for the day &quot;</span>
						+ fromDate.split(&quot; &quot;)[0];
			}
<span class="nc bnc" id="L1969" title="All 2 branches missed.">			if(trngExpAmt &gt; 0.0 ){</span>
<span class="nc" id="L1970">				pstmt2 = con.prepareStatement(updateCreditNote);</span>
<span class="nc bnc" id="L1971" title="All 2 branches missed.">				if(trngExpType.equalsIgnoreCase(&quot;WEEKLY&quot;))</span>
<span class="nc" id="L1972">					reason=&quot;CR_WEEKLY_EXP&quot;;</span>
				else
<span class="nc" id="L1974">					reason=&quot;CR_DAILY_EXP&quot;;</span>
			}else{
<span class="nc" id="L1976">				pstmt2 = con.prepareStatement(updateDebitNote);</span>
<span class="nc bnc" id="L1977" title="All 2 branches missed.">				if(trngExpType.equalsIgnoreCase(&quot;WEEKLY&quot;))</span>
<span class="nc" id="L1978">					reason=&quot;DR_WEEKLY_TE_RETURN&quot;;</span>
				else
<span class="nc" id="L1980">					reason=&quot;DR_DAILY_TE_RETURN&quot;;</span>
			}
<span class="nc" id="L1982">			pstmt2.setLong(1, transaction_id);</span>
<span class="nc" id="L1983">			pstmt2.setInt(2, agtOrgId);</span>
<span class="nc" id="L1984">			pstmt2.setDouble(3, unsignTrngAmt);</span>
<span class="nc" id="L1985">			pstmt2.setString(4, transactionType);</span>
<span class="nc" id="L1986">			pstmt2.setString(5, remarks);</span>
<span class="nc" id="L1987">			pstmt2.setString(6, reason);</span>
<span class="nc" id="L1988">			System.out.println(&quot;st_lms_bo_credit/debit_note&gt;&gt;&gt;&quot; + pstmt2);</span>
<span class="nc" id="L1989">			pstmt2.executeUpdate();</span>

<span class="nc" id="L1991">			String fetchCreditNoteLastEntryQuery = &quot;SELECT * from st_lms_bo_receipts where receipt_type=? or receipt_type=? ORDER BY generated_id DESC LIMIT 1&quot;;</span>
<span class="nc" id="L1992">			pstmt4 = con.prepareStatement(fetchCreditNoteLastEntryQuery);</span>
<span class="nc bnc" id="L1993" title="All 2 branches missed.">			if(trngExpAmt &gt; 0.0){</span>
<span class="nc" id="L1994">				pstmt4.setString(1, &quot;CR_NOTE_CASH&quot;);</span>
<span class="nc" id="L1995">				pstmt4.setString(2, &quot;CR_NOTE&quot;);</span>
			}else{
<span class="nc" id="L1997">				pstmt4.setString(1, &quot;DR_NOTE_CASH&quot;);</span>
<span class="nc" id="L1998">				pstmt4.setString(2, &quot;DR_NOTE&quot;);</span>
			}
<span class="nc" id="L2000">			ResultSet recieptRs = pstmt4.executeQuery();</span>
<span class="nc" id="L2001">			String lastRecieptNoGenerated = null;</span>
<span class="nc bnc" id="L2002" title="All 2 branches missed.">			if (recieptRs.next()) {</span>
<span class="nc" id="L2003">				lastRecieptNoGenerated = recieptRs.getString(&quot;generated_id&quot;);</span>
			}
			// create receipt no.
<span class="nc" id="L2006">			String autoGeneRecieptNo = GenerateRecieptNo.getRecieptNo(transactionType, lastRecieptNoGenerated, userBean.getUserType());</span>

			// insert in receipt master table
<span class="nc" id="L2009">			pstmt2 = con.prepareStatement(QueryManager.insertInReceiptMaster());</span>
<span class="nc" id="L2010">			pstmt2.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L2011">			pstmt2.executeUpdate();</span>
<span class="nc" id="L2012">			ResultSet rs2 = pstmt2.getGeneratedKeys();</span>
<span class="nc" id="L2013">			int id = -1;</span>
<span class="nc bnc" id="L2014" title="All 2 branches missed.">			if (rs2.next()) {</span>
<span class="nc" id="L2015">				id = rs2.getInt(1);</span>
			} else {
<span class="nc" id="L2017">				throw new LMSException(&quot;Error in reciept generation&quot;);</span>
			}

			// insert into BO receipt table
<span class="nc" id="L2021">			pstmt2 = con.prepareStatement(QueryManager.insertInBOReceipts());</span>
<span class="nc" id="L2022">			pstmt2.setInt(1, id);</span>
<span class="nc" id="L2023">			pstmt2.setString(2, transactionType);</span>
<span class="nc" id="L2024">			pstmt2.setInt(3, agtOrgId);</span>
<span class="nc" id="L2025">			pstmt2.setString(4, &quot;AGENT&quot;);</span>
<span class="nc" id="L2026">			pstmt2.setString(5, autoGeneRecieptNo);</span>
<span class="nc" id="L2027">			pstmt2.setTimestamp(6, Util.getCurrentTimeStamp());</span>
<span class="nc" id="L2028">			System.out.println(&quot;insertInBOReceipts&gt;&gt;&gt;&quot; + pstmt2);</span>
<span class="nc" id="L2029">			pstmt2.executeUpdate();</span>

			// insert into receipt transaction mapping
<span class="nc" id="L2032">			pstmt3 = con.prepareStatement(QueryManager.insertBOReceiptTrnMapping());</span>
<span class="nc" id="L2033">			pstmt3.setInt(1, id);</span>
<span class="nc" id="L2034">			pstmt3.setLong(2, transaction_id);</span>
<span class="nc" id="L2035">			pstmt3.executeUpdate();</span>

			// update organization account details
			
<span class="nc" id="L2039">			boolean isValid=OrgCreditUpdation.updateOrganizationBalWithValidate(unsignTrngAmt, &quot;TRANSACTION&quot;, transactionType, agtOrgId,</span>
					0, &quot;AGENT&quot;, 0, con);
<span class="nc bnc" id="L2041" title="All 2 branches missed.">			if(!isValid)</span>
<span class="nc" id="L2042">				throw new LMSException();</span>
			
			
			/*OrgCreditUpdation.updateCreditLimitForAgent(agtOrgId,
					transactionType, unsignTrngAmt, con);*/

			// update training expense table

<span class="nc" id="L2050">			pstmt5 = con.prepareStatement(updateQry);</span>
<span class="nc" id="L2051">			pstmt5.setString(1, autoGeneRecieptNo);</span>
<span class="nc" id="L2052">			pstmt5.setInt(2, userBean.getUserId());</span>
<span class="nc" id="L2053">			pstmt5.setTimestamp(3, updateTime);</span>
<span class="nc" id="L2054">			pstmt5.setString(4, UpdateMode);</span>
<span class="nc" id="L2055">			System.out.println(&quot;updating training Expense table.&gt;&gt;&gt;&gt;&quot; + pstmt5);</span>
<span class="nc bnc" id="L2056" title="All 2 branches missed.">			if (pstmt5.executeUpdate() &lt; 1) {</span>
<span class="nc" id="L2057">				throw new LMSException(&quot;training expense table not updated&quot;);</span>
			}
			// following code is commented temp....
			/*
			 * GraphReportHelper graphReportHelper = new GraphReportHelper();
			 * graphReportHelper.createTextReportBO(id, parentOrgName,
			 * userOrgID, (String) session.getAttribute(&quot;ROOT_PATH&quot;));
			 */
<span class="nc" id="L2065">		} catch (Exception e) {</span>
<span class="nc" id="L2066">			e.printStackTrace();</span>
<span class="nc" id="L2067">		}</span>

<span class="nc" id="L2069">	}</span>
	
	
	/**
	 * This method is for updating IW Incentive agentwise.
	 * @param updateTime
	 * @param fromDate
	 * @param toDate
	 * @param taskId
	 * @param agtOrgId
	 * @param trngExpAmt
	 * @param userBean
	 * @param UpdateMode
	 * @param trngExpType
	 * @param gameNo
	 * @param serviceId
	 * @param con
	 * @throws Exception
	 * @author Rishi
	 */
	public void updateAgentDataIWIncentive(Timestamp updateTime, String fromDate, String toDate, int taskId, int agtOrgId, double trngExpAmt, UserInfoBean userBean, String UpdateMode, String trngExpType,int gameNo, int serviceId, Connection con) throws Exception {
<span class="nc" id="L2090">		PreparedStatement pstmt1 = null;</span>
<span class="nc" id="L2091">		PreparedStatement pstmt2 = null;</span>
<span class="nc" id="L2092">		PreparedStatement pstmt3 = null;</span>
<span class="nc" id="L2093">		PreparedStatement pstmt4 = null;</span>
<span class="nc" id="L2094">		PreparedStatement pstmt5 = null;</span>
<span class="nc" id="L2095">		String reason=&quot;&quot;;</span>
<span class="nc bnc" id="L2096" title="All 2 branches missed.">		String transactionType = trngExpAmt &gt; 0.0 ? &quot;CR_NOTE_CASH&quot;:&quot;DR_NOTE_CASH&quot;;</span>
<span class="nc bnc" id="L2097" title="All 2 branches missed.">		double unsignTrngAmt =  trngExpAmt &gt; 0.0 ? trngExpAmt : (-1) * trngExpAmt;</span>
<span class="nc bnc" id="L2098" title="All 2 branches missed.">		if (&quot;AUTO&quot;.equalsIgnoreCase(UpdateMode)) {</span>
<span class="nc" id="L2099">			HttpServletRequest request = new ManualRequest();</span>
<span class="nc" id="L2100">			request.setAttribute(&quot;code&quot;, &quot;MGMT&quot;);</span>
<span class="nc" id="L2101">			request.setAttribute(&quot;interfaceType&quot;, &quot;WEB&quot;);</span>
<span class="nc" id="L2102">			ServletActionContext.setRequest(request);</span>
		}
<span class="nc" id="L2104">		String updateQry = null;</span>
		try {
			//statement = con.createStatement();
<span class="nc" id="L2107">			updateQry = &quot;update st_lms_agent_&quot; + trngExpType.toLowerCase() + &quot;_training_exp set incentive_credit_note_number=?, done_by_user_id=?, updated_date=?, updated_mode=? where service_id = &quot; + serviceId + &quot; and agent_org_id=&quot; + agtOrgId + &quot; and id=&quot; + taskId;</span>

			/*
			 * String updateBoRecieptGenMapping = QueryManager
			 * .updateST5BOReceiptGenMapping();
			 */
			// insert into LMS transaction master
<span class="nc" id="L2114">			String queryLMSTrans = QueryManager.insertInLMSTransactionMaster();</span>
<span class="nc" id="L2115">			pstmt1 = con.prepareStatement(queryLMSTrans);</span>
<span class="nc" id="L2116">			pstmt1.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L2117">			pstmt1.executeUpdate();</span>
<span class="nc" id="L2118">			ResultSet rs1 = pstmt1.getGeneratedKeys();</span>
			// int transaction_id = -1;
<span class="nc" id="L2120">			long transaction_id =-1;</span>
<span class="nc bnc" id="L2121" title="All 2 branches missed.">			if (rs1.next()) {</span>
<span class="nc" id="L2122">				transaction_id = rs1.getLong(1);</span>
			} else {
<span class="nc" id="L2124">				throw new LMSException(&quot;Transaction id is not generated &quot;);</span>
			}
			
<span class="nc" id="L2127">			String updateBoMaster = QueryManager.insertInBOTransactionMaster();</span>
<span class="nc" id="L2128">			pstmt1 = con.prepareStatement(updateBoMaster);</span>
<span class="nc" id="L2129">			pstmt1.setLong(1, transaction_id);</span>
<span class="nc" id="L2130">			pstmt1.setInt(2, userBean.getUserId());</span>
<span class="nc" id="L2131">			pstmt1.setInt(3, userBean.getUserOrgId());</span>
<span class="nc" id="L2132">			pstmt1.setString(4, &quot;AGENT&quot;);</span>
<span class="nc" id="L2133">			pstmt1.setInt(5, agtOrgId);</span>
<span class="nc" id="L2134">			pstmt1.setTimestamp(6, updateTime);</span>
<span class="nc" id="L2135">			pstmt1.setString(7,transactionType);</span>
<span class="nc" id="L2136">			pstmt1.executeUpdate();</span>
<span class="nc" id="L2137">			System.out.println(&quot;insertInBOTransactionMaster&gt;&gt;&gt;&quot; + pstmt1);</span>

<span class="nc" id="L2139">			String updateCreditNote = &quot;insert into st_lms_bo_credit_note(transaction_id,agent_org_id,amount,transaction_type,remarks,reason) values(?,?,?,?,?,?)&quot;;</span>
<span class="nc" id="L2140">			String updateDebitNote = &quot;insert into st_lms_bo_debit_note(transaction_id,agent_org_id,amount,transaction_type,remarks,reason) values(?,?,?,?,?,?)&quot; ;</span>
<span class="nc" id="L2141">			String remarks = null;</span>
<span class="nc bnc" id="L2142" title="All 2 branches missed.">			if (&quot;weekly&quot;.equalsIgnoreCase(trngExpType)) {</span>
<span class="nc" id="L2143">				remarks = &quot;Given as Weekly Incentive for the week from &quot;</span>
						+ fromDate.split(&quot; &quot;)[0] + &quot; to &quot;
						+ toDate.split(&quot; &quot;)[0];
			} else {
<span class="nc" id="L2147">				remarks = &quot;Given as Daily Incentive for the day &quot;</span>
						+ fromDate.split(&quot; &quot;)[0];
			}
<span class="nc bnc" id="L2150" title="All 2 branches missed.">			if(trngExpAmt &gt; 0.0 ){</span>
<span class="nc" id="L2151">				pstmt2 = con.prepareStatement(updateCreditNote);</span>
<span class="nc bnc" id="L2152" title="All 2 branches missed.">				if(trngExpType.equalsIgnoreCase(&quot;WEEKLY&quot;))</span>
<span class="nc" id="L2153">					reason=&quot;CR_WEEKLY_INCENTIVE&quot;;</span>
				else
<span class="nc" id="L2155">					reason=&quot;CR_DAILY_INCENTIVE&quot;;</span>
			}else{
<span class="nc" id="L2157">				pstmt2 = con.prepareStatement(updateDebitNote);</span>
<span class="nc bnc" id="L2158" title="All 2 branches missed.">				if(trngExpType.equalsIgnoreCase(&quot;WEEKLY&quot;))</span>
<span class="nc" id="L2159">					reason=&quot;DR_WEEKLY_TE_RETURN&quot;;</span>
				else
<span class="nc" id="L2161">					reason=&quot;DR_DAILY_TE_RETURN&quot;;</span>
			}
<span class="nc" id="L2163">			pstmt2.setLong(1, transaction_id);</span>
<span class="nc" id="L2164">			pstmt2.setInt(2, agtOrgId);</span>
<span class="nc" id="L2165">			pstmt2.setDouble(3, unsignTrngAmt);</span>
<span class="nc" id="L2166">			pstmt2.setString(4, transactionType);</span>
<span class="nc" id="L2167">			pstmt2.setString(5, remarks);</span>
<span class="nc" id="L2168">			pstmt2.setString(6, reason);</span>
<span class="nc" id="L2169">			System.out.println(&quot;st_lms_bo_credit/debit_note&gt;&gt;&gt;&quot; + pstmt2);</span>
<span class="nc" id="L2170">			pstmt2.executeUpdate();</span>

<span class="nc" id="L2172">			String fetchCreditNoteLastEntryQuery = &quot;SELECT * from st_lms_bo_receipts where receipt_type=? or receipt_type=? ORDER BY generated_id DESC LIMIT 1&quot;;</span>
<span class="nc" id="L2173">			pstmt4 = con.prepareStatement(fetchCreditNoteLastEntryQuery);</span>
<span class="nc bnc" id="L2174" title="All 2 branches missed.">			if(trngExpAmt &gt; 0.0){</span>
<span class="nc" id="L2175">				pstmt4.setString(1, &quot;CR_NOTE_CASH&quot;);</span>
<span class="nc" id="L2176">				pstmt4.setString(2, &quot;CR_NOTE&quot;);</span>
			}else{
<span class="nc" id="L2178">				pstmt4.setString(1, &quot;DR_NOTE_CASH&quot;);</span>
<span class="nc" id="L2179">				pstmt4.setString(2, &quot;DR_NOTE&quot;);</span>
			}
<span class="nc" id="L2181">			ResultSet recieptRs = pstmt4.executeQuery();</span>
<span class="nc" id="L2182">			String lastRecieptNoGenerated = null;</span>
<span class="nc bnc" id="L2183" title="All 2 branches missed.">			if (recieptRs.next()) {</span>
<span class="nc" id="L2184">				lastRecieptNoGenerated = recieptRs.getString(&quot;generated_id&quot;);</span>
			}
			// create receipt no.
<span class="nc" id="L2187">			String autoGeneRecieptNo = GenerateRecieptNo.getRecieptNo(transactionType, lastRecieptNoGenerated, userBean.getUserType());</span>

			// insert in receipt master table
<span class="nc" id="L2190">			pstmt2 = con.prepareStatement(QueryManager.insertInReceiptMaster());</span>
<span class="nc" id="L2191">			pstmt2.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L2192">			pstmt2.executeUpdate();</span>
<span class="nc" id="L2193">			ResultSet rs2 = pstmt2.getGeneratedKeys();</span>
<span class="nc" id="L2194">			int id = -1;</span>
<span class="nc bnc" id="L2195" title="All 2 branches missed.">			if (rs2.next()) {</span>
<span class="nc" id="L2196">				id = rs2.getInt(1);</span>
			} else {
<span class="nc" id="L2198">				throw new LMSException(&quot;Error in reciept generation&quot;);</span>
			}

			// insert into BO receipt table
<span class="nc" id="L2202">			pstmt2 = con.prepareStatement(QueryManager.insertInBOReceipts());</span>
<span class="nc" id="L2203">			pstmt2.setInt(1, id);</span>
<span class="nc" id="L2204">			pstmt2.setString(2, transactionType);</span>
<span class="nc" id="L2205">			pstmt2.setInt(3, agtOrgId);</span>
<span class="nc" id="L2206">			pstmt2.setString(4, &quot;AGENT&quot;);</span>
<span class="nc" id="L2207">			pstmt2.setString(5, autoGeneRecieptNo);</span>
<span class="nc" id="L2208">			pstmt2.setTimestamp(6, Util.getCurrentTimeStamp());</span>
<span class="nc" id="L2209">			System.out.println(&quot;insertInBOReceipts&gt;&gt;&gt;&quot; + pstmt2);</span>
<span class="nc" id="L2210">			pstmt2.executeUpdate();</span>

			// insert into receipt transaction mapping
<span class="nc" id="L2213">			pstmt3 = con.prepareStatement(QueryManager.insertBOReceiptTrnMapping());</span>
<span class="nc" id="L2214">			pstmt3.setInt(1, id);</span>
<span class="nc" id="L2215">			pstmt3.setLong(2, transaction_id);</span>
<span class="nc" id="L2216">			pstmt3.executeUpdate();</span>

			// update organization account details
			
<span class="nc" id="L2220">			boolean isValid=OrgCreditUpdation.updateOrganizationBalWithValidate(unsignTrngAmt, &quot;TRANSACTION&quot;, transactionType, agtOrgId,</span>
					0, &quot;AGENT&quot;, 0, con);
<span class="nc bnc" id="L2222" title="All 2 branches missed.">			if(!isValid)</span>
<span class="nc" id="L2223">				throw new LMSException();</span>
			
			
			/*OrgCreditUpdation.updateCreditLimitForAgent(agtOrgId,
					transactionType, unsignTrngAmt, con);*/

			// update training expense table

<span class="nc" id="L2231">			pstmt5 = con.prepareStatement(updateQry);</span>
<span class="nc" id="L2232">			pstmt5.setString(1, autoGeneRecieptNo);</span>
<span class="nc" id="L2233">			pstmt5.setInt(2, userBean.getUserId());</span>
<span class="nc" id="L2234">			pstmt5.setTimestamp(3, updateTime);</span>
<span class="nc" id="L2235">			pstmt5.setString(4, UpdateMode);</span>
<span class="nc" id="L2236">			System.out.println(&quot;updating training Expense table.&gt;&gt;&gt;&gt;&quot; + pstmt5);</span>
<span class="nc bnc" id="L2237" title="All 2 branches missed.">			if (pstmt5.executeUpdate() &lt; 1) {</span>
<span class="nc" id="L2238">				throw new LMSException(&quot;training expense table not updated&quot;);</span>
			}
			// following code is commented temp....
			/*
			 * GraphReportHelper graphReportHelper = new GraphReportHelper();
			 * graphReportHelper.createTextReportBO(id, parentOrgName,
			 * userOrgID, (String) session.getAttribute(&quot;ROOT_PATH&quot;));
			 */
<span class="nc" id="L2246">		} catch (Exception e) {</span>
<span class="nc" id="L2247">			e.printStackTrace();</span>
<span class="nc" id="L2248">		}</span>

<span class="nc" id="L2250">	}</span>
	
	/**
	 * This method is for updating approval status after generating CR Note Number.
	 * @param taskId
	 * @param con
	 * @throws LMSException
	 * @author Rishi
	 */
	public void updateApprovalStatus(int taskId,Connection con, String trngExpType) throws LMSException{
<span class="nc" id="L2260">		String query = null;</span>
<span class="nc" id="L2261">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L2262">		int isUpdated = 0;</span>
		try{
<span class="nc" id="L2264">			logger.info(&quot;In update Approval&quot;);</span>
<span class="nc" id="L2265">			query = &quot;Update st_lms_agent_&quot;+trngExpType+&quot;_training_exp SET status = 'DONE' Where id=?&quot;;</span>
<span class="nc" id="L2266">			pstmt = con.prepareStatement(query);</span>
<span class="nc" id="L2267">			pstmt.setInt(1, taskId);</span>
<span class="nc" id="L2268">			isUpdated = pstmt.executeUpdate();</span>
<span class="nc bnc" id="L2269" title="All 2 branches missed.">			if(isUpdated == 0){</span>
<span class="nc" id="L2270">				throw new LMSException();</span>
			}
<span class="nc" id="L2272">		}catch(Exception e){</span>
<span class="nc" id="L2273">			e.printStackTrace();</span>
		} finally{
<span class="nc" id="L2275">			DBConnect.closeResource(pstmt);</span>
<span class="nc" id="L2276">		}</span>
<span class="nc" id="L2277">	}</span>
	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>