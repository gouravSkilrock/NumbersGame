<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PlayerPWTVerifyHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lms</a> &gt; <a href="index.source.html" class="el_package">com.skilrock.lms.coreEngine.accMgmt.common</a> &gt; <span class="el_source">PlayerPWTVerifyHelper.java</span></div><h1>PlayerPWTVerifyHelper.java</h1><pre class="source lang-java linenums">package com.skilrock.lms.coreEngine.accMgmt.common;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import com.skilrock.lms.beans.PlayerBean;
import com.skilrock.lms.beans.PwtBean;
import com.skilrock.lms.common.db.DBConnect;
import com.skilrock.lms.common.db.QueryManager;
import com.skilrock.lms.common.db.TableConstants;
import com.skilrock.lms.common.exception.LMSException;
import com.skilrock.lms.common.utility.GameUtilityHelper;
import com.skilrock.lms.common.utility.GenerateRecieptNo;
import com.skilrock.lms.common.utility.MD5Encoder;
import com.skilrock.lms.web.drawGames.common.Util;

/**
 * This is a helper class for Player Verification.
 * 
 * @author Skilrock Technologies
 * 
 */
<span class="nc" id="L32">public class PlayerPWTVerifyHelper {</span>
	/**
	 * Search Player
	 * 
	 * @param searchMap
	 * @return List
	 * @throws LMSException
	 */
<span class="nc" id="L40">	static Log logger = LogFactory.getLog(PlayerPWTVerifyHelper.class);</span>

	// this methos is commented because it is not refrenced any where in LMS
	/*
	 * public int donePWTProcess(int gameId, int playerId, List pwtList,
	 * Connection connection) throws LMSException{ List&lt;PwtBean&gt; pwt = pwtList;
	 * 
	 * //Connection connection = null; Statement statement = null; int
	 * transaction_id = -1; double net_amt = 0; double pwtAmt = 0; boolean flag =
	 * false; int id=-1; ResultSet resultSet = null;
	 * 
	 * Statement st = null; PreparedStatement prepare1 = null; PreparedStatement
	 * prepare2 = null; PreparedStatement prepare3 = null; PreparedStatement
	 * prepare4 = null; PreparedStatement prepare5 = null; PreparedStatement
	 * prepare6 = null;
	 * 
	 * String query1 = QueryManager.getST5CashTransactionQuery(); String query2 =
	 * QueryManager.getST5PlrPWTCommRateQuery() + gameId; String query3 =
	 * QueryManager.getST5DirectPlayerTransactionQuery(); // update pwt status
	 * String query4 = QueryManager.getST5PwtBODetailQuery();
	 * 
	 * 
	 * String query5 = QueryManager.getST4InsertBoReceipts(); String query6 =
	 * QueryManager.getST4InsertBoReceiptsTrnMapping();
	 * 
	 * try {
	 * 
	 * if (connection == null) { System.out .println(&quot;Connection in the
	 * donePWTProcess method without session &quot; + connection);
	 * 
	 *   connection =
	 * dbConnect.getConnection(); connection.setAutoCommit(false); } System.out
	 * .println(&quot;Connection in the donePWTProcess method by session &quot; +
	 * connection); //java.util.Date current_date = new java.util.Date();
	 * //java.sql.Date CURRENT_DATE = new java.sql.Date(current_date //
	 * .getTime());
	 * 
	 * prepare1 = connection.prepareStatement(query1);
	 * 
	 * prepare1.setString(1, &quot;PLAYER&quot;); prepare1.setInt(2, playerId);
	 * prepare1.setTimestamp(3, new java.sql.Timestamp(new java.util.Date()
	 * .getTime())); prepare1.setString(4, &quot;PWT_PLR&quot;); prepare1.executeUpdate();
	 * resultSet = prepare1.getGeneratedKeys(); resultSet.next(); transaction_id =
	 * resultSet.getInt(1); if(!(transaction_id&gt;0)){
	 * 
	 * return -1; } ServletContext sc=ServletActionContext.getServletContext();
	 * String govt_pwt_comm_rate1=(String)sc.getAttribute(&quot;GOVT_COMM_RATE&quot;);
	 * //String govt_pwt_comm_rate1 =
	 * properties.getProperty(&quot;govt_pwt_comm_rate&quot;);
	 * 
	 * int govt_pwt_comm_rate2 = Integer.parseInt(govt_pwt_comm_rate1);
	 * 
	 * String virnCode = pwt.get(0).getVirnCode(); int virnCode1 =
	 * Integer.parseInt(virnCode); String pwtamt = pwt.get(0).getPwtAmount();
	 * pwtAmt = Double.parseDouble(pwtamt); TaxCalculation tx=new
	 * TaxCalculation(); double income_tax=0.0; double calculatedincomeTax=0.0;
	 * income_tax = tx.returnTaxAmount(pwtAmt);
	 * calculatedincomeTax=(double)(pwtAmt * income_tax / 100); net_amt =
	 * (double) (pwtAmt - calculatedincomeTax); prepare2 =
	 * connection.prepareStatement(query3); prepare2.setString(1,
	 * getEncodedVirnCode(virnCode)); prepare2.setInt(2, transaction_id);
	 * prepare2.setInt(3, gameId); prepare2.setInt(4, playerId);
	 * prepare2.setDouble(5, pwtAmt); prepare2.setDouble(6,
	 * calculatedincomeTax); prepare2.setDouble(7, net_amt);
	 * prepare2.setTimestamp(8, new java.sql.Timestamp(new java.util.Date()
	 * .getTime())); //prepare2.setDate(8, CURRENT_DATE);
	 * prepare2.executeUpdate(); ////
	 * 
	 * 
	 * //update total prize remaining of that game
	 * GameUtilityHelper.updateNoOfPrizeRem(gameId, pwtAmt, &quot;CLAIM_PLR&quot;,
	 * getEncodedVirnCode(virnCode), connection );
	 * 
	 * //update pwt status = 'CLAIM_PLR' in st_pwt_inv table prepare3 =
	 * connection.prepareStatement(query4); prepare3.setInt(1, gameId);
	 * prepare3.setString(2, getEncodedVirnCode(virnCode));
	 * prepare3.executeUpdate();
	 * 
	 * 
	 * 
	 * 
	 * 
	 * prepare4 = connection.prepareStatement(query5); prepare4.setString(1,
	 * &quot;RECEIPT&quot;); prepare4.setString(2, null); prepare4.executeUpdate();
	 * ResultSet rss = prepare4.getGeneratedKeys(); rss.next(); id =
	 * rss.getInt(1);
	 * 
	 * prepare5 = connection.prepareStatement(query6); prepare5.setInt(1, id);
	 * prepare5.setInt(2, transaction_id); prepare5.executeUpdate();
	 * 
	 * connection.commit(); flag = true; }
	 * 
	 * catch (SQLException e) { logger.error(&quot;Exception: &quot;+e);
	 * e.printStackTrace(); throw new LMSException(e); } catch (IOException ee) {
	 * 
	 * ee.printStackTrace(); throw new LMSException(ee); }
	 * 
	 * 
	 * finally {
	 * 
	 * try {
	 * 
	 * if (statement != null) { statement.close(); } if (connection != null) {
	 * connection.close(); } } catch (SQLException se) { se.printStackTrace();
	 * throw new LMSException(se); } }
	 * 
	 * return id; }
	 */
	/**
	 * In this method the net payed PWT will be committed.
	 * 
	 * @param gameId
	 * @param playerId
	 * @param pwtAmt
	 * @param tax
	 * @param virnCode
	 * @param tempTransactionId
	 * @return int
	 * @throws LMSException
	 */
	public int CommitPWTProcess(int gameId, int playerId, double pwtAmt,
			double tax, String virnCode, int tempTransactionId,
			String chequeNbr, String draweeBank, String issuingParty,
			java.sql.Date chqDate, int userOrgId, int userId, int gameNbr)
			throws LMSException {

		// Connection connection = null;
<span class="nc" id="L167">		Statement statement = null;</span>
<span class="nc" id="L168">		int transaction_id = -1;</span>
<span class="nc" id="L169">		double net_amt = 0.0;</span>

<span class="nc" id="L171">		int id = -1;</span>
<span class="nc" id="L172">		String autoGeneRecieptNo = null;</span>
<span class="nc" id="L173">		ResultSet resultSet = null;</span>
<span class="nc" id="L174">		Connection connection = null;</span>
<span class="nc" id="L175">		PreparedStatement prepare1 = null;</span>
<span class="nc" id="L176">		PreparedStatement prepare2 = null;</span>
<span class="nc" id="L177">		PreparedStatement prepare3 = null;</span>
<span class="nc" id="L178">		PreparedStatement prepare4 = null;</span>
<span class="nc" id="L179">		PreparedStatement prepare5 = null;</span>
<span class="nc" id="L180">		PreparedStatement prepare6 = null;</span>
<span class="nc" id="L181">		String query1 = QueryManager.insertInBOTransactionMaster();</span>
<span class="nc" id="L182">		String LMSTransQuery = QueryManager.insertInLMSTransactionMaster();</span>

<span class="nc" id="L184">		String query2 = QueryManager.getST5PlrPWTCommRateQuery() + gameId;</span>

<span class="nc" id="L186">		String query3 = QueryManager.getST5DirectPlayerTransactionQuery();</span>

<span class="nc" id="L188">		String query4 = QueryManager.getST5PwtBODetailQuery();</span>
		// String query5 = QueryManager.getST4InsertBoReceipts();
		// String query6 = QueryManager.getST4InsertBoReceiptsTrnMapping();

<span class="nc" id="L192">		String query7 = QueryManager.getST5UpdateSTBOtempTranction();</span>

		try {

			 
<span class="nc" id="L197">			connection = DBConnect.getConnection();</span>
<span class="nc" id="L198">			connection.setAutoCommit(false);</span>

			// insert into LMS transaction master

<span class="nc" id="L202">			prepare1 = connection.prepareStatement(LMSTransQuery);</span>
<span class="nc" id="L203">			prepare1.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L204">			prepare1.executeUpdate();</span>

<span class="nc" id="L206">			resultSet = prepare1.getGeneratedKeys();</span>
<span class="nc" id="L207">			resultSet.next();</span>
<span class="nc" id="L208">			transaction_id = resultSet.getInt(1);</span>
<span class="nc" id="L209">			logger.debug(&quot;Generated New Transaction Id &quot; + transaction_id);</span>

			// //PWT Entry against the player into bo transaction master

<span class="nc" id="L213">			prepare1 = connection.prepareStatement(query1);</span>

<span class="nc" id="L215">			prepare1.setInt(1, transaction_id);</span>
<span class="nc" id="L216">			prepare1.setInt(2, userId);</span>
<span class="nc" id="L217">			prepare1.setInt(3, userOrgId);</span>
<span class="nc" id="L218">			prepare1.setString(4, &quot;PLAYER&quot;);</span>
<span class="nc" id="L219">			prepare1.setInt(5, playerId);</span>
<span class="nc" id="L220">			prepare1.setTimestamp(6, new java.sql.Timestamp(</span>
					new java.util.Date().getTime()));
<span class="nc" id="L222">			prepare1.setString(7, &quot;PWT_PLR&quot;);</span>

			/*
			 * prepare1.setString(1, &quot;PLAYER&quot;); prepare1.setInt(2, playerId);
			 * prepare1.setTimestamp(3, new java.sql.Timestamp(new
			 * java.util.Date().getTime())); prepare1.setString(4, &quot;PWT_PLR&quot;);
			 */

<span class="nc" id="L230">			prepare1.executeUpdate();</span>

<span class="nc" id="L232">			net_amt = pwtAmt - tax;</span>

<span class="nc" id="L234">			prepare2 = connection.prepareStatement(query3);</span>

<span class="nc" id="L236">			prepare2.setString(1, virnCode);</span>
<span class="nc" id="L237">			prepare2.setInt(2, transaction_id);</span>
<span class="nc" id="L238">			prepare2.setInt(3, gameId);</span>
<span class="nc" id="L239">			prepare2.setInt(4, playerId);</span>
<span class="nc" id="L240">			prepare2.setDouble(5, pwtAmt);</span>
<span class="nc" id="L241">			prepare2.setDouble(6, tax);</span>
<span class="nc" id="L242">			prepare2.setDouble(7, net_amt);</span>
<span class="nc" id="L243">			prepare2.setTimestamp(8, new java.sql.Timestamp(</span>
					new java.util.Date().getTime()));
<span class="nc" id="L245">			prepare2.setString(9, chequeNbr);</span>
<span class="nc" id="L246">			prepare2.setDate(10, chqDate);</span>
<span class="nc" id="L247">			prepare2.setString(11, draweeBank);</span>
<span class="nc" id="L248">			prepare2.setString(12, issuingParty);</span>
			// prepare2.setDate(8, CURRENT_DATE);
<span class="nc" id="L250">			prepare2.executeUpdate();</span>
			// //

			// update total prize remaining of that game
<span class="nc" id="L254">			GameUtilityHelper.updateNoOfPrizeRem(gameId, pwtAmt, &quot;CLAIM_PLR&quot;,</span>
					virnCode, connection, gameNbr);

			// update the status = 'CLAIM_PLR' of virn code in st_pwt_inv table
<span class="nc" id="L258">			prepare3 = connection.prepareStatement(query4);</span>
<span class="nc" id="L259">			prepare3.setInt(1, gameNbr);</span>
<span class="nc" id="L260">			prepare3.setInt(2, gameId);</span>
<span class="nc" id="L261">			prepare3.setString(3, virnCode);</span>
<span class="nc" id="L262">			logger.debug(&quot;query  for update pwt table is &quot; + prepare3);</span>
<span class="nc" id="L263">			prepare3.executeUpdate();</span>

<span class="nc" id="L265">			logger.debug(&quot;--------&quot; + query7 + &quot;--------------tax &quot; + tax</span>
					+ &quot; net_amt &quot; + net_amt);
<span class="nc" id="L267">			prepare6 = connection.prepareStatement(query7);</span>
<span class="nc" id="L268">			prepare6.setString(1, &quot;CLAIM_PLR&quot;);</span>
<span class="nc" id="L269">			prepare6.setDouble(2, tax);</span>
<span class="nc" id="L270">			prepare6.setDouble(3, net_amt);</span>
<span class="nc" id="L271">			prepare6.setInt(4, tempTransactionId);</span>
<span class="nc" id="L272">			prepare6.executeUpdate();</span>

			// get auto generated treciept number
<span class="nc" id="L275">			PreparedStatement autoGenPstmt = null;</span>
			// String getLatestRecieptNumber=&quot;SELECT * from
			// st_bo_receipt_gen_mapping where receipt_type=? ORDER BY
			// generated_id DESC LIMIT 1 &quot;;
<span class="nc" id="L279">			autoGenPstmt = connection.prepareStatement(QueryManager</span>
					.getBOLatestReceiptNb());
<span class="nc" id="L281">			autoGenPstmt.setString(1, &quot;RECEIPT&quot;);</span>
<span class="nc" id="L282">			ResultSet recieptRs = autoGenPstmt.executeQuery();</span>
<span class="nc" id="L283">			String lastRecieptNoGenerated = null;</span>

<span class="nc bnc" id="L285" title="All 2 branches missed.">			while (recieptRs.next()) {</span>
<span class="nc" id="L286">				lastRecieptNoGenerated = recieptRs.getString(&quot;generated_id&quot;);</span>
			}

<span class="nc" id="L289">			autoGeneRecieptNo = GenerateRecieptNo.getRecieptNo(&quot;RECEIPT&quot;,</span>
					lastRecieptNoGenerated, &quot;BO&quot;);

			// insert in receipt master table
<span class="nc" id="L293">			prepare4 = connection.prepareStatement(QueryManager</span>
					.insertInReceiptMaster());
<span class="nc" id="L295">			prepare4.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L296">			prepare4.executeUpdate();</span>

<span class="nc" id="L298">			ResultSet rss = prepare4.getGeneratedKeys();</span>
<span class="nc" id="L299">			rss.next();</span>
<span class="nc" id="L300">			id = rss.getInt(1);</span>

<span class="nc" id="L302">			prepare4 = connection.prepareStatement(QueryManager</span>
					.insertInBOReceipts());

<span class="nc" id="L305">			prepare4.setInt(1, id);</span>
<span class="nc" id="L306">			prepare4.setString(2, &quot;RECEIPT&quot;);</span>
<span class="nc" id="L307">			prepare4.setInt(3, playerId);</span>
<span class="nc" id="L308">			prepare4.setString(4, &quot;PLAYER&quot;);</span>
<span class="nc" id="L309">			prepare4.setString(5, autoGeneRecieptNo);</span>
<span class="nc" id="L310">			prepare4.setTimestamp(6, Util.getCurrentTimeStamp());</span>

			/*
			 * //prepare4.setString(1, autoGeneRecieptNo); prepare4.setString(1,
			 * &quot;RECEIPT&quot;); prepare4.setString(2, null);
			 */
<span class="nc" id="L316">			prepare4.executeUpdate();</span>

<span class="nc" id="L318">			prepare5 = connection.prepareStatement(QueryManager</span>
					.insertBOReceiptTrnMapping());
<span class="nc" id="L320">			prepare5.setInt(1, id);</span>
<span class="nc" id="L321">			prepare5.setInt(2, transaction_id);</span>
<span class="nc" id="L322">			prepare5.executeUpdate();</span>

			/*
			 * //insert into recipt gen reciept mapping String
			 * updateBoRecieptGenMapping=QueryManager.updateST5BOReceiptGenMapping();
			 * prepare7=connection.prepareStatement(updateBoRecieptGenMapping);
			 * prepare7.setInt(1,id); prepare7.setString(2,autoGeneRecieptNo);
			 * prepare7.setString(3,&quot;RECEIPT&quot;); prepare7.executeUpdate();
			 */

			/*
			 * logger.debug(&quot;--------&quot;+query7 +&quot;--------------tax &quot;+tax+&quot;
			 * net_amt &quot;+net_amt); prepare6 =
			 * connection.prepareStatement(query7); prepare6.setString(1,
			 * &quot;CLAIM_PLR&quot;); prepare6.setDouble(2, tax); prepare6.setDouble(3,
			 * net_amt); prepare6.setInt(4, tempTransactionId);
			 * prepare6.executeUpdate();
			 */

<span class="nc" id="L341">			connection.commit();</span>

		}

<span class="nc" id="L345">		catch (SQLException e) {</span>
<span class="nc" id="L346">			logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L347">			e.printStackTrace();</span>
<span class="nc" id="L348">			throw new LMSException(e);</span>
		}

		finally {

<span class="nc" id="L353">			try {</span>

<span class="nc bnc" id="L355" title="All 4 branches missed.">				if (statement != null) {</span>
<span class="nc" id="L356">					statement.close();</span>
				}
<span class="nc bnc" id="L358" title="All 4 branches missed.">				if (connection != null) {</span>
<span class="nc" id="L359">					connection.close();</span>
				}
<span class="nc" id="L361">			} catch (SQLException se) {</span>
<span class="nc" id="L362">				logger.error(&quot;Exception: &quot; + se);</span>
<span class="nc" id="L363">				se.printStackTrace();</span>
<span class="nc" id="L364">				throw new LMSException(se);</span>
<span class="nc" id="L365">			}</span>

		}

<span class="nc" id="L369">		return id;</span>
	}

	public boolean denyPWTProcess(int transactionId, String virnCode,
			int gameId, String ticketNbr, String denyPwtStatus, int gameNbr)
			throws LMSException {

<span class="nc" id="L376">		boolean statusChange = false;</span>
<span class="nc" id="L377">		Connection connection = null;</span>
		 
<span class="nc" id="L379">		connection = DBConnect.getConnection();</span>
		try {
<span class="nc" id="L381">			connection.setAutoCommit(false);</span>

			// update direct playe temp table
			// 'CANCELLED_PERMANENT':'Permanent Cancellation',
			// 'UNCLM_CANCELLED':'Temporary Cancellation'
<span class="nc" id="L386">			String tempPwtStatus = &quot;&quot;;</span>
<span class="nc" id="L387">			String pwtStatus = &quot;&quot;;</span>
<span class="nc" id="L388">			int isPwtTicketDelete = 0;</span>

<span class="nc bnc" id="L390" title="All 2 branches missed.">			if (&quot;Permanent Cancellation&quot;.equalsIgnoreCase(denyPwtStatus.trim())) {</span>
<span class="nc" id="L391">				tempPwtStatus = &quot;CANCEL&quot;;</span>
<span class="nc" id="L392">				pwtStatus = &quot;CANCELLED_PERMANENT&quot;;</span>
<span class="nc bnc" id="L393" title="All 2 branches missed.">			} else if (&quot;Temporary Cancellation&quot;.equalsIgnoreCase(denyPwtStatus</span>
					.trim())) {
<span class="nc" id="L395">				tempPwtStatus = &quot;CANCEL&quot;;</span>
<span class="nc" id="L396">				pwtStatus = &quot;UNCLM_CANCELLED&quot;;</span>
				// deleted entry in case of Temporary Cancellation
<span class="nc" id="L398">				PreparedStatement pstmtPwtTicketUpdate = connection</span>
						.prepareStatement(&quot;delete from st_se_pwt_tickets_inv_? where game_id=? and ticket_nbr=?&quot;);
<span class="nc" id="L400">				pstmtPwtTicketUpdate.setInt(1, gameNbr);</span>
<span class="nc" id="L401">				pstmtPwtTicketUpdate.setInt(2, gameId);</span>
<span class="nc" id="L402">				pstmtPwtTicketUpdate.setString(3, ticketNbr);</span>
<span class="nc" id="L403">				logger.debug(&quot;update ticket  table:: &quot; + pstmtPwtTicketUpdate);</span>
<span class="nc" id="L404">				isPwtTicketDelete = pstmtPwtTicketUpdate.executeUpdate();</span>
<span class="nc" id="L405">				logger.debug(&quot;query is  &quot; + pstmtPwtTicketUpdate);</span>
			}

<span class="nc" id="L408">			PreparedStatement pstmt = connection</span>
					.prepareStatement(&quot;update st_se_direct_player_pwt_temp_receipt set status=? where pwt_receipt_id=?&quot;);
<span class="nc" id="L410">			pstmt.setString(1, tempPwtStatus);</span>
<span class="nc" id="L411">			pstmt.setInt(2, transactionId);</span>
<span class="nc" id="L412">			int isUpdate = pstmt.executeUpdate();</span>
<span class="nc" id="L413">			logger.debug(&quot;update st_se_direct_player_pwt_temp_receipt ==&quot;</span>
					+ pstmt);

			// update pwt inv table status
<span class="nc" id="L417">			PreparedStatement pstmtPwtInvUpdate = connection</span>
					.prepareStatement(&quot;update st_se_pwt_inv_? set status=? where virn_code=? and game_id=?&quot;);
<span class="nc" id="L419">			pstmtPwtInvUpdate.setInt(1, gameNbr);</span>
<span class="nc" id="L420">			pstmtPwtInvUpdate.setString(2, pwtStatus);</span>
<span class="nc" id="L421">			pstmtPwtInvUpdate.setString(3, virnCode);</span>
<span class="nc" id="L422">			pstmtPwtInvUpdate.setInt(4, gameId);</span>
<span class="nc" id="L423">			int isPwtupdate = pstmtPwtInvUpdate.executeUpdate();</span>
<span class="nc" id="L424">			logger.debug(&quot;update st_pwt_inv ==&quot; + pstmtPwtInvUpdate);</span>

<span class="nc bnc" id="L426" title="All 8 branches missed.">			if (&quot;Temporary Cancellation&quot;.equalsIgnoreCase(denyPwtStatus.trim())</span>
					&amp;&amp; isUpdate == 1 &amp;&amp; isPwtupdate == 1
					&amp;&amp; isPwtTicketDelete == 1) {
<span class="nc" id="L429">				statusChange = true;</span>
<span class="nc" id="L430">				connection.commit();</span>
<span class="nc bnc" id="L431" title="All 6 branches missed.">			} else if (&quot;Permanent Cancellation&quot;.equalsIgnoreCase(denyPwtStatus</span>
					.trim())
					&amp;&amp; isUpdate == 1 &amp;&amp; isPwtupdate == 1) {
<span class="nc" id="L434">				statusChange = true;</span>
<span class="nc" id="L435">				connection.commit();</span>
			}

<span class="nc" id="L438">		} catch (SQLException e) {</span>
<span class="nc" id="L439">			logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L440">			e.printStackTrace();</span>
<span class="nc" id="L441">			throw new LMSException(e);</span>
		} finally {

<span class="nc" id="L444">			try {</span>
<span class="nc bnc" id="L445" title="All 4 branches missed.">				if (connection != null) {</span>
<span class="nc" id="L446">					connection.close();</span>
				}
<span class="nc" id="L448">			} catch (SQLException se) {</span>
<span class="nc" id="L449">				logger.error(&quot;Exception: &quot; + se);</span>
<span class="nc" id="L450">				se.printStackTrace();</span>
<span class="nc" id="L451">				throw new LMSException(se);</span>
<span class="nc" id="L452">			}</span>

		}

<span class="nc" id="L456">		return statusChange;</span>

	}

	/**
	 * To get country code for the country.
	 * 
	 * @param key
	 * @param connection
	 * @return String
	 * @throws SQLException
	 */
	public String getCountryCode(String key, Connection connection)
			throws SQLException {
<span class="nc" id="L470">		String Country_code = null;</span>
<span class="nc" id="L471">		Statement statement = null;</span>
<span class="nc" id="L472">		ResultSet rs = null;</span>

<span class="nc" id="L474">		statement = connection.createStatement();</span>
		// String query1=&quot;select country_code from st_lms_country_master where
		// country_name='&quot;+key+&quot;'&quot;;
<span class="nc" id="L477">		String query1 = QueryManager.getST5CountryCodeQuery() + &quot; where name='&quot;</span>
				+ key + &quot;'&quot;;

<span class="nc" id="L480">		rs = statement.executeQuery(query1);</span>
<span class="nc" id="L481">		rs.next();</span>
<span class="nc" id="L482">		Country_code = rs.getString(&quot;country_code&quot;);</span>

<span class="nc" id="L484">		return Country_code;</span>
	}

	private String getEncodedVirnCode(String virnCode) {

<span class="nc" id="L489">		StringBuffer encodedVirnCode = new StringBuffer(&quot;&quot;);</span>

<span class="nc" id="L491">		encodedVirnCode.append(MD5Encoder.encode(virnCode));</span>

<span class="nc" id="L493">		return encodedVirnCode.toString();</span>
	}

	/**
	 * This method is used to commit the data for Direct Player Pwt Receive but
	 * at this time user player will not get the PWT amount.
	 * 
	 * @param gameId
	 * @param playerId
	 * @param pwtList
	 * @param connection
	 * @return
	 * @throws LMSException
	 */

	/**
	 * To Get State Code
	 * 
	 * @param key
	 * @param countryCode
	 * @param connection
	 * @return String
	 * @throws SQLException
	 */
	public String getStateCode(String key, String countryCode,
			Connection connection) throws SQLException {
<span class="nc" id="L519">		String state_code = null;</span>
<span class="nc" id="L520">		Statement statement = null;</span>
<span class="nc" id="L521">		ResultSet rs = null;</span>

<span class="nc" id="L523">		statement = connection.createStatement();</span>
		// String query1=&quot;select state_code from st_lms_state_master WHERE
		// name='DELHI' and country_code='3'&quot;;
<span class="nc" id="L526">		String query1 = QueryManager.getST5StateCodeQuery() + &quot; where name='&quot;</span>
				+ key + &quot;' and country_code='&quot; + countryCode + &quot;'&quot;;

<span class="nc" id="L529">		rs = statement.executeQuery(query1);</span>
<span class="nc" id="L530">		rs.next();</span>
<span class="nc" id="L531">		state_code = rs.getString(&quot;state_code&quot;);</span>

<span class="nc" id="L533">		return state_code;</span>
	}

	/**
	 * This method is used to make the entry in the
	 * &quot;st_se_direct_player_pwt_temp_receipt&quot;. This table has the Direct Player
	 * Entry against the player for the Virn Code.At this this is Pending PWT.
	 * Later on at the time of net pay this table would be used to display
	 * pending PWTs which have been processed but not yet payyed.
	 * 
	 * @param gameId
	 * @param playerId
	 * @param pwtList
	 * @param connection
	 * @return
	 * @throws LMSException
	 */

	public int partiallyPWTProcess(int gameId, int playerId, List pwtList,
			Connection connection, String ticket_nbr, double pwtApprovalLimit,
			int gameNbr) throws LMSException {
<span class="nc" id="L554">		List&lt;PwtBean&gt; pwt = pwtList;</span>

		// Connection connection = null;
		// Statement statement = null;
<span class="nc" id="L558">		int transaction_id = 0;</span>

<span class="nc" id="L560">		double pwtAmt = 0;</span>
<span class="nc" id="L561">		String pwtStatus = &quot;PND_PWT&quot;;</span>
		// ResultSet resultSet = null;
<span class="nc" id="L563">		PreparedStatement prepare1 = null;</span>
<span class="nc" id="L564">		PreparedStatement pstmtPwt = null;</span>

<span class="nc" id="L566">		String query1 = QueryManager.getST5DirectPlrTempTransactionQuery();</span>
<span class="nc" id="L567">		String updatePwtTableQuery = &quot;update st_se_pwt_inv_? set status=? where virn_code=? and game_id=? &quot;;</span>

		try {

<span class="nc bnc" id="L571" title="All 2 branches missed.">			if (connection == null) {</span>
<span class="nc" id="L572">				System.out</span>
						.println(&quot;Connection in the donePWTProcess method without session  &quot;
								+ connection);

				 
<span class="nc" id="L577">				connection = DBConnect.getConnection();</span>
<span class="nc" id="L578">				connection.setAutoCommit(false);</span>
			}
<span class="nc" id="L580">			System.out</span>
					.println(&quot;Connection in the donePWTProcess method by session &quot;
							+ connection);
<span class="nc" id="L583">			String virnCode = pwt.get(0).getVirnCode();</span>

<span class="nc" id="L585">			String pwtamt = pwt.get(0).getPwtAmount();</span>
<span class="nc" id="L586">			pwtAmt = Double.parseDouble(pwtamt);</span>
<span class="nc bnc" id="L587" title="All 2 branches missed.">			if (pwtAmt &gt;= pwtApprovalLimit) {</span>
<span class="nc" id="L588">				pwtStatus = &quot;PND_ADM&quot;;</span>
			}

<span class="nc" id="L591">			prepare1 = connection.prepareStatement(query1);</span>
<span class="nc" id="L592">			prepare1.setInt(1, playerId);</span>
<span class="nc" id="L593">			prepare1.setTimestamp(2, new java.sql.Timestamp(</span>
					new java.util.Date().getTime()));
<span class="nc" id="L595">			prepare1.setString(3, getEncodedVirnCode(virnCode));</span>
<span class="nc" id="L596">			prepare1.setInt(4, gameId);</span>
<span class="nc" id="L597">			prepare1.setDouble(5, pwtAmt);</span>
<span class="nc" id="L598">			prepare1.setString(6, pwtStatus);</span>
<span class="nc" id="L599">			prepare1.setString(7, ticket_nbr);</span>
<span class="nc" id="L600">			prepare1.executeUpdate();</span>

<span class="nc" id="L602">			ResultSet resultSet = prepare1.getGeneratedKeys();</span>
<span class="nc" id="L603">			resultSet.next();</span>
<span class="nc" id="L604">			transaction_id = resultSet.getInt(1);</span>

<span class="nc" id="L606">			pstmtPwt = connection.prepareStatement(updatePwtTableQuery);</span>
<span class="nc" id="L607">			pstmtPwt.setInt(1, gameNbr);</span>
<span class="nc" id="L608">			pstmtPwt.setString(2, &quot;CLAIM_PLR_TEMP&quot;);</span>
<span class="nc" id="L609">			pstmtPwt.setString(3, getEncodedVirnCode(virnCode));</span>
<span class="nc" id="L610">			pstmtPwt.setInt(4, gameId);</span>
<span class="nc" id="L611">			pstmtPwt.executeUpdate();</span>

<span class="nc" id="L613">			connection.commit();</span>

		}

<span class="nc" id="L617">		catch (SQLException e) {</span>
<span class="nc" id="L618">			logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L619">			e.printStackTrace();</span>
<span class="nc" id="L620">			throw new LMSException(e);</span>
		}

		finally {

<span class="nc" id="L625">			try {</span>
				/*
				 * if (statement != null) { statement.close(); }
				 */
<span class="nc bnc" id="L629" title="All 4 branches missed.">				if (connection != null) {</span>
<span class="nc" id="L630">					connection.close();</span>
				}
<span class="nc" id="L632">			} catch (SQLException se) {</span>
<span class="nc" id="L633">				logger.error(&quot;Exception: &quot; + se);</span>
<span class="nc" id="L634">				se.printStackTrace();</span>
<span class="nc" id="L635">				throw new LMSException(se);</span>
<span class="nc" id="L636">			}</span>

		}

<span class="nc" id="L640">		return transaction_id;</span>
	}

	/**
	 * Register Player
	 * 
	 * @param searchMap
	 * @param connection
	 * @return
	 * @throws LMSException
	 */
	public int registerPlayer(Map searchMap, Connection connection)
			throws LMSException {
		// This connection object is same for whole transaction of the Direct
		// Player.

<span class="nc bnc" id="L656" title="All 2 branches missed.">		if (connection == null) {</span>
<span class="nc" id="L657">			return -1;</span>
		}

		// Connection connection = null;
<span class="nc" id="L661">		PreparedStatement prepareState = null;</span>
<span class="nc" id="L662">		ResultSet resultSet = null;</span>
<span class="nc" id="L663">		String countryCode = null;</span>
<span class="nc" id="L664">		String stateCode = null;</span>
<span class="nc" id="L665">		boolean insetInto = false;</span>
<span class="nc" id="L666">		int playerId = 0;</span>
		try {

<span class="nc" id="L669">			List&lt;PlayerBean&gt; searchResults = new ArrayList&lt;PlayerBean&gt;();</span>

			//  
			// connection = DBConnect.getConnection();
<span class="nc" id="L673">			logger.debug(&quot;Player Contry&quot;</span>
					+ (String) searchMap.get(TableConstants.PLAYER_COUNTRY));
<span class="nc" id="L675">			logger.debug(&quot;Player State&quot;</span>
					+ (String) searchMap.get(TableConstants.PLAYER_STATE));
<span class="nc" id="L677">			countryCode = getCountryCode((String) searchMap</span>
					.get(TableConstants.PLAYER_COUNTRY), connection);
<span class="nc" id="L679">			stateCode = getStateCode((String) searchMap</span>
					.get(TableConstants.PLAYER_STATE), countryCode, connection);
<span class="nc" id="L681">			logger.debug(&quot;Country Code...&quot; + countryCode + &quot; and  StateCode&quot;</span>
					+ stateCode);

<span class="nc" id="L684">			String query = QueryManager.getST5PlayerEntryQuery();</span>

<span class="nc" id="L686">			logger.debug(&quot;-----Query----::&quot; + query);</span>

<span class="nc" id="L688">			prepareState = connection.prepareStatement(query);</span>

			// select
			// a.first_name,a.last_name,a.email_id,a.phone_nbr,a.addr_line1,a.city,d.name
			// 'country',e.name 'state',a.pin_code from st_lms_player_master
			// a,st_lms_country_master d, st_lms_state_master e where
			// a.country_code=d.country_code and a.state_code=e.state_code and
			// a.first_name=? and a.last_name=? and a.photo_id_type=? and
			// a.photo_id_nbr=?
			// first_name,last_name,email_id,phone_nbr,addr_line1,addr_line2,city,state_code,country_code,pin_code,photo_id_type,photo_id_nbr)

<span class="nc" id="L699">			prepareState.setString(1, (String) searchMap</span>
					.get(TableConstants.PLAYER_FIRSTNAME));
<span class="nc" id="L701">			prepareState.setString(2, (String) searchMap</span>
					.get(TableConstants.PLAYER_LASTNAME));
<span class="nc" id="L703">			prepareState.setString(3, (String) searchMap</span>
					.get(TableConstants.PLAYER_EMAIL));
<span class="nc" id="L705">			prepareState.setString(4, (String) searchMap</span>
					.get(TableConstants.PLAYER_PHONE));
<span class="nc" id="L707">			prepareState.setString(5, (String) searchMap</span>
					.get(TableConstants.PLAYER_ADDR1));
<span class="nc" id="L709">			prepareState.setString(6, (String) searchMap</span>
					.get(TableConstants.PLAYER_ADDR2));
<span class="nc" id="L711">			prepareState.setString(7, (String) searchMap</span>
					.get(TableConstants.PLAYER_CITY));
<span class="nc" id="L713">			prepareState.setString(8, stateCode);</span>
<span class="nc" id="L714">			prepareState.setString(9, countryCode);</span>
<span class="nc" id="L715">			prepareState.setLong(10, Long.parseLong((String) searchMap</span>
					.get(TableConstants.PLAYER_PIN)));
<span class="nc" id="L717">			prepareState.setString(11, (String) searchMap</span>
					.get(TableConstants.PLAYER_IDTYPE));
<span class="nc" id="L719">			prepareState.setString(12, (String) searchMap</span>
					.get(TableConstants.PLAYER_IDNUMBER));

<span class="nc" id="L722">			insetInto = prepareState.execute();</span>

<span class="nc" id="L724">			ResultSet rs = prepareState.getGeneratedKeys();</span>
<span class="nc" id="L725">			rs.next();</span>
<span class="nc" id="L726">			playerId = rs.getInt(1);</span>

<span class="nc" id="L728">			System.out</span>
					.println(&quot;SucessFully Inserted into st_lms_player_master Table&quot;);

<span class="nc" id="L731">		} catch (SQLException e) {</span>
<span class="nc" id="L732">			logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L733">			e.printStackTrace();</span>
<span class="nc" id="L734">			throw new LMSException(e);</span>
		} finally {

<span class="nc" id="L737">			try {</span>
<span class="nc bnc" id="L738" title="All 4 branches missed.">				if (resultSet != null) {</span>
<span class="nc" id="L739">					resultSet.close();</span>
				}
<span class="nc bnc" id="L741" title="All 4 branches missed.">				if (prepareState != null) {</span>
<span class="nc" id="L742">					prepareState.close();</span>
				}

<span class="nc" id="L745">			} catch (SQLException se) {</span>
<span class="nc" id="L746">				logger.error(&quot;Exception: &quot; + se);</span>
<span class="nc" id="L747">				throw new LMSException(se);</span>
<span class="nc" id="L748">			}</span>
		}
<span class="nc" id="L750">		return playerId;</span>
	}

	public List searchPlayer(Map searchMap) throws LMSException {
		// / searchMap parameter is having all the search criteria parameters
		// coming from the user end.
<span class="nc" id="L756">		Connection connection = null;</span>
<span class="nc" id="L757">		PreparedStatement prepareState = null;</span>
<span class="nc" id="L758">		ResultSet resultSet = null;</span>

		try {

<span class="nc" id="L762">			PlayerBean plrBean = null;</span>
<span class="nc" id="L763">			List&lt;PlayerBean&gt; searchResults = new ArrayList&lt;PlayerBean&gt;();</span>

			 
<span class="nc" id="L766">			connection = DBConnect.getConnection();</span>

<span class="nc" id="L768">			String query = QueryManager.getST5PlayerDetailQuery();</span>

<span class="nc" id="L770">			logger.debug(&quot;-----Query----::&quot; + query);</span>

<span class="nc" id="L772">			prepareState = connection.prepareStatement(query);</span>

			// select
			// a.first_name,a.last_name,a.email_id,a.phone_nbr,a.addr_line1,a.city,d.name
			// 'country',e.name 'state',a.pin_code from st_lms_player_master
			// a,st_lms_country_master d, st_lms_state_master e where
			// a.country_code=d.country_code and a.state_code=e.state_code and
			// a.first_name=? and a.last_name=? and a.photo_id_type=? and
			// a.photo_id_nbr=?

<span class="nc" id="L782">			prepareState.setString(1, (String) searchMap</span>
					.get(TableConstants.PLAYER_FIRSTNAME));
<span class="nc" id="L784">			prepareState.setString(2, (String) searchMap</span>
					.get(TableConstants.PLAYER_LASTNAME));
<span class="nc" id="L786">			prepareState.setString(3, (String) searchMap</span>
					.get(TableConstants.PLAYER_IDTYPE));
<span class="nc" id="L788">			prepareState.setString(4, (String) searchMap</span>
					.get(TableConstants.PLAYER_IDNUMBER));

<span class="nc" id="L791">			resultSet = prepareState.executeQuery();</span>

<span class="nc" id="L793">			logger.debug(&quot;Result Set forPlayer Search&quot; + resultSet);</span>
<span class="nc bnc" id="L794" title="All 2 branches missed.">			while (resultSet.next()) {</span>
<span class="nc" id="L795">				logger.debug(&quot;State   &quot; + resultSet.getString(&quot;state&quot;));</span>
<span class="nc" id="L796">				plrBean = new PlayerBean();</span>
				// userBean.setUserId(resultSet.getInt(TableConstants.USER_ID));
<span class="nc" id="L798">				plrBean.setPlrId(resultSet.getInt(&quot;player_id&quot;));</span>
<span class="nc" id="L799">				plrBean.setFirstName((String) searchMap</span>
						.get(TableConstants.PLAYER_FIRSTNAME));
<span class="nc" id="L801">				plrBean.setLastName((String) searchMap</span>
						.get(TableConstants.PLAYER_LASTNAME));
<span class="nc" id="L803">				plrBean.setIdType((String) searchMap</span>
						.get(TableConstants.PLAYER_IDTYPE));
<span class="nc" id="L805">				plrBean.setIdNumber((String) searchMap</span>
						.get(TableConstants.PLAYER_IDNUMBER));
<span class="nc" id="L807">				plrBean.setEmailId(resultSet.getString(&quot;email_id&quot;));</span>
<span class="nc" id="L808">				plrBean.setPhone(resultSet.getString(&quot;phone_nbr&quot;));</span>
<span class="nc" id="L809">				plrBean.setPlrAddr1(resultSet.getString(&quot;addr_line1&quot;));</span>
<span class="nc" id="L810">				plrBean.setPlrAddr2(resultSet.getString(&quot;addr_line2&quot;));</span>
<span class="nc" id="L811">				plrBean.setPlrCity(resultSet.getString(&quot;city&quot;));</span>
<span class="nc" id="L812">				plrBean.setPlrState(resultSet.getString(&quot;state&quot;));</span>
<span class="nc" id="L813">				plrBean.setPlrCountry(resultSet.getString(&quot;country&quot;));</span>
<span class="nc" id="L814">				plrBean.setPlrPin(resultSet.getLong(&quot;pin_code&quot;));</span>

<span class="nc" id="L816">				searchResults.add(plrBean);</span>
			}

<span class="nc" id="L819">			return searchResults;</span>

<span class="nc" id="L821">		} catch (SQLException e) {</span>
<span class="nc" id="L822">			logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L823">			e.printStackTrace();</span>
<span class="nc" id="L824">			throw new LMSException(e);</span>
		} finally {

<span class="nc" id="L827">			try {</span>
<span class="nc bnc" id="L828" title="All 4 branches missed.">				if (resultSet != null) {</span>
<span class="nc" id="L829">					resultSet.close();</span>
				}
<span class="nc bnc" id="L831" title="All 4 branches missed.">				if (prepareState != null) {</span>
<span class="nc" id="L832">					prepareState.close();</span>
				}

<span class="nc bnc" id="L835" title="All 4 branches missed.">				if (connection != null) {</span>
<span class="nc" id="L836">					connection.close();</span>
				}
<span class="nc" id="L838">			} catch (SQLException se) {</span>
<span class="nc" id="L839">				logger.error(&quot;Exception: &quot; + se);</span>
<span class="nc" id="L840">				throw new LMSException(se);</span>
<span class="nc" id="L841">			}</span>
		}

	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>