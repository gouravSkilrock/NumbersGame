<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LiveGameReportHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lms</a> &gt; <a href="index.source.html" class="el_package">com.skilrock.lms.coreEngine.reportsMgmt.common</a> &gt; <span class="el_source">LiveGameReportHelper.java</span></div><h1>LiveGameReportHelper.java</h1><pre class="source lang-java linenums">package com.skilrock.lms.coreEngine.reportsMgmt.common;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Timestamp;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.LinkedHashMap;
import java.util.Map;
import java.util.TreeMap;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import com.skilrock.lms.common.db.DBConnect;
import com.skilrock.lms.common.db.QueryManager;
import com.skilrock.lms.common.exception.LMSException;

<span class="nc" id="L22">public class LiveGameReportHelper implements ILiveGameReportHelper{</span>
<span class="nc" id="L23">	static Log logger = LogFactory.getLog(LiveGameReportHelper.class);</span>

	public static void main(String[] args) {
<span class="nc" id="L26">		LiveGameReportHelper helper = new LiveGameReportHelper();</span>
<span class="nc" id="L27">		helper.drawReport(4, new Timestamp(</span>
				new Date().getTime() - 24 * 60 * 1000), new Timestamp(
				new Date().getTime()));
<span class="nc" id="L30">		logger.debug(&quot;******************Scratch Game*************&quot;);</span>
<span class="nc" id="L31">		helper.scratchReport(4, new Timestamp(</span>
				new Date().getTime() - 24 * 60 * 1000), new Timestamp(
				new Date().getTime()));
<span class="nc" id="L34">	}</span>

	public Map&lt;String, String&gt; consolidateLiveGameReport(int agtOrgId,
			Timestamp startDate, Timestamp endDate, boolean isNoCash) {

<span class="nc" id="L39">		Connection con = null;</span>
<span class="nc" id="L40">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L41">		ResultSet rsRetOrg = null;</span>
<span class="nc" id="L42">		ResultSet rsGame = null;</span>
<span class="nc" id="L43">		ResultSet rs = null;</span>
<span class="nc" id="L44">		String gameQry = null;</span>
<span class="nc" id="L45">		String retOrgQry = null;</span>
<span class="nc" id="L46">		String saleQry = null;</span>
<span class="nc" id="L47">		String cancelQry = null;</span>
<span class="nc" id="L48">		String pwtQry = null;</span>
<span class="nc" id="L49">		String cashQry = null;</span>
<span class="nc" id="L50">		String dirPlrPwtQry = null;</span>
<span class="nc" id="L51">		String dirPlrPwtAmt = null;</span>
<span class="nc" id="L52">		Map&lt;Integer, String&gt; orgMap = new LinkedHashMap&lt;Integer, String&gt;();</span>
<span class="nc" id="L53">		Map&lt;String, String&gt; reportMap = new LinkedHashMap&lt;String, String&gt;();</span>
<span class="nc" id="L54">		Map&lt;Integer, Double&gt; saleDrawRetMap = new HashMap&lt;Integer, Double&gt;();</span>
<span class="nc" id="L55">		Map&lt;Integer, Double&gt; cancelDrawRetMap = new HashMap&lt;Integer, Double&gt;();</span>
<span class="nc" id="L56">		Map&lt;Integer, Double&gt; pwtDrawRetMap = new HashMap&lt;Integer, Double&gt;();</span>
<span class="nc" id="L57">		Map&lt;Integer, Double&gt; saleScratchRetMap = new HashMap&lt;Integer, Double&gt;();</span>
<span class="nc" id="L58">		Map&lt;Integer, Double&gt; pwtScratchRetMap = new HashMap&lt;Integer, Double&gt;();</span>
<span class="nc" id="L59">		Map&lt;Integer, Double&gt; cashRetMap = new HashMap&lt;Integer, Double&gt;();</span>
		try {
<span class="nc" id="L61">			con = DBConnect.getConnection();</span>
			// Check if The Report Is AgentWise or RetailerWise
<span class="nc bnc" id="L63" title="All 2 branches missed.">			if(agtOrgId==1)</span>
<span class="nc" id="L64">				retOrgQry = &quot;select &quot;+QueryManager.getOrgCodeQuery()+&quot; , organization_id from st_lms_organization_master where organization_type='RETAILER' order by &quot;+QueryManager.getAppendOrgOrder();</span>
			else
<span class="nc" id="L66">				retOrgQry = &quot;select &quot;+QueryManager.getOrgCodeQuery()+&quot; , organization_id from st_lms_organization_master where parent_id=&quot;+agtOrgId+&quot; order by &quot;+QueryManager.getAppendOrgOrder();</span>
<span class="nc" id="L67">				pstmt = con.prepareStatement(retOrgQry);</span>
<span class="nc" id="L68">				rsRetOrg = pstmt.executeQuery();</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">				while (rsRetOrg.next()) {</span>
<span class="nc" id="L70">					int orgId = rsRetOrg.getInt(&quot;organization_id&quot;);</span>
<span class="nc" id="L71">					orgMap.put(orgId, rsRetOrg.getString(&quot;orgCode&quot;));</span>
<span class="nc" id="L72">					saleDrawRetMap.put(orgId, 0.0);</span>
<span class="nc" id="L73">					cancelDrawRetMap.put(orgId, 0.0);</span>
<span class="nc" id="L74">				pwtDrawRetMap.put(orgId, 0.0);</span>
<span class="nc" id="L75">				saleScratchRetMap.put(orgId, 0.0);</span>
<span class="nc" id="L76">				pwtScratchRetMap.put(orgId, 0.0);</span>
<span class="nc" id="L77">				cashRetMap.put(orgId, 0.0);</span>
<span class="nc" id="L78">			}</span>

			// Game Master Query for Draw Game
<span class="nc" id="L81">			gameQry = &quot;select game_id from st_dg_game_master&quot;;</span>
<span class="nc" id="L82">			PreparedStatement gamePstmt = con.prepareStatement(gameQry);</span>
<span class="nc" id="L83">			rsGame = gamePstmt.executeQuery();</span>

<span class="nc bnc" id="L85" title="All 2 branches missed.">			while (rsGame.next()) {</span>
<span class="nc" id="L86">				int gameId = rsGame.getInt(&quot;game_id&quot;);</span>
				
<span class="nc bnc" id="L88" title="All 2 branches missed.">				if(agtOrgId==1)	{</span>
<span class="nc" id="L89">					saleQry=&quot;select drs.retailer_org_id,sum(mrp_amt) as sale from st_dg_ret_sale_&quot;+gameId+&quot; drs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_SALE','DG_SALE_OFFLINE') and transaction_date&gt;='&quot;+startDate+&quot;' and transaction_date&lt;='&quot;+endDate+&quot;') group by drs.retailer_org_id&quot;;</span>
<span class="nc" id="L90">					cancelQry=&quot;select drs.retailer_org_id,sum(mrp_amt) as cancel from st_dg_ret_sale_refund_&quot;+gameId+&quot; drs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_REFUND_CANCEL','DG_REFUND_FAILED') and transaction_date&gt;='&quot;+startDate+&quot;' and transaction_date&lt;='&quot;+endDate+&quot;') group by drs.retailer_org_id&quot;;</span>
<span class="nc" id="L91">					pwtQry=&quot;select drs.retailer_org_id,sum(pwt_amt) as pwt from st_dg_ret_pwt_&quot;+gameId+&quot; drs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_PWT_AUTO','DG_PWT_PLR','DG_PWT') and transaction_date&gt;='&quot;+startDate+&quot;' and transaction_date&lt;='&quot;+endDate+&quot;') group by drs.retailer_org_id&quot;;</span>
<span class="nc" id="L92">					dirPlrPwtQry=&quot;select ifnull(sum(pwt_amt + agt_claim_comm),0) as netAgtDirPlrPwt from st_dg_agt_direct_plr_pwt where agent_org_id = -111;&quot;;</span>
<span class="nc" id="L93">					cashQry=&quot;select retailer_org_id,sum(amount) cash from st_lms_agent_cash_transaction where transaction_id in(select transaction_id from st_lms_agent_transaction_master where transaction_type='CASH' and transaction_date&gt;='&quot;+startDate+&quot;' and transaction_date&lt;='&quot;+endDate+&quot;') group by retailer_org_id&quot;;</span>
				}
				else{
<span class="nc" id="L96">					saleQry = &quot;select drs.retailer_org_id,sum(mrp_amt) as sale from st_dg_ret_sale_&quot;+gameId+&quot; drs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_SALE','DG_SALE_OFFLINE') and transaction_date&gt;='&quot;+startDate+&quot;' and transaction_date&lt;='&quot;+endDate+&quot;' and retailer_org_id in (select organization_id from st_lms_organization_master where parent_id=&quot;+agtOrgId+&quot;)) group by drs.retailer_org_id&quot;;</span>
<span class="nc" id="L97">					cancelQry = &quot;select drs.retailer_org_id,sum(mrp_amt) as cancel from st_dg_ret_sale_refund_&quot;+gameId+&quot; drs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_REFUND_CANCEL','DG_REFUND_FAILED') and transaction_date&gt;='&quot;+startDate+&quot;' and transaction_date&lt;='&quot;+endDate+&quot;' and retailer_org_id in (select organization_id from st_lms_organization_master where parent_id=&quot;+agtOrgId+&quot;)) group by drs.retailer_org_id&quot;;</span>
<span class="nc" id="L98">					pwtQry = &quot;select drs.retailer_org_id,sum(pwt_amt) as pwt from st_dg_ret_pwt_&quot;+gameId+&quot; drs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_PWT_AUTO','DG_PWT_PLR','DG_PWT') and transaction_date&gt;='&quot;+startDate+&quot;' and transaction_date&lt;='&quot;+endDate+&quot;' and retailer_org_id in (select organization_id from st_lms_organization_master where parent_id=&quot;+agtOrgId+&quot;)) group by drs.retailer_org_id&quot;;</span>
<span class="nc" id="L99">					dirPlrPwtQry = &quot;select ifnull(sum(pwt_amt + agt_claim_comm),0) as netAgtDirPlrPwt from st_dg_agt_direct_plr_pwt where agent_org_id =&quot;+agtOrgId+&quot; and date(transaction_date) &gt;= '&quot;+startDate+&quot;' and date(transaction_date) &lt;'&quot;+endDate+&quot;'&quot;;</span>
<span class="nc" id="L100">					cashQry = &quot;select retailer_org_id,sum(amount) cash from st_lms_agent_cash_transaction where transaction_id in(select transaction_id from st_lms_agent_transaction_master where transaction_type='CASH' and transaction_date&gt;='&quot;+startDate+&quot;' and transaction_date&lt;='&quot;+endDate+&quot;') and agent_org_id=&quot;+agtOrgId+&quot; group by retailer_org_id&quot;;		</span>
				}
				// Calculate Sale
<span class="nc" id="L103">				pstmt = con.prepareStatement(saleQry);</span>
<span class="nc" id="L104">				logger.debug(&quot;***Sale Query*** \n&quot; + pstmt);</span>
<span class="nc" id="L105">				rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L107" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L108">					double salValue = saleDrawRetMap.get(rs</span>
							.getInt(&quot;retailer_org_id&quot;));
<span class="nc" id="L110">					saleDrawRetMap.put(rs.getInt(&quot;retailer_org_id&quot;), salValue</span>
							+ rs.getDouble(&quot;sale&quot;));
<span class="nc" id="L112">				}</span>
				// Calculate Cancel
<span class="nc" id="L114">				pstmt = con.prepareStatement(cancelQry);</span>
<span class="nc" id="L115">				logger.debug(&quot;***Cancel Query*** \n&quot; + pstmt);</span>
<span class="nc" id="L116">				rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L118" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L119">					double canValue = cancelDrawRetMap.get(rs</span>
							.getInt(&quot;retailer_org_id&quot;));
<span class="nc" id="L121">					cancelDrawRetMap.put(rs.getInt(&quot;retailer_org_id&quot;), canValue</span>
							+ rs.getDouble(&quot;cancel&quot;));
<span class="nc" id="L123">				}</span>
				// Calculate Pwt
<span class="nc" id="L125">				pstmt = con.prepareStatement(pwtQry);</span>
<span class="nc" id="L126">				logger.debug(&quot;***Pwt Query*** \n&quot; + pstmt);</span>
<span class="nc" id="L127">				rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L129" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L130">					double pwtValue = pwtDrawRetMap.get(rs</span>
							.getInt(&quot;retailer_org_id&quot;));
<span class="nc" id="L132">					pwtDrawRetMap.put(rs.getInt(&quot;retailer_org_id&quot;), pwtValue</span>
							+ rs.getDouble(&quot;pwt&quot;));
<span class="nc" id="L134">				}</span>

<span class="nc" id="L136">			}</span>
			// Calculate DirplrPwt
<span class="nc" id="L138">			pstmt = con.prepareStatement(dirPlrPwtQry);</span>
<span class="nc" id="L139">			logger.debug(&quot;****dir plr plwt qry*** &quot; + pstmt);</span>
<span class="nc" id="L140">			rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L142" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L143">				dirPlrPwtAmt = rs.getString(&quot;netAgtDirPlrPwt&quot;);</span>
			}

<span class="nc" id="L146">			logger.debug(&quot;***Sale Draw Map***&quot; + saleDrawRetMap);</span>
<span class="nc" id="L147">			logger.debug(&quot;***Cancel Draw Map***&quot; + cancelDrawRetMap);</span>
<span class="nc" id="L148">			logger.debug(&quot;***Pwt Draw Map***&quot; + pwtDrawRetMap);</span>

			// Scratch Game
<span class="nc" id="L151">			saleQry=null;</span>
<span class="nc" id="L152">			pwtQry=null;</span>
<span class="nc" id="L153">			dirPlrPwtQry=null;</span>

<span class="nc bnc" id="L155" title="All 2 branches missed.">			if(agtOrgId==1)	{</span>
<span class="nc" id="L156">			   		saleQry=&quot;select current_owner_id,sum(sale) sale from (select gmti.game_id,gmti.current_owner_id,gmti.date, (sum(gmti.sold_tickets)*ticket_price) sale from st_se_game_ticket_inv_history gmti ,st_se_game_master gm where gmti.current_owner='RETAILER' and gmti.date&gt;='&quot;+startDate+&quot;' and gmti.date&lt;='&quot;+endDate+&quot;' and gmti.game_id=gm.game_id group by gmti.current_owner_id,gmti.game_id) aa group by current_owner_id&quot;;</span>
<span class="nc" id="L157">					pwtQry=&quot;select retailer_org_id,sum(pwt_amt) pwt from st_se_retailer_pwt where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_date&gt;='&quot;+startDate+&quot;' and transaction_date&lt;='&quot;+endDate+&quot;' and transaction_type='PWT') group by retailer_org_id&quot;;</span>
			}
			else			{
<span class="nc" id="L160">					saleQry = &quot;select current_owner_id,sum(sale) sale from (select gmti.game_id,gmti.current_owner_id,gmti.date, (sum(gmti.sold_tickets)*ticket_price) sale from st_se_game_ticket_inv_history gmti ,st_se_game_master gm where gmti.current_owner='RETAILER' and gmti.current_owner_id in(select organization_id from st_lms_organization_master where parent_id=&quot;+agtOrgId+&quot;) and gmti.date&gt;='&quot;+startDate+&quot;' and gmti.date&lt;='&quot;+endDate+&quot;' and gmti.game_id=gm.game_id group by gmti.current_owner_id,gmti.game_id) aa group by current_owner_id&quot;;</span>
<span class="nc" id="L161">					pwtQry = &quot;select retailer_org_id,sum(pwt_amt) pwt from st_se_retailer_pwt where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_date&gt;='&quot;+startDate+&quot;' and transaction_date&lt;='&quot;+endDate+&quot;' and transaction_type='PWT' and retailer_org_id in (select organization_id from st_lms_organization_master where parent_id=&quot;+agtOrgId+&quot;)) group by retailer_org_id&quot;;</span>
			}
						
				// Calculate Sale
<span class="nc" id="L165">			pstmt = con.prepareStatement(saleQry);	</span>
<span class="nc" id="L166">			logger.debug(&quot;***Sale Query*** \n&quot; + pstmt);</span>
<span class="nc" id="L167">			rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L169" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L170">				saleScratchRetMap.put(rs.getInt(&quot;current_owner_id&quot;), rs</span>
						.getDouble(&quot;sale&quot;));
			}
			// Calculate Pwt
<span class="nc" id="L174">			pstmt = con.prepareStatement(pwtQry);</span>
<span class="nc" id="L175">			logger.debug(&quot;***PWT Query*** \n&quot; + pstmt);</span>
<span class="nc" id="L176">			rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L178" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L179">				pwtScratchRetMap.put(rs.getInt(&quot;retailer_org_id&quot;), rs</span>
						.getDouble(&quot;pwt&quot;));
			}

<span class="nc" id="L183">			logger.debug(&quot;***Sale Scratch Map***&quot; + saleScratchRetMap);</span>
<span class="nc" id="L184">			logger.debug(&quot;***Pwt Scratch Map***&quot; + pwtScratchRetMap);</span>

			// Cash Payment Calculations
<span class="nc" id="L187">			pstmt = con.prepareStatement(cashQry);</span>
<span class="nc" id="L188">			logger.debug(&quot;***Cash Query*** \n&quot; + pstmt);</span>
<span class="nc" id="L189">			rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L191" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L192">				cashRetMap.put(rs.getInt(&quot;retailer_org_id&quot;), rs</span>
						.getDouble(&quot;cash&quot;));
			}
			// Result Map
<span class="nc" id="L196">			Iterator&lt;Map.Entry&lt;Integer, String&gt;&gt; iter = orgMap.entrySet()</span>
					.iterator();
<span class="nc" id="L198">			double saleDrawAmtTot = 0.0;</span>
<span class="nc" id="L199">			double cancelDrawAmtTot = 0.0;</span>
<span class="nc" id="L200">			double pwtDrawAmtTot = 0.0;</span>
<span class="nc" id="L201">			double saleScratchAmtTot = 0.0;</span>
<span class="nc" id="L202">			double pwtScratchAmtTot = 0.0;</span>
<span class="nc" id="L203">			double cashAmtTot = 0.0;</span>
<span class="nc" id="L204">			double cashInHandTot = 0.0;</span>

<span class="nc bnc" id="L206" title="All 2 branches missed.">			while (iter.hasNext()) {</span>
<span class="nc" id="L207">				Map.Entry&lt;Integer, String&gt; pair = (Map.Entry&lt;Integer, String&gt;) iter</span>
						.next();
<span class="nc" id="L209">				int key = pair.getKey(); // orgId</span>
<span class="nc" id="L210">				StringBuilder amtVal = new StringBuilder(&quot;&quot;);</span>
<span class="nc" id="L211">				String orgName = pair.getValue();</span>
<span class="nc" id="L212">				double saleDrawAmt = saleDrawRetMap.get(key);</span>
<span class="nc" id="L213">				double cancelDrawAmt = cancelDrawRetMap.get(key);</span>
<span class="nc" id="L214">				double pwtDrawAmt = pwtDrawRetMap.get(key);</span>
<span class="nc" id="L215">				double saleScratchAmt = saleScratchRetMap.get(key);</span>
<span class="nc" id="L216">				double pwtScratchAmt = pwtScratchRetMap.get(key);</span>

<span class="nc" id="L218">				double cashAmt = cashRetMap.get(key);</span>

<span class="nc" id="L220">				double cashInHand = saleDrawAmt + saleScratchAmt</span>
						- (cancelDrawAmt + pwtDrawAmt + pwtScratchAmt);
<span class="nc" id="L222">				amtVal.append(saleDrawAmt + &quot;,&quot; + cancelDrawAmt + &quot;,&quot;</span>
						+ pwtDrawAmt + &quot;,&quot; + saleScratchAmt + &quot;,&quot;
						+ pwtScratchAmt + &quot;,&quot;);
<span class="nc bnc" id="L225" title="All 2 branches missed.">				if (isNoCash) {</span>
<span class="nc" id="L226">					amtVal.append(cashInHand);</span>
				} else {
<span class="nc" id="L228">					cashInHand = cashInHand - cashAmt;</span>
<span class="nc" id="L229">					amtVal.append(cashAmt + &quot;,&quot; + cashInHand);</span>
<span class="nc" id="L230">					cashAmtTot += cashAmt;</span>
				}
<span class="nc" id="L232">				reportMap.put(orgName, amtVal.toString());</span>

<span class="nc" id="L234">				saleDrawAmtTot += saleDrawAmt;</span>
<span class="nc" id="L235">				cancelDrawAmtTot += cancelDrawAmt;</span>
<span class="nc" id="L236">				pwtDrawAmtTot += pwtDrawAmt;</span>
<span class="nc" id="L237">				saleScratchAmtTot += saleScratchAmt;</span>
<span class="nc" id="L238">				pwtScratchAmtTot += pwtScratchAmt;</span>
<span class="nc" id="L239">				cashInHandTot += cashInHand;</span>
<span class="nc" id="L240">			}</span>
<span class="nc" id="L241">			reportMap</span>
					.put(&quot;Total&quot;, saleDrawAmtTot + &quot;,&quot; + cancelDrawAmtTot + &quot;,&quot;
							+ pwtDrawAmtTot + &quot;,&quot; + saleScratchAmtTot + &quot;,&quot;
							+ pwtScratchAmtTot + &quot;,&quot; + cashAmtTot + &quot;,&quot;
							+ cashInHandTot);
<span class="nc bnc" id="L246" title="All 2 branches missed.">			if (isNoCash) {</span>
<span class="nc" id="L247">				reportMap.put(&quot;Total&quot;, saleDrawAmtTot + &quot;,&quot; + cancelDrawAmtTot</span>
						+ &quot;,&quot; + pwtDrawAmtTot + &quot;,&quot; + saleScratchAmtTot + &quot;,&quot;
						+ pwtScratchAmtTot + &quot;,&quot; + cashInHandTot);
			}
<span class="nc" id="L251">			reportMap.put(&quot;dirPlrPwt&quot;, dirPlrPwtAmt);</span>
<span class="nc" id="L252">			logger.debug(&quot;***report Map***&quot; + reportMap);</span>

<span class="nc" id="L254">		} catch (Exception e) {</span>
<span class="nc" id="L255">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L257">			try {</span>
<span class="nc" id="L258">				con.close();</span>
<span class="nc" id="L259">			} catch (SQLException e) {</span>
<span class="nc" id="L260">				e.printStackTrace();</span>
<span class="nc" id="L261">			}</span>
<span class="nc" id="L262">		}</span>
<span class="nc" id="L263">		return reportMap;</span>
	}

	public TreeMap&lt;String, String&gt; drawReport(int agtOrgId,
			Timestamp startDate, Timestamp endDate) {
<span class="nc" id="L268">		Connection con = null;</span>
<span class="nc" id="L269">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L270">		ResultSet rsRetOrg = null;</span>
<span class="nc" id="L271">		ResultSet rsGame = null;</span>
<span class="nc" id="L272">		ResultSet rs = null;</span>
<span class="nc" id="L273">		String gameQry = null;</span>
<span class="nc" id="L274">		String retOrgQry = null;</span>
<span class="nc" id="L275">		String saleQry = null;</span>
<span class="nc" id="L276">		String cancelQry = null;</span>
<span class="nc" id="L277">		String pwtQry = null;</span>
<span class="nc" id="L278">		Map&lt;Integer, String&gt; orgMap = new HashMap&lt;Integer, String&gt;();</span>
<span class="nc" id="L279">		TreeMap&lt;String, String&gt; reportMap = new TreeMap&lt;String, String&gt;();</span>
<span class="nc" id="L280">		Map&lt;Integer, Double&gt; saleRetMap = new HashMap&lt;Integer, Double&gt;();</span>
<span class="nc" id="L281">		Map&lt;Integer, Double&gt; cancelRetMap = new HashMap&lt;Integer, Double&gt;();</span>
<span class="nc" id="L282">		Map&lt;Integer, Double&gt; pwtRetMap = new HashMap&lt;Integer, Double&gt;();</span>
		try {
<span class="nc" id="L284">			con = DBConnect.getConnection();</span>
<span class="nc" id="L285">			con.setAutoCommit(false);</span>
<span class="nc" id="L286">			retOrgQry = &quot;select name,organization_id from st_lms_organization_master where parent_id=?&quot;;</span>
<span class="nc" id="L287">			pstmt = con.prepareStatement(retOrgQry);</span>
<span class="nc" id="L288">			pstmt.setInt(1, agtOrgId);</span>
<span class="nc" id="L289">			rsRetOrg = pstmt.executeQuery();</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">			while (rsRetOrg.next()) {</span>
<span class="nc" id="L291">				orgMap.put(rsRetOrg.getInt(&quot;organization_id&quot;), rsRetOrg</span>
						.getString(&quot;name&quot;));
<span class="nc" id="L293">				saleRetMap.put(rsRetOrg.getInt(&quot;organization_id&quot;), 0.0);</span>
<span class="nc" id="L294">				cancelRetMap.put(rsRetOrg.getInt(&quot;organization_id&quot;), 0.0);</span>
<span class="nc" id="L295">				pwtRetMap.put(rsRetOrg.getInt(&quot;organization_id&quot;), 0.0);</span>
			}

			// Game Master Query
<span class="nc" id="L299">			gameQry = &quot;select game_id from st_dg_game_master&quot;;</span>
<span class="nc" id="L300">			PreparedStatement gamePstmt = con.prepareStatement(gameQry);</span>
<span class="nc" id="L301">			rsGame = gamePstmt.executeQuery();</span>

<span class="nc bnc" id="L303" title="All 2 branches missed.">			while (rsGame.next()) {</span>
				// Calculate Sale
<span class="nc" id="L305">				int gameId = rsGame.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L306">				saleQry = &quot;select drs.retailer_org_id,sum(mrp_amt) as sale from st_dg_ret_sale_? drs,&quot;</span>
						+ &quot;(select retailer_org_id,transaction_id,transaction_type from &quot;
						+ &quot;st_lms_retailer_transaction_master where transaction_type in('DG_SALE','DG_SALE_OFFLINE')&quot;
						+ &quot; and transaction_date&gt;=? and transaction_date&lt;=?&quot;
						+ &quot; and retailer_org_id in (select organization_id from st_lms_organization_master &quot;
						+ &quot;where parent_id=?)) retTran where retTran.transaction_id=drs.transaction_id &quot;
						+ &quot;group by drs.retailer_org_id&quot;;
<span class="nc" id="L313">				pstmt = con.prepareStatement(saleQry);</span>
<span class="nc" id="L314">				pstmt.setInt(1, gameId);</span>
<span class="nc" id="L315">				pstmt.setTimestamp(2, startDate);</span>
<span class="nc" id="L316">				pstmt.setTimestamp(3, endDate);</span>
<span class="nc" id="L317">				pstmt.setInt(4, agtOrgId);</span>

<span class="nc" id="L319">				logger.debug(&quot;***Sale Query*** \n&quot; + pstmt);</span>
<span class="nc" id="L320">				rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L322" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L323">					double salValue = saleRetMap.get(rs</span>
							.getInt(&quot;retailer_org_id&quot;));
<span class="nc" id="L325">					saleRetMap.put(rs.getInt(&quot;retailer_org_id&quot;), salValue</span>
							+ rs.getDouble(&quot;sale&quot;));
<span class="nc" id="L327">				}</span>

				// Calculate Cancel

<span class="nc" id="L331">				cancelQry = &quot;select drs.retailer_org_id,sum(mrp_amt) as cancel from st_dg_ret_sale_refund_? drs,&quot;</span>
						+ &quot;(select retailer_org_id,transaction_id,transaction_type from &quot;
						+ &quot;st_lms_retailer_transaction_master where transaction_type in('DG_REFUND_CANCEL','DG_REFUND_FAILED') &quot;
						+ &quot;and transaction_date&gt;=? and transaction_date&lt;=?&quot;
						+ &quot; and retailer_org_id in (select organization_id &quot;
						+ &quot;from st_lms_organization_master where parent_id=?)) retTran &quot;
						+ &quot;where retTran.transaction_id=drs.transaction_id group by drs.retailer_org_id&quot;;
<span class="nc" id="L338">				pstmt = con.prepareStatement(cancelQry);</span>
<span class="nc" id="L339">				pstmt.setInt(1, gameId);</span>
<span class="nc" id="L340">				pstmt.setTimestamp(2, startDate);</span>
<span class="nc" id="L341">				pstmt.setTimestamp(3, endDate);</span>
<span class="nc" id="L342">				pstmt.setInt(4, agtOrgId);</span>

<span class="nc" id="L344">				logger.debug(&quot;***Cancel Query*** \n&quot; + pstmt);</span>
<span class="nc" id="L345">				rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L347" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L348">					double canValue = cancelRetMap.get(rs</span>
							.getInt(&quot;retailer_org_id&quot;));
<span class="nc" id="L350">					cancelRetMap.put(rs.getInt(&quot;retailer_org_id&quot;), canValue</span>
							+ rs.getDouble(&quot;cancel&quot;));
<span class="nc" id="L352">				}</span>

				// Calculate Pwt

<span class="nc" id="L356">				pwtQry = &quot;select drs.retailer_org_id,sum(pwt_amt) as pwt from st_dg_ret_pwt_? drs,(select retailer_org_id,transaction_id,transaction_type from st_lms_retailer_transaction_master where transaction_type in('DG_PWT_AUTO','DG_PWT_PLR','DG_PWT') and transaction_date&gt;=? and transaction_date&lt;=? and retailer_org_id in (select organization_id from st_lms_organization_master where parent_id=?)) retTran where retTran.transaction_id=drs.transaction_id group by drs.retailer_org_id&quot;;</span>
<span class="nc" id="L357">				pstmt = con.prepareStatement(pwtQry);</span>
<span class="nc" id="L358">				pstmt.setInt(1, gameId);</span>
<span class="nc" id="L359">				pstmt.setTimestamp(2, startDate);</span>
<span class="nc" id="L360">				pstmt.setTimestamp(3, endDate);</span>
<span class="nc" id="L361">				pstmt.setInt(4, agtOrgId);</span>

<span class="nc" id="L363">				logger.debug(&quot;***Pwt Query*** \n&quot; + pstmt);</span>
<span class="nc" id="L364">				rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L366" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L367">					double pwtValue = pwtRetMap.get(rs</span>
							.getInt(&quot;retailer_org_id&quot;));
<span class="nc" id="L369">					pwtRetMap.put(rs.getInt(&quot;retailer_org_id&quot;), pwtValue</span>
							+ rs.getDouble(&quot;pwt&quot;));
<span class="nc" id="L371">				}</span>

<span class="nc" id="L373">			}</span>

<span class="nc" id="L375">			logger.debug(&quot;***Sale Map***&quot; + saleRetMap);</span>
<span class="nc" id="L376">			logger.debug(&quot;***Cancel Map***&quot; + cancelRetMap);</span>
<span class="nc" id="L377">			logger.debug(&quot;***Pwt Map***&quot; + pwtRetMap);</span>

<span class="nc" id="L379">			Iterator&lt;Map.Entry&lt;Integer, String&gt;&gt; iter = orgMap.entrySet()</span>
					.iterator();
<span class="nc bnc" id="L381" title="All 2 branches missed.">			while (iter.hasNext()) {</span>
<span class="nc" id="L382">				Map.Entry&lt;Integer, String&gt; pair = (Map.Entry&lt;Integer, String&gt;) iter</span>
						.next();
<span class="nc" id="L384">				int key = pair.getKey();</span>
<span class="nc" id="L385">				StringBuilder amtVal = new StringBuilder(&quot;&quot;);</span>
<span class="nc" id="L386">				String orgName = pair.getValue();</span>
<span class="nc" id="L387">				double saleAmt = saleRetMap.get(key);</span>
<span class="nc" id="L388">				double cancelAmt = cancelRetMap.get(key);</span>
<span class="nc" id="L389">				double pwtAmt = pwtRetMap.get(key);</span>
<span class="nc" id="L390">				double cashInHand = saleAmt - cancelAmt - pwtAmt;</span>

<span class="nc" id="L392">				amtVal.append(saleAmt + &quot;,&quot; + cancelAmt + &quot;,&quot; + pwtAmt + &quot;,&quot;</span>
						+ cashInHand);
<span class="nc" id="L394">				reportMap.put(orgName, amtVal.toString());</span>
<span class="nc" id="L395">			}</span>
<span class="nc" id="L396">			logger.debug(&quot;***report Map***&quot; + reportMap);</span>
<span class="nc" id="L397">			con.commit();</span>
<span class="nc" id="L398">		} catch (Exception e) {</span>
<span class="nc" id="L399">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L401">			try {</span>
<span class="nc" id="L402">				con.close();</span>
<span class="nc" id="L403">			} catch (SQLException e) {</span>
<span class="nc" id="L404">				e.printStackTrace();</span>
<span class="nc" id="L405">			}</span>
<span class="nc" id="L406">		}</span>
<span class="nc" id="L407">		return reportMap;</span>
	}

	public String getOrgAdd(int orgId) throws LMSException {
<span class="nc" id="L411">		String orgAdd = &quot;&quot;;</span>
<span class="nc" id="L412">		Connection con = null;</span>
<span class="nc" id="L413">		con = DBConnect.getConnection();</span>
<span class="nc" id="L414">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L415">		ResultSet rs = null;</span>
		try {
<span class="nc" id="L417">			pstmt = con</span>
					.prepareStatement(&quot;select addr_line1, addr_line2, city from st_lms_organization_master where organization_id = ?&quot;);
<span class="nc" id="L419">			pstmt.setInt(1, orgId);</span>
<span class="nc" id="L420">			rs = pstmt.executeQuery();</span>
<span class="nc" id="L421">			logger.debug(pstmt);</span>
<span class="nc bnc" id="L422" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L423">				orgAdd = rs.getString(&quot;addr_line1&quot;) + &quot;, &quot;</span>
						+ rs.getString(&quot;addr_line2&quot;) + &quot;, &quot;
						+ rs.getString(&quot;city&quot;);
			}
<span class="nc" id="L427">		} catch (SQLException e) {</span>
<span class="nc" id="L428">			logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L429">			e.printStackTrace();</span>
<span class="nc" id="L430">			throw new LMSException(e);</span>
		} finally {
<span class="nc" id="L432">			try {</span>
<span class="nc bnc" id="L433" title="All 8 branches missed.">				if (con != null &amp;&amp; !con.isClosed()) {</span>
<span class="nc" id="L434">					con.close();</span>
				}
<span class="nc" id="L436">			} catch (SQLException e) {</span>
<span class="nc" id="L437">				logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L438">				e.printStackTrace();</span>
<span class="nc" id="L439">				throw new LMSException(e);</span>
<span class="nc" id="L440">			}</span>
		}
<span class="nc" id="L442">		return orgAdd;</span>
	}

	public void retDrawReport() {

<span class="nc" id="L447">	}</span>

	public TreeMap&lt;String, String&gt; retStatusReport(int agtOrgId,
			Timestamp startDate, Timestamp endDate) {

<span class="nc" id="L452">		Connection con = null;</span>
<span class="nc" id="L453">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L454">		ResultSet rsRetOrg = null;</span>
<span class="nc" id="L455">		ResultSet rsGame = null;</span>
<span class="nc" id="L456">		ResultSet rs = null;</span>
<span class="nc" id="L457">		String gameQry = null;</span>
<span class="nc" id="L458">		String retOrgQry = null;</span>
<span class="nc" id="L459">		String saleQry = null;</span>
<span class="nc" id="L460">		String cancelQry = null;</span>
<span class="nc" id="L461">		String pwtQry = null;</span>
<span class="nc" id="L462">		String cashQry = null;</span>
<span class="nc" id="L463">		Map&lt;Integer, String&gt; orgMap = new HashMap&lt;Integer, String&gt;();</span>
<span class="nc" id="L464">		TreeMap&lt;String, String&gt; reportMap = new TreeMap&lt;String, String&gt;();</span>
<span class="nc" id="L465">		Map&lt;Integer, Double&gt; saleDrawRetMap = new HashMap&lt;Integer, Double&gt;();</span>
<span class="nc" id="L466">		Map&lt;Integer, Double&gt; cancelDrawRetMap = new HashMap&lt;Integer, Double&gt;();</span>
<span class="nc" id="L467">		Map&lt;Integer, Double&gt; pwtDrawRetMap = new HashMap&lt;Integer, Double&gt;();</span>
<span class="nc" id="L468">		Map&lt;Integer, Double&gt; saleScratchRetMap = new HashMap&lt;Integer, Double&gt;();</span>
<span class="nc" id="L469">		Map&lt;Integer, Double&gt; pwtScratchRetMap = new HashMap&lt;Integer, Double&gt;();</span>
<span class="nc" id="L470">		Map&lt;Integer, Double&gt; cashRetMap = new HashMap&lt;Integer, Double&gt;();</span>
		try {
<span class="nc" id="L472">			con = DBConnect.getConnection();</span>
<span class="nc" id="L473">			retOrgQry = &quot;select name,organization_id from st_lms_organization_master where parent_id=? and organization_type=?&quot;;</span>
<span class="nc" id="L474">			pstmt = con.prepareStatement(retOrgQry);</span>
<span class="nc" id="L475">			pstmt.setInt(1, agtOrgId);</span>
<span class="nc" id="L476">			pstmt.setString(2, &quot;RETAILER&quot;);</span>
<span class="nc" id="L477">			rsRetOrg = pstmt.executeQuery();</span>
<span class="nc bnc" id="L478" title="All 2 branches missed.">			while (rsRetOrg.next()) {</span>
<span class="nc" id="L479">				orgMap.put(rsRetOrg.getInt(&quot;organization_id&quot;), rsRetOrg</span>
						.getString(&quot;name&quot;));
			}

			// Game Master Query for Draw Game
<span class="nc" id="L484">			gameQry = &quot;select game_id from st_dg_game_master&quot;;</span>
<span class="nc" id="L485">			PreparedStatement gamePstmt = con.prepareStatement(gameQry);</span>
<span class="nc" id="L486">			rsGame = gamePstmt.executeQuery();</span>

<span class="nc bnc" id="L488" title="All 2 branches missed.">			while (rsGame.next()) {</span>
				// Calculate Sale
<span class="nc" id="L490">				int gameId = rsGame.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L491">				saleQry = &quot;select drs.retailer_org_id,sum(mrp_amt) as sale from st_dg_ret_sale_? drs &quot;</span>
						+ &quot;where transaction_id in (select transaction_id from &quot;
						+ &quot;st_lms_retailer_transaction_master where transaction_type in('DG_SALE','DG_SALE_OFFLINE')&quot;
						+ &quot; and transaction_date&gt;=? and transaction_date&lt;=?&quot;
						+ &quot; and retailer_org_id in (select organization_id from st_lms_organization_master &quot;
						+ &quot;where parent_id=?)) &quot;
						+ &quot;group by drs.retailer_org_id&quot;;
<span class="nc" id="L498">				pstmt = con.prepareStatement(saleQry);</span>
<span class="nc" id="L499">				pstmt.setInt(1, gameId);</span>
<span class="nc" id="L500">				pstmt.setTimestamp(2, startDate);</span>
<span class="nc" id="L501">				pstmt.setTimestamp(3, endDate);</span>
<span class="nc" id="L502">				pstmt.setInt(4, agtOrgId);</span>

<span class="nc" id="L504">				logger.debug(&quot;***Sale Query*** \n&quot; + pstmt);</span>
<span class="nc" id="L505">				rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L507" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L508">					double salValue = saleDrawRetMap.get(rs</span>
							.getInt(&quot;retailer_org_id&quot;));
<span class="nc" id="L510">					saleDrawRetMap.put(rs.getInt(&quot;retailer_org_id&quot;), salValue</span>
							+ rs.getDouble(&quot;sale&quot;));
<span class="nc" id="L512">				}</span>

				// Calculate Cancel

<span class="nc" id="L516">				cancelQry = &quot;select drs.retailer_org_id,sum(mrp_amt) as cancel from st_dg_ret_sale_refund_? drs &quot;</span>
						+ &quot;where transaction_id in (select transaction_id from &quot;
						+ &quot;st_lms_retailer_transaction_master where transaction_type in('DG_REFUND_CANCEL','DG_REFUND_FAILED') &quot;
						+ &quot;and transaction_date&gt;=? and transaction_date&lt;=?&quot;
						+ &quot; and retailer_org_id in (select organization_id &quot;
						+ &quot;from st_lms_organization_master where parent_id=?)) &quot;
						+ &quot;group by drs.retailer_org_id&quot;;
<span class="nc" id="L523">				pstmt = con.prepareStatement(cancelQry);</span>
<span class="nc" id="L524">				pstmt.setInt(1, gameId);</span>
<span class="nc" id="L525">				pstmt.setTimestamp(2, startDate);</span>
<span class="nc" id="L526">				pstmt.setTimestamp(3, endDate);</span>
<span class="nc" id="L527">				pstmt.setInt(4, agtOrgId);</span>

<span class="nc" id="L529">				logger.debug(&quot;***Cancel Query*** \n&quot; + pstmt);</span>
<span class="nc" id="L530">				rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L532" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L533">					double canValue = cancelDrawRetMap.get(rs</span>
							.getInt(&quot;retailer_org_id&quot;));
<span class="nc" id="L535">					cancelDrawRetMap.put(rs.getInt(&quot;retailer_org_id&quot;), canValue</span>
							+ rs.getDouble(&quot;cancel&quot;));
<span class="nc" id="L537">				}</span>

				// Calculate Pwt

<span class="nc" id="L541">				pwtQry = &quot;select drs.retailer_org_id,sum(pwt_amt) as pwt from st_dg_ret_pwt_? drs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_PWT_AUTO','DG_PWT_PLR','DG_PWT') and transaction_date&gt;=? and transaction_date&lt;=? and retailer_org_id in (select organization_id from st_lms_organization_master where parent_id=?)) group by drs.retailer_org_id&quot;;</span>
<span class="nc" id="L542">				pstmt = con.prepareStatement(pwtQry);</span>
<span class="nc" id="L543">				pstmt.setInt(1, gameId);</span>
<span class="nc" id="L544">				pstmt.setTimestamp(2, startDate);</span>
<span class="nc" id="L545">				pstmt.setTimestamp(3, endDate);</span>
<span class="nc" id="L546">				pstmt.setInt(4, agtOrgId);</span>

<span class="nc" id="L548">				logger.debug(&quot;***Pwt Query*** \n&quot; + pstmt);</span>
<span class="nc" id="L549">				rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L551" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L552">					double pwtValue = pwtDrawRetMap.get(rs</span>
							.getInt(&quot;retailer_org_id&quot;));
<span class="nc" id="L554">					pwtDrawRetMap.put(rs.getInt(&quot;retailer_org_id&quot;), pwtValue</span>
							+ rs.getDouble(&quot;pwt&quot;));
<span class="nc" id="L556">				}</span>

<span class="nc" id="L558">			}</span>

<span class="nc" id="L560">			logger.debug(&quot;***Sale Draw Map***&quot; + saleDrawRetMap);</span>
<span class="nc" id="L561">			logger.debug(&quot;***Cancel Draw Map***&quot; + cancelDrawRetMap);</span>
<span class="nc" id="L562">			logger.debug(&quot;***Pwt Draw Map***&quot; + pwtDrawRetMap);</span>

			// Scratch Game

			// Calculate Sale
<span class="nc" id="L567">			saleQry = &quot;select current_owner_id,sum(sale) sale from (select gmti.game_id,gmti.current_owner_id,gmti.date, (sum(gmti.sold_tickets)*ticket_price) sale from st_se_game_ticket_inv_history gmti ,st_se_game_master gm where gmti.current_owner='RETAILER' and gmti.current_owner_id in(select organization_id from st_lms_organization_master where parent_id=?) and gmti.date&gt;=? and gmti.date&lt;=? and gmti.game_id=gm.game_id group by gmti.current_owner_id,gmti.game_id) aa group by current_owner_id&quot;;</span>
<span class="nc" id="L568">			pstmt = con.prepareStatement(saleQry);</span>
<span class="nc" id="L569">			pstmt.setInt(1, agtOrgId);</span>
<span class="nc" id="L570">			pstmt.setTimestamp(2, startDate);</span>
<span class="nc" id="L571">			pstmt.setTimestamp(3, endDate);</span>

<span class="nc" id="L573">			logger.debug(&quot;***Sale Query*** \n&quot; + pstmt);</span>
<span class="nc" id="L574">			rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L576" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L577">				saleScratchRetMap.put(rs.getInt(&quot;current_owner_id&quot;), rs</span>
						.getDouble(&quot;sale&quot;));
			}

			// Calculate Pwt
<span class="nc" id="L582">			pwtQry = &quot;select retailer_org_id,sum(pwt_amt) pwt from st_se_retailer_pwt where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_date&gt;=? and transaction_date&lt;=? and transaction_type='PWT' and retailer_org_id in (select organization_id from st_lms_organization_master where parent_id=?)) group by retailer_org_id&quot;;</span>
<span class="nc" id="L583">			pstmt = con.prepareStatement(pwtQry);</span>
<span class="nc" id="L584">			pstmt.setTimestamp(1, startDate);</span>
<span class="nc" id="L585">			pstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L586">			pstmt.setInt(3, agtOrgId);</span>

<span class="nc" id="L588">			logger.debug(&quot;***PWT Query*** \n&quot; + pstmt);</span>
<span class="nc" id="L589">			rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L591" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L592">				pwtScratchRetMap.put(rs.getInt(&quot;retailer_org_id&quot;), rs</span>
						.getDouble(&quot;pwt&quot;));
			}

<span class="nc" id="L596">			logger.debug(&quot;***Sale Scratch Map***&quot; + saleScratchRetMap);</span>
<span class="nc" id="L597">			logger.debug(&quot;***Pwt Scratch Map***&quot; + pwtScratchRetMap);</span>

			// Cash Payment Calculations
<span class="nc" id="L600">			cashQry = &quot;select retailer_org_id,sum(amount) cash from st_lms_agent_cash_transaction where transaction_id in(select transaction_id from st_lms_agent_transaction_master where transaction_type='CASH' and transaction_date&gt;=? and transaction_date&lt;=?) and agent_org_id=? group by retailer_org_id&quot;;</span>
<span class="nc" id="L601">			pstmt = con.prepareStatement(cashQry);</span>
<span class="nc" id="L602">			pstmt.setTimestamp(1, startDate);</span>
<span class="nc" id="L603">			pstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L604">			pstmt.setInt(3, agtOrgId);</span>

<span class="nc" id="L606">			logger.debug(&quot;***Cash Query*** \n&quot; + pstmt);</span>
<span class="nc" id="L607">			rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L609" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L610">				cashRetMap.put(rs.getInt(&quot;retailer_org_id&quot;), rs</span>
						.getDouble(&quot;cash&quot;));
			}
			// Cheque Payment Calculations
<span class="nc" id="L614">			cashQry = &quot;select retailer_org_id,sum(cheque_amt) cheque from st_lms_agent_sale_chq where transaction_id in(select transaction_id from st_lms_agent_transaction_master where transaction_type='CHEQUE' and transaction_date&gt;=? and transaction_date&lt;=?) and agent_org_id=? group by retailer_org_id&quot;;</span>
<span class="nc" id="L615">			pstmt = con.prepareStatement(cashQry);</span>
<span class="nc" id="L616">			pstmt.setTimestamp(1, startDate);</span>
<span class="nc" id="L617">			pstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L618">			pstmt.setInt(3, agtOrgId);</span>

<span class="nc" id="L620">			logger.debug(&quot;***Cash Query*** \n&quot; + pstmt);</span>
<span class="nc" id="L621">			rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L623" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L624">				cashRetMap.put(rs.getInt(&quot;retailer_org_id&quot;), rs</span>
						.getDouble(&quot;cheque&quot;)
						+ cashRetMap.get(rs.getInt(&quot;retailer_org_id&quot;)));
			}
			// Result Map
<span class="nc" id="L629">			Iterator&lt;Map.Entry&lt;Integer, String&gt;&gt; iter = orgMap.entrySet()</span>
					.iterator();
<span class="nc" id="L631">			double saleDrawAmtTot = 0.0;</span>
<span class="nc" id="L632">			double cancelDrawAmtTot = 0.0;</span>
<span class="nc" id="L633">			double pwtDrawAmtTot = 0.0;</span>
<span class="nc" id="L634">			double saleScratchAmtTot = 0.0;</span>
<span class="nc" id="L635">			double pwtScratchAmtTot = 0.0;</span>
<span class="nc" id="L636">			double cashAmtTot = 0.0;</span>
<span class="nc" id="L637">			double cashInHandTot = 0.0;</span>

<span class="nc bnc" id="L639" title="All 2 branches missed.">			while (iter.hasNext()) {</span>
<span class="nc" id="L640">				Map.Entry&lt;Integer, String&gt; pair = (Map.Entry&lt;Integer, String&gt;) iter</span>
						.next();
<span class="nc" id="L642">				int key = pair.getKey(); // orgId</span>
<span class="nc" id="L643">				StringBuilder amtVal = new StringBuilder(&quot;&quot;);</span>
<span class="nc" id="L644">				String orgName = pair.getValue();</span>
<span class="nc" id="L645">				double saleDrawAmt = saleDrawRetMap.get(key);</span>
<span class="nc" id="L646">				double cancelDrawAmt = cancelDrawRetMap.get(key);</span>
<span class="nc" id="L647">				double pwtDrawAmt = pwtDrawRetMap.get(key);</span>
<span class="nc" id="L648">				double saleScratchAmt = saleScratchRetMap.get(key);</span>
<span class="nc" id="L649">				double pwtScratchAmt = pwtScratchRetMap.get(key);</span>
<span class="nc" id="L650">				double cashAmt = cashRetMap.get(key);</span>

<span class="nc" id="L652">				double cashInHand = saleDrawAmt</span>
						+ saleScratchAmt
						- (cancelDrawAmt + pwtDrawAmt + pwtScratchAmt + cashAmt);

<span class="nc" id="L656">				amtVal.append(saleDrawAmt + &quot;,&quot; + cancelDrawAmt + &quot;,&quot;</span>
						+ pwtDrawAmt + &quot;,&quot; + saleScratchAmt + &quot;,&quot;
						+ pwtScratchAmt + &quot;,&quot; + cashAmt + &quot;,&quot; + cashInHand);
<span class="nc" id="L659">				reportMap.put(orgName, amtVal.toString());</span>

<span class="nc" id="L661">				saleDrawAmtTot += saleDrawAmt;</span>
<span class="nc" id="L662">				cancelDrawAmtTot += cancelDrawAmt;</span>
<span class="nc" id="L663">				pwtDrawAmtTot += pwtDrawAmt;</span>
<span class="nc" id="L664">				saleScratchAmtTot += saleScratchAmt;</span>
<span class="nc" id="L665">				pwtScratchAmtTot += pwtScratchAmt;</span>
<span class="nc" id="L666">				cashAmtTot += cashAmt;</span>
<span class="nc" id="L667">				cashInHandTot += cashInHand;</span>
<span class="nc" id="L668">			}</span>
<span class="nc" id="L669">			reportMap</span>
					.put(&quot;Total&quot;, saleDrawAmtTot + &quot;,&quot; + cancelDrawAmtTot + &quot;,&quot;
							+ pwtDrawAmtTot + &quot;,&quot; + saleScratchAmtTot + &quot;,&quot;
							+ pwtScratchAmtTot + &quot;,&quot; + cashAmtTot + &quot;,&quot;
							+ cashInHandTot);
<span class="nc" id="L674">			logger.debug(&quot;***report Map***&quot; + reportMap);</span>

<span class="nc" id="L676">		} catch (Exception e) {</span>
<span class="nc" id="L677">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L679">			try {</span>
<span class="nc" id="L680">				con.close();</span>
<span class="nc" id="L681">			} catch (SQLException e) {</span>
<span class="nc" id="L682">				e.printStackTrace();</span>
<span class="nc" id="L683">			}</span>
<span class="nc" id="L684">		}</span>
<span class="nc" id="L685">		return reportMap;</span>
	}

	public TreeMap&lt;String, String&gt; scratchReport(int agtOrgId,
			Timestamp startDate, Timestamp endDate) {
<span class="nc" id="L690">		Connection con = null;</span>
<span class="nc" id="L691">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L692">		ResultSet rsRetOrg = null;</span>
<span class="nc" id="L693">		ResultSet rs = null;</span>
<span class="nc" id="L694">		String retOrgQry = null;</span>
<span class="nc" id="L695">		String saleQry = null;</span>
<span class="nc" id="L696">		String pwtQry = null;</span>
<span class="nc" id="L697">		Map&lt;Integer, String&gt; orgMap = new HashMap&lt;Integer, String&gt;();</span>
<span class="nc" id="L698">		TreeMap&lt;String, String&gt; reportMap = new TreeMap&lt;String, String&gt;();</span>
<span class="nc" id="L699">		Map&lt;Integer, Double&gt; saleRetMap = new HashMap&lt;Integer, Double&gt;();</span>
<span class="nc" id="L700">		Map&lt;Integer, Double&gt; pwtRetMap = new HashMap&lt;Integer, Double&gt;();</span>
		try {
<span class="nc" id="L702">			con = DBConnect.getConnection();</span>
<span class="nc" id="L703">			con.setAutoCommit(false);</span>
<span class="nc" id="L704">			retOrgQry = &quot;select name,organization_id from st_lms_organization_master where parent_id=?&quot;;</span>
<span class="nc" id="L705">			pstmt = con.prepareStatement(retOrgQry);</span>
<span class="nc" id="L706">			pstmt.setInt(1, agtOrgId);</span>
<span class="nc" id="L707">			rsRetOrg = pstmt.executeQuery();</span>
<span class="nc bnc" id="L708" title="All 2 branches missed.">			while (rsRetOrg.next()) {</span>
<span class="nc" id="L709">				orgMap.put(rsRetOrg.getInt(&quot;organization_id&quot;), rsRetOrg</span>
						.getString(&quot;name&quot;));
<span class="nc" id="L711">				saleRetMap.put(rsRetOrg.getInt(&quot;organization_id&quot;), 0.0);</span>
<span class="nc" id="L712">				pwtRetMap.put(rsRetOrg.getInt(&quot;organization_id&quot;), 0.0);</span>
			}

			// Calculate Sale
<span class="nc" id="L716">			saleQry = &quot;select current_owner_id,sum(sale) sale from (select gmti.game_id,gmti.current_owner_id,gmti.date, (sum(gmti.sold_tickets)*ticket_price) sale from st_se_game_ticket_inv_history gmti ,st_se_game_master gm where gmti.current_owner='RETAILER' and gmti.current_owner_id in(select organization_id from st_lms_organization_master where parent_id=?) and gmti.date&gt;=? and gmti.date&lt;=? and gmti.game_id=gm.game_id group by gmti.current_owner_id,gmti.game_id) aa group by current_owner_id&quot;;</span>
<span class="nc" id="L717">			pstmt = con.prepareStatement(saleQry);</span>
<span class="nc" id="L718">			pstmt.setInt(1, agtOrgId);</span>
<span class="nc" id="L719">			pstmt.setTimestamp(2, startDate);</span>
<span class="nc" id="L720">			pstmt.setTimestamp(3, endDate);</span>

<span class="nc" id="L722">			logger.debug(&quot;***Sale Query*** \n&quot; + pstmt);</span>
<span class="nc" id="L723">			rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L725" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L726">				saleRetMap.put(rs.getInt(&quot;current_owner_id&quot;), rs</span>
						.getDouble(&quot;sale&quot;));
			}

			// Calculate Pwt
<span class="nc" id="L731">			pwtQry = &quot;select retailer_org_id,sum(pwt_amt) pwt from st_se_retailer_pwt where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_date&gt;=? and transaction_date&lt;=? and transaction_type='PWT' and retailer_org_id in (select organization_id from st_lms_organization_master where parent_id=?)) group by retailer_org_id&quot;;</span>
<span class="nc" id="L732">			pstmt = con.prepareStatement(pwtQry);</span>
<span class="nc" id="L733">			pstmt.setTimestamp(1, startDate);</span>
<span class="nc" id="L734">			pstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L735">			pstmt.setInt(3, agtOrgId);</span>

<span class="nc" id="L737">			logger.debug(&quot;***PWT Query*** \n&quot; + pstmt);</span>
<span class="nc" id="L738">			rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L740" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L741">				pwtRetMap</span>
						.put(rs.getInt(&quot;retailer_org_id&quot;), rs.getDouble(&quot;pwt&quot;));
			}

<span class="nc" id="L745">			logger.debug(&quot;***Sale Map***&quot; + saleRetMap);</span>
<span class="nc" id="L746">			logger.debug(&quot;***Pwt Map***&quot; + pwtRetMap);</span>

<span class="nc" id="L748">			Iterator&lt;Map.Entry&lt;Integer, String&gt;&gt; iter = orgMap.entrySet()</span>
					.iterator();
<span class="nc bnc" id="L750" title="All 2 branches missed.">			while (iter.hasNext()) {</span>
<span class="nc" id="L751">				Map.Entry&lt;Integer, String&gt; pair = (Map.Entry&lt;Integer, String&gt;) iter</span>
						.next();
<span class="nc" id="L753">				int key = pair.getKey();</span>
<span class="nc" id="L754">				StringBuilder amtVal = new StringBuilder(&quot;&quot;);</span>
<span class="nc" id="L755">				String orgName = pair.getValue();</span>
<span class="nc" id="L756">				double saleAmt = saleRetMap.get(key);</span>
<span class="nc" id="L757">				double pwtAmt = pwtRetMap.get(key);</span>
<span class="nc" id="L758">				double cashInHand = saleAmt - pwtAmt;</span>

<span class="nc" id="L760">				amtVal.append(saleAmt + &quot;,&quot; + pwtAmt + &quot;,&quot; + cashInHand);</span>
<span class="nc" id="L761">				reportMap.put(orgName, amtVal.toString());</span>
<span class="nc" id="L762">			}</span>
<span class="nc" id="L763">			logger.debug(&quot;***report Map***&quot; + reportMap);</span>
<span class="nc" id="L764">			con.commit();</span>
<span class="nc" id="L765">		} catch (Exception e) {</span>
<span class="nc" id="L766">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L768">			try {</span>
<span class="nc" id="L769">				con.close();</span>
<span class="nc" id="L770">			} catch (SQLException e) {</span>
<span class="nc" id="L771">				e.printStackTrace();</span>
<span class="nc" id="L772">			}</span>
<span class="nc" id="L773">		}</span>
<span class="nc" id="L774">		return reportMap;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>