<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LedgerHelperQuartz.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lms</a> &gt; <a href="index.source.html" class="el_package">com.skilrock.lms.coreEngine.reportsMgmt.common</a> &gt; <span class="el_source">LedgerHelperQuartz.java</span></div><h1>LedgerHelperQuartz.java</h1><pre class="source lang-java linenums">package com.skilrock.lms.coreEngine.reportsMgmt.common;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.sql.Timestamp;
import java.text.DateFormat;
import java.text.ParseException;
import java.util.Date;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.apache.struts2.ServletActionContext;

import com.skilrock.lms.common.db.DBConnect;
import com.skilrock.lms.common.db.QueryManager;
import com.skilrock.lms.common.exception.LMSException;
import com.skilrock.lms.common.utility.FormatNumber;
import com.skilrock.lms.common.utility.PropertyLoader;

/**
 * This Helper class is for generation of Agent and Back Office ledger.
 * 
 * @author Skilrock Technologies
 * 
 */
<span class="nc" id="L29">public class LedgerHelperQuartz {</span>
<span class="nc" id="L30">	private static Log logger = LogFactory.getLog(LedgerHelperQuartz.class);</span>
<span class="nc" id="L31">	String address = null;</span>
	double AGENT_ACCOUNT_CURRENT;
	double agent_bank_acc_current;
	private int agent_id;
	double agent_pwt_charges_current;
	double agent_pwt_charges_rcv_current;
	double agent_pwt_pay_current;
	double agent_vat_pay_current;
	double agnt_prchse_current;
	double agnt_purchs_ret_current;
	double agnt_pwt_rcv_current;
	double agnt_sale_acc_current;
	double agnt_sale_ret_current;

	double BANK_ACC_CURRENT;

	double bo_bank_acc_current;
	double bo_pwt_charges_current;
	double bo_pwt_pay_current;
	double bo_sale_acc_current;
	double bo_sale_ret_current;
<span class="nc" id="L52">	Connection connection = null;</span>
<span class="nc" id="L53">	Date date = null;</span>
<span class="nc" id="L54">	DateFormat dateFormat1 = new java.text.SimpleDateFormat(&quot;dd-MM-yyyy&quot;);</span>

<span class="nc" id="L56">	String dep_Date = getDeployMentDate();</span>
<span class="nc" id="L57">	String genNum = null;</span>
	double GOVT_COMM_CURRENT;
<span class="nc" id="L59">	String orgName = null;</span>
	double PLAYER_CASH_CURRENT;
	double PLAYER_PWT_CURRENT;
	double PLAYER_TDS_CURRENT;
	// Date present_date = null;
<span class="nc" id="L64">	Timestamp present_date = null;</span>
	double PWT_CHARGES_CURRENT;
	double PWT_PAY_CURRENT;
<span class="nc" id="L67">	String query1 = null;</span>
<span class="nc" id="L68">	String query2 = null;</span>
<span class="nc" id="L69">	String query3 = null;</span>
<span class="nc" id="L70">	PreparedStatement rcptPS = null;</span>
<span class="nc" id="L71">	String rcptQry = null;</span>
<span class="nc" id="L72">	ResultSet rcptRS = null;</span>
	double retailer_org_id_current;
<span class="nc" id="L74">	ResultSet rs = null;</span>

<span class="nc" id="L76">	ResultSet rs1 = null;</span>
<span class="nc" id="L77">	ResultSet rs2 = null;</span>
	double SALE_ACC_CURRENT;
	double SALE_RET_CURRENT;

<span class="nc" id="L81">	Statement statement = null;</span>
<span class="nc" id="L82">	PreparedStatement stmt = null;</span>
<span class="nc" id="L83">	PreparedStatement stmt1 = null;</span>
<span class="nc" id="L84">	PreparedStatement stmt2 = null;</span>

	double TDS_PAY_CURRENT;
<span class="nc" id="L87">	Timestamp to_Date = null;</span>
	double UNCLM_GOVT_CURRENT;
<span class="nc" id="L89">	PreparedStatement updatePstmt = null;</span>
<span class="nc" id="L90">	PreparedStatement updPstmt = null;</span>
<span class="nc" id="L91">	PreparedStatement upPstmt = null;</span>
	double VAT_PAY_CURRENT;

	/**
	 * This method is for entering the data into back office ledger.
	 * 
	 * @param toDate_Bean
	 *            is Date and used for comparing the date from Database.
	 * @throws LMSException
	 */
	public String getDeployMentDate() {
<span class="nc" id="L102">		String dep_Date = null;</span>

<span class="nc bnc" id="L104" title="All 2 branches missed.">		if (ServletActionContext.getServletContext() != null) {</span>
<span class="nc" id="L105">			dep_Date = (String) ServletActionContext.getServletContext()</span>
					.getAttribute(&quot;DEPLOYMENT_DATE&quot;);
		} else {
<span class="nc" id="L108">			PropertyLoader.loadProperties(&quot;RMS/LMS.properties&quot;);</span>
<span class="nc" id="L109">			dep_Date = PropertyLoader.getProperty(&quot;deployment_date&quot;);</span>
		}

<span class="nc" id="L112">		return dep_Date;</span>
	}

	private String chkArcLedgerTable() {
<span class="nc" id="L116">		String archDate = null;</span>
<span class="nc" id="L117">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L118">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L119">		ResultSet rs = null;</span>
		try {
<span class="nc" id="L121">			con.setAutoCommit(false);</span>
<span class="nc" id="L122">			String selQry = &quot;select max(last_date) archDate from tempdate_history&quot;;</span>
<span class="nc" id="L123">			pstmt = con.prepareStatement(selQry);</span>
<span class="nc" id="L124">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L126">				archDate = rs.getString(&quot;archDate&quot;);</span>
			} else {
<span class="nc" id="L128">				archDate = null;</span>
			}

<span class="nc bnc" id="L131" title="All 2 branches missed.">			if (archDate != null) {</span>
<span class="nc" id="L132">				String insQry = &quot;insert into st_lms_bo_current_balance (account_type, current_balance, agent_org_id) select account_type,current_balance,agent_org_id from st_lms_bo_current_balance_history_arch where date(transaction_date)=?&quot;;</span>
<span class="nc" id="L133">				pstmt = con.prepareStatement(insQry);</span>
<span class="nc" id="L134">				pstmt.setString(1, archDate);</span>
<span class="nc" id="L135">				pstmt.executeUpdate();</span>

<span class="nc" id="L137">				insQry = &quot;insert into st_lms_agent_current_balance (account_type,current_balance,agent_org_id) select account_type,current_balance,agent_org_id from st_lms_agent_current_balance_history_arch where date(transaction_date)=?&quot;;</span>
<span class="nc" id="L138">				pstmt = con.prepareStatement(insQry);</span>
<span class="nc" id="L139">				pstmt.setString(1, archDate);</span>
<span class="nc" id="L140">				pstmt.executeUpdate();</span>
<span class="nc" id="L141">			} else {</span>
<span class="nc" id="L142">				archDate = new java.sql.Date(dateFormat1.parse(</span>
						getDeployMentDate()).getTime())
						+ &quot;&quot;;
			}
<span class="nc" id="L146">			con.commit();</span>

<span class="nc" id="L148">		} catch (SQLException e) {</span>
<span class="nc" id="L149">			e.printStackTrace();</span>
<span class="nc" id="L150">		} catch (ParseException e) {</span>
<span class="nc" id="L151">			e.printStackTrace();</span>
<span class="nc" id="L152">		}</span>

<span class="nc" id="L154">		return archDate;</span>
	}

	// END OF METHOD

	// Fetching data for ajax list on Boledger

	public double getDouble(double number) {
<span class="nc" id="L162">		double d = 0.0;</span>
<span class="nc" id="L163">		d = number * 100;</span>
<span class="nc" id="L164">		d = Math.round(d);</span>
<span class="nc" id="L165">		d = d / 100;</span>

<span class="nc" id="L167">		return d;</span>
	}

	/**
	 * This method is for entering the data into agent ledger.
	 * 
	 * @param toDate_Bean
	 *            is Date and used for comparing the date from Database.
	 * @param userId
	 *            is integer and is current user's Organization Id
	 * @throws NumberFormatException
	 */

	public void ledgerAgentEntry(Timestamp toDate_Bean, int userId)
			throws NumberFormatException {

<span class="nc" id="L183">		int retailerPresent = 0;</span>
<span class="nc" id="L184">		agent_id = userId;</span>
		try {
			//  
<span class="nc" id="L187">			connection = DBConnect.getConnection();</span>
<span class="nc" id="L188">			connection.setAutoCommit(false);</span>
<span class="nc" id="L189">			present_date = toDate_Bean;</span>
<span class="nc" id="L190">			toDate_Bean = new Timestamp(present_date.getTime() + 24 * 60 * 60</span>
					* 1000 - 1000);
<span class="nc" id="L192">			to_Date = toDate_Bean;</span>
<span class="nc" id="L193">			String rcptQry = &quot;select sbr.receipt_id,sbr.generated_id from st_lms_bo_receipts_trn_mapping sbrtm , st_lms_bo_receipts sbr where transaction_id=? and sbrtm.receipt_id=sbr.receipt_id&quot;;</span>

<span class="nc bnc" id="L195" title="All 2 branches missed.">			if (present_date.before(to_Date)) {</span>
<span class="nc" id="L196">				logger.debug(&quot;LH-AGT**PresentDate-&quot; + present_date</span>
						+ &quot;**ToDate-&quot; + toDate_Bean);

<span class="nc" id="L199">				int i = 0;</span>
<span class="nc" id="L200">				String genNum = null;</span>
<span class="nc" id="L201">				stmt = connection.prepareStatement(QueryManager</span>
						.getST2AgentCurrentBal());
<span class="nc" id="L203">				stmt.setInt(1, agent_id);</span>
<span class="nc" id="L204">				rs = stmt.executeQuery();</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">					if (rs.getString(&quot;account_type&quot;).equals(&quot;AGNT_BANK_ACC&quot;)) {</span>
<span class="nc" id="L207">						agent_bank_acc_current = rs</span>
								.getDouble(&quot;current_balance&quot;);
<span class="nc bnc" id="L209" title="All 2 branches missed.">					} else if (rs.getString(&quot;account_type&quot;).equals(</span>
							&quot;AGNT_SALE_ACC&quot;)) {
<span class="nc" id="L211">						agnt_sale_acc_current = rs.getDouble(&quot;current_balance&quot;);</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">					} else if (rs.getString(&quot;account_type&quot;).equals(</span>
							&quot;AGNT_SALE_RET&quot;)) {
<span class="nc" id="L214">						agnt_sale_ret_current = rs.getDouble(&quot;current_balance&quot;);</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">					} else if (rs.getString(&quot;account_type&quot;).equals(</span>
							&quot;AGNT_PWT_PAY&quot;)) {
<span class="nc" id="L217">						agent_pwt_pay_current = rs.getDouble(&quot;current_balance&quot;);</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">					} else if (rs.getString(&quot;account_type&quot;).equals(</span>
							&quot;AGNT_PWT_RCV&quot;)) {
<span class="nc" id="L220">						agnt_pwt_rcv_current = rs.getDouble(&quot;current_balance&quot;);</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">					} else if (rs.getString(&quot;account_type&quot;).equals(</span>
							&quot;AGNT_PRCHSE_ACC&quot;)) {
<span class="nc" id="L223">						agnt_prchse_current = rs.getDouble(&quot;current_balance&quot;);</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">					} else if (rs.getString(&quot;account_type&quot;).equals(</span>
							&quot;AGNT_PURCHS_RET_ACC&quot;)) {
<span class="nc" id="L226">						agnt_purchs_ret_current = rs</span>
								.getDouble(&quot;current_balance&quot;);
<span class="nc bnc" id="L228" title="All 2 branches missed.">					} else if (rs.getString(&quot;account_type&quot;).equals(</span>
							&quot;BO_BANK_ACC&quot;)) {
<span class="nc" id="L230">						bo_bank_acc_current = rs.getDouble(&quot;current_balance&quot;);</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">					} else if (rs.getString(&quot;account_type&quot;).equals(</span>
							&quot;BO_SALE_ACC&quot;)) {
<span class="nc" id="L233">						bo_sale_acc_current = rs.getDouble(&quot;current_balance&quot;);</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">					} else if (rs.getString(&quot;account_type&quot;).equals(</span>
							&quot;BO_SALE_RET&quot;)) {
<span class="nc" id="L236">						bo_sale_ret_current = rs.getDouble(&quot;current_balance&quot;);</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">					} else if (rs.getString(&quot;account_type&quot;)</span>
							.equals(&quot;BO_PWT_PAY&quot;)) {
<span class="nc" id="L239">						bo_pwt_pay_current = rs.getDouble(&quot;current_balance&quot;);</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">					} else if (rs.getString(&quot;account_type&quot;).equals(</span>
							&quot;AGNT_PWT_CHARGES_RCV&quot;)) {
<span class="nc" id="L242">						agent_pwt_charges_rcv_current = rs</span>
								.getDouble(&quot;current_balance&quot;);
<span class="nc bnc" id="L244" title="All 2 branches missed.">					} else if (rs.getString(&quot;account_type&quot;).equals(</span>
							&quot;BO_PWT_CHARGES&quot;)) {
<span class="nc" id="L246">						bo_pwt_charges_current = rs</span>
								.getDouble(&quot;current_balance&quot;);
<span class="nc bnc" id="L248" title="All 2 branches missed.">					} else if (rs.getString(&quot;account_type&quot;).equals(</span>
							&quot;AGENT_PWT_CHARGES&quot;)) {
<span class="nc" id="L250">						agent_pwt_charges_current = rs</span>
								.getDouble(&quot;current_balance&quot;);
<span class="nc bnc" id="L252" title="All 2 branches missed.">					} else if (rs.getString(&quot;account_type&quot;).equals(</span>
							&quot;AGENT_VAT_PAY&quot;)) {
<span class="nc" id="L254">						agent_vat_pay_current = rs.getDouble(&quot;current_balance&quot;);</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">					} else if (rs.getString(&quot;account_type&quot;).equals(</span>
							&quot;AGNT_PLAYER_TDS&quot;)) {
<span class="nc" id="L257">						PLAYER_TDS_CURRENT = rs.getDouble(&quot;current_balance&quot;);</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">					} else if (rs.getString(&quot;account_type&quot;).equals(</span>
							&quot;AGNT_PLAYER_PWT&quot;)) {
<span class="nc" id="L260">						PLAYER_PWT_CURRENT = rs.getDouble(&quot;current_balance&quot;);</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">					} else if (rs.getString(&quot;account_type&quot;).equals(</span>
							&quot;AGNT_PLAYER_CAS&quot;)) {
<span class="nc" id="L263">						PLAYER_CASH_CURRENT = rs.getDouble(&quot;current_balance&quot;);</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">					} else if (rs.getString(&quot;account_type&quot;).equals(</span>
							&quot;AGNT_TDS_PAY&quot;)) {
<span class="nc" id="L266">						PLAYER_CASH_CURRENT = rs.getDouble(&quot;current_balance&quot;);</span>
					}
<span class="nc" id="L268">					i++;</span>
				}

<span class="nc bnc" id="L271" title="All 2 branches missed.">				if (rs != null) {</span>
<span class="nc" id="L272">					rs.close();</span>
				}
<span class="nc bnc" id="L274" title="All 2 branches missed.">				if (i == 0) {</span>
<span class="nc" id="L275">					stmt</span>
							.executeUpdate(&quot;insert into st_lms_agent_current_balance (account_type,current_balance,agent_org_id) values ('AGNT_BANK_ACC',0.0,&quot;
									+ agent_id + &quot;)&quot;);
<span class="nc" id="L278">					stmt</span>
							.executeUpdate(&quot;insert into st_lms_agent_current_balance (account_type,current_balance,agent_org_id) values ('AGNT_SALE_ACC',0.0,&quot;
									+ agent_id + &quot;)&quot;);
<span class="nc" id="L281">					stmt</span>
							.executeUpdate(&quot;insert into st_lms_agent_current_balance (account_type,current_balance,agent_org_id) values ('AGNT_SALE_RET',0.0,&quot;
									+ agent_id + &quot;)&quot;);
<span class="nc" id="L284">					stmt</span>
							.executeUpdate(&quot;insert into st_lms_agent_current_balance (account_type,current_balance,agent_org_id) values ('AGNT_PWT_PAY',0.0,&quot;
									+ agent_id + &quot;)&quot;);
<span class="nc" id="L287">					stmt</span>
							.executeUpdate(&quot;insert into st_lms_agent_current_balance (account_type,current_balance,agent_org_id) values ('AGNT_PWT_RCV',0.0,&quot;
									+ agent_id + &quot;)&quot;);
<span class="nc" id="L290">					stmt</span>
							.executeUpdate(&quot;insert into st_lms_agent_current_balance (account_type,current_balance,agent_org_id) values ('AGNT_PRCHSE_ACC',0.0,&quot;
									+ agent_id + &quot;)&quot;);
<span class="nc" id="L293">					stmt</span>
							.executeUpdate(&quot;insert into st_lms_agent_current_balance (account_type,current_balance,agent_org_id) values ('AGNT_PURCHS_RET_ACC',0.0,&quot;
									+ agent_id + &quot;)&quot;);
<span class="nc" id="L296">					stmt</span>
							.executeUpdate(&quot;insert into st_lms_agent_current_balance (account_type,current_balance,agent_org_id) values ('BO_BANK_ACC',0.0,&quot;
									+ agent_id + &quot;)&quot;);
<span class="nc" id="L299">					stmt</span>
							.executeUpdate(&quot;insert into st_lms_agent_current_balance (account_type,current_balance,agent_org_id) values ('BO_SALE_ACC',0.0,&quot;
									+ agent_id + &quot;)&quot;);
<span class="nc" id="L302">					stmt</span>
							.executeUpdate(&quot;insert into st_lms_agent_current_balance (account_type,current_balance,agent_org_id) values ('BO_SALE_RET',0.0,&quot;
									+ agent_id + &quot;)&quot;);
<span class="nc" id="L305">					stmt</span>
							.executeUpdate(&quot;insert into st_lms_agent_current_balance (account_type,current_balance,agent_org_id) values ('BO_PWT_PAY',0.0,&quot;
									+ agent_id + &quot;)&quot;);
<span class="nc" id="L308">					stmt</span>
							.executeUpdate(&quot;insert into st_lms_agent_current_balance (account_type,current_balance,agent_org_id) values ('AGNT_PLAYER_TDS',0.0,&quot;
									+ agent_id + &quot;)&quot;);
<span class="nc" id="L311">					stmt</span>
							.executeUpdate(&quot;insert into st_lms_agent_current_balance (account_type,current_balance,agent_org_id) values ('AGNT_PLAYER_PWT',0.0,&quot;
									+ agent_id + &quot;)&quot;);
<span class="nc" id="L314">					stmt</span>
							.executeUpdate(&quot;insert into st_lms_agent_current_balance (account_type,current_balance,agent_org_id) values ('AGNT_PLAYER_CAS',0.0,&quot;
									+ agent_id + &quot;)&quot;);
<span class="nc" id="L317">					stmt</span>
							.executeUpdate(&quot;insert into st_lms_agent_current_balance (account_type,current_balance,agent_org_id) values ('AGNT_TDS_PAY',0.0,&quot;
									+ agent_id + &quot;)&quot;);
<span class="nc" id="L320">					stmt</span>
							.executeUpdate(&quot;insert into st_lms_agent_current_balance (account_type,current_balance,agent_org_id) values ('AGNT_PWT_CHARGES_RCV',0.0,&quot;
									+ agent_id + &quot;)&quot;);
<span class="nc" id="L323">					stmt</span>
							.executeUpdate(&quot;insert into st_lms_agent_current_balance (account_type,current_balance,agent_org_id) values ('BO_PWT_CHARGES',0.0,&quot;
									+ agent_id + &quot;)&quot;);
<span class="nc" id="L326">					stmt</span>
							.executeUpdate(&quot;insert into st_lms_agent_current_balance (account_type,current_balance,agent_org_id) values ('AGENT_PWT_CHARGES',0.0,&quot;
									+ agent_id + &quot;)&quot;);
<span class="nc" id="L329">					stmt</span>
							.executeUpdate(&quot;insert into st_lms_agent_current_balance (account_type,current_balance,agent_org_id) values ('AGENT_VAT_PAY',0.0,&quot;
									+ agent_id + &quot;)&quot;);

<span class="nc bnc" id="L333" title="All 2 branches missed.">					if (stmt != null) {</span>
<span class="nc" id="L334">						stmt.close();</span>
					}

				}

				// ///////////////////////Start of Back Office and Agent Ledger
				// Entry Part/////////////

<span class="nc" id="L342">				stmt1 = connection.prepareStatement(QueryManager</span>
						.getST2BoAgtTransactions());
<span class="nc" id="L344">				stmt1.setTimestamp(1, present_date);</span>
<span class="nc" id="L345">				stmt1.setTimestamp(2, to_Date);</span>
<span class="nc" id="L346">				stmt1.setInt(3, agent_id);</span>
<span class="nc" id="L347">				logger.debug(&quot;LH-AGT**Select Trxn Master**&quot; + stmt1);</span>
<span class="nc" id="L348">				rs1 = stmt1.executeQuery();</span>
<span class="nc bnc" id="L349" title="All 2 branches missed.">				while (rs1.next()) {</span>

<span class="nc" id="L351">					long transaction_id = rs1.getLong(&quot;transaction_id&quot;);</span>
<span class="nc" id="L352">					String transaction_type = rs1.getString(&quot;transaction_type&quot;);</span>
<span class="nc" id="L353">					String RECEIPT_ID = &quot;N.A.&quot;;</span>

<span class="nc" id="L355">					rcptPS = connection.prepareStatement(rcptQry);</span>
<span class="nc" id="L356">					rcptPS.setLong(1, transaction_id);</span>
<span class="nc" id="L357">					rcptRS = rcptPS.executeQuery();</span>

<span class="nc bnc" id="L359" title="All 2 branches missed.">					while (rcptRS.next()) {</span>
<span class="nc" id="L360">						genNum = rcptRS.getString(&quot;generated_id&quot;);</span>
<span class="nc bnc" id="L361" title="All 8 branches missed.">						if (genNum != null</span>
								&amp;&amp; !genNum.trim().equals(&quot;&quot;)
								&amp;&amp; !(genNum.contains(&quot;DLB&quot;) || genNum
										.contains(&quot;DSB&quot;))) {
<span class="nc" id="L365">							RECEIPT_ID = rcptRS.getString(&quot;generated_id&quot;);</span>
						}

					}

<span class="nc bnc" id="L370" title="All 2 branches missed.">					if (rcptPS != null) {</span>
<span class="nc" id="L371">						rcptPS.close();</span>
					}
<span class="nc bnc" id="L373" title="All 2 branches missed.">					if (rcptRS != null) {</span>
<span class="nc" id="L374">						rcptRS.close();</span>
					}

<span class="nc" id="L377">					double amount = 0;</span>
<span class="nc" id="L378">					double pwt_charges_amount = 0;</span>
<span class="nc" id="L379">					Timestamp transaction_date = null;</span>
					// java.sql.Date transaction_date = null;
<span class="nc" id="L381">					String acc_type = &quot;&quot;;</span>
<span class="nc" id="L382">					String acc_type_charges = &quot;&quot;;</span>
<span class="nc" id="L383">					String saleQuery = &quot;&quot;;</span>
<span class="nc" id="L384">					String saleRetQuery = &quot;&quot;;</span>
<span class="nc bnc" id="L385" title="All 8 branches missed.">					if (transaction_type.equalsIgnoreCase(&quot;Sale&quot;)</span>
							|| transaction_type.equalsIgnoreCase(&quot;DG_SALE&quot;)
							|| transaction_type.equalsIgnoreCase(&quot;CS_SALE&quot;) || transaction_type.equalsIgnoreCase(&quot;OLA_DEPOSIT&quot;)) {
<span class="nc bnc" id="L388" title="All 2 branches missed.">						if (transaction_type.equalsIgnoreCase(&quot;Sale&quot;)) {</span>
<span class="nc" id="L389">							saleQuery = QueryManager.getST2BoSale();</span>
<span class="nc bnc" id="L390" title="All 2 branches missed.">						} else if (transaction_type.equalsIgnoreCase(&quot;DG_SALE&quot;)) {</span>
<span class="nc" id="L391">							saleQuery = QueryManager.getST2BoDrwGmSale();</span>
<span class="nc bnc" id="L392" title="All 2 branches missed.">						} else if (transaction_type.equalsIgnoreCase(&quot;CS_SALE&quot;)) {</span>
<span class="nc" id="L393">							saleQuery = QueryManager.getST2BoCsSale();</span>
						}
<span class="nc bnc" id="L395" title="All 2 branches missed.">						else if (transaction_type.equalsIgnoreCase(&quot;OLA_DEPOSIT&quot;)) {</span>
<span class="nc" id="L396">							saleQuery = QueryManager.getST2BoOlaDeposit();</span>
						}
<span class="nc" id="L398">						stmt2 = connection.prepareStatement(saleQuery);</span>
<span class="nc" id="L399">						stmt2.setLong(1, transaction_id);</span>
<span class="nc" id="L400">						rs2 = stmt2.executeQuery();</span>
<span class="nc" id="L401">						logger.debug(&quot;LH-AGT**&quot; + transaction_type</span>
								+ &quot;**TRX_ID-&quot; + transaction_id + &quot;**R_ID-&quot;
								+ RECEIPT_ID);
<span class="nc bnc" id="L404" title="All 2 branches missed.">						while (rs2.next()) {</span>
<span class="nc" id="L405">							amount = rs2.getDouble(&quot;net_amt&quot;);</span>
<span class="nc" id="L406">							transaction_date = rs2</span>
									.getTimestamp(&quot;transaction_date&quot;);
<span class="nc" id="L408">							acc_type = &quot;AGNT_PRCHSE_ACC&quot;;</span>
						}

<span class="nc bnc" id="L411" title="All 2 branches missed.">						if (stmt2 != null) {</span>
<span class="nc" id="L412">							stmt2.close();</span>
						}
<span class="nc bnc" id="L414" title="All 2 branches missed.">						if (rs2 != null) {</span>
<span class="nc" id="L415">							rs2.close();</span>
						}

<span class="nc" id="L418">						stmt = connection.prepareStatement(QueryManager</span>
								.getST6AgtCurrBal());
<span class="nc" id="L420">						stmt.setString(1, acc_type);</span>
<span class="nc" id="L421">						stmt.setInt(2, agent_id);</span>
<span class="nc" id="L422">						rs = stmt.executeQuery();</span>
<span class="nc bnc" id="L423" title="All 2 branches missed.">						while (rs.next()) {</span>
<span class="nc" id="L424">							agnt_prchse_current = rs</span>
									.getDouble(&quot;current_balance&quot;);

						}

<span class="nc bnc" id="L429" title="All 2 branches missed.">						if (stmt != null) {</span>
<span class="nc" id="L430">							stmt.close();</span>
						}
<span class="nc bnc" id="L432" title="All 2 branches missed.">						if (rs != null) {</span>
<span class="nc" id="L433">							rs.close();</span>
						}

<span class="nc" id="L436">						agnt_prchse_current = agnt_prchse_current - amount;</span>
<span class="nc" id="L437">						bo_sale_acc_current = bo_sale_acc_current + amount;</span>

<span class="nc" id="L439">						logger.debug(&quot;LH-AGT**&quot; + transaction_date + &quot;**AMT-&quot;</span>
								+ amount + &quot;**ACT_TYPE-&quot; + acc_type
								+ &quot;**AGT_PURCH_ACC=&quot; + agnt_prchse_current
								+ &quot;**BO_SALE_ACC&quot; + bo_sale_acc_current);
<span class="nc" id="L443">						query1 = QueryManager.getST2InsertAgentLedger();</span>
<span class="nc" id="L444">						updatePstmt = connection.prepareStatement(query1);</span>

<span class="nc" id="L446">						updatePstmt.setInt(1, agent_id);</span>
<span class="nc" id="L447">						updatePstmt.setString(2, &quot;PURCH&quot;);</span>
<span class="nc" id="L448">						updatePstmt.setLong(3, transaction_id);</span>
<span class="nc" id="L449">						updatePstmt.setTimestamp(4, transaction_date);</span>
<span class="nc" id="L450">						updatePstmt.setString(5, -amount + &quot;&quot;);</span>
<span class="nc" id="L451">						updatePstmt.setString(6, acc_type);</span>
<span class="nc" id="L452">						updatePstmt.setString(7, agnt_prchse_current + &quot;&quot;);</span>
<span class="nc" id="L453">						updatePstmt.setString(8, &quot;BO&quot;);</span>
<span class="nc" id="L454">						updatePstmt.setString(9, RECEIPT_ID);</span>
<span class="nc" id="L455">						updatePstmt.execute();</span>

<span class="nc bnc" id="L457" title="All 2 branches missed.">						if (updatePstmt != null) {</span>
<span class="nc" id="L458">							updatePstmt.close();</span>
						}

<span class="nc" id="L461">						query2 = QueryManager.getST2InsertAgentLedger();</span>
<span class="nc" id="L462">						upPstmt = connection.prepareStatement(query2);</span>
<span class="nc" id="L463">						upPstmt.setInt(1, agent_id);</span>
<span class="nc" id="L464">						upPstmt.setString(2, &quot;PURCH&quot;);</span>
<span class="nc" id="L465">						upPstmt.setLong(3, transaction_id);</span>
<span class="nc" id="L466">						upPstmt.setTimestamp(4, transaction_date);</span>
<span class="nc" id="L467">						upPstmt.setString(5, amount + &quot;&quot;);</span>
<span class="nc" id="L468">						upPstmt.setString(6, &quot;BO_SALE_ACC&quot;);</span>
<span class="nc" id="L469">						upPstmt.setString(7, bo_sale_acc_current + &quot;&quot;);</span>
<span class="nc" id="L470">						upPstmt.setString(8, &quot;BO&quot;);</span>
<span class="nc" id="L471">						upPstmt.setString(9, RECEIPT_ID);</span>
<span class="nc" id="L472">						upPstmt.execute();</span>

<span class="nc bnc" id="L474" title="All 2 branches missed.">						if (upPstmt != null) {</span>
<span class="nc" id="L475">							upPstmt.close();</span>
						}

<span class="nc" id="L478">						query3 = QueryManager.getST2UpadateAgentCurrentBal();</span>
<span class="nc" id="L479">						updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L480">						updPstmt.setString(1, agnt_prchse_current + &quot;&quot;);</span>
<span class="nc" id="L481">						updPstmt.setString(2, acc_type);</span>
<span class="nc" id="L482">						updPstmt.setInt(3, agent_id);</span>
<span class="nc" id="L483">						updPstmt.execute();</span>

<span class="nc bnc" id="L485" title="All 2 branches missed.">						if (updPstmt != null) {</span>
<span class="nc" id="L486">							updPstmt.close();</span>
						}

<span class="nc bnc" id="L489" title="All 12 branches missed.">					} else if (transaction_type.equalsIgnoreCase(&quot;sale_ret&quot;)</span>
							|| transaction_type
									.equalsIgnoreCase(&quot;DG_REFUND_FAILED&quot;)
							|| transaction_type
									.equalsIgnoreCase(&quot;DG_REFUND_CANCEL&quot;)
							|| transaction_type
									.equalsIgnoreCase(&quot;CS_CANCEL_SERVER&quot;)
							|| transaction_type
									.equalsIgnoreCase(&quot;CS_CANCEL_RET&quot;)
							|| transaction_type.equalsIgnoreCase(&quot;OLA_DEPOSIT_REFUND&quot;)) {

<span class="nc bnc" id="L500" title="All 2 branches missed.">						if (transaction_type.equalsIgnoreCase(&quot;sale_ret&quot;)) {</span>
<span class="nc" id="L501">							saleRetQuery = QueryManager.getST2BoSaleRet();</span>
<span class="nc bnc" id="L502" title="All 4 branches missed.">						} else if (transaction_type</span>
								.equalsIgnoreCase(&quot;DG_REFUND_FAILED&quot;)
								|| transaction_type
										.equalsIgnoreCase(&quot;DG_REFUND_CANCEL&quot;)) {
<span class="nc" id="L506">							saleRetQuery = QueryManager.getST2BoDrwGmRefnd();</span>
<span class="nc bnc" id="L507" title="All 4 branches missed.">						} else if (transaction_type</span>
								.equalsIgnoreCase(&quot;CS_CANCEL_SERVER&quot;)
								|| transaction_type
										.equalsIgnoreCase(&quot;CS_CANCEL_RET&quot;)) {
<span class="nc" id="L511">							saleRetQuery = QueryManager.getST2BoCsRefnd();</span>
<span class="nc bnc" id="L512" title="All 2 branches missed.">						}else if(transaction_type.equalsIgnoreCase(&quot;OLA_DEPOSIT_REFUND&quot;))</span>
						{
<span class="nc" id="L514">							saleRetQuery = QueryManager.getST2BoOlaRefnd();</span>
						}
<span class="nc" id="L516">						stmt2 = connection.prepareStatement(saleRetQuery);</span>
<span class="nc" id="L517">						stmt2.setLong(1, transaction_id);</span>
<span class="nc" id="L518">						rs2 = stmt2.executeQuery();</span>
<span class="nc" id="L519">						logger.debug(&quot;LH-AGT**&quot; + transaction_type</span>
								+ &quot;**TRX_ID-&quot; + transaction_id + &quot;**R_ID-&quot;
								+ RECEIPT_ID);
<span class="nc bnc" id="L522" title="All 2 branches missed.">						while (rs2.next()) {</span>
<span class="nc" id="L523">							amount = rs2.getDouble(&quot;net_amt&quot;);</span>
<span class="nc" id="L524">							transaction_date = rs2</span>
									.getTimestamp(&quot;transaction_date&quot;);
<span class="nc" id="L526">							acc_type = &quot;AGNT_PURCHS_RET_ACC&quot;;</span>
						}

<span class="nc bnc" id="L529" title="All 2 branches missed.">						if (stmt2 != null) {</span>
<span class="nc" id="L530">							stmt2.close();</span>
						}
<span class="nc bnc" id="L532" title="All 2 branches missed.">						if (rs2 != null) {</span>
<span class="nc" id="L533">							rs2.close();</span>
						}

<span class="nc" id="L536">						stmt = connection.prepareStatement(QueryManager</span>
								.getST6AgtCurrBal());
<span class="nc" id="L538">						stmt.setString(1, acc_type);</span>
<span class="nc" id="L539">						stmt.setInt(2, agent_id);</span>
<span class="nc" id="L540">						rs = stmt.executeQuery();</span>
<span class="nc bnc" id="L541" title="All 2 branches missed.">						while (rs.next()) {</span>
<span class="nc" id="L542">							agnt_purchs_ret_current = rs</span>
									.getDouble(&quot;current_balance&quot;);
						}

<span class="nc bnc" id="L546" title="All 2 branches missed.">						if (stmt != null) {</span>
<span class="nc" id="L547">							stmt.close();</span>
						}
<span class="nc bnc" id="L549" title="All 2 branches missed.">						if (rs != null) {</span>
<span class="nc" id="L550">							rs.close();</span>
						}

<span class="nc" id="L553">						agnt_purchs_ret_current = agnt_purchs_ret_current</span>
								+ amount;
<span class="nc" id="L555">						bo_sale_ret_current = bo_sale_ret_current - amount;</span>

<span class="nc" id="L557">						logger.debug(&quot;LH-AGT**&quot; + transaction_date + &quot;**AMT-&quot;</span>
								+ amount + &quot;**ACT_TYPE-&quot; + acc_type
								+ &quot;**AGT_PURCH_RET_ACC=&quot;
								+ agnt_purchs_ret_current + &quot;**BO_SALE_RET_ACC&quot;
								+ bo_sale_ret_current);

<span class="nc" id="L563">						query2 = QueryManager.getST2InsertAgentLedger();</span>
<span class="nc" id="L564">						upPstmt = connection.prepareStatement(query2);</span>
<span class="nc" id="L565">						upPstmt.setInt(1, agent_id);</span>
<span class="nc" id="L566">						upPstmt.setString(2, &quot;PURCH_RET&quot;);</span>
<span class="nc" id="L567">						upPstmt.setLong(3, transaction_id);</span>
<span class="nc" id="L568">						upPstmt.setTimestamp(4, transaction_date);</span>
<span class="nc" id="L569">						upPstmt.setString(5, -amount + &quot;&quot;);</span>
<span class="nc" id="L570">						upPstmt.setString(6, &quot;BO_SALE_RET_ACC&quot;);</span>
<span class="nc" id="L571">						upPstmt.setString(7, bo_sale_ret_current + &quot;&quot;);</span>
<span class="nc" id="L572">						upPstmt.setString(8, &quot;BO&quot;);</span>
<span class="nc" id="L573">						upPstmt.setString(9, RECEIPT_ID);</span>
<span class="nc" id="L574">						upPstmt.execute();</span>

<span class="nc bnc" id="L576" title="All 2 branches missed.">						if (upPstmt != null) {</span>
<span class="nc" id="L577">							upPstmt.close();</span>
						}

<span class="nc" id="L580">						query1 = QueryManager.getST2InsertAgentLedger();</span>
<span class="nc" id="L581">						updatePstmt = connection.prepareStatement(query1);</span>

<span class="nc" id="L583">						updatePstmt.setInt(1, agent_id);</span>
<span class="nc" id="L584">						updatePstmt.setString(2, &quot;PURCH_RET&quot;);</span>
<span class="nc" id="L585">						updatePstmt.setLong(3, transaction_id);</span>
<span class="nc" id="L586">						updatePstmt.setTimestamp(4, transaction_date);</span>
<span class="nc" id="L587">						updatePstmt.setString(5, amount + &quot;&quot;);</span>
<span class="nc" id="L588">						updatePstmt.setString(6, acc_type);</span>
<span class="nc" id="L589">						updatePstmt.setString(7, agnt_purchs_ret_current + &quot;&quot;);</span>
<span class="nc" id="L590">						updatePstmt.setString(8, &quot;BO&quot;);</span>
<span class="nc" id="L591">						updatePstmt.setString(9, RECEIPT_ID);</span>
<span class="nc" id="L592">						updatePstmt.execute();</span>

<span class="nc bnc" id="L594" title="All 2 branches missed.">						if (updatePstmt != null) {</span>
<span class="nc" id="L595">							updatePstmt.close();</span>
						}

<span class="nc" id="L598">						query3 = QueryManager.getST2UpadateAgentCurrentBal();</span>
<span class="nc" id="L599">						updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L600">						updPstmt.setString(1, agnt_purchs_ret_current + &quot;&quot;);</span>
<span class="nc" id="L601">						updPstmt.setString(2, acc_type);</span>
<span class="nc" id="L602">						updPstmt.setInt(3, agent_id);</span>
<span class="nc" id="L603">						updPstmt.execute();</span>

<span class="nc bnc" id="L605" title="All 2 branches missed.">						if (updatePstmt != null) {</span>
<span class="nc" id="L606">							updatePstmt.close();</span>
						}

					}

<span class="nc bnc" id="L611" title="All 2 branches missed.">					else if (transaction_type.equalsIgnoreCase(&quot;cheque&quot;)) {</span>
						// This has been changed to prepared statement 10-03-08
<span class="nc" id="L613">						stmt2 = connection.prepareStatement(QueryManager</span>
								.getST2BoChq());
<span class="nc" id="L615">						stmt2.setLong(1, transaction_id);</span>
<span class="nc" id="L616">						rs2 = stmt2.executeQuery();</span>
						// rs2 =
						// stmt2.executeQuery(QueryManager.getST2BoChq()+&quot;&quot;+
						// transaction_id + &quot;&quot;);;

<span class="nc bnc" id="L621" title="All 2 branches missed.">						while (rs2.next()) {</span>
<span class="nc" id="L622">							amount = rs2.getDouble(&quot;cheque_amt&quot;);</span>
<span class="nc" id="L623">							transaction_date = rs2</span>
									.getTimestamp(&quot;transaction_date&quot;);
<span class="nc" id="L625">							acc_type = &quot;AGNT_BANK_ACC&quot;;</span>
						}

<span class="nc bnc" id="L628" title="All 2 branches missed.">						if (stmt2 != null) {</span>
<span class="nc" id="L629">							stmt2.close();</span>
						}
<span class="nc bnc" id="L631" title="All 2 branches missed.">						if (rs2 != null) {</span>
<span class="nc" id="L632">							rs2.close();</span>
						}

<span class="nc" id="L635">						stmt = connection.prepareStatement(QueryManager</span>
								.getST6AgtCurrBal());
<span class="nc" id="L637">						stmt.setString(1, acc_type);</span>
<span class="nc" id="L638">						stmt.setInt(2, agent_id);</span>
<span class="nc" id="L639">						rs = stmt.executeQuery();</span>
<span class="nc" id="L640">						logger.debug(&quot;LH-AGT**&quot; + transaction_type</span>
								+ &quot;**TRX_ID-&quot; + transaction_id + &quot;**R_ID-&quot;
								+ RECEIPT_ID);

<span class="nc bnc" id="L644" title="All 2 branches missed.">						while (rs.next()) {</span>
<span class="nc" id="L645">							agent_bank_acc_current = rs</span>
									.getDouble(&quot;current_balance&quot;);
						}

<span class="nc bnc" id="L649" title="All 2 branches missed.">						if (stmt != null) {</span>
<span class="nc" id="L650">							stmt.close();</span>
						}
<span class="nc bnc" id="L652" title="All 2 branches missed.">						if (rs != null) {</span>
<span class="nc" id="L653">							rs.close();</span>
						}

<span class="nc" id="L656">						agent_bank_acc_current = agent_bank_acc_current</span>
								+ amount;
<span class="nc" id="L658">						bo_bank_acc_current = bo_bank_acc_current - amount;</span>
<span class="nc" id="L659">						logger.debug(&quot;LH-AGT**&quot; + transaction_date + &quot;**AMT-&quot;</span>
								+ amount + &quot;**ACT_TYPE-&quot; + acc_type
								+ &quot;**AGT_BANK_ACC=&quot; + agent_bank_acc_current
								+ &quot;**BO_ACC&quot; + bo_sale_acc_current);
<span class="nc" id="L663">						query2 = QueryManager.getST2InsertAgentLedger();</span>
<span class="nc" id="L664">						upPstmt = connection.prepareStatement(query2);</span>
<span class="nc" id="L665">						upPstmt.setInt(1, agent_id);</span>
<span class="nc" id="L666">						upPstmt.setString(2, &quot;BO_&quot; + transaction_type);</span>
<span class="nc" id="L667">						upPstmt.setLong(3, transaction_id);</span>
<span class="nc" id="L668">						upPstmt.setTimestamp(4, transaction_date);</span>
<span class="nc" id="L669">						upPstmt.setString(5, -amount + &quot;&quot;);</span>
<span class="nc" id="L670">						upPstmt.setString(6, &quot;BO_BANK_ACC&quot;);</span>
<span class="nc" id="L671">						upPstmt.setString(7, bo_bank_acc_current + &quot;&quot;);</span>
<span class="nc" id="L672">						upPstmt.setString(8, &quot;BO&quot;);</span>
<span class="nc" id="L673">						upPstmt.setString(9, RECEIPT_ID);</span>
<span class="nc" id="L674">						upPstmt.execute();</span>

<span class="nc bnc" id="L676" title="All 2 branches missed.">						if (upPstmt != null) {</span>
<span class="nc" id="L677">							upPstmt.close();</span>
						}

<span class="nc" id="L680">						query1 = QueryManager.getST2InsertAgentLedger();</span>
<span class="nc" id="L681">						updatePstmt = connection.prepareStatement(query1);</span>

<span class="nc" id="L683">						updatePstmt.setInt(1, agent_id);</span>
<span class="nc" id="L684">						updatePstmt.setString(2, &quot;BO_&quot; + transaction_type);</span>
<span class="nc" id="L685">						updatePstmt.setLong(3, transaction_id);</span>
<span class="nc" id="L686">						updatePstmt.setTimestamp(4, transaction_date);</span>
<span class="nc" id="L687">						updatePstmt.setString(5, amount + &quot;&quot;);</span>
<span class="nc" id="L688">						updatePstmt.setString(6, acc_type);</span>
<span class="nc" id="L689">						updatePstmt.setString(7, agent_bank_acc_current + &quot;&quot;);</span>
<span class="nc" id="L690">						updatePstmt.setString(8, &quot;BO&quot;);</span>
<span class="nc" id="L691">						updatePstmt.setString(9, RECEIPT_ID);</span>
<span class="nc" id="L692">						updatePstmt.execute();</span>

<span class="nc bnc" id="L694" title="All 2 branches missed.">						if (updatePstmt != null) {</span>
<span class="nc" id="L695">							updatePstmt.close();</span>
						}

<span class="nc" id="L698">						query3 = QueryManager.getST2UpadateAgentCurrentBal();</span>
<span class="nc" id="L699">						updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L700">						updPstmt.setString(1, agent_bank_acc_current + &quot;&quot;);</span>
<span class="nc" id="L701">						updPstmt.setString(2, acc_type);</span>
<span class="nc" id="L702">						updPstmt.setInt(3, agent_id);</span>
<span class="nc" id="L703">						updPstmt.execute();</span>

<span class="nc bnc" id="L705" title="All 2 branches missed.">						if (updPstmt != null) {</span>
<span class="nc" id="L706">							updPstmt.close();</span>
						}

					}

<span class="nc bnc" id="L711" title="All 2 branches missed.">					else if (transaction_type.equalsIgnoreCase(&quot;chq_bounce&quot;)) {</span>
						// This has been changed to prepared statement 10-03-08
<span class="nc" id="L713">						stmt2 = connection.prepareStatement(QueryManager</span>
								.getST2BoChqBounce());
<span class="nc" id="L715">						stmt2.setLong(1, transaction_id);</span>
<span class="nc" id="L716">						rs2 = stmt2.executeQuery();</span>
						// rs2 =
						// stmt2.executeQuery(QueryManager.getST2BoChqBounce()+&quot;&quot;+
						// transaction_id + &quot;&quot;);
<span class="nc bnc" id="L720" title="All 2 branches missed.">						while (rs2.next()) {</span>
<span class="nc" id="L721">							amount = rs2.getDouble(&quot;cheque_amt&quot;);</span>
<span class="nc" id="L722">							transaction_date = rs2</span>
									.getTimestamp(&quot;transaction_date&quot;);
<span class="nc" id="L724">							acc_type = &quot;AGNT_BANK_ACC&quot;;</span>
						}

<span class="nc bnc" id="L727" title="All 2 branches missed.">						if (stmt2 != null) {</span>
<span class="nc" id="L728">							stmt2.close();</span>
						}
<span class="nc bnc" id="L730" title="All 2 branches missed.">						if (rs2 != null) {</span>
<span class="nc" id="L731">							rs2.close();</span>
						}

<span class="nc" id="L734">						stmt = connection.prepareStatement(QueryManager</span>
								.getST6AgtCurrBal());
<span class="nc" id="L736">						stmt.setString(1, acc_type);</span>
<span class="nc" id="L737">						stmt.setInt(2, agent_id);</span>
<span class="nc" id="L738">						rs = stmt.executeQuery();</span>
<span class="nc" id="L739">						logger.debug(&quot;LH-AGT**&quot; + transaction_type</span>
								+ &quot;**TRX_ID-&quot; + transaction_id + &quot;**R_ID-&quot;
								+ RECEIPT_ID);
<span class="nc bnc" id="L742" title="All 2 branches missed.">						while (rs.next()) {</span>
<span class="nc" id="L743">							agent_bank_acc_current = rs</span>
									.getDouble(&quot;current_balance&quot;);
						}

<span class="nc bnc" id="L747" title="All 2 branches missed.">						if (stmt != null) {</span>
<span class="nc" id="L748">							stmt.close();</span>
						}
<span class="nc bnc" id="L750" title="All 2 branches missed.">						if (rs != null) {</span>
<span class="nc" id="L751">							rs.close();</span>
						}

<span class="nc" id="L754">						agent_bank_acc_current = agent_bank_acc_current</span>
								- amount;
<span class="nc" id="L756">						bo_bank_acc_current = bo_bank_acc_current + amount;</span>
<span class="nc" id="L757">						logger.debug(&quot;LH-AGT**&quot; + transaction_date + &quot;**AMT-&quot;</span>
								+ amount + &quot;**ACT_TYPE-&quot; + acc_type
								+ &quot;**AGT_BANK_ACC=&quot; + agent_bank_acc_current
								+ &quot;**BO_ACC&quot; + bo_sale_acc_current);
<span class="nc" id="L761">						query1 = QueryManager.getST2InsertAgentLedger();</span>
<span class="nc" id="L762">						updatePstmt = connection.prepareStatement(query1);</span>

<span class="nc" id="L764">						updatePstmt.setInt(1, agent_id);</span>
<span class="nc" id="L765">						updatePstmt.setString(2, &quot;BO_CH_BOUN&quot;);</span>
<span class="nc" id="L766">						updatePstmt.setLong(3, transaction_id);</span>
<span class="nc" id="L767">						updatePstmt.setTimestamp(4, transaction_date);</span>
<span class="nc" id="L768">						updatePstmt.setString(5, -amount + &quot;&quot;);</span>
<span class="nc" id="L769">						updatePstmt.setString(6, acc_type);</span>
<span class="nc" id="L770">						updatePstmt.setString(7, agent_bank_acc_current + &quot;&quot;);</span>
<span class="nc" id="L771">						updatePstmt.setString(8, &quot;BO&quot;);</span>
<span class="nc" id="L772">						updatePstmt.setString(9, RECEIPT_ID);</span>
<span class="nc" id="L773">						updatePstmt.execute();</span>

<span class="nc bnc" id="L775" title="All 2 branches missed.">						if (updatePstmt != null) {</span>
<span class="nc" id="L776">							updatePstmt.close();</span>
						}

<span class="nc" id="L779">						query2 = QueryManager.getST2InsertAgentLedger();</span>
<span class="nc" id="L780">						upPstmt = connection.prepareStatement(query2);</span>
<span class="nc" id="L781">						upPstmt.setInt(1, agent_id);</span>
<span class="nc" id="L782">						upPstmt.setString(2, &quot;BO_CH_BOUN&quot;);</span>
<span class="nc" id="L783">						upPstmt.setLong(3, transaction_id);</span>
<span class="nc" id="L784">						upPstmt.setTimestamp(4, transaction_date);</span>
<span class="nc" id="L785">						upPstmt.setString(5, amount + &quot;&quot;);</span>
<span class="nc" id="L786">						upPstmt.setString(6, &quot;BO_BANK_ACC&quot;);</span>
<span class="nc" id="L787">						upPstmt.setString(7, bo_bank_acc_current + &quot;&quot;);</span>
<span class="nc" id="L788">						upPstmt.setString(8, &quot;BO&quot;);</span>
<span class="nc" id="L789">						upPstmt.setString(9, RECEIPT_ID);</span>
<span class="nc" id="L790">						upPstmt.execute();</span>

<span class="nc bnc" id="L792" title="All 2 branches missed.">						if (upPstmt != null) {</span>
<span class="nc" id="L793">							upPstmt.close();</span>
						}

<span class="nc" id="L796">						query3 = QueryManager.getST2UpadateAgentCurrentBal();</span>
<span class="nc" id="L797">						updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L798">						updPstmt.setString(1, agent_bank_acc_current + &quot;&quot;);</span>
<span class="nc" id="L799">						updPstmt.setString(2, acc_type);</span>
<span class="nc" id="L800">						updPstmt.setInt(3, agent_id);</span>
<span class="nc" id="L801">						updPstmt.execute();</span>

<span class="nc bnc" id="L803" title="All 2 branches missed.">						if (updPstmt != null) {</span>
<span class="nc" id="L804">							updPstmt.close();</span>
						}

					}

<span class="nc bnc" id="L809" title="All 4 branches missed.">					else if (transaction_type.equalsIgnoreCase(&quot;DR_NOTE_CASH&quot;)</span>
							|| transaction_type.equalsIgnoreCase(&quot;DR_NOTE&quot;)) {
						// This has been changed to prepared statement 10-03-08
<span class="nc" id="L812">						stmt2 = connection.prepareStatement(QueryManager</span>
								.getST6BoDebitNote());
<span class="nc" id="L814">						stmt2.setLong(1, transaction_id);</span>
<span class="nc" id="L815">						rs2 = stmt2.executeQuery();</span>
						// rs2 =
						// stmt2.executeQuery(QueryManager.getST2BoChqBounce()+&quot;&quot;+
						// transaction_id + &quot;&quot;);
<span class="nc bnc" id="L819" title="All 2 branches missed.">						while (rs2.next()) {</span>
<span class="nc" id="L820">							amount = rs2.getDouble(&quot;amount&quot;);</span>
<span class="nc" id="L821">							transaction_date = rs2</span>
									.getTimestamp(&quot;transaction_date&quot;);
<span class="nc" id="L823">							acc_type = &quot;AGNT_BANK_ACC&quot;;</span>
						}

<span class="nc bnc" id="L826" title="All 2 branches missed.">						if (stmt2 != null) {</span>
<span class="nc" id="L827">							stmt2.close();</span>
						}
<span class="nc bnc" id="L829" title="All 2 branches missed.">						if (rs2 != null) {</span>
<span class="nc" id="L830">							rs2.close();</span>
						}
<span class="nc" id="L832">						logger.debug(&quot;LH-AGT**&quot; + transaction_type</span>
								+ &quot;**TRX_ID-&quot; + transaction_id + &quot;**R_ID-&quot;
								+ RECEIPT_ID);
<span class="nc" id="L835">						stmt = connection.prepareStatement(QueryManager</span>
								.getST6AgtCurrBal());
<span class="nc" id="L837">						stmt.setString(1, acc_type);</span>
<span class="nc" id="L838">						stmt.setInt(2, agent_id);</span>
<span class="nc" id="L839">						rs = stmt.executeQuery();</span>
						// This has been changed to prepared statement and moved
						// to query manager 10-03-08
						// rs = stmt.executeQuery(&quot;select current_balance from
						// st_lms_agent_current_balance where account_type = '&quot;+
						// acc_type + &quot;' and agent_id = &quot;+agent_id);
<span class="nc bnc" id="L845" title="All 2 branches missed.">						while (rs.next()) {</span>
<span class="nc" id="L846">							agent_bank_acc_current = rs</span>
									.getDouble(&quot;current_balance&quot;);
						}

<span class="nc bnc" id="L850" title="All 2 branches missed.">						if (stmt != null) {</span>
<span class="nc" id="L851">							stmt.close();</span>
						}
<span class="nc bnc" id="L853" title="All 2 branches missed.">						if (rs != null) {</span>
<span class="nc" id="L854">							rs.close();</span>
						}

<span class="nc" id="L857">						agent_bank_acc_current = agent_bank_acc_current</span>
								- amount;
<span class="nc" id="L859">						bo_bank_acc_current = bo_bank_acc_current + amount;</span>
<span class="nc" id="L860">						logger.debug(&quot;LH-AGT**&quot; + transaction_date + &quot;**AMT-&quot;</span>
								+ amount + &quot;**ACT_TYPE-&quot; + acc_type
								+ &quot;**AGT_BANK_ACC=&quot; + agent_bank_acc_current
								+ &quot;**BO_ACC&quot; + bo_bank_acc_current);
<span class="nc" id="L864">						query1 = QueryManager.getST2InsertAgentLedger();</span>
<span class="nc" id="L865">						updatePstmt = connection.prepareStatement(query1);</span>

<span class="nc" id="L867">						updatePstmt.setInt(1, agent_id);</span>
<span class="nc" id="L868">						updatePstmt.setString(2, &quot;BO_&quot; + transaction_type);</span>
<span class="nc" id="L869">						updatePstmt.setLong(3, transaction_id);</span>
<span class="nc" id="L870">						updatePstmt.setTimestamp(4, transaction_date);</span>
<span class="nc" id="L871">						updatePstmt.setString(5, -amount + &quot;&quot;);</span>
<span class="nc" id="L872">						updatePstmt.setString(6, acc_type);</span>
<span class="nc" id="L873">						updatePstmt.setString(7, agent_bank_acc_current + &quot;&quot;);</span>
<span class="nc" id="L874">						updatePstmt.setString(8, &quot;BO&quot;);</span>
<span class="nc" id="L875">						updatePstmt.setString(9, RECEIPT_ID);</span>
<span class="nc" id="L876">						updatePstmt.execute();</span>

<span class="nc bnc" id="L878" title="All 2 branches missed.">						if (updatePstmt != null) {</span>
<span class="nc" id="L879">							updatePstmt.close();</span>
						}

<span class="nc" id="L882">						query2 = QueryManager.getST2InsertAgentLedger();</span>
<span class="nc" id="L883">						upPstmt = connection.prepareStatement(query2);</span>
<span class="nc" id="L884">						upPstmt.setInt(1, agent_id);</span>
<span class="nc" id="L885">						upPstmt.setString(2, &quot;BO_&quot; + transaction_type);</span>
<span class="nc" id="L886">						upPstmt.setLong(3, transaction_id);</span>
<span class="nc" id="L887">						upPstmt.setTimestamp(4, transaction_date);</span>
<span class="nc" id="L888">						upPstmt.setString(5, amount + &quot;&quot;);</span>
<span class="nc" id="L889">						upPstmt.setString(6, &quot;BO_BANK_ACC&quot;);</span>
<span class="nc" id="L890">						upPstmt.setString(7, bo_bank_acc_current + &quot;&quot;);</span>
<span class="nc" id="L891">						upPstmt.setString(8, &quot;BO&quot;);</span>
<span class="nc" id="L892">						upPstmt.setString(9, RECEIPT_ID);</span>
<span class="nc" id="L893">						upPstmt.execute();</span>

<span class="nc bnc" id="L895" title="All 2 branches missed.">						if (upPstmt != null) {</span>
<span class="nc" id="L896">							upPstmt.close();</span>
						}

<span class="nc" id="L899">						query3 = QueryManager.getST2UpadateAgentCurrentBal();</span>
<span class="nc" id="L900">						updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L901">						updPstmt.setString(1, agent_bank_acc_current + &quot;&quot;);</span>
<span class="nc" id="L902">						updPstmt.setString(2, acc_type);</span>
<span class="nc" id="L903">						updPstmt.setInt(3, agent_id);</span>
<span class="nc" id="L904">						updPstmt.execute();</span>

<span class="nc bnc" id="L906" title="All 2 branches missed.">						if (updPstmt != null) {</span>
<span class="nc" id="L907">							updPstmt.close();</span>
						}

<span class="nc bnc" id="L910" title="All 4 branches missed.">					} else if (transaction_type</span>
							.equalsIgnoreCase(&quot;CR_NOTE_CASH&quot;)
							|| transaction_type.equalsIgnoreCase(&quot;CR_NOTE&quot;)) {
						// This has been changed to prepared statement 10-03-08
<span class="nc" id="L914">						stmt2 = connection.prepareStatement(QueryManager</span>
								.getST6BoCreditNote());
<span class="nc" id="L916">						stmt2.setLong(1, transaction_id);</span>
<span class="nc" id="L917">						rs2 = stmt2.executeQuery();</span>
<span class="nc" id="L918">						logger.debug(&quot;LH-AGT**&quot; + transaction_type</span>
								+ &quot;**TRX_ID-&quot; + transaction_id + &quot;**R_ID-&quot;
								+ RECEIPT_ID);
<span class="nc bnc" id="L921" title="All 2 branches missed.">						while (rs2.next()) {</span>
<span class="nc" id="L922">							amount = rs2.getDouble(&quot;amount&quot;);</span>
<span class="nc" id="L923">							transaction_date = rs2</span>
									.getTimestamp(&quot;transaction_date&quot;);
<span class="nc" id="L925">							acc_type = &quot;AGNT_BANK_ACC&quot;;</span>
						}

<span class="nc bnc" id="L928" title="All 2 branches missed.">						if (stmt2 != null) {</span>
<span class="nc" id="L929">							stmt2.close();</span>
						}
<span class="nc bnc" id="L931" title="All 2 branches missed.">						if (rs2 != null) {</span>
<span class="nc" id="L932">							rs2.close();</span>
						}

<span class="nc" id="L935">						stmt = connection.prepareStatement(QueryManager</span>
								.getST6AgtCurrBal());
<span class="nc" id="L937">						stmt.setString(1, acc_type);</span>
<span class="nc" id="L938">						stmt.setInt(2, agent_id);</span>
<span class="nc" id="L939">						rs = stmt.executeQuery();</span>

<span class="nc bnc" id="L941" title="All 2 branches missed.">						while (rs.next()) {</span>
<span class="nc" id="L942">							agent_bank_acc_current = rs</span>
									.getDouble(&quot;current_balance&quot;);
						}

<span class="nc bnc" id="L946" title="All 2 branches missed.">						if (stmt != null) {</span>
<span class="nc" id="L947">							stmt.close();</span>
						}
<span class="nc bnc" id="L949" title="All 2 branches missed.">						if (rs != null) {</span>
<span class="nc" id="L950">							rs.close();</span>
						}

<span class="nc" id="L953">						agent_bank_acc_current = agent_bank_acc_current</span>
								+ amount;
<span class="nc" id="L955">						bo_bank_acc_current = bo_bank_acc_current - amount;</span>
<span class="nc" id="L956">						logger.debug(&quot;LH-AGT**&quot; + transaction_date + &quot;**AMT-&quot;</span>
								+ amount + &quot;**ACT_TYPE-&quot; + acc_type
								+ &quot;**AGT_ACC&quot; + agent_bank_acc_current
								+ &quot;**BO_ACC&quot; + bo_bank_acc_current);
<span class="nc" id="L960">						query2 = QueryManager.getST2InsertAgentLedger();</span>
<span class="nc" id="L961">						upPstmt = connection.prepareStatement(query2);</span>
<span class="nc" id="L962">						upPstmt.setInt(1, agent_id);</span>
<span class="nc" id="L963">						upPstmt.setString(2, &quot;BO_&quot; + transaction_type);</span>
<span class="nc" id="L964">						upPstmt.setLong(3, transaction_id);</span>
<span class="nc" id="L965">						upPstmt.setTimestamp(4, transaction_date);</span>
<span class="nc" id="L966">						upPstmt.setString(5, -amount + &quot;&quot;);</span>
<span class="nc" id="L967">						upPstmt.setString(6, &quot;BO_BANK_ACC&quot;);</span>
<span class="nc" id="L968">						upPstmt.setString(7, bo_bank_acc_current + &quot;&quot;);</span>
<span class="nc" id="L969">						upPstmt.setString(8, &quot;BO&quot;);</span>
<span class="nc" id="L970">						upPstmt.setString(9, RECEIPT_ID);</span>
<span class="nc" id="L971">						upPstmt.execute();</span>

<span class="nc bnc" id="L973" title="All 2 branches missed.">						if (upPstmt != null) {</span>
<span class="nc" id="L974">							upPstmt.close();</span>
						}

<span class="nc" id="L977">						query1 = QueryManager.getST2InsertAgentLedger();</span>
<span class="nc" id="L978">						updatePstmt = connection.prepareStatement(query1);</span>

<span class="nc" id="L980">						updatePstmt.setInt(1, agent_id);</span>
<span class="nc" id="L981">						updatePstmt.setString(2, &quot;BO_&quot; + transaction_type);</span>
<span class="nc" id="L982">						updatePstmt.setLong(3, transaction_id);</span>
<span class="nc" id="L983">						updatePstmt.setTimestamp(4, transaction_date);</span>
<span class="nc" id="L984">						updatePstmt.setString(5, amount + &quot;&quot;);</span>
<span class="nc" id="L985">						updatePstmt.setString(6, acc_type);</span>
<span class="nc" id="L986">						updatePstmt.setString(7, agent_bank_acc_current + &quot;&quot;);</span>
<span class="nc" id="L987">						updatePstmt.setString(8, &quot;BO&quot;);</span>
<span class="nc" id="L988">						updatePstmt.setString(9, RECEIPT_ID);</span>
<span class="nc" id="L989">						updatePstmt.execute();</span>

<span class="nc bnc" id="L991" title="All 2 branches missed.">						if (updatePstmt != null) {</span>
<span class="nc" id="L992">							updatePstmt.close();</span>
						}

<span class="nc" id="L995">						query3 = QueryManager.getST2UpadateAgentCurrentBal();</span>
<span class="nc" id="L996">						updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L997">						updPstmt.setString(1, agent_bank_acc_current + &quot;&quot;);</span>
<span class="nc" id="L998">						updPstmt.setString(2, acc_type);</span>
<span class="nc" id="L999">						updPstmt.setInt(3, agent_id);</span>
<span class="nc" id="L1000">						updPstmt.execute();</span>

<span class="nc bnc" id="L1002" title="All 2 branches missed.">						if (updPstmt != null) {</span>
<span class="nc" id="L1003">							updPstmt.close();</span>
						}

					}

<span class="nc bnc" id="L1008" title="All 2 branches missed.">					else if (transaction_type.equalsIgnoreCase(&quot;cash&quot;)) {</span>
<span class="nc" id="L1009">						stmt2 = connection.prepareStatement(QueryManager</span>
								.getST2BoCash());
<span class="nc" id="L1011">						stmt2.setLong(1, transaction_id);</span>
<span class="nc" id="L1012">						rs2 = stmt2.executeQuery();</span>
						// rs2 =
						// stmt2.executeQuery(QueryManager.getST2BoCash()+&quot;&quot;+
						// transaction_id + &quot;&quot;);
<span class="nc bnc" id="L1016" title="All 2 branches missed.">						while (rs2.next()) {</span>
<span class="nc" id="L1017">							amount = rs2.getDouble(&quot;amount&quot;);</span>
<span class="nc" id="L1018">							transaction_date = rs2</span>
									.getTimestamp(&quot;transaction_date&quot;);
<span class="nc" id="L1020">							acc_type = &quot;AGNT_BANK_ACC&quot;;</span>
						}

<span class="nc bnc" id="L1023" title="All 2 branches missed.">						if (stmt2 != null) {</span>
<span class="nc" id="L1024">							stmt2.close();</span>
						}
<span class="nc bnc" id="L1026" title="All 2 branches missed.">						if (rs2 != null) {</span>
<span class="nc" id="L1027">							rs2.close();</span>
						}
<span class="nc" id="L1029">						logger.debug(&quot;LH-AGT**&quot; + transaction_type</span>
								+ &quot;**TRX_ID-&quot; + transaction_id + &quot;**R_ID-&quot;
								+ RECEIPT_ID);
<span class="nc" id="L1032">						stmt = connection.prepareStatement(QueryManager</span>
								.getST6AgtCurrBal());
<span class="nc" id="L1034">						stmt.setString(1, acc_type);</span>
<span class="nc" id="L1035">						stmt.setInt(2, agent_id);</span>
<span class="nc" id="L1036">						rs = stmt.executeQuery();</span>
						// This has been changed to prepared statement and moved
						// to query manager 10-03-08
						// rs = stmt.executeQuery(&quot;select current_balance from
						// st_lms_agent_current_balance where account_type = '&quot;+
						// acc_type + &quot;' and agent_id = &quot;+agent_id);
<span class="nc bnc" id="L1042" title="All 2 branches missed.">						while (rs.next()) {</span>
<span class="nc" id="L1043">							agent_bank_acc_current = rs</span>
									.getDouble(&quot;current_balance&quot;);
						}

<span class="nc bnc" id="L1047" title="All 2 branches missed.">						if (stmt != null) {</span>
<span class="nc" id="L1048">							stmt.close();</span>
						}
<span class="nc bnc" id="L1050" title="All 2 branches missed.">						if (rs != null) {</span>
<span class="nc" id="L1051">							rs.close();</span>
						}

<span class="nc" id="L1054">						agent_bank_acc_current = agent_bank_acc_current</span>
								+ amount;
<span class="nc" id="L1056">						bo_bank_acc_current = bo_bank_acc_current - amount;</span>
<span class="nc" id="L1057">						logger.debug(&quot;LH-AGT**&quot; + transaction_date + &quot;**AMT-&quot;</span>
								+ amount + &quot;**ACT_TYPE-&quot; + acc_type
								+ &quot;**AGT_ACC-&quot; + agent_bank_acc_current
								+ &quot;**BO_ACC-&quot; + bo_bank_acc_current);
<span class="nc" id="L1061">						query2 = QueryManager.getST2InsertAgentLedger();</span>
<span class="nc" id="L1062">						upPstmt = connection.prepareStatement(query2);</span>
<span class="nc" id="L1063">						upPstmt.setInt(1, agent_id);</span>
<span class="nc" id="L1064">						upPstmt.setString(2, &quot;BO_&quot; + transaction_type);</span>
<span class="nc" id="L1065">						upPstmt.setLong(3, transaction_id);</span>
<span class="nc" id="L1066">						upPstmt.setTimestamp(4, transaction_date);</span>
<span class="nc" id="L1067">						upPstmt.setString(5, -amount + &quot;&quot;);</span>
<span class="nc" id="L1068">						upPstmt.setString(6, &quot;BO_BANK_ACC&quot;);</span>
<span class="nc" id="L1069">						upPstmt.setString(7, bo_bank_acc_current + &quot;&quot;);</span>
<span class="nc" id="L1070">						upPstmt.setString(8, &quot;BO&quot;);</span>
<span class="nc" id="L1071">						upPstmt.setString(9, RECEIPT_ID);</span>
<span class="nc" id="L1072">						upPstmt.execute();</span>

<span class="nc bnc" id="L1074" title="All 2 branches missed.">						if (upPstmt != null) {</span>
<span class="nc" id="L1075">							upPstmt.close();</span>
						}

<span class="nc" id="L1078">						query1 = QueryManager.getST2InsertAgentLedger();</span>
<span class="nc" id="L1079">						updatePstmt = connection.prepareStatement(query1);</span>

<span class="nc" id="L1081">						updatePstmt.setInt(1, agent_id);</span>
<span class="nc" id="L1082">						updatePstmt.setString(2, &quot;BO_&quot; + transaction_type);</span>
<span class="nc" id="L1083">						updatePstmt.setLong(3, transaction_id);</span>
<span class="nc" id="L1084">						updatePstmt.setTimestamp(4, transaction_date);</span>
<span class="nc" id="L1085">						updatePstmt.setString(5, amount + &quot;&quot;);</span>
<span class="nc" id="L1086">						updatePstmt.setString(6, acc_type);</span>
<span class="nc" id="L1087">						updatePstmt.setString(7, agent_bank_acc_current + &quot;&quot;);</span>
<span class="nc" id="L1088">						updatePstmt.setString(8, &quot;BO&quot;);</span>
<span class="nc" id="L1089">						updatePstmt.setString(9, RECEIPT_ID);</span>
<span class="nc" id="L1090">						updatePstmt.execute();</span>

<span class="nc bnc" id="L1092" title="All 2 branches missed.">						if (updatePstmt != null) {</span>
<span class="nc" id="L1093">							updatePstmt.close();</span>
						}

<span class="nc" id="L1096">						query3 = QueryManager.getST2UpadateAgentCurrentBal();</span>
<span class="nc" id="L1097">						updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L1098">						updPstmt.setString(1, agent_bank_acc_current + &quot;&quot;);</span>
<span class="nc" id="L1099">						updPstmt.setString(2, acc_type);</span>
<span class="nc" id="L1100">						updPstmt.setInt(3, agent_id);</span>
<span class="nc" id="L1101">						updPstmt.execute();</span>

<span class="nc bnc" id="L1103" title="All 2 branches missed.">						if (updPstmt != null) {</span>
<span class="nc" id="L1104">							updPstmt.close();</span>
						}

					}
<span class="nc bnc" id="L1108" title="All 2 branches missed.">					else if (transaction_type.equalsIgnoreCase(&quot;OLA_COMMISSION&quot;)) {</span>
<span class="nc" id="L1109">						stmt2 = connection.prepareStatement(QueryManager</span>
								.getST2BoOlaCommission());
<span class="nc" id="L1111">						stmt2.setLong(1, transaction_id);</span>
<span class="nc" id="L1112">						rs2 = stmt2.executeQuery();</span>
						// rs2 =
						// stmt2.executeQuery(QueryManager.getST2BoCash()+&quot;&quot;+
						// transaction_id + &quot;&quot;);
<span class="nc bnc" id="L1116" title="All 2 branches missed.">						while (rs2.next()) {</span>
<span class="nc" id="L1117">							amount = rs2.getDouble(&quot;amount&quot;);</span>
<span class="nc" id="L1118">							transaction_date = rs2</span>
									.getTimestamp(&quot;transaction_date&quot;);
<span class="nc" id="L1120">							acc_type = &quot;AGNT_BANK_ACC&quot;;</span>
						}

<span class="nc bnc" id="L1123" title="All 2 branches missed.">						if (stmt2 != null) {</span>
<span class="nc" id="L1124">							stmt2.close();</span>
						}
<span class="nc bnc" id="L1126" title="All 2 branches missed.">						if (rs2 != null) {</span>
<span class="nc" id="L1127">							rs2.close();</span>
						}
<span class="nc" id="L1129">						logger.debug(&quot;LH-AGT**&quot; + transaction_type</span>
								+ &quot;**TRX_ID-&quot; + transaction_id + &quot;**R_ID-&quot;
								+ RECEIPT_ID);
<span class="nc" id="L1132">						stmt = connection.prepareStatement(QueryManager</span>
								.getST6AgtCurrBal());
<span class="nc" id="L1134">						stmt.setString(1, acc_type);</span>
<span class="nc" id="L1135">						stmt.setInt(2, agent_id);</span>
<span class="nc" id="L1136">						rs = stmt.executeQuery();</span>
						// This has been changed to prepared statement and moved
						// to query manager 10-03-08
						// rs = stmt.executeQuery(&quot;select current_balance from
						// st_lms_agent_current_balance where account_type = '&quot;+
						// acc_type + &quot;' and agent_id = &quot;+agent_id);
<span class="nc bnc" id="L1142" title="All 2 branches missed.">						while (rs.next()) {</span>
<span class="nc" id="L1143">							agent_bank_acc_current = rs</span>
									.getDouble(&quot;current_balance&quot;);
						}

<span class="nc bnc" id="L1147" title="All 2 branches missed.">						if (stmt != null) {</span>
<span class="nc" id="L1148">							stmt.close();</span>
						}
<span class="nc bnc" id="L1150" title="All 2 branches missed.">						if (rs != null) {</span>
<span class="nc" id="L1151">							rs.close();</span>
						}

<span class="nc" id="L1154">						agent_bank_acc_current = agent_bank_acc_current</span>
								+ amount;
<span class="nc" id="L1156">						bo_bank_acc_current = bo_bank_acc_current - amount;</span>
<span class="nc" id="L1157">						logger.debug(&quot;LH-AGT**&quot; + transaction_date + &quot;**AMT-&quot;</span>
								+ amount + &quot;**ACT_TYPE-&quot; + acc_type
								+ &quot;**AGT_ACC-&quot; + agent_bank_acc_current
								+ &quot;**BO_ACC-&quot; + bo_bank_acc_current);
<span class="nc" id="L1161">						query2 = QueryManager.getST2InsertAgentLedger();</span>
<span class="nc" id="L1162">						upPstmt = connection.prepareStatement(query2);</span>
<span class="nc" id="L1163">						upPstmt.setInt(1, agent_id);</span>
<span class="nc" id="L1164">						upPstmt.setString(2, &quot;BO_&quot; + transaction_type);</span>
<span class="nc" id="L1165">						upPstmt.setLong(3, transaction_id);</span>
<span class="nc" id="L1166">						upPstmt.setTimestamp(4, transaction_date);</span>
<span class="nc" id="L1167">						upPstmt.setString(5, -amount + &quot;&quot;);</span>
<span class="nc" id="L1168">						upPstmt.setString(6, &quot;BO_BANK_ACC&quot;);</span>
<span class="nc" id="L1169">						upPstmt.setString(7, bo_bank_acc_current + &quot;&quot;);</span>
<span class="nc" id="L1170">						upPstmt.setString(8, &quot;BO&quot;);</span>
<span class="nc" id="L1171">						upPstmt.setString(9, RECEIPT_ID);</span>
<span class="nc" id="L1172">						upPstmt.execute();</span>

<span class="nc bnc" id="L1174" title="All 2 branches missed.">						if (upPstmt != null) {</span>
<span class="nc" id="L1175">							upPstmt.close();</span>
						}

<span class="nc" id="L1178">						query1 = QueryManager.getST2InsertAgentLedger();</span>
<span class="nc" id="L1179">						updatePstmt = connection.prepareStatement(query1);</span>

<span class="nc" id="L1181">						updatePstmt.setInt(1, agent_id);</span>
<span class="nc" id="L1182">						updatePstmt.setString(2, &quot;BO_&quot; + transaction_type);</span>
<span class="nc" id="L1183">						updatePstmt.setLong(3, transaction_id);</span>
<span class="nc" id="L1184">						updatePstmt.setTimestamp(4, transaction_date);</span>
<span class="nc" id="L1185">						updatePstmt.setString(5, amount + &quot;&quot;);</span>
<span class="nc" id="L1186">						updatePstmt.setString(6, acc_type);</span>
<span class="nc" id="L1187">						updatePstmt.setString(7, agent_bank_acc_current + &quot;&quot;);</span>
<span class="nc" id="L1188">						updatePstmt.setString(8, &quot;BO&quot;);</span>
<span class="nc" id="L1189">						updatePstmt.setString(9, RECEIPT_ID);</span>
<span class="nc" id="L1190">						updatePstmt.execute();</span>

<span class="nc bnc" id="L1192" title="All 2 branches missed.">						if (updatePstmt != null) {</span>
<span class="nc" id="L1193">							updatePstmt.close();</span>
						}

<span class="nc" id="L1196">						query3 = QueryManager.getST2UpadateAgentCurrentBal();</span>
<span class="nc" id="L1197">						updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L1198">						updPstmt.setString(1, agent_bank_acc_current + &quot;&quot;);</span>
<span class="nc" id="L1199">						updPstmt.setString(2, acc_type);</span>
<span class="nc" id="L1200">						updPstmt.setInt(3, agent_id);</span>
<span class="nc" id="L1201">						updPstmt.execute();</span>

<span class="nc bnc" id="L1203" title="All 2 branches missed.">						if (updPstmt != null) {</span>
<span class="nc" id="L1204">							updPstmt.close();</span>
						}

					}
<span class="nc bnc" id="L1208" title="All 10 branches missed.">					else if (transaction_type.equalsIgnoreCase(&quot;pwt&quot;)</span>
							|| transaction_type.equalsIgnoreCase(&quot;pwt_auto&quot;)
							|| transaction_type.equalsIgnoreCase(&quot;DG_PWT&quot;)
							|| transaction_type.equalsIgnoreCase(&quot;DG_PWT_AUTO&quot;) || transaction_type.equalsIgnoreCase(&quot;OLA_WITHDRAWL&quot;)) {
<span class="nc" id="L1212">						int result = 0;</span>
<span class="nc" id="L1213">						String pwtQuery = &quot;&quot;;</span>
						// This has been changed to prepared statement 10-03-08
<span class="nc bnc" id="L1215" title="All 4 branches missed.">						if (transaction_type.equalsIgnoreCase(&quot;DG_PWT&quot;)</span>
								|| transaction_type
										.equalsIgnoreCase(&quot;DG_PWT_AUTO&quot;)) {
<span class="nc" id="L1218">							pwtQuery = QueryManager.getST2BoDrGmPwtPay();</span>
<span class="nc bnc" id="L1219" title="All 2 branches missed.">						}else if(transaction_type.equalsIgnoreCase(&quot;OLA_WITHDRAWL&quot;))</span>
						{
<span class="nc" id="L1221">							pwtQuery = QueryManager.getST2BoOlaWithdrawl();</span>
						}
						else {
<span class="nc" id="L1224">							pwtQuery = QueryManager.getST2BoPwtPay();</span>
						}
<span class="nc" id="L1226">						stmt2 = connection.prepareStatement(pwtQuery);</span>
<span class="nc" id="L1227">						stmt2.setLong(1, transaction_id);</span>
<span class="nc" id="L1228">						rs2 = stmt2.executeQuery();</span>
<span class="nc" id="L1229">						logger.debug(&quot;LH-AGT**&quot; + transaction_type</span>
								+ &quot;**TRX_ID-&quot; + transaction_id + &quot;**R_ID-&quot;
								+ RECEIPT_ID);
<span class="nc bnc" id="L1232" title="All 2 branches missed.">						while (rs2.next()) {</span>
<span class="nc" id="L1233">							amount = rs2.getDouble(&quot;pwt_amount&quot;);</span>
<span class="nc" id="L1234">							pwt_charges_amount = rs2.getDouble(&quot;comm_amount&quot;);</span>
<span class="nc" id="L1235">							transaction_date = rs2</span>
									.getTimestamp(&quot;transaction_date&quot;);
<span class="nc" id="L1237">							acc_type = &quot;AGNT_PWT_RCV&quot;;</span>
<span class="nc" id="L1238">							acc_type_charges = &quot;AGNT_PWT_CHARGES_RCV&quot;;</span>
<span class="nc" id="L1239">							result++;</span>
						}

<span class="nc bnc" id="L1242" title="All 2 branches missed.">						if (stmt2 != null) {</span>
<span class="nc" id="L1243">							stmt2.close();</span>
						}
<span class="nc bnc" id="L1245" title="All 2 branches missed.">						if (rs2 != null) {</span>
<span class="nc" id="L1246">							rs2.close();</span>
						}

<span class="nc bnc" id="L1249" title="All 2 branches missed.">						if (result != 0) {</span>
<span class="nc bnc" id="L1250" title="All 2 branches missed.">							if (acc_type.equals(&quot;AGNT_PWT_RCV&quot;)) {</span>

<span class="nc" id="L1252">								stmt = connection.prepareStatement(QueryManager</span>
										.getST6AgtCurrBal());
<span class="nc" id="L1254">								stmt.setString(1, acc_type);</span>
<span class="nc" id="L1255">								stmt.setInt(2, agent_id);</span>
<span class="nc" id="L1256">								rs = stmt.executeQuery();</span>

<span class="nc bnc" id="L1258" title="All 2 branches missed.">								while (rs.next()) {</span>
<span class="nc" id="L1259">									agnt_pwt_rcv_current = rs</span>
											.getDouble(&quot;current_balance&quot;);
								}

<span class="nc bnc" id="L1263" title="All 2 branches missed.">								if (stmt != null) {</span>
<span class="nc" id="L1264">									stmt.close();</span>
								}
<span class="nc bnc" id="L1266" title="All 2 branches missed.">								if (rs != null) {</span>
<span class="nc" id="L1267">									rs.close();</span>
								}

<span class="nc" id="L1270">								agnt_pwt_rcv_current = agnt_pwt_rcv_current</span>
										+ amount;
<span class="nc" id="L1272">								bo_pwt_pay_current = bo_pwt_pay_current</span>
										- amount;
<span class="nc" id="L1274">								logger.debug(&quot;LH-AGT**&quot; + transaction_date</span>
										+ &quot;**AMT-&quot; + amount + &quot;**ACT_TYPE-&quot;
										+ acc_type + &quot;**AGT_PWT_RCV_ACC-&quot;
										+ agnt_pwt_rcv_current
										+ &quot;**BO_PWT_PAY_ACC-&quot;
										+ bo_pwt_pay_current);

<span class="nc" id="L1281">								query2 = QueryManager.getST2InsertAgentLedger();</span>
<span class="nc" id="L1282">								upPstmt = connection.prepareStatement(query2);</span>
<span class="nc" id="L1283">								upPstmt.setInt(1, agent_id);</span>
<span class="nc" id="L1284">								upPstmt.setString(2, &quot;BO_&quot; + transaction_type);</span>
<span class="nc" id="L1285">								upPstmt.setLong(3, transaction_id);</span>
<span class="nc" id="L1286">								upPstmt.setTimestamp(4, transaction_date);</span>
<span class="nc" id="L1287">								upPstmt.setString(5, -amount + &quot;&quot;);</span>
<span class="nc" id="L1288">								upPstmt.setString(6, &quot;BO_PWT_PAY&quot;);</span>
<span class="nc" id="L1289">								upPstmt.setString(7, bo_pwt_pay_current + &quot;&quot;);</span>
<span class="nc" id="L1290">								upPstmt.setString(8, &quot;BO&quot;);</span>
<span class="nc" id="L1291">								upPstmt.setString(9, RECEIPT_ID);</span>
<span class="nc" id="L1292">								upPstmt.execute();</span>

<span class="nc bnc" id="L1294" title="All 2 branches missed.">								if (upPstmt != null) {</span>
<span class="nc" id="L1295">									upPstmt.close();</span>
								}

<span class="nc" id="L1298">								query1 = QueryManager.getST2InsertAgentLedger();</span>
<span class="nc" id="L1299">								updatePstmt = connection</span>
										.prepareStatement(query1);

<span class="nc" id="L1302">								updatePstmt.setInt(1, agent_id);</span>
<span class="nc" id="L1303">								updatePstmt.setString(2, &quot;BO_&quot;</span>
										+ transaction_type);
<span class="nc" id="L1305">								updatePstmt.setLong(3, transaction_id);</span>
<span class="nc" id="L1306">								updatePstmt.setTimestamp(4, transaction_date);</span>
<span class="nc" id="L1307">								updatePstmt.setString(5, amount + &quot;&quot;);</span>
<span class="nc" id="L1308">								updatePstmt.setString(6, acc_type);</span>
<span class="nc" id="L1309">								updatePstmt.setString(7, agnt_pwt_rcv_current</span>
										+ &quot;&quot;);
<span class="nc" id="L1311">								updatePstmt.setString(8, &quot;BO&quot;);</span>
<span class="nc" id="L1312">								updatePstmt.setString(9, RECEIPT_ID);</span>
<span class="nc" id="L1313">								updatePstmt.execute();</span>

<span class="nc bnc" id="L1315" title="All 2 branches missed.">								if (updatePstmt != null) {</span>
<span class="nc" id="L1316">									updatePstmt.close();</span>
								}

<span class="nc" id="L1319">								query3 = QueryManager</span>
										.getST2UpadateAgentCurrentBal();
<span class="nc" id="L1321">								updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L1322">								updPstmt</span>
										.setString(1, agnt_pwt_rcv_current + &quot;&quot;);
<span class="nc" id="L1324">								updPstmt.setString(2, acc_type);</span>
<span class="nc" id="L1325">								updPstmt.setInt(3, agent_id);</span>
<span class="nc" id="L1326">								updPstmt.execute();</span>

<span class="nc bnc" id="L1328" title="All 2 branches missed.">								if (updPstmt != null) {</span>
<span class="nc" id="L1329">									updPstmt.close();</span>
								}

							}/*
								 * for charges collection
								 */
<span class="nc bnc" id="L1335" title="All 2 branches missed.">							if (acc_type_charges.equals(&quot;AGNT_PWT_CHARGES_RCV&quot;)) {</span>

<span class="nc" id="L1337">								stmt = connection.prepareStatement(QueryManager</span>
										.getST6AgtCurrBal());
<span class="nc" id="L1339">								stmt.setString(1, acc_type_charges);</span>
<span class="nc" id="L1340">								stmt.setInt(2, agent_id);</span>
<span class="nc" id="L1341">								rs = stmt.executeQuery();</span>
								// This has been changed to prepared statement
								// and moved to query manager 10-03-08
								// rs = stmt.executeQuery(&quot;select
								// current_balance from
								// st_lms_agent_current_balance where
								// account_type = '&quot;+ acc_type + &quot;' and agent_id
								// = &quot;+agent_id);
<span class="nc bnc" id="L1349" title="All 2 branches missed.">								while (rs.next()) {</span>
<span class="nc" id="L1350">									agent_pwt_charges_rcv_current = rs</span>
											.getDouble(&quot;current_balance&quot;);
								}

<span class="nc bnc" id="L1354" title="All 2 branches missed.">								if (stmt != null) {</span>
<span class="nc" id="L1355">									stmt.close();</span>
								}
<span class="nc bnc" id="L1357" title="All 2 branches missed.">								if (rs != null) {</span>
<span class="nc" id="L1358">									rs.close();</span>
								}

<span class="nc" id="L1361">								agent_pwt_charges_rcv_current = agent_pwt_charges_rcv_current</span>
										+ pwt_charges_amount;
<span class="nc" id="L1363">								bo_pwt_charges_current = bo_pwt_charges_current</span>
										- pwt_charges_amount;

<span class="nc bnc" id="L1366" title="All 2 branches missed.">								if (pwt_charges_amount != 0.0) {</span>
<span class="nc" id="L1367">									query2 = QueryManager</span>
											.getST2InsertAgentLedger();
<span class="nc" id="L1369">									upPstmt = connection</span>
											.prepareStatement(query2);
<span class="nc" id="L1371">									upPstmt.setInt(1, agent_id);</span>
<span class="nc" id="L1372">									upPstmt.setString(2, &quot;BO_&quot;</span>
											+ transaction_type);
<span class="nc" id="L1374">									upPstmt.setLong(3, transaction_id);</span>
<span class="nc" id="L1375">									upPstmt.setTimestamp(4, transaction_date);</span>
<span class="nc" id="L1376">									upPstmt.setString(5, -pwt_charges_amount</span>
											+ &quot;&quot;);
<span class="nc" id="L1378">									upPstmt.setString(6, &quot;BO_PWT_CHARGES&quot;);</span>
<span class="nc" id="L1379">									upPstmt.setString(7, bo_pwt_charges_current</span>
											+ &quot;&quot;);
<span class="nc" id="L1381">									upPstmt.setString(8, &quot;BO&quot;);</span>
<span class="nc" id="L1382">									upPstmt.setString(9, RECEIPT_ID);</span>
<span class="nc" id="L1383">									upPstmt.execute();</span>

<span class="nc bnc" id="L1385" title="All 2 branches missed.">									if (upPstmt != null) {</span>
<span class="nc" id="L1386">										upPstmt.close();</span>
									}

<span class="nc" id="L1389">									query1 = QueryManager</span>
											.getST2InsertAgentLedger();
<span class="nc" id="L1391">									updatePstmt = connection</span>
											.prepareStatement(query1);

<span class="nc" id="L1394">									updatePstmt.setInt(1, agent_id);</span>
<span class="nc" id="L1395">									updatePstmt.setString(2, &quot;BO_&quot;</span>
											+ transaction_type);
<span class="nc" id="L1397">									updatePstmt.setLong(3, transaction_id);</span>
<span class="nc" id="L1398">									updatePstmt.setTimestamp(4,</span>
											transaction_date);
<span class="nc" id="L1400">									updatePstmt.setString(5, pwt_charges_amount</span>
											+ &quot;&quot;);
<span class="nc" id="L1402">									updatePstmt.setString(6, acc_type_charges);</span>
<span class="nc" id="L1403">									updatePstmt.setString(7,</span>
											agent_pwt_charges_rcv_current + &quot;&quot;);
<span class="nc" id="L1405">									updatePstmt.setString(8, &quot;BO&quot;);</span>
<span class="nc" id="L1406">									updatePstmt.setString(9, RECEIPT_ID);</span>
<span class="nc" id="L1407">									updatePstmt.execute();</span>

<span class="nc bnc" id="L1409" title="All 2 branches missed.">									if (updatePstmt != null) {</span>
<span class="nc" id="L1410">										updatePstmt.close();</span>
									}

								}

<span class="nc" id="L1415">								query3 = QueryManager</span>
										.getST2UpadateAgentCurrentBal();
<span class="nc" id="L1417">								updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L1418">								updPstmt.setString(1,</span>
										agent_pwt_charges_rcv_current + &quot;&quot;);
<span class="nc" id="L1420">								updPstmt.setString(2, acc_type_charges);</span>
<span class="nc" id="L1421">								updPstmt.setInt(3, agent_id);</span>
<span class="nc" id="L1422">								updPstmt.execute();</span>

<span class="nc bnc" id="L1424" title="All 2 branches missed.">								if (updPstmt != null) {</span>
<span class="nc" id="L1425">									updPstmt.close();</span>
								}

							}
						} else {
<span class="nc" id="L1430">							System.out.println(&quot;Error in Transaction&quot;</span>
									+ transaction_id + &quot; and Transaction_type &quot;
									+ transaction_type);
						}
					}

<span class="nc" id="L1436">				}</span>

<span class="nc bnc" id="L1438" title="All 2 branches missed.">				if (stmt1 != null) {</span>
<span class="nc" id="L1439">					stmt1.close();</span>
				}
<span class="nc bnc" id="L1441" title="All 2 branches missed.">				if (rs1 != null) {</span>
<span class="nc" id="L1442">					rs1.close();</span>
				}

				// ///////////////////////////////////////////Agent Retailer
				// Transaction
				// Start////////////////////////////////////////////////////////////////////
<span class="nc" id="L1448">				String rcptQryAgt = &quot;select sar.receipt_id,sar.generated_id from st_lms_agent_receipts_trn_mapping sartm , st_lms_agent_receipts sar where transaction_id=? and sartm.receipt_id=sar.receipt_id&quot;;</span>

<span class="nc" id="L1450">				stmt1 = connection.prepareStatement(QueryManager</span>
						.getST6AgtTransaction());
<span class="nc" id="L1452">				stmt1.setTimestamp(1, present_date);</span>
<span class="nc" id="L1453">				stmt1.setTimestamp(2, to_Date);</span>
<span class="nc" id="L1454">				stmt1.setInt(3, agent_id);</span>
<span class="nc" id="L1455">				rs1 = stmt1.executeQuery();</span>
<span class="nc" id="L1456">				logger.debug(&quot;LH-AGT-RET**PresentDate-&quot; + present_date</span>
						+ &quot;**ToDate-&quot; + toDate_Bean);
<span class="nc bnc" id="L1458" title="All 2 branches missed.">				while (rs1.next()) {</span>

<span class="nc" id="L1460">					long transaction_id = rs1.getLong(&quot;transaction_id&quot;);</span>
<span class="nc" id="L1461">					String transaction_type = rs1.getString(&quot;transaction_type&quot;);</span>
<span class="nc" id="L1462">					String RECEIPT_ID = &quot;N.A.&quot;;</span>

<span class="nc" id="L1464">					rcptPS = connection.prepareStatement(rcptQryAgt);</span>
<span class="nc" id="L1465">					rcptPS.setLong(1, transaction_id);</span>
<span class="nc" id="L1466">					rcptRS = rcptPS.executeQuery();</span>

<span class="nc bnc" id="L1468" title="All 2 branches missed.">					while (rcptRS.next()) {</span>
<span class="nc" id="L1469">						genNum = rcptRS.getString(&quot;generated_id&quot;);</span>
<span class="nc bnc" id="L1470" title="All 8 branches missed.">						if (genNum != null</span>
								&amp;&amp; !genNum.trim().equals(&quot;&quot;)
								&amp;&amp; !(genNum.contains(&quot;DLA&quot;) || genNum
										.contains(&quot;DSA&quot;))) {
<span class="nc" id="L1474">							RECEIPT_ID = rcptRS.getString(&quot;generated_id&quot;);</span>
						}

					}

<span class="nc bnc" id="L1479" title="All 2 branches missed.">					if (rcptPS != null) {</span>
<span class="nc" id="L1480">						rcptPS.close();</span>
					}
<span class="nc bnc" id="L1482" title="All 2 branches missed.">					if (rcptRS != null) {</span>
<span class="nc" id="L1483">						rcptRS.close();</span>
					}

<span class="nc" id="L1486">					double amount = 0;</span>
<span class="nc" id="L1487">					double pwt_charges_amount = 0;</span>
					// java.sql.Date transaction_date = null;
<span class="nc" id="L1489">					Timestamp transaction_date = null;</span>
					// java.sql.Date TRANS_DATE = null;
<span class="nc" id="L1491">					String acc_type = &quot;&quot;;</span>
<span class="nc bnc" id="L1492" title="All 8 branches missed.">					if (transaction_type.equalsIgnoreCase(&quot;Sale&quot;)</span>
							|| transaction_type.equalsIgnoreCase(&quot;DG_SALE&quot;)
							|| transaction_type.equalsIgnoreCase(&quot;CS_SALE&quot;) || transaction_type.equalsIgnoreCase(&quot;OLA_DEPOSIT&quot;)) {
<span class="nc" id="L1495">						String saleQuery = &quot;&quot;;</span>
<span class="nc bnc" id="L1496" title="All 2 branches missed.">						if (transaction_type.equalsIgnoreCase(&quot;Sale&quot;)) {</span>
<span class="nc" id="L1497">							saleQuery = QueryManager.getST2AgentSale();</span>
<span class="nc bnc" id="L1498" title="All 2 branches missed.">						} else if (transaction_type.equalsIgnoreCase(&quot;DG_SALE&quot;)) {</span>
<span class="nc" id="L1499">							saleQuery = QueryManager.getST2AgentDrGmSale();</span>
<span class="nc bnc" id="L1500" title="All 2 branches missed.">						} else if (transaction_type.equalsIgnoreCase(&quot;CS_SALE&quot;)) {</span>
<span class="nc" id="L1501">							saleQuery = QueryManager.getST2AgentCSSale();</span>
<span class="nc bnc" id="L1502" title="All 2 branches missed.">						} else if (transaction_type.equalsIgnoreCase(&quot;OLA_DEPOSIT&quot;))</span>
						{
<span class="nc" id="L1504">							saleQuery = QueryManager.getST2AgentOLADeposit();</span>
						}
<span class="nc" id="L1506">						stmt2 = connection.prepareStatement(saleQuery);</span>
<span class="nc" id="L1507">						stmt2.setLong(1, transaction_id);</span>
<span class="nc" id="L1508">						rs2 = stmt2.executeQuery();</span>
						// This has been moved to query manager 10-03-08 and
						// statement has been changed in to Prepared statement
						// 10-03-08
						// rs2 =
						// stmt2.executeQuery(QueryManager.getST2AgentSale()+&quot;&quot;+
						// transaction_id + &quot;&quot;);
<span class="nc bnc" id="L1515" title="All 2 branches missed.">						while (rs2.next()) {</span>
<span class="nc" id="L1516">							amount = rs2.getDouble(&quot;net_amt&quot;);</span>
<span class="nc" id="L1517">							transaction_date = rs2</span>
									.getTimestamp(&quot;transaction_date&quot;);
<span class="nc" id="L1519">							acc_type = &quot;&quot; + rs2.getInt(&quot;retailer_org_id&quot;);</span>
<span class="nc" id="L1520">							orgName = rs2.getString(&quot;name&quot;);</span>
						}

<span class="nc bnc" id="L1523" title="All 2 branches missed.">						if (stmt2 != null) {</span>
<span class="nc" id="L1524">							stmt2.close();</span>
						}
<span class="nc bnc" id="L1526" title="All 2 branches missed.">						if (rs2 != null) {</span>
<span class="nc" id="L1527">							rs2.close();</span>
						}

<span class="nc" id="L1530">						stmt = connection.prepareStatement(QueryManager</span>
								.getST6AgtCurrBal());
<span class="nc" id="L1532">						stmt.setString(1, acc_type);</span>
<span class="nc" id="L1533">						stmt.setInt(2, agent_id);</span>
<span class="nc" id="L1534">						rs = stmt.executeQuery();</span>
<span class="nc" id="L1535">						logger.debug(&quot;LH-AGT-RET**&quot; + transaction_type</span>
								+ &quot;**TRX_ID-&quot; + transaction_id + &quot;**R_ID-&quot;
								+ RECEIPT_ID);
<span class="nc bnc" id="L1538" title="All 2 branches missed.">						while (rs.next()) {</span>
<span class="nc" id="L1539">							retailer_org_id_current = rs</span>
									.getDouble(&quot;current_balance&quot;);

<span class="nc" id="L1542">							retailerPresent++;</span>
						}

<span class="nc bnc" id="L1545" title="All 2 branches missed.">						if (stmt != null) {</span>
<span class="nc" id="L1546">							stmt.close();</span>
						}
<span class="nc bnc" id="L1548" title="All 2 branches missed.">						if (rs != null) {</span>
<span class="nc" id="L1549">							rs.close();</span>
						}

<span class="nc bnc" id="L1552" title="All 2 branches missed.">						if (retailerPresent == 0) {</span>

<span class="nc" id="L1554">							stmt = connection.prepareStatement(QueryManager</span>
									.getST6InsertAgentCurrBal());
<span class="nc" id="L1556">							stmt.setString(1, acc_type);</span>
<span class="nc" id="L1557">							stmt.setDouble(2, 0.0);</span>
<span class="nc" id="L1558">							stmt.setInt(3, agent_id);</span>
<span class="nc" id="L1559">							stmt.execute();</span>
<span class="nc" id="L1560">							retailer_org_id_current = 0.0;</span>

<span class="nc bnc" id="L1562" title="All 2 branches missed.">							if (stmt != null) {</span>
<span class="nc" id="L1563">								stmt.close();</span>
							}

						}
<span class="nc" id="L1567">						retailerPresent = 0;</span>

<span class="nc" id="L1569">						retailer_org_id_current = retailer_org_id_current</span>
								- amount;

<span class="nc" id="L1572">						agnt_sale_acc_current = agnt_sale_acc_current + amount;</span>
<span class="nc" id="L1573">						logger.debug(&quot;LH-AGT-RET**&quot; + transaction_date</span>
								+ &quot;**AMT-&quot; + amount + &quot;**ACT_TYPE-&quot; + acc_type
								+ &quot;**RET_ACC-&quot; + retailer_org_id_current
								+ &quot;**AGT_ACC-&quot; + agnt_sale_acc_current);
<span class="nc" id="L1577">						query1 = QueryManager.getST2InsertAgentLedger();</span>
<span class="nc" id="L1578">						updatePstmt = connection.prepareStatement(query1);</span>

<span class="nc" id="L1580">						updatePstmt.setInt(1, agent_id);</span>
<span class="nc" id="L1581">						updatePstmt.setString(2, transaction_type);</span>
<span class="nc" id="L1582">						updatePstmt.setLong(3, transaction_id);</span>
<span class="nc" id="L1583">						updatePstmt.setTimestamp(4, transaction_date);</span>
<span class="nc" id="L1584">						updatePstmt.setString(5, -amount + &quot;&quot;);</span>
<span class="nc" id="L1585">						updatePstmt.setString(6, acc_type);</span>
<span class="nc" id="L1586">						updatePstmt.setString(7, retailer_org_id_current + &quot;&quot;);</span>
<span class="nc" id="L1587">						updatePstmt.setString(8, orgName);</span>
<span class="nc" id="L1588">						updatePstmt.setString(9, RECEIPT_ID);</span>
<span class="nc" id="L1589">						updatePstmt.execute();</span>

<span class="nc bnc" id="L1591" title="All 2 branches missed.">						if (updatePstmt != null) {</span>
<span class="nc" id="L1592">							updatePstmt.close();</span>
						}

<span class="nc" id="L1595">						query2 = QueryManager.getST2InsertAgentLedger();</span>
<span class="nc" id="L1596">						upPstmt = connection.prepareStatement(query2);</span>
<span class="nc" id="L1597">						upPstmt.setInt(1, agent_id);</span>
<span class="nc" id="L1598">						upPstmt.setString(2, transaction_type);</span>
<span class="nc" id="L1599">						upPstmt.setLong(3, transaction_id);</span>
<span class="nc" id="L1600">						upPstmt.setTimestamp(4, transaction_date);</span>
<span class="nc" id="L1601">						upPstmt.setString(5, amount + &quot;&quot;);</span>
<span class="nc" id="L1602">						upPstmt.setString(6, &quot;AGNT_SALE_ACC&quot;);</span>
<span class="nc" id="L1603">						upPstmt.setString(7, agnt_sale_acc_current + &quot;&quot;);</span>
<span class="nc" id="L1604">						upPstmt.setString(8, orgName);</span>
<span class="nc" id="L1605">						upPstmt.setString(9, RECEIPT_ID);</span>
<span class="nc" id="L1606">						upPstmt.execute();</span>

<span class="nc bnc" id="L1608" title="All 2 branches missed.">						if (upPstmt != null) {</span>
<span class="nc" id="L1609">							upPstmt.close();</span>
						}

<span class="nc" id="L1612">						query3 = QueryManager.getST2UpadateAgentCurrentBal();</span>
<span class="nc" id="L1613">						updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L1614">						updPstmt.setString(1, retailer_org_id_current + &quot;&quot;);</span>
<span class="nc" id="L1615">						updPstmt.setString(2, acc_type);</span>
<span class="nc" id="L1616">						updPstmt.setInt(3, agent_id);</span>
<span class="nc" id="L1617">						updPstmt.execute();</span>

<span class="nc bnc" id="L1619" title="All 2 branches missed.">						if (updPstmt != null) {</span>
<span class="nc" id="L1620">							updPstmt.close();</span>
						}

<span class="nc" id="L1623">					}</span>

<span class="nc bnc" id="L1625" title="All 2 branches missed.">					else if (transaction_type.equalsIgnoreCase(&quot;cheque&quot;)) {</span>
<span class="nc" id="L1626">						stmt2 = connection.prepareStatement(QueryManager</span>
								.getST2AgentChq());
<span class="nc" id="L1628">						stmt2.setLong(1, transaction_id);</span>
<span class="nc" id="L1629">						rs2 = stmt2.executeQuery();</span>

						// This has been changed into prepared Statement
						// 10-03-08

						// rs2 =
						// stmt2.executeQuery(QueryManager.getST2AgentChq()+&quot;&quot;+
						// transaction_id + &quot;&quot;);

<span class="nc bnc" id="L1638" title="All 2 branches missed.">						while (rs2.next()) {</span>
<span class="nc" id="L1639">							amount = rs2.getDouble(&quot;cheque_amt&quot;);</span>
<span class="nc" id="L1640">							transaction_date = rs2</span>
									.getTimestamp(&quot;transaction_date&quot;);
							// TRANS_DATE= new
							// java.sql.Date(transaction_date.getTime());
<span class="nc" id="L1644">							acc_type = &quot;&quot; + rs2.getInt(&quot;retailer_org_id&quot;);</span>
<span class="nc" id="L1645">							orgName = rs2.getString(&quot;name&quot;);</span>
						}

<span class="nc bnc" id="L1648" title="All 2 branches missed.">						if (stmt2 != null) {</span>
<span class="nc" id="L1649">							stmt2.close();</span>
						}
<span class="nc bnc" id="L1651" title="All 2 branches missed.">						if (rs2 != null) {</span>
<span class="nc" id="L1652">							rs2.close();</span>
						}

<span class="nc" id="L1655">						stmt = connection.prepareStatement(QueryManager</span>
								.getST6AgtCurrBal());
<span class="nc" id="L1657">						stmt.setString(1, acc_type);</span>
<span class="nc" id="L1658">						stmt.setInt(2, agent_id);</span>
<span class="nc" id="L1659">						rs = stmt.executeQuery();</span>

<span class="nc bnc" id="L1661" title="All 2 branches missed.">						while (rs.next()) {</span>
<span class="nc" id="L1662">							retailer_org_id_current = rs</span>
									.getDouble(&quot;current_balance&quot;);
<span class="nc" id="L1664">							retailerPresent++;</span>

						}

<span class="nc bnc" id="L1668" title="All 2 branches missed.">						if (stmt != null) {</span>
<span class="nc" id="L1669">							stmt.close();</span>
						}
<span class="nc bnc" id="L1671" title="All 2 branches missed.">						if (rs != null) {</span>
<span class="nc" id="L1672">							rs.close();</span>
						}

<span class="nc bnc" id="L1675" title="All 2 branches missed.">						if (retailerPresent == 0) {</span>

<span class="nc" id="L1677">							stmt = connection.prepareStatement(QueryManager</span>
									.getST6InsertAgentCurrBal());
<span class="nc" id="L1679">							stmt.setString(1, acc_type);</span>
<span class="nc" id="L1680">							stmt.setDouble(2, 0.0);</span>
<span class="nc" id="L1681">							stmt.setInt(3, agent_id);</span>
<span class="nc" id="L1682">							stmt.execute();</span>
<span class="nc" id="L1683">							retailer_org_id_current = 0.0;</span>

<span class="nc bnc" id="L1685" title="All 2 branches missed.">							if (stmt != null) {</span>
<span class="nc" id="L1686">								stmt.close();</span>
							}

						}
<span class="nc" id="L1690">						logger.debug(&quot;LH-AGT-RET**&quot; + transaction_type</span>
								+ &quot;**TRX_ID-&quot; + transaction_id + &quot;**R_ID-&quot;
								+ RECEIPT_ID);
<span class="nc" id="L1693">						retailerPresent = 0;</span>
<span class="nc" id="L1694">						retailer_org_id_current = retailer_org_id_current</span>
								+ amount;

<span class="nc" id="L1697">						agent_bank_acc_current = agent_bank_acc_current</span>
								- amount;
<span class="nc" id="L1699">						logger.debug(&quot;LH-AGT-RET**&quot; + transaction_date</span>
								+ &quot;**AMT-&quot; + amount + &quot;**ACT_TYPE-&quot; + acc_type
								+ &quot;**RET_ACC-&quot; + retailer_org_id_current
								+ &quot;**AGT_ACC-&quot; + agent_bank_acc_current);
<span class="nc" id="L1703">						query2 = QueryManager.getST2InsertAgentLedger();</span>
<span class="nc" id="L1704">						upPstmt = connection.prepareStatement(query2);</span>
<span class="nc" id="L1705">						upPstmt.setInt(1, agent_id);</span>
<span class="nc" id="L1706">						upPstmt.setString(2, transaction_type);</span>
<span class="nc" id="L1707">						upPstmt.setLong(3, transaction_id);</span>
<span class="nc" id="L1708">						upPstmt.setTimestamp(4, transaction_date);</span>
<span class="nc" id="L1709">						upPstmt.setString(5, -amount + &quot;&quot;);</span>
<span class="nc" id="L1710">						upPstmt.setString(6, &quot;AGNT_BANK_ACC&quot;);</span>
<span class="nc" id="L1711">						upPstmt.setString(7, agent_bank_acc_current + &quot;&quot;);</span>
<span class="nc" id="L1712">						upPstmt.setString(8, orgName);</span>
<span class="nc" id="L1713">						upPstmt.setString(9, RECEIPT_ID);</span>
<span class="nc" id="L1714">						upPstmt.execute();</span>

<span class="nc bnc" id="L1716" title="All 2 branches missed.">						if (upPstmt != null) {</span>
<span class="nc" id="L1717">							upPstmt.close();</span>
						}

<span class="nc" id="L1720">						query1 = QueryManager.getST2InsertAgentLedger();</span>
<span class="nc" id="L1721">						updatePstmt = connection.prepareStatement(query1);</span>

<span class="nc" id="L1723">						updatePstmt.setInt(1, agent_id);</span>
<span class="nc" id="L1724">						updatePstmt.setString(2, transaction_type);</span>
<span class="nc" id="L1725">						updatePstmt.setLong(3, transaction_id);</span>
<span class="nc" id="L1726">						updatePstmt.setTimestamp(4, transaction_date);</span>
<span class="nc" id="L1727">						updatePstmt.setString(5, amount + &quot;&quot;);</span>
<span class="nc" id="L1728">						updatePstmt.setString(6, acc_type);</span>
<span class="nc" id="L1729">						updatePstmt.setString(7, retailer_org_id_current + &quot;&quot;);</span>
<span class="nc" id="L1730">						updatePstmt.setString(8, orgName);</span>
<span class="nc" id="L1731">						updatePstmt.setString(9, RECEIPT_ID);</span>
<span class="nc" id="L1732">						updatePstmt.execute();</span>

<span class="nc bnc" id="L1734" title="All 2 branches missed.">						if (updatePstmt != null) {</span>
<span class="nc" id="L1735">							updatePstmt.close();</span>
						}

<span class="nc" id="L1738">						query3 = QueryManager.getST2UpadateAgentCurrentBal();</span>
<span class="nc" id="L1739">						updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L1740">						updPstmt.setString(1, retailer_org_id_current + &quot;&quot;);</span>
<span class="nc" id="L1741">						updPstmt.setString(2, acc_type);</span>
<span class="nc" id="L1742">						updPstmt.setInt(3, agent_id);</span>
<span class="nc" id="L1743">						updPstmt.execute();</span>

<span class="nc bnc" id="L1745" title="All 2 branches missed.">						if (updPstmt != null) {</span>
<span class="nc" id="L1746">							updPstmt.close();</span>
						}

					}

<span class="nc bnc" id="L1751" title="All 2 branches missed.">					else if (transaction_type.equalsIgnoreCase(&quot;chq_bounce&quot;)) {</span>

<span class="nc" id="L1753">						stmt2 = connection.prepareStatement(QueryManager</span>
								.getST2AgentChqBounce());
<span class="nc" id="L1755">						stmt2.setLong(1, transaction_id);</span>
<span class="nc" id="L1756">						rs2 = stmt2.executeQuery();</span>
						// This has been changed to prepared statement 10-03-08
						// rs2 =
						// stmt2.executeQuery(QueryManager.getST2AgentChqBounce()+&quot;&quot;+
						// transaction_id + &quot;&quot;);
<span class="nc bnc" id="L1761" title="All 2 branches missed.">						while (rs2.next()) {</span>
<span class="nc" id="L1762">							amount = rs2.getDouble(&quot;cheque_amt&quot;);</span>
<span class="nc" id="L1763">							transaction_date = rs2</span>
									.getTimestamp(&quot;transaction_date&quot;);
							// TRANS_DATE= new
							// java.sql.Date(transaction_date.getTime());
<span class="nc" id="L1767">							acc_type = &quot;&quot; + rs2.getInt(&quot;retailer_org_id&quot;);</span>
<span class="nc" id="L1768">							orgName = rs2.getString(&quot;name&quot;);</span>
						}

<span class="nc bnc" id="L1771" title="All 2 branches missed.">						if (stmt2 != null) {</span>
<span class="nc" id="L1772">							stmt2.close();</span>
						}
<span class="nc bnc" id="L1774" title="All 2 branches missed.">						if (rs2 != null) {</span>
<span class="nc" id="L1775">							rs2.close();</span>
						}

<span class="nc" id="L1778">						stmt = connection.prepareStatement(QueryManager</span>
								.getST6AgtCurrBal());
<span class="nc" id="L1780">						stmt.setString(1, acc_type);</span>
<span class="nc" id="L1781">						stmt.setInt(2, agent_id);</span>
<span class="nc" id="L1782">						rs = stmt.executeQuery();</span>
						// This has been changed into Prepared statement and
						// moved to Query manager 10-03-08
						// rs = stmt.executeQuery(&quot;select current_balance from
						// st_lms_agent_current_balance where account_type = '&quot;+
						// acc_type + &quot;' and agent_id = &quot;+agent_id);

<span class="nc bnc" id="L1789" title="All 2 branches missed.">						while (rs.next()) {</span>
<span class="nc" id="L1790">							retailer_org_id_current = rs</span>
									.getDouble(&quot;current_balance&quot;);
<span class="nc" id="L1792">							retailerPresent++;</span>
						}

<span class="nc bnc" id="L1795" title="All 2 branches missed.">						if (stmt != null) {</span>
<span class="nc" id="L1796">							stmt.close();</span>
						}
<span class="nc bnc" id="L1798" title="All 2 branches missed.">						if (rs != null) {</span>
<span class="nc" id="L1799">							rs.close();</span>
						}

<span class="nc bnc" id="L1802" title="All 2 branches missed.">						if (retailerPresent == 0) {</span>
<span class="nc" id="L1803">							stmt = connection.prepareStatement(QueryManager</span>
									.getST6InsertAgentCurrBal());
<span class="nc" id="L1805">							stmt.setString(1, acc_type);</span>
<span class="nc" id="L1806">							stmt.setDouble(2, 0.0);</span>
<span class="nc" id="L1807">							stmt.setInt(3, agent_id);</span>
<span class="nc" id="L1808">							stmt.execute();</span>
<span class="nc" id="L1809">							retailer_org_id_current = 0.0;</span>

<span class="nc bnc" id="L1811" title="All 2 branches missed.">							if (stmt != null) {</span>
<span class="nc" id="L1812">								stmt.close();</span>
							}

							// This has been moved into query manager and
							// changed to prepared statement 10-03-08
							// stmt.executeUpdate(&quot;insert into
							// st_lms_agent_current_balance
							// (account_type,current_balance,agent_id) values
							// ('&quot;+acc_type+&quot;',0.0,&quot;+agent_id+&quot;)&quot;);
						}
<span class="nc" id="L1822">						retailerPresent = 0;</span>

<span class="nc" id="L1824">						logger.debug(&quot;LH-AGT-RET**&quot; + transaction_type</span>
								+ &quot;**TRX_ID-&quot; + transaction_id + &quot;**R_ID-&quot;
								+ RECEIPT_ID);
<span class="nc" id="L1827">						retailer_org_id_current = retailer_org_id_current</span>
								- amount;
<span class="nc" id="L1829">						agent_bank_acc_current = agent_bank_acc_current</span>
								+ amount;
<span class="nc" id="L1831">						logger.debug(&quot;LH-AGT-RET**&quot; + transaction_date</span>
								+ &quot;**AMT-&quot; + amount + &quot;**ACT_TYPE-&quot; + acc_type
								+ &quot;**RET_ACC-&quot; + retailer_org_id_current
								+ &quot;**AGT_ACC-&quot; + agent_bank_acc_current);
<span class="nc" id="L1835">						query1 = QueryManager.getST2InsertAgentLedger();</span>
<span class="nc" id="L1836">						updatePstmt = connection.prepareStatement(query1);</span>

<span class="nc" id="L1838">						updatePstmt.setInt(1, agent_id);</span>
<span class="nc" id="L1839">						updatePstmt.setString(2, transaction_type);</span>
<span class="nc" id="L1840">						updatePstmt.setLong(3, transaction_id);</span>
<span class="nc" id="L1841">						updatePstmt.setTimestamp(4, transaction_date);</span>
<span class="nc" id="L1842">						updatePstmt.setString(5, -amount + &quot;&quot;);</span>
<span class="nc" id="L1843">						updatePstmt.setString(6, acc_type);</span>
<span class="nc" id="L1844">						updatePstmt.setString(7, retailer_org_id_current + &quot;&quot;);</span>
<span class="nc" id="L1845">						updatePstmt.setString(8, orgName);</span>
<span class="nc" id="L1846">						updatePstmt.setString(9, RECEIPT_ID);</span>
<span class="nc" id="L1847">						updatePstmt.execute();</span>

<span class="nc bnc" id="L1849" title="All 2 branches missed.">						if (updatePstmt != null) {</span>
<span class="nc" id="L1850">							updatePstmt.close();</span>
						}

<span class="nc" id="L1853">						query2 = QueryManager.getST2InsertAgentLedger();</span>
<span class="nc" id="L1854">						upPstmt = connection.prepareStatement(query2);</span>
<span class="nc" id="L1855">						upPstmt.setInt(1, agent_id);</span>
<span class="nc" id="L1856">						upPstmt.setString(2, transaction_type);</span>
<span class="nc" id="L1857">						upPstmt.setLong(3, transaction_id);</span>
<span class="nc" id="L1858">						upPstmt.setTimestamp(4, transaction_date);</span>
<span class="nc" id="L1859">						upPstmt.setString(5, amount + &quot;&quot;);</span>
<span class="nc" id="L1860">						upPstmt.setString(6, &quot;AGNT_BANK_ACC&quot;);</span>
<span class="nc" id="L1861">						upPstmt.setString(7, agent_bank_acc_current + &quot;&quot;);</span>
<span class="nc" id="L1862">						upPstmt.setString(8, orgName);</span>
<span class="nc" id="L1863">						upPstmt.setString(9, RECEIPT_ID);</span>
<span class="nc" id="L1864">						upPstmt.execute();</span>

<span class="nc bnc" id="L1866" title="All 2 branches missed.">						if (upPstmt != null) {</span>
<span class="nc" id="L1867">							upPstmt.close();</span>
						}

<span class="nc" id="L1870">						query3 = QueryManager.getST2UpadateAgentCurrentBal();</span>
<span class="nc" id="L1871">						updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L1872">						updPstmt.setString(1, retailer_org_id_current + &quot;&quot;);</span>
<span class="nc" id="L1873">						updPstmt.setString(2, acc_type);</span>
<span class="nc" id="L1874">						updPstmt.setInt(3, agent_id);</span>
<span class="nc" id="L1875">						updPstmt.execute();</span>

<span class="nc bnc" id="L1877" title="All 2 branches missed.">						if (updPstmt != null) {</span>
<span class="nc" id="L1878">							updPstmt.close();</span>
						}

					}
					/*
					 * on abshishekhs recomendation
					 */

<span class="nc bnc" id="L1886" title="All 2 branches missed.">					else if (transaction_type.equalsIgnoreCase(&quot;vat&quot;)) {</span>

<span class="nc" id="L1888">						stmt2 = connection.prepareStatement(QueryManager</span>
								.getST6AgentVATPayable());
<span class="nc" id="L1890">						stmt2.setLong(1, transaction_id);</span>
<span class="nc" id="L1891">						rs2 = stmt2.executeQuery();</span>
						// This has been replaced by the obove prepared
						// statements statements 07-03-08
						// rs2 =
						// stmt2.executeQuery(QueryManager.getST2BoGovtComm()+&quot;&quot;+
						// transaction_id + &quot;&quot;);

<span class="nc bnc" id="L1898" title="All 2 branches missed.">						while (rs2.next()) {</span>
<span class="nc" id="L1899">							amount = rs2.getDouble(&quot;amount&quot;);</span>
							// TRANSACTION_DATE =
							// rs2.getDate(&quot;transaction_date&quot;);
<span class="nc" id="L1902">							transaction_date = rs2</span>
									.getTimestamp(&quot;transaction_date&quot;);
<span class="nc" id="L1904">							acc_type = &quot;AGENT_VAT_PAY&quot;;</span>
						}

<span class="nc bnc" id="L1907" title="All 2 branches missed.">						if (stmt2 != null) {</span>
<span class="nc" id="L1908">							stmt2.close();</span>
						}
<span class="nc bnc" id="L1910" title="All 2 branches missed.">						if (rs2 != null) {</span>
<span class="nc" id="L1911">							rs2.close();</span>
						}

<span class="nc" id="L1914">						agent_vat_pay_current = agent_vat_pay_current - amount;</span>
<span class="nc" id="L1915">						agent_bank_acc_current = agent_bank_acc_current</span>
								+ amount;

<span class="nc" id="L1918">						query1 = QueryManager.getST2InsertAgentLedger();</span>
<span class="nc" id="L1919">						updatePstmt = connection.prepareStatement(query1);</span>
<span class="nc" id="L1920">						updatePstmt.setInt(1, agent_id);</span>
<span class="nc" id="L1921">						updatePstmt.setString(2, transaction_type);</span>
<span class="nc" id="L1922">						updatePstmt.setLong(3, transaction_id);</span>
						// updatePstmt.setDate(3, TRANSACTION_DATE);
<span class="nc" id="L1924">						updatePstmt.setTimestamp(4, transaction_date);</span>
<span class="nc" id="L1925">						updatePstmt.setString(5, -amount + &quot;&quot;);</span>
<span class="nc" id="L1926">						updatePstmt.setString(6, acc_type);</span>
<span class="nc" id="L1927">						updatePstmt.setString(7, agent_vat_pay_current + &quot;&quot;);</span>
<span class="nc" id="L1928">						updatePstmt.setString(8, &quot;GOVERNMENT&quot;);</span>
<span class="nc" id="L1929">						updatePstmt.setString(9, RECEIPT_ID);</span>
<span class="nc" id="L1930">						updatePstmt.execute();</span>

<span class="nc bnc" id="L1932" title="All 2 branches missed.">						if (updatePstmt != null) {</span>
<span class="nc" id="L1933">							updatePstmt.close();</span>
						}

<span class="nc" id="L1936">						query2 = QueryManager.getST2InsertAgentLedger();</span>
<span class="nc" id="L1937">						upPstmt = connection.prepareStatement(query2);</span>
<span class="nc" id="L1938">						upPstmt.setInt(1, agent_id);</span>
<span class="nc" id="L1939">						upPstmt.setString(2, transaction_type);</span>
<span class="nc" id="L1940">						upPstmt.setLong(3, transaction_id);</span>
						// upPstmt.setDate(3, TRANSACTION_DATE);
<span class="nc" id="L1942">						upPstmt.setTimestamp(4, transaction_date);</span>
<span class="nc" id="L1943">						upPstmt.setString(5, amount + &quot;&quot;);</span>
<span class="nc" id="L1944">						upPstmt.setString(6, &quot;AGNT_BANK_ACC&quot;);</span>
<span class="nc" id="L1945">						upPstmt.setString(7, agent_bank_acc_current + &quot;&quot;);</span>
<span class="nc" id="L1946">						upPstmt.setString(8, &quot;GOVERNMENT&quot;);</span>
<span class="nc" id="L1947">						upPstmt.setString(9, RECEIPT_ID);</span>
<span class="nc" id="L1948">						upPstmt.execute();</span>

<span class="nc bnc" id="L1950" title="All 2 branches missed.">						if (upPstmt != null) {</span>
<span class="nc" id="L1951">							upPstmt.close();</span>
						}

					}

					/*
					 */
<span class="nc bnc" id="L1958" title="All 4 branches missed.">					else if (transaction_type.equalsIgnoreCase(&quot;DR_NOTE_CASH&quot;)</span>
							|| transaction_type.equalsIgnoreCase(&quot;DR_NOTE&quot;)) {

<span class="nc" id="L1961">						stmt2 = connection.prepareStatement(QueryManager</span>
								.getST6AgentDebitNote());
<span class="nc" id="L1963">						stmt2.setLong(1, transaction_id);</span>
<span class="nc" id="L1964">						rs2 = stmt2.executeQuery();</span>
						// This has been changed to prepared statement 10-03-08
						// rs2 =
						// stmt2.executeQuery(QueryManager.getST2AgentChqBounce()+&quot;&quot;+
						// transaction_id + &quot;&quot;);
<span class="nc bnc" id="L1969" title="All 2 branches missed.">						while (rs2.next()) {</span>
<span class="nc" id="L1970">							amount = rs2.getDouble(&quot;amount&quot;);</span>
<span class="nc" id="L1971">							transaction_date = rs2</span>
									.getTimestamp(&quot;transaction_date&quot;);
							// TRANS_DATE= new
							// java.sql.Date(transaction_date.getTime());
<span class="nc" id="L1975">							acc_type = &quot;&quot; + rs2.getInt(&quot;retailer_org_id&quot;);</span>
<span class="nc" id="L1976">							orgName = rs2.getString(&quot;name&quot;);</span>
						}

<span class="nc bnc" id="L1979" title="All 2 branches missed.">						if (stmt2 != null) {</span>
<span class="nc" id="L1980">							stmt2.close();</span>
						}
<span class="nc bnc" id="L1982" title="All 2 branches missed.">						if (rs2 != null) {</span>
<span class="nc" id="L1983">							rs2.close();</span>
						}

<span class="nc" id="L1986">						stmt = connection.prepareStatement(QueryManager</span>
								.getST6AgtCurrBal());
<span class="nc" id="L1988">						stmt.setString(1, acc_type);</span>
<span class="nc" id="L1989">						stmt.setInt(2, agent_id);</span>
<span class="nc" id="L1990">						rs = stmt.executeQuery();</span>

<span class="nc bnc" id="L1992" title="All 2 branches missed.">						while (rs.next()) {</span>
<span class="nc" id="L1993">							retailer_org_id_current = rs</span>
									.getDouble(&quot;current_balance&quot;);
<span class="nc" id="L1995">							retailerPresent++;</span>
						}

<span class="nc bnc" id="L1998" title="All 2 branches missed.">						if (stmt2 != null) {</span>
<span class="nc" id="L1999">							stmt2.close();</span>
						}
<span class="nc bnc" id="L2001" title="All 2 branches missed.">						if (rs2 != null) {</span>
<span class="nc" id="L2002">							rs2.close();</span>
						}

<span class="nc bnc" id="L2005" title="All 2 branches missed.">						if (retailerPresent == 0) {</span>
<span class="nc" id="L2006">							stmt = connection.prepareStatement(QueryManager</span>
									.getST6InsertAgentCurrBal());
<span class="nc" id="L2008">							stmt.setString(1, acc_type);</span>
<span class="nc" id="L2009">							stmt.setDouble(2, 0.0);</span>
<span class="nc" id="L2010">							stmt.setInt(3, agent_id);</span>
<span class="nc" id="L2011">							stmt.execute();</span>
<span class="nc" id="L2012">							retailer_org_id_current = 0.0;</span>

<span class="nc bnc" id="L2014" title="All 2 branches missed.">							if (stmt != null) {</span>
<span class="nc" id="L2015">								stmt.close();</span>
							}

							// This has been moved into query manager and
							// changed to prepared statement 10-03-08
							// stmt.executeUpdate(&quot;insert into
							// st_lms_agent_current_balance
							// (account_type,current_balance,agent_id) values
							// ('&quot;+acc_type+&quot;',0.0,&quot;+agent_id+&quot;)&quot;);
						}
<span class="nc" id="L2025">						retailerPresent = 0;</span>
<span class="nc" id="L2026">						retailer_org_id_current = retailer_org_id_current</span>
								- amount;
<span class="nc" id="L2028">						agent_bank_acc_current = agent_bank_acc_current</span>
								+ amount;

<span class="nc" id="L2031">						logger.debug(&quot;LH-AGT-RET**&quot; + transaction_type</span>
								+ &quot;**TRX_ID-&quot; + transaction_id + &quot;**R_ID-&quot;
								+ RECEIPT_ID);
<span class="nc" id="L2034">						logger.debug(&quot;LH-AGT-RET**&quot; + transaction_date</span>
								+ &quot;**AMT-&quot; + amount + &quot;**ACT_TYPE-&quot; + acc_type
								+ &quot;**RET_ACC-&quot; + retailer_org_id_current
								+ &quot;**AGT_ACC-&quot; + agent_bank_acc_current);
<span class="nc" id="L2038">						query1 = QueryManager.getST2InsertAgentLedger();</span>
<span class="nc" id="L2039">						updatePstmt = connection.prepareStatement(query1);</span>

<span class="nc" id="L2041">						updatePstmt.setInt(1, agent_id);</span>
<span class="nc" id="L2042">						updatePstmt.setString(2, transaction_type);</span>
<span class="nc" id="L2043">						updatePstmt.setLong(3, transaction_id);</span>
<span class="nc" id="L2044">						updatePstmt.setTimestamp(4, transaction_date);</span>
<span class="nc" id="L2045">						updatePstmt.setString(5, -amount + &quot;&quot;);</span>
<span class="nc" id="L2046">						updatePstmt.setString(6, acc_type);</span>
<span class="nc" id="L2047">						updatePstmt.setString(7, retailer_org_id_current + &quot;&quot;);</span>
<span class="nc" id="L2048">						updatePstmt.setString(8, orgName);</span>
<span class="nc" id="L2049">						updatePstmt.setString(9, RECEIPT_ID);</span>
<span class="nc" id="L2050">						updatePstmt.execute();</span>

<span class="nc bnc" id="L2052" title="All 2 branches missed.">						if (updatePstmt != null) {</span>
<span class="nc" id="L2053">							updatePstmt.close();</span>
						}

<span class="nc" id="L2056">						query2 = QueryManager.getST2InsertAgentLedger();</span>
<span class="nc" id="L2057">						upPstmt = connection.prepareStatement(query2);</span>
<span class="nc" id="L2058">						upPstmt.setInt(1, agent_id);</span>
<span class="nc" id="L2059">						upPstmt.setString(2, transaction_type);</span>
<span class="nc" id="L2060">						upPstmt.setLong(3, transaction_id);</span>
<span class="nc" id="L2061">						upPstmt.setTimestamp(4, transaction_date);</span>
<span class="nc" id="L2062">						upPstmt.setString(5, amount + &quot;&quot;);</span>
<span class="nc" id="L2063">						upPstmt.setString(6, &quot;AGNT_BANK_ACC&quot;);</span>
<span class="nc" id="L2064">						upPstmt.setString(7, agent_bank_acc_current + &quot;&quot;);</span>
<span class="nc" id="L2065">						upPstmt.setString(8, orgName);</span>
<span class="nc" id="L2066">						upPstmt.setString(9, RECEIPT_ID);</span>
<span class="nc" id="L2067">						upPstmt.execute();</span>

<span class="nc bnc" id="L2069" title="All 2 branches missed.">						if (upPstmt != null) {</span>
<span class="nc" id="L2070">							upPstmt.close();</span>
						}

<span class="nc" id="L2073">						query3 = QueryManager.getST2UpadateAgentCurrentBal();</span>
<span class="nc" id="L2074">						updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L2075">						updPstmt.setString(1, retailer_org_id_current + &quot;&quot;);</span>
<span class="nc" id="L2076">						updPstmt.setString(2, acc_type);</span>
<span class="nc" id="L2077">						updPstmt.setInt(3, agent_id);</span>
<span class="nc" id="L2078">						updPstmt.execute();</span>

<span class="nc bnc" id="L2080" title="All 2 branches missed.">						if (updPstmt != null) {</span>
<span class="nc" id="L2081">							updPstmt.close();</span>
						}

					}
					// code for credit note entry in ledger @amit starts...

<span class="nc bnc" id="L2087" title="All 4 branches missed.">					else if (transaction_type.equalsIgnoreCase(&quot;CR_NOTE_CASH&quot;)</span>
							|| transaction_type.equalsIgnoreCase(&quot;CR_NOTE&quot;)) {
<span class="nc" id="L2089">						stmt2 = connection.prepareStatement(QueryManager</span>
								.getST6AgentCreditNote());
<span class="nc" id="L2091">						stmt2.setLong(1, transaction_id);</span>
<span class="nc" id="L2092">						rs2 = stmt2.executeQuery();</span>
						// This has been changed to prepared statement 10-03-08
						// rs2 =
						// stmt2.executeQuery(QueryManager.getST2AgentChqBounce()+&quot;&quot;+
						// transaction_id + &quot;&quot;);
<span class="nc bnc" id="L2097" title="All 2 branches missed.">						while (rs2.next()) {</span>
<span class="nc" id="L2098">							amount = rs2.getDouble(&quot;amount&quot;);</span>
<span class="nc" id="L2099">							transaction_date = rs2</span>
									.getTimestamp(&quot;transaction_date&quot;);
							// TRANS_DATE= new
							// java.sql.Date(transaction_date.getTime());
<span class="nc" id="L2103">							acc_type = &quot;&quot; + rs2.getInt(&quot;retailer_org_id&quot;);</span>
<span class="nc" id="L2104">							orgName = rs2.getString(&quot;name&quot;);</span>
						}

<span class="nc bnc" id="L2107" title="All 2 branches missed.">						if (stmt2 != null) {</span>
<span class="nc" id="L2108">							stmt2.close();</span>
						}
<span class="nc bnc" id="L2110" title="All 2 branches missed.">						if (rs2 != null) {</span>
<span class="nc" id="L2111">							rs2.close();</span>
						}

<span class="nc" id="L2114">						stmt = connection.prepareStatement(QueryManager</span>
								.getST6AgtCurrBal());
<span class="nc" id="L2116">						stmt.setString(1, acc_type);</span>
<span class="nc" id="L2117">						stmt.setInt(2, agent_id);</span>
<span class="nc" id="L2118">						rs = stmt.executeQuery();</span>

<span class="nc bnc" id="L2120" title="All 2 branches missed.">						while (rs.next()) {</span>
<span class="nc" id="L2121">							retailer_org_id_current = rs</span>
									.getDouble(&quot;current_balance&quot;);
<span class="nc" id="L2123">							retailerPresent++;</span>
						}

<span class="nc bnc" id="L2126" title="All 2 branches missed.">						if (stmt2 != null) {</span>
<span class="nc" id="L2127">							stmt2.close();</span>
						}
<span class="nc bnc" id="L2129" title="All 2 branches missed.">						if (rs2 != null) {</span>
<span class="nc" id="L2130">							rs2.close();</span>
						}

<span class="nc bnc" id="L2133" title="All 2 branches missed.">						if (retailerPresent == 0) {</span>
<span class="nc" id="L2134">							stmt = connection.prepareStatement(QueryManager</span>
									.getST6InsertAgentCurrBal());
<span class="nc" id="L2136">							stmt.setString(1, acc_type);</span>
<span class="nc" id="L2137">							stmt.setDouble(2, 0.0);</span>
<span class="nc" id="L2138">							stmt.setInt(3, agent_id);</span>
<span class="nc" id="L2139">							stmt.execute();</span>
<span class="nc" id="L2140">							retailer_org_id_current = 0.0;</span>

<span class="nc bnc" id="L2142" title="All 2 branches missed.">							if (stmt != null) {</span>
<span class="nc" id="L2143">								stmt.close();</span>
							}

							// This has been moved into query manager and
							// changed to prepared statement 10-03-08
							// stmt.executeUpdate(&quot;insert into
							// st_lms_agent_current_balance
							// (account_type,current_balance,agent_id) values
							// ('&quot;+acc_type+&quot;',0.0,&quot;+agent_id+&quot;)&quot;);
						}
<span class="nc" id="L2153">						retailerPresent = 0;</span>
<span class="nc" id="L2154">						retailer_org_id_current = retailer_org_id_current</span>
								+ amount;
<span class="nc" id="L2156">						agent_bank_acc_current = agent_bank_acc_current</span>
								- amount;
<span class="nc" id="L2158">						logger.debug(&quot;LH-AGT-RET**&quot; + transaction_type</span>
								+ &quot;**TRX_ID-&quot; + transaction_id + &quot;**R_ID-&quot;
								+ RECEIPT_ID);
<span class="nc" id="L2161">						logger.debug(&quot;LH-AGT-RET**&quot; + transaction_date</span>
								+ &quot;**AMT-&quot; + amount + &quot;**ACT_TYPE-&quot; + acc_type
								+ &quot;**RET_ACC-&quot; + retailer_org_id_current
								+ &quot;**AGT_ACC-&quot; + agent_bank_acc_current);
<span class="nc" id="L2165">						query1 = QueryManager.getST2InsertAgentLedger();</span>
<span class="nc" id="L2166">						updatePstmt = connection.prepareStatement(query1);</span>

<span class="nc" id="L2168">						updatePstmt.setInt(1, agent_id);</span>
<span class="nc" id="L2169">						updatePstmt.setString(2, transaction_type);</span>
<span class="nc" id="L2170">						updatePstmt.setLong(3, transaction_id);</span>
<span class="nc" id="L2171">						updatePstmt.setTimestamp(4, transaction_date);</span>
<span class="nc" id="L2172">						updatePstmt.setString(5, amount + &quot;&quot;);</span>
<span class="nc" id="L2173">						updatePstmt.setString(6, acc_type);</span>
<span class="nc" id="L2174">						updatePstmt.setString(7, retailer_org_id_current + &quot;&quot;);</span>
<span class="nc" id="L2175">						updatePstmt.setString(8, orgName);</span>
<span class="nc" id="L2176">						updatePstmt.setString(9, RECEIPT_ID);</span>
<span class="nc" id="L2177">						updatePstmt.execute();</span>

<span class="nc bnc" id="L2179" title="All 2 branches missed.">						if (updatePstmt != null) {</span>
<span class="nc" id="L2180">							updatePstmt.close();</span>
						}

<span class="nc" id="L2183">						query2 = QueryManager.getST2InsertAgentLedger();</span>
<span class="nc" id="L2184">						upPstmt = connection.prepareStatement(query2);</span>
<span class="nc" id="L2185">						upPstmt.setInt(1, agent_id);</span>
<span class="nc" id="L2186">						upPstmt.setString(2, transaction_type);</span>
<span class="nc" id="L2187">						upPstmt.setLong(3, transaction_id);</span>
<span class="nc" id="L2188">						upPstmt.setTimestamp(4, transaction_date);</span>
<span class="nc" id="L2189">						upPstmt.setString(5, -amount + &quot;&quot;);</span>
<span class="nc" id="L2190">						upPstmt.setString(6, &quot;AGNT_BANK_ACC&quot;);</span>
<span class="nc" id="L2191">						upPstmt.setString(7, agent_bank_acc_current + &quot;&quot;);</span>
<span class="nc" id="L2192">						upPstmt.setString(8, orgName);</span>
<span class="nc" id="L2193">						upPstmt.setString(9, RECEIPT_ID);</span>
<span class="nc" id="L2194">						upPstmt.execute();</span>

<span class="nc bnc" id="L2196" title="All 2 branches missed.">						if (upPstmt != null) {</span>
<span class="nc" id="L2197">							upPstmt.close();</span>
						}

<span class="nc" id="L2200">						query3 = QueryManager.getST2UpadateAgentCurrentBal();</span>
<span class="nc" id="L2201">						updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L2202">						updPstmt.setString(1, retailer_org_id_current + &quot;&quot;);</span>
<span class="nc" id="L2203">						updPstmt.setString(2, acc_type);</span>
<span class="nc" id="L2204">						updPstmt.setInt(3, agent_id);</span>
<span class="nc" id="L2205">						updPstmt.execute();</span>

<span class="nc bnc" id="L2207" title="All 2 branches missed.">						if (updPstmt != null) {</span>
<span class="nc" id="L2208">							updPstmt.close();</span>
						}
					}

					// code for credit note entry in ledger @amit ends...

<span class="nc bnc" id="L2214" title="All 12 branches missed.">					else if (transaction_type.equalsIgnoreCase(&quot;sale_ret&quot;)</span>
							|| transaction_type
									.equalsIgnoreCase(&quot;DG_REFUND_FAILED&quot;)
							|| transaction_type
									.equalsIgnoreCase(&quot;DG_REFUND_CANCEL&quot;)
							|| transaction_type
									.equalsIgnoreCase(&quot;CS_CANCEL_SERVER&quot;)
							|| transaction_type
									.equalsIgnoreCase(&quot;CS_CANCEL_RET&quot;)
							|| transaction_type.equalsIgnoreCase(&quot;OLA_DEPOSIT_REFUND&quot;)) {
<span class="nc" id="L2224">						String saleRetQuery = &quot;&quot;;</span>
<span class="nc bnc" id="L2225" title="All 2 branches missed.">						if (transaction_type.equalsIgnoreCase(&quot;sale_ret&quot;)) {</span>
<span class="nc" id="L2226">							saleRetQuery = QueryManager.getST2AgentSaleRet();</span>
<span class="nc bnc" id="L2227" title="All 4 branches missed.">						} else if (transaction_type</span>
								.equalsIgnoreCase(&quot;DG_REFUND_FAILED&quot;)
								|| transaction_type
										.equalsIgnoreCase(&quot;DG_REFUND_CANCEL&quot;)) {
<span class="nc" id="L2231">							saleRetQuery = QueryManager.getST2AgtDrwGmRefnd();</span>

<span class="nc bnc" id="L2233" title="All 4 branches missed.">						} else if (transaction_type</span>
								.equalsIgnoreCase(&quot;CS_CANCEL_SERVER&quot;)
								|| transaction_type
										.equalsIgnoreCase(&quot;CS_CANCEL_RET&quot;)) {
<span class="nc" id="L2237">							saleRetQuery = QueryManager.getST2AgtCSRefnd();</span>

<span class="nc bnc" id="L2239" title="All 2 branches missed.">						} else if (transaction_type.equalsIgnoreCase(&quot;OLA_DEPOSIT_REFUND&quot;))</span>
						{
<span class="nc" id="L2241">							saleRetQuery = QueryManager.getST2AgtOLARefnd();</span>
						}
<span class="nc" id="L2243">						stmt2 = connection.prepareStatement(saleRetQuery);</span>
<span class="nc" id="L2244">						stmt2.setLong(1, transaction_id);</span>
<span class="nc" id="L2245">						rs2 = stmt2.executeQuery();</span>
						// This has been changed to prepared statement 10-03-08
						// Wrong query was being used here instead of sale
						// return query for sale was being used here
						// rs2 =
						// stmt2.executeQuery(QueryManager.getST2AgentSale()+&quot;&quot;+
						// transaction_id + &quot;&quot;);
<span class="nc bnc" id="L2252" title="All 2 branches missed.">						while (rs2.next()) {</span>
<span class="nc" id="L2253">							amount = rs2.getDouble(&quot;net_amt&quot;);</span>
<span class="nc" id="L2254">							transaction_date = rs2</span>
									.getTimestamp(&quot;transaction_date&quot;);
<span class="nc" id="L2256">							acc_type = &quot;&quot; + rs2.getInt(&quot;retailer_org_id&quot;);</span>
<span class="nc" id="L2257">							orgName = rs2.getString(&quot;name&quot;);</span>
						}

<span class="nc bnc" id="L2260" title="All 2 branches missed.">						if (stmt2 != null) {</span>
<span class="nc" id="L2261">							stmt2.close();</span>
						}
<span class="nc bnc" id="L2263" title="All 2 branches missed.">						if (rs2 != null) {</span>
<span class="nc" id="L2264">							rs2.close();</span>
						}

<span class="nc" id="L2267">						stmt = connection.prepareStatement(QueryManager</span>
								.getST6AgtCurrBal());
<span class="nc" id="L2269">						stmt.setString(1, acc_type);</span>
<span class="nc" id="L2270">						stmt.setInt(2, agent_id);</span>
<span class="nc" id="L2271">						rs = stmt.executeQuery();</span>

<span class="nc bnc" id="L2273" title="All 2 branches missed.">						while (rs.next()) {</span>
<span class="nc" id="L2274">							retailer_org_id_current = rs</span>
									.getDouble(&quot;current_balance&quot;);

<span class="nc" id="L2277">							retailerPresent++;</span>
						}

<span class="nc bnc" id="L2280" title="All 2 branches missed.">						if (stmt != null) {</span>
<span class="nc" id="L2281">							stmt.close();</span>
						}
<span class="nc bnc" id="L2283" title="All 2 branches missed.">						if (rs != null) {</span>
<span class="nc" id="L2284">							rs.close();</span>
						}

<span class="nc bnc" id="L2287" title="All 2 branches missed.">						if (retailerPresent == 0) {</span>
<span class="nc" id="L2288">							stmt = connection.prepareStatement(QueryManager</span>
									.getST6InsertAgentCurrBal());
<span class="nc" id="L2290">							stmt.setString(1, acc_type);</span>
<span class="nc" id="L2291">							stmt.setDouble(2, 0.0);</span>
<span class="nc" id="L2292">							stmt.setInt(3, agent_id);</span>
<span class="nc" id="L2293">							stmt.execute();</span>
<span class="nc" id="L2294">							retailer_org_id_current = 0.0;</span>

<span class="nc bnc" id="L2296" title="All 2 branches missed.">							if (stmt != null) {</span>
<span class="nc" id="L2297">								stmt.close();</span>
							}
						}
<span class="nc" id="L2300">						retailerPresent = 0;</span>
<span class="nc" id="L2301">						retailer_org_id_current = retailer_org_id_current</span>
								+ amount;
<span class="nc" id="L2303">						agnt_sale_ret_current = agnt_sale_ret_current - amount;</span>
<span class="nc" id="L2304">						logger.debug(&quot;LH-AGT-RET**&quot; + transaction_type</span>
								+ &quot;**TRX_ID-&quot; + transaction_id + &quot;**R_ID-&quot;
								+ RECEIPT_ID);
<span class="nc" id="L2307">						logger.debug(&quot;LH-AGT-RET**&quot; + transaction_date</span>
								+ &quot;**AMT-&quot; + amount + &quot;**ACT_TYPE-&quot; + acc_type
								+ &quot;**RET_ACC-&quot; + retailer_org_id_current
								+ &quot;**AGT_ACC-&quot; + agnt_sale_ret_current);
<span class="nc" id="L2311">						query2 = QueryManager.getST2InsertAgentLedger();</span>
<span class="nc" id="L2312">						upPstmt = connection.prepareStatement(query2);</span>
<span class="nc" id="L2313">						upPstmt.setInt(1, agent_id);</span>
<span class="nc" id="L2314">						upPstmt.setString(2, transaction_type);</span>
<span class="nc" id="L2315">						upPstmt.setLong(3, transaction_id);</span>
<span class="nc" id="L2316">						upPstmt.setTimestamp(4, transaction_date);</span>
<span class="nc" id="L2317">						upPstmt.setString(5, -amount + &quot;&quot;);</span>
<span class="nc" id="L2318">						upPstmt.setString(6, &quot;AGNT_SALE_RET_ACC&quot;);</span>
<span class="nc" id="L2319">						upPstmt.setString(7, agnt_sale_ret_current + &quot;&quot;);</span>
<span class="nc" id="L2320">						upPstmt.setString(8, orgName);</span>
<span class="nc" id="L2321">						upPstmt.setString(9, RECEIPT_ID);</span>
<span class="nc" id="L2322">						upPstmt.execute();</span>

<span class="nc bnc" id="L2324" title="All 2 branches missed.">						if (upPstmt != null) {</span>
<span class="nc" id="L2325">							upPstmt.close();</span>
						}

<span class="nc" id="L2328">						query1 = QueryManager.getST2InsertAgentLedger();</span>
<span class="nc" id="L2329">						updatePstmt = connection.prepareStatement(query1);</span>

<span class="nc" id="L2331">						updatePstmt.setInt(1, agent_id);</span>
<span class="nc" id="L2332">						updatePstmt.setString(2, transaction_type);</span>
<span class="nc" id="L2333">						updatePstmt.setLong(3, transaction_id);</span>
<span class="nc" id="L2334">						updatePstmt.setTimestamp(4, transaction_date);</span>
<span class="nc" id="L2335">						updatePstmt.setString(5, amount + &quot;&quot;);</span>
<span class="nc" id="L2336">						updatePstmt.setString(6, acc_type);</span>
<span class="nc" id="L2337">						updatePstmt.setString(7, retailer_org_id_current + &quot;&quot;);</span>
<span class="nc" id="L2338">						updatePstmt.setString(8, orgName);</span>
<span class="nc" id="L2339">						updatePstmt.setString(9, RECEIPT_ID);</span>
<span class="nc" id="L2340">						updatePstmt.execute();</span>

<span class="nc bnc" id="L2342" title="All 2 branches missed.">						if (updatePstmt != null) {</span>
<span class="nc" id="L2343">							updatePstmt.close();</span>
						}

<span class="nc" id="L2346">						query3 = QueryManager.getST2UpadateAgentCurrentBal();</span>
<span class="nc" id="L2347">						updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L2348">						updPstmt.setString(1, retailer_org_id_current + &quot;&quot;);</span>
<span class="nc" id="L2349">						updPstmt.setString(2, acc_type);</span>
<span class="nc" id="L2350">						updPstmt.setInt(3, agent_id);</span>
<span class="nc" id="L2351">						updPstmt.execute();</span>

<span class="nc bnc" id="L2353" title="All 2 branches missed.">						if (updPstmt != null) {</span>
<span class="nc" id="L2354">							updPstmt.close();</span>
						}

<span class="nc" id="L2357">					}</span>

<span class="nc bnc" id="L2359" title="All 10 branches missed.">					else if (transaction_type.equalsIgnoreCase(&quot;pwt&quot;)</span>
							|| transaction_type.equalsIgnoreCase(&quot;pwt_auto&quot;)
							|| transaction_type.equalsIgnoreCase(&quot;DG_PWT&quot;)
							|| transaction_type.equalsIgnoreCase(&quot;DG_PWT_AUTO&quot;)
							|| transaction_type.equalsIgnoreCase(&quot;OLA_WITHDRAWL&quot;)) {
<span class="nc" id="L2364">						int result = 0;</span>
<span class="nc" id="L2365">						String pwtQuery = &quot;&quot;;</span>
<span class="nc bnc" id="L2366" title="All 4 branches missed.">						if (transaction_type.equalsIgnoreCase(&quot;DG_PWT&quot;)</span>
								|| transaction_type
										.equalsIgnoreCase(&quot;DG_PWT_AUTO&quot;)) {
<span class="nc" id="L2369">							pwtQuery = QueryManager.getST2AgentDrGmPwtPay();</span>
<span class="nc bnc" id="L2370" title="All 2 branches missed.">						} else if(transaction_type.equalsIgnoreCase(&quot;OLA_WITHDRAWL&quot;))</span>
						{
<span class="nc" id="L2372">							pwtQuery = QueryManager.getST2AgentOLAWithdrawal();</span>
						}
						else {
<span class="nc" id="L2375">							pwtQuery = QueryManager.getST2AgentPwtPay();</span>
						}
<span class="nc" id="L2377">						stmt2 = connection.prepareStatement(pwtQuery);</span>
<span class="nc" id="L2378">						stmt2.setLong(1, transaction_id);</span>

<span class="nc" id="L2380">						rs2 = stmt2.executeQuery();</span>

<span class="nc bnc" id="L2382" title="All 2 branches missed.">						while (rs2.next()) {</span>
<span class="nc" id="L2383">							amount = rs2.getDouble(&quot;pwt_amount&quot;);</span>
<span class="nc" id="L2384">							pwt_charges_amount = rs2.getDouble(&quot;comm_amount&quot;);</span>
<span class="nc" id="L2385">							transaction_date = rs2</span>
									.getTimestamp(&quot;transaction_date&quot;);
<span class="nc" id="L2387">							acc_type = &quot;&quot; + rs2.getInt(&quot;retailer_org_id&quot;);</span>
<span class="nc" id="L2388">							orgName = rs2.getString(&quot;name&quot;);</span>

<span class="nc" id="L2390">							result++;</span>
						}

<span class="nc bnc" id="L2393" title="All 2 branches missed.">						if (stmt2 != null) {</span>
<span class="nc" id="L2394">							stmt2.close();</span>
						}
<span class="nc bnc" id="L2396" title="All 2 branches missed.">						if (rs2 != null) {</span>
<span class="nc" id="L2397">							rs2.close();</span>
						}

<span class="nc bnc" id="L2400" title="All 2 branches missed.">						if (result != 0) {</span>
<span class="nc" id="L2401">							stmt = connection.prepareStatement(QueryManager</span>
									.getST6AgtCurrBal());
<span class="nc" id="L2403">							stmt.setString(1, acc_type);</span>
<span class="nc" id="L2404">							stmt.setInt(2, agent_id);</span>
<span class="nc" id="L2405">							rs = stmt.executeQuery();</span>
							// This has been changed into Prepared statement and
							// moved to Query manager 10-03-08
							// rs = stmt.executeQuery(&quot;select current_balance
							// from st_lms_agent_current_balance where
							// account_type = '&quot;+ acc_type + &quot;' and agent_id =
							// &quot;+agent_id);
<span class="nc bnc" id="L2412" title="All 2 branches missed.">							while (rs.next()) {</span>
<span class="nc" id="L2413">								retailer_org_id_current = rs</span>
										.getDouble(&quot;current_balance&quot;);
<span class="nc" id="L2415">								retailerPresent++;</span>
							}

<span class="nc bnc" id="L2418" title="All 2 branches missed.">							if (stmt != null) {</span>
<span class="nc" id="L2419">								stmt.close();</span>
							}
<span class="nc bnc" id="L2421" title="All 2 branches missed.">							if (rs != null) {</span>
<span class="nc" id="L2422">								rs.close();</span>
							}

<span class="nc bnc" id="L2425" title="All 2 branches missed.">							if (retailerPresent == 0) {</span>
<span class="nc" id="L2426">								stmt = connection.prepareStatement(QueryManager</span>
										.getST6InsertAgentCurrBal());
<span class="nc" id="L2428">								stmt.setString(1, acc_type);</span>
<span class="nc" id="L2429">								stmt.setDouble(2, 0.0);</span>
<span class="nc" id="L2430">								stmt.setInt(3, agent_id);</span>
<span class="nc" id="L2431">								stmt.execute();</span>
<span class="nc" id="L2432">								retailer_org_id_current = 0.0;</span>

<span class="nc bnc" id="L2434" title="All 2 branches missed.">								if (stmt != null) {</span>
<span class="nc" id="L2435">									stmt.close();</span>
								}

							}
<span class="nc" id="L2439">							retailerPresent = 0;</span>
							try {
<span class="nc" id="L2441">								retailer_org_id_current = getDouble(retailer_org_id_current)</span>
										+ amount;
<span class="nc" id="L2443">								agent_pwt_pay_current = getDouble(agent_pwt_pay_current)</span>
										- amount;

<span class="nc" id="L2446">							} catch (NumberFormatException e) {</span>
<span class="nc" id="L2447">							}</span>
<span class="nc" id="L2448">							logger.debug(&quot;LH-AGT-RET**&quot; + transaction_type</span>
									+ &quot;**TRX_ID-&quot; + transaction_id + &quot;**R_ID-&quot;
									+ RECEIPT_ID);
<span class="nc" id="L2451">							logger.debug(&quot;LH-AGT-RET**&quot; + transaction_date</span>
									+ &quot;**AMT-&quot; + amount + &quot;**ACT_TYPE-&quot;
									+ acc_type + &quot;**RET_ACC-&quot;
									+ retailer_org_id_current + &quot;**AGT_ACC-&quot;
									+ agent_pwt_pay_current);
<span class="nc" id="L2456">							query2 = QueryManager.getST2InsertAgentLedger();</span>
<span class="nc" id="L2457">							upPstmt = connection.prepareStatement(query2);</span>
<span class="nc" id="L2458">							upPstmt.setInt(1, agent_id);</span>
<span class="nc" id="L2459">							upPstmt.setString(2, transaction_type);</span>
<span class="nc" id="L2460">							upPstmt.setLong(3, transaction_id);</span>
<span class="nc" id="L2461">							upPstmt.setTimestamp(4, transaction_date);</span>
<span class="nc" id="L2462">							upPstmt.setString(5, -amount + &quot;&quot;);</span>
<span class="nc" id="L2463">							upPstmt.setString(6, &quot;AGNT_PWT_PAY&quot;);</span>
<span class="nc" id="L2464">							upPstmt.setString(7, agent_pwt_pay_current + &quot;&quot;);</span>
<span class="nc" id="L2465">							upPstmt.setString(8, orgName);</span>
<span class="nc" id="L2466">							upPstmt.setString(9, RECEIPT_ID);</span>
<span class="nc" id="L2467">							upPstmt.execute();</span>

<span class="nc bnc" id="L2469" title="All 2 branches missed.">							if (upPstmt != null) {</span>
<span class="nc" id="L2470">								upPstmt.close();</span>
							}

<span class="nc" id="L2473">							query1 = QueryManager.getST2InsertAgentLedger();</span>
<span class="nc" id="L2474">							updatePstmt = connection.prepareStatement(query1);</span>

<span class="nc" id="L2476">							updatePstmt.setInt(1, agent_id);</span>
<span class="nc" id="L2477">							updatePstmt.setString(2, transaction_type);</span>
<span class="nc" id="L2478">							updatePstmt.setLong(3, transaction_id);</span>
<span class="nc" id="L2479">							updatePstmt.setTimestamp(4, transaction_date);</span>
<span class="nc" id="L2480">							updatePstmt.setString(5, amount + &quot;&quot;);</span>
<span class="nc" id="L2481">							updatePstmt.setString(6, acc_type);</span>
<span class="nc" id="L2482">							updatePstmt.setString(7, retailer_org_id_current</span>
									+ &quot;&quot;);
<span class="nc" id="L2484">							updatePstmt.setString(8, orgName);</span>
<span class="nc" id="L2485">							updatePstmt.setString(9, RECEIPT_ID);</span>
<span class="nc" id="L2486">							updatePstmt.execute();</span>

<span class="nc bnc" id="L2488" title="All 2 branches missed.">							if (updatePstmt != null) {</span>
<span class="nc" id="L2489">								updatePstmt.close();</span>
							}

<span class="nc" id="L2492">							query3 = QueryManager</span>
									.getST2UpadateAgentCurrentBal();
<span class="nc" id="L2494">							updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L2495">							updPstmt.setString(1, retailer_org_id_current + &quot;&quot;);</span>
<span class="nc" id="L2496">							updPstmt.setString(2, acc_type);</span>
<span class="nc" id="L2497">							updPstmt.setInt(3, agent_id);</span>
<span class="nc" id="L2498">							updPstmt.execute();</span>

<span class="nc bnc" id="L2500" title="All 2 branches missed.">							if (updPstmt != null) {</span>
<span class="nc" id="L2501">								updPstmt.close();</span>
							}

							/*
							 * moved below for collection charges query3 =
							 * QueryManager.getST2UpadateAgentCurrentBal();
							 * updPstmt=connection.prepareStatement(query3);
							 * updPstmt.setString(1,
							 * retailer_org_id_current+&quot;&quot;);
							 * updPstmt.setString(2, acc_type);
							 * updPstmt.setInt(3, agent_id); updPstmt.execute();
							 */
							/*
							 * 
							 * for collection charges
							 */
							try {
<span class="nc" id="L2518">								retailer_org_id_current = getDouble(retailer_org_id_current)</span>
										+ pwt_charges_amount;
<span class="nc" id="L2520">								agent_pwt_charges_current = getDouble(agent_pwt_charges_current)</span>
										- pwt_charges_amount;

<span class="nc" id="L2523">							} catch (NumberFormatException e) {</span>
<span class="nc" id="L2524">							}</span>

<span class="nc bnc" id="L2526" title="All 2 branches missed.">							if (pwt_charges_amount != 0.0) {</span>
<span class="nc" id="L2527">								query2 = QueryManager.getST2InsertAgentLedger();</span>
<span class="nc" id="L2528">								upPstmt = connection.prepareStatement(query2);</span>
<span class="nc" id="L2529">								upPstmt.setInt(1, agent_id);</span>
<span class="nc" id="L2530">								upPstmt.setString(2, transaction_type);</span>
<span class="nc" id="L2531">								upPstmt.setLong(3, transaction_id);</span>
<span class="nc" id="L2532">								upPstmt.setTimestamp(4, transaction_date);</span>
<span class="nc" id="L2533">								upPstmt.setString(5, -pwt_charges_amount + &quot;&quot;);</span>
<span class="nc" id="L2534">								upPstmt.setString(6, &quot;AGENT_PWT_CHARGES&quot;);</span>
<span class="nc" id="L2535">								upPstmt.setString(7, agent_pwt_charges_current</span>
										+ &quot;&quot;);
<span class="nc" id="L2537">								upPstmt.setString(8, orgName);</span>
<span class="nc" id="L2538">								upPstmt.setString(9, RECEIPT_ID);</span>
<span class="nc" id="L2539">								upPstmt.execute();</span>

<span class="nc bnc" id="L2541" title="All 2 branches missed.">								if (upPstmt != null) {</span>
<span class="nc" id="L2542">									upPstmt.close();</span>
								}

<span class="nc" id="L2545">								query1 = QueryManager.getST2InsertAgentLedger();</span>
<span class="nc" id="L2546">								updatePstmt = connection</span>
										.prepareStatement(query1);

<span class="nc" id="L2549">								updatePstmt.setInt(1, agent_id);</span>
<span class="nc" id="L2550">								updatePstmt.setString(2, transaction_type);</span>
<span class="nc" id="L2551">								updatePstmt.setLong(3, transaction_id);</span>
<span class="nc" id="L2552">								updatePstmt.setTimestamp(4, transaction_date);</span>
<span class="nc" id="L2553">								updatePstmt.setString(5, pwt_charges_amount</span>
										+ &quot;&quot;);
<span class="nc" id="L2555">								updatePstmt.setString(6, acc_type + &quot;#&quot;);</span>
<span class="nc" id="L2556">								updatePstmt.setString(7,</span>
										retailer_org_id_current + &quot;&quot;);
<span class="nc" id="L2558">								updatePstmt.setString(8, orgName);</span>
<span class="nc" id="L2559">								updatePstmt.setString(9, RECEIPT_ID);</span>
<span class="nc" id="L2560">								updatePstmt.execute();</span>

<span class="nc bnc" id="L2562" title="All 2 branches missed.">								if (updatePstmt != null) {</span>
<span class="nc" id="L2563">									updatePstmt.close();</span>
								}

							}
<span class="nc" id="L2567">							query3 = QueryManager</span>
									.getST2UpadateAgentCurrentBal();
<span class="nc" id="L2569">							updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L2570">							updPstmt.setString(1, retailer_org_id_current + &quot;&quot;);</span>
<span class="nc" id="L2571">							updPstmt.setString(2, acc_type);</span>
<span class="nc" id="L2572">							updPstmt.setInt(3, agent_id);</span>
<span class="nc" id="L2573">							updPstmt.execute();</span>

<span class="nc bnc" id="L2575" title="All 2 branches missed.">							if (updPstmt != null) {</span>
<span class="nc" id="L2576">								updPstmt.close();</span>
							}

						} else {
<span class="nc" id="L2580">							System.out.println(&quot;Error in Transaction at &quot;</span>
									+ transaction_id + &quot; and Transaction_type&quot;
									+ transaction_type);
						}
<span class="nc bnc" id="L2584" title="All 2 branches missed.">					} else if (transaction_type.equalsIgnoreCase(&quot;cash&quot;)) {</span>
<span class="nc" id="L2585">						stmt2 = connection.prepareStatement(QueryManager</span>
								.getST2AgentCash());
<span class="nc" id="L2587">						stmt2.setLong(1, transaction_id);</span>
<span class="nc" id="L2588">						rs2 = stmt2.executeQuery();</span>
						// This has been changed to prepared statement 10-03-08
						// rs2 =
						// stmt2.executeQuery(QueryManager.getST2AgentCash()+&quot;&quot;+
						// transaction_id + &quot;&quot;);
<span class="nc bnc" id="L2593" title="All 2 branches missed.">						while (rs2.next()) {</span>
<span class="nc" id="L2594">							amount = rs2.getDouble(&quot;amount&quot;);</span>
<span class="nc" id="L2595">							transaction_date = rs2</span>
									.getTimestamp(&quot;transaction_date&quot;);
<span class="nc" id="L2597">							acc_type = &quot;&quot; + rs2.getInt(&quot;retailer_org_id&quot;);</span>
<span class="nc" id="L2598">							orgName = rs2.getString(&quot;name&quot;);</span>
						}

<span class="nc bnc" id="L2601" title="All 2 branches missed.">						if (stmt2 != null) {</span>
<span class="nc" id="L2602">							stmt2.close();</span>
						}
<span class="nc bnc" id="L2604" title="All 2 branches missed.">						if (rs2 != null) {</span>
<span class="nc" id="L2605">							rs2.close();</span>
						}

<span class="nc" id="L2608">						stmt = connection.prepareStatement(QueryManager</span>
								.getST6AgtCurrBal());
<span class="nc" id="L2610">						stmt.setString(1, acc_type);</span>
<span class="nc" id="L2611">						stmt.setInt(2, agent_id);</span>
<span class="nc" id="L2612">						rs = stmt.executeQuery();</span>

<span class="nc bnc" id="L2614" title="All 2 branches missed.">						while (rs.next()) {</span>

<span class="nc" id="L2616">							retailer_org_id_current = rs</span>
									.getDouble(&quot;current_balance&quot;);

<span class="nc" id="L2619">							retailerPresent++;</span>
						}

<span class="nc bnc" id="L2622" title="All 2 branches missed.">						if (stmt != null) {</span>
<span class="nc" id="L2623">							stmt.close();</span>
						}
<span class="nc bnc" id="L2625" title="All 2 branches missed.">						if (rs != null) {</span>
<span class="nc" id="L2626">							rs.close();</span>
						}

<span class="nc bnc" id="L2629" title="All 2 branches missed.">						if (retailerPresent == 0) {</span>
<span class="nc" id="L2630">							stmt = connection.prepareStatement(QueryManager</span>
									.getST6InsertAgentCurrBal());
<span class="nc" id="L2632">							stmt.setString(1, acc_type);</span>
<span class="nc" id="L2633">							stmt.setDouble(2, 0.0);</span>
<span class="nc" id="L2634">							stmt.setInt(3, agent_id);</span>
<span class="nc" id="L2635">							stmt.execute();</span>
<span class="nc" id="L2636">							retailer_org_id_current = 0.0;</span>

<span class="nc bnc" id="L2638" title="All 2 branches missed.">							if (stmt != null) {</span>
<span class="nc" id="L2639">								stmt.close();</span>
							}

							// This has been moved into query manager and
							// changed to prepared statement 10-03-08
							// stmt.executeUpdate(&quot;insert into
							// st_lms_agent_current_balance
							// (account_type,current_balance,agent_id) values
							// ('&quot;+acc_type+&quot;',0.0,&quot;+agent_id+&quot;)&quot;);
						}
<span class="nc" id="L2649">						retailerPresent = 0;</span>
<span class="nc" id="L2650">						agent_bank_acc_current = agent_bank_acc_current</span>
								- amount;
<span class="nc" id="L2652">						retailer_org_id_current = retailer_org_id_current</span>
								+ amount;
<span class="nc" id="L2654">						logger.debug(&quot;LH-AGT-RET**&quot; + transaction_type</span>
								+ &quot;**TRX_ID-&quot; + transaction_id + &quot;**R_ID-&quot;
								+ RECEIPT_ID);
<span class="nc" id="L2657">						logger.debug(&quot;LH-AGT-RET**&quot; + transaction_date</span>
								+ &quot;**AMT-&quot; + amount + &quot;**ACT_TYPE-&quot; + acc_type
								+ &quot;**RET_ACC-&quot; + retailer_org_id_current
								+ &quot;**AGT_ACC-&quot; + agent_bank_acc_current);
<span class="nc" id="L2661">						query2 = QueryManager.getST2InsertAgentLedger();</span>
<span class="nc" id="L2662">						upPstmt = connection.prepareStatement(query2);</span>
<span class="nc" id="L2663">						upPstmt.setInt(1, agent_id);</span>
<span class="nc" id="L2664">						upPstmt.setString(2, transaction_type);</span>
<span class="nc" id="L2665">						upPstmt.setLong(3, transaction_id);</span>
<span class="nc" id="L2666">						upPstmt.setTimestamp(4, transaction_date);</span>
<span class="nc" id="L2667">						upPstmt.setString(5, -amount + &quot;&quot;);</span>
<span class="nc" id="L2668">						upPstmt.setString(6, &quot;AGNT_BANK_ACC&quot;);</span>
<span class="nc" id="L2669">						upPstmt.setString(7, agent_bank_acc_current + &quot;&quot;);</span>
<span class="nc" id="L2670">						upPstmt.setString(8, orgName);</span>
<span class="nc" id="L2671">						upPstmt.setString(9, RECEIPT_ID);</span>
<span class="nc" id="L2672">						upPstmt.execute();</span>

<span class="nc bnc" id="L2674" title="All 2 branches missed.">						if (upPstmt != null) {</span>
<span class="nc" id="L2675">							upPstmt.close();</span>
						}

<span class="nc" id="L2678">						query1 = QueryManager.getST2InsertAgentLedger();</span>
<span class="nc" id="L2679">						updatePstmt = connection.prepareStatement(query1);</span>

<span class="nc" id="L2681">						updatePstmt.setInt(1, agent_id);</span>
<span class="nc" id="L2682">						updatePstmt.setString(2, transaction_type);</span>
<span class="nc" id="L2683">						updatePstmt.setLong(3, transaction_id);</span>
<span class="nc" id="L2684">						updatePstmt.setTimestamp(4, transaction_date);</span>
<span class="nc" id="L2685">						updatePstmt.setString(5, amount + &quot;&quot;);</span>
<span class="nc" id="L2686">						updatePstmt.setString(6, acc_type);</span>
<span class="nc" id="L2687">						updatePstmt.setString(7, retailer_org_id_current + &quot;&quot;);</span>
<span class="nc" id="L2688">						updatePstmt.setString(8, orgName);</span>
<span class="nc" id="L2689">						updatePstmt.setString(9, RECEIPT_ID);</span>
<span class="nc" id="L2690">						updatePstmt.execute();</span>

<span class="nc bnc" id="L2692" title="All 2 branches missed.">						if (updatePstmt != null) {</span>
<span class="nc" id="L2693">							updatePstmt.close();</span>
						}

<span class="nc" id="L2696">						query3 = QueryManager.getST2UpadateAgentCurrentBal();</span>
<span class="nc" id="L2697">						updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L2698">						updPstmt.setString(1, retailer_org_id_current + &quot;&quot;);</span>
<span class="nc" id="L2699">						updPstmt.setString(2, acc_type);</span>
<span class="nc" id="L2700">						updPstmt.setInt(3, agent_id);</span>
<span class="nc" id="L2701">						updPstmt.execute();</span>

<span class="nc bnc" id="L2703" title="All 2 branches missed.">						if (updPstmt != null) {</span>
<span class="nc" id="L2704">							updPstmt.close();</span>
						}

<span class="nc bnc" id="L2707" title="All 2 branches missed.">					}else if (transaction_type.equalsIgnoreCase(&quot;OLA_COMMISSION&quot;)) {</span>
<span class="nc" id="L2708">						stmt2 = connection.prepareStatement(QueryManager</span>
								.getST2AgentOlaCommission());
<span class="nc" id="L2710">						stmt2.setLong(1, transaction_id);</span>
<span class="nc" id="L2711">						rs2 = stmt2.executeQuery();</span>
						// This has been changed to prepared statement 10-03-08
						// rs2 =
						// stmt2.executeQuery(QueryManager.getST2AgentCash()+&quot;&quot;+
						// transaction_id + &quot;&quot;);
<span class="nc bnc" id="L2716" title="All 2 branches missed.">						while (rs2.next()) {</span>
<span class="nc" id="L2717">							amount = rs2.getDouble(&quot;amount&quot;);</span>
<span class="nc" id="L2718">							transaction_date = rs2</span>
									.getTimestamp(&quot;transaction_date&quot;);
<span class="nc" id="L2720">							acc_type = &quot;&quot; + rs2.getInt(&quot;retailer_org_id&quot;);</span>
<span class="nc" id="L2721">							orgName = rs2.getString(&quot;name&quot;);</span>
						}

<span class="nc bnc" id="L2724" title="All 2 branches missed.">						if (stmt2 != null) {</span>
<span class="nc" id="L2725">							stmt2.close();</span>
						}
<span class="nc bnc" id="L2727" title="All 2 branches missed.">						if (rs2 != null) {</span>
<span class="nc" id="L2728">							rs2.close();</span>
						}

<span class="nc" id="L2731">						stmt = connection.prepareStatement(QueryManager</span>
								.getST6AgtCurrBal());
<span class="nc" id="L2733">						stmt.setString(1, acc_type);</span>
<span class="nc" id="L2734">						stmt.setInt(2, agent_id);</span>
<span class="nc" id="L2735">						rs = stmt.executeQuery();</span>

<span class="nc bnc" id="L2737" title="All 2 branches missed.">						while (rs.next()) {</span>

<span class="nc" id="L2739">							retailer_org_id_current = rs</span>
									.getDouble(&quot;current_balance&quot;);

<span class="nc" id="L2742">							retailerPresent++;</span>
						}

<span class="nc bnc" id="L2745" title="All 2 branches missed.">						if (stmt != null) {</span>
<span class="nc" id="L2746">							stmt.close();</span>
						}
<span class="nc bnc" id="L2748" title="All 2 branches missed.">						if (rs != null) {</span>
<span class="nc" id="L2749">							rs.close();</span>
						}

<span class="nc bnc" id="L2752" title="All 2 branches missed.">						if (retailerPresent == 0) {</span>
<span class="nc" id="L2753">							stmt = connection.prepareStatement(QueryManager</span>
									.getST6InsertAgentCurrBal());
<span class="nc" id="L2755">							stmt.setString(1, acc_type);</span>
<span class="nc" id="L2756">							stmt.setDouble(2, 0.0);</span>
<span class="nc" id="L2757">							stmt.setInt(3, agent_id);</span>
<span class="nc" id="L2758">							stmt.execute();</span>
<span class="nc" id="L2759">							retailer_org_id_current = 0.0;</span>

<span class="nc bnc" id="L2761" title="All 2 branches missed.">							if (stmt != null) {</span>
<span class="nc" id="L2762">								stmt.close();</span>
							}

							// This has been moved into query manager and
							// changed to prepared statement 10-03-08
							// stmt.executeUpdate(&quot;insert into
							// st_lms_agent_current_balance
							// (account_type,current_balance,agent_id) values
							// ('&quot;+acc_type+&quot;',0.0,&quot;+agent_id+&quot;)&quot;);
						}
<span class="nc" id="L2772">						retailerPresent = 0;</span>
<span class="nc" id="L2773">						agent_bank_acc_current = agent_bank_acc_current</span>
								- amount;
<span class="nc" id="L2775">						retailer_org_id_current = retailer_org_id_current</span>
								+ amount;
<span class="nc" id="L2777">						logger.debug(&quot;LH-AGT-RET**&quot; + transaction_type</span>
								+ &quot;**TRX_ID-&quot; + transaction_id + &quot;**R_ID-&quot;
								+ RECEIPT_ID);
<span class="nc" id="L2780">						logger.debug(&quot;LH-AGT-RET**&quot; + transaction_date</span>
								+ &quot;**AMT-&quot; + amount + &quot;**ACT_TYPE-&quot; + acc_type
								+ &quot;**RET_ACC-&quot; + retailer_org_id_current
								+ &quot;**AGT_ACC-&quot; + agent_bank_acc_current);
<span class="nc" id="L2784">						query2 = QueryManager.getST2InsertAgentLedger();</span>
<span class="nc" id="L2785">						upPstmt = connection.prepareStatement(query2);</span>
<span class="nc" id="L2786">						upPstmt.setInt(1, agent_id);</span>
<span class="nc" id="L2787">						upPstmt.setString(2, transaction_type);</span>
<span class="nc" id="L2788">						upPstmt.setLong(3, transaction_id);</span>
<span class="nc" id="L2789">						upPstmt.setTimestamp(4, transaction_date);</span>
<span class="nc" id="L2790">						upPstmt.setString(5, -amount + &quot;&quot;);</span>
<span class="nc" id="L2791">						upPstmt.setString(6, &quot;AGNT_BANK_ACC&quot;);</span>
<span class="nc" id="L2792">						upPstmt.setString(7, agent_bank_acc_current + &quot;&quot;);</span>
<span class="nc" id="L2793">						upPstmt.setString(8, orgName);</span>
<span class="nc" id="L2794">						upPstmt.setString(9, RECEIPT_ID);</span>
<span class="nc" id="L2795">						upPstmt.execute();</span>

<span class="nc bnc" id="L2797" title="All 2 branches missed.">						if (upPstmt != null) {</span>
<span class="nc" id="L2798">							upPstmt.close();</span>
						}

<span class="nc" id="L2801">						query1 = QueryManager.getST2InsertAgentLedger();</span>
<span class="nc" id="L2802">						updatePstmt = connection.prepareStatement(query1);</span>

<span class="nc" id="L2804">						updatePstmt.setInt(1, agent_id);</span>
<span class="nc" id="L2805">						updatePstmt.setString(2, transaction_type);</span>
<span class="nc" id="L2806">						updatePstmt.setLong(3, transaction_id);</span>
<span class="nc" id="L2807">						updatePstmt.setTimestamp(4, transaction_date);</span>
<span class="nc" id="L2808">						updatePstmt.setString(5, amount + &quot;&quot;);</span>
<span class="nc" id="L2809">						updatePstmt.setString(6, acc_type);</span>
<span class="nc" id="L2810">						updatePstmt.setString(7, retailer_org_id_current + &quot;&quot;);</span>
<span class="nc" id="L2811">						updatePstmt.setString(8, orgName);</span>
<span class="nc" id="L2812">						updatePstmt.setString(9, RECEIPT_ID);</span>
<span class="nc" id="L2813">						updatePstmt.execute();</span>

<span class="nc bnc" id="L2815" title="All 2 branches missed.">						if (updatePstmt != null) {</span>
<span class="nc" id="L2816">							updatePstmt.close();</span>
						}

<span class="nc" id="L2819">						query3 = QueryManager.getST2UpadateAgentCurrentBal();</span>
<span class="nc" id="L2820">						updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L2821">						updPstmt.setString(1, retailer_org_id_current + &quot;&quot;);</span>
<span class="nc" id="L2822">						updPstmt.setString(2, acc_type);</span>
<span class="nc" id="L2823">						updPstmt.setInt(3, agent_id);</span>
<span class="nc" id="L2824">						updPstmt.execute();</span>

<span class="nc bnc" id="L2826" title="All 2 branches missed.">						if (updPstmt != null) {</span>
<span class="nc" id="L2827">							updPstmt.close();</span>
						}

					} 
<span class="nc bnc" id="L2831" title="All 4 branches missed.">					else if (transaction_type.equalsIgnoreCase(&quot;pwt_plr&quot;)</span>
							|| transaction_type.equalsIgnoreCase(&quot;dg_pwt_plr&quot;)) {

<span class="nc" id="L2834">						double PWT_AMT = 0;</span>
<span class="nc" id="L2835">						double TAX_AMT = 0;</span>
<span class="nc" id="L2836">						double NET_AMT = 0;</span>
<span class="nc" id="L2837">						String directPwtPlrQry = &quot;&quot;;</span>
<span class="nc bnc" id="L2838" title="All 2 branches missed.">						if (transaction_type.equalsIgnoreCase(&quot;dg_pwt_plr&quot;)) {</span>
<span class="nc" id="L2839">							directPwtPlrQry = QueryManager</span>
									.getST2AgentDGPwtPlr();
						} else {
<span class="nc" id="L2842">							directPwtPlrQry = QueryManager.getST2AgentPwtPlr();</span>
						}
<span class="nc" id="L2844">						stmt = connection.prepareStatement(directPwtPlrQry);</span>
<span class="nc" id="L2845">						stmt.setLong(1, transaction_id);</span>
<span class="nc" id="L2846">						rs = stmt.executeQuery();</span>
						// This has been replaced by the obove prepared
						// statements statements 07-03-08
						// rs =
						// stmt.executeQuery(QueryManager.getST2BoPwtPlr()+&quot;&quot;+
						// transaction_id + &quot;&quot;);
<span class="nc bnc" id="L2852" title="All 2 branches missed.">						while (rs.next()) {</span>
<span class="nc" id="L2853">							PWT_AMT = rs.getDouble(&quot;pwt_amt&quot;);</span>
<span class="nc" id="L2854">							TAX_AMT = rs.getDouble(&quot;tax_amt&quot;);</span>
<span class="nc" id="L2855">							NET_AMT = rs.getDouble(&quot;net_amt&quot;);</span>
<span class="nc" id="L2856">							transaction_type = rs.getString(&quot;transaction_type&quot;);</span>
							// TRANSACTION_DATE =
							// rs.getDate(&quot;transaction_date&quot;);
<span class="nc" id="L2859">							transaction_date = rs</span>
									.getTimestamp(&quot;transaction_date&quot;);
<span class="nc" id="L2861">							orgName = rs.getString(&quot;first_name&quot;);</span>
						}

<span class="nc bnc" id="L2864" title="All 2 branches missed.">						if (rs != null) {</span>
<span class="nc" id="L2865">							rs.close();</span>
						}

<span class="nc" id="L2868">						PLAYER_PWT_CURRENT = PLAYER_PWT_CURRENT + PWT_AMT;</span>
<span class="nc" id="L2869">						agent_pwt_pay_current = agent_pwt_pay_current - PWT_AMT;</span>
<span class="nc" id="L2870">						PLAYER_TDS_CURRENT = PLAYER_TDS_CURRENT - TAX_AMT;</span>
<span class="nc" id="L2871">						TDS_PAY_CURRENT = TDS_PAY_CURRENT + TAX_AMT;</span>
<span class="nc" id="L2872">						agent_bank_acc_current = agent_bank_acc_current</span>
								+ NET_AMT;
<span class="nc" id="L2874">						PLAYER_CASH_CURRENT = PLAYER_CASH_CURRENT - NET_AMT;</span>

<span class="nc" id="L2876">						stmt</span>
								.executeUpdate(&quot;insert into st_lms_agent_ledger (agent_org_id,transaction_type, transaction_id,transaction_date,amount,account_type,balance,transaction_with,receipt_id) values ('&quot;
										+ agent_id
										+ &quot;','&quot;
										+ transaction_type
										+ &quot;',&quot;
										+ transaction_id
										+ &quot;,'&quot;
										+ transaction_date
										+ &quot;',&quot;
										+ (-PWT_AMT + &quot;&quot;)
										+ &quot;,'AGNT_PWT_PAY',&quot;
										+ FormatNumber
												.formatNumber(agent_pwt_pay_current)
										+ &quot;, '&quot;
										+ orgName
										+ &quot;','&quot;
										+ RECEIPT_ID
										+ &quot;')&quot;);

<span class="nc" id="L2896">						stmt</span>
								.executeUpdate(&quot;insert into st_lms_agent_ledger (agent_org_id,transaction_type, transaction_id,transaction_date,amount,account_type,balance,transaction_with,receipt_id) values ('&quot;
										+ agent_id
										+ &quot;','&quot;
										+ transaction_type
										+ &quot;',&quot;
										+ transaction_id
										+ &quot;,'&quot;
										+ transaction_date
										+ &quot;',&quot;
										+ FormatNumber.formatNumber(PWT_AMT)
										+ &quot;,'AGNT_PLAYER_PWT',&quot;
										+ FormatNumber
												.formatNumber(PLAYER_PWT_CURRENT)
										+ &quot;, '&quot;
										+ orgName
										+ &quot;','&quot;
										+ RECEIPT_ID
										+ &quot;')&quot;);

<span class="nc" id="L2916">						stmt</span>
								.executeUpdate(&quot;insert into st_lms_agent_ledger (agent_org_id,transaction_type, transaction_id,transaction_date,amount,account_type,balance,transaction_with,receipt_id) values ('&quot;
										+ agent_id
										+ &quot;','&quot;
										+ transaction_type
										+ &quot;',&quot;
										+ transaction_id
										+ &quot;,'&quot;
										+ transaction_date
										+ &quot;',&quot;
										+ (-TAX_AMT + &quot;&quot;)
										+ &quot;,'AGNT_PLAYER_TDS',&quot;
										+ FormatNumber
												.formatNumber(PLAYER_TDS_CURRENT)
										+ &quot;, '&quot;
										+ orgName
										+ &quot;','&quot;
										+ RECEIPT_ID
										+ &quot;')&quot;);
<span class="nc" id="L2935">						stmt</span>
								.executeUpdate(&quot;insert into st_lms_agent_ledger (agent_org_id,transaction_type, transaction_id,transaction_date,amount,account_type,balance,transaction_with,receipt_id) values ('&quot;
										+ agent_id
										+ &quot;','&quot;
										+ transaction_type
										+ &quot;',&quot;
										+ transaction_id
										+ &quot;,'&quot;
										+ transaction_date
										+ &quot;',&quot;
										+ TAX_AMT
										+ &quot;&quot;
										+ &quot;,'AGNT_TDS_PAY',&quot;
										+ FormatNumber
												.formatNumber(TDS_PAY_CURRENT)
										+ &quot;, '&quot;
										+ orgName
										+ &quot;','&quot;
										+ RECEIPT_ID
										+ &quot;' )&quot;);

<span class="nc" id="L2956">						stmt</span>
								.executeUpdate(&quot;insert into st_lms_agent_ledger (agent_org_id,transaction_type, transaction_id,transaction_date,amount,account_type,balance,transaction_with,receipt_id) values ('&quot;
										+ agent_id
										+ &quot;','&quot;
										+ transaction_type
										+ &quot;',&quot;
										+ transaction_id
										+ &quot;,'&quot;
										+ transaction_date
										+ &quot;',&quot;
										+ (-NET_AMT + &quot;&quot;)
										+ &quot;,'AGNT_PLAYER_CAS',&quot;
										+ FormatNumber
												.formatNumber(PLAYER_CASH_CURRENT)
										+ &quot;, '&quot;
										+ orgName
										+ &quot;','&quot;
										+ RECEIPT_ID
										+ &quot;' )&quot;);

<span class="nc" id="L2976">						stmt</span>
								.executeUpdate(&quot;insert into st_lms_agent_ledger (agent_org_id,transaction_type, transaction_id,transaction_date,amount,account_type,balance,transaction_with,receipt_id) values ('&quot;
										+ agent_id
										+ &quot;','&quot;
										+ transaction_type
										+ &quot;',&quot;
										+ transaction_id
										+ &quot;,'&quot;
										+ transaction_date
										+ &quot;',&quot;
										+ FormatNumber.formatNumber(NET_AMT)
										+ &quot;,'AGNT_BANK_ACC',&quot;
										+ FormatNumber
												.formatNumber(agent_bank_acc_current)
										+ &quot;, '&quot;
										+ orgName
										+ &quot;','&quot;
										+ RECEIPT_ID
										+ &quot;' )&quot;);

<span class="nc bnc" id="L2996" title="All 2 branches missed.">						if (stmt != null) {</span>
<span class="nc" id="L2997">							stmt.close();</span>
						}

					}

<span class="nc" id="L3002">					query3 = QueryManager.getST2UpadateAgentCurrentBal();</span>
<span class="nc" id="L3003">					updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L3004">					updPstmt.setString(1, agent_bank_acc_current + &quot;&quot;);</span>
<span class="nc" id="L3005">					updPstmt.setString(2, &quot;AGNT_BANK_ACC&quot;);</span>
<span class="nc" id="L3006">					updPstmt.setInt(3, agent_id);</span>
<span class="nc" id="L3007">					updPstmt.execute();</span>

<span class="nc bnc" id="L3009" title="All 2 branches missed.">					if (updPstmt != null) {</span>
<span class="nc" id="L3010">						updPstmt.close();</span>
					}

<span class="nc" id="L3013">					query3 = QueryManager.getST2UpadateAgentCurrentBal();</span>
<span class="nc" id="L3014">					updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L3015">					updPstmt.setString(1, agnt_sale_acc_current + &quot;&quot;);</span>
<span class="nc" id="L3016">					updPstmt.setString(2, &quot;AGNT_SALE_ACC&quot;);</span>
<span class="nc" id="L3017">					updPstmt.setInt(3, agent_id);</span>
<span class="nc" id="L3018">					updPstmt.execute();</span>

<span class="nc bnc" id="L3020" title="All 2 branches missed.">					if (updPstmt != null) {</span>
<span class="nc" id="L3021">						updPstmt.close();</span>
					}

<span class="nc" id="L3024">					query3 = QueryManager.getST2UpadateAgentCurrentBal();</span>
<span class="nc" id="L3025">					updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L3026">					updPstmt.setString(1, agnt_sale_ret_current + &quot;&quot;);</span>
<span class="nc" id="L3027">					updPstmt.setString(2, &quot;AGNT_SALE_RET&quot;);</span>
<span class="nc" id="L3028">					updPstmt.setInt(3, agent_id);</span>
<span class="nc" id="L3029">					updPstmt.execute();</span>

<span class="nc bnc" id="L3031" title="All 2 branches missed.">					if (updPstmt != null) {</span>
<span class="nc" id="L3032">						updPstmt.close();</span>
					}

<span class="nc" id="L3035">					query3 = QueryManager.getST2UpadateAgentCurrentBal();</span>
<span class="nc" id="L3036">					updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L3037">					updPstmt.setString(1, agent_pwt_pay_current + &quot;&quot;);</span>
<span class="nc" id="L3038">					updPstmt.setString(2, &quot;AGNT_PWT_PAY&quot;);</span>
<span class="nc" id="L3039">					updPstmt.setInt(3, agent_id);</span>
<span class="nc" id="L3040">					updPstmt.execute();</span>

<span class="nc bnc" id="L3042" title="All 2 branches missed.">					if (updPstmt != null) {</span>
<span class="nc" id="L3043">						updPstmt.close();</span>
					}

					/*
					 * for collection charges
					 */
<span class="nc" id="L3049">					query3 = QueryManager.getST2UpadateAgentCurrentBal();</span>
<span class="nc" id="L3050">					updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L3051">					updPstmt.setString(1, agent_pwt_charges_current + &quot;&quot;);</span>
<span class="nc" id="L3052">					updPstmt.setString(2, &quot;AGENT_PWT_CHARGES&quot;);</span>
<span class="nc" id="L3053">					updPstmt.setInt(3, agent_id);</span>
<span class="nc" id="L3054">					updPstmt.execute();</span>

<span class="nc bnc" id="L3056" title="All 2 branches missed.">					if (updPstmt != null) {</span>
<span class="nc" id="L3057">						updPstmt.close();</span>
					}

					/*
					 * for vat payable
					 */

<span class="nc" id="L3064">					query3 = QueryManager.getST2UpadateAgentCurrentBal();</span>
<span class="nc" id="L3065">					updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L3066">					updPstmt.setString(1, agent_vat_pay_current + &quot;&quot;);</span>
<span class="nc" id="L3067">					updPstmt.setString(2, &quot;AGENT_VAT_PAY&quot;);</span>
<span class="nc" id="L3068">					updPstmt.setInt(3, agent_id);</span>
<span class="nc" id="L3069">					updPstmt.execute();</span>

<span class="nc bnc" id="L3071" title="All 2 branches missed.">					if (updPstmt != null) {</span>
<span class="nc" id="L3072">						updPstmt.close();</span>
					}

<span class="nc" id="L3075">					query3 = QueryManager.getST2UpadateAgentCurrentBal();</span>
<span class="nc" id="L3076">					updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L3077">					updPstmt.setString(1, PLAYER_PWT_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L3078">					updPstmt.setString(2, &quot;AGNT_PLAYER_PWT&quot;);</span>
<span class="nc" id="L3079">					updPstmt.setInt(3, agent_id);</span>
<span class="nc" id="L3080">					updPstmt.execute();</span>

<span class="nc bnc" id="L3082" title="All 2 branches missed.">					if (updPstmt != null) {</span>
<span class="nc" id="L3083">						updPstmt.close();</span>
					}

<span class="nc" id="L3086">					query3 = QueryManager.getST2UpadateAgentCurrentBal();</span>
<span class="nc" id="L3087">					updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L3088">					updPstmt.setString(1, PLAYER_TDS_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L3089">					updPstmt.setString(2, &quot;AGNT_PLAYER_TDS&quot;);</span>
<span class="nc" id="L3090">					updPstmt.setInt(3, agent_id);</span>
<span class="nc" id="L3091">					updPstmt.execute();</span>

<span class="nc bnc" id="L3093" title="All 2 branches missed.">					if (updPstmt != null) {</span>
<span class="nc" id="L3094">						updPstmt.close();</span>
					}

<span class="nc" id="L3097">					query3 = QueryManager.getST2UpadateAgentCurrentBal();</span>
<span class="nc" id="L3098">					updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L3099">					updPstmt.setString(1, TDS_PAY_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L3100">					updPstmt.setString(2, &quot;AGNT_TDS_PAY&quot;);</span>
<span class="nc" id="L3101">					updPstmt.setInt(3, agent_id);</span>
<span class="nc" id="L3102">					updPstmt.execute();</span>

<span class="nc bnc" id="L3104" title="All 2 branches missed.">					if (updPstmt != null) {</span>
<span class="nc" id="L3105">						updPstmt.close();</span>
					}

<span class="nc" id="L3108">					query3 = QueryManager.getST2UpadateAgentCurrentBal();</span>
<span class="nc" id="L3109">					updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L3110">					updPstmt.setString(1, PLAYER_CASH_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L3111">					updPstmt.setString(2, &quot;AGNT_PLAYER_CAS&quot;);</span>
<span class="nc" id="L3112">					updPstmt.setInt(3, agent_id);</span>
<span class="nc" id="L3113">					updPstmt.execute();</span>

<span class="nc bnc" id="L3115" title="All 2 branches missed.">					if (updPstmt != null) {</span>
<span class="nc" id="L3116">						updPstmt.close();</span>
					}

<span class="nc" id="L3119">				}</span>

<span class="nc bnc" id="L3121" title="All 2 branches missed.">				if (stmt1 != null) {</span>
<span class="nc" id="L3122">					stmt1.close();</span>
				}
<span class="nc bnc" id="L3124" title="All 2 branches missed.">				if (rs1 != null) {</span>
<span class="nc" id="L3125">					rs1.close();</span>
				}

				// ///////////////////////////////////////////Agent Retailer
				// Transaction
				// End////////////////////////////////////////////////////////////////////
				// This is the end of Retailer and Agent Ledger entry Part

<span class="nc" id="L3133">				query3 = QueryManager.getST2UpadateAgentCurrentBal();</span>
<span class="nc" id="L3134">				updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L3135">				updPstmt.setString(1, bo_bank_acc_current + &quot;&quot;);</span>
<span class="nc" id="L3136">				updPstmt.setString(2, &quot;BO_BANK_ACC&quot;);</span>
<span class="nc" id="L3137">				updPstmt.setInt(3, agent_id);</span>
<span class="nc" id="L3138">				updPstmt.execute();</span>

<span class="nc bnc" id="L3140" title="All 2 branches missed.">				if (updPstmt != null) {</span>
<span class="nc" id="L3141">					updPstmt.close();</span>
				}

<span class="nc" id="L3144">				query3 = QueryManager.getST2UpadateAgentCurrentBal();</span>
<span class="nc" id="L3145">				updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L3146">				updPstmt.setString(1, bo_sale_acc_current + &quot;&quot;);</span>
<span class="nc" id="L3147">				updPstmt.setString(2, &quot;BO_SALE_ACC&quot;);</span>
<span class="nc" id="L3148">				updPstmt.setInt(3, agent_id);</span>
<span class="nc" id="L3149">				updPstmt.execute();</span>

<span class="nc bnc" id="L3151" title="All 2 branches missed.">				if (updPstmt != null) {</span>
<span class="nc" id="L3152">					updPstmt.close();</span>
				}

<span class="nc" id="L3155">				query3 = QueryManager.getST2UpadateAgentCurrentBal();</span>
<span class="nc" id="L3156">				updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L3157">				updPstmt.setString(1, bo_sale_ret_current + &quot;&quot;);</span>
<span class="nc" id="L3158">				updPstmt.setString(2, &quot;BO_SALE_RET&quot;);</span>
<span class="nc" id="L3159">				updPstmt.setInt(3, agent_id);</span>
<span class="nc" id="L3160">				updPstmt.execute();</span>

<span class="nc bnc" id="L3162" title="All 2 branches missed.">				if (updPstmt != null) {</span>
<span class="nc" id="L3163">					updPstmt.close();</span>
				}

<span class="nc" id="L3166">				query3 = QueryManager.getST2UpadateAgentCurrentBal();</span>
<span class="nc" id="L3167">				updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L3168">				updPstmt.setString(1, bo_pwt_pay_current + &quot;&quot;);</span>
<span class="nc" id="L3169">				updPstmt.setString(2, &quot;BO_PWT_PAY&quot;);</span>
<span class="nc" id="L3170">				updPstmt.setInt(3, agent_id);</span>
<span class="nc" id="L3171">				updPstmt.execute();</span>

<span class="nc bnc" id="L3173" title="All 2 branches missed.">				if (updPstmt != null) {</span>
<span class="nc" id="L3174">					updPstmt.close();</span>
				}

<span class="nc" id="L3177">				query3 = QueryManager.getST2UpadateAgentCurrentBal();</span>
<span class="nc" id="L3178">				updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L3179">				updPstmt.setString(1, bo_pwt_charges_current + &quot;&quot;);</span>
<span class="nc" id="L3180">				updPstmt.setString(2, &quot;BO_PWT_CHARGES&quot;);</span>
<span class="nc" id="L3181">				updPstmt.setInt(3, agent_id);</span>
<span class="nc" id="L3182">				updPstmt.execute();</span>

<span class="nc bnc" id="L3184" title="All 2 branches missed.">				if (updPstmt != null) {</span>
<span class="nc" id="L3185">					updPstmt.close();</span>
				}

				// END OF BO AND AGENT LEDGER TRANSACTION
<span class="nc" id="L3189">				insBalHistory(&quot;agent&quot;, connection, toDate_Bean);</span>
			} // END OF IF STATEMENT

<span class="nc" id="L3192">			connection.commit();</span>
<span class="nc" id="L3193">		} catch (SQLException e) {</span>

			try {
<span class="nc" id="L3196">				System.out.println(&quot;In agent Exception &quot; + e);</span>
<span class="nc" id="L3197">				e.printStackTrace();</span>
<span class="nc" id="L3198">				connection.rollback();</span>
<span class="nc" id="L3199">			} catch (SQLException e1) {</span>
				// TODO Auto-generated catch block
<span class="nc" id="L3201">				e1.printStackTrace();</span>
<span class="nc" id="L3202">			}</span>
		}

		finally {
<span class="nc bnc" id="L3206" title="All 6 branches missed.">			if (connection != null) {</span>
				try {

<span class="nc" id="L3209">					connection.close();</span>
<span class="nc" id="L3210">				} catch (SQLException e) {</span>
					// TODO Auto-generated catch block
<span class="nc" id="L3212">					e.printStackTrace();</span>
<span class="nc" id="L3213">				}</span>
			}
		}
<span class="nc" id="L3216">	}</span>

	public void ledgerBoEntry(Timestamp toDate_Bean) throws LMSException {

		try {

<span class="nc" id="L3222">			connection = DBConnect.getConnection();</span>
<span class="nc" id="L3223">			connection.setAutoCommit(false);</span>
<span class="nc" id="L3224">			present_date = toDate_Bean;</span>
<span class="nc" id="L3225">			toDate_Bean = new Timestamp(present_date.getTime() + 24 * 60 * 60</span>
					* 1000 - 1000);
<span class="nc" id="L3227">			to_Date = toDate_Bean;</span>
<span class="nc" id="L3228">			String rcptQry = &quot;select sbr.receipt_id,sbr.generated_id from st_lms_bo_receipts_trn_mapping sbrtm , st_lms_bo_receipts sbr where transaction_id=? and sbrtm.receipt_id=sbr.receipt_id&quot;;</span>

<span class="nc" id="L3230">			logger.debug(&quot;LH-BO**PresentDate-&quot; + present_date + &quot;**ToDate-&quot;</span>
					+ toDate_Bean);
<span class="nc bnc" id="L3232" title="All 2 branches missed.">			if (present_date.before(to_Date)) {</span>

<span class="nc" id="L3234">				int resultQuery = 0;</span>
<span class="nc" id="L3235">				statement = connection.createStatement();</span>
<span class="nc" id="L3236">				rs = statement.executeQuery(QueryManager.getST2BoCurrentBal());</span>

<span class="nc bnc" id="L3238" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc bnc" id="L3239" title="All 2 branches missed.">					if (rs.getString(&quot;account_type&quot;).equals(&quot;TDS_PAY&quot;)) {</span>
<span class="nc" id="L3240">						TDS_PAY_CURRENT = rs.getDouble(&quot;current_balance&quot;);</span>
<span class="nc bnc" id="L3241" title="All 2 branches missed.">					} else if (rs.getString(&quot;account_type&quot;).equals(&quot;SALE_ACC&quot;)) {</span>
<span class="nc" id="L3242">						SALE_ACC_CURRENT = rs.getDouble(&quot;current_balance&quot;);</span>
<span class="nc bnc" id="L3243" title="All 2 branches missed.">					} else if (rs.getString(&quot;account_type&quot;).equals(&quot;SALE_RET&quot;)) {</span>
<span class="nc" id="L3244">						SALE_RET_CURRENT = rs.getDouble(&quot;current_balance&quot;);</span>
<span class="nc bnc" id="L3245" title="All 2 branches missed.">					} else if (rs.getString(&quot;account_type&quot;).equals(&quot;PWT_PAY&quot;)) {</span>
<span class="nc" id="L3246">						PWT_PAY_CURRENT = rs.getDouble(&quot;current_balance&quot;);</span>
<span class="nc bnc" id="L3247" title="All 2 branches missed.">					} else if (rs.getString(&quot;account_type&quot;)</span>
							.equals(&quot;UNCLM_GOVT&quot;)) {
<span class="nc" id="L3249">						UNCLM_GOVT_CURRENT = rs.getDouble(&quot;current_balance&quot;);</span>
<span class="nc bnc" id="L3250" title="All 2 branches missed.">					} else if (rs.getString(&quot;account_type&quot;).equals(&quot;GOVT_COMM&quot;)) {</span>
<span class="nc" id="L3251">						GOVT_COMM_CURRENT = rs.getDouble(&quot;current_balance&quot;);</span>
<span class="nc bnc" id="L3252" title="All 2 branches missed.">					} else if (rs.getString(&quot;account_type&quot;).equals(&quot;BANK_ACC&quot;)) {</span>
<span class="nc" id="L3253">						BANK_ACC_CURRENT = rs.getDouble(&quot;current_balance&quot;);</span>
<span class="nc bnc" id="L3254" title="All 2 branches missed.">					} else if (rs.getString(&quot;account_type&quot;)</span>
							.equals(&quot;PLAYER_TDS&quot;)) {
<span class="nc" id="L3256">						PLAYER_TDS_CURRENT = rs.getDouble(&quot;current_balance&quot;);</span>
<span class="nc bnc" id="L3257" title="All 2 branches missed.">					} else if (rs.getString(&quot;account_type&quot;)</span>
							.equals(&quot;PLAYER_PWT&quot;)) {
<span class="nc" id="L3259">						PLAYER_PWT_CURRENT = rs.getDouble(&quot;current_balance&quot;);</span>
<span class="nc bnc" id="L3260" title="All 2 branches missed.">					} else if (rs.getString(&quot;account_type&quot;)</span>
							.equals(&quot;PLAYER_CAS&quot;)) {
<span class="nc" id="L3262">						PLAYER_CASH_CURRENT = rs.getDouble(&quot;current_balance&quot;);</span>
<span class="nc bnc" id="L3263" title="All 2 branches missed.">					} else if (rs.getString(&quot;account_type&quot;).equals(&quot;VAT_PAY&quot;)) {</span>
<span class="nc" id="L3264">						VAT_PAY_CURRENT = rs.getDouble(&quot;current_balance&quot;);</span>
<span class="nc bnc" id="L3265" title="All 2 branches missed.">					} else if (rs.getString(&quot;account_type&quot;).equals(</span>
							&quot;PWT_CHARGES&quot;)) {
<span class="nc" id="L3267">						PWT_CHARGES_CURRENT = rs.getDouble(&quot;current_balance&quot;);</span>
					}
<span class="nc" id="L3269">					resultQuery++;</span>
				}
<span class="nc bnc" id="L3271" title="All 2 branches missed.">				if (statement != null) {</span>
<span class="nc" id="L3272">					statement.close();</span>
				}
<span class="nc bnc" id="L3274" title="All 2 branches missed.">				if (rs != null) {</span>
<span class="nc" id="L3275">					rs.close();</span>
				}

<span class="nc" id="L3278">				Statement stmtInitial = connection.createStatement();</span>
<span class="nc bnc" id="L3279" title="All 2 branches missed.">				if (resultQuery == 0) {</span>

<span class="nc" id="L3281">					stmtInitial</span>
							.executeUpdate(&quot;insert into st_lms_bo_current_balance (account_type,current_balance) values ('BANK_ACC',0.0)&quot;);
<span class="nc" id="L3283">					stmtInitial</span>
							.executeUpdate(&quot;insert into st_lms_bo_current_balance (account_type,current_balance) values ('GOVT_COMM',0.0)&quot;);
<span class="nc" id="L3285">					stmtInitial</span>
							.executeUpdate(&quot;insert into st_lms_bo_current_balance (account_type,current_balance) values ('PLAYER_CAS',0.0)&quot;);
<span class="nc" id="L3287">					stmtInitial</span>
							.executeUpdate(&quot;insert into st_lms_bo_current_balance (account_type,current_balance) values ('PLAYER_PWT',0.0)&quot;);
<span class="nc" id="L3289">					stmtInitial</span>
							.executeUpdate(&quot;insert into st_lms_bo_current_balance (account_type,current_balance) values ('PLAYER_TDS',0.0)&quot;);
<span class="nc" id="L3291">					stmtInitial</span>
							.executeUpdate(&quot;insert into st_lms_bo_current_balance (account_type,current_balance) values ('PWT_PAY',0.0)&quot;);
<span class="nc" id="L3293">					stmtInitial</span>
							.executeUpdate(&quot;insert into st_lms_bo_current_balance (account_type,current_balance) values ('SALE_ACC',0.0)&quot;);
<span class="nc" id="L3295">					stmtInitial</span>
							.executeUpdate(&quot;insert into st_lms_bo_current_balance (account_type,current_balance) values ('SALE_RET',0.0)&quot;);
<span class="nc" id="L3297">					stmtInitial</span>
							.executeUpdate(&quot;insert into st_lms_bo_current_balance (account_type,current_balance) values ('TDS_PAY',0.0)&quot;);
<span class="nc" id="L3299">					stmtInitial</span>
							.executeUpdate(&quot;insert into st_lms_bo_current_balance (account_type,current_balance) values ('UNCLM_GOVT',0.0)&quot;);
<span class="nc" id="L3301">					stmtInitial</span>
							.executeUpdate(&quot;insert into st_lms_bo_current_balance (account_type,current_balance) values ('VAT_PAY',0.0)&quot;);
<span class="nc" id="L3303">					stmtInitial</span>
							.executeUpdate(&quot;insert into st_lms_bo_current_balance (account_type,current_balance) values ('PWT_CHARGES',0.0)&quot;);

				}
<span class="nc bnc" id="L3307" title="All 2 branches missed.">				if (stmtInitial != null) {</span>
<span class="nc" id="L3308">					stmtInitial.close();</span>
				}

<span class="nc" id="L3311">				stmt1 = connection.prepareStatement(QueryManager</span>
						.getST2BoTransaction());
<span class="nc" id="L3313">				stmt1.setTimestamp(1, present_date);</span>
<span class="nc" id="L3314">				stmt1.setTimestamp(2, to_Date);</span>
<span class="nc" id="L3315">				logger.debug(&quot;LH-BO**Select Trxn Master**&quot; + stmt1);</span>
<span class="nc" id="L3316">				rs1 = stmt1.executeQuery();</span>
				// This has been replaced by the obove prepared statements
				// statements 07-03-08
				// rs1 =
				// stmt1.executeQuery(QueryManager.getST2BoTransaction()+&quot;'&quot;+
				// present_date + &quot;'&quot;);

<span class="nc bnc" id="L3323" title="All 2 branches missed.">				while (rs1.next()) {</span>

<span class="nc" id="L3325">					long transaction_id = rs1.getLong(&quot;transaction_id&quot;);</span>
<span class="nc" id="L3326">					String TRANSACTION_TYPE = rs1.getString(&quot;transaction_type&quot;);</span>
<span class="nc" id="L3327">					String RECEIPT_ID = &quot;N.A.&quot;;</span>

<span class="nc" id="L3329">					rcptPS = connection.prepareStatement(rcptQry);</span>
<span class="nc" id="L3330">					rcptPS.setLong(1, transaction_id);</span>
<span class="nc" id="L3331">					rcptRS = rcptPS.executeQuery();</span>
<span class="nc bnc" id="L3332" title="All 2 branches missed.">					while (rcptRS.next()) {</span>
<span class="nc" id="L3333">						genNum = rcptRS.getString(&quot;generated_id&quot;);</span>
						// System.out.println(&quot;****&quot;+genNum+&quot;***&quot;+genNum.trim()+&quot;***&quot;+genNum.trim().equals(&quot;&quot;));
<span class="nc bnc" id="L3335" title="All 8 branches missed.">						if (genNum != null</span>
								&amp;&amp; !genNum.trim().equals(&quot;&quot;)
								&amp;&amp; !(genNum.contains(&quot;DLB&quot;) || genNum
										.contains(&quot;DSB&quot;))) {
<span class="nc" id="L3339">							RECEIPT_ID = rcptRS.getString(&quot;generated_id&quot;);</span>
						}

					}
<span class="nc bnc" id="L3343" title="All 2 branches missed.">					if (rcptPS != null) {</span>
<span class="nc" id="L3344">						rcptPS.close();</span>
					}
<span class="nc bnc" id="L3346" title="All 2 branches missed.">					if (rcptRS != null) {</span>
<span class="nc" id="L3347">						rcptRS.close();</span>
					}

<span class="nc" id="L3350">					double AMOUNT = 0;</span>
<span class="nc" id="L3351">					Timestamp TRANSACTION_DATE = null;</span>
<span class="nc" id="L3352">					String ACC_TYPE = &quot;&quot;;</span>
<span class="nc" id="L3353">					String saleQuery = &quot;&quot;;</span>
<span class="nc" id="L3354">					String saleRetQuery = &quot;&quot;;</span>
<span class="nc" id="L3355">					logger.debug(&quot;LH-BO**&quot; + TRANSACTION_TYPE + &quot;**TRX_ID-&quot;</span>
							+ transaction_id + &quot;**R_ID-&quot; + RECEIPT_ID);
<span class="nc bnc" id="L3357" title="All 2 branches missed.">					if (TRANSACTION_TYPE.equalsIgnoreCase(&quot;Sale&quot;)</span>
							| TRANSACTION_TYPE.equalsIgnoreCase(&quot;DG_SALE&quot;)
							| TRANSACTION_TYPE.equalsIgnoreCase(&quot;CS_SALE&quot;) | TRANSACTION_TYPE.equalsIgnoreCase(&quot;OLA_DEPOSIT&quot;)) {
<span class="nc bnc" id="L3360" title="All 2 branches missed.">						if (TRANSACTION_TYPE.equalsIgnoreCase(&quot;Sale&quot;)) {</span>
<span class="nc" id="L3361">							saleQuery = QueryManager.getST2BoSale();</span>
<span class="nc bnc" id="L3362" title="All 2 branches missed.">						} else if (TRANSACTION_TYPE.equalsIgnoreCase(&quot;DG_SALE&quot;)) {</span>
<span class="nc" id="L3363">							saleQuery = QueryManager.getST2BoDrwGmSale();</span>
<span class="nc bnc" id="L3364" title="All 2 branches missed.">						} else if (TRANSACTION_TYPE.equalsIgnoreCase(&quot;CS_SALE&quot;)) {</span>
<span class="nc" id="L3365">							saleQuery = QueryManager.getST2BoCsSale();</span>
<span class="nc bnc" id="L3366" title="All 2 branches missed.">						}else if (TRANSACTION_TYPE.equalsIgnoreCase(&quot;OLA_DEPOSIT&quot;)) {</span>
<span class="nc" id="L3367">							saleQuery = QueryManager.getST2BoOlaDeposit();</span>
						}
<span class="nc" id="L3369">						stmt2 = connection.prepareStatement(saleQuery);</span>
<span class="nc" id="L3370">						stmt2.setLong(1, transaction_id);</span>
<span class="nc" id="L3371">						rs2 = stmt2.executeQuery();</span>
<span class="nc bnc" id="L3372" title="All 2 branches missed.">						while (rs2.next()) {</span>
<span class="nc" id="L3373">							AMOUNT = rs2.getDouble(&quot;net_amt&quot;);</span>
<span class="nc" id="L3374">							TRANSACTION_DATE = rs2</span>
									.getTimestamp(&quot;transaction_date&quot;);
<span class="nc" id="L3376">							ACC_TYPE = &quot;&quot; + rs2.getInt(&quot;agent_org_id&quot;);</span>
<span class="nc" id="L3377">							orgName = rs2.getString(&quot;name&quot;);</span>
						}
<span class="nc bnc" id="L3379" title="All 2 branches missed.">						if (stmt2 != null) {</span>
<span class="nc" id="L3380">							stmt2.close();</span>
						}
<span class="nc bnc" id="L3382" title="All 2 branches missed.">						if (rs2 != null) {</span>
<span class="nc" id="L3383">							rs2.close();</span>
						}

<span class="nc" id="L3386">						stmt = connection.prepareStatement(QueryManager</span>
								.getST2BoCurrentBalAgent());
<span class="nc" id="L3388">						stmt.setString(1, ACC_TYPE);</span>
<span class="nc" id="L3389">						rs = stmt.executeQuery();</span>
<span class="nc" id="L3390">						int i = 0;</span>
<span class="nc bnc" id="L3391" title="All 2 branches missed.">						while (rs.next()) {</span>
<span class="nc" id="L3392">							AGENT_ACCOUNT_CURRENT = rs</span>
									.getDouble(&quot;current_balance&quot;);
<span class="nc" id="L3394">							i++;</span>
						}
<span class="nc bnc" id="L3396" title="All 2 branches missed.">						if (stmt != null) {</span>
<span class="nc" id="L3397">							stmt.close();</span>
						}
<span class="nc bnc" id="L3399" title="All 2 branches missed.">						if (rs != null) {</span>
<span class="nc" id="L3400">							rs.close();</span>
						}

<span class="nc bnc" id="L3403" title="All 2 branches missed.">						if (i == 0) {</span>
<span class="nc" id="L3404">							query1 = QueryManager.getST2InsertAgentCurrentBal();</span>
<span class="nc" id="L3405">							updatePstmt = connection.prepareStatement(query1);</span>
<span class="nc" id="L3406">							updatePstmt.setString(1, &quot;AGENT_ACC&quot;);</span>
<span class="nc" id="L3407">							updatePstmt.setInt(2, 0);</span>
<span class="nc" id="L3408">							updatePstmt.setString(3, ACC_TYPE);</span>
<span class="nc" id="L3409">							updatePstmt.execute();</span>
<span class="nc" id="L3410">							AGENT_ACCOUNT_CURRENT = 0.0;</span>

<span class="nc bnc" id="L3412" title="All 2 branches missed.">							if (updatePstmt != null) {</span>
<span class="nc" id="L3413">								updatePstmt.close();</span>
							}

						}
<span class="nc" id="L3417">						AGENT_ACCOUNT_CURRENT = AGENT_ACCOUNT_CURRENT - AMOUNT;</span>
<span class="nc" id="L3418">						SALE_ACC_CURRENT = SALE_ACC_CURRENT + AMOUNT;</span>
<span class="nc" id="L3419">						logger.debug(&quot;LH-BO**&quot; + TRANSACTION_DATE + &quot;**AMT-&quot;</span>
								+ AMOUNT + &quot;**ACT_TYPE-&quot; + ACC_TYPE
								+ &quot;**AGT_ACC=&quot; + AGENT_ACCOUNT_CURRENT
								+ &quot;**SALE_ACC&quot; + SALE_ACC_CURRENT);
<span class="nc" id="L3423">						query1 = QueryManager.getST2InsertBoLedger();</span>
<span class="nc" id="L3424">						updatePstmt = connection.prepareStatement(query1);</span>

<span class="nc" id="L3426">						updatePstmt.setString(1, TRANSACTION_TYPE);</span>
<span class="nc" id="L3427">						updatePstmt.setLong(2, transaction_id);</span>
<span class="nc" id="L3428">						updatePstmt.setTimestamp(3, TRANSACTION_DATE);</span>
<span class="nc" id="L3429">						updatePstmt.setString(4, -AMOUNT + &quot;&quot;);</span>
<span class="nc" id="L3430">						updatePstmt.setString(5, ACC_TYPE);</span>
<span class="nc" id="L3431">						updatePstmt.setString(6, AGENT_ACCOUNT_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L3432">						updatePstmt.setString(7, orgName);</span>
<span class="nc" id="L3433">						updatePstmt.setString(8, RECEIPT_ID);</span>
<span class="nc" id="L3434">						updatePstmt.execute();</span>

<span class="nc bnc" id="L3436" title="All 2 branches missed.">						if (updatePstmt != null) {</span>
<span class="nc" id="L3437">							updatePstmt.close();</span>
						}

<span class="nc" id="L3440">						query2 = QueryManager.getST2InsertBoLedger();</span>
<span class="nc" id="L3441">						upPstmt = connection.prepareStatement(query2);</span>
<span class="nc" id="L3442">						upPstmt.setString(1, TRANSACTION_TYPE);</span>
<span class="nc" id="L3443">						upPstmt.setLong(2, transaction_id);</span>
<span class="nc" id="L3444">						upPstmt.setTimestamp(3, TRANSACTION_DATE);</span>
<span class="nc" id="L3445">						upPstmt.setString(4, AMOUNT + &quot;&quot;);</span>
<span class="nc" id="L3446">						upPstmt.setString(5, &quot;SALE_ACC&quot;);</span>
<span class="nc" id="L3447">						upPstmt.setString(6, SALE_ACC_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L3448">						upPstmt.setString(7, orgName);</span>
<span class="nc" id="L3449">						upPstmt.setString(8, RECEIPT_ID);</span>
<span class="nc" id="L3450">						upPstmt.execute();</span>

<span class="nc bnc" id="L3452" title="All 2 branches missed.">						if (upPstmt != null) {</span>
<span class="nc" id="L3453">							upPstmt.close();</span>
						}

<span class="nc" id="L3456">						query3 = QueryManager.getST2UpadateCurrentBalAgent();</span>
<span class="nc" id="L3457">						updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L3458">						updPstmt.setString(1, AGENT_ACCOUNT_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L3459">						updPstmt.setString(2, &quot;AGENT_ACC&quot;);</span>
<span class="nc" id="L3460">						updPstmt.setString(3, ACC_TYPE);</span>
<span class="nc" id="L3461">						updPstmt.execute();</span>

<span class="nc bnc" id="L3463" title="All 2 branches missed.">						if (updPstmt != null) {</span>
<span class="nc" id="L3464">							updPstmt.close();</span>
						}
<span class="nc" id="L3466">					}</span>

<span class="nc bnc" id="L3468" title="All 2 branches missed.">				else if (TRANSACTION_TYPE.equalsIgnoreCase(&quot;cash&quot;)) {</span>
<span class="nc" id="L3469">						stmt2 = connection.prepareStatement(QueryManager</span>
								.getST2BoCash());
<span class="nc" id="L3471">						stmt2.setLong(1, transaction_id);</span>
<span class="nc" id="L3472">						rs2 = stmt2.executeQuery();</span>

<span class="nc bnc" id="L3474" title="All 2 branches missed.">						while (rs2.next()) {</span>
<span class="nc" id="L3475">							TRANSACTION_DATE = rs2</span>
									.getTimestamp(&quot;transaction_date&quot;);
<span class="nc" id="L3477">							AMOUNT = rs2.getDouble(&quot;amount&quot;);</span>
<span class="nc" id="L3478">							ACC_TYPE = &quot;&quot; + rs2.getInt(&quot;agent_org_id&quot;);</span>
<span class="nc" id="L3479">							orgName = rs2.getString(&quot;name&quot;);</span>
						}
<span class="nc bnc" id="L3481" title="All 2 branches missed.">						if (stmt2 != null) {</span>
<span class="nc" id="L3482">							stmt2.close();</span>
						}
<span class="nc bnc" id="L3484" title="All 2 branches missed.">						if (rs2 != null) {</span>
<span class="nc" id="L3485">							rs2.close();</span>
						}
<span class="nc" id="L3487">						stmt = connection.prepareStatement(QueryManager</span>
								.getST2BoCurrentBalAgent());
<span class="nc" id="L3489">						stmt.setString(1, ACC_TYPE);</span>
<span class="nc" id="L3490">						rs = stmt.executeQuery();</span>
<span class="nc" id="L3491">						int i = 0;</span>
<span class="nc bnc" id="L3492" title="All 2 branches missed.">						while (rs.next()) {</span>
<span class="nc" id="L3493">							AGENT_ACCOUNT_CURRENT = rs</span>
									.getDouble(&quot;current_balance&quot;);
<span class="nc" id="L3495">							i++;</span>
						}

<span class="nc bnc" id="L3498" title="All 2 branches missed.">						if (stmt != null) {</span>
<span class="nc" id="L3499">							stmt.close();</span>
						}
<span class="nc bnc" id="L3501" title="All 2 branches missed.">						if (rs != null) {</span>
<span class="nc" id="L3502">							rs.close();</span>
						}

<span class="nc bnc" id="L3505" title="All 2 branches missed.">						if (i == 0) {</span>
<span class="nc" id="L3506">							query1 = QueryManager.getST2InsertAgentCurrentBal();</span>
<span class="nc" id="L3507">							updatePstmt = connection.prepareStatement(query1);</span>
<span class="nc" id="L3508">							updatePstmt.setString(1, &quot;AGENT_ACC&quot;);</span>
<span class="nc" id="L3509">							updatePstmt.setInt(2, 0);</span>
<span class="nc" id="L3510">							updatePstmt.setString(3, ACC_TYPE);</span>
<span class="nc" id="L3511">							updatePstmt.execute();</span>
<span class="nc" id="L3512">							AGENT_ACCOUNT_CURRENT = 0.0;</span>

<span class="nc bnc" id="L3514" title="All 2 branches missed.">							if (updatePstmt != null) {</span>
<span class="nc" id="L3515">								updatePstmt.close();</span>
							}

						}

<span class="nc" id="L3520">						AGENT_ACCOUNT_CURRENT = AGENT_ACCOUNT_CURRENT + AMOUNT;</span>
<span class="nc" id="L3521">						BANK_ACC_CURRENT = BANK_ACC_CURRENT - AMOUNT;</span>
<span class="nc" id="L3522">						logger.debug(&quot;LH-BO**&quot; + TRANSACTION_DATE + &quot;**AMT-&quot;</span>
								+ AMOUNT + &quot;**ACT_TYPE-&quot; + ACC_TYPE
								+ &quot;**AGT_ACC=&quot; + AGENT_ACCOUNT_CURRENT
								+ &quot;**BANK_ACC&quot; + BANK_ACC_CURRENT);

<span class="nc" id="L3527">						query2 = QueryManager.getST2InsertBoLedger();</span>
<span class="nc" id="L3528">						upPstmt = connection.prepareStatement(query2);</span>
<span class="nc" id="L3529">						upPstmt.setString(1, TRANSACTION_TYPE);</span>
<span class="nc" id="L3530">						upPstmt.setLong(2, transaction_id);</span>
						// upPstmt.setDate(3, TRANSACTION_DATE);
<span class="nc" id="L3532">						upPstmt.setTimestamp(3, TRANSACTION_DATE);</span>
<span class="nc" id="L3533">						upPstmt.setString(4, -AMOUNT + &quot;&quot;);</span>
<span class="nc" id="L3534">						upPstmt.setString(5, &quot;BANK_ACC&quot;);</span>
<span class="nc" id="L3535">						upPstmt.setString(6, BANK_ACC_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L3536">						upPstmt.setString(7, orgName);</span>
<span class="nc" id="L3537">						upPstmt.setString(8, RECEIPT_ID);</span>
<span class="nc" id="L3538">						upPstmt.execute();</span>

<span class="nc bnc" id="L3540" title="All 2 branches missed.">						if (upPstmt != null) {</span>
<span class="nc" id="L3541">							upPstmt.close();</span>
						}

<span class="nc" id="L3544">						query1 = QueryManager.getST2InsertBoLedger();</span>
<span class="nc" id="L3545">						updatePstmt = connection.prepareStatement(query1);</span>

<span class="nc" id="L3547">						updatePstmt.setString(1, TRANSACTION_TYPE);</span>
<span class="nc" id="L3548">						updatePstmt.setLong(2, transaction_id);</span>
						// updatePstmt.setDate(3, TRANSACTION_DATE);
<span class="nc" id="L3550">						updatePstmt.setTimestamp(3, TRANSACTION_DATE);</span>
<span class="nc" id="L3551">						updatePstmt.setString(4, AMOUNT + &quot;&quot;);</span>
<span class="nc" id="L3552">						updatePstmt.setString(5, ACC_TYPE);</span>
<span class="nc" id="L3553">						updatePstmt.setString(6, AGENT_ACCOUNT_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L3554">						updatePstmt.setString(7, orgName);</span>
<span class="nc" id="L3555">						updatePstmt.setString(8, RECEIPT_ID);</span>
<span class="nc" id="L3556">						updatePstmt.execute();</span>

<span class="nc bnc" id="L3558" title="All 2 branches missed.">						if (updatePstmt != null) {</span>
<span class="nc" id="L3559">							updatePstmt.close();</span>
						}

<span class="nc" id="L3562">						query3 = QueryManager.getST2UpadateCurrentBalAgent();</span>
<span class="nc" id="L3563">						updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L3564">						updPstmt.setString(1, AGENT_ACCOUNT_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L3565">						updPstmt.setString(2, &quot;AGENT_ACC&quot;);</span>
<span class="nc" id="L3566">						updPstmt.setString(3, ACC_TYPE);</span>
<span class="nc" id="L3567">						updPstmt.execute();</span>

<span class="nc bnc" id="L3569" title="All 2 branches missed.">						if (updPstmt != null) {</span>
<span class="nc" id="L3570">							updPstmt.close();</span>
						}

<span class="nc" id="L3573">					} </span>
<span class="nc bnc" id="L3574" title="All 2 branches missed.">				else if (TRANSACTION_TYPE.equalsIgnoreCase(&quot;OLA_COMMISSION&quot;)) {</span>
<span class="nc" id="L3575">					stmt2 = connection.prepareStatement(QueryManager</span>
							.getST2BoOlaCommission());
<span class="nc" id="L3577">					stmt2.setLong(1, transaction_id);</span>
<span class="nc" id="L3578">					rs2 = stmt2.executeQuery();</span>

<span class="nc bnc" id="L3580" title="All 2 branches missed.">					while (rs2.next()) {</span>
<span class="nc" id="L3581">						TRANSACTION_DATE = rs2</span>
								.getTimestamp(&quot;transaction_date&quot;);
<span class="nc" id="L3583">						AMOUNT = rs2.getDouble(&quot;amount&quot;);</span>
<span class="nc" id="L3584">						ACC_TYPE = &quot;&quot; + rs2.getInt(&quot;agent_org_id&quot;);</span>
<span class="nc" id="L3585">						orgName = rs2.getString(&quot;name&quot;);</span>
					}
<span class="nc bnc" id="L3587" title="All 2 branches missed.">					if (stmt2 != null) {</span>
<span class="nc" id="L3588">						stmt2.close();</span>
					}
<span class="nc bnc" id="L3590" title="All 2 branches missed.">					if (rs2 != null) {</span>
<span class="nc" id="L3591">						rs2.close();</span>
					}
<span class="nc" id="L3593">					stmt = connection.prepareStatement(QueryManager</span>
							.getST2BoCurrentBalAgent());
<span class="nc" id="L3595">					stmt.setString(1, ACC_TYPE);</span>
<span class="nc" id="L3596">					rs = stmt.executeQuery();</span>
<span class="nc" id="L3597">					int i = 0;</span>
<span class="nc bnc" id="L3598" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L3599">						AGENT_ACCOUNT_CURRENT = rs</span>
								.getDouble(&quot;current_balance&quot;);
<span class="nc" id="L3601">						i++;</span>
					}

<span class="nc bnc" id="L3604" title="All 2 branches missed.">					if (stmt != null) {</span>
<span class="nc" id="L3605">						stmt.close();</span>
					}
<span class="nc bnc" id="L3607" title="All 2 branches missed.">					if (rs != null) {</span>
<span class="nc" id="L3608">						rs.close();</span>
					}

<span class="nc bnc" id="L3611" title="All 2 branches missed.">					if (i == 0) {</span>
<span class="nc" id="L3612">						query1 = QueryManager.getST2InsertAgentCurrentBal();</span>
<span class="nc" id="L3613">						updatePstmt = connection.prepareStatement(query1);</span>
<span class="nc" id="L3614">						updatePstmt.setString(1, &quot;AGENT_ACC&quot;);</span>
<span class="nc" id="L3615">						updatePstmt.setInt(2, 0);</span>
<span class="nc" id="L3616">						updatePstmt.setString(3, ACC_TYPE);</span>
<span class="nc" id="L3617">						updatePstmt.execute();</span>
<span class="nc" id="L3618">						AGENT_ACCOUNT_CURRENT = 0.0;</span>

<span class="nc bnc" id="L3620" title="All 2 branches missed.">						if (updatePstmt != null) {</span>
<span class="nc" id="L3621">							updatePstmt.close();</span>
						}

					}

<span class="nc" id="L3626">					AGENT_ACCOUNT_CURRENT = AGENT_ACCOUNT_CURRENT + AMOUNT;</span>
<span class="nc" id="L3627">					BANK_ACC_CURRENT = BANK_ACC_CURRENT - AMOUNT;</span>
<span class="nc" id="L3628">					logger.debug(&quot;LH-BO**&quot; + TRANSACTION_DATE + &quot;**AMT-&quot;</span>
							+ AMOUNT + &quot;**ACT_TYPE-&quot; + ACC_TYPE
							+ &quot;**AGT_ACC=&quot; + AGENT_ACCOUNT_CURRENT
							+ &quot;**BANK_ACC&quot; + BANK_ACC_CURRENT);

<span class="nc" id="L3633">					query2 = QueryManager.getST2InsertBoLedger();</span>
<span class="nc" id="L3634">					upPstmt = connection.prepareStatement(query2);</span>
<span class="nc" id="L3635">					upPstmt.setString(1, TRANSACTION_TYPE);</span>
<span class="nc" id="L3636">					upPstmt.setLong(2, transaction_id);</span>
					// upPstmt.setDate(3, TRANSACTION_DATE);
<span class="nc" id="L3638">					upPstmt.setTimestamp(3, TRANSACTION_DATE);</span>
<span class="nc" id="L3639">					upPstmt.setString(4, -AMOUNT + &quot;&quot;);</span>
<span class="nc" id="L3640">					upPstmt.setString(5, &quot;BANK_ACC&quot;);</span>
<span class="nc" id="L3641">					upPstmt.setString(6, BANK_ACC_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L3642">					upPstmt.setString(7, orgName);</span>
<span class="nc" id="L3643">					upPstmt.setString(8, RECEIPT_ID);</span>
<span class="nc" id="L3644">					upPstmt.execute();</span>

<span class="nc bnc" id="L3646" title="All 2 branches missed.">					if (upPstmt != null) {</span>
<span class="nc" id="L3647">						upPstmt.close();</span>
					}

<span class="nc" id="L3650">					query1 = QueryManager.getST2InsertBoLedger();</span>
<span class="nc" id="L3651">					updatePstmt = connection.prepareStatement(query1);</span>

<span class="nc" id="L3653">					updatePstmt.setString(1, TRANSACTION_TYPE);</span>
<span class="nc" id="L3654">					updatePstmt.setLong(2, transaction_id);</span>
					// updatePstmt.setDate(3, TRANSACTION_DATE);
<span class="nc" id="L3656">					updatePstmt.setTimestamp(3, TRANSACTION_DATE);</span>
<span class="nc" id="L3657">					updatePstmt.setString(4, AMOUNT + &quot;&quot;);</span>
<span class="nc" id="L3658">					updatePstmt.setString(5, ACC_TYPE);</span>
<span class="nc" id="L3659">					updatePstmt.setString(6, AGENT_ACCOUNT_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L3660">					updatePstmt.setString(7, orgName);</span>
<span class="nc" id="L3661">					updatePstmt.setString(8, RECEIPT_ID);</span>
<span class="nc" id="L3662">					updatePstmt.execute();</span>

<span class="nc bnc" id="L3664" title="All 2 branches missed.">					if (updatePstmt != null) {</span>
<span class="nc" id="L3665">						updatePstmt.close();</span>
					}

<span class="nc" id="L3668">					query3 = QueryManager.getST2UpadateCurrentBalAgent();</span>
<span class="nc" id="L3669">					updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L3670">					updPstmt.setString(1, AGENT_ACCOUNT_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L3671">					updPstmt.setString(2, &quot;AGENT_ACC&quot;);</span>
<span class="nc" id="L3672">					updPstmt.setString(3, ACC_TYPE);</span>
<span class="nc" id="L3673">					updPstmt.execute();</span>

<span class="nc bnc" id="L3675" title="All 2 branches missed.">					if (updPstmt != null) {</span>
<span class="nc" id="L3676">						updPstmt.close();</span>
					}

<span class="nc" id="L3679">				}</span>
<span class="nc bnc" id="L3680" title="All 2 branches missed.">				else if (TRANSACTION_TYPE</span>
							.equalsIgnoreCase(&quot;BANK_DEPOSIT&quot;)) {// code updated
						// for Bank Dep
						// starts ...
<span class="nc" id="L3684">						stmt2 = connection.prepareStatement(QueryManager</span>
								.getST2BoBankDep());
<span class="nc" id="L3686">						stmt2.setLong(1, transaction_id);</span>
<span class="nc" id="L3687">						rs2 = stmt2.executeQuery();</span>

<span class="nc bnc" id="L3689" title="All 2 branches missed.">						while (rs2.next()) {</span>
<span class="nc" id="L3690">							TRANSACTION_DATE = rs2</span>
									.getTimestamp(&quot;transaction_date&quot;);
<span class="nc" id="L3692">							AMOUNT = rs2.getDouble(&quot;amount&quot;);</span>
<span class="nc" id="L3693">							ACC_TYPE = &quot;&quot; + rs2.getInt(&quot;agent_org_id&quot;);</span>
<span class="nc" id="L3694">							orgName = rs2.getString(&quot;name&quot;);</span>
						}
<span class="nc bnc" id="L3696" title="All 2 branches missed.">						if (stmt2 != null) {</span>
<span class="nc" id="L3697">							stmt2.close();</span>
						}
<span class="nc bnc" id="L3699" title="All 2 branches missed.">						if (rs2 != null) {</span>
<span class="nc" id="L3700">							rs2.close();</span>
						}
<span class="nc" id="L3702">						stmt = connection.prepareStatement(QueryManager</span>
								.getST2BoCurrentBalAgent());
<span class="nc" id="L3704">						stmt.setString(1, ACC_TYPE);</span>
<span class="nc" id="L3705">						rs = stmt.executeQuery();</span>
<span class="nc" id="L3706">						int i = 0;</span>
<span class="nc bnc" id="L3707" title="All 2 branches missed.">						while (rs.next()) {</span>
<span class="nc" id="L3708">							AGENT_ACCOUNT_CURRENT = rs</span>
									.getDouble(&quot;current_balance&quot;);
<span class="nc" id="L3710">							i++;</span>
						}

<span class="nc bnc" id="L3713" title="All 2 branches missed.">						if (stmt != null) {</span>
<span class="nc" id="L3714">							stmt.close();</span>
						}
<span class="nc bnc" id="L3716" title="All 2 branches missed.">						if (rs != null) {</span>
<span class="nc" id="L3717">							rs.close();</span>
						}

<span class="nc bnc" id="L3720" title="All 2 branches missed.">						if (i == 0) {</span>
<span class="nc" id="L3721">							query1 = QueryManager.getST2InsertAgentCurrentBal();</span>
<span class="nc" id="L3722">							updatePstmt = connection.prepareStatement(query1);</span>
<span class="nc" id="L3723">							updatePstmt.setString(1, &quot;AGENT_ACC&quot;);</span>
<span class="nc" id="L3724">							updatePstmt.setInt(2, 0);</span>
<span class="nc" id="L3725">							updatePstmt.setString(3, ACC_TYPE);</span>
<span class="nc" id="L3726">							updatePstmt.execute();</span>
<span class="nc" id="L3727">							AGENT_ACCOUNT_CURRENT = 0.0;</span>

<span class="nc bnc" id="L3729" title="All 2 branches missed.">							if (updatePstmt != null) {</span>
<span class="nc" id="L3730">								updatePstmt.close();</span>
							}

						}

<span class="nc" id="L3735">						AGENT_ACCOUNT_CURRENT = AGENT_ACCOUNT_CURRENT + AMOUNT;</span>
<span class="nc" id="L3736">						BANK_ACC_CURRENT = BANK_ACC_CURRENT - AMOUNT;</span>
<span class="nc" id="L3737">						logger.debug(&quot;LH-BO**&quot; + TRANSACTION_DATE + &quot;**AMT-&quot;</span>
								+ AMOUNT + &quot;**ACT_TYPE-&quot; + ACC_TYPE
								+ &quot;**AGT_ACC=&quot; + AGENT_ACCOUNT_CURRENT
								+ &quot;**BANK_ACC&quot; + BANK_ACC_CURRENT);

<span class="nc" id="L3742">						query2 = QueryManager.getST2InsertBoLedger();</span>
<span class="nc" id="L3743">						upPstmt = connection.prepareStatement(query2);</span>
<span class="nc" id="L3744">						upPstmt.setString(1, TRANSACTION_TYPE);</span>
<span class="nc" id="L3745">						upPstmt.setLong(2, transaction_id);</span>
						// upPstmt.setDate(3, TRANSACTION_DATE);
<span class="nc" id="L3747">						upPstmt.setTimestamp(3, TRANSACTION_DATE);</span>
<span class="nc" id="L3748">						upPstmt.setString(4, -AMOUNT + &quot;&quot;);</span>
<span class="nc" id="L3749">						upPstmt.setString(5, &quot;BANK_ACC&quot;);</span>
<span class="nc" id="L3750">						upPstmt.setString(6, BANK_ACC_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L3751">						upPstmt.setString(7, orgName);</span>
<span class="nc" id="L3752">						upPstmt.setString(8, RECEIPT_ID);</span>
<span class="nc" id="L3753">						upPstmt.execute();</span>

<span class="nc bnc" id="L3755" title="All 2 branches missed.">						if (upPstmt != null) {</span>
<span class="nc" id="L3756">							upPstmt.close();</span>
						}

<span class="nc" id="L3759">						query1 = QueryManager.getST2InsertBoLedger();</span>
<span class="nc" id="L3760">						updatePstmt = connection.prepareStatement(query1);</span>

<span class="nc" id="L3762">						updatePstmt.setString(1, TRANSACTION_TYPE);</span>
<span class="nc" id="L3763">						updatePstmt.setLong(2, transaction_id);</span>
						// updatePstmt.setDate(3, TRANSACTION_DATE);
<span class="nc" id="L3765">						updatePstmt.setTimestamp(3, TRANSACTION_DATE);</span>
<span class="nc" id="L3766">						updatePstmt.setString(4, AMOUNT + &quot;&quot;);</span>
<span class="nc" id="L3767">						updatePstmt.setString(5, ACC_TYPE);</span>
<span class="nc" id="L3768">						updatePstmt.setString(6, AGENT_ACCOUNT_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L3769">						updatePstmt.setString(7, orgName);</span>
<span class="nc" id="L3770">						updatePstmt.setString(8, RECEIPT_ID);</span>
<span class="nc" id="L3771">						updatePstmt.execute();</span>

<span class="nc bnc" id="L3773" title="All 2 branches missed.">						if (updatePstmt != null) {</span>
<span class="nc" id="L3774">							updatePstmt.close();</span>
						}

<span class="nc" id="L3777">						query3 = QueryManager.getST2UpadateCurrentBalAgent();</span>
<span class="nc" id="L3778">						updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L3779">						updPstmt.setString(1, AGENT_ACCOUNT_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L3780">						updPstmt.setString(2, &quot;AGENT_ACC&quot;);</span>
<span class="nc" id="L3781">						updPstmt.setString(3, ACC_TYPE);</span>
<span class="nc" id="L3782">						updPstmt.execute();</span>

<span class="nc bnc" id="L3784" title="All 2 branches missed.">						if (updPstmt != null) {</span>
<span class="nc" id="L3785">							updPstmt.close();</span>
						}

<span class="nc" id="L3788">					}// code updated for Bank Dep ends...</span>
<span class="nc bnc" id="L3789" title="All 2 branches missed.">					else if (TRANSACTION_TYPE.equalsIgnoreCase(&quot;cheque&quot;)) {</span>
						// System.out.println(&quot;in Cheque&quot;);
<span class="nc" id="L3791">						stmt2 = connection.prepareStatement(QueryManager</span>
								.getST2BoChq());
<span class="nc" id="L3793">						stmt2.setLong(1, transaction_id);</span>
<span class="nc" id="L3794">						rs2 = stmt2.executeQuery();</span>
						// This has been replaced by the obove prepared
						// statements statements 07-03-08
						// rs2 =
						// stmt2.executeQuery(QueryManager.getST2BoChq()+&quot;&quot;+
						// transaction_id + &quot;&quot;);

<span class="nc bnc" id="L3801" title="All 2 branches missed.">						while (rs2.next()) {</span>
<span class="nc" id="L3802">							AMOUNT = rs2.getDouble(&quot;cheque_amt&quot;);</span>
							// TRANSACTION_DATE =
							// rs2.getDate(&quot;transaction_date&quot;);
<span class="nc" id="L3805">							TRANSACTION_DATE = rs2</span>
									.getTimestamp(&quot;transaction_date&quot;);
							// TRANS_DATE= new
							// java.sql.Date(TRANSACTION_DATE.getTime());

<span class="nc" id="L3810">							ACC_TYPE = &quot;&quot; + rs2.getInt(&quot;agent_org_id&quot;);</span>
<span class="nc" id="L3811">							orgName = rs2.getString(&quot;name&quot;);</span>
						}

<span class="nc bnc" id="L3814" title="All 2 branches missed.">						if (stmt2 != null) {</span>
<span class="nc" id="L3815">							stmt2.close();</span>
						}
<span class="nc bnc" id="L3817" title="All 2 branches missed.">						if (rs2 != null) {</span>
<span class="nc" id="L3818">							rs2.close();</span>
						}

						// System.out.println(&quot;Amount-- &quot;+AMOUNT+&quot; TRANS DATE--
						// &quot;+TRANSACTION_DATE+&quot; ACC_TYPE-- &quot;+ACC_TYPE+&quot; Org NAme
						// &quot;+orgName);
<span class="nc" id="L3824">						stmt = connection.prepareStatement(QueryManager</span>
								.getST2BoCurrentBalAgent());
<span class="nc" id="L3826">						stmt.setString(1, ACC_TYPE);</span>
<span class="nc" id="L3827">						rs = stmt.executeQuery();</span>
						// This has been replaced by the obove prepared
						// statements statements 07-03-08
						// rs =
						// stmt.executeQuery(QueryManager.getST2BoCurrentBalAgent()+&quot;'&quot;+
						// ACC_TYPE + &quot;'&quot;);
<span class="nc" id="L3833">						int i = 0;</span>
<span class="nc bnc" id="L3834" title="All 2 branches missed.">						while (rs.next()) {</span>
<span class="nc" id="L3835">							AGENT_ACCOUNT_CURRENT = rs</span>
									.getDouble(&quot;current_balance&quot;);
<span class="nc" id="L3837">							i++;</span>
						}

<span class="nc bnc" id="L3840" title="All 2 branches missed.">						if (stmt != null) {</span>
<span class="nc" id="L3841">							stmt.close();</span>
						}
<span class="nc bnc" id="L3843" title="All 2 branches missed.">						if (rs != null) {</span>
<span class="nc" id="L3844">							rs.close();</span>
						}

<span class="nc bnc" id="L3847" title="All 2 branches missed.">						if (i == 0) {</span>
<span class="nc" id="L3848">							query1 = QueryManager.getST2InsertAgentCurrentBal();</span>
<span class="nc" id="L3849">							updatePstmt = connection.prepareStatement(query1);</span>
<span class="nc" id="L3850">							updatePstmt.setString(1, &quot;AGENT_ACC&quot;);</span>
<span class="nc" id="L3851">							updatePstmt.setInt(2, 0);</span>
<span class="nc" id="L3852">							updatePstmt.setString(3, ACC_TYPE);</span>
<span class="nc" id="L3853">							updatePstmt.execute();</span>
<span class="nc" id="L3854">							AGENT_ACCOUNT_CURRENT = 0.0;</span>

<span class="nc bnc" id="L3856" title="All 2 branches missed.">							if (updatePstmt != null) {</span>
<span class="nc" id="L3857">								updatePstmt.close();</span>
							}

						}

<span class="nc" id="L3862">						AGENT_ACCOUNT_CURRENT = AGENT_ACCOUNT_CURRENT + AMOUNT;</span>
<span class="nc" id="L3863">						BANK_ACC_CURRENT = BANK_ACC_CURRENT - AMOUNT;</span>
						// System.out.println(&quot;AGT ACC CUR--
						// &quot;+AGENT_ACCOUNT_CURRENT+&quot;BANK ACC
						// CUR&quot;+BANK_ACC_CURRENT+&quot;&quot;);
<span class="nc" id="L3867">						logger.debug(&quot;LH-BO**&quot; + TRANSACTION_DATE + &quot;**AMT-&quot;</span>
								+ AMOUNT + &quot;**ACT_TYPE-&quot; + ACC_TYPE
								+ &quot;**AGT_ACC=&quot; + AGENT_ACCOUNT_CURRENT
								+ &quot;**BANK_ACC&quot; + BANK_ACC_CURRENT);

<span class="nc" id="L3872">						query2 = QueryManager.getST2InsertBoLedger();</span>
<span class="nc" id="L3873">						upPstmt = connection.prepareStatement(query2);</span>
<span class="nc" id="L3874">						upPstmt.setString(1, TRANSACTION_TYPE);</span>
<span class="nc" id="L3875">						upPstmt.setLong(2, transaction_id);</span>
						// upPstmt.setDate(3, TRANSACTION_DATE);
<span class="nc" id="L3877">						upPstmt.setTimestamp(3, TRANSACTION_DATE);</span>
<span class="nc" id="L3878">						upPstmt.setString(4, -AMOUNT + &quot;&quot;);</span>
<span class="nc" id="L3879">						upPstmt.setString(5, &quot;BANK_ACC&quot;);</span>
<span class="nc" id="L3880">						upPstmt.setString(6, BANK_ACC_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L3881">						upPstmt.setString(7, orgName);</span>
<span class="nc" id="L3882">						upPstmt.setString(8, RECEIPT_ID);</span>
<span class="nc" id="L3883">						upPstmt.execute();</span>

<span class="nc bnc" id="L3885" title="All 2 branches missed.">						if (upPstmt != null) {</span>
<span class="nc" id="L3886">							upPstmt.close();</span>
						}

<span class="nc" id="L3889">						query1 = QueryManager.getST2InsertBoLedger();</span>
<span class="nc" id="L3890">						updatePstmt = connection.prepareStatement(query1);</span>

<span class="nc" id="L3892">						updatePstmt.setString(1, TRANSACTION_TYPE);</span>
<span class="nc" id="L3893">						updatePstmt.setLong(2, transaction_id);</span>
						// updatePstmt.setDate(3, TRANSACTION_DATE);
<span class="nc" id="L3895">						updatePstmt.setTimestamp(3, TRANSACTION_DATE);</span>
<span class="nc" id="L3896">						updatePstmt.setString(4, AMOUNT + &quot;&quot;);</span>
<span class="nc" id="L3897">						updatePstmt.setString(5, ACC_TYPE);</span>
<span class="nc" id="L3898">						updatePstmt.setString(6, AGENT_ACCOUNT_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L3899">						updatePstmt.setString(7, orgName);</span>
<span class="nc" id="L3900">						updatePstmt.setString(8, RECEIPT_ID);</span>
<span class="nc" id="L3901">						updatePstmt.execute();</span>

<span class="nc bnc" id="L3903" title="All 2 branches missed.">						if (updatePstmt != null) {</span>
<span class="nc" id="L3904">							updatePstmt.close();</span>
						}

<span class="nc" id="L3907">						query3 = QueryManager.getST2UpadateCurrentBalAgent();</span>
<span class="nc" id="L3908">						updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L3909">						updPstmt.setString(1, AGENT_ACCOUNT_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L3910">						updPstmt.setString(2, &quot;AGENT_ACC&quot;);</span>
<span class="nc" id="L3911">						updPstmt.setString(3, ACC_TYPE);</span>
<span class="nc" id="L3912">						updPstmt.execute();</span>

<span class="nc bnc" id="L3914" title="All 2 branches missed.">						if (updPstmt != null) {</span>
<span class="nc" id="L3915">							updPstmt.close();</span>
						}

<span class="nc bnc" id="L3918" title="All 12 branches missed.">					} else if (TRANSACTION_TYPE.equalsIgnoreCase(&quot;sale_ret&quot;)</span>
							|| TRANSACTION_TYPE
									.equalsIgnoreCase(&quot;DG_REFUND_FAILED&quot;)
							|| TRANSACTION_TYPE
									.equalsIgnoreCase(&quot;DG_REFUND_CANCEL&quot;)
							|| TRANSACTION_TYPE
									.equalsIgnoreCase(&quot;CS_CANCEL_SERVER&quot;)
							|| TRANSACTION_TYPE
									.equalsIgnoreCase(&quot;CS_CANCEL_RET&quot;) || TRANSACTION_TYPE.equalsIgnoreCase(&quot;OLA_DEPOSIT_REFUND&quot;)) {
						// System.out.println(&quot;in Sale Ret&quot;);
<span class="nc bnc" id="L3928" title="All 2 branches missed.">						if (TRANSACTION_TYPE.equalsIgnoreCase(&quot;sale_ret&quot;)) {</span>
<span class="nc" id="L3929">							saleRetQuery = QueryManager.getST2BoSaleRet();</span>
<span class="nc bnc" id="L3930" title="All 4 branches missed.">						} else if (TRANSACTION_TYPE</span>
								.equalsIgnoreCase(&quot;DG_REFUND_FAILED&quot;)
								|| TRANSACTION_TYPE
										.equalsIgnoreCase(&quot;DG_REFUND_CANCEL&quot;)) {
<span class="nc" id="L3934">							saleRetQuery = QueryManager.getST2BoDrwGmRefnd();</span>
<span class="nc bnc" id="L3935" title="All 4 branches missed.">						} else if (TRANSACTION_TYPE</span>
								.equalsIgnoreCase(&quot;CS_CANCEL_SERVER&quot;)
								|| TRANSACTION_TYPE
										.equalsIgnoreCase(&quot;CS_CANCEL_RET&quot;)) {
<span class="nc" id="L3939">							saleRetQuery = QueryManager.getST2BoCsRefnd();</span>
						}
<span class="nc bnc" id="L3941" title="All 2 branches missed.">						else if(TRANSACTION_TYPE.equalsIgnoreCase(&quot;OLA_DEPOSIT_REFUND&quot;))</span>
						{
<span class="nc" id="L3943">							saleRetQuery = QueryManager.getST2BoOlaRefnd();</span>
						}
<span class="nc" id="L3945">						stmt2 = connection.prepareStatement(saleRetQuery);</span>
<span class="nc" id="L3946">						stmt2.setLong(1, transaction_id);</span>
<span class="nc" id="L3947">						rs2 = stmt2.executeQuery();</span>
						// This has been replaced by the obove prepared
						// statements statements 07-03-08
						// rs2 =
						// stmt2.executeQuery(QueryManager.getST2BoSaleRet()+&quot;&quot;+
						// transaction_id + &quot;&quot;);

<span class="nc bnc" id="L3954" title="All 2 branches missed.">						while (rs2.next()) {</span>
<span class="nc" id="L3955">							AMOUNT = rs2.getDouble(&quot;net_amt&quot;);</span>
							// TRANSACTION_DATE =
							// rs2.getDate(&quot;transaction_date&quot;);
<span class="nc" id="L3958">							TRANSACTION_DATE = rs2</span>
									.getTimestamp(&quot;transaction_date&quot;);
<span class="nc" id="L3960">							ACC_TYPE = &quot;&quot; + rs2.getInt(&quot;agent_org_id&quot;);</span>
<span class="nc" id="L3961">							orgName = rs2.getString(&quot;name&quot;);</span>
						}

<span class="nc bnc" id="L3964" title="All 2 branches missed.">						if (stmt2 != null) {</span>
<span class="nc" id="L3965">							stmt2.close();</span>
						}
<span class="nc bnc" id="L3967" title="All 2 branches missed.">						if (rs2 != null) {</span>
<span class="nc" id="L3968">							rs2.close();</span>
						}

						// System.out.println(&quot;Amount-- &quot;+AMOUNT+&quot; TRANS DATE--
						// &quot;+TRANSACTION_DATE+&quot; ACC_TYPE-- &quot;+ACC_TYPE+&quot; Org NAme
						// &quot;+orgName);
<span class="nc" id="L3974">						stmt = connection.prepareStatement(QueryManager</span>
								.getST2BoCurrentBalAgent());
<span class="nc" id="L3976">						stmt.setString(1, ACC_TYPE);</span>
<span class="nc" id="L3977">						rs = stmt.executeQuery();</span>
						// This has been replaced by the obove prepared
						// statements statements 07-03-08
						// rs =
						// stmt.executeQuery(QueryManager.getST2BoCurrentBalAgent()+&quot;'&quot;+
						// ACC_TYPE + &quot;'&quot;);
<span class="nc" id="L3983">						int i = 0;</span>
<span class="nc bnc" id="L3984" title="All 2 branches missed.">						while (rs.next()) {</span>
<span class="nc" id="L3985">							AGENT_ACCOUNT_CURRENT = rs</span>
									.getDouble(&quot;current_balance&quot;);
<span class="nc" id="L3987">							i++;</span>
						}

<span class="nc bnc" id="L3990" title="All 2 branches missed.">						if (stmt != null) {</span>
<span class="nc" id="L3991">							stmt.close();</span>
						}
<span class="nc bnc" id="L3993" title="All 2 branches missed.">						if (rs != null) {</span>
<span class="nc" id="L3994">							rs.close();</span>
						}

<span class="nc bnc" id="L3997" title="All 2 branches missed.">						if (i == 0) {</span>
<span class="nc" id="L3998">							query1 = QueryManager.getST2InsertAgentCurrentBal();</span>
<span class="nc" id="L3999">							updatePstmt = connection.prepareStatement(query1);</span>
<span class="nc" id="L4000">							updatePstmt.setString(1, &quot;AGENT_ACC&quot;);</span>
<span class="nc" id="L4001">							updatePstmt.setInt(2, 0);</span>
<span class="nc" id="L4002">							updatePstmt.setString(3, ACC_TYPE);</span>
<span class="nc" id="L4003">							updatePstmt.execute();</span>
<span class="nc" id="L4004">							AGENT_ACCOUNT_CURRENT = 0.0;</span>

<span class="nc bnc" id="L4006" title="All 2 branches missed.">							if (updatePstmt != null) {</span>
<span class="nc" id="L4007">								updatePstmt.close();</span>
							}

						}

<span class="nc" id="L4012">						AGENT_ACCOUNT_CURRENT = AGENT_ACCOUNT_CURRENT + AMOUNT;</span>
<span class="nc" id="L4013">						SALE_RET_CURRENT = SALE_RET_CURRENT - AMOUNT;</span>
						// System.out.println(&quot;AGT ACC CUR--
						// &quot;+AGENT_ACCOUNT_CURRENT+&quot;SALE RET ACC
						// CUR&quot;+SALE_RET_CURRENT);
						// System.out.println(TRANSACTION_DATE);
<span class="nc" id="L4018">						logger.debug(&quot;LH-BO**&quot; + TRANSACTION_DATE + &quot;**AMT-&quot;</span>
								+ AMOUNT + &quot;**ACT_TYPE-&quot; + ACC_TYPE
								+ &quot;**AGT_ACC=&quot; + AGENT_ACCOUNT_CURRENT
								+ &quot;**SALE_RET_ACC&quot; + SALE_RET_CURRENT);

<span class="nc" id="L4023">						query2 = QueryManager.getST2InsertBoLedger();</span>
<span class="nc" id="L4024">						upPstmt = connection.prepareStatement(query2);</span>
<span class="nc" id="L4025">						upPstmt.setString(1, TRANSACTION_TYPE);</span>
<span class="nc" id="L4026">						upPstmt.setLong(2, transaction_id);</span>
						// upPstmt.setDate(3, TRANSACTION_DATE);
<span class="nc" id="L4028">						upPstmt.setTimestamp(3, TRANSACTION_DATE);</span>
<span class="nc" id="L4029">						upPstmt.setString(4, -AMOUNT + &quot;&quot;);</span>
<span class="nc" id="L4030">						upPstmt.setString(5, &quot;SALE_RET&quot;);</span>
<span class="nc" id="L4031">						upPstmt.setString(6, SALE_RET_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L4032">						upPstmt.setString(7, orgName);</span>
<span class="nc" id="L4033">						upPstmt.setString(8, RECEIPT_ID);</span>
<span class="nc" id="L4034">						upPstmt.execute();</span>

<span class="nc bnc" id="L4036" title="All 2 branches missed.">						if (upPstmt != null) {</span>
<span class="nc" id="L4037">							upPstmt.close();</span>
						}

<span class="nc" id="L4040">						query1 = QueryManager.getST2InsertBoLedger();</span>
<span class="nc" id="L4041">						updatePstmt = connection.prepareStatement(query1);</span>

<span class="nc" id="L4043">						updatePstmt.setString(1, TRANSACTION_TYPE);</span>
<span class="nc" id="L4044">						updatePstmt.setLong(2, transaction_id);</span>
						// updatePstmt.setDate(3, TRANSACTION_DATE);
<span class="nc" id="L4046">						updatePstmt.setTimestamp(3, TRANSACTION_DATE);</span>
<span class="nc" id="L4047">						updatePstmt.setString(4, AMOUNT + &quot;&quot;);</span>
<span class="nc" id="L4048">						updatePstmt.setString(5, ACC_TYPE);</span>
<span class="nc" id="L4049">						updatePstmt.setString(6, AGENT_ACCOUNT_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L4050">						updatePstmt.setString(7, orgName);</span>
<span class="nc" id="L4051">						updatePstmt.setString(8, RECEIPT_ID);</span>
<span class="nc" id="L4052">						updatePstmt.execute();</span>

<span class="nc bnc" id="L4054" title="All 2 branches missed.">						if (updatePstmt != null) {</span>
<span class="nc" id="L4055">							updatePstmt.close();</span>
						}

<span class="nc" id="L4058">						query3 = QueryManager.getST2UpadateCurrentBalAgent();</span>
<span class="nc" id="L4059">						updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L4060">						updPstmt.setString(1, AGENT_ACCOUNT_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L4061">						updPstmt.setString(2, &quot;AGENT_ACC&quot;);</span>
<span class="nc" id="L4062">						updPstmt.setString(3, ACC_TYPE);</span>
<span class="nc" id="L4063">						updPstmt.execute();</span>

<span class="nc bnc" id="L4065" title="All 2 branches missed.">						if (updPstmt != null) {</span>
<span class="nc" id="L4066">							updPstmt.close();</span>
						}

<span class="nc bnc" id="L4069" title="All 2 branches missed.">					} else if (TRANSACTION_TYPE.equalsIgnoreCase(&quot;chq_bounce&quot;)) {</span>
						// System.out.println(&quot;in chq bounce&quot;);
<span class="nc" id="L4071">						stmt2 = connection.prepareStatement(QueryManager</span>
								.getST2BoChqBounce());
<span class="nc" id="L4073">						stmt2.setLong(1, transaction_id);</span>
<span class="nc" id="L4074">						rs2 = stmt2.executeQuery();</span>
						// This has been replaced by the obove prepared
						// statements statements 07-03-08
						// rs2 =
						// stmt2.executeQuery(QueryManager.getST2BoChqBounce()+&quot;&quot;+
						// transaction_id + &quot;&quot;);

<span class="nc bnc" id="L4081" title="All 2 branches missed.">						while (rs2.next()) {</span>
<span class="nc" id="L4082">							AMOUNT = rs2.getDouble(&quot;cheque_amt&quot;);</span>
							// TRANSACTION_DATE =
							// rs2.getDate(&quot;transaction_date&quot;);
<span class="nc" id="L4085">							TRANSACTION_DATE = rs2</span>
									.getTimestamp(&quot;transaction_date&quot;);
							// TRANS_DATE= new
							// java.sql.Date(TRANSACTION_DATE.getTime());
<span class="nc" id="L4089">							ACC_TYPE = &quot;&quot; + rs2.getInt(&quot;agent_org_id&quot;);</span>
<span class="nc" id="L4090">							orgName = rs2.getString(&quot;name&quot;);</span>
						}

<span class="nc bnc" id="L4093" title="All 2 branches missed.">						if (stmt2 != null) {</span>
<span class="nc" id="L4094">							stmt2.close();</span>
						}
<span class="nc bnc" id="L4096" title="All 2 branches missed.">						if (rs2 != null) {</span>
<span class="nc" id="L4097">							rs2.close();</span>
						}

						// System.out.println(&quot;Amount-- &quot;+AMOUNT+&quot; TRANS DATE--
						// &quot;+TRANSACTION_DATE+&quot; ACC_TYPE-- &quot;+ACC_TYPE+&quot; Org NAme
						// &quot;+orgName);
<span class="nc" id="L4103">						stmt = connection.prepareStatement(QueryManager</span>
								.getST2BoCurrentBalAgent());
<span class="nc" id="L4105">						stmt.setString(1, ACC_TYPE);</span>
<span class="nc" id="L4106">						rs = stmt.executeQuery();</span>
						// This has been replaced by the obove prepared
						// statements statements 07-03-08
						// rs =
						// stmt.executeQuery(QueryManager.getST2BoCurrentBalAgent()+&quot;'&quot;+
						// ACC_TYPE + &quot;'&quot;);
<span class="nc" id="L4112">						int i = 0;</span>
<span class="nc bnc" id="L4113" title="All 2 branches missed.">						while (rs.next()) {</span>
<span class="nc" id="L4114">							AGENT_ACCOUNT_CURRENT = rs</span>
									.getDouble(&quot;current_balance&quot;);
<span class="nc" id="L4116">							i++;</span>
						}

<span class="nc bnc" id="L4119" title="All 2 branches missed.">						if (stmt != null) {</span>
<span class="nc" id="L4120">							stmt.close();</span>
						}
<span class="nc bnc" id="L4122" title="All 2 branches missed.">						if (rs != null) {</span>
<span class="nc" id="L4123">							rs.close();</span>
						}

<span class="nc bnc" id="L4126" title="All 2 branches missed.">						if (i == 0) {</span>
<span class="nc" id="L4127">							query1 = QueryManager.getST2InsertAgentCurrentBal();</span>
<span class="nc" id="L4128">							updatePstmt = connection.prepareStatement(query1);</span>
<span class="nc" id="L4129">							updatePstmt.setString(1, &quot;AGENT_ACC&quot;);</span>
<span class="nc" id="L4130">							updatePstmt.setInt(2, 0);</span>
<span class="nc" id="L4131">							updatePstmt.setString(3, ACC_TYPE);</span>
<span class="nc" id="L4132">							updatePstmt.execute();</span>
<span class="nc" id="L4133">							AGENT_ACCOUNT_CURRENT = 0.0;</span>

<span class="nc bnc" id="L4135" title="All 2 branches missed.">							if (updatePstmt != null) {</span>
<span class="nc" id="L4136">								updatePstmt.close();</span>
							}

						}

<span class="nc" id="L4141">						AGENT_ACCOUNT_CURRENT = AGENT_ACCOUNT_CURRENT - AMOUNT;</span>
<span class="nc" id="L4142">						BANK_ACC_CURRENT = BANK_ACC_CURRENT + AMOUNT;</span>

						// System.out.println(&quot;AGT ACC CUR--
						// &quot;+AGENT_ACCOUNT_CURRENT+&quot;Bank ACC
						// CUR&quot;+BANK_ACC_CURRENT+&quot;&quot;);
<span class="nc" id="L4147">						logger.debug(&quot;LH-BO**&quot; + TRANSACTION_DATE + &quot;**AMT-&quot;</span>
								+ AMOUNT + &quot;**ACT_TYPE-&quot; + ACC_TYPE
								+ &quot;**AGT_ACC=&quot; + AGENT_ACCOUNT_CURRENT
								+ &quot;**BANK_ACC&quot; + BANK_ACC_CURRENT);

<span class="nc" id="L4152">						query1 = QueryManager.getST2InsertBoLedger();</span>
<span class="nc" id="L4153">						updatePstmt = connection.prepareStatement(query1);</span>

<span class="nc" id="L4155">						updatePstmt.setString(1, TRANSACTION_TYPE);</span>
<span class="nc" id="L4156">						updatePstmt.setLong(2, transaction_id);</span>
						// updatePstmt.setDate(3, TRANSACTION_DATE);
<span class="nc" id="L4158">						updatePstmt.setTimestamp(3, TRANSACTION_DATE);</span>
<span class="nc" id="L4159">						updatePstmt.setString(4, -AMOUNT + &quot;&quot;);</span>
<span class="nc" id="L4160">						updatePstmt.setString(5, ACC_TYPE);</span>
<span class="nc" id="L4161">						updatePstmt.setString(6, AGENT_ACCOUNT_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L4162">						updatePstmt.setString(7, orgName);</span>
<span class="nc" id="L4163">						updatePstmt.setString(8, RECEIPT_ID);</span>
<span class="nc" id="L4164">						updatePstmt.execute();</span>

<span class="nc bnc" id="L4166" title="All 2 branches missed.">						if (updatePstmt != null) {</span>
<span class="nc" id="L4167">							updatePstmt.close();</span>
						}

<span class="nc" id="L4170">						query2 = QueryManager.getST2InsertBoLedger();</span>
<span class="nc" id="L4171">						upPstmt = connection.prepareStatement(query2);</span>
<span class="nc" id="L4172">						upPstmt.setString(1, TRANSACTION_TYPE);</span>
<span class="nc" id="L4173">						upPstmt.setLong(2, transaction_id);</span>
						// upPstmt.setDate(3, TRANSACTION_DATE);
<span class="nc" id="L4175">						upPstmt.setTimestamp(3, TRANSACTION_DATE);</span>
<span class="nc" id="L4176">						upPstmt.setString(4, AMOUNT + &quot;&quot;);</span>
<span class="nc" id="L4177">						upPstmt.setString(5, &quot;BANK_ACC&quot;);</span>
<span class="nc" id="L4178">						upPstmt.setString(6, BANK_ACC_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L4179">						upPstmt.setString(7, orgName);</span>
<span class="nc" id="L4180">						upPstmt.setString(8, RECEIPT_ID);</span>
<span class="nc" id="L4181">						upPstmt.execute();</span>

<span class="nc bnc" id="L4183" title="All 2 branches missed.">						if (upPstmt != null) {</span>
<span class="nc" id="L4184">							upPstmt.close();</span>
						}

<span class="nc" id="L4187">						query3 = QueryManager.getST2UpadateCurrentBalAgent();</span>
<span class="nc" id="L4188">						updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L4189">						updPstmt.setString(1, AGENT_ACCOUNT_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L4190">						updPstmt.setString(2, &quot;AGENT_ACC&quot;);</span>
<span class="nc" id="L4191">						updPstmt.setString(3, ACC_TYPE);</span>
<span class="nc" id="L4192">						updPstmt.execute();</span>

<span class="nc bnc" id="L4194" title="All 2 branches missed.">						if (updPstmt != null) {</span>
<span class="nc" id="L4195">							updPstmt.close();</span>
						}

<span class="nc bnc" id="L4198" title="All 4 branches missed.">					} else if (TRANSACTION_TYPE</span>
							.equalsIgnoreCase(&quot;DR_NOTE_CASH&quot;)
							|| TRANSACTION_TYPE.equalsIgnoreCase(&quot;DR_NOTE&quot;)) {
						// System.out.println(&quot;in DR_NOTE_CASH &quot;);
<span class="nc" id="L4202">						stmt2 = connection.prepareStatement(QueryManager</span>
								.getST6BoDebitNote());
<span class="nc" id="L4204">						stmt2.setLong(1, transaction_id);</span>
<span class="nc" id="L4205">						rs2 = stmt2.executeQuery();</span>
						// System.out.println(&quot;query &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot; + stmt2);//
						// for
						// testing
						// This has been replaced by the obove prepared
						// statements statements 07-03-08
						// rs2 =
						// stmt2.executeQuery(QueryManager.getST2BoChqBounce()+&quot;&quot;+
						// transaction_id + &quot;&quot;);

<span class="nc bnc" id="L4215" title="All 2 branches missed.">						while (rs2.next()) {</span>
<span class="nc" id="L4216">							AMOUNT = rs2.getDouble(&quot;amount&quot;);</span>
							// TRANSACTION_DATE =
							// rs2.getDate(&quot;transaction_date&quot;);
<span class="nc" id="L4219">							TRANSACTION_DATE = rs2</span>
									.getTimestamp(&quot;transaction_date&quot;);
							// TRANS_DATE= new
							// java.sql.Date(TRANSACTION_DATE.getTime());
<span class="nc" id="L4223">							ACC_TYPE = &quot;&quot; + rs2.getInt(&quot;agent_org_id&quot;);</span>
<span class="nc" id="L4224">							orgName = rs2.getString(&quot;name&quot;);</span>
						}
<span class="nc bnc" id="L4226" title="All 2 branches missed.">						if (stmt2 != null) {</span>
<span class="nc" id="L4227">							stmt2.close();</span>
						}
<span class="nc bnc" id="L4229" title="All 2 branches missed.">						if (rs2 != null) {</span>
<span class="nc" id="L4230">							rs2.close();</span>
						}
						// System.out.println(&quot;Amount-- &quot;+AMOUNT+&quot; TRANS DATE--
						// &quot;+TRANSACTION_DATE+&quot; ACC_TYPE-- &quot;+ACC_TYPE+&quot; Org NAme
						// &quot;+orgName);
<span class="nc" id="L4235">						stmt = connection.prepareStatement(QueryManager</span>
								.getST2BoCurrentBalAgent());
<span class="nc" id="L4237">						stmt.setString(1, ACC_TYPE);</span>
<span class="nc" id="L4238">						rs = stmt.executeQuery();</span>
						// This has been replaced by the obove prepared
						// statements statements 07-03-08
						// rs =
						// stmt.executeQuery(QueryManager.getST2BoCurrentBalAgent()+&quot;'&quot;+
						// ACC_TYPE + &quot;'&quot;);
<span class="nc" id="L4244">						int i = 0;</span>
<span class="nc bnc" id="L4245" title="All 2 branches missed.">						while (rs.next()) {</span>
<span class="nc" id="L4246">							AGENT_ACCOUNT_CURRENT = rs</span>
									.getDouble(&quot;current_balance&quot;);
<span class="nc" id="L4248">							i++;</span>
						}

<span class="nc bnc" id="L4251" title="All 2 branches missed.">						if (stmt != null) {</span>
<span class="nc" id="L4252">							stmt.close();</span>
						}
<span class="nc bnc" id="L4254" title="All 2 branches missed.">						if (rs != null) {</span>
<span class="nc" id="L4255">							rs.close();</span>
						}

<span class="nc bnc" id="L4258" title="All 2 branches missed.">						if (i == 0) {</span>
<span class="nc" id="L4259">							query1 = QueryManager.getST2InsertAgentCurrentBal();</span>
<span class="nc" id="L4260">							updatePstmt = connection.prepareStatement(query1);</span>
<span class="nc" id="L4261">							updatePstmt.setString(1, &quot;AGENT_ACC&quot;);</span>
<span class="nc" id="L4262">							updatePstmt.setInt(2, 0);</span>
<span class="nc" id="L4263">							updatePstmt.setString(3, ACC_TYPE);</span>
<span class="nc" id="L4264">							updatePstmt.execute();</span>
<span class="nc" id="L4265">							AGENT_ACCOUNT_CURRENT = 0.0;</span>

<span class="nc bnc" id="L4267" title="All 2 branches missed.">							if (updatePstmt != null) {</span>
<span class="nc" id="L4268">								updatePstmt.close();</span>
							}

						}

<span class="nc" id="L4273">						AGENT_ACCOUNT_CURRENT = AGENT_ACCOUNT_CURRENT - AMOUNT;</span>
<span class="nc" id="L4274">						BANK_ACC_CURRENT = BANK_ACC_CURRENT + AMOUNT;</span>

						// System.out.println(&quot;AGT ACC CUR--
						// &quot;+AGENT_ACCOUNT_CURRENT+&quot;Bank ACC
						// CUR&quot;+BANK_ACC_CURRENT+&quot;&quot;);
<span class="nc" id="L4279">						logger.debug(&quot;LH-BO**&quot; + TRANSACTION_DATE + &quot;**AMT-&quot;</span>
								+ AMOUNT + &quot;**ACT_TYPE-&quot; + ACC_TYPE
								+ &quot;**AGT_ACC=&quot; + AGENT_ACCOUNT_CURRENT
								+ &quot;**BANK_ACC&quot; + BANK_ACC_CURRENT);

<span class="nc" id="L4284">						query1 = QueryManager.getST2InsertBoLedger();</span>
<span class="nc" id="L4285">						updatePstmt = connection.prepareStatement(query1);</span>

<span class="nc" id="L4287">						updatePstmt.setString(1, TRANSACTION_TYPE);</span>
<span class="nc" id="L4288">						updatePstmt.setLong(2, transaction_id);</span>
						// updatePstmt.setDate(3, TRANSACTION_DATE);
<span class="nc" id="L4290">						updatePstmt.setTimestamp(3, TRANSACTION_DATE);</span>
<span class="nc" id="L4291">						updatePstmt.setString(4, -AMOUNT + &quot;&quot;);</span>
<span class="nc" id="L4292">						updatePstmt.setString(5, ACC_TYPE);</span>
<span class="nc" id="L4293">						updatePstmt.setString(6, AGENT_ACCOUNT_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L4294">						updatePstmt.setString(7, orgName);</span>
<span class="nc" id="L4295">						updatePstmt.setString(8, RECEIPT_ID);</span>
<span class="nc" id="L4296">						updatePstmt.execute();</span>

<span class="nc bnc" id="L4298" title="All 2 branches missed.">						if (updatePstmt != null) {</span>
<span class="nc" id="L4299">							updatePstmt.close();</span>
						}

<span class="nc" id="L4302">						query2 = QueryManager.getST2InsertBoLedger();</span>
<span class="nc" id="L4303">						upPstmt = connection.prepareStatement(query2);</span>
<span class="nc" id="L4304">						upPstmt.setString(1, TRANSACTION_TYPE);</span>
<span class="nc" id="L4305">						upPstmt.setLong(2, transaction_id);</span>
						// upPstmt.setDate(3, TRANSACTION_DATE);
<span class="nc" id="L4307">						upPstmt.setTimestamp(3, TRANSACTION_DATE);</span>
<span class="nc" id="L4308">						upPstmt.setString(4, AMOUNT + &quot;&quot;);</span>
<span class="nc" id="L4309">						upPstmt.setString(5, &quot;BANK_ACC&quot;);</span>
<span class="nc" id="L4310">						upPstmt.setString(6, BANK_ACC_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L4311">						upPstmt.setString(7, orgName);</span>
<span class="nc" id="L4312">						upPstmt.setString(8, RECEIPT_ID);</span>
<span class="nc" id="L4313">						upPstmt.execute();</span>

<span class="nc bnc" id="L4315" title="All 2 branches missed.">						if (upPstmt != null) {</span>
<span class="nc" id="L4316">							upPstmt.close();</span>
						}

<span class="nc" id="L4319">						query3 = QueryManager.getST2UpadateCurrentBalAgent();</span>
<span class="nc" id="L4320">						updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L4321">						updPstmt.setString(1, AGENT_ACCOUNT_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L4322">						updPstmt.setString(2, &quot;AGENT_ACC&quot;);</span>
<span class="nc" id="L4323">						updPstmt.setString(3, ACC_TYPE);</span>
<span class="nc" id="L4324">						updPstmt.execute();</span>

<span class="nc bnc" id="L4326" title="All 2 branches missed.">						if (updPstmt != null) {</span>
<span class="nc" id="L4327">							updPstmt.close();</span>
						}

<span class="nc bnc" id="L4330" title="All 2 branches missed.">					} else if (TRANSACTION_TYPE</span>
							.equalsIgnoreCase(&quot;CR_NOTE_CASH&quot;)) {
						// System.out.println(&quot;in CR_NOTE_CASH &quot;);
<span class="nc" id="L4333">						stmt2 = connection.prepareStatement(QueryManager</span>
								.getST6BoCreditNote());
<span class="nc" id="L4335">						stmt2.setLong(1, transaction_id);</span>
<span class="nc" id="L4336">						rs2 = stmt2.executeQuery();</span>
						// This has been replaced by the obove prepared
						// statements statements 07-03-08
						// rs2 =
						// stmt2.executeQuery(QueryManager.getST2BoChqBounce()+&quot;&quot;+
						// transaction_id + &quot;&quot;);

<span class="nc bnc" id="L4343" title="All 2 branches missed.">						while (rs2.next()) {</span>
<span class="nc" id="L4344">							AMOUNT = rs2.getDouble(&quot;amount&quot;);</span>
							// TRANSACTION_DATE =
							// rs2.getDate(&quot;transaction_date&quot;);
<span class="nc" id="L4347">							TRANSACTION_DATE = rs2</span>
									.getTimestamp(&quot;transaction_date&quot;);
							// TRANS_DATE= new
							// java.sql.Date(TRANSACTION_DATE.getTime());
<span class="nc" id="L4351">							ACC_TYPE = &quot;&quot; + rs2.getInt(&quot;agent_org_id&quot;);</span>
<span class="nc" id="L4352">							orgName = rs2.getString(&quot;name&quot;);</span>
						}

<span class="nc bnc" id="L4355" title="All 2 branches missed.">						if (stmt2 != null) {</span>
<span class="nc" id="L4356">							stmt2.close();</span>
						}
<span class="nc bnc" id="L4358" title="All 2 branches missed.">						if (rs2 != null) {</span>
<span class="nc" id="L4359">							rs2.close();</span>
						}

						// System.out.println(&quot;Amount-- &quot;+AMOUNT+&quot; TRANS DATE--
						// &quot;+TRANSACTION_DATE+&quot; ACC_TYPE-- &quot;+ACC_TYPE+&quot; Org NAme
						// &quot;+orgName);
<span class="nc" id="L4365">						stmt = connection.prepareStatement(QueryManager</span>
								.getST2BoCurrentBalAgent());
<span class="nc" id="L4367">						stmt.setString(1, ACC_TYPE);</span>
<span class="nc" id="L4368">						rs = stmt.executeQuery();</span>
						// This has been replaced by the obove prepared
						// statements statements 07-03-08
						// rs =
						// stmt.executeQuery(QueryManager.getST2BoCurrentBalAgent()+&quot;'&quot;+
						// ACC_TYPE + &quot;'&quot;);
<span class="nc" id="L4374">						int i = 0;</span>
<span class="nc bnc" id="L4375" title="All 2 branches missed.">						while (rs.next()) {</span>
<span class="nc" id="L4376">							AGENT_ACCOUNT_CURRENT = rs</span>
									.getDouble(&quot;current_balance&quot;);
<span class="nc" id="L4378">							i++;</span>
						}

<span class="nc bnc" id="L4381" title="All 2 branches missed.">						if (stmt != null) {</span>
<span class="nc" id="L4382">							stmt.close();</span>
						}
<span class="nc bnc" id="L4384" title="All 2 branches missed.">						if (rs != null) {</span>
<span class="nc" id="L4385">							rs.close();</span>
						}

<span class="nc bnc" id="L4388" title="All 2 branches missed.">						if (i == 0) {</span>
<span class="nc" id="L4389">							query1 = QueryManager.getST2InsertAgentCurrentBal();</span>
<span class="nc" id="L4390">							updatePstmt = connection.prepareStatement(query1);</span>
<span class="nc" id="L4391">							updatePstmt.setString(1, &quot;AGENT_ACC&quot;);</span>
<span class="nc" id="L4392">							updatePstmt.setInt(2, 0);</span>
<span class="nc" id="L4393">							updatePstmt.setString(3, ACC_TYPE);</span>
<span class="nc" id="L4394">							updatePstmt.execute();</span>
<span class="nc" id="L4395">							AGENT_ACCOUNT_CURRENT = 0.0;</span>

<span class="nc bnc" id="L4397" title="All 2 branches missed.">							if (updatePstmt != null) {</span>
<span class="nc" id="L4398">								updatePstmt.close();</span>
							}

						}

<span class="nc" id="L4403">						AGENT_ACCOUNT_CURRENT = AGENT_ACCOUNT_CURRENT + AMOUNT;</span>
<span class="nc" id="L4404">						BANK_ACC_CURRENT = BANK_ACC_CURRENT - AMOUNT;</span>

						// System.out.println(&quot;AGT ACC CUR--
						// &quot;+AGENT_ACCOUNT_CURRENT+&quot;Bank ACC
						// CUR&quot;+BANK_ACC_CURRENT+&quot;&quot;);
<span class="nc" id="L4409">						logger.debug(&quot;LH-BO**&quot; + TRANSACTION_DATE + &quot;**AMT-&quot;</span>
								+ AMOUNT + &quot;**ACT_TYPE-&quot; + ACC_TYPE
								+ &quot;**AGT_ACC=&quot; + AGENT_ACCOUNT_CURRENT
								+ &quot;**BANK_ACC&quot; + BANK_ACC_CURRENT);

<span class="nc" id="L4414">						query2 = QueryManager.getST2InsertBoLedger();</span>
<span class="nc" id="L4415">						upPstmt = connection.prepareStatement(query2);</span>
<span class="nc" id="L4416">						upPstmt.setString(1, TRANSACTION_TYPE);</span>
<span class="nc" id="L4417">						upPstmt.setLong(2, transaction_id);</span>
						// upPstmt.setDate(3, TRANSACTION_DATE);
<span class="nc" id="L4419">						upPstmt.setTimestamp(3, TRANSACTION_DATE);</span>
<span class="nc" id="L4420">						upPstmt.setString(4, -AMOUNT + &quot;&quot;);</span>
<span class="nc" id="L4421">						upPstmt.setString(5, &quot;BANK_ACC&quot;);</span>
<span class="nc" id="L4422">						upPstmt.setString(6, BANK_ACC_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L4423">						upPstmt.setString(7, orgName);</span>
<span class="nc" id="L4424">						upPstmt.setString(8, RECEIPT_ID);</span>
<span class="nc" id="L4425">						upPstmt.execute();</span>

<span class="nc bnc" id="L4427" title="All 2 branches missed.">						if (upPstmt != null) {</span>
<span class="nc" id="L4428">							upPstmt.close();</span>
						}

<span class="nc" id="L4431">						query1 = QueryManager.getST2InsertBoLedger();</span>
<span class="nc" id="L4432">						updatePstmt = connection.prepareStatement(query1);</span>

<span class="nc" id="L4434">						updatePstmt.setString(1, TRANSACTION_TYPE);</span>
<span class="nc" id="L4435">						updatePstmt.setLong(2, transaction_id);</span>
						// updatePstmt.setDate(3, TRANSACTION_DATE);
<span class="nc" id="L4437">						updatePstmt.setTimestamp(3, TRANSACTION_DATE);</span>
<span class="nc" id="L4438">						updatePstmt.setString(4, AMOUNT + &quot;&quot;);</span>
<span class="nc" id="L4439">						updatePstmt.setString(5, ACC_TYPE);</span>
<span class="nc" id="L4440">						updatePstmt.setString(6, AGENT_ACCOUNT_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L4441">						updatePstmt.setString(7, orgName);</span>
<span class="nc" id="L4442">						updatePstmt.setString(8, RECEIPT_ID);</span>
<span class="nc" id="L4443">						updatePstmt.execute();</span>

<span class="nc bnc" id="L4445" title="All 2 branches missed.">						if (updatePstmt != null) {</span>
<span class="nc" id="L4446">							updatePstmt.close();</span>
						}

<span class="nc" id="L4449">						query3 = QueryManager.getST2UpadateCurrentBalAgent();</span>
<span class="nc" id="L4450">						updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L4451">						updPstmt.setString(1, AGENT_ACCOUNT_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L4452">						updPstmt.setString(2, &quot;AGENT_ACC&quot;);</span>
<span class="nc" id="L4453">						updPstmt.setString(3, ACC_TYPE);</span>
<span class="nc" id="L4454">						updPstmt.execute();</span>

<span class="nc bnc" id="L4456" title="All 2 branches missed.">						if (updPstmt != null) {</span>
<span class="nc" id="L4457">							updPstmt.close();</span>
						}

<span class="nc bnc" id="L4460" title="All 4 branches missed.">					} else if (TRANSACTION_TYPE.equalsIgnoreCase(&quot;pwt_plr&quot;)</span>
							|| TRANSACTION_TYPE.equalsIgnoreCase(&quot;dg_pwt_plr&quot;)) {

<span class="nc" id="L4463">						double PWT_AMT = 0;</span>
<span class="nc" id="L4464">						double TAX_AMT = 0;</span>
<span class="nc" id="L4465">						double NET_AMT = 0;</span>
<span class="nc" id="L4466">						String directPwtPlrQry = &quot;&quot;;</span>
<span class="nc bnc" id="L4467" title="All 2 branches missed.">						if (TRANSACTION_TYPE.equalsIgnoreCase(&quot;dg_pwt_plr&quot;)) {</span>
<span class="nc" id="L4468">							directPwtPlrQry = QueryManager.getST2BoDGPwtPlr();</span>
						} else {
<span class="nc" id="L4470">							directPwtPlrQry = QueryManager.getST2BoPwtPlr();</span>
						}
<span class="nc" id="L4472">						stmt = connection.prepareStatement(directPwtPlrQry);</span>
<span class="nc" id="L4473">						stmt.setLong(1, transaction_id);</span>
<span class="nc" id="L4474">						rs = stmt.executeQuery();</span>
						// This has been replaced by the obove prepared
						// statements statements 07-03-08
						// rs =
						// stmt.executeQuery(QueryManager.getST2BoPwtPlr()+&quot;&quot;+
						// transaction_id + &quot;&quot;);
<span class="nc bnc" id="L4480" title="All 2 branches missed.">						while (rs.next()) {</span>
<span class="nc" id="L4481">							PWT_AMT = rs.getDouble(&quot;pwt_amt&quot;);</span>
<span class="nc" id="L4482">							TAX_AMT = rs.getDouble(&quot;tax_amt&quot;);</span>
<span class="nc" id="L4483">							NET_AMT = rs.getDouble(&quot;net_amt&quot;);</span>
<span class="nc" id="L4484">							TRANSACTION_TYPE = rs.getString(&quot;transaction_type&quot;);</span>
							// TRANSACTION_DATE =
							// rs.getDate(&quot;transaction_date&quot;);
<span class="nc" id="L4487">							TRANSACTION_DATE = rs</span>
									.getTimestamp(&quot;transaction_date&quot;);
<span class="nc" id="L4489">							orgName = rs.getString(&quot;first_name&quot;);</span>
						}

<span class="nc" id="L4492">						logger.debug(&quot;LH-BO**&quot; + TRANSACTION_DATE + &quot;**AMT-&quot;</span>
								+ AMOUNT + &quot;**ACT_TYPE-&quot; + ACC_TYPE + &quot;**&quot;
								+ PLAYER_CASH_CURRENT + &quot; PLAYER_TDS_CURRENT =&quot;
								+ PLAYER_TDS_CURRENT + &quot;PLAYER_PWT_CURRENT =&quot;
								+ PLAYER_PWT_CURRENT);
<span class="nc" id="L4497">						logger.debug(&quot;In PWT_PAY_CURRENT is =&quot;</span>
								+ FormatNumber.formatNumber(PWT_PAY_CURRENT)
								+ &quot; TDS_PAY_CURRENT = &quot; + TDS_PAY_CURRENT
								+ &quot;BANK_ACC_CURRENT =&quot;
								+ FormatNumber.formatNumber(BANK_ACC_CURRENT));

<span class="nc" id="L4503">						stmt</span>
								.executeUpdate(&quot;insert into st_lms_bo_ledger (transaction_type, transaction_id,transaction_date,amount,account_type,balance,transaction_with,receipt_id) values ('&quot;
										+ TRANSACTION_TYPE
										+ &quot;',&quot;
										+ transaction_id
										+ &quot;,'&quot;
										+ TRANSACTION_DATE
										+ &quot;',&quot;
										+ (-PWT_AMT + &quot;&quot;)
										+ &quot;,'PWT_PAY',&quot;
										+ FormatNumber
												.formatNumber(PWT_PAY_CURRENT)
										+ &quot;, '&quot;
										+ orgName
										+ &quot;','&quot;
										+ RECEIPT_ID
										+ &quot;')&quot;);

<span class="nc" id="L4521">						stmt</span>
								.executeUpdate(&quot;insert into st_lms_bo_ledger (transaction_type, transaction_id,transaction_date,amount,account_type,balance,transaction_with,receipt_id) values ('&quot;
										+ TRANSACTION_TYPE
										+ &quot;',&quot;
										+ transaction_id
										+ &quot;,'&quot;
										+ TRANSACTION_DATE
										+ &quot;',&quot;
										+ FormatNumber.formatNumber(PWT_AMT)
										+ &quot;,'PLAYER_PWT',&quot;
										+ FormatNumber
												.formatNumber(PLAYER_PWT_CURRENT)
										+ &quot;, '&quot;
										+ orgName
										+ &quot;','&quot;
										+ RECEIPT_ID
										+ &quot;')&quot;);

<span class="nc" id="L4539">						stmt</span>
								.executeUpdate(&quot;insert into st_lms_bo_ledger (transaction_type, transaction_id,transaction_date,amount,account_type,balance,transaction_with,receipt_id) values ('&quot;
										+ TRANSACTION_TYPE
										+ &quot;',&quot;
										+ transaction_id
										+ &quot;,'&quot;
										+ TRANSACTION_DATE
										+ &quot;',&quot;
										+ (-TAX_AMT + &quot;&quot;)
										+ &quot;,'PLAYER_TDS',&quot;
										+ FormatNumber
												.formatNumber(PLAYER_TDS_CURRENT)
										+ &quot;, '&quot;
										+ orgName
										+ &quot;','&quot;
										+ RECEIPT_ID
										+ &quot;')&quot;);
<span class="nc" id="L4556">						stmt</span>
								.executeUpdate(&quot;insert into st_lms_bo_ledger (transaction_type, transaction_id,transaction_date,amount,account_type,balance,transaction_with,receipt_id) values ('&quot;
										+ TRANSACTION_TYPE
										+ &quot;',&quot;
										+ transaction_id
										+ &quot;,'&quot;
										+ TRANSACTION_DATE
										+ &quot;',&quot;
										+ TAX_AMT
										+ &quot;&quot;
										+ &quot;,'TDS_PAY',&quot;
										+ FormatNumber
												.formatNumber(TDS_PAY_CURRENT)
										+ &quot;, '&quot;
										+ orgName
										+ &quot;','&quot;
										+ RECEIPT_ID
										+ &quot;' )&quot;);

<span class="nc" id="L4575">						stmt</span>
								.executeUpdate(&quot;insert into st_lms_bo_ledger (transaction_type, transaction_id,transaction_date,amount,account_type,balance,transaction_with,receipt_id) values ('&quot;
										+ TRANSACTION_TYPE
										+ &quot;',&quot;
										+ transaction_id
										+ &quot;,'&quot;
										+ TRANSACTION_DATE
										+ &quot;',&quot;
										+ (-NET_AMT + &quot;&quot;)
										+ &quot;,'PLAYER_CAS',&quot;
										+ FormatNumber
												.formatNumber(PLAYER_CASH_CURRENT)
										+ &quot;, '&quot;
										+ orgName
										+ &quot;','&quot;
										+ RECEIPT_ID
										+ &quot;' )&quot;);

<span class="nc" id="L4593">						stmt</span>
								.executeUpdate(&quot;insert into st_lms_bo_ledger (transaction_type, transaction_id,transaction_date,amount,account_type,balance,transaction_with,receipt_id) values ('&quot;
										+ TRANSACTION_TYPE
										+ &quot;',&quot;
										+ transaction_id
										+ &quot;,'&quot;
										+ TRANSACTION_DATE
										+ &quot;',&quot;
										+ FormatNumber.formatNumber(NET_AMT)
										+ &quot;,'BANK_ACC',&quot;
										+ FormatNumber
												.formatNumber(BANK_ACC_CURRENT)
										+ &quot;, '&quot;
										+ orgName
										+ &quot;','&quot;
										+ RECEIPT_ID
										+ &quot;' )&quot;);

<span class="nc bnc" id="L4611" title="All 2 branches missed.">						if (stmt != null) {</span>
<span class="nc" id="L4612">							stmt.close();</span>
						}
<span class="nc bnc" id="L4614" title="All 2 branches missed.">						if (rs != null) {</span>
<span class="nc" id="L4615">							rs.close();</span>
						}

<span class="nc" id="L4618">					}</span>

<span class="nc bnc" id="L4620" title="All 2 branches missed.">					else if (TRANSACTION_TYPE.equalsIgnoreCase(&quot;tds&quot;)) {</span>
						// System.out.println(&quot;in TDS&quot;);
<span class="nc" id="L4622">						stmt2 = connection.prepareStatement(QueryManager</span>
								.getST2BoTds());
<span class="nc" id="L4624">						stmt2.setLong(1, transaction_id);</span>
<span class="nc" id="L4625">						rs2 = stmt2.executeQuery();</span>
						// This has been replaced by the obove prepared
						// statements statements 07-03-08
						// rs2 =
						// stmt2.executeQuery(QueryManager.getST2BoTds()+&quot;&quot;+
						// transaction_id + &quot;&quot;);

<span class="nc bnc" id="L4632" title="All 2 branches missed.">						while (rs2.next()) {</span>
<span class="nc" id="L4633">							AMOUNT = rs2.getDouble(&quot;amount&quot;);</span>
							// TRANSACTION_DATE =
							// rs2.getDate(&quot;transaction_date&quot;);
<span class="nc" id="L4636">							TRANSACTION_DATE = rs2</span>
									.getTimestamp(&quot;transaction_date&quot;);
<span class="nc" id="L4638">							ACC_TYPE = &quot;TDS_PAY&quot;;</span>
						}

<span class="nc bnc" id="L4641" title="All 2 branches missed.">						if (stmt2 != null) {</span>
<span class="nc" id="L4642">							stmt2.close();</span>
						}
<span class="nc bnc" id="L4644" title="All 2 branches missed.">						if (rs2 != null) {</span>
<span class="nc" id="L4645">							rs2.close();</span>
						}

						// System.out.println(&quot;Amount-- &quot;+AMOUNT+&quot; TRANS DATE--
						// &quot;+TRANSACTION_DATE+&quot; ACC_TYPE-- &quot;+ACC_TYPE);

<span class="nc" id="L4651">						TDS_PAY_CURRENT = TDS_PAY_CURRENT - AMOUNT;</span>
<span class="nc" id="L4652">						BANK_ACC_CURRENT = BANK_ACC_CURRENT + AMOUNT;</span>
						// System.out.println(&quot;TDS ACC CUR--
						// &quot;+TDS_PAY_CURRENT+&quot;Bank ACC
						// CUR&quot;+BANK_ACC_CURRENT+&quot;&quot;);
<span class="nc" id="L4656">						logger.debug(&quot;LH-BO**&quot; + TRANSACTION_DATE + &quot;**AMT-&quot;</span>
								+ AMOUNT + &quot;**ACT_TYPE-&quot; + ACC_TYPE
								+ &quot;**TDS_ACC=&quot; + TDS_PAY_CURRENT + &quot;**BANK_ACC&quot;
								+ BANK_ACC_CURRENT);

<span class="nc" id="L4661">						query1 = QueryManager.getST2InsertBoLedger();</span>
<span class="nc" id="L4662">						updatePstmt = connection.prepareStatement(query1);</span>

<span class="nc" id="L4664">						updatePstmt.setString(1, TRANSACTION_TYPE);</span>
<span class="nc" id="L4665">						updatePstmt.setLong(2, transaction_id);</span>
						// updatePstmt.setDate(3, TRANSACTION_DATE);
<span class="nc" id="L4667">						updatePstmt.setTimestamp(3, TRANSACTION_DATE);</span>
<span class="nc" id="L4668">						updatePstmt.setString(4, -AMOUNT + &quot;&quot;);</span>
<span class="nc" id="L4669">						updatePstmt.setString(5, ACC_TYPE);</span>
<span class="nc" id="L4670">						updatePstmt.setString(6, TDS_PAY_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L4671">						updatePstmt.setString(7, &quot;GOVERNMENT&quot;);</span>
<span class="nc" id="L4672">						updatePstmt.setString(8, RECEIPT_ID);</span>

<span class="nc" id="L4674">						updatePstmt.execute();</span>

<span class="nc bnc" id="L4676" title="All 2 branches missed.">						if (updatePstmt != null) {</span>
<span class="nc" id="L4677">							updatePstmt.close();</span>
						}

<span class="nc" id="L4680">						query2 = QueryManager.getST2InsertBoLedger();</span>
<span class="nc" id="L4681">						upPstmt = connection.prepareStatement(query2);</span>
<span class="nc" id="L4682">						upPstmt.setString(1, TRANSACTION_TYPE);</span>
<span class="nc" id="L4683">						upPstmt.setLong(2, transaction_id);</span>
						// upPstmt.setDate(3, TRANSACTION_DATE);
<span class="nc" id="L4685">						upPstmt.setTimestamp(3, TRANSACTION_DATE);</span>
<span class="nc" id="L4686">						upPstmt.setString(4, AMOUNT + &quot;&quot;);</span>
<span class="nc" id="L4687">						upPstmt.setString(5, &quot;BANK_ACC&quot;);</span>
<span class="nc" id="L4688">						upPstmt.setString(6, BANK_ACC_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L4689">						upPstmt.setString(7, &quot;GOVERNMENT&quot;);</span>
<span class="nc" id="L4690">						upPstmt.setString(8, RECEIPT_ID);</span>
<span class="nc" id="L4691">						upPstmt.execute();</span>

<span class="nc bnc" id="L4693" title="All 2 branches missed.">						if (upPstmt != null) {</span>
<span class="nc" id="L4694">							upPstmt.close();</span>
						}

<span class="nc bnc" id="L4697" title="All 2 branches missed.">					} else if (TRANSACTION_TYPE.equalsIgnoreCase(&quot;govt_comm&quot;)) {</span>
						// System.out.println(&quot;in Govt COmm&quot;);
<span class="nc" id="L4699">						stmt2 = connection.prepareStatement(QueryManager</span>
								.getST2BoGovtComm());
<span class="nc" id="L4701">						stmt2.setLong(1, transaction_id);</span>
<span class="nc" id="L4702">						rs2 = stmt2.executeQuery();</span>
						// This has been replaced by the obove prepared
						// statements statements 07-03-08
						// rs2 =
						// stmt2.executeQuery(QueryManager.getST2BoGovtComm()+&quot;&quot;+
						// transaction_id + &quot;&quot;);

<span class="nc bnc" id="L4709" title="All 2 branches missed.">						while (rs2.next()) {</span>
<span class="nc" id="L4710">							AMOUNT = rs2.getDouble(&quot;amount&quot;);</span>
							// TRANSACTION_DATE =
							// rs2.getDate(&quot;transaction_date&quot;);
<span class="nc" id="L4713">							TRANSACTION_DATE = rs2</span>
									.getTimestamp(&quot;transaction_date&quot;);
<span class="nc" id="L4715">							ACC_TYPE = &quot;GOVT_COMM&quot;;</span>
						}

<span class="nc bnc" id="L4718" title="All 2 branches missed.">						if (stmt2 != null) {</span>
<span class="nc" id="L4719">							stmt2.close();</span>
						}
<span class="nc bnc" id="L4721" title="All 2 branches missed.">						if (rs2 != null) {</span>
<span class="nc" id="L4722">							rs2.close();</span>
						}

						// System.out.println(&quot;Amount-- &quot;+AMOUNT+&quot; TRANS DATE--
						// &quot;+TRANSACTION_DATE+&quot; ACC_TYPE-- &quot;+ACC_TYPE);

<span class="nc" id="L4728">						GOVT_COMM_CURRENT = GOVT_COMM_CURRENT - AMOUNT;</span>
<span class="nc" id="L4729">						BANK_ACC_CURRENT = BANK_ACC_CURRENT + AMOUNT;</span>
						// System.out.println(&quot;GOVT ACC CUR--
						// &quot;+GOVT_COMM_CURRENT+&quot;Bank ACC
						// CUR&quot;+BANK_ACC_CURRENT+&quot;&quot;);
<span class="nc" id="L4733">						logger.debug(&quot;LH-BO**&quot; + TRANSACTION_DATE + &quot;**AMT-&quot;</span>
								+ AMOUNT + &quot;**ACT_TYPE-&quot; + ACC_TYPE
								+ &quot;**GOVT_ACC=&quot; + GOVT_COMM_CURRENT
								+ &quot;**BANK_ACC&quot; + BANK_ACC_CURRENT);

<span class="nc" id="L4738">						query1 = QueryManager.getST2InsertBoLedger();</span>
<span class="nc" id="L4739">						updatePstmt = connection.prepareStatement(query1);</span>

<span class="nc" id="L4741">						updatePstmt.setString(1, TRANSACTION_TYPE);</span>
<span class="nc" id="L4742">						updatePstmt.setLong(2, transaction_id);</span>
						// updatePstmt.setDate(3, TRANSACTION_DATE);
<span class="nc" id="L4744">						updatePstmt.setTimestamp(3, TRANSACTION_DATE);</span>
<span class="nc" id="L4745">						updatePstmt.setString(4, -AMOUNT + &quot;&quot;);</span>
<span class="nc" id="L4746">						updatePstmt.setString(5, ACC_TYPE);</span>
<span class="nc" id="L4747">						updatePstmt.setString(6, GOVT_COMM_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L4748">						updatePstmt.setString(7, &quot;GOVERNMENT&quot;);</span>
<span class="nc" id="L4749">						updatePstmt.setString(8, RECEIPT_ID);</span>
<span class="nc" id="L4750">						updatePstmt.execute();</span>

<span class="nc bnc" id="L4752" title="All 2 branches missed.">						if (updatePstmt != null) {</span>
<span class="nc" id="L4753">							updatePstmt.close();</span>
						}

<span class="nc" id="L4756">						query2 = QueryManager.getST2InsertBoLedger();</span>
<span class="nc" id="L4757">						upPstmt = connection.prepareStatement(query2);</span>
<span class="nc" id="L4758">						upPstmt.setString(1, TRANSACTION_TYPE);</span>
<span class="nc" id="L4759">						upPstmt.setLong(2, transaction_id);</span>
						// upPstmt.setDate(3, TRANSACTION_DATE);
<span class="nc" id="L4761">						upPstmt.setTimestamp(3, TRANSACTION_DATE);</span>
<span class="nc" id="L4762">						upPstmt.setString(4, AMOUNT + &quot;&quot;);</span>
<span class="nc" id="L4763">						upPstmt.setString(5, &quot;BANK_ACC&quot;);</span>
<span class="nc" id="L4764">						upPstmt.setString(6, BANK_ACC_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L4765">						upPstmt.setString(7, &quot;GOVERNMENT&quot;);</span>
<span class="nc" id="L4766">						upPstmt.setString(8, RECEIPT_ID);</span>
<span class="nc" id="L4767">						upPstmt.execute();</span>

<span class="nc bnc" id="L4769" title="All 2 branches missed.">						if (upPstmt != null) {</span>
<span class="nc" id="L4770">							upPstmt.close();</span>
						}

					}
					/*
					 * added on 7-12-2008 on Abhisheks recommendations
					 */
<span class="nc bnc" id="L4777" title="All 2 branches missed.">					else if (TRANSACTION_TYPE.equalsIgnoreCase(&quot;vat&quot;)) {</span>

						// System.out.println(&quot;in VAT&quot;);
<span class="nc" id="L4780">						stmt2 = connection.prepareStatement(QueryManager</span>
								.getST6BoVATPayable());
<span class="nc" id="L4782">						stmt2.setLong(1, transaction_id);</span>
<span class="nc" id="L4783">						rs2 = stmt2.executeQuery();</span>
						// This has been replaced by the obove prepared
						// statements statements 07-03-08
						// rs2 =
						// stmt2.executeQuery(QueryManager.getST2BoGovtComm()+&quot;&quot;+
						// transaction_id + &quot;&quot;);

<span class="nc bnc" id="L4790" title="All 2 branches missed.">						while (rs2.next()) {</span>
<span class="nc" id="L4791">							AMOUNT = rs2.getDouble(&quot;amount&quot;);</span>
							// TRANSACTION_DATE =
							// rs2.getDate(&quot;transaction_date&quot;);
<span class="nc" id="L4794">							TRANSACTION_DATE = rs2</span>
									.getTimestamp(&quot;transaction_date&quot;);
<span class="nc" id="L4796">							ACC_TYPE = &quot;VAT_PAY&quot;;</span>
						}

<span class="nc bnc" id="L4799" title="All 2 branches missed.">						if (stmt2 != null) {</span>
<span class="nc" id="L4800">							stmt2.close();</span>
						}
<span class="nc bnc" id="L4802" title="All 2 branches missed.">						if (rs2 != null) {</span>
<span class="nc" id="L4803">							rs2.close();</span>
						}

						// System.out.println(&quot;Amount-- &quot;+AMOUNT+&quot; TRANS DATE--
						// &quot;+TRANSACTION_DATE+&quot; ACC_TYPE-- &quot;+ACC_TYPE);

<span class="nc" id="L4809">						VAT_PAY_CURRENT = VAT_PAY_CURRENT - AMOUNT;</span>
<span class="nc" id="L4810">						BANK_ACC_CURRENT = BANK_ACC_CURRENT + AMOUNT;</span>
						// System.out.println(&quot;VAT_PAY_CURRENT--
						// &quot;+VAT_PAY_CURRENT+&quot;Bank ACC
						// CUR&quot;+BANK_ACC_CURRENT+&quot;&quot;);
<span class="nc" id="L4814">						logger.debug(&quot;LH-BO**&quot; + TRANSACTION_DATE + &quot;**AMT-&quot;</span>
								+ AMOUNT + &quot;**ACT_TYPE-&quot; + ACC_TYPE
								+ &quot;**VAT_ACC=&quot; + VAT_PAY_CURRENT + &quot;**BANK_ACC&quot;
								+ BANK_ACC_CURRENT);

<span class="nc" id="L4819">						query1 = QueryManager.getST2InsertBoLedger();</span>
<span class="nc" id="L4820">						updatePstmt = connection.prepareStatement(query1);</span>

<span class="nc" id="L4822">						updatePstmt.setString(1, TRANSACTION_TYPE);</span>
<span class="nc" id="L4823">						updatePstmt.setLong(2, transaction_id);</span>
						// updatePstmt.setDate(3, TRANSACTION_DATE);
<span class="nc" id="L4825">						updatePstmt.setTimestamp(3, TRANSACTION_DATE);</span>
<span class="nc" id="L4826">						updatePstmt.setString(4, -AMOUNT + &quot;&quot;);</span>
<span class="nc" id="L4827">						updatePstmt.setString(5, ACC_TYPE);</span>
<span class="nc" id="L4828">						updatePstmt.setString(6, VAT_PAY_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L4829">						updatePstmt.setString(7, &quot;GOVERNMENT&quot;);</span>
<span class="nc" id="L4830">						updatePstmt.setString(8, RECEIPT_ID);</span>
<span class="nc" id="L4831">						updatePstmt.execute();</span>

<span class="nc bnc" id="L4833" title="All 2 branches missed.">						if (updatePstmt != null) {</span>
<span class="nc" id="L4834">							updatePstmt.close();</span>
						}

<span class="nc" id="L4837">						query2 = QueryManager.getST2InsertBoLedger();</span>
<span class="nc" id="L4838">						upPstmt = connection.prepareStatement(query2);</span>
<span class="nc" id="L4839">						upPstmt.setString(1, TRANSACTION_TYPE);</span>
<span class="nc" id="L4840">						upPstmt.setLong(2, transaction_id);</span>
						// upPstmt.setDate(3, TRANSACTION_DATE);
<span class="nc" id="L4842">						upPstmt.setTimestamp(3, TRANSACTION_DATE);</span>
<span class="nc" id="L4843">						upPstmt.setString(4, AMOUNT + &quot;&quot;);</span>
<span class="nc" id="L4844">						upPstmt.setString(5, &quot;BANK_ACC&quot;);</span>
<span class="nc" id="L4845">						upPstmt.setString(6, BANK_ACC_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L4846">						upPstmt.setString(7, &quot;GOVERNMENT&quot;);</span>
<span class="nc" id="L4847">						upPstmt.setString(8, RECEIPT_ID);</span>
<span class="nc" id="L4848">						upPstmt.execute();</span>

<span class="nc bnc" id="L4850" title="All 2 branches missed.">						if (upPstmt != null) {</span>
<span class="nc" id="L4851">							upPstmt.close();</span>
						}

					}

<span class="nc bnc" id="L4856" title="All 2 branches missed.">					else if (TRANSACTION_TYPE.equalsIgnoreCase(&quot;unclm_pwt&quot;)) {</span>
						// System.out.println(&quot;in UNCLM PWT&quot;);
<span class="nc" id="L4858">						stmt2 = connection.prepareStatement(QueryManager</span>
								.getST2BoUnclmPwt());
<span class="nc" id="L4860">						stmt2.setLong(1, transaction_id);</span>
<span class="nc" id="L4861">						rs2 = stmt2.executeQuery();</span>
						// This has been replaced by the obove prepared
						// statements statements 07-03-08
						// rs2 =
						// stmt2.executeQuery(QueryManager.getST2BoUnclmPwt()+&quot;&quot;+
						// transaction_id + &quot;&quot;);

<span class="nc bnc" id="L4868" title="All 2 branches missed.">						while (rs2.next()) {</span>
<span class="nc" id="L4869">							AMOUNT = rs2.getDouble(&quot;amount&quot;);</span>
							// TRANSACTION_DATE =
							// rs2.getDate(&quot;transaction_date&quot;);
<span class="nc" id="L4872">							TRANSACTION_DATE = rs2</span>
									.getTimestamp(&quot;transaction_date&quot;);
<span class="nc" id="L4874">							ACC_TYPE = &quot;UNCLM_GOVT&quot;;</span>
						}

<span class="nc bnc" id="L4877" title="All 2 branches missed.">						if (stmt2 != null) {</span>
<span class="nc" id="L4878">							stmt2.close();</span>
						}
<span class="nc bnc" id="L4880" title="All 2 branches missed.">						if (rs2 != null) {</span>
<span class="nc" id="L4881">							rs2.close();</span>
						}
						// System.out.println(&quot;Amount-- &quot;+AMOUNT+&quot; TRANS DATE--
						// &quot;+TRANSACTION_DATE+&quot; ACC_TYPE-- &quot;+ACC_TYPE);

<span class="nc" id="L4886">						UNCLM_GOVT_CURRENT = UNCLM_GOVT_CURRENT - AMOUNT;</span>
<span class="nc" id="L4887">						BANK_ACC_CURRENT = BANK_ACC_CURRENT + AMOUNT;</span>
						// System.out.println(&quot;UNCLM ACC CUR--
						// &quot;+UNCLM_GOVT_CURRENT+&quot;Bank ACC
						// CUR&quot;+BANK_ACC_CURRENT+&quot;&quot;);
<span class="nc" id="L4891">						logger.debug(&quot;LH-BO**&quot; + TRANSACTION_DATE + &quot;**AMT-&quot;</span>
								+ AMOUNT + &quot;**ACT_TYPE-&quot; + ACC_TYPE
								+ &quot;**UNCLM_GOVT_ACC=&quot; + UNCLM_GOVT_CURRENT
								+ &quot;**BANK_ACC&quot; + BANK_ACC_CURRENT);

<span class="nc" id="L4896">						query1 = QueryManager.getST2InsertBoLedger();</span>
<span class="nc" id="L4897">						updatePstmt = connection.prepareStatement(query1);</span>

<span class="nc" id="L4899">						updatePstmt.setString(1, TRANSACTION_TYPE);</span>
<span class="nc" id="L4900">						updatePstmt.setLong(2, transaction_id);</span>
						// updatePstmt.setDate(3, TRANSACTION_DATE);
<span class="nc" id="L4902">						updatePstmt.setTimestamp(3, TRANSACTION_DATE);</span>
<span class="nc" id="L4903">						updatePstmt.setString(4, -AMOUNT + &quot;&quot;);</span>
<span class="nc" id="L4904">						updatePstmt.setString(5, ACC_TYPE);</span>
<span class="nc" id="L4905">						updatePstmt.setString(6, UNCLM_GOVT_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L4906">						updatePstmt.setString(7, &quot;GOVERNMENT&quot;);</span>
<span class="nc" id="L4907">						updatePstmt.setString(8, RECEIPT_ID);</span>
<span class="nc" id="L4908">						updatePstmt.execute();</span>

<span class="nc bnc" id="L4910" title="All 2 branches missed.">						if (updatePstmt != null) {</span>
<span class="nc" id="L4911">							updatePstmt.close();</span>
						}

<span class="nc" id="L4914">						query2 = QueryManager.getST2InsertBoLedger();</span>
<span class="nc" id="L4915">						upPstmt = connection.prepareStatement(query2);</span>
<span class="nc" id="L4916">						upPstmt.setString(1, TRANSACTION_TYPE);</span>
<span class="nc" id="L4917">						upPstmt.setLong(2, transaction_id);</span>
						// upPstmt.setDate(3, TRANSACTION_DATE);
<span class="nc" id="L4919">						upPstmt.setTimestamp(3, TRANSACTION_DATE);</span>
<span class="nc" id="L4920">						upPstmt.setString(4, AMOUNT + &quot;&quot;);</span>
<span class="nc" id="L4921">						upPstmt.setString(5, &quot;BANK_ACC&quot;);</span>
<span class="nc" id="L4922">						upPstmt.setString(6, BANK_ACC_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L4923">						upPstmt.setString(7, &quot;GOVERNMENT&quot;);</span>
<span class="nc" id="L4924">						upPstmt.setString(8, RECEIPT_ID);</span>
<span class="nc" id="L4925">						upPstmt.execute();</span>

<span class="nc bnc" id="L4927" title="All 2 branches missed.">						if (upPstmt != null) {</span>
<span class="nc" id="L4928">							upPstmt.close();</span>
						}

<span class="nc bnc" id="L4931" title="All 10 branches missed.">					} else if (TRANSACTION_TYPE.equalsIgnoreCase(&quot;pwt&quot;)</span>
							|| TRANSACTION_TYPE.equalsIgnoreCase(&quot;pwt_auto&quot;)
							|| TRANSACTION_TYPE.equalsIgnoreCase(&quot;DG_PWT&quot;)
							|| TRANSACTION_TYPE.equalsIgnoreCase(&quot;DG_PWT_AUTO&quot;) || TRANSACTION_TYPE.equalsIgnoreCase(&quot;OLA_WITHDRAWL&quot;)) {
						// System.out.println(&quot;in PWT&quot;);
						// System.out.println(&quot;in pwtttttt&quot;);
<span class="nc" id="L4937">						String pwtQuery = &quot;&quot;;</span>
<span class="nc" id="L4938">						double PWT_CHARGES_AMOUNT = 0.0;</span>
<span class="nc bnc" id="L4939" title="All 4 branches missed.">						if (TRANSACTION_TYPE.equalsIgnoreCase(&quot;DG_PWT&quot;)</span>
								|| TRANSACTION_TYPE
										.equalsIgnoreCase(&quot;DG_PWT_AUTO&quot;)) {
<span class="nc" id="L4942">							pwtQuery = QueryManager.getST2BoDrGmPwtPay();</span>
							// System.out.println(&quot;getST2BoDrGmPwtPay &quot; +
							// pwtQuery);
						} 
<span class="nc bnc" id="L4946" title="All 2 branches missed.">						else if(TRANSACTION_TYPE.equalsIgnoreCase(&quot;OLA_WITHDRAWL&quot;))</span>
							{
<span class="nc" id="L4948">							pwtQuery =  QueryManager.getST2BoOlaWithdrawl();</span>
							}else {
<span class="nc" id="L4950">							pwtQuery = QueryManager.getST2BoPwtPay();</span>
							// System.out.println(&quot;getST2BoPwtPay &quot; + pwtQuery);
						}
<span class="nc" id="L4953">						stmt2 = connection.prepareStatement(pwtQuery);</span>
<span class="nc" id="L4954">						stmt2.setLong(1, transaction_id);</span>
<span class="nc" id="L4955">						rs2 = stmt2.executeQuery();</span>
						// This has been replaced by the obove prepared
						// statements statements 07-03-08
						// rs2 =
						// stmt2.executeQuery(QueryManager.getST2BoPwtPay()+&quot;&quot;+
						// transaction_id + &quot;&quot;);
<span class="nc bnc" id="L4961" title="All 2 branches missed.">						while (rs2.next()) {</span>
<span class="nc" id="L4962">							AMOUNT = rs2.getDouble(&quot;pwt_amount&quot;);</span>
<span class="nc" id="L4963">							PWT_CHARGES_AMOUNT = rs2.getDouble(&quot;comm_amount&quot;);</span>
							// TRANSACTION_DATE =
							// rs2.getDate(&quot;transaction_date&quot;);
<span class="nc" id="L4966">							TRANSACTION_DATE = rs2</span>
									.getTimestamp(&quot;transaction_date&quot;);
<span class="nc" id="L4968">							ACC_TYPE = &quot;&quot; + rs2.getInt(&quot;agent_org_id&quot;);</span>
<span class="nc" id="L4969">							orgName = rs2.getString(&quot;name&quot;);</span>
						}

<span class="nc bnc" id="L4972" title="All 2 branches missed.">						if (stmt2 != null) {</span>
<span class="nc" id="L4973">							stmt2.close();</span>
						}
<span class="nc bnc" id="L4975" title="All 2 branches missed.">						if (rs2 != null) {</span>
<span class="nc" id="L4976">							rs2.close();</span>
						}

						// System.out.println(&quot;Amount-- &quot;+AMOUNT+&quot; TRANS DATE--
						// &quot;+TRANSACTION_DATE+&quot; ACC_TYPE-- &quot;+ACC_TYPE +&quot;
						// PWT_CHARGES_AMOUNT &quot;+PWT_CHARGES_AMOUNT+&quot;&quot;);

<span class="nc" id="L4983">						stmt = connection.prepareStatement(QueryManager</span>
								.getST2BoCurrentBalAgent());
<span class="nc" id="L4985">						stmt.setString(1, ACC_TYPE);</span>
						// System.out.println(&quot;gggggggggggggggggggg&quot;);
<span class="nc" id="L4987">						rs = stmt.executeQuery();</span>
						// System.out.println(&quot;ffffffffffffffffffffffff&quot;);
						// This has been replaced by the obove prepared
						// statements statements 07-03-08
						// rs =
						// stmt.executeQuery(QueryManager.getST2BoCurrentBalAgent()+&quot;
						// '&quot;+ ACC_TYPE + &quot;'&quot;);
<span class="nc" id="L4994">						int i = 0;</span>
<span class="nc bnc" id="L4995" title="All 2 branches missed.">						while (rs.next()) {</span>
<span class="nc" id="L4996">							AGENT_ACCOUNT_CURRENT = rs</span>
									.getDouble(&quot;current_balance&quot;);
<span class="nc" id="L4998">							i++;</span>
						}

<span class="nc bnc" id="L5001" title="All 2 branches missed.">						if (stmt != null) {</span>
<span class="nc" id="L5002">							stmt.close();</span>
						}
<span class="nc bnc" id="L5004" title="All 2 branches missed.">						if (rs != null) {</span>
<span class="nc" id="L5005">							rs.close();</span>
						}

<span class="nc bnc" id="L5008" title="All 2 branches missed.">						if (i == 0) {</span>
<span class="nc" id="L5009">							query1 = QueryManager.getST2InsertAgentCurrentBal();</span>
<span class="nc" id="L5010">							updatePstmt = connection.prepareStatement(query1);</span>
<span class="nc" id="L5011">							updatePstmt.setString(1, &quot;AGENT_ACC&quot;);</span>
<span class="nc" id="L5012">							updatePstmt.setInt(2, 0);</span>
<span class="nc" id="L5013">							updatePstmt.setString(3, ACC_TYPE);</span>
							// System.out.println(&quot;sdsdsdsd&quot;);
							// System.out.println(&quot;query is : &quot; + updatePstmt +
							// &quot;agent id is &quot; + ACC_TYPE);
<span class="nc" id="L5017">							updatePstmt.execute();</span>
							// System.out.println(&quot;hhhhhhhhh&quot;);
<span class="nc" id="L5019">							AGENT_ACCOUNT_CURRENT = 0.0;</span>

<span class="nc bnc" id="L5021" title="All 2 branches missed.">							if (updatePstmt != null) {</span>
<span class="nc" id="L5022">								updatePstmt.close();</span>
							}

						}

<span class="nc" id="L5027">						AGENT_ACCOUNT_CURRENT = AGENT_ACCOUNT_CURRENT + AMOUNT;</span>
<span class="nc" id="L5028">						PWT_PAY_CURRENT = PWT_PAY_CURRENT - AMOUNT;</span>
						// System.out.println(&quot;In BoLedger trans_id is =
						// &quot;+transaction_id+&quot; tratype = &quot;+TRANSACTION_TYPE+
						// &quot;TRANSACTION_DATE = &quot;+TRANSACTION_DATE+&quot; AGENT
						// curr=&quot;+AGENT_ACCOUNT_CURRENT+&quot;&quot;);
						// System.out.println(&quot;PWT ACC CUR--
						// &quot;+PWT_PAY_CURRENT+&quot;AGENT ACC
						// CUR&quot;+AGENT_ACCOUNT_CURRENT+&quot;&quot;);
<span class="nc" id="L5036">						logger.debug(&quot;LH-BO**&quot; + TRANSACTION_DATE + &quot;**AMT-&quot;</span>
								+ AMOUNT + &quot;**ACT_TYPE-&quot; + ACC_TYPE
								+ &quot;**AGT_ACC=&quot; + AGENT_ACCOUNT_CURRENT
								+ &quot;**PWT_ACC&quot; + PWT_PAY_CURRENT);

<span class="nc" id="L5041">						query2 = QueryManager.getST2InsertBoLedger();</span>
<span class="nc" id="L5042">						upPstmt = connection.prepareStatement(query2);</span>
<span class="nc" id="L5043">						upPstmt.setString(1, TRANSACTION_TYPE);</span>
<span class="nc" id="L5044">						upPstmt.setLong(2, transaction_id);</span>
						// upPstmt.setDate(3, TRANSACTION_DATE);
<span class="nc" id="L5046">						upPstmt.setTimestamp(3, TRANSACTION_DATE);</span>
<span class="nc" id="L5047">						upPstmt.setString(4, -AMOUNT + &quot;&quot;);</span>
<span class="nc" id="L5048">						upPstmt.setString(5, &quot;PWT_PAY&quot;);</span>
<span class="nc" id="L5049">						upPstmt.setString(6, PWT_PAY_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L5050">						upPstmt.setString(7, orgName);</span>
<span class="nc" id="L5051">						upPstmt.setString(8, RECEIPT_ID);</span>
<span class="nc" id="L5052">						upPstmt.execute();</span>

<span class="nc bnc" id="L5054" title="All 2 branches missed.">						if (upPstmt != null) {</span>
<span class="nc" id="L5055">							upPstmt.close();</span>
						}

<span class="nc" id="L5058">						query1 = QueryManager.getST2InsertBoLedger();</span>
<span class="nc" id="L5059">						updatePstmt = connection.prepareStatement(query1);</span>

<span class="nc" id="L5061">						updatePstmt.setString(1, TRANSACTION_TYPE);</span>
<span class="nc" id="L5062">						updatePstmt.setLong(2, transaction_id);</span>
						// updatePstmt.setDate(3, TRANSACTION_DATE);
<span class="nc" id="L5064">						updatePstmt.setTimestamp(3, TRANSACTION_DATE);</span>
<span class="nc" id="L5065">						updatePstmt.setString(4, AMOUNT + &quot;&quot;);</span>
<span class="nc" id="L5066">						updatePstmt.setString(5, ACC_TYPE);</span>
<span class="nc" id="L5067">						updatePstmt.setString(6, AGENT_ACCOUNT_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L5068">						updatePstmt.setString(7, orgName);</span>
<span class="nc" id="L5069">						updatePstmt.setString(8, RECEIPT_ID);</span>
<span class="nc" id="L5070">						updatePstmt.execute();</span>

<span class="nc bnc" id="L5072" title="All 2 branches missed.">						if (updatePstmt != null) {</span>
<span class="nc" id="L5073">							updatePstmt.close();</span>
						}

<span class="nc" id="L5076">						query3 = QueryManager.getST2UpadateCurrentBalAgent();</span>
<span class="nc" id="L5077">						updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L5078">						updPstmt.setString(1, AGENT_ACCOUNT_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L5079">						updPstmt.setString(2, &quot;AGENT_ACC&quot;);</span>
<span class="nc" id="L5080">						updPstmt.setString(3, ACC_TYPE);</span>
<span class="nc" id="L5081">						updPstmt.execute();</span>

<span class="nc bnc" id="L5083" title="All 2 branches missed.">						if (updPstmt != null) {</span>
<span class="nc" id="L5084">							updPstmt.close();</span>
						}

						/*
						 * moved below after changes for collection charges
						 * 
						 * query3 = QueryManager.getST2UpadateCurrentBalAgent();
						 * updPstmt=connection.prepareStatement(query3);
						 * updPstmt.setString(1, AGENT_ACCOUNT_CURRENT+&quot;&quot;);
						 * updPstmt.setString(2, &quot;AGENT_ACC&quot;);
						 * updPstmt.setString(3, ACC_TYPE); updPstmt.execute();
						 */

						/*
						 * added for pwt collection charges 08-12-2008
						 */
<span class="nc" id="L5100">						AGENT_ACCOUNT_CURRENT = AGENT_ACCOUNT_CURRENT</span>
								+ PWT_CHARGES_AMOUNT;
<span class="nc" id="L5102">						PWT_CHARGES_CURRENT = PWT_CHARGES_CURRENT</span>
								- PWT_CHARGES_AMOUNT;
						// System.out.println(&quot;In BoLedger trans_id is =
						// &quot;+transaction_id+&quot; tratype = &quot;+TRANSACTION_TYPE+
						// &quot;TRANSACTION_DATE = &quot;+TRANSACTION_DATE+&quot; AGENT
						// curr=&quot;+AGENT_ACCOUNT_CURRENT+&quot;&quot;);
						// System.out.println(&quot;PWT_CHARGES_CURRENT--
						// &quot;+PWT_CHARGES_CURRENT+&quot;AGENT ACC
						// CUR&quot;+AGENT_ACCOUNT_CURRENT+&quot;&quot;);

<span class="nc bnc" id="L5112" title="All 2 branches missed.">						if (PWT_CHARGES_AMOUNT != 0.0) {</span>
<span class="nc" id="L5113">							query2 = QueryManager.getST2InsertBoLedger();</span>
<span class="nc" id="L5114">							upPstmt = connection.prepareStatement(query2);</span>
<span class="nc" id="L5115">							upPstmt.setString(1, TRANSACTION_TYPE);</span>
<span class="nc" id="L5116">							upPstmt.setLong(2, transaction_id);</span>
							// upPstmt.setDate(3, TRANSACTION_DATE);
<span class="nc" id="L5118">							upPstmt.setTimestamp(3, TRANSACTION_DATE);</span>
<span class="nc" id="L5119">							upPstmt.setString(4, -PWT_CHARGES_AMOUNT + &quot;&quot;);</span>
<span class="nc" id="L5120">							upPstmt.setString(5, &quot;PWT_CHARGES&quot;);</span>
<span class="nc" id="L5121">							upPstmt.setString(6, PWT_CHARGES_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L5122">							upPstmt.setString(7, orgName);</span>
<span class="nc" id="L5123">							upPstmt.setString(8, RECEIPT_ID);</span>
<span class="nc" id="L5124">							upPstmt.execute();</span>

<span class="nc bnc" id="L5126" title="All 2 branches missed.">							if (upPstmt != null) {</span>
<span class="nc" id="L5127">								upPstmt.close();</span>
							}

<span class="nc" id="L5130">							query1 = QueryManager.getST2InsertBoLedger();</span>
<span class="nc" id="L5131">							updatePstmt = connection.prepareStatement(query1);</span>

<span class="nc" id="L5133">							updatePstmt.setString(1, TRANSACTION_TYPE);</span>
<span class="nc" id="L5134">							updatePstmt.setLong(2, transaction_id);</span>
							// updatePstmt.setDate(3, TRANSACTION_DATE);
<span class="nc" id="L5136">							updatePstmt.setTimestamp(3, TRANSACTION_DATE);</span>
<span class="nc" id="L5137">							updatePstmt.setString(4, PWT_CHARGES_AMOUNT + &quot;&quot;);</span>
<span class="nc" id="L5138">							updatePstmt.setString(5, ACC_TYPE + &quot;#&quot;);</span>
<span class="nc" id="L5139">							updatePstmt</span>
									.setString(6, AGENT_ACCOUNT_CURRENT + &quot;&quot;);
<span class="nc" id="L5141">							updatePstmt.setString(7, orgName);</span>
<span class="nc" id="L5142">							updatePstmt.setString(8, RECEIPT_ID);</span>
<span class="nc" id="L5143">							updatePstmt.execute();</span>

<span class="nc bnc" id="L5145" title="All 2 branches missed.">							if (updatePstmt != null) {</span>
<span class="nc" id="L5146">								updatePstmt.close();</span>
							}

						}

<span class="nc" id="L5151">						query3 = QueryManager.getST2UpadateCurrentBalAgent();</span>
<span class="nc" id="L5152">						updPstmt = connection.prepareStatement(query3);</span>
<span class="nc" id="L5153">						updPstmt.setString(1, AGENT_ACCOUNT_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L5154">						updPstmt.setString(2, &quot;AGENT_ACC&quot;);</span>
<span class="nc" id="L5155">						updPstmt.setString(3, ACC_TYPE);</span>
<span class="nc" id="L5156">						updPstmt.execute();</span>

<span class="nc bnc" id="L5158" title="All 2 branches missed.">						if (updPstmt != null) {</span>
<span class="nc" id="L5159">							updPstmt.close();</span>
						}

						/*
						 * end pwt collection charges
						 */
					}
<span class="nc" id="L5166">				}</span>

				// System.out.println(&quot;BANK ACC CUR-- &quot;+BANK_ACC_CURRENT+&quot;&quot;);
				// System.out.println(&quot;TDS ACC CUR-- &quot;+TDS_PAY_CURRENT+&quot;&quot;);
				// System.out.println(&quot;SALE ACC CUR-- &quot;+SALE_ACC_CURRENT+&quot;&quot;);
				// System.out.println(&quot;SAle ret ACC CUR-- &quot;+SALE_RET_CURRENT);
				// System.out.println(&quot;PWT ACC CUR-- &quot;+PWT_PAY_CURRENT);
				// System.out.println(&quot;UNCLM ACC CUR-- &quot;+UNCLM_GOVT_CURRENT);
				// System.out.println(&quot;GOVT ACC CUR-- &quot;+GOVT_COMM_CURRENT);
				// System.out.println(&quot;VAT_PAY_CURRENT-- &quot;+VAT_PAY_CURRENT);
				// System.out.println(&quot;AGENT ACC CUR--
				// &quot;+AGENT_ACCOUNT_CURRENT+&quot;&quot;);
				// System.out.println(&quot;PWT_CHARGES_CURRENT--
				// &quot;+PWT_CHARGES_CURRENT);

<span class="nc" id="L5181">				query3 = QueryManager.getST2UpdateCurrentBal();</span>
<span class="nc" id="L5182">				updPstmt = connection.prepareStatement(query3);</span>

<span class="nc" id="L5184">				updPstmt.setString(1, BANK_ACC_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L5185">				updPstmt.setString(2, &quot;BANK_ACC&quot;);</span>
<span class="nc" id="L5186">				updPstmt.execute();</span>
<span class="nc" id="L5187">				updPstmt.setString(1, TDS_PAY_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L5188">				updPstmt.setString(2, &quot;TDS_PAY&quot;);</span>
<span class="nc" id="L5189">				updPstmt.execute();</span>
<span class="nc" id="L5190">				updPstmt.setString(1, SALE_ACC_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L5191">				updPstmt.setString(2, &quot;SALE_ACC&quot;);</span>
<span class="nc" id="L5192">				updPstmt.execute();</span>

<span class="nc" id="L5194">				updPstmt.setString(1, SALE_RET_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L5195">				updPstmt.setString(2, &quot;SALE_RET&quot;);</span>
<span class="nc" id="L5196">				updPstmt.execute();</span>
<span class="nc" id="L5197">				updPstmt.setString(1, PWT_PAY_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L5198">				updPstmt.setString(2, &quot;PWT_PAY&quot;);</span>
<span class="nc" id="L5199">				updPstmt.execute();</span>

<span class="nc" id="L5201">				updPstmt.setString(1, UNCLM_GOVT_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L5202">				updPstmt.setString(2, &quot;UNCLM_GOVT&quot;);</span>
<span class="nc" id="L5203">				updPstmt.execute();</span>
<span class="nc" id="L5204">				updPstmt.setString(1, GOVT_COMM_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L5205">				updPstmt.setString(2, &quot;GOVT_COMM&quot;);</span>
<span class="nc" id="L5206">				updPstmt.execute();</span>

				/*
				 * added on 07-12-2008 on abhishekhs recommendation
				 */

<span class="nc" id="L5212">				updPstmt.setString(1, VAT_PAY_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L5213">				updPstmt.setString(2, &quot;VAT_PAY&quot;);</span>
<span class="nc" id="L5214">				updPstmt.execute();</span>

				/*
				 * for collection charges
				 */
<span class="nc" id="L5219">				updPstmt.setString(1, PWT_CHARGES_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L5220">				updPstmt.setString(2, &quot;PWT_CHARGES&quot;);</span>
<span class="nc" id="L5221">				updPstmt.execute();</span>

				/*
				 */
<span class="nc" id="L5225">				updPstmt.setString(1, PLAYER_TDS_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L5226">				updPstmt.setString(2, &quot;PLAYER_TDS&quot;);</span>
<span class="nc" id="L5227">				updPstmt.execute();</span>

<span class="nc" id="L5229">				updPstmt.setString(1, PLAYER_PWT_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L5230">				updPstmt.setString(2, &quot;PLAYER_PWT&quot;);</span>
<span class="nc" id="L5231">				updPstmt.execute();</span>

<span class="nc" id="L5233">				updPstmt.setString(1, PLAYER_CASH_CURRENT + &quot;&quot;);</span>
<span class="nc" id="L5234">				updPstmt.setString(2, &quot;PLAYER_CAS&quot;);</span>
<span class="nc" id="L5235">				updPstmt.execute();</span>

<span class="nc bnc" id="L5237" title="All 2 branches missed.">				if (updPstmt != null) {</span>
<span class="nc" id="L5238">					updPstmt.close();</span>
				}
<span class="nc" id="L5240">				insBalHistory(&quot;bo&quot;, connection, toDate_Bean);</span>
			}

<span class="nc" id="L5243">			connection.commit();</span>
<span class="nc" id="L5244">		} catch (SQLException e) {</span>

			try {
<span class="nc" id="L5247">				System.out.println(&quot;In BO Exception &quot; + e);</span>
<span class="nc" id="L5248">				connection.rollback();</span>
<span class="nc" id="L5249">			} catch (SQLException e1) {</span>
				// TODO Auto-generated catch block
<span class="nc" id="L5251">				e1.printStackTrace();</span>
<span class="nc" id="L5252">			}</span>
<span class="nc" id="L5253">			e.printStackTrace();</span>
<span class="nc" id="L5254">			throw new LMSException(e);</span>
		}

		finally {

<span class="nc bnc" id="L5259" title="All 4 branches missed.">			if (connection != null) {</span>
				try {
<span class="nc bnc" id="L5261" title="All 4 branches missed.">					if (rs1 != null) {</span>
<span class="nc" id="L5262">						rs1.close();</span>
					}
<span class="nc" id="L5264">					connection.close();</span>

<span class="nc" id="L5266">				} catch (SQLException e) {</span>
					// TODO Auto-generated catch block
<span class="nc" id="L5268">					e.printStackTrace();</span>
<span class="nc" id="L5269">				}</span>
			}
		}

<span class="nc" id="L5273">	}</span>

	private Timestamp onAdhocUpdateLedger(String tier) {
<span class="nc" id="L5276">		Connection connection = DBConnect.getConnection();</span>
<span class="nc" id="L5277">		Timestamp trxDate = null;</span>
<span class="nc" id="L5278">		Timestamp ledgerDate = null;</span>
<span class="nc" id="L5279">		Timestamp deleteTS = null;</span>
<span class="nc" id="L5280">		String trxWith = null;</span>
<span class="nc" id="L5281">		String tableName = tier;</span>
<span class="nc" id="L5282">		long trxId = 0;</span>
		try {
<span class="nc" id="L5284">			connection.setAutoCommit(false);</span>
<span class="nc" id="L5285">			stmt = connection</span>
					.prepareStatement(&quot;select transaction_date,transaction_id,transaction_with from st_lms_&quot;
							+ tier
							+ &quot;_ledger order by transaction_date desc limit 1&quot;);
<span class="nc" id="L5289">			rs = stmt.executeQuery();</span>
<span class="nc bnc" id="L5290" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L5291">				ledgerDate = rs.getTimestamp(&quot;transaction_date&quot;);</span>
<span class="nc" id="L5292">				trxId = rs.getLong(&quot;transaction_id&quot;);</span>
<span class="nc" id="L5293">				trxWith = rs.getString(&quot;transaction_with&quot;);</span>

<span class="nc" id="L5295">				logger.debug(&quot;In Ledger Helper**tier &quot; + tier</span>
						+ &quot;**Selecting ledger Date**&quot; + trxId + &quot;---TrxID&quot;
						+ stmt);
<span class="nc bnc" id="L5298" title="All 2 branches missed.">				if (trxWith.equals(&quot;BO&quot;)) {</span>
<span class="nc" id="L5299">					tableName = &quot;bo&quot;;</span>
				}
<span class="nc" id="L5301">				stmt = connection</span>
						.prepareStatement(&quot;select transaction_date from st_lms_&quot;
								+ tableName
								+ &quot;_transaction_master where transaction_id&gt;&quot;
								+ trxId
								+ &quot; order by transaction_date asc limit 1&quot;);
<span class="nc" id="L5307">				logger.debug(&quot;In Ledger Helper**tier Agent****&quot; + stmt);</span>
<span class="nc" id="L5308">				rs = stmt.executeQuery();</span>
<span class="nc bnc" id="L5309" title="All 2 branches missed.">				if (rs.next()) {</span>
<span class="nc" id="L5310">					trxDate = rs.getTimestamp(&quot;transaction_date&quot;);</span>
				}

<span class="nc" id="L5313">				logger.debug(&quot;Tier*****&quot; + tier</span>
						+ &quot;Date in Transaction Master***&quot; + trxDate
						+ &quot;***Date in Ledger*****&quot; + ledgerDate);
<span class="nc bnc" id="L5316" title="All 6 branches missed.">				if (trxDate != null &amp;&amp; ledgerDate != null</span>
						&amp;&amp; trxDate.before(ledgerDate)) {
<span class="nc" id="L5318">					Date deleteFromDate = new java.sql.Date(trxDate.getTime());</span>
<span class="nc" id="L5319">					deleteTS = trxDate;</span>

<span class="nc" id="L5321">					stmt = connection</span>
							.prepareStatement(&quot;select distinct(transaction_date) from st_lms_&quot;
									+ tier
									+ &quot;_current_balance_history where transaction_date&lt;'&quot;
									+ deleteFromDate
									+ &quot; 00:00:00' order by transaction_date desc&quot;);
<span class="nc" id="L5327">					rs = stmt.executeQuery();</span>
<span class="nc bnc" id="L5328" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L5329">						trxDate = rs.getTimestamp(&quot;transaction_date&quot;);</span>
<span class="nc bnc" id="L5330" title="All 2 branches missed.">						if (deleteFromDate.after(rs</span>
								.getTimestamp(&quot;transaction_date&quot;))) {
<span class="nc" id="L5332">							deleteTS = rs.getTimestamp(&quot;transaction_date&quot;);</span>
<span class="nc" id="L5333">							deleteFromDate = new java.sql.Date(deleteTS</span>
									.getTime());
<span class="nc" id="L5335">							break;</span>
						}
					}
<span class="nc" id="L5338">					logger.debug(&quot;In Ledger Helper Deleting data from*******&quot;</span>
							+ deleteTS);
				}
			}
<span class="nc" id="L5342">			connection.commit();</span>
<span class="nc" id="L5343">		} catch (Exception e) {</span>
<span class="nc" id="L5344">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L5346">			DBConnect.closeCon(connection);</span>
<span class="nc" id="L5347">		}</span>
<span class="nc" id="L5348">		return deleteTS;</span>
	}

	private static void insBalHistory(String tier, Connection connection,
			Timestamp toDate_Bean) throws SQLException {
<span class="nc" id="L5353">		PreparedStatement stmt = connection</span>
				.prepareStatement(&quot;delete from st_lms_&quot;
						+ tier
						+ &quot;_current_balance_history where date(transaction_date) ='&quot;
						+ new java.sql.Date(toDate_Bean.getTime()) + &quot;'&quot;);
<span class="nc" id="L5358">		logger.debug(&quot;Deleting from bal history ledger****&quot; + stmt);</span>
<span class="nc" id="L5359">		stmt.execute();</span>

<span class="nc" id="L5361">		stmt = connection</span>
				.prepareStatement(&quot;insert into st_lms_&quot;
						+ tier
						+ &quot;_current_balance_history select account_type,current_balance,agent_org_id,'&quot;
						+ toDate_Bean + &quot;' from st_lms_&quot; + tier
						+ &quot;_current_balance&quot;);
<span class="nc" id="L5367">		logger.debug(&quot;Inserting into bal history ledger****&quot; + stmt);</span>
<span class="nc" id="L5368">		stmt.execute();</span>

<span class="nc" id="L5370">	}</span>

	public static void main(String[] args) throws SQLException {
<span class="nc" id="L5373">		Connection connection = DBConnect.getConnection();</span>
		// new LedgerHelper().onAdhocUpdateLedger(&quot;bo&quot;);
		// new LedgerHelper().insBalHistory(&quot;bo&quot;, connection);
<span class="nc" id="L5376">		new LedgerHelperQuartz().fillLedger();</span>

<span class="nc" id="L5378">	}</span>

	public void fillLedger() {
<span class="nc" id="L5381">		Connection connection = DBConnect.getConnection();</span>

		try {
<span class="nc" id="L5384">			Timestamp toDate = null;</span>
<span class="nc" id="L5385">			ResultSet rs = null;</span>
<span class="nc" id="L5386">			ResultSet rsDate = null;</span>
<span class="nc" id="L5387">			Timestamp boDelDate = onAdhocUpdateLedger(&quot;bo&quot;);</span>
<span class="nc" id="L5388">			Timestamp agentDelDate = onAdhocUpdateLedger(&quot;agent&quot;);</span>
<span class="nc" id="L5389">			Timestamp delDate = null;</span>
<span class="nc" id="L5390">			String delDateStr = null;</span>
<span class="nc" id="L5391">			String fromDateStr = null;</span>
<span class="nc bnc" id="L5392" title="All 2 branches missed.">			if (boDelDate != null) {</span>
<span class="nc" id="L5393">				delDate = boDelDate;</span>
			}
<span class="nc bnc" id="L5395" title="All 6 branches missed.">			if (agentDelDate != null &amp;&amp; delDate != null</span>
					&amp;&amp; agentDelDate.before(delDate)) {
<span class="nc" id="L5397">				delDate = agentDelDate;</span>
			}

<span class="nc bnc" id="L5400" title="All 2 branches missed.">			if (delDate != null) {</span>
<span class="nc" id="L5401">				delDateStr = new java.sql.Date(delDate.getTime()) + &quot; 23:59:59&quot;;</span>
<span class="nc" id="L5402">				logger.debug(&quot;Deleting data after &quot; + delDateStr + &quot;****date&quot;);</span>
<span class="nc" id="L5403">				stmt = connection</span>
						.prepareStatement(&quot;delete from st_lms_bo_current_balance&quot;);
<span class="nc" id="L5405">				stmt.addBatch(&quot;delete from st_lms_bo_current_balance&quot;);</span>
<span class="nc" id="L5406">				stmt</span>
						.addBatch(&quot;delete from st_lms_bo_ledger where transaction_date&gt;'&quot;
								+ delDateStr + &quot;'&quot;);
<span class="nc" id="L5409">				stmt</span>
						.addBatch(&quot;insert into st_lms_bo_current_balance select account_type,current_balance,agent_org_id from st_lms_bo_current_balance_history where date(transaction_date)='&quot;
								+ new java.sql.Date(delDate.getTime()) + &quot;'&quot;);
<span class="nc" id="L5412">				stmt</span>
						.addBatch(&quot;delete from st_lms_bo_current_balance_history where transaction_date&gt;'&quot;
								+ delDateStr + &quot;'&quot;);
<span class="nc" id="L5415">				stmt.addBatch(&quot;delete from st_lms_agent_current_balance&quot;);</span>
<span class="nc" id="L5416">				stmt</span>
						.addBatch(&quot;delete from st_lms_agent_ledger where transaction_date&gt;'&quot;
								+ delDateStr + &quot;'&quot;);
<span class="nc" id="L5419">				stmt</span>
						.addBatch(&quot;insert into st_lms_agent_current_balance select account_type,current_balance,agent_org_id from st_lms_agent_current_balance_history where date(transaction_date)='&quot;
								+ new java.sql.Date(delDate.getTime()) + &quot;'&quot;);
<span class="nc" id="L5422">				stmt</span>
						.addBatch(&quot;delete from st_lms_agent_current_balance_history where transaction_date&gt;'&quot;
								+ delDateStr + &quot;'&quot;);
<span class="nc" id="L5425">				stmt.executeBatch();</span>
			}
<span class="nc" id="L5427">			stmt = connection</span>
					.prepareStatement(&quot;select distinct(date(transaction_date)) transaction_date from st_lms_bo_current_balance_history order by transaction_date desc limit 1&quot;);
<span class="nc" id="L5429">			rs = stmt.executeQuery();</span>
<span class="nc bnc" id="L5430" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L5431">				fromDateStr = new java.sql.Date(rs.getDate(&quot;transaction_date&quot;)</span>
						.getTime())
						+ &quot;&quot;;
			}

<span class="nc bnc" id="L5436" title="All 2 branches missed.">			if (fromDateStr == null) {</span>
<span class="nc" id="L5437">				fromDateStr = chkArcLedgerTable();</span>
			}

<span class="nc" id="L5440">			PreparedStatement stmtDate = connection</span>
					.prepareStatement(&quot;select distinct(date(trDate)) transaction_date from (select distinct(date(transaction_date)) trDate from st_lms_agent_transaction_master union select distinct(date(transaction_date)) trDate from  st_lms_bo_transaction_master union select distinct(date(transaction_date)) trDate from st_lms_retailer_transaction_master) c where c.trDate&gt;'&quot;+ fromDateStr + &quot;' order by transaction_date&quot;);
<span class="nc" id="L5442">			logger.debug(&quot;Filling Ledger********&quot; + stmtDate);</span>
<span class="nc" id="L5443">			rsDate = stmtDate.executeQuery();</span>
<span class="nc" id="L5444">			System.out.println(new Date() + &quot;---Fill Ledger Start---&quot;</span>
					+ new Date().getTime());
<span class="nc bnc" id="L5446" title="All 2 branches missed.">			while (rsDate.next()) {</span>

<span class="nc" id="L5448">				toDate = rsDate.getTimestamp(&quot;transaction_date&quot;);</span>
<span class="nc" id="L5449">				PreparedStatement stmt = connection</span>
						.prepareStatement(&quot;select organization_id from st_lms_organization_master where organization_type='AGENT'&quot;);
<span class="nc" id="L5451">				rs = stmt.executeQuery();</span>
<span class="nc bnc" id="L5452" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L5453">					ledgerAgentEntry(toDate, rs.getInt(&quot;organization_id&quot;));</span>
				}
<span class="nc" id="L5455">				ledgerBoEntry(toDate);</span>

<span class="nc" id="L5457">			}</span>
<span class="nc" id="L5458">			System.out.println(new Date() + &quot;---Fill Ledger Start---&quot;</span>
					+ new Date().getTime());
<span class="nc" id="L5460">			DBConnect.closeCon(connection);</span>

<span class="nc" id="L5462">		} catch (Exception e) {</span>
<span class="nc" id="L5463">			e.printStackTrace();</span>
<span class="nc" id="L5464">		}</span>

<span class="nc" id="L5466">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>