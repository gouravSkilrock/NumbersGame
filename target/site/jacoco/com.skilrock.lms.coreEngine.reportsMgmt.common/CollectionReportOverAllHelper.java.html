<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CollectionReportOverAllHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lms</a> &gt; <a href="index.source.html" class="el_package">com.skilrock.lms.coreEngine.reportsMgmt.common</a> &gt; <span class="el_source">CollectionReportOverAllHelper.java</span></div><h1>CollectionReportOverAllHelper.java</h1><pre class="source lang-java linenums">package com.skilrock.lms.coreEngine.reportsMgmt.common;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Timestamp;
import java.util.HashMap;
import java.util.LinkedHashMap;
import java.util.Map;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import com.skilrock.lms.beans.AgentCollectionReportOverAllBean;
import com.skilrock.lms.beans.CollectionReportOverAllBean;
import com.skilrock.lms.beans.CompleteCollectionBean;
import com.skilrock.lms.common.db.DBConnect;
import com.skilrock.lms.common.db.QueryManager;
import com.skilrock.lms.common.exception.LMSException;
import com.skilrock.lms.common.filter.LMSFilterDispatcher;
import com.skilrock.lms.web.accMgmt.common.AgentOpeningBalanceHelper;
import com.skilrock.lms.web.reportsMgmt.common.ReportUtility;

<span class="nc" id="L25">public class CollectionReportOverAllHelper implements ICollectionReportOverAllHelper{</span>
<span class="nc" id="L26">	Log logger = LogFactory.getLog(CollectionReportOverAllHelper.class);</span>

	

	public void collectionAgentWise(Timestamp startDate, Timestamp endDate,
			Connection con,	Map&lt;String, CollectionReportOverAllBean&gt; agtMap)
			throws LMSException {

<span class="nc" id="L34">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L35">		ResultSet rs = null;</span>

<span class="nc" id="L37">		String saleTranDG = null;</span>
<span class="nc" id="L38">		String cancelTranDG = null;</span>
<span class="nc" id="L39">		String pwtTranDG = null;</span>

<span class="nc" id="L41">		String saleTranCS = null;</span>
<span class="nc" id="L42">		String cancelTranCS = null;</span>
		
<span class="nc bnc" id="L44" title="All 2 branches missed.">		if (startDate.after(endDate)) {</span>
<span class="nc" id="L45">			return;</span>
		}

		try {
			// Get Account Details

<span class="nc" id="L51">			String addOrgQry = &quot;right outer join (select organization_id from st_lms_organization_master where organization_type='AGENT') om on agent_org_id=organization_id&quot;;</span>
<span class="nc" id="L52">			String cashQry = &quot;(select organization_id,cash from (select agent_org_id,sum(amount) cash from st_lms_bo_cash_transaction cash,st_lms_bo_transaction_master btm where cash.transaction_id=btm.transaction_id and transaction_date&gt;='&quot;</span>
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' group by agent_org_id) cash &quot; + addOrgQry + &quot;) cash&quot;;
<span class="nc" id="L57">			String chqQry = &quot;(select organization_id,chq from (select agent_org_id,sum(cheque_amt) chq from st_lms_bo_sale_chq chq,st_lms_bo_transaction_master btm where chq.transaction_id=btm.transaction_id and chq.transaction_type IN ('CHEQUE','CLOSED') and transaction_date&gt;='&quot;</span>
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' group by agent_org_id) chq &quot; + addOrgQry + &quot;) chq&quot;;
<span class="nc" id="L62">			String chqRetQry = &quot;(select organization_id,chq_ret from (select agent_org_id,sum(cheque_amt) chq_ret from st_lms_bo_sale_chq chq,st_lms_bo_transaction_master btm where chq.transaction_id=btm.transaction_id and chq.transaction_type IN ('CHQ_BOUNCE') and transaction_date&gt;='&quot;</span>
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' group by agent_org_id) chq_ret &quot;
					+ addOrgQry
					+ &quot;) chq_ret&quot;;
<span class="nc" id="L69">			String debitQry = &quot;(select organization_id,debit from (select agent_org_id,sum(amount) debit from st_lms_bo_debit_note debit,st_lms_bo_transaction_master btm where debit.transaction_id=btm.transaction_id and debit.transaction_type IN ('DR_NOTE_CASH','DR_NOTE') and transaction_date&gt;='&quot;</span>
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' group by agent_org_id) debit &quot; + addOrgQry + &quot;) debit&quot;;
<span class="nc" id="L74">			String creditQry = &quot;(select organization_id,credit from (select agent_org_id,sum(amount) credit from st_lms_bo_credit_note credit,st_lms_bo_transaction_master btm where credit.transaction_id=btm.transaction_id and credit.transaction_type IN ('CR_NOTE_CASH','CR_NOTE') and transaction_date&gt;='&quot;</span>
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' group by agent_org_id) credit &quot;
					+ addOrgQry
					+ &quot;) credit&quot;;
<span class="nc" id="L81">			String bankQry = &quot;(select organization_id,bank from (select agent_org_id,sum(amount) bank from st_lms_bo_bank_deposit_transaction bank,st_lms_bo_transaction_master btm where bank.transaction_id=btm.transaction_id and transaction_date&gt;='&quot;</span>
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' group by agent_org_id) bank &quot; + addOrgQry + &quot;) bank&quot;;

<span class="nc" id="L87">			String accQry = &quot;select cash.organization_id,ifnull(cash,0.0) cash,ifnull(chq,0.0) chq,ifnull(chq_ret,0.0) chq_ret,ifnull(debit,0.0) debit,ifnull(credit,0.0) credit, ifnull(bank,0.0) bank from &quot;</span>
					+ cashQry
					+ &quot;,&quot;
					+ chqQry
					+ &quot;,&quot;
					+ chqRetQry
					+ &quot;,&quot;
					+ debitQry
					+ &quot;,&quot;
					+ creditQry
					+ &quot;,&quot;
					+ bankQry
					+ &quot; where cash.organization_id=chq.organization_id and cash.organization_id=chq_ret.organization_id and cash.organization_id=debit.organization_id and cash.organization_id=credit.organization_id and cash.organization_id=bank.organization_id and chq.organization_id=chq_ret.organization_id and chq.organization_id=debit.organization_id and chq.organization_id=credit.organization_id and chq.organization_id=bank.organization_id and chq_ret.organization_id=debit.organization_id and chq_ret.organization_id=credit.organization_id and chq_ret.organization_id=bank.organization_id  and debit.organization_id=credit.organization_id and debit.organization_id=bank.organization_id and credit.organization_id=bank.organization_id &quot;;
<span class="nc" id="L100">			pstmt = con.prepareStatement(accQry);</span>
<span class="nc" id="L101">			logger.debug(&quot;---Account Detail Query---&quot; + pstmt);</span>
<span class="nc" id="L102">			rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L104" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L105">				String agtOrgId = rs.getString(&quot;organization_id&quot;);</span>
<span class="nc" id="L106">				agtMap.get(agtOrgId).setCash(rs.getDouble(&quot;cash&quot;));</span>
<span class="nc" id="L107">				agtMap.get(agtOrgId).setCheque(rs.getDouble(&quot;chq&quot;));</span>
<span class="nc" id="L108">				agtMap.get(agtOrgId).setChequeReturn(rs.getDouble(&quot;chq_ret&quot;));</span>
<span class="nc" id="L109">				agtMap.get(agtOrgId).setCredit(rs.getDouble(&quot;credit&quot;));</span>
<span class="nc" id="L110">				agtMap.get(agtOrgId).setDebit(rs.getDouble(&quot;debit&quot;));</span>
<span class="nc" id="L111">				agtMap.get(agtOrgId).setBankDep(rs.getDouble(&quot;bank&quot;));</span>
<span class="nc" id="L112">			}</span>

<span class="nc bnc" id="L114" title="All 2 branches missed.">			if (ReportUtility.isDG) {</span>
<span class="nc" id="L115">				saleTranDG = &quot;select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_SALE','DG_SALE_OFFLINE') and transaction_date&gt;='&quot;</span>
						+ startDate
						+ &quot;' and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;' and retailer_org_id in (select organization_id from st_lms_organization_master where organization_type='RETAILER')&quot;;
<span class="nc" id="L120">				cancelTranDG = &quot;select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_REFUND_CANCEL','DG_REFUND_FAILED') and transaction_date&gt;='&quot;</span>
						+ startDate
						+ &quot;' and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;' and retailer_org_id in (select organization_id from st_lms_organization_master where organization_type='RETAILER')&quot;;
<span class="nc" id="L125">				pwtTranDG = &quot;select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_PWT_AUTO','DG_PWT_PLR','DG_PWT') and transaction_date&gt;='&quot;</span>
						+ startDate
						+ &quot;' and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;' and retailer_org_id in (select organization_id from st_lms_organization_master where organization_type='RETAILER')&quot;;

				// Game Master Query
<span class="nc" id="L132">				String gameQry = ReportUtility.getDrawGameMapQuery(startDate);</span>
<span class="nc" id="L133">				PreparedStatement gamePstmt = con.prepareStatement(gameQry);</span>
<span class="nc" id="L134">				ResultSet rsGame = gamePstmt.executeQuery();</span>
<span class="nc" id="L135">				StringBuilder saleQry = new StringBuilder(</span>
						&quot;select organization_id,ifnull(sale,0.0) sale from (select parent_id,sum(sale) as sale from (&quot;);
<span class="nc" id="L137">				StringBuilder cancelQry = new StringBuilder(</span>
						&quot;select organization_id,ifnull(cancel,0.0) cancel from (select parent_id,sum(cancel) as cancel from (&quot;);
<span class="nc" id="L139">				StringBuilder pwtQry = new StringBuilder(</span>
						&quot;select organization_id,ifnull(pwt,0.0) pwt from (select parent_id,sum(pwt) as pwt from (&quot;);
<span class="nc bnc" id="L141" title="All 2 branches missed.">				while (rsGame.next()) {</span>
<span class="nc" id="L142">					saleQry</span>
							.append(&quot;(select bb.parent_id,sum(sale) as sale from (select drs.retailer_org_id,sum(agent_net_amt) as sale from st_dg_ret_sale_&quot;
									+ rsGame.getInt(&quot;game_id&quot;)
									+ &quot; drs where transaction_id in (&quot;
									+ saleTranDG
									+ &quot;) group by drs.retailer_org_id) aa,st_lms_organization_master bb where retailer_org_id=organization_id group by parent_id) union all&quot;);

<span class="nc" id="L149">					cancelQry</span>
							.append(&quot;(select bb.parent_id,sum(cancel) as cancel from (select drs.retailer_org_id,sum(agent_net_amt) as cancel from st_dg_ret_sale_refund_&quot;
									+ rsGame.getInt(&quot;game_id&quot;)
									+ &quot; drs where transaction_id in (&quot;
									+ cancelTranDG
									+ &quot;) group by drs.retailer_org_id) aa,st_lms_organization_master bb where retailer_org_id=organization_id group by parent_id) union all&quot;);

<span class="nc" id="L156">					pwtQry</span>
							.append(&quot;(select bb.parent_id,sum(pwt) as pwt from (select drs.retailer_org_id,sum(pwt_amt+agt_claim_comm) as pwt from st_dg_ret_pwt_&quot;
									+ rsGame.getInt(&quot;game_id&quot;)
									+ &quot; drs where transaction_id in (&quot;
									+ pwtTranDG
									+ &quot;) group by drs.retailer_org_id) aa,st_lms_organization_master bb where retailer_org_id=organization_id group by parent_id) union all&quot;);

				}

<span class="nc" id="L165">				saleQry.delete(saleQry.lastIndexOf(&quot;union all&quot;), saleQry</span>
						.length());
<span class="nc" id="L167">				cancelQry.delete(cancelQry.lastIndexOf(&quot;union all&quot;), cancelQry</span>
						.length());
<span class="nc" id="L169">				pwtQry.delete(pwtQry.lastIndexOf(&quot;union all&quot;), pwtQry.length());</span>

<span class="nc" id="L171">				saleQry</span>
						.append(&quot;) saleTlb group by parent_id) saleTlb right outer join (select organization_id from st_lms_organization_master where organization_type='AGENT') om on parent_id=organization_id&quot;);
<span class="nc" id="L173">				cancelQry</span>
						.append(&quot;) cancelTlb group by parent_id) cancelTlb right outer join (select organization_id from st_lms_organization_master where organization_type='AGENT') om on parent_id=organization_id&quot;);
<span class="nc" id="L175">				pwtQry</span>
						.append(&quot;) pwtTlb group by parent_id) pwtTlb right outer join (select organization_id from st_lms_organization_master where organization_type='AGENT') om on parent_id=organization_id&quot;);
<span class="nc" id="L177">				logger.debug(&quot;-------Draw Sale Qurey------\n&quot; + saleQry);</span>
<span class="nc" id="L178">				logger.debug(&quot;-------Draw Cancel Qurey------\n&quot; + cancelQry);</span>
<span class="nc" id="L179">				logger.debug(&quot;-------Draw Pwt Qurey------\n&quot; + pwtQry);</span>

				// Draw Sale Query
<span class="nc" id="L182">				pstmt = con.prepareStatement(saleQry.toString());</span>
<span class="nc" id="L183">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L185">					agtMap.get(rs.getString(&quot;organization_id&quot;)).setDgSale(</span>
							rs.getDouble(&quot;sale&quot;));
				}
				// Draw Cancel Query
<span class="nc" id="L189">				pstmt = con.prepareStatement(cancelQry.toString());</span>
<span class="nc" id="L190">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L192">					agtMap.get(rs.getString(&quot;organization_id&quot;)).setDgCancel(</span>
							rs.getDouble(&quot;cancel&quot;));
				}
				// Draw Pwt Query
<span class="nc" id="L196">				pstmt = con.prepareStatement(pwtQry.toString());</span>
<span class="nc" id="L197">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L199">					agtMap.get(rs.getString(&quot;organization_id&quot;)).setDgPwt(</span>
							rs.getDouble(&quot;pwt&quot;));
				}

				// Draw Direct Player Qry

<span class="nc" id="L205">				String dirPwtQry = &quot;select organization_id,ifnull(pwtDir,0.0) pwtDir from (select agent_org_id,sum(pwt_amt+agt_claim_comm) pwtDir from st_dg_agt_direct_plr_pwt where transaction_date&gt;=? and transaction_date&lt;=? group by agent_org_id) pwtDirPly right outer join (select organization_id from st_lms_organization_master where organization_type='AGENT') om on agent_org_id=organization_id&quot;;</span>
<span class="nc" id="L206">				pstmt = con.prepareStatement(dirPwtQry);</span>
<span class="nc" id="L207">				pstmt.setTimestamp(1, startDate);</span>
<span class="nc" id="L208">				pstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L209">				logger.debug(&quot;-------Draw Direct Player Qry------\n&quot; + pstmt);</span>
<span class="nc" id="L210">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L212">					agtMap.get(rs.getString(&quot;organization_id&quot;)).setDgDirPlyPwt(</span>
							rs.getDouble(&quot;pwtDir&quot;));
				}
			}
<span class="nc bnc" id="L216" title="All 2 branches missed.">			if (ReportUtility.isSE) {</span>
				// Calculate Scratch Sale
<span class="nc" id="L218">				String saleQry = &quot;&quot;;</span>
				
<span class="nc bnc" id="L220" title="All 2 branches missed.">				if (&quot;BOOK_WISE&quot;.equals(LMSFilterDispatcher.seSaleReportType)) {</span>
<span class="nc" id="L221">					saleQry = &quot;select sale.organization_id,(ifnull(mrpAmt,0.0)-ifnull(mrpAmtRet,0.0)) mrpAmt,(ifnull(netAmt,0.0)-ifnull(netAmtRet,0.0)) netAmt from (select organization_id,name,ifnull(mrpAmt,0.0) mrpAmt,ifnull(netAmt,0.0) netAmt from st_lms_organization_master left outer join (select agent_org_id,sum(mrpAmt) mrpAmt,sum(netAmt) netAmt from (select agent_org_id,sum(mrp_amt) mrpAmt,sum(net_amt) netAmt from st_se_bo_agent_transaction right outer join st_lms_organization_master on organization_id=agent_org_id where transaction_id in (select transaction_id from st_lms_bo_transaction_master where transaction_type='SALE' and transaction_date&gt;='&quot;</span>
						+ startDate
						+ &quot;'  and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;' ) group by agent_org_id union all select agent_org_id,sum(mrp_amt) mrpAmt,sum(net_amt) netAmt from st_se_bo_agent_loose_book_transaction right outer join st_lms_organization_master on organization_id=agent_org_id where transaction_id in (select transaction_id from st_lms_bo_transaction_master where transaction_type='LOOSE_SALE' and transaction_date&gt;='&quot;
						+ startDate
						+ &quot;'  and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;' ) group by agent_org_id)sale group by agent_org_id) sale on organization_id=agent_org_id where organization_type='AGENT') sale inner join (select organization_id,name,ifnull(mrpAmtRet,0.0) mrpAmtRet,ifnull(netAmtRet,0.0) netAmtRet from st_lms_organization_master left outer join (select agent_org_id,sum(mrpAmtRet) mrpAmtRet,sum(netAmtRet) netAmtRet from (select agent_org_id,sum(mrp_amt) mrpAmtRet,sum(net_amt) netAmtRet from st_se_bo_agent_transaction where transaction_id in (select transaction_id from st_lms_bo_transaction_master where transaction_type='SALE_RET' and transaction_date&gt;='&quot;
						+ startDate
						+ &quot;'  and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;' ) group by agent_org_id union all select agent_org_id,sum(mrp_amt) mrpAmt,sum(net_amt) netAmt from st_se_bo_agent_loose_book_transaction right outer join st_lms_organization_master on organization_id=agent_org_id where transaction_id in (select transaction_id from st_lms_bo_transaction_master where transaction_type='LOOSE_SALE_RET' and transaction_date&gt;='&quot;
						+ startDate
						+ &quot;'  and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;' ) group by agent_org_id )saleRet group by agent_org_id ) saleRet on organization_id=agent_org_id where organization_type='AGENT') saleRet on sale.organization_id=saleRet.organization_id&quot;;
<span class="nc bnc" id="L238" title="All 2 branches missed.">				} else if (&quot;TICKET_WISE&quot;</span>
						.equals(LMSFilterDispatcher.seSaleReportType)) {
<span class="nc" id="L240">					saleQry = &quot;select organization_id,name,ifnull(mrpAmt,0.0) mrpAmt,ifnull(netAmt,0.0) netAmt from st_lms_organization_master left outer join (select current_owner_id,sum(soldTkt*ticket_price) mrpAmt,sum((soldTkt*ticket_price)-(soldTkt*ticket_price*transacrion_sale_comm_rate*0.01)) netAmt from st_se_game_master gm,st_se_game_inv_detail gid,(select game_id,book_nbr,sum(sold_tickets) soldTkt from st_se_game_ticket_inv_history where date&gt;='&quot;</span>
							+ startDate
							+ &quot;' and date&lt;='&quot;
							+ endDate
							+ &quot;' and current_owner='RETAILER' group by book_nbr) TktTlb where gm.game_id=TktTlb.game_id and TktTlb.book_nbr=gid.book_nbr and gid.current_owner='AGENT' group by current_owner_id) saleTlb on organization_id=current_owner_id where organization_type='AGENT'&quot;;
				}
<span class="nc" id="L246">				pstmt = con.prepareStatement(saleQry);</span>
<span class="nc" id="L247">				logger.debug(&quot;***Scratch Sale Query*** \n&quot; + pstmt);</span>
<span class="nc" id="L248">				rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L250" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L251">					agtMap.get(rs.getString(&quot;organization_id&quot;)).setSeSale(</span>
							rs.getDouble(&quot;netAmt&quot;));
				}

				// Calculate Scratch Pwt
<span class="nc" id="L256">				String pwtQry = &quot;select organization_id,ifnull(sum(pwt),0.0) pwt from (select bb.parent_id,sum(pwt) as pwt from (select retailer_org_id,sum(pwt_amt+(pwt_amt*agt_claim_comm*0.01)) pwt from st_se_retailer_pwt where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_date&gt;=? and transaction_date&lt;=? and transaction_type='PWT' and retailer_org_id in (select organization_id from st_lms_organization_master where organization_type='RETAILER')) group by retailer_org_id union all select retailer_org_id,sum(pwt_amt+(pwt_amt*claim_comm*0.01)) pwt from st_se_agent_pwt where status!='DONE_UNCLM' and transaction_id in (select transaction_id from st_lms_agent_transaction_master where transaction_date&gt;=? and transaction_date&lt;=? and transaction_type='PWT' and retailer_org_id in (select organization_id from st_lms_organization_master where organization_type='RETAILER')) group by retailer_org_id) aa,st_lms_organization_master bb where retailer_org_id=organization_id group by parent_id union all select agent_org_id,sum(pwt_amt+comm_amt) boPwt from st_se_bo_pwt where transaction_id in (select transaction_id from st_lms_bo_transaction_master where transaction_date&gt;=? and transaction_date&lt;=? and transaction_type='PWT' and agent_org_id in (select organization_id from st_lms_organization_master where organization_type='AGENT')) group by agent_org_id) pwtTlb right outer join (select organization_id from st_lms_organization_master where organization_type='AGENT') om on parent_id=organization_id group by organization_id&quot;;</span>
<span class="nc" id="L257">				pstmt = con.prepareStatement(pwtQry);</span>
<span class="nc" id="L258">				pstmt.setTimestamp(1, startDate);</span>
<span class="nc" id="L259">				pstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L260">				pstmt.setTimestamp(3, startDate);</span>
<span class="nc" id="L261">				pstmt.setTimestamp(4, endDate);</span>
<span class="nc" id="L262">				pstmt.setTimestamp(5, startDate);</span>
<span class="nc" id="L263">				pstmt.setTimestamp(6, endDate);</span>
<span class="nc" id="L264">				logger.debug(&quot;***Scratch Pwt Query*** \n&quot; + pstmt);</span>
<span class="nc" id="L265">				rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L267" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L268">					agtMap.get(rs.getString(&quot;organization_id&quot;)).setSePwt(</span>
							rs.getDouble(&quot;pwt&quot;));
				}

				// Scratch Direct Player Qry

<span class="nc" id="L274">				String dirPwtQry = &quot;select organization_id,ifnull(pwtDir,0.0) pwtDir from (select agent_org_id,sum(pwt_amt+(pwt_amt*claim_comm*0.01)) pwtDir from st_se_agt_direct_player_pwt where transaction_date&gt;=? and transaction_date&lt;=? group by agent_org_id) pwtDirPly right outer join (select organization_id from st_lms_organization_master where organization_type='AGENT') om on agent_org_id=organization_id&quot;;</span>
<span class="nc" id="L275">				pstmt = con.prepareStatement(dirPwtQry);</span>
<span class="nc" id="L276">				pstmt.setTimestamp(1, startDate);</span>
<span class="nc" id="L277">				pstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L278">				logger</span>
						.debug(&quot;-------Scratch Direct Player Qry------\n&quot;
								+ pstmt);
<span class="nc" id="L281">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L283">					agtMap.get(rs.getString(&quot;organization_id&quot;)).setSeDirPlyPwt(</span>
							rs.getDouble(&quot;pwtDir&quot;));
				}
			}
<span class="nc bnc" id="L287" title="All 2 branches missed.">			if (ReportUtility.isCS) {</span>

<span class="nc" id="L289">				saleTranCS = &quot;select transaction_id from st_lms_retailer_transaction_master where transaction_type in('CS_SALE') and transaction_date&gt;='&quot;</span>
						+ startDate
						+ &quot;' and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;' and retailer_org_id in (select organization_id from st_lms_organization_master where organization_type='RETAILER')&quot;;
<span class="nc" id="L294">				cancelTranCS = &quot;select transaction_id from st_lms_retailer_transaction_master where transaction_type in('CS_CANCEL_SERVER','CS_CANCEL_RET') and transaction_date&gt;='&quot;</span>
						+ startDate
						+ &quot;' and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;' and retailer_org_id in (select organization_id from st_lms_organization_master where organization_type='RETAILER')&quot;;

				// Category Master Query
<span class="nc" id="L301">				String catQry = &quot;select category_id from st_cs_product_category_master where status = 'ACTIVE'&quot;;</span>
<span class="nc" id="L302">				PreparedStatement gamePstmt = con.prepareStatement(catQry);</span>
<span class="nc" id="L303">				ResultSet rsProduct = gamePstmt.executeQuery();</span>
<span class="nc" id="L304">				StringBuilder saleQry = new StringBuilder(</span>
						&quot;select organization_id,ifnull(sale,0.0) sale from (select parent_id,sum(sale) as sale from (&quot;);
<span class="nc" id="L306">				StringBuilder cancelQry = new StringBuilder(</span>
						&quot;select organization_id,ifnull(cancel,0.0) cancel from (select parent_id,sum(cancel) as cancel from (&quot;);
<span class="nc bnc" id="L308" title="All 2 branches missed.">				while (rsProduct.next()) {</span>
<span class="nc" id="L309">					saleQry</span>
							.append(&quot;(select bb.parent_id,sum(sale) as sale from (select drs.retailer_org_id,sum(agent_net_amt) as sale from st_cs_sale_&quot;
									+ rsProduct.getInt(&quot;category_id&quot;)
									+ &quot; drs where transaction_id in (&quot;
									+ saleTranCS
									+ &quot;) group by drs.retailer_org_id) aa,st_lms_organization_master bb where retailer_org_id=organization_id group by parent_id) union all&quot;);

<span class="nc" id="L316">					cancelQry</span>
							.append(&quot;(select bb.parent_id,sum(cancel) as cancel from (select drs.retailer_org_id,sum(agent_net_amt) as cancel from st_cs_refund_&quot;
									+ rsProduct.getInt(&quot;category_id&quot;)
									+ &quot; drs where transaction_id in (&quot;
									+ cancelTranCS
									+ &quot;) group by drs.retailer_org_id) aa,st_lms_organization_master bb where retailer_org_id=organization_id group by parent_id) union all&quot;);

				}

<span class="nc" id="L325">				saleQry.delete(saleQry.lastIndexOf(&quot;union all&quot;), saleQry</span>
						.length());
<span class="nc" id="L327">				cancelQry.delete(cancelQry.lastIndexOf(&quot;union all&quot;), cancelQry</span>
						.length());

<span class="nc" id="L330">				saleQry</span>
						.append(&quot;) saleTlb group by parent_id) saleTlb right outer join (select organization_id from st_lms_organization_master where organization_type='AGENT') om on parent_id=organization_id&quot;);
<span class="nc" id="L332">				cancelQry</span>
						.append(&quot;) cancelTlb group by parent_id) cancelTlb right outer join (select organization_id from st_lms_organization_master where organization_type='AGENT') om on parent_id=organization_id&quot;);

<span class="nc" id="L335">				logger.debug(&quot;-------CS Sale Query------\n&quot; + saleQry);</span>
<span class="nc" id="L336">				logger.debug(&quot;-------CS Cancel Query------\n&quot; + cancelQry);</span>

				// CS Sale Query
<span class="nc" id="L339">				pstmt = con.prepareStatement(saleQry.toString());</span>
<span class="nc" id="L340">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L342">					agtMap.get(rs.getString(&quot;organization_id&quot;)).setCSSale(</span>
							rs.getDouble(&quot;sale&quot;));
				}
				// CS Cancel Query
<span class="nc" id="L346">				pstmt = con.prepareStatement(cancelQry.toString());</span>
<span class="nc" id="L347">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L348" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L349">					agtMap.get(rs.getString(&quot;organization_id&quot;)).setCSCancel(</span>
							rs.getDouble(&quot;cancel&quot;));
				}
			}
<span class="nc bnc" id="L353" title="All 2 branches missed.">			if(ReportUtility.isOLA){</span>
				
<span class="nc" id="L355">			StringBuilder wdQry = new StringBuilder(</span>
					&quot;select om.parent_id agtOrgId, ifnull(sum(wd), 0.0) wdraw from &quot;);
<span class="nc" id="L357">			StringBuilder wdRefQry = new StringBuilder(</span>
					&quot;select om.parent_id agtOrgId, ifnull(sum(wdRef), 0.0) wdrawRef from&quot;);
<span class="nc" id="L359">			StringBuilder depQry = new StringBuilder(</span>
					&quot;select om.parent_id agtOrgId, ifnull(sum(depo), 0.0) depoAmt from&quot;);
<span class="nc" id="L361">			StringBuilder depRefQry = new StringBuilder(</span>
					&quot;select om.parent_id agtOrgId, ifnull(sum(depoRef), 0.0) depoRefAmt from&quot;);
						
<span class="nc" id="L364">				wdQry</span>
						.append(&quot;(select wrs.retailer_org_id, agent_net_amt as wd from st_ola_ret_withdrawl wrs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type = 'OLA_WITHDRAWL' and transaction_date&gt;='&quot;
									+ startDate 
									+ &quot;' and transaction_date&lt;='&quot;
									+ endDate
									+ &quot;')) wdret right outer join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on om.organization_id = wdret.retailer_org_id group by om.parent_id&quot;);

<span class="nc" id="L371">				wdRefQry</span>
						.append(&quot;(select wrs.retailer_org_id, agent_net_amt as wdRef from st_ola_ret_withdrawl_refund wrs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type = 'OLA_WITHDRAWL_REFUND' and transaction_date&gt;='&quot;
								+ startDate 
								+ &quot;' and transaction_date&lt;='&quot;
								+ endDate
								+ &quot;')) wdret right outer join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on om.organization_id = wdret.retailer_org_id group by om.parent_id&quot;);
<span class="nc" id="L377">				depQry</span>
						.append(&quot;(select wrs.retailer_org_id, agent_net_amt as depo from st_ola_ret_deposit wrs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type = 'OLA_DEPOSIT' and transaction_date&gt;='&quot;
								+ startDate 
								+ &quot;' and transaction_date&lt;='&quot;
								+ endDate
								+ &quot;')) wdret right outer join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on om.organization_id = wdret.retailer_org_id group by om.parent_id&quot;);

<span class="nc" id="L384">				depRefQry</span>
						.append(&quot;(select wrs.retailer_org_id, agent_net_amt as depoRef from st_ola_ret_deposit_refund wrs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type = 'OLA_DEPOSIT_REFUND' and transaction_date&gt;='&quot;
								+ startDate 
								+ &quot;' and transaction_date&lt;='&quot;
								+ endDate
								+ &quot;')) wdret right outer join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on om.organization_id = wdret.retailer_org_id group by om.parent_id&quot;);

<span class="nc" id="L391">				String netGamingQry = &quot;select om.parent_id agtOrgId, ifnull(sum(netGamingAmt), 0.0) netAmt from(select wrs.retailer_org_id, agt_net_claim_comm as netGamingAmt from st_ola_ret_comm wrs inner join st_lms_retailer_transaction_master rt on wrs.transaction_id=rt.transaction_id where transaction_type = 'OLA_COMMISSION' and transaction_date&gt;='&quot;</span>
						+ startDate
						+ &quot;' and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;') wdret right outer join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on om.organization_id = wdret.retailer_org_id group by om.parent_id&quot;;
<span class="nc" id="L396">			logger.debug(&quot;-------Withdrawal Query------\n&quot; + wdQry);</span>
<span class="nc" id="L397">			logger.debug(&quot;-------WithDrawal Refund Query------\n&quot; + wdRefQry);</span>
<span class="nc" id="L398">			logger.debug(&quot;-------Deposit Query------\n&quot; + depQry);</span>
<span class="nc" id="L399">			logger.debug(&quot;-------Deposit Refund Query------\n&quot; + depRefQry);</span>
<span class="nc" id="L400">			logger.debug(&quot;-------Net Gaming Query------\n&quot; + netGamingQry);</span>


			// Withdrawal Query
<span class="nc" id="L404">			pstmt = con.prepareStatement(wdQry.toString());</span>
<span class="nc" id="L405">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L406" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L407">				agtMap.get(rs.getString(&quot;agtOrgId&quot;)).setWithdrawal(</span>
						rs.getDouble(&quot;wdraw&quot;));
			}
			// WithDrawal Refund Query
<span class="nc" id="L411">			pstmt = con.prepareStatement(wdRefQry.toString());</span>
<span class="nc" id="L412">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L413" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L414">				agtMap.get(rs.getString(&quot;agtOrgId&quot;)).setWithdrawalRefund(</span>
						rs.getDouble(&quot;wdrawRef&quot;));
			}
			
			// Deposit Query
<span class="nc" id="L419">			pstmt = con.prepareStatement(depQry.toString());</span>
<span class="nc" id="L420">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L421" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L422">				agtMap.get(rs.getString(&quot;agtOrgId&quot;)).setDeposit(</span>
						rs.getDouble(&quot;depoAmt&quot;));
			}
			// Deposit Refund Query
<span class="nc" id="L426">			pstmt = con.prepareStatement(depRefQry.toString());</span>
<span class="nc" id="L427">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L428" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L429">				agtMap.get(rs.getString(&quot;agtOrgId&quot;)).setDepositRefund(</span>
						rs.getDouble(&quot;depoRefAmt&quot;));
			}
			
			//net gaming commission query
<span class="nc" id="L434">			pstmt = con.prepareStatement(netGamingQry);</span>
<span class="nc" id="L435">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L436" title="All 2 branches missed.">			while(rs.next()){</span>
<span class="nc" id="L437">				agtMap.get(rs.getString(&quot;agtOrgId&quot;)).setNetGamingComm(</span>
						rs.getDouble(&quot;netAmt&quot;));
			}
		}

<span class="nc" id="L442">		} catch (Exception e) {</span>
<span class="nc" id="L443">			e.printStackTrace();</span>
<span class="nc" id="L444">			throw new LMSException(&quot;Error in report collectionAgentWise&quot;);</span>
<span class="nc" id="L445">		}</span>
<span class="nc" id="L446">	}</span>

	public void collectionAgentWiseExpand(Timestamp startDate,
			Timestamp endDate,Map&lt;String, CollectionReportOverAllBean&gt; agtMap)
			throws LMSException {
<span class="nc" id="L451">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L452">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L453">		ResultSet rs = null;</span>

<span class="nc" id="L455">		String saleTranDG = null;</span>
<span class="nc" id="L456">		String cancelTranDG = null;</span>
<span class="nc" id="L457">		String pwtTranDG = null;</span>
<span class="nc" id="L458">		String saleTranCS = null;</span>
<span class="nc" id="L459">		String cancelTranCS = null;</span>
<span class="nc" id="L460">		String dirPlrPwt = null;</span>
<span class="nc" id="L461">		String wdTranOLA = null;</span>
<span class="nc" id="L462">		String wdRefTranOLA = null;</span>
<span class="nc" id="L463">		String depoTranOLA = null;</span>
<span class="nc" id="L464">		String depoRefTranOLA= null;</span>
<span class="nc" id="L465">		String netGTranOLA = null;</span>
<span class="nc" id="L466">		StringBuilder drawQry = null;</span>
<span class="nc" id="L467">		StringBuilder scratchQry = null;</span>
<span class="nc" id="L468">		StringBuilder CSQry = null;</span>
<span class="nc" id="L469">		StringBuilder OLAQry = null;</span>
<span class="nc" id="L470">		CollectionReportOverAllBean agentBean = null;</span>
<span class="nc" id="L471">		CompleteCollectionBean gameBean, prodBean = null;</span>
		try {
<span class="nc bnc" id="L473" title="All 2 branches missed.">			if (ReportUtility.isDG) {</span>
<span class="nc" id="L474">				drawQry = new StringBuilder(</span>
						&quot;select organization_id,ifnull(sale,0.0) sale,ifnull(cancel,0.0) cancel,ifnull(pwt,0.0)  pwt from (select sale.parent_id,sale,cancel,pwt from &quot;);
<span class="nc" id="L476">				saleTranDG = &quot;(select bb.parent_id,sum(sale) as sale from (select drs.retailer_org_id,sum(agent_net_amt) as sale from st_dg_ret_sale_? drs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_SALE','DG_SALE_OFFLINE') and transaction_date&gt;='&quot;</span>
						+ startDate
						+ &quot;' and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;') group by drs.retailer_org_id) aa right outer join (select organization_id,parent_id from st_lms_organization_master where organization_type='RETAILER')bb on retailer_org_id=organization_id group by parent_id) sale,&quot;;
<span class="nc" id="L481">				cancelTranDG = &quot;(select bb.parent_id,sum(cancel) as cancel from (select drs.retailer_org_id,sum(agent_net_amt) as cancel from st_dg_ret_sale_refund_? drs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_REFUND_CANCEL','DG_REFUND_FAILED') and transaction_date&gt;='&quot;</span>
						+ startDate
						+ &quot;' and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;') group by drs.retailer_org_id) aa right outer join (select organization_id,parent_id from st_lms_organization_master where organization_type='RETAILER') bb on retailer_org_id=organization_id group by parent_id) cancel,&quot;;
<span class="nc" id="L486">				pwtTranDG = &quot;(select bb.parent_id,sum(pwt) as pwt from (select drs.retailer_org_id,sum(pwt_amt+agt_claim_comm) as pwt from st_dg_ret_pwt_? drs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_PWT_AUTO','DG_PWT_PLR','DG_PWT') and transaction_date&gt;='&quot;</span>
						+ startDate
						+ &quot;' and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;') group by drs.retailer_org_id) aa right outer join (select organization_id,parent_id from st_lms_organization_master where organization_type='RETAILER') bb on retailer_org_id=organization_id group by parent_id) pwt&quot;;
<span class="nc" id="L491">				drawQry.append(saleTranDG);</span>
<span class="nc" id="L492">				drawQry.append(cancelTranDG);</span>
<span class="nc" id="L493">				drawQry.append(pwtTranDG);</span>
<span class="nc" id="L494">				drawQry</span>
						.append(&quot; where sale.parent_id=cancel.parent_id and sale.parent_id=pwt.parent_id and cancel.parent_id=pwt.parent_id) gameTlb right outer join (select organization_id from st_lms_organization_master where organization_type='AGENT') agtTlb on gameTlb.parent_id=agtTlb.organization_id&quot;);
<span class="nc" id="L496">				logger.debug(&quot;For Expand draw game Qry:: &quot; + drawQry);</span>

<span class="nc" id="L498">				dirPlrPwt = &quot;select organization_id,ifnull(pwtDir,0.0) pwtDir from (select agent_org_id,sum(pwt_amt+agt_claim_comm) pwtDir from st_dg_agt_direct_plr_pwt where transaction_date&gt;='&quot;</span>
						+ startDate
						+ &quot;' and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;' and game_id=? group by agent_org_id) aa right outer join (select organization_id from st_lms_organization_master where organization_type='AGENT') bb on agent_org_id=organization_id&quot;;

<span class="nc" id="L504">				logger.debug(&quot;For Expand draw game Qry Direct Ply:: &quot;</span>
						+ dirPlrPwt);
				// Game Master Query
<span class="nc" id="L507">				String gameQry = ReportUtility.getDrawGameMapQuery(startDate);</span>
<span class="nc" id="L508">				PreparedStatement gamePstmt = con.prepareStatement(gameQry);</span>
<span class="nc" id="L509">				ResultSet rsGame = gamePstmt.executeQuery();</span>
<span class="nc bnc" id="L510" title="All 2 branches missed.">				while (rsGame.next()) {</span>
<span class="nc" id="L511">					int gameId = rsGame.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L512">					String gameName = rsGame.getString(&quot;game_name&quot;);</span>
<span class="nc" id="L513">					pstmt = con.prepareStatement(drawQry.toString());</span>
<span class="nc" id="L514">					pstmt.setInt(1, gameId);</span>
<span class="nc" id="L515">					pstmt.setInt(2, gameId);</span>
<span class="nc" id="L516">					pstmt.setInt(3, gameId);</span>
<span class="nc" id="L517">					logger.debug(&quot;-------Indivisual Game Qry-------\n&quot; + pstmt);</span>
<span class="nc" id="L518">					rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L519" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L520">						String agtOrgId = rs.getString(&quot;organization_id&quot;);</span>
<span class="nc" id="L521">						agentBean = agtMap.get(agtOrgId);</span>
<span class="nc" id="L522">						Map&lt;String, CompleteCollectionBean&gt; gameMap = agentBean</span>
								.getGameBeanMap();
<span class="nc bnc" id="L524" title="All 2 branches missed.">						if (gameMap == null) {</span>
<span class="nc" id="L525">							gameMap = new HashMap&lt;String, CompleteCollectionBean&gt;();</span>
<span class="nc" id="L526">							agentBean.setGameBeanMap(gameMap);</span>
						}
<span class="nc" id="L528">						gameBean = gameMap.get(gameName);</span>
<span class="nc bnc" id="L529" title="All 2 branches missed.">						if (gameBean == null) {</span>
<span class="nc" id="L530">							gameBean = new CompleteCollectionBean();</span>
<span class="nc" id="L531">							gameMap.put(gameName, gameBean);</span>
						}
<span class="nc" id="L533">						gameBean.setOrgName(gameName);</span>
<span class="nc" id="L534">						gameBean.setDrawSale(rs.getDouble(&quot;sale&quot;));</span>
<span class="nc" id="L535">						gameBean.setDrawCancel(rs.getDouble(&quot;cancel&quot;));</span>
<span class="nc" id="L536">						gameBean.setDrawPwt(rs.getDouble(&quot;pwt&quot;));</span>
<span class="nc" id="L537">					}</span>

					// Direct Player Pwt
<span class="nc" id="L540">					pstmt = con.prepareStatement(dirPlrPwt);</span>
<span class="nc" id="L541">					pstmt.setInt(1, gameId);</span>
<span class="nc" id="L542">					rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L543" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L544">						String agtOrgId = rs.getString(&quot;organization_id&quot;);</span>
<span class="nc" id="L545">						agentBean = agtMap.get(agtOrgId);</span>
<span class="nc" id="L546">						Map&lt;String, CompleteCollectionBean&gt; gameMap = agentBean</span>
								.getGameBeanMap();
<span class="nc bnc" id="L548" title="All 2 branches missed.">						if (gameMap == null) {</span>
<span class="nc" id="L549">							gameMap = new HashMap&lt;String, CompleteCollectionBean&gt;();</span>
<span class="nc" id="L550">							agentBean.setGameBeanMap(gameMap);</span>
						}
<span class="nc" id="L552">						gameBean = gameMap.get(gameName);</span>
<span class="nc bnc" id="L553" title="All 2 branches missed.">						if (gameBean == null) {</span>
<span class="nc" id="L554">							gameBean = new CompleteCollectionBean();</span>
<span class="nc" id="L555">							gameMap.put(gameName, gameBean);</span>
						}
<span class="nc" id="L557">						gameBean.setDrawDirPlyPwt(rs.getDouble(&quot;pwtDir&quot;));</span>
<span class="nc" id="L558">					}</span>
<span class="nc" id="L559">				}</span>
			}
<span class="nc bnc" id="L561" title="All 2 branches missed.">			if (ReportUtility.isSE) {</span>
<span class="nc" id="L562">				scratchQry = new StringBuilder(</span>
						&quot;select organization_id,ifnull(sale,0.0) sale,ifnull(pwt,0.0) pwt from (select sale.parent_id,sale,pwt from&quot;);
<span class="nc" id="L564">				logger.info(&quot;----Type Select ---&quot;</span>
						+ LMSFilterDispatcher.seSaleReportType);
<span class="nc" id="L566">				boolean isTrue=false;</span>
<span class="nc bnc" id="L567" title="All 2 branches missed.">				if (&quot;BOOK_WISE&quot;.equals(LMSFilterDispatcher.seSaleReportType)) {</span>
<span class="nc" id="L568">					isTrue=true;</span>
<span class="nc" id="L569">					saleTranDG = &quot;(select sale.organization_id parent_id,sale.name,(ifnull(mrpAmt,0.0)-ifnull(mrpAmtRet,0.0)) mrpAmt,(ifnull(netAmt,0.0)-ifnull(netAmtRet,0.0)) sale from (select organization_id,name,ifnull(mrpAmt,0.0) mrpAmt,ifnull(netAmt,0.0) netAmt from st_lms_organization_master left outer join (select agent_org_id,sum(mrpAmt) mrpAmt,sum(netAmt) netAmt from(select agent_org_id,sum(mrp_amt) mrpAmt,sum(net_amt) netAmt from st_se_bo_agent_transaction right outer join st_lms_organization_master on organization_id=agent_org_id where game_id=?   and transaction_id in (select transaction_id from st_lms_bo_transaction_master where transaction_type='SALE' and transaction_date&gt;='&quot;</span>
						+ startDate
						+ &quot;'  and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;' ) group by agent_org_id union all select agent_org_id,sum(mrp_amt) mrpAmt,sum(net_amt) netAmt from st_se_bo_agent_loose_book_transaction right outer join st_lms_organization_master on organization_id=agent_org_id where game_id=?   and transaction_id in (select transaction_id from st_lms_bo_transaction_master where transaction_type='LOOSE_SALE' and transaction_date&gt;='&quot;
						+ startDate
						+ &quot;'  and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;' ) group by agent_org_id)sale group by agent_org_id ) sale on organization_id=agent_org_id where organization_type='AGENT') sale inner join (select organization_id,name,ifnull(mrpAmtRet,0.0) mrpAmtRet,ifnull(netAmtRet,0.0) netAmtRet from st_lms_organization_master left outer join (select agent_org_id,sum(mrpAmtRet) mrpAmtRet,sum(netAmtRet) netAmtRet from (select agent_org_id,sum(mrp_amt) mrpAmtRet,sum(net_amt) netAmtRet from st_se_bo_agent_transaction where game_id=?   and transaction_id in (select transaction_id from st_lms_bo_transaction_master where transaction_type='SALE_RET' and transaction_date&gt;='&quot;
						+ startDate
						+ &quot;'  and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;' ) group by agent_org_id union all	select agent_org_id,sum(mrp_amt) mrpAmtRet,sum(net_amt) netAmtRet from st_se_bo_agent_loose_book_transaction where game_id=?   and transaction_id in (select transaction_id from st_lms_bo_transaction_master where transaction_type='LOOSE_SALE_RET' and transaction_date&gt;='&quot;
						+ startDate
						+ &quot;'  and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;' ) group by agent_org_id )saleRet group by agent_org_id ) saleRet on organization_id=agent_org_id where organization_type='AGENT') saleRet on sale.organization_id=saleRet.organization_id) sale left outer join&quot;;
<span class="nc bnc" id="L586" title="All 2 branches missed.">				} else if (&quot;TICKET_WISE&quot;</span>
						.equals(LMSFilterDispatcher.seSaleReportType)) {
<span class="nc" id="L588">					saleTranDG = &quot;(select organization_id parent_id,name,ifnull(mrpAmt,0.0) mrpAmt,ifnull(netAmt,0.0) sale from st_lms_organization_master left outer join (select current_owner_id,sum(soldTkt*ticket_price) mrpAmt,sum((soldTkt*ticket_price)-(soldTkt*ticket_price*transacrion_sale_comm_rate*0.01)) netAmt from st_se_game_master gm,st_se_game_inv_detail gid,(select game_id,book_nbr,sum(sold_tickets) soldTkt from st_se_game_ticket_inv_history where date&gt;='&quot;</span>
							+ startDate
							+ &quot;' and date&lt;='&quot;
							+ endDate
							+ &quot;' and current_owner='RETAILER' and game_id=? group by book_nbr) TktTlb where gm.game_id=? and gm.game_id=TktTlb.game_id and TktTlb.book_nbr=gid.book_nbr and gid.current_owner='AGENT' group by current_owner_id) saleTlb on organization_id=current_owner_id where organization_type='AGENT') sale,&quot;;
				}
<span class="nc" id="L594">				pwtTranDG = &quot;(select parent_id,sum(pwt) pwt from (select bb.parent_id,sum(pwt) as pwt from (select retailer_org_id,sum(pwt_amt+(pwt_amt*agt_claim_comm*0.01)) pwt from st_se_retailer_pwt where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_date&gt;='&quot;</span>
						+ startDate
						+ &quot;' and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;' and transaction_type='PWT') and game_id=? group by retailer_org_id union all select retailer_org_id,sum(pwt_amt+(pwt_amt*claim_comm*0.01)) pwt from st_se_agent_pwt where transaction_id in (select transaction_id from st_lms_agent_transaction_master where transaction_date&gt;='&quot;
						+ startDate
						+ &quot;' and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;' and transaction_type='PWT') and game_id=? group by retailer_org_id) aa right outer join (select organization_id,parent_id from st_lms_organization_master where organization_type='RETAILER') bb on retailer_org_id=organization_id group by parent_id union all select agent_org_id,sum(pwt_amt+comm_amt) boPwt from st_se_bo_pwt where transaction_id in (select transaction_id from st_lms_bo_transaction_master where transaction_date&gt;='&quot;
						+ startDate
						+ &quot;' and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;' and transaction_type='PWT' and agent_org_id in (select organization_id from st_lms_organization_master where organization_type='AGENT')) and game_id=? group by agent_org_id) pwt group by parent_id) pwt&quot;;
<span class="nc" id="L607">				scratchQry.append(saleTranDG);</span>
<span class="nc" id="L608">				scratchQry.append(pwtTranDG);</span>
<span class="nc bnc" id="L609" title="All 2 branches missed.">				scratchQry</span>
						.append(&quot; &quot;+((isTrue)?&quot;on&quot;:&quot;where&quot;)+&quot; sale.parent_id=pwt.parent_id) gameTlb right outer join (select organization_id from st_lms_organization_master where organization_type='AGENT') agtTlb on gameTlb.parent_id=agtTlb.organization_id&quot;);
<span class="nc" id="L611">				logger.debug(&quot;For Expand scratch game Qry:: &quot; + scratchQry);</span>

<span class="nc" id="L613">				dirPlrPwt = &quot;select organization_id,ifnull(pwtDir,0.0) pwtDir from (select agent_org_id,sum(pwt_amt+(pwt_amt*claim_comm*0.01)) pwtDir from st_se_agt_direct_player_pwt where transaction_date&gt;='&quot;</span>
						+ startDate
						+ &quot;' and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;' and game_id=? group by agent_org_id) aa right outer join (select organization_id from st_lms_organization_master where organization_type='AGENT') bb on agent_org_id=organization_id&quot;;

<span class="nc" id="L619">				logger.debug(&quot;For Expand scratch game Qry Direct Ply:: &quot;</span>
						+ dirPlrPwt);
				// Game Master Query
<span class="nc" id="L622">				String gameQry = &quot;select game_id,game_name from st_se_game_master&quot;;</span>
<span class="nc" id="L623">				PreparedStatement gamePstmt = con.prepareStatement(gameQry);</span>
<span class="nc" id="L624">				ResultSet rsGame = gamePstmt.executeQuery();</span>
<span class="nc bnc" id="L625" title="All 2 branches missed.">				while (rsGame.next()) {</span>
<span class="nc" id="L626">					int gameId = rsGame.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L627">					String gameName = rsGame.getString(&quot;game_name&quot;);</span>
<span class="nc" id="L628">					pstmt = con.prepareStatement(scratchQry.toString());</span>
<span class="nc" id="L629">					pstmt.setInt(1, gameId);</span>
<span class="nc" id="L630">					pstmt.setInt(2, gameId);</span>
<span class="nc" id="L631">					pstmt.setInt(3, gameId);</span>
<span class="nc" id="L632">					pstmt.setInt(4, gameId);</span>
<span class="nc" id="L633">					pstmt.setInt(5, gameId);</span>
<span class="nc" id="L634">					pstmt.setInt(6, gameId);</span>
<span class="nc" id="L635">					pstmt.setInt(7, gameId);</span>
<span class="nc" id="L636">					logger.debug(&quot;-------Indivisual Game Qry-------\n&quot; + pstmt);</span>
<span class="nc" id="L637">					rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L638" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L639">						String agtOrgId = rs.getString(&quot;organization_id&quot;);</span>
<span class="nc" id="L640">						agentBean = agtMap.get(agtOrgId);</span>
<span class="nc" id="L641">						Map&lt;String, CompleteCollectionBean&gt; gameMap = agentBean</span>
								.getGameBeanMap();
<span class="nc bnc" id="L643" title="All 2 branches missed.">						if (gameMap == null) {</span>
<span class="nc" id="L644">							gameMap = new HashMap&lt;String, CompleteCollectionBean&gt;();</span>
<span class="nc" id="L645">							agentBean.setGameBeanMap(gameMap);</span>
						}
<span class="nc" id="L647">						gameBean = gameMap.get(gameName);</span>
<span class="nc bnc" id="L648" title="All 2 branches missed.">						if (gameBean == null) {</span>
<span class="nc" id="L649">							gameBean = new CompleteCollectionBean();</span>
<span class="nc" id="L650">							gameMap.put(gameName, gameBean);</span>
						}
<span class="nc" id="L652">						gameBean.setOrgName(gameName);</span>
<span class="nc" id="L653">						gameBean.setDrawSale(rs.getDouble(&quot;sale&quot;));</span>
<span class="nc" id="L654">						gameBean.setDrawCancel(0.0);</span>
<span class="nc" id="L655">						gameBean.setDrawPwt(rs.getDouble(&quot;pwt&quot;));</span>
<span class="nc" id="L656">					}</span>

					// Direct Player Pwt
<span class="nc" id="L659">					pstmt = con.prepareStatement(dirPlrPwt);</span>
<span class="nc" id="L660">					pstmt.setInt(1, gameId);</span>
<span class="nc" id="L661">					rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L662" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L663">						String agtOrgId = rs.getString(&quot;organization_id&quot;);</span>
<span class="nc" id="L664">						agentBean = agtMap.get(agtOrgId);</span>
<span class="nc" id="L665">						Map&lt;String, CompleteCollectionBean&gt; gameMap = agentBean</span>
								.getGameBeanMap();
<span class="nc bnc" id="L667" title="All 2 branches missed.">						if (gameMap == null) {</span>
<span class="nc" id="L668">							gameMap = new HashMap&lt;String, CompleteCollectionBean&gt;();</span>
<span class="nc" id="L669">							agentBean.setGameBeanMap(gameMap);</span>
						}
<span class="nc" id="L671">						gameBean = gameMap.get(gameName);</span>
<span class="nc bnc" id="L672" title="All 2 branches missed.">						if (gameBean == null) {</span>
<span class="nc" id="L673">							gameBean = new CompleteCollectionBean();</span>
<span class="nc" id="L674">							gameMap.put(gameName, gameBean);</span>
						}
<span class="nc" id="L676">						gameBean.setDrawDirPlyPwt(rs.getDouble(&quot;pwtDir&quot;));</span>
<span class="nc" id="L677">					}</span>
<span class="nc" id="L678">				}</span>
			}
<span class="nc bnc" id="L680" title="All 2 branches missed.">			if (ReportUtility.isCS) {</span>

<span class="nc" id="L682">				CSQry = new StringBuilder(</span>
						&quot;select organization_id,ifnull(sale,0.0) sale,ifnull(cancel,0.0) cancel from (select sale.parent_id,sale,cancel from &quot;);
<span class="nc" id="L684">				saleTranCS = &quot;(select bb.parent_id,sum(sale) as sale from (select drs.retailer_org_id,sum(agent_net_amt) as sale from st_cs_sale_? drs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type in('CS_SALE') and transaction_date&gt;='&quot;</span>
						+ startDate
						+ &quot;' and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;') group by drs.retailer_org_id) aa right outer join (select organization_id,parent_id from st_lms_organization_master where organization_type='RETAILER')bb on retailer_org_id=organization_id group by parent_id) sale,&quot;;
<span class="nc" id="L689">				cancelTranCS = &quot;(select bb.parent_id,sum(cancel) as cancel from (select drs.retailer_org_id,sum(agent_net_amt) as cancel from st_cs_refund_? drs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type in('CS_CANCEL_SERVER','CS_CANCEL_RET') and transaction_date&gt;='&quot;</span>
						+ startDate
						+ &quot;' and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;') group by drs.retailer_org_id) aa right outer join (select organization_id,parent_id from st_lms_organization_master where organization_type='RETAILER') bb on retailer_org_id=organization_id group by parent_id) cancel&quot;;
<span class="nc" id="L694">				CSQry.append(saleTranCS);</span>
<span class="nc" id="L695">				CSQry.append(cancelTranCS);</span>
<span class="nc" id="L696">				CSQry</span>
						.append(&quot; where sale.parent_id=cancel.parent_id) gameTlb right outer join (select organization_id from st_lms_organization_master where organization_type='AGENT') agtTlb on gameTlb.parent_id=agtTlb.organization_id&quot;);
<span class="nc" id="L698">				logger.debug(&quot;For Expand CS game Qry:: &quot; + CSQry);</span>

				// Category Master Query
<span class="nc" id="L701">				String prodQry = &quot;select category_id, category_code from st_cs_product_category_master where status = 'ACTIVE'&quot;;</span>
<span class="nc" id="L702">				PreparedStatement prodPstmt = con.prepareStatement(prodQry);</span>
<span class="nc" id="L703">				ResultSet rsProd = prodPstmt.executeQuery();</span>
<span class="nc bnc" id="L704" title="All 2 branches missed.">				while (rsProd.next()) {</span>
<span class="nc" id="L705">					int catId = rsProd.getInt(&quot;category_id&quot;);</span>
<span class="nc" id="L706">					String catName = rsProd.getString(&quot;category_code&quot;);</span>
<span class="nc" id="L707">					pstmt = con.prepareStatement(CSQry.toString());</span>
<span class="nc" id="L708">					pstmt.setInt(1, catId);</span>
<span class="nc" id="L709">					pstmt.setInt(2, catId);</span>
<span class="nc" id="L710">					logger.debug(&quot;-------Indivisual Category Qry-------\n&quot;</span>
							+ pstmt);
<span class="nc" id="L712">					rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L713" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L714">						String agtOrgId = rs.getString(&quot;organization_id&quot;);</span>
<span class="nc" id="L715">						agentBean = agtMap.get(agtOrgId);</span>
<span class="nc" id="L716">						Map&lt;String, CompleteCollectionBean&gt; prodMap = agentBean</span>
								.getGameBeanMap();
<span class="nc bnc" id="L718" title="All 2 branches missed.">						if (prodMap == null) {</span>
<span class="nc" id="L719">							prodMap = new HashMap&lt;String, CompleteCollectionBean&gt;();</span>
<span class="nc" id="L720">							agentBean.setGameBeanMap(prodMap);</span>
						}
<span class="nc" id="L722">						prodBean = prodMap.get(catName);</span>
<span class="nc bnc" id="L723" title="All 2 branches missed.">						if (prodBean == null) {</span>
<span class="nc" id="L724">							prodBean = new CompleteCollectionBean();</span>
<span class="nc" id="L725">							prodMap.put(catName, prodBean);</span>
						}
<span class="nc" id="L727">						prodBean.setOrgName(catName);</span>
<span class="nc" id="L728">						prodBean.setCSSale(rs.getDouble(&quot;sale&quot;));</span>
<span class="nc" id="L729">						prodBean.setCSCancel(rs.getDouble(&quot;cancel&quot;));</span>

<span class="nc" id="L731">						System.out.println(&quot;map size:&quot; + prodMap.size());</span>
<span class="nc" id="L732">					}</span>

<span class="nc" id="L734">				}</span>

			}
<span class="nc bnc" id="L737" title="All 2 branches missed.">			if(ReportUtility.isOLA){</span>

<span class="nc" id="L739">				OLAQry = new StringBuilder(</span>
						&quot;select withdraw.agtOrgId, (wdra-wdraRef) withdrawAmt, (depo-depoRef) depositAmt, netAmt netGamingComm from &quot;);
<span class="nc" id="L741">				wdTranOLA = &quot;(select om.parent_id agtOrgId, ifnull(sum(wdra),0.0)wdra from (select ifnull(orw.retailer_org_id,0)retId, ifnull(sum(agent_net_amt),0.0) as wdra from st_ola_ret_withdrawl orw where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type='OLA_WITHDRAWL' and transaction_date&gt;='&quot;</span>
							+ startDate
							+ &quot;' and transaction_date &lt;='&quot;
							+ endDate 
							+&quot;') and orw.wallet_id = ? group by retId)wd right outer join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on wd.retId = om.organization_id group by parent_id)wd,&quot;;
<span class="nc" id="L746">				wdRefTranOLA = &quot;(select om.parent_id agtOrgId, ifnull(sum(wdraRef),0.0)wdraRef from (select ifnull(orwRef.retailer_org_id,0)retId, ifnull(sum(agent_net_amt),0.0) as wdraRef from st_ola_ret_withdrawl_refund orwRef where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type='OLA_WITHDRAWL_REFUND' and transaction_date&gt;= '&quot;</span>
							+ startDate
							+ &quot;' and transaction_date &lt;= '&quot;
							+ endDate 
							+ &quot;') and orwRef.wallet_id = ? group by retId)wdRef right outer join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on wdRef.retId = om.organization_id group by parent_id)wdRef&quot;;
<span class="nc" id="L751">				depoTranOLA = &quot;(select om.parent_id agtOrgId, ifnull(sum(depo),0.0)depo from (select ifnull(ordepo.retailer_org_id,0)retId, ifnull(sum(agent_net_amt),0.0) as depo from st_ola_ret_deposit ordepo where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type='OLA_DEPOSIT' and transaction_date&gt;='&quot;</span>
						+ startDate
						+ &quot;' and transaction_date &lt;='&quot;
						+ endDate 
						+&quot;') and ordepo.wallet_id = ? group by retId)depo right outer join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on depo.retId = om.organization_id group by parent_id)depo,&quot;;
<span class="nc" id="L756">				depoRefTranOLA = &quot;(select om.parent_id agtOrgId, ifnull(sum(depoRef),0.0)depoRef from (select ifnull(ordepoRef.retailer_org_id,0)retId, ifnull(sum(agent_net_amt),0.0) as depoRef from st_ola_ret_deposit_refund ordepoRef where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type='OLA_DEPOSIT_REFUND' and transaction_date&gt;= '&quot;</span>
						+ startDate
						+ &quot;' and transaction_date &lt;= '&quot;
						+ endDate 
						+ &quot;') and ordepoRef.wallet_id = ? group by retId)depoRef right outer join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on depoRef.retId = om.organization_id group by parent_id)depoRef&quot;;
<span class="nc" id="L761">				netGTranOLA =&quot;(select om.parent_id agtOrgId, ifnull(sum(netGamingAmt), 0.0) netAmt from(select wrs.retailer_org_id, agt_net_claim_comm as netGamingAmt from st_ola_ret_comm wrs inner join st_lms_retailer_transaction_master rt on wrs.transaction_id=rt.transaction_id where transaction_type = 'OLA_COMMISSION' and transaction_date&gt;='&quot;+ startDate + &quot;' and transaction_date&lt;='&quot;	+ endDate+ &quot;' and wallet_id = ?) wdret right outer join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on om.organization_id = wdret.retailer_org_id group by om.parent_id) netgaming&quot;;</span>
<span class="nc" id="L762">				OLAQry.append(&quot;(select wd.agtOrgId, wdra, wdraRef from&quot;);</span>
<span class="nc" id="L763">				OLAQry.append(wdTranOLA);</span>
<span class="nc" id="L764">				OLAQry.append(wdRefTranOLA);</span>
<span class="nc" id="L765">				OLAQry.append(&quot; where wd.agtOrgId = wdRef.agtOrgId)withdraw,&quot;);</span>
<span class="nc" id="L766">				OLAQry.append(&quot;(select depo.agtOrgId, depo, depoRef from&quot;);</span>
<span class="nc" id="L767">				OLAQry.append(depoTranOLA);</span>
<span class="nc" id="L768">				OLAQry.append(depoRefTranOLA);</span>
<span class="nc" id="L769">				OLAQry.append(&quot; where depo.agtOrgId = depoRef.agtOrgId)deposit, &quot;);</span>
<span class="nc" id="L770">				OLAQry.append(netGTranOLA);</span>
<span class="nc" id="L771">				OLAQry</span>
						.append(&quot; where withdraw.agtOrgId = deposit.agtOrgId and netgaming.agtOrgId = withdraw.agtOrgId and netgaming.agtOrgId = deposit.agtOrgId&quot;);
<span class="nc" id="L773">				logger.debug(&quot;For Expand OLA wallet Qry:: &quot; + OLAQry);</span>

				// Wallet Master Query
<span class="nc" id="L776">				String walletQry = &quot;select wallet_id, wallet_name from st_ola_wallet_master&quot;;</span>
<span class="nc" id="L777">				PreparedStatement walletPstmt = con.prepareStatement(walletQry);</span>
<span class="nc" id="L778">				ResultSet rsWallet = walletPstmt.executeQuery();</span>
<span class="nc bnc" id="L779" title="All 2 branches missed.">				while (rsWallet.next()) {</span>
<span class="nc" id="L780">					int walletId = rsWallet.getInt(&quot;wallet_id&quot;);</span>
<span class="nc" id="L781">					String walletName = rsWallet.getString(&quot;wallet_name&quot;);</span>
<span class="nc" id="L782">					pstmt = con.prepareStatement(OLAQry.toString());</span>
<span class="nc" id="L783">					pstmt.setInt(1, walletId);</span>
<span class="nc" id="L784">					pstmt.setInt(2, walletId);</span>
<span class="nc" id="L785">					pstmt.setInt(3, walletId);</span>
<span class="nc" id="L786">					pstmt.setInt(4, walletId);</span>
<span class="nc" id="L787">					pstmt.setInt(5, walletId);</span>
<span class="nc" id="L788">					logger.debug(&quot;-------Indivisual Wallet Qry-------\n&quot; + pstmt);</span>
<span class="nc" id="L789">					rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L790" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L791">						String agtOrgId = rs.getString(&quot;agtOrgId&quot;);</span>
<span class="nc" id="L792">						agentBean = agtMap.get(agtOrgId);</span>
<span class="nc" id="L793">						Map&lt;String, CompleteCollectionBean&gt; walletMap = agentBean</span>
								.getGameBeanMap();
<span class="nc bnc" id="L795" title="All 2 branches missed.">						if (walletMap == null) {</span>
<span class="nc" id="L796">							walletMap = new HashMap&lt;String, CompleteCollectionBean&gt;();</span>
<span class="nc" id="L797">							agentBean.setGameBeanMap(walletMap);</span>
						}
<span class="nc" id="L799">						gameBean = walletMap.get(walletName);</span>
<span class="nc bnc" id="L800" title="All 2 branches missed.">						if (gameBean == null) {</span>
<span class="nc" id="L801">							gameBean = new CompleteCollectionBean();</span>
<span class="nc" id="L802">							walletMap.put(walletName, gameBean);</span>
						}
<span class="nc" id="L804">						gameBean.setOrgName(walletName);</span>
<span class="nc" id="L805">						gameBean.setOlaWithdrawalAmt(rs.getDouble(&quot;withdrawAmt&quot;));</span>
<span class="nc" id="L806">						gameBean.setOlaDepositAmt(rs.getDouble(&quot;depositAmt&quot;));</span>
<span class="nc" id="L807">						gameBean.setOlaNetGaming(rs.getDouble(&quot;netGamingComm&quot;));</span>
<span class="nc" id="L808">					}</span>
<span class="nc" id="L809">				}</span>
			
			}
<span class="nc" id="L812">		} catch (Exception e) {</span>
<span class="nc" id="L813">			e.printStackTrace();</span>
<span class="nc" id="L814">			throw new LMSException(&quot;Error in report collectionAgentWise Expand&quot;);</span>
		} finally {
<span class="nc" id="L816">			try {</span>
<span class="nc" id="L817">				con.close();</span>
<span class="nc" id="L818">			} catch (SQLException e) {</span>
<span class="nc" id="L819">				e.printStackTrace();</span>
<span class="nc" id="L820">			}</span>
<span class="nc" id="L821">		}</span>
<span class="nc" id="L822">	}</span>

	public Map&lt;String, CollectionReportOverAllBean&gt; collectionAgentWiseWithOpeningBal(
			Timestamp deployDate, Timestamp startDate, Timestamp endDate, String cityCode, String stateCode) throws LMSException {
<span class="nc" id="L826">		return commanMethodOfCollectionAgentWiseWithOpeningBal(deployDate, startDate, endDate,0);</span>
	}
	
	
	public Map&lt;String, CollectionReportOverAllBean&gt; collectionAgentWiseWithOpeningBal(
			Timestamp deployDate, Timestamp startDate, Timestamp endDate, String cityCode, String stateCode,int roleId) throws LMSException {
<span class="nc" id="L832">		return commanMethodOfCollectionAgentWiseWithOpeningBal(deployDate, startDate, endDate, roleId);</span>
	}

	private Map&lt;String, CollectionReportOverAllBean&gt; commanMethodOfCollectionAgentWiseWithOpeningBal(
			Timestamp deployDate, Timestamp startDate, Timestamp endDate, int roleId) throws LMSException {
<span class="nc" id="L837">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L838">		ResultSet rsRetOrg = null;</span>
<span class="nc" id="L839">		Connection con = null;</span>
<span class="nc" id="L840">		String agtOrgQry=null;</span>
<span class="nc bnc" id="L841" title="All 2 branches missed.">		if (startDate.after(endDate)) {</span>
<span class="nc" id="L842">			return null;</span>
		}
<span class="nc" id="L844">		Map&lt;String, CollectionReportOverAllBean&gt; agtMap = new LinkedHashMap&lt;String, CollectionReportOverAllBean&gt;();</span>
<span class="nc" id="L845">		CollectionReportOverAllBean collBean = null;</span>

		try {
<span class="nc" id="L848">			con = DBConnect.getConnection();</span>
			
<span class="nc bnc" id="L850" title="All 2 branches missed.">			if(roleId!=0){</span>
<span class="nc" id="L851">				agtOrgQry = QueryManager.getOrgQryUsingRoleId(&quot;AGENT&quot;,roleId);	</span>
			}else{
<span class="nc" id="L853">				agtOrgQry = QueryManager.getOrgQry(&quot;AGENT&quot;);</span>
			}
			
			
			/*String agtOrgQry = &quot;select name,organization_id from st_lms_organization_master where organization_type='AGENT' order by name&quot;;*/
<span class="nc" id="L858">			pstmt = con.prepareStatement(agtOrgQry);</span>
<span class="nc" id="L859">			rsRetOrg = pstmt.executeQuery();</span>
<span class="nc bnc" id="L860" title="All 2 branches missed.">			while (rsRetOrg.next()) {</span>
<span class="nc" id="L861">				collBean = new CollectionReportOverAllBean();</span>
<span class="nc" id="L862">				collBean.setAgentName(rsRetOrg.getString(&quot;orgCode&quot;));</span>
<span class="nc" id="L863">				collBean.setOpeningBal(0.0);</span>
<span class="nc" id="L864">				collBean.setCash(0.0);</span>
<span class="nc" id="L865">				collBean.setCheque(0.0);</span>
<span class="nc" id="L866">				collBean.setChequeReturn(0.0);</span>
<span class="nc" id="L867">				collBean.setCredit(0.0);</span>
<span class="nc" id="L868">				collBean.setDebit(0.0);</span>
<span class="nc" id="L869">				collBean.setBankDep(0.0);</span>
<span class="nc bnc" id="L870" title="All 2 branches missed.">				if (ReportUtility.isDG) {</span>
<span class="nc" id="L871">					collBean.setDgSale(0.0);</span>
<span class="nc" id="L872">					collBean.setDgPwt(0.0);</span>
<span class="nc" id="L873">					collBean.setDgCancel(0.0);</span>
<span class="nc" id="L874">					collBean.setDgDirPlyPwt(0.0);</span>
				}
<span class="nc bnc" id="L876" title="All 2 branches missed.">				if (ReportUtility.isSE) {</span>
<span class="nc" id="L877">					collBean.setSeSale(0.0);</span>
<span class="nc" id="L878">					collBean.setSePwt(0.0);</span>
<span class="nc" id="L879">					collBean.setSeDirPlyPwt(0.0);</span>
				}
<span class="nc bnc" id="L881" title="All 2 branches missed.">				if (ReportUtility.isCS) {</span>
<span class="nc" id="L882">					collBean.setCSSale(0.0);</span>
<span class="nc" id="L883">					collBean.setCSCancel(0.0);</span>
				}
<span class="nc bnc" id="L885" title="All 2 branches missed.">				if(ReportUtility.isOLA){</span>
<span class="nc" id="L886">					collBean.setDeposit(0.0);</span>
<span class="nc" id="L887">					collBean.setDepositRefund(0.0);</span>
<span class="nc" id="L888">					collBean.setWithdrawal(0.0);</span>
<span class="nc" id="L889">					collBean.setWithdrawalRefund(0.0);</span>
<span class="nc" id="L890">					collBean.setNetGamingComm(0.0);</span>
				}
<span class="nc" id="L892">				agtMap.put(rsRetOrg.getString(&quot;organization_id&quot;), collBean);</span>
			}
			// for calculation of opening Balance
<span class="nc" id="L895">			AgentOpeningBalanceHelper openingHelper=new AgentOpeningBalanceHelper();</span>
<span class="nc" id="L896">			openingHelper.collectionAgentWiseOpenningBal(deployDate, startDate, con,agtMap);</span>
			

<span class="nc" id="L899">			collectionAgentWise(startDate, endDate, con,</span>
					agtMap);
<span class="nc" id="L901">		} catch (Exception e) {</span>
<span class="nc" id="L902">			e.printStackTrace();</span>
<span class="nc" id="L903">			throw new LMSException(</span>
					&quot;Error in report collectionAgentWiseWithOpeningBal&quot;);
		} finally {
<span class="nc" id="L906">			try {</span>
<span class="nc" id="L907">				con.close();</span>
<span class="nc" id="L908">			} catch (SQLException e) {</span>
<span class="nc" id="L909">				e.printStackTrace();</span>
<span class="nc" id="L910">			}</span>
<span class="nc" id="L911">		}</span>
<span class="nc" id="L912">		return agtMap;</span>
	}


	//Unimplemented Method
	public Map&lt;String, AgentCollectionReportOverAllBean&gt; collectionRetailerWiseWithOpeningBal(int userId,
			Timestamp deployDate, Timestamp startDate, Timestamp endDate,
<span class="nc" id="L919">			boolean isDG, boolean isSE, boolean isCS, boolean isOLA) throws LMSException{ return null;}</span>

	public void collectionRetailerWiseExpand(int userId, Timestamp startDate,
			Timestamp endDate, boolean isDG, boolean isSE, boolean isCS,
			boolean isOLA, Map&lt;String, AgentCollectionReportOverAllBean&gt; agtMap)
			throws LMSException {
		// TODO Auto-generated method stub
		
<span class="nc" id="L927">	}</span>
	
	

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>