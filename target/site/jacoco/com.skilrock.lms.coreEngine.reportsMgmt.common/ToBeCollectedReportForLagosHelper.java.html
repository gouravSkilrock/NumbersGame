<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ToBeCollectedReportForLagosHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lms</a> &gt; <a href="index.source.html" class="el_package">com.skilrock.lms.coreEngine.reportsMgmt.common</a> &gt; <span class="el_source">ToBeCollectedReportForLagosHelper.java</span></div><h1>ToBeCollectedReportForLagosHelper.java</h1><pre class="source lang-java linenums">package com.skilrock.lms.coreEngine.reportsMgmt.common;

import java.sql.CallableStatement;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.sql.Timestamp;
import java.util.HashMap;
import java.util.Iterator;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.Set;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import com.skilrock.lms.beans.CollectionReportOverAllBean;
import com.skilrock.lms.beans.CompleteCollectionBean;
import com.skilrock.lms.common.db.DBConnect;
import com.skilrock.lms.common.db.QueryManager;
import com.skilrock.lms.common.exception.LMSException;
import com.skilrock.lms.common.filter.LMSFilterDispatcher;
import com.skilrock.lms.web.accMgmt.common.AgentOpeningBalanceHelper;
import com.skilrock.lms.web.reportsMgmt.common.ReportUtility;

<span class="nc" id="L29">public class ToBeCollectedReportForLagosHelper {</span>
<span class="nc" id="L30">	Log logger = LogFactory.getLog(ToBeCollectedReportForLagosHelper.class);</span>
	final static long oneDay = 1 * 24 * 60 * 60 * 1000;

	public Map&lt;String, CollectionReportOverAllBean&gt; fetchDataForAgent(
			Timestamp deployDate, Timestamp startDate) throws LMSException {

<span class="nc" id="L36">		String agtOrgQry = null;</span>
<span class="nc" id="L37">		Connection con = null;</span>
<span class="nc" id="L38">		ResultSet rsRetOrg = null;</span>
<span class="nc" id="L39">		PreparedStatement pstmt = null;</span>

<span class="nc" id="L41">		CollectionReportOverAllBean collBean = null;</span>
		//Map&lt;Integer, CollectionReportOverAllBean&gt; agtMap = null;
<span class="nc" id="L43">		Map&lt;String, CollectionReportOverAllBean&gt; agtMap = null;</span>

		try {

		/*	con = DBConnect.getConnection();
			agtMap = new LinkedHashMap&lt;Integer, CollectionReportOverAllBean&gt;();
			agtOrgQry = &quot;select name,organization_id from st_lms_organization_master where organization_type='AGENT' order by name&quot;;
			pstmt = con.prepareStatement(agtOrgQry);
			rsRetOrg = pstmt.executeQuery();
			while (rsRetOrg.next()) {
				collBean = new CollectionReportOverAllBean();
				collBean.setOpeningBal(0.0);
				collBean.setCash(0.0);
				collBean.setCheque(0.0);
				collBean.setChequeReturn(0.0);
				collBean.setCredit(0.0);
				collBean.setDebit(0.0);
				collBean.setBankDep(0.0);
				if (ReportUtility.isDG) {
					collBean.setDgSale(0.0);
					collBean.setDgPwt(0.0);
					collBean.setDgCancel(0.0);
					collBean.setDgDirPlyPwt(0.0);
				}
				collBean.setAgentName(rsRetOrg.getString(&quot;name&quot;));
				agtMap.put(rsRetOrg.getInt(&quot;organization_id&quot;), collBean);
			}*/
<span class="nc" id="L70">			agtMap = new LinkedHashMap&lt;String, CollectionReportOverAllBean&gt;();</span>
			
<span class="nc" id="L72">			agtOrgQry = QueryManager.getOrgQry(&quot;AGENT&quot;);</span>
		/*	String agtOrgQry = &quot;select name,organization_id from st_lms_organization_master where organization_type='AGENT' order by name&quot;;*/
<span class="nc" id="L74">			con = DBConnect.getConnection();</span>
<span class="nc" id="L75">			pstmt = con.prepareStatement(agtOrgQry);</span>
<span class="nc" id="L76">			rsRetOrg = pstmt.executeQuery();</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">			while (rsRetOrg.next()) {</span>
<span class="nc" id="L78">				collBean = new CollectionReportOverAllBean();</span>
<span class="nc" id="L79">				collBean.setAgentName(rsRetOrg.getString(&quot;orgCode&quot;));</span>
<span class="nc" id="L80">				agtMap.put(rsRetOrg.getString(&quot;organization_id&quot;), collBean);</span>
			}
<span class="nc" id="L82">			collBean = new CollectionReportOverAllBean();</span>
<span class="nc" id="L83">			collBean.setOpeningBal(0.0);</span>
<span class="nc" id="L84">			collBean.setCash(0.0);</span>
<span class="nc" id="L85">			collBean.setCheque(0.0);</span>
<span class="nc" id="L86">			collBean.setChequeReturn(0.0);</span>
<span class="nc" id="L87">			collBean.setCredit(0.0);</span>
<span class="nc" id="L88">			collBean.setDebit(0.0);</span>
<span class="nc" id="L89">			collBean.setBankDep(0.0);</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">			if (ReportUtility.isDG) {</span>
<span class="nc" id="L91">				collBean.setDgSale(0.0);</span>
<span class="nc" id="L92">				collBean.setDgPwt(0.0);</span>
<span class="nc" id="L93">				collBean.setDgCancel(0.0);</span>
<span class="nc" id="L94">				collBean.setDgDirPlyPwt(0.0);</span>
			}
			
<span class="nc bnc" id="L97" title="All 2 branches missed.">			if (ReportUtility.isIW) {</span>
<span class="nc" id="L98">				collBean.setIwSale(0.0);</span>
<span class="nc" id="L99">				collBean.setIwPwt(0.0);</span>
<span class="nc" id="L100">				collBean.setIwCancel(0.0);</span>
<span class="nc" id="L101">				collBean.setIwDirPlyPwt(0.0);</span>
			}
			
<span class="nc bnc" id="L104" title="All 2 branches missed.">			if (ReportUtility.isVS) {</span>
<span class="nc" id="L105">				collBean.setVsSale(0.0);</span>
<span class="nc" id="L106">				collBean.setVsPwt(0.0);</span>
<span class="nc" id="L107">				collBean.setVsCancel(0.0);</span>
<span class="nc" id="L108">				collBean.setVsDirPlyPwt(0.0);</span>
			}
			
<span class="nc" id="L111">			collBean.setAgentName(&quot;Total&quot;);</span>
<span class="nc" id="L112">			agtMap.put(&quot;-1111&quot;, collBean);</span>

			// for calculation of opening Balance
<span class="nc" id="L115">			AgentOpeningBalanceHelper agentOpenHelper=new AgentOpeningBalanceHelper();</span>
//			agentOpenHelper.collectionAgentWiseOpenningBal(deployDate,new Timestamp(startDate.getTime()- oneDay -1000), con,	agtMap);
<span class="nc" id="L117">			agentOpenHelper.collectionAgentWiseOpenningBal(deployDate,new Timestamp(startDate.getTime()- oneDay), con,	agtMap);</span>

			// for calculation of opening Balance
			/*agentWiseOpenningBalForLagos(deployDate, new Timestamp(startDate
					.getTime()
					- oneDay - 1000), con, agtMap);*/

			// remove terminate Agent
<span class="nc" id="L125">			OrganizationTerminateReportHelper</span>
					.getTerminateAgentListForRep(new Timestamp(startDate
							.getTime()
							- 1 * 24 * 60 * 60 * 1000), new Timestamp(startDate
							.getTime()
							+ 1 * 24 * 60 * 60 * 1000 - 1000));

<span class="nc" id="L132">			List&lt;String&gt; terminateAgentList = OrganizationTerminateReportHelper.AgentOrgIdStringTypeList;</span>
<span class="nc" id="L133">			logger.info(&quot;Terminate agent List:: &quot; + terminateAgentList);</span>
<span class="nc" id="L134">			Set&lt;String&gt; agentListSet = agtMap.keySet();</span>
<span class="nc" id="L135">			agentListSet.removeAll(terminateAgentList);</span>

			// Get The Actual Data For Report
<span class="nc" id="L138">			getActualReportForLagos(startDate, con, agtMap);</span>

<span class="nc" id="L140">		} catch (Exception e) {</span>
<span class="nc" id="L141">			e.printStackTrace();</span>
<span class="nc" id="L142">			throw new LMSException(&quot;Error in TO BE COLLECTED REPORT&quot;);</span>
		} finally {
<span class="nc" id="L144">			try {</span>
<span class="nc bnc" id="L145" title="All 4 branches missed.">				if (pstmt != null)</span>
<span class="nc" id="L146">					pstmt.close();</span>
<span class="nc" id="L147">			} catch (SQLException e) {</span>
<span class="nc" id="L148">				e.printStackTrace();</span>
<span class="nc" id="L149">			}</span>
			try {
<span class="nc bnc" id="L151" title="All 4 branches missed.">				if (rsRetOrg != null)</span>
<span class="nc" id="L152">					rsRetOrg.close();</span>
<span class="nc" id="L153">			} catch (SQLException e) {</span>
<span class="nc" id="L154">				e.printStackTrace();</span>
<span class="nc" id="L155">			}</span>
			try {
<span class="nc bnc" id="L157" title="All 4 branches missed.">				if (con != null)</span>
<span class="nc" id="L158">					con.close();</span>
<span class="nc" id="L159">			} catch (SQLException e) {</span>
<span class="nc" id="L160">				e.printStackTrace();</span>
<span class="nc" id="L161">			}</span>
<span class="nc" id="L162">		}</span>
<span class="nc" id="L163">		return agtMap;</span>
	}

	public void agentWiseOpenningBalForLagos(Timestamp startDate,
			Timestamp endDate, Connection con,
			Map&lt;Integer, CollectionReportOverAllBean&gt; agtMap)
			throws LMSException {

<span class="nc" id="L171">		ResultSet rs = null;</span>
<span class="nc" id="L172">		PreparedStatement pstmt = null;</span>
		try {
			// Get Account Details
<span class="nc" id="L175">			CallableStatement cstmt = con</span>
					.prepareCall(&quot;call collectionCashChqOverAll(?,?)&quot;);
<span class="nc" id="L177">			cstmt.setTimestamp(1, startDate);</span>
<span class="nc" id="L178">			cstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L179">			rs = cstmt.executeQuery();</span>

<span class="nc bnc" id="L181" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L182">				int agtOrgId = rs.getInt(&quot;organization_id&quot;);</span>
<span class="nc" id="L183">				agtMap.get(agtOrgId).setCash(rs.getDouble(&quot;cash&quot;));</span>
<span class="nc" id="L184">				agtMap.get(agtOrgId).setCheque(rs.getDouble(&quot;chq&quot;));</span>
<span class="nc" id="L185">				agtMap.get(agtOrgId).setChequeReturn(rs.getDouble(&quot;chq_ret&quot;));</span>
<span class="nc" id="L186">				agtMap.get(agtOrgId).setCredit(rs.getDouble(&quot;credit&quot;));</span>
<span class="nc" id="L187">				agtMap.get(agtOrgId).setDebit(rs.getDouble(&quot;debit&quot;));</span>
<span class="nc" id="L188">				agtMap.get(agtOrgId).setBankDep(rs.getDouble(&quot;bank&quot;));</span>
<span class="nc" id="L189">			}</span>

<span class="nc bnc" id="L191" title="All 2 branches missed.">			if (ReportUtility.isDG) {</span>
				// Game Master Query
<span class="nc" id="L193">				String gameQry = &quot;select game_id from st_dg_game_master&quot;;</span>
<span class="nc" id="L194">				PreparedStatement gamePstmt = con.prepareStatement(gameQry);</span>
<span class="nc" id="L195">				ResultSet rsGame = gamePstmt.executeQuery();</span>

<span class="nc bnc" id="L197" title="All 2 branches missed.">				while (rsGame.next()) {</span>
<span class="nc" id="L198">					int gameNo = rsGame.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L199">					cstmt = con</span>
							.prepareCall(&quot;call drawCollectionAgentWisePerGame(?,?,?)&quot;);
<span class="nc" id="L201">					cstmt.setTimestamp(1, startDate);</span>
<span class="nc" id="L202">					cstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L203">					cstmt.setInt(3, gameNo);</span>
<span class="nc" id="L204">					rs = cstmt.executeQuery();</span>
					int agtOrgId;
<span class="nc" id="L206">					double sale = 0, cancel = 0, pwt = 0;</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L208">						agtOrgId = rs.getInt(&quot;parent_id&quot;);</span>
<span class="nc" id="L209">						sale = rs.getDouble(&quot;sale&quot;);</span>
<span class="nc" id="L210">						cancel = rs.getDouble(&quot;cancel&quot;);</span>
<span class="nc" id="L211">						pwt = rs.getDouble(&quot;pwt&quot;);</span>
<span class="nc" id="L212">						agtMap.get(agtOrgId).setDgSale(</span>
								agtMap.get(agtOrgId).getDgSale() + sale);
<span class="nc" id="L214">						agtMap.get(agtOrgId).setDgCancel(</span>
								agtMap.get(agtOrgId).getDgCancel() + cancel);
<span class="nc" id="L216">						agtMap.get(agtOrgId).setDgPwt(</span>
								agtMap.get(agtOrgId).getDgPwt() + pwt);
<span class="nc" id="L218">						agtMap.get(agtOrgId).setDgDirPlyPwt(</span>
								agtMap.get(agtOrgId).getDgDirPlyPwt()
										+ rs.getDouble(&quot;pwtDir&quot;));
					}
<span class="nc" id="L222">				}</span>
			}
<span class="nc bnc" id="L224" title="All 2 branches missed.">			if (ReportUtility.isSE) {</span>
				// Game Master Query
<span class="nc" id="L226">				String gameQry = &quot;select game_id from st_se_game_master&quot;;</span>
<span class="nc" id="L227">				PreparedStatement gamePstmt = con.prepareStatement(gameQry);</span>
<span class="nc" id="L228">				ResultSet rsGame = gamePstmt.executeQuery();</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">				while (rsGame.next()) {</span>
<span class="nc" id="L230">					int gameNo = rsGame.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L231">					cstmt = con</span>
							.prepareCall(&quot;call scratchCollectionAgentWisePerGame(?,?,?)&quot;);
<span class="nc" id="L233">					cstmt.setTimestamp(1, startDate);</span>
<span class="nc" id="L234">					cstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L235">					cstmt.setInt(3, gameNo);</span>
<span class="nc" id="L236">					rs = cstmt.executeQuery();</span>
					int agtOrgId;
<span class="nc" id="L238">					double sale = 0, cancel = 0, pwt = 0;</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L240">						agtOrgId = rs.getInt(&quot;organization_id&quot;);</span>
<span class="nc" id="L241">						sale = rs.getDouble(&quot;sale&quot;);</span>
<span class="nc" id="L242">						cancel = rs.getDouble(&quot;cancel&quot;);</span>
<span class="nc" id="L243">						pwt = rs.getDouble(&quot;pwt&quot;);</span>
<span class="nc" id="L244">						agtMap.get(agtOrgId).setSeSale(</span>
								agtMap.get(agtOrgId).getSeSale()
										+ (sale - cancel));
<span class="nc" id="L247">						agtMap.get(agtOrgId).setSePwt(</span>
								agtMap.get(agtOrgId).getSePwt() + pwt);
<span class="nc" id="L249">						agtMap.get(agtOrgId).setSeDirPlyPwt(</span>
								agtMap.get(agtOrgId).getSeDirPlyPwt()
										+ rs.getDouble(&quot;pwtDir&quot;));
					}
<span class="nc" id="L253">				}</span>
			}
<span class="nc bnc" id="L255" title="All 2 branches missed.">			if (ReportUtility.isCS) {</span>
				// Category Master Query
<span class="nc" id="L257">				String catQry = &quot;select category_id from st_cs_product_category_master where status = 'ACTIVE'&quot;;</span>
<span class="nc" id="L258">				PreparedStatement gamePstmt = con.prepareStatement(catQry);</span>
<span class="nc" id="L259">				ResultSet rsProduct = gamePstmt.executeQuery();</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">				while (rsProduct.next()) {</span>
<span class="nc" id="L261">					int catId = rsProduct.getInt(&quot;category_id&quot;);</span>
<span class="nc" id="L262">					cstmt = con</span>
							.prepareCall(&quot;call csCollectionAgentWisePerCategory(?,?,?)&quot;);
<span class="nc" id="L264">					cstmt.setTimestamp(1, startDate);</span>
<span class="nc" id="L265">					cstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L266">					cstmt.setInt(3, catId);</span>
<span class="nc" id="L267">					logger.debug(&quot;-------CS Sale Query------\n&quot; + cstmt);</span>
<span class="nc" id="L268">					rs = cstmt.executeQuery();</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L270">						agtMap.get(rs.getInt(&quot;parent_id&quot;)).setCSSale(</span>
								agtMap.get(rs.getInt(&quot;parent_id&quot;)).getCSSale()
										+ rs.getDouble(&quot;sale&quot;));
<span class="nc" id="L273">						agtMap.get(rs.getInt(&quot;parent_id&quot;)).setCSCancel(</span>
								agtMap.get(rs.getInt(&quot;parent_id&quot;))
										.getCSCancel()
										+ rs.getDouble(&quot;cancel&quot;));
					}
<span class="nc" id="L278">				}</span>
			}
<span class="nc bnc" id="L280" title="All 2 branches missed.">			if (ReportUtility.isOLA) {</span>

<span class="nc" id="L282">				StringBuilder olaQuery = new StringBuilder(</span>
						&quot;select WID.agtOrgId, wdraw,wdrawRef,depoAmt,depoRefAmt,netAmt from (select om.parent_id agtOrgId, ifnull(sum(wd), 0.0) wdraw from (select wrs.retailer_org_id, agent_net_amt as wd from st_ola_ret_withdrawl wrs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type = 'OLA_WITHDRAWL' and transaction_date&gt;='&quot;
								+ startDate
								+ &quot;' and transaction_date&lt;='&quot;
								+ endDate
								+ &quot;')) wdret right outer join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on om.organization_id = wdret.retailer_org_id group by om.parent_id)WID, (select om.parent_id agtOrgId, ifnull(sum(wdRef), 0.0) wdrawRef from (select wrs.retailer_org_id, agent_net_amt as wdRef from st_ola_ret_withdrawl_refund wrs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type = 'OLA_WITHDRAWL_REFUND' and transaction_date&gt;='&quot;
								+ startDate
								+ &quot;' and transaction_date&lt;='&quot;
								+ endDate
								+ &quot;')) wdret right outer join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on om.organization_id = wdret.retailer_org_id group by om.parent_id)WIDREF,(select om.parent_id agtOrgId, ifnull(sum(depo), 0.0) depoAmt from (select wrs.retailer_org_id, agent_net_amt as depo from st_ola_ret_deposit wrs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type = 'OLA_DEPOSIT' and transaction_date&gt;='&quot;
								+ startDate
								+ &quot;' and transaction_date&lt;='&quot;
								+ endDate
								+ &quot;')) wdret right outer join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on om.organization_id = wdret.retailer_org_id group by om.parent_id)DEP,(select om.parent_id agtOrgId, ifnull(sum(depoRef), 0.0) depoRefAmt from (select wrs.retailer_org_id, agent_net_amt as depoRef from st_ola_ret_deposit_refund wrs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type = 'OLA_DEPOSIT_REFUND' and transaction_date&gt;='&quot;
								+ startDate
								+ &quot;' and transaction_date&lt;='&quot;
								+ endDate
								+ &quot;')) wdret right outer join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on om.organization_id = wdret.retailer_org_id group by om.parent_id)DEPREF,(select om.parent_id agtOrgId, ifnull(sum(netGamingAmt), 0.0) netAmt from(select wrs.retailer_org_id, agt_net_claim_comm as netGamingAmt from st_ola_ret_comm wrs inner join st_lms_retailer_transaction_master rt on wrs.transaction_id=rt.transaction_id where transaction_type = 'OLA_COMMISSION' and transaction_date&gt;='&quot;
								+ startDate
								+ &quot;' and transaction_date&lt;='&quot;
								+ endDate
								+ &quot;') wdret right outer join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on om.organization_id = wdret.retailer_org_id group by om.parent_id)NETGAME where WID.agtOrgId=WIDREF.agtOrgId and WIDREF.agtOrgId =DEP.agtOrgId and DEP.agtOrgId =DEPREF.agtOrgId and DEPREF.agtOrgId=NETGAME.agtOrgId and NETGAME.agtOrgId=WID.agtOrgId&quot;);

<span class="nc" id="L305">				StringBuilder unionQuery = null;</span>
<span class="nc" id="L306">				StringBuilder mainQuery = null;</span>

<span class="nc bnc" id="L308" title="All 2 branches missed.">				if (LMSFilterDispatcher.isRepFrmSP) {</span>
<span class="nc" id="L309">					mainQuery = new StringBuilder(</span>
							&quot;select agtOrgId,sum(wdraw) wdraw,sum(wdrawRef) wdrawRef,sum(depoAmt) depoAmt,sum(depoRefAmt)depoRefAmt,sum(netAmt) netAmt from (&quot;);
<span class="nc" id="L311">					unionQuery = new StringBuilder(</span>
							&quot; union all select parent_id agtOrgId , sum(withdrawal_net_amt) wdraw , sum(ref_withdrawal_net_amt) wdrawRef , sum(deposit_net) depoAmt  , sum(ref_deposit_net_amt) depoRefAmt, sum(net_gaming_net_comm) netAmt from st_rep_ola_retailer where finaldate&gt;='&quot;
									+ startDate
									+ &quot;' and finaldate&lt;='&quot;
									+ endDate
									+ &quot;' group by parent_id) repTable group by agtOrgId&quot;);
<span class="nc" id="L317">					mainQuery.append(olaQuery.toString()).append(</span>
							unionQuery.toString());
<span class="nc" id="L319">					pstmt = con.prepareStatement(mainQuery.toString());</span>
				} else {
<span class="nc" id="L321">					pstmt = con.prepareStatement(olaQuery.toString());</span>
				}
<span class="nc" id="L323">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L325">					agtMap.get(rs.getInt(&quot;agtOrgId&quot;)).setWithdrawal(</span>
							rs.getDouble(&quot;wdraw&quot;));
<span class="nc" id="L327">					agtMap.get(rs.getInt(&quot;agtOrgId&quot;)).setWithdrawalRefund(</span>
							rs.getDouble(&quot;wdrawRef&quot;));
<span class="nc" id="L329">					agtMap.get(rs.getInt(&quot;agtOrgId&quot;)).setDeposit(</span>
							rs.getDouble(&quot;depoAmt&quot;));
<span class="nc" id="L331">					agtMap.get(rs.getInt(&quot;agtOrgId&quot;)).setDepositRefund(</span>
							rs.getDouble(&quot;depoRefAmt&quot;));
<span class="nc" id="L333">					agtMap.get(rs.getInt(&quot;agtOrgId&quot;)).setNetGamingComm(</span>
							rs.getDouble(&quot;netAmt&quot;));
				}
			}
<span class="nc" id="L337">			Iterator&lt;Map.Entry&lt;Integer, CollectionReportOverAllBean&gt;&gt; itr = agtMap</span>
					.entrySet().iterator();
<span class="nc bnc" id="L339" title="All 2 branches missed.">			while (itr.hasNext()) {</span>
<span class="nc" id="L340">				Map.Entry&lt;Integer, CollectionReportOverAllBean&gt; pair = itr</span>
						.next();
<span class="nc" id="L342">				CollectionReportOverAllBean bean = pair.getValue();</span>
<span class="nc" id="L343">				double openingBal = bean.getDgSale()</span>
						- bean.getDgCancel()
						- bean.getDgPwt()
						- bean.getDgDirPlyPwt()
						+ bean.getSeSale()
						- bean.getSePwt()
						- bean.getSeDirPlyPwt()
						+ bean.getCSSale()
						- bean.getCSCancel()
						+ bean.getDeposit()
						- bean.getDepositRefund()
						- bean.getWithdrawal()
						- bean.getNetGamingComm()
						- (bean.getCash() + bean.getCheque() + bean.getCredit()
								+ bean.getBankDep() - bean.getDebit() - bean
								.getChequeReturn());

<span class="nc" id="L360">				bean.setOpeningBal(0.0);</span>
<span class="nc" id="L361">				bean.setCash(0.0);</span>
<span class="nc" id="L362">				bean.setCheque(0.0);</span>
<span class="nc" id="L363">				bean.setChequeReturn(0.0);</span>
<span class="nc" id="L364">				bean.setCredit(0.0);</span>
<span class="nc" id="L365">				bean.setDebit(0.0);</span>
<span class="nc" id="L366">				bean.setBankDep(0.0);</span>
<span class="nc bnc" id="L367" title="All 2 branches missed.">				if (ReportUtility.isDG) {</span>
<span class="nc" id="L368">					bean.setDgSale(0.0);</span>
<span class="nc" id="L369">					bean.setDgPwt(0.0);</span>
<span class="nc" id="L370">					bean.setDgCancel(0.0);</span>
<span class="nc" id="L371">					bean.setDgDirPlyPwt(0.0);</span>
				}
<span class="nc bnc" id="L373" title="All 2 branches missed.">				if (ReportUtility.isSE) {</span>
<span class="nc" id="L374">					bean.setSeSale(0.0);</span>
<span class="nc" id="L375">					bean.setSePwt(0.0);</span>
<span class="nc" id="L376">					bean.setSeDirPlyPwt(0.0);</span>
				}
<span class="nc bnc" id="L378" title="All 2 branches missed.">				if (ReportUtility.isCS) {</span>
<span class="nc" id="L379">					bean.setCSSale(0.0);</span>
<span class="nc" id="L380">					bean.setCSCancel(0.0);</span>
				}
<span class="nc bnc" id="L382" title="All 2 branches missed.">				if (ReportUtility.isOLA) {</span>
<span class="nc" id="L383">					bean.setDeposit(0.0);</span>
<span class="nc" id="L384">					bean.setDepositRefund(0.0);</span>
<span class="nc" id="L385">					bean.setWithdrawal(0.0);</span>
<span class="nc" id="L386">					bean.setWithdrawalRefund(0.0);</span>
<span class="nc" id="L387">					bean.setNetGamingComm(0.0);</span>
				}

<span class="nc" id="L390">				bean.setOpeningBal(openingBal);</span>
<span class="nc" id="L391">			}</span>
<span class="nc" id="L392">		} catch (Exception e) {</span>
<span class="nc" id="L393">			e.printStackTrace();</span>
<span class="nc" id="L394">			throw new LMSException(</span>
					&quot;agentWiseOpenningBalForLagos in To Be Collected&quot;);
<span class="nc" id="L396">		}</span>
<span class="nc" id="L397">	}</span>

	public void getActualReportForLagos(Timestamp stDate, Connection con,
			Map&lt;String, CollectionReportOverAllBean&gt; agtMap)
			throws LMSException {

<span class="nc" id="L403">		String toBeQuery = null;</span>

<span class="nc" id="L405">		double totalOpeningBal = 0.0;</span>
<span class="nc" id="L406">		double totalSale = 0.0;</span>
<span class="nc" id="L407">		double totalDebit = 0.0;</span>
<span class="nc" id="L408">		double totalCredit = 0.0;</span>
<span class="nc" id="L409">		double totalPwt = 0.0;</span>
<span class="nc" id="L410">		double totalCash = 0.0;</span>
<span class="nc" id="L411">		double totalBank = 0.0;</span>

<span class="nc" id="L413">		ResultSet rs = null;</span>
<span class="nc" id="L414">		ResultSet rsGame = null;</span>
<span class="nc" id="L415">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L416">		Statement stmt=null;</span>
<span class="nc" id="L417">		PreparedStatement gamePstmt = null;</span>

<span class="nc" id="L419">		CompleteCollectionBean gameBean = null;</span>
<span class="nc" id="L420">		CollectionReportOverAllBean agentBean = null;</span>

<span class="nc" id="L422">		Timestamp startDate = new Timestamp(stDate.getTime() - oneDay);</span>
<span class="nc" id="L423">		Timestamp endDate = new Timestamp(startDate.getTime() + oneDay - 1000);</span>

		try {
			// Query To Add/Subtract The Variables From The Opening Balance

<span class="nc" id="L428">			toBeQuery = &quot;select  organization_id ,sum(cash) cashForOpnin from (select agent_org_id organization_id,sum(amount) cash from st_lms_bo_cash_transaction cash,st_lms_bo_transaction_master btm where cash.transaction_id=btm.transaction_id and transaction_date&gt;='&quot;</span>
					+ startDate
					+ &quot;'  and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;'  group by agent_org_id union all select agent_org_id organization_id,sum(cheque_amt) cash from st_lms_bo_sale_chq chq,st_lms_bo_transaction_master btm where chq.transaction_id=btm.transaction_id and chq.transaction_type IN ('CHEQUE','CLOSED') and transaction_date&gt;='&quot;
					+ startDate
					+ &quot;'  and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;'  group by agent_org_id union all select agent_org_id organization_id,-(sum(cheque_amt)) cash from st_lms_bo_sale_chq chq,st_lms_bo_transaction_master btm where chq.transaction_id=btm.transaction_id and chq.transaction_type IN ('CHQ_BOUNCE') and transaction_date&gt;='&quot;
					+ startDate
					+ &quot;'  and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;'  group by agent_org_id union all select agent_org_id organization_id,sum(amount) cash from st_lms_bo_bank_deposit_transaction bank,st_lms_bo_transaction_master btm where bank.transaction_id=btm.transaction_id and transaction_date&gt;='&quot;
					+ startDate
					+ &quot;'  and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;'  group by agent_org_id union all select organization_id,-(ifnull(amount,0.0)) cash from (select agent_org_id ,sum(amount) amount  from st_lms_bo_transaction_master a inner join st_lms_bo_debit_note a1 on a.transaction_id=a1.transaction_id and a.transaction_date&gt;='&quot;
					+ startDate
					+ &quot;'  and a.transaction_date&lt;='&quot;
					+ endDate
					+ &quot;'   and a.transaction_type in ('DR_NOTE_CASH','DR_NOTE') and reason in ('DR_WRONG_RECEIPT_ON_CASH','DR_WRONG_RECEIPT_ON_BD') group by agent_org_id) debit   right outer join (select organization_id from st_lms_organization_master where organization_type='AGENT') om on agent_org_id=organization_id ) pymntsTbl group by organization_id &quot;;

<span class="nc" id="L450">			stmt=con.createStatement();</span>
<span class="nc" id="L451">			logger.info(&quot;QUERY FOR OPENING BAL VAR****-&gt; &quot; + toBeQuery);</span>
<span class="nc" id="L452">			rs=stmt.executeQuery(toBeQuery);</span>
			
			/*pstmt = con.prepareStatement(toBeQuery);
			logger.info(&quot;QUERY FOR OPENING BAL VAR****-&gt; &quot; + pstmt);
			rs = pstmt.executeQuery();*/
<span class="nc bnc" id="L457" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L458">				String agtOrgId = rs.getString(&quot;organization_id&quot;);</span>
<span class="nc" id="L459">				agentBean = agtMap.get(agtOrgId);</span>
<span class="nc bnc" id="L460" title="All 2 branches missed.">				if (agentBean != null) {</span>
<span class="nc" id="L461">					agtMap.get(agtOrgId).setOpeningBal(</span>
							agtMap.get(agtOrgId).getOpeningBal()
									- rs.getDouble(&quot;cashForOpnin&quot;));
				}
<span class="nc" id="L465">			}</span>

			
			/*toBeQuery = &quot;select agent_org_id parent_id ,sum(training_exp_amt) teAmtd from st_lms_agent_weekly_training_exp ex,(select generated_id from st_lms_bo_receipts a,(select receipt_id from st_lms_bo_receipts_trn_mapping map ,(select  transaction_id from st_lms_bo_transaction_master a where a.transaction_date&gt;='&quot;
					+ startDate
					+ &quot;' and a.transaction_date&lt;='&quot;
					+ endDate
					+ &quot;'  and transaction_type='CR_NOTE_CASH') a where a.transaction_id=map.transaction_id) rec where a.receipt_id=rec.receipt_id) gen where ex.credit_note_number=gen.generated_id group by agent_org_id&quot;;*/
			
			// Weekly Training EXP For Opening Balance
<span class="nc" id="L475">			toBeQuery = &quot;select parent_id ,sum(teAmtd) teAmtd  from	(select agent_org_id parent_id ,sum(amount) teAmtd from st_lms_bo_credit_note cn inner join st_lms_bo_transaction_master btm on cn.transaction_id = btm.transaction_id and transaction_date&gt;='&quot;</span>
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' and reason  = 'CR_WEEKLY_EXP' group by agent_org_id union all select agent_org_id parent_id ,-sum(amount) teAmtd from st_lms_bo_debit_note cn inner join st_lms_bo_transaction_master btm on cn.transaction_id = btm.transaction_id and transaction_date&gt;='&quot;
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' and reason  = 'DR_WEEKLY_TE_RETURN' group by agent_org_id) a group by parent_id&quot;;

			
			
<span class="nc" id="L487">			pstmt = con.prepareStatement(toBeQuery);</span>
<span class="nc" id="L488">			logger.info(&quot;Game Wise Data Without Daily Training EXP.****-&gt; &quot;</span>
					+ pstmt);
<span class="nc" id="L490">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L491" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L492">				String agtOrgId = rs.getString(&quot;parent_id&quot;);</span>
<span class="nc" id="L493">				agentBean = agtMap.get(agtOrgId);</span>
<span class="nc bnc" id="L494" title="All 2 branches missed.">				if (agentBean != null) {</span>
<span class="nc" id="L495">					agtMap.get(agtOrgId).setOpeningBal(</span>
							agtMap.get(agtOrgId).getOpeningBal()
									- rs.getDouble(&quot;teAmtd&quot;));
				}
<span class="nc" id="L499">			}</span>
			
			
<span class="nc bnc" id="L502" title="All 2 branches missed.">			if (ReportUtility.isDG) {</span>
				// Get Game Wise Sale Data With Excluding The Daily Training EXP
<span class="nc" id="L504">				String gameQry = ReportUtility.getDrawGameMapQuery(startDate);</span>
<span class="nc" id="L505">				gamePstmt = con.prepareStatement(gameQry);</span>
<span class="nc" id="L506">				rsGame = gamePstmt.executeQuery();</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">				while (rsGame.next()) {</span>
<span class="nc" id="L508">					totalSale = 0.0;</span>
<span class="nc" id="L509">					int gameNo = rsGame.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L510">					String gameName = rsGame.getString(&quot;game_name&quot;);</span>
<span class="nc" id="L511">					toBeQuery = &quot;select parent_id,(sum(sale)-sum(cancel)-sum(teAmt)) sale, (sum(pwt)+sum(pwtDir)) pwt  from (select  0.0  teAmt,parent_id,sale,cancel,pwt,ifnull(pwtDir,0.0) pwtDir from (select sale.parent_id,sum(sale) sale,sum(cancel) cancel,sum(pwt) pwt from (select organization_id,parent_id,ifnull(sale,0.0) sale from st_lms_organization_master om left outer join (select drs.retailer_org_id,sum(agent_net_amt) as sale from st_dg_ret_sale_&quot;</span>
							+ gameNo
							+ &quot; drs inner join st_lms_retailer_transaction_master rtm on drs.transaction_id=rtm.transaction_id where rtm.transaction_type in('DG_SALE','DG_SALE_OFFLINE') and rtm.transaction_date&gt;='&quot;
							+ startDate
							+ &quot;' and rtm.transaction_date&lt;='&quot;
							+ endDate
							+ &quot;' group by drs.retailer_org_id) sale on om.organization_id=retailer_org_id where om.organization_type='RETAILER') sale inner join (select organization_id,parent_id,ifnull(cancel,0.0) cancel from st_lms_organization_master om left outer join (select drs.retailer_org_id,sum(agent_net_amt) as cancel from st_dg_ret_sale_refund_&quot;
							+ gameNo
							+ &quot;  drs inner join st_lms_retailer_transaction_master rtm on drs.transaction_id=rtm.transaction_id where transaction_type in('DG_REFUND_CANCEL','DG_REFUND_FAILED') and transaction_date&gt;='&quot;
							+ startDate
							+ &quot;' and transaction_date&lt;='&quot;
							+ endDate
							+ &quot;' group by drs.retailer_org_id) cancel on om.organization_id=retailer_org_id where om.organization_type='RETAILER') cancel inner join (select organization_id,parent_id,ifnull(pwt,0.0) pwt from st_lms_organization_master om left outer join (select drs.retailer_org_id,sum(pwt_amt+agt_claim_comm) as pwt from st_dg_ret_pwt_&quot;
							+ gameNo
							+ &quot;  drs inner join st_lms_retailer_transaction_master rtm on drs.transaction_id=rtm.transaction_id where transaction_type in('DG_PWT_AUTO','DG_PWT_PLR','DG_PWT') and transaction_date&gt;='&quot;
							+ startDate
							+ &quot;' and transaction_date&lt;='&quot;
							+ endDate
							+ &quot;' group by drs.retailer_org_id) pwt on om.organization_id=retailer_org_id where om.organization_type='RETAILER') pwt on  sale.organization_id=cancel.organization_id and sale.organization_id=pwt.organization_id and pwt.organization_id=cancel.organization_id group by parent_id) aa left outer join (select organization_id,sum(pwt_amt+agt_claim_comm) pwtDir from st_lms_organization_master left outer join st_dg_agt_direct_plr_pwt on organization_id=agent_org_id where transaction_date&gt;='&quot;
							+ startDate
							+ &quot;' and transaction_date&lt;='&quot;
							+ endDate
							+ &quot;' and organization_type='AGENT' and game_id=&quot;
							+ gameNo
							+ &quot;  group by agent_org_id) bb on parent_id=organization_id union all select a1.amount teAmtd,d.agent_org_id parent_id,0.0 sale,0.0 cancel,0.0 pwt,0.0 pwdDir from st_lms_bo_transaction_master a inner join st_lms_bo_credit_note a1 inner join st_lms_bo_receipts_trn_mapping b inner join st_lms_bo_receipts c inner join st_lms_agent_daily_training_exp d   on a.transaction_id=a1.transaction_id and a1.transaction_id=b.transaction_id and b.receipt_id=c.receipt_id and c.generated_id=d.credit_note_number and a.transaction_date&gt;='&quot;
							+ startDate
							+ &quot;' and a.transaction_date&lt;='&quot;
							+ endDate
							+ &quot;' and d.game_id=&quot;
							+ gameNo
							+ &quot; and reason in ('CR_DAILY_EXP') group by d.agent_org_id union all select -a1.amount teAmtd,d.agent_org_id parent_id,0.0 sale,0.0 cancel,0.0 pwt,0.0 pwdDir from st_lms_bo_transaction_master a inner join st_lms_bo_debit_note a1 inner join st_lms_bo_receipts_trn_mapping b inner join st_lms_bo_receipts c inner join st_lms_agent_daily_training_exp d   on a.transaction_id=a1.transaction_id and a1.transaction_id=b.transaction_id and b.receipt_id=c.receipt_id and c.generated_id=d.credit_note_number and a.transaction_date&gt;='&quot;
							+ startDate
							+ &quot;' and a.transaction_date&lt;='&quot;
							+ endDate
							+ &quot;' and d.game_id=&quot;
							+ gameNo
							+ &quot; and reason in ('DR_DAILY_TE_RETURN') group by d.agent_org_id) mainTbl group by parent_id&quot;;
					/*pstmt = con.prepareStatement(toBeQuery);
					logger
							.info(&quot;Game Wise Data Without Daily Training EXP.****-&gt; &quot;
									+ pstmt);
					rs = pstmt.executeQuery();*/
<span class="nc" id="L553">					stmt=con.createStatement();</span>
<span class="nc" id="L554">					logger</span>
					.info(&quot;Game Wise Data Without Daily Training EXP.****-&gt; &quot;
							+ toBeQuery);
<span class="nc" id="L557">					rs=stmt.executeQuery(toBeQuery);</span>
<span class="nc bnc" id="L558" title="All 2 branches missed.">					while (rs.next()) {</span>

<span class="nc" id="L560">						String agtOrgId = rs.getString(&quot;parent_id&quot;);</span>
<span class="nc" id="L561">						agentBean = agtMap.get(agtOrgId);</span>
<span class="nc bnc" id="L562" title="All 2 branches missed.">						if (agentBean != null) {</span>
<span class="nc" id="L563">							agtMap.get(agtOrgId).setOpeningBal(</span>
									agtMap.get(agtOrgId).getOpeningBal()
											- rs.getDouble(&quot;pwt&quot;));
<span class="nc bnc" id="L566" title="All 2 branches missed.">							if (rsGame.isLast()) {</span>
<span class="nc" id="L567">								totalOpeningBal = totalOpeningBal</span>
										+ agtMap.get(agtOrgId).getOpeningBal();
							}
<span class="nc" id="L570">							Map&lt;String, CompleteCollectionBean&gt; gameMap = agentBean</span>
									.getGameBeanMap();
<span class="nc bnc" id="L572" title="All 2 branches missed.">							if (gameMap == null) {</span>
<span class="nc" id="L573">								gameMap = new HashMap&lt;String, CompleteCollectionBean&gt;();</span>
<span class="nc" id="L574">								agentBean.setGameBeanMap(gameMap);</span>
							}
<span class="nc" id="L576">							gameBean = gameMap.get(gameName);</span>
<span class="nc bnc" id="L577" title="All 2 branches missed.">							if (gameBean == null) {</span>
<span class="nc" id="L578">								gameBean = new CompleteCollectionBean();</span>
<span class="nc" id="L579">								gameMap.put(gameName, gameBean);</span>
							}
<span class="nc" id="L581">							gameBean.setOrgName(gameName);</span>
<span class="nc" id="L582">							gameBean.setDrawSale(rs.getDouble(&quot;sale&quot;));</span>
<span class="nc" id="L583">							totalSale = totalSale + rs.getDouble(&quot;sale&quot;);</span>
						}
<span class="nc" id="L585">					}</span>

<span class="nc" id="L587">					agentBean = agtMap.get(&quot;-1111&quot;);</span>
<span class="nc bnc" id="L588" title="All 2 branches missed.">					if (agentBean != null) {</span>
<span class="nc" id="L589">						Map&lt;String, CompleteCollectionBean&gt; gameMap = agentBean</span>
								.getGameBeanMap();
<span class="nc bnc" id="L591" title="All 2 branches missed.">						if (gameMap == null) {</span>
<span class="nc" id="L592">							gameMap = new HashMap&lt;String, CompleteCollectionBean&gt;();</span>
<span class="nc" id="L593">							agentBean.setGameBeanMap(gameMap);</span>
						}
<span class="nc" id="L595">						gameBean = gameMap.get(gameName);</span>
<span class="nc bnc" id="L596" title="All 2 branches missed.">						if (gameBean == null) {</span>
<span class="nc" id="L597">							gameBean = new CompleteCollectionBean();</span>
<span class="nc" id="L598">							gameMap.put(gameName, gameBean);</span>
						}
<span class="nc" id="L600">						gameBean.setOrgName(gameName);</span>
<span class="nc" id="L601">						gameBean.setDrawSale(totalSale);</span>
					}
<span class="nc" id="L603">				}</span>
<span class="nc" id="L604">				agtMap.get(&quot;-1111&quot;).setOpeningBal(totalOpeningBal);</span>
			}
			
<span class="nc bnc" id="L607" title="All 2 branches missed.">			if (ReportUtility.isIW) {</span>
				// Get Game Wise Sale Data With Excluding The Daily Training EXP
<span class="nc" id="L609">				String gameQry = ReportUtility.getIWGameMapQuery(startDate);</span>
<span class="nc" id="L610">				gamePstmt = con.prepareStatement(gameQry);</span>
<span class="nc" id="L611">				rsGame = gamePstmt.executeQuery();</span>
<span class="nc bnc" id="L612" title="All 2 branches missed.">				while (rsGame.next()) {</span>
<span class="nc" id="L613">					totalSale = 0.0;</span>
<span class="nc" id="L614">					int gameNo = rsGame.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L615">					String gameName = rsGame.getString(&quot;game_name&quot;);</span>
<span class="nc" id="L616">					toBeQuery = &quot;select parent_id,(sum(sale)-sum(cancel)-sum(teAmt)) sale, (sum(pwt)+sum(pwtDir)) pwt from (select 0.0 teAmt,parent_id,sale,cancel,pwt,ifnull(pwtDir,0.0) pwtDir from (select sale.parent_id,sum(sale) sale,sum(cancel) cancel,sum(pwt) pwt from (select organization_id,parent_id,ifnull(sale,0.0) sale from st_lms_organization_master om left outer join (select irs.retailer_org_id, sum(agent_net_amt) as sale from st_iw_ret_sale irs inner join st_lms_retailer_transaction_master rtm on irs.transaction_id=rtm.transaction_id where irs.game_id = &quot;</span>
							+ gameNo
							+ &quot; and is_cancel = 'N' and rtm.transaction_type in('IW_SALE') and rtm.transaction_date&gt;='&quot;
							+ startDate
							+ &quot;' and rtm.transaction_date&lt;='&quot;
							+ endDate
							+ &quot;' group by irs.retailer_org_id) sale on om.organization_id=retailer_org_id where om.organization_type='RETAILER') sale inner join (select organization_id,parent_id,ifnull(cancel,0.0) cancel from st_lms_organization_master om left outer join (select irs.retailer_org_id, sum(agent_net_amt) as cancel from st_iw_ret_sale_refund irs inner join st_lms_retailer_transaction_master rtm on irs.transaction_id=rtm.transaction_id where irs.game_id = &quot;
							+ gameNo
							+ &quot; and transaction_type in('IW_REFUND_CANCEL','IW_REFUND_FAILED') and irs.transaction_date&gt;='&quot;
							+ startDate
							+ &quot;' and irs.transaction_date&lt;='&quot;
							+ endDate
							+ &quot;' group by irs.retailer_org_id) cancel on om.organization_id=retailer_org_id where om.organization_type='RETAILER') cancel inner join (select organization_id,parent_id,ifnull(pwt,0.0) pwt from st_lms_organization_master om left outer join (select irs.retailer_org_id, sum(pwt_amt+agt_claim_comm) as pwt from st_iw_ret_pwt  irs inner join st_lms_retailer_transaction_master rtm on irs.transaction_id=rtm.transaction_id where irs.game_id = &quot;
							+ gameNo
							+ &quot; and transaction_type in('IW_PWT_AUTO','IW_PWT_PLR','IW_PWT') and irs.transaction_date&gt;='&quot;
							+ startDate
							+ &quot;' and irs.transaction_date&lt;='&quot;
							+ endDate
							+ &quot;' group by irs.retailer_org_id) pwt on om.organization_id=retailer_org_id where om.organization_type='RETAILER') pwt on sale.organization_id=cancel.organization_id and sale.organization_id=pwt.organization_id and pwt.organization_id=cancel.organization_id group by parent_id) aa left outer join (select organization_id,sum(pwt_amt+agt_claim_comm) pwtDir from st_lms_organization_master left outer join st_iw_agent_direct_plr_pwt on organization_id=agent_org_id where transaction_date&gt;='&quot;
							+ startDate
							+ &quot;' and transaction_date&lt;='&quot;
							+ endDate
							+ &quot;' and organization_type='AGENT' and game_id=&quot;
							+ gameNo
							+ &quot;  group by agent_org_id) bb on parent_id=organization_id union all select a1.amount teAmtd,d.agent_org_id parent_id,0.0 sale,0.0 cancel,0.0 pwt,0.0 pwdDir from st_lms_bo_transaction_master a inner join st_lms_bo_credit_note a1 inner join st_lms_bo_receipts_trn_mapping b inner join st_lms_bo_receipts c inner join st_lms_agent_daily_training_exp d on a.transaction_id=a1.transaction_id and a1.transaction_id=b.transaction_id and b.receipt_id=c.receipt_id and c.generated_id=d.credit_note_number and a.transaction_date&gt;='&quot;
							+ startDate
							+ &quot;' and a.transaction_date&lt;='&quot;
							+ endDate
							+ &quot;' and d.game_id=&quot;
							+ gameNo
							+ &quot; and reason in ('CR_DAILY_EXP') group by d.agent_org_id union all select -a1.amount teAmtd,d.agent_org_id parent_id,0.0 sale,0.0 cancel,0.0 pwt,0.0 pwdDir from st_lms_bo_transaction_master a inner join st_lms_bo_debit_note a1 inner join st_lms_bo_receipts_trn_mapping b inner join st_lms_bo_receipts c inner join st_lms_agent_daily_training_exp d on a.transaction_id=a1.transaction_id and a1.transaction_id=b.transaction_id and b.receipt_id=c.receipt_id and c.generated_id=d.credit_note_number and a.transaction_date&gt;='&quot;
							+ startDate
							+ &quot;' and a.transaction_date&lt;='&quot;
							+ endDate
							+ &quot;' and d.game_id=&quot;
							+ gameNo
							+ &quot; and reason in ('DR_DAILY_TE_RETURN') group by d.agent_org_id) mainTbl group by parent_id&quot;;
<span class="nc" id="L653">					stmt = con.createStatement();</span>
<span class="nc" id="L654">					logger.info(&quot;IW Game Wise Data Without Daily Training EXP.****-&gt; &quot; + toBeQuery);</span>
<span class="nc" id="L655">					rs = stmt.executeQuery(toBeQuery);</span>
<span class="nc bnc" id="L656" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L657">						String agtOrgId = rs.getString(&quot;parent_id&quot;);</span>
<span class="nc" id="L658">						agentBean = agtMap.get(agtOrgId);</span>
<span class="nc bnc" id="L659" title="All 2 branches missed.">						if (agentBean != null) {</span>
<span class="nc" id="L660">							agtMap.get(agtOrgId).setOpeningBal(agtMap.get(agtOrgId).getOpeningBal() - rs.getDouble(&quot;pwt&quot;));</span>
<span class="nc bnc" id="L661" title="All 2 branches missed.">							if (rsGame.isLast()) {</span>
<span class="nc" id="L662">								totalOpeningBal = totalOpeningBal + agtMap.get(agtOrgId).getOpeningBal();</span>
							}
<span class="nc" id="L664">							Map&lt;String, CompleteCollectionBean&gt; gameMap = agentBean.getGameBeanMap();</span>
<span class="nc bnc" id="L665" title="All 2 branches missed.">							if (gameMap == null) {</span>
<span class="nc" id="L666">								gameMap = new HashMap&lt;String, CompleteCollectionBean&gt;();</span>
<span class="nc" id="L667">								agentBean.setGameBeanMap(gameMap);</span>
							}
<span class="nc" id="L669">							gameBean = gameMap.get(gameName);</span>
<span class="nc bnc" id="L670" title="All 2 branches missed.">							if (gameBean == null) {</span>
<span class="nc" id="L671">								gameBean = new CompleteCollectionBean();</span>
<span class="nc" id="L672">								gameMap.put(gameName, gameBean);</span>
							}
<span class="nc" id="L674">							gameBean.setOrgName(gameName);</span>
<span class="nc" id="L675">							gameBean.setIwSale(rs.getDouble(&quot;sale&quot;));</span>
<span class="nc" id="L676">							totalSale = totalSale + rs.getDouble(&quot;sale&quot;);</span>
						}
<span class="nc" id="L678">					}</span>

<span class="nc" id="L680">					agentBean = agtMap.get(&quot;-1111&quot;);</span>
<span class="nc bnc" id="L681" title="All 2 branches missed.">					if (agentBean != null) {</span>
<span class="nc" id="L682">						Map&lt;String, CompleteCollectionBean&gt; gameMap = agentBean.getGameBeanMap();</span>
<span class="nc bnc" id="L683" title="All 2 branches missed.">						if (gameMap == null) {</span>
<span class="nc" id="L684">							gameMap = new HashMap&lt;String, CompleteCollectionBean&gt;();</span>
<span class="nc" id="L685">							agentBean.setGameBeanMap(gameMap);</span>
						}
<span class="nc" id="L687">						gameBean = gameMap.get(gameName);</span>
<span class="nc bnc" id="L688" title="All 2 branches missed.">						if (gameBean == null) {</span>
<span class="nc" id="L689">							gameBean = new CompleteCollectionBean();</span>
<span class="nc" id="L690">							gameMap.put(gameName, gameBean);</span>
						}
<span class="nc" id="L692">						gameBean.setOrgName(gameName);</span>
<span class="nc" id="L693">						gameBean.setIwSale(totalSale);</span>
					}
<span class="nc" id="L695">				}</span>
<span class="nc" id="L696">				agtMap.get(&quot;-1111&quot;).setOpeningBal(totalOpeningBal);</span>
			}
			
<span class="nc bnc" id="L699" title="All 2 branches missed.">			if (ReportUtility.isVS) {</span>
				// Get Game Wise Sale Data With Excluding The Daily Training EXP
<span class="nc" id="L701">				String gameQry = ReportUtility.getVSGameMapQuery(startDate);</span>
<span class="nc" id="L702">				gamePstmt = con.prepareStatement(gameQry);</span>
<span class="nc" id="L703">				rsGame = gamePstmt.executeQuery();</span>
<span class="nc bnc" id="L704" title="All 2 branches missed.">				while (rsGame.next()) {</span>
<span class="nc" id="L705">					totalSale = 0.0;</span>
<span class="nc" id="L706">					int gameNo = rsGame.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L707">					String gameName = rsGame.getString(&quot;game_name&quot;);</span>
<span class="nc" id="L708">					toBeQuery = &quot;select parent_id,(sum(sale)-sum(cancel)-sum(teAmt)) sale, (sum(pwt)+sum(pwtDir)) pwt from (select 0.0 teAmt,parent_id,sale,cancel,pwt,ifnull(pwtDir,0.0) pwtDir from (select sale.parent_id,sum(sale) sale,sum(cancel) cancel,sum(pwt) pwt from (select organization_id,parent_id,ifnull(sale,0.0) sale from st_lms_organization_master om left outer join (select irs.retailer_org_id, sum(agent_net_amt) as sale from st_vs_ret_sale irs inner join st_lms_retailer_transaction_master rtm on irs.transaction_id=rtm.transaction_id where irs.game_id = &quot;</span>
							+ gameNo
							+ &quot; and is_cancel = 'N' and rtm.transaction_type in('VS_SALE') and rtm.transaction_date&gt;='&quot;
							+ startDate
							+ &quot;' and rtm.transaction_date&lt;='&quot;
							+ endDate
							+ &quot;' group by irs.retailer_org_id) sale on om.organization_id=retailer_org_id where om.organization_type='RETAILER') sale inner join (select organization_id,parent_id,ifnull(cancel,0.0) cancel from st_lms_organization_master om left outer join (select irs.retailer_org_id, sum(agent_net_amt) as cancel from st_vs_ret_sale_refund irs inner join st_lms_retailer_transaction_master rtm on irs.transaction_id=rtm.transaction_id where irs.game_id = &quot;
							+ gameNo
							+ &quot; and transaction_type in('VS_SALE_REFUND') and irs.transaction_date&gt;='&quot;
							+ startDate
							+ &quot;' and irs.transaction_date&lt;='&quot;
							+ endDate
							+ &quot;' group by irs.retailer_org_id) cancel on om.organization_id=retailer_org_id where om.organization_type='RETAILER') cancel inner join (select organization_id,parent_id,ifnull(pwt,0.0) pwt from st_lms_organization_master om left outer join (select irs.retailer_org_id, sum(pwt_amt+agt_claim_comm) as pwt from st_vs_ret_pwt  irs inner join st_lms_retailer_transaction_master rtm on irs.transaction_id=rtm.transaction_id where irs.game_id = &quot;
							+ gameNo
							+ &quot; and transaction_type in('VS_PWT_AUTO','VS_PWT_PLR','VS_PWT') and irs.transaction_date&gt;='&quot;
							+ startDate
							+ &quot;' and irs.transaction_date&lt;='&quot;
							+ endDate
							+ &quot;' group by irs.retailer_org_id) pwt on om.organization_id=retailer_org_id where om.organization_type='RETAILER') pwt on sale.organization_id=cancel.organization_id and sale.organization_id=pwt.organization_id and pwt.organization_id=cancel.organization_id group by parent_id) aa left outer join (select organization_id,sum(pwt_amt+agt_claim_comm) pwtDir from st_lms_organization_master left outer join st_vs_agent_direct_plr_pwt on organization_id=agent_org_id where transaction_date&gt;='&quot;
							+ startDate
							+ &quot;' and transaction_date&lt;='&quot;
							+ endDate
							+ &quot;' and organization_type='AGENT' and game_id=&quot;
							+ gameNo
							+ &quot;  group by agent_org_id) bb on parent_id=organization_id union all select a1.amount teAmtd,d.agent_org_id parent_id,0.0 sale,0.0 cancel,0.0 pwt,0.0 pwdDir from st_lms_bo_transaction_master a inner join st_lms_bo_credit_note a1 inner join st_lms_bo_receipts_trn_mapping b inner join st_lms_bo_receipts c inner join st_lms_agent_daily_training_exp d on a.transaction_id=a1.transaction_id and a1.transaction_id=b.transaction_id and b.receipt_id=c.receipt_id and c.generated_id=d.credit_note_number and a.transaction_date&gt;='&quot;
							+ startDate
							+ &quot;' and a.transaction_date&lt;='&quot;
							+ endDate
							+ &quot;' and d.game_id=&quot;
							+ gameNo
							+ &quot; and reason in ('CR_DAILY_EXP') group by d.agent_org_id union all select -a1.amount teAmtd,d.agent_org_id parent_id,0.0 sale,0.0 cancel,0.0 pwt,0.0 pwdDir from st_lms_bo_transaction_master a inner join st_lms_bo_debit_note a1 inner join st_lms_bo_receipts_trn_mapping b inner join st_lms_bo_receipts c inner join st_lms_agent_daily_training_exp d on a.transaction_id=a1.transaction_id and a1.transaction_id=b.transaction_id and b.receipt_id=c.receipt_id and c.generated_id=d.credit_note_number and a.transaction_date&gt;='&quot;
							+ startDate
							+ &quot;' and a.transaction_date&lt;='&quot;
							+ endDate
							+ &quot;' and d.game_id=&quot;
							+ gameNo
							+ &quot; and reason in ('DR_DAILY_TE_RETURN') group by d.agent_org_id) mainTbl group by parent_id&quot;;
<span class="nc" id="L745">					stmt = con.createStatement();</span>
<span class="nc" id="L746">					logger.info(&quot;VS Game Wise Data Without Daily Training EXP.****-&gt; &quot; + toBeQuery);</span>
<span class="nc" id="L747">					rs = stmt.executeQuery(toBeQuery);</span>
<span class="nc bnc" id="L748" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L749">						String agtOrgId = rs.getString(&quot;parent_id&quot;);</span>
<span class="nc" id="L750">						agentBean = agtMap.get(agtOrgId);</span>
<span class="nc bnc" id="L751" title="All 2 branches missed.">						if (agentBean != null) {</span>
<span class="nc" id="L752">							agtMap.get(agtOrgId).setOpeningBal(agtMap.get(agtOrgId).getOpeningBal() - rs.getDouble(&quot;pwt&quot;));</span>
<span class="nc bnc" id="L753" title="All 2 branches missed.">							if (rsGame.isLast()) {</span>
<span class="nc" id="L754">								totalOpeningBal = totalOpeningBal + agtMap.get(agtOrgId).getOpeningBal();</span>
							}
<span class="nc" id="L756">							Map&lt;String, CompleteCollectionBean&gt; gameMap = agentBean.getGameBeanMap();</span>
<span class="nc bnc" id="L757" title="All 2 branches missed.">							if (gameMap == null) {</span>
<span class="nc" id="L758">								gameMap = new HashMap&lt;String, CompleteCollectionBean&gt;();</span>
<span class="nc" id="L759">								agentBean.setGameBeanMap(gameMap);</span>
							}
<span class="nc" id="L761">							gameBean = gameMap.get(gameName);</span>
<span class="nc bnc" id="L762" title="All 2 branches missed.">							if (gameBean == null) {</span>
<span class="nc" id="L763">								gameBean = new CompleteCollectionBean();</span>
<span class="nc" id="L764">								gameMap.put(gameName, gameBean);</span>
							}
<span class="nc" id="L766">							gameBean.setOrgName(gameName);</span>
<span class="nc" id="L767">							gameBean.setVsSale(rs.getDouble(&quot;sale&quot;));</span>
<span class="nc" id="L768">							totalSale = totalSale + rs.getDouble(&quot;sale&quot;);</span>
						}
<span class="nc" id="L770">					}</span>

<span class="nc" id="L772">					agentBean = agtMap.get(&quot;-1111&quot;);</span>
<span class="nc bnc" id="L773" title="All 2 branches missed.">					if (agentBean != null) {</span>
<span class="nc" id="L774">						Map&lt;String, CompleteCollectionBean&gt; gameMap = agentBean.getGameBeanMap();</span>
<span class="nc bnc" id="L775" title="All 2 branches missed.">						if (gameMap == null) {</span>
<span class="nc" id="L776">							gameMap = new HashMap&lt;String, CompleteCollectionBean&gt;();</span>
<span class="nc" id="L777">							agentBean.setGameBeanMap(gameMap);</span>
						}
<span class="nc" id="L779">						gameBean = gameMap.get(gameName);</span>
<span class="nc bnc" id="L780" title="All 2 branches missed.">						if (gameBean == null) {</span>
<span class="nc" id="L781">							gameBean = new CompleteCollectionBean();</span>
<span class="nc" id="L782">							gameMap.put(gameName, gameBean);</span>
						}
<span class="nc" id="L784">						gameBean.setOrgName(gameName);</span>
<span class="nc" id="L785">						gameBean.setVsSale(totalSale);</span>
					}
<span class="nc" id="L787">				}</span>
<span class="nc" id="L788">				agtMap.get(&quot;-1111&quot;).setOpeningBal(totalOpeningBal);</span>
			}

			// Debit and Credit Note Against Other Reasons
<span class="nc" id="L792">			toBeQuery = &quot;select agent_org_id organization_id,sum(amount) amount from (select agent_org_id,-sum(amount) amount  from st_lms_bo_transaction_master a inner join st_lms_bo_credit_note a1 on a.transaction_id=a1.transaction_id where a.transaction_date&gt;='&quot;</span>
					+ startDate
					+ &quot;' and a.transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' and a.transaction_type in ('CR_NOTE_CASH','CR_NOTE') and reason in ('OTHERS','CR_DAILY_INCENTIVE','CR_WEEKLY_INCENTIVE') group by agent_org_id union all select agent_org_id,(sum(amount)) amount from st_lms_bo_transaction_master a inner join st_lms_bo_debit_note a1 on a.transaction_id=a1.transaction_id where a.transaction_date&gt;='&quot;
					+ startDate
					+ &quot;' and a.transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' and a.transaction_type in ('DR_NOTE_CASH','DR_NOTE') and reason ='OTHERS' group by agent_org_id union all select organization_id agent_org_id,0.0 amount from st_lms_organization_master where organization_type='AGENT') mainTbl group by agent_org_id&quot;;

<span class="nc" id="L802">			pstmt = con.prepareStatement(toBeQuery);</span>
<span class="nc" id="L803">			logger.info(&quot;Current CR DR Note****-&gt; &quot; + pstmt);</span>
<span class="nc" id="L804">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L805" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L806">				String agtOrgId = rs.getString(&quot;organization_id&quot;);</span>
<span class="nc" id="L807">				agentBean = agtMap.get(agtOrgId);</span>
<span class="nc bnc" id="L808" title="All 2 branches missed.">				if (agentBean != null) {</span>
<span class="nc" id="L809">					agtMap.get(agtOrgId).setDebit(rs.getDouble(&quot;amount&quot;));</span>
<span class="nc" id="L810">					totalDebit = totalDebit + rs.getDouble(&quot;amount&quot;);</span>
				}
<span class="nc" id="L812">			}</span>

<span class="nc" id="L814">			agentBean = agtMap.get(&quot;-1111&quot;);</span>
<span class="nc bnc" id="L815" title="All 2 branches missed.">			if (agentBean != null) {</span>
<span class="nc" id="L816">				agtMap.get(&quot;-1111&quot;).setDebit(totalDebit);</span>
			}

<span class="nc bnc" id="L819" title="All 2 branches missed.">			if (ReportUtility.isOLA) {</span>
<span class="nc" id="L820">				toBeQuery = &quot;select WID.agtOrgId agtOrgId , wdraw,wdrawRef,depoAmt,depoRefAmt,netAmt from (select om.parent_id agtOrgId, ifnull(sum(wd), 0.0) wdraw from (select wrs.retailer_org_id, agent_net_amt as wd from st_ola_ret_withdrawl wrs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type = 'OLA_WITHDRAWL' and transaction_date&gt;='&quot;</span>
						+ startDate
						+ &quot;' and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;')) wdret right outer join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on om.organization_id = wdret.retailer_org_id group by om.parent_id)WID, (select om.parent_id agtOrgId, ifnull(sum(wdRef), 0.0) wdrawRef from (select wrs.retailer_org_id, agent_net_amt as wdRef from st_ola_ret_withdrawl_refund wrs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type = 'OLA_WITHDRAWL_REFUND' and transaction_date&gt;='&quot;
						+ startDate
						+ &quot;' and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;')) wdret right outer join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on om.organization_id = wdret.retailer_org_id group by om.parent_id)WIDREF,(select om.parent_id agtOrgId, ifnull(sum(depo), 0.0) depoAmt from (select wrs.retailer_org_id, agent_net_amt as depo from st_ola_ret_deposit wrs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type = 'OLA_DEPOSIT' and transaction_date&gt;='&quot;
						+ startDate
						+ &quot;' and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;')) wdret right outer join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on om.organization_id = wdret.retailer_org_id group by om.parent_id)DEP,(select om.parent_id agtOrgId, ifnull(sum(depoRef), 0.0) depoRefAmt from (select wrs.retailer_org_id, agent_net_amt as depoRef from st_ola_ret_deposit_refund wrs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type = 'OLA_DEPOSIT_REFUND' and transaction_date&gt;='&quot;
						+ startDate
						+ &quot;' and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;')) wdret right outer join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on om.organization_id = wdret.retailer_org_id group by om.parent_id)DEPREF,(select om.parent_id agtOrgId, ifnull(sum(netGamingAmt), 0.0) netAmt from(select wrs.retailer_org_id, agt_net_claim_comm as netGamingAmt from st_ola_ret_comm wrs inner join st_lms_retailer_transaction_master rt on wrs.transaction_id=rt.transaction_id where transaction_type = 'OLA_COMMISSION' and transaction_date&gt;='&quot;
						+ startDate
						+ &quot;' and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;') wdret right outer join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on om.organization_id = wdret.retailer_org_id group by om.parent_id)NETGAME where WID.agtOrgId=WIDREF.agtOrgId and WIDREF.agtOrgId =DEP.agtOrgId and DEP.agtOrgId =DEPREF.agtOrgId and DEPREF.agtOrgId=NETGAME.agtOrgId and NETGAME.agtOrgId=WID.agtOrgId&quot;;
				
<span class="nc" id="L842">				stmt=con.createStatement();</span>
<span class="nc" id="L843">				logger.info(&quot;QUERY FOR OPENING BAL OLA****-&gt; &quot; + toBeQuery);</span>
<span class="nc" id="L844">				rs=stmt.executeQuery(toBeQuery);</span>
				
				/*pstmt = con.prepareStatement(toBeQuery);
				rs = pstmt.executeQuery();*/
<span class="nc bnc" id="L848" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L849">					String agtOrgId = rs.getString(&quot;agtOrgId&quot;);</span>
<span class="nc" id="L850">					double dep = rs.getDouble(&quot;depoAmt&quot;)</span>
							- rs.getDouble(&quot;depoRefAmt&quot;);
<span class="nc" id="L852">					double wid = rs.getDouble(&quot;wdraw&quot;)</span>
							- rs.getDouble(&quot;wdrawRef&quot;);
<span class="nc bnc" id="L854" title="All 2 branches missed.">					if (agtMap.get(agtOrgId) != null) {</span>
<span class="nc" id="L855">						agtMap.get(agtOrgId).setDebit(</span>
								agtMap.get(agtOrgId).getDebit() + dep - wid);
<span class="nc" id="L857">						totalDebit = totalDebit</span>
								+ agtMap.get(agtOrgId).getDebit();
					}
<span class="nc" id="L860">				}</span>

<span class="nc" id="L862">				agentBean = agtMap.get(&quot;-1111&quot;);</span>
<span class="nc bnc" id="L863" title="All 2 branches missed.">				if (agentBean != null) {</span>
<span class="nc" id="L864">					agtMap.get(&quot;-1111&quot;).setDebit(totalDebit);</span>
				}
			}
			// CHANGE DATES FOR CURRENT DAY
<span class="nc" id="L868">			startDate = new Timestamp(stDate.getTime());</span>
<span class="nc" id="L869">			endDate = new Timestamp(startDate.getTime() + oneDay - 1000);</span>


			/*toBeQuery = &quot;select agent_org_id parent_id ,sum(training_exp_amt) teAmtd from st_lms_agent_weekly_training_exp ex,(select generated_id from st_lms_bo_receipts a,(select receipt_id from st_lms_bo_receipts_trn_mapping map ,(select  transaction_id from st_lms_bo_transaction_master a where a.transaction_date&gt;='&quot;
					+ startDate
					+ &quot;' and a.transaction_date&lt;='&quot;
					+ endDate
					+ &quot;'  and transaction_type='CR_NOTE_CASH') a where a.transaction_id=map.transaction_id) rec where a.receipt_id=rec.receipt_id) gen where ex.credit_note_number=gen.generated_id group by agent_org_id&quot;;*/
			
			
			// Weekly Training EXP
			
<span class="nc" id="L881">			toBeQuery = &quot;select parent_id ,sum(teAmtd) teAmtd  from	(select agent_org_id parent_id ,sum(amount) teAmtd from st_lms_bo_credit_note cn inner join st_lms_bo_transaction_master btm on cn.transaction_id = btm.transaction_id and transaction_date&gt;='&quot;</span>
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' and reason  = 'CR_WEEKLY_EXP' group by agent_org_id union all select agent_org_id parent_id ,-sum(amount) teAmtd from st_lms_bo_debit_note cn inner join st_lms_bo_transaction_master btm on cn.transaction_id = btm.transaction_id and transaction_date&gt;='&quot;
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' and reason  = 'DR_WEEKLY_TE_RETURN' group by agent_org_id) a group by parent_id&quot;;

			

<span class="nc" id="L893">			pstmt = con.prepareStatement(toBeQuery);</span>
<span class="nc" id="L894">			logger.info(&quot;Game Wise Data Without Daily Training EXP.****-&gt; &quot;</span>
					+ pstmt);
<span class="nc" id="L896">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L897" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L898">				String agtOrgId = rs.getString(&quot;parent_id&quot;);</span>
<span class="nc" id="L899">				agentBean = agtMap.get(agtOrgId);</span>
<span class="nc bnc" id="L900" title="All 2 branches missed.">				if (agentBean != null) {</span>
<span class="nc" id="L901">					agtMap.get(agtOrgId).setCredit(rs.getDouble(&quot;teAmtd&quot;));</span>
<span class="nc" id="L902">					totalCredit = totalCredit + rs.getDouble(&quot;teAmtd&quot;);</span>
				}
<span class="nc" id="L904">			}</span>

<span class="nc" id="L906">			agentBean = agtMap.get(&quot;-1111&quot;);</span>
<span class="nc bnc" id="L907" title="All 2 branches missed.">			if (agentBean != null) {</span>
<span class="nc" id="L908">				agtMap.get(&quot;-1111&quot;).setCredit(totalCredit);</span>
			}
			// Current Day's/CASH/BD+CHQ-CHQRET
<span class="nc" id="L911">			toBeQuery = &quot;select organization_id,sum(bank) bank,sum(cash) cash from (select  organization_id,sum(bank)+sum(chq) -sum(chkRet) bank,sum(cash) cash from (select agent_org_id organization_id,0.0 bank, 0.0 chq, 0.0 chkRet,sum(amount) cash from st_lms_bo_cash_transaction cash,st_lms_bo_transaction_master btm where cash.transaction_id=btm.transaction_id and transaction_date&gt;='&quot;</span>
					+ startDate
					+ &quot;'  and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;'  group by agent_org_id union all select agent_org_id organization_id,0.0 bank,sum(cheque_amt) chq,0.0 chkRet,0.0 cash from st_lms_bo_sale_chq chq,st_lms_bo_transaction_master btm where chq.transaction_id=btm.transaction_id and chq.transaction_type IN ('CHEQUE','CLOSED') and transaction_date&gt;='&quot;
					+ startDate
					+ &quot;'  and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;'  group by agent_org_id union all select agent_org_id organization_id,0.0 bank, 0.0 chq,sum(cheque_amt) chkRet,0.0 cash from st_lms_bo_sale_chq chq,st_lms_bo_transaction_master btm where chq.transaction_id=btm.transaction_id and chq.transaction_type IN ('CHQ_BOUNCE') and transaction_date&gt;='&quot;
					+ startDate
					+ &quot;'  and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;'  group by agent_org_id union all select organization_id,ifnull(bank,0.0) bank, 0.0 chq,0.0 chkRet,0.0 cash from (select agent_org_id ,sum(amount) bank from st_lms_bo_bank_deposit_transaction bank,st_lms_bo_transaction_master btm where bank.transaction_id=btm.transaction_id and transaction_date&gt;='&quot;
					+ startDate
					+ &quot;'  and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;'  group by agent_org_id) bank right outer join (select organization_id from st_lms_organization_master where organization_type='AGENT') om on agent_org_id=organization_id) pymntsTbl group by organization_id   union all select agent_org_id organization_id ,0.0 bank ,-sum(amount) cash  from st_lms_bo_transaction_master a inner join st_lms_bo_debit_note a1 on a.transaction_id=a1.transaction_id and a.transaction_date&gt;='&quot;+startDate+&quot;'  and a.transaction_date&lt;='&quot;+endDate+&quot;'   and a.transaction_type in ('DR_NOTE_CASH','DR_NOTE') and reason ='DR_WRONG_RECEIPT_ON_CASH' group by agent_org_id union all select agent_org_id organization_id ,-sum(amount) bank  , 0.0 cash from st_lms_bo_transaction_master a inner join st_lms_bo_debit_note a1 on a.transaction_id=a1.transaction_id and a.transaction_date&gt;='&quot;+startDate+&quot;'  and a.transaction_date&lt;='&quot;+endDate+&quot;'   and a.transaction_type in ('DR_NOTE_CASH','DR_NOTE') and reason ='DR_WRONG_RECEIPT_ON_BD' group by agent_org_id) outerQuery  group by organization_id&quot;;

<span class="nc" id="L929">			stmt=con.createStatement();</span>
<span class="nc" id="L930">			logger.info(&quot;Current Day's TX's.****-&gt; &quot; + toBeQuery);</span>
<span class="nc" id="L931">			rs=stmt.executeQuery(toBeQuery);</span>
			
			/*pstmt = con.prepareStatement(toBeQuery);
			logger.info(&quot;Current Day's TX's.****-&gt; &quot; + pstmt);
			rs = pstmt.executeQuery();*/
<span class="nc bnc" id="L936" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L937">				String agtOrgId = rs.getString(&quot;organization_id&quot;);</span>
<span class="nc" id="L938">				agentBean = agtMap.get(agtOrgId);</span>
<span class="nc bnc" id="L939" title="All 2 branches missed.">				if (agentBean != null) {</span>
<span class="nc" id="L940">					agtMap.get(agtOrgId).setCash(</span>
							agtMap.get(agtOrgId).getCash()
									+ rs.getDouble(&quot;cash&quot;));
<span class="nc" id="L943">					agtMap.get(agtOrgId).setBankDep(</span>
							agtMap.get(agtOrgId).getBankDep()
									+ rs.getDouble(&quot;bank&quot;));

<span class="nc" id="L947">					totalCash = totalCash + rs.getDouble(&quot;cash&quot;);</span>
<span class="nc" id="L948">					totalBank = totalBank + rs.getDouble(&quot;bank&quot;);</span>
				}
<span class="nc" id="L950">			}</span>

<span class="nc" id="L952">			agentBean = agtMap.get(&quot;-1111&quot;);</span>
<span class="nc bnc" id="L953" title="All 2 branches missed.">			if (agentBean != null) {</span>
<span class="nc" id="L954">				agtMap.get(&quot;-1111&quot;).setCash(totalCash);</span>
<span class="nc" id="L955">				agtMap.get(&quot;-1111&quot;).setBankDep(totalBank);</span>
			}
			
<span class="nc bnc" id="L958" title="All 2 branches missed.">			if (ReportUtility.isIW) {</span>
				// Current Day's PWT
<span class="nc" id="L960">				String gameQry = ReportUtility.getIWGameMapQuery(startDate);</span>
<span class="nc" id="L961">				gamePstmt = con.prepareStatement(gameQry);</span>
<span class="nc" id="L962">				rsGame = gamePstmt.executeQuery();</span>

<span class="nc bnc" id="L964" title="All 2 branches missed.">				while (rsGame.next()) {</span>
<span class="nc" id="L965">					int gameNo = rsGame.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L966">					toBeQuery = &quot;select organization_id, sum(pwt) pwt from (select parent_id organization_id ,ifnull(pwt,0.0) pwt from st_lms_organization_master om left outer join (select drs.retailer_org_id, sum(pwt_amt+agt_claim_comm) pwt from st_iw_ret_pwt drs inner join st_lms_retailer_transaction_master rtm on drs.transaction_id=rtm.transaction_id and (drs.game_id = &quot;</span>
							+ gameNo
							+ &quot; and drs.transaction_date&gt;='&quot;
							+ startDate
							+ &quot;' and drs.transaction_date&lt;='&quot;
							+ endDate
							+ &quot;') and transaction_type in('IW_PWT_AUTO','IW_PWT_PLR','IW_PWT') group by drs.retailer_org_id) pwt on om.organization_id=retailer_org_id union all select organization_id,sum(pwt_amt+agt_claim_comm) pwt from st_lms_organization_master, st_iw_agent_direct_plr_pwt where organization_id=agent_org_id and transaction_date&gt;='&quot;
							+ startDate
							+ &quot;' and transaction_date&lt;='&quot;
							+ endDate
							+ &quot;' and game_id=&quot;
							+ gameNo
							+ &quot; and organization_type='AGENT' group by agent_org_id) pwt group by organization_id&quot;;

<span class="nc" id="L980">					stmt = con.createStatement();</span>
<span class="nc" id="L981">					logger.info(&quot;Current Day's PWT/CASH/BD+CHQ-CHQREF****-&gt; &quot;</span>
							+ toBeQuery);
<span class="nc" id="L983">					rs = stmt.executeQuery(toBeQuery);</span>

					String agtOrgId;
<span class="nc bnc" id="L986" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L987">						agtOrgId = rs.getString(&quot;organization_id&quot;);</span>
<span class="nc bnc" id="L988" title="All 2 branches missed.">						if (agtMap.get(agtOrgId) != null) {</span>
<span class="nc" id="L989">							agtMap.get(agtOrgId).setIwPwt(agtMap.get(agtOrgId).getIwPwt() + rs.getDouble(&quot;pwt&quot;));</span>
<span class="nc" id="L990">							totalPwt = totalPwt + rs.getDouble(&quot;pwt&quot;);</span>
						}
					}
<span class="nc" id="L993">					agtMap.get(&quot;-1111&quot;).setIwPwt(totalPwt);</span>
<span class="nc" id="L994">				}</span>
			}
			
<span class="nc bnc" id="L997" title="All 2 branches missed.">			if (ReportUtility.isVS) {</span>
				// Current Day's PWT
<span class="nc" id="L999">				String gameQry = ReportUtility.getVSGameMapQuery(startDate);</span>
<span class="nc" id="L1000">				gamePstmt = con.prepareStatement(gameQry);</span>
<span class="nc" id="L1001">				rsGame = gamePstmt.executeQuery();</span>

<span class="nc bnc" id="L1003" title="All 2 branches missed.">				while (rsGame.next()) {</span>
<span class="nc" id="L1004">					int gameNo = rsGame.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L1005">					toBeQuery = &quot;select organization_id, sum(pwt) pwt from (select parent_id organization_id ,ifnull(pwt,0.0) pwt from st_lms_organization_master om left outer join (select drs.retailer_org_id, sum(pwt_amt+agt_claim_comm) pwt from st_vs_ret_pwt drs inner join st_lms_retailer_transaction_master rtm on drs.transaction_id=rtm.transaction_id and (drs.game_id = &quot;</span>
							+ gameNo
							+ &quot; and drs.transaction_date&gt;='&quot;
							+ startDate
							+ &quot;' and drs.transaction_date&lt;='&quot;
							+ endDate
							+ &quot;') and transaction_type in('VS_PWT_AUTO','VS_PWT_PLR','VS_PWT') group by drs.retailer_org_id) pwt on om.organization_id=retailer_org_id union all select organization_id,sum(pwt_amt+agt_claim_comm) pwt from st_lms_organization_master, st_vs_agent_direct_plr_pwt where organization_id=agent_org_id and transaction_date&gt;='&quot;
							+ startDate
							+ &quot;' and transaction_date&lt;='&quot;
							+ endDate
							+ &quot;' and game_id=&quot;
							+ gameNo
							+ &quot; and organization_type='AGENT' group by agent_org_id) pwt group by organization_id&quot;;

<span class="nc" id="L1019">					stmt = con.createStatement();</span>
<span class="nc" id="L1020">					logger.info(&quot;Current Day's PWT/CASH/BD+CHQ-CHQREF****-&gt; &quot;</span>
							+ toBeQuery);
<span class="nc" id="L1022">					rs = stmt.executeQuery(toBeQuery);</span>

					String agtOrgId;
<span class="nc bnc" id="L1025" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L1026">						agtOrgId = rs.getString(&quot;organization_id&quot;);</span>
<span class="nc bnc" id="L1027" title="All 2 branches missed.">						if (agtMap.get(agtOrgId) != null) {</span>
<span class="nc" id="L1028">							agtMap.get(agtOrgId).setVsPwt(agtMap.get(agtOrgId).getVsPwt() + rs.getDouble(&quot;pwt&quot;));</span>
<span class="nc" id="L1029">							totalPwt = totalPwt + rs.getDouble(&quot;pwt&quot;);</span>
						}
					}
<span class="nc" id="L1032">					agtMap.get(&quot;-1111&quot;).setVsPwt(totalPwt);</span>
<span class="nc" id="L1033">				}</span>
			}

<span class="nc bnc" id="L1036" title="All 2 branches missed.">			if (ReportUtility.isDG) {</span>
				// Current Day's PWT
<span class="nc" id="L1038">				String gameQry = ReportUtility.getDrawGameMapQuery(startDate);</span>
<span class="nc" id="L1039">				gamePstmt = con.prepareStatement(gameQry);</span>
<span class="nc" id="L1040">				rsGame = gamePstmt.executeQuery();</span>

<span class="nc bnc" id="L1042" title="All 2 branches missed.">				while (rsGame.next()) {</span>
<span class="nc" id="L1043">					int gameNo = rsGame.getInt(&quot;game_id&quot;);</span>
					/*toBeQuery = &quot;select parent_id organization_id,pwt+ifnull(pwtDir,0.0) pwt from (select parent_id,ifnull(pwt,0.0) pwt from st_lms_organization_master om , (select drs.retailer_org_id,sum(pwt_amt+agt_claim_comm) as pwt from st_dg_ret_pwt_&quot;
							+ gameNo
							+ &quot;  drs inner join st_lms_retailer_transaction_master rtm on drs.transaction_id=rtm.transaction_id where transaction_type in('DG_PWT_AUTO','DG_PWT_PLR','DG_PWT') and transaction_date&gt;='&quot;
							+ startDate
							+ &quot;'  and transaction_date&lt;='&quot;
							+ endDate
							+ &quot;'  group by drs.retailer_org_id) pwt where om.organization_id=retailer_org_id and om.organization_type='RETAILER' group by parent_id) aa left outer join (select organization_id,sum(pwt_amt+agt_claim_comm) pwtDir from st_lms_organization_master , st_dg_agt_direct_plr_pwt where organization_id=agent_org_id and transaction_date&gt;='&quot;
							+ startDate
							+ &quot;'  and transaction_date&lt;='&quot;
							+ endDate
							+ &quot;'  and game_id=&quot;
							+ gameNo
							+ &quot; and organization_type='AGENT' group by agent_org_id) bb on parent_id=organization_id&quot;;*/
					
<span class="nc" id="L1058">					toBeQuery = &quot;select organization_id , sum(pwt) pwt from (select parent_id organization_id ,ifnull(pwt,0.0) pwt from st_lms_organization_master om left outer join  (select drs.retailer_org_id,sum(pwt_amt+agt_claim_comm) pwt  from st_dg_ret_pwt_&quot;</span>
							+ gameNo
							+ &quot; drs inner join st_lms_retailer_transaction_master rtm on drs.transaction_id=rtm.transaction_id and (transaction_date&gt;='&quot;
							+ startDate
							+ &quot;'  and transaction_date&lt;='&quot;
							+ endDate
							+ &quot;') and transaction_type in('DG_PWT_AUTO','DG_PWT_PLR','DG_PWT') group by drs.retailer_org_id) pwt on om.organization_id=retailer_org_id union all select organization_id,sum(pwt_amt+agt_claim_comm) pwt from st_lms_organization_master , st_dg_agt_direct_plr_pwt where organization_id=agent_org_id and transaction_date&gt;='&quot;
							+ startDate
							+ &quot;'  and transaction_date&lt;='&quot;
							+ endDate
							+ &quot;'  and game_id=&quot;
							+ gameNo
							+ &quot; and organization_type='AGENT' group by agent_org_id) pwt group by organization_id&quot;;

<span class="nc" id="L1072">					stmt=con.createStatement();</span>
<span class="nc" id="L1073">					logger.info(&quot;Current Day's PWT/CASH/BD+CHQ-CHQREF****-&gt; &quot; + toBeQuery);</span>
<span class="nc" id="L1074">					rs=stmt.executeQuery(toBeQuery);</span>
					
					/*pstmt = con.prepareStatement(toBeQuery);
					logger.info(&quot;Current Day's PWT/CASH/BD+CHQ-CHQREF****-&gt; &quot;
							+ pstmt);
					rs = pstmt.executeQuery();*/
					String agtOrgId;
<span class="nc bnc" id="L1081" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L1082">						agtOrgId = rs.getString(&quot;organization_id&quot;);</span>
<span class="nc bnc" id="L1083" title="All 2 branches missed.">						if (agtMap.get(agtOrgId) != null) {</span>
<span class="nc" id="L1084">							agtMap.get(agtOrgId).setDgPwt(</span>
									agtMap.get(agtOrgId).getDgPwt()
											+ rs.getDouble(&quot;pwt&quot;));

<span class="nc" id="L1088">							totalPwt = totalPwt + rs.getDouble(&quot;pwt&quot;);</span>
						}
					}
<span class="nc" id="L1091">					agtMap.get(&quot;-1111&quot;).setDgPwt(totalPwt);</span>
<span class="nc" id="L1092">				}</span>
			}
<span class="nc" id="L1094">		} catch (Exception e) {</span>
<span class="nc" id="L1095">			e.printStackTrace();</span>
<span class="nc" id="L1096">			throw new LMSException(&quot;Error in report collectionAgentWise Expand&quot;);</span>
		} finally {
<span class="nc bnc" id="L1098" title="All 4 branches missed.">			if (con != null) {</span>
<span class="nc" id="L1099">				DBConnect.closeCon(con);</span>
			}
		}
<span class="nc" id="L1102">	}</span>

	public String getOrgAdd(int orgId) throws LMSException {
<span class="nc" id="L1105">		String orgAdd = &quot;&quot;;</span>
<span class="nc" id="L1106">		Connection con = null;</span>
<span class="nc" id="L1107">		con = DBConnect.getConnection();</span>
<span class="nc" id="L1108">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L1109">		ResultSet rs = null;</span>
		try {
<span class="nc" id="L1111">			pstmt = con</span>
					.prepareStatement(&quot;select addr_line1, addr_line2, city from st_lms_organization_master where organization_id = ?&quot;);
<span class="nc" id="L1113">			pstmt.setInt(1, orgId);</span>
<span class="nc" id="L1114">			rs = pstmt.executeQuery();</span>
<span class="nc" id="L1115">			System.out.println(pstmt);</span>
<span class="nc bnc" id="L1116" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1117">				orgAdd = rs.getString(&quot;addr_line1&quot;) + &quot;, &quot;</span>
						+ rs.getString(&quot;addr_line2&quot;) + &quot;, &quot;
						+ rs.getString(&quot;city&quot;);
			}
<span class="nc" id="L1121">		} catch (SQLException e) {</span>
<span class="nc" id="L1122">			logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L1123">			e.printStackTrace();</span>
<span class="nc" id="L1124">			throw new LMSException(e);</span>
		} finally {
<span class="nc" id="L1126">			try {</span>
<span class="nc bnc" id="L1127" title="All 8 branches missed.">				if (con != null &amp;&amp; !con.isClosed()) {</span>
<span class="nc" id="L1128">					con.close();</span>
				}
<span class="nc" id="L1130">			} catch (SQLException e) {</span>
<span class="nc" id="L1131">				logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L1132">				e.printStackTrace();</span>
<span class="nc" id="L1133">				throw new LMSException(e);</span>
<span class="nc" id="L1134">			}</span>
		}
<span class="nc" id="L1136">		return orgAdd;</span>
	}

	public Map&lt;String, String&gt; allGameMap() throws LMSException {
<span class="nc" id="L1140">		Map&lt;String, String&gt; gameMap = new LinkedHashMap&lt;String, String&gt;();</span>
<span class="nc" id="L1141">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L1142">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L1143">		ResultSet rs = null;</span>
		try {
<span class="nc" id="L1145">			String gameQry = &quot;select game_name,'DG' as game_type from st_dg_game_master where game_nbr not in(select game_nbr from st_dg_game_master where game_status='SALE_CLOSE') union all select game_name,'SE' as game_type from st_se_game_master union all select category_code,'CS' as game_type from st_cs_product_category_master where status = 'ACTIVE' union all select wallet_name,'OLA' as game_type from st_ola_wallet_master order by game_type&quot;;</span>
<span class="nc" id="L1146">			pstmt = con.prepareStatement(gameQry);</span>
<span class="nc" id="L1147">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1148" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1149">				gameMap.put(rs.getString(&quot;game_name&quot;), rs</span>
						.getString(&quot;game_type&quot;));
			}
<span class="nc" id="L1152">		} catch (Exception e) {</span>
<span class="nc" id="L1153">			e.printStackTrace();</span>
<span class="nc" id="L1154">			throw new LMSException(&quot;Error in fetch Game List&quot;);</span>
		} finally {
<span class="nc" id="L1156">			try {</span>
<span class="nc" id="L1157">				con.close();</span>
<span class="nc" id="L1158">			} catch (SQLException e) {</span>
<span class="nc" id="L1159">				e.printStackTrace();</span>
<span class="nc" id="L1160">			}</span>
<span class="nc" id="L1161">		}</span>
<span class="nc" id="L1162">		return gameMap;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>