<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PaymentLedgerReportAgtWiseHelperSP.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lms</a> &gt; <a href="index.source.html" class="el_package">com.skilrock.lms.coreEngine.reportsMgmt.common</a> &gt; <span class="el_source">PaymentLedgerReportAgtWiseHelperSP.java</span></div><h1>PaymentLedgerReportAgtWiseHelperSP.java</h1><pre class="source lang-java linenums">package com.skilrock.lms.coreEngine.reportsMgmt.common;

import java.sql.CallableStatement;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Timestamp;
import java.text.SimpleDateFormat;
import java.util.Calendar;
import java.util.HashMap;
import java.util.Iterator;
import java.util.LinkedHashMap;
import java.util.Map;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import com.skilrock.lms.beans.CollectionReportOverAllBean;
import com.skilrock.lms.beans.CompleteCollectionBean;
import com.skilrock.lms.common.db.DBConnect;
import com.skilrock.lms.common.exception.LMSException;
import com.skilrock.lms.common.filter.LMSFilterDispatcher;
import com.skilrock.lms.web.accMgmt.common.AgentOpeningBalanceHelper;
import com.skilrock.lms.web.instantWin.reportsMgmt.beans.IWOrgReportRequestBean;
import com.skilrock.lms.web.instantWin.reportsMgmt.beans.IWOrgReportResponseBean;
import com.skilrock.lms.web.instantWin.reportsMgmt.controller.IWAgentReportsControllerImpl;
import com.skilrock.lms.web.reportsMgmt.common.ReportUtility;
import com.skilrock.lms.web.sportsLottery.reportsMgmt.beans.SLEOrgReportRequestBean;
import com.skilrock.lms.web.sportsLottery.reportsMgmt.beans.SLEOrgReportResponseBean;
import com.skilrock.lms.web.sportsLottery.reportsMgmt.controller.SLEAgentReportsControllerImpl;
import com.skilrock.lms.web.virtualSports.reportsMgmt.beans.VSOrgReportRequestBean;
import com.skilrock.lms.web.virtualSports.reportsMgmt.beans.VSOrgReportResponseBean;
import com.skilrock.lms.web.virtualSports.reportsMgmt.controller.VSAgentReportsControllerImpl;
import com.skilrock.ola.reportsMgmt.controllerImpl.OlaAgentReportControllerImpl;
import com.skilrock.ola.reportsMgmt.javaBeans.OlaOrgReportRequestBean;
import com.skilrock.ola.reportsMgmt.javaBeans.OlaOrgReportResponseBean;

<span class="nc" id="L39">public class PaymentLedgerReportAgtWiseHelperSP implements IPaymentLedgerReportAgtWiseHelper {</span>
<span class="nc" id="L40">	Log logger = LogFactory.getLog(PaymentLedgerReportAgtWiseHelperSP.class);</span>



	public void collectionDateWise(Timestamp startDate, Timestamp endDate,
			Connection con,Map&lt;String, CollectionReportOverAllBean&gt; agtMap, int agtOrgId)
	throws LMSException {

<span class="nc" id="L48">		ResultSet rs = null;</span>
<span class="nc" id="L49">		PreparedStatement pstmt=null;</span>
<span class="nc bnc" id="L50" title="All 2 branches missed.">		if (startDate.after(endDate)) {</span>
<span class="nc" id="L51">			return;</span>
		}
		
		try {
			// Get Account Details

<span class="nc" id="L57">			CallableStatement cstmt = con</span>
			.prepareCall(&quot;call cashChqPaymentDateWiseOverAll(?,?,?)&quot;);
<span class="nc" id="L59">			cstmt.setTimestamp(1, startDate);</span>
<span class="nc" id="L60">			cstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L61">			cstmt.setInt(3, agtOrgId);</span>
<span class="nc" id="L62">			rs = cstmt.executeQuery();</span>

<span class="nc bnc" id="L64" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L65">				SimpleDateFormat dateformat = new SimpleDateFormat(</span>
						&quot;yyyy-MM-dd&quot;);
<span class="nc" id="L67">				String dateFrDtParse =dateformat.format(rs.getDate(&quot;date&quot;));</span>
				//String agtOrgId = rs.getString(&quot;organization_id&quot;);

<span class="nc" id="L70">				agtMap.get(dateFrDtParse).setCash(rs.getDouble(&quot;cash&quot;));</span>
<span class="nc" id="L71">				agtMap.get(dateFrDtParse).setCheque(rs.getDouble(&quot;chq&quot;));</span>


<span class="nc" id="L74">			}			</span>
<span class="nc" id="L75">			cstmt = con</span>
			.prepareCall(&quot;call creditDebitPaymentDateWiseOverAll(?,?,?)&quot;);
<span class="nc" id="L77">			cstmt.setTimestamp(1, startDate);</span>
<span class="nc" id="L78">			cstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L79">			cstmt.setInt(3, agtOrgId);</span>
<span class="nc" id="L80">			rs = cstmt.executeQuery();			</span>

<span class="nc bnc" id="L82" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L83">				SimpleDateFormat dateformat = new SimpleDateFormat(</span>
				&quot;yyyy-MM-dd&quot;);
<span class="nc" id="L85">				String dateFrDtParse =dateformat.format(rs.getDate(&quot;date&quot;));</span>
				//String agtOrgId = rs.getString(&quot;organization_id&quot;);

<span class="nc" id="L88">				agtMap.get(dateFrDtParse).setCredit(rs.getDouble(&quot;credit&quot;));</span>
<span class="nc" id="L89">				agtMap.get(dateFrDtParse).setDebit(rs.getDouble(&quot;debit&quot;));</span>
<span class="nc" id="L90">				agtMap.get(dateFrDtParse).setTraining(rs.getDouble(&quot;training&quot;));</span>
<span class="nc" id="L91">				agtMap.get(dateFrDtParse).setIncentive(rs.getDouble(&quot;incentive&quot;));</span>
<span class="nc" id="L92">				agtMap.get(dateFrDtParse).setOthers(rs.getDouble(&quot;others&quot;));</span>

<span class="nc" id="L94">			}</span>
<span class="nc" id="L95">			cstmt = con</span>
			.prepareCall(&quot;call chqRetBankPaymentDateWiseOverAll(?,?,?)&quot;);
<span class="nc" id="L97">			cstmt.setTimestamp(1, startDate);</span>
<span class="nc" id="L98">			cstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L99">			cstmt.setInt(3, agtOrgId);</span>
<span class="nc" id="L100">			rs = cstmt.executeQuery();	</span>

<span class="nc bnc" id="L102" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L103">				SimpleDateFormat dateformat = new SimpleDateFormat(</span>
				&quot;yyyy-MM-dd&quot;);
<span class="nc" id="L105">				String dateFrDtParse =dateformat.format(rs.getDate(&quot;date&quot;));</span>
				//String agtOrgId = rs.getString(&quot;organization_id&quot;);

<span class="nc" id="L108">				agtMap.get(dateFrDtParse).setChequeReturn(rs.getDouble(&quot;chq_ret&quot;));</span>
<span class="nc" id="L109">				agtMap.get(dateFrDtParse).setBankDep(rs.getDouble(&quot;bank&quot;));</span>
<span class="nc" id="L110">			}</span>

<span class="nc bnc" id="L112" title="All 2 branches missed.">			if (ReportUtility.isDG) {</span>

				// Game Master Query
<span class="nc" id="L115">				String gameQry = &quot;select game_id from st_dg_game_master&quot;;</span>
<span class="nc" id="L116">				PreparedStatement gamePstmt = con.prepareStatement(gameQry);</span>
<span class="nc" id="L117">				ResultSet rsGame = gamePstmt.executeQuery();</span>

<span class="nc bnc" id="L119" title="All 2 branches missed.">				while (rsGame.next()) {</span>
<span class="nc" id="L120">					int gameNo = rsGame.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L121">					cstmt = con</span>
					.prepareCall(&quot;call saleCancelPaymentDateWisePerGame(?,?,?,?)&quot;);
<span class="nc" id="L123">					cstmt.setTimestamp(1, startDate);</span>
<span class="nc" id="L124">					cstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L125">					cstmt.setInt(3, gameNo);</span>
<span class="nc" id="L126">					cstmt.setInt(4, agtOrgId);</span>
<span class="nc" id="L127">					rs = cstmt.executeQuery();</span>

<span class="nc bnc" id="L129" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L130">						SimpleDateFormat dateformat = new SimpleDateFormat(</span>
								&quot;yyyy-MM-dd&quot;);
<span class="nc" id="L132">						String dateFrDtParse =dateformat.format(rs.getDate(&quot;date&quot;));</span>
						//String agtOrgId = rs.getString(&quot;organization_id&quot;);

<span class="nc" id="L135">						agtMap.get(dateFrDtParse).setDgSale(agtMap.get(dateFrDtParse).getDgSale()+rs.getDouble(&quot;sale&quot;));</span>
<span class="nc" id="L136">						agtMap.get(dateFrDtParse).setDgCancel(agtMap.get(dateFrDtParse).getDgCancel()+rs.getDouble(&quot;cancel&quot;));</span>

<span class="nc" id="L138">					}</span>

<span class="nc" id="L140">					cstmt = con</span>
					.prepareCall(&quot;call pwtPaymentDateWisePerGame(?,?,?,?)&quot;);
<span class="nc" id="L142">					cstmt.setTimestamp(1, startDate);</span>
<span class="nc" id="L143">					cstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L144">					cstmt.setInt(3, gameNo);</span>
<span class="nc" id="L145">					cstmt.setInt(4, agtOrgId);</span>
<span class="nc" id="L146">					rs = cstmt.executeQuery();</span>

<span class="nc bnc" id="L148" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L149">						SimpleDateFormat dateformat = new SimpleDateFormat(</span>
						&quot;yyyy-MM-dd&quot;);
<span class="nc" id="L151">						String dateFrDtParse =dateformat.format(rs.getDate(&quot;date&quot;));</span>
						//String agtOrgId = rs.getString(&quot;organization_id&quot;);

<span class="nc" id="L154">						agtMap.get(dateFrDtParse).setDgPwt(agtMap.get(dateFrDtParse).getDgPwt() + rs.getDouble(&quot;pwt&quot;));</span>

<span class="nc" id="L156">					}</span>
<span class="nc" id="L157">				}</span>

<span class="nc" id="L159">				cstmt = con</span>
				.prepareCall(&quot;call DirPlayerpwtPaymentDateWisePerGame(?,?,?)&quot;);
<span class="nc" id="L161">				cstmt.setTimestamp(1, startDate);</span>
<span class="nc" id="L162">				cstmt.setTimestamp(2, endDate);</span>

<span class="nc" id="L164">				cstmt.setInt(3, agtOrgId);</span>
<span class="nc" id="L165">				rs = cstmt.executeQuery();</span>

<span class="nc bnc" id="L167" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L168">					SimpleDateFormat dateformat = new SimpleDateFormat(</span>
					&quot;yyyy-MM-dd&quot;);
<span class="nc" id="L170">					String dateFrDtParse =dateformat.format(rs.getDate(&quot;date&quot;));</span>
					//String agtOrgId = rs.getString(&quot;organization_id&quot;);

<span class="nc" id="L173">					agtMap.get(dateFrDtParse).setDgDirPlyPwt(</span>
							rs.getDouble(&quot;pwtDir&quot;));

<span class="nc" id="L176">				}</span>
				// Draw Direct Player Qry



			}
<span class="nc bnc" id="L182" title="All 2 branches missed.">			if (ReportUtility.isSE) {</span>
				// Calculate Scratch Sale
				// Game Master Query
<span class="nc" id="L185">				String gameQry = &quot;select game_id from st_se_game_master&quot;;</span>
<span class="nc" id="L186">				PreparedStatement gamePstmt = con.prepareStatement(gameQry);</span>
<span class="nc" id="L187">				ResultSet rsGame = gamePstmt.executeQuery();</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">				while (rsGame.next()) {</span>
<span class="nc" id="L189">					int gameNo = rsGame.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L190">					cstmt = con</span>
					.prepareCall(&quot;call scratchSaleCancelDateWisePerGame(?,?,?,?)&quot;);
<span class="nc" id="L192">					cstmt.setTimestamp(1, startDate);</span>
<span class="nc" id="L193">					cstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L194">					cstmt.setInt(3, gameNo);</span>
<span class="nc" id="L195">					cstmt.setInt(4,agtOrgId);</span>
<span class="nc" id="L196">					logger.debug(&quot;***Scratch Sale Query*** \n&quot; + cstmt);</span>
<span class="nc" id="L197">					rs = cstmt.executeQuery();</span>
					//String agtOrgId = null;
<span class="nc bnc" id="L199" title="All 2 branches missed.">					if (&quot;BOOK_WISE&quot;.equals(LMSFilterDispatcher.seSaleReportType)) {</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">						while (rs.next()) {</span>
							//agtOrgId = rs.getString(&quot;organization_id&quot;);

<span class="nc" id="L203">							SimpleDateFormat dateformat = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span>
<span class="nc" id="L204">							String dateFrDtParse =dateformat.format(rs.getDate(&quot;date&quot;));</span>
<span class="nc" id="L205">							agtMap.get(dateFrDtParse).setSeSale(agtMap.get(dateFrDtParse).getSeSale()+rs.getDouble(&quot;sale&quot;));</span>
<span class="nc" id="L206">							agtMap.get(dateFrDtParse).setSeCancel(agtMap.get(dateFrDtParse).getSeCancel()+ rs.getDouble(&quot;cancel&quot;));</span>
<span class="nc" id="L207">						}}</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">					else if (&quot;TICKET_WISE&quot;</span>
							.equals(LMSFilterDispatcher.seSaleReportType)) {
<span class="nc" id="L210">						SimpleDateFormat dateformat = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span>
<span class="nc" id="L211">						String dateFrDtParse =dateformat.format(rs.getDate(&quot;date&quot;));</span>

<span class="nc" id="L213">						agtMap.get(dateFrDtParse).setSeSale(agtMap.get(dateFrDtParse).getSeSale()+ rs.getDouble(&quot;sale&quot;));</span>
					}

<span class="nc" id="L216">					cstmt = con</span>
					.prepareCall(&quot;call scratchPwtDateWisePerGame(?,?,?,?)&quot;);
<span class="nc" id="L218">					cstmt.setTimestamp(1, startDate);</span>
<span class="nc" id="L219">					cstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L220">					cstmt.setInt(3, gameNo);</span>
<span class="nc" id="L221">					cstmt.setInt(4, agtOrgId);</span>
<span class="nc" id="L222">					rs = cstmt.executeQuery();</span>
<span class="nc" id="L223">					logger.debug(&quot;***Scratch Pwt Query*** \n&quot; + cstmt);</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L225">						SimpleDateFormat dateformat = new SimpleDateFormat(</span>
						&quot;yyyy-MM-dd&quot;);
<span class="nc" id="L227">						String dateFrDtParse =dateformat.format(rs.getDate(&quot;date&quot;));</span>
						//String agtOrgId = rs.getString(&quot;organization_id&quot;);
<span class="nc" id="L229">						agtMap.get(dateFrDtParse).setSePwt(agtMap.get(dateFrDtParse).getSePwt()+rs.getDouble(&quot;pwt&quot;));</span>


<span class="nc" id="L232">					}</span>

<span class="nc" id="L234">					cstmt = con</span>
					.prepareCall(&quot;call scratchDirPwtPlayerDateWisePerGame(?,?,?,?)&quot;);
<span class="nc" id="L236">					cstmt.setTimestamp(1, startDate);</span>
<span class="nc" id="L237">					cstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L238">					cstmt.setInt(3, gameNo);</span>
<span class="nc" id="L239">					cstmt.setInt(4, agtOrgId);</span>
<span class="nc" id="L240">					rs = cstmt.executeQuery();</span>
<span class="nc" id="L241">					logger.debug(&quot;***Scratch DirectPlayerPwt Query*** \n&quot; + cstmt);</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L243">						SimpleDateFormat dateformat = new SimpleDateFormat(</span>
						&quot;yyyy-MM-dd&quot;);
<span class="nc" id="L245">						String dateFrDtParse =dateformat.format(rs.getDate(&quot;date&quot;));</span>
						//String agtOrgId = rs.getString(&quot;organization_id&quot;);
<span class="nc" id="L247">						agtMap.get(dateFrDtParse).setSeDirPlyPwt(agtMap.get(dateFrDtParse).getSeDirPlyPwt()+rs.getDouble(&quot;pwtDir&quot;));</span>


<span class="nc" id="L250">					}</span>

<span class="nc" id="L252">				}</span>



			}
<span class="nc bnc" id="L257" title="All 2 branches missed.">			if (ReportUtility.isCS) {</span>

				// Category Master Query
<span class="nc" id="L260">				String catQry = &quot;select category_id from st_cs_product_category_master&quot;;</span>
<span class="nc" id="L261">				PreparedStatement gamePstmt = con.prepareStatement(catQry);</span>
<span class="nc" id="L262">				ResultSet rsProduct = gamePstmt.executeQuery();</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">				while (rsProduct.next()) {</span>
<span class="nc" id="L264">					int catId = rsProduct.getInt(&quot;category_id&quot;);</span>
<span class="nc" id="L265">					cstmt = con.prepareCall(&quot;call csCollectionDateWisePerCategory(?,?,?,?)&quot;);</span>
<span class="nc" id="L266">					cstmt.setTimestamp(1, startDate);</span>
<span class="nc" id="L267">					cstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L268">					cstmt.setInt(3, catId);</span>
<span class="nc" id="L269">					cstmt.setInt(4,agtOrgId);</span>
<span class="nc" id="L270">					logger.debug(&quot;-------CS Sale Query------\n&quot; + cstmt);</span>
<span class="nc" id="L271">					rs = cstmt.executeQuery();</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L273">						SimpleDateFormat dateformat = new SimpleDateFormat(</span>
						&quot;yyyy-MM-dd&quot;);
<span class="nc" id="L275">						String dateFrDtParse =dateformat.format(rs.getDate(&quot;date&quot;));</span>
						//String agtOrgId = rs.getString(&quot;organization_id&quot;);

<span class="nc" id="L278">						agtMap.get(dateFrDtParse).setCSSale(agtMap.get(dateFrDtParse).getCSSale()+rs.getDouble(&quot;sale&quot;));</span>
<span class="nc" id="L279">						agtMap.get(dateFrDtParse).setCSCancel(agtMap.get(dateFrDtParse).getCSCancel()+rs.getDouble(&quot;cancel&quot;));</span>

<span class="nc" id="L281">					}</span>

<span class="nc" id="L283">				}</span>
			}


<span class="nc bnc" id="L287" title="All 2 branches missed.">			if(ReportUtility.isOLA){</span>
				
<span class="nc" id="L289">				SimpleDateFormat dateformat = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span>
				
<span class="nc" id="L291">				OlaOrgReportRequestBean requestBean=new OlaOrgReportRequestBean();</span>
<span class="nc" id="L292">				requestBean.setFromDate(startDate.toString());</span>
<span class="nc" id="L293">				requestBean.setToDate(endDate.toString());</span>
<span class="nc" id="L294">				requestBean.setOrgId(agtOrgId);</span>
<span class="nc" id="L295">				Map&lt;String, OlaOrgReportResponseBean&gt; olaResponseBeanMap=OlaAgentReportControllerImpl.fetchDepositWithdrawlSingleAgentDateWise(requestBean, con);</span>
				
<span class="nc bnc" id="L297" title="All 2 branches missed.">				for(Map.Entry&lt;String, OlaOrgReportResponseBean&gt; entry:olaResponseBeanMap.entrySet()){</span>
<span class="nc" id="L298">					String txndate=entry.getKey();</span>
<span class="nc" id="L299">					OlaOrgReportResponseBean olaResponseBean=entry.getValue();</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">					if(agtMap.containsKey(txndate)){</span>
<span class="nc" id="L301">						agtMap.get(txndate).setWithdrawal(olaResponseBean.getNetWithdrawalAmt());</span>
<span class="nc" id="L302">						agtMap.get(txndate).setDeposit(olaResponseBean.getNetDepositAmt());</span>
					}
<span class="nc" id="L304">				}</span>
				
<span class="nc" id="L306">				String netGamingQry = &quot;select om.parent_id parent_id, sum(netGamingAmt) netAmt,date(transaction_date) date from(select wrs.retailer_org_id, agt_net_claim_comm as netGamingAmt,transaction_date from st_ola_ret_comm wrs inner join st_lms_retailer_transaction_master rt on wrs.transaction_id=rt.transaction_id where transaction_type = 'OLA_COMMISSION' and transaction_date&gt;='&quot;+ startDate+ &quot;' and transaction_date&lt;='&quot;+ endDate+ &quot;') wdret inner join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on om.organization_id = wdret.retailer_org_id where om.parent_id=&quot;+ agtOrgId + &quot; group by date(transaction_date)&quot;;</span>
				// net gaming commission query
<span class="nc" id="L308">				pstmt = con.prepareStatement(netGamingQry);</span>
<span class="nc" id="L309">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L311">					agtMap.get(dateformat.format(rs.getDate(&quot;date&quot;)))</span>
							.setNetGamingComm(rs.getDouble(&quot;netAmt&quot;));
				}
				
				
				/*
				
				
				SimpleDateFormat dateformat = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);
				StringBuilder wdQry = new StringBuilder(
						&quot;select parent_id,sum(wdrawAmt) as wdraw,date(transaction_date) date from&quot;);
				StringBuilder wdRefQry = new StringBuilder(
						&quot;select parent_id,sum(wdrawRefAmt) as wdrawRef,date(transaction_date) date from&quot;);// wdrawRef
				StringBuilder depQry = new StringBuilder(
						&quot;select parent_id,sum(depo) as depoAmt,date(transaction_date) date from&quot;);
				StringBuilder depRefQry = new StringBuilder(
						&quot;select parent_id,sum(depoRef) as depoRefAmt,date(transaction_date) date from&quot;);

				wdQry
						.append(&quot;(select drs.retailer_org_id,sum(agent_net_amt) as wdrawAmt,rtm.transaction_date from st_ola_ret_withdrawl drs,st_lms_retailer_transaction_master rtm where drs.transaction_id=rtm.transaction_id and rtm.transaction_type in('OLA_WITHDRAWL') and transaction_date&gt;='&quot;
								+ startDate
								+ &quot;' and transaction_date&lt;='&quot;
								+ endDate
								+ &quot;' and drs.retailer_org_id in (select organization_id from st_lms_organization_master where organization_type='RETAILER') group by date(transaction_date),drs.retailer_org_id)aa,st_lms_organization_master bb where retailer_org_id=organization_id and parent_id=&quot;
								+ agtOrgId + &quot; group by date(transaction_date)&quot;);

				wdRefQry
						.append(&quot;(select drs.retailer_org_id,sum(agent_net_amt) as wdrawRefAmt,rtm.transaction_date from st_ola_ret_withdrawl_refund drs,st_lms_retailer_transaction_master rtm where drs.transaction_id=rtm.transaction_id and rtm.transaction_type in('OLA_WITHDRAWL_REFUND') and transaction_date&gt;='&quot;
								+ startDate
								+ &quot;'and transaction_date&lt;='&quot;
								+ endDate
								+ &quot;' and drs.retailer_org_id in (select organization_id from st_lms_organization_master where organization_type='RETAILER') group by date(transaction_date),drs.retailer_org_id)aa,st_lms_organization_master bb where retailer_org_id=organization_id and parent_id=&quot;
								+ agtOrgId + &quot; group by date(transaction_date)&quot;);
				depQry
						.append(&quot;(select drs.retailer_org_id,sum(agent_net_amt) as depo,rtm.transaction_date from st_ola_ret_deposit drs,st_lms_retailer_transaction_master rtm where drs.transaction_id=rtm.transaction_id and rtm.transaction_type in('OLA_DEPOSIT') and transaction_date&gt;='&quot;
								+ startDate
								+ &quot;' and transaction_date&lt;='&quot;
								+ endDate
								+ &quot;' and drs.retailer_org_id in (select organization_id from st_lms_organization_master where organization_type='RETAILER') group by date(transaction_date),drs.retailer_org_id)aa,st_lms_organization_master bb where retailer_org_id=organization_id and parent_id=&quot;
								+ agtOrgId + &quot; group by date(transaction_date)&quot;);

				depRefQry
						.append(&quot;(select drs.retailer_org_id,sum(agent_net_amt) as depoRef,rtm.transaction_date from st_ola_ret_deposit_refund drs,st_lms_retailer_transaction_master rtm where drs.transaction_id=rtm.transaction_id and rtm.transaction_type in('OLA_DEPOSIT_REFUND') and transaction_date&gt;='&quot;
								+ startDate
								+ &quot;' and transaction_date&lt;='&quot;
								+ endDate
								+ &quot;' and drs.retailer_org_id in (select organization_id from st_lms_organization_master where organization_type='RETAILER') group by date(transaction_date),drs.retailer_org_id)aa,st_lms_organization_master bb where retailer_org_id=organization_id and parent_id=&quot;
								+ agtOrgId + &quot; group by date(transaction_date)&quot;);

				String netGamingQry = &quot;select om.parent_id parent_id, sum(netGamingAmt) netAmt,date(transaction_date) date from(select wrs.retailer_org_id, agt_net_claim_comm as netGamingAmt,transaction_date from st_ola_ret_comm wrs inner join st_lms_retailer_transaction_master rt on wrs.transaction_id=rt.transaction_id where transaction_type = 'OLA_COMMISSION' and transaction_date&gt;='&quot;+ startDate+ &quot;' and transaction_date&lt;='&quot;+ endDate+ &quot;') wdret inner join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on om.organization_id = wdret.retailer_org_id where om.parent_id=&quot;+ agtOrgId + &quot; group by date(transaction_date)&quot;;
				
				
				StringBuilder unionQuery=null;
				StringBuilder mainQuery=null;		
				
				// Withdrawal Query
				if(LMSFilterDispatcher.isRepFrmSP){
					mainQuery=new StringBuilder(&quot;select parent_id,sum(wdraw) wdraw,date from (&quot;);
					unionQuery=new StringBuilder(&quot; union all select parent_id agtOrgId,ifnull(sum(withdrawal_net_amt),0) as wdraw ,finaldate date from st_rep_ola_retailer where finaldate&gt;='&quot;+startDate+&quot;' and finaldate&lt;='&quot;+endDate+&quot;' and parent_id=&quot;+agtOrgId+&quot; group by finaldate) repTable group by date&quot;);
					mainQuery.append(wdQry.toString()).append(unionQuery.toString());
					pstmt = con.prepareStatement(mainQuery.toString());
				}
				else
				{
					pstmt = con.prepareStatement(wdQry.toString());
				}
				
				logger.debug(&quot;-------Withdrawal Query------\n&quot; + wdQry);
				rs = pstmt.executeQuery();
				while (rs.next()) {
					agtMap.get(dateformat.format(rs.getDate(&quot;date&quot;)))
							.setWithdrawal(rs.getDouble(&quot;wdraw&quot;));
				}
				
				// WithDrawal Refund Query
				if(LMSFilterDispatcher.isRepFrmSP){
					mainQuery=new StringBuilder(&quot;select parent_id,sum(wdrawRef) wdrawRef,date from (&quot;);
					unionQuery=new StringBuilder(&quot; union all select parent_id agtOrgId,ifnull(sum(ref_withdrawal_net_amt),0) as wdrawRef ,finaldate date from st_rep_ola_retailer where finaldate&gt;='&quot;+startDate+&quot;' and finaldate&lt;='&quot;+endDate+&quot;' and parent_id=&quot;+agtOrgId+&quot; group by finaldate) repTable group by date&quot;);
					mainQuery.append(wdRefQry.toString()).append(unionQuery.toString());
					pstmt = con.prepareStatement(mainQuery.toString());
				}
				else
				{
					pstmt = con.prepareStatement(wdRefQry.toString());
				}
				
				logger.debug(&quot;-------WithDrawal Refund Query------\n&quot;
						+ wdRefQry);
				rs = pstmt.executeQuery();
				while (rs.next()) {
					agtMap.get(dateformat.format(rs.getDate(&quot;date&quot;)))
							.setWithdrawalRefund(rs.getDouble(&quot;wdrawRef&quot;));
				}
				
				// Deposit Query
				if(LMSFilterDispatcher.isRepFrmSP){
					mainQuery=new StringBuilder(&quot;select parent_id,sum(depoAmt) depoAmt ,date from (&quot;);
					unionQuery=new StringBuilder(&quot; union all select parent_id agtOrgId,ifnull(sum(deposit_net),0) as depoAmt ,finaldate date from st_rep_ola_retailer where finaldate&gt;='&quot;+startDate+&quot;' and finaldate&lt;='&quot;+endDate+&quot;' and parent_id=&quot;+agtOrgId+&quot; group by finaldate) repTable group by date&quot;);
					mainQuery.append(depQry.toString()).append(unionQuery.toString());
					pstmt = con.prepareStatement(mainQuery.toString());
				}
				else
				{
					pstmt = con.prepareStatement(depQry.toString());
				}
				
				logger.debug(&quot;-------Deposit Query------\n&quot; + depQry);
				rs = pstmt.executeQuery();
				while (rs.next()) {
					agtMap.get(dateformat.format(rs.getDate(&quot;date&quot;)))
							.setDeposit(rs.getDouble(&quot;depoAmt&quot;));
				}
				
				// Deposit Refund Query
				if(LMSFilterDispatcher.isRepFrmSP){
					mainQuery=new StringBuilder(&quot;select parent_id,sum(depoRefAmt) depoRefAmt ,date from (&quot;);
					unionQuery=new StringBuilder(&quot; union all select parent_id agtOrgId,ifnull(sum(ref_deposit_net_amt),0) as depoRefAmt ,finaldate date from st_rep_ola_retailer where finaldate&gt;='&quot;+startDate+&quot;' and finaldate&lt;='&quot;+endDate+&quot;' and parent_id=&quot;+agtOrgId+&quot; group by finaldate) repTable group by date&quot;);
					mainQuery.append(depRefQry.toString()).append(unionQuery.toString());
					pstmt = con.prepareStatement(mainQuery.toString());
				}
				else
				{
					pstmt = con.prepareStatement(depRefQry.toString());
				}
				
				logger.debug(&quot;-------Deposit Refund Query------\n&quot; + depRefQry);

				rs = pstmt.executeQuery();
				while (rs.next()) {
					agtMap.get(dateformat.format(rs.getDate(&quot;date&quot;)))
							.setDepositRefund(rs.getDouble(&quot;depoRefAmt&quot;));
				}

				// net gaming commission query
				if(LMSFilterDispatcher.isRepFrmSP){
					mainQuery=new StringBuilder(&quot;select parent_id,sum(netAmt) netAmt ,date from (&quot;);
					unionQuery=new StringBuilder(&quot; union all select parent_id agtOrgId,ifnull(sum(net_gaming_net_comm),0) as netAmt ,finaldate date from st_rep_ola_retailer where finaldate&gt;='&quot;+startDate+&quot;' and finaldate&lt;='&quot;+endDate+&quot;' and parent_id=&quot;+agtOrgId+&quot; group by finaldate) repTable group by date&quot;);
					mainQuery.append(netGamingQry.toString()).append(unionQuery.toString());
					pstmt = con.prepareStatement(mainQuery.toString());
				}
				else
				{
					pstmt = con.prepareStatement(netGamingQry.toString());
				}
				rs = pstmt.executeQuery();
		
				logger.debug(&quot;-------Net Gaming Query------\n&quot; + netGamingQry);
				
				rs = pstmt.executeQuery();
				while (rs.next()) {
					agtMap.get(dateformat.format(rs.getDate(&quot;date&quot;)))
							.setNetGamingComm(rs.getDouble(&quot;netAmt&quot;));
				}*/
			}
			
<span class="nc bnc" id="L466" title="All 2 branches missed.">			if(ReportUtility.isSLE){</span>
<span class="nc" id="L467">				SLEOrgReportRequestBean requestBean=new SLEOrgReportRequestBean();</span>
<span class="nc" id="L468">				requestBean.setFromDate(startDate);</span>
<span class="nc" id="L469">				requestBean.setToDate(endDate);</span>
<span class="nc" id="L470">				requestBean.setOrgId(agtOrgId);</span>
<span class="nc" id="L471">				Map&lt;String, SLEOrgReportResponseBean&gt; sleResponseBeanMap=SLEAgentReportsControllerImpl.fetchSalePWTDayWiseAllGameSingleAgent(requestBean, con);</span>
				
<span class="nc bnc" id="L473" title="All 2 branches missed.">				for(Map.Entry&lt;String, SLEOrgReportResponseBean&gt; entry : sleResponseBeanMap.entrySet()){</span>
<span class="nc" id="L474">					String txndate=entry.getKey();</span>
<span class="nc" id="L475">					SLEOrgReportResponseBean sleResponseBean = entry.getValue();</span>
<span class="nc bnc" id="L476" title="All 2 branches missed.">					if(agtMap.containsKey(txndate)){</span>
<span class="nc" id="L477">						agtMap.get(txndate).setSleSale(sleResponseBean.getSaleAmt());</span>
<span class="nc" id="L478">						agtMap.get(txndate).setSleCancel(sleResponseBean.getCancelAmt());</span>
<span class="nc" id="L479">						agtMap.get(txndate).setSlePwt(sleResponseBean.getPwtAmt());</span>
<span class="nc" id="L480">						agtMap.get(txndate).setSleDirPlyPwt(sleResponseBean.getPwtDirAmt());</span>
					}
<span class="nc" id="L482">				}</span>
			}
			
<span class="nc bnc" id="L485" title="All 2 branches missed.">			if(ReportUtility.isIW){</span>
<span class="nc" id="L486">				IWOrgReportRequestBean requestBean=new IWOrgReportRequestBean();</span>
<span class="nc" id="L487">				requestBean.setFromDate(startDate);</span>
<span class="nc" id="L488">				requestBean.setToDate(endDate);</span>
<span class="nc" id="L489">				requestBean.setOrgId(agtOrgId);</span>
<span class="nc" id="L490">				Map&lt;String, IWOrgReportResponseBean&gt; iwResponseBeanMap=IWAgentReportsControllerImpl.fetchSalePWTDayWiseAllGameSingleAgent(requestBean, con);</span>
				
<span class="nc bnc" id="L492" title="All 2 branches missed.">				for(Map.Entry&lt;String, IWOrgReportResponseBean&gt; entry : iwResponseBeanMap.entrySet()){</span>
<span class="nc" id="L493">					String txndate=entry.getKey();</span>
<span class="nc" id="L494">					IWOrgReportResponseBean iwResponseBean = entry.getValue();</span>
<span class="nc bnc" id="L495" title="All 2 branches missed.">					if(agtMap.containsKey(txndate)){</span>
<span class="nc" id="L496">						agtMap.get(txndate).setIwSale(iwResponseBean.getSaleAmt());</span>
<span class="nc" id="L497">						agtMap.get(txndate).setIwCancel(iwResponseBean.getCancelAmt());</span>
<span class="nc" id="L498">						agtMap.get(txndate).setIwPwt(iwResponseBean.getPwtAmt());</span>
<span class="nc" id="L499">						agtMap.get(txndate).setIwDirPlyPwt(iwResponseBean.getPwtDirAmt());</span>
					}
<span class="nc" id="L501">				}</span>
			}

<span class="nc bnc" id="L504" title="All 2 branches missed.">			if (ReportUtility.isVS) {</span>
<span class="nc" id="L505">				VSOrgReportRequestBean requestBean = new VSOrgReportRequestBean();</span>
<span class="nc" id="L506">				requestBean.setFromDate(startDate);</span>
<span class="nc" id="L507">				requestBean.setToDate(endDate);</span>
<span class="nc" id="L508">				requestBean.setOrgId(agtOrgId);</span>
<span class="nc" id="L509">				Map&lt;String, VSOrgReportResponseBean&gt; vsResponseBeanMap = VSAgentReportsControllerImpl.fetchSalePWTDayWiseAllGameSingleAgent(requestBean, con);</span>

<span class="nc bnc" id="L511" title="All 2 branches missed.">				for (Map.Entry&lt;String, VSOrgReportResponseBean&gt; entry : vsResponseBeanMap.entrySet()) {</span>
<span class="nc" id="L512">					String txndate = entry.getKey();</span>
<span class="nc" id="L513">					VSOrgReportResponseBean vsResponseBean = entry.getValue();</span>
<span class="nc bnc" id="L514" title="All 2 branches missed.">					if (agtMap.containsKey(txndate)) {</span>
<span class="nc" id="L515">						agtMap.get(txndate).setVsSale(vsResponseBean.getSaleAmt());</span>
<span class="nc" id="L516">						agtMap.get(txndate).setVsCancel(vsResponseBean.getCancelAmt());</span>
<span class="nc" id="L517">						agtMap.get(txndate).setVsPwt(vsResponseBean.getPwtAmt());</span>
<span class="nc" id="L518">						agtMap.get(txndate).setVsDirPlyPwt(vsResponseBean.getPwtDirAmt());</span>
					}
<span class="nc" id="L520">				}</span>
			}
<span class="nc" id="L522">		} catch (Exception e) {</span>
<span class="nc" id="L523">			e.printStackTrace();</span>
<span class="nc" id="L524">			throw new LMSException(&quot;Error in report collectionAgentWise&quot;);</span>
<span class="nc" id="L525">		}</span>
<span class="nc" id="L526">	}</span>
	

	public void collectionAgentWiseExpand(Timestamp startDate,
			Timestamp endDate,Map&lt;String, CollectionReportOverAllBean&gt; agtMap)
			throws LMSException {
<span class="nc" id="L532">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L533">		ResultSet rs = null;</span>

<span class="nc" id="L535">		CollectionReportOverAllBean agentBean = null;</span>
		CompleteCollectionBean gameBean;
		try {
<span class="nc bnc" id="L538" title="All 2 branches missed.">			if (ReportUtility.isDG) {</span>
				// Game Master Query
<span class="nc" id="L540">				String gameQry = &quot;select game_id,game_name from st_dg_game_master&quot;;</span>
<span class="nc" id="L541">				PreparedStatement gamePstmt = con.prepareStatement(gameQry);</span>
<span class="nc" id="L542">				ResultSet rsGame = gamePstmt.executeQuery();</span>
<span class="nc bnc" id="L543" title="All 2 branches missed.">				while (rsGame.next()) {</span>
<span class="nc" id="L544">					int gameId = rsGame.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L545">					String gameName = rsGame.getString(&quot;game_name&quot;);</span>
<span class="nc" id="L546">					CallableStatement cstmt = con</span>
							.prepareCall(&quot;call drawCollectionAgentWisePerGame(?,?,?)&quot;);
<span class="nc" id="L548">					cstmt.setTimestamp(1, startDate);</span>
<span class="nc" id="L549">					cstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L550">					cstmt.setInt(3, gameId);					</span>
<span class="nc" id="L551">					logger.debug(&quot;-------Indivisual Game Qry-------\n&quot; + cstmt);</span>
<span class="nc" id="L552">					rs = cstmt.executeQuery();</span>
<span class="nc bnc" id="L553" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L554">						String agtOrgId = rs.getString(&quot;parent_id&quot;);</span>
<span class="nc" id="L555">						agentBean = agtMap.get(agtOrgId);</span>
<span class="nc" id="L556">						Map&lt;String, CompleteCollectionBean&gt; gameMap = agentBean</span>
								.getGameBeanMap();
<span class="nc bnc" id="L558" title="All 2 branches missed.">						if (gameMap == null) {</span>
<span class="nc" id="L559">							gameMap = new HashMap&lt;String, CompleteCollectionBean&gt;();</span>
<span class="nc" id="L560">							agentBean.setGameBeanMap(gameMap);</span>
						}
<span class="nc" id="L562">						gameBean = gameMap.get(gameName);</span>
<span class="nc bnc" id="L563" title="All 2 branches missed.">						if (gameBean == null) {</span>
<span class="nc" id="L564">							gameBean = new CompleteCollectionBean();</span>
<span class="nc" id="L565">							gameMap.put(gameName, gameBean);</span>
						}
<span class="nc" id="L567">						gameBean.setOrgName(gameName);</span>
<span class="nc" id="L568">						gameBean.setDrawSale(rs.getDouble(&quot;sale&quot;));</span>
<span class="nc" id="L569">						gameBean.setDrawCancel(rs.getDouble(&quot;cancel&quot;));</span>
<span class="nc" id="L570">						gameBean.setDrawPwt(rs.getDouble(&quot;pwt&quot;));</span>
<span class="nc" id="L571">						gameBean.setDrawDirPlyPwt(rs.getDouble(&quot;pwtDir&quot;));</span>
<span class="nc" id="L572">					}</span>
<span class="nc" id="L573">				}</span>
			}
<span class="nc bnc" id="L575" title="All 2 branches missed.">			if (ReportUtility.isSE) {</span>
				// Game Master Query
<span class="nc" id="L577">				String gameQry = &quot;select game_id,game_name from st_se_game_master&quot;;</span>
<span class="nc" id="L578">				PreparedStatement gamePstmt = con.prepareStatement(gameQry);</span>
<span class="nc" id="L579">				ResultSet rsGame = gamePstmt.executeQuery();</span>
<span class="nc bnc" id="L580" title="All 2 branches missed.">				while (rsGame.next()) {</span>
<span class="nc" id="L581">					int gameId = rsGame.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L582">					String gameName = rsGame.getString(&quot;game_name&quot;);</span>
<span class="nc" id="L583">					CallableStatement cstmt = con</span>
							.prepareCall(&quot;call scratchCollectionAgentWisePerGame(?,?,?)&quot;);
<span class="nc" id="L585">					cstmt.setTimestamp(1, startDate);</span>
<span class="nc" id="L586">					cstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L587">					cstmt.setInt(3, gameId);</span>
<span class="nc" id="L588">					logger.debug(&quot;-------Indivisual Game Qry-------\n&quot; + cstmt);</span>
<span class="nc" id="L589">					rs = cstmt.executeQuery();</span>
<span class="nc bnc" id="L590" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L591">						String agtOrgId = rs.getString(&quot;organization_id&quot;);</span>
<span class="nc" id="L592">						agentBean = agtMap.get(agtOrgId);</span>
<span class="nc" id="L593">						Map&lt;String, CompleteCollectionBean&gt; gameMap = agentBean</span>
								.getGameBeanMap();
<span class="nc bnc" id="L595" title="All 2 branches missed.">						if (gameMap == null) {</span>
<span class="nc" id="L596">							gameMap = new HashMap&lt;String, CompleteCollectionBean&gt;();</span>
<span class="nc" id="L597">							agentBean.setGameBeanMap(gameMap);</span>
						}
<span class="nc" id="L599">						gameBean = gameMap.get(gameName);</span>
<span class="nc bnc" id="L600" title="All 2 branches missed.">						if (gameBean == null) {</span>
<span class="nc" id="L601">							gameBean = new CompleteCollectionBean();</span>
<span class="nc" id="L602">							gameMap.put(gameName, gameBean);</span>
						}
<span class="nc" id="L604">						gameBean.setOrgName(gameName);</span>
<span class="nc" id="L605">						gameBean.setDrawSale(rs.getDouble(&quot;sale&quot;));</span>
<span class="nc" id="L606">						gameBean.setDrawCancel(rs.getDouble(&quot;cancel&quot;));</span>
<span class="nc" id="L607">						gameBean.setDrawPwt(rs.getDouble(&quot;pwt&quot;));</span>
<span class="nc" id="L608">						gameBean.setDrawDirPlyPwt(rs.getDouble(&quot;pwtDir&quot;));</span>
<span class="nc" id="L609">					}</span>
<span class="nc" id="L610">				}</span>
			}
<span class="nc bnc" id="L612" title="All 2 branches missed.">			if (ReportUtility.isCS) {</span>
				// Category Master Query
<span class="nc" id="L614">				String prodQry = &quot;select category_id,category_code from st_cs_product_category_master&quot;;</span>
<span class="nc" id="L615">				PreparedStatement prodPstmt = con.prepareStatement(prodQry);</span>
<span class="nc" id="L616">				ResultSet rsProd = prodPstmt.executeQuery();</span>
<span class="nc bnc" id="L617" title="All 2 branches missed.">				while (rsProd.next()) {</span>
<span class="nc" id="L618">					int catId = rsProd.getInt(&quot;category_id&quot;);</span>
<span class="nc" id="L619">					String catName = rsProd.getString(&quot;category_code&quot;);</span>
<span class="nc" id="L620">					CallableStatement cstmt = con</span>
							.prepareCall(&quot;call csCollectionAgentWisePerGame(?,?,?)}&quot;);
<span class="nc" id="L622">					cstmt.setTimestamp(1, startDate);</span>
<span class="nc" id="L623">					cstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L624">					cstmt.setInt(3, catId);					</span>
<span class="nc" id="L625">					logger.debug(&quot;-------Indivisual Category Qry-------\n&quot; + cstmt);</span>
<span class="nc" id="L626">					rs = cstmt.executeQuery();</span>
<span class="nc bnc" id="L627" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L628">						String agtOrgId = rs.getString(&quot;parent_id&quot;);</span>
<span class="nc" id="L629">						agentBean = agtMap.get(agtOrgId);</span>
<span class="nc" id="L630">						Map&lt;String, CompleteCollectionBean&gt; gameMap = agentBean</span>
								.getGameBeanMap();
<span class="nc bnc" id="L632" title="All 2 branches missed.">						if (gameMap == null) {</span>
<span class="nc" id="L633">							gameMap = new HashMap&lt;String, CompleteCollectionBean&gt;();</span>
<span class="nc" id="L634">							agentBean.setGameBeanMap(gameMap);</span>
						}
<span class="nc" id="L636">						gameBean = gameMap.get(catName);</span>
<span class="nc bnc" id="L637" title="All 2 branches missed.">						if (gameBean == null) {</span>
<span class="nc" id="L638">							gameBean = new CompleteCollectionBean();</span>
<span class="nc" id="L639">							gameMap.put(catName, gameBean);</span>
						}
<span class="nc" id="L641">						gameBean.setOrgName(catName);</span>
<span class="nc" id="L642">						gameBean.setDrawSale(rs.getDouble(&quot;sale&quot;));</span>
<span class="nc" id="L643">						gameBean.setDrawCancel(rs.getDouble(&quot;cancel&quot;));</span>
<span class="nc" id="L644">						gameBean.setDrawPwt(rs.getDouble(&quot;pwt&quot;));</span>
<span class="nc" id="L645">						gameBean.setDrawDirPlyPwt(rs.getDouble(&quot;pwtDir&quot;));</span>
<span class="nc" id="L646">					}</span>
<span class="nc" id="L647">				}</span>
			
				
				
				/*CSQry = new StringBuilder(
						&quot;select organization_id,ifnull(sale,0.0) sale,ifnull(cancel,0.0) cancel from (select sale.parent_id,sale,cancel from &quot;);
				saleTranCS = &quot;(select bb.parent_id,sum(sale) as sale from (select drs.retailer_org_id,sum(agent_net_amt) as sale from st_cs_sale_? drs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type in('CS_SALE') and transaction_date&gt;='&quot;
						+ startDate
						+ &quot;' and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;') group by drs.retailer_org_id) aa right outer join (select organization_id,parent_id from st_lms_organization_master where organization_type='RETAILER')bb on retailer_org_id=organization_id group by parent_id) sale,&quot;;
				cancelTranCS = &quot;(select bb.parent_id,sum(cancel) as cancel from (select drs.retailer_org_id,sum(agent_net_amt) as cancel from st_cs_refund_? drs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type in('CS_CANCEL_SERVER','CS_CANCEL_RET') and transaction_date&gt;='&quot;
						+ startDate
						+ &quot;' and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;') group by drs.retailer_org_id) aa right outer join (select organization_id,parent_id from st_lms_organization_master where organization_type='RETAILER') bb on retailer_org_id=organization_id group by parent_id) cancel&quot;;
				CSQry.append(saleTranCS);
				CSQry.append(cancelTranCS);
				CSQry
						.append(&quot; where sale.parent_id=cancel.parent_id) gameTlb right outer join (select organization_id from st_lms_organization_master where organization_type='AGENT') agtTlb on gameTlb.parent_id=agtTlb.organization_id&quot;);
				logger.debug(&quot;For Expand CS game Qry:: &quot; + CSQry);

				// Category Master Query
				String prodQry = &quot;select category_id, category_code from st_cs_product_category_master where status = 'ACTIVE'&quot;;
				PreparedStatement prodPstmt = con.prepareStatement(prodQry);
				ResultSet rsProd = prodPstmt.executeQuery();
				while (rsProd.next()) {
					int catId = rsProd.getInt(&quot;category_id&quot;);
					String catName = rsProd.getString(&quot;category_code&quot;);
					pstmt = con.prepareStatement(CSQry.toString());
					pstmt.setInt(1, catId);
					pstmt.setInt(2, catId);
					logger.debug(&quot;-------Indivisual Category Qry-------\n&quot;
							+ pstmt);
					rs = pstmt.executeQuery();
					while (rs.next()) {
						String agtOrgId = rs.getString(&quot;organization_id&quot;);
						agentBean = agtMap.get(agtOrgId);
						Map&lt;String, CompleteCollectionBean&gt; prodMap = agentBean
								.getGameBeanMap();
						if (prodMap == null) {
							prodMap = new HashMap&lt;String, CompleteCollectionBean&gt;();
							agentBean.setGameBeanMap(prodMap);
						}
						prodBean = prodMap.get(catName);
						if (prodBean == null) {
							prodBean = new CompleteCollectionBean();
							prodMap.put(catName, prodBean);
						}
						prodBean.setOrgName(catName);
						prodBean.setDrawSale(rs.getDouble(&quot;sale&quot;));
						prodBean.setDrawPwt(rs.getDouble(&quot;cancel&quot;));

						System.out.println(&quot;map size:&quot; + prodMap.size());
					}

				}*/

			}
<span class="nc" id="L706">		} catch (Exception e) {</span>
<span class="nc" id="L707">			e.printStackTrace();</span>
<span class="nc" id="L708">			throw new LMSException(&quot;Error in report collectionAgentWise Expand&quot;);</span>
		} finally {
<span class="nc" id="L710">			try {</span>
<span class="nc" id="L711">				con.close();</span>
<span class="nc" id="L712">			} catch (SQLException e) {</span>
<span class="nc" id="L713">				e.printStackTrace();</span>
<span class="nc" id="L714">			}</span>
<span class="nc" id="L715">		}</span>
<span class="nc" id="L716">	}</span>

	public Map&lt;String, CollectionReportOverAllBean&gt; collectionAgentWiseWithOpeningBal(
			Timestamp deployDate, Timestamp startDate, Timestamp endDate,int agtOrgId) throws LMSException {
		
<span class="nc" id="L721">		Connection con = null;</span>
<span class="nc bnc" id="L722" title="All 2 branches missed.">		if (startDate.after(endDate)) {</span>
<span class="nc" id="L723">			return null;</span>
		}
		//Map&lt;String, CollectionReportOverAllBean&gt; agtMapOpenningBalance = new LinkedHashMap&lt;String, CollectionReportOverAllBean&gt;();
<span class="nc" id="L726">		Map&lt;String, CollectionReportOverAllBean&gt; agtMap = new LinkedHashMap&lt;String, CollectionReportOverAllBean&gt;();</span>
		//Map&lt;String, CollectionReportOverAllBean&gt; resultMap = new LinkedHashMap&lt;String, CollectionReportOverAllBean&gt;();
<span class="nc" id="L728">		CollectionReportOverAllBean collBean = null;</span>
<span class="nc" id="L729">        Double openingBalance=0.0;</span>
		try {
<span class="nc" id="L731">			con = DBConnect.getConnection();</span>
			//String agtOrgQry = &quot;select name,organization_id from st_lms_organization_master where organization_type='AGENT' and organization_id=&quot;+agtOrgId;
			//pstmt = con.prepareStatement(agtOrgQry);
			//rsRetOrg = pstmt.executeQuery();
			
<span class="nc" id="L736">			Calendar startCal = Calendar.getInstance();</span>
<span class="nc" id="L737">			Calendar endCal = Calendar.getInstance();</span>
<span class="nc" id="L738">			Calendar nextCal = Calendar.getInstance();</span>
<span class="nc" id="L739">			startCal.setTimeInMillis(startDate.getTime());</span>
<span class="nc" id="L740">			endCal.setTimeInMillis(endDate.getTime());</span>
<span class="nc" id="L741">			nextCal.setTimeInMillis(startDate.getTime());</span>
			
			//nextCal.add(Calendar.DAY_OF_MONTH, 1);
		//	startDate = new Timestamp(sdf.parse(sdf.format(startCal.getTime())).getTime());
		//	endDate = new Timestamp(sdf.parse(sdf.format(endCal.getTime())).getTime());
		//	collBean = new CollectionReportOverAllBean();
		//	collBean.setAgentName(new Timestamp(nextCal.getTimeInMillis()).toString().split(&quot; &quot;)[0]);//its date for this report
			
			
			//agtMapOpenningBalance.put(agtOrgId+&quot;&quot;, collBean);
<span class="nc" id="L751">			AgentOpeningBalanceHelper agentOpenHelper=new AgentOpeningBalanceHelper();</span>
<span class="nc" id="L752">			openingBalance=agentOpenHelper.collectionAgentWise(deployDate, startDate, con,agtOrgId);</span>
//			openingBalance=agentOpenHelper.collectionAgentWise(deployDate, new Timestamp(startDate.getTime()-1000), con,agtOrgId);
	/*		Iterator&lt;Map.Entry&lt;String, CollectionReportOverAllBean&gt;&gt; itr = agtMapOpenningBalance
			.entrySet().iterator();
			while (itr.hasNext()) {
				Map.Entry&lt;String, CollectionReportOverAllBean&gt; pair = itr
				.next();
				CollectionReportOverAllBean bean = pair.getValue();
				double openingBal = bean.getDgSale()
				- bean.getDgCancel()
				- bean.getDgPwt()
				- bean.getDgDirPlyPwt()
				+ bean.getSeSale()
				- bean.getSePwt()
				- bean.getSeDirPlyPwt()
				+ bean.getCSSale()
				- bean.getCSCancel()
				+ bean.getDeposit()
				- bean.getDepositRefund()
				- bean.getWithdrawal()
				- bean.getNetGamingComm()
				- (bean.getCash() + bean.getCheque() + bean.getCredit()
				+ bean.getBankDep() - bean.getDebit() - bean
				.getChequeReturn());
			bean.setOpeningBal(openingBal);
			openingBalance = openingBal;
	}
			*/
<span class="nc" id="L780">			logger.info(&quot;AgentId==&quot;+agtOrgId+&quot;==Openning Balance=&quot;+openingBalance+&quot;=date=&quot;+startDate);</span>
<span class="nc bnc" id="L781" title="All 2 branches missed.">			if (endCal.after(startCal)) {</span>
<span class="nc bnc" id="L782" title="All 2 branches missed.">				while(nextCal.compareTo(endCal)&lt;=0){</span>
					
<span class="nc" id="L784">				collBean = new CollectionReportOverAllBean();</span>
<span class="nc" id="L785">				String AgentName=new Timestamp(nextCal.getTimeInMillis()).toString().split(&quot; &quot;)[0];//its date for this report</span>
<span class="nc" id="L786">				collBean.setAgtId(agtOrgId);</span>
				
<span class="nc" id="L788">				agtMap.put(AgentName, collBean);</span>
				
<span class="nc" id="L790">				nextCal.add(Calendar.DAY_OF_MONTH, 1);//increment the date</span>
				
<span class="nc" id="L792">				}</span>
			}
			
			
<span class="nc" id="L796">			collectionDateWise(startDate, endDate, con,agtMap,agtOrgId);</span>
			
<span class="nc" id="L798">			Iterator&lt;Map.Entry&lt;String, CollectionReportOverAllBean&gt;&gt; itr1 = agtMap</span>
			.entrySet().iterator();
<span class="nc bnc" id="L800" title="All 2 branches missed.">	while (itr1.hasNext()) {</span>
<span class="nc" id="L801">		Map.Entry&lt;String, CollectionReportOverAllBean&gt; pair = itr1</span>
				.next();
<span class="nc" id="L803">		CollectionReportOverAllBean bean = pair.getValue();</span>
<span class="nc" id="L804">		double openingBal = bean.getDgSale()</span>
		- bean.getDgCancel()
		- bean.getDgPwt()
		- bean.getDgDirPlyPwt()
		+ bean.getSeSale()
		- bean.getSeCancel()
		- bean.getSePwt()
		- bean.getSeDirPlyPwt()
		+ bean.getCSSale()
		- bean.getCSCancel()
		+ bean.getDeposit()
		- bean.getDepositRefund()
		- bean.getWithdrawal()
		- bean.getNetGamingComm()
		+ bean.getSleSale()
		- bean.getSleCancel()
		- bean.getSlePwt()
		- bean.getSleDirPlyPwt()
		+ bean.getIwSale()
		- bean.getIwCancel()
		- bean.getIwPwt()
		- bean.getIwDirPlyPwt()
		+ bean.getVsSale()
		- bean.getVsCancel()
		- bean.getVsPwt()
		- bean.getVsDirPlyPwt()
		- (bean.getCash() + bean.getCheque() + bean.getCredit()
				+ bean.getBankDep() - bean.getDebit() - bean
				.getChequeReturn()) + openingBalance;
<span class="nc" id="L833">		bean.setOpeningBal(openingBalance);</span>
<span class="nc" id="L834">		openingBalance = openingBal;</span>
<span class="nc" id="L835">	}</span>
			
			
			
<span class="nc" id="L839">		} catch (Exception e) {</span>
<span class="nc" id="L840">			e.printStackTrace();</span>
<span class="nc" id="L841">			throw new LMSException(</span>
					&quot;Error in report collectionAgentWiseWithOpeningBal&quot;);
		} finally {
<span class="nc" id="L844">			try {</span>
<span class="nc" id="L845">				con.close();</span>
<span class="nc" id="L846">			} catch (SQLException e) {</span>
<span class="nc" id="L847">				e.printStackTrace();</span>
<span class="nc" id="L848">			}</span>
<span class="nc" id="L849">		}</span>
<span class="nc" id="L850">		return agtMap;</span>
	}


	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>