<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CollectionReportOverAllHelperLagos.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lms</a> &gt; <a href="index.source.html" class="el_package">com.skilrock.lms.coreEngine.reportsMgmt.common</a> &gt; <span class="el_source">CollectionReportOverAllHelperLagos.java</span></div><h1>CollectionReportOverAllHelperLagos.java</h1><pre class="source lang-java linenums">package com.skilrock.lms.coreEngine.reportsMgmt.common;

import java.sql.CallableStatement;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Timestamp;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.HashMap;
import java.util.Iterator;
import java.util.LinkedHashMap;
import java.util.Map;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import com.skilrock.lms.beans.CollectionReportOverAllBean;
import com.skilrock.lms.beans.CompleteCollectionBean;
import com.skilrock.lms.common.db.DBConnect;
import com.skilrock.lms.common.exception.LMSException;
import com.skilrock.lms.common.filter.LMSFilterDispatcher;

<span class="nc" id="L25">public class CollectionReportOverAllHelperLagos {</span>
<span class="nc" id="L26">	static Log logger = LogFactory</span>
			.getLog(CollectionReportOverAllHelperLagos.class);

	public Map&lt;String, CollectionReportOverAllBean&gt; collectionAgentWiseWithOpeningBal(
			Timestamp deployDate, Timestamp startDate, Timestamp endDate,
			boolean isDG, boolean isSE, boolean isCS, boolean isOLA)
			throws LMSException {

<span class="nc" id="L34">		double totalOpnBal = 0.0;</span>
<span class="nc" id="L35">		String agtOrgQry = null;</span>

<span class="nc" id="L37">		Connection con = null;</span>
<span class="nc" id="L38">		ResultSet rsRetOrg = null;</span>
<span class="nc" id="L39">		PreparedStatement pstmt = null;</span>

<span class="nc" id="L41">		Map&lt;String, CollectionReportOverAllBean&gt; agtMap = null;</span>
<span class="nc" id="L42">		CollectionReportOverAllBean collBean = null;</span>

		try {
<span class="nc bnc" id="L45" title="All 2 branches missed.">			if (startDate.after(endDate))</span>
<span class="nc" id="L46">				return null;</span>

<span class="nc" id="L48">			con = DBConnect.getConnection();</span>
<span class="nc" id="L49">			agtMap = new LinkedHashMap&lt;String, CollectionReportOverAllBean&gt;();</span>
<span class="nc" id="L50">			agtOrgQry = &quot;select name,organization_id from st_lms_organization_master where organization_type='AGENT' order by name&quot;;</span>
<span class="nc" id="L51">			pstmt = con.prepareStatement(agtOrgQry);</span>
<span class="nc" id="L52">			rsRetOrg = pstmt.executeQuery();</span>
<span class="nc bnc" id="L53" title="All 2 branches missed.">			while (rsRetOrg.next()) {</span>
<span class="nc" id="L54">				collBean = new CollectionReportOverAllBean();</span>
<span class="nc" id="L55">				collBean.setAgentName(rsRetOrg.getString(&quot;name&quot;));</span>
<span class="nc" id="L56">				collBean.setOpeningBal(0.0);</span>
<span class="nc" id="L57">				collBean.setCash(0.0);</span>
<span class="nc" id="L58">				collBean.setCheque(0.0);</span>
<span class="nc" id="L59">				collBean.setChequeReturn(0.0);</span>
<span class="nc" id="L60">				collBean.setCredit(0.0);</span>
<span class="nc" id="L61">				collBean.setDebit(0.0);</span>
<span class="nc" id="L62">				collBean.setBankDep(0.0);</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">				if (isDG) {</span>
<span class="nc" id="L64">					collBean.setDgSale(0.0);</span>
<span class="nc" id="L65">					collBean.setDgPwt(0.0);</span>
<span class="nc" id="L66">					collBean.setDgCancel(0.0);</span>
<span class="nc" id="L67">					collBean.setDgDirPlyPwt(0.0);</span>
				}
<span class="nc bnc" id="L69" title="All 2 branches missed.">				if (isSE) {</span>
<span class="nc" id="L70">					collBean.setSeSale(0.0);</span>
<span class="nc" id="L71">					collBean.setSePwt(0.0);</span>
<span class="nc" id="L72">					collBean.setSeDirPlyPwt(0.0);</span>
				}
<span class="nc bnc" id="L74" title="All 2 branches missed.">				if (isCS) {</span>
<span class="nc" id="L75">					collBean.setCSSale(0.0);</span>
<span class="nc" id="L76">					collBean.setCSCancel(0.0);</span>
				}
<span class="nc bnc" id="L78" title="All 2 branches missed.">				if (isOLA) {</span>
<span class="nc" id="L79">					collBean.setDeposit(0.0);</span>
<span class="nc" id="L80">					collBean.setDepositRefund(0.0);</span>
<span class="nc" id="L81">					collBean.setWithdrawal(0.0);</span>
<span class="nc" id="L82">					collBean.setWithdrawalRefund(0.0);</span>
<span class="nc" id="L83">					collBean.setNetGamingComm(0.0);</span>
				}
<span class="nc" id="L85">				agtMap.put(rsRetOrg.getString(&quot;organization_id&quot;), collBean);</span>
			}

			// for calculation of opening Balance
<span class="nc" id="L89">			collectionAgentWiseLagos(deployDate, new Timestamp(startDate</span>
					.getTime() - 1000), con, isDG, isSE, isCS, isOLA, agtMap);
<span class="nc" id="L91">			Iterator&lt;Map.Entry&lt;String, CollectionReportOverAllBean&gt;&gt; itr = agtMap</span>
					.entrySet().iterator();
<span class="nc" id="L93">			double totalNetPymnts = 0.0;</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">			while (itr.hasNext()) {</span>
<span class="nc" id="L95">				Map.Entry&lt;String, CollectionReportOverAllBean&gt; pair = itr</span>
						.next();
<span class="nc" id="L97">				CollectionReportOverAllBean bean = pair.getValue();</span>
<span class="nc" id="L98">				double netPymnts = -bean.getCash() - bean.getCheque()</span>
						- bean.getCredit() - bean.getBankDep()
						+ bean.getDebit() + bean.getChequeReturn();

<span class="nc" id="L102">				totalNetPymnts += netPymnts;</span>
<span class="nc" id="L103">				double openingBal = bean.getDgSale()</span>
						- bean.getDgCancel()
						- bean.getDgPwt()
						- bean.getDgDirPlyPwt()
						+ bean.getSeSale()
						- bean.getSePwt()
						- bean.getSeDirPlyPwt()
						+ bean.getCSSale()
						- bean.getCSCancel()
						+ bean.getDeposit()
						- bean.getDepositRefund()
						- bean.getWithdrawal()
						- bean.getNetGamingComm()
						- (bean.getCash() + bean.getCheque() + bean.getCredit()
								+ bean.getBankDep() - bean.getDebit() - bean
								.getChequeReturn());
<span class="nc" id="L119">				totalOpnBal += openingBal;</span>
<span class="nc" id="L120">				bean.setOpeningBal(0.0);</span>
<span class="nc" id="L121">				bean.setNetPayments(0.0);</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">				if (isDG) {</span>
<span class="nc" id="L123">					bean.setDgSale(0.0);</span>
<span class="nc" id="L124">					bean.setDgPwt(0.0);</span>
<span class="nc" id="L125">					bean.setDgCancel(0.0);</span>
<span class="nc" id="L126">					bean.setDgDirPlyPwt(0.0);</span>
				}
<span class="nc bnc" id="L128" title="All 2 branches missed.">				if (isSE) {</span>
<span class="nc" id="L129">					bean.setSeSale(0.0);</span>
<span class="nc" id="L130">					bean.setSePwt(0.0);</span>
<span class="nc" id="L131">					bean.setSeDirPlyPwt(0.0);</span>
				}
<span class="nc bnc" id="L133" title="All 2 branches missed.">				if (isCS) {</span>
<span class="nc" id="L134">					bean.setCSSale(0.0);</span>
<span class="nc" id="L135">					bean.setCSCancel(0.0);</span>
				}
<span class="nc bnc" id="L137" title="All 2 branches missed.">				if (isOLA) {</span>
<span class="nc" id="L138">					collBean.setDeposit(0.0);</span>
<span class="nc" id="L139">					collBean.setDepositRefund(0.0);</span>
<span class="nc" id="L140">					collBean.setWithdrawal(0.0);</span>
<span class="nc" id="L141">					collBean.setWithdrawalRefund(0.0);</span>
<span class="nc" id="L142">					collBean.setNetGamingComm(0.0);</span>
				}

<span class="nc" id="L145">				bean.setOpeningBal(openingBal);</span>
<span class="nc" id="L146">				bean.setNetPayments(netPymnts);</span>
<span class="nc" id="L147">			}</span>
<span class="nc" id="L148">			collBean = new CollectionReportOverAllBean();</span>
<span class="nc" id="L149">			collBean.setAgentName(&quot;Total&quot;);</span>
<span class="nc" id="L150">			collBean.setOpeningBal(0.0);</span>
<span class="nc" id="L151">			collBean.setCash(0.0);</span>
<span class="nc" id="L152">			collBean.setCheque(0.0);</span>
<span class="nc" id="L153">			collBean.setChequeReturn(0.0);</span>
<span class="nc" id="L154">			collBean.setCredit(0.0);</span>
<span class="nc" id="L155">			collBean.setDebit(0.0);</span>
<span class="nc" id="L156">			collBean.setBankDep(0.0);</span>
<span class="nc" id="L157">			collBean.setNetPayments(totalNetPymnts);</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">			if (isDG) {</span>
<span class="nc" id="L159">				collBean.setDgSale(0.0);</span>
<span class="nc" id="L160">				collBean.setDgPwt(0.0);</span>
<span class="nc" id="L161">				collBean.setDgCancel(0.0);</span>
<span class="nc" id="L162">				collBean.setDgDirPlyPwt(0.0);</span>
			}
<span class="nc bnc" id="L164" title="All 2 branches missed.">			if (isSE) {</span>
<span class="nc" id="L165">				collBean.setSeSale(0.0);</span>
<span class="nc" id="L166">				collBean.setSePwt(0.0);</span>
<span class="nc" id="L167">				collBean.setSeDirPlyPwt(0.0);</span>
			}
<span class="nc bnc" id="L169" title="All 2 branches missed.">			if (isCS) {</span>
<span class="nc" id="L170">				collBean.setCSSale(0.0);</span>
<span class="nc" id="L171">				collBean.setCSCancel(0.0);</span>
			}
<span class="nc bnc" id="L173" title="All 2 branches missed.">			if (isOLA) {</span>
<span class="nc" id="L174">				collBean.setDeposit(0.0);</span>
<span class="nc" id="L175">				collBean.setDepositRefund(0.0);</span>
<span class="nc" id="L176">				collBean.setWithdrawal(0.0);</span>
<span class="nc" id="L177">				collBean.setWithdrawalRefund(0.0);</span>
<span class="nc" id="L178">				collBean.setNetGamingComm(0.0);</span>
			}
<span class="nc" id="L180">			collBean.setOpeningBal(totalOpnBal);</span>
<span class="nc" id="L181">			collBean.setNetPayments(totalNetPymnts);</span>
<span class="nc" id="L182">			agtMap.put(&quot;9999999999&quot;, collBean);</span>

<span class="nc" id="L184">			collectionAgentWiseExpandLagos(startDate, endDate, con, isDG, isSE,</span>
					isCS, isOLA, agtMap);
<span class="nc" id="L186">		} catch (Exception e) {</span>
<span class="nc" id="L187">			e.printStackTrace();</span>
<span class="nc" id="L188">			throw new LMSException(</span>
					&quot;Error in report collectionAgentWiseWithOpeningBal&quot;);
		} finally {
<span class="nc" id="L191">			try {</span>
<span class="nc" id="L192">				pstmt.close();</span>
<span class="nc" id="L193">			} catch (SQLException e) {</span>
<span class="nc" id="L194">				e.printStackTrace();</span>
<span class="nc" id="L195">			}</span>
			try {
<span class="nc" id="L197">				rsRetOrg.close();</span>
<span class="nc" id="L198">			} catch (SQLException e) {</span>
<span class="nc" id="L199">				e.printStackTrace();</span>
<span class="nc" id="L200">			}</span>
			try {
<span class="nc" id="L202">				con.close();</span>
<span class="nc" id="L203">			} catch (SQLException e) {</span>
<span class="nc" id="L204">				e.printStackTrace();</span>
<span class="nc" id="L205">			}</span>
<span class="nc" id="L206">		}</span>
<span class="nc" id="L207">		return agtMap;</span>
	}

	public void collectionAgentWiseLagos(Timestamp startDate,
			Timestamp endDate, Connection con, boolean isDG, boolean isSE,
			boolean isCS, boolean isOLA,
			Map&lt;String, CollectionReportOverAllBean&gt; agtMap)
			throws LMSException {

<span class="nc" id="L216">		ResultSet rs = null;</span>
<span class="nc" id="L217">		ResultSet rsGame = null;</span>
<span class="nc" id="L218">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L219">		CallableStatement cstmt = null;</span>
<span class="nc" id="L220">		PreparedStatement gamePstmt = null;</span>

		try {
<span class="nc bnc" id="L223" title="All 2 branches missed.">			if (startDate.after(endDate)) {</span>
<span class="nc" id="L224">				return;</span>
			}

			// Get Account Details
<span class="nc" id="L228">			cstmt = con.prepareCall(&quot;call collectionCashChqOverAll(?,?)&quot;);</span>
<span class="nc" id="L229">			cstmt.setTimestamp(1, startDate);</span>
<span class="nc" id="L230">			cstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L231">			rs = cstmt.executeQuery();</span>

<span class="nc bnc" id="L233" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L234">				String agtOrgId = rs.getString(&quot;organization_id&quot;);</span>
<span class="nc" id="L235">				agtMap.get(agtOrgId).setCash(rs.getDouble(&quot;cash&quot;));</span>
<span class="nc" id="L236">				agtMap.get(agtOrgId).setCheque(rs.getDouble(&quot;chq&quot;));</span>
<span class="nc" id="L237">				agtMap.get(agtOrgId).setChequeReturn(rs.getDouble(&quot;chq_ret&quot;));</span>
<span class="nc" id="L238">				agtMap.get(agtOrgId).setCredit(rs.getDouble(&quot;credit&quot;));</span>
<span class="nc" id="L239">				agtMap.get(agtOrgId).setDebit(rs.getDouble(&quot;debit&quot;));</span>
<span class="nc" id="L240">				agtMap.get(agtOrgId).setBankDep(rs.getDouble(&quot;bank&quot;));</span>
<span class="nc" id="L241">			}</span>

<span class="nc bnc" id="L243" title="All 2 branches missed.">			if (isDG) {</span>
				// Game Master Query
<span class="nc" id="L245">				String gameQry = &quot;select game_id from st_dg_game_master&quot;;</span>
<span class="nc" id="L246">				gamePstmt = con.prepareStatement(gameQry);</span>
<span class="nc" id="L247">				rsGame = gamePstmt.executeQuery();</span>

<span class="nc bnc" id="L249" title="All 2 branches missed.">				while (rsGame.next()) {</span>
<span class="nc" id="L250">					int gameNo = rsGame.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L251">					cstmt = con</span>
							.prepareCall(&quot;call drawCollectionAgentWisePerGame(?,?,?)&quot;);
<span class="nc" id="L253">					cstmt.setTimestamp(1, startDate);</span>
<span class="nc" id="L254">					cstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L255">					cstmt.setInt(3, gameNo);</span>
<span class="nc" id="L256">					rs = cstmt.executeQuery();</span>
<span class="nc" id="L257">					String agtOrgId = null;</span>
<span class="nc" id="L258">					double sale = 0, cancel = 0, pwt = 0;</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L260">						agtOrgId = rs.getString(&quot;parent_id&quot;);</span>
<span class="nc" id="L261">						sale = rs.getDouble(&quot;sale&quot;);</span>
<span class="nc" id="L262">						cancel = rs.getDouble(&quot;cancel&quot;);</span>
<span class="nc" id="L263">						pwt = rs.getDouble(&quot;pwt&quot;);</span>
<span class="nc" id="L264">						agtMap.get(agtOrgId).setDgSale(</span>
								agtMap.get(agtOrgId).getDgSale() + sale);
<span class="nc" id="L266">						agtMap.get(agtOrgId).setDgCancel(</span>
								agtMap.get(agtOrgId).getDgCancel() + cancel);
<span class="nc" id="L268">						agtMap.get(agtOrgId).setDgPwt(</span>
								agtMap.get(agtOrgId).getDgPwt() + pwt);
<span class="nc" id="L270">						agtMap.get(agtOrgId).setDgDirPlyPwt(</span>
								agtMap.get(agtOrgId).getDgDirPlyPwt()
										+ rs.getDouble(&quot;pwtDir&quot;));
					}
<span class="nc" id="L274">				}</span>
<span class="nc" id="L275">				gamePstmt.close();</span>
<span class="nc" id="L276">				rsGame.close();</span>
			}
<span class="nc bnc" id="L278" title="All 2 branches missed.">			if (isSE) {</span>
				// Game Master Query
<span class="nc" id="L280">				String gameQry = &quot;select game_id from st_se_game_master&quot;;</span>
<span class="nc" id="L281">				gamePstmt = con.prepareStatement(gameQry);</span>
<span class="nc" id="L282">				rsGame = gamePstmt.executeQuery();</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">				while (rsGame.next()) {</span>
<span class="nc" id="L284">					int gameNo = rsGame.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L285">					cstmt = con</span>
							.prepareCall(&quot;call scratchCollectionAgentWisePerGame(?,?,?)&quot;);
<span class="nc" id="L287">					cstmt.setTimestamp(1, startDate);</span>
<span class="nc" id="L288">					cstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L289">					cstmt.setInt(3, gameNo);</span>
<span class="nc" id="L290">					rs = cstmt.executeQuery();</span>
<span class="nc" id="L291">					String agtOrgId = null;</span>
<span class="nc" id="L292">					double sale = 0, cancel = 0, pwt = 0;</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L294">						agtOrgId = rs.getString(&quot;organization_id&quot;);</span>
<span class="nc" id="L295">						sale = rs.getDouble(&quot;sale&quot;);</span>
<span class="nc" id="L296">						cancel = rs.getDouble(&quot;cancel&quot;);</span>
<span class="nc" id="L297">						pwt = rs.getDouble(&quot;pwt&quot;);</span>
<span class="nc" id="L298">						agtMap.get(agtOrgId).setSeSale(</span>
								agtMap.get(agtOrgId).getSeSale()
										+ (sale - cancel));
<span class="nc" id="L301">						agtMap.get(agtOrgId).setSePwt(</span>
								agtMap.get(agtOrgId).getSePwt() + pwt);
<span class="nc" id="L303">						agtMap.get(agtOrgId).setSeDirPlyPwt(</span>
								agtMap.get(agtOrgId).getSeDirPlyPwt()
										+ rs.getDouble(&quot;pwtDir&quot;));
					}
<span class="nc" id="L307">				}</span>
<span class="nc" id="L308">				gamePstmt.close();</span>
<span class="nc" id="L309">				rsGame.close();</span>
			}
<span class="nc bnc" id="L311" title="All 2 branches missed.">			if (isCS) {</span>
				// Category Master Query
<span class="nc" id="L313">				String catQry = &quot;select category_id from st_cs_product_category_master where status = 'ACTIVE'&quot;;</span>
<span class="nc" id="L314">				gamePstmt = con.prepareStatement(catQry);</span>
<span class="nc" id="L315">				rsGame = gamePstmt.executeQuery();</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">				while (rsGame.next()) {</span>
<span class="nc" id="L317">					int catId = rsGame.getInt(&quot;category_id&quot;);</span>
<span class="nc" id="L318">					cstmt = con</span>
							.prepareCall(&quot;call csCollectionAgentWisePerCategory(?,?,?)&quot;);
<span class="nc" id="L320">					cstmt.setTimestamp(1, startDate);</span>
<span class="nc" id="L321">					cstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L322">					cstmt.setInt(3, catId);</span>
<span class="nc" id="L323">					logger.debug(&quot;-------CS Sale Query------\n&quot; + cstmt);</span>
<span class="nc" id="L324">					rs = cstmt.executeQuery();</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L326">						agtMap.get(rs.getString(&quot;parent_id&quot;)).setCSSale(</span>
								agtMap.get(rs.getString(&quot;parent_id&quot;))
										.getCSSale()
										+ rs.getDouble(&quot;sale&quot;));
<span class="nc" id="L330">						agtMap.get(rs.getString(&quot;parent_id&quot;)).setCSCancel(</span>
								agtMap.get(rs.getString(&quot;parent_id&quot;))
										.getCSCancel()
										+ rs.getDouble(&quot;cancel&quot;));
					}
<span class="nc" id="L335">				}</span>
<span class="nc" id="L336">				gamePstmt.close();</span>
<span class="nc" id="L337">				rsGame.close();</span>
			}
<span class="nc bnc" id="L339" title="All 2 branches missed.">			if (isOLA) {</span>

<span class="nc" id="L341">				StringBuilder olaQuery = new StringBuilder(</span>
						&quot;select WID.agtOrgId, wdraw,wdrawRef,depoAmt,depoRefAmt,netAmt from (select om.parent_id agtOrgId, ifnull(sum(wd), 0.0) wdraw from (select wrs.retailer_org_id, agent_net_amt as wd from st_ola_ret_withdrawl wrs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type = 'OLA_WITHDRAWL' and transaction_date&gt;='&quot;
								+ startDate
								+ &quot;' and transaction_date&lt;='&quot;
								+ endDate
								+ &quot;')) wdret right outer join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on om.organization_id = wdret.retailer_org_id group by om.parent_id)WID, (select om.parent_id agtOrgId, ifnull(sum(wdRef), 0.0) wdrawRef from (select wrs.retailer_org_id, agent_net_amt as wdRef from st_ola_ret_withdrawl_refund wrs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type = 'OLA_WITHDRAWL_REFUND' and transaction_date&gt;='&quot;
								+ startDate
								+ &quot;' and transaction_date&lt;='&quot;
								+ endDate
								+ &quot;')) wdret right outer join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on om.organization_id = wdret.retailer_org_id group by om.parent_id)WIDREF,(select om.parent_id agtOrgId, ifnull(sum(depo), 0.0) depoAmt from (select wrs.retailer_org_id, agent_net_amt as depo from st_ola_ret_deposit wrs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type = 'OLA_DEPOSIT' and transaction_date&gt;='&quot;
								+ startDate
								+ &quot;' and transaction_date&lt;='&quot;
								+ endDate
								+ &quot;')) wdret right outer join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on om.organization_id = wdret.retailer_org_id group by om.parent_id)DEP,(select om.parent_id agtOrgId, ifnull(sum(depoRef), 0.0) depoRefAmt from (select wrs.retailer_org_id, agent_net_amt as depoRef from st_ola_ret_deposit_refund wrs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type = 'OLA_DEPOSIT_REFUND' and transaction_date&gt;='&quot;
								+ startDate
								+ &quot;' and transaction_date&lt;='&quot;
								+ endDate
								+ &quot;')) wdret right outer join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on om.organization_id = wdret.retailer_org_id group by om.parent_id)DEPREF,(select om.parent_id agtOrgId, ifnull(sum(netGamingAmt), 0.0) netAmt from(select wrs.retailer_org_id, agt_net_claim_comm as netGamingAmt from st_ola_ret_comm wrs inner join st_lms_retailer_transaction_master rt on wrs.transaction_id=rt.transaction_id where transaction_type = 'OLA_COMMISSION' and transaction_date&gt;='&quot;
								+ startDate
								+ &quot;' and transaction_date&lt;='&quot;
								+ endDate
								+ &quot;') wdret right outer join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on om.organization_id = wdret.retailer_org_id group by om.parent_id)NETGAME where WID.agtOrgId=WIDREF.agtOrgId and WIDREF.agtOrgId =DEP.agtOrgId and DEP.agtOrgId =DEPREF.agtOrgId and DEPREF.agtOrgId=NETGAME.agtOrgId and NETGAME.agtOrgId=WID.agtOrgId&quot;);

<span class="nc" id="L364">				StringBuilder unionQuery = null;</span>
<span class="nc" id="L365">				StringBuilder mainQuery = null;</span>

<span class="nc bnc" id="L367" title="All 2 branches missed.">				if (LMSFilterDispatcher.isRepFrmSP) {</span>
<span class="nc" id="L368">					mainQuery = new StringBuilder(</span>
							&quot;select agtOrgId,sum(wdraw) wdraw,sum(wdrawRef) wdrawRef,sum(depoAmt) depoAmt,sum(depoRefAmt)depoRefAmt,sum(netAmt) netAmt from (&quot;);
<span class="nc" id="L370">					unionQuery = new StringBuilder(</span>
							&quot; union all select parent_id agtOrgId , sum(withdrawal_net_amt) wdraw , sum(ref_withdrawal_net_amt) wdrawRef , sum(deposit_net) depoAmt  , sum(ref_deposit_net_amt) depoRefAmt, sum(net_gaming_net_comm) netAmt from st_rep_ola_retailer where finaldate&gt;='&quot;
									+ startDate
									+ &quot;' and finaldate&lt;='&quot;
									+ endDate
									+ &quot;' group by parent_id) repTable group by agtOrgId&quot;);
<span class="nc" id="L376">					mainQuery.append(olaQuery.toString()).append(</span>
							unionQuery.toString());
<span class="nc" id="L378">					pstmt = con.prepareStatement(mainQuery.toString());</span>
				} else {
<span class="nc" id="L380">					pstmt = con.prepareStatement(olaQuery.toString());</span>
				}
<span class="nc" id="L382">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L383" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L384">					agtMap.get(rs.getString(&quot;agtOrgId&quot;)).setWithdrawal(</span>
							rs.getDouble(&quot;wdraw&quot;));
<span class="nc" id="L386">					agtMap.get(rs.getString(&quot;agtOrgId&quot;)).setWithdrawalRefund(</span>
							rs.getDouble(&quot;wdrawRef&quot;));
<span class="nc" id="L388">					agtMap.get(rs.getString(&quot;agtOrgId&quot;)).setDeposit(</span>
							rs.getDouble(&quot;depoAmt&quot;));
<span class="nc" id="L390">					agtMap.get(rs.getString(&quot;agtOrgId&quot;)).setDepositRefund(</span>
							rs.getDouble(&quot;depoRefAmt&quot;));
<span class="nc" id="L392">					agtMap.get(rs.getString(&quot;agtOrgId&quot;)).setNetGamingComm(</span>
							rs.getDouble(&quot;netAmt&quot;));
				}
			}

<span class="nc" id="L397">		} catch (Exception e) {</span>
<span class="nc" id="L398">			e.printStackTrace();</span>
<span class="nc" id="L399">			throw new LMSException(&quot;Error in report collectionAgentWise&quot;);</span>
<span class="nc" id="L400">		}</span>
<span class="nc" id="L401">	}</span>

	public void collectionAgentWiseExpandLagos(Timestamp startDate,
			Timestamp endDate, Connection con, boolean isDG, boolean isSE,
			boolean isCS, boolean isOLA,
			Map&lt;String, CollectionReportOverAllBean&gt; agtMap)
			throws LMSException {

<span class="nc" id="L409">		double totalNetPymnts = 0.0;</span>

<span class="nc" id="L411">		ResultSet rs = null;</span>
<span class="nc" id="L412">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L413">		CallableStatement cstmt = null;</span>

<span class="nc" id="L415">		CompleteCollectionBean gameBean = null;</span>
<span class="nc" id="L416">		CollectionReportOverAllBean agentBean = null;</span>

		try {

			// Get Account Details
<span class="nc" id="L421">			cstmt = con.prepareCall(&quot;call collectionCashChqOverAll(?,?)&quot;);</span>
<span class="nc" id="L422">			cstmt.setTimestamp(1, startDate);</span>
<span class="nc" id="L423">			cstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L424">			rs = cstmt.executeQuery();</span>

<span class="nc bnc" id="L426" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L427">				double netPymnts = 0.0;</span>
<span class="nc" id="L428">				String agtOrgId = rs.getString(&quot;organization_id&quot;);</span>
<span class="nc" id="L429">				agentBean = agtMap.get(agtOrgId);</span>
<span class="nc bnc" id="L430" title="All 2 branches missed.">				if (agentBean != null) {</span>
<span class="nc" id="L431">					netPymnts = rs.getDouble(&quot;cash&quot;) + rs.getDouble(&quot;chq&quot;)</span>
							+ rs.getDouble(&quot;credit&quot;) + rs.getDouble(&quot;bank&quot;)
							- rs.getDouble(&quot;debit&quot;) - rs.getDouble(&quot;chq_ret&quot;);
<span class="nc" id="L434">					totalNetPymnts += netPymnts;</span>
<span class="nc" id="L435">					agtMap.get(agtOrgId).setNetPayments(netPymnts);</span>
				}
<span class="nc" id="L437">			}</span>
<span class="nc" id="L438">			agtMap.get(&quot;9999999999&quot;).setNetPayments(totalNetPymnts);</span>
<span class="nc bnc" id="L439" title="All 2 branches missed.">			if (isDG) {</span>
				// Game Master Query
<span class="nc" id="L441">				String gameQry = &quot;select game_id,game_name from st_dg_game_master&quot;;</span>
<span class="nc" id="L442">				PreparedStatement gamePstmt = con.prepareStatement(gameQry);</span>
<span class="nc" id="L443">				ResultSet rsGame = gamePstmt.executeQuery();</span>
<span class="nc bnc" id="L444" title="All 2 branches missed.">				while (rsGame.next()) {</span>
<span class="nc" id="L445">					double totalSale = 0.0;</span>
<span class="nc" id="L446">					double totalCancel = 0.0;</span>
<span class="nc" id="L447">					double totalPwt = 0.0;</span>
<span class="nc" id="L448">					double totalDPlrpwt = 0.0;</span>
<span class="nc" id="L449">					int gameId = rsGame.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L450">					String gameName = rsGame.getString(&quot;game_name&quot;);</span>
<span class="nc" id="L451">					cstmt = con</span>
							.prepareCall(&quot;call drawCollectionAgentWisePerGame(?,?,?)&quot;);
<span class="nc" id="L453">					cstmt.setTimestamp(1, startDate);</span>
<span class="nc" id="L454">					cstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L455">					cstmt.setInt(3, gameId);</span>
<span class="nc" id="L456">					logger.debug(&quot;-------Indivisual Game Qry-------\n&quot; + cstmt);</span>
<span class="nc" id="L457">					rs = cstmt.executeQuery();</span>
<span class="nc bnc" id="L458" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L459">						String agtOrgId = rs.getString(&quot;parent_id&quot;);</span>
<span class="nc" id="L460">						agentBean = agtMap.get(agtOrgId);</span>
<span class="nc bnc" id="L461" title="All 2 branches missed.">						if (agentBean != null) {</span>
<span class="nc" id="L462">							Map&lt;String, CompleteCollectionBean&gt; gameMap = agentBean</span>
									.getGameBeanMap();
<span class="nc bnc" id="L464" title="All 2 branches missed.">							if (gameMap == null) {</span>
<span class="nc" id="L465">								gameMap = new HashMap&lt;String, CompleteCollectionBean&gt;();</span>
<span class="nc" id="L466">								agentBean.setGameBeanMap(gameMap);</span>
							}
<span class="nc" id="L468">							gameBean = gameMap.get(gameName);</span>
<span class="nc bnc" id="L469" title="All 2 branches missed.">							if (gameBean == null) {</span>
<span class="nc" id="L470">								gameBean = new CompleteCollectionBean();</span>
<span class="nc" id="L471">								gameMap.put(gameName, gameBean);</span>
							}
<span class="nc" id="L473">							totalSale += rs.getDouble(&quot;sale&quot;);</span>
<span class="nc" id="L474">							totalCancel += rs.getDouble(&quot;cancel&quot;);</span>
<span class="nc" id="L475">							totalPwt += rs.getDouble(&quot;pwt&quot;);</span>
<span class="nc" id="L476">							totalDPlrpwt += rs.getDouble(&quot;pwtDir&quot;);</span>
<span class="nc" id="L477">							gameBean.setOrgName(gameName);</span>
<span class="nc" id="L478">							gameBean.setDrawSale(rs.getDouble(&quot;sale&quot;));</span>
<span class="nc" id="L479">							gameBean.setDrawCancel(rs.getDouble(&quot;cancel&quot;));</span>
<span class="nc" id="L480">							gameBean.setDrawPwt(rs.getDouble(&quot;pwt&quot;));</span>
<span class="nc" id="L481">							gameBean.setDrawDirPlyPwt(rs.getDouble(&quot;pwtDir&quot;));</span>
						}
<span class="nc" id="L483">					}</span>
<span class="nc" id="L484">					agentBean = agtMap.get(&quot;9999999999&quot;);</span>
<span class="nc" id="L485">					Map&lt;String, CompleteCollectionBean&gt; gameMap = agentBean</span>
							.getGameBeanMap();
<span class="nc bnc" id="L487" title="All 2 branches missed.">					if (gameMap == null) {</span>
<span class="nc" id="L488">						gameMap = new HashMap&lt;String, CompleteCollectionBean&gt;();</span>
<span class="nc" id="L489">						agentBean.setGameBeanMap(gameMap);</span>
					}
<span class="nc" id="L491">					gameBean = gameMap.get(gameName);</span>
<span class="nc bnc" id="L492" title="All 2 branches missed.">					if (gameBean == null) {</span>
<span class="nc" id="L493">						gameBean = new CompleteCollectionBean();</span>
<span class="nc" id="L494">						gameMap.put(gameName, gameBean);</span>
					}
<span class="nc" id="L496">					gameBean.setOrgName(gameName);</span>
<span class="nc" id="L497">					gameBean.setDrawSale(totalSale);</span>
<span class="nc" id="L498">					gameBean.setDrawCancel(totalCancel);</span>
<span class="nc" id="L499">					gameBean.setDrawPwt(totalPwt);</span>
<span class="nc" id="L500">					gameBean.setDrawDirPlyPwt(totalDPlrpwt);</span>

<span class="nc" id="L502">				}</span>
			}
<span class="nc bnc" id="L504" title="All 2 branches missed.">			if (isSE) {</span>
				// Game Master Query
<span class="nc" id="L506">				String gameQry = &quot;select game_id,game_name from st_se_game_master&quot;;</span>
<span class="nc" id="L507">				PreparedStatement gamePstmt = con.prepareStatement(gameQry);</span>
<span class="nc" id="L508">				ResultSet rsGame = gamePstmt.executeQuery();</span>
<span class="nc bnc" id="L509" title="All 2 branches missed.">				while (rsGame.next()) {</span>
<span class="nc" id="L510">					double totalSale = 0.0;</span>
<span class="nc" id="L511">					double totalCancel = 0.0;</span>
<span class="nc" id="L512">					double totalPwt = 0.0;</span>
<span class="nc" id="L513">					double totalDPlrpwt = 0.0;</span>
<span class="nc" id="L514">					int gameId = rsGame.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L515">					String gameName = rsGame.getString(&quot;game_name&quot;);</span>
<span class="nc" id="L516">					cstmt = con</span>
							.prepareCall(&quot;call scratchCollectionAgentWisePerGame(?,?,?)&quot;);
<span class="nc" id="L518">					cstmt.setTimestamp(1, startDate);</span>
<span class="nc" id="L519">					cstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L520">					cstmt.setInt(3, gameId);</span>
<span class="nc" id="L521">					logger.debug(&quot;-------Indivisual Game Qry-------\n&quot; + cstmt);</span>
<span class="nc" id="L522">					rs = cstmt.executeQuery();</span>
<span class="nc bnc" id="L523" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L524">						String agtOrgId = rs.getString(&quot;organization_id&quot;);</span>
<span class="nc" id="L525">						agentBean = agtMap.get(agtOrgId);</span>
<span class="nc bnc" id="L526" title="All 2 branches missed.">						if (agentBean != null) {</span>
<span class="nc" id="L527">							Map&lt;String, CompleteCollectionBean&gt; gameMap = agentBean</span>
									.getGameBeanMap();
<span class="nc bnc" id="L529" title="All 2 branches missed.">							if (gameMap == null) {</span>
<span class="nc" id="L530">								gameMap = new HashMap&lt;String, CompleteCollectionBean&gt;();</span>
<span class="nc" id="L531">								agentBean.setGameBeanMap(gameMap);</span>
							}
<span class="nc" id="L533">							gameBean = gameMap.get(gameName);</span>
<span class="nc bnc" id="L534" title="All 2 branches missed.">							if (gameBean == null) {</span>
<span class="nc" id="L535">								gameBean = new CompleteCollectionBean();</span>
<span class="nc" id="L536">								gameMap.put(gameName, gameBean);</span>
							}
<span class="nc" id="L538">							totalSale += rs.getDouble(&quot;sale&quot;);</span>
<span class="nc" id="L539">							totalCancel += rs.getDouble(&quot;cancel&quot;);</span>
<span class="nc" id="L540">							totalPwt += rs.getDouble(&quot;pwt&quot;);</span>
<span class="nc" id="L541">							totalDPlrpwt += rs.getDouble(&quot;pwtDir&quot;);</span>
<span class="nc" id="L542">							gameBean.setOrgName(gameName);</span>
<span class="nc" id="L543">							gameBean.setDrawSale(rs.getDouble(&quot;sale&quot;));</span>
<span class="nc" id="L544">							gameBean.setDrawCancel(rs.getDouble(&quot;cancel&quot;));</span>
<span class="nc" id="L545">							gameBean.setDrawPwt(rs.getDouble(&quot;pwt&quot;));</span>
<span class="nc" id="L546">							gameBean.setDrawDirPlyPwt(rs.getDouble(&quot;pwtDir&quot;));</span>
						}
<span class="nc" id="L548">					}</span>
<span class="nc" id="L549">					agentBean = agtMap.get(&quot;9999999999&quot;);</span>
<span class="nc" id="L550">					Map&lt;String, CompleteCollectionBean&gt; gameMap = agentBean</span>
							.getGameBeanMap();
<span class="nc bnc" id="L552" title="All 2 branches missed.">					if (gameMap == null) {</span>
<span class="nc" id="L553">						gameMap = new HashMap&lt;String, CompleteCollectionBean&gt;();</span>
<span class="nc" id="L554">						agentBean.setGameBeanMap(gameMap);</span>
					}
<span class="nc" id="L556">					gameBean = gameMap.get(gameName);</span>
<span class="nc bnc" id="L557" title="All 2 branches missed.">					if (gameBean == null) {</span>
<span class="nc" id="L558">						gameBean = new CompleteCollectionBean();</span>
<span class="nc" id="L559">						gameMap.put(gameName, gameBean);</span>
					}
<span class="nc" id="L561">					gameBean.setOrgName(gameName);</span>
<span class="nc" id="L562">					gameBean.setDrawSale(totalSale);</span>
<span class="nc" id="L563">					gameBean.setDrawCancel(totalCancel);</span>
<span class="nc" id="L564">					gameBean.setDrawPwt(totalPwt);</span>
<span class="nc" id="L565">					gameBean.setDrawDirPlyPwt(totalDPlrpwt);</span>
<span class="nc" id="L566">				}</span>
			}
<span class="nc bnc" id="L568" title="All 2 branches missed.">			if (isCS) {</span>
				// Category Master Query
<span class="nc" id="L570">				String prodQry = &quot;select category_id,category_code from st_cs_product_category_master&quot;;</span>
<span class="nc" id="L571">				PreparedStatement prodPstmt = con.prepareStatement(prodQry);</span>
<span class="nc" id="L572">				ResultSet rsProd = prodPstmt.executeQuery();</span>
<span class="nc bnc" id="L573" title="All 2 branches missed.">				while (rsProd.next()) {</span>
<span class="nc" id="L574">					double totalSale = 0.0;</span>
<span class="nc" id="L575">					double totalCancel = 0.0;</span>
<span class="nc" id="L576">					int catId = rsProd.getInt(&quot;category_id&quot;);</span>
<span class="nc" id="L577">					String catName = rsProd.getString(&quot;category_code&quot;);</span>
<span class="nc" id="L578">					cstmt = con</span>
							.prepareCall(&quot;call csCollectionAgentWisePerGame(?,?,?)&quot;);
<span class="nc" id="L580">					cstmt.setTimestamp(1, startDate);</span>
<span class="nc" id="L581">					cstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L582">					cstmt.setInt(3, catId);</span>
<span class="nc" id="L583">					logger.debug(&quot;-------Indivisual Category Qry-------\n&quot;</span>
							+ cstmt);
<span class="nc" id="L585">					rs = cstmt.executeQuery();</span>
<span class="nc bnc" id="L586" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L587">						String agtOrgId = rs.getString(&quot;parent_id&quot;);</span>
<span class="nc" id="L588">						agentBean = agtMap.get(agtOrgId);</span>
<span class="nc bnc" id="L589" title="All 2 branches missed.">						if (agentBean != null) {</span>
<span class="nc" id="L590">							Map&lt;String, CompleteCollectionBean&gt; gameMap = agentBean</span>
									.getGameBeanMap();
<span class="nc bnc" id="L592" title="All 2 branches missed.">							if (gameMap == null) {</span>
<span class="nc" id="L593">								gameMap = new HashMap&lt;String, CompleteCollectionBean&gt;();</span>
<span class="nc" id="L594">								agentBean.setGameBeanMap(gameMap);</span>
							}
<span class="nc" id="L596">							gameBean = gameMap.get(catName);</span>
<span class="nc bnc" id="L597" title="All 2 branches missed.">							if (gameBean == null) {</span>
<span class="nc" id="L598">								gameBean = new CompleteCollectionBean();</span>
<span class="nc" id="L599">								gameMap.put(catName, gameBean);</span>
							}
<span class="nc" id="L601">							totalSale += rs.getDouble(&quot;sale&quot;);</span>
<span class="nc" id="L602">							totalCancel += rs.getDouble(&quot;cancel&quot;);</span>
<span class="nc" id="L603">							gameBean.setOrgName(catName);</span>
<span class="nc" id="L604">							gameBean.setCSSale(rs.getDouble(&quot;sale&quot;));</span>
<span class="nc" id="L605">							gameBean.setCSCancel(rs.getDouble(&quot;cancel&quot;));</span>
						}
<span class="nc" id="L607">					}</span>
<span class="nc" id="L608">					agentBean = agtMap.get(&quot;9999999999&quot;);</span>
<span class="nc" id="L609">					Map&lt;String, CompleteCollectionBean&gt; gameMap = agentBean</span>
							.getGameBeanMap();
<span class="nc bnc" id="L611" title="All 2 branches missed.">					if (gameMap == null) {</span>
<span class="nc" id="L612">						gameMap = new HashMap&lt;String, CompleteCollectionBean&gt;();</span>
<span class="nc" id="L613">						agentBean.setGameBeanMap(gameMap);</span>
					}
<span class="nc" id="L615">					gameBean = gameMap.get(catName);</span>
<span class="nc bnc" id="L616" title="All 2 branches missed.">					if (gameBean == null) {</span>
<span class="nc" id="L617">						gameBean = new CompleteCollectionBean();</span>
<span class="nc" id="L618">						gameMap.put(catName, gameBean);</span>
					}
<span class="nc" id="L620">					gameBean.setOrgName(catName);</span>
<span class="nc" id="L621">					gameBean.setCSSale(rs.getDouble(&quot;sale&quot;));</span>
<span class="nc" id="L622">					gameBean.setCSCancel(rs.getDouble(&quot;cancel&quot;));</span>

<span class="nc" id="L624">				}</span>
			}

<span class="nc" id="L627">			String wdTranOLA = null;</span>
<span class="nc" id="L628">			String wdRefTranOLA = null;</span>
<span class="nc" id="L629">			String depoTranOLA = null;</span>
<span class="nc" id="L630">			String depoRefTranOLA = null;</span>
<span class="nc" id="L631">			String netGTranOLA = null;</span>
<span class="nc" id="L632">			StringBuilder OLAQry = null;</span>
<span class="nc bnc" id="L633" title="All 2 branches missed.">			if (isOLA) {</span>
<span class="nc" id="L634">				OLAQry = new StringBuilder(</span>
						&quot;select withdraw.agtOrgId, (wdra-wdraRef) withdrawAmt, (depo-depoRef) depositAmt, netAmt netGamingComm from &quot;);
<span class="nc" id="L636">				wdTranOLA = &quot;(select om.parent_id agtOrgId, ifnull(sum(wdra),0.0)wdra from (select ifnull(orw.retailer_org_id,0)retId, ifnull(sum(agent_net_amt),0.0) as wdra from st_ola_ret_withdrawl orw where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type='OLA_WITHDRAWL' and transaction_date&gt;='&quot;</span>
						+ startDate
						+ &quot;' and transaction_date &lt;='&quot;
						+ endDate
						+ &quot;') and orw.wallet_id = ? group by retId)wd right outer join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on wd.retId = om.organization_id group by parent_id)wd,&quot;;
<span class="nc" id="L641">				wdRefTranOLA = &quot;(select om.parent_id agtOrgId, ifnull(sum(wdraRef),0.0)wdraRef from (select ifnull(orwRef.retailer_org_id,0)retId, ifnull(sum(agent_net_amt),0.0) as wdraRef from st_ola_ret_withdrawl_refund orwRef where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type='OLA_WITHDRAWL_REFUND' and transaction_date&gt;= '&quot;</span>
						+ startDate
						+ &quot;' and transaction_date &lt;= '&quot;
						+ endDate
						+ &quot;') and orwRef.wallet_id = ? group by retId)wdRef right outer join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on wdRef.retId = om.organization_id group by parent_id)wdRef&quot;;
<span class="nc" id="L646">				depoTranOLA = &quot;(select om.parent_id agtOrgId, ifnull(sum(depo),0.0)depo from (select ifnull(ordepo.retailer_org_id,0)retId, ifnull(sum(agent_net_amt),0.0) as depo from st_ola_ret_deposit ordepo where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type='OLA_DEPOSIT' and transaction_date&gt;='&quot;</span>
						+ startDate
						+ &quot;' and transaction_date &lt;='&quot;
						+ endDate
						+ &quot;') and ordepo.wallet_id = ? group by retId)depo right outer join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on depo.retId = om.organization_id group by parent_id)depo,&quot;;
<span class="nc" id="L651">				depoRefTranOLA = &quot;(select om.parent_id agtOrgId, ifnull(sum(depoRef),0.0)depoRef from (select ifnull(ordepoRef.retailer_org_id,0)retId, ifnull(sum(agent_net_amt),0.0) as depoRef from st_ola_ret_deposit_refund ordepoRef where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type='OLA_DEPOSIT_REFUND' and transaction_date&gt;= '&quot;</span>
						+ startDate
						+ &quot;' and transaction_date &lt;= '&quot;
						+ endDate
						+ &quot;') and ordepoRef.wallet_id = ? group by retId)depoRef right outer join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on depoRef.retId = om.organization_id group by parent_id)depoRef&quot;;
<span class="nc" id="L656">				netGTranOLA = &quot;(select om.parent_id agtOrgId, ifnull(sum(netGamingAmt), 0.0) netAmt from(select wrs.retailer_org_id, agt_net_claim_comm as netGamingAmt from st_ola_ret_comm wrs inner join st_lms_retailer_transaction_master rt on wrs.transaction_id=rt.transaction_id where transaction_type = 'OLA_COMMISSION' and transaction_date&gt;='&quot;</span>
						+ startDate
						+ &quot;' and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;' and wallet_id = ?) wdret right outer join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on om.organization_id = wdret.retailer_org_id group by om.parent_id) netgaming&quot;;
<span class="nc" id="L661">				OLAQry.append(&quot;(select wd.agtOrgId, wdra, wdraRef from&quot;);</span>
<span class="nc" id="L662">				OLAQry.append(wdTranOLA);</span>
<span class="nc" id="L663">				OLAQry.append(wdRefTranOLA);</span>
<span class="nc" id="L664">				OLAQry.append(&quot; where wd.agtOrgId = wdRef.agtOrgId)withdraw,&quot;);</span>
<span class="nc" id="L665">				OLAQry.append(&quot;(select depo.agtOrgId, depo, depoRef from&quot;);</span>
<span class="nc" id="L666">				OLAQry.append(depoTranOLA);</span>
<span class="nc" id="L667">				OLAQry.append(depoRefTranOLA);</span>
<span class="nc" id="L668">				OLAQry</span>
						.append(&quot; where depo.agtOrgId = depoRef.agtOrgId)deposit, &quot;);
<span class="nc" id="L670">				OLAQry.append(netGTranOLA);</span>
<span class="nc" id="L671">				OLAQry</span>
						.append(&quot; where withdraw.agtOrgId = deposit.agtOrgId and netgaming.agtOrgId = withdraw.agtOrgId and netgaming.agtOrgId = deposit.agtOrgId&quot;);

<span class="nc" id="L674">				StringBuilder unionQuery = null;</span>
<span class="nc" id="L675">				StringBuilder mainQuery = null;</span>

<span class="nc bnc" id="L677" title="All 2 branches missed.">				if (LMSFilterDispatcher.isRepFrmSP) {</span>
<span class="nc" id="L678">					mainQuery = new StringBuilder(</span>
							&quot;select agtOrgId, sum(withdrawAmt) withdrawAmt,sum(depositAmt) depositAmt ,sum(netGamingComm) netGamingComm from (&quot;);
<span class="nc" id="L680">					unionQuery = new StringBuilder(</span>
							&quot; union all select parent_id agtOrgId, sum(withdrawal_net_amt)-sum(ref_withdrawal_net_amt) withdrawAmt ,sum(deposit_net) -sum(ref_deposit_net_amt) depositAmt,sum(net_gaming_net_comm) netGamingComm from st_rep_ola_retailer where finaldate&gt;='&quot;
									+ startDate
									+ &quot;' and finaldate&lt;='&quot;
									+ endDate
									+ &quot;'  and wallet_id=? group by  parent_id) repTable group by agtOrgId&quot;);
<span class="nc" id="L686">					mainQuery.append(OLAQry.toString()).append(</span>
							unionQuery.toString());
<span class="nc" id="L688">					pstmt = con.prepareStatement(mainQuery.toString());</span>
				} else {
<span class="nc" id="L690">					pstmt = con.prepareStatement(OLAQry.toString());</span>
				}
<span class="nc" id="L692">				logger.debug(&quot;For Expand OLA wallet Qry:: &quot; + OLAQry);</span>
				// Wallet Master Query
<span class="nc" id="L694">				String walletQry = &quot;select wallet_id, wallet_name from st_ola_wallet_master&quot;;</span>
<span class="nc" id="L695">				PreparedStatement walletPstmt = con.prepareStatement(walletQry);</span>
<span class="nc" id="L696">				ResultSet rsWallet = walletPstmt.executeQuery();</span>
<span class="nc bnc" id="L697" title="All 2 branches missed.">				while (rsWallet.next()) {</span>
<span class="nc" id="L698">					double withdrawAmt = 0.0;</span>
<span class="nc" id="L699">					double depositAmt = 0.0;</span>
<span class="nc" id="L700">					double netGamingComm = 0.0;</span>
<span class="nc" id="L701">					int walletId = rsWallet.getInt(&quot;wallet_id&quot;);</span>
<span class="nc" id="L702">					String walletName = rsWallet.getString(&quot;wallet_name&quot;);</span>
					// pstmt = con.prepareStatement(OLAQry.toString());
<span class="nc" id="L704">					pstmt.setInt(1, walletId);</span>
<span class="nc" id="L705">					pstmt.setInt(2, walletId);</span>
<span class="nc" id="L706">					pstmt.setInt(3, walletId);</span>
<span class="nc" id="L707">					pstmt.setInt(4, walletId);</span>
<span class="nc" id="L708">					pstmt.setInt(5, walletId);</span>
<span class="nc" id="L709">					pstmt.setInt(6, walletId);</span>
<span class="nc" id="L710">					logger.debug(&quot;-------Indivisual Wallet Qry-------\n&quot;</span>
							+ pstmt);
<span class="nc" id="L712">					rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L713" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L714">						String agtOrgId = rs.getString(&quot;agtOrgId&quot;);</span>
<span class="nc" id="L715">						agentBean = agtMap.get(agtOrgId);</span>
<span class="nc bnc" id="L716" title="All 2 branches missed.">						if (agentBean != null) {</span>
<span class="nc" id="L717">							Map&lt;String, CompleteCollectionBean&gt; walletMap = agentBean</span>
									.getGameBeanMap();
<span class="nc bnc" id="L719" title="All 2 branches missed.">							if (walletMap == null) {</span>
<span class="nc" id="L720">								walletMap = new HashMap&lt;String, CompleteCollectionBean&gt;();</span>
<span class="nc" id="L721">								agentBean.setGameBeanMap(walletMap);</span>
							}
<span class="nc" id="L723">							gameBean = walletMap.get(walletName);</span>
<span class="nc bnc" id="L724" title="All 2 branches missed.">							if (gameBean == null) {</span>
<span class="nc" id="L725">								gameBean = new CompleteCollectionBean();</span>
<span class="nc" id="L726">								walletMap.put(walletName, gameBean);</span>
							}
<span class="nc" id="L728">							withdrawAmt += rs.getDouble(&quot;withdrawAmt&quot;);</span>
<span class="nc" id="L729">							depositAmt += rs.getDouble(&quot;depositAmt&quot;);</span>
<span class="nc" id="L730">							netGamingComm += rs.getDouble(&quot;netGamingComm&quot;);</span>
<span class="nc" id="L731">							gameBean.setOrgName(walletName);</span>
<span class="nc" id="L732">							gameBean.setOlaWithdrawalAmt(rs</span>
									.getDouble(&quot;withdrawAmt&quot;));
<span class="nc" id="L734">							gameBean.setOlaDepositAmt(rs</span>
									.getDouble(&quot;depositAmt&quot;));
<span class="nc" id="L736">							gameBean.setOlaNetGaming(rs</span>
									.getDouble(&quot;netGamingComm&quot;));
						}
<span class="nc" id="L739">					}</span>
<span class="nc" id="L740">					agentBean = agtMap.get(&quot;9999999999&quot;);</span>
<span class="nc" id="L741">					Map&lt;String, CompleteCollectionBean&gt; walletMap = agentBean</span>
							.getGameBeanMap();
<span class="nc bnc" id="L743" title="All 2 branches missed.">					if (walletMap == null) {</span>
<span class="nc" id="L744">						walletMap = new HashMap&lt;String, CompleteCollectionBean&gt;();</span>
<span class="nc" id="L745">						agentBean.setGameBeanMap(walletMap);</span>
					}
<span class="nc" id="L747">					gameBean = walletMap.get(walletName);</span>
<span class="nc bnc" id="L748" title="All 2 branches missed.">					if (gameBean == null) {</span>
<span class="nc" id="L749">						gameBean = new CompleteCollectionBean();</span>
<span class="nc" id="L750">						walletMap.put(walletName, gameBean);</span>
					}
<span class="nc" id="L752">					gameBean.setOrgName(walletName);</span>
<span class="nc" id="L753">					gameBean.setOlaWithdrawalAmt(rs.getDouble(&quot;withdrawAmt&quot;));</span>
<span class="nc" id="L754">					gameBean.setOlaDepositAmt(rs.getDouble(&quot;depositAmt&quot;));</span>
<span class="nc" id="L755">					gameBean.setOlaNetGaming(rs.getDouble(&quot;netGamingComm&quot;));</span>
<span class="nc" id="L756">				}</span>
			}

<span class="nc" id="L759">		} catch (Exception e) {</span>
<span class="nc" id="L760">			e.printStackTrace();</span>
<span class="nc" id="L761">			throw new LMSException(&quot;Error in report collectionAgentWise Expand&quot;);</span>
		} finally {
<span class="nc bnc" id="L763" title="All 4 branches missed.">			if (con != null) {</span>
<span class="nc" id="L764">				DBConnect.closeCon(con);</span>
			}
		}
<span class="nc" id="L767">	}</span>

	public String getOrgAdd(int orgId) throws LMSException {
<span class="nc" id="L770">		String orgAdd = &quot;&quot;;</span>
<span class="nc" id="L771">		Connection con = null;</span>
<span class="nc" id="L772">		con = DBConnect.getConnection();</span>
<span class="nc" id="L773">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L774">		ResultSet rs = null;</span>
		try {
<span class="nc" id="L776">			pstmt = con</span>
					.prepareStatement(&quot;select addr_line1, addr_line2, city from st_lms_organization_master where organization_id = ?&quot;);
<span class="nc" id="L778">			pstmt.setInt(1, orgId);</span>
<span class="nc" id="L779">			rs = pstmt.executeQuery();</span>
<span class="nc" id="L780">			System.out.println(pstmt);</span>
<span class="nc bnc" id="L781" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L782">				orgAdd = rs.getString(&quot;addr_line1&quot;) + &quot;, &quot;</span>
						+ rs.getString(&quot;addr_line2&quot;) + &quot;, &quot;
						+ rs.getString(&quot;city&quot;);
			}
<span class="nc" id="L786">		} catch (SQLException e) {</span>
<span class="nc" id="L787">			logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L788">			e.printStackTrace();</span>
<span class="nc" id="L789">			throw new LMSException(e);</span>
		} finally {
<span class="nc" id="L791">			try {</span>
<span class="nc bnc" id="L792" title="All 8 branches missed.">				if (con != null &amp;&amp; !con.isClosed()) {</span>
<span class="nc" id="L793">					con.close();</span>
				}
<span class="nc" id="L795">			} catch (SQLException e) {</span>
<span class="nc" id="L796">				logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L797">				e.printStackTrace();</span>
<span class="nc" id="L798">				throw new LMSException(e);</span>
<span class="nc" id="L799">			}</span>
		}
<span class="nc" id="L801">		return orgAdd;</span>
	}

	public Map&lt;String, String&gt; allGameMap() throws LMSException {
<span class="nc" id="L805">		Map&lt;String, String&gt; gameMap = new LinkedHashMap&lt;String, String&gt;();</span>
<span class="nc" id="L806">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L807">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L808">		ResultSet rs = null;</span>
		try {
<span class="nc" id="L810">			String gameQry = &quot;select game_name,'DG' as game_type from st_dg_game_master union all select game_name,'SE' as game_type from st_se_game_master union all select category_code,'CS' as game_type from st_cs_product_category_master where status = 'ACTIVE' union all select wallet_name,'OLA' as game_type from st_ola_wallet_master order by game_type&quot;;</span>
<span class="nc" id="L811">			pstmt = con.prepareStatement(gameQry);</span>
<span class="nc" id="L812">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L813" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L814">				gameMap.put(rs.getString(&quot;game_name&quot;), rs</span>
						.getString(&quot;game_type&quot;));
			}
<span class="nc" id="L817">		} catch (Exception e) {</span>
<span class="nc" id="L818">			e.printStackTrace();</span>
<span class="nc" id="L819">			throw new LMSException(&quot;Error in fetch Game List&quot;);</span>
		} finally {
<span class="nc" id="L821">			try {</span>
<span class="nc" id="L822">				con.close();</span>
<span class="nc" id="L823">			} catch (SQLException e) {</span>
<span class="nc" id="L824">				e.printStackTrace();</span>
<span class="nc" id="L825">			}</span>
<span class="nc" id="L826">		}</span>
<span class="nc" id="L827">		return gameMap;</span>
	}

	public static void main(String s[]) throws ParseException, LMSException {
		/*
		 * SimpleDateFormat sdf=new SimpleDateFormat(&quot;dd-MM-yyyy HH:mm:ss&quot;);
		 * Timestamp depDate=new
		 * Timestamp(sdf.parse(&quot;29-10-2010 00:00:00&quot;).getTime()); Timestamp
		 * stDate=new Timestamp(sdf.parse(&quot;08-03-2013 23:59:59&quot;).getTime());
		 * Timestamp enDate=new
		 * Timestamp(sdf.parse(&quot;09-03-2013 23:59:59&quot;).getTime());
		 * 
		 * Map&lt;String, CollectionReportOverAllBean&gt;
		 * map=collectionAgentWiseWithOpeningBal( depDate, stDate,enDate,true,
		 * false,false,false);
		 * 
		 * 
		 * 
		 * System.out.println(map);
		 */

<span class="nc" id="L848">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>