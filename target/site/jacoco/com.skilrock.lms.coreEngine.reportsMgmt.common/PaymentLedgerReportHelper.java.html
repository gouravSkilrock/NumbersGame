<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PaymentLedgerReportHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lms</a> &gt; <a href="index.source.html" class="el_package">com.skilrock.lms.coreEngine.reportsMgmt.common</a> &gt; <span class="el_source">PaymentLedgerReportHelper.java</span></div><h1>PaymentLedgerReportHelper.java</h1><pre class="source lang-java linenums">package com.skilrock.lms.coreEngine.reportsMgmt.common;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Timestamp;
import java.text.SimpleDateFormat;
import java.util.Calendar;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.LinkedHashMap;
import java.util.Map;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import com.skilrock.lms.beans.CollectionReportOverAllBean;
import com.skilrock.lms.beans.CompleteCollectionBean;
import com.skilrock.lms.common.db.DBConnect;
import com.skilrock.lms.common.exception.LMSException;
import com.skilrock.lms.common.filter.LMSFilterDispatcher;
import com.skilrock.lms.web.reportsMgmt.common.ReportUtility;

<span class="nc" id="L26">public class PaymentLedgerReportHelper implements</span>
		IPaymentLedgerReportAgtWiseHelper {
<span class="nc" id="L28">	Log logger = LogFactory.getLog(PaymentLedgerReportHelper.class);</span>



	public void collectionDateWise(Timestamp startDate, Timestamp endDate,
			Connection con, Map&lt;String, CollectionReportOverAllBean&gt; agtMap,
			int agtOrgId) throws LMSException {

<span class="nc" id="L36">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L37">		PreparedStatement pstmt1 = null;</span>
<span class="nc" id="L38">		ResultSet rs = null;</span>
<span class="nc" id="L39">		ResultSet rs1 = null;</span>

<span class="nc bnc" id="L41" title="All 2 branches missed.">		if (startDate.after(endDate)) {</span>
<span class="nc" id="L42">			return;</span>
		}

		try {
			// Get Account Details

			// String addOrgQry =
			// &quot;right outer join (select organization_id from st_lms_organization_master where organization_type='AGENT' and organization_id=&quot;+agtOrgId+&quot; ) om on agent_org_id=organization_id&quot;;
<span class="nc" id="L50">			String cashQry = &quot;(select agent_org_id,sum(amount) cash,date(transaction_date) date from st_lms_bo_cash_transaction cash,st_lms_bo_transaction_master btm where cash.transaction_id=btm.transaction_id and transaction_date&gt;='&quot;</span>
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' and agent_org_id= &quot;
					+ agtOrgId
					+ &quot; group by date(transaction_date)) cash&quot;;
<span class="nc" id="L57">			String chqQry = &quot;(select agent_org_id,sum(cheque_amt) chq,date(transaction_date) date from st_lms_bo_sale_chq chq,st_lms_bo_transaction_master btm where chq.transaction_id=btm.transaction_id and chq.transaction_type IN ('CHEQUE','CLOSED') and transaction_date&gt;='&quot;</span>
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;'and agent_org_id= &quot;
					+ agtOrgId
					+ &quot; group by date(transaction_date)) chq &quot;;
<span class="nc" id="L64">			String chqRetQry = &quot;(select agent_org_id,sum(cheque_amt) chq_ret,date(transaction_date) date from st_lms_bo_sale_chq chq,st_lms_bo_transaction_master btm where chq.transaction_id=btm.transaction_id and chq.transaction_type IN ('CHQ_BOUNCE') and transaction_date&gt;='&quot;</span>
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' and agent_org_id= &quot;
					+ agtOrgId
					+ &quot; group by date(transaction_date)) chq_ret &quot;;

<span class="nc" id="L72">			String debitQry = &quot;(select agent_org_id,sum(amount) debit,date(transaction_date) date from st_lms_bo_debit_note debit,st_lms_bo_transaction_master btm where debit.transaction_id=btm.transaction_id and debit.transaction_type IN ('DR_NOTE_CASH','DR_NOTE') and transaction_date&gt;='&quot;</span>
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' and agent_org_id= &quot;
					+ agtOrgId
					+ &quot; group by date(transaction_date))  debit&quot;;
<span class="nc" id="L79">			String creditQry = &quot;(select agent_org_id,sum(amount) credit,date(transaction_date) date from st_lms_bo_credit_note credit,st_lms_bo_transaction_master btm where credit.transaction_id=btm.transaction_id and credit.transaction_type IN ('CR_NOTE_CASH','CR_NOTE') and transaction_date&gt;='&quot;</span>
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;'and agent_org_id= &quot;
					+ agtOrgId
					+ &quot; group by date(transaction_date)) credit&quot;;
<span class="nc" id="L86">			String bankQry = &quot;(select agent_org_id,sum(amount) bank,date(transaction_date) date from st_lms_bo_bank_deposit_transaction bank,st_lms_bo_transaction_master btm where bank.transaction_id=btm.transaction_id and transaction_date&gt;='&quot;</span>
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;'and agent_org_id= &quot;
					+ agtOrgId
					+ &quot; group by date(transaction_date))  bank&quot;;

<span class="nc" id="L94">			String acc1Qry = &quot;select ifnull(chq.date,cash.date) date,ifnull(cash,0.0) cash,ifnull(chq,0.0) chq from (&quot;</span>
					+ cashQry
					+ &quot; left join &quot;
					+ chqQry
					+ &quot; on cash.date=chq.date ) union&quot;

					+ &quot; select ifnull(chq.date,cash.date) date,ifnull(cash,0.0) cash,ifnull(chq,0.0) chq from (&quot;
					+ cashQry
					+ &quot; right join &quot;
					+ chqQry
					+ &quot; on cash.date=chq.date )&quot;;

<span class="nc" id="L106">			String acc2Qry = &quot;select ifnull(credit.date,debit.date) date,ifnull(debit,0.0) debit,ifnull(credit,0.0) credit from (&quot;</span>
					+ debitQry
					+ &quot; left join &quot;
					+ creditQry
					+ &quot; on debit.date=credit.date ) union&quot;

					+ &quot; select ifnull(credit.date,debit.date) date,ifnull(debit,0.0) debit,ifnull(credit,0.0) credit from (&quot;
					+ debitQry
					+ &quot; right join &quot;
					+ creditQry
					+ &quot; on debit.date=credit.date )&quot;;

<span class="nc" id="L118">			String acc3Qry = &quot;select ifnull(chq_ret.date,bank.date) date,ifnull(chq_ret,0.0) chq_ret,ifnull(bank,0.0) bank from (&quot;</span>
					+ chqRetQry
					+ &quot; left join &quot;
					+ bankQry
					+ &quot; on chq_ret.date=bank.date ) union&quot;

					+ &quot; select ifnull(chq_ret.date,bank.date) date,ifnull(chq_ret,0.0) chq_ret,ifnull(bank,0.0) bank from (&quot;
					+ chqRetQry
					+ &quot; right join &quot;
					+ bankQry
					+ &quot; on chq_ret.date=bank.date )&quot;;
<span class="nc" id="L129">			pstmt = con.prepareStatement(acc1Qry);</span>
<span class="nc" id="L130">			logger.debug(&quot;---Account Detail Query---&quot; + pstmt);</span>
<span class="nc" id="L131">			rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L133" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L134">				SimpleDateFormat dateformat = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span>
<span class="nc" id="L135">				String dateFrDtParse = dateformat.format(rs.getDate(&quot;date&quot;));</span>
				// String agtOrgId = rs.getString(&quot;organization_id&quot;);

<span class="nc" id="L138">				agtMap.get(dateFrDtParse).setCash(rs.getDouble(&quot;cash&quot;));</span>
<span class="nc" id="L139">				agtMap.get(dateFrDtParse).setCheque(rs.getDouble(&quot;chq&quot;));</span>

<span class="nc" id="L141">			}</span>
<span class="nc" id="L142">			pstmt1 = con.prepareStatement(acc2Qry);</span>
<span class="nc" id="L143">			logger.debug(&quot;---Account Detail Query---&quot; + pstmt1);</span>
<span class="nc" id="L144">			rs1 = pstmt1.executeQuery();</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">			while (rs1.next()) {</span>
<span class="nc" id="L146">				SimpleDateFormat dateformat = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span>
<span class="nc" id="L147">				String dateFrDtParse = dateformat.format(rs1.getDate(&quot;date&quot;));</span>
				// String agtOrgId = rs.getString(&quot;organization_id&quot;);

<span class="nc" id="L150">				agtMap.get(dateFrDtParse).setCredit(rs1.getDouble(&quot;credit&quot;));</span>
<span class="nc" id="L151">				agtMap.get(dateFrDtParse).setDebit(rs1.getDouble(&quot;debit&quot;));</span>

<span class="nc" id="L153">			}</span>

<span class="nc" id="L155">			pstmt = con.prepareStatement(acc3Qry);</span>
<span class="nc" id="L156">			logger.debug(&quot;---Account Detail Query---&quot; + pstmt);</span>
<span class="nc" id="L157">			rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L159" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L160">				SimpleDateFormat dateformat = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span>
<span class="nc" id="L161">				String dateFrDtParse = dateformat.format(rs.getDate(&quot;date&quot;));</span>
				// String agtOrgId = rs.getString(&quot;organization_id&quot;);

<span class="nc" id="L164">				agtMap.get(dateFrDtParse).setChequeReturn(</span>
						rs.getDouble(&quot;chq_ret&quot;));
<span class="nc" id="L166">				agtMap.get(dateFrDtParse).setBankDep(rs.getDouble(&quot;bank&quot;));</span>
<span class="nc" id="L167">			}</span>

<span class="nc bnc" id="L169" title="All 2 branches missed.">			if (ReportUtility.isDG) {</span>
				/*
				 * saleTranDG =
				 * &quot;select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_SALE','DG_SALE_OFFLINE') and transaction_date&gt;='&quot;
				 * + startDate + &quot;' and transaction_date&lt;='&quot; + endDate +
				 * &quot;' and retailer_org_id in (select organization_id from st_lms_organization_master where organization_type='RETAILER')&quot;
				 * ; cancelTranDG =
				 * &quot;select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_REFUND_CANCEL','DG_REFUND_FAILED') and transaction_date&gt;='&quot;
				 * + startDate + &quot;' and transaction_date&lt;='&quot; + endDate +
				 * &quot;' and retailer_org_id in (select organization_id from st_lms_organization_master where organization_type='RETAILER')&quot;
				 * ; pwtTranDG =
				 * &quot;select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_PWT_AUTO','DG_PWT_PLR','DG_PWT') and transaction_date&gt;='&quot;
				 * + startDate + &quot;' and transaction_date&lt;='&quot; + endDate +
				 * &quot;' and retailer_org_id in (select organization_id from st_lms_organization_master where organization_type='RETAILER')&quot;
				 * ;
				 */
				// Game Master Query
<span class="nc" id="L186">				String gameQry = &quot;select game_id from st_dg_game_master&quot;;</span>
<span class="nc" id="L187">				PreparedStatement gamePstmt = con.prepareStatement(gameQry);</span>
<span class="nc" id="L188">				ResultSet rsGame = gamePstmt.executeQuery();</span>
<span class="nc" id="L189">				StringBuilder saleQry = new StringBuilder(</span>
						&quot;select date(transaction_date) date,parent_id,sum(sale) as sale from (&quot;);
<span class="nc" id="L191">				StringBuilder cancelQry = new StringBuilder(</span>
						&quot;select date(transaction_date) date,parent_id,sum(cancel) as cancel from (&quot;);
<span class="nc" id="L193">				StringBuilder pwtQry = new StringBuilder(</span>
						&quot;select date(transaction_date) date,parent_id,sum(pwt) as pwt from (&quot;);
<span class="nc bnc" id="L195" title="All 2 branches missed.">				while (rsGame.next()) {</span>
<span class="nc" id="L196">					saleQry</span>
							.append(&quot;(select bb.parent_id,sum(sale) as sale,transaction_date from(select drs.retailer_org_id,sum(agent_net_amt) as sale,rtm.transaction_date from st_dg_ret_sale_&quot;
									+ rsGame.getInt(&quot;game_id&quot;)
									+ &quot; drs,st_lms_retailer_transaction_master rtm where drs.transaction_id=rtm.transaction_id and rtm.transaction_type in('DG_SALE','DG_SALE_OFFLINE') and transaction_date&gt;='&quot;
									+ startDate
									+ &quot;'and transaction_date&lt;='&quot;
									+ endDate
									+ &quot;' and drs.retailer_org_id in (select organization_id from st_lms_organization_master where organization_type='RETAILER') group by date(transaction_date),drs.retailer_org_id)aa,st_lms_organization_master bb where retailer_org_id=organization_id and parent_id=&quot;
									+ agtOrgId
									+ &quot; group by date(transaction_date)) union all &quot;);

<span class="nc" id="L207">					cancelQry</span>
							.append(&quot;(select bb.parent_id,sum(cancel) as cancel,transaction_date from(select drs.retailer_org_id,sum(agent_net_amt) as cancel,rtm.transaction_date from st_dg_ret_sale_refund_&quot;
									+ rsGame.getInt(&quot;game_id&quot;)
									+ &quot; drs,st_lms_retailer_transaction_master rtm where drs.transaction_id=rtm.transaction_id and rtm.transaction_type in('DG_REFUND_CANCEL','DG_REFUND_FAILED') and transaction_date&gt;='&quot;
									+ startDate
									+ &quot;'and transaction_date&lt;='&quot;
									+ endDate
									+ &quot;' and drs.retailer_org_id in (select organization_id from st_lms_organization_master where organization_type='RETAILER') group by date(transaction_date),drs.retailer_org_id)aa,st_lms_organization_master bb where retailer_org_id=organization_id and parent_id=&quot;
									+ agtOrgId
									+ &quot; group by date(transaction_date)) union all &quot;);

<span class="nc" id="L218">					pwtQry</span>
							.append(&quot;(select bb.parent_id,sum(pwt) as pwt,transaction_date from(select drs.retailer_org_id,sum(pwt_amt+agt_claim_comm) as pwt,rtm.transaction_date from st_dg_ret_pwt_&quot;
									+ rsGame.getInt(&quot;game_id&quot;)
									+ &quot; drs,st_lms_retailer_transaction_master rtm where drs.transaction_id=rtm.transaction_id and rtm.transaction_type in('DG_PWT_AUTO','DG_PWT_PLR','DG_PWT') and transaction_date&gt;='&quot;
									+ startDate
									+ &quot;'and transaction_date&lt;='&quot;
									+ endDate
									+ &quot;' and drs.retailer_org_id in (select organization_id from st_lms_organization_master where organization_type='RETAILER') group by date(transaction_date),drs.retailer_org_id)aa,st_lms_organization_master bb where retailer_org_id=organization_id and parent_id=&quot;
									+ agtOrgId
									+ &quot; group by date(transaction_date)) union all&quot;);

				}

<span class="nc" id="L231">				saleQry.delete(saleQry.lastIndexOf(&quot;union all&quot;), saleQry</span>
						.length());
<span class="nc" id="L233">				cancelQry.delete(cancelQry.lastIndexOf(&quot;union all&quot;), cancelQry</span>
						.length());
<span class="nc" id="L235">				pwtQry.delete(pwtQry.lastIndexOf(&quot;union all&quot;), pwtQry.length());</span>

<span class="nc" id="L237">				saleQry.append(&quot;) saletable group by date(transaction_date)&quot;);</span>
<span class="nc" id="L238">				cancelQry.append(&quot;) cancelTlb group by date(transaction_date)&quot;);</span>
<span class="nc" id="L239">				pwtQry.append(&quot;) pwtTlb group by date(transaction_date)&quot;);</span>
<span class="nc" id="L240">				logger.debug(&quot;-------Draw Sale Qurey------\n&quot; + saleQry);</span>
<span class="nc" id="L241">				logger.debug(&quot;-------Draw Cancel Qurey------\n&quot; + cancelQry);</span>
<span class="nc" id="L242">				logger.debug(&quot;-------Draw Pwt Qurey------\n&quot; + pwtQry);</span>

				// Draw Sale Query
<span class="nc" id="L245">				pstmt = con.prepareStatement(saleQry.toString());</span>
<span class="nc" id="L246">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L248">					SimpleDateFormat dateformat = new SimpleDateFormat(</span>
							&quot;yyyy-MM-dd&quot;);
<span class="nc" id="L250">					String dateFrDtParse = dateformat</span>
							.format(rs.getDate(&quot;date&quot;));
					// String agtOrgId = rs.getString(&quot;organization_id&quot;);

<span class="nc" id="L254">					agtMap.get(dateFrDtParse).setDgSale(rs.getDouble(&quot;sale&quot;));</span>

<span class="nc" id="L256">				}</span>
				// Draw Cancel Query
<span class="nc" id="L258">				pstmt = con.prepareStatement(cancelQry.toString());</span>
<span class="nc" id="L259">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L261">					SimpleDateFormat dateformat = new SimpleDateFormat(</span>
							&quot;yyyy-MM-dd&quot;);
<span class="nc" id="L263">					String dateFrDtParse = dateformat</span>
							.format(rs.getDate(&quot;date&quot;));
					// String agtOrgId = rs.getString(&quot;organization_id&quot;);

<span class="nc" id="L267">					agtMap.get(dateFrDtParse).setDgCancel(</span>
							rs.getDouble(&quot;cancel&quot;));

<span class="nc" id="L270">				}</span>
				// Draw Pwt Query
<span class="nc" id="L272">				pstmt = con.prepareStatement(pwtQry.toString());</span>
<span class="nc" id="L273">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L275">					SimpleDateFormat dateformat = new SimpleDateFormat(</span>
							&quot;yyyy-MM-dd&quot;);
<span class="nc" id="L277">					String dateFrDtParse = dateformat</span>
							.format(rs.getDate(&quot;date&quot;));

<span class="nc" id="L280">					agtMap.get(dateFrDtParse).setDgPwt(rs.getDouble(&quot;pwt&quot;));</span>

<span class="nc" id="L282">				}</span>

				// Draw Direct Player Qry

<span class="nc" id="L286">				String dirPwtQry = &quot;select date(transaction_date) date,agent_org_id,sum(pwt_amt+agt_claim_comm) pwtDir from st_dg_agt_direct_plr_pwt where transaction_date&gt;=? and transaction_date&lt;=? and agent_org_id=&quot;</span>
						+ agtOrgId + &quot; group by date(transaction_date) &quot;;
<span class="nc" id="L288">				pstmt = con.prepareStatement(dirPwtQry);</span>
<span class="nc" id="L289">				pstmt.setTimestamp(1, startDate);</span>
<span class="nc" id="L290">				pstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L291">				logger.debug(&quot;-------Draw Direct Player Qry------\n&quot; + pstmt);</span>
<span class="nc" id="L292">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L294">					SimpleDateFormat dateformat = new SimpleDateFormat(</span>
							&quot;yyyy-MM-dd&quot;);
<span class="nc" id="L296">					String dateFrDtParse = dateformat</span>
							.format(rs.getDate(&quot;date&quot;));
					// String agtOrgId = rs.getString(&quot;organization_id&quot;);

<span class="nc" id="L300">					agtMap.get(dateFrDtParse).setDgDirPlyPwt(</span>
							rs.getDouble(&quot;pwtDir&quot;));

<span class="nc" id="L303">				}</span>
			}
<span class="nc bnc" id="L305" title="All 2 branches missed.">			if (ReportUtility.isSE) {</span>
				// Calculate Scratch Sale
<span class="nc" id="L307">				String saleQry = &quot;&quot;;</span>
<span class="nc" id="L308">				String cancelQry = &quot;&quot;;</span>
<span class="nc" id="L309">				logger.info(&quot;----Type Select ---&quot;</span>
						+ LMSFilterDispatcher.seSaleReportType);
<span class="nc bnc" id="L311" title="All 2 branches missed.">				if (&quot;BOOK_WISE&quot;.equals(LMSFilterDispatcher.seSaleReportType)) {</span>
<span class="nc" id="L312">					saleQry = &quot;select agent_org_id,ifnull(sum(mrp_amt),0.0) as mrp_amt,ifnull(sum(netAmt),0.0) netAmt, date from((select sbt.agent_org_id,ifnull(sum(mrp_amt),0.0) as mrp_amt,ifnull(sum(net_amt),0.0) netAmt,date(btm.transaction_date) date from st_se_bo_agent_transaction sbt,st_lms_bo_transaction_master btm where sbt.transaction_id=btm.transaction_id and btm.transaction_type ='SALE' and transaction_date&gt;='&quot;</span>
							+ startDate
							+ &quot;' and transaction_date&lt;='&quot;
							+ endDate
							+ &quot;' and sbt.agent_org_id=&quot;
							+ agtOrgId
							+ &quot; group by date(transaction_date)) union all &quot;
							+ &quot;(select sbt.agent_org_id,ifnull(sum(mrp_amt),0.0) as mrp_amt,ifnull(sum(net_amt),0.0) netAmt,date(btm.transaction_date) date from st_se_bo_agent_loose_book_transaction sbt,st_lms_bo_transaction_master btm where sbt.transaction_id=btm.transaction_id and btm.transaction_type ='LOOSE_SALE' and transaction_date&gt;='&quot;
							+ startDate
							+ &quot;' and transaction_date&lt;='&quot;
							+ endDate
							+ &quot;' and sbt.agent_org_id=&quot;
							+ agtOrgId
							+ &quot; group by date(transaction_date)))saleTlb group by date&quot;;

<span class="nc" id="L327">					cancelQry = &quot;select agent_org_id,ifnull(sum(mrp_amt),0.0) as mrp_amt,ifnull(sum(netAmt),0.0) netAmt, date from(select sbt.agent_org_id,ifnull(sum(mrp_amt),0.0) as mrp_amt,ifnull(sum(net_amt),0.0) netAmt,date(btm.transaction_date) date from st_se_bo_agent_transaction sbt,st_lms_bo_transaction_master btm where sbt.transaction_id=btm.transaction_id and btm.transaction_type ='SALE_RET' and transaction_date&gt;='&quot;</span>
							+ startDate
							+ &quot;' and transaction_date&lt;='&quot;
							+ endDate
							+ &quot;' and sbt.agent_org_id=&quot;
							+ agtOrgId
							+ &quot; group by date(transaction_date)) union all (select sbt.agent_org_id,ifnull(sum(mrp_amt),0.0) as mrp_amt,ifnull(sum(net_amt),0.0) netAmt,date(btm.transaction_date) date from st_se_bo_agent_loose_book_transaction sbt,st_lms_bo_transaction_master btm where sbt.transaction_id=btm.transaction_id and btm.transaction_type ='LOOSE_SALE_RET' and transaction_date&gt;='&quot;
							+ startDate
							+ &quot;' and transaction_date&lt;='&quot;
							+ endDate
							+ &quot;' and sbt.agent_org_id=&quot;
							+ agtOrgId
							+ &quot; group by date(transaction_date)))cancelTlb group by date&quot;;

<span class="nc bnc" id="L341" title="All 2 branches missed.">				} else if (&quot;TICKET_WISE&quot;</span>
						.equals(LMSFilterDispatcher.seSaleReportType)) {
<span class="nc" id="L343">					saleQry = &quot;select gid.current_owner_id,sum(soldTkt*ticket_price) mrpAmt,sum((soldTkt*ticket_price)-(soldTkt*ticket_price*transacrion_sale_comm_rate*0.01)) netAmt,date(transaction_date) date from &quot;</span>
							+ &quot;st_se_game_master gm,st_se_game_inv_detail gid,(select game_id,book_nbr,sum(sold_tickets) soldTkt from st_se_game_ticket_inv_history where date&gt;='&quot;
							+ startDate
							+ &quot;' and date&lt;='&quot;
							+ endDate
							+ &quot;' and current_owner='RETAILER' group by book_nbr) TktTlb where gm.game_id=TktTlb.game_id and TktTlb.book_nbr=gid.book_nbr and gid.current_owner='AGENT' and gid.current_owner_id=&quot;
							+ agtOrgId + &quot; group by date(transaction_date) &quot;;
				}
<span class="nc" id="L351">				pstmt = con.prepareStatement(saleQry);</span>
<span class="nc" id="L352">				logger.debug(&quot;***Scratch Sale Query*** \n&quot; + pstmt);</span>
<span class="nc" id="L353">				rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L355" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L356">					SimpleDateFormat dateformat = new SimpleDateFormat(</span>
							&quot;yyyy-MM-dd&quot;);
<span class="nc" id="L358">					String dateFrDtParse = dateformat</span>
							.format(rs.getDate(&quot;date&quot;));

<span class="nc" id="L361">					agtMap.get(dateFrDtParse).setSeSale(rs.getDouble(&quot;netAmt&quot;));</span>

<span class="nc" id="L363">				}</span>
<span class="nc bnc" id="L364" title="All 2 branches missed.">				if (&quot;BOOK_WISE&quot;.equals(LMSFilterDispatcher.seSaleReportType)) {</span>
<span class="nc" id="L365">					pstmt = con.prepareStatement(cancelQry);</span>
<span class="nc" id="L366">					logger.debug(&quot;***Scratch Cancel Query*** \n&quot; + pstmt);</span>
<span class="nc" id="L367">					rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L369" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L370">						SimpleDateFormat dateformat = new SimpleDateFormat(</span>
								&quot;yyyy-MM-dd&quot;);
<span class="nc" id="L372">						String dateFrDtParse = dateformat.format(rs</span>
								.getDate(&quot;date&quot;));

<span class="nc" id="L375">						agtMap.get(dateFrDtParse).setSeCancel(</span>
								rs.getDouble(&quot;netAmt&quot;));

<span class="nc" id="L378">					}</span>
				}

				// Calculate Scratch Pwt
<span class="nc" id="L382">				String pwtQry = &quot;select date(transaction_date) date,parent_id,sum(pwt) as pwt from (select bb.parent_id,sum(pwt) as pwt,transaction_date from(select srp.retailer_org_id,sum(pwt_amt+(pwt_amt*agt_claim_comm*0.01)) pwt,transaction_date from &quot;</span>
						+ &quot; st_se_retailer_pwt srp inner join st_lms_retailer_transaction_master rtm on srp.transaction_id=rtm.transaction_id and transaction_date&gt;= ? and transaction_date&lt;= ? and transaction_type='PWT' and srp.retailer_org_id in &quot;
						+ &quot;(select organization_id from st_lms_organization_master where organization_type='RETAILER')group by date(transaction_date),retailer_org_id)aa,st_lms_organization_master bb where retailer_org_id=organization_id and parent_id=&quot;
						+ agtOrgId
						+ &quot; group by date(transaction_date) union all select bb.parent_id,sum(pwt) as pwt,transaction_date from(select srp.retailer_org_id,sum(pwt_amt+(pwt_amt*claim_comm*0.01)) pwt,transaction_date from st_se_agent_pwt srp &quot;
						+ &quot;inner join st_lms_retailer_transaction_master rtm on srp.transaction_id=rtm.transaction_id and transaction_date&gt;= ? and transaction_date&lt;= ?  and transaction_type='PWT' and srp.retailer_org_id in (select organization_id from st_lms_organization_master where organization_type='RETAILER')group by date(transaction_date),retailer_org_id)aa,st_lms_organization_master bb where retailer_org_id=organization_id and parent_id=&quot;
						+ agtOrgId
						+ &quot; group by date(transaction_date)&quot;
						+ &quot;union all select agent_org_id,sum(pwt_amt+comm_amt) Pwt,transaction_date  from st_se_bo_pwt sbp inner join st_lms_bo_transaction_master btm on sbp.transaction_id=btm.transaction_id and transaction_date&gt;= ? and transaction_date&lt;= ? and transaction_type='PWT' and agent_org_id in (select organization_id from st_lms_organization_master where organization_type='AGENT' and organization_id= &quot;
						+ agtOrgId
						+ &quot;) group by date(transaction_date))pwtTlb group by date(transaction_date) &quot;;
<span class="nc" id="L393">				pstmt = con.prepareStatement(pwtQry);</span>
<span class="nc" id="L394">				pstmt.setTimestamp(1, startDate);</span>
<span class="nc" id="L395">				pstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L396">				pstmt.setTimestamp(3, startDate);</span>
<span class="nc" id="L397">				pstmt.setTimestamp(4, endDate);</span>
<span class="nc" id="L398">				pstmt.setTimestamp(5, startDate);</span>
<span class="nc" id="L399">				pstmt.setTimestamp(6, endDate);</span>
<span class="nc" id="L400">				logger.debug(&quot;***Scratch Pwt Query*** \n&quot; + pstmt);</span>
<span class="nc" id="L401">				rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L403" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L404">					SimpleDateFormat dateformat = new SimpleDateFormat(</span>
							&quot;yyyy-MM-dd&quot;);
<span class="nc" id="L406">					String dateFrDtParse = dateformat</span>
							.format(rs.getDate(&quot;date&quot;));
<span class="nc" id="L408">					agtMap.get(dateFrDtParse).setSePwt(rs.getDouble(&quot;pwt&quot;));</span>
<span class="nc" id="L409">				}</span>

				// Scratch Direct Player Qry
<span class="nc" id="L412">				String dirPwtQry = &quot;select date(transaction_date) date,agent_org_id,sum(pwt_amt+(pwt_amt*claim_comm*0.01)) pwtDir from st_se_agt_direct_player_pwt where transaction_date&gt;=? and transaction_date&lt;=? and agent_org_id=&quot;</span>
						+ agtOrgId + &quot; group by date(transaction_date) &quot;;

				// String dirPwtQry =
				// &quot;select organization_id,ifnull(pwtDir,0.0) pwtDir from (select agent_org_id,sum(pwt_amt+(pwt_amt*claim_comm*0.01)) pwtDir from st_se_agt_direct_player_pwt where transaction_date&gt;=? and transaction_date&lt;=? group by agent_org_id) pwtDirPly right outer join (select organization_id from st_lms_organization_master where organization_type='AGENT' and organization_id=&quot;+agtOrgId+&quot;) om on agent_org_id=organization_id&quot;;
<span class="nc" id="L417">				pstmt = con.prepareStatement(dirPwtQry);</span>
<span class="nc" id="L418">				pstmt.setTimestamp(1, startDate);</span>
<span class="nc" id="L419">				pstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L420">				logger</span>
						.debug(&quot;-------Scratch Direct Player Qry------\n&quot;
								+ pstmt);
<span class="nc" id="L423">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L424" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L425">					SimpleDateFormat dateformat = new SimpleDateFormat(</span>
							&quot;yyyy-MM-dd&quot;);
<span class="nc" id="L427">					String dateFrDtParse = dateformat</span>
							.format(rs.getDate(&quot;date&quot;));
<span class="nc" id="L429">					agtMap.get(dateFrDtParse).setSeDirPlyPwt(</span>
							rs.getDouble(&quot;pwtDir&quot;));
<span class="nc" id="L431">				}</span>
			}
<span class="nc bnc" id="L433" title="All 2 branches missed.">			if (ReportUtility.isCS) {</span>

				/*
				 * saleTranCS =
				 * &quot;select transaction_id from st_lms_retailer_transaction_master where transaction_type in('CS_SALE') and transaction_date&gt;='&quot;
				 * + startDate + &quot;' and transaction_date&lt;='&quot; + endDate +
				 * &quot;' and retailer_org_id in (select organization_id from st_lms_organization_master where organization_type='RETAILER')&quot;
				 * ; cancelTranCS =
				 * &quot;select transaction_id from st_lms_retailer_transaction_master where transaction_type in('CS_CANCEL_SERVER','CS_CANCEL_RET') and transaction_date&gt;='&quot;
				 * + startDate + &quot;' and transaction_date&lt;='&quot; + endDate +
				 * &quot;' and retailer_org_id in (select organization_id from st_lms_organization_master where organization_type='RETAILER')&quot;
				 * ;
				 */
				// Category Master Query
<span class="nc" id="L447">				String catQry = &quot;select category_id from st_cs_product_category_master where status = 'ACTIVE'&quot;;</span>
<span class="nc" id="L448">				PreparedStatement gamePstmt = con.prepareStatement(catQry);</span>
<span class="nc" id="L449">				ResultSet rsProduct = gamePstmt.executeQuery();</span>

<span class="nc" id="L451">				StringBuilder saleQry = new StringBuilder(</span>
						&quot;select date(transaction_date) date,parent_id,sum(sale) as sale from (&quot;);
<span class="nc" id="L453">				StringBuilder cancelQry = new StringBuilder(</span>
						&quot;select date(transaction_date) date,parent_id,sum(cancel) as cancel from (&quot;);

<span class="nc bnc" id="L456" title="All 2 branches missed.">				while (rsProduct.next()) {</span>
<span class="nc" id="L457">					saleQry</span>
							.append(&quot;(select bb.parent_id,sum(sale) as sale,transaction_date from(select drs.retailer_org_id,sum(agent_net_amt) as sale,rtm.transaction_date from st_cs_sale_&quot;
									+ rsProduct.getInt(&quot;category_id&quot;)
									+ &quot; drs,st_lms_retailer_transaction_master rtm where drs.transaction_id=rtm.transaction_id and rtm.transaction_type in('CS_SALE') and transaction_date&gt;='&quot;
									+ startDate
									+ &quot;'and transaction_date&lt;='&quot;
									+ endDate
									+ &quot;' and drs.retailer_org_id in (select organization_id from st_lms_organization_master where organization_type='RETAILER') group by date(transaction_date),drs.retailer_org_id)aa,st_lms_organization_master bb where retailer_org_id=organization_id and parent_id=&quot;
									+ agtOrgId
									+ &quot; group by date(transaction_date)) union all &quot;);

<span class="nc" id="L468">					cancelQry</span>
							.append(&quot;(select bb.parent_id,sum(cancel) as cancel,transaction_date from(select drs.retailer_org_id,sum(agent_net_amt) as cancel,rtm.transaction_date from st_cs_refund_&quot;
									+ rsProduct.getInt(&quot;category_id&quot;)
									+ &quot; drs,st_lms_retailer_transaction_master rtm where drs.transaction_id=rtm.transaction_id and rtm.transaction_type in('CS_CANCEL_SERVER','CS_CANCEL_RET') and transaction_date&gt;='&quot;
									+ startDate
									+ &quot;'and transaction_date&lt;='&quot;
									+ endDate
									+ &quot;' and drs.retailer_org_id in (select organization_id from st_lms_organization_master where organization_type='RETAILER') group by date(transaction_date),drs.retailer_org_id)aa,st_lms_organization_master bb where retailer_org_id=organization_id and parent_id=&quot;
									+ agtOrgId
									+ &quot; group by date(transaction_date)) union all &quot;);

					/*
					 * saleQry.append(
					 * &quot;(select bb.parent_id,sum(sale) as sale from (select drs.retailer_org_id,sum(agent_net_amt) as sale from st_cs_sale_&quot;
					 * + rsProduct.getInt(&quot;category_id&quot;) +
					 * &quot; drs where transaction_id in (&quot; + saleTranCS +
					 * &quot;) group by drs.retailer_org_id) aa,st_lms_organization_master bb where retailer_org_id=organization_id group by parent_id) union all&quot;
					 * );
					 * 
					 * cancelQry.append(
					 * &quot;(select bb.parent_id,sum(cancel) as cancel from (select drs.retailer_org_id,sum(agent_net_amt) as cancel from st_cs_refund_&quot;
					 * + rsProduct.getInt(&quot;category_id&quot;) +
					 * &quot; drs where transaction_id in (&quot; + cancelTranCS +
					 * &quot;) group by drs.retailer_org_id) aa,st_lms_organization_master bb where retailer_org_id=organization_id group by parent_id) union all&quot;
					 * );
					 */
				}

<span class="nc" id="L496">				saleQry.delete(saleQry.lastIndexOf(&quot;union all&quot;), saleQry</span>
						.length());
<span class="nc" id="L498">				cancelQry.delete(cancelQry.lastIndexOf(&quot;union all&quot;), cancelQry</span>
						.length());

<span class="nc" id="L501">				saleQry.append(&quot;) saleTlb group by date(transaction_date)&quot;);</span>
<span class="nc" id="L502">				cancelQry.append(&quot;) cancelTlb group by date(transaction_date)&quot;);</span>

<span class="nc" id="L504">				logger.debug(&quot;-------CS Sale Query------\n&quot; + saleQry);</span>
<span class="nc" id="L505">				logger.debug(&quot;-------CS Cancel Query------\n&quot; + cancelQry);</span>

				// CS Sale Query
<span class="nc" id="L508">				pstmt = con.prepareStatement(saleQry.toString());</span>
<span class="nc" id="L509">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L510" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L511">					SimpleDateFormat dateformat = new SimpleDateFormat(</span>
							&quot;yyyy-MM-dd&quot;);
<span class="nc" id="L513">					String dateFrDtParse = dateformat</span>
							.format(rs.getDate(&quot;date&quot;));
					// String agtOrgId = rs.getString(&quot;organization_id&quot;);

<span class="nc" id="L517">					agtMap.get(dateFrDtParse).setDgSale(rs.getDouble(&quot;sale&quot;));</span>

<span class="nc" id="L519">				}</span>
				// CS Cancel Query
<span class="nc" id="L521">				pstmt = con.prepareStatement(cancelQry.toString());</span>
<span class="nc" id="L522">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L523" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L524">					SimpleDateFormat dateformat = new SimpleDateFormat(</span>
							&quot;yyyy-MM-dd&quot;);
<span class="nc" id="L526">					String dateFrDtParse = dateformat</span>
							.format(rs.getDate(&quot;date&quot;));
					// String agtOrgId = rs.getString(&quot;organization_id&quot;);

<span class="nc" id="L530">					agtMap.get(dateFrDtParse).setCSCancel(</span>
							rs.getDouble(&quot;cancel&quot;));

<span class="nc" id="L533">				}</span>
			}
<span class="nc bnc" id="L535" title="All 2 branches missed.">			if (ReportUtility.isOLA) {</span>
<span class="nc" id="L536">				SimpleDateFormat dateformat = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span>
<span class="nc" id="L537">				StringBuilder wdQry = new StringBuilder(</span>
						&quot;select parent_id,sum(wdrawAmt) as wdraw,date(transaction_date) date from&quot;);
<span class="nc" id="L539">				StringBuilder wdRefQry = new StringBuilder(</span>
						&quot;select parent_id,sum(wdrawRefAmt) as wdrawRef,date(transaction_date) date from&quot;);// wdrawRef
<span class="nc" id="L541">				StringBuilder depQry = new StringBuilder(</span>
						&quot;select parent_id,sum(depo) as depoAmt,date(transaction_date) date from&quot;);
<span class="nc" id="L543">				StringBuilder depRefQry = new StringBuilder(</span>
						&quot;select parent_id,sum(depoRef) as depoRefAmt,date(transaction_date) date from&quot;);

<span class="nc" id="L546">				wdQry</span>
						.append(&quot;(select drs.retailer_org_id,sum(agent_net_amt) as wdrawAmt,rtm.transaction_date from st_ola_ret_withdrawl drs,st_lms_retailer_transaction_master rtm where drs.transaction_id=rtm.transaction_id and rtm.transaction_type in('OLA_WITHDRAWL') and transaction_date&gt;='&quot;
								+ startDate
								+ &quot;' and transaction_date&lt;='&quot;
								+ endDate
								+ &quot;' and drs.retailer_org_id in (select organization_id from st_lms_organization_master where organization_type='RETAILER') group by date(transaction_date),drs.retailer_org_id)aa,st_lms_organization_master bb where retailer_org_id=organization_id and parent_id=&quot;
								+ agtOrgId + &quot; group by date(transaction_date)&quot;);

<span class="nc" id="L554">				wdRefQry</span>
						.append(&quot;(select drs.retailer_org_id,sum(agent_net_amt) as wdrawRefAmt,rtm.transaction_date from st_ola_ret_withdrawl_refund drs,st_lms_retailer_transaction_master rtm where drs.transaction_id=rtm.transaction_id and rtm.transaction_type in('OLA_WITHDRAWL_REFUND') and transaction_date&gt;='&quot;
								+ startDate
								+ &quot;'and transaction_date&lt;='&quot;
								+ endDate
								+ &quot;' and drs.retailer_org_id in (select organization_id from st_lms_organization_master where organization_type='RETAILER') group by date(transaction_date),drs.retailer_org_id)aa,st_lms_organization_master bb where retailer_org_id=organization_id and parent_id=&quot;
								+ agtOrgId + &quot; group by date(transaction_date)&quot;);
<span class="nc" id="L561">				depQry</span>
						.append(&quot;(select drs.retailer_org_id,sum(agent_net_amt) as depo,rtm.transaction_date from st_ola_ret_deposit drs,st_lms_retailer_transaction_master rtm where drs.transaction_id=rtm.transaction_id and rtm.transaction_type in('OLA_DEPOSIT') and transaction_date&gt;='&quot;
								+ startDate
								+ &quot;' and transaction_date&lt;='&quot;
								+ endDate
								+ &quot;' and drs.retailer_org_id in (select organization_id from st_lms_organization_master where organization_type='RETAILER') group by date(transaction_date),drs.retailer_org_id)aa,st_lms_organization_master bb where retailer_org_id=organization_id and parent_id=&quot;
								+ agtOrgId + &quot; group by date(transaction_date)&quot;);

<span class="nc" id="L569">				depRefQry</span>
						.append(&quot;(select drs.retailer_org_id,sum(agent_net_amt) as depoRef,rtm.transaction_date from st_ola_ret_deposit_refund drs,st_lms_retailer_transaction_master rtm where drs.transaction_id=rtm.transaction_id and rtm.transaction_type in('OLA_DEPOSIT_REFUND') and transaction_date&gt;='&quot;
								+ startDate
								+ &quot;' and transaction_date&lt;='&quot;
								+ endDate
								+ &quot;' and drs.retailer_org_id in (select organization_id from st_lms_organization_master where organization_type='RETAILER') group by date(transaction_date),drs.retailer_org_id)aa,st_lms_organization_master bb where retailer_org_id=organization_id and parent_id=&quot;
								+ agtOrgId + &quot; group by date(transaction_date)&quot;);

<span class="nc" id="L577">				String netGamingQry = &quot;select om.parent_id parent_id, sum(netGamingAmt) netAmt,date(transaction_date) date from(select wrs.retailer_org_id, agt_net_claim_comm as netGamingAmt,transaction_date from st_ola_ret_comm wrs inner join st_lms_retailer_transaction_master rt on wrs.transaction_id=rt.transaction_id where transaction_type = 'OLA_COMMISSION' and transaction_date&gt;='&quot;+ startDate+ &quot;' and transaction_date&lt;='&quot;+ endDate+ &quot;') wdret inner join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on om.organization_id = wdret.retailer_org_id where om.parent_id=&quot;+ agtOrgId + &quot; group by date(transaction_date)&quot;;</span>
<span class="nc" id="L578">				logger.debug(&quot;-------Withdrawal Query------\n&quot; + wdQry);</span>
<span class="nc" id="L579">				logger.debug(&quot;-------WithDrawal Refund Query------\n&quot;</span>
						+ wdRefQry);
<span class="nc" id="L581">				logger.debug(&quot;-------Deposit Query------\n&quot; + depQry);</span>
<span class="nc" id="L582">				logger.debug(&quot;-------Deposit Refund Query------\n&quot; + depRefQry);</span>
<span class="nc" id="L583">				logger.debug(&quot;-------Net Gaming Query------\n&quot; + netGamingQry);</span>

				// Withdrawal Query
<span class="nc" id="L586">				pstmt = con.prepareStatement(wdQry.toString());</span>
<span class="nc" id="L587">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L588" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L589">					agtMap.get(dateformat.format(rs.getDate(&quot;date&quot;)))</span>
							.setWithdrawal(rs.getDouble(&quot;wdraw&quot;));
				}
				// WithDrawal Refund Query
<span class="nc" id="L593">				pstmt = con.prepareStatement(wdRefQry.toString());</span>
<span class="nc" id="L594">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L595" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L596">					agtMap.get(dateformat.format(rs.getDate(&quot;date&quot;)))</span>
							.setWithdrawalRefund(rs.getDouble(&quot;wdrawRef&quot;));
				}

				// Deposit Query
<span class="nc" id="L601">				pstmt = con.prepareStatement(depQry.toString());</span>
<span class="nc" id="L602">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L603" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L604">					agtMap.get(dateformat.format(rs.getDate(&quot;date&quot;)))</span>
							.setDeposit(rs.getDouble(&quot;depoAmt&quot;));
				}
				// Deposit Refund Query
<span class="nc" id="L608">				pstmt = con.prepareStatement(depRefQry.toString());</span>
<span class="nc" id="L609">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L610" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L611">					agtMap.get(dateformat.format(rs.getDate(&quot;date&quot;)))</span>
							.setDepositRefund(rs.getDouble(&quot;depoRefAmt&quot;));
				}

				// net gaming commission query
<span class="nc" id="L616">				pstmt = con.prepareStatement(netGamingQry);</span>
<span class="nc" id="L617">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L618" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L619">					agtMap.get(dateformat.format(rs.getDate(&quot;date&quot;)))</span>
							.setNetGamingComm(rs.getDouble(&quot;netAmt&quot;));
				}
			}
<span class="nc" id="L623">		} catch (Exception e) {</span>
<span class="nc" id="L624">			e.printStackTrace();</span>
<span class="nc" id="L625">			throw new LMSException(&quot;Error in report collectionAgentWise&quot;);</span>
<span class="nc" id="L626">		}</span>
<span class="nc" id="L627">	}</span>

	public void collectionAgentWise(Timestamp startDate, Timestamp endDate,
			Connection con, Map&lt;String, CollectionReportOverAllBean&gt; agtMap,
			int agtOrgId) throws LMSException {

<span class="nc" id="L633">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L634">		ResultSet rs = null;</span>

<span class="nc" id="L636">		String saleTranDG = null;</span>
<span class="nc" id="L637">		String cancelTranDG = null;</span>
<span class="nc" id="L638">		String pwtTranDG = null;</span>

<span class="nc" id="L640">		String saleTranCS = null;</span>
<span class="nc" id="L641">		String cancelTranCS = null;</span>
<span class="nc bnc" id="L642" title="All 2 branches missed.">		if (startDate.after(endDate)) {</span>
<span class="nc" id="L643">			return;</span>
		}

		try {
			// Get Account Details

<span class="nc" id="L649">			String addOrgQry = &quot;right outer join (select organization_id from st_lms_organization_master where organization_type='AGENT' and organization_id=&quot;</span>
					+ agtOrgId + &quot; ) om on agent_org_id=organization_id&quot;;
<span class="nc" id="L651">			String cashQry = &quot;(select organization_id,cash from (select agent_org_id,sum(amount) cash from st_lms_bo_cash_transaction cash,st_lms_bo_transaction_master btm where cash.transaction_id=btm.transaction_id and transaction_date&gt;='&quot;</span>
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' group by agent_org_id) cash &quot; + addOrgQry + &quot;) cash&quot;;
<span class="nc" id="L656">			String chqQry = &quot;(select organization_id,chq from (select agent_org_id,sum(cheque_amt) chq from st_lms_bo_sale_chq chq,st_lms_bo_transaction_master btm where chq.transaction_id=btm.transaction_id and chq.transaction_type IN ('CHEQUE','CLOSED') and transaction_date&gt;='&quot;</span>
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' group by agent_org_id) chq &quot; + addOrgQry + &quot;) chq&quot;;
<span class="nc" id="L661">			String chqRetQry = &quot;(select organization_id,chq_ret from (select agent_org_id,sum(cheque_amt) chq_ret from st_lms_bo_sale_chq chq,st_lms_bo_transaction_master btm where chq.transaction_id=btm.transaction_id and chq.transaction_type IN ('CHQ_BOUNCE') and transaction_date&gt;='&quot;</span>
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' group by agent_org_id) chq_ret &quot;
					+ addOrgQry
					+ &quot;) chq_ret&quot;;
<span class="nc" id="L668">			String debitQry = &quot;(select organization_id,debit from (select agent_org_id,sum(amount) debit from st_lms_bo_debit_note debit,st_lms_bo_transaction_master btm where debit.transaction_id=btm.transaction_id and debit.transaction_type IN ('DR_NOTE_CASH','DR_NOTE') and transaction_date&gt;='&quot;</span>
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' group by agent_org_id) debit &quot; + addOrgQry + &quot;) debit&quot;;
<span class="nc" id="L673">			String creditQry = &quot;(select organization_id,credit from (select agent_org_id,sum(amount) credit from st_lms_bo_credit_note credit,st_lms_bo_transaction_master btm where credit.transaction_id=btm.transaction_id and credit.transaction_type IN ('CR_NOTE_CASH','CR_NOTE') and transaction_date&gt;='&quot;</span>
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' group by agent_org_id) credit &quot;
					+ addOrgQry
					+ &quot;) credit&quot;;
<span class="nc" id="L680">			String bankQry = &quot;(select organization_id,bank from (select agent_org_id,sum(amount) bank from st_lms_bo_bank_deposit_transaction bank,st_lms_bo_transaction_master btm where bank.transaction_id=btm.transaction_id and transaction_date&gt;='&quot;</span>
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' group by agent_org_id) bank &quot; + addOrgQry + &quot;) bank&quot;;

<span class="nc" id="L686">			String accQry = &quot;select cash.organization_id,ifnull(cash,0.0) cash,ifnull(chq,0.0) chq,ifnull(chq_ret,0.0) chq_ret,ifnull(debit,0.0) debit,ifnull(credit,0.0) credit, ifnull(bank,0.0) bank from &quot;</span>
					+ cashQry
					+ &quot;,&quot;
					+ chqQry
					+ &quot;,&quot;
					+ chqRetQry
					+ &quot;,&quot;
					+ debitQry
					+ &quot;,&quot;
					+ creditQry
					+ &quot;,&quot;
					+ bankQry
					+ &quot; where cash.organization_id=chq.organization_id and cash.organization_id=chq_ret.organization_id and cash.organization_id=debit.organization_id and cash.organization_id=credit.organization_id and cash.organization_id=bank.organization_id and chq.organization_id=chq_ret.organization_id and chq.organization_id=debit.organization_id and chq.organization_id=credit.organization_id and chq.organization_id=bank.organization_id and chq_ret.organization_id=debit.organization_id and chq_ret.organization_id=credit.organization_id and chq_ret.organization_id=bank.organization_id  and debit.organization_id=credit.organization_id and debit.organization_id=bank.organization_id and credit.organization_id=bank.organization_id &quot;;
<span class="nc" id="L699">			pstmt = con.prepareStatement(accQry);</span>
<span class="nc" id="L700">			logger.debug(&quot;---Account Detail Query---&quot; + pstmt);</span>
<span class="nc" id="L701">			rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L703" title="All 2 branches missed.">			while (rs.next()) {</span>
				// String agtOrgId = rs.getString(&quot;organization_id&quot;);
<span class="nc" id="L705">				agtMap.get(agtOrgId + &quot;&quot;).setCash(rs.getDouble(&quot;cash&quot;));</span>
<span class="nc" id="L706">				agtMap.get(agtOrgId + &quot;&quot;).setCheque(rs.getDouble(&quot;chq&quot;));</span>
<span class="nc" id="L707">				agtMap.get(agtOrgId + &quot;&quot;).setChequeReturn(</span>
						rs.getDouble(&quot;chq_ret&quot;));
<span class="nc" id="L709">				agtMap.get(agtOrgId + &quot;&quot;).setCredit(rs.getDouble(&quot;credit&quot;));</span>
<span class="nc" id="L710">				agtMap.get(agtOrgId + &quot;&quot;).setDebit(rs.getDouble(&quot;debit&quot;));</span>
<span class="nc" id="L711">				agtMap.get(agtOrgId + &quot;&quot;).setBankDep(rs.getDouble(&quot;bank&quot;));</span>
			}

<span class="nc bnc" id="L714" title="All 2 branches missed.">			if (ReportUtility.isDG) {</span>
<span class="nc" id="L715">				saleTranDG = &quot;select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_SALE','DG_SALE_OFFLINE') and transaction_date&gt;='&quot;</span>
						+ startDate
						+ &quot;' and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;' and retailer_org_id in (select organization_id from st_lms_organization_master where organization_type='RETAILER')&quot;;
<span class="nc" id="L720">				cancelTranDG = &quot;select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_REFUND_CANCEL','DG_REFUND_FAILED') and transaction_date&gt;='&quot;</span>
						+ startDate
						+ &quot;' and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;' and retailer_org_id in (select organization_id from st_lms_organization_master where organization_type='RETAILER')&quot;;
<span class="nc" id="L725">				pwtTranDG = &quot;select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_PWT_AUTO','DG_PWT_PLR','DG_PWT') and transaction_date&gt;='&quot;</span>
						+ startDate
						+ &quot;' and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;' and retailer_org_id in (select organization_id from st_lms_organization_master where organization_type='RETAILER')&quot;;

				// Game Master Query
<span class="nc" id="L732">				String gameQry = &quot;select game_id from st_dg_game_master&quot;;</span>
<span class="nc" id="L733">				PreparedStatement gamePstmt = con.prepareStatement(gameQry);</span>
<span class="nc" id="L734">				ResultSet rsGame = gamePstmt.executeQuery();</span>
<span class="nc" id="L735">				StringBuilder saleQry = new StringBuilder(</span>
						&quot;select organization_id,ifnull(sale,0.0) sale from (select parent_id,sum(sale) as sale from (&quot;);
<span class="nc" id="L737">				StringBuilder cancelQry = new StringBuilder(</span>
						&quot;select organization_id,ifnull(cancel,0.0) cancel from (select parent_id,sum(cancel) as cancel from (&quot;);
<span class="nc" id="L739">				StringBuilder pwtQry = new StringBuilder(</span>
						&quot;select organization_id,ifnull(pwt,0.0) pwt from (select parent_id,sum(pwt) as pwt from (&quot;);
<span class="nc bnc" id="L741" title="All 2 branches missed.">				while (rsGame.next()) {</span>
<span class="nc" id="L742">					saleQry</span>
							.append(&quot;(select bb.parent_id,sum(sale) as sale from (select drs.retailer_org_id,sum(agent_net_amt) as sale from st_dg_ret_sale_&quot;
									+ rsGame.getInt(&quot;game_id&quot;)
									+ &quot; drs where transaction_id in (&quot;
									+ saleTranDG
									+ &quot;) group by drs.retailer_org_id) aa,st_lms_organization_master bb where retailer_org_id=organization_id group by parent_id) union all&quot;);

<span class="nc" id="L749">					cancelQry</span>
							.append(&quot;(select bb.parent_id,sum(cancel) as cancel from (select drs.retailer_org_id,sum(agent_net_amt) as cancel from st_dg_ret_sale_refund_&quot;
									+ rsGame.getInt(&quot;game_id&quot;)
									+ &quot; drs where transaction_id in (&quot;
									+ cancelTranDG
									+ &quot;) group by drs.retailer_org_id) aa,st_lms_organization_master bb where retailer_org_id=organization_id group by parent_id) union all&quot;);

<span class="nc" id="L756">					pwtQry</span>
							.append(&quot;(select bb.parent_id,sum(pwt) as pwt from (select drs.retailer_org_id,sum(pwt_amt+agt_claim_comm) as pwt from st_dg_ret_pwt_&quot;
									+ rsGame.getInt(&quot;game_id&quot;)
									+ &quot; drs where transaction_id in (&quot;
									+ pwtTranDG
									+ &quot;) group by drs.retailer_org_id) aa,st_lms_organization_master bb where retailer_org_id=organization_id group by parent_id) union all&quot;);

				}

<span class="nc" id="L765">				saleQry.delete(saleQry.lastIndexOf(&quot;union all&quot;), saleQry</span>
						.length());
<span class="nc" id="L767">				cancelQry.delete(cancelQry.lastIndexOf(&quot;union all&quot;), cancelQry</span>
						.length());
<span class="nc" id="L769">				pwtQry.delete(pwtQry.lastIndexOf(&quot;union all&quot;), pwtQry.length());</span>

<span class="nc" id="L771">				saleQry</span>
						.append(&quot;) saleTlb group by parent_id) saleTlb right outer join (select organization_id from st_lms_organization_master where organization_type='AGENT' and organization_id=&quot;
								+ agtOrgId
								+ &quot;) om on parent_id=organization_id&quot;);
<span class="nc" id="L775">				cancelQry</span>
						.append(&quot;) cancelTlb group by parent_id) cancelTlb right outer join (select organization_id from st_lms_organization_master where organization_type='AGENT' and organization_id=&quot;
								+ agtOrgId
								+ &quot;) om on parent_id=organization_id&quot;);
<span class="nc" id="L779">				pwtQry</span>
						.append(&quot;) pwtTlb group by parent_id) pwtTlb right outer join (select organization_id from st_lms_organization_master where organization_type='AGENT' and organization_id=&quot;
								+ agtOrgId
								+ &quot;) om on parent_id=organization_id&quot;);
<span class="nc" id="L783">				logger.debug(&quot;-------Draw Sale Qurey------\n&quot; + saleQry);</span>
<span class="nc" id="L784">				logger.debug(&quot;-------Draw Cancel Qurey------\n&quot; + cancelQry);</span>
<span class="nc" id="L785">				logger.debug(&quot;-------Draw Pwt Qurey------\n&quot; + pwtQry);</span>

				// Draw Sale Query
<span class="nc" id="L788">				pstmt = con.prepareStatement(saleQry.toString());</span>
<span class="nc" id="L789">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L790" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L791">					agtMap.get(rs.getString(&quot;organization_id&quot;)).setDgSale(</span>
							rs.getDouble(&quot;sale&quot;));
				}
				// Draw Cancel Query
<span class="nc" id="L795">				pstmt = con.prepareStatement(cancelQry.toString());</span>
<span class="nc" id="L796">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L797" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L798">					agtMap.get(rs.getString(&quot;organization_id&quot;)).setDgCancel(</span>
							rs.getDouble(&quot;cancel&quot;));
				}
				// Draw Pwt Query
<span class="nc" id="L802">				pstmt = con.prepareStatement(pwtQry.toString());</span>
<span class="nc" id="L803">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L804" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L805">					agtMap.get(rs.getString(&quot;organization_id&quot;)).setDgPwt(</span>
							rs.getDouble(&quot;pwt&quot;));
				}

				// Draw Direct Player Qry

<span class="nc" id="L811">				String dirPwtQry = &quot;select organization_id,ifnull(pwtDir,0.0) pwtDir from (select agent_org_id,sum(pwt_amt+agt_claim_comm) pwtDir from st_dg_agt_direct_plr_pwt where transaction_date&gt;=? and transaction_date&lt;=? group by agent_org_id) pwtDirPly right outer join (select organization_id from st_lms_organization_master where organization_type='AGENT' and organization_id=&quot;</span>
						+ agtOrgId + &quot;) om on agent_org_id=organization_id&quot;;
<span class="nc" id="L813">				pstmt = con.prepareStatement(dirPwtQry);</span>
<span class="nc" id="L814">				pstmt.setTimestamp(1, startDate);</span>
<span class="nc" id="L815">				pstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L816">				logger.debug(&quot;-------Draw Direct Player Qry------\n&quot; + pstmt);</span>
<span class="nc" id="L817">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L818" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L819">					agtMap.get(rs.getString(&quot;organization_id&quot;)).setDgDirPlyPwt(</span>
							rs.getDouble(&quot;pwtDir&quot;));
				}
			}
<span class="nc bnc" id="L823" title="All 2 branches missed.">			if (ReportUtility.isSE) {</span>
				// Calculate Scratch Sale
<span class="nc" id="L825">				String saleQry = &quot;&quot;;</span>
<span class="nc" id="L826">				logger.info(&quot;----Type Select ---&quot;</span>
						+ LMSFilterDispatcher.seSaleReportType);
<span class="nc bnc" id="L828" title="All 2 branches missed.">				if (&quot;BOOK_WISE&quot;.equals(LMSFilterDispatcher.seSaleReportType)) {</span>
<span class="nc" id="L829">					saleQry = &quot;select sale.organization_id,(ifnull(mrpAmt,0.0)-ifnull(mrpAmtRet,0.0)) mrpAmt,(ifnull(netAmt,0.0)-ifnull(netAmtRet,0.0)) netAmt from (select organization_id,name,ifnull(mrpAmt,0.0) mrpAmt,ifnull(netAmt,0.0) netAmt from st_lms_organization_master left outer join (select sale1.agent_org_id,sum(mrpAmt) mrpAmt,sum(netAmt) netAmt from (select agent_org_id,sum(mrp_amt) mrpAmt,sum(net_amt) netAmt from st_se_bo_agent_transaction at inner join st_lms_bo_transaction_master tm on at.transaction_id=tm.transaction_id where  tm.transaction_type='SALE' and transaction_date&gt;='&quot;</span>
							+ startDate
							+ &quot;' and transaction_date&lt;='&quot;
							+ endDate
							+ &quot;' and agent_org_id=&quot;
							+ agtOrgId
							+ &quot; group by agent_org_id union all select agent_org_id,sum(mrp_amt) mrpAmt,sum(net_amt) sale from st_se_bo_agent_loose_book_transaction at inner join st_lms_bo_transaction_master tm on at.transaction_id=tm.transaction_id where  tm.transaction_type='LOOSE_SALE' and transaction_date&gt;='&quot;
							+ startDate
							+ &quot;' and transaction_date&lt;='&quot;
							+ endDate
							+ &quot;' and agent_org_id=&quot;
							+ agtOrgId
							+ &quot; group by agent_org_id)sale1 group by agent_org_id )sale on organization_id=agent_org_id where organization_type='AGENT')sale inner join (select organization_id,name,ifnull(mrpAmtRet,0.0) mrpAmtRet,ifnull(netAmtRet,0.0) netAmtRet from st_lms_organization_master left outer join (select cancel1.agent_org_id,sum(mrpAmtRet) mrpAmtRet,sum(netAmtRet) netAmtRet from (select agent_org_id,sum(mrp_amt) mrpAmtRet,sum(net_amt) netAmtRet from st_se_bo_agent_transaction at inner join st_lms_bo_transaction_master tm on at.transaction_id=tm.transaction_id where  tm.transaction_type='SALE_RET' and transaction_date&gt;='&quot;
							+ startDate
							+ &quot;' and transaction_date&lt;='&quot;
							+ endDate
							+ &quot;' and agent_org_id=&quot;
							+ agtOrgId
							+ &quot; group by agent_org_id union all select agent_org_id,sum(mrp_amt) mrpAmtRet,sum(net_amt) netAmtRet from st_se_bo_agent_loose_book_transaction at inner join st_lms_bo_transaction_master tm on at.transaction_id=tm.transaction_id where  tm.transaction_type='LOOSE_SALE_RET' and transaction_date&gt;='&quot;
							+ startDate
							+ &quot;' and transaction_date&lt;='&quot;
							+ endDate
							+ &quot;' and agent_org_id=&quot;
							+ agtOrgId
							+ &quot; group by agent_org_id)cancel1 group by agent_org_id) saleRet on organization_id=agent_org_id where organization_type='AGENT') saleRet on sale.organization_id=saleRet.organization_id&quot;;
<span class="nc bnc" id="L854" title="All 2 branches missed.">				} else if (&quot;TICKET_WISE&quot;</span>
						.equals(LMSFilterDispatcher.seSaleReportType)) {
<span class="nc" id="L856">					saleQry = &quot;select organization_id,name,ifnull(mrpAmt,0.0) mrpAmt,ifnull(netAmt,0.0) netAmt from st_lms_organization_master left outer join (select current_owner_id,sum(soldTkt*ticket_price) mrpAmt,sum((soldTkt*ticket_price)-(soldTkt*ticket_price*transacrion_sale_comm_rate*0.01)) netAmt from st_se_game_master gm,st_se_game_inv_detail gid,(select game_id,book_nbr,sum(sold_tickets) soldTkt from st_se_game_ticket_inv_history where date&gt;='&quot;</span>
							+ startDate
							+ &quot;' and date&lt;='&quot;
							+ endDate
							+ &quot;' and current_owner='RETAILER' group by book_nbr) TktTlb where gm.game_id=TktTlb.game_id and TktTlb.book_nbr=gid.book_nbr and gid.current_owner='AGENT' group by current_owner_id) saleTlb on organization_id=current_owner_id where organization_type='AGENT' and organization_id=&quot;
							+ agtOrgId;
				}
<span class="nc" id="L863">				pstmt = con.prepareStatement(saleQry);</span>
<span class="nc" id="L864">				logger.debug(&quot;***Scratch Sale Query*** \n&quot; + pstmt);</span>
<span class="nc" id="L865">				rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L867" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L868">					agtMap.get(rs.getString(&quot;organization_id&quot;)).setSeSale(</span>
							rs.getDouble(&quot;netAmt&quot;));
				}

				// Calculate Scratch Pwt
<span class="nc" id="L873">				String pwtQry = &quot;select organization_id,ifnull(sum(pwt),0.0) pwt from (select bb.parent_id,sum(pwt) as pwt from (select retailer_org_id,sum(pwt_amt+(pwt_amt*agt_claim_comm*0.01)) pwt from st_se_retailer_pwt where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_date&gt;=? and transaction_date&lt;=? and transaction_type='PWT' and retailer_org_id in (select organization_id from st_lms_organization_master where organization_type='RETAILER')) group by retailer_org_id union all select retailer_org_id,sum(pwt_amt+(pwt_amt*claim_comm*0.01)) pwt from st_se_agent_pwt where transaction_id in (select transaction_id from st_lms_agent_transaction_master where transaction_date&gt;=? and transaction_date&lt;=? and transaction_type='PWT' and retailer_org_id in (select organization_id from st_lms_organization_master where organization_type='RETAILER')) group by retailer_org_id) aa,st_lms_organization_master bb where retailer_org_id=organization_id group by parent_id union all select agent_org_id,sum(pwt_amt+comm_amt) boPwt from st_se_bo_pwt where transaction_id in (select transaction_id from st_lms_bo_transaction_master where transaction_date&gt;=? and transaction_date&lt;=? and transaction_type='PWT' and agent_org_id in (select organization_id from st_lms_organization_master where organization_type='AGENT' and organization_id=&quot;</span>
						+ agtOrgId
						+ &quot;)) group by agent_org_id) pwtTlb right outer join (select organization_id from st_lms_organization_master where organization_type='AGENT' and organization_id=&quot;
						+ agtOrgId
						+ &quot;) om on parent_id=organization_id group by organization_id&quot;;
<span class="nc" id="L878">				pstmt = con.prepareStatement(pwtQry);</span>
<span class="nc" id="L879">				pstmt.setTimestamp(1, startDate);</span>
<span class="nc" id="L880">				pstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L881">				pstmt.setTimestamp(3, startDate);</span>
<span class="nc" id="L882">				pstmt.setTimestamp(4, endDate);</span>
<span class="nc" id="L883">				pstmt.setTimestamp(5, startDate);</span>
<span class="nc" id="L884">				pstmt.setTimestamp(6, endDate);</span>
<span class="nc" id="L885">				logger.debug(&quot;***Scratch Pwt Query*** \n&quot; + pstmt);</span>
<span class="nc" id="L886">				rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L888" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L889">					agtMap.get(rs.getString(&quot;organization_id&quot;)).setSePwt(</span>
							rs.getDouble(&quot;pwt&quot;));
				}

				// Scratch Direct Player Qry

<span class="nc" id="L895">				String dirPwtQry = &quot;select organization_id,ifnull(pwtDir,0.0) pwtDir from (select agent_org_id,sum(pwt_amt+(pwt_amt*claim_comm*0.01)) pwtDir from st_se_agt_direct_player_pwt where transaction_date&gt;=? and transaction_date&lt;=? group by agent_org_id) pwtDirPly right outer join (select organization_id from st_lms_organization_master where organization_type='AGENT' and organization_id=&quot;</span>
						+ agtOrgId + &quot;) om on agent_org_id=organization_id&quot;;
<span class="nc" id="L897">				pstmt = con.prepareStatement(dirPwtQry);</span>
<span class="nc" id="L898">				pstmt.setTimestamp(1, startDate);</span>
<span class="nc" id="L899">				pstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L900">				logger</span>
						.debug(&quot;-------Scratch Direct Player Qry------\n&quot;
								+ pstmt);
<span class="nc" id="L903">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L904" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L905">					agtMap.get(rs.getString(&quot;organization_id&quot;)).setSeDirPlyPwt(</span>
							rs.getDouble(&quot;pwtDir&quot;));
				}
			}
<span class="nc bnc" id="L909" title="All 2 branches missed.">			if (ReportUtility.isCS) {</span>

<span class="nc" id="L911">				saleTranCS = &quot;select transaction_id from st_lms_retailer_transaction_master where transaction_type in('CS_SALE') and transaction_date&gt;='&quot;</span>
						+ startDate
						+ &quot;' and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;' and retailer_org_id in (select organization_id from st_lms_organization_master where organization_type='RETAILER')&quot;;
<span class="nc" id="L916">				cancelTranCS = &quot;select transaction_id from st_lms_retailer_transaction_master where transaction_type in('CS_CANCEL_SERVER','CS_CANCEL_RET') and transaction_date&gt;='&quot;</span>
						+ startDate
						+ &quot;' and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;' and retailer_org_id in (select organization_id from st_lms_organization_master where organization_type='RETAILER')&quot;;

				// Category Master Query
<span class="nc" id="L923">				String catQry = &quot;select category_id from st_cs_product_category_master where status = 'ACTIVE'&quot;;</span>
<span class="nc" id="L924">				PreparedStatement gamePstmt = con.prepareStatement(catQry);</span>
<span class="nc" id="L925">				ResultSet rsProduct = gamePstmt.executeQuery();</span>
<span class="nc" id="L926">				StringBuilder saleQry = new StringBuilder(</span>
						&quot;select organization_id,ifnull(sale,0.0) sale from (select parent_id,sum(sale) as sale from (&quot;);
<span class="nc" id="L928">				StringBuilder cancelQry = new StringBuilder(</span>
						&quot;select organization_id,ifnull(cancel,0.0) cancel from (select parent_id,sum(cancel) as cancel from (&quot;);
<span class="nc bnc" id="L930" title="All 2 branches missed.">				while (rsProduct.next()) {</span>
<span class="nc" id="L931">					saleQry</span>
							.append(&quot;(select bb.parent_id,sum(sale) as sale from (select drs.retailer_org_id,sum(agent_net_amt) as sale from st_cs_sale_&quot;
									+ rsProduct.getInt(&quot;category_id&quot;)
									+ &quot; drs where transaction_id in (&quot;
									+ saleTranCS
									+ &quot;) group by drs.retailer_org_id) aa,st_lms_organization_master bb where retailer_org_id=organization_id group by parent_id) union all&quot;);

<span class="nc" id="L938">					cancelQry</span>
							.append(&quot;(select bb.parent_id,sum(cancel) as cancel from (select drs.retailer_org_id,sum(agent_net_amt) as cancel from st_cs_refund_&quot;
									+ rsProduct.getInt(&quot;category_id&quot;)
									+ &quot; drs where transaction_id in (&quot;
									+ cancelTranCS
									+ &quot;) group by drs.retailer_org_id) aa,st_lms_organization_master bb where retailer_org_id=organization_id group by parent_id) union all&quot;);

				}

<span class="nc" id="L947">				saleQry.delete(saleQry.lastIndexOf(&quot;union all&quot;), saleQry</span>
						.length());
<span class="nc" id="L949">				cancelQry.delete(cancelQry.lastIndexOf(&quot;union all&quot;), cancelQry</span>
						.length());

<span class="nc" id="L952">				saleQry</span>
						.append(&quot;) saleTlb group by parent_id) saleTlb right outer join (select organization_id from st_lms_organization_master where organization_type='AGENT' and organization_id=&quot;
								+ agtOrgId
								+ &quot;) om on parent_id=organization_id&quot;);
<span class="nc" id="L956">				cancelQry</span>
						.append(&quot;) cancelTlb group by parent_id) cancelTlb right outer join (select organization_id from st_lms_organization_master where organization_type='AGENT' and organization_id=&quot;
								+ agtOrgId
								+ &quot;) om on parent_id=organization_id&quot;);

<span class="nc" id="L961">				logger.debug(&quot;-------CS Sale Query------\n&quot; + saleQry);</span>
<span class="nc" id="L962">				logger.debug(&quot;-------CS Cancel Query------\n&quot; + cancelQry);</span>

				// CS Sale Query
<span class="nc" id="L965">				pstmt = con.prepareStatement(saleQry.toString());</span>
<span class="nc" id="L966">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L967" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L968">					agtMap.get(rs.getString(&quot;organization_id&quot;)).setCSSale(</span>
							rs.getDouble(&quot;sale&quot;));
				}
				// CS Cancel Query
<span class="nc" id="L972">				pstmt = con.prepareStatement(cancelQry.toString());</span>
<span class="nc" id="L973">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L974" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L975">					agtMap.get(rs.getString(&quot;organization_id&quot;)).setCSCancel(</span>
							rs.getDouble(&quot;cancel&quot;));
				}
			}
<span class="nc bnc" id="L979" title="All 2 branches missed.">			if (ReportUtility.isOLA) {</span>

<span class="nc" id="L981">				StringBuilder wdQry = new StringBuilder(</span>
						&quot;select parent_id agtOrgId,wdraw from &quot;);
<span class="nc" id="L983">				StringBuilder wdRefQry = new StringBuilder(</span>
						&quot;select parent_id agtOrgId,wdrawRef from &quot;);
<span class="nc" id="L985">				StringBuilder depQry = new StringBuilder(</span>
						&quot;select parent_id agtOrgId,depoAmt from &quot;);
<span class="nc" id="L987">				StringBuilder depRefQry = new StringBuilder(</span>
						&quot;select parent_id agtOrgId,depoRefAmt from&quot;);

<span class="nc" id="L990">				wdQry</span>
						.append(&quot;(select parent_id,ifnull(sum(withd),0.0) wdraw from st_lms_organization_master om left outer join (select wrs.retailer_org_id, agent_net_amt as withd from st_ola_ret_withdrawl wrs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type = 'OLA_WITHDRAWL' and transaction_date&gt;='&quot;
								+ startDate
								+ &quot;' and transaction_date&lt;='&quot;
								+ endDate
								+ &quot;'))withdRef on om.organization_id=retailer_org_id where om.organization_type='RETAILER' and om.parent_id=&quot;
								+ agtOrgId + &quot; group by parent_id) withRef&quot;);

<span class="nc" id="L998">				wdRefQry</span>
						.append(&quot;(select parent_id,ifnull(sum(withd),0.0) wdrawRef from st_lms_organization_master om left outer join (select wrs.retailer_org_id, agent_net_amt as withd from st_ola_ret_withdrawl_refund wrs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type = 'OLA_WITHDRAWL_REFUND' and transaction_date&gt;='&quot;
								+ startDate
								+ &quot;' and transaction_date&lt;='&quot;
								+ endDate
								+ &quot;'))withdRef on om.organization_id=retailer_org_id where om.organization_type='RETAILER' and om.parent_id=&quot;
								+ agtOrgId + &quot; group by parent_id) withRef&quot;);
<span class="nc" id="L1005">				depQry</span>
						.append(&quot;(select parent_id,ifnull(sum(depo),0.0) depoAmt from st_lms_organization_master om left outer join (select wrs.retailer_org_id, agent_net_amt as depo from st_ola_ret_deposit wrs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type = 'OLA_DEPOSIT' and transaction_date&gt;='&quot;
								+ startDate
								+ &quot;' and transaction_date&lt;='&quot;
								+ endDate
								+ &quot;'))deposit on om.organization_id=retailer_org_id where om.organization_type='RETAILER' and om.parent_id=&quot;
								+ agtOrgId + &quot; group by parent_id) depo&quot;);

<span class="nc" id="L1013">				depRefQry</span>
						.append(&quot;(select parent_id,ifnull(sum(depo),0.0) depoRefAmt from st_lms_organization_master om left outer join (select wrs.retailer_org_id, agent_net_amt as depo from st_ola_ret_deposit_refund wrs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type = 'OLA_DEPOSIT_REFUND' and transaction_date&gt;='&quot;
								+ startDate
								+ &quot;' and transaction_date&lt;='&quot;
								+ endDate
								+ &quot;'))depositRef on om.organization_id=retailer_org_id where om.organization_type='RETAILER' and om.parent_id=&quot;
								+ agtOrgId + &quot; group by parent_id) depoRef&quot;);

<span class="nc" id="L1021">				String netGamingQry = &quot;select om.parent_id agtOrgId, ifnull(sum(netGamingAmt), 0.0) netAmt from(select wrs.retailer_org_id, agt_net_claim_comm as netGamingAmt from st_ola_ret_comm wrs inner join st_lms_retailer_transaction_master rt on wrs.transaction_id=rt.transaction_id where transaction_type = 'OLA_COMMISSION' and transaction_date&gt;='&quot;+ startDate + &quot;' and transaction_date&lt;='&quot;	+ endDate+ &quot;') wdret right outer join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on om.organization_id = wdret.retailer_org_id where om.parent_id=&quot;+agtOrgId+&quot; group by om.parent_id&quot;;</span>
<span class="nc" id="L1022">				logger.debug(&quot;-------Withdrawal Query------\n&quot; + wdQry);</span>
<span class="nc" id="L1023">				logger.debug(&quot;-------WithDrawal Refund Query------\n&quot;</span>
						+ wdRefQry);
<span class="nc" id="L1025">				logger.debug(&quot;-------Deposit Query------\n&quot; + depQry);</span>
<span class="nc" id="L1026">				logger.debug(&quot;-------Deposit Refund Query------\n&quot; + depRefQry);</span>
<span class="nc" id="L1027">				logger.debug(&quot;-------Net Gaming Query------\n&quot; + netGamingQry);</span>

				// Withdrawal Query
<span class="nc" id="L1030">				pstmt = con.prepareStatement(wdQry.toString());</span>
<span class="nc" id="L1031">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1032" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L1033">					agtMap.get(rs.getString(&quot;agtOrgId&quot; + &quot;&quot;)).setWithdrawal(</span>
							rs.getDouble(&quot;wdraw&quot;));
				}
				// WithDrawal Refund Query
<span class="nc" id="L1037">				pstmt = con.prepareStatement(wdRefQry.toString());</span>
<span class="nc" id="L1038">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1039" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L1040">					agtMap.get(rs.getString(&quot;agtOrgId&quot; + &quot;&quot;))</span>
							.setWithdrawalRefund(rs.getDouble(&quot;wdrawRef&quot;));
				}

				// Deposit Query
<span class="nc" id="L1045">				pstmt = con.prepareStatement(depQry.toString());</span>
<span class="nc" id="L1046">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1047" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L1048">					agtMap.get(rs.getString(&quot;agtOrgId&quot; + &quot;&quot;)).setDeposit(</span>
							rs.getDouble(&quot;depoAmt&quot;));
				}
				// Deposit Refund Query
<span class="nc" id="L1052">				pstmt = con.prepareStatement(depRefQry.toString());</span>
<span class="nc" id="L1053">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1054" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L1055">					agtMap.get(rs.getString(&quot;agtOrgId&quot; + &quot;&quot;)).setDepositRefund(</span>
							rs.getDouble(&quot;depoRefAmt&quot;));
				}

				// net gaming commission query
<span class="nc" id="L1060">				pstmt = con.prepareStatement(netGamingQry);</span>
<span class="nc" id="L1061">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1062" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L1063">					agtMap.get(rs.getString(&quot;agtOrgId&quot; + &quot;&quot;)).setNetGamingComm(</span>
							rs.getDouble(&quot;netAmt&quot;));
				}
			}
<span class="nc" id="L1067">		} catch (Exception e) {</span>
<span class="nc" id="L1068">			e.printStackTrace();</span>
<span class="nc" id="L1069">			throw new LMSException(&quot;Error in report collectionAgentWise&quot;);</span>
<span class="nc" id="L1070">		}</span>
<span class="nc" id="L1071">	}</span>

	public void collectionAgentWiseExpand(Timestamp startDate,
			Timestamp endDate,Map&lt;String, CollectionReportOverAllBean&gt; agtMap)
			throws LMSException {
<span class="nc" id="L1076">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L1077">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L1078">		ResultSet rs = null;</span>

<span class="nc" id="L1080">		String saleTranDG = null;</span>
<span class="nc" id="L1081">		String cancelTranDG = null;</span>
<span class="nc" id="L1082">		String pwtTranDG = null;</span>
<span class="nc" id="L1083">		String saleTranCS = null;</span>
<span class="nc" id="L1084">		String cancelTranCS = null;</span>
<span class="nc" id="L1085">		String dirPlrPwt = null;</span>
<span class="nc" id="L1086">		StringBuilder drawQry = null;</span>
<span class="nc" id="L1087">		StringBuilder scratchQry = null;</span>
<span class="nc" id="L1088">		StringBuilder CSQry = null;</span>
<span class="nc" id="L1089">		CollectionReportOverAllBean agentBean = null;</span>
<span class="nc" id="L1090">		CompleteCollectionBean gameBean, prodBean = null;</span>
		try {
<span class="nc bnc" id="L1092" title="All 2 branches missed.">			if (ReportUtility.isDG) {</span>
<span class="nc" id="L1093">				drawQry = new StringBuilder(</span>
						&quot;select organization_id,ifnull(sale,0.0) sale,ifnull(cancel,0.0) cancel,ifnull(pwt,0.0)  pwt from (select sale.parent_id,sale,cancel,pwt from &quot;);
<span class="nc" id="L1095">				saleTranDG = &quot;(select bb.parent_id,sum(sale) as sale from (select drs.retailer_org_id,sum(agent_net_amt) as sale from st_dg_ret_sale_? drs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_SALE','DG_SALE_OFFLINE') and transaction_date&gt;='&quot;</span>
						+ startDate
						+ &quot;' and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;') group by drs.retailer_org_id) aa right outer join (select organization_id,parent_id from st_lms_organization_master where organization_type='RETAILER')bb on retailer_org_id=organization_id group by parent_id) sale,&quot;;
<span class="nc" id="L1100">				cancelTranDG = &quot;(select bb.parent_id,sum(cancel) as cancel from (select drs.retailer_org_id,sum(agent_net_amt) as cancel from st_dg_ret_sale_refund_? drs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_REFUND_CANCEL','DG_REFUND_FAILED') and transaction_date&gt;='&quot;</span>
						+ startDate
						+ &quot;' and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;') group by drs.retailer_org_id) aa right outer join (select organization_id,parent_id from st_lms_organization_master where organization_type='RETAILER') bb on retailer_org_id=organization_id group by parent_id) cancel,&quot;;
<span class="nc" id="L1105">				pwtTranDG = &quot;(select bb.parent_id,sum(pwt) as pwt from (select drs.retailer_org_id,sum(pwt_amt+agt_claim_comm) as pwt from st_dg_ret_pwt_? drs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_PWT_AUTO','DG_PWT_PLR','DG_PWT') and transaction_date&gt;='&quot;</span>
						+ startDate
						+ &quot;' and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;') group by drs.retailer_org_id) aa right outer join (select organization_id,parent_id from st_lms_organization_master where organization_type='RETAILER') bb on retailer_org_id=organization_id group by parent_id) pwt&quot;;
<span class="nc" id="L1110">				drawQry.append(saleTranDG);</span>
<span class="nc" id="L1111">				drawQry.append(cancelTranDG);</span>
<span class="nc" id="L1112">				drawQry.append(pwtTranDG);</span>
<span class="nc" id="L1113">				drawQry</span>
						.append(&quot; where sale.parent_id=cancel.parent_id and sale.parent_id=pwt.parent_id and cancel.parent_id=pwt.parent_id) gameTlb right outer join (select organization_id from st_lms_organization_master where organization_type='AGENT') agtTlb on gameTlb.parent_id=agtTlb.organization_id&quot;);
<span class="nc" id="L1115">				logger.debug(&quot;For Expand draw game Qry:: &quot; + drawQry);</span>

<span class="nc" id="L1117">				dirPlrPwt = &quot;select organization_id,ifnull(pwtDir,0.0) pwtDir from (select agent_org_id,sum(pwt_amt+agt_claim_comm) pwtDir from st_dg_agt_direct_plr_pwt where transaction_date&gt;='&quot;</span>
						+ startDate
						+ &quot;' and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;' and game_id=? group by agent_org_id) aa right outer join (select organization_id from st_lms_organization_master where organization_type='AGENT') bb on agent_org_id=organization_id&quot;;

<span class="nc" id="L1123">				logger.debug(&quot;For Expand draw game Qry Direct Ply:: &quot;</span>
						+ dirPlrPwt);
				// Game Master Query
<span class="nc" id="L1126">				String gameQry = &quot;select game_id,game_name from st_dg_game_master&quot;;</span>
<span class="nc" id="L1127">				PreparedStatement gamePstmt = con.prepareStatement(gameQry);</span>
<span class="nc" id="L1128">				ResultSet rsGame = gamePstmt.executeQuery();</span>
<span class="nc bnc" id="L1129" title="All 2 branches missed.">				while (rsGame.next()) {</span>
<span class="nc" id="L1130">					int gameId = rsGame.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L1131">					String gameName = rsGame.getString(&quot;game_name&quot;);</span>
<span class="nc" id="L1132">					pstmt = con.prepareStatement(drawQry.toString());</span>
<span class="nc" id="L1133">					pstmt.setInt(1, gameId);</span>
<span class="nc" id="L1134">					pstmt.setInt(2, gameId);</span>
<span class="nc" id="L1135">					pstmt.setInt(3, gameId);</span>
<span class="nc" id="L1136">					logger.debug(&quot;-------Indivisual Game Qry-------\n&quot; + pstmt);</span>
<span class="nc" id="L1137">					rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1138" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L1139">						String agtOrgId = rs.getString(&quot;organization_id&quot;);</span>
<span class="nc" id="L1140">						agentBean = agtMap.get(agtOrgId);</span>
<span class="nc" id="L1141">						Map&lt;String, CompleteCollectionBean&gt; gameMap = agentBean</span>
								.getGameBeanMap();
<span class="nc bnc" id="L1143" title="All 2 branches missed.">						if (gameMap == null) {</span>
<span class="nc" id="L1144">							gameMap = new HashMap&lt;String, CompleteCollectionBean&gt;();</span>
<span class="nc" id="L1145">							agentBean.setGameBeanMap(gameMap);</span>
						}
<span class="nc" id="L1147">						gameBean = gameMap.get(gameName);</span>
<span class="nc bnc" id="L1148" title="All 2 branches missed.">						if (gameBean == null) {</span>
<span class="nc" id="L1149">							gameBean = new CompleteCollectionBean();</span>
<span class="nc" id="L1150">							gameMap.put(gameName, gameBean);</span>
						}
<span class="nc" id="L1152">						gameBean.setOrgName(gameName);</span>
<span class="nc" id="L1153">						gameBean.setDrawSale(rs.getDouble(&quot;sale&quot;));</span>
<span class="nc" id="L1154">						gameBean.setDrawCancel(rs.getDouble(&quot;cancel&quot;));</span>
<span class="nc" id="L1155">						gameBean.setDrawPwt(rs.getDouble(&quot;pwt&quot;));</span>
<span class="nc" id="L1156">					}</span>

					// Direct Player Pwt
<span class="nc" id="L1159">					pstmt = con.prepareStatement(dirPlrPwt);</span>
<span class="nc" id="L1160">					pstmt.setInt(1, gameId);</span>
<span class="nc" id="L1161">					rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1162" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L1163">						String agtOrgId = rs.getString(&quot;organization_id&quot;);</span>
<span class="nc" id="L1164">						agentBean = agtMap.get(agtOrgId);</span>
<span class="nc" id="L1165">						Map&lt;String, CompleteCollectionBean&gt; gameMap = agentBean</span>
								.getGameBeanMap();
<span class="nc bnc" id="L1167" title="All 2 branches missed.">						if (gameMap == null) {</span>
<span class="nc" id="L1168">							gameMap = new HashMap&lt;String, CompleteCollectionBean&gt;();</span>
<span class="nc" id="L1169">							agentBean.setGameBeanMap(gameMap);</span>
						}
<span class="nc" id="L1171">						gameBean = gameMap.get(gameName);</span>
<span class="nc bnc" id="L1172" title="All 2 branches missed.">						if (gameBean == null) {</span>
<span class="nc" id="L1173">							gameBean = new CompleteCollectionBean();</span>
<span class="nc" id="L1174">							gameMap.put(gameName, gameBean);</span>
						}
<span class="nc" id="L1176">						gameBean.setDrawDirPlyPwt(rs.getDouble(&quot;pwtDir&quot;));</span>
<span class="nc" id="L1177">					}</span>
<span class="nc" id="L1178">				}</span>
			}
<span class="nc bnc" id="L1180" title="All 2 branches missed.">			if (ReportUtility.isSE) {</span>
<span class="nc" id="L1181">				scratchQry = new StringBuilder(</span>
						&quot;select organization_id,ifnull(sale,0.0) sale,ifnull(pwt,0.0) pwt from (select sale.parent_id,sale,pwt from&quot;);
<span class="nc" id="L1183">				logger.info(&quot;----Type Select ---&quot;</span>
						+ LMSFilterDispatcher.seSaleReportType);
<span class="nc" id="L1185">				boolean isTrue = false;</span>
<span class="nc bnc" id="L1186" title="All 2 branches missed.">				if (&quot;BOOK_WISE&quot;.equals(LMSFilterDispatcher.seSaleReportType)) {</span>
<span class="nc" id="L1187">					isTrue = true;</span>
<span class="nc" id="L1188">					saleTranDG = &quot;(select sale.organization_id parent_id,sale.name,(ifnull(mrpAmt,0.0)-ifnull(mrpAmtRet,0.0)) mrpAmt,(ifnull(netAmt,0.0)-ifnull(netAmtRet,0.0)) sale from (select organization_id,name,ifnull(mrpAmt,0.0) mrpAmt,ifnull(netAmt,0.0) netAmt from st_lms_organization_master left outer join (select agent_org_id,sum(mrp_amt) mrpAmt,sum(net_amt) netAmt from st_se_bo_agent_transaction right outer join st_lms_organization_master on organization_id=agent_org_id where game_id=? and transaction_id in (select transaction_id from st_lms_bo_transaction_master where transaction_type='SALE' and transaction_date&gt;='&quot;</span>
							+ startDate
							+ &quot;' and transaction_date&lt;='&quot;
							+ endDate
							+ &quot;') group by agent_org_id) sale on organization_id=agent_org_id where organization_type='AGENT') sale inner join (select organization_id,name,ifnull(mrpAmtRet,0.0) mrpAmtRet,ifnull(netAmtRet,0.0) netAmtRet from st_lms_organization_master left outer join (select agent_org_id,sum(mrp_amt) mrpAmtRet,sum(net_amt) netAmtRet from st_se_bo_agent_transaction where game_id=? and transaction_id in (select transaction_id from st_lms_bo_transaction_master where transaction_type='SALE_RET' and transaction_date&gt;='&quot;
							+ startDate
							+ &quot;' and transaction_date&lt;='&quot;
							+ endDate
							+ &quot;') group by agent_org_id ) saleRet on organization_id=agent_org_id where organization_type='AGENT') saleRet on sale.organization_id=saleRet.organization_id) sale left outer join &quot;;
<span class="nc bnc" id="L1197" title="All 2 branches missed.">				} else if (&quot;TICKET_WISE&quot;</span>
						.equals(LMSFilterDispatcher.seSaleReportType)) {
<span class="nc" id="L1199">					saleTranDG = &quot;(select organization_id parent_id,name,ifnull(mrpAmt,0.0) mrpAmt,ifnull(netAmt,0.0) sale from st_lms_organization_master left outer join (select current_owner_id,sum(soldTkt*ticket_price) mrpAmt,sum((soldTkt*ticket_price)-(soldTkt*ticket_price*transacrion_sale_comm_rate*0.01)) netAmt from st_se_game_master gm,st_se_game_inv_detail gid,(select game_id,book_nbr,sum(sold_tickets) soldTkt from st_se_game_ticket_inv_history where date&gt;='&quot;</span>
							+ startDate
							+ &quot;' and date&lt;='&quot;
							+ endDate
							+ &quot;' and current_owner='RETAILER' and game_id=? group by book_nbr) TktTlb where gm.game_id=? and gm.game_id=TktTlb.game_id and TktTlb.book_nbr=gid.book_nbr and gid.current_owner='AGENT' group by current_owner_id) saleTlb on organization_id=current_owner_id where organization_type='AGENT') sale,&quot;;
				}
<span class="nc" id="L1205">				pwtTranDG = &quot;(select parent_id,sum(pwt) pwt from (select bb.parent_id,sum(pwt) as pwt from (select retailer_org_id,sum(pwt_amt+(pwt_amt*agt_claim_comm*0.01)) pwt from st_se_retailer_pwt where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_date&gt;='&quot;</span>
						+ startDate
						+ &quot;' and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;' and transaction_type='PWT') and game_id=? group by retailer_org_id union all select retailer_org_id,sum(pwt_amt+(pwt_amt*claim_comm*0.01)) pwt from st_se_agent_pwt where transaction_id in (select transaction_id from st_lms_agent_transaction_master where transaction_date&gt;='&quot;
						+ startDate
						+ &quot;' and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;' and transaction_type='PWT') and game_id=? group by retailer_org_id) aa right outer join (select organization_id,parent_id from st_lms_organization_master where organization_type='RETAILER') bb on retailer_org_id=organization_id group by parent_id union all select agent_org_id,sum(pwt_amt+comm_amt) boPwt from st_se_bo_pwt where transaction_id in (select transaction_id from st_lms_bo_transaction_master where transaction_date&gt;='&quot;
						+ startDate
						+ &quot;' and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;' and transaction_type='PWT' and agent_org_id in (select organization_id from st_lms_organization_master where organization_type='AGENT')) and game_id=? group by agent_org_id) pwt group by parent_id) pwt&quot;;
<span class="nc" id="L1218">				scratchQry.append(saleTranDG);</span>
<span class="nc" id="L1219">				scratchQry.append(pwtTranDG);</span>
<span class="nc bnc" id="L1220" title="All 2 branches missed.">				scratchQry</span>
						.append(&quot; &quot;
								+ ((isTrue) ? &quot;on&quot; : &quot;where&quot;)
								+ &quot; sale.parent_id=pwt.parent_id) gameTlb right outer join (select organization_id from st_lms_organization_master where organization_type='AGENT') agtTlb on gameTlb.parent_id=agtTlb.organization_id&quot;);
<span class="nc" id="L1224">				logger.debug(&quot;For Expand scratch game Qry:: &quot; + scratchQry);</span>

<span class="nc" id="L1226">				dirPlrPwt = &quot;select organization_id,ifnull(pwtDir,0.0) pwtDir from (select agent_org_id,sum(pwt_amt+(pwt_amt*claim_comm*0.01)) pwtDir from st_se_agt_direct_player_pwt where transaction_date&gt;='&quot;</span>
						+ startDate
						+ &quot;' and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;' and game_id=? group by agent_org_id) aa right outer join (select organization_id from st_lms_organization_master where organization_type='AGENT') bb on agent_org_id=organization_id&quot;;

<span class="nc" id="L1232">				logger.debug(&quot;For Expand scratch game Qry Direct Ply:: &quot;</span>
						+ dirPlrPwt);
				// Game Master Query
<span class="nc" id="L1235">				String gameQry = &quot;select game_id,game_name from st_se_game_master&quot;;</span>
<span class="nc" id="L1236">				PreparedStatement gamePstmt = con.prepareStatement(gameQry);</span>
<span class="nc" id="L1237">				ResultSet rsGame = gamePstmt.executeQuery();</span>
<span class="nc bnc" id="L1238" title="All 2 branches missed.">				while (rsGame.next()) {</span>
<span class="nc" id="L1239">					int gameId = rsGame.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L1240">					String gameName = rsGame.getString(&quot;game_name&quot;);</span>
<span class="nc" id="L1241">					pstmt = con.prepareStatement(scratchQry.toString());</span>
<span class="nc" id="L1242">					pstmt.setInt(1, gameId);</span>
<span class="nc" id="L1243">					pstmt.setInt(2, gameId);</span>
<span class="nc" id="L1244">					pstmt.setInt(3, gameId);</span>
<span class="nc" id="L1245">					pstmt.setInt(4, gameId);</span>
<span class="nc" id="L1246">					pstmt.setInt(5, gameId);</span>
<span class="nc" id="L1247">					logger.debug(&quot;-------Indivisual Game Qry-------\n&quot; + pstmt);</span>
<span class="nc" id="L1248">					rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1249" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L1250">						String agtOrgId = rs.getString(&quot;organization_id&quot;);</span>
<span class="nc" id="L1251">						agentBean = agtMap.get(agtOrgId);</span>
<span class="nc" id="L1252">						Map&lt;String, CompleteCollectionBean&gt; gameMap = agentBean</span>
								.getGameBeanMap();
<span class="nc bnc" id="L1254" title="All 2 branches missed.">						if (gameMap == null) {</span>
<span class="nc" id="L1255">							gameMap = new HashMap&lt;String, CompleteCollectionBean&gt;();</span>
<span class="nc" id="L1256">							agentBean.setGameBeanMap(gameMap);</span>
						}
<span class="nc" id="L1258">						gameBean = gameMap.get(gameName);</span>
<span class="nc bnc" id="L1259" title="All 2 branches missed.">						if (gameBean == null) {</span>
<span class="nc" id="L1260">							gameBean = new CompleteCollectionBean();</span>
<span class="nc" id="L1261">							gameMap.put(gameName, gameBean);</span>
						}
<span class="nc" id="L1263">						gameBean.setOrgName(gameName);</span>
<span class="nc" id="L1264">						gameBean.setDrawSale(rs.getDouble(&quot;sale&quot;));</span>
<span class="nc" id="L1265">						gameBean.setDrawCancel(0.0);</span>
<span class="nc" id="L1266">						gameBean.setDrawPwt(rs.getDouble(&quot;pwt&quot;));</span>
<span class="nc" id="L1267">					}</span>

					// Direct Player Pwt
<span class="nc" id="L1270">					pstmt = con.prepareStatement(dirPlrPwt);</span>
<span class="nc" id="L1271">					pstmt.setInt(1, gameId);</span>
<span class="nc" id="L1272">					rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1273" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L1274">						String agtOrgId = rs.getString(&quot;organization_id&quot;);</span>
<span class="nc" id="L1275">						agentBean = agtMap.get(agtOrgId);</span>
<span class="nc" id="L1276">						Map&lt;String, CompleteCollectionBean&gt; gameMap = agentBean</span>
								.getGameBeanMap();
<span class="nc bnc" id="L1278" title="All 2 branches missed.">						if (gameMap == null) {</span>
<span class="nc" id="L1279">							gameMap = new HashMap&lt;String, CompleteCollectionBean&gt;();</span>
<span class="nc" id="L1280">							agentBean.setGameBeanMap(gameMap);</span>
						}
<span class="nc" id="L1282">						gameBean = gameMap.get(gameName);</span>
<span class="nc bnc" id="L1283" title="All 2 branches missed.">						if (gameBean == null) {</span>
<span class="nc" id="L1284">							gameBean = new CompleteCollectionBean();</span>
<span class="nc" id="L1285">							gameMap.put(gameName, gameBean);</span>
						}
<span class="nc" id="L1287">						gameBean.setDrawDirPlyPwt(rs.getDouble(&quot;pwtDir&quot;));</span>
<span class="nc" id="L1288">					}</span>
<span class="nc" id="L1289">				}</span>
			}
<span class="nc bnc" id="L1291" title="All 2 branches missed.">			if (ReportUtility.isCS) {</span>

<span class="nc" id="L1293">				CSQry = new StringBuilder(</span>
						&quot;select organization_id,ifnull(sale,0.0) sale,ifnull(cancel,0.0) cancel from (select sale.parent_id,sale,cancel from &quot;);
<span class="nc" id="L1295">				saleTranCS = &quot;(select bb.parent_id,sum(sale) as sale from (select drs.retailer_org_id,sum(agent_net_amt) as sale from st_cs_sale_? drs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type in('CS_SALE') and transaction_date&gt;='&quot;</span>
						+ startDate
						+ &quot;' and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;') group by drs.retailer_org_id) aa right outer join (select organization_id,parent_id from st_lms_organization_master where organization_type='RETAILER')bb on retailer_org_id=organization_id group by parent_id) sale,&quot;;
<span class="nc" id="L1300">				cancelTranCS = &quot;(select bb.parent_id,sum(cancel) as cancel from (select drs.retailer_org_id,sum(agent_net_amt) as cancel from st_cs_refund_? drs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type in('CS_CANCEL_SERVER','CS_CANCEL_RET') and transaction_date&gt;='&quot;</span>
						+ startDate
						+ &quot;' and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;') group by drs.retailer_org_id) aa right outer join (select organization_id,parent_id from st_lms_organization_master where organization_type='RETAILER') bb on retailer_org_id=organization_id group by parent_id) cancel&quot;;
<span class="nc" id="L1305">				CSQry.append(saleTranCS);</span>
<span class="nc" id="L1306">				CSQry.append(cancelTranCS);</span>
<span class="nc" id="L1307">				CSQry</span>
						.append(&quot; where sale.parent_id=cancel.parent_id) gameTlb right outer join (select organization_id from st_lms_organization_master where organization_type='AGENT') agtTlb on gameTlb.parent_id=agtTlb.organization_id&quot;);
<span class="nc" id="L1309">				logger.debug(&quot;For Expand CS game Qry:: &quot; + CSQry);</span>

				// Category Master Query
<span class="nc" id="L1312">				String prodQry = &quot;select category_id, category_code from st_cs_product_category_master where status = 'ACTIVE'&quot;;</span>
<span class="nc" id="L1313">				PreparedStatement prodPstmt = con.prepareStatement(prodQry);</span>
<span class="nc" id="L1314">				ResultSet rsProd = prodPstmt.executeQuery();</span>
<span class="nc bnc" id="L1315" title="All 2 branches missed.">				while (rsProd.next()) {</span>
<span class="nc" id="L1316">					int catId = rsProd.getInt(&quot;category_id&quot;);</span>
<span class="nc" id="L1317">					String catName = rsProd.getString(&quot;category_code&quot;);</span>
<span class="nc" id="L1318">					pstmt = con.prepareStatement(CSQry.toString());</span>
<span class="nc" id="L1319">					pstmt.setInt(1, catId);</span>
<span class="nc" id="L1320">					pstmt.setInt(2, catId);</span>
<span class="nc" id="L1321">					logger.debug(&quot;-------Indivisual Category Qry-------\n&quot;</span>
							+ pstmt);
<span class="nc" id="L1323">					rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1324" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L1325">						String agtOrgId = rs.getString(&quot;organization_id&quot;);</span>
<span class="nc" id="L1326">						agentBean = agtMap.get(agtOrgId);</span>
<span class="nc" id="L1327">						Map&lt;String, CompleteCollectionBean&gt; prodMap = agentBean</span>
								.getGameBeanMap();
<span class="nc bnc" id="L1329" title="All 2 branches missed.">						if (prodMap == null) {</span>
<span class="nc" id="L1330">							prodMap = new HashMap&lt;String, CompleteCollectionBean&gt;();</span>
<span class="nc" id="L1331">							agentBean.setGameBeanMap(prodMap);</span>
						}
<span class="nc" id="L1333">						prodBean = prodMap.get(catName);</span>
<span class="nc bnc" id="L1334" title="All 2 branches missed.">						if (prodBean == null) {</span>
<span class="nc" id="L1335">							prodBean = new CompleteCollectionBean();</span>
<span class="nc" id="L1336">							prodMap.put(catName, prodBean);</span>
						}
<span class="nc" id="L1338">						prodBean.setOrgName(catName);</span>
<span class="nc" id="L1339">						prodBean.setDrawSale(rs.getDouble(&quot;sale&quot;));</span>
<span class="nc" id="L1340">						prodBean.setDrawPwt(rs.getDouble(&quot;cancel&quot;));</span>

<span class="nc" id="L1342">						System.out.println(&quot;map size:&quot; + prodMap.size());</span>
<span class="nc" id="L1343">					}</span>

<span class="nc" id="L1345">				}</span>

			}
<span class="nc" id="L1348">		} catch (Exception e) {</span>
<span class="nc" id="L1349">			e.printStackTrace();</span>
<span class="nc" id="L1350">			throw new LMSException(&quot;Error in report collectionAgentWise Expand&quot;);</span>
		} finally {
<span class="nc" id="L1352">			try {</span>
<span class="nc" id="L1353">				con.close();</span>
<span class="nc" id="L1354">			} catch (SQLException e) {</span>
<span class="nc" id="L1355">				e.printStackTrace();</span>
<span class="nc" id="L1356">			}</span>
<span class="nc" id="L1357">		}</span>
<span class="nc" id="L1358">	}</span>

	public Map&lt;String, CollectionReportOverAllBean&gt; collectionAgentWiseWithOpeningBal(
			Timestamp deployDate, Timestamp startDate, Timestamp endDate,
			int agtOrgId) throws LMSException {

<span class="nc" id="L1364">		Connection con = null;</span>
<span class="nc bnc" id="L1365" title="All 2 branches missed.">		if (startDate.after(endDate)) {</span>
<span class="nc" id="L1366">			return null;</span>
		}
<span class="nc" id="L1368">		Map&lt;String, CollectionReportOverAllBean&gt; agtMapOpenningBalance = new LinkedHashMap&lt;String, CollectionReportOverAllBean&gt;();</span>
<span class="nc" id="L1369">		Map&lt;String, CollectionReportOverAllBean&gt; agtMap = new LinkedHashMap&lt;String, CollectionReportOverAllBean&gt;();</span>
		// Map&lt;String, CollectionReportOverAllBean&gt; resultMap = new
		// LinkedHashMap&lt;String, CollectionReportOverAllBean&gt;();
<span class="nc" id="L1372">		CollectionReportOverAllBean collBean = null;</span>
<span class="nc" id="L1373">		Double openingBalance = 0.0;</span>
		try {
<span class="nc" id="L1375">			con = DBConnect.getConnection();</span>
			// String agtOrgQry =
			// &quot;select name,organization_id from st_lms_organization_master where organization_type='AGENT' and organization_id=&quot;+agtOrgId;
			// pstmt = con.prepareStatement(agtOrgQry);
			// rsRetOrg = pstmt.executeQuery();

<span class="nc" id="L1381">			Calendar startCal = Calendar.getInstance();</span>
<span class="nc" id="L1382">			Calendar endCal = Calendar.getInstance();</span>
<span class="nc" id="L1383">			Calendar nextCal = Calendar.getInstance();</span>
<span class="nc" id="L1384">			startCal.setTimeInMillis(startDate.getTime());</span>
<span class="nc" id="L1385">			endCal.setTimeInMillis(endDate.getTime());</span>
<span class="nc" id="L1386">			nextCal.setTimeInMillis(startDate.getTime());</span>
<span class="nc" id="L1387">			SimpleDateFormat sdf = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span>
<span class="nc" id="L1388">			collBean = new CollectionReportOverAllBean();</span>
<span class="nc" id="L1389">			collBean.setAgentName(new Timestamp(nextCal.getTimeInMillis())</span>
					.toString().split(&quot; &quot;)[0]);// its date for this report
<span class="nc" id="L1391">			collBean.setOpeningBal(0.0);</span>
<span class="nc" id="L1392">			collBean.setCash(0.0);</span>
<span class="nc" id="L1393">			collBean.setCheque(0.0);</span>
<span class="nc" id="L1394">			collBean.setChequeReturn(0.0);</span>
<span class="nc" id="L1395">			collBean.setCredit(0.0);</span>
<span class="nc" id="L1396">			collBean.setDebit(0.0);</span>
<span class="nc" id="L1397">			collBean.setBankDep(0.0);</span>
<span class="nc bnc" id="L1398" title="All 2 branches missed.">			if (ReportUtility.isDG) {</span>
<span class="nc" id="L1399">				collBean.setDgSale(0.0);</span>
<span class="nc" id="L1400">				collBean.setDgPwt(0.0);</span>
<span class="nc" id="L1401">				collBean.setDgCancel(0.0);</span>
<span class="nc" id="L1402">				collBean.setDgDirPlyPwt(0.0);</span>
			}
<span class="nc bnc" id="L1404" title="All 2 branches missed.">			if (ReportUtility.isSE) {</span>
<span class="nc" id="L1405">				collBean.setSeSale(0.0);</span>
<span class="nc" id="L1406">				collBean.setSePwt(0.0);</span>
<span class="nc" id="L1407">				collBean.setSeDirPlyPwt(0.0);</span>
			}
<span class="nc bnc" id="L1409" title="All 2 branches missed.">			if (ReportUtility.isCS) {</span>
<span class="nc" id="L1410">				collBean.setCSSale(0.0);</span>
<span class="nc" id="L1411">				collBean.setCSCancel(0.0);</span>
			}
<span class="nc bnc" id="L1413" title="All 2 branches missed.">			if (ReportUtility.isOLA) {</span>
<span class="nc" id="L1414">				collBean.setDeposit(0.0);</span>
<span class="nc" id="L1415">				collBean.setDepositRefund(0.0);</span>
<span class="nc" id="L1416">				collBean.setWithdrawal(0.0);</span>
<span class="nc" id="L1417">				collBean.setWithdrawalRefund(0.0);</span>
<span class="nc" id="L1418">				collBean.setNetGamingComm(0.0);</span>
			}
<span class="nc" id="L1420">			agtMapOpenningBalance.put(agtOrgId + &quot;&quot;, collBean);</span>

<span class="nc" id="L1422">			collectionAgentWise(deployDate, new Timestamp(</span>
					startDate.getTime() - 1000), con,
					agtMapOpenningBalance, agtOrgId);
<span class="nc" id="L1425">			Iterator&lt;Map.Entry&lt;String, CollectionReportOverAllBean&gt;&gt; itr = agtMapOpenningBalance</span>
					.entrySet().iterator();
<span class="nc bnc" id="L1427" title="All 2 branches missed.">			while (itr.hasNext()) {</span>
<span class="nc" id="L1428">				Map.Entry&lt;String, CollectionReportOverAllBean&gt; pair = itr</span>
						.next();
<span class="nc" id="L1430">				CollectionReportOverAllBean bean = pair.getValue();</span>
<span class="nc" id="L1431">				double openingBal = bean.getDgSale()</span>
						- bean.getDgCancel()
						- bean.getDgPwt()
						- bean.getDgDirPlyPwt()
						+ bean.getSeSale()
						- bean.getSePwt()
						- bean.getSeDirPlyPwt()
						+ bean.getCSSale()
						- bean.getCSCancel()
						+ bean.getDeposit()
						- bean.getDepositRefund()
						- bean.getWithdrawal()
						- bean.getNetGamingComm()
						- (bean.getCash() + bean.getCheque() + bean.getCredit()
								+ bean.getBankDep() - bean.getDebit() - bean
								.getChequeReturn());
<span class="nc" id="L1447">				bean.setOpeningBal(openingBal);</span>
<span class="nc" id="L1448">				openingBalance = openingBal;</span>
<span class="nc" id="L1449">			}</span>
<span class="nc bnc" id="L1450" title="All 2 branches missed.">			if (endCal.after(startCal)) {</span>
<span class="nc bnc" id="L1451" title="All 2 branches missed.">				while (nextCal.compareTo(endCal) &lt;= 0) {</span>

<span class="nc" id="L1453">					collBean = new CollectionReportOverAllBean();</span>
<span class="nc" id="L1454">					String AgentName = new Timestamp(nextCal.getTimeInMillis())</span>
							.toString().split(&quot; &quot;)[0];// its date for this
					// report
<span class="nc" id="L1457">					collBean.setAgtId(agtOrgId);</span>
<span class="nc" id="L1458">					collBean.setOpeningBal(0.0);</span>
<span class="nc" id="L1459">					collBean.setCash(0.0);</span>
<span class="nc" id="L1460">					collBean.setCheque(0.0);</span>
<span class="nc" id="L1461">					collBean.setChequeReturn(0.0);</span>
<span class="nc" id="L1462">					collBean.setCredit(0.0);</span>
<span class="nc" id="L1463">					collBean.setDebit(0.0);</span>
<span class="nc" id="L1464">					collBean.setBankDep(0.0);</span>
<span class="nc bnc" id="L1465" title="All 2 branches missed.">					if (ReportUtility.isDG) {</span>
<span class="nc" id="L1466">						collBean.setDgSale(0.0);</span>
<span class="nc" id="L1467">						collBean.setDgPwt(0.0);</span>
<span class="nc" id="L1468">						collBean.setDgCancel(0.0);</span>
<span class="nc" id="L1469">						collBean.setDgDirPlyPwt(0.0);</span>
					}
<span class="nc bnc" id="L1471" title="All 2 branches missed.">					if (ReportUtility.isSE) {</span>
<span class="nc" id="L1472">						collBean.setSeSale(0.0);</span>
<span class="nc" id="L1473">						collBean.setSePwt(0.0);</span>
<span class="nc" id="L1474">						collBean.setSeDirPlyPwt(0.0);</span>
					}
<span class="nc bnc" id="L1476" title="All 2 branches missed.">					if (ReportUtility.isCS) {</span>
<span class="nc" id="L1477">						collBean.setCSSale(0.0);</span>
<span class="nc" id="L1478">						collBean.setCSCancel(0.0);</span>
					}
<span class="nc bnc" id="L1480" title="All 2 branches missed.">					if (ReportUtility.isOLA) {</span>
<span class="nc" id="L1481">						collBean.setDeposit(0.0);</span>
<span class="nc" id="L1482">						collBean.setDepositRefund(0.0);</span>
<span class="nc" id="L1483">						collBean.setWithdrawal(0.0);</span>
<span class="nc" id="L1484">						collBean.setWithdrawalRefund(0.0);</span>
<span class="nc" id="L1485">						collBean.setNetGamingComm(0.0);</span>
					}
<span class="nc" id="L1487">					agtMap.put(AgentName, collBean);</span>

<span class="nc" id="L1489">					nextCal.add(Calendar.DAY_OF_MONTH, 1);// increment the date</span>

<span class="nc" id="L1491">				}</span>
			}
<span class="nc" id="L1493">			System.out.println(&quot;***agentMap***&quot; + agtMap);</span>

<span class="nc" id="L1495">			collectionDateWise(startDate, endDate, con,agtMap, agtOrgId);</span>

<span class="nc" id="L1497">			Iterator&lt;Map.Entry&lt;String, CollectionReportOverAllBean&gt;&gt; itr1 = agtMap</span>
					.entrySet().iterator();
<span class="nc bnc" id="L1499" title="All 2 branches missed.">			while (itr1.hasNext()) {</span>
<span class="nc" id="L1500">				Map.Entry&lt;String, CollectionReportOverAllBean&gt; pair = itr1</span>
						.next();
<span class="nc" id="L1502">				CollectionReportOverAllBean bean = pair.getValue();</span>
<span class="nc" id="L1503">				double openingBal = bean.getDgSale()</span>
						- bean.getDgCancel()
						- bean.getDgPwt()
						- bean.getDgDirPlyPwt()
						+ bean.getSeSale()
						- bean.getSeCancel()
						- bean.getSePwt()
						- bean.getSeDirPlyPwt()
						+ bean.getCSSale()
						- bean.getCSCancel()
						+ bean.getDeposit()
						- bean.getDepositRefund()
						- bean.getWithdrawal()
						- bean.getNetGamingComm()
						- (bean.getCash() + bean.getCheque() + bean.getCredit()
								+ bean.getBankDep() - bean.getDebit() - bean
								.getChequeReturn()) + openingBalance;
<span class="nc" id="L1520">				bean.setOpeningBal(openingBalance);</span>
<span class="nc" id="L1521">				openingBalance = openingBal;</span>
<span class="nc" id="L1522">			}</span>

<span class="nc" id="L1524">		} catch (Exception e) {</span>
<span class="nc" id="L1525">			e.printStackTrace();</span>
<span class="nc" id="L1526">			throw new LMSException(</span>
					&quot;Error in report collectionAgentWiseWithOpeningBal&quot;);
		} finally {
<span class="nc" id="L1529">			try {</span>
<span class="nc" id="L1530">				con.close();</span>
<span class="nc" id="L1531">			} catch (SQLException e) {</span>
<span class="nc" id="L1532">				e.printStackTrace();</span>
<span class="nc" id="L1533">			}</span>
<span class="nc" id="L1534">		}</span>
<span class="nc" id="L1535">		return agtMap;</span>
	}

	


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>