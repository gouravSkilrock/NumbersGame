<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AgentOpeningBalanceHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lms</a> &gt; <a href="index.source.html" class="el_package">com.skilrock.lms.web.accMgmt.common</a> &gt; <span class="el_source">AgentOpeningBalanceHelper.java</span></div><h1>AgentOpeningBalanceHelper.java</h1><pre class="source lang-java linenums">package com.skilrock.lms.web.accMgmt.common;

import java.sql.CallableStatement;
import java.sql.Connection;
import java.sql.Date;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.Timestamp;
import java.text.SimpleDateFormat;
import java.util.Calendar;
import java.util.Iterator;
import java.util.Map;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import com.skilrock.lms.beans.CollectionReportOverAllBean;
import com.skilrock.lms.beans.OrganizationBalanceData;
import com.skilrock.lms.common.db.DBConnect;
import com.skilrock.lms.common.exception.LMSException;
import com.skilrock.lms.common.filter.LMSFilterDispatcher;
import com.skilrock.lms.web.instantWin.reportsMgmt.beans.IWOrgReportRequestBean;
import com.skilrock.lms.web.instantWin.reportsMgmt.beans.IWOrgReportResponseBean;
import com.skilrock.lms.web.instantWin.reportsMgmt.controller.IWAgentReportsControllerImpl;
import com.skilrock.lms.web.reportsMgmt.common.ReportUtility;
import com.skilrock.lms.web.sportsLottery.reportsMgmt.beans.SLEOrgReportRequestBean;
import com.skilrock.lms.web.sportsLottery.reportsMgmt.beans.SLEOrgReportResponseBean;
import com.skilrock.lms.web.sportsLottery.reportsMgmt.controller.SLEAgentReportsControllerImpl;
import com.skilrock.lms.web.virtualSports.reportsMgmt.beans.VSOrgReportRequestBean;
import com.skilrock.lms.web.virtualSports.reportsMgmt.beans.VSOrgReportResponseBean;
import com.skilrock.lms.web.virtualSports.reportsMgmt.controller.VSAgentReportsControllerImpl;
import com.skilrock.ola.reportsMgmt.controllerImpl.OlaAgentReportControllerImpl;
import com.skilrock.ola.reportsMgmt.javaBeans.OlaOrgReportRequestBean;
import com.skilrock.ola.reportsMgmt.javaBeans.OlaOrgReportResponseBean;

<span class="nc" id="L36">public class AgentOpeningBalanceHelper {</span>
<span class="nc" id="L37">	Log logger = LogFactory.getLog(AgentOpeningBalanceHelper.class);</span>

	public void collectionAgentWiseOpenningBal(Timestamp startDate,
			Timestamp endDate, Connection con,
			Map&lt;String, CollectionReportOverAllBean&gt; agtMap)
			throws LMSException {

<span class="nc" id="L44">		ResultSet rs = null;</span>
<span class="nc" id="L45">		Date lastArchDate = null;</span>
<span class="nc" id="L46">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L47">		CallableStatement cstmt = null;</span>
<span class="nc bnc" id="L48" title="All 2 branches missed.">		if (startDate.after(endDate)) {</span>
<span class="nc" id="L49">			return;</span>
		}
<span class="nc" id="L51">		Calendar calendar = Calendar.getInstance();</span>

<span class="nc" id="L53">		Calendar checkCal = Calendar.getInstance();</span>
<span class="nc" id="L54">		checkCal.setTimeInMillis(endDate.getTime());</span>
<span class="nc" id="L55">		checkCal.add(Calendar.DAY_OF_MONTH, -1);</span>
<span class="nc" id="L56">		checkCal.set(Calendar.HOUR_OF_DAY, 0);</span>
<span class="nc" id="L57">		checkCal.set(Calendar.MINUTE, 0);</span>
<span class="nc" id="L58">		checkCal.set(Calendar.SECOND, 0);</span>
<span class="nc" id="L59">		checkCal.set(Calendar.MILLISECOND, 0);</span>
		try {
<span class="nc" id="L61">			String lastRunDate = ReportUtility.fetchLastRunDate(con);</span>
<span class="nc" id="L62">			Calendar lastRunCal = Calendar.getInstance();</span>
<span class="nc" id="L63">			lastRunCal.setTimeInMillis(new SimpleDateFormat(&quot;dd-MM-yyyy&quot;).parse(lastRunDate).getTime());</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">			if (lastRunCal.getTimeInMillis() &gt;= checkCal.getTimeInMillis()) {</span>
<span class="nc" id="L65">				pstmt = con.prepareStatement(&quot;select organization_id,(opening_bal+net_amount_transaction)open_bal from st_rep_org_bal_history where finaldate=? and organization_type='AGENT'&quot;);</span>
<span class="nc" id="L66">				pstmt.setTimestamp(1, new Timestamp(checkCal.getTimeInMillis()));</span>
<span class="nc" id="L67">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">					if (agtMap.get(rs.getString(&quot;organization_id&quot;)) != null) {</span>
<span class="nc" id="L70">						agtMap.get(rs.getString(&quot;organization_id&quot;)).setOpeningBal(rs.getDouble(&quot;open_bal&quot;));</span>
					}
				}
				return;
			} else {
<span class="nc" id="L75">				pstmt = con.prepareStatement(&quot;select organization_id,(opening_bal+net_amount_transaction)open_bal from st_rep_org_bal_history where finaldate=? and organization_type='AGENT'&quot;);</span>
<span class="nc" id="L76">				pstmt.setTimestamp(1, new Timestamp(lastRunCal.getTimeInMillis()));</span>
<span class="nc" id="L77">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">					if (agtMap.get(rs.getString(&quot;organization_id&quot;)) != null) {</span>
<span class="nc" id="L80">						agtMap.get(rs.getString(&quot;organization_id&quot;)).setOpeningBal(rs.getDouble(&quot;open_bal&quot;));</span>
					}
				}
			}

<span class="nc" id="L85">			Calendar cal = Calendar.getInstance();</span>
<span class="nc" id="L86">			cal.setTimeInMillis(lastRunCal.getTimeInMillis());</span>
<span class="nc" id="L87">			cal.add(Calendar.DAY_OF_MONTH, 1);</span>
<span class="nc" id="L88">			ReportUtility.clearTimeFromDate(cal);</span>
			
<span class="nc" id="L90">			Timestamp fromDate = new Timestamp(cal.getTimeInMillis());</span>

			// Get Account Details
<span class="nc" id="L93">			cstmt = con</span>
					.prepareCall(&quot;call collectionCashChqOverAll(?,?)&quot;);
<span class="nc" id="L95">			cstmt.setTimestamp(1, fromDate);</span>
<span class="nc" id="L96">			cstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L97">			rs = cstmt.executeQuery();</span>

<span class="nc bnc" id="L99" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L100">				String agtOrgId = rs.getString(&quot;organization_id&quot;);</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">				if(agtMap.containsKey(agtOrgId)) {</span>
<span class="nc" id="L102">					agtMap.get(agtOrgId).setCash(rs.getDouble(&quot;cash&quot;));</span>
<span class="nc" id="L103">					agtMap.get(agtOrgId).setCheque(rs.getDouble(&quot;chq&quot;));</span>
<span class="nc" id="L104">					agtMap.get(agtOrgId).setChequeReturn(rs.getDouble(&quot;chq_ret&quot;));</span>
<span class="nc" id="L105">					agtMap.get(agtOrgId).setCredit(rs.getDouble(&quot;credit&quot;));</span>
<span class="nc" id="L106">					agtMap.get(agtOrgId).setDebit(rs.getDouble(&quot;debit&quot;));</span>
<span class="nc" id="L107">					agtMap.get(agtOrgId).setBankDep(rs.getDouble(&quot;bank&quot;));</span>
				}
<span class="nc" id="L109">			}</span>

<span class="nc bnc" id="L111" title="All 2 branches missed.">			if (ReportUtility.isDG) {</span>
				// Game Master Query
				// String gameQry = &quot;select game_id from st_dg_game_master&quot;;
<span class="nc" id="L114">				PreparedStatement gamePstmt = con</span>
						.prepareStatement(ReportUtility
								.getDrawGameMapQuery(fromDate));
<span class="nc" id="L117">				ResultSet rsGame = gamePstmt.executeQuery();</span>

<span class="nc bnc" id="L119" title="All 2 branches missed.">				while (rsGame.next()) {</span>
<span class="nc" id="L120">					int gameNo = rsGame.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L121">					cstmt = con</span>
							.prepareCall(&quot;call drawCollectionAgentWisePerGame(?,?,?)&quot;);
<span class="nc" id="L123">					cstmt.setTimestamp(1, fromDate);</span>
<span class="nc" id="L124">					cstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L125">					cstmt.setInt(3, gameNo);</span>
<span class="nc" id="L126">					rs = cstmt.executeQuery();</span>
<span class="nc" id="L127">					String agtOrgId = null;</span>
<span class="nc" id="L128">					double sale = 0, cancel = 0, pwt = 0;</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L130">						agtOrgId = rs.getString(&quot;parent_id&quot;);</span>
<span class="nc" id="L131">						sale = rs.getDouble(&quot;sale&quot;);</span>
<span class="nc" id="L132">						cancel = rs.getDouble(&quot;cancel&quot;);</span>
<span class="nc" id="L133">						pwt = rs.getDouble(&quot;pwt&quot;);</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">						if(agtMap.containsKey(agtOrgId)) {</span>
<span class="nc" id="L135">							agtMap.get(agtOrgId).setDgSale(</span>
									agtMap.get(agtOrgId).getDgSale() + sale);
<span class="nc" id="L137">							agtMap.get(agtOrgId).setDgCancel(</span>
									agtMap.get(agtOrgId).getDgCancel() + cancel);
<span class="nc" id="L139">							agtMap.get(agtOrgId).setDgPwt(</span>
									agtMap.get(agtOrgId).getDgPwt() + pwt);
<span class="nc" id="L141">							agtMap.get(agtOrgId).setDgDirPlyPwt(</span>
									agtMap.get(agtOrgId).getDgDirPlyPwt()
											+ rs.getDouble(&quot;pwtDir&quot;));
						}
					}
<span class="nc" id="L146">				}</span>
<span class="nc" id="L147">				DBConnect.closePstmt(gamePstmt);</span>
			}
<span class="nc bnc" id="L149" title="All 2 branches missed.">			if (ReportUtility.isSE) {</span>
				// Game Master Query
<span class="nc" id="L151">				String gameQry = &quot;select game_id from st_se_game_master&quot;;</span>
<span class="nc" id="L152">				PreparedStatement gamePstmt = con.prepareStatement(gameQry);</span>
<span class="nc" id="L153">				ResultSet rsGame = gamePstmt.executeQuery();</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">				while (rsGame.next()) {</span>
<span class="nc" id="L155">					int gameNo = rsGame.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L156">					cstmt = con</span>
							.prepareCall(&quot;call scratchCollectionAgentWisePerGame(?,?,?)&quot;);
<span class="nc" id="L158">					cstmt.setTimestamp(1, fromDate);</span>
<span class="nc" id="L159">					cstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L160">					cstmt.setInt(3, gameNo);</span>
<span class="nc" id="L161">					rs = cstmt.executeQuery();</span>
<span class="nc" id="L162">					String agtOrgId = null;</span>
<span class="nc" id="L163">					double sale = 0, cancel = 0, pwt = 0;</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L165">						agtOrgId = rs.getString(&quot;organization_id&quot;);</span>
<span class="nc" id="L166">						sale = rs.getDouble(&quot;sale&quot;);</span>
<span class="nc" id="L167">						cancel = rs.getDouble(&quot;cancel&quot;);</span>
<span class="nc" id="L168">						pwt = rs.getDouble(&quot;pwt&quot;);</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">						if(agtMap.containsKey(agtOrgId)) {</span>
<span class="nc" id="L170">							agtMap.get(agtOrgId).setSeSale(</span>
									agtMap.get(agtOrgId).getSeSale()
											+ (sale - cancel));
<span class="nc" id="L173">							agtMap.get(agtOrgId).setSePwt(</span>
									agtMap.get(agtOrgId).getSePwt() + pwt);
<span class="nc" id="L175">							agtMap.get(agtOrgId).setSeDirPlyPwt(</span>
									agtMap.get(agtOrgId).getSeDirPlyPwt()
											+ rs.getDouble(&quot;pwtDir&quot;));
						}
					}
<span class="nc" id="L180">				}</span>
<span class="nc" id="L181">				DBConnect.closePstmt(gamePstmt);</span>
			}
<span class="nc bnc" id="L183" title="All 2 branches missed.">			if (ReportUtility.isCS) {</span>
				// Category Master Query
<span class="nc" id="L185">				String catQry = &quot;select category_id from st_cs_product_category_master where status = 'ACTIVE'&quot;;</span>
<span class="nc" id="L186">				PreparedStatement gamePstmt = con.prepareStatement(catQry);</span>
<span class="nc" id="L187">				ResultSet rsProduct = gamePstmt.executeQuery();</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">				while (rsProduct.next()) {</span>
<span class="nc" id="L189">					int catId = rsProduct.getInt(&quot;category_id&quot;);</span>
<span class="nc" id="L190">					cstmt = con</span>
							.prepareCall(&quot;call csCollectionAgentWisePerCategory(?,?,?)&quot;);
<span class="nc" id="L192">					cstmt.setTimestamp(1, fromDate);</span>
<span class="nc" id="L193">					cstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L194">					cstmt.setInt(3, catId);</span>
<span class="nc" id="L195">					logger.debug(&quot;-------CS Sale Query------\n&quot; + cstmt);</span>
<span class="nc" id="L196">					rs = cstmt.executeQuery();</span>
<span class="nc bnc" id="L197" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">						if(agtMap.containsKey(rs.getString(&quot;parent_id&quot;))) {</span>
<span class="nc" id="L199">							agtMap.get(rs.getString(&quot;parent_id&quot;)).setCSSale(</span>
									agtMap.get(rs.getString(&quot;parent_id&quot;))
											.getCSSale()
											+ rs.getDouble(&quot;sale&quot;));
<span class="nc" id="L203">							agtMap.get(rs.getString(&quot;parent_id&quot;)).setCSCancel(</span>
									agtMap.get(rs.getString(&quot;parent_id&quot;))
											.getCSCancel()
											+ rs.getDouble(&quot;cancel&quot;));
						}
					}
<span class="nc" id="L209">				}</span>
<span class="nc" id="L210">				DBConnect.closePstmt(gamePstmt);</span>
			}
<span class="nc bnc" id="L212" title="All 2 branches missed.">			if (ReportUtility.isOLA) {</span>
<span class="nc" id="L213">				OlaOrgReportRequestBean requestBean = new OlaOrgReportRequestBean();</span>
<span class="nc" id="L214">				requestBean.setFromDate(fromDate.toString());</span>
<span class="nc" id="L215">				requestBean.setToDate(endDate.toString());</span>
<span class="nc" id="L216">				Map&lt;Integer, OlaOrgReportResponseBean&gt; olaResponseBeanMap = OlaAgentReportControllerImpl</span>
						.fetchDepositWithdrawlMultipleAgent(requestBean, con);

<span class="nc bnc" id="L219" title="All 2 branches missed.">				for (Map.Entry&lt;Integer, OlaOrgReportResponseBean&gt; entry : olaResponseBeanMap</span>
						.entrySet()) {
<span class="nc" id="L221">					String orgId = String.valueOf(entry.getKey());</span>
<span class="nc" id="L222">					OlaOrgReportResponseBean olaResponseBean = entry.getValue();</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">					if (agtMap.containsKey(orgId)) {</span>
<span class="nc" id="L224">						agtMap.get(orgId).setWithdrawal(</span>
								olaResponseBean.getNetWithdrawalAmt());
<span class="nc" id="L226">						agtMap.get(orgId).setDeposit(</span>
								olaResponseBean.getNetDepositAmt());
					}
<span class="nc" id="L229">				}</span>
				
<span class="nc" id="L231">				String netGamingQry = &quot;select om.parent_id agtOrgId, ifnull(sum(netGamingAmt), 0.0) netAmt from(select wrs.retailer_org_id, agt_net_claim_comm as netGamingAmt from st_ola_ret_comm wrs inner join st_lms_retailer_transaction_master rt on wrs.transaction_id=rt.transaction_id where transaction_type = 'OLA_COMMISSION' and transaction_date&gt;='&quot;</span>
						+ startDate
						+ &quot;' and transaction_date&lt;='&quot;
						+ endDate
						+ &quot;') wdret right outer join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on om.organization_id = wdret.retailer_org_id group by om.parent_id&quot;;
				
				//net gaming commission query
<span class="nc" id="L238">				pstmt = con.prepareStatement(netGamingQry);</span>
<span class="nc" id="L239">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">				while(rs.next()){</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">					if (agtMap.containsKey(rs.getString(&quot;agtOrgId&quot;))) {</span>
<span class="nc" id="L242">						agtMap.get(rs.getString(&quot;agtOrgId&quot;)).setNetGamingComm(</span>
								rs.getDouble(&quot;netAmt&quot;));
					}
					
				}
				/*
				 * StringBuilder olaQuery = new StringBuilder(
				 * &quot;select WID.agtOrgId, wdraw,wdrawRef,depoAmt,depoRefAmt,netAmt from (select om.parent_id agtOrgId, ifnull(sum(wd), 0.0) wdraw from (select wrs.retailer_org_id, agent_net_amt as wd from st_ola_ret_withdrawl wrs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type = 'OLA_WITHDRAWL' and transaction_date&gt;='&quot;
				 * + fromDate + &quot;' and transaction_date&lt;='&quot; + endDate +
				 * &quot;')) wdret right outer join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on om.organization_id = wdret.retailer_org_id group by om.parent_id)WID, (select om.parent_id agtOrgId, ifnull(sum(wdRef), 0.0) wdrawRef from (select wrs.retailer_org_id, agent_net_amt as wdRef from st_ola_ret_withdrawl_refund wrs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type = 'OLA_WITHDRAWL_REFUND' and transaction_date&gt;='&quot;
				 * + fromDate + &quot;' and transaction_date&lt;='&quot; + endDate +
				 * &quot;')) wdret right outer join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on om.organization_id = wdret.retailer_org_id group by om.parent_id)WIDREF,(select om.parent_id agtOrgId, ifnull(sum(depo), 0.0) depoAmt from (select wrs.retailer_org_id, agent_net_amt as depo from st_ola_ret_deposit wrs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type = 'OLA_DEPOSIT' and transaction_date&gt;='&quot;
				 * + fromDate + &quot;' and transaction_date&lt;='&quot; + endDate +
				 * &quot;')) wdret right outer join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on om.organization_id = wdret.retailer_org_id group by om.parent_id)DEP,(select om.parent_id agtOrgId, ifnull(sum(depoRef), 0.0) depoRefAmt from (select wrs.retailer_org_id, agent_net_amt as depoRef from st_ola_ret_deposit_refund wrs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type = 'OLA_DEPOSIT_REFUND' and transaction_date&gt;='&quot;
				 * + fromDate + &quot;' and transaction_date&lt;='&quot; + endDate +
				 * &quot;')) wdret right outer join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on om.organization_id = wdret.retailer_org_id group by om.parent_id)DEPREF,(select om.parent_id agtOrgId, ifnull(sum(netGamingAmt), 0.0) netAmt from(select wrs.retailer_org_id, agt_net_claim_comm as netGamingAmt from st_ola_ret_comm wrs inner join st_lms_retailer_transaction_master rt on wrs.transaction_id=rt.transaction_id where transaction_type = 'OLA_COMMISSION' and transaction_date&gt;='&quot;
				 * + fromDate + &quot;' and transaction_date&lt;='&quot; + endDate +
				 * &quot;') wdret right outer join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on om.organization_id = wdret.retailer_org_id group by om.parent_id)NETGAME where WID.agtOrgId=WIDREF.agtOrgId and WIDREF.agtOrgId =DEP.agtOrgId and DEP.agtOrgId =DEPREF.agtOrgId and DEPREF.agtOrgId=NETGAME.agtOrgId and NETGAME.agtOrgId=WID.agtOrgId&quot;
				 * );
				 * 
				 * StringBuilder unionQuery=null; StringBuilder mainQuery=null;
				 * 
				 * if(LMSFilterDispatcher.isRepFrmSP){ mainQuery=new
				 * StringBuilder(
				 * &quot;select agtOrgId,sum(wdraw) wdraw,sum(wdrawRef) wdrawRef,sum(depoAmt) depoAmt,sum(depoRefAmt)depoRefAmt,sum(netAmt) netAmt from (&quot;
				 * ); unionQuery=newStringBuilder(
				 * &quot; union all select parent_id agtOrgId , sum(withdrawal_net_amt) wdraw , sum(ref_withdrawal_net_amt) wdrawRef , sum(deposit_net) depoAmt  , sum(ref_deposit_net_amt) depoRefAmt, sum(net_gaming_net_comm) netAmt from st_rep_ola_retailer where finaldate&gt;='&quot;
				 * +fromDate+&quot;' and finaldate&lt;='&quot;+endDate+
				 * &quot;' group by parent_id) repTable group by agtOrgId&quot;);
				 * mainQuery
				 * .append(olaQuery.toString()).append(unionQuery.toString());
				 * pstmt = con.prepareStatement(mainQuery.toString()); } else {
				 * pstmt = con.prepareStatement(olaQuery.toString()); } rs =
				 * pstmt.executeQuery(); while (rs.next()) {
				 * agtMap.get(rs.getString(&quot;agtOrgId&quot;)).setWithdrawal(
				 * rs.getDouble(&quot;wdraw&quot;));
				 * agtMap.get(rs.getString(&quot;agtOrgId&quot;)).setWithdrawalRefund(
				 * rs.getDouble(&quot;wdrawRef&quot;));
				 * agtMap.get(rs.getString(&quot;agtOrgId&quot;)).setDeposit(
				 * rs.getDouble(&quot;depoAmt&quot;));
				 * agtMap.get(rs.getString(&quot;agtOrgId&quot;)).setDepositRefund(
				 * rs.getDouble(&quot;depoRefAmt&quot;));
				 * agtMap.get(rs.getString(&quot;agtOrgId&quot;)).setNetGamingComm(
				 * rs.getDouble(&quot;netAmt&quot;)); }
				 */
				/*
				 * 
				 * // Wallet Master Query String walletQry =
				 * &quot;select wallet_id from st_ola_wallet_master&quot;;
				 * PreparedStatement walletPstmt =
				 * con.prepareStatement(walletQry); ResultSet rsWallet =
				 * walletPstmt.executeQuery();
				 * 
				 * while (rsWallet.next()) { int walletId =
				 * rsWallet.getInt(&quot;wallet_id&quot;); cstmt = con
				 * .prepareCall(&quot;call OLACollectionAgentWisePerWallet(?,?,?)&quot;);
				 * cstmt.setTimestamp(1, startDate); cstmt.setTimestamp(2,
				 * endDate); cstmt.setInt(3, walletId); rs =
				 * cstmt.executeQuery(); String agtOrgId = null; double sale =
				 * 0, cancel = 0, pwt = 0; while (rs.next()) { agtOrgId =
				 * rs.getString(&quot;parent_id&quot;); sale = rs.getDouble(&quot;withdraw&quot;);
				 * cancel = rs.getDouble(&quot;deposit&quot;);
				 * agtMap.get(agtOrgId).setDgSale(
				 * agtMap.get(agtOrgId).getDgSale() + sale);
				 * agtMap.get(agtOrgId).setDgCancel(
				 * agtMap.get(agtOrgId).getDgCancel() + cancel);
				 * agtMap.get(agtOrgId).setDgPwt(
				 * agtMap.get(agtOrgId).getDgPwt() + pwt);
				 * agtMap.get(agtOrgId).setDgDirPlyPwt(
				 * agtMap.get(agtOrgId).getDgDirPlyPwt() +
				 * rs.getDouble(&quot;pwtDir&quot;)); } }
				 */
			}

<span class="nc bnc" id="L316" title="All 2 branches missed.">			if (ReportUtility.isSLE) {</span>
<span class="nc" id="L317">				SLEOrgReportRequestBean requestBean = new SLEOrgReportRequestBean();</span>
<span class="nc" id="L318">				requestBean.setFromDate(fromDate);</span>
<span class="nc" id="L319">				requestBean.setToDate(endDate);</span>
<span class="nc" id="L320">				Map&lt;Integer, SLEOrgReportResponseBean&gt; sleResponseBeanMap = SLEAgentReportsControllerImpl</span>
						.fetchSaleCancelPWTMultipleAgent(requestBean, con);

<span class="nc bnc" id="L323" title="All 2 branches missed.">				for (Map.Entry&lt;Integer, SLEOrgReportResponseBean&gt; entry : sleResponseBeanMap</span>
						.entrySet()) {
<span class="nc" id="L325">					String orgId = String.valueOf(entry.getKey());</span>
<span class="nc" id="L326">					SLEOrgReportResponseBean sleResponseBean = entry.getValue();</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">					if (agtMap.containsKey(orgId)) {</span>
<span class="nc" id="L328">						agtMap.get(orgId).setSleSale(</span>
								sleResponseBean.getSaleAmt());
<span class="nc" id="L330">						agtMap.get(orgId).setSleCancel(</span>
								sleResponseBean.getCancelAmt());
<span class="nc" id="L332">						agtMap.get(orgId)</span>
								.setSlePwt(sleResponseBean.getPwtAmt());
<span class="nc" id="L334">						agtMap.get(orgId).setSleDirPlyPwt(</span>
								sleResponseBean.getPwtDirAmt());
					}
<span class="nc" id="L337">				}</span>
			}
			
<span class="nc bnc" id="L340" title="All 2 branches missed.">			if (ReportUtility.isIW) {</span>
<span class="nc" id="L341">				IWOrgReportRequestBean requestBean = new IWOrgReportRequestBean();</span>
<span class="nc" id="L342">				requestBean.setFromDate(fromDate);</span>
<span class="nc" id="L343">				requestBean.setToDate(endDate);</span>
<span class="nc" id="L344">				Map&lt;Integer, IWOrgReportResponseBean&gt; iwResponseBeanMap = IWAgentReportsControllerImpl.fetchSaleCancelPWTMultipleAgent(requestBean, con);</span>

<span class="nc bnc" id="L346" title="All 2 branches missed.">				for (Map.Entry&lt;Integer, IWOrgReportResponseBean&gt; entry : iwResponseBeanMap.entrySet()) {</span>
<span class="nc" id="L347">					String orgId = String.valueOf(entry.getKey());</span>
<span class="nc" id="L348">					IWOrgReportResponseBean iwResponseBean = entry.getValue();</span>
<span class="nc bnc" id="L349" title="All 2 branches missed.">					if (agtMap.containsKey(orgId)) {</span>
<span class="nc" id="L350">						agtMap.get(orgId).setIwSale(iwResponseBean.getSaleAmt());</span>
<span class="nc" id="L351">						agtMap.get(orgId).setIwCancel(iwResponseBean.getCancelAmt());</span>
<span class="nc" id="L352">						agtMap.get(orgId).setIwPwt(iwResponseBean.getPwtAmt());</span>
<span class="nc" id="L353">						agtMap.get(orgId).setIwDirPlyPwt(iwResponseBean.getPwtDirAmt());</span>
					}
<span class="nc" id="L355">				}</span>
			}
			
<span class="nc bnc" id="L358" title="All 2 branches missed.">			if (ReportUtility.isVS) {</span>
<span class="nc" id="L359">				String gameQry = ReportUtility.getVSGameMapQuery(fromDate);		</span>
<span class="nc" id="L360">				PreparedStatement gamePstmt = con.prepareStatement(gameQry);		</span>
<span class="nc" id="L361">				ResultSet rsGame = gamePstmt.executeQuery();		</span>
<span class="nc bnc" id="L362" title="All 2 branches missed.">				while(rsGame.next()){</span>
<span class="nc" id="L363">					VSOrgReportRequestBean requestBean = new VSOrgReportRequestBean();</span>
<span class="nc" id="L364">					requestBean.setFromDate(fromDate);</span>
<span class="nc" id="L365">					requestBean.setToDate(endDate);</span>
<span class="nc" id="L366">					requestBean.setGameId(rsGame.getInt(&quot;game_id&quot;));</span>
<span class="nc" id="L367">					Map&lt;Integer, VSOrgReportResponseBean&gt; vsResponseBeanMap = VSAgentReportsControllerImpl.fetchSaleCancelPWTMultipleAgent(requestBean, con);</span>
	
<span class="nc bnc" id="L369" title="All 2 branches missed.">					for (Map.Entry&lt;Integer, VSOrgReportResponseBean&gt; entry : vsResponseBeanMap.entrySet()) {</span>
<span class="nc" id="L370">						String orgId = String.valueOf(entry.getKey());</span>
<span class="nc" id="L371">						VSOrgReportResponseBean vsResponseBean = entry.getValue();</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">						if (agtMap.containsKey(orgId)) {</span>
<span class="nc" id="L373">							agtMap.get(orgId).setVsSale(agtMap.get(orgId).getVsSale()+ vsResponseBean.getSaleAmt());</span>
<span class="nc" id="L374">							agtMap.get(orgId).setVsCancel(agtMap.get(orgId).getVsCancel()+ vsResponseBean.getCancelAmt());</span>
<span class="nc" id="L375">							agtMap.get(orgId).setVsPwt(agtMap.get(orgId).getVsPwt()+ vsResponseBean.getPwtAmt());</span>
<span class="nc" id="L376">							agtMap.get(orgId).setVsDirPlyPwt(agtMap.get(orgId).getVsDirPlyPwt()+ vsResponseBean.getPwtDirAmt());</span>
						}
<span class="nc" id="L378">					}</span>
<span class="nc" id="L379">				}</span>
			}

<span class="nc" id="L382">			Iterator&lt;Map.Entry&lt;String, CollectionReportOverAllBean&gt;&gt; itr = agtMap</span>
					.entrySet().iterator();
<span class="nc bnc" id="L384" title="All 2 branches missed.">			while (itr.hasNext()) {</span>
<span class="nc" id="L385">				Map.Entry&lt;String, CollectionReportOverAllBean&gt; pair = itr</span>
						.next();
<span class="nc" id="L387">				CollectionReportOverAllBean bean = pair.getValue();</span>
<span class="nc" id="L388">				double openingBal = bean.getOpeningBal()</span>
						+ bean.getDgSale()
						- bean.getDgCancel()
						- bean.getDgPwt()
						- bean.getDgDirPlyPwt()
						+ bean.getSeSale()
						- bean.getSePwt()
						- bean.getSeDirPlyPwt()
						+ bean.getCSSale()
						- bean.getCSCancel()
						+ bean.getDeposit()
						- bean.getDepositRefund()
						- bean.getWithdrawal()
						- bean.getNetGamingComm()
						+ bean.getSleSale()
						- bean.getSleCancel()
						- bean.getSlePwt()
						- bean.getSleDirPlyPwt()
						+ bean.getIwSale()
						- bean.getIwCancel()
						- bean.getIwPwt()
						- bean.getIwDirPlyPwt()
						+ bean.getVsSale()
						- bean.getVsCancel()
						- bean.getVsPwt()
						- bean.getVsDirPlyPwt()
						- (bean.getCash() + bean.getCheque() + bean.getCredit()
								+ bean.getBankDep() - bean.getDebit() - bean
								.getChequeReturn());

<span class="nc" id="L418">				bean.setOpeningBal(0.0);</span>
<span class="nc" id="L419">				bean.setCash(0.0);</span>
<span class="nc" id="L420">				bean.setCheque(0.0);</span>
<span class="nc" id="L421">				bean.setChequeReturn(0.0);</span>
<span class="nc" id="L422">				bean.setCredit(0.0);</span>
<span class="nc" id="L423">				bean.setDebit(0.0);</span>
<span class="nc" id="L424">				bean.setBankDep(0.0);</span>
<span class="nc bnc" id="L425" title="All 2 branches missed.">				if (ReportUtility.isDG) {</span>
<span class="nc" id="L426">					bean.setDgSale(0.0);</span>
<span class="nc" id="L427">					bean.setDgPwt(0.0);</span>
<span class="nc" id="L428">					bean.setDgCancel(0.0);</span>
<span class="nc" id="L429">					bean.setDgDirPlyPwt(0.0);</span>
				}
<span class="nc bnc" id="L431" title="All 2 branches missed.">				if (ReportUtility.isSE) {</span>
<span class="nc" id="L432">					bean.setSeSale(0.0);</span>
<span class="nc" id="L433">					bean.setSePwt(0.0);</span>
<span class="nc" id="L434">					bean.setSeDirPlyPwt(0.0);</span>
				}
<span class="nc bnc" id="L436" title="All 2 branches missed.">				if (ReportUtility.isCS) {</span>
<span class="nc" id="L437">					bean.setCSSale(0.0);</span>
<span class="nc" id="L438">					bean.setCSCancel(0.0);</span>
				}
<span class="nc bnc" id="L440" title="All 2 branches missed.">				if (ReportUtility.isOLA) {</span>
<span class="nc" id="L441">					bean.setDeposit(0.0);</span>
<span class="nc" id="L442">					bean.setDepositRefund(0.0);</span>
<span class="nc" id="L443">					bean.setWithdrawal(0.0);</span>
<span class="nc" id="L444">					bean.setWithdrawalRefund(0.0);</span>
<span class="nc" id="L445">					bean.setNetGamingComm(0.0);</span>
				}
<span class="nc bnc" id="L447" title="All 2 branches missed.">				if (ReportUtility.isSLE) {</span>
<span class="nc" id="L448">					bean.setSleSale(0.0);</span>
<span class="nc" id="L449">					bean.setSlePwt(0.0);</span>
<span class="nc" id="L450">					bean.setSleCancel(0.0);</span>
<span class="nc" id="L451">					bean.setSleDirPlyPwt(0.0);</span>
				}
<span class="nc bnc" id="L453" title="All 2 branches missed.">				if (ReportUtility.isIW) {</span>
<span class="nc" id="L454">					bean.setIwSale(0.0);</span>
<span class="nc" id="L455">					bean.setIwPwt(0.0);</span>
<span class="nc" id="L456">					bean.setIwCancel(0.0);</span>
<span class="nc" id="L457">					bean.setIwDirPlyPwt(0.0);</span>
				}
<span class="nc bnc" id="L459" title="All 2 branches missed.">				if (ReportUtility.isVS) {</span>
<span class="nc" id="L460">					bean.setVsSale(0.0);</span>
<span class="nc" id="L461">					bean.setVsPwt(0.0);</span>
<span class="nc" id="L462">					bean.setVsCancel(0.0);</span>
<span class="nc" id="L463">					bean.setVsDirPlyPwt(0.0);</span>
				}

<span class="nc" id="L466">				bean.setOpeningBal(openingBal);</span>
<span class="nc" id="L467">			}</span>

<span class="nc" id="L469">		} catch (Exception e) {</span>
<span class="nc" id="L470">			e.printStackTrace();</span>
<span class="nc" id="L471">			throw new LMSException(&quot;Error in report collectionAgentWise&quot;);</span>
		} finally {
<span class="nc" id="L473">			DBConnect.closePstmt(pstmt);</span>
<span class="nc" id="L474">			DBConnect.closeCstmt(cstmt);</span>
<span class="nc" id="L475">		}</span>
<span class="nc" id="L476">	}</span>
	
	public void collectionAgentWiseBalanceData(Timestamp startDate, Timestamp endDate, Connection con, Map&lt;String, OrganizationBalanceData&gt; agtMap) throws LMSException {
<span class="nc" id="L479">		ResultSet rs = null;</span>
<span class="nc" id="L480">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L481">		CallableStatement cstmt = null;</span>
<span class="nc" id="L482">		Date lastArchDate = null;</span>
<span class="nc bnc" id="L483" title="All 2 branches missed.">		if (startDate.after(endDate)) {</span>
<span class="nc" id="L484">			return;</span>
		}

		try {
<span class="nc" id="L488">			Timestamp fromDate = null;</span>
<span class="nc" id="L489">			SimpleDateFormat sdf = new SimpleDateFormat(&quot;dd-MM-yyyy&quot;);</span>
<span class="nc" id="L490">			Calendar lastRunDateCal = Calendar.getInstance();</span>

			// String date = ReportUtility.fetchLastRunDate(con);

<span class="nc" id="L494">			String date = ReportUtility.fetchLastRunDate(&quot;AGENT&quot;, -1, con);</span>
<span class="nc" id="L495">			lastRunDateCal.setTimeInMillis(sdf.parse(date).getTime());</span>
				
<span class="nc" id="L497">			pstmt = con.prepareStatement(&quot;select organization_id, (opening_bal_cl_inc - net_amount_transaction + cl + xcl) live_open_bal, (opening_bal + net_amount_transaction)open_bal from st_rep_org_bal_history where finaldate=? and organization_type='AGENT'&quot;);</span>
<span class="nc" id="L498">			pstmt.setTimestamp(1, new Timestamp(lastRunDateCal.getTimeInMillis()));</span>

<span class="nc" id="L500">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L501" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc bnc" id="L502" title="All 2 branches missed.">				if (agtMap.get(rs.getString(&quot;organization_id&quot;)) != null) {</span>
<span class="nc" id="L503">					agtMap.get(rs.getString(&quot;organization_id&quot;)).setOpeningBal(rs.getDouble(&quot;open_bal&quot;));</span>
<span class="nc" id="L504">					agtMap.get(rs.getString(&quot;organization_id&quot;)).setLiveOpeningBal(rs.getDouble(&quot;live_open_bal&quot;));</span>
				}
			}

<span class="nc bnc" id="L508" title="All 2 branches missed.">			if(lastRunDateCal.getTimeInMillis() &lt; startDate.getTime()) {</span>
<span class="nc" id="L509">				lastRunDateCal.add(Calendar.DAY_OF_MONTH, 1);</span>
<span class="nc" id="L510">				fromDate = new Timestamp(lastRunDateCal.getTimeInMillis());</span>
<span class="nc bnc" id="L511" title="All 4 branches missed.">			} else if(lastRunDateCal.getTimeInMillis() &gt;= startDate.getTime() &amp;&amp; lastRunDateCal.getTimeInMillis() &lt; endDate.getTime()) {</span>
<span class="nc" id="L512">				fromDate = startDate;</span>
			} else {
				return;
			}

			// Get Account Details
<span class="nc" id="L518">			cstmt = con.prepareCall(&quot;call collectionCashChqOverAll(?,?)&quot;);</span>
<span class="nc" id="L519">			cstmt.setTimestamp(1, fromDate);</span>
<span class="nc" id="L520">			cstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L521">			rs = cstmt.executeQuery();</span>

<span class="nc bnc" id="L523" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L524">				String agtOrgId = rs.getString(&quot;organization_id&quot;);</span>
<span class="nc bnc" id="L525" title="All 2 branches missed.">				if (agtMap.containsKey(agtOrgId)) {</span>
<span class="nc" id="L526">					agtMap.get(agtOrgId).setCash(rs.getDouble(&quot;cash&quot;));</span>
<span class="nc" id="L527">					agtMap.get(agtOrgId).setCheque(rs.getDouble(&quot;chq&quot;));</span>
<span class="nc" id="L528">					agtMap.get(agtOrgId).setChequeReturn(rs.getDouble(&quot;chq_ret&quot;));</span>
<span class="nc" id="L529">					agtMap.get(agtOrgId).setCredit(rs.getDouble(&quot;credit&quot;));</span>
<span class="nc" id="L530">					agtMap.get(agtOrgId).setDebit(rs.getDouble(&quot;debit&quot;));</span>
<span class="nc" id="L531">					agtMap.get(agtOrgId).setBankDep(rs.getDouble(&quot;bank&quot;));</span>
				}
<span class="nc" id="L533">			}</span>

<span class="nc bnc" id="L535" title="All 2 branches missed.">			if (ReportUtility.isDG) {</span>
				// Game Master Query
				// String gameQry = &quot;select game_id from st_dg_game_master&quot;;
<span class="nc" id="L538">				PreparedStatement gamePstmt = con.prepareStatement(ReportUtility.getDrawGameMapQuery(fromDate));</span>
<span class="nc" id="L539">				ResultSet rsGame = gamePstmt.executeQuery();</span>

<span class="nc bnc" id="L541" title="All 2 branches missed.">				while (rsGame.next()) {</span>
<span class="nc" id="L542">					int gameNo = rsGame.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L543">					cstmt = con.prepareCall(&quot;call drawCollectionAgentWisePerGame(?,?,?)&quot;);</span>
<span class="nc" id="L544">					cstmt.setTimestamp(1, fromDate);</span>
<span class="nc" id="L545">					cstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L546">					cstmt.setInt(3, gameNo);</span>
<span class="nc" id="L547">					rs = cstmt.executeQuery();</span>
<span class="nc" id="L548">					String agtOrgId = null;</span>
<span class="nc" id="L549">					double sale = 0, cancel = 0, pwt = 0;</span>
<span class="nc bnc" id="L550" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L551">						agtOrgId = rs.getString(&quot;parent_id&quot;);</span>
<span class="nc" id="L552">						sale = rs.getDouble(&quot;sale&quot;);</span>
<span class="nc" id="L553">						cancel = rs.getDouble(&quot;cancel&quot;);</span>
<span class="nc" id="L554">						pwt = rs.getDouble(&quot;pwt&quot;);</span>
<span class="nc bnc" id="L555" title="All 2 branches missed.">						if (agtMap.containsKey(agtOrgId)) {</span>
<span class="nc" id="L556">							agtMap.get(agtOrgId).setDgSale(agtMap.get(agtOrgId).getDgSale() + sale);</span>
<span class="nc" id="L557">							agtMap.get(agtOrgId).setDgCancel(agtMap.get(agtOrgId).getDgCancel() + cancel);</span>
<span class="nc" id="L558">							agtMap.get(agtOrgId).setDgPwt(agtMap.get(agtOrgId).getDgPwt() + pwt);</span>
<span class="nc" id="L559">							agtMap.get(agtOrgId).setDgDirPlyPwt(agtMap.get(agtOrgId).getDgDirPlyPwt() + rs.getDouble(&quot;pwtDir&quot;));</span>
						}
					}
<span class="nc" id="L562">				}</span>
<span class="nc" id="L563">				DBConnect.closePstmt(gamePstmt);</span>
			}
<span class="nc bnc" id="L565" title="All 2 branches missed.">			if (ReportUtility.isSE) {</span>
				// Game Master Query
<span class="nc" id="L567">				String gameQry = &quot;select game_id from st_se_game_master&quot;;</span>
<span class="nc" id="L568">				PreparedStatement gamePstmt = con.prepareStatement(gameQry);</span>
<span class="nc" id="L569">				ResultSet rsGame = gamePstmt.executeQuery();</span>
<span class="nc bnc" id="L570" title="All 2 branches missed.">				while (rsGame.next()) {</span>
<span class="nc" id="L571">					int gameNo = rsGame.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L572">					cstmt = con.prepareCall(&quot;call scratchCollectionAgentWisePerGame(?,?,?)&quot;);</span>
<span class="nc" id="L573">					cstmt.setTimestamp(1, fromDate);</span>
<span class="nc" id="L574">					cstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L575">					cstmt.setInt(3, gameNo);</span>
<span class="nc" id="L576">					rs = cstmt.executeQuery();</span>
<span class="nc" id="L577">					String agtOrgId = null;</span>
<span class="nc" id="L578">					double sale = 0, cancel = 0, pwt = 0;</span>
<span class="nc bnc" id="L579" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L580">						agtOrgId = rs.getString(&quot;organization_id&quot;);</span>
<span class="nc" id="L581">						sale = rs.getDouble(&quot;sale&quot;);</span>
<span class="nc" id="L582">						cancel = rs.getDouble(&quot;cancel&quot;);</span>
<span class="nc" id="L583">						pwt = rs.getDouble(&quot;pwt&quot;);</span>
<span class="nc bnc" id="L584" title="All 2 branches missed.">						if (agtMap.containsKey(agtOrgId)) {</span>
<span class="nc" id="L585">							agtMap.get(agtOrgId).setSeSale(agtMap.get(agtOrgId).getSeSale() + (sale - cancel));</span>
<span class="nc" id="L586">							agtMap.get(agtOrgId).setSePwt(agtMap.get(agtOrgId).getSePwt() + pwt);</span>
<span class="nc" id="L587">							agtMap.get(agtOrgId).setSeDirPlyPwt(agtMap.get(agtOrgId).getSeDirPlyPwt() + rs.getDouble(&quot;pwtDir&quot;));</span>
						}
					}
<span class="nc" id="L590">				}</span>
<span class="nc" id="L591">				DBConnect.closePstmt(gamePstmt);</span>
			}
<span class="nc bnc" id="L593" title="All 2 branches missed.">			if (ReportUtility.isCS) {</span>
				// Category Master Query
<span class="nc" id="L595">				String catQry = &quot;select category_id from st_cs_product_category_master where status = 'ACTIVE'&quot;;</span>
<span class="nc" id="L596">				PreparedStatement gamePstmt = con.prepareStatement(catQry);</span>
<span class="nc" id="L597">				ResultSet rsProduct = gamePstmt.executeQuery();</span>
<span class="nc bnc" id="L598" title="All 2 branches missed.">				while (rsProduct.next()) {</span>
<span class="nc" id="L599">					int catId = rsProduct.getInt(&quot;category_id&quot;);</span>
<span class="nc" id="L600">					cstmt = con.prepareCall(&quot;call csCollectionAgentWisePerCategory(?,?,?)&quot;);</span>
<span class="nc" id="L601">					cstmt.setTimestamp(1, fromDate);</span>
<span class="nc" id="L602">					cstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L603">					cstmt.setInt(3, catId);</span>
<span class="nc" id="L604">					logger.debug(&quot;-------CS Sale Query------\n&quot; + cstmt);</span>
<span class="nc" id="L605">					rs = cstmt.executeQuery();</span>
<span class="nc bnc" id="L606" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc bnc" id="L607" title="All 2 branches missed.">						if (agtMap.containsKey(rs.getString(&quot;parent_id&quot;))) {</span>
<span class="nc" id="L608">							agtMap.get(rs.getString(&quot;parent_id&quot;)).setCSSale(agtMap.get(rs.getString(&quot;parent_id&quot;)).getCSSale() + rs.getDouble(&quot;sale&quot;));</span>
<span class="nc" id="L609">							agtMap.get(rs.getString(&quot;parent_id&quot;)).setCSCancel(agtMap.get(rs.getString(&quot;parent_id&quot;)).getCSCancel() + rs.getDouble(&quot;cancel&quot;));</span>
						}
					}
<span class="nc" id="L612">				}</span>
<span class="nc" id="L613">				DBConnect.closePstmt(gamePstmt);</span>
			}
<span class="nc bnc" id="L615" title="All 2 branches missed.">			if (ReportUtility.isOLA) {</span>
<span class="nc" id="L616">				OlaOrgReportRequestBean requestBean = new OlaOrgReportRequestBean();</span>
<span class="nc" id="L617">				requestBean.setFromDate(fromDate.toString());</span>
<span class="nc" id="L618">				requestBean.setToDate(endDate.toString());</span>
<span class="nc" id="L619">				Map&lt;Integer, OlaOrgReportResponseBean&gt; olaResponseBeanMap = OlaAgentReportControllerImpl.fetchDepositWithdrawlMultipleAgent(requestBean, con);</span>

<span class="nc bnc" id="L621" title="All 2 branches missed.">				for (Map.Entry&lt;Integer, OlaOrgReportResponseBean&gt; entry : olaResponseBeanMap.entrySet()) {</span>
<span class="nc" id="L622">					String orgId = String.valueOf(entry.getKey());</span>
<span class="nc" id="L623">					OlaOrgReportResponseBean olaResponseBean = entry.getValue();</span>
<span class="nc bnc" id="L624" title="All 2 branches missed.">					if (agtMap.containsKey(orgId)) {</span>
<span class="nc" id="L625">						agtMap.get(orgId).setWithdrawal(olaResponseBean.getNetWithdrawalAmt());</span>
<span class="nc" id="L626">						agtMap.get(orgId).setDeposit(olaResponseBean.getNetDepositAmt());</span>
					}
<span class="nc" id="L628">				}</span>
			}

<span class="nc bnc" id="L631" title="All 2 branches missed.">			if (ReportUtility.isSLE) {</span>
<span class="nc" id="L632">				SLEOrgReportRequestBean requestBean = new SLEOrgReportRequestBean();</span>
<span class="nc" id="L633">				requestBean.setFromDate(fromDate);</span>
<span class="nc" id="L634">				requestBean.setToDate(endDate);</span>
<span class="nc" id="L635">				Map&lt;Integer, SLEOrgReportResponseBean&gt; sleResponseBeanMap = SLEAgentReportsControllerImpl.fetchSaleCancelPWTMultipleAgent(requestBean, con);</span>

<span class="nc bnc" id="L637" title="All 2 branches missed.">				for (Map.Entry&lt;Integer, SLEOrgReportResponseBean&gt; entry : sleResponseBeanMap.entrySet()) {</span>
<span class="nc" id="L638">					String orgId = String.valueOf(entry.getKey());</span>
<span class="nc" id="L639">					SLEOrgReportResponseBean sleResponseBean = entry.getValue();</span>
<span class="nc bnc" id="L640" title="All 2 branches missed.">					if (agtMap.containsKey(orgId)) {</span>
<span class="nc" id="L641">						agtMap.get(orgId).setSleSale(sleResponseBean.getSaleAmt());</span>
<span class="nc" id="L642">						agtMap.get(orgId).setSleCancel(sleResponseBean.getCancelAmt());</span>
<span class="nc" id="L643">						agtMap.get(orgId).setSlePwt(sleResponseBean.getPwtAmt());</span>
<span class="nc" id="L644">						agtMap.get(orgId).setSleDirPlyPwt(sleResponseBean.getPwtDirAmt());</span>
					}
<span class="nc" id="L646">				}</span>
			}

<span class="nc bnc" id="L649" title="All 2 branches missed.">			if (ReportUtility.isIW) {</span>
<span class="nc" id="L650">				IWOrgReportRequestBean requestBean = new IWOrgReportRequestBean();</span>
<span class="nc" id="L651">				requestBean.setFromDate(fromDate);</span>
<span class="nc" id="L652">				requestBean.setToDate(endDate);</span>
<span class="nc" id="L653">				Map&lt;Integer, IWOrgReportResponseBean&gt; iwResponseBeanMap = IWAgentReportsControllerImpl.fetchSaleCancelPWTMultipleAgent(requestBean, con);</span>

<span class="nc bnc" id="L655" title="All 2 branches missed.">				for (Map.Entry&lt;Integer, IWOrgReportResponseBean&gt; entry : iwResponseBeanMap.entrySet()) {</span>
<span class="nc" id="L656">					String orgId = String.valueOf(entry.getKey());</span>
<span class="nc" id="L657">					IWOrgReportResponseBean iwResponseBean = entry.getValue();</span>
<span class="nc bnc" id="L658" title="All 2 branches missed.">					if (agtMap.containsKey(orgId)) {</span>
<span class="nc" id="L659">						agtMap.get(orgId).setIwSale(iwResponseBean.getSaleAmt());</span>
<span class="nc" id="L660">						agtMap.get(orgId).setIwCancel(iwResponseBean.getCancelAmt());</span>
<span class="nc" id="L661">						agtMap.get(orgId).setIwPwt(iwResponseBean.getPwtAmt());</span>
<span class="nc" id="L662">						agtMap.get(orgId).setIwDirPlyPwt(iwResponseBean.getPwtDirAmt());</span>
					}
<span class="nc" id="L664">				}</span>
			}
			
<span class="nc bnc" id="L667" title="All 2 branches missed.">			if (ReportUtility.isVS) {</span>
<span class="nc" id="L668">				String gameQry = ReportUtility.getVSGameMapQuery(fromDate);		</span>
<span class="nc" id="L669">				PreparedStatement gamePstmt = con.prepareStatement(gameQry);		</span>
<span class="nc" id="L670">				ResultSet rsGame = gamePstmt.executeQuery();		</span>
<span class="nc bnc" id="L671" title="All 2 branches missed.">				while(rsGame.next()){</span>
<span class="nc" id="L672">					VSOrgReportRequestBean requestBean = new VSOrgReportRequestBean();</span>
<span class="nc" id="L673">					requestBean.setFromDate(fromDate);</span>
<span class="nc" id="L674">					requestBean.setToDate(endDate);</span>
<span class="nc" id="L675">					requestBean.setGameId(rsGame.getInt(&quot;game_id&quot;));</span>
<span class="nc" id="L676">					Map&lt;Integer, VSOrgReportResponseBean&gt; vsResponseBeanMap = VSAgentReportsControllerImpl.fetchSaleCancelPWTMultipleAgent(requestBean, con);</span>
	
<span class="nc bnc" id="L678" title="All 2 branches missed.">					for (Map.Entry&lt;Integer, VSOrgReportResponseBean&gt; entry : vsResponseBeanMap.entrySet()) {</span>
<span class="nc" id="L679">						String orgId = String.valueOf(entry.getKey());</span>
<span class="nc" id="L680">						VSOrgReportResponseBean vsResponseBean = entry.getValue();</span>
<span class="nc bnc" id="L681" title="All 2 branches missed.">						if (agtMap.containsKey(orgId)) {</span>
<span class="nc" id="L682">							agtMap.get(orgId).setVsSale(agtMap.get(orgId).getVsSale()+ vsResponseBean.getSaleAmt());</span>
<span class="nc" id="L683">							agtMap.get(orgId).setVsCancel(agtMap.get(orgId).getVsCancel()+ vsResponseBean.getCancelAmt());</span>
<span class="nc" id="L684">							agtMap.get(orgId).setVsPwt(agtMap.get(orgId).getVsPwt()+ vsResponseBean.getPwtAmt());</span>
<span class="nc" id="L685">							agtMap.get(orgId).setVsDirPlyPwt(agtMap.get(orgId).getVsDirPlyPwt()+ vsResponseBean.getPwtDirAmt());</span>
						}
<span class="nc" id="L687">					}</span>
<span class="nc" id="L688">				}</span>
			}
			
//			Timestamp tempTimestamp = new Timestamp(endDate.getTime() + (((23 * 60 * 60) + (59 * 60) + 59) * 1000));
<span class="nc" id="L692">			pstmt = con.prepareStatement(&quot;select CL.organization_id, sum(amount)amount, type from st_lms_cl_xcl_update_history CL inner join st_lms_organization_master om on CL.organization_id=om.organization_id where organization_type='AGENT' and date_time&gt;=? and date_time&lt;=? group by CL.organization_id, CL.type&quot;);</span>
<span class="nc" id="L693">			pstmt.setTimestamp(1, fromDate);</span>
<span class="nc" id="L694">			pstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L695">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L696" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc bnc" id="L697" title="All 2 branches missed.">				if (&quot;CL&quot;.equals(rs.getString(&quot;type&quot;))) {</span>
<span class="nc bnc" id="L698" title="All 2 branches missed.">					if(agtMap.containsKey(rs.getString(&quot;organization_id&quot;)))</span>
<span class="nc" id="L699">						agtMap.get(rs.getString(&quot;organization_id&quot;)).setClLimit(rs.getDouble(&quot;amount&quot;));</span>
				}
<span class="nc bnc" id="L701" title="All 2 branches missed.">				else if (&quot;XCL&quot;.equals(rs.getString(&quot;type&quot;))) {</span>
<span class="nc bnc" id="L702" title="All 2 branches missed.">					if(agtMap.containsKey(rs.getString(&quot;organization_id&quot;)))</span>
<span class="nc" id="L703">						agtMap.get(rs.getString(&quot;organization_id&quot;)).setXclLimit(rs.getDouble(&quot;amount&quot;));</span>
				}
			}

<span class="nc bnc" id="L707" title="All 2 branches missed.">			for(Map.Entry&lt;String, OrganizationBalanceData&gt; entrySet : agtMap.entrySet()) {</span>
<span class="nc" id="L708">				OrganizationBalanceData bean = entrySet.getValue();</span>
<span class="nc" id="L709">				double openingBal = bean.getDgSale()</span>
						- bean.getDgCancel()
						- bean.getDgPwt()
						- bean.getDgDirPlyPwt()
						+ bean.getSeSale()
						- bean.getSePwt()
						- bean.getSeDirPlyPwt()
						+ bean.getCSSale()
						- bean.getCSCancel()
						+ bean.getDeposit()
						- bean.getDepositRefund()
						- bean.getWithdrawal()
						- bean.getNetGamingComm()
						+ bean.getSleSale()
						- bean.getSleCancel()
						- bean.getSlePwt()
						- bean.getSleDirPlyPwt()
						+ bean.getIwSale()
						- bean.getIwCancel()
						- bean.getIwPwt()
						- bean.getIwDirPlyPwt()
						+ bean.getVsSale()
						- bean.getVsCancel()
						- bean.getVsPwt()
						- bean.getVsDirPlyPwt()
						- (bean.getCash() + bean.getCheque() + bean.getCredit() + bean.getBankDep() - bean.getDebit() - bean.getChequeReturn());
				
<span class="nc bnc" id="L736" title="All 2 branches missed.">				if(bean.getOrgId() == 1256)</span>
				{
<span class="nc" id="L738">					System.out.println(&quot;asdasd&quot;);</span>
				}
				
<span class="nc" id="L741">				bean.setNetTxnAmt(openingBal);</span>
//				bean.setLiveOpeningBal(bean.getClLimit() + bean.getXclLimit() - openingBal + bean.getLiveOpeningBal());
<span class="nc" id="L743">				bean.setLiveOpeningBal(bean.getLiveOpeningBal());</span>
//				bean.setOpeningBal(openingBal + bean.getOpeningBal());
<span class="nc" id="L745">				bean.setOpeningBal(bean.getOpeningBal());</span>

<span class="nc" id="L747">				bean.setCash(0.0);</span>
<span class="nc" id="L748">				bean.setCheque(0.0);</span>
<span class="nc" id="L749">				bean.setChequeReturn(0.0);</span>
<span class="nc" id="L750">				bean.setCredit(0.0);</span>
<span class="nc" id="L751">				bean.setDebit(0.0);</span>
<span class="nc" id="L752">				bean.setBankDep(0.0);</span>
<span class="nc bnc" id="L753" title="All 2 branches missed.">				if (ReportUtility.isDG) {</span>
<span class="nc" id="L754">					bean.setDgSale(0.0);</span>
<span class="nc" id="L755">					bean.setDgPwt(0.0);</span>
<span class="nc" id="L756">					bean.setDgCancel(0.0);</span>
<span class="nc" id="L757">					bean.setDgDirPlyPwt(0.0);</span>
				}
<span class="nc bnc" id="L759" title="All 2 branches missed.">				if (ReportUtility.isSE) {</span>
<span class="nc" id="L760">					bean.setSeSale(0.0);</span>
<span class="nc" id="L761">					bean.setSePwt(0.0);</span>
<span class="nc" id="L762">					bean.setSeDirPlyPwt(0.0);</span>
				}
<span class="nc bnc" id="L764" title="All 2 branches missed.">				if (ReportUtility.isCS) {</span>
<span class="nc" id="L765">					bean.setCSSale(0.0);</span>
<span class="nc" id="L766">					bean.setCSCancel(0.0);</span>
				}
<span class="nc bnc" id="L768" title="All 2 branches missed.">				if (ReportUtility.isOLA) {</span>
<span class="nc" id="L769">					bean.setDeposit(0.0);</span>
<span class="nc" id="L770">					bean.setDepositRefund(0.0);</span>
<span class="nc" id="L771">					bean.setWithdrawal(0.0);</span>
<span class="nc" id="L772">					bean.setWithdrawalRefund(0.0);</span>
<span class="nc" id="L773">					bean.setNetGamingComm(0.0);</span>
				}
<span class="nc bnc" id="L775" title="All 2 branches missed.">				if (ReportUtility.isSLE) {</span>
<span class="nc" id="L776">					bean.setSleSale(0.0);</span>
<span class="nc" id="L777">					bean.setSlePwt(0.0);</span>
<span class="nc" id="L778">					bean.setSleCancel(0.0);</span>
<span class="nc" id="L779">					bean.setSleDirPlyPwt(0.0);</span>
				}
<span class="nc bnc" id="L781" title="All 2 branches missed.">				if (ReportUtility.isIW) {</span>
<span class="nc" id="L782">					bean.setIwSale(0.0);</span>
<span class="nc" id="L783">					bean.setIwPwt(0.0);</span>
<span class="nc" id="L784">					bean.setIwCancel(0.0);</span>
<span class="nc" id="L785">					bean.setIwDirPlyPwt(0.0);</span>
				}
<span class="nc bnc" id="L787" title="All 2 branches missed.">				if (ReportUtility.isVS) {</span>
<span class="nc" id="L788">					bean.setVsSale(0.0);</span>
<span class="nc" id="L789">					bean.setVsPwt(0.0);</span>
<span class="nc" id="L790">					bean.setVsCancel(0.0);</span>
<span class="nc" id="L791">					bean.setVsDirPlyPwt(0.0);</span>
				}
<span class="nc" id="L793">			}</span>
<span class="nc" id="L794">		} catch (Exception e) {</span>
<span class="nc" id="L795">			e.printStackTrace();</span>
<span class="nc" id="L796">			throw new LMSException(&quot;Error in report collectionAgentWise&quot;);</span>
		} finally {
<span class="nc" id="L798">			DBConnect.closePstmt(pstmt);</span>
<span class="nc" id="L799">			DBConnect.closeCstmt(cstmt);</span>
<span class="nc" id="L800">		}</span>
<span class="nc" id="L801">	}</span>

	public void collectionAgentWiseLiveOpenningBal(Timestamp startDate,
			Timestamp endDate, Connection con,
			Map&lt;String, CollectionReportOverAllBean&gt; agtMap)
			throws LMSException {

<span class="nc" id="L808">		ResultSet rs = null;</span>
<span class="nc" id="L809">		Date lastArchDate = null;</span>
<span class="nc" id="L810">		PreparedStatement pstmt = null;</span>
<span class="nc bnc" id="L811" title="All 2 branches missed.">		if (startDate.after(endDate)) {</span>
<span class="nc" id="L812">			return;</span>
		}

<span class="nc" id="L815">		Calendar checkCal = Calendar.getInstance();</span>
<span class="nc" id="L816">		checkCal.setTimeInMillis(endDate.getTime());</span>
<span class="nc" id="L817">		checkCal.add(Calendar.DAY_OF_MONTH, -1);</span>

		try {
//			boolean isDataFromArch = ReportUtility.checkDateLessThanLastRunDate(endDate, -1, &quot;AGENT&quot;, con);
//			if (isDataFromArch) {
//				Calendar cal1 = Calendar.getInstance();
//				cal1.setTimeInMillis(endDate.getTime());
//				cal1.add(Calendar.DAY_OF_MONTH, 1);
//				ReportUtility.clearTimeFromDate(cal1);
//
//				pstmt = con
//						.prepareStatement(&quot;select organization_id,opening_bal_cl_inc from st_rep_org_bal_history where finaldate=? and organization_type='AGENT'&quot;);
//				pstmt.setDate(1, new Date(cal1.getTimeInMillis()));
//
//				rs = pstmt.executeQuery();
//				while (rs.next()) {
//					if (agtMap.get(rs.getString(&quot;organization_id&quot;)) != null) {
//						agtMap.get(rs.getString(&quot;organization_id&quot;))
//								.setOpeningBal(
//										rs.getDouble(&quot;opening_bal_cl_inc&quot;));
//					}
//				}
//				return;
//
//			} else {
//				lastArchDate = ReportUtility.getLastArchDateInDateFormat(con);
//				pstmt = con
//						.prepareStatement(&quot;select organization_id,(opening_bal_cl_inc-net_amount_transaction+cl+xcl)open_bal from st_rep_org_bal_history where finaldate=? and organization_type='AGENT'&quot;);
//				pstmt.setDate(1, lastArchDate);
//
//				rs = pstmt.executeQuery();
//				while (rs.next()) {
//					if (agtMap.get(rs.getString(&quot;organization_id&quot;)) != null) {
//						agtMap.get(rs.getString(&quot;organization_id&quot;))
//								.setOpeningBal(rs.getDouble(&quot;open_bal&quot;));
//					}
//				}
//			}
			
<span class="nc" id="L856">			String lastRunDate = ReportUtility.fetchLastRunDate(con);</span>
<span class="nc" id="L857">			Calendar lastRunCal = Calendar.getInstance();</span>
<span class="nc" id="L858">			lastRunCal.setTimeInMillis(new SimpleDateFormat(&quot;dd-MM-yyyy&quot;).parse(lastRunDate).getTime());</span>
<span class="nc bnc" id="L859" title="All 2 branches missed.">			if (lastRunCal.getTimeInMillis() &gt;= checkCal.getTimeInMillis()) {</span>
<span class="nc" id="L860">				pstmt = con.prepareStatement(&quot;select organization_id,(opening_bal_cl_inc-net_amount_transaction+cl+xcl)open_bal from st_rep_org_bal_history where finaldate=? and organization_type='AGENT'&quot;);</span>
<span class="nc" id="L861">				pstmt.setTimestamp(1, new Timestamp(checkCal.getTimeInMillis()));</span>
<span class="nc" id="L862">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L863" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc bnc" id="L864" title="All 2 branches missed.">					if (agtMap.get(rs.getString(&quot;organization_id&quot;)) != null) {</span>
<span class="nc" id="L865">						agtMap.get(rs.getString(&quot;organization_id&quot;)).setOpeningBal(rs.getDouble(&quot;open_bal&quot;));</span>
					}
				}
<span class="nc" id="L868">				return;</span>
			} else {
<span class="nc" id="L870">				pstmt = con.prepareStatement(&quot;select organization_id,(opening_bal+net_amount_transaction)open_bal from st_rep_org_bal_history where finaldate=? and organization_type='AGENT'&quot;);</span>
<span class="nc" id="L871">				pstmt.setTimestamp(1, new Timestamp(lastRunCal.getTimeInMillis()));</span>
<span class="nc" id="L872">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L873" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc bnc" id="L874" title="All 2 branches missed.">					if (agtMap.get(rs.getString(&quot;organization_id&quot;)) != null) {</span>
<span class="nc" id="L875">						agtMap.get(rs.getString(&quot;organization_id&quot;)).setOpeningBal(rs.getDouble(&quot;open_bal&quot;));</span>
					}
				}
			}
			

//			Calendar cal = Calendar.getInstance();
//			cal.setTimeInMillis(lastArchDate.getTime());
//			cal.add(Calendar.DAY_OF_MONTH, 1);
//			ReportUtility.clearTimeFromDate(cal);
			
<span class="nc" id="L886">			Calendar cal = Calendar.getInstance();</span>
<span class="nc" id="L887">			cal.setTimeInMillis(lastRunCal.getTimeInMillis());</span>
<span class="nc" id="L888">			cal.add(Calendar.DAY_OF_MONTH, 1);</span>
<span class="nc" id="L889">			ReportUtility.clearTimeFromDate(cal);</span>

<span class="nc" id="L891">			Timestamp fromDate = new Timestamp(cal.getTimeInMillis());</span>

			// Get Account Details
<span class="nc" id="L894">			CallableStatement cstmt = con</span>
					.prepareCall(&quot;call collectionCashChqOverAll(?,?)&quot;);
<span class="nc" id="L896">			cstmt.setTimestamp(1, fromDate);</span>
<span class="nc" id="L897">			cstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L898">			rs = cstmt.executeQuery();</span>

<span class="nc bnc" id="L900" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L901">				String agtOrgId = rs.getString(&quot;organization_id&quot;);</span>
<span class="nc" id="L902">				agtMap.get(agtOrgId).setCash(rs.getDouble(&quot;cash&quot;));</span>
<span class="nc" id="L903">				agtMap.get(agtOrgId).setCheque(rs.getDouble(&quot;chq&quot;));</span>
<span class="nc" id="L904">				agtMap.get(agtOrgId).setChequeReturn(rs.getDouble(&quot;chq_ret&quot;));</span>
<span class="nc" id="L905">				agtMap.get(agtOrgId).setCredit(rs.getDouble(&quot;credit&quot;));</span>
<span class="nc" id="L906">				agtMap.get(agtOrgId).setDebit(rs.getDouble(&quot;debit&quot;));</span>
<span class="nc" id="L907">				agtMap.get(agtOrgId).setBankDep(rs.getDouble(&quot;bank&quot;));</span>
<span class="nc" id="L908">			}</span>

<span class="nc bnc" id="L910" title="All 2 branches missed.">			if (ReportUtility.isDG) {</span>
				// Game Master Query
				// String gameQry = &quot;select game_id from st_dg_game_master&quot;;
<span class="nc" id="L913">				PreparedStatement gamePstmt = con</span>
						.prepareStatement(ReportUtility
								.getDrawGameMapQuery(fromDate));
<span class="nc" id="L916">				ResultSet rsGame = gamePstmt.executeQuery();</span>

<span class="nc bnc" id="L918" title="All 2 branches missed.">				while (rsGame.next()) {</span>
<span class="nc" id="L919">					int gameNo = rsGame.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L920">					cstmt = con</span>
							.prepareCall(&quot;call drawCollectionAgentWisePerGame(?,?,?)&quot;);
<span class="nc" id="L922">					cstmt.setTimestamp(1, fromDate);</span>
<span class="nc" id="L923">					cstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L924">					cstmt.setInt(3, gameNo);</span>
<span class="nc" id="L925">					rs = cstmt.executeQuery();</span>
<span class="nc" id="L926">					String agtOrgId = null;</span>
<span class="nc" id="L927">					double sale = 0, cancel = 0, pwt = 0;</span>
<span class="nc bnc" id="L928" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L929">						agtOrgId = rs.getString(&quot;parent_id&quot;);</span>
<span class="nc" id="L930">						sale = rs.getDouble(&quot;sale&quot;);</span>
<span class="nc" id="L931">						cancel = rs.getDouble(&quot;cancel&quot;);</span>
<span class="nc" id="L932">						pwt = rs.getDouble(&quot;pwt&quot;);</span>
<span class="nc" id="L933">						agtMap.get(agtOrgId).setDgSale(</span>
								agtMap.get(agtOrgId).getDgSale() + sale);
<span class="nc" id="L935">						agtMap.get(agtOrgId).setDgCancel(</span>
								agtMap.get(agtOrgId).getDgCancel() + cancel);
<span class="nc" id="L937">						agtMap.get(agtOrgId).setDgPwt(</span>
								agtMap.get(agtOrgId).getDgPwt() + pwt);
<span class="nc" id="L939">						agtMap.get(agtOrgId).setDgDirPlyPwt(</span>
								agtMap.get(agtOrgId).getDgDirPlyPwt()
										+ rs.getDouble(&quot;pwtDir&quot;));
					}
<span class="nc" id="L943">				}</span>
			}
<span class="nc bnc" id="L945" title="All 2 branches missed.">			if (ReportUtility.isSE) {</span>
				// Game Master Query
<span class="nc" id="L947">				String gameQry = &quot;select game_id from st_se_game_master&quot;;</span>
<span class="nc" id="L948">				PreparedStatement gamePstmt = con.prepareStatement(gameQry);</span>
<span class="nc" id="L949">				ResultSet rsGame = gamePstmt.executeQuery();</span>
<span class="nc bnc" id="L950" title="All 2 branches missed.">				while (rsGame.next()) {</span>
<span class="nc" id="L951">					int gameNo = rsGame.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L952">					cstmt = con</span>
							.prepareCall(&quot;call scratchCollectionAgentWisePerGame(?,?,?)&quot;);
<span class="nc" id="L954">					cstmt.setTimestamp(1, fromDate);</span>
<span class="nc" id="L955">					cstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L956">					cstmt.setInt(3, gameNo);</span>
<span class="nc" id="L957">					rs = cstmt.executeQuery();</span>
<span class="nc" id="L958">					String agtOrgId = null;</span>
<span class="nc" id="L959">					double sale = 0, cancel = 0, pwt = 0;</span>
<span class="nc bnc" id="L960" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L961">						agtOrgId = rs.getString(&quot;organization_id&quot;);</span>
<span class="nc" id="L962">						sale = rs.getDouble(&quot;sale&quot;);</span>
<span class="nc" id="L963">						cancel = rs.getDouble(&quot;cancel&quot;);</span>
<span class="nc" id="L964">						pwt = rs.getDouble(&quot;pwt&quot;);</span>
<span class="nc" id="L965">						agtMap.get(agtOrgId).setSeSale(</span>
								agtMap.get(agtOrgId).getSeSale()
										+ (sale - cancel));
<span class="nc" id="L968">						agtMap.get(agtOrgId).setSePwt(</span>
								agtMap.get(agtOrgId).getSePwt() + pwt);
<span class="nc" id="L970">						agtMap.get(agtOrgId).setSeDirPlyPwt(</span>
								agtMap.get(agtOrgId).getSeDirPlyPwt()
										+ rs.getDouble(&quot;pwtDir&quot;));
					}
<span class="nc" id="L974">				}</span>
			}
<span class="nc bnc" id="L976" title="All 2 branches missed.">			if (ReportUtility.isCS) {</span>
				// Category Master Query
<span class="nc" id="L978">				String catQry = &quot;select category_id from st_cs_product_category_master where status = 'ACTIVE'&quot;;</span>
<span class="nc" id="L979">				PreparedStatement gamePstmt = con.prepareStatement(catQry);</span>
<span class="nc" id="L980">				ResultSet rsProduct = gamePstmt.executeQuery();</span>
<span class="nc bnc" id="L981" title="All 2 branches missed.">				while (rsProduct.next()) {</span>
<span class="nc" id="L982">					int catId = rsProduct.getInt(&quot;category_id&quot;);</span>
<span class="nc" id="L983">					cstmt = con</span>
							.prepareCall(&quot;call csCollectionAgentWisePerCategory(?,?,?)&quot;);
<span class="nc" id="L985">					cstmt.setTimestamp(1, fromDate);</span>
<span class="nc" id="L986">					cstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L987">					cstmt.setInt(3, catId);</span>
<span class="nc" id="L988">					logger.debug(&quot;-------CS Sale Query------\n&quot; + cstmt);</span>
<span class="nc" id="L989">					rs = cstmt.executeQuery();</span>
<span class="nc bnc" id="L990" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L991">						agtMap.get(rs.getString(&quot;parent_id&quot;)).setCSSale(</span>
								agtMap.get(rs.getString(&quot;parent_id&quot;))
										.getCSSale()
										+ rs.getDouble(&quot;sale&quot;));
<span class="nc" id="L995">						agtMap.get(rs.getString(&quot;parent_id&quot;)).setCSCancel(</span>
								agtMap.get(rs.getString(&quot;parent_id&quot;))
										.getCSCancel()
										+ rs.getDouble(&quot;cancel&quot;));
					}
<span class="nc" id="L1000">				}</span>
			}
<span class="nc bnc" id="L1002" title="All 2 branches missed.">			if (ReportUtility.isOLA) {</span>

<span class="nc" id="L1004">				StringBuilder olaQuery = new StringBuilder(</span>
						&quot;select WID.agtOrgId, wdraw,wdrawRef,depoAmt,depoRefAmt,netAmt from (select om.parent_id agtOrgId, ifnull(sum(wd), 0.0) wdraw from (select wrs.retailer_org_id, agent_net_amt as wd from st_ola_ret_withdrawl wrs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type = 'OLA_WITHDRAWL' and transaction_date&gt;='&quot;
								+ fromDate
								+ &quot;' and transaction_date&lt;='&quot;
								+ endDate
								+ &quot;')) wdret right outer join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on om.organization_id = wdret.retailer_org_id group by om.parent_id)WID, (select om.parent_id agtOrgId, ifnull(sum(wdRef), 0.0) wdrawRef from (select wrs.retailer_org_id, agent_net_amt as wdRef from st_ola_ret_withdrawl_refund wrs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type = 'OLA_WITHDRAWL_REFUND' and transaction_date&gt;='&quot;
								+ fromDate
								+ &quot;' and transaction_date&lt;='&quot;
								+ endDate
								+ &quot;')) wdret right outer join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on om.organization_id = wdret.retailer_org_id group by om.parent_id)WIDREF,(select om.parent_id agtOrgId, ifnull(sum(depo), 0.0) depoAmt from (select wrs.retailer_org_id, agent_net_amt as depo from st_ola_ret_deposit wrs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type = 'OLA_DEPOSIT' and transaction_date&gt;='&quot;
								+ fromDate
								+ &quot;' and transaction_date&lt;='&quot;
								+ endDate
								+ &quot;')) wdret right outer join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on om.organization_id = wdret.retailer_org_id group by om.parent_id)DEP,(select om.parent_id agtOrgId, ifnull(sum(depoRef), 0.0) depoRefAmt from (select wrs.retailer_org_id, agent_net_amt as depoRef from st_ola_ret_deposit_refund wrs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type = 'OLA_DEPOSIT_REFUND' and transaction_date&gt;='&quot;
								+ fromDate
								+ &quot;' and transaction_date&lt;='&quot;
								+ endDate
								+ &quot;')) wdret right outer join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on om.organization_id = wdret.retailer_org_id group by om.parent_id)DEPREF,(select om.parent_id agtOrgId, ifnull(sum(netGamingAmt), 0.0) netAmt from(select wrs.retailer_org_id, agt_net_claim_comm as netGamingAmt from st_ola_ret_comm wrs inner join st_lms_retailer_transaction_master rt on wrs.transaction_id=rt.transaction_id where transaction_type = 'OLA_COMMISSION' and transaction_date&gt;='&quot;
								+ fromDate
								+ &quot;' and transaction_date&lt;='&quot;
								+ endDate
								+ &quot;') wdret right outer join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on om.organization_id = wdret.retailer_org_id group by om.parent_id)NETGAME where WID.agtOrgId=WIDREF.agtOrgId and WIDREF.agtOrgId =DEP.agtOrgId and DEP.agtOrgId =DEPREF.agtOrgId and DEPREF.agtOrgId=NETGAME.agtOrgId and NETGAME.agtOrgId=WID.agtOrgId&quot;);

<span class="nc" id="L1027">				StringBuilder unionQuery = null;</span>
<span class="nc" id="L1028">				StringBuilder mainQuery = null;</span>

<span class="nc bnc" id="L1030" title="All 2 branches missed.">				if (LMSFilterDispatcher.isRepFrmSP) {</span>
<span class="nc" id="L1031">					mainQuery = new StringBuilder(</span>
							&quot;select agtOrgId,sum(wdraw) wdraw,sum(wdrawRef) wdrawRef,sum(depoAmt) depoAmt,sum(depoRefAmt)depoRefAmt,sum(netAmt) netAmt from (&quot;);
<span class="nc" id="L1033">					unionQuery = new StringBuilder(</span>
							&quot; union all select parent_id agtOrgId , sum(withdrawal_net_amt) wdraw , sum(ref_withdrawal_net_amt) wdrawRef , sum(deposit_net) depoAmt  , sum(ref_deposit_net_amt) depoRefAmt, sum(net_gaming_net_comm) netAmt from st_rep_ola_retailer where finaldate&gt;='&quot;
									+ fromDate
									+ &quot;' and finaldate&lt;='&quot;
									+ endDate
									+ &quot;' group by parent_id) repTable group by agtOrgId&quot;);
<span class="nc" id="L1039">					mainQuery.append(olaQuery.toString()).append(</span>
							unionQuery.toString());
<span class="nc" id="L1041">					pstmt = con.prepareStatement(mainQuery.toString());</span>
				} else {
<span class="nc" id="L1043">					pstmt = con.prepareStatement(olaQuery.toString());</span>
				}
<span class="nc" id="L1045">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1046" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L1047">					agtMap.get(rs.getString(&quot;agtOrgId&quot;)).setWithdrawal(</span>
							rs.getDouble(&quot;wdraw&quot;));
<span class="nc" id="L1049">					agtMap.get(rs.getString(&quot;agtOrgId&quot;)).setWithdrawalRefund(</span>
							rs.getDouble(&quot;wdrawRef&quot;));
<span class="nc" id="L1051">					agtMap.get(rs.getString(&quot;agtOrgId&quot;)).setDeposit(</span>
							rs.getDouble(&quot;depoAmt&quot;));
<span class="nc" id="L1053">					agtMap.get(rs.getString(&quot;agtOrgId&quot;)).setDepositRefund(</span>
							rs.getDouble(&quot;depoRefAmt&quot;));
<span class="nc" id="L1055">					agtMap.get(rs.getString(&quot;agtOrgId&quot;)).setNetGamingComm(</span>
							rs.getDouble(&quot;netAmt&quot;));
				}
				/*
				 * 
				 * // Wallet Master Query String walletQry =
				 * &quot;select wallet_id from st_ola_wallet_master&quot;;
				 * PreparedStatement walletPstmt =
				 * con.prepareStatement(walletQry); ResultSet rsWallet =
				 * walletPstmt.executeQuery();
				 * 
				 * while (rsWallet.next()) { int walletId =
				 * rsWallet.getInt(&quot;wallet_id&quot;); cstmt = con
				 * .prepareCall(&quot;call OLACollectionAgentWisePerWallet(?,?,?)&quot;);
				 * cstmt.setTimestamp(1, startDate); cstmt.setTimestamp(2,
				 * endDate); cstmt.setInt(3, walletId); rs =
				 * cstmt.executeQuery(); String agtOrgId = null; double sale =
				 * 0, cancel = 0, pwt = 0; while (rs.next()) { agtOrgId =
				 * rs.getString(&quot;parent_id&quot;); sale = rs.getDouble(&quot;withdraw&quot;);
				 * cancel = rs.getDouble(&quot;deposit&quot;);
				 * agtMap.get(agtOrgId).setDgSale(
				 * agtMap.get(agtOrgId).getDgSale() + sale);
				 * agtMap.get(agtOrgId).setDgCancel(
				 * agtMap.get(agtOrgId).getDgCancel() + cancel);
				 * agtMap.get(agtOrgId).setDgPwt(
				 * agtMap.get(agtOrgId).getDgPwt() + pwt);
				 * agtMap.get(agtOrgId).setDgDirPlyPwt(
				 * agtMap.get(agtOrgId).getDgDirPlyPwt() +
				 * rs.getDouble(&quot;pwtDir&quot;)); } }
				 */
			}

<span class="nc bnc" id="L1087" title="All 2 branches missed.">			if (ReportUtility.isSLE) {</span>
<span class="nc" id="L1088">				SLEOrgReportRequestBean requestBean = new SLEOrgReportRequestBean();</span>
<span class="nc" id="L1089">				requestBean.setFromDate(fromDate);</span>
<span class="nc" id="L1090">				requestBean.setToDate(endDate);</span>
<span class="nc" id="L1091">				Map&lt;Integer, SLEOrgReportResponseBean&gt; sleResponseBeanMap = SLEAgentReportsControllerImpl</span>
						.fetchSaleCancelPWTMultipleAgent(requestBean, con);

<span class="nc bnc" id="L1094" title="All 2 branches missed.">				for (Map.Entry&lt;Integer, SLEOrgReportResponseBean&gt; entry : sleResponseBeanMap</span>
						.entrySet()) {
<span class="nc" id="L1096">					String orgId = String.valueOf(entry.getKey());</span>
<span class="nc" id="L1097">					SLEOrgReportResponseBean sleResponseBean = entry.getValue();</span>
<span class="nc bnc" id="L1098" title="All 2 branches missed.">					if (agtMap.containsKey(orgId)) {</span>
<span class="nc" id="L1099">						agtMap.get(orgId).setSleSale(</span>
								agtMap.get(orgId).getSleSale()
										+ sleResponseBean.getSaleAmt());
<span class="nc" id="L1102">						agtMap.get(orgId).setSleCancel(</span>
								agtMap.get(orgId).getSleCancel()
										+ sleResponseBean.getCancelAmt());
<span class="nc" id="L1105">						agtMap.get(orgId).setSlePwt(</span>
								agtMap.get(orgId).getSlePwt()
										+ sleResponseBean.getPwtAmt());
<span class="nc" id="L1108">						agtMap.get(orgId).setSleDirPlyPwt(</span>
								agtMap.get(orgId).getSleDirPlyPwt()
										+ sleResponseBean.getPwtDirAmt());
					}
<span class="nc" id="L1112">				}</span>
			}

			// set cl and xcl in openning bal
<span class="nc" id="L1116">			pstmt = con</span>
					.prepareStatement(&quot;select CL.organization_id,sum(amount)amount from st_lms_cl_xcl_update_history CL inner join st_lms_organization_master om on CL.organization_id=om.organization_id where organization_type='AGENT' and date_time&gt;=? and date_time&lt;=? group by CL.organization_id&quot;);
<span class="nc" id="L1118">			pstmt.setTimestamp(1, fromDate);</span>
<span class="nc" id="L1119">			pstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L1120">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1121" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1122">				agtMap.get(rs.getString(&quot;organization_id&quot;)).setClLimit(</span>
						rs.getDouble(&quot;amount&quot;));
			}

<span class="nc" id="L1126">			Iterator&lt;Map.Entry&lt;String, CollectionReportOverAllBean&gt;&gt; itr = agtMap</span>
					.entrySet().iterator();
<span class="nc bnc" id="L1128" title="All 2 branches missed.">			while (itr.hasNext()) {</span>
<span class="nc" id="L1129">				Map.Entry&lt;String, CollectionReportOverAllBean&gt; pair = itr</span>
						.next();
<span class="nc" id="L1131">				CollectionReportOverAllBean bean = pair.getValue();</span>
<span class="nc" id="L1132">				double openingBal = bean.getDgSale()</span>
						- bean.getDgCancel()
						- bean.getDgPwt()
						- bean.getDgDirPlyPwt()
						+ bean.getSeSale()
						- bean.getSePwt()
						- bean.getSeDirPlyPwt()
						+ bean.getCSSale()
						- bean.getCSCancel()
						+ bean.getDeposit()
						- bean.getDepositRefund()
						- bean.getWithdrawal()
						- bean.getNetGamingComm()
						+ bean.getSleSale()
						- bean.getSleCancel()
						- bean.getSlePwt()
						- bean.getSleDirPlyPwt()
						- (bean.getCash() + bean.getCheque() + bean.getCredit()
								+ bean.getBankDep() - bean.getDebit() - bean
								.getChequeReturn());
<span class="nc" id="L1152">				openingBal = bean.getClLimit() - openingBal</span>
						+ bean.getOpeningBal();
<span class="nc" id="L1154">				bean.setOpeningBal(0.0);</span>
<span class="nc" id="L1155">				bean.setCash(0.0);</span>
<span class="nc" id="L1156">				bean.setCheque(0.0);</span>
<span class="nc" id="L1157">				bean.setChequeReturn(0.0);</span>
<span class="nc" id="L1158">				bean.setCredit(0.0);</span>
<span class="nc" id="L1159">				bean.setDebit(0.0);</span>
<span class="nc" id="L1160">				bean.setBankDep(0.0);</span>
<span class="nc" id="L1161">				bean.setClLimit(0.0);</span>
<span class="nc bnc" id="L1162" title="All 2 branches missed.">				if (ReportUtility.isDG) {</span>
<span class="nc" id="L1163">					bean.setDgSale(0.0);</span>
<span class="nc" id="L1164">					bean.setDgPwt(0.0);</span>
<span class="nc" id="L1165">					bean.setDgCancel(0.0);</span>
<span class="nc" id="L1166">					bean.setDgDirPlyPwt(0.0);</span>
				}
<span class="nc bnc" id="L1168" title="All 2 branches missed.">				if (ReportUtility.isSE) {</span>
<span class="nc" id="L1169">					bean.setSeSale(0.0);</span>
<span class="nc" id="L1170">					bean.setSePwt(0.0);</span>
<span class="nc" id="L1171">					bean.setSeDirPlyPwt(0.0);</span>
				}
<span class="nc bnc" id="L1173" title="All 2 branches missed.">				if (ReportUtility.isCS) {</span>
<span class="nc" id="L1174">					bean.setCSSale(0.0);</span>
<span class="nc" id="L1175">					bean.setCSCancel(0.0);</span>
				}
<span class="nc bnc" id="L1177" title="All 2 branches missed.">				if (ReportUtility.isOLA) {</span>
<span class="nc" id="L1178">					bean.setDeposit(0.0);</span>
<span class="nc" id="L1179">					bean.setDepositRefund(0.0);</span>
<span class="nc" id="L1180">					bean.setWithdrawal(0.0);</span>
<span class="nc" id="L1181">					bean.setWithdrawalRefund(0.0);</span>
<span class="nc" id="L1182">					bean.setNetGamingComm(0.0);</span>
				}
<span class="nc bnc" id="L1184" title="All 2 branches missed.">				if (ReportUtility.isSLE) {</span>
<span class="nc" id="L1185">					bean.setSleSale(0.0);</span>
<span class="nc" id="L1186">					bean.setSlePwt(0.0);</span>
<span class="nc" id="L1187">					bean.setSleCancel(0.0);</span>
<span class="nc" id="L1188">					bean.setSleDirPlyPwt(0.0);</span>
				}

<span class="nc" id="L1191">				bean.setOpeningBal(openingBal);</span>
<span class="nc" id="L1192">			}</span>

<span class="nc" id="L1194">		} catch (Exception e) {</span>
<span class="nc" id="L1195">			e.printStackTrace();</span>
<span class="nc" id="L1196">			throw new LMSException(&quot;Error in report collectionAgentWise&quot;);</span>
<span class="nc" id="L1197">		}</span>
<span class="nc" id="L1198">	}</span>

	public double collectionAgentWise(Timestamp startDate, Timestamp endDate,
			Connection con, int agtOrgId) throws LMSException {

<span class="nc" id="L1203">		ResultSet rs = null;</span>
<span class="nc" id="L1204">		double RetOpenBal = 0.0;</span>
<span class="nc" id="L1205">		Date lastArchDate = null;</span>
<span class="nc bnc" id="L1206" title="All 2 branches missed.">		if (startDate.after(endDate)) {</span>
<span class="nc" id="L1207">			throw new LMSException(&quot;Error in report collectionAgentWise&quot;);</span>
		}
<span class="nc" id="L1209">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L1210">		Calendar checkCal = Calendar.getInstance();</span>
<span class="nc" id="L1211">		checkCal.setTimeInMillis(endDate.getTime());</span>
<span class="nc" id="L1212">		checkCal.add(Calendar.DAY_OF_MONTH, -1);</span>

		try {
<span class="nc" id="L1215">			String lastRunDate = ReportUtility.fetchLastRunDate(con);</span>
<span class="nc" id="L1216">			Calendar lastRunCal = Calendar.getInstance();</span>
<span class="nc" id="L1217">			lastRunCal.setTimeInMillis(new SimpleDateFormat(&quot;dd-MM-yyyy&quot;).parse(lastRunDate).getTime());</span>
<span class="nc bnc" id="L1218" title="All 2 branches missed.">			if (lastRunCal.getTimeInMillis() &gt;= checkCal.getTimeInMillis()) {</span>
<span class="nc" id="L1219">				pstmt = con.prepareStatement(&quot;select organization_id,(opening_bal+net_amount_transaction)open_bal from st_rep_org_bal_history where finaldate=? and organization_id =? and organization_type='AGENT'&quot;);</span>
<span class="nc" id="L1220">				pstmt.setTimestamp(1, new Timestamp(checkCal.getTimeInMillis()));</span>
<span class="nc" id="L1221">				pstmt.setInt(2, agtOrgId);</span>
<span class="nc" id="L1222">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1223" title="All 2 branches missed.">				if (rs.next()) {</span>
<span class="nc" id="L1224">					RetOpenBal = rs.getDouble(&quot;open_bal&quot;);</span>
				}
<span class="nc" id="L1226">				return RetOpenBal;</span>
			} else {
<span class="nc" id="L1228">				pstmt = con.prepareStatement(&quot;select organization_id,(opening_bal+net_amount_transaction)open_bal from st_rep_org_bal_history where finaldate=? and organization_id =? and organization_type='AGENT'&quot;);</span>
<span class="nc" id="L1229">				pstmt.setTimestamp(1, new Timestamp(lastRunCal.getTimeInMillis()));</span>
<span class="nc" id="L1230">				pstmt.setInt(2, agtOrgId);</span>
<span class="nc" id="L1231">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1232" title="All 2 branches missed.">				if (rs.next()) {</span>
<span class="nc" id="L1233">					RetOpenBal = rs.getDouble(&quot;open_bal&quot;);</span>
				}
			}
			
//			boolean isDataFromArch = ReportUtility.checkDateLessThanLastRunDate(endDate, -1, &quot;AGENT&quot;, con);
//			if (isDataFromArch) {
//				Calendar cal1 = Calendar.getInstance();
//				cal1.setTimeInMillis(endDate.getTime());
//				cal1.add(Calendar.DAY_OF_MONTH, 1);
//				ReportUtility.clearTimeFromDate(cal1);
//
//				pstmt = con
//						.prepareStatement(&quot;select organization_id,opening_bal from st_rep_org_bal_history where finaldate=? and organization_id =? and organization_type='AGENT'&quot;);
//				pstmt.setDate(1, new Date(cal1.getTimeInMillis()));
//				pstmt.setInt(2, agtOrgId);
//				rs = pstmt.executeQuery();
//				if (rs.next()) {
//					RetOpenBal = rs.getDouble(&quot;opening_bal&quot;);
//
//				}
//				return RetOpenBal;
//
//			} else {
//				lastArchDate = ReportUtility.getLastArchDateInDateFormat(con);
//				pstmt = con
//						.prepareStatement(&quot;select organization_id,(opening_bal+net_amount_transaction)open_bal from st_rep_org_bal_history where finaldate=? and organization_id =? and organization_type='AGENT'&quot;);
//				pstmt.setDate(1, lastArchDate);
//				pstmt.setInt(2, agtOrgId);
//				rs = pstmt.executeQuery();
//				if (rs.next()) {
//					RetOpenBal = rs.getDouble(&quot;open_bal&quot;);
//
//				}
//			}

<span class="nc" id="L1268">			Calendar cal = Calendar.getInstance();</span>
<span class="nc" id="L1269">			cal.setTimeInMillis(lastRunCal.getTimeInMillis());</span>
<span class="nc" id="L1270">			cal.add(Calendar.DAY_OF_MONTH, 1);</span>
<span class="nc" id="L1271">			ReportUtility.clearTimeFromDate(cal);</span>

<span class="nc" id="L1273">			Timestamp fromDate = new Timestamp(cal.getTimeInMillis());</span>

			// Get Account Details
<span class="nc" id="L1276">			CallableStatement cstmt = con</span>
					.prepareCall(&quot;call paymentCashChqOverAll(?,?,?)&quot;);
<span class="nc" id="L1278">			cstmt.setTimestamp(1, fromDate);</span>
<span class="nc" id="L1279">			cstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L1280">			cstmt.setInt(3, agtOrgId);</span>
<span class="nc" id="L1281">			rs = cstmt.executeQuery();</span>
<span class="nc" id="L1282">			double recTotal = 0.0;</span>
<span class="nc" id="L1283">			double scratchTotal = 0.0;</span>
<span class="nc" id="L1284">			double drawTotal = 0.0;</span>
<span class="nc" id="L1285">			double csTotal = 0.0;</span>
<span class="nc" id="L1286">			double olaTotal = 0.0;</span>
<span class="nc" id="L1287">			double sleTotal = 0.0;</span>
<span class="nc" id="L1288">			double iwTotal = 0.0;</span>
<span class="nc" id="L1289">			double vsTotal = 0.0;</span>
<span class="nc bnc" id="L1290" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1291">				double cash = rs.getDouble(&quot;cash&quot;);</span>
<span class="nc" id="L1292">				double cheque = rs.getDouble(&quot;chq&quot;);</span>
<span class="nc" id="L1293">				double credit = rs.getDouble(&quot;credit&quot;);</span>
<span class="nc" id="L1294">				double debit = rs.getDouble(&quot;debit&quot;);</span>
<span class="nc" id="L1295">				double chqRet = rs.getDouble(&quot;chq_ret&quot;);</span>
<span class="nc" id="L1296">				double bank = rs.getDouble(&quot;bank&quot;);</span>
<span class="nc" id="L1297">				recTotal = recTotal + cash + cheque + credit + bank - debit</span>
						- chqRet;

				/*
				 * agtMap.get(agtOrgId+&quot;&quot;).setCash(rs.getDouble(&quot;cash&quot;));
				 * agtMap.get(agtOrgId+&quot;&quot;).setCheque(rs.getDouble(&quot;chq&quot;));
				 * agtMap
				 * .get(agtOrgId+&quot;&quot;).setChequeReturn(rs.getDouble(&quot;chq_ret&quot;));
				 * agtMap.get(agtOrgId+&quot;&quot;).setCredit(rs.getDouble(&quot;credit&quot;));
				 * agtMap.get(agtOrgId+&quot;&quot;).setDebit(rs.getDouble(&quot;debit&quot;));
				 * agtMap.get(agtOrgId+&quot;&quot;).setBankDep(rs.getDouble(&quot;bank&quot;));
				 */
<span class="nc" id="L1309">			}</span>

<span class="nc bnc" id="L1311" title="All 2 branches missed.">			if (ReportUtility.isDG) {</span>
				// Game Master Query
				// String gameQry = &quot;select game_id from st_dg_game_master&quot;;
<span class="nc" id="L1314">				PreparedStatement gamePstmt = con</span>
						.prepareStatement(ReportUtility
								.getDrawGameMapQuery(fromDate));
<span class="nc" id="L1317">				ResultSet rsGame = gamePstmt.executeQuery();</span>

<span class="nc bnc" id="L1319" title="All 2 branches missed.">				while (rsGame.next()) {</span>
<span class="nc" id="L1320">					int gameNo = rsGame.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L1321">					cstmt = con</span>
							.prepareCall(&quot;call drawPaymentAgentWisePerGame(?,?,?,?)&quot;);
<span class="nc" id="L1323">					cstmt.setTimestamp(1, fromDate);</span>
<span class="nc" id="L1324">					cstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L1325">					cstmt.setInt(3, gameNo);</span>
<span class="nc" id="L1326">					cstmt.setInt(4, agtOrgId);</span>
<span class="nc" id="L1327">					rs = cstmt.executeQuery();</span>
					// String agtOrgId = null;
<span class="nc" id="L1329">					double sale = 0, cancel = 0, pwt = 0;</span>
<span class="nc" id="L1330">					double dirPlrPwt = 0.0;</span>
<span class="nc bnc" id="L1331" title="All 2 branches missed.">					while (rs.next()) {</span>
						// agtOrgId = rs.getString(&quot;parent_id&quot;);

<span class="nc" id="L1334">						sale = sale + rs.getDouble(&quot;sale&quot;);</span>
<span class="nc" id="L1335">						cancel = cancel + rs.getDouble(&quot;cancel&quot;);</span>
<span class="nc" id="L1336">						pwt = pwt + rs.getDouble(&quot;pwt&quot;);</span>
<span class="nc" id="L1337">						dirPlrPwt = dirPlrPwt + rs.getDouble(&quot;pwtDir&quot;);</span>
<span class="nc" id="L1338">						drawTotal = drawTotal + sale - cancel - pwt - dirPlrPwt;</span>
						/*
						 * agtMap.get(agtOrgId+&quot;&quot;).setDgSale(
						 * agtMap.get(agtOrgId+&quot;&quot;).getDgSale() + sale);
						 * agtMap.get(agtOrgId+&quot;&quot;).setDgCancel(
						 * agtMap.get(agtOrgId+&quot;&quot;).getDgCancel() + cancel);
						 * agtMap.get(agtOrgId+&quot;&quot;).setDgPwt(
						 * agtMap.get(agtOrgId+&quot;&quot;).getDgPwt() + pwt);
						 */
						/*
						 * agtMap.get(agtOrgId+&quot;&quot;).setDgDirPlyPwt(
						 * agtMap.get(agtOrgId+&quot;&quot;).getDgDirPlyPwt() +
						 * rs.getDouble(&quot;pwtDir&quot;));
						 */
					}
<span class="nc" id="L1353">				}</span>

			}
<span class="nc bnc" id="L1356" title="All 2 branches missed.">			if (ReportUtility.isSE) {</span>
				// Game Master Query
<span class="nc" id="L1358">				String gameQry = &quot;select game_id from st_se_game_master&quot;;</span>
<span class="nc" id="L1359">				PreparedStatement gamePstmt = con.prepareStatement(gameQry);</span>
<span class="nc" id="L1360">				ResultSet rsGame = gamePstmt.executeQuery();</span>
<span class="nc bnc" id="L1361" title="All 2 branches missed.">				while (rsGame.next()) {</span>
<span class="nc" id="L1362">					int gameNo = rsGame.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L1363">					cstmt = con</span>
							.prepareCall(&quot;call scratchPaymentAgentWisePerGame(?,?,?,?)&quot;);
<span class="nc" id="L1365">					cstmt.setTimestamp(1, fromDate);</span>
<span class="nc" id="L1366">					cstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L1367">					cstmt.setInt(3, gameNo);</span>
<span class="nc" id="L1368">					cstmt.setInt(4, agtOrgId);</span>
<span class="nc" id="L1369">					rs = cstmt.executeQuery();</span>
					// String agtOrgId = null;
<span class="nc" id="L1371">					double sale = 0, cancel = 0, pwt = 0;</span>
<span class="nc" id="L1372">					double dirPlrPwt = 0.0;</span>
<span class="nc bnc" id="L1373" title="All 2 branches missed.">					while (rs.next()) {</span>
						// agtOrgId = rs.getString(&quot;organization_id&quot;);
<span class="nc" id="L1375">						sale = sale + rs.getDouble(&quot;sale&quot;);</span>
<span class="nc" id="L1376">						cancel = cancel + rs.getDouble(&quot;cancel&quot;);</span>
<span class="nc" id="L1377">						pwt = pwt + rs.getDouble(&quot;pwt&quot;);</span>
<span class="nc" id="L1378">						dirPlrPwt = dirPlrPwt + rs.getDouble(&quot;pwtDir&quot;);</span>
<span class="nc" id="L1379">						scratchTotal = scratchTotal + sale - cancel - pwt</span>
								- dirPlrPwt;
						/*
						 * agtMap.get(agtOrgId+&quot;&quot;).setSeSale(
						 * agtMap.get(agtOrgId+&quot;&quot;).getSeSale() + (sale -
						 * cancel)); agtMap.get(agtOrgId+&quot;&quot;).setSePwt(
						 * agtMap.get(agtOrgId+&quot;&quot;).getSePwt() + pwt);
						 * agtMap.get(agtOrgId+&quot;&quot;).setSeDirPlyPwt(
						 * agtMap.get(agtOrgId+&quot;&quot;).getSeDirPlyPwt() +
						 * rs.getDouble(&quot;pwtDir&quot;));
						 */
					}
<span class="nc" id="L1391">				}</span>
			}
<span class="nc bnc" id="L1393" title="All 2 branches missed.">			if (ReportUtility.isCS) {</span>
				// Category Master Query
<span class="nc" id="L1395">				String catQry = &quot;select category_id from st_cs_product_category_master where status = 'ACTIVE'&quot;;</span>
<span class="nc" id="L1396">				PreparedStatement gamePstmt = con.prepareStatement(catQry);</span>
<span class="nc" id="L1397">				ResultSet rsProduct = gamePstmt.executeQuery();</span>
<span class="nc bnc" id="L1398" title="All 2 branches missed.">				while (rsProduct.next()) {</span>
<span class="nc" id="L1399">					int catId = rsProduct.getInt(&quot;category_id&quot;);</span>
<span class="nc" id="L1400">					cstmt = con</span>
							.prepareCall(&quot;call csPaymentAgentWisePerGame(?,?,?,?)&quot;);
<span class="nc" id="L1402">					cstmt.setTimestamp(1, fromDate);</span>
<span class="nc" id="L1403">					cstmt.setTimestamp(2, endDate);</span>
<span class="nc" id="L1404">					cstmt.setInt(3, catId);</span>
<span class="nc" id="L1405">					cstmt.setInt(4, agtOrgId);</span>
<span class="nc" id="L1406">					logger.debug(&quot;-------CS Sale Query------\n&quot; + cstmt);</span>
<span class="nc" id="L1407">					rs = cstmt.executeQuery();</span>
<span class="nc" id="L1408">					double sale = 0.0;</span>
<span class="nc" id="L1409">					double cancel = 0.0;</span>
<span class="nc bnc" id="L1410" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L1411">						sale = sale + rs.getDouble(&quot;sale&quot;);</span>
<span class="nc" id="L1412">						cancel = cancel + rs.getDouble(&quot;cancel&quot;);</span>
<span class="nc" id="L1413">						csTotal = csTotal + sale - cancel;</span>
						/*
						 * agtMap.get(agtOrgId+&quot;&quot;).setCSSale(agtMap.get(agtOrgId+
						 * &quot;&quot;).getCSSale()+ rs.getDouble(&quot;sale&quot;));
						 * agtMap.get(agtOrgId
						 * +&quot;&quot;).setCSCancel(agtMap.get(agtOrgId
						 * +&quot;&quot;).getCSCancel()+ rs.getDouble(&quot;cancel&quot;));
						 */
					}
<span class="nc" id="L1422">				}</span>
			}

<span class="nc bnc" id="L1425" title="All 2 branches missed.">			if (ReportUtility.isOLA) {</span>
<span class="nc" id="L1426">				double olaDeposit = 0.0;</span>
<span class="nc" id="L1427">				double olaDepositRefund = 0.0;</span>
<span class="nc" id="L1428">				double olaWithdrawal = 0.0;</span>
<span class="nc" id="L1429">				double olaWithdrawalRefund = 0.0;</span>
<span class="nc" id="L1430">				double netGaming = 0.0;</span>
				/*
				 * StringBuilder wdQry = new StringBuilder(
				 * &quot;select parent_id agtOrgId,wdraw from &quot;); StringBuilder
				 * wdRefQry = new StringBuilder(
				 * &quot;select parent_id agtOrgId,wdrawRef from &quot;); StringBuilder
				 * depQry = new StringBuilder(
				 * &quot;select parent_id agtOrgId,depoAmt from &quot;); StringBuilder
				 * depRefQry = new StringBuilder(
				 * &quot;select parent_id agtOrgId,depoRefAmt from&quot;);
				 * 
				 * wdQry.append(
				 * &quot;(select parent_id,ifnull(sum(withd),0.0) wdraw from st_lms_organization_master om left outer join (select wrs.retailer_org_id, agent_net_amt as withd from st_ola_ret_withdrawl wrs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type = 'OLA_WITHDRAWL' and transaction_date&gt;='&quot;
				 * + fromDate + &quot;' and transaction_date&lt;='&quot; + endDate +
				 * &quot;'))withdRef on om.organization_id=retailer_org_id where om.organization_type='RETAILER' and om.parent_id=&quot;
				 * + agtOrgId + &quot; group by parent_id) withRef&quot;);
				 * 
				 * wdRefQry.append(
				 * &quot;(select parent_id,ifnull(sum(withd),0.0) wdrawRef from st_lms_organization_master om left outer join (select wrs.retailer_org_id, agent_net_amt as withd from st_ola_ret_withdrawl_refund wrs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type = 'OLA_WITHDRAWL_REFUND' and transaction_date&gt;='&quot;
				 * + fromDate + &quot;' and transaction_date&lt;='&quot; + endDate +
				 * &quot;'))withdRef on om.organization_id=retailer_org_id where om.organization_type='RETAILER' and om.parent_id=&quot;
				 * + agtOrgId + &quot; group by parent_id) withRef&quot;); depQry.append(
				 * &quot;(select parent_id,ifnull(sum(depo),0.0) depoAmt from st_lms_organization_master om left outer join (select wrs.retailer_org_id, agent_net_amt as depo from st_ola_ret_deposit wrs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type = 'OLA_DEPOSIT' and transaction_date&gt;='&quot;
				 * + fromDate + &quot;' and transaction_date&lt;='&quot; + endDate +
				 * &quot;'))deposit on om.organization_id=retailer_org_id where om.organization_type='RETAILER' and om.parent_id=&quot;
				 * + agtOrgId + &quot; group by parent_id) depo&quot;);
				 * 
				 * depRefQry.append(
				 * &quot;(select parent_id,ifnull(sum(depo),0.0) depoRefAmt from st_lms_organization_master om left outer join (select wrs.retailer_org_id, agent_net_amt as depo from st_ola_ret_deposit_refund wrs where transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_type = 'OLA_DEPOSIT_REFUND' and transaction_date&gt;='&quot;
				 * + fromDate + &quot;' and transaction_date&lt;='&quot; + endDate +
				 * &quot;'))depositRef on om.organization_id=retailer_org_id where om.organization_type='RETAILER' and om.parent_id=&quot;
				 * + agtOrgId + &quot; group by parent_id) depoRef&quot;);
				 * 
				 * String netGamingQry =
				 * &quot;select om.parent_id agtOrgId, ifnull(sum(netGamingAmt), 0.0) netAmt from(select wrs.retailer_org_id, agt_net_claim_comm as netGamingAmt from st_ola_ret_comm wrs inner join st_lms_retailer_transaction_master rt on wrs.transaction_id=rt.transaction_id where transaction_type = 'OLA_COMMISSION' and transaction_date&gt;='&quot;
				 * + fromDate + &quot;' and transaction_date&lt;='&quot; + endDate+
				 * &quot;') wdret right outer join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on om.organization_id = wdret.retailer_org_id where om.parent_id=&quot;
				 * +agtOrgId+&quot; group by om.parent_id&quot;; StringBuilder
				 * unionQuery=null; StringBuilder mainQuery=null;
				 * 
				 * // Withdrawal Query if(LMSFilterDispatcher.isRepFrmSP){
				 * mainQuery=new
				 * StringBuilder(&quot;select agtOrgId,sum(wdraw) wdraw from (&quot;);
				 * unionQuery=newStringBuilder(
				 * &quot; union all select parent_id agtOrgId,ifnull(sum(withdrawal_net_amt),0) as wdraw from st_rep_ola_retailer where finaldate&gt;='&quot;
				 * +
				 * fromDate+&quot;' and finaldate&lt;='&quot;+endDate+&quot;' and parent_id=&quot;+agtOrgId
				 * +&quot; ) repTable&quot;);
				 * mainQuery.append(wdQry.toString()).append(unionQuery
				 * .toString()); pstmt =
				 * con.prepareStatement(mainQuery.toString()); } else { pstmt =
				 * con.prepareStatement(wdQry.toString()); }
				 * logger.debug(&quot;-------Withdrawal Query------\n&quot; + pstmt); rs =
				 * pstmt.executeQuery(); while (rs.next()) {
				 * olaWithdrawal=olaWithdrawal+rs.getDouble(&quot;wdraw&quot;);
				 * 
				 * agentBean=agtMap.get(rs.getString(&quot;agtOrgId&quot;));
				 * if(agentBean!=null){ agtMap.get(rs.getString(&quot;agtOrgId&quot; +
				 * &quot;&quot;)).setWithdrawal( rs.getDouble(&quot;wdraw&quot;)); } }
				 */

				/*
				 * // WithDrawal Refund Query
				 * if(LMSFilterDispatcher.isRepFrmSP){ mainQuery=new
				 * StringBuilder
				 * (&quot;select agtOrgId,sum(wdrawRef) wdrawRef from (&quot;);
				 * unionQuery=newStringBuilder(
				 * &quot; union all select parent_id agtOrgId,ifnull(sum(ref_withdrawal_net_amt),0) as wdrawRef from st_rep_ola_retailer where finaldate&gt;='&quot;
				 * +
				 * fromDate+&quot;' and finaldate&lt;='&quot;+endDate+&quot;' and parent_id=&quot;+agtOrgId
				 * +&quot; ) repTable&quot;);
				 * mainQuery.append(wdRefQry.toString()).append(
				 * unionQuery.toString()); pstmt =
				 * con.prepareStatement(mainQuery.toString()); } else { pstmt =
				 * con.prepareStatement(wdRefQry.toString()); }
				 * 
				 * logger.debug(&quot;-------WithDrawal Refund Query------\n&quot; +
				 * pstmt); rs = pstmt.executeQuery(); while (rs.next()) {
				 * olaWithdrawalRefund
				 * =olaWithdrawalRefund+rs.getDouble(&quot;wdrawRef&quot;);
				 * agentBean=agtMap.get(rs.getString(&quot;agtOrgId&quot;));
				 * if(agentBean!=null){ agtMap.get(rs.getString(&quot;agtOrgId&quot; +
				 * &quot;&quot;)) .setWithdrawalRefund(rs.getDouble(&quot;wdrawRef&quot;)); } }
				 */

				/*
				 * // Deposit Query if(LMSFilterDispatcher.isRepFrmSP){
				 * mainQuery=new
				 * StringBuilder(&quot;select agtOrgId,sum(depoAmt) depoAmt from (&quot;);
				 * unionQuery=newStringBuilder(
				 * &quot; union all select parent_id agtOrgId,ifnull(sum(deposit_net),0) as depoAmt from st_rep_ola_retailer where finaldate&gt;='&quot;
				 * +
				 * fromDate+&quot;' and finaldate&lt;='&quot;+endDate+&quot;' and parent_id=&quot;+agtOrgId
				 * +&quot; ) repTable&quot;);
				 * mainQuery.append(depQry.toString()).append(unionQuery
				 * .toString()); pstmt =
				 * con.prepareStatement(mainQuery.toString()); } else { pstmt =
				 * con.prepareStatement(depQry.toString()); }
				 * logger.debug(&quot;-------Deposit Query------\n&quot; + pstmt);
				 * 
				 * rs = pstmt.executeQuery(); while (rs.next()) {
				 * olaDeposit=olaDeposit+rs.getDouble(&quot;depoAmt&quot;);
				 * agentBean=agtMap.get(rs.getString(&quot;agtOrgId&quot;));
				 * if(agentBean!=null){ agtMap.get(rs.getString(&quot;agtOrgId&quot; +
				 * &quot;&quot;)).setDeposit( rs.getDouble(&quot;depoAmt&quot;)); } }
				 */

				/*
				 * // Deposit Refund Query if(LMSFilterDispatcher.isRepFrmSP){
				 * mainQuery=new
				 * StringBuilder(&quot;select agtOrgId,sum(depoRefAmt) depoRefAmt from (&quot;
				 * ); unionQuery=newStringBuilder(
				 * &quot; union all select parent_id agtOrgId,ifnull(sum(ref_deposit_net_amt),0) as depoRefAmt from st_rep_ola_retailer where finaldate&gt;='&quot;
				 * +
				 * fromDate+&quot;' and finaldate&lt;='&quot;+endDate+&quot;' and parent_id=&quot;+agtOrgId
				 * +&quot; ) repTable&quot;);
				 * mainQuery.append(depRefQry.toString()).append
				 * (unionQuery.toString()); pstmt =
				 * con.prepareStatement(mainQuery.toString()); } else { pstmt =
				 * con.prepareStatement(depRefQry.toString()); }
				 * logger.debug(&quot;-------Deposit Refund Query------\n&quot; + pstmt);
				 */

				/*
				 * rs = pstmt.executeQuery(); while (rs.next()) {
				 * olaDepositRefund=olaDepositRefund+rs.getDouble(&quot;depoRefAmt&quot;);
				 * 
				 * agentBean=agtMap.get(rs.getString(&quot;agtOrgId&quot;));
				 * if(agentBean!=null){ agtMap.get(rs.getString(&quot;agtOrgId&quot; +
				 * &quot;&quot;)).setDepositRefund( rs.getDouble(&quot;depoRefAmt&quot;)); } }
				 */

				/*
				 * // net gaming commission query
				 * if(LMSFilterDispatcher.isRepFrmSP){ mainQuery=new
				 * StringBuilder(&quot;select agtOrgId,sum(netAmt) netAmt from (&quot;);
				 * unionQuery=newStringBuilder(
				 * &quot; union all select parent_id agtOrgId,ifnull(sum(net_gaming_net_comm),0) as netAmt from st_rep_ola_retailer where finaldate&gt;='&quot;
				 * +
				 * fromDate+&quot;' and finaldate&lt;='&quot;+endDate+&quot;' and parent_id=&quot;+agtOrgId
				 * +&quot; ) repTable&quot;);
				 * mainQuery.append(netGamingQry).append(unionQuery.toString());
				 * pstmt = con.prepareStatement(mainQuery.toString()); } else {
				 * pstmt = con.prepareStatement(netGamingQry.toString()); }
				 */

				/*
				 * logger.debug(&quot;-------Net Gaming Query------\n&quot; + pstmt); rs =
				 * pstmt.executeQuery(); while (rs.next()) {
				 * netGaming=netGaming+rs.getDouble(&quot;netAmt&quot;);
				 * 
				 * agentBean=agtMap.get(rs.getString(&quot;agtOrgId&quot;));
				 * if(agentBean!=null){ agtMap.get(rs.getString(&quot;agtOrgId&quot; +
				 * &quot;&quot;)).setNetGamingComm( rs.getDouble(&quot;netAmt&quot;)); } }
				 */
<span class="nc" id="L1585">				OlaOrgReportRequestBean requestBean = new OlaOrgReportRequestBean();</span>
<span class="nc" id="L1586">				requestBean.setFromDate(fromDate.toString());</span>
<span class="nc" id="L1587">				requestBean.setToDate(endDate.toString());</span>
<span class="nc" id="L1588">				requestBean.setOrgId(agtOrgId);</span>
<span class="nc" id="L1589">				OlaOrgReportResponseBean responseBean = OlaAgentReportControllerImpl</span>
						.fetchDepositWithdrawlSinglaAgent(requestBean, con);
<span class="nc" id="L1591">				String netGamingQry = &quot;select om.parent_id agtOrgId, ifnull(sum(netGamingAmt), 0.0) netAmt from(select wrs.retailer_org_id, agt_net_claim_comm as netGamingAmt from st_ola_ret_comm wrs inner join st_lms_retailer_transaction_master rt on wrs.transaction_id=rt.transaction_id where transaction_type = 'OLA_COMMISSION' and transaction_date&gt;='&quot;+ startDate + &quot;' and transaction_date&lt;='&quot;	+ endDate+ &quot;') wdret right outer join (select organization_id, parent_id from st_lms_organization_master where organization_type = 'RETAILER')om on om.organization_id = wdret.retailer_org_id where om.parent_id=&quot;+agtOrgId+&quot; group by om.parent_id&quot;;</span>
				
				
				// net gaming commission query
<span class="nc" id="L1595">				pstmt = con.prepareStatement(netGamingQry);</span>
<span class="nc" id="L1596">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L1597" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L1598">					netGaming=netGaming+rs.getDouble(&quot;netAmt&quot;);</span>
				}
				
				
				
<span class="nc" id="L1603">				olaTotal = responseBean.getNetDepositAmt()</span>
						- responseBean.getNetWithdrawalAmt() - netGaming;
			}

<span class="nc bnc" id="L1607" title="All 2 branches missed.">			if (ReportUtility.isSLE) {</span>
<span class="nc" id="L1608">				SLEOrgReportRequestBean requestBean = new SLEOrgReportRequestBean();</span>
<span class="nc" id="L1609">				requestBean.setFromDate(fromDate);</span>
<span class="nc" id="L1610">				requestBean.setToDate(endDate);</span>
<span class="nc" id="L1611">				requestBean.setOrgId(agtOrgId);</span>
<span class="nc" id="L1612">				SLEOrgReportResponseBean responseBean = SLEAgentReportsControllerImpl.fetchSaleCancelPWTSingleAgentAllGame(requestBean, con);</span>

<span class="nc" id="L1614">				sleTotal = responseBean.getSaleAmt() - responseBean.getCancelAmt() - responseBean.getPwtAmt() - responseBean.getPwtDirAmt();</span>
			}
			
<span class="nc bnc" id="L1617" title="All 2 branches missed.">			if (ReportUtility.isIW) {</span>
<span class="nc" id="L1618">				IWOrgReportRequestBean requestBean = new IWOrgReportRequestBean();</span>
<span class="nc" id="L1619">				requestBean.setFromDate(fromDate);</span>
<span class="nc" id="L1620">				requestBean.setToDate(endDate);</span>
<span class="nc" id="L1621">				requestBean.setOrgId(agtOrgId);</span>
<span class="nc" id="L1622">				IWOrgReportResponseBean responseBean = IWAgentReportsControllerImpl.fetchSaleCancelPWTSingleAgentAllGame(requestBean, con);</span>

<span class="nc" id="L1624">				iwTotal = responseBean.getSaleAmt() - responseBean.getCancelAmt() - responseBean.getPwtAmt() - responseBean.getPwtDirAmt();</span>
			}
			
<span class="nc bnc" id="L1627" title="All 2 branches missed.">			if (ReportUtility.isVS) {</span>
<span class="nc" id="L1628">				VSOrgReportRequestBean requestBean = new VSOrgReportRequestBean();</span>
<span class="nc" id="L1629">				requestBean.setFromDate(fromDate);</span>
<span class="nc" id="L1630">				requestBean.setToDate(endDate);</span>
<span class="nc" id="L1631">				requestBean.setOrgId(agtOrgId);</span>
<span class="nc" id="L1632">				VSOrgReportResponseBean responseBean = VSAgentReportsControllerImpl.fetchSaleCancelPWTSingleAgentAllGame(requestBean, con);</span>

<span class="nc" id="L1634">				vsTotal = responseBean.getSaleAmt() - responseBean.getCancelAmt() - responseBean.getPwtAmt() - responseBean.getPwtDirAmt();</span>
			}

<span class="nc" id="L1637">			RetOpenBal = RetOpenBal + drawTotal + scratchTotal + csTotal</span>
					+ olaTotal + sleTotal + iwTotal - recTotal + vsTotal;
<span class="nc" id="L1639">		} catch (Exception e) {</span>
<span class="nc" id="L1640">			e.printStackTrace();</span>
<span class="nc" id="L1641">			throw new LMSException(&quot;Error in report collectionAgentWise&quot;);</span>
<span class="nc" id="L1642">		}</span>
<span class="nc" id="L1643">		return RetOpenBal;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>