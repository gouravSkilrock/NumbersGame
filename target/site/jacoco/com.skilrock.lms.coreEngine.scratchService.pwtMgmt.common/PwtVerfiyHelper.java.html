<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PwtVerfiyHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lms</a> &gt; <a href="index.source.html" class="el_package">com.skilrock.lms.coreEngine.scratchService.pwtMgmt.common</a> &gt; <span class="el_source">PwtVerfiyHelper.java</span></div><h1>PwtVerfiyHelper.java</h1><pre class="source lang-java linenums">package com.skilrock.lms.coreEngine.scratchService.pwtMgmt.common;

import java.sql.Connection;
import java.sql.Date;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.sql.Timestamp;
import java.text.DateFormat;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Set;

import javax.servlet.ServletContext;

import org.apache.struts2.ServletActionContext;

import com.skilrock.lms.beans.ActiveGameBean;
import com.skilrock.lms.beans.OrgBean;
import com.skilrock.lms.beans.PwtBean;
import com.skilrock.lms.beans.TicketBean;
import com.skilrock.lms.beans.TmpPwtReceiptBean;
import com.skilrock.lms.beans.TmpReceiptDetailBean;
import com.skilrock.lms.common.db.DBConnect;
import com.skilrock.lms.common.db.QueryManager;
import com.skilrock.lms.common.db.TableConstants;
import com.skilrock.lms.common.exception.LMSException;
import com.skilrock.lms.common.utility.CommonMethods;
import com.skilrock.lms.common.utility.GameUtilityHelper;
import com.skilrock.lms.common.utility.GenerateRecieptNo;
import com.skilrock.lms.common.utility.OrgCreditUpdation;
import com.skilrock.lms.coreEngine.reportsMgmt.common.GraphReportHelper;

<span class="nc" id="L41">public class PwtVerfiyHelper {</span>

<span class="nc" id="L43">	private static final DateFormat utilDateFormatter = new SimpleDateFormat(</span>
			&quot;dd-MM-yyyy&quot;);

	List&lt;ActiveGameBean&gt; activeGameList;

	// copied from pwt bo helper
<span class="nc" id="L49">	String receiptNum = null;</span>

	// StringBuilder virn = null;
<span class="nc" id="L52">	Map virnMap = null;</span>

	private Date add(Date date, int value) {

<span class="nc" id="L56">		Date newDate = null;</span>
		try {
<span class="nc" id="L58">			java.util.Date utilDate = (java.util.Date) utilDateFormatter</span>
					.parse(utilDateFormatter.format(date));
<span class="nc" id="L60">			Calendar cal = Calendar.getInstance();</span>
<span class="nc" id="L61">			cal.setTime(utilDate);</span>
<span class="nc" id="L62">			cal.add(Calendar.DAY_OF_MONTH, 1);</span>
<span class="nc" id="L63">			newDate = new Date(cal.getTime().getTime());</span>
<span class="nc" id="L64">		} catch (ParseException e) {</span>
<span class="nc" id="L65">			e.printStackTrace();</span>
<span class="nc" id="L66">		}</span>
<span class="nc" id="L67">		System.out.println(&quot;Date after addition Date : &quot; + newDate);</span>
<span class="nc" id="L68">		return newDate;</span>
	}

	public OrgBean agentOrgName(String receiptNum) {

<span class="nc" id="L73">		OrgBean agentOrgBean = null;</span>
<span class="nc" id="L74">		Connection connection = null;</span>
<span class="nc" id="L75">		Statement statement = null;</span>
<span class="nc" id="L76">		ResultSet resultSet = null;</span>
		try {

			 
<span class="nc" id="L80">			connection = DBConnect.getConnection();</span>
<span class="nc" id="L81">			statement = connection.createStatement();</span>

<span class="nc" id="L83">			String query = &quot;select so.organization_id,so.name,su.user_id from st_lms_organization_master so,st_lms_user_master su where so.organization_id = su.organization_id and  so.organization_id=(select agent_org_id from st_se_tmp_pwt_receipt where receipt_id='&quot;</span>
					+ receiptNum + &quot;')&quot;;

<span class="nc" id="L86">			resultSet = statement.executeQuery(query);</span>

<span class="nc bnc" id="L88" title="All 2 branches missed.">			while (resultSet.next()) {</span>

<span class="nc" id="L90">				agentOrgBean = new OrgBean();</span>
<span class="nc" id="L91">				agentOrgBean.setOrgId(resultSet</span>
						.getInt(TableConstants.SOM_ORG_ID));
<span class="nc" id="L93">				agentOrgBean.setOrgName(resultSet</span>
						.getString(TableConstants.SOM_ORG_NAME));
<span class="nc" id="L95">				agentOrgBean.setUserId(resultSet</span>
						.getInt(TableConstants.SUM_USER_ID));

			}

<span class="nc" id="L100">			System.out.println(&quot;** &quot; + query);</span>

<span class="nc" id="L102">			return agentOrgBean;</span>
<span class="nc" id="L103">		} catch (SQLException e) {</span>
<span class="nc" id="L104">			System.out.println(&quot;In Generate Receipt Exception &quot; + e);</span>
<span class="nc" id="L105">			e.printStackTrace();</span>
		} finally {

<span class="nc" id="L108">			try {</span>

<span class="nc bnc" id="L110" title="All 6 branches missed.">				if (statement != null) {</span>
<span class="nc" id="L111">					statement.close();</span>
				}
<span class="nc bnc" id="L113" title="All 6 branches missed.">				if (connection != null) {</span>
<span class="nc" id="L114">					connection.close();</span>
				}
<span class="nc" id="L116">			} catch (SQLException se) {</span>
<span class="nc" id="L117">				se.printStackTrace();</span>
<span class="nc" id="L118">			}</span>

<span class="nc" id="L120">		}</span>
<span class="nc" id="L121">		return null;</span>

	}

	public void closeReceipt(String receiptNum, int userId, int userOrgID,
			List verifiedData, List&lt;ActiveGameBean&gt; activeGameList,
			Connection connection, String channel, String interfaceType) {
<span class="nc" id="L128">		System.out.println(&quot;inside close receipttssssssssssssssssssss &quot;);</span>
		// Connection connection = null;
<span class="nc" id="L130">		Statement statement = null;</span>
<span class="nc" id="L131">		String game_nbr = null;</span>
<span class="nc" id="L132">		ActiveGameBean activeGameBean = null;</span>
<span class="nc" id="L133">		String insertPwtTktQry = null;</span>
<span class="nc" id="L134">		String updPwtTktQry = null;</span>
<span class="nc" id="L135">		String tktNbrStr = null;</span>
<span class="nc" id="L136">		int game_id = 0;</span>
		try {

			//  
			// connection = DBConnect.getConnection();
<span class="nc" id="L141">			statement = connection.createStatement();</span>

<span class="nc" id="L143">			String tmpTicketUpdateQuery = &quot;update st_se_tmp_pwt_tickets_inv set status='CLOSE',final_receipt_num='NO RECEIPT' where receipt_id='&quot;</span>
					+ receiptNum + &quot;' and final_receipt_num is null&quot;;
<span class="nc" id="L145">			String tmpReceiptUpdateQuery = &quot;update st_se_tmp_pwt_receipt set status='CLOSE' where receipt_id='&quot;</span>
					+ receiptNum + &quot;'&quot;;

<span class="nc" id="L148">			statement.executeUpdate(tmpTicketUpdateQuery);</span>
<span class="nc" id="L149">			statement.executeUpdate(tmpReceiptUpdateQuery);</span>
<span class="nc" id="L150">			tktNbrStr = ((List) verifiedData.get(0)).toString().replace(&quot;[&quot;,</span>
					&quot;'&quot;).replace(&quot;]&quot;, &quot;'&quot;).replaceAll(&quot;,&quot;, &quot;','&quot;).replaceAll(
					&quot; &quot;, &quot;&quot;);
			/*
			 * if (activeGameList != null) { for (int i = 0; i &lt;
			 * activeGameList.size(); i++) { activeGameBean =
			 * activeGameList.get(i); if (game_id==activeGameBean.getGameId()) {
			 * game_nbr=activeGameBean.getGameNbr_Name().split(&quot;-&quot;)[0]; break; } } }
			 */
<span class="nc" id="L159">			Map gameTickNum = (Map) verifiedData.get(2);</span>
<span class="nc" id="L160">			Iterator itTkt = gameTickNum.entrySet().iterator();</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">			while (itTkt.hasNext()) {</span>
<span class="nc" id="L162">				Map.Entry pairsTkt = (Map.Entry) itTkt.next();</span>
<span class="nc" id="L163">				game_id = (Integer) pairsTkt.getKey();</span>
<span class="nc" id="L164">				System.out.println(&quot;Tkt Map--game_id&quot; + game_id);</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">				if (activeGameList != null) {</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">					for (int i = 0; i &lt; activeGameList.size(); i++) {</span>
<span class="nc" id="L167">						activeGameBean = activeGameList.get(i);</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">						if (game_id == activeGameBean.getGameId()) {</span>
<span class="nc" id="L169">							game_nbr = activeGameBean.getGameNbr_Name().split(</span>
									&quot;-&quot;)[0];
<span class="nc" id="L171">							break;</span>
						}
					}
				}
<span class="nc" id="L175">				updPwtTktQry = &quot;update st_se_pwt_tickets_inv_&quot;</span>
						+ game_nbr
						+ &quot; aa,  st_se_tmp_pwt_tickets_inv bb set aa.status='CLAIM_AGT', aa.verify_by_user='&quot;
						+ userId
						+ &quot;', aa.verify_by_org='&quot;
						+ userOrgID
						+ &quot;'  where aa.status='CLAIM_RET' and aa.ticket_nbr in (&quot;
						+ tktNbrStr + &quot;) and aa.ticket_nbr = bb.ticket_nbr&quot;;
<span class="nc" id="L183">				System.out.println(&quot;********PWT Update********&quot; + updPwtTktQry);</span>
<span class="nc" id="L184">				statement.executeUpdate(updPwtTktQry);</span>
				// &quot;insert into st_se_pwt_tickets_inv_&quot;+game_nbr+&quot; select
				// ticket_nbr,game_id,book_nbr,'CLAIM_AGT' as status
				// ,'&quot;+userId+&quot;' as verify_by_user,'&quot;+userOrgID+&quot;' as
				// 'verify_by_org from st_se_tmp_pwt_tickets_inv where
				// receipt_id='&quot;+receiptNum+&quot;' and final_receipt_num='NO
				// RECEIPT' and game_id=&quot;+game_id+&quot; and ticket_nbr in
				// (&quot;+tktNbrStr+&quot;)&quot;;

				// insertPwtTktQry =&quot;insert into
				// st_se_pwt_tickets_inv_&quot;+game_nbr+&quot; select bb.ticket_nbr,
				// bb.game_id, bb.book_nbr,'CLAIM_AGT' as status ,'&quot;+userId+&quot;'
				// as verify_by_user,'&quot;+userOrgID+&quot;' as verify_by_org from
				// st_se_tmp_pwt_tickets_inv bb where
				// bb.receipt_id='&quot;+receiptNum+&quot;' and bb.final_receipt_num='NO
				// RECEIPT' and bb.game_id=&quot;+game_id+&quot; and bb.ticket_nbr in
				// (&quot;+tktNbrStr+&quot;) and bb.ticket_nbr not in (select ticket_nbr
				// from st_se_pwt_tickets_inv_&quot;+game_nbr+&quot;)&quot;;
<span class="nc" id="L202">				insertPwtTktQry = &quot;insert into st_se_pwt_tickets_inv_&quot;</span>
						+ game_nbr
						+ &quot; select bb.ticket_nbr, bb.game_id, bb.book_nbr,'CLAIM_AGT' as status ,'&quot;
						+ userId
						+ &quot;' as verify_by_user,'&quot;
						+ userOrgID
						+ &quot;' as verify_by_org,'&quot;
						+ channel
						+ &quot;','&quot;
						+ interfaceType
						+ &quot;',stpr.agent_org_id,stpr.date_entered from st_se_tmp_pwt_tickets_inv bb ,st_se_tmp_pwt_receipt stpr where bb.receipt_id='&quot;
						+ receiptNum
						+ &quot;' and bb.game_id=&quot;
						+ game_id
						+ &quot; and bb.receipt_id=stpr.receipt_id and bb.ticket_nbr in (&quot;
						+ tktNbrStr
						+ &quot;) and bb.ticket_nbr not in (select ticket_nbr from st_se_pwt_tickets_inv_&quot;
						+ game_nbr + &quot;)&quot;;

<span class="nc" id="L221">				System.out.println(&quot;********PWT Insert********&quot;</span>
						+ insertPwtTktQry);
<span class="nc" id="L223">				statement.executeUpdate(insertPwtTktQry);</span>
				;
<span class="nc" id="L225">			}</span>

<span class="nc" id="L227">		} catch (SQLException e) {</span>
<span class="nc" id="L228">			System.out.println(&quot;In Generate Receipt Exception &quot; + e);</span>
<span class="nc" id="L229">			e.printStackTrace();</span>
		} finally {

<span class="nc" id="L232">			try {</span>

<span class="nc bnc" id="L234" title="All 6 branches missed.">				if (statement != null) {</span>
<span class="nc" id="L235">					statement.close();</span>
				}
				/*
				 * if (connection != null) { connection.close(); }
				 */
<span class="nc" id="L240">			} catch (SQLException se) {</span>
<span class="nc" id="L241">				se.printStackTrace();</span>
<span class="nc" id="L242">			}</span>

<span class="nc" id="L244">		}</span>

<span class="nc" id="L246">	}</span>

	public int fetchOrgId(String orgName, Connection con) throws SQLException {

<span class="nc" id="L250">		Statement stmt = con.createStatement();</span>
<span class="nc" id="L251">		ResultSet rs = stmt</span>
				.executeQuery(&quot;select organization_id from st_lms_organization_master where name = '&quot;
						+ orgName + &quot;'&quot;);
<span class="nc" id="L254">		int orgId = 0;</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">		if (rs.next()) {</span>
<span class="nc" id="L256">			orgId = rs.getInt(&quot;organization_id&quot;);</span>
		}
<span class="nc" id="L258">		return orgId;</span>
	}

	public List generateReceipt(String receiptNum) {
		// List&lt;TicketBean&gt; VerifyTicketList = new ArrayList&lt;TicketBean&gt;();

<span class="nc" id="L264">		Map gameTickNum = new HashMap();</span>
<span class="nc" id="L265">		Map gameVirnCode = new HashMap();</span>
<span class="nc" id="L266">		List verifiedData = new ArrayList();</span>
<span class="nc" id="L267">		List tickNumberList = new ArrayList();</span>

<span class="nc" id="L269">		PwtTicketHelper pwtTicketHelper = new PwtTicketHelper();</span>

<span class="nc" id="L271">		Connection connection = null;</span>
<span class="nc" id="L272">		Statement statement = null;</span>
<span class="nc" id="L273">		Statement statementTick = null;</span>
<span class="nc" id="L274">		ResultSet resultSet = null;</span>
<span class="nc" id="L275">		ResultSet resultSetTick = null;</span>
<span class="nc" id="L276">		TicketBean ticketBean = null;</span>
<span class="nc" id="L277">		int game_id = 0;</span>

		try {
<span class="nc" id="L280">			System.out.println(&quot;inside try............&quot;);</span>

			 
<span class="nc" id="L283">			connection = DBConnect.getConnection();</span>
<span class="nc" id="L284">			connection.setAutoCommit(false);</span>
<span class="nc" id="L285">			statement = connection.createStatement();</span>
<span class="nc" id="L286">			statementTick = connection.createStatement();</span>

<span class="nc" id="L288">			String query = &quot;select distinct(game_id) from st_se_tmp_pwt_tickets_inv where receipt_id='&quot;</span>
					+ receiptNum + &quot;'&quot;;
<span class="nc" id="L290">			String getTicketListQuery = &quot;select ticket_nbr from st_se_tmp_pwt_tickets_inv where receipt_id='&quot;</span>
					+ receiptNum + &quot;' and status='OPEN' and game_id=&quot;;
<span class="nc" id="L292">			resultSet = statement.executeQuery(query);</span>

<span class="nc bnc" id="L294" title="All 2 branches missed.">			while (resultSet.next()) {</span>
<span class="nc" id="L295">				game_id = Integer.parseInt(resultSet.getString(&quot;game_id&quot;));</span>
<span class="nc" id="L296">				resultSetTick = statementTick.executeQuery(getTicketListQuery</span>
						+ game_id);
<span class="nc" id="L298">				List&lt;TicketBean&gt; ticketList = new ArrayList&lt;TicketBean&gt;();</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">				while (resultSetTick.next()) {</span>
<span class="nc" id="L300">					ticketBean = new TicketBean();</span>
<span class="nc" id="L301">					ticketBean.setTicketNumber(resultSetTick</span>
							.getString(&quot;ticket_nbr&quot;));
<span class="nc" id="L303">					tickNumberList.add(resultSetTick.getString(&quot;ticket_nbr&quot;));</span>
<span class="nc" id="L304">					ticketList.add(ticketBean);</span>
				}
<span class="nc" id="L306">				gameTickNum.put(game_id, ticketList);</span>
<span class="nc" id="L307">			}</span>
<span class="nc" id="L308">			System.out.println(&quot;Ticket Map--&quot; + gameTickNum);</span>

<span class="nc" id="L310">			query = &quot;select distinct(game_id) from st_se_tmp_pwt_inv where receipt_id='&quot;</span>
					+ receiptNum + &quot;'&quot;;
<span class="nc" id="L312">			getTicketListQuery = &quot;select virn_code from st_se_tmp_pwt_inv where receipt_id='&quot;</span>
					+ receiptNum + &quot;' and status='OPEN' and game_id=&quot;;
<span class="nc" id="L314">			resultSet = statement.executeQuery(query);</span>

<span class="nc bnc" id="L316" title="All 2 branches missed.">			while (resultSet.next()) {</span>
<span class="nc" id="L317">				game_id = Integer.parseInt(resultSet.getString(&quot;game_id&quot;));</span>
<span class="nc" id="L318">				resultSetTick = statementTick.executeQuery(getTicketListQuery</span>
						+ game_id);
<span class="nc" id="L320">				List virnList = new ArrayList();</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">				while (resultSetTick.next()) {</span>
<span class="nc" id="L322">					virnList.add(resultSetTick.getString(&quot;virn_code&quot;));</span>
				}
<span class="nc" id="L324">				gameVirnCode.put(game_id, virnList);</span>
<span class="nc" id="L325">			}</span>

<span class="nc" id="L327">			System.out.println(&quot;VIRN Map--&quot; + gameVirnCode);</span>

<span class="nc" id="L329">			verifiedData.add(tickNumberList);</span>
<span class="nc" id="L330">			verifiedData.add(gameVirnCode);</span>
<span class="nc" id="L331">			verifiedData.add(gameTickNum);</span>
<span class="nc" id="L332">			connection.commit();</span>
<span class="nc" id="L333">			return verifiedData;</span>
<span class="nc" id="L334">		} catch (SQLException e) {</span>
<span class="nc" id="L335">			System.out.println(&quot;In Generate Receipt Exception &quot; + e);</span>
<span class="nc" id="L336">			e.printStackTrace();</span>
		} finally {

<span class="nc" id="L339">			try {</span>

<span class="nc bnc" id="L341" title="All 6 branches missed.">				if (statement != null) {</span>
<span class="nc" id="L342">					statement.close();</span>
				}
<span class="nc bnc" id="L344" title="All 6 branches missed.">				if (connection != null) {</span>
<span class="nc" id="L345">					connection.close();</span>
				}
<span class="nc" id="L347">			} catch (SQLException se) {</span>
<span class="nc" id="L348">				se.printStackTrace();</span>
<span class="nc" id="L349">			}</span>

<span class="nc" id="L351">		}</span>
<span class="nc" id="L352">		return null;</span>

	}

	public List&lt;ActiveGameBean&gt; getActiveGameList() {
<span class="nc" id="L357">		return activeGameList;</span>
	}

	private String getEncodedVirnCodeTmpReceipt(String[] virnCode) {

<span class="nc" id="L362">		StringBuffer encodedVirnCode = new StringBuffer(&quot;&quot;);</span>

<span class="nc bnc" id="L364" title="All 2 branches missed.">		for (String element : virnCode) {</span>

<span class="nc" id="L366">			encodedVirnCode.append(&quot;'&quot;);</span>
<span class="nc" id="L367">			encodedVirnCode.append(element);</span>
<span class="nc" id="L368">			encodedVirnCode.append(&quot;'&quot;);</span>
<span class="nc" id="L369">			encodedVirnCode.append(&quot;,&quot;);</span>

		}
<span class="nc" id="L372">		int length = encodedVirnCode.length();</span>
<span class="nc" id="L373">		encodedVirnCode.deleteCharAt(length - 1);</span>

<span class="nc" id="L375">		return encodedVirnCode.toString();</span>
	}

	public String getReceiptNum() {
<span class="nc" id="L379">		return receiptNum;</span>
	}

	public String getTmpReceiptId(Map gameNumMap, String agtOrgName,
			String boOrgName, int userOrgID, String root_path) {

<span class="nc" id="L385">		Connection connection = null;</span>
<span class="nc" id="L386">		Statement statement = null;</span>
<span class="nc" id="L387">		ResultSet resultSet = null;</span>
<span class="nc" id="L388">		PreparedStatement tmpPwtInsert = null;</span>

		try {
<span class="nc" id="L391">			System.out.println(&quot;inside try............&quot;);</span>
<span class="nc" id="L392">			int agentOrgId = 0;</span>
<span class="nc" id="L393">			String receiptId = null;</span>
<span class="nc" id="L394">			int gameId = 0;</span>

			 
<span class="nc" id="L397">			connection = DBConnect.getConnection();</span>
<span class="nc" id="L398">			connection.setAutoCommit(false);</span>
<span class="nc" id="L399">			statement = connection.createStatement();</span>

<span class="nc" id="L401">			PreparedStatement autoGenRecptPstmtBO = null;</span>
<span class="nc" id="L402">			String getLatestRecieptNumberBO = &quot;SELECT * from st_se_tmp_pwt_receipt ORDER BY receipt_id DESC LIMIT 1&quot;;</span>
<span class="nc" id="L403">			autoGenRecptPstmtBO = connection</span>
					.prepareStatement(getLatestRecieptNumberBO);
<span class="nc" id="L405">			ResultSet recieptRsBO = autoGenRecptPstmtBO.executeQuery();</span>
<span class="nc" id="L406">			String lastRecieptNoGeneratedBO = null;</span>

<span class="nc bnc" id="L408" title="All 2 branches missed.">			while (recieptRsBO.next()) {</span>
<span class="nc" id="L409">				lastRecieptNoGeneratedBO = recieptRsBO.getString(&quot;receipt_id&quot;);</span>
			}

<span class="nc" id="L412">			String autoGeneRecieptNoBO = GenerateRecieptNo.getRecieptNo(</span>
					&quot;TPWTRECEIPT&quot;, lastRecieptNoGeneratedBO, &quot;BO&quot;);

<span class="nc" id="L415">			String getAgentIdQuery = &quot;select organization_id from st_lms_organization_master where name='&quot;</span>
					+ agtOrgName + &quot;'&quot;;
<span class="nc" id="L417">			String getGameIdQuery = &quot;select game_id from st_se_game_master where game_nbr=&quot;;</span>

<span class="nc" id="L419">			String tmpPwtInsertquery = &quot;insert into st_se_tmp_pwt_receipt(receipt_id,agent_org_id,status,date_entered) values (?,?,?,?)&quot;;</span>
<span class="nc" id="L420">			String tmpPwtDetailInsertquery = &quot;insert into st_se_tmp_pwt_receipt_detail values &quot;;</span>

<span class="nc" id="L422">			resultSet = statement.executeQuery(getAgentIdQuery);</span>
<span class="nc bnc" id="L423" title="All 2 branches missed.">			while (resultSet.next()) {</span>
<span class="nc" id="L424">				agentOrgId = resultSet.getInt(&quot;organization_id&quot;);</span>
			}
<span class="nc" id="L426">			Timestamp dateEntered = new Timestamp(new java.util.Date()</span>
					.getTime());
<span class="nc" id="L428">			System.out.println(&quot;777777777777777 b  &quot; + dateEntered);</span>
<span class="nc" id="L429">			tmpPwtInsert = connection.prepareStatement(tmpPwtInsertquery);</span>
<span class="nc" id="L430">			tmpPwtInsert.setString(1, autoGeneRecieptNoBO);</span>
<span class="nc" id="L431">			tmpPwtInsert.setInt(2, agentOrgId);</span>
<span class="nc" id="L432">			tmpPwtInsert.setString(3, &quot;OPEN&quot;);</span>
<span class="nc" id="L433">			tmpPwtInsert.setTimestamp(4, dateEntered);</span>
			// tmpPwtInsertquery =
			// tmpPwtInsertquery+&quot;('&quot;+autoGeneRecieptNoBO+&quot;',&quot;+agentOrgId+&quot;,'OPEN','&quot;+new
			// Timestamp(new java.util.Date().getTime())+&quot;')&quot;;
<span class="nc" id="L437">			System.out.println(lastRecieptNoGeneratedBO + &quot;--&quot;</span>
					+ autoGeneRecieptNoBO + &quot;--insert Query--&quot;
					+ tmpPwtInsertquery);
			// statement.executeUpdate(tmpPwtInsertquery);
<span class="nc" id="L441">			tmpPwtInsert.executeUpdate();</span>
<span class="nc" id="L442">			receiptId = autoGeneRecieptNoBO;</span>

<span class="nc" id="L444">			StringBuilder valuesData = new StringBuilder();</span>
<span class="nc" id="L445">			Iterator gameNumItr = gameNumMap.entrySet().iterator();</span>

<span class="nc bnc" id="L447" title="All 2 branches missed.">			while (gameNumItr.hasNext()) {</span>
<span class="nc" id="L448">				Map.Entry gameNumpair = (Map.Entry) gameNumItr.next();</span>

<span class="nc" id="L450">				Map przMap = (HashMap) gameNumpair.getValue();</span>

<span class="nc bnc" id="L452" title="All 2 branches missed.">				if (!przMap.isEmpty()) {</span>
<span class="nc" id="L453">					resultSet = statement.executeQuery(getGameIdQuery</span>
							+ gameNumpair.getKey());

<span class="nc bnc" id="L456" title="All 2 branches missed.">					while (resultSet.next()) {</span>
<span class="nc" id="L457">						gameId = resultSet.getInt(&quot;game_id&quot;);</span>
					}

<span class="nc" id="L460">					Iterator it = przMap.entrySet().iterator();</span>
<span class="nc bnc" id="L461" title="All 2 branches missed.">					while (it.hasNext()) {</span>
<span class="nc" id="L462">						Map.Entry pairs = (Map.Entry) it.next();</span>
<span class="nc" id="L463">						String przAmtData = pairs.getValue() + &quot;,&quot;</span>
								+ pairs.getKey();
<span class="nc" id="L465">						valuesData.append(&quot;('&quot; + receiptId + &quot;',&quot; + gameId</span>
								+ &quot;,&quot; + przAmtData + &quot;),&quot;);
<span class="nc" id="L467">					}</span>
				}

<span class="nc" id="L470">			}</span>

<span class="nc" id="L472">			statement = connection.createStatement();</span>
<span class="nc" id="L473">			statement.executeUpdate(tmpPwtDetailInsertquery</span>
					+ valuesData.substring(0, valuesData.length() - 1));

<span class="nc" id="L476">			connection.commit();</span>

<span class="nc" id="L478">			GraphReportHelper reportHelper = new GraphReportHelper();</span>
<span class="nc" id="L479">			reportHelper.generateTempPWTReceipt(receiptId, boOrgName,</span>
					userOrgID, root_path, agentOrgId);

<span class="nc" id="L482">			return receiptId + &quot;&quot;;</span>

<span class="nc" id="L484">		} catch (SQLException e) {</span>
<span class="nc" id="L485">			System.out.println(&quot;In PwtVerifyHelper Exception &quot; + e);</span>
<span class="nc" id="L486">			e.printStackTrace();</span>
			try {
<span class="nc" id="L488">				connection.rollback();</span>
<span class="nc" id="L489">			} catch (SQLException e1) {</span>
				// TODO Auto-generated catch block
<span class="nc" id="L491">				e1.printStackTrace();</span>
<span class="nc" id="L492">			}</span>
		} finally {

<span class="nc" id="L495">			try {</span>

<span class="nc bnc" id="L497" title="All 6 branches missed.">				if (statement != null) {</span>
<span class="nc" id="L498">					statement.close();</span>
				}
<span class="nc bnc" id="L500" title="All 6 branches missed.">				if (connection != null) {</span>
<span class="nc" id="L501">					connection.close();</span>
				}
<span class="nc" id="L503">			} catch (SQLException se) {</span>
<span class="nc" id="L504">				se.printStackTrace();</span>
<span class="nc" id="L505">			}</span>

<span class="nc" id="L507">		}</span>
<span class="nc" id="L508">		return null;</span>
	}

	private String getWhereClause(String agtOrgName, String receiptNum,
			String fromDate, String toDate, String status, String pwtGen)
			throws ParseException {
<span class="nc" id="L514">		StringBuilder whereClause = new StringBuilder();</span>
<span class="nc bnc" id="L515" title="All 6 branches missed.">		if (receiptNum != null &amp; !receiptNum.equals(&quot;&quot;)) {</span>
<span class="nc bnc" id="L516" title="All 2 branches missed.">			if (pwtGen.equals(&quot;pwtRcptGen&quot;)) {</span>
<span class="nc" id="L517">				whereClause.append(&quot;searchResult.receipt_id='&quot; + receiptNum</span>
						+ &quot;' and &quot;);
			} else {
<span class="nc" id="L520">				whereClause.append(&quot;receipt_id='&quot; + receiptNum + &quot;' and &quot;);</span>
			}
		}
<span class="nc bnc" id="L523" title="All 6 branches missed.">		if (agtOrgName != null &amp; !agtOrgName.equals(&quot;-1&quot;)) {</span>
<span class="nc" id="L524">			whereClause</span>
					.append(&quot;agent_org_id=(select organization_id from st_lms_organization_master where name='&quot;
							+ agtOrgName + &quot;') and &quot;);
		}
<span class="nc bnc" id="L528" title="All 6 branches missed.">		if (fromDate != null &amp; !fromDate.equals(&quot;&quot;)) {</span>
<span class="nc" id="L529">			whereClause.append(&quot;date_entered between '&quot; + fromDate + &quot;' and &quot;);</span>
		} else {
			try {
<span class="nc" id="L532">				whereClause.append(&quot;date_entered between '&quot;</span>
						+ new Timestamp((new SimpleDateFormat(&quot;yyyy-MM-dd&quot;))
								.parse(&quot;1900-01-01&quot;).getTime()) + &quot;' and &quot;);
<span class="nc" id="L535">			} catch (ParseException e) {</span>
				// TODO Auto-generated catch block
<span class="nc" id="L537">				e.printStackTrace();</span>
<span class="nc" id="L538">			}</span>
		}
<span class="nc bnc" id="L540" title="All 6 branches missed.">		if (toDate != null &amp; !toDate.equals(&quot;&quot;)) {</span>
<span class="nc" id="L541">			whereClause.append(&quot;'&quot;</span>
					+ add(new java.sql.Date(new SimpleDateFormat(&quot;yyyy-MM-dd&quot;)
							.parse(toDate).getTime()), 1) + &quot;'&quot;);
		} else {
<span class="nc" id="L545">			whereClause.append(&quot;'&quot;</span>
					+ new Timestamp(new java.util.Date().getTime()) + &quot;'&quot;);
		}
<span class="nc bnc" id="L548" title="All 8 branches missed.">		if (status != null &amp; !status.equals(&quot;&quot;) &amp; !status.equals(&quot;-1&quot;)) {</span>
<span class="nc" id="L549">			whereClause.append(&quot;and status = '&quot; + status + &quot;'&quot;);</span>
		}

<span class="nc" id="L552">		return whereClause.toString();</span>
	}

	public List pwtRcptGenSearchRes(String agtOrgName, String receiptNum,

	String fromDate, String toDate, String status) {
<span class="nc" id="L558">		Connection connection = null;</span>
<span class="nc" id="L559">		Statement statement = null;</span>
<span class="nc" id="L560">		ResultSet resultSet = null;</span>

<span class="nc" id="L562">		List tmpRcptSearchRes = new ArrayList();</span>
<span class="nc" id="L563">		String whereClause = &quot; &quot;;</span>
		try {
<span class="nc" id="L565">			whereClause = getWhereClause(agtOrgName, receiptNum, fromDate,</span>
					toDate, status, &quot;pwtRcptGen&quot;);
<span class="nc" id="L567">		} catch (ParseException e2) {</span>
			// TODO Auto-generated catch block
<span class="nc" id="L569">			e2.printStackTrace();</span>
<span class="nc" id="L570">		}</span>
<span class="nc" id="L571">		System.out.println(&quot;Where Clause--&quot; + whereClause);</span>

		try {
			 
<span class="nc" id="L575">			connection = DBConnect.getConnection();</span>
<span class="nc" id="L576">			connection.setAutoCommit(false);</span>
<span class="nc" id="L577">			statement = connection.createStatement();</span>

<span class="nc" id="L579">			String searchQuery = &quot;select status,no_of_tickets,date_entered,verified_tickets,verified_virn,agent_org_id,noOfTicket.receipt_id,name from (select status,date_entered,verified_tickets,verified_virn,agent_org_id,result.receipt_id,name from st_lms_organization_master, st_se_tmp_pwt_receipt stpr,(select distinct(receipt_id),SUM(verified_tickets) as verified_tickets,SUM(verified_virn) as verified_virn  from (select 0 verified_tickets,0 verified_virn,receipt_id from st_se_tmp_pwt_receipt stpr union select count(ticket.receipt_id) as verified_tickets ,0 verified_virn,receipt_id from st_se_tmp_pwt_tickets_inv ticket group by receipt_id  union select 0 verified_tickets,count(virn.receipt_id) as verified_virn ,receipt_id from st_se_tmp_pwt_inv virn group by receipt_id) c group by receipt_id) result where stpr.receipt_id=result.receipt_id and agent_org_id=organization_id) searchResult , (select sum(no_of_tickets) no_of_tickets ,receipt_id from st_se_tmp_pwt_receipt_detail group by receipt_id) noOfTicket where searchResult.receipt_id = noOfTicket.receipt_id&quot;;</span>

<span class="nc" id="L581">			System.out.println(searchQuery + &quot; and &quot; + whereClause);</span>
<span class="nc" id="L582">			resultSet = statement.executeQuery(searchQuery + &quot; and &quot;</span>
					+ whereClause);

<span class="nc bnc" id="L585" title="All 2 branches missed.">			while (resultSet.next()) {</span>
<span class="nc" id="L586">				TmpPwtReceiptBean receiptBean = new TmpPwtReceiptBean();</span>
<span class="nc" id="L587">				receiptBean.setAgtOrgName(resultSet.getString(&quot;name&quot;));</span>
<span class="nc" id="L588">				receiptBean.setReceiptId(resultSet.getString(&quot;receipt_id&quot;));</span>
<span class="nc" id="L589">				receiptBean.setRecievedDate(resultSet.getTimestamp(</span>
						&quot;date_entered&quot;).toString());
<span class="nc" id="L591">				receiptBean.setTickReceived(resultSet</span>
						.getString(&quot;no_of_tickets&quot;));
<span class="nc" id="L593">				receiptBean.setVerifiedTickNum(resultSet</span>
						.getString(&quot;verified_tickets&quot;));
<span class="nc" id="L595">				receiptBean.setVerifiedVIRN(resultSet</span>
						.getString(&quot;verified_virn&quot;));
<span class="nc" id="L597">				receiptBean.setStatus(resultSet.getString(&quot;status&quot;));</span>
<span class="nc" id="L598">				tmpRcptSearchRes.add(receiptBean);</span>
<span class="nc" id="L599">			}</span>

<span class="nc" id="L601">			return tmpRcptSearchRes;</span>
<span class="nc" id="L602">		} catch (SQLException e) {</span>
<span class="nc" id="L603">			System.out.println(&quot;In PwtVerifyHelper Exception &quot; + e);</span>
			try {
<span class="nc" id="L605">				connection.rollback();</span>
<span class="nc" id="L606">			} catch (SQLException e1) {</span>
				// TODO Auto-generated catch block
<span class="nc" id="L608">				e1.printStackTrace();</span>
<span class="nc" id="L609">			}</span>
		} finally {

<span class="nc" id="L612">			try {</span>

<span class="nc bnc" id="L614" title="All 6 branches missed.">				if (statement != null) {</span>
<span class="nc" id="L615">					statement.close();</span>
				}
<span class="nc bnc" id="L617" title="All 6 branches missed.">				if (connection != null) {</span>
<span class="nc" id="L618">					connection.close();</span>
				}
<span class="nc" id="L620">			} catch (SQLException se) {</span>
<span class="nc" id="L621">				se.printStackTrace();</span>
<span class="nc" id="L622">			}</span>

<span class="nc" id="L624">		}</span>
<span class="nc" id="L625">		return null;</span>
	}

	public List&lt;PwtBean&gt; saveBOPwtTicketsDataTmpReceipt(String boOrgName,
			int userID, int userOrgID, OrgBean agtOrgBean,
			List&lt;ActiveGameBean&gt; activeGameList, String rootPath,
			double HighPrizeAmount, String highPrizeCriteria,
			List verifiedData, String receiptNum, String closeReceipt,
			String channel, String interfaceType) throws LMSException {

<span class="nc" id="L635">		setReceiptNum(receiptNum);</span>
<span class="nc" id="L636">		setActiveGameList(activeGameList);</span>
		// virn = new StringBuilder();
<span class="nc" id="L638">		virnMap = new HashMap&lt;Integer, StringBuilder&gt;();</span>
<span class="nc" id="L639">		Connection connection = null;</span>
<span class="nc" id="L640">		boolean isCommitable = false;</span>
<span class="nc" id="L641">		List&lt;PwtBean&gt; pwtCompleteReceiptList = new ArrayList&lt;PwtBean&gt;();</span>

<span class="nc" id="L643">		PreparedStatement boReceiptPstmt = null;</span>
<span class="nc" id="L644">		PreparedStatement boReceiptMappingPstmt = null;</span>
<span class="nc" id="L645">		String boReceiptQuery = null;</span>
<span class="nc" id="L646">		String boReceiptMappingQuery = null;</span>

<span class="nc" id="L648">		int boReceiptId = 0;</span>

<span class="nc" id="L650">		double agtPwtCommRate = 0.0;</span>
<span class="nc" id="L651">		int gameNbr = 0;</span>
		;

<span class="nc" id="L654">		ActiveGameBean activeGameBean = null;</span>

<span class="nc" id="L656">		int agentOrgId = agtOrgBean.getOrgId();</span>
<span class="nc" id="L657">		int agtUserId = agtOrgBean.getUserId();</span>

<span class="nc" id="L659">		System.out.println(agtOrgBean.getOrgName()</span>
				+ &quot;-saveBOPwtTicketsDataTmpReceipt--agtOrgId-**&quot; + agentOrgId);
		try {
			 
<span class="nc" id="L663">			connection = DBConnect.getConnection();</span>
<span class="nc" id="L664">			connection.setAutoCommit(false);</span>

<span class="nc" id="L666">			List transactionId = new ArrayList();</span>
			// String receiptArr=null;

<span class="nc" id="L669">			Map gameVirnCode = (Map) verifiedData.get(1);</span>
<span class="nc" id="L670">			PwtBean pwtBean = null;</span>
<span class="nc" id="L671">			int game_id = 0;</span>
<span class="nc" id="L672">			Iterator itVirn = gameVirnCode.entrySet().iterator();</span>
<span class="nc bnc" id="L673" title="All 2 branches missed.">			while (itVirn.hasNext()) {</span>
<span class="nc" id="L674">				StringBuilder virn = new StringBuilder();</span>
<span class="nc" id="L675">				List&lt;PwtBean&gt; pwtList = new ArrayList&lt;PwtBean&gt;();</span>
<span class="nc" id="L676">				Map.Entry pairsVirn = (Map.Entry) itVirn.next();</span>
<span class="nc" id="L677">				game_id = (Integer) pairsVirn.getKey();</span>
<span class="nc" id="L678">				System.out.println(&quot;VIRN Map--game_id&quot; + game_id);</span>
<span class="nc" id="L679">				List virnList = (List) pairsVirn.getValue();</span>
<span class="nc bnc" id="L680" title="All 2 branches missed.">				if (!virnList.isEmpty()) {</span>
<span class="nc" id="L681">					String[] virnArray = (String[]) virnList</span>
							.toArray(new String[virnList.size()]);

<span class="nc bnc" id="L684" title="All 2 branches missed.">					for (int i = 0; i &lt; virnArray.length; i++) {</span>
<span class="nc bnc" id="L685" title="All 4 branches missed.">						if (virnArray[i] != null</span>
								&amp;&amp; !virnArray[i].trim().equals(&quot;&quot;)) {
<span class="nc" id="L687">							pwtBean = new PwtBean();</span>
<span class="nc" id="L688">							pwtBean.setVirnCode(virnArray[i]);</span>
<span class="nc" id="L689">							pwtBean.setValid(true);</span>
<span class="nc" id="L690">							pwtList.add(pwtBean);</span>
						}
					}

<span class="nc bnc" id="L694" title="All 2 branches missed.">					if (activeGameList != null) {</span>
<span class="nc bnc" id="L695" title="All 2 branches missed.">						for (int i = 0; i &lt; activeGameList.size(); i++) {</span>
<span class="nc" id="L696">							activeGameBean = activeGameList.get(i);</span>
<span class="nc bnc" id="L697" title="All 2 branches missed.">							if (game_id == activeGameBean.getGameId()) {</span>
								// agtPwtCommRate =
								// activeGameBean.getAgentPwtCommRate();
<span class="nc" id="L700">								gameNbr = Integer.parseInt(activeGameBean</span>
										.getGameNbr_Name().split(&quot;-&quot;)[0]);
<span class="nc" id="L702">								break;</span>

							}
						}
					}
					// pwt verification and check for umclaimed
<span class="nc" id="L708">					boolean isVerified = verifyPwtTicketsTmpReceipt(game_id,</span>
							virnArray, pwtList, HighPrizeAmount,
							highPrizeCriteria, gameNbr, agentOrgId);
<span class="nc bnc" id="L711" title="All 2 branches missed.">					if (isVerified) {</span>
<span class="nc" id="L712">						long transactionID = saveBOPwtTicketsTmpReceipt(pwtList,</span>
								game_id, boOrgName, userID, userOrgID,
								agentOrgId, agtUserId, connection, virn,
								gameNbr);
<span class="nc bnc" id="L716" title="All 4 branches missed.">						if (transactionID != 0 &amp;&amp; transactionID != -1) {</span>
<span class="nc" id="L717">							transactionId.add(transactionID);</span>
						}
<span class="nc" id="L719">						pwtCompleteReceiptList.addAll(pwtList);</span>

<span class="nc" id="L721">						virn.append(&quot;''&quot;);</span>
<span class="nc" id="L722">						virnMap.put(game_id, virn);</span>

					}
				}
<span class="nc" id="L726">			}</span>
<span class="nc" id="L727">			System.out.println(&quot;---List of Tx Id--&quot; + transactionId);</span>
<span class="nc" id="L728">			System.out.println(&quot;---virn Map game Wise-&quot; + virnMap);</span>

			// get auto generated reciept number
<span class="nc bnc" id="L731" title="All 4 branches missed.">			if (transactionId != null &amp;&amp; transactionId.size() &gt; 0) {</span>
<span class="nc" id="L732">				CommonFunctionsHelper commonHelper = new CommonFunctionsHelper();</span>
<span class="nc" id="L733">				String generatedReceiptNumber = commonHelper.generateReceiptBo(</span>
						connection, agentOrgId, &quot;AGENT&quot;, transactionId);
<span class="nc bnc" id="L735" title="All 2 branches missed.">				if (generatedReceiptNumber != null) {</span>
<span class="nc" id="L736">					isCommitable = true;</span>
				} else {
<span class="nc" id="L738">					throw new LMSException(</span>
							&quot;Exception during generating final receipt while generating receipt&quot;);
				}
<span class="nc" id="L741">				boReceiptId = Integer.parseInt(generatedReceiptNumber</span>
						.split(&quot;-&quot;)[0]);

<span class="nc bnc" id="L744" title="All 2 branches missed.">				if (isCommitable) {</span>
					// virn.append(&quot;''&quot;);
					// verifiedData.add(virn);
<span class="nc" id="L747">					verifiedData.add(virnMap);</span>
<span class="nc" id="L748">					System.out.println(&quot;---verifiedData-&quot; + verifiedData);</span>
					// Temporary receipt tables entries
<span class="nc" id="L750">					updateTempReceiptTables(verifiedData, boReceiptId + &quot;&quot;,</span>
							connection, userID, userOrgID, channel,
							interfaceType);

<span class="nc" id="L754">					List&lt;TicketBean&gt; VerifyTicketList = new ArrayList&lt;TicketBean&gt;();</span>
<span class="nc" id="L755">					int game_id_tk = 0;</span>
<span class="nc" id="L756">					PwtTicketHelper pwtTicketHelper = new PwtTicketHelper();</span>
<span class="nc" id="L757">					System.out.println(&quot;Ticket Map--&quot; + verifiedData.get(2));</span>
<span class="nc" id="L758">					Map gameTickNum = (HashMap) verifiedData.get(2);</span>
<span class="nc" id="L759">					Iterator it = gameTickNum.entrySet().iterator();</span>
<span class="nc bnc" id="L760" title="All 2 branches missed.">					while (it.hasNext()) {</span>
<span class="nc" id="L761">						Map.Entry pairs = (Map.Entry) it.next();</span>
<span class="nc" id="L762">						game_id_tk = (Integer) pairs.getKey();</span>
<span class="nc" id="L763">						updateTicketsStatus(</span>
								(List&lt;TicketBean&gt;) pairs.getValue(), userID,
								userOrgID, game_id_tk, connection, agentOrgId,
								channel, interfaceType);
<span class="nc" id="L767">					}</span>
<span class="nc" id="L768">				} else {</span>
<span class="nc" id="L769">					throw new LMSException(</span>
							&quot;There are no Valid Transaction done for these specified PWT&quot;);
				}

			}
			// closing receipt
<span class="nc bnc" id="L775" title="All 4 branches missed.">			if (closeReceipt != null &amp;&amp; closeReceipt.equals(&quot;Yes&quot;)) {</span>
<span class="nc" id="L776">				closeReceipt(receiptNum, userID, userOrgID, verifiedData,</span>
						activeGameList, connection, channel, interfaceType);
			} else {
<span class="nc" id="L779">				System.out.println(&quot;ALERT :: receipt not closed&quot;);</span>
			}
<span class="nc" id="L781">			connection.commit();</span>

<span class="nc bnc" id="L783" title="All 2 branches missed.">			if (boReceiptId &gt; 0) {</span>
<span class="nc" id="L784">				GraphReportHelper graphReportHelper = new GraphReportHelper();</span>
<span class="nc" id="L785">				graphReportHelper.createTextReportBO(boReceiptId, boOrgName,</span>
						userOrgID, rootPath);
			}

<span class="nc" id="L789">		} catch (SQLException e) {</span>
			try {
<span class="nc" id="L791">				connection.rollback();</span>

<span class="nc" id="L793">			} catch (SQLException e1) {</span>
				// TODO Auto-generated catch block
<span class="nc" id="L795">				e1.printStackTrace();</span>
<span class="nc" id="L796">			}</span>
<span class="nc" id="L797">			e.printStackTrace();</span>
<span class="nc" id="L798">			throw new LMSException(e);</span>

		} finally {

<span class="nc" id="L802">			try {</span>

<span class="nc bnc" id="L804" title="All 4 branches missed.">				if (connection != null) {</span>
<span class="nc" id="L805">					connection.close();</span>
				}
<span class="nc" id="L807">			} catch (SQLException se) {</span>
<span class="nc" id="L808">				se.printStackTrace();</span>
<span class="nc" id="L809">			}</span>
<span class="nc" id="L810">		}</span>

<span class="nc" id="L812">		return pwtCompleteReceiptList;</span>

	}

	private long saveBOPwtTicketsTmpReceipt(List&lt;PwtBean&gt; pwtList, int gameId,
			String boOrgName, int userID, int userOrgID, int agentOrgId,
			int agtUserId, Connection connection, StringBuilder virn,
			int gameNbr) throws LMSException {
		try {
<span class="nc" id="L821">			PreparedStatement masterPstmt = null;</span>
<span class="nc" id="L822">			PreparedStatement detailPstmt = null;</span>
<span class="nc" id="L823">			PreparedStatement invPstmt = null;</span>
			// PreparedStatement agtGameCommVarPstmt = null;
<span class="nc" id="L825">			PreparedStatement agtPwtUpdatePstmt = null;</span>

<span class="nc" id="L827">			ResultSet resultSet = null;</span>
			// ResultSet resultSetCommVar = null;

<span class="nc" id="L830">			long trnId = -1;</span>

<span class="nc bnc" id="L832" title="All 2 branches missed.">			if (pwtList != null) {</span>
<span class="nc" id="L833">				int size = pwtList.size();</span>
<span class="nc" id="L834">				PwtBean pwtBean = null;</span>
<span class="nc" id="L835">				String masterQuery = null;</span>
<span class="nc" id="L836">				String detailQuery = null;</span>
<span class="nc" id="L837">				String invQuery = null;</span>

<span class="nc" id="L839">				double pwtAmt = 0.0;</span>
<span class="nc" id="L840">				double commAmt = 0.0;</span>
<span class="nc" id="L841">				double netAmt = 0.0;</span>
<span class="nc" id="L842">				double creditAmt = 0.0;</span>
<span class="nc" id="L843">				double debitUnclaim = 0.0;</span>

<span class="nc bnc" id="L845" title="All 2 branches missed.">				if (size &gt; 0) {</span>

					// get agents game pwtCommRate
<span class="nc" id="L848">					CommonFunctionsHelper commonHelper = new CommonFunctionsHelper();</span>
<span class="nc" id="L849">					double agtPwtCommRate = commonHelper</span>
							.fetchCommOfOrganization(gameId, agentOrgId, &quot;PWT&quot;,
									&quot;AGENT&quot;, connection);

<span class="nc" id="L853">					masterPstmt = connection.prepareStatement(QueryManager</span>
							.insertInLMSTransactionMaster());
<span class="nc" id="L855">					masterPstmt.setString(1, &quot;AGENT&quot;);</span>

<span class="nc" id="L857">					masterPstmt.executeUpdate();</span>
<span class="nc" id="L858">					resultSet = masterPstmt.getGeneratedKeys();</span>
<span class="nc bnc" id="L859" title="All 2 branches missed.">					if (resultSet.next()) {</span>
<span class="nc" id="L860">						trnId = resultSet.getLong(1);</span>
<span class="nc" id="L861">						System.out.println(&quot;Transaction Id:&quot; + trnId);</span>

<span class="nc" id="L863">						masterQuery = QueryManager.getST1BOMasterQuery();</span>
<span class="nc" id="L864">						masterPstmt = connection.prepareStatement(masterQuery);</span>

<span class="nc" id="L866">						detailQuery = QueryManager.getST1PwtBODetailQuery();</span>
<span class="nc" id="L867">						detailPstmt = connection.prepareStatement(detailQuery);</span>

<span class="nc" id="L869">						invQuery = QueryManager.getST1PWTBOUpdateQuery();</span>
<span class="nc" id="L870">						invPstmt = connection.prepareStatement(invQuery);</span>
<span class="nc" id="L871">						System.out.println(userOrgID + &quot;--userOrg---userId-&quot;</span>
								+ userID
								+ &quot;-saveBOPwtTicketsTmpReceipt--agtOrgId-***&quot;
								+ agentOrgId);

						// update st_se_agent_pwt in case if agent brings
						// uncalimed PWTs to BO
<span class="nc" id="L878">						String agtPwtUpdateQuery = &quot;update  st_se_agent_pwt set status=? where game_id = ? and virn_code = ? and agent_org_id = ? &quot;;</span>
<span class="nc" id="L879">						agtPwtUpdatePstmt = connection</span>
								.prepareStatement(agtPwtUpdateQuery);

<span class="nc" id="L882">						masterPstmt.setLong(1, trnId);</span>
<span class="nc" id="L883">						masterPstmt.setString(2, &quot;AGENT&quot;);</span>
<span class="nc" id="L884">						masterPstmt.setInt(3, agentOrgId);</span>
<span class="nc" id="L885">						masterPstmt.setTimestamp(4, new java.sql.Timestamp(</span>
								new java.util.Date().getTime()));
<span class="nc" id="L887">						masterPstmt.setString(5, &quot;PWT&quot;);</span>
<span class="nc" id="L888">						masterPstmt.setInt(6, userID);</span>
<span class="nc" id="L889">						masterPstmt.setInt(7, userOrgID);</span>
<span class="nc" id="L890">						masterPstmt.executeUpdate();</span>

<span class="nc" id="L892">						System.out.println(&quot;transaction ID ::&quot; + trnId);</span>

<span class="nc bnc" id="L894" title="All 2 branches missed.">						for (int i = 0; i &lt; size; i++) {</span>
<span class="nc" id="L895">							pwtBean = (PwtBean) pwtList.get(i);</span>

<span class="nc bnc" id="L897" title="All 2 branches missed.">							if (pwtBean.getIsValid()) {</span>

<span class="nc" id="L899">								String encodedVirn = pwtBean.getVirnCode();</span>
<span class="nc" id="L900">								detailPstmt.setString(1, encodedVirn);</span>
<span class="nc" id="L901">								detailPstmt.setLong(2, trnId);</span>
<span class="nc" id="L902">								detailPstmt.setInt(3, gameId);</span>
<span class="nc" id="L903">								detailPstmt.setInt(4, agtUserId);</span>
<span class="nc" id="L904">								detailPstmt.setInt(5, agentOrgId);</span>

<span class="nc" id="L906">								pwtAmt = Double.parseDouble(pwtBean</span>
										.getPwtAmount());
<span class="nc" id="L908">								commAmt = pwtAmt * agtPwtCommRate * 0.01;</span>
<span class="nc" id="L909">								netAmt = pwtAmt + commAmt;</span>
								// for current credit amt updation
<span class="nc" id="L911">								creditAmt += netAmt;</span>

<span class="nc" id="L913">								detailPstmt.setDouble(6, pwtAmt);</span>
<span class="nc" id="L914">								detailPstmt.setDouble(7, commAmt);</span>
<span class="nc" id="L915">								detailPstmt.setDouble(8, netAmt);</span>
<span class="nc" id="L916">								detailPstmt.execute();</span>

<span class="nc bnc" id="L918" title="All 4 branches missed.">								if (&quot;IN_PLR_UNCLM&quot;.equalsIgnoreCase(pwtBean</span>
										.getInUnclmed())
										|| &quot;IN_AGENT_UNCLM&quot;
												.equalsIgnoreCase(pwtBean
														.getInUnclmed())) {
									String tableType;
<span class="nc bnc" id="L924" title="All 2 branches missed.">									if (&quot;IN_PLR_UNCLM&quot;.equalsIgnoreCase(pwtBean</span>
											.getInUnclmed())) {
<span class="nc" id="L926">										tableType = &quot;PLAYER&quot;;</span>
									} else {
<span class="nc" id="L928">										tableType = &quot;AGENT&quot;;</span>
									}

<span class="nc" id="L931">									commonHelper.updateOrgForUnClaimedVirn(</span>
											agentOrgId, &quot;AGENT&quot;, encodedVirn,
											&quot;DONE_UNCLM&quot;, gameId, tableType,
											connection,pwtBean.getTicketNumber());
<span class="nc" id="L935">									debitUnclaim += pwtAmt;</span>

								}

								// by yogesh game nbr
<span class="nc" id="L940">								GameUtilityHelper.updateNoOfPrizeRem(gameId,</span>
										pwtAmt, &quot;CLAIM_AGT&quot;, encodedVirn,
										connection, gameNbr);

<span class="nc" id="L944">								invPstmt.setInt(1, gameNbr);</span>
<span class="nc" id="L945">								invPstmt.setInt(2, gameId);</span>
<span class="nc" id="L946">								invPstmt.setString(3, encodedVirn);</span>
<span class="nc" id="L947">								invPstmt.execute();</span>
<span class="nc" id="L948">								virn.append(&quot;'&quot; + encodedVirn + &quot;',&quot;);</span>

							}

						}

<span class="nc" id="L954">						boolean isValid=OrgCreditUpdation.updateOrganizationBalWithValidate(creditAmt, &quot;TRANSACTION&quot;, &quot;PWT&quot;, agentOrgId,</span>
								0, &quot;AGENT&quot;, 0, connection);
						
<span class="nc bnc" id="L957" title="All 2 branches missed.">						if(!isValid)</span>
<span class="nc" id="L958">							throw new LMSException();</span>
						
						// for current credit amt updation
						/*boolean isUpdateDone = OrgCreditUpdation
								.updateCreditLimitForAgent(agentOrgId, &quot;PWT&quot;,
										creditAmt, connection);*/
<span class="nc" id="L964">						System.out</span>
								.println(&quot;---saveBOPwtTicketsTmpReceipt--virn-&quot;
										+ virn);

						// update AGENT's UNCLAIM_BAL Balance
<span class="nc bnc" id="L969" title="All 2 branches missed.">						if (creditAmt &gt; 0.0) {</span>
<span class="nc" id="L970">							OrgCreditUpdation.updateOrganizationBalWithValidate(debitUnclaim, &quot;UNCLAIM_BAL&quot;, &quot;DEBIT&quot;, agentOrgId,</span>
									0, &quot;AGENT&quot;, 0, connection);
							/*commonHelper.updateOrgBalance(&quot;UNCLAIM_BAL&quot;,
									debitUnclaim, agentOrgId, &quot;DEBIT&quot;,
									connection);*/
						}
<span class="nc" id="L976">					} else {</span>
<span class="nc" id="L977">						throw new LMSException(</span>
								&quot;Exception while generating final receipt Transaction id not generated: &quot;
										+ trnId);
					}
				}

			}

<span class="nc" id="L985">			return trnId;</span>
<span class="nc" id="L986">		} catch (SQLException sqle) {</span>
<span class="nc" id="L987">			throw new LMSException(sqle);</span>
		}
	}

	/*
	 * private boolean verifyPwtTicketsTmpReceipt(int gameId, String[] virnCode,
	 * List&lt;PwtBean&gt; pwtList,double HighPrizeAmount,String
	 * highPrizeCriteria,int gameNbr,int agtOrgId) throws LMSException {
	 * System.out.println(&quot;verify fumction called &quot;); String encodedVirnCode =
	 * getEncodedVirnCodeTmpReceipt(virnCode); System.out.println(&quot;---((((((::&quot; +
	 * encodedVirnCode);
	 * 
	 * Connection connection = null; Statement statement = null; Statement
	 * statement2 = null; Statement statement3 = null; Statement statement4 =
	 * null;
	 * 
	 * ResultSet resultSet = null; ResultSet resultSet2 = null; ResultSet
	 * resultSet3 = null; ResultSet resultSet4 = null;
	 * 
	 * 
	 * 
	 * boolean isVerified = false; //int orderId = -1;
	 * 
	 * if (pwtList != null) { int size = pwtList.size();
	 * 
	 * PwtBean pwtBean = null;
	 * 
	 * StringBuffer query = new StringBuffer();
	 * 
	 * if (size &gt; 0) { try {   connection =
	 * dbConnect.getConnection();
	 * 
	 * statement = connection.createStatement();
	 * query.append(QueryManager.getST1PWTBOCheckQuery()); query.append(&quot;
	 * st_se_pwt_inv_&quot;+gameNbr+&quot; where &quot;); query.append(&quot; game_id = &quot;);
	 * query.append(&quot;&quot; + gameId); query.append(&quot; and virn_code in (&quot;);
	 * query.append(encodedVirnCode); query.append(&quot;)&quot;);
	 * 
	 * System.out.println(&quot;GameId:&quot; + gameId); System.out.println(&quot;Query:: &quot; +
	 * query); resultSet = statement.executeQuery(query.toString());
	 * System.out.println(&quot;ResultSet:&quot; + resultSet + &quot;---&quot; +
	 * resultSet.getFetchSize());
	 * 
	 * String vCode = null; String pwtAmount = null; String enVirnCode = null;
	 * String prizeLevel = null; String prizeStatus=null;
	 * 
	 * while (resultSet.next()) {
	 * 
	 * vCode = resultSet .getString(TableConstants.SPI_VIRN_CODE);
	 * System.out.println(&quot;Vcode:&quot; + vCode); pwtAmount = resultSet
	 * .getString(TableConstants.SPI_PWT_AMT); prizeLevel = resultSet
	 * .getString(TableConstants.SPI_PRIZE_LEVEL);
	 * prizeStatus=resultSet.getString(&quot;status&quot;);
	 * 
	 * for (int j = 0; j &lt; pwtList.size(); j++) {
	 * 
	 * pwtBean = (PwtBean) pwtList.get(j); enVirnCode = pwtBean.getVirnCode();
	 * //System.out.println(&quot;for loop running &quot; + j+ &quot; times &quot; +
	 * pwtBean.getVirnCode()); // check for entry into temp table
	 * 
	 * if(enVirnCode.equals(vCode)) { if
	 * (prizeStatus.equalsIgnoreCase(&quot;CLAIM_RET_UNCLM&quot;)) { CommonFunctionsHelper
	 * commHelper = new CommonFunctionsHelper(); boolean flag =
	 * commHelper.verifyOrgForUnClaimedVirn(agtOrgId, &quot;AGENT&quot;, enVirnCode,
	 * &quot;UNCLAIM_BAL&quot;, gameId, connection); if(flag){ String orgname=null; String
	 * receiptNumber=null; Timestamp receiptTime=null;
	 * statement4=connection.createStatement(); //String agtDetailsQuery=&quot;select
	 * name from st_lms_organization_master where organization_id in (select
	 * agent_org_id from st_se_bo_pwt where virn_code='&quot;+enVirnCode+&quot;' and
	 * game_id=&quot;+gameId+&quot;)&quot;; String retDetailsQuery=&quot;select
	 * a.name,c.generated_id,e.transaction_date from st_lms_organization_master
	 * a,st_se_agent_pwt b,st_lms_agent_receipts
	 * c,st_lms_agent_transaction_master e where b.virn_code='&quot;+enVirnCode+&quot;'
	 * and b.game_id=&quot;+gameId+&quot; and a.organization_id=b.retailer_org_id and
	 * b.transaction_id=e.transaction_id and c.receipt_id=(select receipt_id
	 * from st_lms_agent_receipts_trn_mapping where
	 * transaction_id=e.transaction_id)&quot;;
	 * 
	 * System.out.println(&quot;query for get org name &quot; + retDetailsQuery);
	 * resultSet4=statement4.executeQuery(retDetailsQuery);
	 * while(resultSet4.next()){ orgname= resultSet4.getString(&quot;name&quot;);
	 * receiptNumber=resultSet4.getString(&quot;generated_id&quot;);
	 * receiptTime=resultSet4.getTimestamp(&quot;transaction_date&quot;); }
	 * 
	 * isVerified = true; pwtBean.setValid(true);
	 * pwtBean.setVerificationStatus(&quot;Valid Virn&quot;);
	 * pwtBean.setPwtAmount(pwtAmount); //pwtBean.setMessage(&quot;Credited to
	 * Concerned Party&quot;); pwtBean.setMessage(&quot;Already Paid to Retailer: &quot; +
	 * orgname+&quot; on Voucher Number: &quot;+receiptNumber+&quot; at &quot;+receiptTime);
	 * pwtBean.setIsUnclmed(true); pwtBean.setMessageCode(&quot;111001&quot;); }else{
	 * pwtBean.setValid(false); pwtBean.setVerificationStatus(&quot;InValid Virn&quot;);
	 * pwtBean.setMessage(&quot;VIRN To be Claimed by Another Agent.&quot;);
	 * pwtBean.setMessageCode(&quot;Undefined&quot;); } break; }else if
	 * (prizeStatus.equalsIgnoreCase(&quot;CLAIM_RET&quot;)) { if
	 * (enVirnCode.equals(vCode)) {
	 * 
	 * isVerified = true; pwtBean.setValid(true);
	 * pwtBean.setPwtAmount(pwtAmount); pwtBean.setMessage(&quot;Credited to
	 * Concerned Party&quot;); pwtBean.setMessageCode(&quot;111001&quot;); } break; }else if
	 * (prizeStatus.equalsIgnoreCase(&quot;CLAIM_AGT_TEMP&quot;)) { if
	 * (enVirnCode.equals(vCode)) { isVerified = true; pwtBean.setValid(true);
	 * pwtBean.setPwtAmount(pwtAmount); pwtBean.setMessage(&quot;AAlready Verified in
	 * Bulk Receipt at BO, Fianl Payment Pending&quot;);
	 * pwtBean.setMessageCode(&quot;112001&quot;); } break; } else if
	 * (prizeStatus.equalsIgnoreCase(&quot;CLAIM_RET_AGT_TEMP&quot;)) { if
	 * (enVirnCode.equals(vCode)) { isVerified = true; pwtBean.setValid(true);
	 * pwtBean.setPwtAmount(pwtAmount); pwtBean.setMessage(&quot;Already Verified in
	 * Bulk Receipt at BO, Fianl Payment Pending&quot;);
	 * pwtBean.setMessageCode(&quot;112001&quot;); } break; } else if (prizeStatus
	 * .equalsIgnoreCase(&quot;CLAIM_AGT&quot;)) { if (enVirnCode.equals(vCode)) {
	 * 
	 * String orgname=null; statement2=connection.createStatement(); String
	 * agtDetailsQuery=&quot;select name from st_lms_organization_master where
	 * organization_id in (select agent_org_id from st_se_bo_pwt where
	 * virn_code='&quot;+enVirnCode+&quot;' and game_id=&quot;+gameId+&quot;)&quot;;
	 * System.out.println(&quot;query for get org name &quot; + agtDetailsQuery);
	 * resultSet2=statement2.executeQuery(agtDetailsQuery);
	 * while(resultSet2.next()){ orgname= resultSet2.getString(&quot;name&quot;); }
	 * pwtBean.setValid(false); //pwtBean.setMessage(&quot;This Ticket has been paid
	 * to Agent:: &quot; + orgname); pwtBean.setMessage(&quot;Already Paid to Agent[&quot; +
	 * orgname+&quot;]&quot;); pwtBean.setMessageCode(&quot;112003&quot;); } break; }else if
	 * (prizeStatus .equalsIgnoreCase(&quot;CLAIM_PLR_TEMP&quot;)){ if
	 * (enVirnCode.equals(vCode)) { isVerified = true; pwtBean.setValid(true);
	 * pwtBean.setPwtAmount(pwtAmount); pwtBean.setMessage(&quot;Already in Process
	 * for Direct Player PWT,Payment/Approval Pending&quot;);
	 * pwtBean.setMessageCode(&quot;112004&quot;); } break; }else if(prizeStatus
	 * .equalsIgnoreCase(&quot;CLAIM_PLR&quot;)){ if (enVirnCode.equals(vCode)) {
	 * 
	 * String playerFirstName=null; String playerLastName=null; String
	 * playercity=null; statement3=connection.createStatement(); String
	 * plrDetailsQuery=&quot;select first_name,last_name,city from
	 * st_lms_player_master where player_id in (select player_id from
	 * st_se_direct_player_pwt where virn_code='&quot;+enVirnCode+&quot;' and
	 * game_id=&quot;+gameId+&quot;)&quot;; System.out.println(&quot;query for get player name &quot; +
	 * plrDetailsQuery); resultSet3=statement3.executeQuery(plrDetailsQuery);
	 * while(resultSet3.next()){ playerFirstName=
	 * resultSet3.getString(&quot;first_name&quot;); playerLastName=
	 * resultSet3.getString(&quot;last_name&quot;); playercity=
	 * resultSet3.getString(&quot;city&quot;); } pwtBean.setValid(false);
	 * //pwtBean.setMessage(&quot;This Ticket has been paid to Player::
	 * &quot;+playerFirstName+&quot; &quot;+playerLastName+ &quot; &quot; +playercity);
	 * pwtBean.setMessage(&quot;Already Paid as Direct Player PWT to Player:
	 * &quot;+playerFirstName+&quot; &quot;+playerLastName+ &quot; &quot; +playercity);
	 * pwtBean.setMessageCode(&quot;112005&quot;); }
	 * 
	 * break; }else if(prizeStatus .equalsIgnoreCase(&quot;CLAIM_PLR_RET&quot;)){ if
	 * (enVirnCode.equals(vCode)) { pwtBean.setValid(false);
	 * pwtBean.setMessage(&quot;This Ticket has been paid to Player but not claimed
	 * by retailer &quot;); }
	 * 
	 * break; }else if(prizeStatus .equalsIgnoreCase(&quot;CLAIM_RET_TEMP&quot;)){ if
	 * (enVirnCode.equals(vCode)) { pwtBean.setValid(false);
	 * //pwtBean.setMessage(&quot;This Ticket is in process between Retailer and
	 * Agent &quot;); pwtBean.setMessage(&quot;Already Verified in Bulk Receipt at
	 * Agent,Final Payment Pending&quot;); pwtBean.setMessageCode(&quot;112006&quot;); } break;
	 * }else if(prizeStatus .equalsIgnoreCase(&quot;CLAIM_PLR_RET_TEMP&quot;)){ if
	 * (enVirnCode.equals(vCode)) { pwtBean.setValid(false);
	 * //pwtBean.setMessage(&quot;This Ticket is in process between Retailer and
	 * Agent &quot;); pwtBean.setMessage(&quot;Already Verified in Bulk Receipt at
	 * Agent,Final Payment Pending&quot;); pwtBean.setMessageCode(&quot;112007&quot;); } break;
	 * }else if(prizeStatus.equalsIgnoreCase(&quot;UNCLM_PWT&quot;)){ if
	 * (enVirnCode.equals(vCode)) {
	 * 
	 * if ((highPrizeCriteria.equals(&quot;level&quot;) &amp;&amp; prizeLevel.equals(&quot;HIGH&quot;)) ||
	 * (highPrizeCriteria.equals(&quot;amt&quot;) &amp;&amp;
	 * (Double.parseDouble(pwtAmount)&gt;=HighPrizeAmount))) {
	 * System.out.println(&quot;inside high prize&quot;); System.out.println(&quot;criteria is &quot; +
	 * highPrizeCriteria); pwtBean.setHighLevel(true); pwtBean.setValid(false);
	 * //pwtBean.setMessage(&quot;This ticket is high prize ticket so please go for
	 * direct player PWT&quot;); pwtBean.setMessage(&quot;High prize VIRN can't be Paid to
	 * Agent.It is to be paid as Direct Player PWT&quot;);
	 * pwtBean.setMessageCode(&quot;112008&quot;); }else{ isVerified = true;
	 * pwtBean.setValid(true); pwtBean.setPwtAmount(pwtAmount);
	 * //pwtBean.setMessage(&quot;This ticket is valid and should be paid to Agent&quot;);
	 * pwtBean.setMessage(&quot;Credited to Concerned Party&quot;);
	 * pwtBean.setMessageCode(&quot;111002&quot;); } }
	 * 
	 * break; }else if(prizeStatus.equalsIgnoreCase(&quot;UNCLM_CANCELLED&quot;)){ if
	 * (enVirnCode.equals(vCode)) {
	 * 
	 * if ((highPrizeCriteria.equals(&quot;level&quot;) &amp;&amp; prizeLevel.equals(&quot;HIGH&quot;)) ||
	 * (highPrizeCriteria.equals(&quot;amt&quot;) &amp;&amp;
	 * (Double.parseDouble(pwtAmount)&gt;=HighPrizeAmount))) {
	 * System.out.println(&quot;inside high prize&quot;); System.out.println(&quot;criteria is &quot; +
	 * highPrizeCriteria); pwtBean.setHighLevel(true); pwtBean.setValid(false);
	 * //pwtBean.setMessage(&quot;This ticket is high prize ticket so please go for
	 * direct player PWT&quot;); pwtBean.setMessage(&quot;High prize VIRN can't be paid to
	 * Agent.It is to be paid as Direct Player PWT&quot;);
	 * pwtBean.setMessageCode(&quot;112011&quot;); }else{ isVerified = true;
	 * pwtBean.setValid(true); pwtBean.setPwtAmount(pwtAmount);
	 * //pwtBean.setMessage(&quot;This ticket is valid and hs been cancelled by BO so
	 * please check it&quot;); pwtBean.setMessage(&quot;Credited to Concerned Party&quot;);
	 * pwtBean.setMessageCode(&quot;111003&quot;); } } break; } else if(prizeStatus
	 * .equalsIgnoreCase(&quot;CANCELLED_PERMANENT&quot;)){ if (enVirnCode.equals(vCode)) {
	 * pwtBean.setValid(false); pwtBean.setMessage(&quot;Tampered/Damaged/Defaced
	 * VIRN as noted at BO&quot;); pwtBean.setMessageCode(&quot;112009&quot;); } break; } } } } }
	 * catch (SQLException e) {
	 * 
	 * e.printStackTrace(); throw new LMSException(e); } finally {
	 * 
	 * try {
	 * 
	 * if (statement != null) { statement.close(); } if (connection != null) {
	 * connection.close(); } } catch (SQLException se) { se.printStackTrace(); } } } }
	 * return isVerified; }
	 */

	private void saveTicketsData(int game_id,
			List&lt;TicketBean&gt; verifiedTicketList, Connection connection)
			throws SQLException {

<span class="nc" id="L1198">		ServletContext servletContext = ServletActionContext</span>
				.getServletContext();
<span class="nc" id="L1200">		String retOnline = (String) servletContext.getAttribute(&quot;RET_ONLINE&quot;);</span>
<span class="nc" id="L1201">		PwtTicketHelper pwtTicketHelper = new PwtTicketHelper();</span>

<span class="nc" id="L1203">		PreparedStatement Pstmt = null;</span>

<span class="nc" id="L1205">		String query = null;</span>

<span class="nc bnc" id="L1207" title="All 2 branches missed.">		if (retOnline.equals(&quot;NO&quot;)) {</span>
<span class="nc" id="L1208">			query = QueryManager.updateIntoPwtTicketsInv();</span>
		} else {
<span class="nc" id="L1210">			query = &quot;update st_pwt_tickets_inv set status=? where ticket_nbr=? and  game_id =?&quot;;</span>
		}

<span class="nc" id="L1213">		Pstmt = connection.prepareStatement(query);</span>
<span class="nc" id="L1214">		Iterator&lt;TicketBean&gt; iterator = verifiedTicketList.iterator();</span>
<span class="nc bnc" id="L1215" title="All 2 branches missed.">		while (iterator.hasNext()) {</span>
<span class="nc" id="L1216">			String ticket_nbr = null;</span>
<span class="nc" id="L1217">			boolean isValid = false;</span>
<span class="nc" id="L1218">			TicketBean ticketBean = (TicketBean) iterator.next();</span>
<span class="nc" id="L1219">			isValid = ticketBean.getIsValid();</span>
<span class="nc bnc" id="L1220" title="All 2 branches missed.">			if (isValid == true) {</span>
<span class="nc" id="L1221">				ticket_nbr = ticketBean.getTicketNumber();</span>
<span class="nc" id="L1222">				String book_nbr = pwtTicketHelper</span>
						.getBookNbrFromTicketNo(ticket_nbr);
<span class="nc bnc" id="L1224" title="All 2 branches missed.">				if (retOnline.equals(&quot;NO&quot;)) {</span>
<span class="nc" id="L1225">					Pstmt.setString(1, ticket_nbr);</span>
<span class="nc" id="L1226">					Pstmt.setInt(2, game_id);</span>
<span class="nc" id="L1227">					Pstmt.setString(3, book_nbr);</span>
<span class="nc" id="L1228">					Pstmt.setString(4, &quot;CLAIM_RET&quot;);</span>
<span class="nc" id="L1229">					Pstmt.executeUpdate();</span>
				} else {

<span class="nc" id="L1232">					Pstmt.setString(1, &quot;CLAIM_RET&quot;);</span>
<span class="nc" id="L1233">					Pstmt.setString(2, ticket_nbr);</span>
<span class="nc" id="L1234">					Pstmt.setInt(3, game_id);</span>
<span class="nc" id="L1235">					Pstmt.executeUpdate();</span>

				}
			}
<span class="nc" id="L1239">		}</span>
<span class="nc" id="L1240">	}</span>

	public List&lt;TicketBean&gt; saveTmpTicketsData(
			List&lt;TicketBean&gt; verifiedTicketList, String receiptNum, int userId,
			int userOrgId, String agtOrgName, String channel,
			String interfaceType) throws LMSException {
<span class="nc" id="L1246">		List&lt;TicketBean&gt; savedResults = new ArrayList&lt;TicketBean&gt;();</span>
<span class="nc" id="L1247">		Connection connection = null;</span>
		// PreparedStatement Pstmt = null;
<span class="nc" id="L1249">		PreparedStatement Pstmt1 = null;</span>
<span class="nc" id="L1250">		String query = QueryManager.getST4UpdatePwtTicketStatusToAGT();</span>
		try {
			 
<span class="nc" id="L1253">			connection = DBConnect.getConnection();</span>
			// Pstmt = connection.prepareStatement(query);
<span class="nc" id="L1255">			Timestamp dateEntered = new Timestamp(new java.util.Date()</span>
					.getTime());
<span class="nc" id="L1257">			Pstmt1 = connection</span>
					.prepareStatement(&quot;insert into st_se_tmp_pwt_tickets_inv(ticket_nbr,book_nbr,game_id,receipt_id,user_id,status,date_entered) values(?,?,?,?,?,?,?)&quot;);
<span class="nc" id="L1259">			Iterator&lt;TicketBean&gt; iterator = verifiedTicketList.iterator();</span>
<span class="nc" id="L1260">			System.out.println(&quot;Verified Tickets list: &quot; + verifiedTicketList);</span>
<span class="nc" id="L1261">			CommonFunctionsHelper commonFunction = new CommonFunctionsHelper();</span>
<span class="nc bnc" id="L1262" title="All 2 branches missed.">			while (iterator.hasNext()) {</span>
<span class="nc" id="L1263">				String ticket_nbr = null;</span>
<span class="nc" id="L1264">				boolean isValid = false;</span>
				// String status=null;
<span class="nc" id="L1266">				int size = 0;</span>
<span class="nc" id="L1267">				TicketBean ticketBean = (TicketBean) iterator.next();</span>
<span class="nc" id="L1268">				isValid = ticketBean.getIsValid();</span>
				// status=ticketBean.getStatus();
<span class="nc bnc" id="L1270" title="All 2 branches missed.">				if (isValid == true) {</span>
<span class="nc" id="L1271">					ticket_nbr = ticketBean.getTicketNumber();</span>
<span class="nc" id="L1272">					Pstmt1.setString(1, ticket_nbr);</span>
<span class="nc" id="L1273">					Pstmt1.setString(2, ticketBean.getBook_nbr());</span>
<span class="nc" id="L1274">					Pstmt1.setInt(3, ticketBean.getTicketGameId());</span>
<span class="nc" id="L1275">					Pstmt1.setString(4, receiptNum);</span>
<span class="nc" id="L1276">					Pstmt1.setInt(5, userId);</span>
<span class="nc" id="L1277">					Pstmt1.setString(6, &quot;OPEN&quot;);</span>
<span class="nc" id="L1278">					Pstmt1.setTimestamp(7, dateEntered);</span>
<span class="nc" id="L1279">					Pstmt1.executeUpdate();</span>
<span class="nc" id="L1280">					int agtOrgId = fetchOrgId(agtOrgName, connection);</span>
					// insert in pwt ticket main table
<span class="nc" id="L1282">					commonFunction.updateTicketInvTable(ticket_nbr, ticketBean</span>
							.getBook_nbr(), ticketBean.getGameNbr(), ticketBean
							.getTicketGameId(), &quot;CLAIM_AGT_TEMP&quot;, userId,
							userOrgId, ticketBean.getUpdateTicketType(),
							agtOrgId, channel, interfaceType, connection);

					// update book status from active to claimed in table
					// st_se_game_inv_status table here
<span class="nc bnc" id="L1290" title="All 2 branches missed.">					if (&quot;ACTIVE&quot;.equalsIgnoreCase(ticketBean.getBookStatus())) {</span>
<span class="nc" id="L1291">						commonFunction.updateBookStatus(ticketBean</span>
								.getTicketGameId(), ticketBean.getBook_nbr(),
								connection, &quot;CLAIMED&quot;);
					}

<span class="nc" id="L1296">					TicketBean bean = new TicketBean();</span>
<span class="nc" id="L1297">					bean.setTicketNumber(ticket_nbr);</span>
<span class="nc" id="L1298">					bean.setValid(isValid);</span>
<span class="nc" id="L1299">					bean.setStatus(&quot;Ticket Is Saved For PWT&quot;);</span>
<span class="nc" id="L1300">					bean.setValidity(&quot;Ticket Is Valid&quot;);</span>
<span class="nc" id="L1301">					savedResults.add(bean);</span>
				}
<span class="nc" id="L1303">			}</span>
<span class="nc" id="L1304">			System.out.println(&quot;SavedTickets List: &quot; + savedResults);</span>
<span class="nc" id="L1305">			return savedResults;</span>
<span class="nc" id="L1306">		} catch (SQLException e) {</span>
			// TODO Auto-generated catch block
<span class="nc" id="L1308">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L1310">			try {</span>
				/*
				 * if (Pstmt != null) Pstmt.close();
				 */
<span class="nc bnc" id="L1314" title="All 6 branches missed.">				if (connection != null) {</span>
<span class="nc" id="L1315">					connection.close();</span>
				}
<span class="nc" id="L1317">			} catch (SQLException e) {</span>
<span class="nc" id="L1318">				e.printStackTrace();</span>
				// throw new LMSException();
<span class="nc" id="L1320">			}</span>
<span class="nc" id="L1321">		}</span>

<span class="nc" id="L1323">		return null;</span>
	}

	// Temporary virn to final receipt

	public void setActiveGameList(List&lt;ActiveGameBean&gt; activeGameList) {
<span class="nc" id="L1329">		this.activeGameList = activeGameList;</span>
<span class="nc" id="L1330">	}</span>

	public void setReceiptNum(String receiptNum) {
<span class="nc" id="L1333">		this.receiptNum = receiptNum;</span>
<span class="nc" id="L1334">	}</span>

	/*
	 * public String getBookNbrFromTicketNo(String ticket_nbr) { String book_nbr =
	 * &quot;&quot;; StringTokenizer st = new StringTokenizer(ticket_nbr, &quot;-&quot;); for (int i =
	 * 0; i &lt; 2; i++) { if (st.hasMoreTokens()) { book_nbr = book_nbr +
	 * st.nextToken(); if (i == 0) { book_nbr = book_nbr + &quot;-&quot;; } } } //
	 * System.out.println(book_nbr); return book_nbr; }
	 */
	public List tmpRcptDetail(String receiptNum) {
<span class="nc" id="L1344">		List tmpRcptList = new ArrayList();</span>
<span class="nc" id="L1345">		Connection connection = null;</span>
<span class="nc" id="L1346">		Statement statement = null;</span>
<span class="nc" id="L1347">		ResultSet resultSet = null;</span>
		try {
<span class="nc" id="L1349">			System.out.println(&quot;inside try............&quot;);</span>
			 
<span class="nc" id="L1351">			connection = DBConnect.getConnection();</span>
<span class="nc" id="L1352">			connection.setAutoCommit(false);</span>
<span class="nc" id="L1353">			statement = connection.createStatement();</span>
<span class="nc" id="L1354">			String tmpPwtDetailquery = &quot;select game_name,user_name,verified_tickets,verified_virn ,generated_id ,final_receipt_num from st_lms_bo_receipts sr right join (select * from (select game_name,user_name,SUM(verified_tickets) as verified_tickets,SUM(verified_virn) as verified_virn ,final_receipt_num from (select game_id,user_id , count(ticket.user_id) as verified_tickets ,0 verified_virn ,final_receipt_num from st_se_tmp_pwt_tickets_inv ticket where receipt_id ='&quot;</span>
					+ receiptNum
					+ &quot;'  group by final_receipt_num,user_id,game_id union select game_id,user_id ,0 as verified_tickets , count(virn.user_id) verified_virn ,final_receipt_num from st_se_tmp_pwt_inv virn where receipt_id ='&quot;
					+ receiptNum
					+ &quot;' group by final_receipt_num,user_id,game_id ) c , st_se_game_master game,st_lms_user_master userm where c.game_id=game.game_id and userm.user_id=c.user_id group by final_receipt_num,c.user_id,c.game_id order by c.game_id)res )rest on sr.receipt_id = rest.final_receipt_num order by generated_id,game_name&quot;;
<span class="nc" id="L1359">			System.out.println(&quot;query  :: ------- &quot; + tmpPwtDetailquery);</span>
			// without final receipt num &quot;select
			// game_name,user_name,SUM(verified_tickets) as
			// verified_tickets,SUM(verified_virn) as verified_virn from (select
			// game_id,user_id , count(ticket.user_id) as verified_tickets ,0
			// verified_virn from st_se_tmp_pwt_tickets_inv ticket where
			// receipt_id =&quot;+receiptNum+&quot; group by user_id,game_id union select
			// game_id,user_id ,0 as verified_tickets , count(virn.user_id)
			// verified_virn from st_se_tmp_pwt_inv virn where receipt_id
			// =&quot;+receiptNum+&quot; group by user_id,game_id ) c , st_se_game_master
			// game,st_lms_user_master userm where c.game_id=game.game_id and
			// userm.user_id=c.user_id group by c.user_id,c.game_id order by
			// c.game_id&quot;
			// with receiptid without join &quot;select
			// game_name,user_name,SUM(verified_tickets) as
			// verified_tickets,SUM(verified_virn) as verified_virn
			// ,final_receipt_num from (select game_id,user_id ,
			// count(ticket.user_id) as verified_tickets ,0 verified_virn
			// ,final_receipt_num from st_se_tmp_pwt_tickets_inv ticket where
			// receipt_id =&quot;+receiptNum+&quot; group by
			// final_receipt_num,user_id,game_id union select game_id,user_id ,0
			// as verified_tickets , count(virn.user_id) verified_virn
			// ,final_receipt_num from st_se_tmp_pwt_inv virn where receipt_id
			// =&quot;+receiptNum+&quot; group by final_receipt_num,user_id,game_id ) c ,
			// st_se_game_master game,st_lms_user_master userm where
			// c.game_id=game.game_id and userm.user_id=c.user_id group by
			// final_receipt_num,c.user_id,c.game_id order by c.game_id&quot;
<span class="nc" id="L1386">			resultSet = statement.executeQuery(tmpPwtDetailquery);</span>
<span class="nc bnc" id="L1387" title="All 2 branches missed.">			while (resultSet.next()) {</span>
<span class="nc" id="L1388">				TmpReceiptDetailBean detailBean = new TmpReceiptDetailBean();</span>
<span class="nc" id="L1389">				detailBean.setGameNum(resultSet.getString(&quot;game_name&quot;));</span>
<span class="nc" id="L1390">				detailBean.setUserName(resultSet.getString(&quot;user_name&quot;));</span>
<span class="nc" id="L1391">				detailBean.setVerifiedTickNum(resultSet</span>
						.getString(&quot;verified_tickets&quot;));
<span class="nc" id="L1393">				detailBean</span>
						.setVerifiedVIRN(resultSet.getString(&quot;verified_virn&quot;));
<span class="nc" id="L1395">				detailBean.setGeneratedId(resultSet.getString(&quot;generated_id&quot;));</span>
<span class="nc" id="L1396">				detailBean.setFinalReceiptNum(resultSet</span>
						.getString(&quot;final_receipt_num&quot;));
<span class="nc" id="L1398">				tmpRcptList.add(detailBean);</span>
<span class="nc" id="L1399">			}</span>
<span class="nc" id="L1400">			System.out.println(&quot;-tmpRcptDetail---Helper--&quot; + tmpRcptList);</span>
			// return tmpRcptList;

<span class="nc" id="L1403">		} catch (SQLException e) {</span>
<span class="nc" id="L1404">			System.out.println(&quot;In Temp Receipt Detail Exception &quot; + e);</span>
			try {
<span class="nc" id="L1406">				connection.rollback();</span>
<span class="nc" id="L1407">			} catch (SQLException e1) {</span>
				// TODO Auto-generated catch block
<span class="nc" id="L1409">				e1.printStackTrace();</span>
<span class="nc" id="L1410">			}</span>
		} finally {

<span class="nc" id="L1413">			try {</span>

<span class="nc bnc" id="L1415" title="All 6 branches missed.">				if (statement != null) {</span>
<span class="nc" id="L1416">					statement.close();</span>
				}
<span class="nc bnc" id="L1418" title="All 6 branches missed.">				if (connection != null) {</span>
<span class="nc" id="L1419">					connection.close();</span>
				}
<span class="nc" id="L1421">			} catch (SQLException se) {</span>
<span class="nc" id="L1422">				se.printStackTrace();</span>
<span class="nc" id="L1423">			}</span>

<span class="nc" id="L1425">		}</span>
<span class="nc" id="L1426">		return tmpRcptList;</span>
	}

	public List tmpRcptSearchRes(String agtOrgName, String receiptNum,
			String fromDate, String toDate) {
<span class="nc" id="L1431">		Connection connection = null;</span>
<span class="nc" id="L1432">		Statement statement = null;</span>
<span class="nc" id="L1433">		ResultSet resultSet = null;</span>

<span class="nc" id="L1435">		List tmpRcptSearchRes = new ArrayList();</span>
<span class="nc" id="L1436">		String whereClause = &quot; &quot;;</span>
		try {
<span class="nc" id="L1438">			whereClause = getWhereClause(agtOrgName, receiptNum, fromDate,</span>
					toDate, &quot;&quot;, &quot;pwtTmp&quot;);
<span class="nc" id="L1440">		} catch (ParseException e2) {</span>
			// TODO Auto-generated catch block
<span class="nc" id="L1442">			e2.printStackTrace();</span>
<span class="nc" id="L1443">		}</span>
<span class="nc" id="L1444">		System.out.println(&quot;Where Clause--&quot; + whereClause);</span>

		try {
			 
<span class="nc" id="L1448">			connection = DBConnect.getConnection();</span>
			// connection.setAutoCommit(false);
<span class="nc" id="L1450">			statement = connection.createStatement();</span>

<span class="nc" id="L1452">			resultSet = statement</span>
					.executeQuery(&quot;select tmpRcpt.receipt_id,name,tmpRcpt.status,tmpRcpt.date_entered from (select receipt_id,status,date_entered,agent_org_id from st_se_tmp_pwt_receipt where &quot;
							+ whereClause
							+ &quot;) tmpRcpt, st_lms_organization_master where organization_id = tmpRcpt.agent_org_id&quot;);

<span class="nc bnc" id="L1457" title="All 2 branches missed.">			while (resultSet.next()) {</span>
<span class="nc" id="L1458">				TmpPwtReceiptBean receiptBean = new TmpPwtReceiptBean();</span>
<span class="nc" id="L1459">				receiptBean.setAgtOrgName(resultSet.getString(&quot;name&quot;));</span>
<span class="nc" id="L1460">				receiptBean.setReceiptId(resultSet.getString(&quot;receipt_id&quot;));</span>
<span class="nc" id="L1461">				receiptBean.setRecievedDate(resultSet.getTimestamp(</span>
						&quot;date_entered&quot;).toString());
<span class="nc" id="L1463">				receiptBean.setStatus(resultSet.getString(&quot;status&quot;));</span>
<span class="nc" id="L1464">				tmpRcptSearchRes.add(receiptBean);</span>
<span class="nc" id="L1465">			}</span>

<span class="nc" id="L1467">			return tmpRcptSearchRes;</span>
<span class="nc" id="L1468">		} catch (SQLException e) {</span>
<span class="nc" id="L1469">			System.out.println(&quot;In PwtVerifyHelper Exception &quot; + e);</span>
			try {
<span class="nc" id="L1471">				connection.rollback();</span>
<span class="nc" id="L1472">			} catch (SQLException e1) {</span>
				// TODO Auto-generated catch block
<span class="nc" id="L1474">				e1.printStackTrace();</span>
<span class="nc" id="L1475">			}</span>
		} finally {

<span class="nc" id="L1478">			try {</span>

<span class="nc bnc" id="L1480" title="All 6 branches missed.">				if (statement != null) {</span>
<span class="nc" id="L1481">					statement.close();</span>
				}
<span class="nc bnc" id="L1483" title="All 6 branches missed.">				if (connection != null) {</span>
<span class="nc" id="L1484">					connection.close();</span>
				}
<span class="nc" id="L1486">			} catch (SQLException se) {</span>
<span class="nc" id="L1487">				se.printStackTrace();</span>
<span class="nc" id="L1488">			}</span>

<span class="nc" id="L1490">		}</span>
<span class="nc" id="L1491">		return null;</span>
	}

	private void updateTempReceiptTables(List verifiedData,
			String autoGeneRecieptNoBO, Connection connection, int userID,
			int userOrgID, String channel, String interfaceType)
			throws SQLException {
<span class="nc" id="L1498">		Statement statementTmpTable = null;</span>

		// StringBuilder virn = new StringBuilder();
<span class="nc" id="L1501">		StringBuilder ticket = new StringBuilder();</span>

<span class="nc" id="L1503">		statementTmpTable = connection.createStatement();</span>

<span class="nc" id="L1505">		System.out.println(&quot;---in updateTempReceiptTables&quot; + verifiedData);</span>
<span class="nc" id="L1506">		ticket.append(((List) verifiedData.get(0)).toString().replace(&quot;[&quot;, &quot;'&quot;)</span>
				.replace(&quot;]&quot;, &quot;'&quot;).replaceAll(&quot;,&quot;, &quot;','&quot;).replaceAll(&quot; &quot;, &quot;&quot;));
<span class="nc" id="L1508">		System.out.println(verifiedData.get(3) + &quot;Buffer---&quot; + ticket);</span>

<span class="nc" id="L1510">		Map virnMap = (Map) verifiedData.get(3);</span>
<span class="nc" id="L1511">		String tmpVirnUpdateQuery = null;</span>

<span class="nc bnc" id="L1513" title="All 2 branches missed.">		for (Integer gameId : (Set&lt;Integer&gt;) virnMap.keySet()) {</span>
<span class="nc" id="L1514">			System.out.println(&quot;Buffer--virn-&quot; + virnMap.get(gameId));</span>
<span class="nc" id="L1515">			tmpVirnUpdateQuery = &quot;update st_se_tmp_pwt_inv set status='CLOSE',final_receipt_num='&quot;</span>
					+ autoGeneRecieptNoBO
					+ &quot;' where virn_code in (&quot;
					+ virnMap.get(gameId).toString()
					+ &quot;) and game_id=&quot;
					+ gameId;
<span class="nc" id="L1521">			System.out.println(&quot;--tmpVirnUpdateQuery-&quot; + tmpVirnUpdateQuery);</span>
<span class="nc" id="L1522">			statementTmpTable.executeUpdate(tmpVirnUpdateQuery);</span>
<span class="nc" id="L1523">		}</span>

		// String tmpVirnUpdateQuery = &quot;update st_se_tmp_pwt_inv set
		// status='CLOSE',final_receipt_num='&quot;+autoGeneRecieptNoBO+&quot;' where
		// virn_code in (&quot;+virn.toString()+&quot;)&quot;;
<span class="nc" id="L1528">		String tmpTicketUpdateQuery = &quot;update st_se_tmp_pwt_tickets_inv set status='CLOSE',final_receipt_num='&quot;</span>
				+ autoGeneRecieptNoBO
				+ &quot;' where ticket_nbr in (&quot;
				+ ticket.toString() + &quot;)&quot;;
<span class="nc" id="L1532">		String insertTmpReceiptMaping = &quot;insert into st_se_tmp_pwt_receipt_mapping values ('&quot;</span>
				+ getReceiptNum() + &quot;','&quot; + autoGeneRecieptNoBO + &quot;')&quot;;

		// System.out.println(&quot;--tmpVirnUpdateQuery-&quot;+tmpVirnUpdateQuery);
<span class="nc" id="L1536">		System.out.println(&quot;--tmpTicketUpdateQuery-&quot; + tmpTicketUpdateQuery);</span>
<span class="nc" id="L1537">		System.out.println(&quot;--insertTmpReceiptMaping--&quot;</span>
				+ insertTmpReceiptMaping);

		// statementTmpTable.executeUpdate(tmpVirnUpdateQuery);
<span class="nc" id="L1541">		statementTmpTable.executeUpdate(tmpTicketUpdateQuery);</span>
<span class="nc" id="L1542">		statementTmpTable.executeUpdate(insertTmpReceiptMaping);</span>

<span class="nc" id="L1544">		String game_nbr = null;</span>
<span class="nc" id="L1545">		ActiveGameBean activeGameBean = null;</span>
<span class="nc" id="L1546">		int game_id = 0;</span>

<span class="nc" id="L1548">		String insertPwtTktQry = null;</span>
<span class="nc" id="L1549">		String updPwtTktQry = null;</span>
<span class="nc" id="L1550">		String tktNbrStr = null;</span>
<span class="nc" id="L1551">		tktNbrStr = ((List) verifiedData.get(0)).toString().replace(&quot;[&quot;, &quot;'&quot;)</span>
				.replace(&quot;]&quot;, &quot;'&quot;).replaceAll(&quot;,&quot;, &quot;','&quot;).replaceAll(&quot; &quot;, &quot;&quot;);
<span class="nc" id="L1553">		Map gameTickNum = (Map) verifiedData.get(2);</span>
<span class="nc" id="L1554">		Iterator itTkt = gameTickNum.entrySet().iterator();</span>
<span class="nc bnc" id="L1555" title="All 2 branches missed.">		while (itTkt.hasNext()) {</span>
<span class="nc" id="L1556">			Map.Entry pairsTkt = (Map.Entry) itTkt.next();</span>
<span class="nc" id="L1557">			game_id = (Integer) pairsTkt.getKey();</span>
<span class="nc" id="L1558">			System.out.println(&quot;Tkt Map--game_id&quot; + game_id);</span>
<span class="nc bnc" id="L1559" title="All 2 branches missed.">			if (activeGameList != null) {</span>
<span class="nc bnc" id="L1560" title="All 2 branches missed.">				for (int i = 0; i &lt; activeGameList.size(); i++) {</span>
<span class="nc" id="L1561">					activeGameBean = activeGameList.get(i);</span>
<span class="nc bnc" id="L1562" title="All 2 branches missed.">					if (game_id == activeGameBean.getGameId()) {</span>
<span class="nc" id="L1563">						game_nbr = activeGameBean.getGameNbr_Name().split(&quot;-&quot;)[0];</span>
<span class="nc" id="L1564">						break;</span>
					}
				}
			}

<span class="nc" id="L1569">			updPwtTktQry = &quot;update st_se_pwt_tickets_inv_&quot;</span>
					+ game_nbr
					+ &quot; aa,  st_se_tmp_pwt_tickets_inv bb set aa.status='CLAIM_AGT', aa.verify_by_user='&quot;
					+ userID
					+ &quot;', aa.verify_by_org='&quot;
					+ userOrgID
					+ &quot;'  where aa.status='CLAIM_AGT_TEMP' and aa.ticket_nbr in (&quot;
					+ tktNbrStr + &quot;) and aa.ticket_nbr = bb.ticket_nbr&quot;;
<span class="nc" id="L1577">			System.out.println(&quot;********PWT Update********&quot; + updPwtTktQry);</span>
<span class="nc" id="L1578">			statementTmpTable.executeUpdate(updPwtTktQry);</span>
			// insertPwtTktQry =&quot;insert into st_se_pwt_tickets_inv_&quot;+game_nbr+&quot;
			// select bb.ticket_nbr, bb.game_id, bb.book_nbr,'CLAIM_AGT' as
			// status ,'&quot;+userID+&quot;' as verify_by_user,'&quot;+userOrgID+&quot;' as
			// verify_by_org from st_se_tmp_pwt_tickets_inv bb where
			// bb.receipt_id='&quot;+receiptNum+&quot;' and bb.game_id=&quot;+game_id+&quot; and
			// bb.ticket_nbr in (&quot;+tktNbrStr+&quot;) and bb.ticket_nbr not in (select
			// ticket_nbr from st_se_pwt_tickets_inv_&quot;+game_nbr+&quot;)&quot;;
<span class="nc" id="L1586">			insertPwtTktQry = &quot;insert into st_se_pwt_tickets_inv_&quot;</span>
					+ game_nbr
					+ &quot; select bb.ticket_nbr, bb.game_id, bb.book_nbr,'CLAIM_AGT' as status ,'&quot;
					+ userID
					+ &quot;' as verify_by_user,'&quot;
					+ userOrgID
					+ &quot;' as verify_by_org,'&quot;
					+ channel
					+ &quot;','&quot;
					+ interfaceType
					+ &quot;',stpr.agent_org_id,stpr.date_entered from st_se_tmp_pwt_tickets_inv bb ,st_se_tmp_pwt_receipt stpr where bb.receipt_id='&quot;
					+ receiptNum
					+ &quot;' and bb.game_id=&quot;
					+ game_id
					+ &quot; and bb.receipt_id=stpr.receipt_id and bb.ticket_nbr in (&quot;
					+ tktNbrStr
					+ &quot;) and bb.ticket_nbr not in (select ticket_nbr from st_se_pwt_tickets_inv_&quot;
					+ game_nbr + &quot;)&quot;;
			// insertPwtTktQry = &quot;insert into st_se_pwt_tickets_inv_&quot;+game_nbr+&quot;
			// select ticket_nbr,game_id,book_nbr,'CLAIM_AGT' as status
			// ,'&quot;+userID+&quot;' as verify_by_user,'&quot;+userOrgID+&quot;'verify_by_org from
			// st_se_tmp_pwt_tickets_inv where receipt_id='&quot;+getReceiptNum()+&quot;'
			// and game_id=&quot;+game_id+&quot; and ticket_nbr in
			// (&quot;+ticket.toString()+&quot;)&quot;;

<span class="nc" id="L1611">			System.out.println(&quot;********PWT Insert********&quot; + insertPwtTktQry);</span>
<span class="nc" id="L1612">			statementTmpTable.executeUpdate(insertPwtTktQry);</span>
<span class="nc" id="L1613">		}</span>

<span class="nc" id="L1615">	}</span>

	public List&lt;TicketBean&gt; updateTicketsStatus(
			List&lt;TicketBean&gt; verifiedTicketList, int userId, int userOrgId,
			int game_id, Connection connection, int agentOrgId, String channel,
			String interfaceType) throws LMSException {

		try {
<span class="nc" id="L1623">			CommonFunctionsHelper commHelper = new CommonFunctionsHelper();</span>
<span class="nc bnc" id="L1624" title="All 2 branches missed.">			for (TicketBean ticketBean : verifiedTicketList) {</span>
<span class="nc bnc" id="L1625" title="All 2 branches missed.">				if (ticketBean.getIsValid()) {</span>
<span class="nc" id="L1626">					commHelper.updateTicketInvTable(ticketBean</span>
							.getTicketNumber(), ticketBean.getTicketNumber()
							.split(&quot;-&quot;)[0]
							+ &quot;-&quot; + ticketBean.getTicketNumber().split(&quot;-&quot;)[1],
							Integer.parseInt(ticketBean.getTicketNumber()
									.split(&quot;-&quot;)[0]), game_id, &quot;CLAIM_AGT&quot;,
							userId, userOrgId, &quot;UPDATE&quot;, agentOrgId, channel,
							interfaceType, connection);

					/*
					 * //update book status from active to claimed in table
					 * st_se_game_inv_status table here
					 * if(&quot;ACTIVE&quot;.equalsIgnoreCase(ticketBean.getBookStatus()))
					 * commHelper.updateBookStatus(ticketBean.getTicketGameId(),
					 * ticketBean.getBook_nbr(), connection, &quot;CLAIMED&quot;);
					 */
				}
<span class="nc" id="L1643">			}</span>
<span class="nc" id="L1644">			connection.commit();</span>
<span class="nc" id="L1645">		} catch (Exception e) {</span>
<span class="nc" id="L1646">			e.printStackTrace();</span>
<span class="nc" id="L1647">			throw new LMSException(e);</span>
<span class="nc" id="L1648">		}</span>
<span class="nc" id="L1649">		return null;</span>
	}

	private boolean verifyPwtTicketsTmpReceipt(int gameId, String[] virnCode,
			List&lt;PwtBean&gt; pwtList, double HighPrizeAmount,
			String highPrizeCriteria, int gameNbr, int agtOrgId)
			throws LMSException {
<span class="nc" id="L1656">		System.out.println(&quot;verify fumction called &quot;);</span>
<span class="nc" id="L1657">		String encodedVirnCode = getEncodedVirnCodeTmpReceipt(virnCode);</span>
<span class="nc" id="L1658">		System.out.println(&quot;---((((((::&quot; + encodedVirnCode);</span>

<span class="nc" id="L1660">		Connection connection = null;</span>
<span class="nc" id="L1661">		Statement statement = null;</span>
<span class="nc" id="L1662">		ResultSet resultSet = null;</span>

<span class="nc" id="L1664">		boolean isVerified = false;</span>
		// int orderId = -1;

<span class="nc bnc" id="L1667" title="All 2 branches missed.">		if (pwtList != null) {</span>
<span class="nc" id="L1668">			int size = pwtList.size();</span>

<span class="nc" id="L1670">			PwtBean pwtBean = null;</span>

<span class="nc" id="L1672">			StringBuffer query = new StringBuffer();</span>

<span class="nc bnc" id="L1674" title="All 2 branches missed.">			if (size &gt; 0) {</span>
				try {
					 
<span class="nc" id="L1677">					connection = DBConnect.getConnection();</span>

<span class="nc" id="L1679">					statement = connection.createStatement();</span>
<span class="nc" id="L1680">					query.append(QueryManager.getST1PWTBOCheckQuery());</span>
<span class="nc" id="L1681">					query.append(&quot; st_se_pwt_inv_&quot; + gameNbr + &quot; where &quot;);</span>
<span class="nc" id="L1682">					query.append(&quot;  game_id = &quot;);</span>
<span class="nc" id="L1683">					query.append(&quot;&quot; + gameId);</span>
<span class="nc" id="L1684">					query.append(&quot; and virn_code in (&quot;);</span>
<span class="nc" id="L1685">					query.append(encodedVirnCode);</span>
<span class="nc" id="L1686">					query.append(&quot;)&quot;);</span>

<span class="nc" id="L1688">					System.out.println(&quot;GameId:&quot; + gameId);</span>
<span class="nc" id="L1689">					System.out.println(&quot;Query:: &quot; + query);</span>
<span class="nc" id="L1690">					resultSet = statement.executeQuery(query.toString());</span>
<span class="nc" id="L1691">					System.out.println(&quot;ResultSet:&quot; + resultSet + &quot;---&quot;</span>
							+ resultSet.getFetchSize());

<span class="nc" id="L1694">					String vCode = null;</span>
<span class="nc" id="L1695">					String pwtAmount = null;</span>
<span class="nc" id="L1696">					String enVirnCode = null;</span>
<span class="nc" id="L1697">					String prizeStatus = null;</span>

<span class="nc bnc" id="L1699" title="All 2 branches missed.">					while (resultSet.next()) {</span>

<span class="nc" id="L1701">						vCode = resultSet</span>
								.getString(TableConstants.SPI_VIRN_CODE);
<span class="nc" id="L1703">						System.out.println(&quot;Vcode:&quot; + vCode);</span>
<span class="nc" id="L1704">						pwtAmount = resultSet</span>
								.getString(TableConstants.SPI_PWT_AMT);
<span class="nc" id="L1706">						prizeStatus = resultSet.getString(&quot;status&quot;);</span>

<span class="nc bnc" id="L1708" title="All 2 branches missed.">						for (int j = 0; j &lt; pwtList.size(); j++) {</span>
<span class="nc" id="L1709">							pwtBean = (PwtBean) pwtList.get(j);</span>
<span class="nc" id="L1710">							enVirnCode = pwtBean.getVirnCode();</span>
<span class="nc bnc" id="L1711" title="All 2 branches missed.">							if (enVirnCode.equals(vCode)) {</span>
<span class="nc bnc" id="L1712" title="All 2 branches missed.">								if (prizeStatus</span>
										.equalsIgnoreCase(&quot;CLAIM_AGT_TEMP&quot;)) {
<span class="nc" id="L1714">									isVerified = true;</span>
<span class="nc" id="L1715">									pwtBean.setValid(true);</span>
<span class="nc" id="L1716">									pwtBean.setPwtAmount(pwtAmount);</span>
<span class="nc" id="L1717">									pwtBean</span>
											.setMessage(&quot;AAlready Verified in Bulk Receipt at BO, Fianl Payment Pending&quot;);
<span class="nc" id="L1719">									pwtBean.setMessageCode(&quot;112001&quot;);</span>
<span class="nc" id="L1720">									break;</span>
<span class="nc bnc" id="L1721" title="All 2 branches missed.">								} else if (prizeStatus</span>
										.equalsIgnoreCase(&quot;MISSING&quot;)) {
<span class="nc" id="L1723">									pwtBean.setValid(false);</span>
<span class="nc" id="L1724">									pwtBean</span>
											.setVerificationStatus(&quot;InValid Virn&quot;);
<span class="nc" id="L1726">									pwtBean</span>
											.setMessage(&quot;VIRN is from MISSING Status&quot;);
<span class="nc" id="L1728">									pwtBean.setMessageCode(&quot;&quot;);</span>

<span class="nc bnc" id="L1730" title="All 2 branches missed.">								} else if (prizeStatus</span>
										.equalsIgnoreCase(&quot;CLAIM_RET_AGT_TEMP&quot;)) {
<span class="nc" id="L1732">									isVerified = true;</span>
<span class="nc" id="L1733">									pwtBean.setValid(true);</span>
<span class="nc" id="L1734">									pwtBean.setPwtAmount(pwtAmount);</span>
<span class="nc" id="L1735">									pwtBean.setInUnclmed(&quot;IN_AGENT_UNCLM&quot;);</span>
<span class="nc" id="L1736">									pwtBean</span>
											.setMessage(&quot;AAlready Verified in Bulk Receipt at BO as unclaimed, Fianl Payment Pending&quot;);
<span class="nc" id="L1738">									pwtBean.setMessageCode(&quot;112001&quot;);</span>
<span class="nc" id="L1739">									break;</span>
<span class="nc bnc" id="L1740" title="All 2 branches missed.">								} else if (prizeStatus</span>
										.equalsIgnoreCase(&quot;CLAIM_PLR_AGT_TEMP&quot;)) {
<span class="nc" id="L1742">									isVerified = true;</span>
<span class="nc" id="L1743">									pwtBean.setValid(true);</span>
<span class="nc" id="L1744">									pwtBean.setPwtAmount(pwtAmount);</span>
<span class="nc" id="L1745">									pwtBean.setInUnclmed(&quot;IN_PLR_UNCLM&quot;);</span>
<span class="nc" id="L1746">									pwtBean</span>
											.setMessage(&quot;AAlready Verified in Bulk Receipt at BO as unclaimed, Fianl Payment Pending&quot;);
<span class="nc" id="L1748">									pwtBean.setMessageCode(&quot;112001&quot;);</span>
<span class="nc" id="L1749">									break;</span>
								} else {
									// shoot a mail
<span class="nc" id="L1752">									System.out</span>
											.println(&quot;undefined status for VIRN at the time of Final receipt generation virn number is  &quot;
													+ enVirnCode);
<span class="nc" id="L1755">									CommonMethods</span>
											.sendMail(&quot;ERROR :::: undefined status for VIRN at the time of Final receipt generation  or  virn status is modified manually for VIRN Number&quot;
													+ enVirnCode
													+ &quot;Expected status are CLAIM_AGT_TEMP ,CLAIM_RET_AGT_TEMP,CLAIM_PLR_AGT_TEMP&quot;);
<span class="nc" id="L1759">									throw new LMSException(</span>
											&quot;ERROR :::: undefined status for VIRN at the time of Final receipt generation  or  virn status is modified manually for VIRN Number&quot;
													+ enVirnCode
													+ &quot;Expected status are CLAIM_AGT_TEMP ,CLAIM_RET_AGT_TEMP,CLAIM_PLR_AGT_TEMP&quot;);
								}
							}
						}
					}

<span class="nc" id="L1768">				} catch (SQLException e) {</span>
<span class="nc" id="L1769">					e.printStackTrace();</span>
<span class="nc" id="L1770">					throw new LMSException(e);</span>
				} finally {
<span class="nc" id="L1772">					try {</span>
<span class="nc bnc" id="L1773" title="All 4 branches missed.">						if (statement != null) {</span>
<span class="nc" id="L1774">							statement.close();</span>
						}
<span class="nc bnc" id="L1776" title="All 4 branches missed.">						if (connection != null) {</span>
<span class="nc" id="L1777">							connection.close();</span>
						}
<span class="nc" id="L1779">					} catch (SQLException se) {</span>
<span class="nc" id="L1780">						se.printStackTrace();</span>
<span class="nc" id="L1781">					}</span>
<span class="nc" id="L1782">				}</span>

			}
		}
<span class="nc" id="L1786">		return isVerified;</span>

	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>