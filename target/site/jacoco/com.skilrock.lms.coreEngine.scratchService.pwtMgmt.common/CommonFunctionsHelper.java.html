<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CommonFunctionsHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lms</a> &gt; <a href="index.source.html" class="el_package">com.skilrock.lms.coreEngine.scratchService.pwtMgmt.common</a> &gt; <span class="el_source">CommonFunctionsHelper.java</span></div><h1>CommonFunctionsHelper.java</h1><pre class="source lang-java linenums">package com.skilrock.lms.coreEngine.scratchService.pwtMgmt.common;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.sql.Timestamp;
import java.text.DateFormat;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.TreeMap;

import com.skilrock.lms.beans.ClmDrawSaleBean;
import com.skilrock.lms.beans.ClmPwtBean;
import com.skilrock.lms.beans.OrgPwtLimitBean;
import com.skilrock.lms.beans.PlayerPWTBean;
import com.skilrock.lms.beans.PwtBean;
import com.skilrock.lms.beans.TicketBean;
import com.skilrock.lms.common.db.DBConnect;
import com.skilrock.lms.common.db.QueryManager;
import com.skilrock.lms.common.exception.LMSException;
import com.skilrock.lms.common.exception.handler.LMSExceptionInterceptor;
import com.skilrock.lms.common.utility.GameUtilityHelper;
import com.skilrock.lms.common.utility.GenerateRecieptNo;
import com.skilrock.lms.common.utility.MD5Encoder;
import com.skilrock.lms.common.utility.MailSend;
import com.skilrock.lms.common.utility.OrgCreditUpdation;
import com.skilrock.lms.coreEngine.reportsMgmt.common.GraphReportHelper;
import com.skilrock.lms.coreEngine.scratchService.common.ScratchErrors;
import com.skilrock.lms.coreEngine.scratchService.common.ScratchException;
import com.skilrock.lms.rest.services.bean.DaoBean;
import com.skilrock.lms.web.drawGames.common.Util;

<span class="fc" id="L40">public class CommonFunctionsHelper {</span>
	
	private PreparedStatement pstmt;
	private ResultSet result;

	// common method for all organization to get the organizations various
	// limits
	public OrgPwtLimitBean fetchPwtLimitsOfOrgnization(int organizationId,
			Connection connection) throws SQLException {
<span class="nc" id="L49">		OrgPwtLimitBean bean = null;</span>
<span class="nc" id="L50">		String query = &quot;select aa.organization_id, verification_limit, approval_limit, pay_limit, scrap_limit, bb.pwt_scrap from st_lms_oranization_limits aa, st_lms_organization_master bb where  aa.organization_id = bb.organization_id and  aa.organization_id = ?&quot;;</span>
<span class="nc" id="L51">		pstmt = connection.prepareStatement(query);</span>
<span class="nc" id="L52">		pstmt.setInt(1, organizationId);</span>
<span class="nc" id="L53">		result = pstmt.executeQuery();</span>
<span class="nc" id="L54">		System.out.println(&quot;query that fetch limit details = &quot; + pstmt);</span>
<span class="nc bnc" id="L55" title="All 2 branches missed.">		if (result.next()) {</span>
<span class="nc" id="L56">			bean = new OrgPwtLimitBean();</span>
<span class="nc" id="L57">			bean.setOrganizationId(organizationId);</span>
<span class="nc" id="L58">			bean.setVerificationLimit(result.getDouble(&quot;verification_limit&quot;));</span>
<span class="nc" id="L59">			bean.setApprovalLimit(result.getDouble(&quot;approval_limit&quot;));</span>
<span class="nc" id="L60">			bean.setPayLimit(result.getDouble(&quot;pay_limit&quot;));</span>
<span class="nc" id="L61">			bean.setScrapLimit(result.getDouble(&quot;scrap_limit&quot;));</span>
<span class="nc" id="L62">			bean.setIsPwtAutoScrap(result.getString(&quot;pwt_scrap&quot;));</span>
		}
<span class="nc" id="L64">		return bean;</span>
	}

	public TicketBean isTicketFormatValid(String ticketNbr, int gameId,
			Connection connection) throws SQLException {
<span class="nc" id="L69">		TicketBean bean = new TicketBean();</span>
<span class="nc" id="L70">		String getTicketFormatQuery = QueryManager</span>
				.getST4GameTicketDetailsUsingGameId();
<span class="nc" id="L72">		pstmt = connection.prepareStatement(getTicketFormatQuery);</span>
<span class="nc" id="L73">		pstmt.setInt(1, gameId);</span>
<span class="nc" id="L74">		result = pstmt.executeQuery();</span>
<span class="nc" id="L75">		System.out.println(&quot;getTicketFormatQuery = &quot; + pstmt);</span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">		if (result.next()) {</span>
<span class="nc" id="L77">			int noOfTktPerBook = result.getInt(&quot;nbr_of_tickets_per_book&quot;);</span>
<span class="nc" id="L78">			int tktNoDigit = result.getInt(&quot;ticket_nbr_digits&quot;);</span>
<span class="nc" id="L79">			int gameNbrDigits = result.getInt(&quot;game_nbr_digits&quot;);</span>
<span class="nc" id="L80">			int packNbrDigits = result.getInt(&quot;pack_nbr_digits&quot;);</span>
<span class="nc" id="L81">			int bookNbrDigits = result.getInt(&quot;book_nbr_digits&quot;);</span>

<span class="nc bnc" id="L83" title="All 4 branches missed.">			if ((ticketNbr.indexOf(&quot;-&quot;) == -1)</span>
					&amp;&amp; (ticketNbr.length() == (gameNbrDigits + packNbrDigits
							+ bookNbrDigits + tktNoDigit))) {
<span class="nc" id="L86">				ticketNbr = ticketNbr.substring(0, gameNbrDigits) + &quot;-&quot;</span>
						+ ticketNbr.substring(gameNbrDigits);
<span class="nc" id="L88">				ticketNbr = ticketNbr.substring(0, gameNbrDigits</span>
						+ packNbrDigits + bookNbrDigits + 1)
						+ &quot;-&quot;
						+ ticketNbr.substring(gameNbrDigits + packNbrDigits
								+ bookNbrDigits + 1);
<span class="nc bnc" id="L93" title="All 2 branches missed.">			} else if (ticketNbr.split(&quot;-&quot;).length &lt; 3) {</span>
<span class="nc" id="L94">				bean.setValid(false);</span>
<span class="nc" id="L95">				bean.setStatus(&quot;Number Format Error/Out of Range Please Check&quot;);</span>
<span class="nc" id="L96">				bean.setMessageCode(&quot;221001&quot;);</span>
<span class="nc" id="L97">				bean.setValidity(&quot;InValid Ticket&quot;);</span>
<span class="nc" id="L98">				bean.setTicketNumber(ticketNbr);</span>
<span class="nc" id="L99">				System.out</span>
						.println(&quot;Ticket number is fake or not in valid format.&quot;);
<span class="nc" id="L101">				return bean;</span>
			}

<span class="nc" id="L104">			String tktArr[] = ticketNbr.split(&quot;-&quot;);</span>
<span class="nc bnc" id="L105" title="All 6 branches missed.">			if (noOfTktPerBook &lt; Integer.parseInt(tktArr[2])</span>
					|| (Integer.parseInt(tktArr[2]) == 0)
					|| (tktNoDigit != tktArr[2].length())) {
<span class="nc" id="L108">				bean.setValid(false);</span>
<span class="nc" id="L109">				bean.setStatus(&quot;Number Format Error/Out of Range Please Check&quot;);</span>
<span class="nc" id="L110">				bean.setMessageCode(&quot;222001&quot;);</span>
<span class="nc" id="L111">				bean.setValidity(&quot;InValid Ticket&quot;);</span>
<span class="nc" id="L112">				bean.setTicketNumber(ticketNbr);</span>
<span class="nc" id="L113">				System.out.println(&quot;Ticket number is fake or not in valid format.&quot;);</span>
<span class="nc" id="L114">				return bean;</span>
			}
<span class="nc" id="L116">			bean.setValid(true);</span>
<span class="nc" id="L117">			bean.setTicketNumber(ticketNbr);</span>
			// System.out.println(&quot;Ticket Format is Valid.&quot;);

<span class="nc" id="L120">		} else {</span>
<span class="nc" id="L121">			bean.setValid(false);</span>
<span class="nc" id="L122">			bean.setStatus(&quot;Game Not Found.&quot;);</span>
<span class="nc" id="L123">			bean.setMessageCode(&quot;221001&quot;);</span>
<span class="nc" id="L124">			bean.setValidity(&quot;InValid Ticket&quot;);</span>
<span class="nc" id="L125">			bean.setTicketNumber(ticketNbr);</span>
<span class="nc" id="L126">			System.out.println(&quot;Ticket IS Not valid for pwt. (Game Not found. Here query not return any result)&quot;);</span>
		}
<span class="nc" id="L128">		result.close();</span>
<span class="nc" id="L129">		pstmt.close();</span>
<span class="nc" id="L130">		return bean;</span>
	}
	
	public TicketBean isBookNbrFormatValid(String bookNbr,int gameNbr) throws SQLException {
<span class="nc" id="L134">		Connection con = null;</span>
<span class="nc" id="L135">		con = DBConnect.getConnection();</span>
<span class="nc" id="L136">		TicketBean bean = null;</span>
<span class="nc" id="L137">		String getBookFormatQuery = &quot;select  b.pack_nbr_digits, &quot;</span>
				+ &quot; b.book_nbr_digits, b.game_nbr_digits, game_virn_digits, game_rank_digits, a.game_id  from st_se_game_master a, &quot;
				+ &quot; st_se_game_ticket_nbr_format b where a.game_nbr=? and a.game_id=b.game_id&quot;;
<span class="nc" id="L140">		pstmt = con.prepareStatement(getBookFormatQuery);</span>
<span class="nc" id="L141">		pstmt.setInt(1, gameNbr);</span>
<span class="nc" id="L142">		result = pstmt.executeQuery();</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">		if (result.next()) {</span>
<span class="nc" id="L144">			int gameNbrDigits = result.getInt(&quot;game_nbr_digits&quot;);</span>
<span class="nc" id="L145">			int packNbrDigits = result.getInt(&quot;pack_nbr_digits&quot;);</span>
<span class="nc" id="L146">			int bookNbrDigits = result.getInt(&quot;book_nbr_digits&quot;);</span>
<span class="nc" id="L147">			int gameId = result.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L148">			bean = new TicketBean();</span>
<span class="nc bnc" id="L149" title="All 4 branches missed.">			if ((bookNbr.indexOf(&quot;-&quot;) == -1)</span>
					&amp;&amp; (bookNbr.length() == (gameNbrDigits + packNbrDigits + bookNbrDigits))) {
<span class="nc" id="L151">				bookNbr = bookNbr.substring(0, gameNbrDigits) + &quot;-&quot;</span>
						+ bookNbr.substring(gameNbrDigits);
<span class="nc" id="L153">				bean.setValid(true);</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">			} else if (bookNbr.split(&quot;-&quot;).length &lt; 3) {</span>
<span class="nc" id="L155">				bean.setValid(false);</span>
<span class="nc" id="L156">				bean.setStatus(&quot;Number Format Error/Out of Range Please Check&quot;);</span>
<span class="nc" id="L157">				bean.setMessageCode(&quot;221001&quot;);</span>
<span class="nc" id="L158">				bean.setValidity(&quot;InValid Ticket&quot;);</span>
<span class="nc" id="L159">				System.out.println(&quot;Ticket number is fake or not in valid format.&quot;);</span>
			}
<span class="nc" id="L161">			bean.setTicketGameId(gameId);</span>
<span class="nc" id="L162">			bean.setBook_nbr(bookNbr);</span>
<span class="nc" id="L163">		} else {</span>
<span class="nc" id="L164">			bean = new TicketBean();</span>
<span class="nc" id="L165">			bean.setBook_nbr(bookNbr);</span>
<span class="nc" id="L166">			bean.setValid(false);</span>
<span class="nc" id="L167">			bean.setStatus(&quot;Game Not Found.&quot;);</span>
<span class="nc" id="L168">			bean.setMessageCode(&quot;221001&quot;);</span>
<span class="nc" id="L169">			bean.setValidity(&quot;InValid Book&quot;);</span>
<span class="nc" id="L170">			System.out.println(&quot;Book Nbr IS Not valid. (Game Not found. Here query not return any result)&quot;);</span>
		}
<span class="nc" id="L172">		result.close();</span>
<span class="nc" id="L173">		pstmt.close();</span>
<span class="nc" id="L174">		con.close();</span>
<span class="nc" id="L175">		return bean;</span>
	}

	public List&lt;TicketBean&gt; isTicketFormatValid(List&lt;String&gt; ticketNbrList,
			int gameNbr, Connection connection) throws SQLException {
<span class="nc" id="L180">		List&lt;TicketBean&gt; tktBeanList = new ArrayList&lt;TicketBean&gt;();</span>
<span class="nc" id="L181">		TicketBean bean = new TicketBean();</span>
<span class="nc" id="L182">		String getTicketFormatQuery = &quot;select a.nbr_of_tickets_per_book, b.ticket_nbr_digits, b.pack_nbr_digits, &quot;</span>
				+ &quot; b.book_nbr_digits, b.game_nbr_digits, game_virn_digits, game_rank_digits, a.game_id  from st_se_game_master a, &quot;
				+ &quot; st_se_game_ticket_nbr_format b where a.game_nbr=? and a.game_id=b.game_id&quot;;
<span class="nc" id="L185">		pstmt = connection.prepareStatement(getTicketFormatQuery);</span>
<span class="nc" id="L186">		pstmt.setInt(1, gameNbr);</span>
<span class="nc" id="L187">		result = pstmt.executeQuery();</span>
		// System.out.println(&quot;getTicketFormatQuery = &quot; + pstmt);
<span class="nc bnc" id="L189" title="All 2 branches missed.">		if (result.next()) {</span>
<span class="nc" id="L190">			int noOfTktPerBook = result.getInt(&quot;nbr_of_tickets_per_book&quot;);</span>
<span class="nc" id="L191">			int tktNoDigit = result.getInt(&quot;ticket_nbr_digits&quot;);</span>
<span class="nc" id="L192">			int gameNbrDigits = result.getInt(&quot;game_nbr_digits&quot;);</span>
<span class="nc" id="L193">			int packNbrDigits = result.getInt(&quot;pack_nbr_digits&quot;);</span>
<span class="nc" id="L194">			int bookNbrDigits = result.getInt(&quot;book_nbr_digits&quot;);</span>
<span class="nc" id="L195">			int gameId = result.getInt(&quot;game_id&quot;);</span>

<span class="nc bnc" id="L197" title="All 2 branches missed.">			for (String ticketNbr : ticketNbrList) {</span>
<span class="nc" id="L198">				bean = new TicketBean();</span>
<span class="nc bnc" id="L199" title="All 4 branches missed.">				if ((ticketNbr.indexOf(&quot;-&quot;) == -1)</span>
						&amp;&amp; (ticketNbr.length() == (gameNbrDigits
								+ packNbrDigits + bookNbrDigits + tktNoDigit))) {
<span class="nc" id="L202">					ticketNbr = ticketNbr.substring(0, gameNbrDigits) + &quot;-&quot;</span>
							+ ticketNbr.substring(gameNbrDigits);
<span class="nc" id="L204">					ticketNbr = ticketNbr.substring(0, gameNbrDigits</span>
							+ packNbrDigits + bookNbrDigits + 1)
							+ &quot;-&quot;
							+ ticketNbr.substring(gameNbrDigits + packNbrDigits
									+ bookNbrDigits + 1);
<span class="nc bnc" id="L209" title="All 2 branches missed.">				} else if (ticketNbr.split(&quot;-&quot;).length &lt; 3) {</span>
<span class="nc" id="L210">					bean.setValid(false);</span>
<span class="nc" id="L211">					bean.setTicketGameId(gameId);</span>
<span class="nc" id="L212">					bean.setTicketNumber(ticketNbr);// added by yogesh</span>
<span class="nc" id="L213">					bean</span>
							.setStatus(&quot;Number Format Error/Out of Range Please Check&quot;);
<span class="nc" id="L215">					bean.setMessageCode(&quot;221001&quot;);</span>
<span class="nc" id="L216">					bean.setValidity(&quot;InValid Ticket&quot;);</span>
<span class="nc" id="L217">					System.out</span>
							.println(&quot;Ticket number is fake or not in valid format.&quot;);
<span class="nc" id="L219">					tktBeanList.add(bean);</span>
<span class="nc" id="L220">					continue;</span>
				}

<span class="nc" id="L223">				String tktArr[] = ticketNbr.split(&quot;-&quot;);</span>
<span class="nc bnc" id="L224" title="All 6 branches missed.">				if (noOfTktPerBook &lt; Integer.parseInt(tktArr[2])</span>
						|| (Integer.parseInt(tktArr[2]) == 0)
						|| (tktNoDigit != tktArr[2].length())) {
<span class="nc" id="L227">					bean.setValid(false);</span>
<span class="nc" id="L228">					bean.setTicketGameId(gameId);</span>
<span class="nc" id="L229">					bean.setTicketNumber(ticketNbr);// added by yogesh</span>
<span class="nc" id="L230">					bean</span>
							.setStatus(&quot;Number Format Error/Out of Range Please Check&quot;);
<span class="nc" id="L232">					bean.setMessageCode(&quot;222001&quot;);</span>
<span class="nc" id="L233">					bean.setValidity(&quot;InValid Ticket&quot;);</span>
<span class="nc" id="L234">					System.out</span>
							.println(&quot;Ticket number is fake or not in valid format.&quot;);
<span class="nc" id="L236">					tktBeanList.add(bean);</span>
<span class="nc" id="L237">					continue;</span>
				}
<span class="nc" id="L239">				bean.setValid(true);</span>
<span class="nc" id="L240">				bean.setTicketGameId(gameId);</span>
<span class="nc" id="L241">				bean.setTicketNumber(ticketNbr);</span>
<span class="nc" id="L242">				tktBeanList.add(bean);</span>
				// System.out.println(&quot;Ticket Format is Valid.&quot;);
<span class="nc" id="L244">			}</span>

<span class="nc" id="L246">		} else {</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">			for (String ticketNbr : ticketNbrList) {</span>
<span class="nc" id="L248">				bean = new TicketBean();</span>
<span class="nc" id="L249">				bean.setTicketNumber(ticketNbr);</span>
<span class="nc" id="L250">				bean.setValid(false);</span>
<span class="nc" id="L251">				bean.setStatus(&quot;Game Not Found.&quot;);</span>
<span class="nc" id="L252">				bean.setMessageCode(&quot;221001&quot;);</span>
<span class="nc" id="L253">				bean.setValidity(&quot;InValid Ticket&quot;);</span>
<span class="nc" id="L254">				tktBeanList.add(bean);</span>
<span class="nc" id="L255">				System.out</span>
						.println(&quot;Ticket IS Not valid for pwt. (Game Not found. Here query not return any result)&quot;);
<span class="nc" id="L257">			}</span>
		}
<span class="nc" id="L259">		result.close();</span>
<span class="nc" id="L260">		pstmt.close();</span>
<span class="nc" id="L261">		return tktBeanList;</span>
	}

	public int updateTicketInvTable(String tktNo, String bookNo, int gameNbr,
			int gameId, String status, int userId, int userOrgId,
			String updateType, int partyOrgId, String channel,
			String interfaceType, Connection connection) throws SQLException,
			LMSException {

<span class="nc" id="L270">		int tktRow = 0;</span>
		// updated by yogesh now not to execute select query

<span class="nc bnc" id="L273" title="All 2 branches missed.">		if (&quot;update&quot;.equalsIgnoreCase(updateType)) { // ticket already exist</span>
			// in st_pwt_tickets_inv
			// table
<span class="nc" id="L276">			String updateTktInvQuery = &quot;update st_se_pwt_tickets_inv_? set status = ?, verify_by_user=?, verify_by_org=?, channel = ?, interface = ?, party_org_id = ?, date = ?  where game_id = ? and ticket_nbr = ?&quot;;</span>
<span class="nc" id="L277">			PreparedStatement upTktInvPstmt = connection</span>
					.prepareStatement(updateTktInvQuery);
<span class="nc" id="L279">			upTktInvPstmt.setInt(1, gameNbr);</span>
<span class="nc" id="L280">			upTktInvPstmt.setString(2, status);</span>
<span class="nc" id="L281">			upTktInvPstmt.setInt(3, userId);</span>
<span class="nc" id="L282">			upTktInvPstmt.setInt(4, userOrgId);</span>
<span class="nc" id="L283">			upTktInvPstmt.setString(5, channel);</span>
<span class="nc" id="L284">			upTktInvPstmt.setString(6, interfaceType);</span>
<span class="nc" id="L285">			upTktInvPstmt.setInt(7, partyOrgId);</span>
<span class="nc" id="L286">			upTktInvPstmt.setTimestamp(8, new Timestamp(new java.util.Date()</span>
					.getTime()));
<span class="nc" id="L288">			upTktInvPstmt.setInt(9, gameId);</span>
<span class="nc" id="L289">			upTktInvPstmt.setString(10, tktNo);</span>
<span class="nc" id="L290">			tktRow = upTktInvPstmt.executeUpdate();</span>
<span class="nc" id="L291">			System.out.println(&quot;total row = &quot; + tktRow</span>
					+ &quot;   ,update ticket inventory status table = &quot;
					+ upTktInvPstmt);
<span class="nc bnc" id="L294" title="All 2 branches missed.">			if (tktRow &lt; 1)</span>
<span class="nc" id="L295">				throw new LMSException(&quot;ticket Number &quot; + tktNo</span>
						+ &quot; status not updated in st_pwt_tickets_inv table.&quot;);
<span class="nc bnc" id="L297" title="All 2 branches missed.">			if (tktRow &gt; 1) {</span>
<span class="nc" id="L298">				LMSExceptionInterceptor.sendMail(&quot;Ticket Number &quot; + tktNo</span>
						+ &quot;is duplicate in DATABASE&quot;);
<span class="nc" id="L300">				throw new LMSException(&quot;Ticket Number &quot; + tktNo</span>
						+ &quot;is duplicate in DATABASE&quot;);
			}
<span class="nc bnc" id="L303" title="All 2 branches missed.">		} else if (&quot;insert&quot;.equalsIgnoreCase(updateType)) { // if ticket not</span>
			// exist in
			// st_pwt_tickets_inv
			// table
<span class="nc" id="L307">			String updateTktInvQuery = &quot;insert into  st_se_pwt_tickets_inv_? ( ticket_nbr , game_id , book_nbr , status , verify_by_user , verify_by_org, channel, interface, party_org_id, date ) values (?,?,?,?,?,?,?,?,?,?)&quot;;</span>
<span class="nc" id="L308">			PreparedStatement inTktInvPstmt = connection</span>
					.prepareStatement(updateTktInvQuery);
<span class="nc" id="L310">			inTktInvPstmt.setInt(1, gameNbr);</span>
<span class="nc" id="L311">			inTktInvPstmt.setString(2, tktNo);</span>
<span class="nc" id="L312">			inTktInvPstmt.setInt(3, gameId);</span>
<span class="nc" id="L313">			inTktInvPstmt.setString(4, bookNo);</span>
<span class="nc" id="L314">			inTktInvPstmt.setString(5, status);</span>
<span class="nc" id="L315">			inTktInvPstmt.setInt(6, userId);</span>
<span class="nc" id="L316">			inTktInvPstmt.setInt(7, userOrgId);</span>
<span class="nc" id="L317">			inTktInvPstmt.setString(8, channel);</span>
<span class="nc" id="L318">			inTktInvPstmt.setString(9, interfaceType);</span>
<span class="nc" id="L319">			inTktInvPstmt.setInt(10, partyOrgId);</span>
<span class="nc" id="L320">			inTktInvPstmt.setTimestamp(11, new Timestamp(new java.util.Date()</span>
					.getTime()));
<span class="nc" id="L322">			tktRow = inTktInvPstmt.executeUpdate();</span>
<span class="nc" id="L323">			System.out.println(&quot;total row = &quot; + tktRow</span>
					+ &quot;   ,insert ticket inventory details into table = &quot;
					+ inTktInvPstmt);
<span class="nc bnc" id="L326" title="All 2 branches missed.">			if (tktRow &lt; 1)</span>
<span class="nc" id="L327">				throw new LMSException(&quot;ticket Number &quot; + tktNo</span>
						+ &quot; is not inserted in st_pwt_tickets_inv table.&quot;);
<span class="nc bnc" id="L329" title="All 2 branches missed.">		} else if (&quot;delete&quot;.equalsIgnoreCase(updateType)) { // in case of ticket</span>
			// temporary
			// cancellation
<span class="nc" id="L332">			String updateTktInvQuery = &quot;delete from st_se_pwt_tickets_inv_? where game_id=? and ticket_nbr=? &quot;;</span>
<span class="nc" id="L333">			PreparedStatement inTktInvPstmt = connection</span>
					.prepareStatement(updateTktInvQuery);
<span class="nc" id="L335">			inTktInvPstmt.setInt(1, gameNbr);</span>
<span class="nc" id="L336">			inTktInvPstmt.setInt(2, gameId);</span>
<span class="nc" id="L337">			inTktInvPstmt.setString(3, tktNo);</span>
<span class="nc" id="L338">			tktRow = inTktInvPstmt.executeUpdate();</span>
<span class="nc" id="L339">			System.out.println(&quot;total row = &quot; + tktRow</span>
					+ &quot;   ,delete form ticket inventory  table = &quot;
					+ inTktInvPstmt);
<span class="nc bnc" id="L342" title="All 2 branches missed.">			if (tktRow &lt; 1)</span>
<span class="nc" id="L343">				throw new LMSException(&quot;ticket Number &quot; + tktNo</span>
						+ &quot; is not deleted from st_pwt_tickets_inv table.&quot;);
<span class="nc" id="L345">		} else {</span>
<span class="nc" id="L346">			throw new LMSException(</span>
					&quot;Exception occured while updating ticket inventory table updation type is :: &quot;
							+ updateType);
		}

<span class="nc" id="L351">		return tktRow;</span>

	}

	public Boolean updateVirnStatus(int gameNbr, String pwtStatus, int gameId,
			String encVirnCode, Connection con,String entktNbr) throws SQLException,
			LMSException {
<span class="nc" id="L358">		String updateVirnInvQuery = &quot;update st_se_pwt_inv_? set status = ? where game_id = ? and virn_code = ? and id1=?&quot;;</span>
<span class="nc" id="L359">		PreparedStatement invPstmt = con.prepareStatement(updateVirnInvQuery);</span>
<span class="nc" id="L360">		invPstmt.setInt(1, gameNbr);</span>
<span class="nc" id="L361">		invPstmt.setString(2, pwtStatus);</span>
<span class="nc" id="L362">		invPstmt.setInt(3, gameId);</span>
<span class="nc" id="L363">		invPstmt.setString(4, encVirnCode);</span>
<span class="nc" id="L364">		invPstmt.setString(5, entktNbr);</span>
<span class="nc" id="L365">		int virnRow = invPstmt.executeUpdate();</span>
<span class="nc" id="L366">		System.out.println(&quot;total row = &quot; + virnRow</span>
				+ &quot;   ,update ticket inventory status table = &quot; + invPstmt);
<span class="nc bnc" id="L368" title="All 2 branches missed.">		if (virnRow &lt; 1)</span>
<span class="nc" id="L369">			throw new LMSException(</span>
					&quot;update ticket inventory status table not updated.&quot;);
<span class="nc bnc" id="L371" title="All 2 branches missed.">		return (virnRow &gt; 0);</span>
	}

	public boolean updateOrgBalance(String claimType, double amount, int orgId,
			String amtUpdateType, Connection connection) throws SQLException {

		// check whether amount type is debit or credit
<span class="nc bnc" id="L378" title="All 2 branches missed.">		amount = &quot;DEBIT&quot;.equals(amtUpdateType) ? -1 * amount : amount;</span>
<span class="nc" id="L379">		System.out.println(&quot;claimType &quot; + claimType + &quot; ::amtUpdateType &quot;</span>
				+ amtUpdateType + &quot; amount = &quot; + amount);
<span class="nc" id="L381">		String updateRetBalQuery = null;</span>
<span class="nc bnc" id="L382" title="All 2 branches missed.">		if (&quot;UNCLAIM_BAL&quot;.equalsIgnoreCase(claimType))</span>
<span class="nc" id="L383">			updateRetBalQuery = &quot;update st_lms_organization_master set unclaimable_bal = (unclaimable_bal+?) where organization_id = ?&quot;;</span>
<span class="nc bnc" id="L384" title="All 2 branches missed.">		else if (&quot;CLAIM_BAL&quot;.equalsIgnoreCase(claimType)) {</span>
<span class="nc" id="L385">			updateRetBalQuery = &quot;update st_lms_organization_master set claimable_bal = (claimable_bal+?) &quot;</span>
					+ &quot; , organization_status = if((available_credit-claimable_bal)&gt;0, 'ACTIVE', 'INACTIVE')&quot;
					+ &quot; where organization_id = ?&quot;;
<span class="nc bnc" id="L388" title="All 2 branches missed.">		} else if (&quot;ACA_N_CLAIM_BAL&quot;.equalsIgnoreCase(claimType)) {</span>
<span class="nc" id="L389">			updateRetBalQuery = &quot;update st_lms_organization_master set claimable_bal = (claimable_bal-?),&quot;</span>
					+ &quot; available_credit=(available_credit+?) where organization_id = ?&quot;;
<span class="nc bnc" id="L391" title="All 2 branches missed.">		} else if (&quot;ACA_N_UNCLAIM_BAL&quot;.equalsIgnoreCase(claimType)) {</span>
<span class="nc" id="L392">			updateRetBalQuery = &quot;update st_lms_organization_master set unclaimable_bal = (unclaimable_bal-?),&quot;</span>
					+ &quot; available_credit=(available_credit+?) where organization_id = ?&quot;;
		}
<span class="nc" id="L395">		PreparedStatement updateRetBal = connection</span>
				.prepareStatement(updateRetBalQuery);
<span class="nc" id="L397">		updateRetBal.setDouble(1, amount);</span>
<span class="nc bnc" id="L398" title="All 2 branches missed.">		if (&quot;ACA_N_CLAIM_BAL&quot;.equalsIgnoreCase(claimType)) {</span>
<span class="nc" id="L399">			updateRetBal.setDouble(2, amount);</span>
<span class="nc" id="L400">			updateRetBal.setInt(3, orgId);</span>
		} else {
<span class="nc" id="L402">			updateRetBal.setInt(2, orgId);</span>
		}
<span class="nc" id="L404">		int retBalRow = updateRetBal.executeUpdate();</span>
<span class="nc" id="L405">		System.out.println(retBalRow + &quot; row updated,  updateRetBalQuery = &quot;</span>
				+ updateRetBal);

		// OrgCreditUpdation.

<span class="nc bnc" id="L410" title="All 2 branches missed.">		return (retBalRow &gt; 0);</span>

	}

	public boolean updateBookStatus(int gameId, String bookNbr, Connection con,
			String status) throws SQLException {
<span class="nc" id="L416">		String updateBookStatus = &quot;update st_se_game_inv_status set book_status = ? where game_id = ? and book_nbr=?&quot;;</span>
<span class="nc" id="L417">		PreparedStatement updateBookStatusPstmt = con</span>
				.prepareStatement(updateBookStatus);
<span class="nc" id="L419">		updateBookStatusPstmt.setString(1, status);</span>
<span class="nc" id="L420">		updateBookStatusPstmt.setInt(2, gameId);</span>
<span class="nc" id="L421">		updateBookStatusPstmt.setString(3, bookNbr);</span>
<span class="nc" id="L422">		int retBalRow = updateBookStatusPstmt.executeUpdate();</span>
<span class="nc" id="L423">		System.out.println(retBalRow + &quot; row updated,  updateBookStatus = &quot;</span>
				+ updateBookStatusPstmt);
<span class="nc bnc" id="L425" title="All 2 branches missed.">		return (retBalRow &gt; 0);</span>

	}

	public double fetchCommOfOrganization(int gameId, int orgId,
			String commType, String orgType, Connection con)
			throws SQLException {
<span class="nc" id="L432">		String fetCommAmount = &quot;&quot;;</span>
<span class="nc bnc" id="L433" title="All 2 branches missed.">		if (&quot;PWT&quot;.equalsIgnoreCase(commType)) {</span>

<span class="nc bnc" id="L435" title="All 2 branches missed.">			if (&quot;RETAILER&quot;.equalsIgnoreCase(orgType)) {</span>
<span class="nc" id="L436">				fetCommAmount = &quot;select a.game_id, a.retailer_pwt_comm_rate, b.pwt_comm_variance , &quot;</span>
						+ &quot;(ifnull(b.pwt_comm_variance, 0)+ a.retailer_pwt_comm_rate) 'total_comm' from &quot;
						+ &quot; (select game_id ,retailer_pwt_comm_rate from st_se_game_master where game_id = ?) a &quot;
						+ &quot; left join (select retailer_org_id, pwt_comm_variance, game_id from &quot;
						+ &quot; st_se_agent_retailer_sale_pwt_comm_variance where game_id = ? and  retailer_org_id = ?) b &quot;
						+ &quot;on a.game_id = b.game_id &quot;;
<span class="nc" id="L442">				System.out.println(&quot;PWT Commision Variance.&quot;);</span>
<span class="nc bnc" id="L443" title="All 2 branches missed.">			} else if (&quot;AGENT&quot;.equalsIgnoreCase(orgType)) {</span>
<span class="nc" id="L444">				fetCommAmount = &quot;select (a.agent_pwt_comm_rate+ifnull(b.pwt_comm_variance,0)) total_comm from(&quot;</span>
						+ &quot;select agent_pwt_comm_rate,game_id from st_se_game_master  where game_id=?)a left join&quot;
						+ &quot;(select pwt_comm_variance,game_id from st_se_bo_agent_sale_pwt_comm_variance &quot;
						+ &quot;where  game_id=? and agent_org_id=?) b on a.game_id=b.game_id&quot;;
<span class="nc" id="L448">				System.out.println(&quot;PWT Commision Variance.&quot;);</span>
			} else {
<span class="nc" id="L450">				System.out</span>
						.println(&quot;ERROR:: Org type is not Defined properly :: &quot;
								+ orgType);
			}

		} else {
<span class="nc" id="L456">			System.out.println(&quot;SALE Commision Variance.&quot;);</span>
		}
<span class="nc" id="L458">		PreparedStatement fetCommAmountPstmt = con</span>
				.prepareStatement(fetCommAmount);
<span class="nc" id="L460">		fetCommAmountPstmt.setInt(1, gameId);</span>
<span class="nc" id="L461">		fetCommAmountPstmt.setInt(2, gameId);</span>
<span class="nc" id="L462">		fetCommAmountPstmt.setInt(3, orgId);</span>
<span class="nc" id="L463">		ResultSet rs = fetCommAmountPstmt.executeQuery();</span>
<span class="nc" id="L464">		double commAmt = 0.0;</span>
<span class="nc bnc" id="L465" title="All 2 branches missed.">		if (rs.next()) {</span>
<span class="nc" id="L466">			commAmt = rs.getDouble(&quot;total_comm&quot;);</span>
		}
<span class="nc" id="L468">		System.out.println(&quot; commAmt = &quot; + commAmt + &quot; ,   fetCommAmount = &quot;</span>
				+ fetCommAmountPstmt);
<span class="nc" id="L470">		return commAmt;</span>

	}

	public String verifyOrgForUnClaimedVirn(int orgId, String orgType,
			String enVirnCode, String virnStatus, int gameId,
			Connection connection) throws SQLException {
<span class="nc" id="L477">		String flag = &quot;NONE&quot;;</span>
<span class="nc" id="L478">		String fetchVirnDetailQuery = &quot;&quot;;</span>
<span class="nc bnc" id="L479" title="All 2 branches missed.">		if (&quot;RETAILER&quot;.equalsIgnoreCase(orgType)) {</span>
<span class="nc" id="L480">			fetchVirnDetailQuery = &quot;select virn_code,'RETAILER' as tableType from st_se_retailer_pwt where game_id = ? and virn_code = ? and retailer_org_id = ? and status = ? UNION select virn_code, 'PLAYER' as tableType from st_se_retailer_direct_player_pwt where game_id = ? and virn_code = ? and retailer_org_id = ? and pwt_claim_status = ?&quot;;</span>
			// fetchVirnDetailQuery = &quot;select * from st_se_retailer_pwt where
			// game_id = ? and virn_code = ? and retailer_org_id = ? and status
			// = ?&quot;;
<span class="nc bnc" id="L484" title="All 2 branches missed.">		} else if (&quot;AGENT&quot;.equalsIgnoreCase(orgType)) {</span>

<span class="nc" id="L486">			fetchVirnDetailQuery = &quot;select virn_code,'AGENT' as tableType from st_se_agent_pwt where game_id = ? and virn_code = ? and agent_org_id = ? and status = ? UNION select virn_code, 'PLAYER' as tableType from st_se_agt_direct_player_pwt where game_id = ? and virn_code = ? and agent_org_id = ? and pwt_claim_status=?&quot;;</span>
			// fetchVirnDetailQuery = &quot;select * from st_se_agent_pwt where
			// game_id = ? and virn_code = ? and agent_org_id = ? and status =
			// ?&quot;;
		}
<span class="nc" id="L491">		pstmt = connection.prepareStatement(fetchVirnDetailQuery);</span>
<span class="nc" id="L492">		pstmt.setInt(1, gameId);</span>
<span class="nc" id="L493">		pstmt.setString(2, enVirnCode);</span>
<span class="nc" id="L494">		pstmt.setInt(3, orgId);</span>
<span class="nc" id="L495">		pstmt.setString(4, virnStatus);</span>
<span class="nc" id="L496">		pstmt.setInt(5, gameId);</span>
<span class="nc" id="L497">		pstmt.setString(6, enVirnCode);</span>
<span class="nc" id="L498">		pstmt.setInt(7, orgId);</span>
<span class="nc" id="L499">		pstmt.setString(8, virnStatus);</span>
<span class="nc" id="L500">		result = pstmt.executeQuery();</span>
<span class="nc" id="L501">		System.out.println(&quot; get detail of virn from &quot; + orgType</span>
				+ &quot; pwt table pstmt = &quot; + pstmt);
<span class="nc bnc" id="L503" title="All 2 branches missed.">		if (result.next()) {</span>
<span class="nc bnc" id="L504" title="All 2 branches missed.">			if (&quot;PLAYER&quot;.equalsIgnoreCase(result.getString(&quot;tableType&quot;)))</span>
<span class="nc" id="L505">				flag = &quot;IN_PLR_UNCLM&quot;;</span>
			else
<span class="nc" id="L507">				flag = &quot;IN_&quot; + orgType + &quot;_UNCLM&quot;;</span>
		} else {
			// we require to shoot a mail
			// System.out.println(&quot;status not matched in &quot;+orgType+&quot; pwt table
			// and st_pwt_inv table for virn = &quot;+enVirnCode);
			// CommonMethods.sendMail(&quot;status not matched in &quot;+orgType+&quot; pwt
			// table and st_pwt_inv table for virn = &quot;+enVirnCode);
		}
<span class="nc" id="L515">		return flag;</span>
	}

	public boolean updateOrgForUnClaimedVirn(int orgId, String orgType,
			String enVirnCode, String virnStatus, int gameId, String tableType,
			Connection connection,String tktNbr) throws SQLException, LMSException {
<span class="nc" id="L521">		boolean flag = false;</span>
		//String fetchVirnDetailQuery = &quot;&quot;;
<span class="nc" id="L523">		String updateVirnDetailQuery = &quot;&quot;;</span>
<span class="nc bnc" id="L524" title="All 2 branches missed.">		if (&quot;RETAILER&quot;.equalsIgnoreCase(orgType)) {</span>

			// update according to the retailer

<span class="nc bnc" id="L528" title="All 2 branches missed.">		} else if (&quot;AGENT&quot;.equalsIgnoreCase(orgType)) {</span>
<span class="nc bnc" id="L529" title="All 2 branches missed.">			if (&quot;AGENT&quot;.equalsIgnoreCase(tableType))</span>
<span class="nc" id="L530">				updateVirnDetailQuery = &quot;update st_se_agent_pwt set status=? where game_id = ? and virn_code = ? and agent_org_id = ? and ticket_nbr=? &quot;;</span>
<span class="nc bnc" id="L531" title="All 2 branches missed.">			else if (&quot;PLAYER&quot;.equalsIgnoreCase(tableType))</span>
<span class="nc" id="L532">				updateVirnDetailQuery = &quot;update st_se_agt_direct_player_pwt set pwt_claim_status=? where game_id = ? and virn_code = ? and agent_org_id = ? and ticket_nbr=? &quot;;</span>
			else
<span class="nc" id="L534">				throw new LMSException(</span>
						&quot;ERROR OCCURED while updating status in AGENT or PLR table for UNCLAIMMABLE balance  for this tableType is &quot;
								+ tableType);
			// fetchVirnDetailQuery = &quot;select * from st_se_agent_pwt where
			// game_id = ? and virn_code = ? and agent_org_id = ? and status =
			// ?&quot;;
			// fetchVirnDetailQuery = &quot;select * from st_se_agent_pwt where
			// game_id = ? and virn_code = ? and agent_org_id = ? and status =
			// ?&quot;;
		}
<span class="nc" id="L544">		pstmt = connection.prepareStatement(updateVirnDetailQuery);</span>
<span class="nc" id="L545">		pstmt.setString(1, virnStatus);</span>
<span class="nc" id="L546">		pstmt.setInt(2, gameId);</span>
<span class="nc" id="L547">		pstmt.setString(3, enVirnCode);</span>
<span class="nc" id="L548">		pstmt.setInt(4, orgId);</span>
<span class="nc" id="L549">		pstmt.setString(5, tktNbr);</span>
<span class="nc" id="L550">		int isupdate = pstmt.executeUpdate();</span>
<span class="nc" id="L551">		System.out.println(&quot; update  virn for &quot; + orgType</span>
				+ &quot; pwt table pstmt = &quot; + pstmt);
<span class="nc bnc" id="L553" title="All 2 branches missed.">		if (isupdate == 1) {</span>
<span class="nc" id="L554">			flag = true;</span>
		} else
<span class="nc" id="L556">			throw new LMSException(</span>
					&quot;ERROR OCCURED PWT NOT Found for this status &quot; + virnStatus);
<span class="nc" id="L558">		return flag;</span>
	}

	public Long agtEndPWTPaymentProcess(List&lt;PwtBean&gt; pwtList, int gameId,
			int agentUserId, int agtOrgId, int partyId, int partyUserId,
			double partyPwtCommRate, double agtPwtCommRate, int gameNbr,
			OrgPwtLimitBean orgPwtLimit, Connection connection,
			String partyType, PlayerPWTBean requestDetailsBean)
			throws SQLException, LMSException {

		PwtBean pwtBean;
<span class="nc" id="L569">		int pwtListSize = pwtList.size();</span>
<span class="nc" id="L570">		double pwtAmt = 0.0;</span>
<span class="nc" id="L571">		double commAmt = 0.0;</span>
<span class="nc" id="L572">		double retNetAmt = 0.0;</span>
<span class="nc" id="L573">		double retCreditAmt = 0.0;</span>
<span class="nc" id="L574">		double totalClmBal = 0.0;</span>
<span class="nc" id="L575">		double totalUnClmBal = 0.0;</span>
<span class="nc" id="L576">		double retTotalUnclmBal = 0.0;</span>
<span class="nc" id="L577">		long  transId = 0;</span>
		boolean isClaimmable;

		// insert data into main transaction master
<span class="nc" id="L581">		System.out.println(&quot;insert data into transaction master &quot; + &quot;type  is&quot;</span>
				+ partyType);
<span class="nc" id="L583">		String transMasQuery = QueryManager.insertInLMSTransactionMaster();</span>
<span class="nc" id="L584">		PreparedStatement pstmt = connection.prepareStatement(transMasQuery);</span>
<span class="nc" id="L585">		pstmt.setString(1, &quot;AGENT&quot;);</span>
<span class="nc" id="L586">		pstmt.executeUpdate();</span>
<span class="nc" id="L587">		ResultSet rs = pstmt.getGeneratedKeys();</span>
<span class="nc bnc" id="L588" title="All 2 branches missed.">		if (rs.next()) {</span>
<span class="nc" id="L589">			transId = rs.getLong(1);</span>

			// insert into agent transaction master
			// String retTransMasterQuery = &quot;insert into
			// st_lms_retailer_transaction_master ( transaction_id ,
			// retailer_user_id , retailer_org_id , transaction_date ,
			// transaction_type ) values (?,?,?,?,?)&quot;;
<span class="nc" id="L596">			String agtTransMasterQuery = QueryManager</span>
					.insertInAgentTransactionMaster();
<span class="nc" id="L598">			System.out.println(&quot;agtTransMasterQuery = &quot; + agtTransMasterQuery);</span>
<span class="nc" id="L599">			pstmt = connection.prepareStatement(agtTransMasterQuery);</span>
<span class="nc" id="L600">			pstmt.setLong(1, transId);</span>
<span class="nc" id="L601">			pstmt.setInt(2, agentUserId);</span>
<span class="nc" id="L602">			pstmt.setInt(3, agtOrgId);</span>

<span class="nc bnc" id="L604" title="All 2 branches missed.">			if (&quot;RETAILER&quot;.equals(partyType)) {</span>
<span class="nc" id="L605">				pstmt.setString(4, &quot;RETAILER&quot;);</span>
<span class="nc" id="L606">				pstmt.setInt(5, partyId);</span>
<span class="nc" id="L607">				pstmt.setString(6, &quot;PWT&quot;);</span>
<span class="nc bnc" id="L608" title="All 2 branches missed.">			} else if (&quot;PLAYER&quot;.equals(partyType)) {</span>
<span class="nc" id="L609">				pstmt.setString(4, &quot;PLAYER&quot;);</span>
<span class="nc" id="L610">				pstmt.setInt(5, partyId);</span>
<span class="nc" id="L611">				pstmt.setString(6, &quot;PWT_PLR&quot;);</span>
			}
<span class="nc" id="L613">			System.out.println(&quot;111111111111111111 ===== &quot; + partyId);</span>
<span class="nc" id="L614">			pstmt.setTimestamp(7, new java.sql.Timestamp(new java.util.Date()</span>
					.getTime()));
<span class="nc" id="L616">			System.out.println(&quot;insert into agent transaction master = &quot;</span>
					+ pstmt);
<span class="nc" id="L618">			pstmt.executeUpdate();</span>

			// insert into st_se_agent_pwt when comes pwtAmt is in payment and
			// approval limit
<span class="nc" id="L622">			String agtPwtEntry = &quot;insert into  st_se_agent_pwt ( virn_code, transaction_id ,game_id,agent_user_id,retailer_user_id,retailer_org_id,pwt_amt,comm_amt,net_amt,agent_org_id,status,claim_comm,ticket_nbr ) values ( ?, ?, ?, ?, ?, ?, ?, ?, ?, ?,?,?,?)&quot;;</span>
<span class="nc" id="L623">			pstmt = connection.prepareStatement(agtPwtEntry);</span>

			// update st_se_retailer_pwt in case if retailer brings uncalimed
			// PWTs to agent
<span class="nc" id="L627">			String retPwtUpdateQuery = &quot;update  st_se_retailer_pwt set status=? where game_id = ? and virn_code = ? and retailer_org_id = ? and ticket_nbr=?&quot;;</span>
<span class="nc" id="L628">			PreparedStatement retPwtUpdatePstmt = connection</span>
					.prepareStatement(retPwtUpdateQuery);

			// insert in st direct player table in case of player
<span class="nc" id="L632">			String insertAgtDirectPlr = &quot;insert into st_se_agt_direct_player_pwt(task_id,agent_user_id,agent_org_id,ticket_nbr,virn_code,transaction_id,game_id,player_id,pwt_amt,tax_amt,net_amt,payment_type,cheque_nbr,cheque_date,drawee_bank,issuing_party_name,pwt_claim_status,claim_comm,transaction_date) values(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)&quot;;</span>
<span class="nc" id="L633">			PreparedStatement dirPlrPstmt = connection</span>
					.prepareStatement(insertAgtDirectPlr);

			//String updateVirnInvQuery = &quot;update st_se_pwt_inv_? set status = ? where game_id = ? and virn_code = ?&quot;;
			//PreparedStatement invPstmt = connection
			//		.prepareStatement(updateVirnInvQuery);

<span class="nc bnc" id="L640" title="All 2 branches missed.">			for (int i = 0; i &lt; pwtListSize; i++) {</span>
<span class="nc" id="L641">				pwtBean = (PwtBean) pwtList.get(i);</span>

<span class="nc bnc" id="L643" title="All 4 branches missed.">				if (pwtBean.getIsValid()</span>
						&amp;&amp; Double.parseDouble(pwtBean.getPwtAmount()) &gt; orgPwtLimit
								.getPayLimit()) {
<span class="nc" id="L646">					pwtBean.setValid(false);</span>
<span class="nc" id="L647">					pwtBean.setMessage(&quot;Pwt Amount is not agents Pay Limit&quot;);</span>
<span class="nc" id="L648">					pwtBean.setVerificationStatus(&quot;Invalid&quot;);</span>
<span class="nc bnc" id="L649" title="All 2 branches missed.">				} else if (pwtBean.getIsValid()) {</span>
<span class="nc" id="L650">					pwtAmt = Double.parseDouble(pwtBean.getPwtAmount());</span>
<span class="nc" id="L651">					String encodedVirn = pwtBean.getEncVirnCode();</span>
<span class="nc" id="L652">					String encodedTktNbr=null;</span>
					// pwtAmt = Double.parseDouble(pwtBean.getPwtAmount());
<span class="nc bnc" id="L654" title="All 4 branches missed.">					if (&quot;YES&quot;.equalsIgnoreCase(orgPwtLimit.getIsPwtAutoScrap())</span>
							&amp;&amp; pwtAmt &lt;= orgPwtLimit.getScrapLimit())
<span class="nc" id="L656">						isClaimmable = true;</span>
					else
<span class="nc" id="L658">						isClaimmable = false;</span>

<span class="nc bnc" id="L660" title="All 2 branches missed.">					if (&quot;RETAILER&quot;.equals(partyType)) {</span>
<span class="nc" id="L661">						encodedTktNbr=pwtBean.getTicketNumber();</span>
<span class="nc" id="L662">						pstmt.setString(1, encodedVirn);</span>
<span class="nc" id="L663">						pstmt.setLong(2, transId);</span>
<span class="nc" id="L664">						pstmt.setInt(3, gameId);</span>
<span class="nc" id="L665">						pstmt.setInt(4, agentUserId);</span>
<span class="nc" id="L666">						pstmt.setInt(5, partyUserId);</span>
<span class="nc" id="L667">						pstmt.setInt(6, partyId);</span>

						// pwtAmt = Double.parseDouble(pwtBean.getPwtAmount());
<span class="nc" id="L670">						commAmt = pwtAmt * partyPwtCommRate * 0.01;</span>
<span class="nc" id="L671">						retNetAmt = pwtAmt + commAmt;</span>

						// for creditUpdation
<span class="nc" id="L674">						retCreditAmt += retNetAmt;</span>

<span class="nc bnc" id="L676" title="All 2 branches missed.">						if (!&quot;NONE&quot;.equalsIgnoreCase(pwtBean.getInUnclmed())) {</span>
							// update retailer pwt status for unclaimed pwt as
							// done
<span class="nc" id="L679">							retPwtUpdatePstmt.setString(1, &quot;DONE_UNCLM&quot;);</span>
<span class="nc" id="L680">							retPwtUpdatePstmt.setInt(2, gameId);</span>
<span class="nc" id="L681">							retPwtUpdatePstmt.setString(3, encodedVirn);</span>
<span class="nc" id="L682">							retPwtUpdatePstmt.setInt(4, partyId);</span>
<span class="nc" id="L683">							retPwtUpdatePstmt.setString(5, encodedTktNbr);</span>
<span class="nc" id="L684">							int row = retPwtUpdatePstmt.executeUpdate();</span>
<span class="nc bnc" id="L685" title="All 2 branches missed.">							if (row == 1)</span>
<span class="nc" id="L686">								retTotalUnclmBal += pwtAmt;</span>

						}
<span class="nc" id="L689">						pstmt.setDouble(7, pwtAmt);</span>
<span class="nc" id="L690">						pstmt.setDouble(8, commAmt);</span>
<span class="nc" id="L691">						pstmt.setDouble(9, retNetAmt);</span>
<span class="nc" id="L692">						pstmt.setInt(10, agtOrgId);</span>

<span class="nc bnc" id="L694" title="All 2 branches missed.">						if (isClaimmable) {</span>
<span class="nc" id="L695">							pstmt.setString(11, &quot;CLAIM_BAL&quot;);</span>
<span class="nc" id="L696">							totalClmBal += (pwtAmt + (pwtAmt * .01 * agtPwtCommRate));</span>
						} else {
<span class="nc" id="L698">							pstmt.setString(11, &quot;UNCLAIM_BAL&quot;);</span>
<span class="nc" id="L699">							totalUnClmBal += pwtAmt;</span>
						}
<span class="nc" id="L701">						pstmt.setDouble(12, agtPwtCommRate);</span>
<span class="nc" id="L702">						pstmt.setString(13,encodedTktNbr);</span>

<span class="nc" id="L704">						pstmt.executeUpdate();</span>
<span class="nc bnc" id="L705" title="All 2 branches missed.">					} else if (&quot;PLAYER&quot;.equals(partyType)) {</span>
<span class="nc" id="L706">						encodedTktNbr=requestDetailsBean.getTicketNbr();</span>
<span class="nc" id="L707">						dirPlrPstmt.setInt(1, requestDetailsBean.getTaskId());</span>
<span class="nc" id="L708">						dirPlrPstmt.setInt(2, agentUserId);</span>
<span class="nc" id="L709">						dirPlrPstmt.setInt(3, agtOrgId);</span>
<span class="nc" id="L710">						dirPlrPstmt.setString(4, requestDetailsBean</span>
								.getTicketNbr());
<span class="nc" id="L712">						dirPlrPstmt.setString(5, requestDetailsBean</span>
								.getVirnCode());
<span class="nc" id="L714">						dirPlrPstmt.setLong(6, transId);</span>
<span class="nc" id="L715">						dirPlrPstmt.setInt(7, gameId);</span>
<span class="nc" id="L716">						dirPlrPstmt.setInt(8, partyId);</span>
<span class="nc" id="L717">						dirPlrPstmt.setDouble(9, pwtAmt);</span>
<span class="nc" id="L718">						dirPlrPstmt.setDouble(10, requestDetailsBean.getTax());</span>
<span class="nc" id="L719">						dirPlrPstmt.setDouble(11, requestDetailsBean</span>
								.getNetAmt());
<span class="nc" id="L721">						dirPlrPstmt.setString(12, requestDetailsBean</span>
								.getPaymentType());
<span class="nc" id="L723">						dirPlrPstmt.setTimestamp(13, new java.sql.Timestamp(</span>
								new java.util.Date().getTime()));

<span class="nc bnc" id="L726" title="All 4 branches missed.">						if (&quot;cash&quot;.equalsIgnoreCase(requestDetailsBean</span>
								.getPaymentType())
								|| &quot;TPT&quot;.equalsIgnoreCase(requestDetailsBean
										.getPaymentType())) {
<span class="nc" id="L730">							dirPlrPstmt.setObject(13, null);</span>
<span class="nc" id="L731">							dirPlrPstmt.setObject(14, null);</span>
<span class="nc" id="L732">							dirPlrPstmt.setObject(15, null);</span>
<span class="nc" id="L733">							dirPlrPstmt.setObject(16, null);</span>
<span class="nc bnc" id="L734" title="All 2 branches missed.">						} else if (&quot;CHEQUE&quot;.equalsIgnoreCase(requestDetailsBean</span>
								.getPaymentType())) {
<span class="nc" id="L736">							DateFormat dateFormat = new SimpleDateFormat(</span>
									&quot;dd-MM-yyyy&quot;);
<span class="nc" id="L738">							java.sql.Date chqDate = null;</span>
							try {
<span class="nc bnc" id="L740" title="All 4 branches missed.">								if (!&quot;&quot;.equalsIgnoreCase(requestDetailsBean</span>
										.getChequeDate())
										&amp;&amp; requestDetailsBean.getChequeDate() != null)
<span class="nc" id="L743">									chqDate = new java.sql.Date(</span>
											(dateFormat
													.parse(requestDetailsBean
															.getChequeDate())
													.getTime()));
<span class="nc" id="L748">							} catch (ParseException e) {</span>
<span class="nc" id="L749">								e.printStackTrace();</span>
<span class="nc" id="L750">								throw new LMSException(</span>
										&quot;Exception date parsing  while pwt payments at Agent end &quot;,
										e);
<span class="nc" id="L753">							}</span>

<span class="nc" id="L755">							dirPlrPstmt.setString(13, requestDetailsBean</span>
									.getChequeNbr());
<span class="nc" id="L757">							dirPlrPstmt.setDate(14, chqDate);</span>
<span class="nc" id="L758">							dirPlrPstmt.setString(15, requestDetailsBean</span>
									.getDraweeBank());
<span class="nc" id="L760">							dirPlrPstmt.setString(16, requestDetailsBean</span>
									.getIssuingPartyName());
<span class="nc" id="L762">						} else {</span>
<span class="nc" id="L763">							throw new LMSException(</span>
									&quot;Exception or Error No payment type specified &quot;
											+ requestDetailsBean
													.getPaymentType());
						}

<span class="nc bnc" id="L769" title="All 2 branches missed.">						if (isClaimmable) {</span>
<span class="nc" id="L770">							dirPlrPstmt.setString(17, &quot;CLAIM_BAL&quot;);</span>
							// pstmt.setString(11, &quot;CLAIM_BAL&quot;);
<span class="nc" id="L772">							totalClmBal += (pwtAmt + (pwtAmt * .01 * agtPwtCommRate));</span>
						} else {
<span class="nc" id="L774">							dirPlrPstmt.setString(17, &quot;UNCLAIM_BAL&quot;);</span>
							// pstmt.setString(11, &quot;UNCLAIM_BAL&quot;);
<span class="nc" id="L776">							totalUnClmBal += pwtAmt;</span>
						}
<span class="nc" id="L778">						dirPlrPstmt.setDouble(18, agtPwtCommRate);</span>
<span class="nc" id="L779">						dirPlrPstmt.setTimestamp(19, new java.sql.Timestamp(</span>
								new java.util.Date().getTime()));
<span class="nc" id="L781">						dirPlrPstmt.executeUpdate();</span>
<span class="nc" id="L782">						System.out.println(&quot;insert in direct player table &quot;</span>
								+ dirPlrPstmt);
						// update status of of requested id entries into
						// st_se_pwt_approval_request_master
<span class="nc" id="L786">						String updateAppTable = &quot;update  st_se_pwt_approval_request_master  set req_status ='PAID', &quot;</span>
								+ &quot;remarks ='Payment Done', payment_done_by_type =?, payment_done_by =?, transaction_id=? where  task_id = ?&quot;;
<span class="nc" id="L788">						pstmt = connection.prepareStatement(updateAppTable);</span>
<span class="nc" id="L789">						pstmt.setString(1, &quot;AGENT&quot;);</span>
<span class="nc" id="L790">						pstmt.setInt(2, agtOrgId);</span>
<span class="nc" id="L791">						pstmt.setLong(3, transId);</span>
<span class="nc" id="L792">						pstmt.setInt(4, requestDetailsBean.getTaskId());</span>
<span class="nc" id="L793">						int j = pstmt.executeUpdate();</span>
<span class="nc" id="L794">						System.out.println(&quot;total row updated = &quot; + j</span>
								+ &quot; ,  requested id &quot;
								+ requestDetailsBean.getTaskId()
								+ &quot; status updated = &quot; + pstmt);
<span class="nc bnc" id="L798" title="All 2 branches missed.">						if (j &lt; 1)</span>
<span class="nc" id="L799">							throw new LMSException(</span>
									&quot;st_se_pwt_approval_request_master table not updated.&quot;);

					}

					// insert in ticket table
<span class="nc bnc" id="L805" title="All 4 branches missed.">					if (&quot;RETAILER&quot;.equals(partyType)</span>
							&amp;&amp; requestDetailsBean != null) {
						// update the ticket_inv_detail table
<span class="nc" id="L808">						CommonFunctionsHelper commHelper = new CommonFunctionsHelper(); // partyId,</span>
						// channel,
						// interfaceType
<span class="nc bnc" id="L811" title="All 2 branches missed.">						commHelper.updateTicketInvTable(requestDetailsBean</span>
								.getTicketNbr(), requestDetailsBean
								.getBookNbr(), gameNbr, gameId,
								(isClaimmable ? &quot;CLAIM_RET_CLM&quot;
										: &quot;CLAIM_RET_UNCLM&quot;), agentUserId,
								agtOrgId, &quot;UPDATE&quot;, 0, null, null, connection);
<span class="nc bnc" id="L817" title="All 2 branches missed.">					} else if (&quot;PLAYER&quot;.equals(partyType)) {</span>
<span class="nc" id="L818">						CommonFunctionsHelper commHelper = new CommonFunctionsHelper();</span>
<span class="nc bnc" id="L819" title="All 2 branches missed.">						commHelper.updateTicketInvTable(requestDetailsBean</span>
								.getTicketNbr(), requestDetailsBean
								.getBookNbr(), gameNbr, gameId,
								(isClaimmable ? &quot;CLAIM_PLR_AGT_CLM_DIR&quot;
										: &quot;CLAIM_PLR_AGT_UNCLM_DIR&quot;),
								agentUserId, agtOrgId, &quot;UPDATE&quot;, 0, null, null,
								connection);
					}

<span class="nc" id="L828">					String pwtStatus = &quot;&quot;;</span>
<span class="nc bnc" id="L829" title="All 4 branches missed.">					if (&quot;RETAILER&quot;.equals(partyType) &amp;&amp; isClaimmable) {</span>
<span class="nc" id="L830">						pwtStatus = &quot;CLAIM_RET_CLM&quot;;</span>
<span class="nc bnc" id="L831" title="All 4 branches missed.">					} else if (&quot;RETAILER&quot;.equals(partyType) &amp;&amp; !isClaimmable) {</span>
<span class="nc" id="L832">						pwtStatus = &quot;CLAIM_RET_UNCLM&quot;;</span>
<span class="nc bnc" id="L833" title="All 4 branches missed.">					} else if (&quot;PLAYER&quot;.equals(partyType) &amp;&amp; isClaimmable) {</span>
<span class="nc" id="L834">						pwtStatus = &quot;CLAIM_PLR_AGT_CLM_DIR&quot;;</span>
<span class="nc bnc" id="L835" title="All 4 branches missed.">					} else if (&quot;PLAYER&quot;.equals(partyType) &amp;&amp; !isClaimmable) {</span>
<span class="nc" id="L836">						pwtStatus = &quot;CLAIM_PLR_AGT_UNCLM_DIR&quot;;</span>
					}

					// update the remaining prize list
					/*GameUtilityHelper.updateNoOfPrizeRemNewZim(gameId, pwtAmt,
							pwtStatus, encodedVirn, connection, gameNbr,MD5Encoder.encode(requestDetailsBean
									.getTicketNbr()));*/
<span class="nc" id="L843">									GameUtilityHelper.updateNoOfPrizeRemNewZim(gameId, pwtAmt,</span>
											pwtStatus, encodedVirn, connection, gameNbr,MD5Encoder.encode(encodedTktNbr));

					// update VIRN status
					/*updateVirnStatus(gameNbr, pwtStatus, gameId, pwtBean
							.getEncVirnCode(), connection,MD5Encoder.encode(requestDetailsBean
								.getTicketNbr()));*/
									
<span class="nc" id="L851">									updateVirnStatus(gameNbr, pwtStatus, gameId, pwtBean</span>
											.getEncVirnCode(), connection,MD5Encoder.encode(encodedTktNbr));

				}
			}
<span class="nc" id="L856">			System.out.println(&quot;insert into st_se_agent_pwt = &quot; + pstmt);</span>

			// update agent CLAIM_BAL payment
<span class="nc" id="L859">			CommonFunctionsHelper commHelper = new CommonFunctionsHelper();</span>
<span class="nc bnc" id="L860" title="All 2 branches missed.">			if (totalClmBal &gt; 0.0) {</span>
				// commHelper.updateOrgBalance(&quot;CLAIM_BAL&quot;, totalClmBal,
				// agtOrgId,&quot;CREDIT&quot;, connection);
				// changed by ARUN when draw game sale come in picture
<span class="nc" id="L864">				OrgCreditUpdation.updateOrganizationBalWithValidate(totalClmBal, &quot;CLAIM_BAL&quot;, &quot;DEBIT&quot;, agtOrgId,</span>
						0, &quot;AGENT&quot;, 0, connection);
				/*commHelper.updateOrgBalance(&quot;CLAIM_BAL&quot;, totalClmBal, agtOrgId,
						&quot;DEBIT&quot;, connection);*/
			}

			// update agent UNCLAIM_BAL payment
<span class="nc bnc" id="L871" title="All 2 branches missed.">			if (totalUnClmBal &gt; 0.0)</span>
<span class="nc" id="L872">				OrgCreditUpdation.updateOrganizationBalWithValidate(totalUnClmBal, &quot;UNCLAIM_BAL&quot;, &quot;CREDIT&quot;, agtOrgId,</span>
						0, &quot;AGENT&quot;, 0, connection);
				/*commHelper.updateOrgBalance(&quot;UNCLAIM_BAL&quot;, totalUnClmBal,
						agtOrgId, &quot;CREDIT&quot;, connection);*/

			// for retailer credit update
<span class="nc bnc" id="L878" title="All 2 branches missed.">			if (&quot;RETAILER&quot;.equals(partyType)) {</span>
				
<span class="nc" id="L880">				boolean isValid=OrgCreditUpdation.updateOrganizationBalWithValidate(retCreditAmt, &quot;TRANSACTION&quot;, &quot;PWT&quot;, partyId,</span>
						agtOrgId, &quot;RETAILER&quot;, 0, connection);
				
				
				/*OrgCreditUpdation.updateCreditLimitForRetailer(partyId, &quot;PWT&quot;,
						retCreditAmt, connection);*/
				// update retailer UNCLAIM_BAL payment
<span class="nc bnc" id="L887" title="All 2 branches missed.">				if(!isValid)</span>
<span class="nc" id="L888">					throw new LMSException();</span>
<span class="nc" id="L889">				System.out</span>
						.println(&quot;inside retailer yogesh &quot; + retTotalUnclmBal);
<span class="nc bnc" id="L891" title="All 2 branches missed.">				if (retTotalUnclmBal &gt; 0.0)</span>
<span class="nc" id="L892">					OrgCreditUpdation.updateOrganizationBalWithValidate(retTotalUnclmBal, &quot;UNCLAIM_BAL&quot;, &quot;DEBIT&quot;, partyId,</span>
							agtOrgId, &quot;RETAILER&quot;, 0, connection);
				
					/*commHelper.updateOrgBalance(&quot;UNCLAIM_BAL&quot;,
							retTotalUnclmBal, partyId, &quot;DEBIT&quot;, connection);*/
			}

			// receipt entries are required to be inserted into receipt table

<span class="nc" id="L901">			return transId;</span>

		} else
<span class="nc" id="L904">			throw new LMSException(</span>
					&quot;no data insert into main transaction master&quot;);

	}

	public Map fetchPwtDetailsOfOrg(int retOrgId, String orgType,
			String status, Connection con) throws LMSException {

<span class="nc" id="L912">		Map map = new TreeMap();</span>
<span class="nc" id="L913">		Map clmPwtDetailMap = new TreeMap();</span>
<span class="nc" id="L914">		ClmPwtBean pwtBean = null;</span>
		try {
<span class="nc" id="L916">			String fetchClmBalOfOrgQuery = &quot;&quot;;</span>
<span class="nc bnc" id="L917" title="All 2 branches missed.">			if (&quot;RETAILER&quot;.equalsIgnoreCase(orgType)) {</span>
<span class="nc" id="L918">				fetchClmBalOfOrgQuery = &quot;select  aaa.game_id, bbb.game_nbr, bbb.game_name, ticket_nbr, aaa.agt_claim_comm , &quot;</span>
						+ &quot;aaa.virn_code, aaa.pwt_amt,  aaa.pwt_type, aaa.claim_comm, aaa.name from((select &quot;
						+ &quot;virn_code, ticket_nbr, pwt_amt, 'Anonymous' as  'pwt_type' , game_id, claim_comm , agt_claim_comm , &quot;
						+ &quot; 'Anonymous' as name from st_se_retailer_pwt where status = ?  and  retailer_org_id = ?) &quot;
						+ &quot;union (select  aa.virn_code, aa.ticket_nbr, aa.pwt_amt , 'direct_plr' as  'pwt_type', &quot;
						+ &quot;aa.game_id,  aa.claim_comm, agt_claim_comm , concat(bb.first_name, ' ', bb.last_name) 'name' from  &quot;
						+ &quot;st_se_retailer_direct_player_pwt aa, st_lms_player_master bb where  pwt_claim_status = ? &quot;
						+ &quot;and retailer_org_id = ? and aa.player_id = bb.player_id ))aaa, st_se_game_master bbb &quot;
						+ &quot;where aaa.game_id = bbb.game_id order by aaa.game_id&quot;;
<span class="nc bnc" id="L927" title="All 2 branches missed.">			} else if (&quot;AGENT&quot;.equalsIgnoreCase(orgType)) {</span>
<span class="nc bnc" id="L928" title="All 4 branches missed.">				fetchClmBalOfOrgQuery = &quot;select  aa.game_id, bb.game_nbr, 'No Tkt' as 'ticket_nbr', bb.game_name,&quot;</span>
						+ &quot; aa.virn_code, aa.pwt_amt, aa.pwt_type, aa.claim_comm, aa.name from((select a.virn_code,&quot;
						+ &quot; a.pwt_amt, 'Anonymous' as 'pwt_type' ,  a.game_id, a.claim_comm, b.name  from &quot;
						+ &quot;st_se_agent_pwt a, st_lms_organization_master b where a.retailer_org_id = b.organization_id &quot;
						+ &quot;and ( a.status = ? &quot;
						+ (&quot;UNCLAIM_BAL&quot;.equalsIgnoreCase(status) ? &quot; or a.status ='BULK_BO' &quot;
								: &quot;&quot;)
						+ &quot; )and a.agent_org_id = ?) union (select virn_code, pwt_amt 'dir_pwt_amt', &quot;
						+ &quot;'direct_plr' as 'pwt_type', game_id, claim_comm, concat(b.first_name, ' ', b.last_name) 'name'&quot;
						+ &quot;  from  st_se_agt_direct_player_pwt a, st_lms_player_master b  where a.player_id = b.player_id and &quot;
						+ &quot; ( pwt_claim_status = ? &quot;
						+ (&quot;UNCLAIM_BAL&quot;.equalsIgnoreCase(status) ? &quot; or pwt_claim_status ='BULK_BO' &quot;
								: &quot;&quot;)
						+ &quot; )and agent_org_id = ?))aa, st_se_game_master bb where aa.game_id = bb.game_id  order by aa.game_id&quot;;

			}
<span class="nc" id="L944">			System.out.println(fetchClmBalOfOrgQuery);</span>
<span class="nc" id="L945">			PreparedStatement pstmt = con</span>
					.prepareStatement(fetchClmBalOfOrgQuery);
<span class="nc" id="L947">			pstmt.setString(1, status);</span>
<span class="nc" id="L948">			pstmt.setInt(2, retOrgId);</span>
<span class="nc" id="L949">			pstmt.setString(3, status);</span>
<span class="nc" id="L950">			pstmt.setInt(4, retOrgId);</span>
<span class="nc" id="L951">			System.out.println(&quot;Fetch &quot; + status + &quot; PWT details for &quot;</span>
					+ orgType + &quot; and orgId is &quot; + retOrgId + &quot; query is &quot;
					+ pstmt);
<span class="nc" id="L954">			ResultSet result = pstmt.executeQuery();</span>
<span class="nc" id="L955">			List&lt;ClmPwtBean&gt; beanList = new ArrayList&lt;ClmPwtBean&gt;();</span>
<span class="nc" id="L956">			int gameId = -1;</span>
<span class="nc" id="L957">			double totalClmBal = 0.0;</span>
<span class="nc" id="L958">			int count = 0;</span>
<span class="nc bnc" id="L959" title="All 2 branches missed.">			while (result.next()) {</span>
<span class="nc" id="L960">				count = count + 1;</span>
<span class="nc" id="L961">				pwtBean = new ClmPwtBean();</span>

<span class="nc" id="L963">				double pwtAmt = result.getDouble(&quot;pwt_amt&quot;);</span>
<span class="nc" id="L964">				int game_id = result.getInt(&quot;game_id&quot;);</span>

<span class="nc" id="L966">				totalClmBal = totalClmBal + pwtAmt;</span>

<span class="nc" id="L968">				pwtBean.setVirnCode(result.getString(&quot;virn_code&quot;));</span>
<span class="nc" id="L969">				pwtBean.setTktNbr(result.getString(&quot;ticket_nbr&quot;));</span>
<span class="nc" id="L970">				pwtBean.setPwtAmt(result.getDouble(&quot;pwt_amt&quot;));</span>
<span class="nc" id="L971">				pwtBean.setPwtType(result.getString(&quot;pwt_type&quot;));</span>
<span class="nc" id="L972">				pwtBean.setClaimComm(result.getDouble(&quot;claim_comm&quot;));</span>
<span class="nc" id="L973">				pwtBean.setGameId(result.getInt(&quot;game_id&quot;));</span>
<span class="nc" id="L974">				pwtBean.setGameName(result.getString(&quot;game_name&quot;));</span>
<span class="nc" id="L975">				pwtBean.setGameNbr(result.getInt(&quot;game_nbr&quot;));</span>
<span class="nc" id="L976">				pwtBean.setClaimedBy(result.getString(&quot;name&quot;));</span>
<span class="nc bnc" id="L977" title="All 2 branches missed.">				if (&quot;RETAILER&quot;.equalsIgnoreCase(orgType)) {</span>
<span class="nc" id="L978">					pwtBean.setAgtClaimComm(result.getDouble(&quot;agt_claim_comm&quot;));</span>
				}

<span class="nc bnc" id="L981" title="All 2 branches missed.">				if (gameId != game_id) {</span>
<span class="nc bnc" id="L982" title="All 2 branches missed.">					if (gameId == -1)</span>
<span class="nc" id="L983">						beanList.add(pwtBean);</span>
					else {
						// System.out.println(&quot;inside else game_id = &quot;+gameId+&quot;
						// and list size = &quot;+beanList.size());
<span class="nc" id="L987">						clmPwtDetailMap.put(gameId, beanList);</span>
<span class="nc" id="L988">						beanList = new ArrayList&lt;ClmPwtBean&gt;();</span>
<span class="nc" id="L989">						gameId = game_id;</span>
<span class="nc" id="L990">						beanList.add(pwtBean);</span>
					}
<span class="nc" id="L992">					gameId = game_id;</span>
				} else {
<span class="nc" id="L994">					beanList.add(pwtBean);</span>
<span class="nc" id="L995">					gameId = game_id;</span>
				}

				// if result set row is last
<span class="nc bnc" id="L999" title="All 2 branches missed.">				if (result.isLast()) {</span>
					// System.out.println(&quot;inside if when result is last game_id
					// = &quot;+gameId+&quot; and list size = &quot;+beanList.size());
<span class="nc" id="L1002">					clmPwtDetailMap.put(gameId, beanList);</span>
				}

<span class="nc" id="L1005">			}</span>
			// System.out.println(&quot;result row size = &quot;+count);
<span class="nc bnc" id="L1007" title="All 2 branches missed.">			if (!clmPwtDetailMap.isEmpty()) {</span>
<span class="nc" id="L1008">				map.put(&quot;clmPwtDetails&quot;, clmPwtDetailMap);</span>
<span class="nc" id="L1009">				map.put(&quot;totalClmBal&quot;, totalClmBal);</span>
			}
<span class="nc" id="L1011">			return map;</span>

<span class="nc" id="L1013">		} catch (SQLException e) {</span>
<span class="nc" id="L1014">			e.printStackTrace();</span>
<span class="nc" id="L1015">			throw new LMSException(e);</span>
		}
	}

	/**
	 * this method is depricated and not used commented on 10 july 2013 by sumit
	 * 
	 * @param userOrgId
	 * @param orgType
	 * @param status
	 * @param con
	 * @return
	 * @throws LMSException
	 */
/*	public Map fetchDrawSaleDetailsOfOrg(int userOrgId, String orgType,
			String status, Connection con) throws LMSException {

		Map map = new TreeMap();
		ClmDrawSaleBean darwSaleBean = null;
		PreparedStatement pstmtRefund = null;
		PreparedStatement pstmt = null;
		PreparedStatement pstmtGameNbr = null;
		try {
			String fetchClmBalOfOrgQuery = &quot;&quot;;
			String fetchDrawRefundClmBal = &quot;&quot;;
			String getGameNbrFromGameMaster = &quot;&quot;;

			Map&lt;String, List&lt;ClmDrawSaleBean&gt;&gt; clmDrawSaleDetailMap = new TreeMap();
			Map&lt;String, List&lt;ClmDrawSaleBean&gt;&gt; clmDrawSaleRefundDetailMap = new TreeMap();

			if (&quot;RETAILER&quot;.equalsIgnoreCase(orgType)) {
				fetchClmBalOfOrgQuery = &quot;select transaction_id ,mrp_amt ,retailer_comm,agent_comm,good_cause_amt,&quot;
						+ &quot;vat_amt,taxable_sale,game_id,(retailer_comm*100/mrp_amt) ret_comm_rate,(agent_comm*100/mrp_amt)&quot;
						+ &quot; agt_comm_rate,(good_cause_amt*100/mrp_amt) good_cause_rate from st_dg_ret_sale_? &quot;
						+ &quot;where retailer_org_id=? and claim_status=? order by game_id,ret_comm_rate,agt_comm_rate,&quot;
						+ &quot;good_cause_rate&quot;;

				fetchDrawRefundClmBal = &quot;select a.transaction_id ,b.transaction_type,a.mrp_amt ,a.retailer_comm,a.agent_comm,a.good_cause_amt,&quot;
						+ &quot;a.vat_amt,a.taxable_sale,a.game_id,(a.retailer_comm*100/a.mrp_amt) ret_comm_rate,(a.agent_comm*100/a.mrp_amt) &quot;
						+ &quot;agt_comm_rate,(a.good_cause_amt*100/a.mrp_amt) good_cause_rate,a.cancellation_charges from st_dg_ret_sale_refund_? a,st_lms_retailer_transaction_master b &quot;
						+ &quot;where a.retailer_org_id=? and a.claim_status=? and b.transaction_id=a.transaction_id order by a.game_id,ret_comm_rate,agt_comm_rate,&quot;
						+ &quot;good_cause_rate,b.transaction_type&quot;;

				getGameNbrFromGameMaster = &quot;select game_nbr,prize_payout_ratio,vat_amt from st_dg_game_master&quot;;
				pstmtGameNbr = con.prepareStatement(getGameNbrFromGameMaster);
				ResultSet resultGameNbr = pstmtGameNbr.executeQuery();
				int gameNbr = 0;
				double ppr = 0.0;
				double vatAmt = 0.0;
				while (resultGameNbr.next()) {

					gameNbr = resultGameNbr.getInt(&quot;game_nbr&quot;);
					ppr = resultGameNbr.getInt(&quot;prize_payout_ratio&quot;);
					vatAmt = resultGameNbr.getDouble(&quot;vat_amt&quot;);
					pstmt = con.prepareStatement(fetchClmBalOfOrgQuery);
					pstmt.setInt(1, gameNbr);
					pstmt.setInt(2, userOrgId);
					pstmt.setString(3, status);
					ResultSet result = pstmt.executeQuery();
					List&lt;ClmDrawSaleBean&gt; beanList = new ArrayList&lt;ClmDrawSaleBean&gt;();

					// String key=&quot;-1&quot;;
					while (result.next()) {
						darwSaleBean = new ClmDrawSaleBean();
						double mrpAmt = result.getDouble(&quot;mrp_amt&quot;);
						double retComm = result.getDouble(&quot;retailer_comm&quot;);
						double agentComm = result.getDouble(&quot;agent_comm&quot;);
						double goodCauseAmt = result
								.getDouble(&quot;good_cause_amt&quot;);
						int game_id = result.getInt(&quot;game_id&quot;);
						if (mrpAmt != 0) {
							String keyGen = game_id + &quot;:&quot;
									+ (retComm * 100 / mrpAmt) + &quot;:&quot;
									+ (agentComm * 100 / mrpAmt) + &quot;:&quot;
									+ (goodCauseAmt * 100 / mrpAmt);
							darwSaleBean.setPricePayRatio(ppr);
							darwSaleBean.setVatAmt(vatAmt);
							darwSaleBean.setMrpAmt(mrpAmt);
							darwSaleBean.setRetComm(retComm);
							darwSaleBean.setAgtComm(agentComm);
							darwSaleBean.setAgtGoodCauseAmt(goodCauseAmt);
							darwSaleBean.setGameId(game_id);
							darwSaleBean.setTransactinId(result
									.getLong(&quot;transaction_id&quot;));
							darwSaleBean.setGameNbr(gameNbr);
							// modify the below code so as to improve
							// readability . Use
							// map.contains method
							// remove duplicacy in variable declaration
							// modified by yogesh as suggested by reviewer
							// vinnet

							if (clmDrawSaleDetailMap.containsKey(keyGen)) {
								beanList = (clmDrawSaleDetailMap.get(keyGen));
								beanList.add(darwSaleBean);
								clmDrawSaleDetailMap.put(keyGen, beanList);
							} else {
								beanList = new ArrayList&lt;ClmDrawSaleBean&gt;();
								beanList.add(darwSaleBean);
								clmDrawSaleDetailMap.put(keyGen, beanList);
							}
						}
					}

					// get data from draw sale refund table
					pstmtRefund = con.prepareStatement(fetchDrawRefundClmBal);
					pstmtRefund.setInt(1, gameNbr);
					pstmtRefund.setInt(2, userOrgId);
					pstmtRefund.setString(3, status);
					ResultSet resultRefund = pstmtRefund.executeQuery();
					List&lt;ClmDrawSaleBean&gt; beanRefundList = new ArrayList&lt;ClmDrawSaleBean&gt;();
					// Map clmDrawSaleRefundDetailMap = new TreeMap();

					// String keyRefund=&quot;-1&quot;;
					while (resultRefund.next()) {
						darwSaleBean = new ClmDrawSaleBean();
						double mrpAmt = resultRefund.getDouble(&quot;mrp_amt&quot;);
						double retComm = resultRefund
								.getDouble(&quot;retailer_comm&quot;);
						double agentComm = resultRefund.getDouble(&quot;agent_comm&quot;);
						double goodCauseAmt = resultRefund
								.getDouble(&quot;good_cause_amt&quot;);
						int game_id = resultRefund.getInt(&quot;game_id&quot;);
						double cancellationCharges = resultRefund
								.getDouble(&quot;cancellation_charges&quot;);
						String refundType = resultRefund
								.getString(&quot;transaction_type&quot;);
						if (mrpAmt != 0) {
							String keyGenRefund = game_id + &quot;:&quot;
									+ (retComm * 100 / mrpAmt) + &quot;:&quot;
									+ (agentComm * 100 / mrpAmt) + &quot;:&quot;
									+ (goodCauseAmt * 100 / mrpAmt) + &quot;:&quot;
									+ refundType;
							darwSaleBean.setPricePayRatio(ppr);
							darwSaleBean.setVatAmt(vatAmt);
							darwSaleBean.setMrpAmt(mrpAmt);
							darwSaleBean.setRetComm(retComm);
							darwSaleBean.setAgtComm(agentComm);
							darwSaleBean.setAgtGoodCauseAmt(goodCauseAmt);
							darwSaleBean.setGameId(game_id);
							darwSaleBean.setTransactinId(resultRefund
									.getLong(&quot;transaction_id&quot;));
							darwSaleBean.setGameNbr(gameNbr);
							darwSaleBean
									.setCancellationCharges(cancellationCharges);
							// modify same as sale

							if (clmDrawSaleRefundDetailMap
									.containsKey(keyGenRefund)) {
								beanRefundList = (clmDrawSaleRefundDetailMap
										.get(keyGenRefund));
								beanRefundList.add(darwSaleBean);
								clmDrawSaleRefundDetailMap.put(keyGenRefund,
										beanRefundList);
							} else {
								beanRefundList = new ArrayList&lt;ClmDrawSaleBean&gt;();
								beanRefundList.add(darwSaleBean);
								clmDrawSaleRefundDetailMap.put(keyGenRefund,
										beanRefundList);
							}

						}

					}
				}
			} else if (&quot;AGENT&quot;.equalsIgnoreCase(orgType)) {
				fetchClmBalOfOrgQuery = &quot;select transaction_id ,mrp_amt ,retailer_comm,agent_comm,govt_comm,&quot;
						+ &quot;vat_amt,taxable_sale,game_id,(agent_comm*100/mrp_amt) agt_comm_rate,(govt_comm*100/mrp_amt) &quot;
						+ &quot;good_cause_rate from st_dg_agt_sale where agent_org_id=? and claim_status=? &quot;
						+ &quot;order by game_id,agt_comm_rate,good_cause_rate&quot;;

				fetchDrawRefundClmBal = &quot;select a.transaction_id ,b.transaction_type,a.mrp_amt ,a.retailer_comm,a.agent_comm,govt_comm,a.vat_amt,&quot;
						+ &quot;a.taxable_sale,a.game_id,(a.agent_comm*100/a.mrp_amt) agt_comm_rate,(a.govt_comm*100/a.mrp_amt) &quot;
						+ &quot;good_cause_rate,a.cancellation_charges from st_dg_agt_sale_refund a,st_lms_agent_transaction_master b where a.agent_org_id=? and a.claim_status=? and a.transaction_id=b.transaction_id &quot;
						+ &quot; order by a.game_id,agt_comm_rate,good_cause_rate,b.transaction_type&quot;;

				pstmt = con.prepareStatement(fetchClmBalOfOrgQuery);
				pstmt.setInt(1, userOrgId);
				pstmt.setString(2, status);
				ResultSet result = pstmt.executeQuery();
				List&lt;ClmDrawSaleBean&gt; beanList = new ArrayList&lt;ClmDrawSaleBean&gt;();
				// String key=&quot;-1&quot;;
				while (result.next()) {
					darwSaleBean = new ClmDrawSaleBean();
					double mrpAmt = result.getDouble(&quot;mrp_amt&quot;);
					double agentComm = result.getDouble(&quot;agent_comm&quot;);
					double goodCauseAmt = result.getDouble(&quot;govt_comm&quot;);
					int game_id = result.getInt(&quot;game_id&quot;);
					if (mrpAmt != 0) {
						String keyGen = game_id + &quot;:&quot;
								+ (agentComm * 100 / mrpAmt) + &quot;:&quot;
								+ (goodCauseAmt * 100 / mrpAmt);

						darwSaleBean.setMrpAmt(mrpAmt);
						darwSaleBean.setAgtComm(agentComm);
						darwSaleBean.setAgtGoodCauseAmt(goodCauseAmt);
						darwSaleBean.setGameId(game_id);
						darwSaleBean.setTransactinId(result
								.getLong(&quot;transaction_id&quot;));

						// modify same as retailer

						if (clmDrawSaleDetailMap.containsKey(keyGen)) {
							beanList = (clmDrawSaleDetailMap.get(keyGen));
							beanList.add(darwSaleBean);
							clmDrawSaleDetailMap.put(keyGen, beanList);
						} else {
							beanList = new ArrayList&lt;ClmDrawSaleBean&gt;();
							beanList.add(darwSaleBean);
							clmDrawSaleDetailMap.put(keyGen, beanList);
						}
					}

				}

				// get data from draw sale refund table
				pstmtRefund = con.prepareStatement(fetchDrawRefundClmBal);
				pstmtRefund.setInt(1, userOrgId);
				pstmtRefund.setString(2, status);
				ResultSet resultRefund = pstmtRefund.executeQuery();
				List&lt;ClmDrawSaleBean&gt; beanRefundList = new ArrayList&lt;ClmDrawSaleBean&gt;();

				// String keyRefund=&quot;-1&quot;;
				while (resultRefund.next()) {
					darwSaleBean = new ClmDrawSaleBean();
					double mrpAmt = resultRefund.getDouble(&quot;mrp_amt&quot;);
					double agentComm = resultRefund.getDouble(&quot;agent_comm&quot;);
					double goodCauseAmt = resultRefund.getDouble(&quot;govt_comm&quot;);
					int game_id = resultRefund.getInt(&quot;game_id&quot;);
					double cancellationCharges = resultRefund
							.getDouble(&quot;cancellation_charges&quot;);
					String refundType = resultRefund
							.getString(&quot;transaction_type&quot;);
					if (mrpAmt != 0) {
						String keyGenRefund = game_id + &quot;:&quot;
								+ (agentComm * 100 / mrpAmt) + &quot;:&quot;
								+ (goodCauseAmt * 100 / mrpAmt) + &quot;:&quot;
								+ refundType;

						darwSaleBean.setMrpAmt(mrpAmt);
						darwSaleBean.setAgtComm(agentComm);
						darwSaleBean.setAgtGoodCauseAmt(goodCauseAmt);
						darwSaleBean.setGameId(game_id);
						darwSaleBean.setTransactinId(resultRefund
								.getLong(&quot;transaction_id&quot;));
						darwSaleBean
								.setCancellationCharges(cancellationCharges);
						// modify same as retailer

						if (clmDrawSaleRefundDetailMap
								.containsKey(keyGenRefund)) {
							beanRefundList = (clmDrawSaleRefundDetailMap
									.get(keyGenRefund));
							beanRefundList.add(darwSaleBean);
							clmDrawSaleRefundDetailMap.put(keyGenRefund,
									beanRefundList);
						} else {
							beanRefundList = new ArrayList&lt;ClmDrawSaleBean&gt;();
							beanRefundList.add(darwSaleBean);
							clmDrawSaleRefundDetailMap.put(keyGenRefund,
									beanRefundList);
						}
					}
				}

			}

			if (clmDrawSaleDetailMap != null &amp;&amp; !clmDrawSaleDetailMap.isEmpty())
				map.put(&quot;drawSaleMap&quot;, clmDrawSaleDetailMap);
			if (clmDrawSaleRefundDetailMap != null
					&amp;&amp; !clmDrawSaleRefundDetailMap.isEmpty())
				map.put(&quot;drawSaleRefundMap&quot;, clmDrawSaleRefundDetailMap);

			return map;

		} catch (SQLException e) {
			e.printStackTrace();
			throw new LMSException(e);
		}
	}*/

	public static void main(String[] args) {
		try {

<span class="nc" id="L1299">			DBConnect co = new DBConnect();</span>
<span class="nc" id="L1300">			Connection con = co.getConnection();</span>
<span class="nc" id="L1301">			CommonFunctionsHelper t = new CommonFunctionsHelper();</span>
			// t.updateClmableBalOfOrg(533,162, &quot;AGENT&quot;);
<span class="nc" id="L1303">		} catch (Exception e) {</span>
			// TODO Auto-generated catch block
<span class="nc" id="L1305">			e.printStackTrace();</span>
<span class="nc" id="L1306">		}</span>
<span class="nc" id="L1307">	}</span>

	/**
	 * this method is depricated and not used commented on 10 july 2013 by sumit
	 * 
	 * @param drawMap
	 * @param retOrgId
	 * @param retParentUserId
	 * @param retParentOrgId
	 * @param con
	 * @return
	 * @throws LMSException
	 */
/*	public String updateClaimableForDrawSaleRet(Map drawMap, int retOrgId,
			int retParentUserId, int retParentOrgId, Connection con)
			throws LMSException {
		System.out.println(&quot;insideeeeeeeeeeeeeeeeeeeee&quot;);
		double retDebitAmount = 0.0;// total amount of retailer that would be
		// deducted from retailers ACA
		List&lt;Long&gt; trnIdListInvoice = new ArrayList&lt;Long&gt;();
		List&lt;Long&gt; trnIdListCRNote = new ArrayList&lt;Long&gt;();
		String autoGeneRecieptNo = null;
		try {

			Map&lt;String, List&lt;ClmDrawSaleBean&gt;&gt; drawSaleMap = (Map) drawMap
					.get(&quot;drawSaleMap&quot;);
			Map&lt;String, List&lt;ClmDrawSaleBean&gt;&gt; drawSaleRefundMap = (Map) drawMap
					.get(&quot;drawSaleRefundMap&quot;);
			List&lt;ClmDrawSaleBean&gt; drawSaleBeanList = null;

			if (drawSaleMap != null) {
				Set keySet = drawSaleMap.keySet();
				for (Object key : keySet) {
					drawSaleBeanList = drawSaleMap.get(key);
					double totalMrpAmt = 0.0;
					double totalRetComm = 0.0;
					double totalAgtComm = 0.0;
					double totalretNetAmt = 0.0;
					double totalAgtNetAmt = 0.0;
					double totalGoodCauseAmt = 0.0;
					double ppr = 0.0;
					double vatAmt = 0.0;
					if (!drawSaleBeanList.isEmpty()) {
						ppr = drawSaleBeanList.get(0).getPricePayRatio();
						vatAmt = drawSaleBeanList.get(0).getVatAmt();
					}
					for (ClmDrawSaleBean clmDrawSaleBean : drawSaleBeanList) {
						totalMrpAmt = totalMrpAmt + clmDrawSaleBean.getMrpAmt();
						totalRetComm = totalRetComm
								+ clmDrawSaleBean.getRetComm();
						totalAgtComm = totalAgtComm
								+ clmDrawSaleBean.getAgtComm();
						totalGoodCauseAmt = totalGoodCauseAmt
								+ clmDrawSaleBean.getAgtGoodCauseAmt();
					}
					totalretNetAmt = totalMrpAmt - totalRetComm;
					totalAgtNetAmt = totalMrpAmt - totalAgtComm;

					// calculate agt vat , agt taxable sale and agt good cause
					double retCommRate = Double.parseDouble(((String) key)
							.split(&quot;:&quot;)[1]);
					double goodCauserate = Double.parseDouble(((String) key)
							.split(&quot;:&quot;)[3]);

					double totalAgtVat = CommonMethods.calculateDrawGameVatRet(
							totalMrpAmt, retCommRate, ppr, goodCauserate,
							vatAmt);
					double tatalAgtTaxableSale = CommonMethods.calTaxableSale(
							totalMrpAmt, retCommRate, ppr, goodCauserate,
							vatAmt);

					retDebitAmount = retDebitAmount + totalretNetAmt;

					// insert in main transaction table
					PreparedStatement pstmt = con.prepareStatement(QueryManager
							.insertInLMSTransactionMaster());
					pstmt.setString(1, &quot;AGENT&quot;);
					pstmt.executeUpdate();
					ResultSet rsTrns = pstmt.getGeneratedKeys();
					if (rsTrns.next()) {
						long transId = rsTrns.getLong(1);
						trnIdListInvoice.add(transId);
						// insert in agent transaction master
						pstmt = con.prepareStatement(QueryManager
								.insertInAgentTransactionMaster());
						pstmt.setLong(1, transId);
						pstmt.setInt(2, retParentUserId);
						pstmt.setInt(3, retParentOrgId);
						pstmt.setString(4, &quot;RETAILER&quot;);
						pstmt.setInt(5, retOrgId);
						pstmt.setString(6, &quot;DG_SALE&quot;);
						pstmt.setTimestamp(7, new java.sql.Timestamp(new Date()
								.getTime()));
						pstmt.executeUpdate();

						// insert in agent draw game sale table
						pstmt = con
								.prepareStatement(&quot;insert into st_dg_agt_sale(transaction_id,agent_org_id,retailer_org_id,game_id,mrp_amt,retailer_comm,net_amt,agent_comm,bo_net_amt,claim_status,vat_amt,taxable_sale,govt_comm) values(?,?,?,?,?,?,?,?,?,?,?,?,?)&quot;);
						pstmt.setLong(1, transId);
						pstmt.setInt(2, retParentOrgId);
						pstmt.setInt(3, retOrgId);
						pstmt.setInt(4, Integer.parseInt(((String) key)
								.split(&quot;:&quot;)[0]));
						pstmt.setDouble(5, totalMrpAmt);
						pstmt.setDouble(6, totalRetComm);
						pstmt.setDouble(7, totalretNetAmt);
						pstmt.setDouble(8, totalAgtComm);
						pstmt.setDouble(9, totalAgtNetAmt);
						pstmt.setString(10, &quot;CLAIM_BAL&quot;);
						pstmt.setDouble(11, totalAgtVat);
						pstmt.setDouble(12, tatalAgtTaxableSale);
						pstmt.setDouble(13, totalGoodCauseAmt);
						pstmt.executeUpdate();

						// update retailer draw table for claim_done
						for (ClmDrawSaleBean clmDrawSaleBean : drawSaleBeanList) {
							pstmt = con
									.prepareStatement(&quot;update st_dg_ret_sale_? set claim_status=?,agent_ref_transaction_id=? where transaction_id=?&quot;);
							pstmt.setInt(1, clmDrawSaleBean.getGameNbr());
							pstmt.setString(2, &quot;DONE_CLAIM&quot;);
							pstmt.setLong(3, transId);
							pstmt.setLong(4, clmDrawSaleBean.getTransactinId());
							pstmt.executeUpdate();

						}
					}
				}

				// genarate receipt here
				// int invoiceId = -1;
				// String autoGeneRecieptNo=null;
				if (trnIdListInvoice.size() &gt; 0 &amp;&amp; trnIdListInvoice != null) {
					PreparedStatement agtReceiptNoGenStmt = connection
							.prepareStatement(QueryManager
									.getAGENTLatestReceiptNb());
					agtReceiptNoGenStmt.setString(1, &quot;INVOICE&quot;);
					agtReceiptNoGenStmt.setInt(2, retParentOrgId);
					ResultSet recieptRs = agtReceiptNoGenStmt.executeQuery();
					String lastRecieptNoGenerated = null;
					while (recieptRs.next()) {
						lastRecieptNoGenerated = recieptRs
								.getString(&quot;generated_id&quot;);
					}

					// String autoGeneRecieptNo=null;
					autoGeneRecieptNo = GenerateRecieptNo.getRecieptNoAgt(
							&quot;INVOICE&quot;, lastRecieptNoGenerated, &quot;AGENT&quot;,
							retParentOrgId);

					// insert in receipt master for invoice

					agtReceiptNoGenStmt = connection
							.prepareStatement(QueryManager
									.insertInReceiptMaster());
					agtReceiptNoGenStmt.setString(1, &quot;AGENT&quot;);
					agtReceiptNoGenStmt.executeUpdate();

					ResultSet rs = agtReceiptNoGenStmt.getGeneratedKeys();
					int invoiceId = -1;
					while (rs.next()) {
						invoiceId = rs.getInt(1);
					}

					// insert into agent receipt table

					agtReceiptNoGenStmt = connection
							.prepareStatement(QueryManager
									.insertInAgentReceipts());
					agtReceiptNoGenStmt.setInt(1, invoiceId);
					agtReceiptNoGenStmt.setString(2, &quot;INVOICE&quot;);
					agtReceiptNoGenStmt.setInt(3, retParentOrgId);
					agtReceiptNoGenStmt.setInt(4, retOrgId);
					agtReceiptNoGenStmt.setString(5, &quot;RETAILER&quot;);
					agtReceiptNoGenStmt.setString(6, autoGeneRecieptNo);
					agtReceiptNoGenStmt.setTimestamp(7, Util.getCurrentTimeStamp());
					agtReceiptNoGenStmt.execute();

					agtReceiptNoGenStmt = connection
							.prepareStatement(QueryManager
									.insertAgentReceiptTrnMapping());
					for (int i = 0; i &lt; trnIdListInvoice.size(); i++) {
						agtReceiptNoGenStmt.setInt(1, invoiceId);
						agtReceiptNoGenStmt.setLong(2, trnIdListInvoice.get(i));
						agtReceiptNoGenStmt.execute();

					}

				}

			}
			// update for refund sale
			if (drawSaleRefundMap != null) {
				Set keySetRefund = drawSaleRefundMap.keySet();
				for (Object key : keySetRefund) {
					drawSaleBeanList = drawSaleRefundMap.get(key);
					double totalMrpAmt = 0.0;
					double totalRetComm = 0.0;
					double totalAgtComm = 0.0;
					double totalretNetAmt = 0.0;
					double totalAgtNetAmt = 0.0;
					double totalGoodCauseAmt = 0.0;
					double totalCancellationCharges = 0.0;
					double ppr = 0.0;
					double vatAmt = 0.0;
					if (!drawSaleBeanList.isEmpty()) {
						ppr = drawSaleBeanList.get(0).getPricePayRatio();
						vatAmt = drawSaleBeanList.get(0).getVatAmt();
					}
					for (ClmDrawSaleBean clmDrawSaleBean : drawSaleBeanList) {

						// totalMrpAmt=clmDrawSaleBean.getMrpAmt();
						totalMrpAmt += clmDrawSaleBean.getMrpAmt();

						// totalRetComm=clmDrawSaleBean.getRetComm();
						totalRetComm += clmDrawSaleBean.getRetComm();

						totalCancellationCharges += clmDrawSaleBean
								.getCancellationCharges();

						// totalAgtComm = clmDrawSaleBean.getAgtComm();
						totalAgtComm += clmDrawSaleBean.getAgtComm();

						// totalGoodCauseAmt =
						// clmDrawSaleBean.getAgtGoodCauseAmt();
						totalGoodCauseAmt += clmDrawSaleBean
								.getAgtGoodCauseAmt();

					}
					totalretNetAmt = totalMrpAmt - totalRetComm
							- totalCancellationCharges;
					totalAgtNetAmt = totalMrpAmt - totalAgtComm
							- totalCancellationCharges;

					// calculate agt vat , agt taxable sale and agt good cause

					double totalAgtVat = CommonMethods.calculateDrawGameVatAgt(
							totalMrpAmt, Double.parseDouble(((String) key)
									.split(&quot;:&quot;)[1]), ppr, Double
									.parseDouble(((String) key).split(&quot;:&quot;)[3]),
							vatAmt);
					double tatalAgtTaxableSale = CommonMethods.calTaxableSale(
							totalMrpAmt, Double.parseDouble(((String) key)
									.split(&quot;:&quot;)[1]), ppr, Double
									.parseDouble(((String) key).split(&quot;:&quot;)[3]),
							vatAmt);

					retDebitAmount = retDebitAmount - totalretNetAmt;

					// insert in main transaction master
					// insert in main transaction table
					PreparedStatement pstmt = con.prepareStatement(QueryManager
							.insertInLMSTransactionMaster());
					pstmt.setString(1, &quot;AGENT&quot;);
					pstmt.executeUpdate();
					ResultSet rsTrns = pstmt.getGeneratedKeys();
					if (rsTrns.next()) {
						Long transId = rsTrns.getLong(1);
						trnIdListCRNote.add(transId);
						// insert in agent transaction master
						pstmt = con.prepareStatement(QueryManager
								.insertInAgentTransactionMaster());
						pstmt.setLong(1, transId);
						pstmt.setInt(2, retParentUserId);
						pstmt.setInt(3, retParentOrgId);
						pstmt.setString(4, &quot;RETAILER&quot;);
						pstmt.setInt(5, retOrgId);
						pstmt.setString(6, ((String) key).split(&quot;:&quot;)[4]);
						pstmt.setTimestamp(7, new java.sql.Timestamp(new Date()
								.getTime()));
						pstmt.executeUpdate();

						// insert in agent draw game sale table
						// double retNetAmt=clmDrawSaleBean.getMrpAmt() -
						// clmDrawSaleBean.getRetComm();
						// retDebitAmount+=retNetAmt;
						pstmt = con
								.prepareStatement(&quot;insert into st_dg_agt_sale_refund(transaction_id,agent_org_id,retailer_org_id,game_id,mrp_amt,retailer_comm,net_amt,agent_comm,bo_net_amt,claim_status,vat_amt,taxable_sale,govt_comm,cancellation_charges) values(?,?,?,?,?,?,?,?,?,?,?,?,?,?)&quot;);
						pstmt.setLong(1, transId);
						pstmt.setInt(2, retParentOrgId);
						pstmt.setInt(3, retOrgId);
						pstmt.setInt(4, Integer.parseInt(((String) key)
								.split(&quot;:&quot;)[0]));
						pstmt.setDouble(5, totalMrpAmt);
						pstmt.setDouble(6, totalRetComm);
						pstmt.setDouble(7, totalretNetAmt);
						pstmt.setDouble(8, totalAgtComm);
						pstmt.setDouble(9, totalAgtNetAmt);
						pstmt.setString(10, &quot;CLAIM_BAL&quot;);
						pstmt.setDouble(11, totalAgtVat);
						pstmt.setDouble(12, tatalAgtTaxableSale);
						pstmt.setDouble(13, totalGoodCauseAmt);
						pstmt.setDouble(14, totalCancellationCharges);
						pstmt.executeUpdate();
						System.out.println(&quot;%%%%%insert &quot; + pstmt);

						// update retailer draw table for claim_done
						for (ClmDrawSaleBean clmDrawSaleBean : drawSaleBeanList) {
							pstmt = con
									.prepareStatement(&quot;update st_dg_ret_sale_refund_? set claim_status=?,agent_ref_transaction_id=? where transaction_id=?&quot;);
							pstmt.setInt(1, clmDrawSaleBean.getGameNbr());
							pstmt.setString(2, &quot;DONE_CLAIM&quot;);
							pstmt.setLong(3, transId);
							pstmt.setLong(4, clmDrawSaleBean.getTransactinId());
							pstmt.executeUpdate();

						}
					}
				}

				// genarate receipt here
				// int credit note = -1;
				// String autoGeneRecieptNo=null;
				if (trnIdListCRNote.size() &gt; 0 &amp;&amp; trnIdListCRNote != null) {
					PreparedStatement agtReceiptNoGenStmt = connection
							.prepareStatement(QueryManager
									.getAGENTLatestReceiptNb());
					agtReceiptNoGenStmt.setString(1, &quot;CR_NOTE&quot;);
					agtReceiptNoGenStmt.setInt(2, retParentOrgId);
					ResultSet recieptRs = agtReceiptNoGenStmt.executeQuery();
					String lastRecieptNoGenerated = null;
					while (recieptRs.next()) {
						lastRecieptNoGenerated = recieptRs
								.getString(&quot;generated_id&quot;);
					}

					// String autoGeneRecieptNo=null;
					autoGeneRecieptNo = GenerateRecieptNo.getRecieptNoAgt(
							&quot;CR_NOTE&quot;, lastRecieptNoGenerated, &quot;AGENT&quot;,
							retParentOrgId);

					// insert in receipt master for invoice

					agtReceiptNoGenStmt = connection
							.prepareStatement(QueryManager
									.insertInReceiptMaster());
					agtReceiptNoGenStmt.setString(1, &quot;AGENT&quot;);
					agtReceiptNoGenStmt.executeUpdate();

					ResultSet rs = agtReceiptNoGenStmt.getGeneratedKeys();
					int crNoteId = -1;
					while (rs.next()) {
						crNoteId = rs.getInt(1);
					}

					// insert into agent receipt table

					agtReceiptNoGenStmt = connection
							.prepareStatement(QueryManager
									.insertInAgentReceipts());
					agtReceiptNoGenStmt.setInt(1, crNoteId);
					agtReceiptNoGenStmt.setString(2, &quot;CR_NOTE&quot;);
					agtReceiptNoGenStmt.setInt(3, retParentOrgId);
					agtReceiptNoGenStmt.setInt(4, retOrgId);
					agtReceiptNoGenStmt.setString(5, &quot;RETAILER&quot;);
					agtReceiptNoGenStmt.setString(6, autoGeneRecieptNo);
					agtReceiptNoGenStmt.execute();

					agtReceiptNoGenStmt = connection
							.prepareStatement(QueryManager
									.insertAgentReceiptTrnMapping());
					for (int i = 0; i &lt; trnIdListCRNote.size(); i++) {
						agtReceiptNoGenStmt.setInt(1, crNoteId);
						agtReceiptNoGenStmt.setLong(2, trnIdListCRNote.get(i));
						agtReceiptNoGenStmt.execute();

					}

				}

			}

			System.out.println(&quot;&amp;&amp;&amp;&amp;&amp;77777777 &quot; + retDebitAmount);
			// update organization claimable balance
			OrgCreditUpdation.updateCreditLimitForRetailer(retOrgId,
					&quot;DRAW_GAME_SALE&quot;, retDebitAmount, connection);
			updateOrgBalance(&quot;CLAIM_BAL&quot;, retDebitAmount, retOrgId, &quot;DEBIT&quot;,
					connection);
			return autoGeneRecieptNo;
		} catch (SQLException e) {
			e.printStackTrace();
			throw new LMSException();
		}

	}*/
/**
 * 
 * this method is depricated and not used commented on 10 july 2013 by sumit
 *
 * @param drawMap
 * @param agtOrgId
 * @param agtParentUserId
 * @param agtParentOrgId
 * @param con
 * @return
 * @throws LMSException
 */
/*	public String updateClaimableForDrawSaleAgt(Map drawMap, int agtOrgId,
			int agtParentUserId, int agtParentOrgId, Connection con)
			throws LMSException {
		System.out.println(&quot;insideeeeeeeeeeeeeeeeeeeee agt updation &quot;);
		double agtDebitAmount = 0.0;// total amount of retailer that would be
		// deducted from retailers ACA
		List&lt;Long&gt; trnIdListInvoice = new ArrayList&lt;Long&gt;();
		List&lt;Long&gt; trnIdListCRNote = new ArrayList&lt;Long&gt;();
		String autoGeneRecieptNo = null;
		try {

			Map&lt;String, List&lt;ClmDrawSaleBean&gt;&gt; drawSaleMap = (Map) drawMap
					.get(&quot;drawSaleMap&quot;);
			Map&lt;String, List&lt;ClmDrawSaleBean&gt;&gt; drawSaleRefundMap = (Map) drawMap
					.get(&quot;drawSaleRefundMap&quot;);
			List&lt;ClmDrawSaleBean&gt; drawSaleBeanList = null;
			if (drawSaleMap != null) {
				Set keySet = drawSaleMap.keySet();
				for (Object key : keySet) {
					drawSaleBeanList = drawSaleMap.get(key);
					double totalMrpAmt = 0.0;
					double totalAgtComm = 0.0;
					double totalAgtNetAmt = 0.0;
					double totalGoodCauseAmt = 0.0;
					double ppr = 0.0;
					double vatAmt = 0.0;
					if (!drawSaleBeanList.isEmpty()) {
						getVatAndPpr(con, drawSaleBeanList.get(0), Integer
								.parseInt(((String) key).split(&quot;:&quot;)[0]));
						ppr = drawSaleBeanList.get(0).getPricePayRatio();
						vatAmt = drawSaleBeanList.get(0).getVatAmt();
					}
					for (ClmDrawSaleBean clmDrawSaleBean : drawSaleBeanList) {
						totalMrpAmt += clmDrawSaleBean.getMrpAmt();
						totalAgtComm += clmDrawSaleBean.getAgtComm();
						totalGoodCauseAmt += clmDrawSaleBean
								.getAgtGoodCauseAmt();
					}

					totalAgtNetAmt = totalMrpAmt - totalAgtComm;

					// calculate agt vat , agt taxable sale and agt good cause
					double agtCommRate = Double.parseDouble(((String) key)
							.split(&quot;:&quot;)[1]);
					double goodcauseRate = Double.parseDouble(((String) key)
							.split(&quot;:&quot;)[2]);
					double totalAgtVat = CommonMethods.calculateDrawGameVatAgt(
							totalMrpAmt, agtCommRate, ppr, goodcauseRate,
							vatAmt);
					double tatalAgtTaxableSale = CommonMethods.calTaxableSale(
							totalMrpAmt, agtCommRate, ppr, goodcauseRate,
							vatAmt);

					agtDebitAmount += totalAgtNetAmt;

					// insert in main transaction table
					PreparedStatement pstmt = con.prepareStatement(QueryManager
							.insertInLMSTransactionMaster());
					pstmt.setString(1, &quot;BO&quot;);
					pstmt.executeUpdate();
					ResultSet rsTrns = pstmt.getGeneratedKeys();
					if (rsTrns.next()) {
						long transId = rsTrns.getLong(1);
						trnIdListInvoice.add(transId);
						// insert in bo transaction master
						pstmt = con.prepareStatement(QueryManager
								.insertInBOTransactionMaster());
						pstmt.setLong(1, transId);
						pstmt.setInt(2, agtParentUserId);
						pstmt.setInt(3, agtParentOrgId);
						pstmt.setString(4, &quot;AGENT&quot;);
						pstmt.setInt(5, agtOrgId);
						pstmt.setTimestamp(6, new java.sql.Timestamp(new Date()
								.getTime()));
						pstmt.setString(7, &quot;DG_SALE&quot;);
						pstmt.executeUpdate();

						// insert in bo draw game sale table
						pstmt = con
								.prepareStatement(&quot;insert into st_dg_bo_sale(transaction_id,agent_org_id,game_id,mrp_amt,agent_comm,net_amt,vat_amt,taxable_sale,govt_comm) values(?,?,?,?,?,?,?,?,?)&quot;);
						pstmt.setLong(1, transId);
						pstmt.setInt(2, agtOrgId);
						pstmt.setInt(3, Integer.parseInt(((String) key)
								.split(&quot;:&quot;)[0]));
						pstmt.setDouble(4, totalMrpAmt);
						pstmt.setDouble(5, totalAgtComm);
						pstmt.setDouble(6, totalAgtNetAmt);
						pstmt.setDouble(7, totalAgtVat);
						pstmt.setDouble(8, tatalAgtTaxableSale);
						pstmt.setDouble(9, totalGoodCauseAmt);
						pstmt.executeUpdate();

						// update retailer draw table for claim_done
						for (ClmDrawSaleBean clmDrawSaleBean : drawSaleBeanList) {
							pstmt = con
									.prepareStatement(&quot;update st_dg_agt_sale set claim_status=?,bo_ref_transaction_id=? where transaction_id=?&quot;);
							pstmt.setString(1, &quot;DONE_CLAIM&quot;);
							pstmt.setLong(2, transId);
							pstmt.setLong(3, clmDrawSaleBean.getTransactinId());
							pstmt.executeUpdate();

						}
					}
				}

				// genarate INVOICE at BO End here
				// int invoiceId = -1;
				// String autoGeneRecieptNo = null;
				if (trnIdListInvoice.size() &gt; 0 &amp;&amp; trnIdListInvoice != null) {
					PreparedStatement boReceiptNoGenStmt = connection
							.prepareStatement(QueryManager
									.getBOLatestReceiptNb());
					boReceiptNoGenStmt.setString(1, &quot;INVOICE&quot;);
					ResultSet recieptRs = boReceiptNoGenStmt.executeQuery();
					String lastRecieptNoGenerated = null;

					while (recieptRs.next()) {
						lastRecieptNoGenerated = recieptRs
								.getString(&quot;generated_id&quot;);
					}

					// String autoGeneRecieptNo = null;
					autoGeneRecieptNo = GenerateRecieptNo.getRecieptNo(
							&quot;INVOICE&quot;, lastRecieptNoGenerated, &quot;BO&quot;);

					boReceiptNoGenStmt = connection
							.prepareStatement(QueryManager
									.insertInReceiptMaster());
					boReceiptNoGenStmt.setString(1, &quot;BO&quot;);
					boReceiptNoGenStmt.executeUpdate();

					ResultSet rs = boReceiptNoGenStmt.getGeneratedKeys();
					int invoiceId = -1;
					while (rs.next()) {
						invoiceId = rs.getInt(1);
					}

					// insert in bo receipts
					boReceiptNoGenStmt = connection
							.prepareStatement(QueryManager.insertInBOReceipts());
					boReceiptNoGenStmt.setInt(1, invoiceId);
					boReceiptNoGenStmt.setString(2, &quot;INVOICE&quot;);
					boReceiptNoGenStmt.setInt(3, agtOrgId);
					boReceiptNoGenStmt.setString(4, &quot;AGENT&quot;);
					boReceiptNoGenStmt.setString(5, autoGeneRecieptNo);
					boReceiptNoGenStmt.setTimestamp(6, Util.getCurrentTimeStamp());
					boReceiptNoGenStmt.execute();

					boReceiptNoGenStmt = connection
							.prepareStatement(QueryManager
									.insertBOReceiptTrnMapping());

					for (int i = 0; i &lt; trnIdListInvoice.size(); i++) {
						boReceiptNoGenStmt.setInt(1, invoiceId);
						boReceiptNoGenStmt.setLong(2, trnIdListInvoice.get(i));
						boReceiptNoGenStmt.execute();

					}
				}

			}
			// update for refund sale
			if (drawSaleRefundMap != null) {
				Set keySetRefund = drawSaleRefundMap.keySet();
				for (Object key : keySetRefund) {
					drawSaleBeanList = drawSaleRefundMap.get(key);
					double totalMrpAmt = 0.0;
					double totalAgtComm = 0.0;
					double totalAgtNetAmt = 0.0;
					double totalGoodCauseAmt = 0.0;
					double totalCancellationCharges = 0.0;
					double ppr = 0.0;
					double vatAmt = 0.0;
					if (!drawSaleBeanList.isEmpty()) {
						ppr = drawSaleBeanList.get(0).getPricePayRatio();
						vatAmt = drawSaleBeanList.get(0).getVatAmt();
					}
					for (ClmDrawSaleBean clmDrawSaleBean : drawSaleBeanList) {
						totalMrpAmt += clmDrawSaleBean.getMrpAmt();
						totalAgtComm += clmDrawSaleBean.getAgtComm();
						totalCancellationCharges += clmDrawSaleBean
								.getCancellationCharges();
						totalGoodCauseAmt += clmDrawSaleBean
								.getAgtGoodCauseAmt();
					}

					totalAgtNetAmt = totalMrpAmt - totalAgtComm
							- totalCancellationCharges;

					// calculate agt vat , agt taxable sale and agt good cause
					double agtCommRate = Double.parseDouble(((String) key)
							.split(&quot;:&quot;)[1]);
					double goodcauseRate = Double.parseDouble(((String) key)
							.split(&quot;:&quot;)[2]);
					double totalAgtVat = CommonMethods.calculateDrawGameVatAgt(
							totalMrpAmt, agtCommRate, ppr, goodcauseRate,
							vatAmt);
					// double tatalAgtTaxableSale =
					// (((totalMrpAmt*(100-(Double.parseDouble(((String)key).split(&quot;:&quot;)[1])*100/totalMrpAmt
					// + 50
					// +Double.parseDouble(((String)key).split(&quot;:&quot;)[2])*100/totalMrpAmt)))/100)*100)/(100+16);
					double tatalAgtTaxableSale = CommonMethods.calTaxableSale(
							totalMrpAmt, agtCommRate, ppr, goodcauseRate,
							vatAmt);
					agtDebitAmount -= totalAgtNetAmt;

					// insert in main transaction table
					PreparedStatement pstmt = con.prepareStatement(QueryManager
							.insertInLMSTransactionMaster());
					pstmt.setString(1, &quot;BO&quot;);
					pstmt.executeUpdate();
					ResultSet rsTrns = pstmt.getGeneratedKeys();
					if (rsTrns.next()) {
						long transId = rsTrns.getLong(1);
						trnIdListCRNote.add(transId);
						// insert in bo transaction master
						pstmt = con.prepareStatement(QueryManager
								.insertInBOTransactionMaster());
						pstmt.setLong(1, transId);
						pstmt.setInt(2, agtParentUserId);
						pstmt.setInt(3, agtParentOrgId);
						pstmt.setString(4, &quot;AGENT&quot;);
						pstmt.setInt(5, agtOrgId);
						pstmt.setTimestamp(6, new java.sql.Timestamp(new Date()
								.getTime()));
						pstmt.setString(7, ((String) key).split(&quot;:&quot;)[3]);
						pstmt.executeUpdate();

						// insert in bo draw game sale table
						pstmt = con
								.prepareStatement(&quot;insert into st_dg_bo_sale_refund(transaction_id,agent_org_id,game_id,mrp_amt,agent_comm,net_amt,vat_amt,taxable_sale,govt_comm,cancellation_charges) values(?,?,?,?,?,?,?,?,?,?)&quot;);
						pstmt.setLong(1, transId);
						pstmt.setInt(2, agtOrgId);
						pstmt.setInt(3, Integer.parseInt(((String) key)
								.split(&quot;:&quot;)[0]));
						pstmt.setDouble(4, totalMrpAmt);
						pstmt.setDouble(5, totalAgtComm);
						pstmt.setDouble(6, totalAgtNetAmt);
						pstmt.setDouble(7, totalAgtVat);
						pstmt.setDouble(8, tatalAgtTaxableSale);
						pstmt.setDouble(9, totalGoodCauseAmt);
						pstmt.setDouble(10, totalCancellationCharges);
						pstmt.executeUpdate();
						System.out.println(&quot;%%%%%insert &quot; + pstmt);

						// update retailer draw table for claim_done
						for (ClmDrawSaleBean clmDrawSaleBean : drawSaleBeanList) {
							pstmt = con
									.prepareStatement(&quot;update st_dg_agt_sale_refund set claim_status=?,bo_ref_transaction_id=? where transaction_id=?&quot;);
							pstmt.setString(1, &quot;DONE_CLAIM&quot;);
							pstmt.setLong(2, transId);
							pstmt.setLong(3, clmDrawSaleBean.getTransactinId());
							pstmt.executeUpdate();

						}
					}
				}

				// genarate INVOICE at BO End here
				// int invoiceId = -1;
				// String autoGeneRecieptNo = null;
				if (trnIdListCRNote.size() &gt; 0 &amp;&amp; trnIdListCRNote != null) {
					PreparedStatement boReceiptNoGenStmt = connection
							.prepareStatement(&quot;SELECT generated_id from st_lms_bo_receipts where receipt_type like ('CR_NOTE%')  ORDER BY generated_id DESC LIMIT 1&quot;);
					// boReceiptNoGenStmt.setString(1, &quot;INVOICE&quot;);
					ResultSet recieptRs = boReceiptNoGenStmt.executeQuery();
					String lastRecieptNoGenerated = null;

					while (recieptRs.next()) {
						lastRecieptNoGenerated = recieptRs
								.getString(&quot;generated_id&quot;);
					}

					// String autoGeneRecieptNo = null;
					autoGeneRecieptNo = GenerateRecieptNo.getRecieptNo(
							&quot;CR_NOTE&quot;, lastRecieptNoGenerated, &quot;BO&quot;);

					boReceiptNoGenStmt = connection
							.prepareStatement(QueryManager
									.insertInReceiptMaster());
					boReceiptNoGenStmt.setString(1, &quot;BO&quot;);
					boReceiptNoGenStmt.executeUpdate();

					ResultSet rs = boReceiptNoGenStmt.getGeneratedKeys();
					int crNoteId = -1;
					while (rs.next()) {
						crNoteId = rs.getInt(1);
					}

					// insert in bo receipts
					boReceiptNoGenStmt = connection
							.prepareStatement(QueryManager.insertInBOReceipts());
					boReceiptNoGenStmt.setInt(1, crNoteId);
					boReceiptNoGenStmt.setString(2, &quot;CR_NOTE&quot;);
					boReceiptNoGenStmt.setInt(3, agtOrgId);
					boReceiptNoGenStmt.setString(4, &quot;AGENT&quot;);
					boReceiptNoGenStmt.setString(5, autoGeneRecieptNo);
					boReceiptNoGenStmt.execute();

					boReceiptNoGenStmt = connection
							.prepareStatement(QueryManager
									.insertBOReceiptTrnMapping());

					for (int i = 0; i &lt; trnIdListCRNote.size(); i++) {
						boReceiptNoGenStmt.setInt(1, crNoteId);
						boReceiptNoGenStmt.setLong(2, trnIdListCRNote.get(i));
						boReceiptNoGenStmt.execute();

					}
				}

			}

			System.out.println(&quot;Agent Debit Amount &quot; + agtDebitAmount);
			// update organization claimable balance
			OrgCreditUpdation.updateCreditLimitForAgent(agtOrgId,
					&quot;DRAW_GAME_SALE&quot;, agtDebitAmount, connection);
			updateOrgBalance(&quot;CLAIM_BAL&quot;, agtDebitAmount, agtOrgId, &quot;DEBIT&quot;,
					connection);
			return autoGeneRecieptNo;
		} catch (SQLException e) {
			e.printStackTrace();
			throw new LMSException();
		}

	}
*/
	
	/**
	 * this method is depricated and not used commented on 10 july 2013 by sumit
	 * 
	 * 
	 */
/*	public List&lt;UserInfoBean&gt; getOrgIdNClmAmtList(Connection con)
			throws SQLException {
		List&lt;UserInfoBean&gt; orgList = new ArrayList&lt;UserInfoBean&gt;();
		String getOrgIdNClmListQuery = &quot;select aa.organization_id, aa.organization_type, aa.parent_id, aa.name, &quot;
				+ &quot; aa.claimable_bal, bb.user_id from st_lms_organization_master aa, st_lms_user_master bb where &quot;
				+ &quot; aa.organization_id = bb.organization_id and bb.isrolehead = 'Y' and &quot;
				+ &quot; (aa.organization_type = 'AGENT' or aa.organization_type = 'RETAILER') and &quot;
				+ &quot; aa.claimable_bal&gt;0 and aa.organization_status!='TERMINATE' order by organization_type desc&quot;;
		PreparedStatement pstmt = con.prepareStatement(getOrgIdNClmListQuery);
		ResultSet rs = pstmt.executeQuery();
		System.out.println(&quot;getOrgIdNClmAmtListQuery is = &quot; + pstmt);
		UserInfoBean userBean = null;
		while (rs.next()) {
			userBean = new UserInfoBean();
			userBean.setUserOrgId(rs.getInt(&quot;organization_id&quot;));
			userBean.setUserId(rs.getInt(&quot;user_id&quot;));
			userBean.setClaimableBal(rs.getDouble(&quot;claimable_bal&quot;));
			userBean.setUserType(rs.getString(&quot;organization_type&quot;));
			userBean.setOrgName(rs.getString(&quot;name&quot;));
			userBean.setParentOrgId(rs.getInt(&quot;parent_id&quot;));
			orgList.add(userBean);
		}
		return orgList;
	}
*/
	public String boEndAgtPWTPaymentProcess(List&lt;PwtBean&gt; pwtList, int gameId,
			String boOrgName, int userOrgID, int agentOrgId, int agtUserId,
			String rootPath, int userId, int gameNbr) throws LMSException {

<span class="nc" id="L2065">		Connection connection = null;</span>
<span class="nc" id="L2066">		PreparedStatement masterPstmt = null;</span>
<span class="nc" id="L2067">		PreparedStatement LMSMasterPstmt = null;</span>
<span class="nc" id="L2068">		PreparedStatement detailPstmt = null;</span>
<span class="nc" id="L2069">		PreparedStatement invPstmt = null;</span>
	//	PreparedStatement agtPwtUpdatePstmt = null;

<span class="nc" id="L2072">		ResultSet resultSet = null;</span>

<span class="nc" id="L2074">		long trnId = -1;</span>
<span class="nc" id="L2075">		int boReceiptId = -1;</span>
		// String receiptArr []=null;
<span class="nc" id="L2077">		String receipts = null;</span>
		try {
<span class="nc bnc" id="L2079" title="All 2 branches missed.">			if (pwtList != null) {</span>
<span class="nc" id="L2080">				int size = pwtList.size();</span>
<span class="nc" id="L2081">				PwtBean pwtBean = null;</span>

<span class="nc" id="L2083">				String masterQuery = null;</span>
<span class="nc" id="L2084">				String LMSMasterQuery = null;</span>
<span class="nc" id="L2085">				String detailQuery = null;</span>
<span class="nc" id="L2086">				String invQuery = null;</span>

<span class="nc" id="L2088">				double pwtAmt = 0.0;</span>
<span class="nc" id="L2089">				double commAmt = 0.0;</span>
<span class="nc" id="L2090">				double netAmt = 0.0;</span>
<span class="nc" id="L2091">				double creditAmt = 0.0;</span>
<span class="nc" id="L2092">				double debitUnclaim = 0.0;</span>

<span class="nc bnc" id="L2094" title="All 2 branches missed.">				if (size &gt; 0) {</span>

<span class="nc" id="L2096">					DBConnect dbConnect = new DBConnect();</span>
<span class="nc" id="L2097">					connection = dbConnect.getConnection();</span>
<span class="nc" id="L2098">					connection.setAutoCommit(false);</span>

					// get agents game pwtCommRate
<span class="nc" id="L2101">					CommonFunctionsHelper commonHelper = new CommonFunctionsHelper();</span>
<span class="nc" id="L2102">					double agtPwtCommRate = commonHelper</span>
							.fetchCommOfOrganization(gameId, agentOrgId, &quot;PWT&quot;,
									&quot;AGENT&quot;, connection);

<span class="nc" id="L2106">					masterQuery = QueryManager.insertInBOTransactionMaster();</span>
<span class="nc" id="L2107">					masterPstmt = connection.prepareStatement(masterQuery);</span>

<span class="nc" id="L2109">					detailQuery = QueryManager.getST1PwtBODetailQuery();</span>
<span class="nc" id="L2110">					detailPstmt = connection.prepareStatement(detailQuery);</span>

<span class="nc" id="L2112">					invQuery = QueryManager.getST1PWTBOUpdateQuery();</span>
<span class="nc" id="L2113">					invPstmt = connection.prepareStatement(invQuery);</span>

					// update st_se_agent_pwt in case if agent brings uncalimed
					// PWTs to BO
				//	String agtPwtUpdateQuery = &quot;update  st_se_agent_pwt set status=? where game_id = ? and virn_code = ? and agent_org_id = ? &quot;;
				//  agtPwtUpdatePstmt = connection
				//			.prepareStatement(agtPwtUpdateQuery);

					// insert into transaction master
<span class="nc" id="L2122">					LMSMasterQuery = QueryManager</span>
							.insertInLMSTransactionMaster();
<span class="nc" id="L2124">					LMSMasterPstmt = connection</span>
							.prepareStatement(LMSMasterQuery);
<span class="nc" id="L2126">					LMSMasterPstmt.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L2127">					LMSMasterPstmt.executeUpdate();</span>
<span class="nc" id="L2128">					resultSet = LMSMasterPstmt.getGeneratedKeys();</span>
<span class="nc bnc" id="L2129" title="All 2 branches missed.">					if (resultSet.next())</span>
<span class="nc" id="L2130">						trnId = resultSet.getLong(1);</span>
					else
<span class="nc" id="L2132">						throw new LMSException(</span>
								&quot;Transaction id is not generated&quot;);

					// insert into BO transaction master
<span class="nc" id="L2136">					masterPstmt.setLong(1, trnId);</span>
<span class="nc" id="L2137">					masterPstmt.setInt(2, userId);</span>
<span class="nc" id="L2138">					masterPstmt.setInt(3, userOrgID);</span>
<span class="nc" id="L2139">					masterPstmt.setString(4, &quot;AGENT&quot;);</span>
<span class="nc" id="L2140">					masterPstmt.setInt(5, agentOrgId);</span>
<span class="nc" id="L2141">					masterPstmt.setTimestamp(6, new java.sql.Timestamp(</span>
							new java.util.Date().getTime()));
<span class="nc" id="L2143">					masterPstmt.setString(7, &quot;PWT&quot;);</span>
<span class="nc" id="L2144">					masterPstmt.execute();</span>
<span class="nc" id="L2145">					System.out.println(&quot;transaction Id::&quot; + trnId);</span>

<span class="nc bnc" id="L2147" title="All 2 branches missed.">					for (int i = 0; i &lt; size; i++) {</span>
<span class="nc" id="L2148">						pwtBean = (PwtBean) pwtList.get(i);</span>

<span class="nc bnc" id="L2150" title="All 2 branches missed.">						if (pwtBean.getIsValid()) {</span>

<span class="nc" id="L2152">							String encodedVirn = pwtBean.getEncVirnCode();</span>
<span class="nc" id="L2153">							detailPstmt.setString(1, encodedVirn);</span>
<span class="nc" id="L2154">							detailPstmt.setLong(2, trnId);</span>
<span class="nc" id="L2155">							detailPstmt.setInt(3, gameId);</span>
<span class="nc" id="L2156">							detailPstmt.setInt(4, agtUserId);</span>
<span class="nc" id="L2157">							detailPstmt.setInt(5, agentOrgId);</span>

<span class="nc" id="L2159">							pwtAmt = Double.parseDouble(pwtBean.getPwtAmount());</span>
<span class="nc" id="L2160">							commAmt = pwtAmt * agtPwtCommRate * 0.01;</span>
<span class="nc" id="L2161">							netAmt = pwtAmt + commAmt;</span>
							// for current credit amount update
<span class="nc" id="L2163">							creditAmt += netAmt;</span>

<span class="nc" id="L2165">							detailPstmt.setDouble(6, pwtAmt);</span>
<span class="nc" id="L2166">							detailPstmt.setDouble(7, commAmt);</span>
<span class="nc" id="L2167">							detailPstmt.setDouble(8, netAmt);</span>
<span class="nc" id="L2168">							detailPstmt.execute();</span>

<span class="nc bnc" id="L2170" title="All 4 branches missed.">							if (&quot;IN_PLR_UNCLM&quot;.equalsIgnoreCase(pwtBean</span>
									.getInUnclmed())
									|| &quot;IN_AGENT_UNCLM&quot;
											.equalsIgnoreCase(pwtBean
													.getInUnclmed())) {
								String tableType;
<span class="nc bnc" id="L2176" title="All 2 branches missed.">								if (&quot;IN_PLR_UNCLM&quot;.equalsIgnoreCase(pwtBean</span>
										.getInUnclmed()))
<span class="nc" id="L2178">									tableType = &quot;PLAYER&quot;;</span>
								else
<span class="nc" id="L2180">									tableType = &quot;AGENT&quot;;</span>

<span class="nc" id="L2182">								commonHelper.updateOrgForUnClaimedVirn(</span>
										agentOrgId, &quot;AGENT&quot;, encodedVirn,
										&quot;DONE_UNCLM&quot;, gameId, tableType,
										connection,pwtBean.getTicketNumber());
<span class="nc" id="L2186">								debitUnclaim += pwtAmt;</span>
							}

							// update the remaining prize list
<span class="nc" id="L2190">							GameUtilityHelper.updateNoOfPrizeRem(gameId,</span>
									pwtAmt, &quot;CLAIM_AGT&quot;, encodedVirn,
									connection, gameNbr);

<span class="nc" id="L2194">							invPstmt.setInt(1, gameNbr);</span>
<span class="nc" id="L2195">							invPstmt.setInt(2, gameId);</span>
<span class="nc" id="L2196">							invPstmt.setString(3, encodedVirn);</span>
<span class="nc" id="L2197">							invPstmt.execute();</span>
<span class="nc" id="L2198">							System.out</span>
									.println(&quot;BO PWT table update Query is = &quot;
											+ invPstmt);
						}

					}

					// for current credit amount update
					
<span class="nc" id="L2207">					boolean isValid=OrgCreditUpdation.updateOrganizationBalWithValidate(creditAmt, &quot;TRANSACTION&quot;, &quot;PWT&quot;, agentOrgId,</span>
							0, &quot;AGENT&quot;, 0, connection);
					
<span class="nc bnc" id="L2210" title="All 2 branches missed.">					if(!isValid)</span>
<span class="nc" id="L2211">						throw new LMSException();</span>
					/*boolean isUpdateDone = OrgCreditUpdation
							.updateCreditLimitForAgent(agentOrgId, &quot;PWT&quot;,
									creditAmt, connection);*/
					// update retailer UNCLAIM_BAL payment
					
					
					

					// update AGENT's UNCLAIM_BAL Balance
<span class="nc bnc" id="L2221" title="All 2 branches missed.">					if (creditAmt &gt; 0.0)</span>
<span class="nc" id="L2222">						OrgCreditUpdation.updateOrganizationBalWithValidate(debitUnclaim, &quot;UNCLAIM_BAL&quot;, &quot;DEBIT&quot;, agentOrgId,</span>
								0, &quot;AGENT&quot;, 0, connection);
					
						/*commonHelper.updateOrgBalance(&quot;UNCLAIM_BAL&quot;,
								debitUnclaim, agentOrgId, &quot;DEBIT&quot;, connection);*/

					// generate receipt for BO
<span class="nc" id="L2229">					ArrayList&lt;Long&gt; transList = new ArrayList&lt;Long&gt;();</span>
<span class="nc" id="L2230">					transList.add(trnId);</span>
<span class="nc" id="L2231">					receipts = generateReceiptBo(connection, agentOrgId,</span>
							&quot;AGENT&quot;, transList);
					// receiptArr = receipts.split(&quot;-&quot;);

<span class="nc" id="L2235">					boReceiptId = Integer.parseInt(receipts.split(&quot;-&quot;)[0]);</span>
<span class="nc bnc" id="L2236" title="All 2 branches missed.">					if (boReceiptId &gt; 0) {</span>
<span class="nc" id="L2237">						connection.commit();</span>
<span class="nc" id="L2238">						GraphReportHelper graphReportHelper = new GraphReportHelper();</span>
<span class="nc" id="L2239">						graphReportHelper.createTextReportBO(boReceiptId,</span>
								boOrgName, userOrgID, rootPath);
					}

				}
			}
<span class="nc" id="L2245">			return receipts;</span>
<span class="nc" id="L2246">		} catch (SQLException e) {</span>
			try {
<span class="nc" id="L2248">				connection.rollback();</span>
<span class="nc" id="L2249">			} catch (SQLException e1) {</span>
<span class="nc" id="L2250">				e1.printStackTrace();</span>
<span class="nc" id="L2251">				throw new LMSException(e);</span>
<span class="nc" id="L2252">			}</span>
<span class="nc" id="L2253">			e.printStackTrace();</span>
<span class="nc" id="L2254">			throw new LMSException(e);</span>
		} finally {
<span class="nc" id="L2256">			try {</span>
<span class="nc bnc" id="L2257" title="All 4 branches missed.">				if (masterPstmt != null)</span>
<span class="nc" id="L2258">					masterPstmt.close();</span>
<span class="nc bnc" id="L2259" title="All 4 branches missed.">				if (detailPstmt != null)</span>
<span class="nc" id="L2260">					detailPstmt.close();</span>
<span class="nc bnc" id="L2261" title="All 4 branches missed.">				if (connection != null)</span>
<span class="nc" id="L2262">					connection.close();</span>
<span class="nc" id="L2263">			} catch (SQLException se) {</span>
<span class="nc" id="L2264">				se.printStackTrace();</span>
<span class="nc" id="L2265">				throw new LMSException(se);</span>
<span class="nc" id="L2266">			}</span>
		}
	}

	// This function is overloaded because connection is passed whenever it is
	// called

	public String boEndAgtPWTPaymentProcess(List&lt;PwtBean&gt; pwtList, int gameId,
			String boOrgName, int userOrgID, int agentOrgId, int agtUserId,
			String rootPath, int userId, int gameNbr, Connection connection)
			throws LMSException {

		// Connection connection = null;
<span class="nc" id="L2279">		PreparedStatement masterPstmt = null;</span>
<span class="nc" id="L2280">		PreparedStatement LMSMasterPstmt = null;</span>
<span class="nc" id="L2281">		PreparedStatement detailPstmt = null;</span>
<span class="nc" id="L2282">		PreparedStatement invPstmt = null;</span>
		//PreparedStatement agtPwtUpdatePstmt = null;

<span class="nc" id="L2285">		ResultSet resultSet = null;</span>

<span class="nc" id="L2287">		long trnId = -1;</span>
<span class="nc" id="L2288">		int boReceiptId = -1;</span>
		// String receiptArr []=null;
<span class="nc" id="L2290">		String receipts = null;</span>
		try {
<span class="nc bnc" id="L2292" title="All 2 branches missed.">			if (pwtList != null) {</span>
<span class="nc" id="L2293">				int size = pwtList.size();</span>
<span class="nc" id="L2294">				PwtBean pwtBean = null;</span>

<span class="nc" id="L2296">				String masterQuery = null;</span>
<span class="nc" id="L2297">				String LMSMasterQuery = null;</span>
<span class="nc" id="L2298">				String detailQuery = null;</span>
<span class="nc" id="L2299">				String invQuery = null;</span>

<span class="nc" id="L2301">				double pwtAmt = 0.0;</span>
<span class="nc" id="L2302">				double commAmt = 0.0;</span>
<span class="nc" id="L2303">				double netAmt = 0.0;</span>
<span class="nc" id="L2304">				double creditAmt = 0.0;</span>
<span class="nc" id="L2305">				double debitUnclaim = 0.0;</span>

<span class="nc bnc" id="L2307" title="All 2 branches missed.">				if (size &gt; 0) {</span>

					// DBConnect dbConnect = new DBConnect();
					// connection = dbConnect.getConnection();
<span class="nc" id="L2311">					connection.setAutoCommit(false);</span>

					// get agents game pwtCommRate
<span class="nc" id="L2314">					CommonFunctionsHelper commonHelper = new CommonFunctionsHelper();</span>
<span class="nc" id="L2315">					double agtPwtCommRate = commonHelper</span>
							.fetchCommOfOrganization(gameId, agentOrgId, &quot;PWT&quot;,
									&quot;AGENT&quot;, connection);

<span class="nc" id="L2319">					masterQuery = QueryManager.insertInBOTransactionMaster();</span>
<span class="nc" id="L2320">					masterPstmt = connection.prepareStatement(masterQuery);</span>

<span class="nc" id="L2322">					detailQuery = QueryManager.getST1PwtBODetailQuery();</span>
<span class="nc" id="L2323">					detailPstmt = connection.prepareStatement(detailQuery);</span>

<span class="nc" id="L2325">					invQuery = QueryManager.getST1PWTBOUpdateQuery();</span>
<span class="nc" id="L2326">					invPstmt = connection.prepareStatement(invQuery);</span>

					// update st_se_agent_pwt in case if agent brings uncalimed
					// PWTs to BO
					//String agtPwtUpdateQuery = &quot;update  st_se_agent_pwt set status=? where game_id = ? and virn_code = ? and agent_org_id = ? &quot;;
					//agtPwtUpdatePstmt = connection
					//		.prepareStatement(agtPwtUpdateQuery);

					// insert into transaction master
<span class="nc" id="L2335">					LMSMasterQuery = QueryManager</span>
							.insertInLMSTransactionMaster();
<span class="nc" id="L2337">					LMSMasterPstmt = connection</span>
							.prepareStatement(LMSMasterQuery);
<span class="nc" id="L2339">					LMSMasterPstmt.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L2340">					LMSMasterPstmt.executeUpdate();</span>
<span class="nc" id="L2341">					resultSet = LMSMasterPstmt.getGeneratedKeys();</span>
<span class="nc bnc" id="L2342" title="All 2 branches missed.">					if (resultSet.next())</span>
<span class="nc" id="L2343">						trnId = resultSet.getLong(1);</span>
					else
<span class="nc" id="L2345">						throw new LMSException(</span>
								&quot;Transaction id is not generated&quot;);

					// insert into BO transaction master
<span class="nc" id="L2349">					masterPstmt.setLong(1, trnId);</span>
<span class="nc" id="L2350">					masterPstmt.setInt(2, userId);</span>
<span class="nc" id="L2351">					masterPstmt.setInt(3, userOrgID);</span>
<span class="nc" id="L2352">					masterPstmt.setString(4, &quot;AGENT&quot;);</span>
<span class="nc" id="L2353">					masterPstmt.setInt(5, agentOrgId);</span>
<span class="nc" id="L2354">					masterPstmt.setTimestamp(6, new java.sql.Timestamp(</span>
							new java.util.Date().getTime()));
<span class="nc" id="L2356">					masterPstmt.setString(7, &quot;PWT&quot;);</span>
<span class="nc" id="L2357">					masterPstmt.execute();</span>
<span class="nc" id="L2358">					System.out.println(&quot;transaction Id::&quot; + trnId);</span>

<span class="nc bnc" id="L2360" title="All 2 branches missed.">					for (int i = 0; i &lt; size; i++) {</span>
<span class="nc" id="L2361">						pwtBean = (PwtBean) pwtList.get(i);</span>

<span class="nc bnc" id="L2363" title="All 4 branches missed.">						if (pwtBean.getIsValid() &amp;&amp; pwtBean.isTicketValid()) {</span>

<span class="nc" id="L2365">							String encodedVirn = pwtBean.getEncVirnCode();</span>
<span class="nc" id="L2366">							detailPstmt.setString(1, encodedVirn);</span>
<span class="nc" id="L2367">							detailPstmt.setLong(2, trnId);</span>
<span class="nc" id="L2368">							detailPstmt.setInt(3, gameId);</span>
<span class="nc" id="L2369">							detailPstmt.setInt(4, agtUserId);</span>
<span class="nc" id="L2370">							detailPstmt.setInt(5, agentOrgId);</span>

<span class="nc" id="L2372">							pwtAmt = Double.parseDouble(pwtBean.getPwtAmount());</span>
<span class="nc" id="L2373">							commAmt = pwtAmt * agtPwtCommRate * 0.01;</span>
<span class="nc" id="L2374">							netAmt = pwtAmt + commAmt;</span>
							// for current credit amount update
<span class="nc" id="L2376">							creditAmt += netAmt;</span>

<span class="nc" id="L2378">							detailPstmt.setDouble(6, pwtAmt);</span>
<span class="nc" id="L2379">							detailPstmt.setDouble(7, commAmt);</span>
<span class="nc" id="L2380">							detailPstmt.setDouble(8, netAmt);</span>
<span class="nc" id="L2381">							detailPstmt.execute();</span>

<span class="nc bnc" id="L2383" title="All 4 branches missed.">							if (&quot;IN_PLR_UNCLM&quot;.equalsIgnoreCase(pwtBean</span>
									.getInUnclmed())
									|| &quot;IN_AGENT_UNCLM&quot;
											.equalsIgnoreCase(pwtBean
													.getInUnclmed())) {
								String tableType;
<span class="nc bnc" id="L2389" title="All 2 branches missed.">								if (&quot;IN_PLR_UNCLM&quot;.equalsIgnoreCase(pwtBean</span>
										.getInUnclmed()))
<span class="nc" id="L2391">									tableType = &quot;PLAYER&quot;;</span>
								else
<span class="nc" id="L2393">									tableType = &quot;AGENT&quot;;</span>

<span class="nc" id="L2395">								commonHelper.updateOrgForUnClaimedVirn(</span>
										agentOrgId, &quot;AGENT&quot;, encodedVirn,
										&quot;DONE_UNCLM&quot;, gameId, tableType,
										connection,pwtBean.getTicketNumber());
<span class="nc" id="L2399">								debitUnclaim += pwtAmt;</span>
							}

							// update the remaining prize list
<span class="nc" id="L2403">							GameUtilityHelper.updateNoOfPrizeRem(gameId,</span>
									pwtAmt, &quot;CLAIM_AGT&quot;, encodedVirn,
									connection, gameNbr);

<span class="nc" id="L2407">							invPstmt.setInt(1, gameNbr);</span>
<span class="nc" id="L2408">							invPstmt.setInt(2, gameId);</span>
<span class="nc" id="L2409">							invPstmt.setString(3, encodedVirn);</span>
<span class="nc" id="L2410">							invPstmt.setString(4, MD5Encoder.encode(pwtBean.getTicketNumber()));</span>
<span class="nc" id="L2411">							invPstmt.execute();</span>
<span class="nc" id="L2412">							System.out</span>
									.println(&quot;BO PWT table update Query is = &quot;
											+ invPstmt);
						}

					}

					// for current credit amount update
<span class="nc" id="L2420">					boolean isValid=OrgCreditUpdation.updateOrganizationBalWithValidate(creditAmt, &quot;TRANSACTION&quot;, &quot;PWT&quot;, agentOrgId,</span>
							0, &quot;AGENT&quot;, 0, connection);
					
<span class="nc bnc" id="L2423" title="All 2 branches missed.">					if(!isValid)</span>
<span class="nc" id="L2424">						throw new LMSException();</span>
					
					/*boolean isUpdateDone = OrgCreditUpdation
							.updateCreditLimitForAgent(agentOrgId, &quot;PWT&quot;,
									creditAmt, connection);*/

					// update AGENT's UNCLAIM_BAL Balance
<span class="nc bnc" id="L2431" title="All 2 branches missed.">					if (creditAmt &gt; 0.0)</span>
<span class="nc" id="L2432">						OrgCreditUpdation.updateOrganizationBalWithValidate(debitUnclaim, &quot;UNCLAIM_BAL&quot;, &quot;DEBIT&quot;, agentOrgId,</span>
								0, &quot;AGENT&quot;, 0, connection);
					
						/*commonHelper.updateOrgBalance(&quot;UNCLAIM_BAL&quot;,
								debitUnclaim, agentOrgId, &quot;DEBIT&quot;, connection);*/

					// generate receipt for BO
<span class="nc" id="L2439">					ArrayList&lt;Long&gt; transList = new ArrayList&lt;Long&gt;();</span>
<span class="nc" id="L2440">					transList.add(trnId);</span>
<span class="nc" id="L2441">					receipts = generateReceiptBo(connection, agentOrgId,</span>
							&quot;AGENT&quot;, transList);
					// receiptArr = receipts.split(&quot;-&quot;);

<span class="nc" id="L2445">					boReceiptId = Integer.parseInt(receipts.split(&quot;-&quot;)[0]);</span>
<span class="nc bnc" id="L2446" title="All 2 branches missed.">					if (boReceiptId &gt; 0) {</span>
<span class="nc" id="L2447">						connection.commit();</span>
<span class="nc" id="L2448">						GraphReportHelper graphReportHelper = new GraphReportHelper();</span>
<span class="nc" id="L2449">						graphReportHelper.createTextReportBO(boReceiptId,</span>
								boOrgName, userOrgID, rootPath);
					}

				}
			}
<span class="nc" id="L2455">			return receipts;</span>
<span class="nc" id="L2456">		} catch (SQLException e) {</span>
			try {
<span class="nc" id="L2458">				connection.rollback();</span>
<span class="nc" id="L2459">			} catch (SQLException e1) {</span>
<span class="nc" id="L2460">				e1.printStackTrace();</span>
<span class="nc" id="L2461">				throw new LMSException(e);</span>
<span class="nc" id="L2462">			}</span>
<span class="nc" id="L2463">			e.printStackTrace();</span>
<span class="nc" id="L2464">			throw new LMSException(e);</span>
		} finally {
<span class="nc" id="L2466">			try {</span>
<span class="nc bnc" id="L2467" title="All 4 branches missed.">				if (masterPstmt != null)</span>
<span class="nc" id="L2468">					masterPstmt.close();</span>
<span class="nc bnc" id="L2469" title="All 4 branches missed.">				if (detailPstmt != null)</span>
<span class="nc" id="L2470">					detailPstmt.close();</span>
<span class="nc bnc" id="L2471" title="All 4 branches missed.">				if (connection != null)</span>
<span class="nc" id="L2472">					connection.close();</span>
<span class="nc" id="L2473">			} catch (SQLException se) {</span>
<span class="nc" id="L2474">				se.printStackTrace();</span>
<span class="nc" id="L2475">				throw new LMSException(se);</span>
<span class="nc" id="L2476">			}</span>
		}
	}

	public String generateReceiptBo(Connection connection, int partyId,
			String partyType, List&lt;Long&gt; transIdList) throws LMSException {
		try {

			// get latest generated receipt number
<span class="nc" id="L2485">			PreparedStatement autoGenRecptPstmtBO = connection</span>
					.prepareStatement(QueryManager.getBOLatestReceiptNb());
<span class="nc" id="L2487">			autoGenRecptPstmtBO.setString(1, &quot;RECEIPT&quot;);</span>
<span class="nc" id="L2488">			ResultSet recieptRsBO = autoGenRecptPstmtBO.executeQuery();</span>

<span class="nc" id="L2490">			String autoGeneRecieptNoBO = null;</span>
<span class="nc bnc" id="L2491" title="All 2 branches missed.">			if (recieptRsBO.next()) {</span>
<span class="nc" id="L2492">				String lastRecieptNoGeneratedBO = recieptRsBO</span>
						.getString(&quot;generated_id&quot;);
<span class="nc" id="L2494">				autoGeneRecieptNoBO = GenerateRecieptNo.getRecieptNo(&quot;RECEIPT&quot;,</span>
						lastRecieptNoGeneratedBO, &quot;BO&quot;);
<span class="nc" id="L2496">			} else {</span>
<span class="nc" id="L2497">				autoGeneRecieptNoBO = GenerateRecieptNo.getRecieptNo(&quot;RECEIPT&quot;,</span>
						null, &quot;BO&quot;);
			}

			// for generating receipt********************

<span class="nc" id="L2503">			PreparedStatement boReceiptPstmt = connection</span>
					.prepareStatement(QueryManager.insertInReceiptMaster());
<span class="nc" id="L2505">			boReceiptPstmt.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L2506">			boReceiptPstmt.executeUpdate();</span>
<span class="nc" id="L2507">			int boReceiptId = -1;</span>
<span class="nc" id="L2508">			ResultSet boRSet = boReceiptPstmt.getGeneratedKeys();</span>
<span class="nc bnc" id="L2509" title="All 2 branches missed.">			if (boRSet.next()) {</span>
<span class="nc" id="L2510">				boReceiptId = boRSet.getInt(1);</span>

<span class="nc" id="L2512">				boReceiptPstmt = connection.prepareStatement(QueryManager</span>
						.insertInBOReceipts());
<span class="nc" id="L2514">				boReceiptPstmt.setInt(1, boReceiptId);</span>
<span class="nc" id="L2515">				boReceiptPstmt.setString(2, &quot;RECEIPT&quot;);</span>
<span class="nc" id="L2516">				boReceiptPstmt.setInt(3, partyId);</span>
<span class="nc" id="L2517">				boReceiptPstmt.setString(4, partyType);</span>
<span class="nc" id="L2518">				boReceiptPstmt.setString(5, autoGeneRecieptNoBO);</span>
<span class="nc" id="L2519">				boReceiptPstmt.setTimestamp(6, Util.getCurrentTimeStamp());</span>
<span class="nc" id="L2520">				boReceiptPstmt.execute();</span>

<span class="nc" id="L2522">				PreparedStatement boReceiptMappingPstmt = connection</span>
						.prepareStatement(QueryManager
								.insertBOReceiptTrnMapping());
<span class="nc bnc" id="L2525" title="All 2 branches missed.">				for (Long transId : transIdList) {</span>
<span class="nc" id="L2526">					boReceiptMappingPstmt.setInt(1, boReceiptId);</span>
<span class="nc" id="L2527">					boReceiptMappingPstmt.setLong(2, transId);</span>
<span class="nc" id="L2528">					boReceiptMappingPstmt.execute();</span>
<span class="nc" id="L2529">				}</span>

			}

<span class="nc" id="L2533">			return boReceiptId + &quot;-&quot; + autoGeneRecieptNoBO;</span>
<span class="nc" id="L2534">		} catch (SQLException e) {</span>
<span class="nc" id="L2535">			e.printStackTrace();</span>
<span class="nc" id="L2536">			throw new LMSException();</span>
		}
	}

	public ClmDrawSaleBean getVatAndPpr(Connection con,
			ClmDrawSaleBean saleBean, int gameId) throws SQLException {
<span class="nc" id="L2542">		String getGameNbrFromGameMaster = &quot;select game_nbr,prize_payout_ratio,vat_amt from st_dg_game_master where game_id =&quot;</span>
				+ gameId;
<span class="nc" id="L2544">		PreparedStatement pstmtGameNbr = con</span>
				.prepareStatement(getGameNbrFromGameMaster);
<span class="nc" id="L2546">		ResultSet resultGameNbr = pstmtGameNbr.executeQuery();</span>
<span class="nc bnc" id="L2547" title="All 2 branches missed.">		while (resultGameNbr.next()) {</span>
<span class="nc" id="L2548">			saleBean.setPricePayRatio(resultGameNbr</span>
					.getDouble(&quot;prize_payout_ratio&quot;));
<span class="nc" id="L2550">			saleBean.setVatAmt(resultGameNbr.getDouble(&quot;vat_amt&quot;));</span>
		}
<span class="nc" id="L2552">		return saleBean;</span>
	}
	
	public void updateGameInvDetail(int gameId,String packNbr,String bookNbr,String currentOwner,int orgId,int userId,String bookStatus,int warehouseId,Connection con){
<span class="nc" id="L2556">		Statement stmt=null;</span>
<span class="nc" id="L2557">		String query=null;</span>
		try{
<span class="nc" id="L2559">			stmt=con.createStatement();</span>
<span class="nc" id="L2560">			query=&quot;insert into st_se_game_inv_detail (game_id,pack_nbr,book_nbr,current_owner,current_owner_id,transaction_date,transaction_at,changed_by_user_id,book_status,warehouse_id) values (&quot;+gameId+&quot;,'&quot;+packNbr+&quot;','&quot;+bookNbr+&quot;','&quot;+currentOwner+&quot;',&quot;+orgId+&quot;,'&quot;+new Timestamp(Calendar.getInstance().getTimeInMillis())+&quot;','&quot;+currentOwner+&quot;',&quot;+userId+&quot;,'&quot;+bookStatus+&quot;',&quot;+warehouseId+&quot;)&quot;;</span>
<span class="nc" id="L2561">			stmt.executeUpdate(query);</span>
<span class="nc" id="L2562">		}catch(Exception e){</span>
<span class="nc" id="L2563">			e.printStackTrace();</span>
<span class="nc" id="L2564">		}</span>
<span class="nc" id="L2565">	}</span>
	
	public Map&lt;Integer, String&gt; fetchWarehouseMap() throws ScratchException {
<span class="nc" id="L2568">		Connection con = null;</span>
<span class="nc" id="L2569">		Statement stmt = null;</span>
<span class="nc" id="L2570">		ResultSet rs = null;</span>
<span class="nc" id="L2571">		Map&lt;Integer, String&gt; warehouseMap = new HashMap&lt;Integer, String&gt;();</span>

		try {
<span class="nc" id="L2574">			con = DBConnect.getConnection();</span>
<span class="nc" id="L2575">			stmt = con.createStatement();</span>
<span class="nc" id="L2576">			rs = stmt.executeQuery(&quot;select warehouse_id, warehouse_name from st_se_warehouse_master where warehouse_type='FIXED';&quot;);</span>
<span class="nc bnc" id="L2577" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L2578">				warehouseMap.put(rs.getInt(&quot;warehouse_id&quot;), rs.getString(&quot;warehouse_name&quot;));</span>
			}
<span class="nc" id="L2580">		} catch (SQLException e) {</span>
<span class="nc" id="L2581">			e.printStackTrace();</span>
<span class="nc" id="L2582">			throw new ScratchException(ScratchErrors.SQL_EXCEPTION_ERROR_CODE, ScratchErrors.SQL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="nc" id="L2583">		} catch (Exception e) {</span>
<span class="nc" id="L2584">			e.printStackTrace();</span>
<span class="nc" id="L2585">			throw new ScratchException(ScratchErrors.GENERAL_EXCEPTION_ERROR_CODE, ScratchErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
		} finally {
<span class="nc" id="L2587">			DBConnect.closeCon(con);</span>
<span class="nc" id="L2588">		}</span>
<span class="nc" id="L2589">		return warehouseMap;</span>
	}
	
	public void updatePwtDateAndTierTickets(TicketBean tktBean, Connection con) {
<span class="nc" id="L2593">		Statement stmt=null;</span>
<span class="nc" id="L2594">		String query=null;</span>
		try {
<span class="nc" id="L2596">			stmt=con.createStatement();</span>
<span class="nc" id="L2597">			query=&quot;update st_se_game_inv_status set total_low_win_tier_tickets_claimed=total_low_win_tier_tickets_claimed+1,first_ticket_claim_date = ifnull(first_ticket_claim_date, '&quot;+new Timestamp(Calendar.getInstance().getTimeInMillis())+&quot;') where book_nbr='&quot;+tktBean.getBook_nbr()+&quot;';&quot;;</span>
<span class="nc" id="L2598">			stmt.executeUpdate(query);</span>
<span class="nc" id="L2599">		} catch (Exception e) {</span>
<span class="nc" id="L2600">			e.printStackTrace();</span>
<span class="nc" id="L2601">		}</span>
<span class="nc" id="L2602">	}</span>
	
	public void sendMail(List&lt;String&gt; bookNumberList, String firstName, String lastName, String emailId, String invoiceReceipt){
		try{
<span class="nc" id="L2606">			String books=null;</span>
<span class="nc bnc" id="L2607" title="All 2 branches missed.">			for (String bookNbr : bookNumberList) </span>
<span class="nc" id="L2608">				 books=bookNbr+&quot;,&quot;;</span>

<span class="nc" id="L2610">			StringBuilder emailMsgTxt = new StringBuilder(&quot;&lt;html&gt;&lt;table&gt;&lt;tr&gt;&lt;td colspan=2&gt;Hi &quot;);</span>
<span class="nc" id="L2611">				emailMsgTxt.append(firstName)</span>
				.append(&quot; &quot;)
				.append(lastName)
				.append(&quot;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td colspan=2&gt;&quot;)
				.append(&quot;Your invoice is successfully generated.&lt;br /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&quot;)
				.append(&quot;&lt;td&gt;Book Number : &lt;/td&gt;&lt;td&gt;&lt;b&gt;&quot;)
				.append(books.substring(0, books.length()-1))
				.append(&quot;&lt;/b&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Invoice Receipt Id : &lt;/td&gt;&lt;td&gt;&lt;b&gt;&quot;)
				.append(invoiceReceipt)
				.append(&quot;&lt;/b&gt;&lt;/td&gt;&quot;)
				.append(&quot;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/html&gt;&quot;);

<span class="nc" id="L2623">				MailSend mailSend = new MailSend(emailId, emailMsgTxt.toString());</span>
<span class="nc" id="L2624">				mailSend.setDaemon(true);</span>
<span class="nc" id="L2625">				mailSend.start();</span>
			
<span class="nc" id="L2627">		}catch(Exception e){</span>
<span class="nc" id="L2628">			e.printStackTrace();</span>
<span class="nc" id="L2629">		}</span>
<span class="nc" id="L2630">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>