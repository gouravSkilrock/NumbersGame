<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RetailerPwtProcessHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lms</a> &gt; <a href="index.source.html" class="el_package">com.skilrock.lms.coreEngine.scratchService.pwtMgmt.common</a> &gt; <span class="el_source">RetailerPwtProcessHelper.java</span></div><h1>RetailerPwtProcessHelper.java</h1><pre class="source lang-java linenums">package com.skilrock.lms.coreEngine.scratchService.pwtMgmt.common;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.Map;
import java.util.TreeMap;
import java.util.logging.Logger;

import com.skilrock.lms.beans.OrgPwtLimitBean;
import com.skilrock.lms.beans.PlayerBean;
import com.skilrock.lms.beans.PwtBean;
import com.skilrock.lms.beans.TicketBean;
import com.skilrock.lms.beans.UserInfoBean;
import com.skilrock.lms.common.Utility;
import com.skilrock.lms.common.db.DBConnect;
import com.skilrock.lms.common.db.QueryManager;
import com.skilrock.lms.common.db.TableConstants;
import com.skilrock.lms.common.exception.LMSErrors;
import com.skilrock.lms.common.exception.LMSException;
import com.skilrock.lms.common.utility.GameUtilityHelper;
import com.skilrock.lms.common.utility.GenerateRecieptNo;
import com.skilrock.lms.common.utility.MD5Encoder;
import com.skilrock.lms.common.utility.OrgCreditUpdation;
import com.skilrock.lms.coreEngine.reportsMgmt.common.GraphReportHelper;
import com.skilrock.lms.web.drawGames.common.Util;

<span class="nc" id="L30">public class RetailerPwtProcessHelper {</span>

	private Connection connection;
	private PreparedStatement pstmt;
	private ResultSet result;

	/**
	 * This function is used to check the ticket validity with owner
	 * 
	 * @param gameNbr
	 * @param bookNbr
	 * @param ticketNbrDigit
	 * @param gameId
	 * @param connection
	 * @return ticketBean
	 * @throws SQLException
	 */
	public TicketBean checkTicketStatus(String gameNbr, String bookNbr,
			String ticketNbrDigit, int gameId, Connection connection)
			throws SQLException {
<span class="nc" id="L50">		TicketBean bean = new TicketBean();</span>
<span class="nc" id="L51">		PreparedStatement pstmt2 = null;</span>
<span class="nc" id="L52">		ResultSet resultSet2 = null;</span>
<span class="nc" id="L53">		bean.setTicketNumber(bookNbr + &quot;-&quot; + ticketNbrDigit);</span>
<span class="nc" id="L54">		System.out.println(&quot;Book No is: &quot; + bookNbr	+ &quot;  actual ticket number is &quot; + ticketNbrDigit);</span>

<span class="nc" id="L56">		String query1 = QueryManager.getST4CurrentOwnerDetailsUsingGameBookNbr();</span>
<span class="nc" id="L57">		pstmt = connection.prepareStatement(query1);</span>
<span class="nc" id="L58">		pstmt.setInt(1, gameId);</span>
<span class="nc" id="L59">		pstmt.setString(2, bookNbr);</span>
<span class="nc" id="L60">		result = pstmt.executeQuery();</span>
<span class="nc" id="L61">		System.out.println(&quot;pstmt == &quot; + pstmt);</span>
<span class="nc bnc" id="L62" title="All 2 branches missed.">		if (result.next()) {</span>
<span class="nc" id="L63">			String ownerType = result.getString(&quot;current_owner&quot;);</span>
<span class="nc" id="L64">			String bookStatus = result.getString(&quot;book_status&quot;);</span>
<span class="nc bnc" id="L65" title="All 8 branches missed.">			if ((&quot;RETAILER&quot;.equalsIgnoreCase(ownerType.trim()) || &quot;AGENT&quot;.equalsIgnoreCase(ownerType.trim()))</span>
					&amp;&amp; (&quot;ACTIVE&quot;.equalsIgnoreCase(bookStatus) || &quot;CLAIMED&quot;
							.equalsIgnoreCase(bookStatus))) {
<span class="nc" id="L68">				bean.setBookStatus(bookStatus);</span>
				
//				pstmt2 = connection.prepareStatement(QueryManager
//						.getST4PwtTicketDetailsFromPwtInvUsingGameNbr());
//				pstmt2.setInt(1, Integer.parseInt(gameNbr));
//				pstmt2.setString(2, MD5Encoder.encode(bookNbr + &quot;-&quot; + ticketNbrDigit));
//				resultSet2 = pstmt2.executeQuery();
//				if(!resultSet2.next()) {
//					bean.setValid(false);
//					bean.setStatus(&quot;Ticket is Not ACTIVE or SOLD&quot;);
//					bean.setMessageCode(&quot;222020&quot;);
//					bean.setValidity(&quot;InValid Ticket&quot;);
//					return bean;
//				}
				
				// check the status of ticket
<span class="nc" id="L84">				String query2 = QueryManager.getST4PwtTicketDetailsUsingGameNbr();</span>
<span class="nc" id="L85">				pstmt2 = connection.prepareStatement(query2);</span>
<span class="nc" id="L86">				pstmt2.setInt(1, Integer.parseInt(gameNbr));</span>
<span class="nc" id="L87">				pstmt2.setString(2, bookNbr + &quot;-&quot; + ticketNbrDigit);</span>
<span class="nc" id="L88">				resultSet2 = pstmt2.executeQuery();</span>
<span class="nc" id="L89">				System.out.println(&quot;inside if = &quot; + pstmt2);</span>
				// required to be reviewed
<span class="nc bnc" id="L91" title="All 2 branches missed.">				if (resultSet2.next()) {</span>
<span class="nc" id="L92">					String ticketStatus = resultSet2.getString(&quot;status&quot;);</span>

					// -----------------------------------------------

<span class="nc bnc" id="L96" title="All 2 branches missed.">					if (ticketStatus.equalsIgnoreCase(&quot;MISSING&quot;)) {</span>
<span class="nc" id="L97">						bean.setValid(false);</span>
<span class="nc" id="L98">						bean.setStatus(&quot;Ticket staus is MISSING in DATABASE&quot;);</span>
<span class="nc" id="L99">						bean.setMessageCode(&quot;222010&quot;);</span>
<span class="nc" id="L100">						bean.setValidity(&quot;InValid Ticket&quot;);</span>
<span class="nc" id="L101">						System.out.println(&quot;Ticket is MISSING.&quot;);</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">					} else if (ticketStatus.equalsIgnoreCase(&quot;CLAIM_RET&quot;)) {</span>
<span class="nc" id="L103">						bean.setValid(false);</span>
<span class="nc" id="L104">						bean.setStatus(&quot;Already paid to Retailer&quot;);</span>
<span class="nc" id="L105">						bean.setMessageCode(&quot;222010&quot;);</span>
<span class="nc" id="L106">						bean.setValidity(&quot;InValid Ticket&quot;);</span>
<span class="nc" id="L107">						System.out.println(&quot;Ticket's PWT Has Bean Paid By Agent.&quot;);</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">					} else if (ticketStatus.equalsIgnoreCase(&quot;RETURN&quot;)) {</span>
<span class="nc" id="L109">						bean.setValid(false);</span>
<span class="nc" id="L110">						bean.setStatus(&quot;Ticket once Verified and Return to Player for Verification as Direct Player PWT at BO&quot;);</span>
<span class="nc" id="L111">						bean.setMessageCode(&quot;222007&quot;);</span>
<span class="nc" id="L112">						bean.setValidity(&quot;InValid Ticket&quot;);</span>
<span class="nc" id="L113">						System.out</span>
								.println(&quot;Ticket Is valid for pwt. But Ticket Is High Prize Ticket, So Go for Direct PWT.  &quot;);
<span class="nc bnc" id="L115" title="All 2 branches missed.">					} else if (ticketStatus.equalsIgnoreCase(&quot;CLAIM_AGT&quot;)) {</span>
<span class="nc" id="L116">						bean.setValid(false);</span>
<span class="nc" id="L117">						bean.setStatus(&quot;Already paid to Agent&quot;);</span>
<span class="nc" id="L118">						bean.setMessageCode(&quot;222005&quot;);</span>
<span class="nc" id="L119">						bean.setValidity(&quot;InValid Ticket&quot;);</span>
<span class="nc" id="L120">						System.out.println(&quot;Ticket's PWT Has Bean Paid By BO.&quot;);</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">					} else if (ticketStatus.equalsIgnoreCase(&quot;CLAIM_AGT_AUTO&quot;)) {</span>
<span class="nc" id="L122">						bean.setValid(false);</span>
<span class="nc" id="L123">						bean.setStatus(&quot;Already paid to Agent as auto scrap.&quot;);</span>
<span class="nc" id="L124">						bean.setMessageCode(&quot;222005&quot;);</span>
<span class="nc" id="L125">						bean.setValidity(&quot;InValid Ticket&quot;);</span>
<span class="nc" id="L126">						System.out.println(&quot;Ticket's PWT Has Bean Paid By BO. as Auto Scrap&quot;);</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">					} else if (ticketStatus.equalsIgnoreCase(&quot;CLAIM_AGT_TEMP&quot;)) {</span>
<span class="nc" id="L128">						bean.setValid(false);</span>
<span class="nc" id="L129">						bean.setStatus(&quot;Already paid to Agent AS Bulk by bO&quot;);</span>
<span class="nc" id="L130">						bean.setMessageCode(&quot;222005&quot;);</span>
<span class="nc" id="L131">						bean.setValidity(&quot;InValid Ticket&quot;);</span>
<span class="nc" id="L132">						System.out.println(&quot;Ticket's PWT Has Bean Paid By BO.&quot;);</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">					} else if (ticketStatus.equalsIgnoreCase(&quot;CLAIM_PLR_BO&quot;)) {</span>
<span class="nc" id="L134">						bean.setValid(false);</span>
<span class="nc" id="L135">						bean.setStatus(&quot;Already paid as Direct Player PWT By BO&quot;);</span>
<span class="nc" id="L136">						bean.setMessageCode(&quot;222006&quot;);</span>
<span class="nc" id="L137">						bean.setValidity(&quot;InValid Ticket&quot;);</span>
<span class="nc" id="L138">						System.out.println(&quot;Already paid as Direct Player PWT By BO &quot;);</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">					} else if (ticketStatus.equalsIgnoreCase(&quot;CLAIM_PLR_RET_UNCLM&quot;)) {</span>
<span class="nc" id="L140">						bean.setValid(false);</span>
<span class="nc" id="L141">						bean.setStatus(&quot;Already paid To Player By Retailer&quot;);</span>
<span class="nc" id="L142">						bean.setMessageCode(&quot;222006&quot;);</span>
<span class="nc" id="L143">						bean.setValidity(&quot;InValid Ticket&quot;);</span>

<span class="nc bnc" id="L145" title="All 2 branches missed.">					} else if (ticketStatus.equalsIgnoreCase(&quot;CLAIM_PLR_RET_CLM&quot;)) {</span>
<span class="nc" id="L146">						bean.setValid(false);</span>
<span class="nc" id="L147">						bean.setStatus(&quot;Paid to Player by Retailer and pending to claim by Retailer at Agent as auto scrap. &quot;);</span>
<span class="nc" id="L148">						bean.setMessageCode(&quot;221002&quot;);</span>
<span class="nc" id="L149">						bean.setValidity(&quot;InValid Ticket&quot;);</span>
<span class="nc" id="L150">						System.out.println(&quot;Ticket IS valid for pwt. (Ticket has been paid to player by retailer so retailer should be paid by agent)&quot;);</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">					} else if (ticketStatus.equalsIgnoreCase(&quot;CLAIM_PLR_RET_CLM_DIR&quot;)) {</span>
<span class="nc" id="L152">						bean.setValid(false);</span>
<span class="nc" id="L153">						bean.setStatus(&quot;Paid to Player by Retailer and pending to claim by Retailer at Agent as auto scrap. &quot;);</span>
<span class="nc" id="L154">						bean.setMessageCode(&quot;221002&quot;);</span>
<span class="nc" id="L155">						bean.setValidity(&quot;InValid Ticket&quot;);</span>
<span class="nc" id="L156">						System.out.println(&quot;Ticket IS valid for pwt. (Ticket has been paid to player by retailer so retailer should be paid by agent)&quot;);</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">					} else if (ticketStatus.equalsIgnoreCase(&quot;CLAIM_PLR_RET_UNCLM_DIR&quot;)) {</span>
<span class="nc" id="L158">						bean.setValid(false);</span>
<span class="nc" id="L159">						bean.setStatus(&quot;Paid to Player by Retailer and pending to claim by Retailer at Agent as Ticket Verification. &quot;);</span>
<span class="nc" id="L160">						bean.setMessageCode(&quot;221002&quot;);</span>
<span class="nc" id="L161">						bean.setValidity(&quot;InValid Ticket&quot;);</span>
					}

<span class="nc bnc" id="L164" title="All 2 branches missed.">					else if (ticketStatus.equalsIgnoreCase(&quot;CLAIM_PLR_AGT_CLM_DIR&quot;)) {</span>
<span class="nc" id="L165">						bean.setValid(false);</span>
<span class="nc" id="L166">						bean.setStatus(&quot;Paid to Player by Agent and pending to claim at BO by Agent.&quot;);</span>
<span class="nc" id="L167">						bean.setMessageCode(&quot;221002&quot;);</span>
<span class="nc" id="L168">						bean.setValidity(&quot;InValid Ticket&quot;);</span>
					}

<span class="nc bnc" id="L171" title="All 2 branches missed.">					else if (ticketStatus.equalsIgnoreCase(&quot;CLAIM_PLR_AGT_TEMP&quot;)) {</span>
<span class="nc" id="L172">						bean.setValid(false);</span>
<span class="nc" id="L173">						bean.setStatus(&quot;Already paid to Agent AS Bulk by BO&quot;);</span>
<span class="nc" id="L174">						bean.setMessageCode(&quot;221002&quot;);</span>
<span class="nc" id="L175">						bean.setValidity(&quot;InValid Ticket&quot;);</span>
					}

<span class="nc bnc" id="L178" title="All 2 branches missed.">					else if (ticketStatus.equalsIgnoreCase(&quot;CLAIM_RET_AGT_TEMP&quot;)) {</span>
<span class="nc" id="L179">						bean.setValid(false);</span>
<span class="nc" id="L180">						bean.setStatus(&quot;Already paid to Agent AS Bulk by BO&quot;);</span>
<span class="nc" id="L181">						bean.setMessageCode(&quot;221002&quot;);</span>
<span class="nc" id="L182">						bean.setValidity(&quot;InValid Ticket&quot;);</span>
					}

<span class="nc bnc" id="L185" title="All 2 branches missed.">					else if (ticketStatus.equalsIgnoreCase(&quot;CLAIM_RET_CLM&quot;)) {</span>
<span class="nc" id="L186">						bean.setValid(false);</span>
<span class="nc" id="L187">						bean.setStatus(&quot;Paid to Retailer as Claimable&quot;);</span>
<span class="nc" id="L188">						bean.setMessageCode(&quot;221002&quot;);</span>
<span class="nc" id="L189">						bean.setValidity(&quot;InValid Ticket&quot;);</span>
					}

<span class="nc bnc" id="L192" title="All 2 branches missed.">					else if (ticketStatus.equalsIgnoreCase(&quot;CLAIM_RET_CLM_AUTO&quot;)) {</span>
<span class="nc" id="L193">						bean.setValid(false);</span>
<span class="nc" id="L194">						bean.setStatus(&quot;Paid to Retailer as Claimable by auto scrap&quot;);</span>
<span class="nc" id="L195">						bean.setMessageCode(&quot;221002&quot;);</span>
<span class="nc" id="L196">						bean.setValidity(&quot;InValid Ticket&quot;);</span>
					}

<span class="nc bnc" id="L199" title="All 2 branches missed.">					else if (ticketStatus.equalsIgnoreCase(&quot;CLAIM_RET_UNCLM&quot;)) {</span>
<span class="nc" id="L200">						bean.setValid(false);</span>
<span class="nc" id="L201">						bean.setStatus(&quot;Paid to Retailer pending to claim at bo as Ticket Verification.&quot;);</span>
<span class="nc" id="L202">						bean.setMessageCode(&quot;221002&quot;);</span>
<span class="nc" id="L203">						bean.setValidity(&quot;InValid Ticket&quot;);</span>
					}

<span class="nc bnc" id="L206" title="All 2 branches missed.">					else if (ticketStatus.equalsIgnoreCase(&quot;CLAIM_PLR_AGT_UNCLM_DIR&quot;)) {</span>
<span class="nc" id="L207">						bean.setValid(false);</span>
<span class="nc" id="L208">						bean.setStatus(&quot;Paid to player by Agent&quot;);</span>
<span class="nc" id="L209">						bean.setMessageCode(&quot;221002&quot;);</span>
<span class="nc" id="L210">						bean.setValidity(&quot;InValid Ticket&quot;);</span>
					}

<span class="nc bnc" id="L213" title="All 2 branches missed.">					else if (ticketStatus.equalsIgnoreCase(&quot;PND_MAS&quot;)) {</span>
<span class="nc" id="L214">						bean.setValid(false);</span>
<span class="nc" id="L215">						bean.setStatus(&quot;Requested to BO Master for Approval&quot;);</span>
<span class="nc" id="L216">						bean.setMessageCode(&quot;221002&quot;);</span>
<span class="nc" id="L217">						bean.setValidity(&quot;InValid Ticket&quot;);</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">					} else if (ticketStatus.equalsIgnoreCase(&quot;PND_PAY&quot;)) {</span>
<span class="nc" id="L219">						bean.setValid(false);</span>
<span class="nc" id="L220">						bean.setStatus(&quot;Pending for Payments&quot;);</span>
<span class="nc" id="L221">						bean.setMessageCode(&quot;221002&quot;);</span>
<span class="nc" id="L222">						bean.setValidity(&quot;InValid Ticket&quot;);</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">					} else if (ticketStatus.equalsIgnoreCase(&quot;REQUESTED&quot;)) {</span>
<span class="nc" id="L224">						bean.setValid(false);</span>
<span class="nc" id="L225">						bean.setStatus(&quot;Requested for Approval&quot;);</span>
<span class="nc" id="L226">						bean.setMessageCode(&quot;221002&quot;);</span>
<span class="nc" id="L227">						bean.setValidity(&quot;InValid Ticket&quot;);</span>
					}

					/*
					 * else if(ticketStatus.equalsIgnoreCase(&quot;CLAIM_PLR_RET&quot;)) {
					 * bean.setValid(false); bean.setStatus(&quot; &quot;);
					 * bean.setMessageCode(&quot;221002&quot;); bean.setValidity(&quot;InValid
					 * Ticket&quot;); System.out.println(&quot;Ticket IS valid for pwt.
					 * (Ticket has been paid to player by retailer so retailer
					 * should be paid by agent)&quot;); }
					 */
					else {
<span class="nc" id="L239">						bean.setValid(false);</span>
<span class="nc" id="L240">						bean.setStatus(&quot;Undefined Status of Ticket's PWT&quot;);</span>
<span class="nc" id="L241">						bean.setValidity(&quot;InValid Ticket&quot;);</span>
<span class="nc" id="L242">						System.out.println(&quot;Undefined Status of Ticket's PWT&quot;);</span>
					}

					// -----------------------------------------------

					/*
					 * if(ticketStatus.equalsIgnoreCase(&quot;CLAIM_RET&quot;)){
					 * bean.setValid(false); bean.setStatus(&quot;Already paid to
					 * Retailer&quot;); bean.setMessageCode(&quot;222010&quot;);
					 * bean.setValidity(&quot;InValid Ticket&quot;);
					 * System.out.println(&quot;Ticket's PWT Has Bean Paid By
					 * Agent.&quot;); } else
					 * if(ticketStatus.equalsIgnoreCase(&quot;RETURN&quot;) ){
					 * bean.setValid(false); bean.setStatus(&quot;Ticket once
					 * Verified and Return to Player for Verification as Direct
					 * Player PWT at BO&quot;); bean.setMessageCode(&quot;222007&quot;);
					 * bean.setValidity(&quot;InValid Ticket&quot;);
					 * System.out.println(&quot;Ticket Is valid for pwt. But Ticket
					 * Is High Prize Ticket, So Go for Direct PWT. &quot;); } else
					 * if(ticketStatus.equalsIgnoreCase(&quot;CLAIM_AGT&quot;)){
					 * bean.setValid(false); bean.setStatus(&quot;Already paid to
					 * Agent&quot;); bean.setMessageCode(&quot;222005&quot;);
					 * bean.setValidity(&quot;InValid Ticket&quot;);
					 * System.out.println(&quot;Ticket's PWT Has Bean Paid By BO.&quot;); }
					 * else if(ticketStatus.equalsIgnoreCase(&quot;CLAIM_PLR&quot;)){
					 * bean.setValid(false); bean.setStatus(&quot;Already paid as
					 * Direct Player PWT&quot;); bean.setMessageCode(&quot;222006&quot;);
					 * bean.setValidity(&quot;InValid Ticket&quot;);
					 * System.out.println(&quot;Ticket Is High Prize Ticket, Ticket's
					 * PWT Has Been Paid. &quot;); } else
					 * if(ticketStatus.equalsIgnoreCase(&quot;CLAIM_PLR_RET&quot;)) {
					 * bean.setValid(false); bean.setStatus(&quot; &quot;);
					 * bean.setMessageCode(&quot;221002&quot;); bean.setValidity(&quot;InValid
					 * Ticket&quot;); System.out.println(&quot;Ticket IS valid for pwt.
					 * (Ticket has been paid to player by retailer so retailer
					 * should be paid by agent)&quot;); } else {
					 * bean.setValid(false); bean.setStatus(&quot;Undefined Status of
					 * Ticket's PWT&quot;); bean.setValidity(&quot;InValid Ticket&quot;);
					 * System.out.println(&quot;Undefined Status of Ticket's PWT&quot;); }
					 */
<span class="nc" id="L282">				} else { // check if this ticket is in temporary table</span>
					/*
					 * String query4 = &quot;select * from st_se_tmp_pwt_tickets_inv
					 * where ticket_nbr = ?&quot;; pstmt =
					 * connection.prepareStatement(query4); pstmt.setString(1,
					 * bookNbr+&quot;-&quot;+ticketNbrDigit); ResultSet resultSet5 =
					 * pstmt.executeQuery(); if(resultSet5.next()){
					 * bean.setValid(false); bean.setStatus(&quot;Already Verified in
					 * Bulk Receipt at BO/AGENT&quot;);
					 * bean.setMessageCode(&quot;222008&quot;); bean.setValidity(&quot;InValid
					 * Ticket&quot;); System.out.println(&quot;Ticket number is verified
					 * for temp table&quot;); } else {
					 */
<span class="nc" id="L295">					bean.setValid(true);</span>
<span class="nc" id="L296">					bean.setStatus(&quot;Ticket Is Valid&quot;);</span>
<span class="nc" id="L297">					bean.setMessageCode(&quot;221001&quot;);</span>
<span class="nc" id="L298">					bean.setUpdateTicketType(&quot;INSERT&quot;);</span>
<span class="nc" id="L299">					bean.setValidity(&quot;Valid Ticket&quot;);</span>
<span class="nc" id="L300">					System.out.println(&quot;Ticket IS valid for pwt. (Means not fake and not in pwt table)&quot;);</span>
					// }
				}

<span class="nc" id="L304">			} else { // when book owner is 'BO' OR book status is 'INACTIVE'</span>
<span class="nc" id="L305">				bean.setValid(false);</span>
<span class="nc" id="L306">				bean.setValidity(&quot;InValid Ticket&quot;);</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">				if (&quot;BO&quot;.equalsIgnoreCase(ownerType)) {</span>
<span class="nc" id="L308">					bean.setStatus(&quot;Ticket is in stock of BO&quot;);</span>
<span class="nc" id="L309">					bean.setMessageCode(&quot;222003&quot;);</span>
<span class="nc" id="L310">					System.out.println(&quot;Ticket owner is BO.&quot;);</span>
				} else {
<span class="nc" id="L312">					bean.setStatus(&quot;Ticket is Not stock of BO&quot;);</span>
<span class="nc" id="L313">					bean.setMessageCode(&quot;222003&quot;);</span>
<span class="nc" id="L314">					System.out.println(&quot;Ticket status is not 'ACTIVE' or 'CLAIMED'&quot;);</span>
				}
			}
<span class="nc" id="L317">		} else { // when book is not found in st_se_game_inv_status table</span>
<span class="nc" id="L318">			bean.setValid(false);</span>
<span class="nc" id="L319">			bean.setStatus(&quot;Number Format Error/Out of Range Please Check&quot;);</span>
<span class="nc" id="L320">			bean.setMessageCode(&quot;222002&quot;);</span>
<span class="nc" id="L321">			bean.setValidity(&quot;InValid Ticket&quot;);</span>
<span class="nc" id="L322">			System.out.println(&quot;Ticket Is not of the company.&quot;);</span>
		}

<span class="nc" id="L325">		return bean;</span>
	}

	private String createQueryForApp(boolean inPayLimit) {
<span class="nc" id="L329">		StringBuilder insertAppQuery = new StringBuilder(</span>
				&quot;insert into  st_se_pwt_approval_request_master (party_type , &quot;
						+ &quot;request_id , party_id , ticket_nbr , virn_code , game_id , pwt_amt , tax_amt , net_amt , &quot;
						+ &quot;req_status , requester_type , requested_by_user_id , requested_by_org_id , requested_to_org_id ,&quot;
						+ &quot; requested_to_type , request_date ,  remarks &quot;);
<span class="nc bnc" id="L334" title="All 2 branches missed.">		if (inPayLimit) {</span>
<span class="nc" id="L335">			insertAppQuery</span>
					.append(&quot;, approved_by_type, approved_by_user_id , approved_by_org_id , &quot;
							+ &quot;pay_req_for_org_type, pay_request_for_org_id, approval_date  &quot;);
		}
<span class="nc" id="L339">		insertAppQuery.append(&quot; ) values (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,? &quot;);</span>

<span class="nc bnc" id="L341" title="All 2 branches missed.">		if (inPayLimit) {</span>
<span class="nc" id="L342">			insertAppQuery.append(&quot;,?,?,?,?,?,? &quot;);</span>
		}
<span class="nc" id="L344">		insertAppQuery.append(&quot;)&quot;);</span>
<span class="nc" id="L345">		return insertAppQuery.toString();</span>
	}

	// fetch the game details for PWT on Retailer End
	public String fetchPwtGameDetails() throws LMSException {
		try {
<span class="nc" id="L351">			connection = DBConnect.getConnection();</span>

<span class="nc" id="L353">			StringBuilder nbrFormat = new StringBuilder();</span>
<span class="nc" id="L354">			Statement stmt1 = connection.createStatement();</span>
<span class="nc" id="L355">			result = stmt1.executeQuery(&quot;select res.game_name,res.game_nbr,res.game_id,sgtnf.pack_nbr_digits,sgtnf.book_nbr_digits,sgtnf.ticket_nbr_digits,sgtnf.game_nbr_digits,sgtnf.game_virn_digits from st_se_game_ticket_nbr_format sgtnf,(select game_name,game_nbr,game_id from st_se_game_master where game_status='OPEN' OR game_status='SALE_CLOSE' OR game_status='SALE_HOLD') res where sgtnf.game_id = res.game_id&quot;);</span>
<span class="nc" id="L356">			boolean flag = false;</span>
<span class="nc bnc" id="L357" title="All 2 branches missed.">			while (result.next()) {</span>
<span class="nc" id="L358">				nbrFormat.append(&quot;Nx*&quot; + result.getString(&quot;game_id&quot;) + &quot;:&quot;);</span>
<span class="nc" id="L359">				nbrFormat.append(result.getString(&quot;game_nbr&quot;) + &quot;:&quot;);</span>
<span class="nc" id="L360">				nbrFormat.append(result.getString(&quot;game_name&quot;) + &quot;:&quot;);</span>
<span class="nc" id="L361">				nbrFormat.append(result.getInt(&quot;pack_nbr_digits&quot;) + &quot;:&quot;);</span>
<span class="nc" id="L362">				nbrFormat.append(result.getInt(&quot;book_nbr_digits&quot;) + &quot;:&quot;);</span>
<span class="nc" id="L363">				nbrFormat.append(result.getInt(&quot;ticket_nbr_digits&quot;) + &quot;:&quot;);</span>
<span class="nc" id="L364">				nbrFormat.append(result.getInt(&quot;game_nbr_digits&quot;) + &quot;:&quot;);</span>
<span class="nc" id="L365">				nbrFormat.append(result.getInt(&quot;game_virn_digits&quot;));</span>
<span class="nc" id="L366">				flag = true;</span>
			}
<span class="nc" id="L368">			System.out.println(&quot;result of pwt &quot; + nbrFormat.toString());</span>
<span class="nc" id="L369">			String nbrFormatStr = &quot;&quot;;</span>
<span class="nc bnc" id="L370" title="All 2 branches missed.">			if (flag) {</span>
<span class="nc" id="L371">				nbrFormatStr = nbrFormat.delete(0, 3).toString();</span>
			}
<span class="nc" id="L373">			System.out.println(&quot;returned string = &quot; + nbrFormatStr);</span>
<span class="nc" id="L374">			return nbrFormatStr;</span>
<span class="nc" id="L375">		} catch (SQLException e) {</span>
<span class="nc" id="L376">			e.printStackTrace();</span>
<span class="nc" id="L377">			throw new LMSException(e);</span>
<span class="nc" id="L378">		} catch (Exception e) {</span>
<span class="nc" id="L379">			e.printStackTrace();</span>
<span class="nc" id="L380">			throw new LMSException(e);</span>
		} finally {
<span class="nc" id="L382">			try {</span>
<span class="nc" id="L383">				connection.close();</span>
<span class="nc" id="L384">			} catch (SQLException e) {</span>
<span class="nc" id="L385">				e.printStackTrace();</span>
<span class="nc" id="L386">				throw new LMSException(e);</span>
<span class="nc" id="L387">			}</span>
		}
	}
	public String fetchPwtGameDetailsNewWinning(String tktNbr, String virnNbr) throws LMSException {
<span class="nc" id="L391">	      	String gameNbr =&quot;&quot;;</span>
<span class="nc" id="L392">	    	String game_id=&quot;&quot;;</span>
<span class="nc" id="L393">	        String game_name=&quot;&quot;;</span>
<span class="nc" id="L394">	        String gameIdNbrName=&quot;&quot;;</span>
		try {
<span class="nc" id="L396">			gameNbr = tktNbr.substring(0, Math.min(tktNbr.length(), 3));</span>
<span class="nc" id="L397">			connection = DBConnect.getConnection();</span>
<span class="nc" id="L398">			String query2 = &quot;select game_name,game_id,pwt_end_date from st_se_game_master where game_nbr=?&quot;;</span>
<span class="nc" id="L399">			pstmt = connection.prepareStatement(query2);</span>
<span class="nc" id="L400">			pstmt.setInt(1, Integer.parseInt(gameNbr));</span>
<span class="nc" id="L401">			result=pstmt.executeQuery();</span>
<span class="nc bnc" id="L402" title="All 2 branches missed.">			if(result.next()) {</span>
<span class="nc bnc" id="L403" title="All 2 branches missed.">				if(Util.getCurrentTimeStamp().after(result.getDate(&quot;pwt_end_date&quot;))){</span>
<span class="nc" id="L404">					throw new LMSException(LMSErrors.GENERAL_EXCEPTION_ERROR_CODE,LMSErrors.TICKET_EXPIRE_ERROR_MESSAGE);</span>
				}
<span class="nc" id="L406">				game_id = result.getString(2);</span>
<span class="nc" id="L407">				game_name = result.getString(1);</span>
<span class="nc" id="L408">				gameIdNbrName = game_id+&quot;-&quot;+gameNbr+&quot;-&quot;+game_name;</span>
			}
			else{
<span class="nc" id="L411">				throw new LMSException(LMSErrors.GENERAL_EXCEPTION_ERROR_CODE,LMSErrors.GAME_NOT_AVAILABLE_ERROR_MESSAGE);</span>
			}
			
<span class="nc" id="L414">		    }catch (SQLException e) {</span>
<span class="nc" id="L415">		    	e.printStackTrace();</span>
<span class="nc" id="L416">		    	throw new LMSException(LMSErrors.GENERAL_EXCEPTION_ERROR_CODE,LMSErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="nc" id="L417">		   }catch(LMSException e) {</span>
<span class="nc" id="L418">				throw e;</span>
<span class="nc" id="L419">			}catch (Exception e) {</span>
<span class="nc" id="L420">				e.printStackTrace();</span>
<span class="nc" id="L421">				throw new LMSException(LMSErrors.GENERAL_EXCEPTION_ERROR_CODE,LMSErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
		} finally {
<span class="nc" id="L423">			DBConnect.closeCon(connection);</span>
<span class="nc" id="L424">		}</span>
<span class="nc" id="L425">		return gameIdNbrName;</span>
	}

	 
	private Map&lt;String, Object&gt; getOrganizationForApp(int orgId, double pwtAmt,
			Connection connection) throws SQLException, LMSException {

<span class="nc" id="L432">		Map&lt;String, Object&gt; map = new TreeMap&lt;String, Object&gt;();</span>
<span class="nc" id="L433">		String getParentOrgId = &quot;select parent_id, (select organization_type from st_lms_organization_master bb &quot;</span>
				+ &quot; where  organization_id = aa.parent_id) 'organization_type' from (select parent_id,organization_type &quot;
				+ &quot; from st_lms_organization_master where organization_id = ?)aa&quot;;
<span class="nc" id="L436">		pstmt = connection.prepareStatement(getParentOrgId);</span>
<span class="nc" id="L437">		pstmt.setInt(1, orgId);</span>
<span class="nc" id="L438">		result = pstmt.executeQuery();</span>
<span class="nc" id="L439">		System.out.println(&quot;getOrganizationForApp = &quot; + pstmt);</span>
<span class="nc bnc" id="L440" title="All 2 branches missed.">		if (result.next()) {</span>
<span class="nc" id="L441">			int parentOrgId = result.getInt(&quot;parent_id&quot;);</span>
<span class="nc" id="L442">			String organizationType = result.getString(&quot;organization_type&quot;);</span>
			// int parentUserId = result.getInt(&quot;user_id&quot;);
			// added by yogesh because this function is written in common
			// functions of pwt
<span class="nc" id="L446">			CommonFunctionsHelper commonFunction = new CommonFunctionsHelper();</span>
<span class="nc" id="L447">			OrgPwtLimitBean limitBean = commonFunction</span>
					.fetchPwtLimitsOfOrgnization(parentOrgId, connection);

<span class="nc bnc" id="L450" title="All 4 branches missed.">			if (!&quot;BO&quot;.equalsIgnoreCase(organizationType)</span>
					&amp;&amp; pwtAmt &gt; limitBean.getApprovalLimit()) {
<span class="nc" id="L452">				System.out</span>
						.println(&quot;getOrganizationForApp is called again because PWT Amt is &quot;
								+ &quot; greator then parent ('&quot;
								+ organizationType
								+ &quot;') approval limit &quot;);
<span class="nc" id="L457">				map = getOrganizationForApp(parentOrgId, pwtAmt, connection);</span>
			} else {
<span class="nc" id="L459">				map.put(&quot;parentOrgId&quot;, parentOrgId);</span>
<span class="nc" id="L460">				map.put(&quot;organizationType&quot;, organizationType);</span>
				// map.put(&quot;parentUserId&quot;, parentUserId);
<span class="nc" id="L462">				map.put(&quot;limitBean&quot;, limitBean);</span>
			}
<span class="nc" id="L464">			return map;</span>

		} else {
<span class="nc" id="L467">			System.out.println(&quot;No Organization found&quot;);</span>
<span class="nc" id="L468">			throw new LMSException(&quot;No Organization found&quot;);</span>
		}

	}

	private Map insIntoPwtAppReqMasByRet(UserInfoBean userInfoBean,
			PwtBean pwtBean, TicketBean tktBean, String playerType,
			String playerId, PlayerBean plrBean, String recIdForApp)
			throws LMSException, SQLException {

<span class="nc" id="L478">		Map map = new TreeMap();</span>

		// get the current organization pay limit
<span class="nc" id="L481">		CommonFunctionsHelper commonFunction = new CommonFunctionsHelper();</span>
<span class="nc" id="L482">		OrgPwtLimitBean limitBean = commonFunction.fetchPwtLimitsOfOrgnization(</span>
				userInfoBean.getUserOrgId(), connection);
		
<span class="nc" id="L485">		boolean isUserBO = &quot;BO&quot;.equalsIgnoreCase(userInfoBean.getUserType());</span>
<span class="nc bnc" id="L486" title="All 4 branches missed.">		boolean isAppReq = isUserBO ? false : Double.parseDouble(pwtBean.getPwtAmount()) &gt; limitBean</span>
				.getApprovalLimit();
<span class="nc bnc" id="L488" title="All 4 branches missed.">		boolean inPayLimit = isUserBO ? true : Double.parseDouble(pwtBean.getPwtAmount()) &lt;= limitBean</span>
				.getPayLimit();

<span class="nc" id="L491">		int reqToOrgId = userInfoBean.getUserOrgId();</span>
<span class="nc" id="L492">		String reqToOrgType = userInfoBean.getUserType();</span>

<span class="nc bnc" id="L494" title="All 6 branches missed.">		if (isAppReq || pwtBean.getIsHighLevel() &amp;&amp; !inPayLimit) {</span>
			// get the organization details whose Approval is required
<span class="nc" id="L496">			Map&lt;String, Object&gt; orgForAppDetail = getOrganizationForApp(</span>
					userInfoBean.getUserOrgId(), Double.parseDouble(pwtBean
							.getPwtAmount()), connection);
<span class="nc" id="L499">			reqToOrgId = (Integer) orgForAppDetail.get(&quot;parentOrgId&quot;);</span>
<span class="nc" id="L500">			reqToOrgType = (String) orgForAppDetail.get(&quot;organizationType&quot;);</span>
		}
<span class="nc bnc" id="L502" title="All 6 branches missed.">		boolean isAutoApp = !(isAppReq || pwtBean.getIsHighLevel()</span>
				&amp;&amp; !inPayLimit);
<span class="nc" id="L504">		System.out.println(&quot;Approval requested to orgId = &quot; + reqToOrgId</span>
				+ &quot;  and user type = &quot; + reqToOrgType);

<span class="nc bnc" id="L507" title="All 2 branches missed.">		String status = isAutoApp ? &quot;PND_PAY&quot; : &quot;REQUESTED&quot;;</span>

		// insert into Approval table
<span class="nc" id="L510">		String insertAppQuery = createQueryForApp(isAutoApp);</span>
<span class="nc" id="L511">		System.out.println(&quot;insertAppQuery = &quot; + insertAppQuery);</span>
<span class="nc" id="L512">		pstmt = connection.prepareStatement(insertAppQuery);</span>
<span class="nc" id="L513">		pstmt.setString(1, playerType.toUpperCase());</span>
<span class="nc" id="L514">		pstmt.setString(2, recIdForApp);</span>

<span class="nc" id="L516">		boolean isPlr = &quot;player&quot;.equalsIgnoreCase(playerType.trim());</span>
<span class="nc bnc" id="L517" title="All 2 branches missed.">		if (isPlr) {</span>
<span class="nc" id="L518">			pstmt.setInt(3, Integer.parseInt(playerId));</span>
		} else {
<span class="nc" id="L520">			pstmt.setObject(3, null);</span>
		}

<span class="nc" id="L523">		pstmt.setString(4, tktBean.getTicketNumber());</span>
<span class="nc" id="L524">		pstmt.setString(5, pwtBean.getEncVirnCode());</span>
<span class="nc" id="L525">		pstmt.setInt(6, tktBean.getTicketGameId());</span>
<span class="nc" id="L526">		pstmt.setDouble(7, Double.parseDouble(pwtBean.getPwtAmount()));</span>
<span class="nc" id="L527">		pstmt.setDouble(8, 0.0);</span>
<span class="nc" id="L528">		pstmt.setDouble(9, Double.parseDouble(pwtBean.getPwtAmount()));</span>
<span class="nc" id="L529">		pstmt.setString(10, status);</span>
<span class="nc" id="L530">		pstmt.setString(11, userInfoBean.getUserType());</span>
<span class="nc" id="L531">		pstmt.setInt(12, userInfoBean.getUserId());</span>
<span class="nc" id="L532">		pstmt.setInt(13, userInfoBean.getUserOrgId());</span>
<span class="nc" id="L533">		pstmt.setInt(14, reqToOrgId);</span>
<span class="nc" id="L534">		pstmt.setString(15, reqToOrgType);</span>
<span class="nc" id="L535">		pstmt.setTimestamp(16, new java.sql.Timestamp(new java.util.Date()</span>
				.getTime()));
<span class="nc" id="L537">		pstmt.setString(17, &quot;request For PWT Approval&quot;);</span>
<span class="nc bnc" id="L538" title="All 2 branches missed.">		if (isAutoApp) {</span>
<span class="nc" id="L539">			pstmt.setString(17, &quot;Auto Approved. &quot;);</span>
<span class="nc" id="L540">			pstmt.setString(18, userInfoBean.getUserType());</span>
<span class="nc" id="L541">			pstmt.setInt(19, userInfoBean.getUserId());</span>
<span class="nc" id="L542">			pstmt.setInt(20, userInfoBean.getUserOrgId());</span>
<span class="nc" id="L543">			pstmt.setString(21, userInfoBean.getUserType());</span>
<span class="nc" id="L544">			pstmt.setInt(22, userInfoBean.getUserOrgId());</span>
<span class="nc" id="L545">			pstmt.setTimestamp(23, new java.sql.Timestamp(new java.util.Date()</span>
					.getTime()));
		}
<span class="nc" id="L548">		System.out.println(&quot;insertAppQuery pppppp = &quot; + pstmt);</span>
<span class="nc" id="L549">		pstmt.executeUpdate();</span>

<span class="nc" id="L551">		System.out.println(&quot;insertion into pwt temp table = &quot; + pstmt);</span>
<span class="nc" id="L552">		ResultSet rs = pstmt.getGeneratedKeys();</span>
<span class="nc" id="L553">		Integer reqId = null;</span>
<span class="nc bnc" id="L554" title="All 2 branches missed.">		if (rs.next()) {</span>
<span class="nc" id="L555">			reqId = rs.getInt(1);</span>

			// update the ticket_inv_detail table

<span class="nc bnc" id="L559" title="All 2 branches missed.">			if (playerId == null) {</span>
<span class="nc" id="L560">				playerId = &quot;0&quot;;</span>
			}
<span class="nc" id="L562">			CommonFunctionsHelper commHelper = new CommonFunctionsHelper();</span>
<span class="nc" id="L563">			commHelper.updateTicketInvTable(tktBean.getTicketNumber(), tktBean</span>
					.getBook_nbr(), tktBean.getGameNbr(), tktBean
					.getTicketGameId(), status, userInfoBean.getUserId(),
					userInfoBean.getUserOrgId(), tktBean.getUpdateTicketType(),
					Integer.parseInt(playerId), userInfoBean.getChannel(),
					userInfoBean.getInterfaceType(), connection);

			// update VIRN inventory status table
<span class="nc" id="L571">			commHelper.updateVirnStatus(tktBean.getGameNbr(), status, tktBean</span>
					.getTicketGameId(), pwtBean.getEncVirnCode(), connection,MD5Encoder.encode(tktBean.getTicketNumber()));

<span class="nc" id="L574">			map.put(&quot;reqId&quot;, reqId);</span>
<span class="nc" id="L575">			map.put(&quot;isAutoApp&quot;, isAutoApp);</span>
<span class="nc" id="L576">			map.put(&quot;reqToOrgType&quot;, reqToOrgType);</span>
<span class="nc" id="L577">			return map;</span>
		} else {
<span class="nc" id="L579">			throw new LMSException(</span>
					&quot;NO Data Inserted in st_se_pwt_approval_request_master table&quot;);
		}

		// return reqId;

	}

	public Map plrRegistrationAndApproval(UserInfoBean userInfoBean,
			Map pwtDetails, String playerType, String playerId,
			PlayerBean plrBean, String root) throws LMSException {
<span class="nc" id="L590">		Map pwtAppMap = new TreeMap();</span>
<span class="nc" id="L591">		TicketBean tktBean = (TicketBean) pwtDetails.get(&quot;tktBean&quot;);</span>
<span class="nc" id="L592">		PwtBean pwtBean = (PwtBean) pwtDetails.get(&quot;pwtBean&quot;);</span>

		try {
<span class="nc" id="L595">			connection = DBConnect.getConnection();</span>
<span class="nc" id="L596">			connection.setAutoCommit(false);</span>

			// register player
<span class="nc bnc" id="L599" title="All 4 branches missed.">			if (plrBean != null &amp;&amp; &quot;PLAYER&quot;.equalsIgnoreCase(playerType.trim())) {</span>
<span class="nc" id="L600">				playerId = new PlayerVerifyHelperForApp().registerPlayer(</span>
						plrBean, connection)
						+ &quot;&quot;;
			}

<span class="nc" id="L605">			System.out.println(&quot;Player id is &quot; + playerId</span>
					+ &quot; for that approval required&quot;);

<span class="nc" id="L608">			System.out.println(&quot;is Approval required = '&quot; + pwtBean.getAppReq()</span>
					+ &quot;' , to  '&quot; + userInfoBean.getUserType()
					+ &quot;' of orgId = &quot; + userInfoBean.getUserOrgId()
					+ &quot; and user id = &quot; + userInfoBean.getUserId());

			// generate TEMP receipt for Approval
			// String recIdForApp = &quot;PWT12345678&quot;;
			// receipt generation done by yogesh
<span class="nc" id="L616">			String recIdForApp = GenerateRecieptNo.generateRequestId(&quot;REQUEST&quot;);</span>
<span class="nc bnc" id="L617" title="All 4 branches missed.">			if (recIdForApp == null || &quot;&quot;.equals(recIdForApp)) {</span>
<span class="nc" id="L618">				throw new LMSException(&quot;Request Id is not generated properly&quot;);</span>
			}

<span class="nc" id="L621">			pwtAppMap = insIntoPwtAppReqMasByRet(userInfoBean, pwtBean,</span>
					tktBean, playerType, playerId, plrBean, recIdForApp);

<span class="nc" id="L624">			connection.commit();</span>

<span class="nc" id="L626">			int reqId = (Integer) pwtAppMap.get(&quot;reqId&quot;);</span>
<span class="nc" id="L627">			GraphReportHelper graphReportHelper = new GraphReportHelper();</span>
<span class="nc" id="L628">			graphReportHelper.createTextReportTempPlayerReceipt(reqId + &quot;&quot;,</span>
					&quot;RETAILER&quot;, root, &quot;SCRATCH_GAME&quot;);

<span class="nc" id="L631">			pwtAppMap.put(&quot;recId&quot;, recIdForApp);</span>
<span class="nc" id="L632">			pwtAppMap.put(&quot;reqId&quot;, reqId);</span>
<span class="nc" id="L633">			pwtAppMap.putAll(pwtDetails);</span>

<span class="nc" id="L635">			return pwtAppMap;</span>

<span class="nc" id="L637">		} catch (Exception e) {</span>
<span class="nc" id="L638">			e.printStackTrace();</span>
<span class="nc" id="L639">			throw new LMSException(e);</span>
		} finally {
<span class="nc bnc" id="L641" title="All 4 branches missed.">			if (connection != null) {</span>
				try {
<span class="nc" id="L643">					connection.close();</span>
<span class="nc" id="L644">				} catch (SQLException e) {</span>
<span class="nc" id="L645">					e.printStackTrace();</span>
<span class="nc" id="L646">					throw new LMSException(e);</span>
<span class="nc" id="L647">				}</span>
			}
		}
	}

	/*
	 * // common method for all organization private OrgPwtLimitBean
	 * fetchPwtLimitsOfOrgnization(int userOrgId, Connection connection) throws
	 * SQLException { OrgPwtLimitBean bean = null; String query = &quot;select
	 * aa.organization_id, verification_limit, approval_limit, pay_limit,
	 * scrap_limit, bb.pwt_scrap from st_lms_oranization_limits aa,
	 * st_lms_organization_master bb where aa.organization_id =
	 * bb.organization_id and aa.organization_id = ?&quot;; pstmt =
	 * connection.prepareStatement(query); pstmt.setInt(1, userOrgId); result =
	 * pstmt.executeQuery(); System.out.println(&quot;query that fetch limit details =
	 * &quot;+pstmt); if(result.next()) { bean = new OrgPwtLimitBean();
	 * bean.setOrganizationId(userOrgId);
	 * bean.setVerificationLimit(result.getDouble(&quot;verification_limit&quot;));
	 * bean.setApprovalLimit(result.getDouble(&quot;approval_limit&quot;));
	 * bean.setPayLimit(result.getDouble(&quot;pay_limit&quot;));
	 * bean.setScrapLimit(result.getDouble(&quot;scrap_limit&quot;));
	 * bean.setIsPwtAutoScrap(result.getString(&quot;pwt_scrap&quot;)); } return bean; }
	 */

	public int retDirectPlrPWTPaymentProcess(UserInfoBean userInfo,
			PwtBean bean, TicketBean tktBean, OrgPwtLimitBean limitBean,
			String playerId, String pendingReqId, Connection connection)
			throws SQLException, LMSException {
<span class="nc" id="L675">		PwtBean pwtBean = bean;</span>
<span class="nc" id="L676">		int gameId = tktBean.getTicketGameId();</span>
<span class="nc" id="L677">		double pwtAmt = Double.parseDouble(pwtBean.getPwtAmount());</span>
<span class="nc" id="L678">		int transId = -1;</span>

<span class="nc bnc" id="L680" title="All 2 branches missed.">		if (pwtAmt &lt; limitBean.getPayLimit()) {</span>

			// insert data into main transaction master
<span class="nc" id="L683">			System.out.println(&quot;insert data into transaction master &quot;);</span>
<span class="nc" id="L684">			String transMasQuery = QueryManager.insertInLMSTransactionMaster();</span>
<span class="nc" id="L685">			PreparedStatement pstmt = connection</span>
					.prepareStatement(transMasQuery);
<span class="nc" id="L687">			pstmt.setString(1, &quot;RETAILER&quot;);</span>
<span class="nc" id="L688">			pstmt.executeUpdate();</span>
<span class="nc" id="L689">			ResultSet rs = pstmt.getGeneratedKeys();</span>
<span class="nc bnc" id="L690" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L691">				transId = rs.getInt(1);</span>

				// insert into retailer transaction master
<span class="nc" id="L694">				String retTransMasterQuery = &quot;insert into  st_lms_retailer_transaction_master ( transaction_id , retailer_user_id , retailer_org_id , transaction_date , transaction_type ) values (?,?,?,?,?)&quot;;</span>
<span class="nc" id="L695">				System.out.println(&quot;retTransMasterQuery = &quot;</span>
						+ retTransMasterQuery);
<span class="nc" id="L697">				pstmt = connection.prepareStatement(retTransMasterQuery);</span>
<span class="nc" id="L698">				pstmt.setInt(1, transId);</span>
<span class="nc" id="L699">				pstmt.setInt(2, userInfo.getUserId());</span>
<span class="nc" id="L700">				pstmt.setInt(3, userInfo.getUserOrgId());</span>
<span class="nc" id="L701">				pstmt.setTimestamp(4, new java.sql.Timestamp(</span>
						new java.util.Date().getTime()));
<span class="nc" id="L703">				pstmt.setString(5, &quot;PWT_PLR_RET&quot;);</span>
<span class="nc" id="L704">				pstmt.executeUpdate();</span>
<span class="nc" id="L705">				System.out.println(&quot;insert into retailer transaction master = &quot;</span>
						+ pstmt);

				// insert into st_se_retailer_pwt when comes pwtAmt&lt;Aproval
				// required
<span class="nc" id="L710">				String retPwtEntry = &quot;insert into  Direct player ( retailer_user_id , retailer_org_id , virn , ticket_nbr ,&quot;</span>
						+ &quot; game_id , transaction_id , pwt_amt , comm_amt , net_amt , status ) values ( ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)&quot;;
<span class="nc" id="L712">				pstmt = connection.prepareStatement(retPwtEntry);</span>
<span class="nc" id="L713">				pstmt.setInt(1, userInfo.getUserId());</span>
<span class="nc" id="L714">				pstmt.setInt(2, userInfo.getUserOrgId());</span>
<span class="nc" id="L715">				pstmt.setString(3, pwtBean.getEncVirnCode());</span>
<span class="nc" id="L716">				pstmt.setString(4, tktBean.getTicketNumber());</span>
<span class="nc" id="L717">				pstmt.setInt(5, gameId);</span>
<span class="nc" id="L718">				pstmt.setInt(6, transId);</span>
<span class="nc" id="L719">				pstmt.setDouble(7, pwtAmt);</span>
<span class="nc" id="L720">				pstmt.setDouble(8, 0.0);</span>
<span class="nc" id="L721">				pstmt.setDouble(9, pwtAmt);</span>
<span class="nc bnc" id="L722" title="All 4 branches missed.">				if (&quot;YES&quot;.equalsIgnoreCase(limitBean.getIsPwtAutoScrap())</span>
						&amp;&amp; pwtAmt &lt;= limitBean.getScrapLimit()) {
<span class="nc" id="L724">					pstmt.setString(10, &quot;CLAIM_BAL&quot;);</span>
				} else {
<span class="nc" id="L726">					pstmt.setString(10, &quot;UNCLAIM_BAL&quot;);</span>
				}
<span class="nc" id="L728">				pstmt.executeUpdate();</span>
<span class="nc" id="L729">				System.out.println(&quot;insert into st_se_retailer_pwt = &quot; + pstmt);</span>

				// update status of of requested id entries into
				// st_se_pwt_approval_request_master
<span class="nc" id="L733">				String updateAppTable = &quot;update  st_se_pwt_approval_request_master  set req_status ='DONE', &quot;</span>
						+ &quot;remarks ='Payment Done', payment_done_by_type =?, payment_done_by =? where  task_id = ?&quot;;
<span class="nc" id="L735">				pstmt = connection.prepareStatement(updateAppTable);</span>
<span class="nc" id="L736">				pstmt.setString(1, userInfo.getUserType());</span>
<span class="nc" id="L737">				pstmt.setInt(2, userInfo.getUserOrgId());</span>
<span class="nc" id="L738">				pstmt.setInt(3, Integer.parseInt(pendingReqId));</span>
<span class="nc" id="L739">				int i = pstmt.executeUpdate();</span>
<span class="nc" id="L740">				System.out.println(&quot;total row updated = &quot; + i</span>
						+ &quot; ,  requested id &quot; + pendingReqId
						+ &quot; status updated = &quot; + pstmt);
<span class="nc bnc" id="L743" title="All 2 branches missed.">				if (i &lt; 1) {</span>
<span class="nc" id="L744">					throw new LMSException(</span>
							&quot;st_se_pwt_approval_request_master table not updated.&quot;);
				}

				// update the remaining prize list
<span class="nc" id="L749">				GameUtilityHelper.updateNoOfPrizeRemNewZim(gameId, pwtAmt,</span>
						&quot;PWT_PLR_RET&quot;, pwtBean.getEncVirnCode(), connection,
						tktBean.getGameNbr(),MD5Encoder.encode(tktBean.getTicketNumber()));

				// update ticket inventory status table
<span class="nc" id="L754">				String updateTktInvQuery = &quot;update st_se_pwt_inv_? set status = ? where game_id = ? and virn_code = ?&quot;;</span>
<span class="nc" id="L755">				PreparedStatement invPstmt = connection</span>
						.prepareStatement(updateTktInvQuery);
<span class="nc" id="L757">				invPstmt.setInt(1, tktBean.getGameNbr());</span>
<span class="nc" id="L758">				invPstmt.setString(2, &quot;PWT_PLR_RET&quot;);</span>
<span class="nc" id="L759">				invPstmt.setInt(3, gameId);</span>
<span class="nc" id="L760">				invPstmt.setString(4, pwtBean.getEncVirnCode());</span>
<span class="nc" id="L761">				int row = invPstmt.executeUpdate();</span>
<span class="nc" id="L762">				System.out.println(&quot;total row = &quot; + row</span>
						+ &quot;   ,update ticket inventory status table = &quot;
						+ invPstmt);
<span class="nc bnc" id="L765" title="All 2 branches missed.">				if (row &lt; 1) {</span>
<span class="nc" id="L766">					throw new LMSException(</span>
							&quot;update ticket inventory status table not updated.&quot;);
				}

				// update the ticket_inv_detail table
<span class="nc" id="L771">				CommonFunctionsHelper commHelper = new CommonFunctionsHelper();</span>
<span class="nc" id="L772">				commHelper.updateTicketInvTable(tktBean.getTicketNumber(),</span>
						tktBean.getBook_nbr(), tktBean.getGameNbr(), gameId,
						&quot;TKT_PLR_RET&quot;, userInfo.getUserId(), userInfo
								.getUserOrgId(), tktBean.getUpdateTicketType(),
						0, userInfo.getChannel(), userInfo.getInterfaceType(),
						connection);

				// update retailer UNCLAIM_BAL payment
<span class="nc" id="L780">				String updateRetBalQuery = &quot;update st_lms_organization_master set unclaimable_bal = (unclaimable_bal+?) where organization_id = ?&quot;;</span>
<span class="nc bnc" id="L781" title="All 4 branches missed.">				if (&quot;YES&quot;.equalsIgnoreCase(limitBean.getIsPwtAutoScrap())</span>
						&amp;&amp; pwtAmt &lt;= limitBean.getScrapLimit()) {
<span class="nc" id="L783">					updateRetBalQuery = &quot;update st_lms_organization_master set claimable_bal = (claimable_bal+?) &quot;</span>
							+ &quot; , organization_status = if((available_credit-claimable_bal)&gt;0, 'ACTIVE', 'INACTIVE')&quot;
							+ &quot; where organization_id = ?&quot;;
					// updateRetBalQuery = &quot;update st_lms_organization_master
					// set claimable_bal = (claimable_bal+?) where
					// organization_id = ?&quot;;
				}
<span class="nc" id="L790">				PreparedStatement updateRetBal = connection</span>
						.prepareStatement(updateRetBalQuery);
<span class="nc" id="L792">				updateRetBal.setDouble(1, pwtAmt);</span>
<span class="nc" id="L793">				updateRetBal.setInt(2, userInfo.getUserOrgId());</span>
<span class="nc" id="L794">				row = updateRetBal.executeUpdate();</span>
<span class="nc" id="L795">				System.out.println(&quot;updateRetBalQuery = &quot; + updateRetBal);</span>

				// receipt entries are required to be inserted into receipt
				// table

<span class="nc" id="L800">			} else {</span>
<span class="nc" id="L801">				throw new LMSException(</span>
						&quot;no data insert into main transaction master&quot;);
			}

<span class="nc" id="L805">		} else { // PWT amount is Greater then Retailer pay limit</span>
<span class="nc" id="L806">			pwtBean.setValid(false);</span>
<span class="nc" id="L807">			pwtBean.setVerificationStatus(&quot;InValid Virn&quot;);</span>
<span class="nc" id="L808">			pwtBean.setMessage(&quot;Undefined&quot;);</span>
<span class="nc" id="L809">			pwtBean</span>
					.setMessageCode(&quot;PWT amount is Greater then Retailer pay limit&quot;);
<span class="nc" id="L811">			System.out.println(&quot;PWT amount is Greater then Retailer pay limit&quot;);</span>
		}

<span class="nc" id="L814">		return transId;</span>

	}

	/**
	 * retailer PWT payment process implementation
	 * 
	 * @param bean
	 * @param tktBean
	 * @param limitBean,
	 *            OrgPwtLimitBean which contain all the limit of login
	 *            organization
	 * @param highPrizeAmt,
	 * @param highPrizeCriteria,
	 * @param prizeLevel
	 * @param playerBean,
	 *            if comes from player registration process else NULL
	 * @return
	 * @throws SQLException
	 * @throws LMSException
	 */

	private String retEndPWTPaymentProcess(UserInfoBean userInfo, PwtBean bean,
			TicketBean tktBean, OrgPwtLimitBean limitBean, boolean isAnonymous,
			String pendingReqId, Connection connection,String entktNbr) throws SQLException,
			LMSException {
<span class="nc" id="L840">		PwtBean pwtBean = bean;</span>
<span class="nc" id="L841">		int gameId = tktBean.getTicketGameId();</span>
<span class="nc" id="L842">		double pwtAmt = Double.parseDouble(pwtBean.getPwtAmount());</span>
<span class="nc" id="L843">		String recId = null;</span>
<span class="nc" id="L844">		String pwtStatus = &quot;&quot;;</span>

<span class="nc bnc" id="L846" title="All 4 branches missed.">		boolean isAutoScrap = &quot;YES&quot;.equalsIgnoreCase(limitBean</span>
				.getIsPwtAutoScrap())
				&amp;&amp; pwtAmt &lt;= limitBean.getScrapLimit();

<span class="nc bnc" id="L850" title="All 2 branches missed.">		if (pwtAmt &lt;= limitBean.getPayLimit()) {</span>
<span class="nc" id="L851">			System.out.println(&quot;mmmmmmm  &quot; + gameId);</span>
<span class="nc" id="L852">			CommonFunctionsHelper commHelper = new CommonFunctionsHelper();</span>

			// insert data into main transaction master
<span class="nc" id="L855">			System.out.println(&quot;insert data into transaction master &quot;);</span>
<span class="nc" id="L856">			String transMasQuery = QueryManager.insertInLMSTransactionMaster();</span>
<span class="nc" id="L857">			PreparedStatement pstmt = connection.prepareStatement(transMasQuery);</span>
<span class="nc" id="L858">			pstmt.setString(1, &quot;RETAILER&quot;);</span>
<span class="nc" id="L859">			pstmt.executeUpdate();</span>
<span class="nc" id="L860">			ResultSet rs = pstmt.getGeneratedKeys();</span>
<span class="nc bnc" id="L861" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L862">				int transId = rs.getInt(1);</span>

				// insert into retailer transaction master
<span class="nc" id="L865">				String retTransMasterQuery = &quot;insert into  st_lms_retailer_transaction_master ( transaction_id , retailer_user_id , retailer_org_id , transaction_date , transaction_type,game_id ) values (?,?,?,?,?,?)&quot;;</span>
<span class="nc" id="L866">				System.out.println(&quot;retTransMasterQuery = &quot;	+ retTransMasterQuery);</span>
<span class="nc" id="L867">				pstmt = connection.prepareStatement(retTransMasterQuery);</span>
<span class="nc" id="L868">				pstmt.setInt(1, transId);</span>
<span class="nc" id="L869">				pstmt.setInt(2, userInfo.getUserId());</span>
<span class="nc" id="L870">				pstmt.setInt(3, userInfo.getUserOrgId());</span>
<span class="nc" id="L871">				pstmt.setTimestamp(4, new java.sql.Timestamp(new java.util.Date().getTime()));</span>
<span class="nc" id="L872">				pstmt.setString(5, &quot;PWT&quot;);</span>
<span class="nc" id="L873">				pstmt.setInt(6, gameId);</span>
<span class="nc" id="L874">				pstmt.executeUpdate();</span>
<span class="nc" id="L875">				System.out.println(&quot;insert into retailer transaction master = &quot;	+ pstmt);</span>

				// insert into st_se_retailer_pwt when comes pwtAmt&lt;Aproval
				// required
<span class="nc" id="L879">				String retPwtEntry = &quot;insert into  st_se_retailer_pwt ( retailer_user_id , retailer_org_id , virn_code , ticket_nbr ,&quot;</span>
						+ &quot; game_id , transaction_id , pwt_amt , claim_comm , agt_claim_comm, status ) values ( ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)&quot;;
<span class="nc" id="L881">				pstmt = connection.prepareStatement(retPwtEntry);</span>
<span class="nc" id="L882">				pstmt.setInt(1, userInfo.getUserId());</span>
<span class="nc" id="L883">				pstmt.setInt(2, userInfo.getUserOrgId());</span>
<span class="nc" id="L884">				pstmt.setString(3, pwtBean.getEncVirnCode());</span>
<span class="nc" id="L885">				pstmt.setString(4, tktBean.getTicketNumber());</span>
<span class="nc" id="L886">				pstmt.setInt(5, gameId);</span>
<span class="nc" id="L887">				pstmt.setInt(6, transId);</span>
<span class="nc" id="L888">				pstmt.setDouble(7, pwtAmt);</span>
				// put retailer commission
<span class="nc" id="L890">				double retComm = commHelper.fetchCommOfOrganization(gameId,	userInfo.getUserOrgId(), &quot;PWT&quot;, &quot;RETAILER&quot;, connection);</span>
<span class="nc" id="L891">				pstmt.setDouble(8, retComm);</span>
				// put Agent commission
<span class="nc" id="L893">				double agtComm = commHelper.fetchCommOfOrganization(gameId,</span>
						userInfo.getParentOrgId(), &quot;PWT&quot;, &quot;AGENT&quot;, connection);
<span class="nc" id="L895">				pstmt.setDouble(9, agtComm);</span>
<span class="nc" id="L896">				System.out.println(&quot;---qurgfffqqqqqqqqqqqqqqqqqq--------&quot;+ pstmt);</span>
<span class="nc bnc" id="L897" title="All 2 branches missed.">				pwtStatus = isAutoScrap ? &quot;CLAIM_BAL&quot; : &quot;UNCLAIM_BAL&quot;;</span>
<span class="nc" id="L898">				pstmt.setString(10, pwtStatus);</span>

<span class="nc" id="L900">				pstmt.executeUpdate();</span>
<span class="nc" id="L901">				System.out.println(&quot;insert into st_se_retailer_pwt = &quot; + pstmt);</span>

<span class="nc bnc" id="L903" title="All 4 branches missed.">				if (pendingReqId != null &amp;&amp; !isAnonymous) {</span>
					// update status of of requested id entries into
					// st_se_pwt_approval_request_master
<span class="nc" id="L906">					String updateAppTable = &quot;update  st_se_pwt_approval_request_master  set req_status ='DONE', &quot;</span>
							+ &quot;remarks ='Payment Done', payment_done_by_type =?, payment_done_by =? where  task_id = ?&quot;;
<span class="nc" id="L908">					pstmt = connection.prepareStatement(updateAppTable);</span>
<span class="nc" id="L909">					pstmt.setString(1, userInfo.getUserType());</span>
<span class="nc" id="L910">					pstmt.setInt(2, userInfo.getUserOrgId());</span>
<span class="nc" id="L911">					pstmt.setInt(3, Integer.parseInt(pendingReqId));</span>
<span class="nc" id="L912">					int i = pstmt.executeUpdate();</span>
<span class="nc" id="L913">					System.out.println(&quot;total row updated = &quot; + i</span>
							+ &quot; ,  requested id &quot; + pendingReqId
							+ &quot; status updated = &quot; + pstmt);
<span class="nc bnc" id="L916" title="All 2 branches missed.">					if (i &lt; 1) {</span>
<span class="nc" id="L917">						throw new LMSException(</span>
								&quot;st_se_pwt_approval_request_master table not updated.&quot;);
					}
				}

				// update the remaining prize list
<span class="nc bnc" id="L923" title="All 2 branches missed.">				pwtStatus = isAutoScrap ? &quot;CLAIM_PLR_RET_CLM&quot;: &quot;CLAIM_PLR_RET_UNCLM&quot;;</span>
<span class="nc" id="L924">				GameUtilityHelper.updateNoOfPrizeRemNewZim(gameId, pwtAmt, pwtStatus,</span>
						pwtBean.getEncVirnCode(), connection, tktBean
								.getGameNbr(),entktNbr);
<span class="nc" id="L927">				System.out.println(&quot;yogesh testing::  &quot; + pwtBean.getVirnCode()	+ &quot; :encodes virn : &quot; + pwtBean.getEncVirnCode());</span>

				// update VIRN inventory status table
<span class="nc" id="L930">				commHelper.updateVirnStatus(tktBean.getGameNbr(), pwtStatus,gameId, pwtBean.getEncVirnCode(), connection,entktNbr);</span>

				// update the ticket_inv_detail table
<span class="nc" id="L933">				commHelper.updateTicketInvTable(tktBean.getTicketNumber(),</span>
						tktBean.getBook_nbr(), tktBean.getGameNbr(), gameId,
						pwtStatus, userInfo.getUserId(), userInfo.getUserOrgId(), tktBean.getUpdateTicketType(),
						0, userInfo.getChannel(), userInfo.getInterfaceType(),
						connection);

				// update book status from active to claimed in table
				// st_se_game_inv_status table here
<span class="nc bnc" id="L941" title="All 2 branches missed.">				if (&quot;ACTIVE&quot;.equalsIgnoreCase(tktBean.getBookStatus())) {</span>
<span class="nc" id="L942">					commHelper.updateBookStatus(gameId, tktBean.getBook_nbr(),</span>
							connection, &quot;CLAIMED&quot;);
				}
<span class="nc" id="L945">				commHelper.updatePwtDateAndTierTickets(tktBean,connection);</span>

				// update retailer UNCLAIM_BAL payment
<span class="nc bnc" id="L948" title="All 2 branches missed.">				if (isAutoScrap) {</span>
					// commHelper.updateOrgBalance(&quot;CLAIM_BAL&quot;,
					// pwtAmt+(pwtAmt*.01*retComm),
					// userInfo.getUserOrgId(),&quot;CREDIT&quot;, connection);
					// now retailer claimable balance DEBITED
<span class="nc" id="L953">					OrgCreditUpdation.updateOrganizationBalWithValidate(pwtAmt + pwtAmt</span>
							* .01 * retComm, &quot;CLAIM_BAL&quot;, &quot;DEBIT&quot;, userInfo.getUserOrgId(),
							userInfo.getParentOrgId(), &quot;RETAILER&quot;, 0, connection);
					/*commHelper.updateOrgBalance(&quot;CLAIM_BAL&quot;, pwtAmt + pwtAmt
							* .01 * retComm, userInfo.getUserOrgId(), &quot;DEBIT&quot;,
							connection);*/
					// agent claimable balance DEBITED
<span class="nc" id="L960">					OrgCreditUpdation.updateOrganizationBalWithValidate(pwtAmt + pwtAmt</span>
							* .01 * agtComm, &quot;CLAIM_BAL&quot;, &quot;DEBIT&quot;,userInfo.getParentOrgId(),
							0, &quot;AGENT&quot;, 0, connection);
					
					/*commHelper.updateOrgBalance(&quot;CLAIM_BAL&quot;, pwtAmt + pwtAmt
							* .01 * agtComm, userInfo.getParentOrgId(),
							&quot;DEBIT&quot;, connection);*/
				} else {
<span class="nc" id="L968">					OrgCreditUpdation.updateOrganizationBalWithValidate(pwtAmt, &quot;UNCLAIM_BAL&quot;, &quot;CREDIT&quot;, userInfo.getUserOrgId(),</span>
							userInfo.getParentOrgId(), &quot;RETAILER&quot;, 0, connection);
					
					/*commHelper.updateOrgBalance(&quot;UNCLAIM_BAL&quot;, pwtAmt, userInfo
							.getUserOrgId(), &quot;CREDIT&quot;, connection);*/
				}

				// receipt entries are required to be inserted into receipt
				// table

<span class="nc" id="L978">				return recId;</span>

			} else {
<span class="nc" id="L981">				throw new LMSException(</span>
						&quot;no data insert into main transaction master&quot;);
			}

		} else {
<span class="nc" id="L986">			return null;</span>
		}

	}
	public Map&lt;String, Object&gt; verifyTicketAndVirnNumber(String ticketNbr, String virnNbr, 
			int gameId, String gameNbr,UserInfoBean userInfoBean, String highPrizeCriteria, 
			String highPrizeAmount) throws LMSException{
		
		try {
<span class="nc" id="L995">			connection = DBConnect.getConnection();</span>
<span class="nc" id="L996">			connection.setAutoCommit(false);</span>
<span class="nc" id="L997">			Map&lt;String, Object&gt; detailMap = new TreeMap&lt;String, Object&gt;();</span>
<span class="nc" id="L998">			CommonFunctionsHelper commonFunction = new CommonFunctionsHelper();</span>
<span class="nc" id="L999">			TicketBean tktBean = commonFunction.isTicketFormatValid(ticketNbr,gameId, connection);</span>
<span class="nc bnc" id="L1000" title="All 4 branches missed.">			if (tktBean != null &amp;&amp; !tktBean.getIsValid()) {</span>
<span class="nc" id="L1001">				detailMap.put(&quot;returnType&quot;, &quot;input&quot;);</span>
<span class="nc" id="L1002">				tktBean.setTicketNumber(ticketNbr);</span>
<span class="nc" id="L1003">				detailMap.put(&quot;tktBean&quot;, tktBean);</span>
<span class="nc" id="L1004">				return detailMap;</span>
			}
			
<span class="nc" id="L1007">			String tktArr[] = tktBean.getTicketNumber().split(&quot;-&quot;);</span>
<span class="nc" id="L1008">			tktBean = checkTicketStatus(tktArr[0], tktArr[0] + &quot;-&quot; + tktArr[1],tktArr[2], gameId, connection);</span>
<span class="nc bnc" id="L1009" title="All 4 branches missed.">			if (tktBean != null &amp;&amp; !tktBean.getIsValid()) {</span>
<span class="nc" id="L1010">				detailMap.put(&quot;returnType&quot;, &quot;input&quot;);</span>
<span class="nc" id="L1011">				tktBean.setTicketNumber(ticketNbr);</span>
<span class="nc" id="L1012">				detailMap.put(&quot;tktBean&quot;, tktBean);</span>
<span class="nc" id="L1013">				return detailMap;</span>
			}
			
<span class="nc" id="L1016">			tktBean.setTicketGameId(gameId);</span>
<span class="nc" id="L1017">			tktBean.setTicketNumber(tktArr[0] + &quot;-&quot; + tktArr[1] + &quot;-&quot;+ tktArr[2]);</span>
<span class="nc" id="L1018">			tktBean.setBook_nbr(tktArr[0] + &quot;-&quot; + tktArr[1]);</span>
<span class="nc" id="L1019">			tktBean.setGameNbr(Integer.parseInt(tktArr[0]));</span>
<span class="nc" id="L1020">			detailMap.put(&quot;tktBean&quot;, tktBean);</span>
<span class="nc" id="L1021">			PwtBean pwtBean = verifyPwtVirn(gameId, virnNbr, Integer</span>
					.parseInt(gameNbr), connection, userInfoBean,
					highPrizeCriteria, highPrizeAmount, tktBean,true);
<span class="nc bnc" id="L1024" title="All 4 branches missed.">			if (pwtBean != null &amp;&amp; pwtBean.getIsValid()) {</span>
<span class="nc bnc" id="L1025" title="All 4 branches missed.">				if (pwtBean.getAppReq() || pwtBean.getIsHighLevel()) {</span>
<span class="nc" id="L1026">					detailMap.put(&quot;tktBean&quot;, tktBean);</span>
<span class="nc" id="L1027">					detailMap.put(&quot;pwtBean&quot;, pwtBean);</span>
<span class="nc" id="L1028">					detailMap.put(&quot;returnType&quot;, &quot;registration&quot;);</span>
<span class="nc" id="L1029">					System.out.println(&quot;go to registration limit&quot;);</span>
				} else { // changed ticket status
<span class="nc" id="L1031">					System.out.println(&quot;change ticket status&quot;);</span>
<span class="nc" id="L1032">					detailMap.put(&quot;tktBean&quot;, tktBean);</span>
<span class="nc" id="L1033">					detailMap.put(&quot;pwtBean&quot;, pwtBean);</span>
<span class="nc" id="L1034">					detailMap.put(&quot;returnType&quot;, &quot;success&quot;);</span>
				}

<span class="nc" id="L1037">				connection.commit();</span>
<span class="nc" id="L1038">				return detailMap;</span>

			} else {
<span class="nc" id="L1041">				detailMap.put(&quot;tktBean&quot;, tktBean);</span>
<span class="nc" id="L1042">				detailMap.put(&quot;pwtBean&quot;, pwtBean);</span>
<span class="nc" id="L1043">				detailMap.put(&quot;returnType&quot;, &quot;input&quot;);</span>
<span class="nc" id="L1044">				return detailMap;</span>
			}
<span class="nc" id="L1046">		} catch (SQLException e) {</span>
<span class="nc" id="L1047">			e.printStackTrace();</span>
<span class="nc" id="L1048">			throw new LMSException(e);</span>
<span class="nc" id="L1049">		} catch (Exception e) {</span>
<span class="nc" id="L1050">			e.printStackTrace();</span>
<span class="nc" id="L1051">			throw new LMSException(e);</span>
		} finally {
<span class="nc" id="L1053">			try {</span>
<span class="nc" id="L1054">				connection.close();</span>
<span class="nc" id="L1055">			} catch (SQLException e) {</span>
<span class="nc" id="L1056">				e.printStackTrace();</span>
<span class="nc" id="L1057">				throw new LMSException(e);</span>
<span class="nc" id="L1058">			}</span>
		}
	}
	
	public Map&lt;String, Object&gt; verifyAndSaveTicketNVirn(String ticketNbr,
			String virnNbr, int gameId, String gameNbr,
			UserInfoBean userInfoBean, String highPrizeCriteria,
			String highPrizeAmt) throws LMSException {

		try {
<span class="nc" id="L1068">			connection = DBConnect.getConnection();</span>
<span class="nc" id="L1069">			connection.setAutoCommit(false);</span>
			// validate the ticket
<span class="nc" id="L1071">			Map&lt;String, Object&gt; detailMap = new TreeMap&lt;String, Object&gt;();</span>

			// check ticket format
<span class="nc" id="L1074">			CommonFunctionsHelper commonFunction = new CommonFunctionsHelper();</span>
<span class="nc" id="L1075">			TicketBean tktBean = commonFunction.isTicketFormatValid(ticketNbr,gameId, connection);</span>
<span class="nc bnc" id="L1076" title="All 4 branches missed.">			if (tktBean != null &amp;&amp; !tktBean.getIsValid()) {</span>
<span class="nc" id="L1077">				detailMap.put(&quot;returnType&quot;, &quot;input&quot;);</span>
<span class="nc" id="L1078">				tktBean.setTicketNumber(ticketNbr);</span>
<span class="nc" id="L1079">				detailMap.put(&quot;tktBean&quot;, tktBean);</span>
<span class="nc" id="L1080">				return detailMap;</span>
			}
<span class="nc bnc" id="L1082" title="All 2 branches missed.">			if (!new RetailerPwtProcessHelper().canClaimRetailer(ticketNbr, userInfoBean.getUserOrgId(), userInfoBean.getParentOrgId())) {</span>
<span class="nc" id="L1083">				TicketBean bean = new TicketBean();</span>
<span class="nc" id="L1084">				bean.setValid(false);</span>
<span class="nc" id="L1085">				bean.setStatus(&quot;UNAUTHORIZED USER&quot;);</span>
<span class="nc" id="L1086">				bean.setMessageCode(&quot;221001&quot;);</span>
<span class="nc" id="L1087">				bean.setValidity(&quot;InValid Ticket&quot;);</span>
<span class="nc" id="L1088">				bean.setTicketNumber(ticketNbr);</span>
<span class="nc" id="L1089">				detailMap.put(&quot;returnType&quot;, &quot;input&quot;);</span>
<span class="nc" id="L1090">				bean.setTicketNumber(ticketNbr);</span>
<span class="nc" id="L1091">				detailMap.put(&quot;tktBean&quot;, bean);</span>
<span class="nc" id="L1092">				return detailMap;</span>
			}
			// tktArr[0]='game NBR', tktArr[1]='Book NBR', tktArr[2]='Ticket NBR
<span class="nc" id="L1095">			String tktArr[] = tktBean.getTicketNumber().split(&quot;-&quot;);</span>
<span class="nc" id="L1096">			tktBean = checkTicketStatus(tktArr[0], tktArr[0] + &quot;-&quot; + tktArr[1],tktArr[2], gameId, connection);</span>
<span class="nc bnc" id="L1097" title="All 4 branches missed.">			if (tktBean != null &amp;&amp; !tktBean.getIsValid()) {</span>
<span class="nc" id="L1098">				detailMap.put(&quot;returnType&quot;, &quot;input&quot;);</span>
<span class="nc" id="L1099">				tktBean.setTicketNumber(ticketNbr);</span>
<span class="nc" id="L1100">				detailMap.put(&quot;tktBean&quot;, tktBean);</span>
<span class="nc" id="L1101">				return detailMap;</span>
			}

<span class="nc" id="L1104">			tktBean.setTicketGameId(gameId);</span>
<span class="nc" id="L1105">			tktBean.setTicketNumber(tktArr[0] + &quot;-&quot; + tktArr[1] + &quot;-&quot;+ tktArr[2]);</span>
<span class="nc" id="L1106">			tktBean.setBook_nbr(tktArr[0] + &quot;-&quot; + tktArr[1]);</span>
<span class="nc" id="L1107">			tktBean.setGameNbr(Integer.parseInt(tktArr[0]));</span>
<span class="nc" id="L1108">			detailMap.put(&quot;tktBean&quot;, tktBean);</span>

			// validate VIRN nbr
<span class="nc" id="L1111">			PwtBean pwtBean = verifyPwtVirn(gameId, virnNbr, Integer</span>
					.parseInt(gameNbr), connection, userInfoBean,
					highPrizeCriteria, highPrizeAmt, tktBean,false);
<span class="nc bnc" id="L1114" title="All 4 branches missed.">			if (pwtBean != null &amp;&amp; pwtBean.getIsValid()) {</span>
<span class="nc bnc" id="L1115" title="All 4 branches missed.">				if (pwtBean.getAppReq() || pwtBean.getIsHighLevel()) {</span>
<span class="nc" id="L1116">					detailMap.put(&quot;tktBean&quot;, tktBean);</span>
<span class="nc" id="L1117">					detailMap.put(&quot;pwtBean&quot;, pwtBean);</span>
<span class="nc" id="L1118">					detailMap.put(&quot;returnType&quot;, &quot;registration&quot;);</span>
<span class="nc" id="L1119">					System.out.println(&quot;go to registration limit&quot;);</span>
				} else { // changed ticket status
<span class="nc" id="L1121">					System.out.println(&quot;change ticket status&quot;);</span>
<span class="nc" id="L1122">					detailMap.put(&quot;tktBean&quot;, tktBean);</span>
<span class="nc" id="L1123">					detailMap.put(&quot;pwtBean&quot;, pwtBean);</span>
<span class="nc" id="L1124">					detailMap.put(&quot;returnType&quot;, &quot;success&quot;);</span>
				}

<span class="nc" id="L1127">				connection.commit();</span>
<span class="nc" id="L1128">				return detailMap;</span>

			} else {
<span class="nc" id="L1131">				detailMap.put(&quot;tktBean&quot;, tktBean);</span>
<span class="nc" id="L1132">				detailMap.put(&quot;pwtBean&quot;, pwtBean);</span>
<span class="nc" id="L1133">				detailMap.put(&quot;returnType&quot;, &quot;input&quot;);</span>
<span class="nc" id="L1134">				return detailMap;</span>
			}

<span class="nc" id="L1137">		} catch (SQLException e) {</span>
<span class="nc" id="L1138">			e.printStackTrace();</span>
<span class="nc" id="L1139">			throw new LMSException(e);</span>
<span class="nc" id="L1140">		} catch (Exception e) {</span>
<span class="nc" id="L1141">			e.printStackTrace();</span>
<span class="nc" id="L1142">			throw new LMSException(e);</span>
		} finally {
<span class="nc" id="L1144">			try {</span>
<span class="nc" id="L1145">				connection.close();</span>
<span class="nc" id="L1146">			} catch (SQLException e) {</span>
<span class="nc" id="L1147">				e.printStackTrace();</span>
<span class="nc" id="L1148">				throw new LMSException(e);</span>
<span class="nc" id="L1149">			}</span>
		}

	}

	private PwtBean verifyPwtVirn(int gameId, String virnCode, int gameNbr,
			Connection connection, UserInfoBean userInfoBean,
			String highPrizeCriteria, String highPrizeAmt, TicketBean tktBean,boolean ifOnlyVerification)
			throws LMSException {

<span class="nc" id="L1159">		PwtBean pwtBean = new PwtBean();</span>
<span class="nc" id="L1160">		pwtBean.setVirnCode(virnCode);</span>
<span class="nc" id="L1161">		pwtBean.setMessageCode(&quot;212013&quot;);</span>
<span class="nc" id="L1162">		pwtBean.setMessage(&quot;Invalid VIRN or Can Not Verify&quot;);</span>
<span class="nc" id="L1163">		pwtBean.setVerificationStatus(&quot;InValid Virn&quot;);</span>

<span class="nc" id="L1165">		String encodedVirnCode = MD5Encoder.encode(virnCode);</span>
<span class="nc" id="L1166">		pwtBean.setEncVirnCode(encodedVirnCode);</span>
<span class="nc" id="L1167">		System.out.println(&quot;Encoded virn == &quot; + encodedVirnCode);</span>

<span class="nc" id="L1169">		String encodedTktNo = MD5Encoder.encode(tktBean.getTicketNumber());</span>
<span class="nc" id="L1170">		pwtBean.setEnctktNumber(encodedTktNo);</span>
<span class="nc" id="L1171">		System.out.println(&quot;Encoded Ticket Number == &quot; + encodedTktNo);</span>
		try {
<span class="nc" id="L1173">			Statement statement = connection.createStatement();</span>
<span class="nc" id="L1174">			StringBuffer query = new StringBuffer();</span>
<span class="nc" id="L1175">			query.append(QueryManager.getST1PWTBOCheckQuery()).append(&quot; st_se_pwt_inv_&quot; + gameNbr + &quot; where &quot;);</span>
<span class="nc" id="L1176">			query.append(&quot; game_id = &quot; + gameId).append(&quot; and virn_code='&quot;);</span>
<span class="nc" id="L1177">			query.append(encodedVirnCode).append(&quot;'&quot;).append(&quot; and id1='&quot;);</span>
<span class="nc bnc" id="L1178" title="All 2 branches missed.">			if(&quot;YES&quot;.equals(Utility.getPropertyValue(&quot;IS_SCRATCH_NEW_FLOW_ENABLED&quot;))){</span>
<span class="nc" id="L1179">				query.append(encodedTktNo).append(&quot;'&quot;).append(&quot; and ticket_status in ('SOLD')&quot;);</span>
			} else{
<span class="nc" id="L1181">				query.append(encodedTktNo).append(&quot;'&quot;).append(&quot; and ticket_status in ('SOLD', 'ACTIVE')&quot;);</span>
			}
			
<span class="nc" id="L1184">			System.out.println(&quot;GameId:&quot; + gameId + &quot;\nQuery:: &quot; + query);</span>

<span class="nc" id="L1186">			ResultSet resultSet = statement.executeQuery(query.toString());</span>
<span class="nc" id="L1187">			System.out.println(&quot;ResultSet:&quot; + resultSet + &quot;---&quot;	+ resultSet.getFetchSize());</span>

<span class="nc bnc" id="L1189" title="All 2 branches missed.">			if (resultSet.next()) {</span>
<span class="nc" id="L1190">				String vCode = resultSet.getString(TableConstants.SPI_VIRN_CODE);</span>
<span class="nc" id="L1191">				String pwtAmount = resultSet.getString(TableConstants.SPI_PWT_AMT);</span>
<span class="nc" id="L1192">				String prizeLevel = resultSet.getString(TableConstants.SPI_PRIZE_LEVEL);</span>
<span class="nc" id="L1193">				String prizeStatus = resultSet.getString(&quot;status&quot;);</span>
<span class="nc" id="L1194">				System.out.println(&quot;Vcode : &quot; + vCode + &quot;\nPWT Amt : &quot;+ pwtAmount + &quot;\nPrize level : &quot; + prizeLevel	+ &quot;\nstatus : &quot; + prizeStatus);</span>
				
<span class="nc bnc" id="L1196" title="All 2 branches missed.">				if (MD5Encoder.encode(pwtBean.getVirnCode()).equals(vCode)) {</span>
<span class="nc" id="L1197">					System.out.println(&quot;Inside Valid VIRN Code&quot;);</span>
<span class="nc bnc" id="L1198" title="All 4 branches missed.">					if (prizeStatus.equalsIgnoreCase(&quot;UNCLM_PWT&quot;)|| prizeStatus.equalsIgnoreCase(&quot;UNCLM_CANCELLED&quot;)) {</span>
						// get the retailer PWT Limits
						// added by yogesh because this function is written in
						// common functions of pwt
<span class="nc" id="L1202">						CommonFunctionsHelper commonFunction = new CommonFunctionsHelper();</span>
<span class="nc" id="L1203">						OrgPwtLimitBean orgPwtLimit = commonFunction.fetchPwtLimitsOfOrgnization(userInfoBean.getUserOrgId(), connection);</span>
<span class="nc bnc" id="L1204" title="All 2 branches missed.">						if (orgPwtLimit == null) { // send mail to backoffice</span>
<span class="nc" id="L1205">							throw new LMSException(&quot;PWT Limits Are Not defined Properly!!&quot;);</span>
						} else { // test PWT amount with limit process
<span class="nc" id="L1207">							pwtBean.setPwtAmount(pwtAmount);</span>
<span class="nc" id="L1208">							double pwtAmt = Double.parseDouble(pwtBean.getPwtAmount());</span>
<span class="nc bnc" id="L1209" title="All 2 branches missed.">							if (pwtAmt &lt;= orgPwtLimit.getVerificationLimit()) { // test</span>
								// retailer
								// verification
								// limit
<span class="nc" id="L1213">								System.out.println(&quot;inside verification limit == &quot;);</span>
<span class="nc bnc" id="L1214" title="All 8 branches missed.">								boolean isHighPrizeFlag = highPrizeCriteria.equals(&quot;level&quot;)</span>
										&amp;&amp; prizeLevel.equals(&quot;HIGH&quot;)
										|| highPrizeCriteria.equals(&quot;amt&quot;)
										&amp;&amp; pwtAmt &gt; Double.parseDouble(highPrizeAmt);
								// check for HIGH Prize Or is Approval Required
<span class="nc bnc" id="L1219" title="All 4 branches missed.">								if (pwtAmt &gt; orgPwtLimit.getApprovalLimit()	|| isHighPrizeFlag) {</span>
<span class="nc" id="L1220">									System.out.println(&quot;inside high prize==&quot;);</span>
<span class="nc" id="L1221">									pwtBean.setValid(false);</span>
<span class="nc" id="L1222">									pwtBean.setVerificationStatus(&quot;Valid Virn&quot;);</span>
<span class="nc" id="L1223">									pwtBean.setMessage(&quot;High Prize Ticket, Can Not Be Claimed&quot;);</span>
<span class="nc" id="L1224">									pwtBean.setMessageCode(&quot;Undefined&quot;);</span>
<span class="nc" id="L1225">									pwtBean.setHighLevel(isHighPrizeFlag);</span>
<span class="nc bnc" id="L1226" title="All 2 branches missed.">									pwtBean.setAppReq(pwtAmt &gt; orgPwtLimit.getApprovalLimit());</span>
<span class="nc" id="L1227">									return pwtBean;</span>
<span class="nc bnc" id="L1228" title="All 2 branches missed.">								} else if (pwtAmt &lt;= orgPwtLimit.getPayLimit()) {// if</span>
									// PWT
									// amount
									// is
									// in
									// retailer
									// payment
									// limit
<span class="nc" id="L1236">									System.out.println(&quot;normal payment to player&quot;);</span>
<span class="nc" id="L1237">									pwtBean.setValid(true);</span>
<span class="nc" id="L1238">									pwtBean.setVerificationStatus(&quot;Valid Virn&quot;);</span>
<span class="nc" id="L1239">									pwtBean.setMessage(&quot;Credited To Concerned Party&quot;);</span>
<span class="nc bnc" id="L1240" title="All 2 branches missed.">									if (!ifOnlyVerification) {</span>
<span class="nc" id="L1241">										String recId = retEndPWTPaymentProcess(</span>
												userInfoBean, pwtBean, tktBean,
												orgPwtLimit, false, null,
												connection,encodedTktNo);
									}
									// insert into receipt create

<span class="nc" id="L1248">									return pwtBean;</span>
								} else {
<span class="nc" id="L1250">									System.out.println(&quot;Out of Range of Retailer Pay Limit.&quot;);</span>
<span class="nc" id="L1251">									pwtBean.setValid(false);</span>
<span class="nc" id="L1252">									pwtBean.setVerificationStatus(&quot;InValid Virn&quot;);</span>
<span class="nc" id="L1253">									pwtBean.setMessage(&quot;Out of Range of Retailer Pay Limit.&quot;);</span>
<span class="nc" id="L1254">									pwtBean.setMessageCode(&quot;Undefined&quot;);</span>
								}

<span class="nc" id="L1257">							} else { // Out of Range of Retailer Verification</span>
								// Limit.
<span class="nc" id="L1259">								System.out.println(&quot;Out of Range of Retailer Verification Limit.&quot;);</span>
<span class="nc" id="L1260">								pwtBean.setValid(false);</span>
<span class="nc" id="L1261">								pwtBean.setVerificationStatus(&quot;InValid Virn&quot;);</span>
<span class="nc" id="L1262">								pwtBean.setMessage(&quot;Out of Range of Retailer Verification Limit.&quot;);</span>
<span class="nc" id="L1263">								pwtBean.setMessageCode(&quot;Undefined&quot;);</span>
<span class="nc" id="L1264">								return pwtBean;</span>
							}

						}

<span class="nc" id="L1269">					}</span>

					// ------------------------------------------

<span class="nc bnc" id="L1273" title="All 2 branches missed.">					else if (prizeStatus.equalsIgnoreCase(&quot;NO_PRIZE_PWT&quot;)) {</span>
<span class="nc" id="L1274">						pwtBean.setValid(false);</span>
<span class="nc" id="L1275">						pwtBean.setVerificationStatus(&quot;Valid Virn&quot;);</span>
<span class="nc" id="L1276">						pwtBean.setMessage(&quot;No Prize&quot;);</span>
<span class="nc" id="L1277">						pwtBean.setMessageCode(&quot;&quot;);</span>

<span class="nc bnc" id="L1279" title="All 2 branches missed.">					} else if (prizeStatus.equalsIgnoreCase(&quot;MISSING&quot;)) {</span>
<span class="nc" id="L1280">						pwtBean.setValid(false);</span>
<span class="nc" id="L1281">						pwtBean.setVerificationStatus(&quot;InValid Virn&quot;);</span>
<span class="nc" id="L1282">						pwtBean.setMessage(&quot;VIRN is from MISSING Status&quot;);</span>
<span class="nc" id="L1283">						pwtBean.setMessageCode(&quot;&quot;);</span>

<span class="nc bnc" id="L1285" title="All 2 branches missed.">					} else if (prizeStatus.equalsIgnoreCase(&quot;CLAIM_PLR_RET_UNCLM&quot;)) {</span>
<span class="nc" id="L1286">						pwtBean.setValid(false);</span>
<span class="nc" id="L1287">						pwtBean.setVerificationStatus(&quot;InValid Virn&quot;);</span>
<span class="nc" id="L1288">						pwtBean.setMessage(&quot;Paid to Player By Retailer&quot;);</span>
<span class="nc" id="L1289">						pwtBean.setMessageCode(&quot;Unknown&quot;);</span>

<span class="nc bnc" id="L1291" title="All 2 branches missed.">					} else if (prizeStatus.equalsIgnoreCase(&quot;CLAIM_PLR_RET_CLM&quot;)) {</span>
<span class="nc" id="L1292">						pwtBean.setValid(false);</span>
<span class="nc" id="L1293">						pwtBean.setVerificationStatus(&quot;InValid Virn&quot;);</span>
<span class="nc" id="L1294">						pwtBean.setMessage(&quot;In Retailer Claimable Balance&quot;);</span>
<span class="nc" id="L1295">						pwtBean.setMessageCode(&quot;212001&quot;);</span>

<span class="nc bnc" id="L1297" title="All 2 branches missed.">					} else if (prizeStatus.equalsIgnoreCase(&quot;CLAIM_PLR&quot;)) {</span>
<span class="nc" id="L1298">						pwtBean.setValid(false);</span>
<span class="nc" id="L1299">						pwtBean.setVerificationStatus(&quot;InValid Virn&quot;);</span>
<span class="nc" id="L1300">						pwtBean.setMessage(&quot;Already paid as Direct Player PWT &quot;);</span>
<span class="nc" id="L1301">						pwtBean.setMessageCode(&quot;212001&quot;);</span>

<span class="nc bnc" id="L1303" title="All 2 branches missed.">					} else if (prizeStatus.equalsIgnoreCase(&quot;CLAIM_RET_TEMP&quot;)) {</span>
<span class="nc" id="L1304">						pwtBean.setValid(false);</span>
<span class="nc" id="L1305">						pwtBean.setVerificationStatus(&quot;InValid Virn&quot;);</span>
<span class="nc" id="L1306">						pwtBean.setMessage(&quot;Already Verified in Bulk Receipt at Agent, Fianl Payment Pending&quot;);</span>
<span class="nc" id="L1307">						pwtBean.setMessageCode(&quot;212002&quot;);</span>

<span class="nc bnc" id="L1309" title="All 2 branches missed.">					} else if (prizeStatus.equalsIgnoreCase(&quot;CLAIM_PLR_RET_TEMP&quot;)) {</span>
<span class="nc" id="L1310">						pwtBean.setValid(false);</span>
<span class="nc" id="L1311">						pwtBean.setVerificationStatus(&quot;InValid Virn&quot;);</span>
<span class="nc" id="L1312">						pwtBean.setMessage(&quot;Already Verified in Bulk Receipt at Agent, Fianl Payment Pending&quot;);</span>
<span class="nc" id="L1313">						pwtBean.setMessageCode(&quot;212003&quot;);</span>

<span class="nc bnc" id="L1315" title="All 2 branches missed.">					} else if (prizeStatus.equalsIgnoreCase(&quot;CLAIM_AGT_TEMP&quot;)) {</span>

<span class="nc" id="L1317">						pwtBean.setValid(false);</span>
<span class="nc" id="L1318">						pwtBean.setVerificationStatus(&quot;InValid Virn&quot;);</span>
<span class="nc" id="L1319">						pwtBean.setMessage(&quot;Already Verified in Bulk Receipt at BO, Fianl Payment Pending&quot;);</span>
<span class="nc" id="L1320">						pwtBean.setMessageCode(&quot;212004&quot;);</span>
<span class="nc bnc" id="L1321" title="All 2 branches missed.">					} else if (prizeStatus.equalsIgnoreCase(&quot;CLAIM_RET_AGT_TEMP&quot;)) {</span>
<span class="nc" id="L1322">						pwtBean.setValid(false);</span>
<span class="nc" id="L1323">						pwtBean.setVerificationStatus(&quot;InValid Virn&quot;);</span>
<span class="nc" id="L1324">						pwtBean.setMessage(&quot;Already Verified in Bulk Receipt at BO, Fianl Payment Pending&quot;);</span>
<span class="nc" id="L1325">						pwtBean.setMessageCode(&quot;212005&quot;);</span>

<span class="nc bnc" id="L1327" title="All 2 branches missed.">					} else if (prizeStatus.equalsIgnoreCase(&quot;CLAIM_AGT&quot;)) {</span>
<span class="nc" id="L1328">						pwtBean.setValid(false);</span>
<span class="nc" id="L1329">						pwtBean.setVerificationStatus(&quot;InValid Virn&quot;);</span>
<span class="nc" id="L1330">						pwtBean.setMessage(&quot;Already Paid to an agent &quot;);</span>
<span class="nc" id="L1331">						pwtBean.setMessageCode(&quot;212006&quot;);</span>

<span class="nc bnc" id="L1333" title="All 2 branches missed.">					} else if (prizeStatus.equalsIgnoreCase(&quot;CLAIM_RET&quot;)) {</span>

<span class="nc" id="L1335">						pwtBean.setValid(false);</span>
<span class="nc" id="L1336">						pwtBean.setVerificationStatus(&quot;InValid Virn&quot;);</span>
<span class="nc" id="L1337">						pwtBean.setMessage(&quot;Already Paid to retailer&quot;);</span>
<span class="nc" id="L1338">						pwtBean.setMessageCode(&quot;212007&quot;);</span>

<span class="nc bnc" id="L1340" title="All 2 branches missed.">					} else if (prizeStatus.equalsIgnoreCase(&quot;CLAIM_PLR_TEMP&quot;)) {</span>

<span class="nc" id="L1342">						pwtBean.setValid(false);</span>
<span class="nc" id="L1343">						pwtBean.setVerificationStatus(&quot;InValid Virn&quot;);</span>
<span class="nc" id="L1344">						pwtBean.setMessage(&quot;Already in Process for Direct Player PWT&quot;);</span>
<span class="nc" id="L1345">						pwtBean.setMessageCode(&quot;212008&quot;);</span>

<span class="nc bnc" id="L1347" title="All 2 branches missed.">					} else if (prizeStatus.equalsIgnoreCase(&quot;CLAIM_PLR_RET&quot;)) {</span>
<span class="nc" id="L1348">						pwtBean.setValid(false);</span>
<span class="nc" id="L1349">						pwtBean.setVerificationStatus(&quot;InValid Virn&quot;);</span>
<span class="nc" id="L1350">						pwtBean.setMessage(&quot;Already Paid To Player By REtailer&quot;);</span>
<span class="nc" id="L1351">						pwtBean.setMessageCode(&quot;212008&quot;);</span>

<span class="nc bnc" id="L1353" title="All 2 branches missed.">					} else if (prizeStatus.equalsIgnoreCase(&quot;REQUESTED&quot;)) {</span>
						// show request details from request table with history
<span class="nc" id="L1355">						pwtBean.setValid(false);</span>
<span class="nc" id="L1356">						pwtBean.setVerificationStatus(&quot;InValid Virn&quot;);</span>
<span class="nc" id="L1357">						pwtBean.setMessage(&quot;This VIRN has Beean Already claimed and requested for Approval&quot;);</span>
<span class="nc" id="L1358">						pwtBean.setMessageCode(&quot;TBD&quot;);</span>

<span class="nc bnc" id="L1360" title="All 2 branches missed.">					} else if (prizeStatus.equalsIgnoreCase(&quot;PND_MAS&quot;)) {</span>
						// details of by and to and date and voucher
<span class="nc" id="L1362">						pwtBean.setValid(false);</span>
<span class="nc" id="L1363">						pwtBean.setVerificationStatus(&quot;InValid Virn&quot;);</span>
<span class="nc" id="L1364">						pwtBean.setMessage(&quot;This VIRN has Beean requested for BO Master Approval&quot;);</span>
<span class="nc" id="L1365">						pwtBean.setMessageCode(&quot;112009&quot;);</span>

<span class="nc bnc" id="L1367" title="All 2 branches missed.">					} else if (prizeStatus.equalsIgnoreCase(&quot;PND_PAY&quot;)) {</span>
						// show details for payment by and to
<span class="nc" id="L1369">						pwtBean.setValid(false);</span>
<span class="nc" id="L1370">						pwtBean.setVerificationStatus(&quot;InValid Virn&quot;);</span>
<span class="nc" id="L1371">						pwtBean.setMessage(&quot;This VIRN has Beean Approved And Pending to Payment&quot;);</span>
<span class="nc" id="L1372">						pwtBean.setMessageCode(&quot;112009&quot;);</span>

<span class="nc bnc" id="L1374" title="All 2 branches missed.">					} else if (prizeStatus.equalsIgnoreCase(&quot;CLAIM_AGT_AUTO&quot;)) {</span>
<span class="nc" id="L1375">						pwtBean.setValid(false);</span>
<span class="nc" id="L1376">						pwtBean.setVerificationStatus(&quot;InValid Virn&quot;);</span>
<span class="nc" id="L1377">						pwtBean.setMessage(&quot;Already Paid As Auto Scrap to Agent&quot;);</span>
<span class="nc" id="L1378">						pwtBean.setMessageCode(&quot;112003&quot;);</span>

<span class="nc bnc" id="L1380" title="All 2 branches missed.">					} else if (prizeStatus.equalsIgnoreCase(&quot;CLAIM_PLR_BO&quot;)) {</span>
<span class="nc" id="L1381">						pwtBean.setValid(false);</span>
<span class="nc" id="L1382">						pwtBean.setMessage(&quot;Already Paid By BO as Direct Player PWT to Player&quot;);</span>
<span class="nc" id="L1383">						pwtBean.setMessageCode(&quot;112005&quot;);</span>
<span class="nc" id="L1384">						pwtBean.setVerificationStatus(&quot;InValid Virn&quot;);</span>

<span class="nc bnc" id="L1386" title="All 2 branches missed.">					} else if (prizeStatus</span>
							.equalsIgnoreCase(&quot;CLAIM_PLR_AGT_UNCLM_DIR&quot;)) {
<span class="nc" id="L1388">						pwtBean.setValid(false);</span>
<span class="nc" id="L1389">						pwtBean.setVerificationStatus(&quot;InValid Virn&quot;);</span>
<span class="nc" id="L1390">						pwtBean.setMessage(&quot;Already Paid to Player By Agent&quot;);</span>
<span class="nc" id="L1391">						pwtBean.setMessageCode(&quot;TBD&quot;);</span>

<span class="nc bnc" id="L1393" title="All 2 branches missed.">					} else if (prizeStatus</span>
							.equalsIgnoreCase(&quot;CLAIM_PLR_AGT_CLM_DIR&quot;)) {
<span class="nc" id="L1395">						pwtBean.setValid(false);</span>
<span class="nc" id="L1396">						pwtBean.setVerificationStatus(&quot;InValid Virn&quot;);</span>
<span class="nc" id="L1397">						pwtBean.setMessage(&quot;Paid to Player By Agent In Claimable Balance&quot;);</span>
<span class="nc" id="L1398">						pwtBean.setMessageCode(&quot;TBD&quot;);</span>

<span class="nc bnc" id="L1400" title="All 2 branches missed.">					} else if (prizeStatus.equalsIgnoreCase(&quot;CLAIM_PLR_AGT_TEMP&quot;)) {</span>
<span class="nc" id="L1401">						pwtBean.setValid(false);</span>
<span class="nc" id="L1402">						pwtBean.setVerificationStatus(&quot;InValid Virn&quot;);</span>
<span class="nc" id="L1403">						pwtBean.setMessage(&quot;Already Verified in Bulk Receipt at BO, Fianl Payment Pending&quot;);</span>
<span class="nc" id="L1404">						pwtBean.setMessageCode(&quot;112002&quot;);</span>

<span class="nc bnc" id="L1406" title="All 2 branches missed.">					} else if (prizeStatus.equalsIgnoreCase(&quot;CLAIM_RET_CLM&quot;)) {</span>
<span class="nc" id="L1407">						pwtBean.setValid(false);</span>
<span class="nc" id="L1408">						pwtBean.setVerificationStatus(&quot;InValid Virn&quot;);</span>
<span class="nc" id="L1409">						pwtBean.setMessage(&quot;Paid to retailer By Agent and pending to claim at bo by agent as uato sarap&quot;);</span>
<span class="nc" id="L1410">						pwtBean.setMessageCode(&quot;TBD&quot;);</span>

<span class="nc bnc" id="L1412" title="All 2 branches missed.">					} else if (prizeStatus.equalsIgnoreCase(&quot;CLAIM_RET_CLM_AUTO&quot;)) {</span>
<span class="nc" id="L1413">						pwtBean.setValid(false);</span>
<span class="nc" id="L1414">						pwtBean.setVerificationStatus(&quot;InValid Virn&quot;);</span>
<span class="nc" id="L1415">						pwtBean.setMessage(&quot;Paid to retailer As Auto Scrap and pending to claim at bo as AUTO Scrap&quot;);</span>
<span class="nc" id="L1416">						pwtBean.setMessageCode(&quot;TBD&quot;);</span>

<span class="nc bnc" id="L1418" title="All 2 branches missed.">					} else if (prizeStatus.equalsIgnoreCase(&quot;CLAIM_RET_UNCLM&quot;)) {</span>
<span class="nc" id="L1419">						pwtBean.setValid(false);</span>
<span class="nc" id="L1420">						pwtBean.setVerificationStatus(&quot;InValid Virn&quot;);</span>
<span class="nc" id="L1421">						pwtBean.setMessage(&quot;VIRN Already Claimed To Retailer&quot;);</span>
<span class="nc" id="L1422">						pwtBean.setMessageCode(&quot;TBD&quot;);</span>

<span class="nc bnc" id="L1424" title="All 2 branches missed.">					} else if (prizeStatus.equalsIgnoreCase(&quot;CANCELLED_PERMANENT&quot;)) {</span>
<span class="nc" id="L1425">						pwtBean.setValid(false);</span>
<span class="nc" id="L1426">						pwtBean.setVerificationStatus(&quot;InValid Virn&quot;);</span>
<span class="nc" id="L1427">						pwtBean.setMessage(&quot;Tampered/Damaged/Defaced VIRN as noted at BO&quot;);</span>
<span class="nc" id="L1428">						pwtBean.setMessageCode(&quot;212010&quot;);</span>

					} else {
<span class="nc" id="L1431">						pwtBean.setValid(false);</span>
<span class="nc" id="L1432">						pwtBean.setVerificationStatus(&quot;InValid Virn&quot;);</span>
<span class="nc" id="L1433">						pwtBean.setMessage(&quot;UNDEFINED STATUS OF PWT:: &quot;	+ prizeStatus);</span>
<span class="nc" id="L1434">						pwtBean.setMessageCode(&quot;TBD&quot;);</span>
					}

					// ------------------------------------------

					/*
					 * else if(prizeStatus.equalsIgnoreCase(&quot;CLAIM_PLR&quot;)){
					 * pwtBean.setValid(false);
					 * pwtBean.setVerificationStatus(&quot;InValid Virn&quot;);
					 * pwtBean.setMessage(&quot;Already paid as Direct Player PWT &quot;);
					 * pwtBean.setMessageCode(&quot;212001&quot;); }else
					 * if(prizeStatus.equalsIgnoreCase(&quot;CLAIM_RET_TEMP&quot;)) {
					 * pwtBean.setValid(false);
					 * pwtBean.setVerificationStatus(&quot;InValid Virn&quot;);
					 * pwtBean.setMessage(&quot;Already Verified in Bulk Receipt at
					 * Agent, Fianl Payment Pending&quot;);
					 * pwtBean.setMessageCode(&quot;212002&quot;); }else
					 * if(prizeStatus.equalsIgnoreCase(&quot;CLAIM_PLR_RET_TEMP&quot;)) {
					 * pwtBean.setValid(false);
					 * pwtBean.setVerificationStatus(&quot;InValid Virn&quot;);
					 * pwtBean.setMessage(&quot;Already Verified in Bulk Receipt at
					 * Agent, Fianl Payment Pending&quot;);
					 * pwtBean.setMessageCode(&quot;212003&quot;); } else
					 * if(prizeStatus.equalsIgnoreCase(&quot;CLAIM_AGT_TEMP&quot;)){
					 * pwtBean.setValid(false);
					 * pwtBean.setVerificationStatus(&quot;InValid Virn&quot;);
					 * pwtBean.setMessage(&quot;Already Verified in Bulk Receipt at
					 * BO, Fianl Payment Pending&quot;);
					 * pwtBean.setMessageCode(&quot;212004&quot;); }else
					 * if(prizeStatus.equalsIgnoreCase(&quot;CLAIM_RET_AGT_TEMP&quot;)){
					 * pwtBean.setValid(false);
					 * pwtBean.setVerificationStatus(&quot;InValid Virn&quot;);
					 * pwtBean.setMessage(&quot;Already Verified in Bulk Receipt at
					 * BO, Fianl Payment Pending&quot;);
					 * pwtBean.setMessageCode(&quot;212005&quot;); }else
					 * if(prizeStatus.equalsIgnoreCase(&quot;CLAIM_AGT&quot;)){
					 * pwtBean.setValid(false);
					 * pwtBean.setVerificationStatus(&quot;InValid Virn&quot;);
					 * pwtBean.setMessage(&quot;Already Paid to an agent &quot;);
					 * pwtBean.setMessageCode(&quot;212006&quot;); }else
					 * if(prizeStatus.equalsIgnoreCase(&quot;CLAIM_RET&quot;)){
					 * pwtBean.setValid(false);
					 * pwtBean.setVerificationStatus(&quot;InValid Virn&quot;);
					 * pwtBean.setMessage(&quot;Already Paid to retailer&quot;);
					 * pwtBean.setMessageCode(&quot;212007&quot;); }else
					 * if(prizeStatus.equalsIgnoreCase(&quot;CLAIM_PLR_TEMP&quot;)){	`
					 * pwtBean.setValid(false);
					 * pwtBean.setVerificationStatus(&quot;InValid Virn&quot;);
					 * pwtBean.setMessage(&quot;Already in Process for Direct Player
					 * PWT&quot;); pwtBean.setMessageCode(&quot;212008&quot;); }else
					 * if(prizeStatus.equalsIgnoreCase(&quot;CANCELLED_PERMANENT&quot;)){
					 * pwtBean.setValid(false);
					 * pwtBean.setVerificationStatus(&quot;InValid Virn&quot;);
					 * pwtBean.setMessage(&quot;Tampered/Damaged/Defaced VIRN as
					 * noted at BO&quot;); pwtBean.setMessageCode(&quot;212010&quot;); }
					 */

				}

			}

<span class="nc" id="L1495">		} catch (SQLException e) {</span>
<span class="nc" id="L1496">			e.printStackTrace();</span>
<span class="nc" id="L1497">			throw new LMSException(e);</span>
<span class="nc" id="L1498">		}</span>

<span class="nc" id="L1500">		return pwtBean;</span>

	}
	public  int  getUserIdFromTicketNumber(String ticketNumber,Connection connection) throws LMSException{
<span class="nc" id="L1504">		int retUserId = 0;</span>
		try {
<span class="nc" id="L1506">			String query2 = &quot;select * from (select  ret_user_id, REPLACE(ticket_nbr, '-', '') as ticket_nbr  from st_se_ticket_by_ticket_sale_txn)aa  where ticket_nbr = ?;&quot;;</span>
<span class="nc" id="L1507">			pstmt = connection.prepareStatement(query2);</span>
<span class="nc" id="L1508">			pstmt.setString(1, ticketNumber.replace(&quot;-&quot;, &quot;&quot;));</span>
<span class="nc" id="L1509">			result=pstmt.executeQuery();</span>
<span class="nc bnc" id="L1510" title="All 2 branches missed.">			if(result.next()) {</span>
<span class="nc" id="L1511">				retUserId = result.getInt(&quot;ret_user_id&quot;);</span>
			}
			else{
<span class="nc" id="L1514">				throw new LMSException(LMSErrors.GENERAL_EXCEPTION_ERROR_CODE,LMSErrors.GAME_NOT_AVAILABLE_ERROR_MESSAGE);</span>
			}
		
<span class="nc" id="L1517">	    	}catch (Exception e) {</span>
<span class="nc" id="L1518">	    		e.printStackTrace();</span>
<span class="nc" id="L1519">	    		throw new LMSException(LMSErrors.GENERAL_EXCEPTION_ERROR_CODE,LMSErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
	    	} finally {
<span class="nc" id="L1521">	    		DBConnect.closeResource(pstmt,result);</span>
<span class="nc" id="L1522">	    	}</span>
<span class="nc" id="L1523">		return retUserId;</span>
	}
	public  boolean canClaimRetailer(String ticketNumber, int retOrgId, int parentOrgId) {
<span class="nc" id="L1526">		boolean canClaim = false;</span>
		try {
<span class="nc" id="L1528">			connection = DBConnect.getConnection();</span>
<span class="nc" id="L1529">			int userId = new RetailerPwtProcessHelper().getUserIdFromTicketNumber(ticketNumber, connection);</span>
<span class="nc" id="L1530">			canClaim = Util.canClaimRetailer(userId, retOrgId, parentOrgId, connection);</span>
<span class="nc" id="L1531">		} catch (Exception e) {</span>
<span class="nc" id="L1532">			e.printStackTrace();</span>
<span class="nc" id="L1533">		}</span>

<span class="nc" id="L1535">		return canClaim;</span>
	}
	public  boolean canClaimAgent(String ticketNumber, int agtOrgId) {
<span class="nc" id="L1538">		boolean canClaim = false;</span>
		try {
<span class="nc" id="L1540">			connection = DBConnect.getConnection();</span>
<span class="nc" id="L1541">			int userId = new RetailerPwtProcessHelper().getUserIdFromTicketNumber(ticketNumber, connection);</span>
<span class="nc" id="L1542">			canClaim = Util.canClaimAgent(userId, agtOrgId, connection);</span>
<span class="nc" id="L1543">		} catch (Exception e) {</span>
<span class="nc" id="L1544">			e.printStackTrace();</span>
<span class="nc" id="L1545">		}</span>

<span class="nc" id="L1547">		return canClaim;</span>
	}
	public  boolean canClaimBO(String ticketNumber, int roleId) {
<span class="nc" id="L1550">		boolean canClaim = false;</span>
		try {
<span class="nc" id="L1552">			connection = DBConnect.getConnection();</span>
<span class="nc" id="L1553">			RetailerPwtProcessHelper helper = new RetailerPwtProcessHelper();</span>
<span class="nc" id="L1554">			int userId = helper.getUserIdFromTicketNumber(ticketNumber, connection);</span>
<span class="nc" id="L1555">			canClaim = helper.canClaimBO(userId, roleId, connection);</span>
<span class="nc" id="L1556">		} catch (Exception e) {</span>
<span class="nc" id="L1557">			e.printStackTrace();</span>
		}finally{
<span class="nc" id="L1559">			DBConnect.closeResource(connection);</span>
<span class="nc" id="L1560">		}</span>

<span class="nc" id="L1562">		return canClaim;</span>
	}
	public static boolean canClaimBO(int userId,int roleId, Connection connection) {
<span class="nc" id="L1565">		int claimAtBo = 0;</span>
<span class="nc" id="L1566">		Statement stmt = null;</span>
<span class="nc" id="L1567">		ResultSet rs = null;</span>
<span class="nc" id="L1568">		boolean canClaim = false;</span>
		try {
<span class="nc" id="L1570">			stmt = connection.createStatement();</span>
<span class="nc" id="L1571">			String query = &quot;select role_id from st_lms_role_agent_mapping where agent_id = (select b.parent_id  from st_lms_user_master a inner join st_lms_organization_master b on a.organization_id = b.organization_id where a.user_id = &quot;+userId+&quot;)order by role_id desc limit 1;&quot;;</span>
<span class="nc" id="L1572">			rs = stmt.executeQuery(query);</span>
<span class="nc bnc" id="L1573" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L1574">				claimAtBo = rs.getInt(&quot;role_id&quot;);</span>
			}
			
<span class="nc" id="L1577">			System.out.println(claimAtBo);</span>
<span class="nc bnc" id="L1578" title="All 4 branches missed.">			canClaim = (claimAtBo == 1 || claimAtBo == roleId) ? true : false;</span>
<span class="nc" id="L1579">		} catch (SQLException se) {</span>
<span class="nc" id="L1580">			se.printStackTrace();</span>
<span class="nc" id="L1581">		} catch (Exception e) {</span>
<span class="nc" id="L1582">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L1584">			DBConnect.closeStmt(stmt);</span>
<span class="nc" id="L1585">			DBConnect.closeRs(rs);</span>
<span class="nc" id="L1586">		}</span>

<span class="nc" id="L1588">		return canClaim;</span>
	}
	
	public  Map validateRequest(String gameId) {
<span class="nc" id="L1592">		Map&lt;String, Object&gt; detailMap = new TreeMap&lt;String, Object&gt;();</span>
<span class="nc" id="L1593">		TicketBean bean = new TicketBean();</span>
<span class="nc" id="L1594">		bean.setValid(false);</span>
<span class="nc" id="L1595">		bean.setStatus(&quot;UNAUTHORIZED USER&quot;);</span>
<span class="nc" id="L1596">		bean.setMessageCode(&quot;221001&quot;);</span>
<span class="nc" id="L1597">		bean.setValidity(&quot;InValid Ticket&quot;);</span>
<span class="nc" id="L1598">		bean.setTicketNumber(gameId);</span>
<span class="nc" id="L1599">		detailMap.put(&quot;returnType&quot;, &quot;input&quot;);</span>
<span class="nc" id="L1600">		bean.setTicketNumber(gameId);</span>
<span class="nc" id="L1601">		detailMap.put(&quot;tktBean&quot;, bean);</span>
<span class="nc" id="L1602">		return detailMap;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>