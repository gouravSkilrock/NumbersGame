<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DrawSaleReportHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lms</a> &gt; <a href="index.source.html" class="el_package">com.skilrock.lms.coreEngine.drawGames.reportMgmt</a> &gt; <span class="el_source">DrawSaleReportHelper.java</span></div><h1>DrawSaleReportHelper.java</h1><pre class="source lang-java linenums">package com.skilrock.lms.coreEngine.drawGames.reportMgmt;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Timestamp;
import java.util.ArrayList;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.TreeMap;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import com.skilrock.lms.beans.ReportStatusBean;
import com.skilrock.lms.beans.SalePwtReportsBean;
import com.skilrock.lms.common.Utility;
import com.skilrock.lms.common.db.DBConnect;
import com.skilrock.lms.common.db.DBConnectReplica;
import com.skilrock.lms.common.db.QueryManager;
import com.skilrock.lms.common.exception.LMSErrors;
import com.skilrock.lms.common.exception.LMSException;
import com.skilrock.lms.coreEngine.drawGames.common.CommonFunctionsHelper;
import com.skilrock.lms.dge.beans.AnalysisBean;
import com.skilrock.lms.web.drawGames.reportsMgmt.beans.RegionWiseDataBean;


<span class="nc" id="L30">public class DrawSaleReportHelper implements IDrawSaleReportHelper {</span>
<span class="nc" id="L31">	private static Log logger = LogFactory.getLog(DrawSaleReportHelper.class);</span>

	public List&lt;SalePwtReportsBean&gt; drawSaleAgentWise(Timestamp startDate,
			Timestamp endDate, ReportStatusBean reportStatusBean, String cityCode, String stateCode) throws SQLException {
<span class="nc" id="L35">		Connection con = null;</span>
<span class="nc" id="L36">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L37">		ResultSet rs = null;</span>
<span class="nc" id="L38">		SalePwtReportsBean reportsBean = null;</span>
<span class="nc" id="L39">		List&lt;SalePwtReportsBean&gt; beanList = new ArrayList&lt;SalePwtReportsBean&gt;();</span>
		try {
<span class="nc bnc" id="L41" title="All 4 branches missed.">			if(&quot;NO&quot;.equals(Utility.getPropertyValue(&quot;IS_DATA_FROM_REPLICA&quot;)) || &quot;MAIN_DB&quot;.equals(reportStatusBean.getReportingFrom()))</span>
<span class="nc" id="L42">				con = DBConnect.getConnection();</span>
			else
<span class="nc" id="L44">				con = DBConnectReplica.getConnection();</span>

<span class="nc" id="L46">			String indGameQry = &quot;(select sale.retailer_org_id,(ifnull(mrpAmt,0.0)-ifnull(mrpAmtRet,0.0))mrpAmt,(ifnull(netAmt,0.0)-ifnull(netAmtRet,0.0))netAmt from (select retailer_org_id,sum(mrp_amt) mrpAmt,sum(agent_net_amt) netAmt from st_dg_ret_sale_* where transaction_id in(select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_SALE','DG_SALE_OFFLINE') and transaction_date&gt;='&quot;</span>
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' )group by retailer_org_id) sale left outer join (select retailer_org_id,sum(mrp_amt) mrpAmtRet,sum(agent_net_amt) netAmtRet from st_dg_ret_sale_refund_* where transaction_id in(select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_REFUND_CANCEL','DG_REFUND_FAILED') and transaction_date&gt;='&quot;
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' )group by retailer_org_id) saleRet on sale.retailer_org_id=saleRet.retailer_org_id) union all &quot;;
<span class="nc" id="L55">			StringBuilder saleQry = new StringBuilder(</span>
					&quot;select om.organization_id,&quot;+QueryManager.getOrgCodeQuery()+&quot;,ifnull(mrpAmt,0.0) mrpAmt,ifnull(netAmt,0.0) netAmt from st_lms_organization_master om right outer join (select parent_id,sum(mrpAmt) mrpAmt,sum(netAmt) netAmt from st_lms_organization_master,(select retailer_org_id,sum(mrpAmt) mrpAmt,sum(netAmt) netAmt from (&quot;);
<span class="nc" id="L57">			String gameQry = &quot;select game_id from st_dg_game_master&quot;;</span>
<span class="nc" id="L58">			PreparedStatement pstmtGame = con.prepareStatement(gameQry);</span>
<span class="nc" id="L59">			ResultSet rsGame = pstmtGame.executeQuery();</span>

<span class="nc bnc" id="L61" title="All 2 branches missed.">			while (rsGame.next()) {</span>
<span class="nc" id="L62">				saleQry.append(indGameQry.replaceAll(&quot;\\*&quot;, rsGame</span>
						.getString(&quot;game_id&quot;)));
			}
<span class="nc" id="L65">			saleQry.delete(saleQry.length() - 10, saleQry.length());</span>
<span class="nc" id="L66">			saleQry</span>
					.append(&quot;) saleTlb group by retailer_org_id) saleTlb where retailer_org_id=organization_id group by parent_id) saleTlb on saleTlb.parent_id=om.organization_id&quot;);

<span class="nc" id="L69">			pstmt = con.prepareStatement(saleQry.toString());</span>

<span class="nc" id="L71">			logger.info(&quot;----Agent Qry---&quot; + pstmt);</span>
<span class="nc" id="L72">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L74">				reportsBean = new SalePwtReportsBean();</span>
<span class="nc" id="L75">				reportsBean.setGameName(rs.getString(&quot;orgCode&quot;));</span>
<span class="nc" id="L76">				reportsBean.setGameNo(rs.getInt(&quot;organization_id&quot;));</span>
<span class="nc" id="L77">				reportsBean.setSaleMrpAmt(rs.getDouble(&quot;mrpAmt&quot;));</span>
<span class="nc" id="L78">				reportsBean.setSaleNetAmt(rs.getDouble(&quot;netAmt&quot;));</span>
<span class="nc" id="L79">				beanList.add(reportsBean);</span>
			}
<span class="nc" id="L81">			CommonFunctionsHelper.sortListForOrgOrder(beanList);	</span>
<span class="nc" id="L82">		} catch (Exception e) {</span>
<span class="nc" id="L83">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L85">			con.close();</span>
<span class="nc" id="L86">		}</span>
<span class="nc" id="L87">		return beanList;</span>
	}

	public List&lt;SalePwtReportsBean&gt; drawSaleRetailerWise(Timestamp startDate,
			Timestamp endDate, int agtOrgId, ReportStatusBean reportStatusBean, String cityCode, String stateCode) throws SQLException {
<span class="nc" id="L92">		Connection con = null;</span>
<span class="nc" id="L93">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L94">		ResultSet rs = null;</span>
<span class="nc" id="L95">		SalePwtReportsBean reportsBean = null;</span>
<span class="nc" id="L96">		List&lt;SalePwtReportsBean&gt; beanList = new ArrayList&lt;SalePwtReportsBean&gt;();</span>
		try {
<span class="nc bnc" id="L98" title="All 4 branches missed.">			if(&quot;NO&quot;.equals(Utility.getPropertyValue(&quot;IS_DATA_FROM_REPLICA&quot;)) || &quot;MAIN_DB&quot;.equals(reportStatusBean.getReportingFrom()))</span>
<span class="nc" id="L99">				con = DBConnect.getConnection();</span>
			else
<span class="nc" id="L101">				con = DBConnectReplica.getConnection();</span>

<span class="nc" id="L103">			String indGameQry = &quot;(select sale.retailer_org_id,(ifnull(mrpAmt,0.0)-ifnull(mrpAmtRet,0.0))mrpAmt,(ifnull(netAmt,0.0)-ifnull(netAmtRet,0.0))netAmt from (select retailer_org_id,sum(mrp_amt) mrpAmt,sum(net_amt) netAmt from st_dg_ret_sale_* where transaction_id in(select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_SALE','DG_SALE_OFFLINE') and transaction_date&gt;='&quot;</span>
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' )group by retailer_org_id) sale left outer join (select retailer_org_id,sum(mrp_amt) mrpAmtRet,sum(net_amt) netAmtRet from st_dg_ret_sale_refund_* where transaction_id in(select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_REFUND_CANCEL','DG_REFUND_FAILED') and transaction_date&gt;='&quot;
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' )group by retailer_org_id) saleRet on sale.retailer_org_id=saleRet.retailer_org_id) union all &quot;;
<span class="nc" id="L112">			StringBuilder saleQry = new StringBuilder(</span>
					&quot;select om.organization_id,&quot;+QueryManager.getOrgCodeQuery()+&quot;,ifnull(mrpAmt,0.0) mrpAmt,ifnull(netAmt,0.0) netAmt from st_lms_organization_master om right outer join (select organization_id,sum(mrpAmt) mrpAmt,sum(netAmt) netAmt from st_lms_organization_master,(select retailer_org_id,sum(mrpAmt) mrpAmt,sum(netAmt) netAmt from (&quot;);
<span class="nc" id="L114">			String gameQry = &quot;select game_id from st_dg_game_master&quot;;</span>
<span class="nc" id="L115">			PreparedStatement pstmtGame = con.prepareStatement(gameQry);</span>
<span class="nc" id="L116">			ResultSet rsGame = pstmtGame.executeQuery();</span>

<span class="nc bnc" id="L118" title="All 2 branches missed.">			while (rsGame.next()) {</span>
<span class="nc" id="L119">				saleQry.append(indGameQry.replaceAll(&quot;\\*&quot;, rsGame</span>
						.getString(&quot;game_id&quot;)));
			}
<span class="nc" id="L122">			saleQry.delete(saleQry.length() - 10, saleQry.length());</span>
<span class="nc" id="L123">			saleQry</span>
					.append(&quot;) saleTlb group by retailer_org_id) saleTlb where retailer_org_id=organization_id and parent_id=&quot;
							+ agtOrgId
							+ &quot; group by organization_id) saleTlb on saleTlb.organization_id=om.organization_id&quot;);

<span class="nc" id="L128">			pstmt = con.prepareStatement(saleQry.toString());</span>

<span class="nc" id="L130">			logger.info(&quot;----Retailer Qry---&quot; + pstmt);</span>
<span class="nc" id="L131">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L133">				reportsBean = new SalePwtReportsBean();</span>
<span class="nc" id="L134">				reportsBean.setGameName(rs.getString(&quot;orgCode&quot;));</span>
<span class="nc" id="L135">				reportsBean.setGameNo(rs.getInt(&quot;organization_id&quot;));</span>
<span class="nc" id="L136">				reportsBean.setSaleMrpAmt(rs.getDouble(&quot;mrpAmt&quot;));</span>
<span class="nc" id="L137">				reportsBean.setSaleNetAmt(rs.getDouble(&quot;netAmt&quot;));</span>
<span class="nc" id="L138">				beanList.add(reportsBean);</span>
			}
<span class="nc" id="L140">			CommonFunctionsHelper.sortListForOrgOrder(beanList);	</span>
<span class="nc" id="L141">		} catch (Exception e) {</span>
<span class="nc" id="L142">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L144">			con.close();</span>
<span class="nc" id="L145">		}</span>
<span class="nc" id="L146">		return beanList;</span>
	}

	public List&lt;SalePwtReportsBean&gt; drawSaleAgentWiseExpand(
			Timestamp startDate, Timestamp endDate, int agentOrgId, ReportStatusBean reportStatusBean)
			throws SQLException {
<span class="nc" id="L152">		Connection con = null;</span>
<span class="nc" id="L153">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L154">		ResultSet rs = null;</span>
<span class="nc" id="L155">		SalePwtReportsBean reportsBean = null;</span>
<span class="nc" id="L156">		List&lt;SalePwtReportsBean&gt; beanList = new ArrayList&lt;SalePwtReportsBean&gt;();</span>
		try {
<span class="nc bnc" id="L158" title="All 4 branches missed.">			if(&quot;NO&quot;.equals(Utility.getPropertyValue(&quot;IS_DATA_FROM_REPLICA&quot;)) || &quot;MAIN_DB&quot;.equals(reportStatusBean.getReportingFrom()))</span>
<span class="nc" id="L159">				con = DBConnect.getConnection();</span>
			else
<span class="nc" id="L161">				con = DBConnectReplica.getConnection();</span>

<span class="nc" id="L163">			String indGameQry = &quot;(select game_id,unitPriceAmt,noOfTkt,mrpAmt,netAmt from (select sale.game_id,unitPriceAmt,(ifnull(noOfTkt,0)-ifnull(noOfTktRet,0)) noOfTkt,(ifnull(mrpAmt,0.0)-ifnull(mrpAmtRet,0.0))mrpAmt,(ifnull(netAmt,0.0)-ifnull(netAmtRet,0.0))netAmt from (select game_id,mrp_amt unitPriceAmt,count(mrp_amt) noOfTkt,sum(mrp_amt) mrpAmt,sum(agent_net_amt) netAmt from st_dg_ret_sale_* where transaction_id in(select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_SALE','DG_SALE_OFFLINE') and transaction_date&gt;='&quot;</span>
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' ) and retailer_org_id in (select organization_id from st_lms_organization_master where parent_id =&quot;
					+ agentOrgId
					+ &quot; )  group by mrp_amt order by mrp_amt) sale left outer join (select game_id,mrp_amt unitPriceAmtRet,count(mrp_amt) noOfTktRet,sum(mrp_amt) mrpAmtRet,sum(agent_net_amt) netAmtRet from st_dg_ret_sale_refund_* where transaction_id in(select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_REFUND_CANCEL','DG_REFUND_FAILED') and transaction_date&gt;='&quot;
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' ) and retailer_org_id in (select organization_id from st_lms_organization_master where parent_id =&quot;
					+ agentOrgId
					+ &quot; )  group by mrp_amt order by mrp_amt) saleRet on unitPriceAmt=unitPriceAmtRet) sale where noOfTkt!=0) union all &quot;;
<span class="nc" id="L176">			StringBuilder saleQry = new StringBuilder(</span>
					&quot;select gm.game_id gameId,game_name gameName,unitPriceAmt,noOfTkt,mrpAmt,netAmt from st_dg_game_master gm,(&quot;);
<span class="nc" id="L178">			String gameQry = &quot;select game_nbr from st_dg_game_master&quot;;</span>
<span class="nc" id="L179">			PreparedStatement pstmtGame = con.prepareStatement(gameQry);</span>
<span class="nc" id="L180">			ResultSet rsGame = pstmtGame.executeQuery();</span>

<span class="nc bnc" id="L182" title="All 2 branches missed.">			while (rsGame.next()) {</span>
<span class="nc" id="L183">				saleQry.append(indGameQry.replaceAll(&quot;\\*&quot;, rsGame</span>
						.getString(&quot;game_id&quot;)));
			}
<span class="nc" id="L186">			saleQry.delete(saleQry.length() - 10, saleQry.length());</span>
<span class="nc" id="L187">			saleQry.append(&quot;) saleTlb where gm.game_id=saleTlb.game_id&quot;);</span>

<span class="nc" id="L189">			pstmt = con.prepareStatement(saleQry.toString());</span>
<span class="nc" id="L190">			logger.info(&quot;----Game Expand Qry---&quot; + pstmt);</span>
<span class="nc" id="L191">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L193">				reportsBean = new SalePwtReportsBean();</span>
<span class="nc" id="L194">				reportsBean.setGameName(rs.getString(&quot;gameName&quot;));</span>
<span class="nc" id="L195">				reportsBean.setGameNo(rs.getInt(&quot;gameId&quot;));</span>
<span class="nc" id="L196">				reportsBean.setSaleMrpAmt(rs.getDouble(&quot;mrpAmt&quot;));</span>
<span class="nc" id="L197">				reportsBean.setSaleNetAmt(rs.getDouble(&quot;netAmt&quot;));</span>
<span class="nc" id="L198">				reportsBean.setUnitPriceAmt(rs.getDouble(&quot;unitPriceAmt&quot;));</span>
<span class="nc" id="L199">				reportsBean.setNoOfTkt(rs.getInt(&quot;noOfTkt&quot;));</span>
<span class="nc" id="L200">				beanList.add(reportsBean);</span>
			}
<span class="nc" id="L202">		} catch (Exception e) {</span>
<span class="nc" id="L203">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L205">			con.close();</span>
<span class="nc" id="L206">		}</span>
<span class="nc" id="L207">		return beanList;</span>
	}

	public List&lt;SalePwtReportsBean&gt; drawSaleRetailerWiseExpand(
			Timestamp startDate, Timestamp endDate, int agentOrgId, ReportStatusBean reportStatusBean)
			throws SQLException {
<span class="nc" id="L213">		Connection con = null;</span>
<span class="nc" id="L214">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L215">		ResultSet rs = null;</span>
<span class="nc" id="L216">		SalePwtReportsBean reportsBean = null;</span>
<span class="nc" id="L217">		List&lt;SalePwtReportsBean&gt; beanList = new ArrayList&lt;SalePwtReportsBean&gt;();</span>
		try {
<span class="nc bnc" id="L219" title="All 4 branches missed.">			if(&quot;NO&quot;.equals(Utility.getPropertyValue(&quot;IS_DATA_FROM_REPLICA&quot;)) || &quot;MAIN_DB&quot;.equals(reportStatusBean.getReportingFrom()))</span>
<span class="nc" id="L220">				con = DBConnect.getConnection();</span>
			else
<span class="nc" id="L222">				con = DBConnectReplica.getConnection();</span>

<span class="nc" id="L224">			String indGameQry = &quot;(select game_id,unitPriceAmt,noOfTkt,mrpAmt,netAmt from (select sale.game_id,unitPriceAmt,(ifnull(noOfTkt,0)-ifnull(noOfTktRet,0)) noOfTkt,(ifnull(mrpAmt,0.0)-ifnull(mrpAmtRet,0.0))mrpAmt,(ifnull(netAmt,0.0)-ifnull(netAmtRet,0.0))netAmt from (select game_id,mrp_amt unitPriceAmt,count(mrp_amt) noOfTkt,sum(mrp_amt) mrpAmt,sum(net_amt) netAmt from st_dg_ret_sale_* where transaction_id in(select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_SALE','DG_SALE_OFFLINE') and transaction_date&gt;='&quot;</span>
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' ) and retailer_org_id in (select organization_id from st_lms_organization_master where organization_id =&quot;
					+ agentOrgId
					+ &quot; )  group by mrp_amt order by mrp_amt) sale left outer join (select game_id,mrp_amt unitPriceAmtRet,count(mrp_amt) noOfTktRet,sum(mrp_amt) mrpAmtRet,sum(net_amt) netAmtRet from st_dg_ret_sale_refund_* where transaction_id in(select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_REFUND_CANCEL','DG_REFUND_FAILED') and transaction_date&gt;='&quot;
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' ) and retailer_org_id in (select organization_id from st_lms_organization_master where organization_id =&quot;
					+ agentOrgId
					+ &quot; )  group by mrp_amt order by mrp_amt) saleRet on unitPriceAmt=unitPriceAmtRet) sale where noOfTkt!=0 ) union all &quot;;
<span class="nc" id="L237">			StringBuilder saleQry = new StringBuilder(</span>
					&quot;select gm.game_id gameId,game_name gameName,unitPriceAmt,noOfTkt,mrpAmt,netAmt from st_dg_game_master gm,(&quot;);
<span class="nc" id="L239">			String gameQry = &quot;select game_id from st_dg_game_master&quot;;</span>
<span class="nc" id="L240">			PreparedStatement pstmtGame = con.prepareStatement(gameQry);</span>
<span class="nc" id="L241">			ResultSet rsGame = pstmtGame.executeQuery();</span>

<span class="nc bnc" id="L243" title="All 2 branches missed.">			while (rsGame.next()) {</span>
<span class="nc" id="L244">				saleQry.append(indGameQry.replaceAll(&quot;\\*&quot;, rsGame</span>
						.getString(&quot;game_id&quot;)));
			}
<span class="nc" id="L247">			saleQry.delete(saleQry.length() - 10, saleQry.length());</span>
<span class="nc" id="L248">			saleQry.append(&quot;) saleTlb where gm.game_id=saleTlb.game_id&quot;);</span>

<span class="nc" id="L250">			pstmt = con.prepareStatement(saleQry.toString());</span>
<span class="nc" id="L251">			logger.info(&quot;----Game Expand Qry---&quot; + pstmt);</span>
<span class="nc" id="L252">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L254">				reportsBean = new SalePwtReportsBean();</span>
<span class="nc" id="L255">				reportsBean.setGameName(rs.getString(&quot;gameName&quot;));</span>
<span class="nc" id="L256">				reportsBean.setGameNo(rs.getInt(&quot;gameId&quot;));</span>
<span class="nc" id="L257">				reportsBean.setSaleMrpAmt(rs.getDouble(&quot;mrpAmt&quot;));</span>
<span class="nc" id="L258">				reportsBean.setSaleNetAmt(rs.getDouble(&quot;netAmt&quot;));</span>
<span class="nc" id="L259">				reportsBean.setUnitPriceAmt(rs.getDouble(&quot;unitPriceAmt&quot;));</span>
<span class="nc" id="L260">				reportsBean.setNoOfTkt(rs.getInt(&quot;noOfTkt&quot;));</span>
<span class="nc" id="L261">				beanList.add(reportsBean);</span>
			}
<span class="nc" id="L263">		} catch (Exception e) {</span>
<span class="nc" id="L264">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L266">			con.close();</span>
<span class="nc" id="L267">		}</span>
<span class="nc" id="L268">		return beanList;</span>
	}

	public List&lt;SalePwtReportsBean&gt; drawSaleGameWise(Timestamp startDate,
			Timestamp endDate) throws SQLException {
<span class="nc" id="L273">		logger.info(&quot;---Draw Sale Report Game Wise Helper---&quot;);</span>
<span class="nc" id="L274">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L275">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L276">		ResultSet rs = null;</span>
<span class="nc" id="L277">		SalePwtReportsBean reportsBean = null;</span>
<span class="nc" id="L278">		List&lt;SalePwtReportsBean&gt; beanList = new ArrayList&lt;SalePwtReportsBean&gt;();</span>
		try {
<span class="nc" id="L280">			String indGameQry = &quot;select sale.game_id,(ifnull(mrpAmt,0.0)-ifnull(mrpAmtRet,0.0))mrpAmt,(ifnull(netAmt,0.0)-ifnull(netAmtRet,0.0))netAmt from (select game_id,sum(mrp_amt) mrpAmt,sum(agent_net_amt) netAmt from st_dg_ret_sale_* where transaction_id in(select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_SALE','DG_SALE_OFFLINE') and transaction_date&gt;='&quot;</span>
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' ) group by game_id) sale left outer join (select game_id,sum(mrp_amt) mrpAmtRet,sum(agent_net_amt) netAmtRet from st_dg_ret_sale_refund_* where transaction_id in(select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_REFUND_CANCEL','DG_REFUND_FAILED') and transaction_date&gt;='&quot;
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' ) group by game_id)saleRet on sale.game_id=saleRet.game_id union all &quot;;
<span class="nc" id="L289">			StringBuilder saleQry = new StringBuilder(</span>
					&quot;select game_id gameId,game_name gameName,mrpAmt,netAmt from st_dg_game_master gm,(&quot;);
<span class="nc" id="L291">			String gameQry = &quot;select game_id gameId from st_dg_game_master&quot;;</span>
<span class="nc" id="L292">			PreparedStatement pstmtGame = con.prepareStatement(gameQry);</span>
<span class="nc" id="L293">			ResultSet rsGame = pstmtGame.executeQuery();</span>

<span class="nc bnc" id="L295" title="All 2 branches missed.">			while (rsGame.next()) {</span>
<span class="nc" id="L296">				saleQry.append(indGameQry.replaceAll(&quot;\\*&quot;, rsGame</span>
						.getString(&quot;gameId&quot;)));
			}
<span class="nc" id="L299">			saleQry.delete(saleQry.length() - 10, saleQry.length());</span>
<span class="nc" id="L300">			saleQry.append(&quot;) saleTlb where gm.gameId=saleTlb.game_id&quot;);</span>

<span class="nc" id="L302">			pstmt = con.prepareStatement(saleQry.toString());</span>
<span class="nc" id="L303">			logger.info(&quot;----Game Qry---&quot; + pstmt);</span>
<span class="nc" id="L304">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L306">				reportsBean = new SalePwtReportsBean();</span>
<span class="nc" id="L307">				reportsBean.setGameName(rs.getString(&quot;gameName&quot;));</span>
<span class="nc" id="L308">				reportsBean.setGameNo(rs.getInt(&quot;gameId&quot;));</span>
<span class="nc" id="L309">				reportsBean.setSaleMrpAmt(rs.getDouble(&quot;mrpAmt&quot;));</span>
<span class="nc" id="L310">				reportsBean.setSaleNetAmt(rs.getDouble(&quot;netAmt&quot;));</span>
<span class="nc" id="L311">				beanList.add(reportsBean);</span>
			}
<span class="nc" id="L313">		} catch (Exception e) {</span>
<span class="nc" id="L314">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L316">			con.close();</span>
<span class="nc" id="L317">		}</span>
<span class="nc" id="L318">		return beanList;</span>
	}

	public List&lt;SalePwtReportsBean&gt; drawSaleGameWise(Timestamp startDate,
			Timestamp endDate, ReportStatusBean reportStatusBean, String cityCode, String stateCode) throws SQLException {
<span class="nc" id="L323">		logger.info(&quot;---Draw Sale Report Game Wise Helper---&quot;);</span>
<span class="nc" id="L324">		Connection con = null;</span>
<span class="nc" id="L325">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L326">		ResultSet rs = null;</span>
<span class="nc" id="L327">		SalePwtReportsBean reportsBean = null;</span>
<span class="nc" id="L328">		List&lt;SalePwtReportsBean&gt; beanList = new ArrayList&lt;SalePwtReportsBean&gt;();</span>
		try {
<span class="nc bnc" id="L330" title="All 4 branches missed.">			if(&quot;NO&quot;.equals(Utility.getPropertyValue(&quot;IS_DATA_FROM_REPLICA&quot;)) || &quot;MAIN_DB&quot;.equals(reportStatusBean.getReportingFrom()))</span>
<span class="nc" id="L331">				con = DBConnect.getConnection();</span>
			else
<span class="nc" id="L333">				con = DBConnectReplica.getConnection();</span>

<span class="nc" id="L335">			String indGameQry = &quot;select sale.game_id,(ifnull(mrpAmt,0.0)-ifnull(mrpAmtRet,0.0))mrpAmt,(ifnull(netAmt,0.0)-ifnull(netAmtRet,0.0))netAmt from (select game_id,sum(mrp_amt) mrpAmt,sum(agent_net_amt) netAmt from st_dg_ret_sale_* where transaction_id in(select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_SALE','DG_SALE_OFFLINE') and transaction_date&gt;='&quot;</span>
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' ) group by game_id) sale left outer join (select game_id,sum(mrp_amt) mrpAmtRet,sum(agent_net_amt) netAmtRet from st_dg_ret_sale_refund_* where transaction_id in(select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_REFUND_CANCEL','DG_REFUND_FAILED') and transaction_date&gt;='&quot;
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' ) group by game_id)saleRet on sale.game_id=saleRet.game_id union all &quot;;
<span class="nc" id="L344">			StringBuilder saleQry = new StringBuilder(</span>
					&quot;select game_id gameId,game_name gameName,mrpAmt,netAmt from st_dg_game_master gm,(&quot;);
<span class="nc" id="L346">			String gameQry = &quot;select game_id gameId from st_dg_game_master&quot;;</span>
<span class="nc" id="L347">			PreparedStatement pstmtGame = con.prepareStatement(gameQry);</span>
<span class="nc" id="L348">			ResultSet rsGame = pstmtGame.executeQuery();</span>

<span class="nc bnc" id="L350" title="All 2 branches missed.">			while (rsGame.next()) {</span>
<span class="nc" id="L351">				saleQry.append(indGameQry.replaceAll(&quot;\\*&quot;, rsGame</span>
						.getString(&quot;gameId&quot;)));
			}
<span class="nc" id="L354">			saleQry.delete(saleQry.length() - 10, saleQry.length());</span>
<span class="nc" id="L355">			saleQry.append(&quot;) saleTlb where gm.gameId=saleTlb.game_id&quot;);</span>

<span class="nc" id="L357">			pstmt = con.prepareStatement(saleQry.toString());</span>
<span class="nc" id="L358">			logger.info(&quot;----Game Qry---&quot; + pstmt);</span>
<span class="nc" id="L359">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L361">				reportsBean = new SalePwtReportsBean();</span>
<span class="nc" id="L362">				reportsBean.setGameName(rs.getString(&quot;gameName&quot;));</span>
<span class="nc" id="L363">				reportsBean.setGameNo(rs.getInt(&quot;gameId&quot;));</span>
<span class="nc" id="L364">				reportsBean.setSaleMrpAmt(rs.getDouble(&quot;mrpAmt&quot;));</span>
<span class="nc" id="L365">				reportsBean.setSaleNetAmt(rs.getDouble(&quot;netAmt&quot;));</span>
<span class="nc" id="L366">				beanList.add(reportsBean);</span>
			}
<span class="nc" id="L368">		} catch (Exception e) {</span>
<span class="nc" id="L369">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L371">			con.close();</span>
<span class="nc" id="L372">		}</span>
<span class="nc" id="L373">		return beanList;</span>
	}

	public List&lt;SalePwtReportsBean&gt; drawSaleGameWiseForAgent(
			Timestamp startDate, Timestamp endDate, int agtOrgId, ReportStatusBean reportStatusBean)
			throws SQLException {
<span class="nc" id="L379">		logger.info(&quot;---Draw Sale Report Game Wise Helper---&quot;);</span>
<span class="nc" id="L380">		Connection con = null;</span>
<span class="nc" id="L381">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L382">		ResultSet rs = null;</span>
<span class="nc" id="L383">		SalePwtReportsBean reportsBean = null;</span>
<span class="nc" id="L384">		List&lt;SalePwtReportsBean&gt; beanList = new ArrayList&lt;SalePwtReportsBean&gt;();</span>
		try {
<span class="nc bnc" id="L386" title="All 4 branches missed.">			if(&quot;NO&quot;.equals(Utility.getPropertyValue(&quot;IS_DATA_FROM_REPLICA&quot;)) || &quot;MAIN_DB&quot;.equals(reportStatusBean.getReportingFrom()))</span>
<span class="nc" id="L387">				con = DBConnect.getConnection();</span>
			else
<span class="nc" id="L389">				con = DBConnectReplica.getConnection();</span>

<span class="nc" id="L391">			String indGameQry = &quot;select sale.game_id,(ifnull(mrpAmt,0.0)-ifnull(mrpAmtRet,0.0))mrpAmt,(ifnull(netAmt,0.0)-ifnull(netAmtRet,0.0))netAmt from (select game_id,sum(mrp_amt) mrpAmt,sum(net_amt) netAmt from st_dg_ret_sale_* where transaction_id in(select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_SALE','DG_SALE_OFFLINE') and transaction_date&gt;='&quot;</span>
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' ) and retailer_org_id in(select organization_id from st_lms_organization_master where parent_id=&quot;
					+ agtOrgId
					+ &quot;) group by game_id) sale left outer join (select game_id,sum(mrp_amt) mrpAmtRet,sum(net_amt) netAmtRet from st_dg_ret_sale_refund_* where transaction_id in(select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_REFUND_CANCEL','DG_REFUND_FAILED') and transaction_date&gt;='&quot;
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' ) and retailer_org_id in(select organization_id from st_lms_organization_master where parent_id=&quot;
					+ agtOrgId
					+ &quot;) group by game_id)saleRet on sale.game_id=saleRet.game_id union all &quot;;
<span class="nc" id="L404">			StringBuilder saleQry = new StringBuilder(</span>
					&quot;select gm.game_id gameId,game_name gameName,mrpAmt,netAmt from st_dg_game_master gm,(&quot;);
<span class="nc" id="L406">			String gameQry = &quot;select game_id from st_dg_game_master&quot;;</span>
<span class="nc" id="L407">			PreparedStatement pstmtGame = con.prepareStatement(gameQry);</span>
<span class="nc" id="L408">			ResultSet rsGame = pstmtGame.executeQuery();</span>

<span class="nc bnc" id="L410" title="All 2 branches missed.">			while (rsGame.next()) {</span>
<span class="nc" id="L411">				saleQry.append(indGameQry.replaceAll(&quot;\\*&quot;, rsGame</span>
						.getString(&quot;game_id&quot;)));
			}
<span class="nc" id="L414">			saleQry.delete(saleQry.length() - 10, saleQry.length());</span>
<span class="nc" id="L415">			saleQry.append(&quot;) saleTlb where gm.game_id=saleTlb.game_id&quot;);</span>

<span class="nc" id="L417">			pstmt = con.prepareStatement(saleQry.toString());</span>
<span class="nc" id="L418">			logger.info(&quot;----Game Qry---&quot; + pstmt);</span>
<span class="nc" id="L419">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L420" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L421">				reportsBean = new SalePwtReportsBean();</span>
<span class="nc" id="L422">				reportsBean.setGameName(rs.getString(&quot;gameName&quot;));</span>
<span class="nc" id="L423">				reportsBean.setGameNo(rs.getInt(&quot;gameId&quot;));</span>
<span class="nc" id="L424">				reportsBean.setSaleMrpAmt(rs.getDouble(&quot;mrpAmt&quot;));</span>
<span class="nc" id="L425">				reportsBean.setSaleNetAmt(rs.getDouble(&quot;netAmt&quot;));</span>
<span class="nc" id="L426">				beanList.add(reportsBean);</span>
			}
<span class="nc" id="L428">		} catch (Exception e) {</span>
<span class="nc" id="L429">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L431">			con.close();</span>
<span class="nc" id="L432">		}</span>
<span class="nc" id="L433">		return beanList;</span>
	}

	public List&lt;SalePwtReportsBean&gt; drawSaleGameWiseExpand(Timestamp startDate,
			Timestamp endDate, ReportStatusBean reportStatusBean) throws SQLException {
<span class="nc" id="L438">		logger.info(&quot;---Draw Sale Report Game Wise Expand Helper---&quot;);</span>
<span class="nc" id="L439">		Connection con = null;</span>
<span class="nc" id="L440">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L441">		ResultSet rs = null;</span>
<span class="nc" id="L442">		SalePwtReportsBean reportsBean = null;</span>
<span class="nc" id="L443">		List&lt;SalePwtReportsBean&gt; beanList = new ArrayList&lt;SalePwtReportsBean&gt;();</span>
		try {
<span class="nc bnc" id="L445" title="All 4 branches missed.">			if(&quot;NO&quot;.equals(Utility.getPropertyValue(&quot;IS_DATA_FROM_REPLICA&quot;)) || &quot;MAIN_DB&quot;.equals(reportStatusBean.getReportingFrom()))</span>
<span class="nc" id="L446">				con = DBConnect.getConnection();</span>
			else
<span class="nc" id="L448">				con = DBConnectReplica.getConnection();</span>

<span class="nc" id="L450">			String indGameQry = &quot;(select game_id,unitPriceAmt,noOfTkt,mrpAmt,netAmt from (select sale.game_id,unitPriceAmt,(ifnull(noOfTkt,0)-ifnull(noOfTktRet,0)) noOfTkt,(ifnull(mrpAmt,0.0)-ifnull(mrpAmtRet,0.0)) mrpAmt,(ifnull(netAmt,0.0)-ifnull(netAmtRet,0.0)) netAmt from (select game_id,mrp_amt unitPriceAmt,count(mrp_amt) noOfTkt,sum(mrp_amt) mrpAmt,sum(agent_net_amt) netAmt from st_dg_ret_sale_* where transaction_id in(select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_SALE','DG_SALE_OFFLINE') and transaction_date&gt;='&quot;</span>
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' ) group by mrp_amt order by mrp_amt) sale left outer join (select game_id,mrp_amt unitPriceAmtRet,count(mrp_amt) noOfTktRet,sum(mrp_amt) mrpAmtRet,sum(agent_net_amt) netAmtRet from st_dg_ret_sale_refund_* where transaction_id in(select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_REFUND_CANCEL','DG_REFUND_FAILED') and transaction_date&gt;='&quot;
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' ) group by mrp_amt order by mrp_amt) saleRet on sale.game_id=saleRet.game_id and unitPriceAmt=unitPriceAmtRet) sale where noOfTkt!=0) union all &quot;;
<span class="nc" id="L459">			StringBuilder saleQry = new StringBuilder(</span>
					&quot;select game_id gameId,game_name gameName,unitPriceAmt,noOfTkt,mrpAmt,netAmt from st_dg_game_master gm,(&quot;);
<span class="nc" id="L461">			String gameQry = &quot;select game_id from st_dg_game_master&quot;;</span>
<span class="nc" id="L462">			PreparedStatement pstmtGame = con.prepareStatement(gameQry);</span>
<span class="nc" id="L463">			ResultSet rsGame = pstmtGame.executeQuery();</span>

<span class="nc bnc" id="L465" title="All 2 branches missed.">			while (rsGame.next()) {</span>
<span class="nc" id="L466">				saleQry.append(indGameQry.replaceAll(&quot;\\*&quot;, rsGame</span>
						.getString(&quot;game_id&quot;)));
			}
<span class="nc" id="L469">			saleQry.delete(saleQry.length() - 10, saleQry.length());</span>
<span class="nc" id="L470">			saleQry.append(&quot;) saleTlb where gm.game_id=saleTlb.game_id&quot;);</span>

<span class="nc" id="L472">			pstmt = con.prepareStatement(saleQry.toString());</span>
<span class="nc" id="L473">			logger.info(&quot;----Game Expand Qry---&quot; + pstmt);</span>
<span class="nc" id="L474">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L475" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L476">				reportsBean = new SalePwtReportsBean();</span>
<span class="nc" id="L477">				reportsBean.setGameName(rs.getString(&quot;gameName&quot;));</span>
<span class="nc" id="L478">				reportsBean.setGameNo(rs.getInt(&quot;gameId&quot;));</span>
<span class="nc" id="L479">				reportsBean.setSaleMrpAmt(rs.getDouble(&quot;mrpAmt&quot;));</span>
<span class="nc" id="L480">				reportsBean.setSaleNetAmt(rs.getDouble(&quot;netAmt&quot;));</span>
<span class="nc" id="L481">				reportsBean.setUnitPriceAmt(rs.getDouble(&quot;unitPriceAmt&quot;));</span>
<span class="nc" id="L482">				reportsBean.setNoOfTkt(rs.getInt(&quot;noOfTkt&quot;));</span>
<span class="nc" id="L483">				beanList.add(reportsBean);</span>
			}
<span class="nc" id="L485">		} catch (Exception e) {</span>
<span class="nc" id="L486">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L488">			con.close();</span>
<span class="nc" id="L489">		}</span>
<span class="nc" id="L490">		return beanList;</span>
	}

	public List&lt;SalePwtReportsBean&gt; drawSaleGameWiseExpandForAgent(
			Timestamp startDate, Timestamp endDate, int agtOrgId, ReportStatusBean reportStatusBean)
			throws SQLException {
<span class="nc" id="L496">		logger.info(&quot;---Draw Sale Report Game Wise Expand Helper---&quot;);</span>
<span class="nc" id="L497">		Connection con = null;</span>
<span class="nc" id="L498">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L499">		ResultSet rs = null;</span>
<span class="nc" id="L500">		SalePwtReportsBean reportsBean = null;</span>
<span class="nc" id="L501">		List&lt;SalePwtReportsBean&gt; beanList = new ArrayList&lt;SalePwtReportsBean&gt;();</span>
		try {
<span class="nc bnc" id="L503" title="All 4 branches missed.">			if(&quot;NO&quot;.equals(Utility.getPropertyValue(&quot;IS_DATA_FROM_REPLICA&quot;)) || &quot;MAIN_DB&quot;.equals(reportStatusBean.getReportingFrom()))</span>
<span class="nc" id="L504">				con = DBConnect.getConnection();</span>
			else
<span class="nc" id="L506">				con = DBConnectReplica.getConnection();</span>

<span class="nc" id="L508">			String indGameQry = &quot;(select game_id,unitPriceAmt,noOfTkt,mrpAmt,netAmt from (select sale.game_id,unitPriceAmt,(ifnull(noOfTkt,0)-ifnull(noOfTktRet,0)) noOfTkt,(ifnull(mrpAmt,0.0)-ifnull(mrpAmtRet,0.0)) mrpAmt,(ifnull(netAmt,0.0)-ifnull(netAmtRet,0.0)) netAmt from (select game_id,mrp_amt unitPriceAmt,count(mrp_amt) noOfTkt,sum(mrp_amt) mrpAmt,sum(net_amt) netAmt from st_dg_ret_sale_* where transaction_id in(select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_SALE','DG_SALE_OFFLINE') and transaction_date&gt;='&quot;</span>
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' ) and retailer_org_id in(select organization_id from st_lms_organization_master where parent_id=&quot;
					+ agtOrgId
					+ &quot;) group by mrp_amt order by mrp_amt) sale left outer join (select game_id,mrp_amt unitPriceAmtRet,count(mrp_amt) noOfTktRet,sum(mrp_amt) mrpAmtRet,sum(net_amt) netAmtRet from st_dg_ret_sale_refund_* where transaction_id in(select transaction_id from st_lms_retailer_transaction_master where transaction_type in('DG_REFUND_CANCEL','DG_REFUND_FAILED') and transaction_date&gt;='&quot;
					+ startDate
					+ &quot;' and transaction_date&lt;='&quot;
					+ endDate
					+ &quot;' ) and retailer_org_id in(select organization_id from st_lms_organization_master where parent_id=&quot;
					+ agtOrgId
					+ &quot;) group by mrp_amt order by mrp_amt) saleRet on sale.game_id=saleRet.game_id and unitPriceAmt=unitPriceAmtRet) sale where noOfTkt!=0) union all &quot;;
<span class="nc" id="L521">			StringBuilder saleQry = new StringBuilder(</span>
					&quot;select gm.game_id gameId,game_name gameName,unitPriceAmt,noOfTkt,mrpAmt,netAmt from st_dg_game_master gm,(&quot;);
<span class="nc" id="L523">			String gameQry = &quot;select game_id from st_dg_game_master&quot;;</span>
<span class="nc" id="L524">			PreparedStatement pstmtGame = con.prepareStatement(gameQry);</span>
<span class="nc" id="L525">			ResultSet rsGame = pstmtGame.executeQuery();</span>

<span class="nc bnc" id="L527" title="All 2 branches missed.">			while (rsGame.next()) {</span>
<span class="nc" id="L528">				saleQry.append(indGameQry.replaceAll(&quot;\\*&quot;, rsGame</span>
						.getString(&quot;game_id&quot;)));
			}
<span class="nc" id="L531">			saleQry.delete(saleQry.length() - 10, saleQry.length());</span>
<span class="nc" id="L532">			saleQry.append(&quot;) saleTlb where gm.game_id=saleTlb.game_id&quot;);</span>

<span class="nc" id="L534">			pstmt = con.prepareStatement(saleQry.toString());</span>
<span class="nc" id="L535">			logger.info(&quot;----Game Expand Qry---&quot; + pstmt);</span>
<span class="nc" id="L536">			rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L537" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L538">				reportsBean = new SalePwtReportsBean();</span>
<span class="nc" id="L539">				reportsBean.setGameName(rs.getString(&quot;gameName&quot;));</span>
<span class="nc" id="L540">				reportsBean.setGameNo(rs.getInt(&quot;gameId&quot;));</span>
<span class="nc" id="L541">				reportsBean.setSaleMrpAmt(rs.getDouble(&quot;mrpAmt&quot;));</span>
<span class="nc" id="L542">				reportsBean.setSaleNetAmt(rs.getDouble(&quot;netAmt&quot;));</span>
<span class="nc" id="L543">				reportsBean.setUnitPriceAmt(rs.getDouble(&quot;unitPriceAmt&quot;));</span>
<span class="nc" id="L544">				reportsBean.setNoOfTkt(rs.getInt(&quot;noOfTkt&quot;));</span>
<span class="nc" id="L545">				beanList.add(reportsBean);</span>
			}
<span class="nc" id="L547">		} catch (Exception e) {</span>
<span class="nc" id="L548">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L550">			con.close();</span>
<span class="nc" id="L551">		}</span>
<span class="nc" id="L552">		return beanList;</span>
	}

	public String getOrgAdd(int orgId) throws LMSException {
<span class="nc" id="L556">		String orgAdd = &quot;&quot;;</span>
<span class="nc" id="L557">		Connection con = null;</span>
<span class="nc" id="L558">		con = DBConnect.getConnection();</span>
<span class="nc" id="L559">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L560">		ResultSet rs = null;</span>
		try {
<span class="nc" id="L562">			pstmt = con</span>
					.prepareStatement(&quot;select addr_line1, addr_line2, city from st_lms_organization_master where organization_id = ?&quot;);
<span class="nc" id="L564">			pstmt.setInt(1, orgId);</span>
<span class="nc" id="L565">			rs = pstmt.executeQuery();</span>
<span class="nc" id="L566">			logger.debug(pstmt);</span>
<span class="nc bnc" id="L567" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L568">				orgAdd = rs.getString(&quot;addr_line1&quot;) + &quot;, &quot;</span>
						+ rs.getString(&quot;addr_line2&quot;) + &quot;, &quot;
						+ rs.getString(&quot;city&quot;);
			}
<span class="nc" id="L572">		} catch (SQLException e) {</span>
<span class="nc" id="L573">			logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L574">			e.printStackTrace();</span>
<span class="nc" id="L575">			throw new LMSException(e);</span>
		} finally {
<span class="nc" id="L577">			try {</span>
<span class="nc bnc" id="L578" title="All 8 branches missed.">				if (con != null &amp;&amp; !con.isClosed()) {</span>
<span class="nc" id="L579">					con.close();</span>
				}
<span class="nc" id="L581">			} catch (SQLException e) {</span>
<span class="nc" id="L582">				logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L583">				e.printStackTrace();</span>
<span class="nc" id="L584">				throw new LMSException(e);</span>
<span class="nc" id="L585">			}</span>
		}
<span class="nc" id="L587">		return orgAdd;</span>
	}

	public Map&lt;Integer, List&lt;String&gt;&gt; fetchOrgAddMap(String orgType,
			Integer agtOrgId) throws LMSException {
<span class="nc" id="L592">		Map&lt;Integer, List&lt;String&gt;&gt; map = new TreeMap&lt;Integer, List&lt;String&gt;&gt;();</span>
<span class="nc" id="L593">		Connection con = null;</span>
<span class="nc" id="L594">		String orgAdd = &quot;&quot;;</span>
<span class="nc" id="L595">		con = DBConnect.getConnection();</span>
<span class="nc" id="L596">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L597">		ResultSet rs = null;</span>
<span class="nc" id="L598">		List&lt;String&gt; tempList = null;</span>
		try {
<span class="nc bnc" id="L600" title="All 2 branches missed.">			if (orgType.equalsIgnoreCase(&quot;AGENT&quot;)) {</span>
<span class="nc" id="L601">				pstmt = con</span>
						.prepareStatement(&quot;select organization_id, name,addr_line1, addr_line2, city from st_lms_organization_master where organization_type = '&quot;
								+ orgType + &quot;'&quot;);
			} else {
<span class="nc" id="L605">				pstmt = con</span>
						.prepareStatement(&quot;select organization_id, name,addr_line1, addr_line2, city from st_lms_organization_master where organization_type = '&quot;
								+ orgType + &quot;' and parent_id = &quot; + agtOrgId);
			}
<span class="nc" id="L609">			rs = pstmt.executeQuery();</span>
<span class="nc" id="L610">			logger.debug(pstmt);</span>
<span class="nc bnc" id="L611" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L612">				tempList = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L613">				orgAdd = rs.getString(&quot;addr_line1&quot;) + &quot;, &quot;</span>
						+ rs.getString(&quot;addr_line2&quot;) + &quot;, &quot;
						+ rs.getString(&quot;city&quot;);
<span class="nc" id="L616">				tempList.add(rs.getString(&quot;name&quot;));</span>
<span class="nc" id="L617">				tempList.add(orgAdd);</span>
<span class="nc" id="L618">				map.put(rs.getInt(&quot;organization_id&quot;), tempList);</span>
			}
<span class="nc" id="L620">		} catch (SQLException e) {</span>
<span class="nc" id="L621">			logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L622">			e.printStackTrace();</span>
<span class="nc" id="L623">			throw new LMSException(e);</span>
		} finally {
<span class="nc" id="L625">			try {</span>
<span class="nc bnc" id="L626" title="All 8 branches missed.">				if (con != null &amp;&amp; !con.isClosed()) {</span>
<span class="nc" id="L627">					con.close();</span>
				}
<span class="nc" id="L629">			} catch (SQLException e) {</span>
<span class="nc" id="L630">				logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L631">				e.printStackTrace();</span>
<span class="nc" id="L632">				throw new LMSException(e);</span>
<span class="nc" id="L633">			}</span>
		}
<span class="nc" id="L635">		return map;</span>
	}
public static Map&lt;String,RegionWiseDataBean&gt;  fetchRegionWiseSaleCashData(AnalysisBean anaBean,String stateCode,ReportStatusBean reportStatusBean) throws LMSException{
<span class="nc" id="L638">	Connection con =null;</span>
<span class="nc" id="L639">	PreparedStatement pstmt =null;</span>
<span class="nc" id="L640">	Map&lt;String,RegionWiseDataBean&gt; dataMap = new LinkedHashMap&lt;String,RegionWiseDataBean&gt;();</span>
<span class="nc" id="L641">	ResultSet rs = null;</span>
	try{
		
<span class="nc" id="L644">		String subQry =&quot; &quot;;</span>
<span class="nc bnc" id="L645" title="All 4 branches missed.">		if(stateCode!=null&amp;&amp;!stateCode.equalsIgnoreCase(&quot;-1&quot;)){</span>
<span class="nc" id="L646">			subQry =&quot; and sm.state_code='&quot;+stateCode.trim()+&quot;'&quot;;</span>
		}
		/*String str =&quot; select sum(ifnull(main.mrpAmtRet,0.0)-ifnull(sub.mrpAmtRet,0.0)) mrpAmtRet,area_name,city_name,sm.name state,sm.state_code from (select retailer_org_id,sum(net_amt) mrpAmtRet from (select transaction_id from st_lms_retailer_transaction_master where  transaction_type in('DG_SALE','DG_SALE_OFFLINE') and transaction_date&gt;=? and transaction_date&lt;=?) rtm &quot;+
					&quot; inner join st_dg_ret_sale_? retSale on retSale.transaction_id=rtm.transaction_id group by retailer_org_id  ) main left join (select retailer_org_id,sum(net_amt) mrpAmtRet from  (select transaction_id from st_lms_retailer_transaction_master where  transaction_type in('DG_REFUND_CANCEL','DG_REFUND_FAILED') and transaction_date&gt;=? and transaction_date&lt;=?) rtm &quot;+
					&quot;	inner join st_dg_ret_sale_refund_? retRef on retRef.transaction_id=rtm.transaction_id group by retailer_org_id  ) sub on main.retailer_org_id=sub.retailer_org_id right join st_lms_organization_master om on organization_id=main.retailer_org_id inner join st_lms_city_master cm on cm.city_name=om.city  inner join st_lms_state_master  sm on sm.state_code=om.state_code   inner join st_lms_area_master  am on  am.area_code=om.area_code&quot;+ 
					&quot; where organization_status!='TERMINATE'  and  om.organization_type='RETAILER'&quot;+subQry+&quot; group by sm.state_code &quot;; */
		
<span class="nc" id="L653">		String str=&quot; select  sum(mrpAmtRet) mrpAmtRet,area_name,city_name,sm.name state,sm.state_code from  ( select sum(ifnull(sale.mrpAmtRet,0.00)-ifnull(ref.mrpAmtRet,0.00)) mrpAmtRet,sale.retailer_org_id from ( select retailer_org_id,sum(mrp_amt) mrpAmtRet from  ( select transaction_id from st_lms_retailer_transaction_master where  transaction_type in('DG_SALE','DG_SALE_OFFLINE') and transaction_date&gt;=? and transaction_date&lt;=? ) rtm inner join st_dg_ret_sale_? retSale on retSale.transaction_id=rtm.transaction_id group by retailer_org_id  ) sale left join (select retailer_org_id,sum(mrp_amt) mrpAmtRet from  (select transaction_id from st_lms_retailer_transaction_master where  transaction_type in('DG_REFUND_CANCEL','DG_REFUND_FAILED')  and transaction_date&gt;=? and transaction_date&lt;=? ) rtm inner join st_dg_ret_sale_refund_? retRef on retRef.transaction_id=rtm.transaction_id group by retailer_org_id  ) ref on sale.retailer_org_id=ref.retailer_org_id  group by retailer_org_id &quot;+</span>
						&quot; union all select mrpAmtRet,retailer_org_id from ( select ifnull(sum(sale_mrp-ref_sale_mrp) ,0.00) mrpAmtRet,organization_id retailer_org_id  from  st_rep_dg_retailer where finaldate&gt;=date(?) and finaldate&lt;=date(?) and game_id=? group by organization_id ) rep group by retailer_org_id )main right join st_lms_organization_master om on organization_id=main.retailer_org_id inner join st_lms_city_master cm on cm.city_name=om.city  inner join st_lms_state_master  sm on sm.state_code=om.state_code   inner join st_lms_area_master  am on  am.area_code=om.area_code inner join st_lms_user_master um on um.organization_id=om.organization_id  where ( (um.termination_date&gt;=? or um.termination_date is null) and registration_date&lt;=? )  and  om.organization_type='RETAILER' and um.isrolehead='Y' &quot;+subQry+&quot; group by sm.state_code&quot; ; 
		
<span class="nc bnc" id="L656" title="All 4 branches missed.">		if(&quot;NO&quot;.equals(Utility.getPropertyValue(&quot;IS_DATA_FROM_REPLICA&quot;)) || &quot;MAIN_DB&quot;.equals(reportStatusBean.getReportingFrom()))</span>
<span class="nc" id="L657">			con = DBConnect.getConnection();</span>
		else
<span class="nc" id="L659">			con = DBConnectReplica.getConnection();</span>
<span class="nc" id="L660">		pstmt =con.prepareStatement(str);</span>
<span class="nc" id="L661">		pstmt.setString(1, anaBean.getStartDate());</span>
<span class="nc" id="L662">		pstmt.setString(2, anaBean.getEndDate());</span>
<span class="nc" id="L663">		pstmt.setInt(3, anaBean.getGameId());</span>
<span class="nc" id="L664">		pstmt.setString(4, anaBean.getStartDate());</span>
<span class="nc" id="L665">		pstmt.setString(5, anaBean.getEndDate());</span>
<span class="nc" id="L666">		pstmt.setInt(6, anaBean.getGameId());</span>
<span class="nc" id="L667">		pstmt.setString(7, anaBean.getStartDate());</span>
<span class="nc" id="L668">		pstmt.setString(8, anaBean.getEndDate());</span>
<span class="nc" id="L669">		pstmt.setInt(9, anaBean.getGameId());</span>
<span class="nc" id="L670">		pstmt.setString(10, anaBean.getStartDate());</span>
<span class="nc" id="L671">		pstmt.setString(11, anaBean.getStartDate());</span>
<span class="nc" id="L672">		rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L673" title="All 2 branches missed.">		while(rs.next()){</span>
<span class="nc" id="L674">			RegionWiseDataBean dataBean =null;</span>
<span class="nc" id="L675">			String stateName = rs.getString(&quot;state_code&quot;);</span>
<span class="nc bnc" id="L676" title="All 2 branches missed.">			if(dataMap.containsKey(stateName)){</span>
<span class="nc" id="L677">				dataBean =dataMap.get(stateName);</span>
<span class="nc" id="L678">				dataBean.setSaleAmt(dataBean.getSaleAmt()+rs.getDouble(&quot;mrpAmtRet&quot;));</span>
				
			}else{
<span class="nc" id="L681">				dataBean = new RegionWiseDataBean();</span>
<span class="nc" id="L682">				dataBean.setStateName(rs.getString(&quot;state&quot;));</span>
<span class="nc" id="L683">				dataBean.setStateCode(rs.getString(&quot;state_code&quot;));</span>
<span class="nc" id="L684">				dataBean.setCityName(rs.getString(&quot;city_name&quot;));</span>
<span class="nc" id="L685">				dataBean.setAreaName(rs.getString(&quot;area_name&quot;));</span>
<span class="nc" id="L686">				dataBean.setSaleAmt(rs.getDouble(&quot;mrpAmtRet&quot;));</span>
<span class="nc" id="L687">				dataMap.put(stateName, dataBean);</span>
			}
			
			
<span class="nc" id="L691">		}</span>
<span class="nc" id="L692">		DBConnect.closeRs(rs);</span>
<span class="nc" id="L693">		DBConnect.closePstmt(pstmt);</span>
		/*String str1 =&quot; select ifnull(sum(amount),0.0) netAmt,area_name,city_name,sm.name state,sm.state_code from ( select ifnull(sum(cash.amount),0.0) amount,party_id from st_lms_agent_cash_transaction cash, st_lms_agent_transaction_master btm where  ( date(btm.transaction_date)&gt;=? and date(btm.transaction_date)&lt;?) and cash.transaction_id=btm.transaction_id  group by party_id union all&quot;+
					&quot; select ifnull(sum(chq.cheque_amt),0.0) amount,party_id from  st_lms_agent_sale_chq chq, st_lms_agent_transaction_master btm where chq.transaction_type IN ('CHEQUE','CLOSED') and ( date(btm.transaction_date)&gt;=? and date(btm.transaction_date)&lt;? ) and chq.transaction_id=btm.transaction_id  group by party_id union all  select ifnull(-sum(chq.cheque_amt),0.0) amount,party_id from  st_lms_agent_sale_chq chq, st_lms_agent_transaction_master btm where chq.transaction_type='CHQ_BOUNCE' and ( date(btm.transaction_date)&gt;=? and date(btm.transaction_date)&lt;?) and chq.transaction_id=btm.transaction_id  group by party_id &quot;+ 
					&quot; union all select ifnull(-sum(bo.amount),0.0) amount,party_id  from st_lms_agent_debit_note bo, st_lms_agent_transaction_master btm where btm.transaction_id=bo.transaction_id and (bo.transaction_type ='DR_NOTE_CASH' or bo.transaction_type ='DR_NOTE') and  ( date(btm.transaction_date)&gt;=? and date(btm.transaction_date)&lt;?) group by party_id union all  select ifnull(sum(bo.amount),0.0) amount,party_id  from st_lms_agent_credit_note bo, st_lms_agent_transaction_master btm where btm.transaction_id=bo.transaction_id and (bo.transaction_type ='CR_NOTE_CASH' or bo.transaction_type ='CR_NOTE')  and ( date(btm.transaction_date)&gt;=? and date(btm.transaction_date)&lt;?) group by party_id )a &quot;+ 
					&quot; right join st_lms_organization_master om  on organization_id=a.party_id inner join st_lms_city_master cm on cm.city_name=om.city inner join st_lms_state_master  sm on sm.state_code=om.state_code  inner join st_lms_area_master  am on  am.area_code=om.area_code where organization_status!='TERMINATE'  and  om.organization_type='RETAILER' &quot;+subQry+&quot; group by sm.state_code &quot;;*/
<span class="nc" id="L698">		String str1=&quot; select ifnull(sum(amount),0.0) netAmt,area_name,city_name,sm.name state,sm.state_code from ( select ifnull(sum(cash.amount),0.0) amount,party_id from st_lms_agent_cash_transaction cash, st_lms_agent_transaction_master btm where  ( date(btm.transaction_date)&gt;=? and date(btm.transaction_date)&lt;=?) and cash.transaction_id=btm.transaction_id  group by party_id union all select ifnull(sum(chq.cheque_amt),0.0) amount,party_id from  st_lms_agent_sale_chq chq, st_lms_agent_transaction_master btm where chq.transaction_type IN ('CHEQUE','CLOSED') and ( date(btm.transaction_date)&gt;=? and date(btm.transaction_date)&lt;=? ) and chq.transaction_id=btm.transaction_id  group by party_id union all  select ifnull(-sum(chq.cheque_amt),0.0) amount,party_id from  st_lms_agent_sale_chq chq, st_lms_agent_transaction_master btm where chq.transaction_type='CHQ_BOUNCE' and ( date(btm.transaction_date)&gt;=? and date(btm.transaction_date)&lt;=?) and chq.transaction_id=btm.transaction_id  group by party_id  union all select ifnull(-sum(bo.amount),0.0) amount,party_id  from st_lms_agent_debit_note bo, st_lms_agent_transaction_master btm where btm.transaction_id=bo.transaction_id and (bo.transaction_type ='DR_NOTE_CASH' or bo.transaction_type ='DR_NOTE') and  ( date(btm.transaction_date)&gt;=? and date(btm.transaction_date)&lt;=?) group by party_id union all  select ifnull(sum(bo.amount),0.0) amount,party_id  from st_lms_agent_credit_note bo, st_lms_agent_transaction_master btm where btm.transaction_id=bo.transaction_id and (bo.transaction_type ='CR_NOTE_CASH' or bo.transaction_type ='CR_NOTE')  and ( date(btm.transaction_date)&gt;=? and date(btm.transaction_date)&lt;=?) &quot;+ </span>
		&quot; group by party_id  union all 	 select sum(ifnull(cash_amt+credit_note-debit_note+cheque_amt-cheque_bounce_amt,0.00)) amount,retailer_org_id party_id  from st_rep_agent_payments where finaldate&gt;=date(?) and finaldate&lt;=date(?)  group by party_id )a  right join st_lms_organization_master om  on organization_id=a.party_id inner join st_lms_city_master cm on cm.city_name=om.city inner join st_lms_state_master  sm on sm.state_code=om.state_code  inner join st_lms_area_master  am on  am.area_code=om.area_code inner join st_lms_user_master um on um.organization_id=om.organization_id  where (um.termination_date is null or (um.termination_date&gt;=?  or registration_date&gt;= ? ))  and  om.organization_type='RETAILER' and um.isrolehead='Y' &quot;+subQry+&quot; group by sm.state_code&quot;;
				 	
		
<span class="nc" id="L702">		pstmt =con.prepareStatement(str1);</span>
<span class="nc" id="L703">		pstmt.setString(1, anaBean.getStartDate());</span>
<span class="nc" id="L704">		pstmt.setString(2, anaBean.getEndDate());</span>
<span class="nc" id="L705">		pstmt.setString(3, anaBean.getStartDate());</span>
<span class="nc" id="L706">		pstmt.setString(4, anaBean.getEndDate());</span>
<span class="nc" id="L707">		pstmt.setString(5, anaBean.getStartDate());</span>
<span class="nc" id="L708">		pstmt.setString(6, anaBean.getEndDate());</span>
<span class="nc" id="L709">		pstmt.setString(7, anaBean.getStartDate());</span>
<span class="nc" id="L710">		pstmt.setString(8, anaBean.getEndDate());</span>
<span class="nc" id="L711">		pstmt.setString(9, anaBean.getStartDate());</span>
<span class="nc" id="L712">		pstmt.setString(10, anaBean.getEndDate());</span>
<span class="nc" id="L713">		pstmt.setString(11, anaBean.getStartDate());</span>
<span class="nc" id="L714">		pstmt.setString(12, anaBean.getEndDate());</span>
<span class="nc" id="L715">		pstmt.setString(13, anaBean.getStartDate());</span>
<span class="nc" id="L716">		pstmt.setString(14, anaBean.getEndDate());</span>
<span class="nc" id="L717">		logger.debug(&quot;Sale Query&quot;+pstmt);</span>
<span class="nc" id="L718">		rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L719" title="All 2 branches missed.">		while(rs.next()){</span>
<span class="nc" id="L720">			RegionWiseDataBean dataBean =null;</span>
<span class="nc" id="L721">			String stateName = rs.getString(&quot;state_code&quot;);</span>
<span class="nc bnc" id="L722" title="All 2 branches missed.">			if(dataMap.containsKey(stateName)){</span>
<span class="nc" id="L723">				dataBean =dataMap.get(stateName);</span>
<span class="nc" id="L724">				dataBean.setTotalCashAmt(dataBean.getTotalCashAmt()+rs.getDouble(&quot;netAmt&quot;));</span>
				
			}else{
<span class="nc" id="L727">				dataBean = new RegionWiseDataBean();</span>
<span class="nc" id="L728">				dataBean.setStateName(rs.getString(&quot;state&quot;));</span>
<span class="nc" id="L729">				dataBean.setStateCode(rs.getString(&quot;state_code&quot;));</span>
<span class="nc" id="L730">				dataBean.setCityName(rs.getString(&quot;city_name&quot;));</span>
<span class="nc" id="L731">				dataBean.setAreaName(rs.getString(&quot;area_name&quot;));</span>
<span class="nc" id="L732">				dataBean.setTotalCashAmt(rs.getDouble(&quot;netAmt&quot;));</span>
<span class="nc" id="L733">				dataMap.put(stateName, dataBean);</span>
			}
			
			
<span class="nc" id="L737">		}</span>
<span class="nc" id="L738">	}catch (SQLException e) {</span>
<span class="nc" id="L739">		logger.error(&quot;SQL Exception &quot;, e);</span>
<span class="nc" id="L740">		throw new LMSException(LMSErrors.SQL_EXCEPTION_ERROR_CODE,LMSErrors.SQL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="nc" id="L741">	}catch (Exception e) {</span>
<span class="nc" id="L742">		logger.error(&quot; Exception &quot;, e);</span>
<span class="nc" id="L743">		throw new LMSException(LMSErrors.GENERAL_EXCEPTION_ERROR_CODE,LMSErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
	}finally{
<span class="nc" id="L745">		DBConnect.closeRs(rs);</span>
<span class="nc" id="L746">		DBConnect.closePstmt(pstmt);</span>
<span class="nc" id="L747">		DBConnect.closeCon(con);</span>
		
<span class="nc" id="L749">	}</span>
<span class="nc" id="L750">	return dataMap;</span>
}
public static Map&lt;String,RegionWiseDataBean&gt;  fetchRegionWiseRetSaleData(RegionWiseDataBean dataBean,ReportStatusBean reportStatusBean) throws LMSException{
<span class="nc" id="L753">	Connection con =null;</span>
<span class="nc" id="L754">	PreparedStatement pstmt =null;</span>
<span class="nc" id="L755">	Map&lt;String,RegionWiseDataBean&gt; dataMap = new LinkedHashMap&lt;String,RegionWiseDataBean&gt;();</span>
<span class="nc" id="L756">	ResultSet rs = null;</span>
	try{
		
	
<span class="nc" id="L760">		StringBuilder appnQry =new StringBuilder();</span>
<span class="nc" id="L761">		String stateCode =dataBean.getStateCode();</span>
<span class="nc" id="L762">		String cityCode =dataBean.getCityCode();</span>
<span class="nc" id="L763">		String areaCode =dataBean.getAreaCode();</span>
	
<span class="nc" id="L765">		String orgCodeQry=&quot; om.name orgCode,pm.name parentOrgCode &quot;;;</span>
<span class="nc" id="L766">		String appendOrder =&quot;orgCode ASC &quot;;</span>
<span class="nc bnc" id="L767" title="All 4 branches missed.">		if(stateCode!=null&amp;&amp;!stateCode.equalsIgnoreCase(&quot;-1&quot;)){</span>
<span class="nc" id="L768">			appnQry.append(&quot; and sm.state_code='&quot;+stateCode.trim()+&quot;' &quot;);</span>
		
		}
<span class="nc bnc" id="L771" title="All 4 branches missed.">		if(cityCode!=null&amp;&amp;!cityCode.equalsIgnoreCase(&quot;-1&quot;)){</span>
<span class="nc" id="L772">			appnQry.append(&quot; and cm.city_code='&quot;+cityCode.trim()+&quot;' &quot;);</span>
			
		}
<span class="nc bnc" id="L775" title="All 4 branches missed.">		if(areaCode!=null&amp;&amp;!areaCode.equalsIgnoreCase(&quot;-1&quot;)){</span>
<span class="nc" id="L776">			appnQry.append(&quot; and find_in_set(am.area_code,'&quot;+areaCode.trim()+&quot;')&quot;);</span>
			
		}
<span class="nc bnc" id="L779" title="All 2 branches missed.">		if(dataBean.getOrgId()!=-1){</span>
<span class="nc" id="L780">			appnQry.append(&quot; and om.parent_id =&quot;+dataBean.getOrgId());</span>
			
		}
<span class="nc bnc" id="L783" title="All 2 branches missed.">		if (&quot;CODE&quot;.equalsIgnoreCase(Utility.getPropertyValue(&quot;ORG_LIST_TYPE&quot;))) {</span>
<span class="nc" id="L784">			orgCodeQry = &quot; om.org_code orgCode,pm.org_code parentOrgCode &quot;;</span>
		

<span class="nc bnc" id="L787" title="All 2 branches missed.">		} else if (&quot;CODE_NAME&quot;.equalsIgnoreCase(Utility.getPropertyValue(&quot;ORG_LIST_TYPE&quot;))) {</span>
<span class="nc" id="L788">			orgCodeQry = &quot; concat(om.org_code,'_',om.name)  orgCode , concat(pm.org_code,'_',pm.name) parentOrgCode &quot;;</span>
		
			
<span class="nc bnc" id="L791" title="All 2 branches missed.">		} else if (&quot;NAME_CODE&quot;.equalsIgnoreCase(Utility.getPropertyValue(&quot;ORG_LIST_TYPE&quot;))) {</span>
<span class="nc" id="L792">			orgCodeQry = &quot; concat(om.name,'_',om.org_code)  orgCode,concat(pm.name,'_',pm.org_code)  parentOrgCode  &quot;;</span>
		
			
		}
<span class="nc bnc" id="L796" title="All 2 branches missed.">		if( &quot;ORG_ID&quot;.equalsIgnoreCase(Utility.getPropertyValue(&quot;ORG_LIST_ORDER&quot;)) ){</span>
<span class="nc" id="L797">			appendOrder=&quot;om.organization_id&quot;;</span>
			
<span class="nc bnc" id="L799" title="All 2 branches missed.">		}else if( &quot;DESC&quot;.equalsIgnoreCase(Utility.getPropertyValue(&quot;ORG_LIST_ORDER&quot;)) ){</span>
			
<span class="nc" id="L801">			appendOrder=&quot;om.orgCode DESC &quot;;</span>
		}
		
	/*	String str =&quot; select sum(ifnull(main.mrpAmtRet,0.0)-ifnull(sub.mrpAmtRet,0.0)) mrpAmtRet,area_name,city_name,sm.name state,sm.state_code from (select retailer_org_id,sum(net_amt) mrpAmtRet from (select transaction_id from st_lms_retailer_transaction_master where  transaction_type in('DG_SALE','DG_SALE_OFFLINE') and transaction_date&gt;=? and transaction_date&lt;=?) rtm &quot;+
					&quot; inner join st_dg_ret_sale_? retSale on retSale.transaction_id=rtm.transaction_id group by retailer_org_id  ) main left join (select retailer_org_id,sum(net_amt) mrpAmtRet from  (select transaction_id from st_lms_retailer_transaction_master where  transaction_type in('DG_REFUND_CANCEL','DG_REFUND_FAILED') and transaction_date&gt;=? and transaction_date&lt;=?) rtm &quot;+
					&quot;	inner join st_dg_ret_sale_refund_? retRef on retRef.transaction_id=rtm.transaction_id group by retailer_org_id  ) sub on main.retailer_org_id=sub.retailer_org_id right join st_lms_organization_master om on organization_id=main.retailer_org_id inner join st_lms_city_master cm on cm.city_name=om.city  inner join st_lms_state_master  sm on sm.state_code=om.state_code   inner join st_lms_area_master  am on  am.area_code=om.area_code&quot;+ 
					&quot; where organization_status!='TERMINATE'  and  om.organization_type='RETAILER'&quot;+appnQry.toString()+&quot; group by sm.state_code &quot;; */
	/*	String str =&quot; select sum((ifnull(retSale.net_amt,0.00)-ifnull(retRef.net_amt,0.00))) mrpAmtRet,&quot;+orgCodeQry+&quot;,sm.name state,cm.city_name from (select transaction_id,retailer_org_id from st_lms_retailer_transaction_master where  transaction_type in('DG_SALE','DG_SALE_OFFLINE','DG_REFUND_CANCEL','DG_REFUND_FAILED') and transaction_date&gt;=? and transaction_date&lt;=?) rtm &quot;+
					&quot; left join st_dg_ret_sale_? retSale on retSale.transaction_id=rtm.transaction_id left join  st_dg_ret_sale_refund_? retRef on retRef.transaction_id=rtm.transaction_id right join st_lms_organization_master om on organization_id=rtm.retailer_org_id inner join st_lms_organization_master  pm   on pm.organization_id=om.organization_id  inner join st_lms_city_master cm on cm.city_name=om.city &quot;+ 
					&quot;	inner join st_lms_state_master  sm on sm.state_code=om.state_code inner join st_lms_area_master  am on  am.area_code=om.area_code  where  om.organization_status!='TERMINATE'  and  om.organization_type='RETAILER'  &quot;+appnQry+&quot; group by om.organization_id  order by &quot;+appendOrder ;*/
<span class="nc" id="L811">		String str =&quot; select  ifnull(sum(mrpAmtRet),0.0) mrpAmtRet,&quot;+orgCodeQry+&quot;,area_name,city_name,sm.name state,sm.state_code from  ( select sum(ifnull(sale.mrpAmtRet,0.00)-ifnull(ref.mrpAmtRet,0.00)) mrpAmtRet,sale.retailer_org_id from ( select retailer_org_id,sum(mrp_amt) mrpAmtRet from  ( select transaction_id from st_lms_retailer_transaction_master where  transaction_type in('DG_SALE','DG_SALE_OFFLINE') and transaction_date&gt;=? and transaction_date&lt;=? ) rtm inner join st_dg_ret_sale_? retSale on retSale.transaction_id=rtm.transaction_id group by retailer_org_id  ) sale left join (select retailer_org_id,sum(mrp_amt) mrpAmtRet from  (select transaction_id from st_lms_retailer_transaction_master where  transaction_type in('DG_REFUND_CANCEL','DG_REFUND_FAILED')  and transaction_date&gt;=? and transaction_date&lt;=?) rtm inner join st_dg_ret_sale_refund_? retRef on retRef.transaction_id=rtm.transaction_id group by retailer_org_id  ) ref on sale.retailer_org_id=ref.retailer_org_id  group by retailer_org_id union all select mrpAmtRet,retailer_org_id from ( select ifnull(sum(sale_mrp-ref_sale_mrp) ,0.00) mrpAmtRet,organization_id retailer_org_id  from  st_rep_dg_retailer where finaldate&gt;=date(?) and finaldate&lt;=date(?) and game_id=? group by organization_id ) rep group by retailer_org_id )main right join st_lms_organization_master om on organization_id=main.retailer_org_id inner join st_lms_organization_master  pm   on pm.organization_id=om.parent_id  inner join st_lms_city_master cm on cm.city_name=om.city  inner join st_lms_state_master  sm on sm.state_code=om.state_code   inner join st_lms_area_master  am on  am.area_code=om.area_code inner join st_lms_user_master um on um.organization_id=om.organization_id where ( (um.termination_date&gt;=? or um.termination_date is null) and registration_date&lt;=? )  and  om.organization_type='RETAILER' and um.isrolehead='Y'  &quot;+appnQry.toString()+&quot; group by om.organization_id  order by &quot;+appendOrder;</span>
		
<span class="nc bnc" id="L813" title="All 4 branches missed.">		if(&quot;NO&quot;.equals(Utility.getPropertyValue(&quot;IS_DATA_FROM_REPLICA&quot;)) || &quot;MAIN_DB&quot;.equals(reportStatusBean.getReportingFrom()))</span>
<span class="nc" id="L814">			con = DBConnect.getConnection();</span>
		else
<span class="nc" id="L816">			con = DBConnectReplica.getConnection();</span>
<span class="nc" id="L817">		pstmt =con.prepareStatement(str);</span>
<span class="nc" id="L818">		pstmt.setString(1, dataBean.getStartDate());</span>
<span class="nc" id="L819">		pstmt.setString(2, dataBean.getEndDate());</span>
<span class="nc" id="L820">		pstmt.setInt(3, dataBean.getGameId());</span>
<span class="nc" id="L821">		pstmt.setString(4, dataBean.getStartDate());</span>
<span class="nc" id="L822">		pstmt.setString(5, dataBean.getEndDate());</span>
<span class="nc" id="L823">		pstmt.setInt(6, dataBean.getGameId());</span>
<span class="nc" id="L824">		pstmt.setString(7, dataBean.getStartDate());</span>
<span class="nc" id="L825">		pstmt.setString(8, dataBean.getEndDate());</span>
<span class="nc" id="L826">		pstmt.setInt(9, dataBean.getGameId());</span>
<span class="nc" id="L827">		pstmt.setString(10, dataBean.getStartDate());</span>
<span class="nc" id="L828">		pstmt.setString(11,dataBean.getStartDate());</span>
<span class="nc" id="L829">		logger.debug(&quot;Ret Sale Query&quot;+pstmt);</span>
<span class="nc" id="L830">		rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L831" title="All 2 branches missed.">		while(rs.next()){</span>
<span class="nc" id="L832">			RegionWiseDataBean repdataBean =null;</span>
<span class="nc" id="L833">			repdataBean = new RegionWiseDataBean();</span>
<span class="nc" id="L834">			repdataBean.setStateName(rs.getString(&quot;state&quot;));</span>
<span class="nc" id="L835">			repdataBean.setCityName(rs.getString(&quot;city_name&quot;));</span>
<span class="nc" id="L836">			repdataBean.setSaleAmt(rs.getDouble(&quot;mrpAmtRet&quot;));</span>
<span class="nc" id="L837">			repdataBean.setOrgName(rs.getString(&quot;orgCode&quot;));</span>
<span class="nc" id="L838">			repdataBean.setParentOrgName(rs.getString(&quot;parentOrgCode&quot;));</span>
<span class="nc" id="L839">			dataMap.put(rs.getString(&quot;orgCode&quot;), repdataBean);</span>
			
			
<span class="nc" id="L842">		}</span>
		
<span class="nc" id="L844">	}catch (SQLException e) {</span>
<span class="nc" id="L845">		logger.error(&quot;SQL Exception &quot;, e);</span>
<span class="nc" id="L846">		throw new LMSException(LMSErrors.SQL_EXCEPTION_ERROR_CODE,LMSErrors.SQL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="nc" id="L847">	}catch (Exception e) {</span>
<span class="nc" id="L848">		logger.error(&quot; Exception &quot;, e);</span>
<span class="nc" id="L849">		throw new LMSException(LMSErrors.GENERAL_EXCEPTION_ERROR_CODE,LMSErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
	}finally{
<span class="nc" id="L851">		DBConnect.closeCon(con);</span>
<span class="nc" id="L852">		DBConnect.closeRs(rs);</span>
<span class="nc" id="L853">		DBConnect.closePstmt(pstmt);</span>
	
<span class="nc" id="L855">	}</span>
<span class="nc" id="L856">	return dataMap;</span>
}

@Override
public List&lt;SalePwtReportsBean&gt; drawSaleAgentWiseExpand(Timestamp startDate,
		Timestamp endDate, int agentOrgId, ReportStatusBean reportStatusBean,
		String stateCode, String cityCode) throws SQLException {
	// TODO Auto-generated method stub
<span class="nc" id="L864">	return null;</span>
}

@Override
public List&lt;SalePwtReportsBean&gt; drawSaleRetailerWiseExpand(Timestamp startDate,
		Timestamp endDate, int agentOrgId, ReportStatusBean reportStatusBean,
		String stateCode, String cityCode) throws SQLException {
	// TODO Auto-generated method stub
<span class="nc" id="L872">	return null;</span>
}

	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>