<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DGPwtReportHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lms</a> &gt; <a href="index.source.html" class="el_package">com.skilrock.lms.coreEngine.drawGames.reportMgmt</a> &gt; <span class="el_source">DGPwtReportHelper.java</span></div><h1>DGPwtReportHelper.java</h1><pre class="source lang-java linenums">package com.skilrock.lms.coreEngine.drawGames.reportMgmt;

import java.sql.Connection;
import java.sql.Date;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.sql.Timestamp;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.TreeMap;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import com.google.gson.Gson;
import com.skilrock.lms.beans.DateBeans;
import com.skilrock.lms.beans.DirPlrPwtRepBean;
import com.skilrock.lms.beans.PwtDetailsBean;
import com.skilrock.lms.beans.PwtReportBean;
import com.skilrock.lms.beans.ServiceRequest;
import com.skilrock.lms.beans.ServiceResponse;
import com.skilrock.lms.beans.UserInfoBean;
import com.skilrock.lms.common.MyTextProvider;
import com.skilrock.lms.common.db.DBConnect;
import com.skilrock.lms.common.db.QueryManager;
import com.skilrock.lms.common.exception.LMSErrors;
import com.skilrock.lms.common.exception.LMSException;
import com.skilrock.lms.common.filter.LMSFilterDispatcher;
import com.skilrock.lms.common.utility.FormatNumber;
import com.skilrock.lms.coreEngine.service.IServiceDelegate;
import com.skilrock.lms.coreEngine.service.ServiceDelegate;
import com.skilrock.lms.coreEngine.service.dge.ServiceMethodName;
import com.skilrock.lms.coreEngine.service.dge.ServiceName;
import com.skilrock.lms.dge.beans.DrawDataBean;
import com.skilrock.lms.dge.beans.DrawWinTktsBean;
import com.skilrock.lms.dge.beans.GameWinTktDataBean;
import com.skilrock.lms.web.drawGames.common.Util;

public class DGPwtReportHelper  extends MyTextProvider {
<span class="nc" id="L44">	static Log logger = LogFactory.getLog(DGPwtReportHelper.class);</span>
<span class="nc" id="L45">	private Connection con = null;</span>
	private Timestamp end;
	private Date endDate;
	private int OrgId;
<span class="nc" id="L49">	private PreparedStatement pstmt = null;</span>
<span class="nc" id="L50">	private ResultSet rs = null;</span>
	private Timestamp start;
	private Date startDate;

<span class="nc" id="L54">	public DGPwtReportHelper() {</span>

<span class="nc" id="L56">	}</span>

<span class="nc" id="L58">	public DGPwtReportHelper(UserInfoBean userInfoBean, DateBeans dateBeans) {</span>
<span class="nc" id="L59">		this.startDate = dateBeans.getFirstdate();</span>
<span class="nc" id="L60">		start = new Timestamp(startDate.getTime());</span>
<span class="nc" id="L61">		this.endDate = dateBeans.getLastdate();</span>
<span class="nc" id="L62">		end = new Timestamp(endDate.getTime());</span>
<span class="nc" id="L63">		this.OrgId = userInfoBean.getUserOrgId();</span>
<span class="nc" id="L64">	}</span>

	public Map&lt;Integer, String&gt; ajaxAgentListForPwt() throws LMSException {
<span class="nc" id="L67">		Map&lt;Integer, String&gt; map = new TreeMap&lt;Integer, String&gt;();</span>
<span class="nc" id="L68">		con = DBConnect.getConnection();</span>
		try {
<span class="nc" id="L70">			PreparedStatement pstmt = con</span>
					.prepareStatement(&quot;select name, organization_id from st_lms_organization_master where organization_type='AGENT'&quot;);

<span class="nc" id="L73">			logger.debug(&quot;get the DG sale detail query -- &quot; + pstmt);</span>

<span class="nc" id="L75">			ResultSet rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L77" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L78">				map.put(rs.getInt(&quot;organization_id&quot;), rs.getString(&quot;name&quot;));</span>
			}

<span class="nc" id="L81">		} catch (SQLException e) {</span>
<span class="nc" id="L82">			logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L83">			e.printStackTrace();</span>
<span class="nc" id="L84">			throw new LMSException(e);</span>
		} finally {
<span class="nc" id="L86">			try {</span>
<span class="nc bnc" id="L87" title="All 8 branches missed.">				if (con != null &amp;&amp; !con.isClosed()) {</span>
<span class="nc" id="L88">					con.close();</span>
				}
<span class="nc" id="L90">			} catch (SQLException e) {</span>
<span class="nc" id="L91">				logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L92">				e.printStackTrace();</span>
<span class="nc" id="L93">				throw new LMSException(e);</span>
<span class="nc" id="L94">			}</span>
		}
<span class="nc" id="L96">		return map;</span>
	}

	@SuppressWarnings(&quot;unchecked&quot;)
	public List&lt;PwtDetailsBean&gt; fetchClaimTicketData(String agtOrgName,
			String filter) {
<span class="nc" id="L102">		con = DBConnect.getConnection();</span>
<span class="nc" id="L103">		StringBuilder orgIdList = null;</span>
<span class="nc" id="L104">		String query = null;</span>
<span class="nc" id="L105">		List&lt;PwtDetailsBean&gt; pwtDetailsBean = new ArrayList&lt;PwtDetailsBean&gt;();</span>
<span class="nc" id="L106">		List&lt;PwtDetailsBean&gt; dirPlrBean = new ArrayList&lt;PwtDetailsBean&gt;();</span>
<span class="nc" id="L107">		PwtDetailsBean detailBean = null;</span>
<span class="nc" id="L108">		String subQuery = &quot;&quot;;</span>
<span class="nc" id="L109">		List&lt;Integer&gt; gameNumList = Util.getGameNumberList();</span>
		try {
<span class="nc bnc" id="L111" title="All 2 branches missed.">			if (!&quot;Game Wise&quot;.equalsIgnoreCase(filter)) {</span>
<span class="nc" id="L112">				String selQry = &quot;&quot;;</span>
<span class="nc" id="L113">				orgIdList = new StringBuilder(&quot;&quot;);</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">				if (&quot;Agent Wise&quot;.equalsIgnoreCase(filter)) {</span>
<span class="nc" id="L115">					selQry = &quot;select organization_id from st_lms_organization_master where parent_id =(select organization_id from st_lms_organization_master where name=?)&quot;;</span>

<span class="nc bnc" id="L117" title="All 2 branches missed.">				} else if (&quot;Retailer Wise&quot;.equalsIgnoreCase(filter)) {</span>
<span class="nc" id="L118">					selQry = &quot;select organization_id from st_lms_organization_master where name=?&quot;;</span>
				}
<span class="nc" id="L120">				pstmt = con.prepareStatement(selQry);</span>
<span class="nc" id="L121">				pstmt.setString(1, agtOrgName);</span>
<span class="nc" id="L122">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L124">					orgIdList.append(rs.getInt(&quot;organization_id&quot;) + &quot;,&quot;);</span>
				}
<span class="nc bnc" id="L126" title="All 2 branches missed.">				if (orgIdList.length() &gt; 1) {</span>
<span class="nc" id="L127">					orgIdList.deleteCharAt(orgIdList.length() - 1);</span>
				}
<span class="nc" id="L129">				subQuery = &quot;and retailer_org_id in (&quot; + orgIdList + &quot;)&quot;;</span>

			}

<span class="nc bnc" id="L133" title="All 2 branches missed.">			for (int i = 0; i &lt; gameNumList.size(); i++) {</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">				if (&quot;Agent Wise&quot;.equalsIgnoreCase(filter)) {</span>
<span class="nc" id="L135">					query = &quot;select sum(amount) amount, sum(totTkt) totTkt,prize,game_id from (select sum(pwt_amt) amount,count(pwt_amt) totTkt,pwt_amt prize,game_id,' ' from st_dg_ret_pwt_&quot;</span>
							+ gameNumList.get(i)
							+ &quot; sdrp where sdrp.transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_date&gt;='&quot;
							+ new java.sql.Date(startDate.getTime())
							+ &quot;'and transaction_date&lt;'&quot;
							+ new java.sql.Date(endDate.getTime())
							+ &quot;' &quot;
							+ subQuery
							+ &quot;) and status='DONE_CLM' group by game_id,pwt_amt union select sum(pwt_amt) amount,count(pwt_amt) totTkt,pwt_amt prize,game_id,'DP' from  st_dg_agt_direct_plr_pwt sdrp where sdrp.transaction_id in (select transaction_id from st_lms_agent_transaction_master where transaction_date&gt;='&quot;
							+ new java.sql.Date(startDate.getTime())
							+ &quot;' and transaction_date&lt;'&quot;
							+ new java.sql.Date(endDate.getTime())
							+ &quot;' ) and game_id=&quot;
							+ gameNumList.get(i)
							+ &quot; and sdrp.agent_org_id=(select organization_id from st_lms_organization_master where name='&quot;
							+ agtOrgName
							+ &quot;') group by game_id,pwt_amt) a  group by game_id,prize order by prize&quot;;
				} else {
<span class="nc" id="L153">					query = &quot;select sum(pwt_amt) amount,count(pwt_amt) totTkt,pwt_amt prize,game_id from st_dg_ret_pwt_&quot;</span>
							+ gameNumList.get(i)
							+ &quot; sdrp where sdrp.transaction_id in (select transaction_id from st_lms_retailer_transaction_master where transaction_date&gt;='&quot;
							+ new java.sql.Date(startDate.getTime())
							+ &quot;'and transaction_date&lt;'&quot;
							+ new java.sql.Date(endDate.getTime())
							+ &quot;' &quot;
							+ subQuery
							+ &quot;) and status='DONE_CLM' group by game_id,pwt_amt order by prize&quot;;
				}
<span class="nc" id="L163">				pstmt = con.prepareStatement(query);</span>
<span class="nc" id="L164">				logger.debug(&quot;Pwt Details****&quot; + pstmt);</span>
<span class="nc" id="L165">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L167">					detailBean = new PwtDetailsBean();</span>
<span class="nc" id="L168">					detailBean.setAmount(rs.getString(&quot;amount&quot;));</span>
<span class="nc" id="L169">					detailBean.setNoOfTkt(rs.getInt(&quot;totTkt&quot;));</span>
<span class="nc" id="L170">					detailBean.setPrize(rs.getString(&quot;prize&quot;));</span>
<span class="nc" id="L171">					detailBean.setGameName(Util.getGameDisplayName(rs</span>
							.getInt(&quot;game_id&quot;)));
<span class="nc" id="L173">					detailBean.setPlayerName(agtOrgName);</span>
<span class="nc" id="L174">					pwtDetailsBean.add(detailBean);</span>
				}

			}

			/*
			 * if (&quot;Agent Wise&quot;.equalsIgnoreCase(filter)) { dirPlrQry = &quot;select
			 * sum(pwt_amt) amount,count(pwt_amt) totTkt,pwt_amt
			 * prize,game_id,agent_org_id from st_dg_agt_direct_plr_pwt sdrp
			 * where sdrp.transaction_id in (select transaction_id from
			 * st_lms_agent_transaction_master where transaction_date&gt;='&quot; +
			 * startDate + &quot;'and transaction_date&lt;'&quot; + endDate + &quot;' and
			 * sdrp.agent_org_id in (&quot; + orgIdList + &quot;)) group by
			 * game_id,pwt_amt order by prize&quot;; } else if (&quot;Retailer
			 * Wise&quot;.equalsIgnoreCase(filter)) { //selQry = &quot;select
			 * organization_id from st_lms_organization_master where name=?&quot;; }
			 * pstmt = con.prepareStatement(dirPlrQry); rs =
			 * pstmt.executeQuery(); while (rs.next()) { detailBean = new
			 * PwtDetailsBean(); detailBean.setAmount(rs.getString(&quot;amount&quot;));
			 * detailBean.setNoOfTkt(rs.getInt(&quot;totTkt&quot;));
			 * detailBean.setPrize(rs.getString(&quot;prize&quot;));
			 * detailBean.setGameName(Util.getGameName(rs .getInt(&quot;game_id&quot;)));
			 * detailBean.setPlayerName(agtOrgName); dirPlrBean.add(detailBean); }
			 */

<span class="nc" id="L199">		} catch (Exception e) {</span>
<span class="nc" id="L200">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L202">			try {</span>
<span class="nc" id="L203">				con.close();</span>
<span class="nc" id="L204">			} catch (SQLException e) {</span>
<span class="nc" id="L205">				e.printStackTrace();</span>
<span class="nc" id="L206">			}</span>
<span class="nc" id="L207">		}</span>

<span class="nc" id="L209">		return pwtDetailsBean;</span>
	}

	public List&lt;DirPlrPwtRepBean&gt; getDirPlrPwtDetailAgentWise() {
<span class="nc" id="L213">		List&lt;DirPlrPwtRepBean&gt; amtList = new ArrayList&lt;DirPlrPwtRepBean&gt;();</span>
<span class="nc" id="L214">		con = DBConnect.getConnection();</span>
		try {
<span class="nc" id="L216">			String dirPwtRepQuery = QueryManager</span>
					.getST_DG_DIR_PLR_PWT_REPORT_AGENT_WISE_BO();
<span class="nc" id="L218">			PreparedStatement pstmt = con.prepareStatement(dirPwtRepQuery);</span>
			/*
			 * pstmt.setDate(1, ); ResultSet rs1 = pstmt.executeQuery();
			 * 
			 * while(rs1.next()){ bean = new DirPlrPwtRepBean();
			 * bean.setRetName(rs1.getString(&quot;&quot;));
			 * bean.setPwtAmtClm(rs1.getDouble(&quot;&quot;)); }
			 */
<span class="nc" id="L226">		} catch (SQLException e) {</span>
<span class="nc" id="L227">			logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L228">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L230">			try {</span>

<span class="nc bnc" id="L232" title="All 12 branches missed.">				if (con != null &amp;&amp; !con.isClosed()) {</span>
<span class="nc" id="L233">					con.close();</span>
				}
<span class="nc" id="L235">			} catch (SQLException e) {</span>
<span class="nc" id="L236">				logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L237">				e.printStackTrace();</span>
<span class="nc" id="L238">			}</span>
<span class="nc" id="L239">		}</span>
<span class="nc" id="L240">		return amtList;</span>
	}

	public List&lt;DirPlrPwtRepBean&gt; getDirPlrPwtDetailGameWise() {
<span class="nc" id="L244">		List&lt;DirPlrPwtRepBean&gt; amtList = new ArrayList&lt;DirPlrPwtRepBean&gt;();</span>
<span class="nc" id="L245">		con = DBConnect.getConnection();</span>
<span class="nc" id="L246">		DirPlrPwtRepBean bean = null;</span>
<span class="nc" id="L247">		DirPlrPwtRepBean totalBean = null;</span>
<span class="nc" id="L248">		double totPwtAmt = 0.0;</span>
		try {
<span class="nc" id="L250">			String dirPwtRepQuery = QueryManager</span>
					.getST_DG_DIR_PLR_PWT_REPORT_GAME_WISE_BO();
<span class="nc" id="L252">			PreparedStatement pstmt = con.prepareStatement(dirPwtRepQuery);</span>
<span class="nc" id="L253">			pstmt.setDate(1, new java.sql.Date(start.getTime()));</span>
<span class="nc" id="L254">			pstmt.setDate(2, new java.sql.Date(end.getTime()));</span>
<span class="nc" id="L255">			ResultSet rs1 = pstmt.executeQuery();</span>
<span class="nc" id="L256">			logger.debug(&quot;get Direct Plr PWT Rep Query Game wise for BO -- &quot;</span>
					+ pstmt);
<span class="nc bnc" id="L258" title="All 2 branches missed.">			while (rs1.next()) {</span>
<span class="nc" id="L259">				bean = new DirPlrPwtRepBean();</span>
<span class="nc" id="L260">				bean.setGameName(rs1.getString(&quot;game_name&quot;));</span>
<span class="nc" id="L261">				bean.setPwtAmtClm(rs1.getDouble(&quot;total_pwt&quot;));</span>
<span class="nc" id="L262">				totPwtAmt += rs1.getDouble(&quot;total_pwt&quot;);</span>
<span class="nc" id="L263">				amtList.add(bean);</span>
			}
<span class="nc" id="L265">			totalBean = new DirPlrPwtRepBean();</span>
<span class="nc" id="L266">			totalBean.setGameName(&quot;Total&quot;);</span>
<span class="nc" id="L267">			totalBean.setPwtAmtClm(totPwtAmt);</span>
<span class="nc" id="L268">			amtList.add(totalBean);</span>
<span class="nc" id="L269">		} catch (SQLException e) {</span>
<span class="nc" id="L270">			logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L271">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L273">			try {</span>

<span class="nc bnc" id="L275" title="All 12 branches missed.">				if (con != null &amp;&amp; !con.isClosed()) {</span>
<span class="nc" id="L276">					con.close();</span>
				}
<span class="nc" id="L278">			} catch (SQLException e) {</span>
<span class="nc" id="L279">				logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L280">				e.printStackTrace();</span>
<span class="nc" id="L281">			}</span>
<span class="nc" id="L282">		}</span>
<span class="nc" id="L283">		return amtList;</span>
	}

	public String getOrgAdd(int orgId) throws LMSException {
<span class="nc" id="L287">		String orgAdd = &quot;&quot;;</span>
<span class="nc" id="L288">		Connection con = null;</span>
<span class="nc" id="L289">		con = DBConnect.getConnection();</span>
<span class="nc" id="L290">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L291">		ResultSet rs = null;</span>
		try {
<span class="nc" id="L293">			pstmt = con</span>
					.prepareStatement(&quot;select addr_line1, addr_line2, city from st_lms_organization_master where organization_id = ?&quot;);
<span class="nc" id="L295">			pstmt.setInt(1, orgId);</span>
<span class="nc" id="L296">			rs = pstmt.executeQuery();</span>
<span class="nc" id="L297">			logger.debug(pstmt);</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L299">				orgAdd = rs.getString(&quot;addr_line1&quot;) + &quot;, &quot;</span>
						+ rs.getString(&quot;addr_line2&quot;) + &quot;, &quot;
						+ rs.getString(&quot;city&quot;);
			}
<span class="nc" id="L303">		} catch (SQLException e) {</span>
<span class="nc" id="L304">			logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L305">			e.printStackTrace();</span>
<span class="nc" id="L306">			throw new LMSException(e);</span>
		} finally {
<span class="nc" id="L308">			try {</span>
<span class="nc bnc" id="L309" title="All 8 branches missed.">				if (con != null &amp;&amp; !con.isClosed()) {</span>
<span class="nc" id="L310">					con.close();</span>
				}
<span class="nc" id="L312">			} catch (SQLException e) {</span>
<span class="nc" id="L313">				logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L314">				e.printStackTrace();</span>
<span class="nc" id="L315">				throw new LMSException(e);</span>
<span class="nc" id="L316">			}</span>
		}
<span class="nc" id="L318">		return orgAdd;</span>
	}

	public List&lt;PwtReportBean&gt; getPwtDetailAgentWise() {

<span class="nc" id="L323">		List&lt;PwtReportBean&gt; list = new ArrayList&lt;PwtReportBean&gt;();</span>
<span class="nc" id="L324">		PwtReportBean reportbean = null;</span>
<span class="nc" id="L325">		PwtReportBean totalBean = null;</span>
<span class="nc" id="L326">		double totPwtAmt = 0.0;</span>
<span class="nc" id="L327">		con = DBConnect.getConnection();</span>

		try {

			// pstmt=con.prepareStatement(QueryManager.getST_PWT_REPORT_BO());
<span class="nc" id="L332">			String orgCodeQry = &quot; name orgCode  &quot;;</span>

			
<span class="nc bnc" id="L335" title="All 2 branches missed.">			if ((LMSFilterDispatcher.orgFieldType).equalsIgnoreCase(&quot;CODE&quot;)) {</span>
<span class="nc" id="L336">				orgCodeQry = &quot; org_code orgCode &quot;;</span>
	

<span class="nc bnc" id="L339" title="All 2 branches missed.">			} else if ((LMSFilterDispatcher.orgFieldType)</span>
					.equalsIgnoreCase(&quot;CODE_NAME&quot;)) {
<span class="nc" id="L341">				orgCodeQry = &quot; concat(org_code,'_',name)  orgCode &quot;;</span>
			

<span class="nc bnc" id="L344" title="All 2 branches missed.">			} else if ((LMSFilterDispatcher.orgFieldType)</span>
					.equalsIgnoreCase(&quot;NAME_CODE&quot;)) {
<span class="nc" id="L346">				orgCodeQry = &quot; concat(name,'_',org_code)  orgCode &quot;;</span>
			

			}	
<span class="nc" id="L350">			pstmt = con</span>
					.prepareStatement(&quot;select sum(pwt_amt) pwt_amt,&quot;+orgCodeQry+&quot; from st_dg_bo_pwt sdbp,st_lms_bo_transaction_master slbtm,st_lms_organization_master slom where sdbp.transaction_id=slbtm.transaction_id and (slbtm.transaction_date&gt;=? and slbtm.transaction_date&lt;?) and slom.organization_id=sdbp.agent_org_id group by agent_org_id order by &quot;+QueryManager.getAppendOrgOrder());
<span class="nc" id="L352">			pstmt.setDate(1, startDate);</span>
<span class="nc" id="L353">			pstmt.setDate(2, endDate);</span>
<span class="nc" id="L354">			rs = pstmt.executeQuery();</span>
<span class="nc" id="L355">			logger.debug(&quot; get pwt details query- ==== -&quot; + pstmt);</span>
<span class="nc bnc" id="L356" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L357">				reportbean = new PwtReportBean();</span>
<span class="nc" id="L358">				reportbean.setClmMrp(FormatNumber.formatNumber(rs</span>
						.getDouble(&quot;pwt_amt&quot;)));
<span class="nc" id="L360">				totPwtAmt += rs.getDouble(&quot;pwt_amt&quot;);</span>
<span class="nc" id="L361">				reportbean.setAgentName(rs.getString(&quot;orgCode&quot;));</span>
<span class="nc" id="L362">				list.add(reportbean);</span>
			}
<span class="nc" id="L364">			totalBean = new PwtReportBean();</span>
<span class="nc" id="L365">			totalBean.setAgentName(&quot;Total&quot;);</span>
<span class="nc" id="L366">			totalBean.setClmMrp(FormatNumber.formatNumber(totPwtAmt));</span>
<span class="nc" id="L367">			list.add(totalBean);</span>

<span class="nc" id="L369">		} catch (SQLException e) {</span>
<span class="nc" id="L370">			logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L371">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L373">			try {</span>

<span class="nc bnc" id="L375" title="All 12 branches missed.">				if (con != null &amp;&amp; !con.isClosed()) {</span>
<span class="nc" id="L376">					con.close();</span>
				}
<span class="nc" id="L378">			} catch (SQLException e) {</span>
<span class="nc" id="L379">				logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L380">				e.printStackTrace();</span>
<span class="nc" id="L381">			}</span>
<span class="nc" id="L382">		}</span>
<span class="nc" id="L383">		return list;</span>
	}

	/**
	 * It is called when BO want to get the PWT details 'Game Wise'
	 * 
	 * @param gameStatus
	 * @return List&lt;GameWisePWTBean&gt;
	 */

	public List&lt;PwtReportBean&gt; getPwtDetailGameWise() {
<span class="nc" id="L394">		List&lt;PwtReportBean&gt; list = new ArrayList&lt;PwtReportBean&gt;();</span>
<span class="nc" id="L395">		con = DBConnect.getConnection();</span>
<span class="nc" id="L396">		PwtReportBean reportbean = null;</span>
<span class="nc" id="L397">		PwtReportBean totalBean = null;</span>
<span class="nc" id="L398">		double totPwtAmt = 0.0;</span>
		try {
<span class="nc" id="L400">			PreparedStatement pst = con.prepareStatement(QueryManager</span>
					.getST_DG_PWT_REPORT_GAME_WISE_BO());
<span class="nc" id="L402">			pst.setDate(1, startDate);</span>
<span class="nc" id="L403">			pst.setDate(2, endDate);</span>
<span class="nc" id="L404">			pst.setDate(3, startDate);</span>
<span class="nc" id="L405">			pst.setDate(4, endDate);</span>
<span class="nc" id="L406">			pst.setDate(5, startDate);</span>
<span class="nc" id="L407">			pst.setDate(6, endDate);</span>
<span class="nc" id="L408">			pst.setDate(7, startDate);</span>
<span class="nc" id="L409">			pst.setDate(8, endDate);</span>
<span class="nc" id="L410">			ResultSet rss = pst.executeQuery();</span>
<span class="nc" id="L411">			logger.debug(&quot;get Player PWT query : == &quot; + pst);</span>
<span class="nc bnc" id="L412" title="All 2 branches missed.">			while (rss.next()) {</span>
<span class="nc" id="L413">				reportbean = new PwtReportBean();</span>
<span class="nc" id="L414">				reportbean.setClmMrp(FormatNumber.formatNumber(rss</span>
						.getDouble(&quot;agtMrpClaimed&quot;)));
<span class="nc" id="L416">				totPwtAmt += rss.getDouble(&quot;agtMrpClaimed&quot;);</span>
<span class="nc" id="L417">				reportbean.setUnclmMrp(FormatNumber.formatNumber(rss</span>
						.getDouble(&quot;agtMrpUnclm&quot;)));
<span class="nc" id="L419">				reportbean.setGameName(rss.getString(&quot;gamename&quot;));</span>
<span class="nc" id="L420">				list.add(reportbean);</span>
			}
<span class="nc" id="L422">			totalBean = new PwtReportBean();</span>
<span class="nc" id="L423">			totalBean.setGameName(&quot;Total&quot;);</span>
<span class="nc" id="L424">			totalBean.setClmMrp(FormatNumber.formatNumber(totPwtAmt));</span>
<span class="nc" id="L425">			list.add(totalBean);</span>

<span class="nc" id="L427">		} catch (SQLException e) {</span>
<span class="nc" id="L428">			logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L429">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L431">			try {</span>

<span class="nc bnc" id="L433" title="All 12 branches missed.">				if (con != null &amp;&amp; !con.isClosed()) {</span>
<span class="nc" id="L434">					con.close();</span>
				}
<span class="nc" id="L436">			} catch (SQLException e) {</span>
<span class="nc" id="L437">				logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L438">				e.printStackTrace();</span>
<span class="nc" id="L439">			}</span>
<span class="nc" id="L440">		}</span>

		// logger.debug(list);
<span class="nc" id="L443">		return list;</span>
	}

	public List&lt;PwtReportBean&gt; getPwtDetailRetailerWise(int agtId) {
<span class="nc" id="L447">		List&lt;PwtReportBean&gt; list = new ArrayList&lt;PwtReportBean&gt;();</span>
<span class="nc" id="L448">		PwtReportBean reportbean = null;</span>
<span class="nc" id="L449">		PwtReportBean totalBean = null;</span>
<span class="nc" id="L450">		double totPwtAmt = 0.0;</span>
<span class="nc" id="L451">		con = DBConnect.getConnection();</span>
		try {
<span class="nc" id="L453">			String orgCodeQry = &quot; name orgCode  &quot;;</span>

			
<span class="nc bnc" id="L456" title="All 2 branches missed.">			if ((LMSFilterDispatcher.orgFieldType).equalsIgnoreCase(&quot;CODE&quot;)) {</span>
<span class="nc" id="L457">				orgCodeQry = &quot; org_code orgCode &quot;;</span>
	

<span class="nc bnc" id="L460" title="All 2 branches missed.">			} else if ((LMSFilterDispatcher.orgFieldType)</span>
					.equalsIgnoreCase(&quot;CODE_NAME&quot;)) {
<span class="nc" id="L462">				orgCodeQry = &quot; concat(org_code,'_',name)  orgCode &quot;;</span>
			

<span class="nc bnc" id="L465" title="All 2 branches missed.">			} else if ((LMSFilterDispatcher.orgFieldType)</span>
					.equalsIgnoreCase(&quot;NAME_CODE&quot;)) {
<span class="nc" id="L467">				orgCodeQry = &quot; concat(name,'_',org_code)  orgCode &quot;;</span>
			

			}	
<span class="nc" id="L471">			PreparedStatement pst = con.prepareStatement(&quot;select top.orgCode,  myn.pwtMrpClm as pwtMrpClm, myn.pwtMrpUnclm as pwtMrpUnclm from (select lef.retailer_org_id, ifnull(lef.pwtMrpClm,0) as pwtMrpClm, ifnull(righ.pwtMrpUnclm,0) as pwtMrpUnclm from (select dgpclm.retailer_org_id, ifnull(sum(pwtMrpClm),0) as pwtMrpClm from (select transaction_id, user_org_id from st_lms_agent_transaction_master where (date(transaction_date)&gt;=? and date(transaction_date)&lt;?) and (transaction_type='DG_PWT' or transaction_type='DG_PWT_AUTO'))as main, (select transaction_id, agent_org_id, retailer_org_id, pwt_amt as pwtMrpClm from st_dg_agt_pwt where status='DONE_CLM') as dgpclm where main.transaction_id = dgpclm.transaction_id  and main.user_org_id = dgpclm.agent_org_id and dgpclm.agent_org_id = ? group by dgpclm.retailer_org_id) as lef left outer join (select dgpUnclm.retailer_org_id, ifnull(sum(pwtMrpUnclm),0) as pwtMrpUnclm from (select transaction_id, user_org_id from st_lms_agent_transaction_master where (date(transaction_date)&gt;=? and date(transaction_date)&lt;?) and (transaction_type='DG_PWT' or transaction_type='DG_PWT_AUTO'))as main, (select transaction_id, agent_org_id, retailer_org_id, pwt_amt as pwtMrpUnclm from st_dg_agt_pwt where status='CLAIM_BAL' or status = 'UNCLAIM_BAL') as dgpUnclm where main.transaction_id = dgpUnclm.transaction_id  and main.user_org_id = dgpUnclm.agent_org_id and dgpUnclm.agent_org_id = ? group by dgpUnclm.retailer_org_id)as righ on lef.retailer_org_id = righ.retailer_org_id)as myn,(select organization_id, &quot;+orgCodeQry+&quot; from st_lms_organization_master where organization_type='RETAILER')as top where top.organization_id = myn.retailer_org_id&quot;);</span>
<span class="nc" id="L472">			pst.setDate(1, startDate);</span>
<span class="nc" id="L473">			pst.setDate(2, endDate);</span>
<span class="nc" id="L474">			pst.setInt(3, agtId);</span>
<span class="nc" id="L475">			pst.setDate(4, startDate);</span>
<span class="nc" id="L476">			pst.setDate(5, endDate);</span>
<span class="nc" id="L477">			pst.setInt(6, agtId);</span>
<span class="nc" id="L478">			ResultSet rss = pst.executeQuery();</span>
<span class="nc" id="L479">			logger.debug(&quot;get Player PWT query : == &quot; + pst);</span>
<span class="nc bnc" id="L480" title="All 2 branches missed.">			while (rss.next()) {</span>
<span class="nc" id="L481">				reportbean = new PwtReportBean();</span>
<span class="nc" id="L482">				reportbean.setClmMrp(FormatNumber.formatNumber(rss</span>
						.getDouble(&quot;pwtMrpClm&quot;)));
<span class="nc" id="L484">				totPwtAmt += rss.getDouble(&quot;pwtMrpClm&quot;);</span>
<span class="nc" id="L485">				reportbean.setUnclmMrp(FormatNumber.formatNumber(rss</span>
						.getDouble(&quot;pwtMrpUnclm&quot;)));
<span class="nc" id="L487">				reportbean.setRetName(rss.getString(&quot;orgCode&quot;));</span>
<span class="nc" id="L488">				list.add(reportbean);</span>
			}
<span class="nc" id="L490">			totalBean = new PwtReportBean();</span>
<span class="nc" id="L491">			totalBean.setRetName(&quot;Total&quot;);</span>
<span class="nc" id="L492">			totalBean.setClmMrp(FormatNumber.formatNumber(totPwtAmt));</span>
<span class="nc" id="L493">			list.add(totalBean);</span>
<span class="nc" id="L494">		} catch (SQLException e) {</span>
<span class="nc" id="L495">			logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L496">			e.printStackTrace();</span>
<span class="nc" id="L497">		}</span>
<span class="nc" id="L498">		DBConnect.closeCon(con);</span>
<span class="nc" id="L499">		return list;</span>
	}
	public Map&lt;Integer, DrawWinTktsBean&gt; fetchRetailerWiseWinningTicketsInfo(DrawDataBean drawDataBean,Map&lt;String,String&gt; orgCodeNameMap,Map&lt;String,String&gt; paymentDateMap,Map&lt;String,String&gt; parentOrgNameMap) 
	throws LMSException{
<span class="nc" id="L503">		ArrayList&lt;Integer&gt; retUserIdList=null;</span>
<span class="nc" id="L504">		Connection con=null;</span>
<span class="nc" id="L505">		Map&lt;Integer,DrawWinTktsBean&gt; drawBeanMap = null;</span>
<span class="nc" id="L506">		GameWinTktDataBean gameWinTktDataBean=null;</span>
		try{
<span class="nc" id="L508">			con=DBConnect.getConnection();</span>
<span class="nc" id="L509">			retUserIdList=fetchRetailirUserIdList(drawDataBean.getAgentOrgId(), con);</span>
<span class="nc" id="L510">			drawDataBean.setRetailerUserIdList(retUserIdList);</span>
<span class="nc" id="L511">			ServiceRequest serReq = new ServiceRequest();</span>
<span class="nc" id="L512">			serReq.setServiceName(ServiceName.REPORTS_MGMT);</span>
<span class="nc" id="L513">			serReq.setServiceMethod(ServiceMethodName.FETCH_WINNING_TICKET_DATA);</span>
<span class="nc" id="L514">			serReq.setServiceData(drawDataBean);</span>
<span class="nc" id="L515">			IServiceDelegate delegate =ServiceDelegate.getInstance(); </span>
<span class="nc" id="L516">			ServiceResponse serResp=delegate.getResponse(serReq);</span>
<span class="nc bnc" id="L517" title="All 2 branches missed.">			if(serResp.getIsSuccess()){</span>
<span class="nc" id="L518">				gameWinTktDataBean  = new Gson().fromJson(serResp.getResponseData().toString(), GameWinTktDataBean.class);</span>
<span class="nc" id="L519">				drawBeanMap=gameWinTktDataBean.getDrawMap();</span>
<span class="nc bnc" id="L520" title="All 4 branches missed.">				if(!drawBeanMap.isEmpty() &amp;&amp; gameWinTktDataBean.getUserIdDetailList().size()&gt;0){</span>
<span class="nc" id="L521">					fetchOrgCodeName(gameWinTktDataBean.getUserIdDetailList(),con,orgCodeNameMap,parentOrgNameMap);</span>
<span class="nc" id="L522">					fetchClamiemedAtOrgCodeMap(gameWinTktDataBean.getClaimetAtBoTickets(),gameWinTktDataBean.getClaimetAtAgtTickets(),gameWinTktDataBean.getClaimetAtRetTickets(),drawDataBean.getGameNo(),con,paymentDateMap);</span>
				}else{
<span class="nc" id="L524">					throw new LMSException(LMSErrors.NO_RECORD_FOUND_ERROR_CODE,getText(&quot;msg.no.record&quot;));</span>
				}	
			}else{
<span class="nc" id="L527">				throw new LMSException(LMSErrors.GENERAL_EXCEPTION_ERROR_CODE,LMSErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
			}
<span class="nc" id="L529">		} catch (LMSException e) {</span>
<span class="nc" id="L530">			throw e;</span>
<span class="nc" id="L531">		}catch (Exception e) {</span>
<span class="nc" id="L532">			e.printStackTrace();</span>
<span class="nc" id="L533">			throw new LMSException(LMSErrors.GENERAL_EXCEPTION_ERROR_CODE,LMSErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
		}finally{
<span class="nc" id="L535">			DBConnect.closeCon(con);</span>
<span class="nc" id="L536">		}</span>
<span class="nc" id="L537">		return drawBeanMap;</span>
	}
	

	public ArrayList&lt;Integer&gt; fetchRetailirUserIdList(int agentOrgId,Connection con) throws LMSException{
<span class="nc" id="L542">		ArrayList&lt;Integer&gt; retUserIdList=new ArrayList&lt;Integer&gt;();</span>
<span class="nc" id="L543">		Statement stmt=null;</span>
<span class="nc" id="L544">		ResultSet rs=null;</span>
<span class="nc" id="L545">		String qry=null;</span>
		try{
<span class="nc bnc" id="L547" title="All 2 branches missed.">			if(agentOrgId &gt; 0){</span>
<span class="nc" id="L548">				con =DBConnect.getConnection();</span>
<span class="nc" id="L549">				qry=&quot;SELECT user_id FROM st_lms_user_master um INNER JOIN st_lms_organization_master om  ON om.organization_id=um.organization_id WHERE parent_id=&quot;+agentOrgId+&quot; AND om.organization_type='RETAILER'&quot;;</span>
<span class="nc" id="L550">				stmt=con.createStatement();</span>
<span class="nc" id="L551">				rs=stmt.executeQuery(qry);</span>
<span class="nc bnc" id="L552" title="All 2 branches missed.">				if(rs.next()) {</span>
<span class="nc" id="L553">					rs.beforeFirst();</span>
<span class="nc bnc" id="L554" title="All 2 branches missed.">					while(rs.next()){</span>
<span class="nc" id="L555">						retUserIdList.add(rs.getInt(&quot;user_id&quot;));</span>
					}
				} else {
<span class="nc" id="L558">					throw new LMSException(LMSErrors.NO_RECORD_FOUND_ERROR_CODE,getText(&quot;msg.no.record&quot;));</span>
				}
<span class="nc" id="L560">				logger.info(&quot;Retailers For Agent: &quot;+agentOrgId+&quot;:- &quot;+retUserIdList);</span>
			
				}	
<span class="nc" id="L563">		} catch (SQLException e) {</span>
<span class="nc" id="L564">			throw new LMSException(LMSErrors.SQL_EXCEPTION_ERROR_CODE,LMSErrors.SQL_EXCEPTION_ERROR_MESSAGE);</span>
		}finally{
<span class="nc" id="L566">			DBConnect.closeConnection(stmt, rs);</span>
<span class="nc" id="L567">		}</span>
<span class="nc" id="L568">		return retUserIdList;</span>
	}
	
	public void fetchOrgCodeName(Set&lt;String&gt; retUserIdSet,Connection con, Map&lt;String,String&gt; orgCodeNameMap,Map&lt;String,String&gt; parentOrgNameMap) throws LMSException {
<span class="nc" id="L572">		Statement stmt=null;</span>
<span class="nc" id="L573">		ResultSet rs=null;</span>
<span class="nc" id="L574">		String qry=null;</span>
<span class="nc" id="L575">		List&lt;String&gt; parentUserIdlist=new ArrayList&lt;String&gt;();</span>
		try{
<span class="nc" id="L577">			qry= &quot;SELECT user_id,concat(org_code,'_',om.name) orgCode,parent_user_id FROM  st_lms_organization_master om INNER JOIN st_lms_user_master um ON om.organization_id=um.organization_id  where um.user_id  in (&quot;+ retUserIdSet.toString().substring(1,retUserIdSet.toString().lastIndexOf(&quot;]&quot;)) + &quot;)&quot;;</span>
<span class="nc" id="L578">			stmt=con.createStatement();</span>
<span class="nc" id="L579">			rs=stmt.executeQuery(qry);</span>
<span class="nc bnc" id="L580" title="All 2 branches missed.">			while(rs.next()){</span>
<span class="nc" id="L581">				orgCodeNameMap.put(rs.getString(&quot;user_id&quot;),rs.getString(&quot;orgCode&quot;));</span>
<span class="nc" id="L582">				parentUserIdlist.add(rs.getString(&quot;parent_user_id&quot;));</span>
			}
<span class="nc" id="L584">			qry=&quot; SELECT user_id,concat(ch.org_code,'_',ch.name) orgCode,parent_user_id FROM  st_lms_organization_master om INNER JOIN st_lms_user_master um ON om.organization_id=um.organization_id  inner join st_lms_organization_master ch on ch.organization_id=.om.parent_id where om.organization_type='RETAILER'  and parent_user_id  IN (&quot;+ parentUserIdlist.toString().substring(1,parentUserIdlist.toString().lastIndexOf(&quot;]&quot;)) + &quot;)&quot;;</span>
<span class="nc" id="L585">			stmt=con.createStatement();</span>
<span class="nc" id="L586">			rs=stmt.executeQuery(qry);</span>
<span class="nc bnc" id="L587" title="All 2 branches missed.">			while(rs.next()){</span>
<span class="nc" id="L588">				parentOrgNameMap.put(rs.getString(&quot;user_id&quot;), rs.getString(&quot;orgCode&quot;));</span>
			}
<span class="nc" id="L590">		}catch (SQLException e) {</span>
<span class="nc" id="L591">			e.printStackTrace();</span>
<span class="nc" id="L592">			throw new LMSException(LMSErrors.SQL_EXCEPTION_ERROR_CODE,LMSErrors.SQL_EXCEPTION_ERROR_MESSAGE);</span>
		}
		finally{
<span class="nc" id="L595">			DBConnect.closeConnection(stmt, rs);</span>
<span class="nc" id="L596">		}</span>
<span class="nc" id="L597">	}</span>
	
	public void fetchClamiemedAtOrgCodeMap(Set&lt;String&gt; claimedByBoTktSet,Set&lt;String&gt; claimedByAgtTktSet,Set&lt;String&gt; claimedByRetTktSet,int gameId,Connection con,Map&lt;String, String&gt; paymentDateMap) throws LMSException{
<span class="nc" id="L600">		Statement stmt=null;</span>
<span class="nc" id="L601">		ResultSet rs=null;</span>
<span class="nc" id="L602">		String boPaymentateDateQry=null;</span>
<span class="nc" id="L603">		String agtPaymentDateQry=null;</span>
<span class="nc" id="L604">		String retPaymentDateQry=null;</span>
		try {
<span class="nc" id="L606">			stmt=con.createStatement();</span>
<span class="nc bnc" id="L607" title="All 2 branches missed.">			if(claimedByBoTktSet.size()&gt;0){</span>
<span class="nc" id="L608">				boPaymentateDateQry=&quot;SELECT ticket_nbr,transaction_date from st_dg_pwt_inv_&quot;+gameId+&quot;  dpi INNER JOIN  st_lms_bo_transaction_master btm ON dpi.bo_transaction_id=btm.transaction_id where ticket_nbr IN(&quot;+ claimedByBoTktSet.toString().substring(1,claimedByBoTktSet.toString().lastIndexOf(&quot;]&quot;))+&quot;)&quot;;</span>
<span class="nc" id="L609">				rs=stmt.executeQuery(boPaymentateDateQry);</span>
<span class="nc bnc" id="L610" title="All 2 branches missed.">				while(rs.next()){</span>
<span class="nc" id="L611">					paymentDateMap.put(rs.getString(&quot;ticket_nbr&quot;), rs.getString(&quot;transaction_date&quot;).replace(&quot;.0&quot;, &quot;&quot;));</span>
				}
			}
<span class="nc bnc" id="L614" title="All 2 branches missed.">			if(claimedByAgtTktSet.size()&gt;0){</span>
<span class="nc" id="L615">				agtPaymentDateQry=&quot;SELECT ticket_nbr,transaction_date from st_dg_pwt_inv_&quot;+gameId+&quot;  dpi INNER JOIN  st_lms_agent_transaction_master atm ON dpi.agent_transaction_id=atm.transaction_id where ticket_nbr IN(&quot;+ claimedByAgtTktSet.toString().substring(1,claimedByAgtTktSet.toString().lastIndexOf(&quot;]&quot;))+&quot;)&quot;;</span>
<span class="nc" id="L616">				rs=stmt.executeQuery(agtPaymentDateQry);</span>
<span class="nc bnc" id="L617" title="All 2 branches missed.">				while(rs.next()){</span>
<span class="nc" id="L618">					paymentDateMap.put(rs.getString(&quot;ticket_nbr&quot;), rs.getString(&quot;transaction_date&quot;).replace(&quot;.0&quot;, &quot;&quot;));</span>
				}
			}
<span class="nc bnc" id="L621" title="All 2 branches missed.">			if(claimedByRetTktSet.size()&gt;0){</span>
<span class="nc" id="L622">				retPaymentDateQry=&quot;SELECT ticket_nbr,transaction_date from st_dg_pwt_inv_&quot;+gameId+&quot;  dpi INNER JOIN  st_lms_retailer_transaction_master rtm ON dpi.retailer_transaction_id=rtm.transaction_id where ticket_nbr IN(&quot;+ claimedByRetTktSet.toString().substring(1,claimedByRetTktSet.toString().lastIndexOf(&quot;]&quot;))+&quot;)&quot;;</span>
<span class="nc" id="L623">				rs=stmt.executeQuery(retPaymentDateQry);</span>
<span class="nc bnc" id="L624" title="All 2 branches missed.">				while(rs.next()){</span>
<span class="nc" id="L625">					paymentDateMap.put(rs.getString(&quot;ticket_nbr&quot;), rs.getString(&quot;transaction_date&quot;).replace(&quot;.0&quot;, &quot;&quot;));</span>
				}
			}
<span class="nc" id="L628">		} catch (SQLException e) {</span>
<span class="nc" id="L629">			throw new LMSException(LMSErrors.SQL_EXCEPTION_ERROR_CODE,LMSErrors.SQL_EXCEPTION_ERROR_MESSAGE);</span>
		}finally{
<span class="nc" id="L631">			DBConnect.closeConnection(stmt, rs);</span>
<span class="nc" id="L632">		}</span>
<span class="nc" id="L633">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>