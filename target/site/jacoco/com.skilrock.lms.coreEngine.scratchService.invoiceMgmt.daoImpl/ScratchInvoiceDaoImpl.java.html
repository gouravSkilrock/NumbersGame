<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ScratchInvoiceDaoImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lms</a> &gt; <a href="index.source.html" class="el_package">com.skilrock.lms.coreEngine.scratchService.invoiceMgmt.daoImpl</a> &gt; <span class="el_source">ScratchInvoiceDaoImpl.java</span></div><h1>ScratchInvoiceDaoImpl.java</h1><pre class="source lang-java linenums">package com.skilrock.lms.coreEngine.scratchService.invoiceMgmt.daoImpl;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Set;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import com.skilrock.lms.beans.BookSaleBean;
import com.skilrock.lms.common.db.QueryManager;
import com.skilrock.lms.common.exception.LMSException;
import com.skilrock.lms.common.utility.CommonMethods;
import com.skilrock.lms.common.utility.GenerateRecieptNo;
import com.skilrock.lms.common.utility.OrgCreditUpdation;
import com.skilrock.lms.coreEngine.scratchService.common.ScratchErrors;
import com.skilrock.lms.coreEngine.scratchService.common.ScratchException;
import com.skilrock.lms.coreEngine.scratchService.common.beans.InvoiceMethodValueMaster;
import com.skilrock.lms.coreEngine.scratchService.common.beans.OrderGameBookBeanMaster;
import com.skilrock.lms.coreEngine.scratchService.inventoryMgmt.common.DirectSaleBOHelper;
import com.skilrock.lms.web.drawGames.common.Util;

<span class="nc" id="L35">public class ScratchInvoiceDaoImpl {</span>

<span class="nc" id="L37">	static Log logger = LogFactory.getLog(ScratchInvoiceDaoImpl.class);</span>

	// Done
	public InvoiceMethodValueMaster fetchInvoiceMethod(int gameId, Connection con) throws ScratchException {
<span class="nc" id="L41">		Statement stmt = null;</span>
<span class="nc" id="L42">		ResultSet rs = null;</span>
<span class="nc" id="L43">		InvoiceMethodValueMaster invoiceMethodValueMaster = null;</span>
		try {
<span class="nc" id="L45">			stmt = con.createStatement();</span>
<span class="nc" id="L46">			rs = stmt.executeQuery(&quot;select scheme_type, scheme_value_type, scheme_value from st_se_game_master gm inner join st_se_invoicing_methods im on gm.invoice_scheme_id = im.invoice_method_id where game_id = &quot; + gameId + &quot; and game_status = 'OPEN';&quot;);</span>
<span class="nc bnc" id="L47" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L48">				invoiceMethodValueMaster = new InvoiceMethodValueMaster();</span>
<span class="nc" id="L49">				invoiceMethodValueMaster.setInvoiceMethodName(rs.getString(&quot;scheme_type&quot;));</span>
<span class="nc" id="L50">				invoiceMethodValueMaster.setValue(rs.getString(&quot;scheme_value&quot;));</span>
<span class="nc" id="L51">				invoiceMethodValueMaster.setValueType(rs.getString(&quot;scheme_value_type&quot;));</span>
			} else {
<span class="nc" id="L53">				throw new ScratchException(ScratchErrors.SCRATCH_GAME_NOT_AVAILABLE_ERROR_CODE, ScratchErrors.SCRATCH_GAME_NOT_AVAILABLE_ERROR_MESSAGE);</span>
			}
<span class="nc" id="L55">		} catch (SQLException e) {</span>
<span class="nc" id="L56">			e.printStackTrace();</span>
<span class="nc" id="L57">			throw new ScratchException(ScratchErrors.SQL_EXCEPTION_ERROR_CODE, ScratchErrors.SQL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="nc" id="L58">		} catch (ScratchException e) {</span>
<span class="nc" id="L59">			throw e;</span>
<span class="nc" id="L60">		} catch (Exception e) {</span>
<span class="nc" id="L61">			throw new ScratchException(ScratchErrors.GENERAL_EXCEPTION_ERROR_CODE, ScratchErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="nc" id="L62">		}</span>
<span class="nc" id="L63">		return invoiceMethodValueMaster;</span>
	}

	// Done
	public InvoiceMethodValueMaster fetchInvoiceMethod(int gameId, int orgId, Connection con) throws ScratchException {
<span class="nc" id="L68">		Statement stmt = null;</span>
<span class="nc" id="L69">		ResultSet rs = null;</span>
<span class="nc" id="L70">		InvoiceMethodValueMaster invoiceMethodValueMaster = null;</span>
		try {
<span class="nc" id="L72">			stmt = con.createStatement();</span>
//			rs = stmt.executeQuery(&quot;select SQL_CACHE scheme_type, scheme_value_type, scheme_value from st_se_game_master gm inner join st_se_org_game_invoice_methods gim on gim.game_id = gm.game_id inner join st_se_invoicing_methods im on im.invoice_method_id = gim.invoice_method_id where gm.game_id = &quot; + gameId + &quot; and game_status = 'OPEN' and gim.organization_id = &quot; + orgId + &quot;;&quot;);
<span class="nc" id="L74">			rs = stmt.executeQuery(&quot;select SQL_CACHE scheme_type, scheme_value_type, invoice_method_value from st_se_game_master gm inner join st_se_org_game_invoice_methods gim on gim.game_id = gm.game_id inner join st_se_invoicing_methods im on im.invoice_method_id = gim.invoice_method_id where gm.game_id = &quot; + gameId + &quot; and game_status = 'OPEN' and gim.organization_id = &quot; + orgId + &quot;;&quot;);</span>
<span class="nc bnc" id="L75" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L76">				invoiceMethodValueMaster = new InvoiceMethodValueMaster();</span>
<span class="nc" id="L77">				invoiceMethodValueMaster.setInvoiceMethodName(rs.getString(&quot;scheme_type&quot;));</span>
<span class="nc" id="L78">				invoiceMethodValueMaster.setValue(rs.getString(&quot;invoice_method_value&quot;));</span>
<span class="nc" id="L79">				invoiceMethodValueMaster.setValueType(rs.getString(&quot;scheme_value_type&quot;));</span>
			} else {
<span class="nc" id="L81">				throw new ScratchException(ScratchErrors.SCRATCH_GAME_NOT_AVAILABLE_ERROR_CODE, ScratchErrors.SCRATCH_GAME_NOT_AVAILABLE_ERROR_MESSAGE);</span>
			}
<span class="nc" id="L83">		} catch (SQLException e) {</span>
<span class="nc" id="L84">			e.printStackTrace();</span>
<span class="nc" id="L85">			throw new ScratchException(ScratchErrors.SQL_EXCEPTION_ERROR_CODE, ScratchErrors.SQL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="nc" id="L86">		} catch (ScratchException e) {</span>
<span class="nc" id="L87">			throw e;</span>
<span class="nc" id="L88">		} catch (Exception e) {</span>
<span class="nc" id="L89">			throw new ScratchException(ScratchErrors.GENERAL_EXCEPTION_ERROR_CODE, ScratchErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="nc" id="L90">		}</span>
<span class="nc" id="L91">		return invoiceMethodValueMaster;</span>
	}

	// Done
	public void generateScratchInvoiceAndDeductBalance(Connection con) throws ScratchException {
<span class="nc" id="L96">		Map&lt;Integer, Map&lt;Integer, OrderGameBookBeanMaster&gt;&gt; orderGameOrgBookMap = null;</span>
		try {
<span class="nc" id="L98">			orderGameOrgBookMap = fetchBookForInvoice(con);</span>

<span class="nc bnc" id="L100" title="All 2 branches missed.">			for (Map.Entry&lt;Integer, Map&lt;Integer, OrderGameBookBeanMaster&gt;&gt; gameBookEntry : orderGameOrgBookMap.entrySet()) {</span>
<span class="nc" id="L101">				checkAndUpdateForInvoice(gameBookEntry.getKey(), gameBookEntry.getValue(), con);</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">				if(!gameBookEntry.getValue().isEmpty())</span>
<span class="nc" id="L103">					generateInvoice(gameBookEntry.getKey(), gameBookEntry.getValue(), con);</span>
<span class="nc" id="L104">			}</span>
<span class="nc" id="L105">		} catch (ScratchException e) {</span>
<span class="nc" id="L106">			throw e;</span>
<span class="nc" id="L107">		} catch (Exception e) {</span>
<span class="nc" id="L108">			e.printStackTrace();</span>
<span class="nc" id="L109">			throw new ScratchException(ScratchErrors.GENERAL_EXCEPTION_ERROR_CODE, ScratchErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="nc" id="L110">		}</span>
<span class="nc" id="L111">	}</span>

	public Map&lt;Integer, Map&lt;Integer, OrderGameBookBeanMaster&gt;&gt; fetchBookForInvoice(Connection con) throws ScratchException {
<span class="nc" id="L114">		Statement stmt = null;</span>
<span class="nc" id="L115">		ResultSet rs = null;</span>
<span class="nc" id="L116">		List&lt;String&gt; bookList = null;</span>
<span class="nc" id="L117">		OrderGameBookBeanMaster orderGameBookBeanMaster = null;</span>
<span class="nc" id="L118">		Map&lt;Integer, OrderGameBookBeanMaster&gt; gameOrgBookMap = null;</span>
<span class="nc" id="L119">		Map&lt;Integer, Map&lt;Integer, OrderGameBookBeanMaster&gt;&gt; orderGameOrgBookMap = new HashMap&lt;Integer, Map&lt;Integer, OrderGameBookBeanMaster&gt;&gt;();</span>
		try {
<span class="nc" id="L121">			stmt = con.createStatement();</span>
<span class="nc" id="L122">			rs = stmt.executeQuery(&quot;select order_id, game_id, pack_nbr, book_nbr, current_owner_id, book_receive_reg_date_ret, book_activation_date_ret, first_ticket_claim_date, total_low_win_tier_tickets, total_low_win_tier_tickets_claimed, book_status from st_se_game_inv_status where current_owner = 'RETAILER' and ret_invoice_id is null and agent_invoice_id is null;&quot;);</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">				if (orderGameOrgBookMap.containsKey(rs.getInt(&quot;current_owner_id&quot;))) {</span>
<span class="nc" id="L125">					gameOrgBookMap = orderGameOrgBookMap.get(rs.getInt(&quot;current_owner_id&quot;));</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">					if (gameOrgBookMap.containsKey(rs.getInt(&quot;game_id&quot;))) {</span>
<span class="nc" id="L127">						bookList = orderGameOrgBookMap.get(rs.getInt(&quot;current_owner_id&quot;)).get(rs.getInt(&quot;game_id&quot;)).getBookList();</span>
<span class="nc" id="L128">						bookList.add(rs.getString(&quot;book_nbr&quot;));</span>
<span class="nc" id="L129">						orderGameOrgBookMap.get(rs.getInt(&quot;current_owner_id&quot;)).get(rs.getInt(&quot;game_id&quot;)).setBookList(bookList);</span>
					} else {
<span class="nc" id="L131">						gameOrgBookMap = new HashMap&lt;Integer, OrderGameBookBeanMaster&gt;();</span>
<span class="nc" id="L132">						orderGameBookBeanMaster = new OrderGameBookBeanMaster();</span>
<span class="nc" id="L133">						bookList = new ArrayList&lt;String&gt;();</span>

<span class="nc" id="L135">						bookList.add(rs.getString(&quot;book_nbr&quot;));</span>
//						orderGameBookBeanMaster.setOrderId(rs.getInt(&quot;order_id&quot;));
<span class="nc" id="L137">						orderGameBookBeanMaster.setBookList(bookList);</span>

<span class="nc" id="L139">						orderGameOrgBookMap.get(rs.getInt(&quot;current_owner_id&quot;)).put(rs.getInt(&quot;game_id&quot;), orderGameBookBeanMaster);</span>
					}
				} else {
<span class="nc" id="L142">					gameOrgBookMap = new HashMap&lt;Integer, OrderGameBookBeanMaster&gt;();</span>
<span class="nc" id="L143">					orderGameBookBeanMaster = new OrderGameBookBeanMaster();</span>
<span class="nc" id="L144">					bookList = new ArrayList&lt;String&gt;();</span>

<span class="nc" id="L146">					bookList.add(rs.getString(&quot;book_nbr&quot;));</span>
//					orderGameBookBeanMaster.setOrderId(rs.getInt(&quot;order_id&quot;));
<span class="nc" id="L148">					orderGameBookBeanMaster.setBookList(bookList);</span>

<span class="nc" id="L150">					gameOrgBookMap.put(rs.getInt(&quot;game_id&quot;), orderGameBookBeanMaster);</span>

<span class="nc" id="L152">					orderGameOrgBookMap.put(rs.getInt(&quot;current_owner_id&quot;), gameOrgBookMap);</span>
				}
			}
<span class="nc" id="L155">		} catch (SQLException e) {</span>
<span class="nc" id="L156">			e.printStackTrace();</span>
<span class="nc" id="L157">			throw new ScratchException(ScratchErrors.SQL_EXCEPTION_ERROR_CODE, ScratchErrors.SQL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="nc" id="L158">		} catch (Exception e) {</span>
<span class="nc" id="L159">			e.printStackTrace();</span>
<span class="nc" id="L160">			throw new ScratchException(ScratchErrors.GENERAL_EXCEPTION_ERROR_CODE, ScratchErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="nc" id="L161">		}</span>
<span class="nc" id="L162">		return orderGameOrgBookMap;</span>
	}

	// Done
	private void generateInvoice(int orgId, Map&lt;Integer, OrderGameBookBeanMaster&gt; gameBookMap, Connection con) throws ScratchException {
		try {
<span class="nc" id="L168">			con.setAutoCommit(false);</span>
<span class="nc" id="L169">			generateInvoiceForAgent(orgId, gameBookMap, null, con);</span>
<span class="nc" id="L170">			generateInvoiceForRetailer(orgId, gameBookMap, null, con);</span>
<span class="nc" id="L171">			con.commit();</span>
<span class="nc" id="L172">		} catch (ScratchException e) {</span>
<span class="nc" id="L173">			throw e;</span>
<span class="nc" id="L174">		} catch (Exception e) {</span>
<span class="nc" id="L175">			e.printStackTrace();</span>
<span class="nc" id="L176">			throw new ScratchException(ScratchErrors.GENERAL_EXCEPTION_ERROR_CODE, ScratchErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="nc" id="L177">		}</span>
<span class="nc" id="L178">	}</span>

	public String getInvoiceReceiptFromInvoiceId(String userType, int invoiceId, Connection connection) throws ScratchException {
<span class="nc" id="L181">		Statement stmt = null;</span>
<span class="nc" id="L182">		ResultSet rs = null;</span>

<span class="nc" id="L184">		String invoiceReceipt = null;</span>
<span class="nc" id="L185">		String query = null;</span>
		try {
<span class="nc bnc" id="L187" title="All 2 branches missed.">			String tableName = &quot;BO&quot;.equals(userType) ? &quot;st_lms_bo_receipts&quot; : &quot;st_lms_agent_receipts&quot;;</span>
<span class="nc" id="L188">			stmt = connection.createStatement();</span>
<span class="nc" id="L189">			query = &quot;SELECT generated_id FROM &quot;+tableName+&quot; WHERE receipt_id=&quot;+invoiceId+&quot;;&quot;;</span>
<span class="nc" id="L190">			logger.info(&quot;getInvoiceReceiptFromInvoiceId - &quot;+query);</span>
<span class="nc" id="L191">			rs = stmt.executeQuery(query);</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">			if(rs.next())</span>
<span class="nc" id="L193">				invoiceReceipt = rs.getString(&quot;generated_id&quot;);</span>
<span class="nc" id="L194">		} catch (SQLException e) {</span>
<span class="nc" id="L195">			e.printStackTrace();</span>
<span class="nc" id="L196">			throw new ScratchException(ScratchErrors.SQL_EXCEPTION_ERROR_CODE, ScratchErrors.SQL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="nc" id="L197">		} catch (Exception e) {</span>
<span class="nc" id="L198">			e.printStackTrace();</span>
<span class="nc" id="L199">			throw new ScratchException(ScratchErrors.GENERAL_EXCEPTION_ERROR_CODE, ScratchErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="nc" id="L200">		}</span>

<span class="nc" id="L202">		return invoiceReceipt;</span>
	}

	public void checkAndUpdateForInvoice(Map&lt;Integer, OrderGameBookBeanMaster&gt; gameBookMap, Connection connection) throws ScratchException {
<span class="nc" id="L206">		Statement stmt = null;</span>
<span class="nc" id="L207">		ResultSet rs = null;</span>
<span class="nc" id="L208">		String query = null;</span>
		try {
<span class="nc" id="L210">			int gameId = 0;</span>
<span class="nc" id="L211">			List&lt;String&gt; bookList = null;</span>

<span class="nc" id="L213">			stmt = connection.createStatement();</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">			for(Map.Entry&lt;Integer, OrderGameBookBeanMaster&gt; entry : gameBookMap.entrySet()) {</span>
<span class="nc" id="L215">				gameId = entry.getKey();</span>
<span class="nc" id="L216">				bookList = entry.getValue().getBookList();</span>
<span class="nc" id="L217">				query = &quot;SELECT book_nbr FROM st_se_game_inv_status WHERE book_nbr IN (&quot;+bookList.toString().replace(&quot;[&quot;, &quot;'&quot;).replace(&quot;,&quot;, &quot;','&quot;).replace(&quot;]&quot;, &quot;'&quot;).replace(&quot; &quot;, &quot;&quot;)+&quot;) AND agent_invoice_id&lt;&gt;'NULL' AND ret_invoice_id&lt;&gt;'NULL' AND game_id=&quot;+gameId+&quot;;&quot;;</span>
<span class="nc" id="L218">				logger.info(&quot;checkAndUpdateForInvoice - &quot;+query);</span>
<span class="nc" id="L219">				rs = stmt.executeQuery(query);</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">				while(rs.next())</span>
<span class="nc" id="L221">					bookList.remove(rs.getString(&quot;book_nbr&quot;));</span>

<span class="nc bnc" id="L223" title="All 2 branches missed.">				if(bookList.size() == 0)</span>
<span class="nc" id="L224">					gameBookMap.remove(gameId);</span>
<span class="nc" id="L225">			}</span>
<span class="nc" id="L226">		} catch (SQLException e) {</span>
<span class="nc" id="L227">			e.printStackTrace();</span>
<span class="nc" id="L228">			throw new ScratchException(ScratchErrors.SQL_EXCEPTION_ERROR_CODE, ScratchErrors.SQL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="nc" id="L229">		} catch (Exception e) {</span>
<span class="nc" id="L230">			e.printStackTrace();</span>
<span class="nc" id="L231">			throw new ScratchException(ScratchErrors.GENERAL_EXCEPTION_ERROR_CODE, ScratchErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="nc" id="L232">		}</span>
<span class="nc" id="L233">	}</span>

	// Done
	public void checkAndUpdateForInvoice(int orgId, Map&lt;Integer, OrderGameBookBeanMaster&gt; gameBookMap, Connection con) throws ScratchException {
<span class="nc" id="L237">		Statement stmt = null;</span>
<span class="nc" id="L238">		ResultSet rs = null;</span>
<span class="nc" id="L239">		StringBuilder bookNbr = new StringBuilder();</span>
<span class="nc" id="L240">		InvoiceMethodValueMaster invoiceMethodValueMaster = null;</span>
<span class="nc" id="L241">		long dayCount = 0;</span>
<span class="nc" id="L242">		List&lt;Integer&gt; gameIdToRemove = new ArrayList&lt;Integer&gt;();</span>
		try {
<span class="nc bnc" id="L244" title="All 2 branches missed.">			for (Map.Entry&lt;Integer, OrderGameBookBeanMaster&gt; bookMap : gameBookMap.entrySet()) {</span>
<span class="nc" id="L245">				bookNbr.setLength(0);</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">				for (String str : bookMap.getValue().getBookList()) {</span>
<span class="nc" id="L247">					bookNbr.append(&quot;'&quot;);</span>
<span class="nc" id="L248">					bookNbr.append(str);</span>
<span class="nc" id="L249">					bookNbr.append(&quot;',&quot;);</span>
<span class="nc" id="L250">				}</span>

<span class="nc bnc" id="L252" title="All 2 branches missed.">				if (bookMap.getValue().getBookList().size() &gt; 0) {</span>
<span class="nc" id="L253">					bookNbr.setLength(bookNbr.length() - 1);</span>
				}

<span class="nc" id="L256">				invoiceMethodValueMaster = fetchInvoiceMethod(bookMap.getKey(), orgId, con);</span>
				
<span class="nc" id="L258">				stmt = con.createStatement();</span>
<span class="nc" id="L259">				rs = stmt.executeQuery(&quot;select game_id, book_nbr, current_owner_id, cur_rem_tickets, active_tickets_upto, book_receive_reg_date_ret, book_activation_date_ret, first_ticket_claim_date, total_low_win_tier_tickets, total_low_win_tier_tickets_claimed, book_status from st_se_game_inv_status where current_owner = 'RETAILER' and game_id = &quot; + bookMap.getKey() + &quot; and book_nbr in (&quot; + bookNbr.toString() + &quot;) and ret_invoice_id is null and agent_invoice_id is null;&quot;);</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">					if (&quot;AFTER_BOOK_RECEIVE_DAYS&quot;.equals(invoiceMethodValueMaster.getInvoiceMethodName())) {</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">						if (!&quot;FIXED&quot;.equals(invoiceMethodValueMaster.getValueType())) {</span>
<span class="nc" id="L263">							throw new ScratchException(ScratchErrors.SCRATCH_INVALID_INVOICE_MENTHOD_VALUE_TYPE_ERROR_CODE, ScratchErrors.SCRATCH_INVALID_INVOICE_MENTHOD_VALUE_TYPE_ERROR_MESSAGE);</span>
						} else {
<span class="nc" id="L265">							dayCount = (Calendar.getInstance().getTime().getTime() / (24 * 60 * 60 * 1000))- new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;).parse(rs.getString(&quot;book_receive_reg_date_ret&quot;)).getTime() / (24 * 60 * 60 * 1000);</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">							if (dayCount &gt;= Long.parseLong(invoiceMethodValueMaster.getValue())) {</span>
								// Generate invoice
							} else {
<span class="nc" id="L269">								bookMap.getValue().getBookList().remove(rs.getString(&quot;book_nbr&quot;));</span>
							}
						}
<span class="nc bnc" id="L272" title="All 2 branches missed.">					} else if (&quot;ON_SALES_RET&quot;.equals(invoiceMethodValueMaster.getInvoiceMethodName())) {</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">						if (&quot;BOOLEAN&quot;.equals(invoiceMethodValueMaster.getValueType())) {</span>
<span class="nc" id="L274">							throw new ScratchException(ScratchErrors.SCRATCH_INVALID_INVOICE_MENTHOD_VALUE_TYPE_ERROR_CODE, ScratchErrors.SCRATCH_INVALID_INVOICE_MENTHOD_VALUE_TYPE_ERROR_MESSAGE);</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">						} else if (&quot;FIXED&quot;.equals(invoiceMethodValueMaster.getValueType())) {</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">							if (rs.getInt(&quot;active_tickets_upto&quot;) &gt;= Integer.parseInt(invoiceMethodValueMaster.getValue())) {</span>
								// Generate invoice
							} else {
<span class="nc" id="L279">								bookMap.getValue().getBookList().remove(rs.getString(&quot;book_nbr&quot;));</span>
							}
<span class="nc bnc" id="L281" title="All 2 branches missed.">						} else if (&quot;PERCENTAGE&quot;.equals(invoiceMethodValueMaster.getValueType())) {</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">							if (((rs.getInt(&quot;active_tickets_upto&quot;) * 100) / (rs.getInt(&quot;active_tickets_upto&quot;) + rs.getInt(&quot;cur_rem_tickets&quot;))) &gt;= Integer.parseInt(invoiceMethodValueMaster.getValue())) {</span>
								// Generate invoice
							} else {
<span class="nc" id="L285">								bookMap.getValue().getBookList().remove(rs.getString(&quot;book_nbr&quot;));</span>
							}
						}
<span class="nc bnc" id="L288" title="All 2 branches missed.">					} else if (&quot;AFTER_DAYS_ACTIVATION&quot;.equals(invoiceMethodValueMaster.getInvoiceMethodName())) {</span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">						if (!&quot;FIXED&quot;.equals(invoiceMethodValueMaster.getValueType())) {</span>
<span class="nc" id="L290">							throw new ScratchException(ScratchErrors.SCRATCH_INVALID_INVOICE_MENTHOD_VALUE_TYPE_ERROR_CODE, ScratchErrors.SCRATCH_INVALID_INVOICE_MENTHOD_VALUE_TYPE_ERROR_MESSAGE);</span>
						} else {
<span class="nc" id="L292">							dayCount = (Calendar.getInstance().getTime().getTime() / (24 * 60 * 60 * 1000)) - new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;).parse(rs.getString(&quot;book_activation_date_ret&quot;)).getTime() / (24 * 60 * 60 * 1000);</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">							if (dayCount &gt;= Long.parseLong(invoiceMethodValueMaster.getValue())) {</span>
								//Generate invoice
							} else {
<span class="nc" id="L296">								bookMap.getValue().getBookList().remove(rs.getString(&quot;book_nbr&quot;));</span>
							}
						}
<span class="nc bnc" id="L299" title="All 2 branches missed.">					} else if (&quot;ON_WIN_CLAIM_RET&quot;.equals(invoiceMethodValueMaster.getInvoiceMethodName())) {</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">						if (&quot;BOOLEAN&quot;.equals(invoiceMethodValueMaster.getValueType())) {</span>
<span class="nc" id="L301">							throw new ScratchException(ScratchErrors.SCRATCH_INVALID_INVOICE_MENTHOD_VALUE_TYPE_ERROR_CODE, ScratchErrors.SCRATCH_INVALID_INVOICE_MENTHOD_VALUE_TYPE_ERROR_MESSAGE);</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">						} else if (&quot;FIXED&quot;.equals(invoiceMethodValueMaster.getValueType())) {</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">							if (rs.getInt(&quot;total_low_win_tier_tickets_claimed&quot;) &gt;= Integer.parseInt(invoiceMethodValueMaster.getValue())) {</span>
								//Generate invoice
							} else {
<span class="nc" id="L306">								bookMap.getValue().getBookList().remove(rs.getString(&quot;book_nbr&quot;));</span>
							}
<span class="nc bnc" id="L308" title="All 2 branches missed.">						} else if (&quot;PERCENTAGE&quot;.equals(invoiceMethodValueMaster.getValueType())) {</span>
<span class="nc bnc" id="L309" title="All 2 branches missed.">							if (((rs.getInt(&quot;total_low_win_tier_tickets_claimed&quot;) * 100) / rs.getInt(&quot;total_low_win_tier_tickets&quot;)) &gt;= Integer.parseInt(invoiceMethodValueMaster.getValue())) {</span>
								//Generate invoice
							} else {
<span class="nc" id="L312">								bookMap.getValue().getBookList().remove(rs.getString(&quot;book_nbr&quot;));</span>
							}
						}
					}
				}
<span class="nc bnc" id="L317" title="All 2 branches missed.">				if(bookMap.getValue().getBookList().size() == 0) {</span>
<span class="nc" id="L318">					gameIdToRemove.add(bookMap.getKey());</span>
				}
<span class="nc" id="L320">			}</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">			for(Integer gameid : gameIdToRemove) </span>
<span class="nc" id="L322">				gameBookMap.remove(gameid);</span>
<span class="nc" id="L323">		} catch (SQLException e) {</span>
<span class="nc" id="L324">			e.printStackTrace();</span>
<span class="nc" id="L325">			throw new ScratchException(ScratchErrors.SQL_EXCEPTION_ERROR_CODE, ScratchErrors.SQL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="nc" id="L326">		} catch (Exception e) {</span>
<span class="nc" id="L327">			e.printStackTrace();</span>
<span class="nc" id="L328">			throw new ScratchException(ScratchErrors.GENERAL_EXCEPTION_ERROR_CODE, ScratchErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="nc" id="L329">		}</span>
<span class="nc" id="L330">	}</span>

	// Done
	private List&lt;Integer&gt; fetchParentUserAndOrgId(int orgId, Connection con) throws ScratchException {
<span class="nc" id="L334">		List&lt;Integer&gt; list = null;</span>

<span class="nc" id="L336">		Statement stmt = null;</span>
<span class="nc" id="L337">		ResultSet rs = null;</span>
		try {
<span class="nc" id="L339">			stmt = con.createStatement();</span>
<span class="nc" id="L340">			rs = stmt</span>
					.executeQuery(&quot;select parent.user_id, parent.organization_id from st_lms_user_master child inner join st_lms_user_master parent on child.parent_user_id = parent.user_id where child.organization_id = &quot;
							+ orgId + &quot; and parent.isrolehead = 'Y'&quot;);
<span class="nc bnc" id="L343" title="All 2 branches missed.">			if(rs.next()) {</span>
<span class="nc" id="L344">				list = new ArrayList&lt;Integer&gt;();</span>
<span class="nc" id="L345">				list.add(rs.getInt(&quot;user_id&quot;));</span>
<span class="nc" id="L346">				list.add(rs.getInt(&quot;organization_id&quot;));</span>
			}
<span class="nc" id="L348">		} catch (SQLException e) {</span>
<span class="nc" id="L349">			e.printStackTrace();</span>
<span class="nc" id="L350">			throw new ScratchException(ScratchErrors.SQL_EXCEPTION_ERROR_CODE, ScratchErrors.SQL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="nc" id="L351">		} catch (Exception e) {</span>
<span class="nc" id="L352">			e.printStackTrace();</span>
<span class="nc" id="L353">			throw new ScratchException(ScratchErrors.GENERAL_EXCEPTION_ERROR_CODE, ScratchErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="nc" id="L354">		}</span>

<span class="nc" id="L356">		return list;</span>
	}

	public int generateInvoiceForAgent(int orgId, Map&lt;Integer, OrderGameBookBeanMaster&gt; gameBookMap, String dl, Connection connection) throws ScratchException {
<span class="nc" id="L360">		int invoiceId = 0;</span>

<span class="nc" id="L362">		String lastRecieptNoGenerated = null, autoGeneRecieptNo = null;</span>

<span class="nc" id="L364">		PreparedStatement pStmt = null;</span>
<span class="nc" id="L365">		Statement stmt = null;</span>
<span class="nc" id="L366">		ResultSet rs = null;</span>

<span class="nc" id="L368">		PreparedStatement pStmtInvDetail = null;</span>

<span class="nc" id="L370">		double bookPrice = 0.0;</span>
<span class="nc" id="L371">		double agt_sale_comm_rate = 0.0;</span>
<span class="nc" id="L372">		double agtGameCommVariance = 0.0;</span>
<span class="nc" id="L373">		double prizepayoutRatio = 0.0;</span>
<span class="nc" id="L374">		double vat = 0.0;</span>
<span class="nc" id="L375">		double fixed_amt = 0.0;</span>
<span class="nc" id="L376">		long tickets_in_scheme = 0l;</span>
<span class="nc" id="L377">		String govtCommRule = null;</span>
<span class="nc" id="L378">		double govt_comm_rate = 0.0;</span>
<span class="nc" id="L379">		int masterTrnId = -1;</span>

<span class="nc" id="L381">		double mrpAmt = 0.0;</span>
<span class="nc" id="L382">		double netAmt = 0.0;</span>
<span class="nc" id="L383">		double vatAmt = 0.0;</span>
<span class="nc" id="L384">		double taxableSale = 0.0;</span>
<span class="nc" id="L385">		double creditAmt = 0.0;</span>
<span class="nc" id="L386">		double govtCommAmt = 0.0;</span>
<span class="nc" id="L387">		double agtSaleCommRate = 0.0;</span>
<span class="nc" id="L388">		double agtcommAmt = 0.0;</span>
<span class="nc" id="L389">		String packNbr = null;</span>

<span class="nc" id="L391">		List&lt;Integer&gt; trnIdList = new ArrayList&lt;Integer&gt;();</span>
<span class="nc" id="L392">		List&lt;Integer&gt; list = null;</span>
<span class="nc" id="L393">		StringBuilder bookNbrList = new StringBuilder();</span>
		
<span class="nc" id="L395">		int gameId = 0;</span>
//		int orderId = 0;
<span class="nc" id="L397">		List&lt;String&gt; bookList = null;</span>
		try {
<span class="nc" id="L399">			pStmt = connection.prepareStatement(QueryManager.insertInReceiptMaster());</span>
<span class="nc" id="L400">			pStmt.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L401">			pStmt.executeUpdate();</span>

<span class="nc" id="L403">			rs = pStmt.getGeneratedKeys();</span>
<span class="nc bnc" id="L404" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L405">				invoiceId = rs.getInt(1);</span>
			}

<span class="nc" id="L408">			java.sql.Timestamp currentDate = new java.sql.Timestamp(new Date().getTime());</span>
<span class="nc" id="L409">			stmt = connection.createStatement();</span>
<span class="nc bnc" id="L410" title="All 2 branches missed.">			for(Map.Entry&lt;Integer, OrderGameBookBeanMaster&gt; gameMap : gameBookMap.entrySet()) {</span>
<span class="nc" id="L411">				gameId = gameMap.getKey();</span>
//				orderId = gameMap.getValue().getOrderId();
<span class="nc" id="L413">				bookList = gameMap.getValue().getBookList();</span>
<span class="nc" id="L414">				rs = stmt.executeQuery(&quot;select * from st_se_game_master where game_id = &quot; + gameId);</span>
<span class="nc bnc" id="L415" title="All 2 branches missed.">				if (rs.next()) {</span>
<span class="nc" id="L416">					list = fetchParentUserAndOrgId(orgId, connection);</span>
	
<span class="nc" id="L418">					bookPrice = rs.getDouble(&quot;ticket_price&quot;) * rs.getInt(&quot;nbr_of_tickets_per_book&quot;);</span>
<span class="nc" id="L419">					agt_sale_comm_rate = rs.getDouble(&quot;agent_sale_comm_rate&quot;);</span>
<span class="nc" id="L420">					prizepayoutRatio = rs.getDouble(&quot;prize_payout_ratio&quot;);</span>
<span class="nc" id="L421">					vat = rs.getDouble(&quot;vat_amt&quot;);</span>
<span class="nc" id="L422">					fixed_amt = rs.getDouble(&quot;fixed_amt&quot;);</span>
<span class="nc" id="L423">					tickets_in_scheme = rs.getLong(&quot;tickets_in_scheme&quot;);</span>
<span class="nc" id="L424">					govtCommRule = rs.getString(&quot;govt_comm_type&quot;);</span>
<span class="nc" id="L425">					govt_comm_rate = rs.getDouble(&quot;govt_comm_rate&quot;);</span>
					
					// Fetch Commission variance of agent
<span class="nc" id="L428">					rs = stmt.executeQuery(&quot;select sale_comm_variance from st_se_bo_agent_sale_pwt_comm_variance where agent_org_id=&quot; + list.get(1) + &quot; and game_id=&quot; + gameId);</span>
<span class="nc" id="L429">					logger.info(&quot;comm var query :: &quot; + &quot;select sale_comm_variance from st_se_bo_agent_sale_pwt_comm_variance where agent_org_id=&quot; + list.get(1) + &quot; and game_id=&quot; + gameId);</span>
<span class="nc bnc" id="L430" title="All 2 branches missed.">					if (rs.next()) {</span>
<span class="nc" id="L431">						agtGameCommVariance = rs.getDouble(&quot;sale_comm_variance&quot;);</span>
					}
<span class="nc" id="L433">					logger.info(&quot;agtGameCommVariance==&quot; + agtGameCommVariance + &quot;  agt_sale_comm_rate==&quot; + agt_sale_comm_rate);</span>
	
<span class="nc" id="L435">					pStmt = connection.prepareStatement(QueryManager.insertInLMSTransactionMasterQuery());</span>
	//				pStmt = connection.prepareStatement(&quot;INSERT INTO st_lms_transaction_master (user_type, service_code, interface) VALUES (?, 'SE', 'WEB')&quot;);
	
					// insert in transaction master
<span class="nc" id="L439">					pStmt.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L440">					pStmt.setString(2, &quot;SE&quot;);</span>
<span class="nc" id="L441">					pStmt.setString(3, &quot;WEB&quot;);</span>
<span class="nc" id="L442">					pStmt.executeUpdate();</span>
<span class="nc" id="L443">					rs = pStmt.getGeneratedKeys();</span>
	
<span class="nc bnc" id="L445" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L446">						masterTrnId = rs.getInt(1);</span>
<span class="nc" id="L447">						trnIdList.add(masterTrnId);</span>
					}
	
<span class="nc" id="L450">					pStmt = connection.prepareStatement(QueryManager.insertInBOTransactionMaster());</span>
<span class="nc" id="L451">					pStmt.setInt(1, masterTrnId);</span>
<span class="nc" id="L452">					pStmt.setInt(2, 11001);</span>
<span class="nc" id="L453">					pStmt.setInt(3, 1);</span>
<span class="nc" id="L454">					pStmt.setString(4, &quot;AGENT&quot;);</span>
<span class="nc" id="L455">					pStmt.setInt(5, list.get(1));</span>
<span class="nc" id="L456">					pStmt.setTimestamp(6, currentDate);</span>
<span class="nc" id="L457">					pStmt.setString(7, &quot;SALE&quot;);</span>
<span class="nc" id="L458">					pStmt.execute();</span>
	
<span class="nc" id="L460">					mrpAmt = bookList.size() * bookPrice;</span>
<span class="nc" id="L461">					govtCommAmt = mrpAmt * govt_comm_rate * .01;</span>
<span class="nc" id="L462">					agtSaleCommRate = agt_sale_comm_rate + agtGameCommVariance;</span>
<span class="nc" id="L463">					agtcommAmt = mrpAmt * agtSaleCommRate * 0.01;</span>
<span class="nc" id="L464">					logger.info(&quot;agtcommAmt === &quot; + agtcommAmt);</span>
<span class="nc" id="L465">					netAmt = mrpAmt - agtcommAmt;</span>
<span class="nc" id="L466">					creditAmt += netAmt;</span>
	
<span class="nc" id="L468">					vatAmt = CommonMethods.calculateVat(mrpAmt, agtSaleCommRate, prizepayoutRatio, govt_comm_rate, vat, govtCommRule, fixed_amt, tickets_in_scheme);</span>
	//				vatAmt = 0.0;
<span class="nc" id="L470">					logger.info(&quot;mrp :&quot; + mrpAmt + &quot;ppr :&quot; + prizepayoutRatio + &quot;gov comm :&quot; + govt_comm_rate + &quot;agt net comm :&quot; + agtSaleCommRate);</span>
	
<span class="nc" id="L472">					taxableSale = CommonMethods.calTaxableSale(mrpAmt, agtSaleCommRate, prizepayoutRatio, govt_comm_rate, vat);</span>
	//				taxableSale = 0.0;
<span class="nc" id="L474">					logger.info(&quot;vat amount is :  &quot; + vatAmt + &quot; and taxable sale is  : &quot; + taxableSale);</span>
	
<span class="nc" id="L476">					pStmt = connection.prepareStatement(QueryManager.getST1BOAgentQuery());</span>
<span class="nc" id="L477">					pStmt.setInt(1, masterTrnId);</span>
<span class="nc" id="L478">					pStmt.setInt(2, bookList.size());</span>
<span class="nc" id="L479">					pStmt.setInt(3, gameId);</span>
<span class="nc" id="L480">					pStmt.setInt(4, list.get(1));</span>
					
<span class="nc" id="L482">					pStmt.setDouble(5, mrpAmt);</span>
<span class="nc" id="L483">					pStmt.setDouble(6, agtcommAmt);</span>
<span class="nc" id="L484">					pStmt.setDouble(7, netAmt);</span>
<span class="nc" id="L485">					pStmt.setString(8, &quot;SALE&quot;);</span>
<span class="nc" id="L486">					pStmt.setDouble(9, vatAmt);</span>
<span class="nc" id="L487">					pStmt.setDouble(10, taxableSale);</span>
<span class="nc" id="L488">					pStmt.setDouble(11, govtCommAmt);</span>
<span class="nc" id="L489">					pStmt.execute();</span>
	
<span class="nc" id="L491">					bookNbrList.setLength(0);</span>
<span class="nc bnc" id="L492" title="All 2 branches missed.">					for (String str : bookList) {</span>
<span class="nc" id="L493">						bookNbrList.append(&quot;'&quot;);</span>
<span class="nc" id="L494">						bookNbrList.append(str);</span>
<span class="nc" id="L495">						bookNbrList.append(&quot;',&quot;);</span>
<span class="nc" id="L496">					}</span>
	
<span class="nc bnc" id="L498" title="All 2 branches missed.">					if (bookList.size() &gt; 0) {</span>
<span class="nc" id="L499">						bookNbrList.setLength(bookNbrList.length() - 1);</span>
					}
					
<span class="nc bnc" id="L502" title="All 2 branches missed.">					if (bookList != null) {</span>
						// ************Check Below Query
<span class="nc" id="L504">						stmt = connection.createStatement();</span>
						
<span class="nc" id="L506">						pStmt = connection.prepareStatement(QueryManager.getST1BOUpdGameInvStatusInvoiceAgentQuery() + &quot; and book_nbr = ?;&quot;);</span>
<span class="nc" id="L507">						pStmtInvDetail = connection.prepareStatement(QueryManager.getST1InvAgentInvoiceDetailInsertQuery());</span>
	
<span class="nc bnc" id="L509" title="All 2 branches missed.">						for (String book : bookList) {</span>
<span class="nc" id="L510">							packNbr = new DirectSaleBOHelper().getPackNbrForBook(connection, gameId, book);</span>
<span class="nc" id="L511">							rs = stmt.executeQuery(&quot;select book_status, warehouse_id, current_owner from st_se_game_inv_status where game_id = &quot; +gameId+&quot; and book_nbr = '&quot;+book+&quot;' and pack_nbr = '&quot;+packNbr+&quot;'&quot;);</span>
	
<span class="nc bnc" id="L513" title="All 2 branches missed.">							if(!rs.next()) {</span>
<span class="nc" id="L514">								throw new ScratchException(ScratchErrors.SCRATCH_BOOK_NOT_AVAILABLE_ERROR_CODE, ScratchErrors.SCRATCH_BOOK_NOT_AVAILABLE_ERROR_MESSAGE);</span>
							}
	
<span class="nc" id="L517">							pStmt.setInt(1, invoiceId);</span>
<span class="nc" id="L518">							pStmt.setInt(2, gameId);</span>
//							pStmt.setInt(3, orderId);
<span class="nc" id="L520">							pStmt.setString(3, packNbr);</span>
<span class="nc" id="L521">							pStmt.setString(4, book);</span>
							
<span class="nc" id="L523">							pStmt.execute();</span>
	
<span class="nc" id="L525">							pStmtInvDetail.setInt(1, masterTrnId);</span>
<span class="nc" id="L526">							pStmtInvDetail.setInt(2, gameId);</span>
<span class="nc" id="L527">							pStmtInvDetail.setString(3, packNbr);</span>
<span class="nc" id="L528">							pStmtInvDetail.setString(4, book);</span>
<span class="nc" id="L529">							pStmtInvDetail.setString(5, rs.getString(&quot;current_owner&quot;));</span>
<span class="nc" id="L530">							pStmtInvDetail.setInt(6, list.get(1));</span>
<span class="nc" id="L531">							pStmtInvDetail.setTimestamp(7, currentDate);</span>
<span class="nc" id="L532">							pStmtInvDetail.setString(8, &quot;BO&quot;);</span>
<span class="nc" id="L533">							pStmtInvDetail.setDouble(9, agtSaleCommRate);</span>
<span class="nc" id="L534">							pStmtInvDetail.setDouble(10, govt_comm_rate);</span>
<span class="nc" id="L535">							pStmtInvDetail.setObject(11, null);</span>
<span class="nc" id="L536">							pStmtInvDetail.setInt(12, 11001);</span>
<span class="nc" id="L537">							pStmtInvDetail.setString(13, rs.getString(&quot;book_status&quot;));</span>
<span class="nc" id="L538">							pStmtInvDetail.setInt(14, rs.getInt(&quot;warehouse_id&quot;));</span>
<span class="nc" id="L539">							pStmtInvDetail.setInt(15, invoiceId);</span>
<span class="nc" id="L540">							pStmtInvDetail.execute();</span>
<span class="nc" id="L541">						}</span>
					}
	
					// for org credit updation
<span class="nc" id="L545">					logger.info(&quot;Org Id For Credit Update:&quot; + list.get(1) + &quot;:&quot; + creditAmt);</span>
	
<span class="nc" id="L547">					boolean isValid = OrgCreditUpdation.updateOrganizationBalWithValidate(creditAmt, &quot;TRANSACTION&quot;, &quot;SALE&quot;, list.get(1), 0, &quot;AGENT&quot;, 0, connection);</span>
	
<span class="nc bnc" id="L549" title="All 2 branches missed.">					if (!isValid)</span>
<span class="nc" id="L550">						throw new LMSException();</span>
				}
<span class="nc" id="L552">			}</span>

<span class="nc" id="L554">			pStmt = connection.prepareStatement(QueryManager.getBOLatestReceiptNb());</span>
<span class="nc" id="L555">			pStmt.setString(1, &quot;INVOICE&quot;);</span>
<span class="nc" id="L556">			rs = pStmt.executeQuery();</span>
<span class="nc bnc" id="L557" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L558">				lastRecieptNoGenerated = rs.getString(&quot;generated_id&quot;);</span>
			}
<span class="nc" id="L560">			autoGeneRecieptNo = GenerateRecieptNo.getRecieptNo(&quot;INVOICE&quot;, lastRecieptNoGenerated, &quot;BO&quot;);</span>

<span class="nc" id="L562">			logger.info(&quot;lastInvoiceNoGenerated &quot; + lastRecieptNoGenerated + &quot;autoGeneInvoiceNo &quot; + autoGeneRecieptNo);</span>

			// insert into BO receipt table
<span class="nc" id="L565">			pStmt = connection.prepareStatement(QueryManager.insertInBOReceipts());</span>
<span class="nc" id="L566">			pStmt.setInt(1, invoiceId);</span>
<span class="nc" id="L567">			pStmt.setString(2, &quot;INVOICE&quot;);</span>
<span class="nc" id="L568">			pStmt.setInt(3, list.get(1));</span>
<span class="nc" id="L569">			pStmt.setString(4, &quot;AGENT&quot;);</span>
<span class="nc" id="L570">			pStmt.setString(5, autoGeneRecieptNo);</span>
<span class="nc" id="L571">			pStmt.setTimestamp(6, Util.getCurrentTimeStamp());</span>
<span class="nc" id="L572">			logger.info(&quot;bo invoice receipt = &quot; + pStmt);</span>
<span class="nc" id="L573">			pStmt.execute();</span>

<span class="nc" id="L575">			pStmt = connection.prepareStatement(QueryManager.insertBOReceiptTrnMapping());</span>
			// insert for receipt and transaction mapping table for Invoice
<span class="nc bnc" id="L577" title="All 2 branches missed.">			for (int i = 0; i &lt; trnIdList.size(); i++) {</span>
<span class="nc" id="L578">				pStmt.setInt(1, invoiceId);</span>
<span class="nc" id="L579">				pStmt.setInt(2, trnIdList.get(i));</span>
<span class="nc" id="L580">				pStmt.execute();</span>
			}

			// insert into invoice and delivery challan mapping table
<span class="nc bnc" id="L584" title="All 2 branches missed.">			if (dl != null) {</span>
<span class="nc" id="L585">				mapInvoiceToDL(invoiceId, autoGeneRecieptNo, dl, connection);</span>
			}
<span class="nc" id="L587">		} catch (SQLException e) {</span>
<span class="nc" id="L588">			e.printStackTrace();</span>
<span class="nc" id="L589">			throw new ScratchException(ScratchErrors.SQL_EXCEPTION_ERROR_CODE, ScratchErrors.SQL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="nc" id="L590">		} catch (Exception e) {</span>
<span class="nc" id="L591">			throw new ScratchException(ScratchErrors.GENERAL_EXCEPTION_ERROR_CODE, ScratchErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="nc" id="L592">		}</span>
<span class="nc" id="L593">		return invoiceId;</span>
	}

	public int generateInvoiceForRetailer(int orgId, Map&lt;Integer, OrderGameBookBeanMaster&gt; gameBookMap, String dl, Connection connection) throws ScratchException {
<span class="nc" id="L597">		double bookPrice = 0.0;</span>
<span class="nc" id="L598">		double retailer_sale_comm_rate = 0.0;</span>
<span class="nc" id="L599">		double retGameCommVariance = 0.0;</span>
<span class="nc" id="L600">		double prizepayoutRatio = 0.0;</span>
<span class="nc" id="L601">		double vat = 0.0;</span>
<span class="nc" id="L602">		double fixed_amt = 0.0;</span>
<span class="nc" id="L603">		long tickets_in_scheme = 0l;</span>
<span class="nc" id="L604">		String govtCommRule = null;</span>
<span class="nc" id="L605">		double govt_comm_rate = 0.0;</span>
<span class="nc" id="L606">		boolean isGovtCommChanged = false;</span>
<span class="nc" id="L607">		int noOfTktPerBooks = -1;</span>
<span class="nc" id="L608">		int invoiceId = -1;</span>
<span class="nc" id="L609">		int masterTrnId = -1;</span>
<span class="nc" id="L610">		List&lt;Integer&gt; trnIdList = new ArrayList&lt;Integer&gt;();</span>
<span class="nc" id="L611">		List&lt;Integer&gt; list = null;</span>
<span class="nc" id="L612">		double purRate = 0.0;</span>

<span class="nc" id="L614">		double mrpAmt = 0.0;</span>
<span class="nc" id="L615">		double commAmt = 0.0;</span>
<span class="nc" id="L616">		double netAmt = 0.0;</span>
<span class="nc" id="L617">		double vatAmt = 0.0;</span>
<span class="nc" id="L618">		double taxableSale = 0.0;</span>
<span class="nc" id="L619">		double retSaleCommRate = 0.0;</span>
<span class="nc" id="L620">		double creditAmt = 0.0;</span>

<span class="nc" id="L622">		PreparedStatement pStmt = null;</span>
<span class="nc" id="L623">		Statement stmt = null;</span>
<span class="nc" id="L624">		ResultSet rs = null;</span>
		
<span class="nc" id="L626">		int gameId = 0;</span>
//		int orderId = 0;
<span class="nc" id="L628">		List&lt;String&gt; bookList = null;</span>

		try {
<span class="nc" id="L631">			pStmt = connection.prepareStatement(QueryManager.insertInReceiptMaster());</span>
<span class="nc" id="L632">			pStmt.setString(1, &quot;AGENT&quot;);</span>
<span class="nc" id="L633">			pStmt.executeUpdate();</span>

<span class="nc" id="L635">			rs = pStmt.getGeneratedKeys();</span>

<span class="nc bnc" id="L637" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L638">				invoiceId = rs.getInt(1);</span>
			}

<span class="nc" id="L641">			stmt = connection.createStatement();</span>
<span class="nc bnc" id="L642" title="All 2 branches missed.">			for (Map.Entry&lt;Integer, OrderGameBookBeanMaster&gt; gameMap : gameBookMap.entrySet()) {</span>
<span class="nc" id="L643">				gameId = gameMap.getKey();</span>
//				orderId = gameMap.getValue().getOrderId();
<span class="nc" id="L645">				bookList = gameMap.getValue().getBookList();</span>
<span class="nc" id="L646">				rs = stmt.executeQuery(&quot;select * from st_se_game_master where game_id=&quot; + gameId);</span>
<span class="nc bnc" id="L647" title="All 2 branches missed.">				if (rs.next()) {</span>
<span class="nc" id="L648">					list = fetchParentUserAndOrgId(orgId, connection);</span>
<span class="nc" id="L649">					java.sql.Timestamp currentDate = new java.sql.Timestamp(new Date().getTime());</span>
	
<span class="nc" id="L651">					gameId = rs.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L652">					bookPrice = rs.getDouble(&quot;ticket_price&quot;) * rs.getInt(&quot;nbr_of_tickets_per_book&quot;);</span>
<span class="nc" id="L653">					noOfTktPerBooks = rs.getInt(&quot;nbr_of_tickets_per_book&quot;);</span>
<span class="nc" id="L654">					retailer_sale_comm_rate = rs.getDouble(&quot;retailer_sale_comm_rate&quot;);</span>
<span class="nc" id="L655">					prizepayoutRatio = rs.getDouble(&quot;prize_payout_ratio&quot;);</span>
<span class="nc" id="L656">					vat = rs.getDouble(&quot;vat_amt&quot;);</span>
<span class="nc" id="L657">					fixed_amt = rs.getDouble(&quot;fixed_amt&quot;);</span>
<span class="nc" id="L658">					tickets_in_scheme = rs.getLong(&quot;tickets_in_scheme&quot;);</span>
<span class="nc" id="L659">					govtCommRule = rs.getString(&quot;govt_comm_type&quot;);</span>
<span class="nc" id="L660">					govt_comm_rate = rs.getDouble(&quot;govt_comm_rate&quot;);</span>
	
					// To Generate Invoice Receipt
					
	
<span class="nc" id="L665">					rs = stmt.executeQuery(&quot;select sale_comm_variance  from st_se_agent_retailer_sale_pwt_comm_variance where retailer_org_id=&quot; + orgId + &quot; and game_id=&quot; + gameId);</span>
<span class="nc bnc" id="L666" title="All 2 branches missed.">					if (rs.next()) {</span>
<span class="nc" id="L667">						retGameCommVariance = rs.getDouble(&quot;sale_comm_variance&quot;);</span>
					}
	
<span class="nc" id="L670">					pStmt = connection.prepareStatement(&quot;select count(*) from st_se_game_govt_comm_history where game_id=?&quot;);</span>
<span class="nc" id="L671">					pStmt.setInt(1, gameId);</span>
<span class="nc" id="L672">					rs = pStmt.executeQuery();</span>
<span class="nc bnc" id="L673" title="All 2 branches missed.">					if (rs.next()) {</span>
<span class="nc bnc" id="L674" title="All 2 branches missed.">						if (rs.getInt(1) &gt; 1) {</span>
<span class="nc" id="L675">							isGovtCommChanged = true;</span>
						}
					}
	
<span class="nc bnc" id="L679" title="All 2 branches missed.">					if (isGovtCommChanged == false) {</span>
						// insert in LMS transaction master
<span class="nc" id="L681">						pStmt = connection.prepareStatement(QueryManager.insertInLMSTransactionMasterQuery());</span>
<span class="nc" id="L682">						pStmt.setString(1, &quot;AGENT&quot;);</span>
<span class="nc" id="L683">						pStmt.setString(2, &quot;SE&quot;);</span>
<span class="nc" id="L684">						pStmt.setString(3, &quot;WEB&quot;);</span>
<span class="nc" id="L685">						pStmt.executeUpdate();</span>
<span class="nc" id="L686">						rs = pStmt.getGeneratedKeys();</span>
	
<span class="nc bnc" id="L688" title="All 2 branches missed.">						while (rs.next()) {</span>
<span class="nc" id="L689">							masterTrnId = rs.getInt(1);</span>
<span class="nc" id="L690">							trnIdList.add(masterTrnId);</span>
						}
	
						// insert in agent transaction master
<span class="nc" id="L694">						pStmt = connection.prepareStatement(QueryManager.insertInAgentTransactionMaster());</span>
<span class="nc" id="L695">						pStmt.setInt(1, masterTrnId);</span>
<span class="nc" id="L696">						pStmt.setInt(2, list.get(0));</span>
<span class="nc" id="L697">						pStmt.setInt(3, list.get(1));</span>
<span class="nc" id="L698">						pStmt.setString(4, &quot;RETAILER&quot;);</span>
<span class="nc" id="L699">						pStmt.setInt(5, orgId);</span>
<span class="nc" id="L700">						pStmt.setString(6, &quot;SALE&quot;);</span>
<span class="nc" id="L701">						pStmt.setTimestamp(7, currentDate);</span>
<span class="nc" id="L702">						pStmt.execute();</span>
	
						// Agent - Retailer Trn Master
<span class="nc" id="L705">						mrpAmt = bookList.size() * bookPrice;</span>
<span class="nc" id="L706">						retSaleCommRate = retailer_sale_comm_rate + retGameCommVariance;</span>
<span class="nc" id="L707">						commAmt = mrpAmt * retSaleCommRate * 0.01;</span>
<span class="nc" id="L708">						netAmt = mrpAmt - commAmt;</span>
<span class="nc" id="L709">						creditAmt += netAmt;</span>
<span class="nc" id="L710">						vatAmt = CommonMethods.calculateVat(mrpAmt, retSaleCommRate, prizepayoutRatio, govt_comm_rate, vat, govtCommRule, fixed_amt, tickets_in_scheme);</span>
<span class="nc" id="L711">						taxableSale = CommonMethods.calTaxableSale(mrpAmt, retSaleCommRate, prizepayoutRatio, govt_comm_rate, vat);</span>
	
<span class="nc" id="L713">						pStmt = connection.prepareStatement(QueryManager.getST1AgentRetQuery());</span>
<span class="nc" id="L714">						pStmt.setInt(1, masterTrnId);</span>
<span class="nc" id="L715">						pStmt.setInt(2, gameId);</span>
<span class="nc" id="L716">						pStmt.setInt(3, list.get(0));</span>
<span class="nc" id="L717">						pStmt.setInt(4, orgId);</span>
<span class="nc" id="L718">						pStmt.setDouble(5, mrpAmt);</span>
<span class="nc" id="L719">						pStmt.setDouble(6, commAmt);</span>
<span class="nc" id="L720">						pStmt.setDouble(7, netAmt);</span>
<span class="nc" id="L721">						pStmt.setString(8, &quot;SALE&quot;);</span>
<span class="nc" id="L722">						pStmt.setInt(9, bookList.size());</span>
<span class="nc" id="L723">						pStmt.setDouble(10, vatAmt);</span>
<span class="nc" id="L724">						pStmt.setDouble(11, taxableSale);</span>
<span class="nc" id="L725">						pStmt.setInt(12, list.get(1));</span>
<span class="nc" id="L726">						pStmt.execute();</span>
	
<span class="nc bnc" id="L728" title="All 2 branches missed.">						if (bookList != null) {</span>
							// ************Check Below Query
<span class="nc" id="L730">							stmt = connection.createStatement();</span>
							
<span class="nc" id="L732">							StringBuilder bookNbrList = new StringBuilder();</span>
							
<span class="nc bnc" id="L734" title="All 2 branches missed.">							for (String str : bookList) {</span>
<span class="nc" id="L735">								bookNbrList.append(&quot;'&quot;);</span>
<span class="nc" id="L736">								bookNbrList.append(str);</span>
<span class="nc" id="L737">								bookNbrList.append(&quot;',&quot;);</span>
<span class="nc" id="L738">							}</span>
	
<span class="nc bnc" id="L740" title="All 2 branches missed.">							if (bookList.size() &gt; 0) {</span>
<span class="nc" id="L741">								bookNbrList.setLength(bookNbrList.length() - 1);</span>
							}
	
<span class="nc" id="L744">							pStmt = connection.prepareStatement(QueryManager.getST1BOUpdGameInvStatusInvoiceRetailerQuery() + &quot; and book_nbr in (&quot; + bookNbrList + &quot;);&quot;);</span>
<span class="nc" id="L745">							PreparedStatement pStmtInvDetail = connection.prepareStatement(QueryManager.getST1InvRetailerInvoiceDetailInsertQuery());</span>
	
<span class="nc bnc" id="L747" title="All 2 branches missed.">							for (String book : bookList) {</span>
<span class="nc" id="L748">								String packNbr = new DirectSaleBOHelper().getPackNbrForBook(connection, gameId, book);</span>
<span class="nc" id="L749">								rs = stmt.executeQuery(&quot;select book_status, warehouse_id, current_owner, agent_invoice_id from st_se_game_inv_status where game_id = &quot; +gameId+&quot; and book_nbr = '&quot;+book+&quot;' and pack_nbr = '&quot;+packNbr+&quot;'&quot;);</span>
	
<span class="nc bnc" id="L751" title="All 2 branches missed.">								if(!rs.next()) {</span>
<span class="nc" id="L752">									throw new ScratchException(ScratchErrors.SCRATCH_BOOK_NOT_AVAILABLE_ERROR_CODE, ScratchErrors.SCRATCH_BOOK_NOT_AVAILABLE_ERROR_MESSAGE);</span>
								}
	
<span class="nc" id="L755">								pStmt.setInt(1, invoiceId);</span>
<span class="nc" id="L756">								pStmt.setInt(2, gameId);</span>
//								pStmt.setInt(3, orderId);
<span class="nc" id="L758">								pStmt.setString(3, packNbr);</span>
	
<span class="nc" id="L760">								pStmt.execute();</span>
	
<span class="nc" id="L762">								pStmtInvDetail.setInt(1, masterTrnId);</span>
<span class="nc" id="L763">								pStmtInvDetail.setInt(2, gameId);</span>
<span class="nc" id="L764">								pStmtInvDetail.setString(3, packNbr);</span>
<span class="nc" id="L765">								pStmtInvDetail.setString(4, book);</span>
<span class="nc" id="L766">								pStmtInvDetail.setString(5, rs.getString(&quot;current_owner&quot;));</span>
<span class="nc" id="L767">								pStmtInvDetail.setInt(6, list.get(1));</span>
<span class="nc" id="L768">								pStmtInvDetail.setTimestamp(7, currentDate);</span>
<span class="nc" id="L769">								pStmtInvDetail.setString(8, &quot;RETAILER&quot;);</span>
<span class="nc" id="L770">								pStmtInvDetail.setDouble(9, retailer_sale_comm_rate);</span>
<span class="nc" id="L771">								pStmtInvDetail.setDouble(10, govt_comm_rate);</span>
<span class="nc" id="L772">								pStmtInvDetail.setObject(11, null);</span>
<span class="nc" id="L773">								pStmtInvDetail.setInt(12, 11001);</span>
<span class="nc" id="L774">								pStmtInvDetail.setString(13, rs.getString(&quot;book_status&quot;));</span>
<span class="nc" id="L775">								pStmtInvDetail.setInt(14, rs.getInt(&quot;warehouse_id&quot;));</span>
<span class="nc" id="L776">								pStmtInvDetail.setInt(15, rs.getInt(&quot;agent_invoice_id&quot;));</span>
<span class="nc" id="L777">								pStmtInvDetail.setInt(16, invoiceId);</span>
<span class="nc" id="L778">								pStmtInvDetail.execute();</span>
<span class="nc" id="L779">							}</span>
<span class="nc" id="L780">						}</span>
					} else {
<span class="nc" id="L782">						mrpAmt = bookList.size() * bookPrice;</span>
<span class="nc" id="L783">						retSaleCommRate = retailer_sale_comm_rate + retGameCommVariance;</span>
<span class="nc" id="L784">						commAmt = mrpAmt * retSaleCommRate * 0.01;</span>
<span class="nc" id="L785">						netAmt = mrpAmt - commAmt;</span>
<span class="nc" id="L786">						creditAmt += netAmt;</span>
	
						ResultSet rsCommVar;
<span class="nc" id="L789">						ArrayList&lt;BookSaleBean&gt; bookSaleBeanList = new ArrayList&lt;BookSaleBean&gt;();</span>
<span class="nc" id="L790">						BookSaleBean bookSaleBean = null;</span>
<span class="nc bnc" id="L791" title="All 2 branches missed.">						for (String bookName : bookList) {</span>
<span class="nc" id="L792">							bookSaleBean = new BookSaleBean();</span>
<span class="nc" id="L793">							double govtCommRate = 0.0;</span>
<span class="nc" id="L794">							double vatAmtForBook = 0.0;</span>
<span class="nc" id="L795">							double taxableSaleForbook = 0.0;</span>
	
<span class="nc" id="L797">							pStmt = connection.prepareStatement(&quot;select transaction_gov_comm_rate,transaction_date from st_se_game_inv_detail where current_owner=? and current_owner_id=? and game_id=? and book_nbr=? and transaction_at=? order by transaction_date desc limit 1 &quot;);</span>
<span class="nc" id="L798">							pStmt.setString(1, &quot;AGENT&quot;);</span>
<span class="nc" id="L799">							pStmt.setInt(2, orgId);</span>
<span class="nc" id="L800">							pStmt.setInt(3, gameId);</span>
<span class="nc" id="L801">							pStmt.setString(4, bookName);</span>
<span class="nc" id="L802">							pStmt.setString(5, &quot;BO&quot;);</span>
<span class="nc" id="L803">							rsCommVar = pStmt.executeQuery();</span>
<span class="nc bnc" id="L804" title="All 2 branches missed.">							while (rsCommVar.next()) {</span>
<span class="nc" id="L805">								govtCommRate = rsCommVar.getDouble(&quot;transaction_gov_comm_rate&quot;);</span>
							}
	
<span class="nc" id="L808">							vatAmtForBook = CommonMethods.calculateVat(bookPrice, retSaleCommRate, prizepayoutRatio, govtCommRate, vat, govtCommRule, fixed_amt, tickets_in_scheme);</span>
<span class="nc" id="L809">							taxableSaleForbook = CommonMethods.calTaxableSale(bookPrice, retSaleCommRate, prizepayoutRatio, govtCommRate, vat);</span>
	
<span class="nc" id="L811">							bookSaleBean.setBookNumber(bookName);</span>
<span class="nc" id="L812">							bookSaleBean.setBookTaxableSale(taxableSaleForbook);</span>
<span class="nc" id="L813">							bookSaleBean.setBookVatAmt(vatAmtForBook);</span>
<span class="nc" id="L814">							bookSaleBean.setTotalSaleGovtComm(govtCommRate);</span>
<span class="nc" id="L815">							bookSaleBeanList.add(bookSaleBean);</span>
<span class="nc" id="L816">						}</span>
	
<span class="nc" id="L818">						Set&lt;Double&gt; GovtCommVarianceSet = new HashSet&lt;Double&gt;();</span>
<span class="nc" id="L819">						pStmt = connection.prepareStatement(&quot;select DISTINCT govt_comm_rate from st_se_game_govt_comm_history where game_id=&quot; + gameId);</span>
<span class="nc" id="L820">						rs = pStmt.executeQuery();</span>
<span class="nc bnc" id="L821" title="All 2 branches missed.">						while (rs.next()) {</span>
<span class="nc" id="L822">							GovtCommVarianceSet.add(rs.getDouble(&quot;govt_comm_rate&quot;));</span>
						}
	
						Iterator&lt;Double&gt; govtCommSetItr;
						Iterator&lt;BookSaleBean&gt; bookSaleBeanItr;
<span class="nc" id="L827">						govtCommSetItr = GovtCommVarianceSet.iterator();</span>
	
<span class="nc bnc" id="L829" title="All 2 branches missed.">						while (govtCommSetItr.hasNext()) {</span>
<span class="nc" id="L830">							boolean bookGovtCommVarMatch = false;</span>
<span class="nc" id="L831">							bookSaleBeanItr = bookSaleBeanList.iterator();</span>
<span class="nc" id="L832">							List&lt;String&gt; bookListforSingleTrn = new ArrayList&lt;String&gt;();</span>
	
<span class="nc" id="L834">							double totVatAmt = 0.0;</span>
<span class="nc" id="L835">							double totTaxableSale = 0.0;</span>
<span class="nc" id="L836">							double totMrpAmt = 0.0;</span>
<span class="nc" id="L837">							double totalCommAmt = 0.0;</span>
<span class="nc" id="L838">							double totalNetAmt = 0.0;</span>
	
<span class="nc" id="L840">							Double govtCommFormSet = (Double) govtCommSetItr.next();</span>
	
<span class="nc bnc" id="L842" title="All 2 branches missed.">							while (bookSaleBeanItr.hasNext()) {</span>
<span class="nc" id="L843">								bookSaleBean = (BookSaleBean) bookSaleBeanItr.next();</span>
<span class="nc bnc" id="L844" title="All 2 branches missed.">								if (bookSaleBean.getTotalSaleGovtComm() == govtCommFormSet) {</span>
<span class="nc" id="L845">									bookGovtCommVarMatch = true;</span>
<span class="nc" id="L846">									totVatAmt = totVatAmt + bookSaleBean.getBookVatAmt();</span>
<span class="nc" id="L847">									totTaxableSale = totTaxableSale + bookSaleBean.getBookTaxableSale();</span>
<span class="nc" id="L848">									totMrpAmt = totMrpAmt + bookPrice;</span>
<span class="nc" id="L849">									bookListforSingleTrn.add(bookSaleBean.getBookNumber());</span>
								}
							}
	
<span class="nc" id="L853">							totalCommAmt = totMrpAmt * retSaleCommRate * 0.01;</span>
<span class="nc" id="L854">							totalNetAmt = totMrpAmt - totalCommAmt;</span>
<span class="nc bnc" id="L855" title="All 2 branches missed.">							if (bookGovtCommVarMatch) {</span>
								// insert in LMS transaction master
<span class="nc" id="L857">								pStmt.setString(1, &quot;RETAILER&quot;);</span>
<span class="nc" id="L858">								pStmt.setString(2, &quot;SE&quot;);</span>
<span class="nc" id="L859">								pStmt.setString(3, &quot;WEB&quot;);</span>
<span class="nc" id="L860">								pStmt.executeUpdate();</span>
<span class="nc" id="L861">								rs = pStmt.getGeneratedKeys();</span>
	
<span class="nc bnc" id="L863" title="All 2 branches missed.">								while (rs.next()) {</span>
<span class="nc" id="L864">									masterTrnId = rs.getInt(1);</span>
<span class="nc" id="L865">									trnIdList.add(masterTrnId);</span>
								}
	
								// insert in agent transaction master
<span class="nc" id="L869">								pStmt = connection.prepareStatement(QueryManager.insertInAgentTransactionMaster());</span>
<span class="nc" id="L870">								pStmt.setInt(1, masterTrnId);</span>
<span class="nc" id="L871">								pStmt.setInt(2, list.get(0));</span>
<span class="nc" id="L872">								pStmt.setInt(3, list.get(1));</span>
<span class="nc" id="L873">								pStmt.setString(4, &quot;RETAILER&quot;);</span>
<span class="nc" id="L874">								pStmt.setInt(5, orgId);</span>
<span class="nc" id="L875">								pStmt.setString(6, &quot;SALE&quot;);</span>
<span class="nc" id="L876">								pStmt.setTimestamp(7, currentDate);</span>
<span class="nc" id="L877">								pStmt.execute();</span>
	
								// Agent - Retailer Trn Master
<span class="nc" id="L880">								mrpAmt = bookList.size() * bookPrice;</span>
<span class="nc" id="L881">								retSaleCommRate = retailer_sale_comm_rate + retGameCommVariance;</span>
<span class="nc" id="L882">								commAmt = mrpAmt * retSaleCommRate * 0.01;</span>
<span class="nc" id="L883">								netAmt = mrpAmt - commAmt;</span>
<span class="nc" id="L884">								creditAmt += netAmt;</span>
<span class="nc" id="L885">								vatAmt = CommonMethods.calculateVat(mrpAmt, retSaleCommRate, prizepayoutRatio, govt_comm_rate, vat, govtCommRule, fixed_amt, tickets_in_scheme);</span>
<span class="nc" id="L886">								taxableSale = CommonMethods.calTaxableSale(mrpAmt, retSaleCommRate, prizepayoutRatio, govt_comm_rate, vat);</span>
	
<span class="nc" id="L888">								pStmt = connection.prepareStatement(QueryManager.getST1AgentRetQuery());</span>
<span class="nc" id="L889">								pStmt.setInt(1, masterTrnId);</span>
<span class="nc" id="L890">								pStmt.setInt(2, gameId);</span>
<span class="nc" id="L891">								pStmt.setInt(3, list.get(0));</span>
<span class="nc" id="L892">								pStmt.setInt(4, orgId);</span>
<span class="nc" id="L893">								pStmt.setDouble(5, mrpAmt);</span>
<span class="nc" id="L894">								pStmt.setDouble(6, commAmt);</span>
<span class="nc" id="L895">								pStmt.setDouble(7, netAmt);</span>
<span class="nc" id="L896">								pStmt.setString(8, &quot;SALE&quot;);</span>
<span class="nc" id="L897">								pStmt.setInt(9, bookList.size());</span>
<span class="nc" id="L898">								pStmt.setDouble(10, vatAmt);</span>
<span class="nc" id="L899">								pStmt.setDouble(11, taxableSale);</span>
<span class="nc" id="L900">								pStmt.setInt(12, list.get(1));</span>
<span class="nc" id="L901">								pStmt.execute();</span>
	
<span class="nc bnc" id="L903" title="All 2 branches missed.">								for (String bookNubr : bookListforSingleTrn) {</span>
									// added by arun
<span class="nc" id="L905">									pStmt = connection.prepareStatement(&quot;select transacrion_sale_comm_rate from st_se_game_inv_detail where book_nbr=? and transaction_at='BO' order by transaction_date desc limit 1&quot;);</span>
<span class="nc" id="L906">									pStmt.setString(1, bookNubr);</span>
<span class="nc" id="L907">									rs = pStmt.executeQuery();</span>
<span class="nc bnc" id="L908" title="All 2 branches missed.">									if (rs.next()) {</span>
<span class="nc" id="L909">										purRate = rs.getDouble(&quot;transacrion_sale_comm_rate&quot;);</span>
									}
<span class="nc" id="L911">								}</span>
							}
<span class="nc" id="L913">						}</span>
<span class="nc bnc" id="L914" title="All 2 branches missed.">						if (bookList != null) {</span>
<span class="nc" id="L915">							String newBookStatus = &quot;ACTIVE&quot;;</span>
							//pStmt = connection.prepareStatement(QueryManager.getST1AgtUpdGameInvStatusQuery() + &quot; and book_nbr = ?&quot;);
<span class="nc" id="L917">							pStmt = connection.prepareStatement(&quot;UPDATE st_se_game_inv_status SET current_owner=?, current_owner_id=?, book_status=?, cur_rem_tickets=?, active_tickets_upto=? WHERE game_id=? AND book_nbr=?;&quot;);</span>
<span class="nc bnc" id="L918" title="All 2 branches missed.">							for (String book : bookList) {</span>
<span class="nc" id="L919">								pStmt.setString(1, &quot;RETAILER&quot;);</span>
<span class="nc" id="L920">								pStmt.setInt(2, orgId);</span>
<span class="nc" id="L921">								pStmt.setString(3, newBookStatus);</span>
<span class="nc" id="L922">								pStmt.setInt(4, noOfTktPerBooks);</span>
<span class="nc bnc" id="L923" title="All 2 branches missed.">								if (&quot;ACTIVE&quot;.equalsIgnoreCase(newBookStatus.trim())) {</span>
<span class="nc" id="L924">									pStmt.setInt(5, noOfTktPerBooks);</span>
								} else {
<span class="nc" id="L926">									pStmt.setInt(5, 0);</span>
								}
<span class="nc" id="L928">								pStmt.setInt(6, gameId);</span>
<span class="nc" id="L929">								pStmt.setString(7, book);</span>
<span class="nc" id="L930">								pStmt.execute();</span>
<span class="nc" id="L931">							}</span>
						}
					}
				}
				// for org credit updation
<span class="nc" id="L936">				System.out.println(&quot;Org Id For Credit Update:&quot; + orgId + &quot;:&quot; + creditAmt);</span>
	
<span class="nc" id="L938">				boolean isValid = OrgCreditUpdation.updateOrganizationBalWithValidate(creditAmt, &quot;TRANSACTION&quot;, &quot;SALE&quot;, orgId, list.get(1), &quot;RETAILER&quot;, 0, connection);</span>
<span class="nc bnc" id="L939" title="All 2 branches missed.">				if (!isValid)</span>
<span class="nc" id="L940">					throw new LMSException();</span>
<span class="nc" id="L941">			}</span>

<span class="nc" id="L943">			pStmt = connection.prepareStatement(QueryManager.getAGENTLatestReceiptNb());</span>
<span class="nc" id="L944">			pStmt.setString(1, &quot;INVOICE&quot;);</span>
<span class="nc" id="L945">			pStmt.setInt(2, list.get(1));</span>
<span class="nc" id="L946">			rs = pStmt.executeQuery();</span>
<span class="nc" id="L947">			String lastRecieptNoGenerated = null;</span>
<span class="nc bnc" id="L948" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L949">				lastRecieptNoGenerated = rs.getString(&quot;generated_id&quot;);</span>
			}

<span class="nc" id="L952">			String autoGeneRecieptNo = null;</span>
<span class="nc" id="L953">			autoGeneRecieptNo = GenerateRecieptNo.getRecieptNoAgt(&quot;INVOICE&quot;, lastRecieptNoGenerated, &quot;AGENT&quot;, list.get(1));</span>

<span class="nc" id="L955">			pStmt = connection.prepareStatement(QueryManager.insertInAgentReceipts());</span>
<span class="nc" id="L956">			pStmt.setInt(1, invoiceId);</span>
<span class="nc" id="L957">			pStmt.setString(2, &quot;INVOICE&quot;);</span>
<span class="nc" id="L958">			pStmt.setInt(3, list.get(1));</span>
<span class="nc" id="L959">			pStmt.setInt(4, orgId);</span>
<span class="nc" id="L960">			pStmt.setString(5, &quot;RETAILER&quot;);</span>
<span class="nc" id="L961">			pStmt.setString(6, autoGeneRecieptNo);</span>
<span class="nc" id="L962">			pStmt.setTimestamp(7, Util.getCurrentTimeStamp());</span>
<span class="nc" id="L963">			pStmt.execute();</span>

<span class="nc" id="L965">			pStmt = connection.prepareStatement(QueryManager.insertAgentReceiptTrnMapping());</span>

<span class="nc bnc" id="L967" title="All 2 branches missed.">			for (Integer txnId : trnIdList) {</span>
<span class="nc" id="L968">				pStmt.setInt(1, invoiceId);</span>
<span class="nc" id="L969">				pStmt.setInt(2, txnId);</span>
<span class="nc" id="L970">				pStmt.execute();</span>
<span class="nc" id="L971">			}</span>

<span class="nc bnc" id="L973" title="All 2 branches missed.">			if (dl != null) {</span>
<span class="nc" id="L974">				mapInvoiceToDL(invoiceId, autoGeneRecieptNo, dl, connection);</span>
			}
<span class="nc" id="L976">		} catch (SQLException e) {</span>
<span class="nc" id="L977">			e.printStackTrace();</span>
<span class="nc" id="L978">			throw new ScratchException(ScratchErrors.SQL_EXCEPTION_ERROR_CODE, ScratchErrors.SQL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="nc" id="L979">		} catch (Exception e) {</span>
<span class="nc" id="L980">			throw new ScratchException(ScratchErrors.GENERAL_EXCEPTION_ERROR_CODE, ScratchErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="nc" id="L981">		}</span>

<span class="nc" id="L983">		return invoiceId;</span>
	}

	// DONE
	public void mapInvoiceToDL(int invcoiceId, String invoiceReceiptId, String dl, Connection connection) throws ScratchException {
<span class="nc" id="L988">		PreparedStatement pStmt = null;</span>
		try {
<span class="nc" id="L990">			pStmt = connection.prepareStatement(&quot;insert into st_se_bo_invoice_delchallan_mapping(id,generated_invoice_id,generated_del_challan_id) values(?,?,?)&quot;);</span>
<span class="nc" id="L991">			pStmt.setInt(1, invcoiceId);</span>
<span class="nc" id="L992">			pStmt.setString(2, invoiceReceiptId);</span>
<span class="nc" id="L993">			pStmt.setString(3, dl);</span>
<span class="nc" id="L994">			pStmt.executeUpdate();</span>
<span class="nc" id="L995">		} catch (SQLException e) {</span>
<span class="nc" id="L996">			e.printStackTrace();</span>
<span class="nc" id="L997">			throw new ScratchException(ScratchErrors.SQL_EXCEPTION_ERROR_CODE, ScratchErrors.SQL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="nc" id="L998">		} catch (Exception e) {</span>
<span class="nc" id="L999">			throw new ScratchException(ScratchErrors.GENERAL_EXCEPTION_ERROR_CODE, ScratchErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="nc" id="L1000">		}</span>
<span class="nc" id="L1001">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>