<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DrawGameMgmtHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lms</a> &gt; <a href="index.source.html" class="el_package">com.skilrock.lms.coreEngine.drawGames.drawMgmt</a> &gt; <span class="el_source">DrawGameMgmtHelper.java</span></div><h1>DrawGameMgmtHelper.java</h1><pre class="source lang-java linenums">package com.skilrock.lms.coreEngine.drawGames.drawMgmt;

import java.io.BufferedReader;
import java.io.DataOutputStream;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.lang.reflect.Type;
import java.net.HttpURLConnection;
import java.net.URL;
import java.net.URLConnection;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.sql.Timestamp;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Calendar;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.LinkedHashMap;
import java.util.LinkedList;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Set;
import java.util.TreeMap;

import net.sf.json.JSONObject;

import org.apache.commons.lang.ArrayUtils;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import com.google.gson.Gson;
import com.google.gson.JsonElement;
import com.google.gson.JsonObject;
import com.google.gson.reflect.TypeToken;
import com.opensymphony.xwork2.util.LocalizedTextUtil;
import com.skilrock.lms.admin.SetResetUserPasswordAction;
import com.skilrock.lms.ajax.AjaxRequestHelper;
import com.skilrock.lms.beans.DailyLedgerBean;
import com.skilrock.lms.beans.PromoGameBean;
import com.skilrock.lms.beans.RankWiseWinningReportBean;
import com.skilrock.lms.beans.ReportStatusBean;
import com.skilrock.lms.beans.ServiceRequest;
import com.skilrock.lms.beans.ServiceResponse;
import com.skilrock.lms.beans.UserInfoBean;
import com.skilrock.lms.common.CommonValidation;
import com.skilrock.lms.common.ConfigurationVariables;
import com.skilrock.lms.common.Utility;
import com.skilrock.lms.common.db.DBConnect;
import com.skilrock.lms.common.db.DBConnectReplica;
import com.skilrock.lms.common.db.QueryManager;
import com.skilrock.lms.common.exception.LMSErrors;
import com.skilrock.lms.common.exception.LMSException;
import com.skilrock.lms.common.filter.LMSFilterDispatcher;
import com.skilrock.lms.common.utility.CommonMethods;
import com.skilrock.lms.common.utility.LMSUtility;
import com.skilrock.lms.common.utility.MailSender;
import com.skilrock.lms.common.utility.MailSenderAfterPerformDraw;
import com.skilrock.lms.common.utility.ResponsibleGaming;
import com.skilrock.lms.common.utility.orgOnLineSaleCreditUpdation;
import com.skilrock.lms.coreEngine.drawGames.common.DGPromoScheme;
import com.skilrock.lms.coreEngine.drawGames.playMgmt.DrawGameRPOSHelper;
import com.skilrock.lms.coreEngine.service.IServiceDelegate;
import com.skilrock.lms.coreEngine.service.ServiceDelegate;
import com.skilrock.lms.coreEngine.service.dge.ServiceMethodName;
import com.skilrock.lms.coreEngine.service.dge.ServiceName;
import com.skilrock.lms.coreEngine.userMgmt.common.CommonFunctionsHelper;
import com.skilrock.lms.dge.beans.AnalysisBean;
import com.skilrock.lms.dge.beans.AnalysisReportDrawBean;
import com.skilrock.lms.dge.beans.BlockTicketUserBean;
import com.skilrock.lms.dge.beans.CancelTicketBean;
import com.skilrock.lms.dge.beans.DGConsolidateDrawBean;
import com.skilrock.lms.dge.beans.DGConsolidateGameDataBean;
import com.skilrock.lms.dge.beans.DrawDataBean;
import com.skilrock.lms.dge.beans.DrawDetailsBean;
import com.skilrock.lms.dge.beans.DrawIdBean;
import com.skilrock.lms.dge.beans.DrawPanelSaleBean;
import com.skilrock.lms.dge.beans.DrawScheduleBean;
import com.skilrock.lms.dge.beans.DrawScheduleBeanResult;
import com.skilrock.lms.dge.beans.ManualWinningBean;
import com.skilrock.lms.dge.beans.MtnCustomerCenterBean;
import com.skilrock.lms.dge.beans.PanelIdBean;
import com.skilrock.lms.dge.beans.ReportBeanDrawModule;
import com.skilrock.lms.dge.beans.ReportDrawBean;
import com.skilrock.lms.dge.beans.ResultSubmitBean;
import com.skilrock.lms.dge.beans.SchedulerBean;
import com.skilrock.lms.dge.beans.TicketSearchCriteriaBean;
import com.skilrock.lms.dge.beans.TicketTracking;
import com.skilrock.lms.dge.beans.TicketWiseDataBean;
import com.skilrock.lms.dge.beans.ValidateTicketBean;
import com.skilrock.lms.dge.beans.BlockTicketUserBean.BlockTicketUserBeanBuilder;
import com.skilrock.lms.dge.gameconstants.BonusBalllottoConstants;
import com.skilrock.lms.dge.gameconstants.BonusBalltwoConstants;
import com.skilrock.lms.dge.gameconstants.FastlottoConstants;
import com.skilrock.lms.dge.gameconstants.KenoConstants;
import com.skilrock.lms.dge.gameconstants.KenoEightConstants;
import com.skilrock.lms.dge.gameconstants.KenoFourConstants;
import com.skilrock.lms.dge.gameconstants.KenoNineConstants;
import com.skilrock.lms.dge.gameconstants.KenoSevenConstants;
import com.skilrock.lms.dge.gameconstants.KenoSixConstants;
import com.skilrock.lms.dge.gameconstants.KenoTwoConstants;
import com.skilrock.lms.dge.gameconstants.LottoConstants;
import com.skilrock.lms.dge.gameconstants.PickFourConstants;
import com.skilrock.lms.dge.gameconstants.PickThreeConstants;
import com.skilrock.lms.dge.gameconstants.RainbowConstants;
import com.skilrock.lms.dge.gameconstants.SuperTwoConstants;
import com.skilrock.lms.dge.gameconstants.TanzanialottoConstants;
import com.skilrock.lms.dge.gameconstants.TenByTwentyConstants;
import com.skilrock.lms.dge.gameconstants.TwelveByTwentyFourConstants;
import com.skilrock.lms.dge.gameconstants.ZimLottoBonusConstants;
import com.skilrock.lms.dge.gameconstants.ZimLottoBonusFreeConstants;
import com.skilrock.lms.dge.gameconstants.ZimLottoBonusTwoConstants;
import com.skilrock.lms.dge.gameconstants.ZimLottoBonusTwoFreeConstants;
import com.skilrock.lms.dge.gameconstants.ZimlottoConstants;
import com.skilrock.lms.dge.gameconstants.ZimlottothreeConstants;
import com.skilrock.lms.dge.gameconstants.ZimlottotwoConstants;
import com.skilrock.lms.web.drawGames.common.DrawGameRPOS;
import com.skilrock.lms.web.drawGames.common.Util;
import com.skilrock.lms.web.reportsMgmt.common.ReportUtility;

/**
 * 
 * @author Gaurav Ujjwal
 * 
 * &lt;pre&gt;
 * Change History
 * Change Date     Changed By     Change Description
 * -----------     ----------     ------------------
 * (e.g.)
 * 01-JAN-2005     ABxxxxxx       CR#zzzzzz: blah blah blah... 
 * 28-MAY-2010     Arun Tanwar    CR#L0375:Implementation of winning numbers for manual entry(freezed draws).
 * 02-MAY-2010     Arun Tanwar    CR#L0375:Implementation of winning numbers for manual entry. Method getManualEntryData added.
 * 03-MAY-2010     Arun Tanwar    CR#L0375:Implementation of entering PMEP for ACTIVE draws. Method getManualDeclareData added.
 * &lt;/pre&gt;
 */
<span class="nc" id="L144">public class DrawGameMgmtHelper extends LocalizedTextUtil{</span>
<span class="nc" id="L145">	static Log logger = LogFactory.getLog(DrawGameMgmtHelper.class);</span>
<span class="nc" id="L146">	private static Locale locale = Locale.getDefault();</span>
		
	public String drawTime(String gameNo) {
<span class="nc" id="L149">		String finalList = null;</span>
<span class="nc" id="L150">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L151">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L152">		sReq.setServiceName(ServiceName.DRAWGAME);</span>
<span class="nc" id="L153">		sReq.setServiceMethod(ServiceMethodName.DRAW_GAME_ANALYSIS_REPORT);</span>
<span class="nc" id="L154">		sReq.setServiceData(gameNo);</span>
<span class="nc" id="L155">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L156">		sRes = delegate.getResponse(sReq);</span>
<span class="nc" id="L157">		finalList = (String) sRes.getResponseData();</span>
<span class="nc" id="L158">		System.out.println(finalList.length() + &quot;***TIME LIST***&quot;</span>
				+ finalList);
<span class="nc" id="L160">		return finalList;</span>
	}
	
	
	public SchedulerBean actionOnHold(DrawScheduleBean drawScheduleBean)
			throws Exception {
<span class="nc" id="L166">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L167">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L168">		sReq.setServiceName(ServiceName.DRAW_MGMT);</span>
<span class="nc" id="L169">		sReq.setServiceMethod(ServiceMethodName.DRAWGAME_ACTION_ON_HOLD_DRAW);</span>
<span class="nc" id="L170">		sReq.setServiceData(drawScheduleBean);</span>
<span class="nc" id="L171">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L172">		sRes = delegate.getResponse(sReq);</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">		if (sRes.getIsSuccess()) {</span>
			//rescheduleJob(drawScheduleBean.getGameNo());
		}
<span class="nc" id="L176">		String responseString=sRes.getResponseData().toString();</span>
<span class="nc" id="L177">		Type elementType = new TypeToken&lt;SchedulerBean&gt;() {}.getType();</span>
<span class="nc" id="L178">		SchedulerBean schedulerBean = new Gson().fromJson(responseString, elementType);</span>
<span class="nc" id="L179">		return schedulerBean;</span>
	}

	public boolean authorizeUser(int userId) {
		
<span class="nc" id="L184">		ResultSet rs = null;</span>
<span class="nc" id="L185">		Statement stmt= null;</span>
<span class="nc" id="L186">		Connection con = null;</span>
<span class="nc" id="L187">		String fetchUser = null;</span>

		try {
<span class="nc" id="L190">			con = DBConnect.getConnection();</span>
<span class="nc" id="L191">			stmt = con.createStatement();</span>
<span class="nc" id="L192">			fetchUser = &quot;select user_id from st_lms_user_master where user_name='bomaster'&quot;;</span>
<span class="nc" id="L193">			rs = stmt.executeQuery(fetchUser);</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">			if (rs.next()) </span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">				if (userId == rs.getInt(&quot;user_id&quot;)) </span>
<span class="nc" id="L196">					return true;</span>
<span class="nc" id="L197">		}catch (SQLException e) {</span>
<span class="nc" id="L198">		logger.error(&quot;SQL Exception  : - &quot; + e);</span>
<span class="nc" id="L199">		}catch (Exception e) {</span>
<span class="nc" id="L200">			logger.error(&quot;General Exception  : - &quot; + e);</span>
		} finally {
<span class="nc" id="L202">			DBConnect.closeConnection(con, stmt, rs);</span>
<span class="nc" id="L203">		}</span>
<span class="nc" id="L204">		return false;</span>
	}

	/////mmmmmmmmmmmmmmmmmmmmm
	
/*	@SuppressWarnings({ &quot;finally&quot;, &quot;unchecked&quot;, &quot;unchecked&quot;, &quot;unchecked&quot;, &quot;unchecked&quot; })
	public Map getDrawNames(String gameNo,String date)
	{
		Connection con = DBConnect.getConnection();
		Map drawNames=new HashMap();
		try {
			Statement stmt = con.createStatement();
			String fetchUser = &quot;select draw_name from ge_draw_master_&quot;
				+gameNo+
				&quot;where draw_datetime like '%&quot;
				+date+
				&quot;%'&quot;;
			ResultSet rs = stmt.executeQuery(fetchUser);
			
			if (rs.next()) {
				drawNames.put(gameNo, rs.getString(1));
			}
			
		} catch (Exception e) {
			e.printStackTrace();
		} finally {
			try {
				con.close();
			} catch (SQLException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
			return drawNames;
		}
		

		
	}
	*/
	public ArrayList&lt;CancelTicketBean&gt; cancelBlkTicketAtBO(int cancelDuration ,boolean isCancel,
			String[] ticketNumArr, String[] reasons, UserInfoBean userInfoBO,
			String search_type, String gameNo, String refMerchantId,
			Map&lt;Integer, Map&lt;Integer, String&gt;&gt; drawIdTableMap,String cancellationCharges)
			throws LMSException {
<span class="nc" id="L248">		logger.debug(&quot;********cancelBlkTicketAtBO******&quot;+ Arrays.asList(ticketNumArr) + &quot;With the Search Type&quot; + search_type);</span>
<span class="nc" id="L249">		ArrayList&lt;CancelTicketBean&gt; canTktList = new ArrayList&lt;CancelTicketBean&gt;();</span>
<span class="nc" id="L250">		int len = ticketNumArr.length;</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">		for (int i=0; i&lt;len; i++) {</span>
<span class="nc" id="L252">			logger.info(&quot;***ticketNum***&quot; + ticketNumArr[i]);</span>
<span class="nc" id="L253">			CancelTicketBean cancelTicketBean = new CancelTicketBean();</span>
<span class="nc" id="L254">			cancelTicketBean.setDrawIdTableMap(drawIdTableMap);</span>
<span class="nc" id="L255">			cancelTicketBean.setTicketNo(ticketNumArr[i]);</span>
<span class="nc" id="L256">			cancelTicketBean.setCancelChannel(&quot;LMS_Web&quot;);</span>
<span class="nc" id="L257">			cancelTicketBean.setRefMerchantId(refMerchantId);</span>
<span class="nc" id="L258">			cancelTicketBean.setCancelType(&quot;LAST_SOLD_TICKET&quot;);</span>
<span class="nc" id="L259">			cancelTicketBean.setCancelDuaraion(isCancel);</span>
<span class="nc" id="L260">			cancelTicketBean.setCancelDuration(cancelDuration);</span>
<span class="nc" id="L261">			cancelTicketBean.setReason(reasons[i]);</span>
			// call cancelTicketAtBO
<span class="nc" id="L263">			cancelTicketBean = cancelTicketAtBO(cancelTicketBean, userInfoBO,search_type, gameNo,cancellationCharges);</span>
<span class="nc" id="L264">			canTktList.add(cancelTicketBean);</span>
		}

<span class="nc" id="L267">		return canTktList;</span>
	}

	public SchedulerBean cancelDraw(DrawScheduleBean drawScheduleBean, UserInfoBean userInfoBean)
	throws Exception {
<span class="nc" id="L272">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L273">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L274">		sReq.setServiceName(ServiceName.DRAW_MGMT);</span>
<span class="nc" id="L275">		sReq.setServiceMethod(ServiceMethodName.DRAWGAME_CANCEL_DRAW);</span>
<span class="nc" id="L276">		sReq.setServiceData(drawScheduleBean);</span>
<span class="nc" id="L277">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L278">		sRes = delegate.getResponse(sReq);</span>
<span class="nc" id="L279">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L280">		String responseString=sRes.getResponseData().toString();</span>
<span class="nc" id="L281">		Type elementType = new TypeToken&lt;SchedulerBean&gt;() {}.getType();</span>
<span class="nc" id="L282">		SchedulerBean drawBean = new Gson().fromJson(responseString, elementType);</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">		if(&quot;cancelAll&quot;.equalsIgnoreCase(drawScheduleBean.getAction())){</span>
			CancelTicketBean cancelBean;
			UserInfoBean userBean;
<span class="nc" id="L286">			DrawGameRPOSHelper helper = new DrawGameRPOSHelper();</span>
<span class="nc" id="L287">			PreparedStatement pstmt = null;</span>
<span class="nc" id="L288">			ResultSet rs = null;</span>
<span class="nc" id="L289">			String refMerchantId = (String) LMSUtility.sc.getAttribute(&quot;REF_MERCHANT_ID&quot;);</span>
<span class="nc" id="L290">			List&lt;DrawScheduleBean&gt; drawList = drawBean.getDrawScheduleList();</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">			for(DrawScheduleBean drwBean : drawList){</span>
<span class="nc" id="L292">				ArrayList&lt;String&gt; tktList = drwBean.getTktList();</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">				if(!tktList.isEmpty()){</span>
<span class="nc" id="L294">					String qry = &quot;select sale.ticket_nbr, um.user_id, um.organization_id, um.organization_type, om.parent_id from st_dg_ret_sale_&quot; + drawBean.getGameNo() </span>
					+ &quot; sale inner join st_lms_organization_master om inner join st_lms_user_master um on sale.retailer_org_id = um.organization_id and um.organization_id = om.organization_id where sale.ticket_nbr in (&quot;
					+ tktList.toString().replace(&quot;[&quot;, &quot;&quot;).replace(&quot;]&quot;, &quot;&quot;).replace(&quot;, &quot;, &quot;,&quot;) + &quot;)&quot;;
<span class="nc" id="L297">					System.out.println(&quot;ticket cancel select query: &quot;+ qry);</span>
<span class="nc" id="L298">					pstmt = con.prepareStatement(qry);</span>
<span class="nc" id="L299">					rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">					while(rs.next()){</span>
<span class="nc" id="L301">						userBean = new UserInfoBean();</span>
<span class="nc" id="L302">						cancelBean = new CancelTicketBean();</span>
<span class="nc" id="L303">						String tktNo = rs.getString(&quot;ticket_nbr&quot;);</span>
<span class="nc" id="L304">						userBean.setUserId(rs.getInt(&quot;user_id&quot;));</span>
<span class="nc" id="L305">						userBean.setUserOrgId(rs.getInt(&quot;organization_id&quot;));</span>
<span class="nc" id="L306">						userBean.setParentOrgId(rs.getInt(&quot;parent_id&quot;));</span>
<span class="nc" id="L307">						cancelBean.setTicketNo(tktNo + Util.getRpcAppenderForTickets(tktNo.length()));</span>
<span class="nc" id="L308">						cancelBean.setGameNo(drawBean.getGameNo());</span>
<span class="nc" id="L309">						cancelBean.setPartyId(userBean.getUserOrgId());</span>
<span class="nc" id="L310">						cancelBean.setPartyType(rs.getString(&quot;organization_type&quot;));</span>
<span class="nc" id="L311">						cancelBean.setUserId(userBean.getUserId());</span>
<span class="nc" id="L312">						cancelBean.setCancelChannel(&quot;DRAW_MGMT&quot;);</span>
<span class="nc" id="L313">						cancelBean.setRefMerchantId(refMerchantId);</span>
<span class="nc" id="L314">						cancelBean.setAutoCancel(&quot;CANCEL_SERVER&quot;);</span>
<span class="nc" id="L315">						cancelBean.setAutoCancel(true);</span>
<span class="nc" id="L316">						helper.cancelTicket(cancelBean, userBean, true,&quot;CANCEL_SERVER&quot;);</span>
<span class="nc" id="L317">					}</span>
				}
<span class="nc" id="L319">			}</span>
		}
<span class="nc bnc" id="L321" title="All 2 branches missed.">		if (sRes.getIsSuccess()) {</span>
		
			//rescheduleJob(drawScheduleBean.getGameNo());
<span class="nc" id="L324">			PreparedStatement ps = con.prepareStatement(&quot;insert into st_dg_draw_status_change_history (user_id, action, date, remarks) values (?,?,?,?)&quot;);</span>
<span class="nc" id="L325">			ps.setInt(1, userInfoBean.getUserId());</span>
<span class="nc" id="L326">			ps.setString(2, &quot;CANCEL&quot;);</span>
<span class="nc" id="L327">			ps.setString(3, Util.getCurrentTimeString());</span>
<span class="nc" id="L328">			ps.setString(4, &quot;Cancelled draws &quot;+drawScheduleBean.getDrawIdList());</span>
<span class="nc" id="L329">			ps.executeUpdate();</span>
<span class="nc" id="L330">			new DrawGameRPOS().newData();</span>
<span class="nc" id="L331">			new SetResetUserPasswordAction().logOutAllRets();</span>
			
<span class="nc" id="L333">			String drawStatus =drawScheduleBean.getStatus();</span>
<span class="nc" id="L334">			String filename =&quot;&quot;;</span>
<span class="nc" id="L335">			String subject =&quot; IMPORTANT DRAW Cancel ALERT &quot;;</span>
<span class="nc" id="L336">			StringBuilder bodyText = new StringBuilder();</span>
<span class="nc" id="L337">			bodyText.append(&quot;&lt;b&gt;Hello Support Team &lt;/b&gt; &lt;br&gt; &lt;/br&gt;  Draw Ids: &quot;).append(drawScheduleBean.getDrawIdList()).append(&quot;Has Been Canceled. Draw  Status: &quot;).append(drawStatus).append(&quot; In Game NO: &quot;).append(drawScheduleBean.getGameNo());</span>
<span class="nc" id="L338">			List&lt;String&gt; to  =CommonFunctionsHelper.getEmailIdsForDrawMgmtNotification();</span>
<span class="nc bnc" id="L339" title="All 4 branches missed.">			if(to!=null&amp;&amp;to.size()&gt;0){</span>
<span class="nc" id="L340">				MailSender  sendMail = new MailSender(ConfigurationVariables.from,ConfigurationVariables.password,to,subject,bodyText.toString(), filename);</span>
<span class="nc" id="L341">				sendMail.setDaemon(true);</span>
<span class="nc" id="L342">				sendMail.start();</span>
<span class="nc" id="L343">				logger.info(&quot;Mail Has Been Send&quot;);</span>
			}
			
			
			
			
			
		}
<span class="nc" id="L351">		return drawBean;</span>
	}
	
	public SchedulerBean freezeDraw(DrawScheduleBean drawScheduleBean, UserInfoBean userBean)
	throws Exception {
<span class="nc" id="L356">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L357">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L358">		sReq.setServiceName(ServiceName.DRAW_MGMT);</span>
<span class="nc" id="L359">		sReq.setServiceMethod(ServiceMethodName.DRAWGAME_FREEZE_DRAW);</span>
<span class="nc" id="L360">		sReq.setServiceData(drawScheduleBean);</span>
<span class="nc" id="L361">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L362">		sRes = delegate.getResponse(sReq);</span>
<span class="nc bnc" id="L363" title="All 2 branches missed.">		if (sRes.getIsSuccess()) {</span>
			//rescheduleJob(drawScheduleBean.getGameNo());
<span class="nc" id="L365">			Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L366">			PreparedStatement ps = con.prepareStatement(&quot;insert into st_dg_draw_status_change_history (user_id, action, date, remarks) values (?,?,?,?)&quot;);</span>
<span class="nc" id="L367">			ps.setInt(1, userBean.getUserId());</span>
<span class="nc" id="L368">			ps.setString(2, &quot;FREEZE&quot;);</span>
<span class="nc" id="L369">			ps.setString(3,Util.getCurrentTimeString());</span>
<span class="nc" id="L370">			ps.setString(4, &quot;Freezed draws &quot;+drawScheduleBean.getDrawIdList());</span>
<span class="nc" id="L371">			ps.executeUpdate();</span>
<span class="nc" id="L372">			new DrawGameRPOS().newData();</span>
<span class="nc" id="L373">			new SetResetUserPasswordAction().logOutAllRets();</span>
			
<span class="nc" id="L375">			String drawStatus =drawScheduleBean.getStatus();</span>
<span class="nc" id="L376">			String filename =&quot;&quot;;</span>
<span class="nc" id="L377">			String subject =&quot; IMPORTANT DRAW FREEZE  ALERT &quot;;</span>
<span class="nc" id="L378">			StringBuilder bodyText = new StringBuilder();</span>
<span class="nc" id="L379">			bodyText.append(&quot;&lt;b&gt;Hello Support Team &lt;/b&gt; &lt;br&gt; &lt;/br&gt;  Draw Ids: &quot;).append(drawScheduleBean.getDrawIdList()).append(&quot;Has Been Freezed  . Draw  Status: &quot;).append(drawStatus).append(&quot; In Game NO: &quot;).append(drawScheduleBean.getGameNo());</span>
<span class="nc" id="L380">			List&lt;String&gt; to  =CommonFunctionsHelper.getEmailIdsForDrawMgmtNotification();</span>
<span class="nc bnc" id="L381" title="All 4 branches missed.">			if(to!=null&amp;&amp;to.size()&gt;0){</span>
<span class="nc" id="L382">				MailSender  sendMail = new MailSender(ConfigurationVariables.from,ConfigurationVariables.password,to,subject,bodyText.toString(), filename);</span>
<span class="nc" id="L383">				sendMail.setDaemon(true);</span>
<span class="nc" id="L384">				sendMail.start();</span>
<span class="nc" id="L385">				logger.info(&quot;Mail Has Been Send&quot;);</span>
			}
		}
		
<span class="nc" id="L389">		String responseString=sRes.getResponseData().toString();</span>
<span class="nc" id="L390">		Type elementType = new TypeToken&lt;SchedulerBean&gt;() {}.getType();</span>
<span class="nc" id="L391">		SchedulerBean schedulerBean = new Gson().fromJson(responseString, elementType);</span>
<span class="nc" id="L392">		return schedulerBean;</span>
	}
	
	public CancelTicketBean cancelTicketAtBO(CancelTicketBean cancelTicketBean,	UserInfoBean userInfoBO,String search_type,String gameNo,String cancellationCharges) throws LMSException {

<span class="nc" id="L397">		int gameNbr = 0;</span>
<span class="nc" id="L398">		int gameId = 0;</span>
<span class="nc" id="L399">		int retUserId = 0;</span>
<span class="nc" id="L400">		int barCodeCount = -1;</span>
<span class="nc" id="L401">		String ticketNumber = null;</span>

<span class="nc" id="L403">		ResultSet rs = null;</span>
<span class="nc" id="L404">		Connection con = null;</span>
<span class="nc" id="L405">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L406">		Statement stmt = null ;</span>
<span class="nc" id="L407">		ResultSet rs1 = null ;</span>
<span class="nc" id="L408">		UserInfoBean retUserBean = null;</span>
<span class="nc" id="L409">		ValidateTicketBean tktBean=null;</span>

		try {
<span class="nc" id="L412">			boolean isPromo = false;</span>
<span class="nc" id="L413">			cancelTicketBean.setPromo(isPromo) ;</span>
<span class="nc" id="L414">			con = DBConnect.getConnection();</span>
<span class="nc" id="L415">			con.setAutoCommit(false);</span>
<span class="nc" id="L416">			ticketNumber = Util.getTicketNumber(cancelTicketBean.getTicketNo(),3);</span>
<span class="nc" id="L417">			gameNbr = getGamenoFromTktnumber(ticketNumber);</span>
<span class="nc" id="L418">			gameId = Util.getGameIdFromGameNumber(gameNbr);</span>
<span class="nc bnc" id="L419" title="All 2 branches missed.">			if (gameId == 0) </span>
<span class="nc" id="L420">				throw new LMSException(LMSErrors.INVALID_TICKET_ERROR_CODE,LMSErrors.INVALID_TICKET_ERROR_MESSAGE);</span>
<span class="nc" id="L421">				cancelTicketBean.setGameId(gameId);</span>

<span class="nc bnc" id="L423" title="All 2 branches missed.">			if (cancelTicketBean.getTicketNo().length() == com.skilrock.lms.common.ConfigurationVariables.barcodeCount) </span>
<span class="nc" id="L424">				barCodeCount = Integer.parseInt(Util.getBarCodeCountFromTicketNumber(cancelTicketBean.getTicketNo()));</span>

<span class="nc bnc" id="L426" title="All 2 branches missed.">			if (&quot;RAFFLE&quot;.equalsIgnoreCase(Util.getGameType(gameId))) </span>
<span class="nc" id="L427">				throw new LMSException(LMSErrors.INVALID_CANCEL_TICKET_DATA_ERROR_CODE,LMSErrors.INVALID_CANCEL_TICKET_DATA_ERROR_MESSAGE);</span>
<span class="nc bnc" id="L428" title="All 2 branches missed.">			else if(ReportUtility.fetchGameMapWithoutPromo().containsKey(gameId))</span>
			{
			    //No Promo ticket cancellation directly
<span class="nc" id="L431">				stmt = con.createStatement() ;</span>
<span class="nc" id="L432">				String checkPromoTicket = &quot;select promo_ticket_nbr from ge_sale_promo_ticket_mapping where promo_ticket_nbr = &quot;+ticketNumber.substring(0, ticketNumber.length()-1) ;</span>
<span class="nc" id="L433">				rs1 = stmt.executeQuery(checkPromoTicket) ;</span>
<span class="nc bnc" id="L434" title="All 2 branches missed.">				if(rs1.next())</span>
<span class="nc" id="L435">					throw new LMSException(LMSErrors.INVALID_CANCEL_PROMOTIONAL_TICKET_DATA_ERROR_CODE,LMSErrors.INVALID_CANCEL_PROMOTIONAL_TICKET_DATA_ERROR_MESSAGE);</span>
				else{
<span class="nc" id="L437">					isPromo = true ;</span>
				}
			}
			
<span class="nc" id="L441">			retUserId = Util.getUserIdFromTicket(ticketNumber);</span>
			
<span class="nc" id="L443">			pstmt = con.prepareStatement(&quot;select um.user_id,om.organization_id,um.organization_type,um.user_name,om.parent_id from st_lms_user_master um,st_lms_organization_master om where um.organization_id=om.organization_id and  um.user_id=?&quot;);</span>
<span class="nc" id="L444">			pstmt.setInt(1, retUserId);</span>
<span class="nc" id="L445">			logger.info(&quot;****select ticket cancel info query*****&quot; + pstmt);</span>
<span class="nc" id="L446">			rs = pstmt.executeQuery();</span>
			
<span class="nc bnc" id="L448" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L449">				cancelTicketBean.setUserId(rs.getInt(&quot;user_id&quot;));</span>
<span class="nc" id="L450">				cancelTicketBean.setPartyId(rs.getInt(&quot;organization_id&quot;));</span>
<span class="nc" id="L451">				cancelTicketBean.setPartyType(rs.getString(&quot;organization_type&quot;));</span>
				
<span class="nc" id="L453">				retUserBean = new UserInfoBean();</span>
<span class="nc" id="L454">				retUserBean.setUserId(rs.getInt(&quot;user_id&quot;));</span>
<span class="nc" id="L455">				retUserBean.setParentOrgId(rs.getInt(&quot;parent_id&quot;));</span>
<span class="nc" id="L456">				retUserBean.setUserName(rs.getString(&quot;user_name&quot;));</span>
<span class="nc" id="L457">				retUserBean.setUserOrgId(rs.getInt(&quot;organization_id&quot;));</span>
			}else{
<span class="nc" id="L459">				logger.debug(&quot;User Id Not Found In Data Base&quot;);</span>
<span class="nc" id="L460">				throw new LMSException(LMSErrors.INVALID_TICKET_ERROR_CODE,LMSErrors.INVALID_TICKET_ERROR_MESSAGE);</span>
				}

<span class="nc" id="L463">			logger.debug(&quot;*Inside Cancel Ticket&quot;);</span>
<span class="nc" id="L464">			tktBean = Util.validateTkt(ticketNumber);</span>
<span class="nc bnc" id="L465" title="All 2 branches missed.">			if (tktBean.isValid()) {</span>
<span class="nc" id="L466">				boolean isPromoCancelled = true;</span>
<span class="nc" id="L467">				cancelTicketBean.setAutoCancel(&quot;CANCEL_MANUAL&quot;);</span>
<span class="nc" id="L468">				List&lt;String&gt; promoTicketList = orgOnLineSaleCreditUpdation.getAssociatedPromoTicket(tktBean.getTicketNumInDB(),con);</span>
<span class="nc bnc" id="L469" title="All 4 branches missed.">				if (promoTicketList != null &amp;&amp; promoTicketList.size() &gt; 0) {</span>
<span class="nc bnc" id="L470" title="All 2 branches missed.">					for (int i = 0; i &lt; promoTicketList.size(); i++) {</span>
<span class="nc" id="L471">						int gameNmbr = getGamenoFromTktnumber(promoTicketList.get(i)+Util.getRpcAppenderForTickets(promoTicketList.get(i).length()));</span>
<span class="nc" id="L472">						String gameType = Util.getGameType(gameNmbr);</span>
<span class="nc" id="L473">						cancelTicketBean.setReprintCount(tktBean.getReprintCount());</span>

<span class="nc bnc" id="L475" title="All 2 branches missed.">						if (&quot;RAFFLE&quot;.equalsIgnoreCase(gameType)) { // Cancel RAFFLE Ticket. </span>
<span class="nc" id="L476">							cancelTicketBean.setPromoTicketList(promoTicketList);</span>
<span class="nc" id="L477">							isPromoCancelled = cancelRaffleTicket(cancelTicketBean, retUserBean,cancellationCharges, con, userInfoBO.getUserId(),search_type);</span>
						} else {  								   // Cancel Associated Promotional Ticket. 
<span class="nc" id="L479">							cancelTicketBean.setTicketNo(promoTicketList.get(i));  </span>
<span class="nc" id="L480">							cancelTicketBean.setBarCodeCount(-1);</span>
<span class="nc" id="L481">							cancelTicketBean.setGameNo(gameNmbr);</span>
<span class="nc" id="L482">							cancelTicketBean.setGameId(Util.getGameIdFromGameNumber(gameNmbr));</span>
<span class="nc" id="L483">							isPromoCancelled = cancelStdTkt(retUserBean,cancelTicketBean, con, cancellationCharges,userInfoBO.getUserId(), search_type);</span>
						}
					}
				}	
<span class="nc bnc" id="L487" title="All 2 branches missed.">				if (isPromoCancelled) {   // Cancel Standard Ticket after cancelling all the Promotional tickets if Associated.</span>
<span class="nc" id="L488">					cancelTicketBean.setPromo(isPromo);</span>
<span class="nc" id="L489">					cancelTicketBean.setTicketNo(tktBean.getTicketNumInDB());</span>
<span class="nc" id="L490">					cancelTicketBean.setReprintCount(tktBean.getReprintCount());</span>
<span class="nc" id="L491">					cancelTicketBean.setGameNo(tktBean.getGameNo());</span>
<span class="nc" id="L492">					cancelTicketBean.setBarCodeCount(barCodeCount);</span>
<span class="nc" id="L493">					cancelTicketBean.setGameId(Util.getGameIdFromGameNumber(tktBean.getGameNo()));</span>
<span class="nc bnc" id="L494" title="All 2 branches missed.">					if (cancelStdTkt(retUserBean, cancelTicketBean, con, cancellationCharges, userInfoBO.getUserId(), search_type)) {</span>
<span class="nc" id="L495">						con.commit();</span>
					}
				}
<span class="nc" id="L498">			} else {</span>
<span class="nc" id="L499">				logger.debug(&quot;Ticket Validation Failed...&quot;);</span>
<span class="nc" id="L500">				throw new LMSException(LMSErrors.INVALID_TICKET_ERROR_CODE,LMSErrors.INVALID_TICKET_ERROR_MESSAGE);</span>
			}
<span class="nc" id="L502">			cancelTicketBean.setTicketNo(ticketNumber);</span>
<span class="nc" id="L503">		} catch (LMSException e) {</span>
<span class="nc" id="L504">			cancelTicketBean.setValid(false);</span>
<span class="nc" id="L505">			cancelTicketBean.setErrMsg(e.getErrorMessage());</span>
<span class="nc" id="L506">		}catch (Exception e) {</span>
<span class="nc" id="L507">			cancelTicketBean.setValid(false);</span>
<span class="nc" id="L508">			e.printStackTrace();</span>
			try {
<span class="nc" id="L510">				con.rollback();</span>
<span class="nc" id="L511">			} catch (SQLException ex) {</span>
<span class="nc" id="L512">				ex.printStackTrace();</span>
<span class="nc" id="L513">			}</span>
<span class="nc" id="L514">			throw new LMSException(LMSErrors.BO_CANCEL_TICKET_DATA_ERROR_CODE,LMSErrors.BO_CANCEL_TICKET_DATA_ERROR_MESSAGE);</span>
		} finally {
<span class="nc" id="L516">			DBConnect.closeConnection(con, pstmt, rs);</span>
<span class="nc" id="L517">		}</span>
<span class="nc" id="L518">		return cancelTicketBean;</span>
	}


	
	public SchedulerBean changeFreezeTime(DrawScheduleBean drawScheduleBean, UserInfoBean userBean)
			throws Exception {
<span class="nc" id="L525">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L526">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L527">		sReq.setServiceName(ServiceName.DRAW_MGMT);</span>
<span class="nc" id="L528">		sReq.setServiceMethod(ServiceMethodName.DRAWGAME_CHANGE_FREEZETIME);</span>
<span class="nc" id="L529">		sReq.setServiceData(drawScheduleBean);</span>
<span class="nc" id="L530">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L531">		sRes = delegate.getResponse(sReq);</span>
<span class="nc" id="L532">		logger.debug(&quot;response in dgm helper------&quot; + sRes);</span>
<span class="nc bnc" id="L533" title="All 2 branches missed.">		if (sRes.getIsSuccess()) {</span>
		
				
			//rescheduleJob(drawScheduleBean.getGameNo());
<span class="nc" id="L537">			Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L538">			PreparedStatement ps = con.prepareStatement(&quot;insert into st_dg_draw_status_change_history (user_id, action, date, remarks) values (?,?,?,?)&quot;);</span>
<span class="nc" id="L539">			ps.setInt(1, userBean.getUserId());</span>
<span class="nc" id="L540">			ps.setString(2, &quot;CHANGE FREEZE TIME&quot;);</span>
<span class="nc" id="L541">			ps.setString(3, Util.getCurrentTimeString());</span>
<span class="nc" id="L542">			ps.setString(4, &quot;Changed Freeze times of draws &quot;+drawScheduleBean.getDrawIdList());</span>
<span class="nc" id="L543">			ps.executeUpdate();</span>
<span class="nc" id="L544">			new DrawGameRPOS().newData();</span>
<span class="nc" id="L545">			new SetResetUserPasswordAction().logOutAllRets();</span>
			
			
<span class="nc" id="L548">			String drawStatus =drawScheduleBean.getStatus();</span>
<span class="nc" id="L549">			String filename =&quot;&quot;;</span>
<span class="nc" id="L550">			String subject =&quot; IMPORTANT DRAW FREEZE TIME CHANGE ALERT &quot;;</span>
<span class="nc" id="L551">			StringBuilder bodyText = new StringBuilder();</span>
<span class="nc" id="L552">			bodyText.append(&quot;&lt;b&gt;Hello Support Team &lt;/b&gt; &lt;br&gt; &lt;/br&gt; Freeze Time For  Draw Ids: &quot;).append(drawScheduleBean.getDrawIdList()).append(&quot;Has Been Changed. Draw  Status: &quot;).append(drawStatus).append(&quot; In Game NO: &quot;).append(drawScheduleBean.getGameNo());</span>
<span class="nc" id="L553">			List&lt;String&gt; to  =CommonFunctionsHelper.getEmailIdsForDrawMgmtNotification();</span>
<span class="nc bnc" id="L554" title="All 4 branches missed.">			if(to!=null&amp;&amp;to.size()&gt;0){</span>
<span class="nc" id="L555">				MailSender  sendMail = new MailSender(ConfigurationVariables.from,ConfigurationVariables.password,to,subject,bodyText.toString(), filename);</span>
<span class="nc" id="L556">				sendMail.setDaemon(true);</span>
<span class="nc" id="L557">				sendMail.start();</span>
<span class="nc" id="L558">				logger.info(&quot;Mail Has Been Send&quot;);</span>
			}
			
			
		}
<span class="nc" id="L563">		String responseString=sRes.getResponseData().toString();</span>
<span class="nc" id="L564">		Type elementType = new TypeToken&lt;SchedulerBean&gt;() {}.getType();</span>
<span class="nc" id="L565">		SchedulerBean schedulerBean = new Gson().fromJson(responseString, elementType);</span>
<span class="nc" id="L566">		return schedulerBean;</span>
	}

	public Object checkNextDraw(DrawScheduleBean drawScheduleBean)
			throws Exception {
<span class="nc" id="L571">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L572">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L573">		sReq.setServiceName(ServiceName.DRAWGAME);</span>
<span class="nc" id="L574">		sReq.setServiceMethod(ServiceMethodName.DRAWGAME_CHECK_NEXTDRAW);</span>
<span class="nc" id="L575">		sReq.setServiceData(drawScheduleBean);</span>
<span class="nc" id="L576">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L577">		sRes = delegate.getResponse(sReq);</span>
<span class="nc" id="L578">		return (Object) sRes.getResponseData();</span>
	}

	@SuppressWarnings(&quot;unchecked&quot;)
	public List&lt;DrawPanelSaleBean&gt; DrawMgmtReport(List&lt;String&gt; list) {
<span class="nc" id="L583">		List&lt;DrawPanelSaleBean&gt; finalList = null;</span>
<span class="nc" id="L584">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L585">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L586">		sReq.setServiceName(ServiceName.REPORTS_MGMT);</span>
<span class="nc" id="L587">		sReq.setServiceMethod(ServiceMethodName.DRAW_PANEL_SALE);</span>
<span class="nc" id="L588">		sReq.setServiceData(list);</span>
<span class="nc" id="L589">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L590">		sRes = delegate.getResponse(sReq);</span>
		
//		if(sRes.getIsSuccess())
		{
<span class="nc" id="L594">			Type type = new TypeToken&lt;List&lt;DrawPanelSaleBean&gt;&gt;(){}.getType();</span>
<span class="nc" id="L595">			finalList = (List&lt;DrawPanelSaleBean&gt;)new Gson().fromJson((JsonElement)sRes.getResponseData(), type);</span>
		}
		
<span class="nc" id="L598">		logger.info(&quot;***DRAW_PANEL_SALE***&quot;	+ finalList);</span>
<span class="nc" id="L599">		return finalList;</span>
	}

	public LinkedHashMap&lt;String, Map&lt;String, String&gt;&gt; fetchAdvMessageData(
			String searchType) throws Exception {
<span class="nc" id="L604">		LinkedHashMap&lt;String, Map&lt;String, String&gt;&gt; retMap = new LinkedHashMap&lt;String, Map&lt;String, String&gt;&gt;();</span>
		
<span class="nc" id="L606">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L607">		Statement drawStmt = con.createStatement();</span>
<span class="nc" id="L608">		String selRet = null;</span>
<span class="nc" id="L609">		Map&lt;String, String&gt; retList = null;</span>
<span class="nc" id="L610">		String type = null;</span>

<span class="nc" id="L612">			String orgCodeQry = &quot; slom.name orgCode  &quot;;</span>

		
<span class="nc bnc" id="L615" title="All 2 branches missed.">		if ((LMSFilterDispatcher.orgFieldType).equalsIgnoreCase(&quot;CODE&quot;)) {</span>
<span class="nc" id="L616">			orgCodeQry = &quot; slom.org_code orgCode &quot;;</span>


<span class="nc bnc" id="L619" title="All 2 branches missed.">		} else if ((LMSFilterDispatcher.orgFieldType)</span>
				.equalsIgnoreCase(&quot;CODE_NAME&quot;)) {
<span class="nc" id="L621">			orgCodeQry = &quot; concat(slom.org_code,'_',slom.name)  orgCode &quot;;</span>
		

<span class="nc bnc" id="L624" title="All 2 branches missed.">		} else if ((LMSFilterDispatcher.orgFieldType)</span>
				.equalsIgnoreCase(&quot;NAME_CODE&quot;)) {
<span class="nc" id="L626">			orgCodeQry = &quot; concat(slom.name,'_',slom.org_code)  orgCode &quot;;</span>
		

		}	
		


<span class="nc bnc" id="L633" title="All 2 branches missed.">		if (&quot;AGENTWISE&quot;.equalsIgnoreCase(searchType)) {</span>
<span class="nc" id="L634">			selRet = &quot;select &quot;+orgCodeQry+&quot;,upper(parent.name) as searchType,slom.organization_id from st_lms_organization_master slom,(select name,organization_id from st_lms_organization_master where parent_id=(SELECT organization_id FROM  st_lms_user_master  WHERE organization_type='BO' AND isrolehead='Y' LIMIT 1 )) parent, st_lms_user_master slum where slom.parent_id=parent.organization_id and slom.organization_id = slum.organization_id order by &quot;+QueryManager.getAppendOrgOrder();</span>
		} else {
<span class="nc" id="L636">			selRet = &quot;select &quot;+orgCodeQry+&quot;,slom.organization_id,upper(slom.city) searchType from st_lms_organization_master slom,(select name,organization_id from st_lms_organization_master where parent_id=(SELECT organization_id FROM  st_lms_user_master  WHERE organization_type='BO' AND isrolehead='Y' LIMIT 1 )) parent, st_lms_user_master slum where slom.parent_id=parent.organization_id and slom.organization_id = slum.organization_id order by &quot;+QueryManager.getAppendOrgOrder();</span>
		}
		

		/*	if (&quot;AGENTWISE&quot;.equalsIgnoreCase(searchType)) {
			selRet = &quot;SELECT UPPER(slom.name) NAME,UPPER(parent.name) AS searchType,slom.organization_id FROM st_lms_organization_master slom,(SELECT a.NAME,a.organization_id FROM st_lms_organization_master a  INNER JOIN (SELECT organization_id FROM  st_lms_user_master  WHERE organization_type='BO' AND isrolehead='Y' LIMIT 1 ) b   ON a. parent_id=b.organization_id) parent, st_lms_user_master slum WHERE slom.parent_id=parent.organization_id AND slom.organization_id = slum.organization_id   ORDER BY searchType,NAME;&quot;;
		} else {
			selRet = &quot;SELECT UPPER(slom.name) NAME,slom.organization_id,UPPER(slom.city) searchType FROM st_lms_organization_master slom,(SELECT a.NAME,a.organization_id FROM st_lms_organization_master a  INNER JOIN (SELECT organization_id FROM  st_lms_user_master  WHERE organization_type='BO' AND isrolehead='Y' LIMIT 1 ) b   ON a. parent_id=b.organization_id) parent, st_lms_user_master slum WHERE slom.parent_id=parent.organization_id AND slom.organization_id = slum.organization_id   ORDER BY searchType,NAME;&quot;;
		}*/
<span class="nc" id="L645">		ResultSet retRs = drawStmt.executeQuery(selRet);</span>
<span class="nc bnc" id="L646" title="All 2 branches missed.">		while (retRs.next()) {</span>
<span class="nc" id="L647">			type = retRs.getString(&quot;searchType&quot;);</span>
<span class="nc bnc" id="L648" title="All 2 branches missed.">			if (retMap.containsKey(type)) {</span>
<span class="nc" id="L649">				retMap.get(type).put(retRs.getString(&quot;organization_id&quot;), retRs.getString(&quot;orgCode&quot;));</span>
			} else {
<span class="nc" id="L651">				retList = new LinkedHashMap&lt;String, String&gt;();</span>
<span class="nc" id="L652">				retList.put(retRs.getString(&quot;organization_id&quot;), retRs.getString(&quot;orgCode&quot;));</span>
<span class="nc" id="L653">				retMap.put(type, retList);</span>
			}
		}
<span class="nc" id="L656">		DBConnect.closeCon(con);</span>
<span class="nc" id="L657">		return retMap;</span>

	}

	/*public Map&lt;Integer, Map&lt;String, String&gt;&gt; getAdvMsgForEdit() {
		Map&lt;Integer, Map&lt;String, String&gt;&gt; advMap = new TreeMap&lt;Integer, Map&lt;String, String&gt;&gt;();
		Connection con = DBConnect.getConnection();
		PreparedStatement pstmt = null;
		try {
			pstmt = con
					.prepareStatement(&quot;select msg_id, date, msg_text, status, msg_location, msg_for, activity  from st_dg_adv_msg_master where status = 'ACTIVE' and editable='YES'&quot;);
			ResultSet rs = pstmt.executeQuery();
			while (rs.next()) {
				
				Map&lt;String, String&gt; tmp = new LinkedHashMap&lt;String, String&gt;();
				tmp.put(&quot;Date&quot;, rs.getTimestamp(&quot;date&quot;).toString());
				tmp.put(&quot;Message Text&quot;, rs.getString(&quot;msg_text&quot;));
				tmp.put(&quot;status&quot;, rs.getString(&quot;status&quot;));
				tmp.put(&quot;location&quot;, rs.getString(&quot;msg_location&quot;));
				tmp.put(&quot;Message For&quot;, rs.getString(&quot;msg_for&quot;));
				tmp.put(&quot;Activity&quot;, rs.getString(&quot;activity&quot;));
				advMap.put(rs.getInt(&quot;msg_id&quot;), tmp);
			}
		} catch (Exception e) {
			e.printStackTrace();
		} finally {
			try {
				con.close();
			} catch (SQLException e) {
				e.printStackTrace();
			}
		}
		return advMap;
	}*/

	/*public boolean editAdvMsgStatus(int msgId, int userId, int orgId) {
		
		Connection con = null;
		boolean status = false;
		StringBuilder query=null;
		PreparedStatement pstmt = null;
		
		try {
			con = DBConnect.getConnection();
			con.setAutoCommit(false);
			query= new StringBuilder(&quot;insert into st_dg_adv_msg_master_history select msg_id, date, creator_user_id,msg_text, msg_for , 'INACTIVE', ? ,?  from st_dg_adv_msg_master where msg_id = ?&quot;);
			
			pstmt = con.prepareStatement(query.toString());
			pstmt.setString(1, new java.sql.Timestamp(new java.util.Date().getTime()).toString());
			pstmt.setString(2, userId + &quot;&quot;);
			pstmt.setInt(3, msgId);
			logger.debug(&quot;instAdvHist:   &quot; + pstmt);
			pstmt.executeUpdate();

			query= new StringBuilder(&quot;update st_dg_adv_msg_master set status = 'INACTIVE' where msg_id = ?&quot;);
			pstmt = con.prepareStatement(query.toString());
			pstmt.setInt(1, msgId);
			logger.debug(&quot;updtAdvMst:   &quot; + pstmt);
			pstmt.executeUpdate();

			query= new StringBuilder(&quot;insert into st_dg_adv_msg_org_mapping_history select amm.msg_id, aom.org_id , aom.game_id, activity, ?, ? from st_dg_adv_msg_org_mapping aom, st_dg_adv_msg_master amm where amm.msg_id = aom.msg_id and amm.msg_id = ?&quot;);
			pstmt = con.prepareStatement(query.toString());
			pstmt.setString(1, new java.sql.Timestamp(new java.util.Date().getTime()).toString());
			pstmt.setString(2, userId + &quot;&quot;);
			pstmt.setInt(3, msgId);
			logger.debug(&quot;instOrgMappingHist:   &quot; + pstmt);
			pstmt.executeUpdate();
			
			query= new StringBuilder(&quot;delete from st_dg_adv_msg_org_mapping where msg_id = ?&quot;);
			pstmt = con.prepareStatement(query.toString());
			pstmt.setInt(1, msgId);
			logger.debug(&quot;delOrgMapMst:   &quot; + pstmt);
			pstmt.executeUpdate();
			
			status = true;
			con.commit();
		} catch (SQLException e) {
			logger.error(&quot;SQL Exception  :- &quot; + e);
		} catch (Exception e) {
			logger.error(&quot;General Exception  :- &quot; + e);
		} finally {
			DBConnect.closeConnection(con, pstmt);
		}
		return status;
	}*/

	public Map&lt;Integer, String&gt; fetchBoUserList(int userId, String userOrgType) {
<span class="nc" id="L744">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L745">		Map&lt;Integer, String&gt; boUserList = new TreeMap&lt;Integer, String&gt;();</span>

		try {
<span class="nc" id="L748">			String query = &quot;select CONCAT_WS('-',first_name, last_name) as username,user_id from st_lms_user_contact_details where user_id in (select user_id from st_lms_user_master where parent_user_id = ? and organization_type = ?)&quot;;</span>
<span class="nc" id="L749">			PreparedStatement pstmt = con.prepareStatement(query);</span>
<span class="nc" id="L750">			pstmt.setInt(1, userId);</span>
<span class="nc" id="L751">			pstmt.setString(2, userOrgType);</span>
<span class="nc" id="L752">			ResultSet rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L753" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L754">				boUserList.put(rs.getInt(&quot;user_id&quot;), rs.getString(&quot;username&quot;));</span>
			}

<span class="nc" id="L757">		} catch (Exception ex) {</span>
<span class="nc" id="L758">			ex.printStackTrace();</span>

		} finally {
<span class="nc" id="L761">			try {</span>
<span class="nc" id="L762">				con.close();</span>
<span class="nc" id="L763">			} catch (SQLException e) {</span>
<span class="nc" id="L764">				e.printStackTrace();</span>
<span class="nc" id="L765">			}</span>
<span class="nc" id="L766">		}</span>
<span class="nc" id="L767">		return boUserList;</span>
	}

	public ReportBeanDrawModule fetchDrawData(DrawDataBean drawDataBean,String raffleTktType)
			throws Exception {
<span class="nc bnc" id="L772" title="All 2 branches missed.">		if(drawDataBean.getAgentOrgId() &gt; 0){</span>
<span class="nc" id="L773">		Connection con=DBConnect.getConnection();</span>
<span class="nc" id="L774">		ArrayList&lt;Integer&gt; retUserIdList=new ArrayList&lt;Integer&gt;();</span>
<span class="nc" id="L775">		PreparedStatement pstmt=con.prepareStatement(&quot;select user_id from st_lms_user_master where organization_id in (select organization_id from st_lms_organization_master where parent_id =&quot;+drawDataBean.getAgentOrgId()+&quot; and organization_type='RETAILER')&quot;);</span>
<span class="nc" id="L776">		ResultSet rs=pstmt.executeQuery();</span>
<span class="nc bnc" id="L777" title="All 2 branches missed.">		while(rs.next()){</span>
			
<span class="nc" id="L779">			retUserIdList.add(rs.getInt(&quot;user_id&quot;));</span>
		}
<span class="nc" id="L781">		System.out.println(&quot;retailer User Id List::&quot;+retUserIdList);</span>
<span class="nc" id="L782">		drawDataBean.setRetailerUserIdList(retUserIdList);</span>
		}
<span class="nc" id="L784">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L785">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L786">		sReq.setServiceName(ServiceName.REPORTS_MGMT);</span>
<span class="nc" id="L787">		sReq.setServiceMethod(ServiceMethodName.DRAWGAME_FETCH_DATA);</span>
<span class="nc" id="L788">		sReq.setServiceData(drawDataBean);</span>
<span class="nc" id="L789">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L790">		sRes = delegate.getResponse(sReq);</span>
		
<span class="nc" id="L792">		Type type = new TypeToken&lt;ReportBeanDrawModule&gt;(){}.getType();</span>
<span class="nc" id="L793">		ReportBeanDrawModule reportBeanDrawModule = (ReportBeanDrawModule) new Gson().fromJson((JsonElement)sRes.getResponseData(), type);</span>
		
		//update the result of raffle ticket in case of reference ticket
//		ReportBeanDrawModule reportBeanDrawModule = (ReportBeanDrawModule) sRes.getResponseData();
	/*	DrawGameRPOSHelper drawHelper = new DrawGameRPOSHelper();
		String gameType = drawHelper.getGameType(drawDataBean.getGameNo());	
		if(&quot;RAFFEL&quot;.equalsIgnoreCase(gameType)){
			getDisplayTktNumber(reportBeanDrawModule);			
		}
	*/	
		
		
<span class="nc" id="L805">		String gameType = Util.getGameType(drawDataBean.getGameNo());</span>
<span class="nc bnc" id="L806" title="All 2 branches missed.">		  if(&quot;RAFFLE&quot;.equalsIgnoreCase(gameType)){				    </span>
		     //to cut last four digit in case of raffle GAME			  
<span class="nc bnc" id="L808" title="All 2 branches missed.">			  if(&quot;ORIGINAL&quot;.equalsIgnoreCase(raffleTktType)){	</span>
<span class="nc" id="L809">			       ReportDrawBean reportGameBean=null;</span>
<span class="nc bnc" id="L810" title="All 2 branches missed.">				     for(int i=0;i&lt;reportBeanDrawModule.getRepGameBean().getRepDrawBean().size();i++){</span>
<span class="nc" id="L811">							reportGameBean = reportBeanDrawModule.getRepGameBean().getRepDrawBean().get(i); </span>
<span class="nc" id="L812">							String  winRes = reportGameBean.getWinningResult();</span>
<span class="nc bnc" id="L813" title="All 2 branches missed.">							if(winRes!=null){	</span>
<span class="nc" id="L814">							String[] winResultArr = winRes.split(&quot;,&quot;);</span>
<span class="nc" id="L815">							StringBuilder finalresult= new StringBuilder(&quot;&quot;);</span>
<span class="nc bnc" id="L816" title="All 2 branches missed.">								for(int j=0;j&lt;winResultArr.length;j++){</span>
<span class="nc" id="L817">									String winResWithRpCnt = winResultArr[j];</span>
<span class="nc bnc" id="L818" title="All 4 branches missed.">									if(winResWithRpCnt != null &amp;&amp; !&quot;null&quot;.equalsIgnoreCase(winResWithRpCnt)){</span>
<span class="nc" id="L819">										int length = winResWithRpCnt.length();</span>
<span class="nc bnc" id="L820" title="All 4 branches missed.">											if(length == ConfigurationVariables.tktLenA || length == ConfigurationVariables.tktLenB){ </span>
<span class="nc" id="L821">												finalresult.append(winResWithRpCnt.substring(0, length-4));</span>
<span class="nc" id="L822">												finalresult.append(&quot;xxxx&quot;);</span>
<span class="nc" id="L823">												finalresult.append(&quot;,&quot;);							 </span>
											} 
									 } 
								}
<span class="nc bnc" id="L827" title="All 6 branches missed.">							if(finalresult!=null &amp;&amp; !&quot;&quot;.equals(finalresult.toString()) &amp;&amp; !&quot;0&quot;.equals(finalresult.toString())){</span>
<span class="nc" id="L828">								finalresult.deleteCharAt(finalresult.length()-1);</span>
							}
<span class="nc" id="L830">						 reportGameBean.setWinningResult(finalresult.toString());</span>
				     } 
				}
<span class="nc" id="L833">		  }else{</span>
			//for swap result with sale ticket number in case of reference ticket 
<span class="nc" id="L835">		      getDisplayTktNumber(reportBeanDrawModule); //in case of reference ticket</span>
		  }
		    }
				
<span class="nc" id="L839">		return reportBeanDrawModule;</span>

	}
	// start 
	public ArrayList&lt;AnalysisReportDrawBean&gt; fetch15minDrawData(
			DrawDataBean drawDataBean, String raffleTktType) throws Exception {

<span class="nc" id="L846">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L847">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L848">		sReq.setServiceName(ServiceName.REPORTS_MGMT);</span>
<span class="nc" id="L849">		sReq</span>
				.setServiceMethod(ServiceMethodName.DRAWGAME_FETCH_ANALYSIS_REP_DATA);
<span class="nc" id="L851">		sReq.setServiceData(drawDataBean);</span>
<span class="nc" id="L852">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L853">		sRes = delegate.getResponse(sReq);</span>
		
<span class="nc" id="L855">		Type type = new TypeToken&lt;ArrayList&lt;AnalysisReportDrawBean&gt;&gt;(){}.getType();</span>
<span class="nc" id="L856">		ArrayList&lt;AnalysisReportDrawBean&gt; reportBeanDrawModule = new Gson().fromJson((JsonElement)sRes.getResponseData(), type);</span>
		
//		ArrayList&lt;AnalysisReportDrawBean&gt; reportBeanDrawModule = (ArrayList&lt;AnalysisReportDrawBean&gt;) sRes
//				.getResponseData();

<span class="nc" id="L861">		return reportBeanDrawModule;</span>

	}
	
//end added by neeraj jain
	
	public ReportBeanDrawModule fetchDrawMachineData(DrawDataBean drawDataBean,String raffleTktType)
			throws Exception {
<span class="nc" id="L869">				System.out.println(&quot;fetchDrawMachine Data&quot;);</span>
<span class="nc" id="L870">				ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L871">				ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L872">				sReq.setServiceName(ServiceName.REPORTS_MGMT);</span>
<span class="nc" id="L873">				sReq.setServiceMethod(ServiceMethodName.DRAWGAME_FETCH_MACHINE_DATA);</span>
<span class="nc" id="L874">				sReq.setServiceData(drawDataBean);</span>
<span class="nc" id="L875">				IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L876">				sRes = delegate.getResponse(sReq);</span>
				// update the result of raffle ticket in case of reference ticket
				
<span class="nc" id="L879">				Type type = new TypeToken&lt;ReportBeanDrawModule&gt;(){}.getType();</span>
				
<span class="nc" id="L881">				ReportBeanDrawModule reportBeanDrawModule = (ReportBeanDrawModule)new Gson().fromJson((JsonElement)sRes.getResponseData(), type);</span>
				
//				commented for bug id 20370 
				
	//			ReportBeanDrawModule reportBeanDrawModule = (ReportBeanDrawModule) sRes
//						.getResponseData();
				/*
				 * DrawGameRPOSHelper drawHelper = new DrawGameRPOSHelper(); String
				 * gameType = drawHelper.getGameType(drawDataBean.getGameNo());
				 * if(&quot;RAFFEL&quot;.equalsIgnoreCase(gameType)){
				 * getDisplayTktNumber(reportBeanDrawModule); }
				
				String gameType = Util.getGameType(drawDataBean.getGameNo());
				if (&quot;RAFFLE&quot;.equalsIgnoreCase(gameType)) {
					// to cut last four digit in case of raffle GAME
					raffleTktType=&quot;ORIGINAL&quot;;
					if (&quot;ORIGINAL&quot;.equalsIgnoreCase(raffleTktType)) {
						ReportDrawBean reportGameBean = null;
						for (int i = 0; i &lt; reportBeanDrawModule.getRepGameBean()
								.getRepDrawBean().size(); i++) {
							reportGameBean = reportBeanDrawModule.getRepGameBean()
									.getRepDrawBean().get(i);
							String winRes = reportGameBean.getWinningResult();
							if (winRes != null) {
								String[] winResultArr = winRes.split(&quot;,&quot;);
								StringBuilder finalresult = new StringBuilder(&quot;&quot;);

								for (int j = 0; j &lt; winResultArr.length; j++) {
									String winResWithRpCnt = winResultArr[j];
									if (winResWithRpCnt != null
											&amp;&amp; !&quot;null&quot;
													.equalsIgnoreCase(winResWithRpCnt)) {
										int length = winResWithRpCnt.length();
										if (length == ConfigurationVariables.tktLenA
												|| length == ConfigurationVariables.tktLenB) {
											finalresult.append(winResWithRpCnt
													.substring(0, length - 4));
											finalresult.append(&quot;xxxx&quot;);
											finalresult.append(&quot;,&quot;);
										}
									}
								}
								if (finalresult != null
										&amp;&amp; !&quot;&quot;.equals(finalresult.toString())
										&amp;&amp; !&quot;0&quot;.equals(finalresult.toString())) {
									finalresult.deleteCharAt(finalresult.length() - 1);
								}
								reportGameBean.setWinningResult(finalresult.toString());
							}
						}
					} else {
						// for swap result with sale ticket number in case of reference
						// ticket
						getDisplayTktNumber(reportBeanDrawModule); // in case of
																	// reference ticket
					}
				} */


<span class="nc" id="L940">				return reportBeanDrawModule;</span>

			}
	public ReportBeanDrawModule getDisplayTktNumber(ReportBeanDrawModule reportBeanDrawModule){
		//List&lt;ReportDrawBean&gt; reportGameBeanList = reportBeanDrawModule.getRepGameBean().getRepDrawBean();
<span class="nc" id="L945">		ReportDrawBean reportGameBean=null;</span>
		
<span class="nc" id="L947">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L948">		Statement drawStmt =null;</span>
<span class="nc" id="L949">		ResultSet drawRs =null;</span>
	try{	
<span class="nc bnc" id="L951" title="All 2 branches missed.">		for(int i=0;i&lt;reportBeanDrawModule.getRepGameBean().getRepDrawBean().size();i++){</span>
<span class="nc" id="L952">			reportGameBean = reportBeanDrawModule.getRepGameBean().getRepDrawBean().get(i);		</span>
<span class="nc" id="L953">			drawStmt = con.createStatement();</span>
<span class="nc" id="L954">			String  winresWithRpCnt = reportGameBean.getWinningResult();</span>
			
<span class="nc bnc" id="L956" title="All 4 branches missed.">		if(winresWithRpCnt != null &amp;&amp; !&quot;null&quot;.equalsIgnoreCase(winresWithRpCnt)){</span>
<span class="nc" id="L957">			String[] winResultArr = winresWithRpCnt.split(&quot;,&quot;);</span>
<span class="nc" id="L958">			StringBuilder finalresult= new StringBuilder(&quot;&quot;);</span>
<span class="nc bnc" id="L959" title="All 2 branches missed.">				for(int j=0;j&lt;winResultArr.length;j++){</span>
<span class="nc" id="L960">					String winResWithRpCnt = winResultArr[j];</span>
<span class="nc bnc" id="L961" title="All 4 branches missed.">					if(winResWithRpCnt != null &amp;&amp; !&quot;null&quot;.equalsIgnoreCase(winResWithRpCnt)){</span>
<span class="nc" id="L962">						int length = winResWithRpCnt.length();</span>
<span class="nc bnc" id="L963" title="All 4 branches missed.">							if(length == ConfigurationVariables.tktLenA || length == ConfigurationVariables.tktLenB){</span>
<span class="nc" id="L964">								String rpCnt = winResWithRpCnt.substring(length-2, length);</span>
<span class="nc" id="L965">								String query =&quot;select sale_ticket_nbr from ge_sale_promo_ticket_mapping where promo_ticket_nbr='&quot;+winResWithRpCnt.substring(0, length-2)+&quot;'&quot;;</span>
<span class="nc" id="L966">								drawRs = drawStmt.executeQuery(query);</span>
<span class="nc bnc" id="L967" title="All 2 branches missed.">								if(drawRs.next()){</span>
<span class="nc" id="L968">									finalresult.append(drawRs.getString(1)+rpCnt);</span>
<span class="nc" id="L969">									finalresult.append(&quot;,&quot;);</span>
								}
															 
<span class="nc bnc" id="L972" title="All 2 branches missed.">							} else if(length==1){</span>
<span class="nc" id="L973">								finalresult.append(winResWithRpCnt);</span>
<span class="nc" id="L974">								finalresult.append(&quot;,&quot;);</span>
							}
					 } 
				}
<span class="nc bnc" id="L978" title="All 6 branches missed.">			if(finalresult!=null &amp;&amp; !&quot;&quot;.equals(finalresult.toString()) &amp;&amp; !&quot;0&quot;.equals(finalresult.toString())){</span>
<span class="nc" id="L979">				finalresult.deleteCharAt(finalresult.length()-1);</span>
			}
<span class="nc" id="L981">		 reportGameBean.setWinningResult(finalresult.toString());</span>
			
			/*
			int length = winresWithRpCnt.length();
			if(length == ConfigurationVariables.tktLenA || length == ConfigurationVariables.tktLenB){			
			String  winresWithoutRpCnt = winresWithRpCnt.substring(0, length-2);
			
			String rpCnt = winresWithRpCnt.substring(length-2, length);
			drawRs = drawStmt.executeQuery(&quot;select sale_ticket_nbr from ge_sale_promo_ticket_mapping where promo_ticket_nbr='&quot;+winresWithoutRpCnt+&quot;'&quot;);
			while(drawRs.next()){
				reportGameBean.setWinningResult(drawRs.getString(1)+rpCnt);
			}
			}	
		*/}	
		}	
<span class="nc" id="L996">		DBConnect.closeCon(con);</span>
<span class="nc" id="L997">		} catch (SQLException e) {			</span>
<span class="nc" id="L998">			e.printStackTrace();</span>
<span class="nc" id="L999">		}		</span>
<span class="nc" id="L1000">		return reportBeanDrawModule;</span>
	}


	@SuppressWarnings(&quot;unchecked&quot;)
	public ArrayList&lt;ResultSubmitBean&gt; fetchSubDrawResult(
			DrawScheduleBean drawScheduleBean) throws Exception {
<span class="nc" id="L1007">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L1008">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L1009">		sReq.setServiceName(ServiceName.DRAW_RESULT_MGMT);</span>
<span class="nc" id="L1010">		sReq.setServiceMethod(ServiceMethodName.FETCH_SUB_DRAW_RESULT);</span>
<span class="nc" id="L1011">		sReq.setServiceData(drawScheduleBean);</span>
<span class="nc" id="L1012">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L1013">		sRes = delegate.getResponse(sReq);</span>

<span class="nc" id="L1015">		String responseString=sRes.getResponseData().toString();</span>
<span class="nc" id="L1016">		Type elementType = new TypeToken&lt;ArrayList&lt;ResultSubmitBean&gt;&gt;() {}.getType();</span>
<span class="nc" id="L1017">		ArrayList&lt;ResultSubmitBean&gt; resultSubmitBeanList = new Gson().fromJson(responseString, elementType);</span>

<span class="nc bnc" id="L1019" title="All 2 branches missed.">		if(&quot;RainbowGame&quot;.equals(Util.getGameName(drawScheduleBean.getGameNo()))) {</span>
<span class="nc" id="L1020">			final String[][] colorArray = new String[][]{{&quot;V&quot;, &quot;Voilet&quot;}, {&quot;I&quot;, &quot;Indigo&quot;}, {&quot;B&quot;, &quot;Blue&quot;}, {&quot;G&quot;, &quot;Green&quot;}, {&quot;Y&quot;, &quot;Yellow&quot;}, {&quot;O&quot;, &quot;Orange&quot;}, {&quot;R&quot;, &quot;Red&quot;}};</span>
<span class="nc bnc" id="L1021" title="All 2 branches missed.">			for(ResultSubmitBean resultBean : resultSubmitBeanList) {</span>
<span class="nc" id="L1022">				String winResult1 = &quot;&quot;;</span>
<span class="nc" id="L1023">				String winResult2 = &quot;&quot;;</span>
<span class="nc" id="L1024">				String[] winOne = resultBean.getWinResult().split(&quot;,&quot;);</span>
<span class="nc" id="L1025">				String[] winTwo = resultBean.getWinResult2().split(&quot;,&quot;);</span>
<span class="nc bnc" id="L1026" title="All 2 branches missed.">				for(int i=0; i&lt;6; i++) {</span>
<span class="nc bnc" id="L1027" title="All 2 branches missed.">					if(i&lt;3) {</span>
<span class="nc" id="L1028">						winResult1 += winOne[i]+&quot;,&quot;;</span>
<span class="nc" id="L1029">						winResult2 += winTwo[i]+&quot;,&quot;;</span>
					} else {
<span class="nc bnc" id="L1031" title="All 2 branches missed.">						for(int j=0; j&lt;7; j++) {</span>
<span class="nc bnc" id="L1032" title="All 2 branches missed.">							if(colorArray[j][0].equals(winOne[i]))</span>
<span class="nc" id="L1033">								winResult1 += colorArray[j][1]+&quot;,&quot;;</span>
<span class="nc bnc" id="L1034" title="All 2 branches missed.">							if(colorArray[j][0].equals(winTwo[i]))</span>
<span class="nc" id="L1035">								winResult2 += colorArray[j][1]+&quot;,&quot;;</span>
						}
					}
				}
<span class="nc" id="L1039">				winResult1 = winResult1.substring(0, winResult1.length()-1);</span>
<span class="nc" id="L1040">				winResult2 = winResult2.substring(0, winResult2.length()-1);</span>
<span class="nc" id="L1041">				resultBean.setWinResult(winResult1);</span>
<span class="nc" id="L1042">				resultBean.setWinResult2(winResult2);</span>
<span class="nc" id="L1043">			}</span>
		}
<span class="nc" id="L1045">		ResultSubmitBean rsb = null;</span>
<span class="nc bnc" id="L1046" title="All 2 branches missed.">		for (int i = 0; i &lt; resultSubmitBeanList.size(); i++) {</span>
<span class="nc" id="L1047">			rsb = resultSubmitBeanList.get(i);</span>
<span class="nc" id="L1048">			rsb.setUserName(CommonFunctionsHelper.fetchNameOfUser(rsb.getUserId()));</span>
<span class="nc" id="L1049">			rsb.setUserName2(CommonFunctionsHelper.fetchNameOfUser(rsb.getUserId2()));</span>
		}
<span class="nc" id="L1051">		return resultSubmitBeanList;</span>
	}

	public ArrayList&lt;DrawScheduleBeanResult&gt; getDrawSchdule(
			DrawScheduleBean drawScheduleBean) throws Exception {
<span class="nc" id="L1056">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L1057">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L1058">		sReq.setServiceName(ServiceName.DRAW_RESULT_MGMT);</span>
<span class="nc" id="L1059">		sReq.setServiceMethod(ServiceMethodName.DRAWGAME_FETCH_DRAWSCHEDULE);</span>
<span class="nc" id="L1060">		sReq.setServiceData(drawScheduleBean);</span>
<span class="nc" id="L1061">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L1062">		sRes = delegate.getResponse(sReq);</span>
<span class="nc" id="L1063">		String responseString=sRes.getResponseData().toString();</span>
<span class="nc" id="L1064">		Type elementType = new TypeToken&lt;ArrayList&lt;DrawScheduleBeanResult&gt;&gt;() {}.getType();</span>
<span class="nc" id="L1065">		ArrayList&lt;DrawScheduleBeanResult&gt; resultSubmitBeanList = new Gson().fromJson(responseString, elementType);</span>
<span class="nc" id="L1066">		return resultSubmitBeanList;</span>

	}

	public Map getLastTenTicket(int gameNo, int retOrgId)
			throws LMSException {
<span class="nc" id="L1072">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L1073">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L1074">		ResultSet rs = null;</span>
<span class="nc" id="L1075">		LinkedHashMap&lt;String, ArrayList&lt;Object&gt;&gt; ticketMap = new LinkedHashMap&lt;String, ArrayList&lt;Object&gt;&gt;();</span>
<span class="nc" id="L1076">		String dataLimitAppender=&quot;10&quot;;</span>
		try {
<span class="nc bnc" id="L1078" title="All 2 branches missed.">			if(&quot;GHANA&quot;.equalsIgnoreCase(Utility.getPropertyValue(&quot;COUNTRY_DEPLOYED&quot;))){</span>
<span class="nc" id="L1079">				dataLimitAppender=&quot;50&quot;;</span>
			}
			//String selQry = &quot;select ticket_nbr from st_dg_ret_sale_? where retailer_org_id=(select organization_id from st_lms_organization_master where name=?) order by transaction_id desc limit 10&quot;;
<span class="nc" id="L1082">			String selQry = &quot;select ticket_nbr from st_dg_ret_sale_? where retailer_org_id=? and ticket_nbr &lt;&gt; 0 order by transaction_id desc limit &quot;+dataLimitAppender;</span>
<span class="nc" id="L1083">			pstmt = con.prepareStatement(selQry);</span>
<span class="nc" id="L1084">			pstmt.setInt(1, gameNo);</span>
<span class="nc" id="L1085">			pstmt.setInt(2, retOrgId);</span>
<span class="nc" id="L1086">			logger.debug(&quot;*****selQry****&quot; + pstmt);</span>
<span class="nc" id="L1087">			rs = pstmt.executeQuery();</span>
<span class="nc" id="L1088">			StringBuilder tickets=new StringBuilder(&quot;(&quot;);</span>
<span class="nc bnc" id="L1089" title="All 2 branches missed.">			if(rs.next()){</span>
				do{
<span class="nc" id="L1091">					tickets.append(rs.getString(&quot;ticket_nbr&quot;));</span>
<span class="nc" id="L1092">					tickets.append(&quot;,&quot;);	</span>
<span class="nc bnc" id="L1093" title="All 2 branches missed.">				}while(rs.next());</span>
			}else{
<span class="nc" id="L1095">				return ticketMap;</span>
			}
<span class="nc" id="L1097">			ticketMap=CommonMethods.fetchTicketToCancel(tickets.toString().substring(0,tickets.toString().length()-1).concat(&quot;)&quot;).concat(&quot;:&quot;).concat(String.valueOf(gameNo)));</span>
			
<span class="nc" id="L1099">		} catch (Exception e) {</span>
<span class="nc" id="L1100">			e.printStackTrace();</span>
<span class="nc" id="L1101">			throw new LMSException();</span>
		}
		finally{
<span class="nc bnc" id="L1104" title="All 6 branches missed.">			if(con!=null){</span>
<span class="nc" id="L1105">				DBConnect.closeCon(con);	</span>
			}
		}
<span class="nc" id="L1108">		logger.debug(&quot;****ticketMap***&quot; + ticketMap);</span>
<span class="nc" id="L1109">		return ticketMap;</span>
	}

	/**
	 * This method fetches draws with draw_status as 'ACTIVE'
	 * 
	 * @return
	 * @throws Exception
	 */
	public ArrayList&lt;DrawScheduleBeanResult&gt; getManualDeclareData(
			DrawScheduleBean drawScheduleBean) throws Exception {
<span class="nc" id="L1120">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L1121">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L1122">		sReq.setServiceName(ServiceName.DRAWGAME);</span>
<span class="nc" id="L1123">		sReq</span>
				.setServiceMethod(ServiceMethodName.DRAWGAME_FETCH_MANUAL_DECLARE_DATA);
<span class="nc" id="L1125">		sReq.setServiceData(drawScheduleBean);</span>
<span class="nc" id="L1126">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L1127">		sRes = delegate.getResponse(sReq);</span>
<span class="nc" id="L1128">		return (ArrayList&lt;DrawScheduleBeanResult&gt;) sRes.getResponseData();</span>
	}

	/**
	 * This method fetches draws with draw_status as 'FREEZE' if Perform Status
	 * is &quot;ALL&quot; else all draws with perform_status = 'PMEP'
	 * 
	 * @return
	 * @throws Exception
	 */
	public ArrayList&lt;DrawScheduleBeanResult&gt; getManualEntryData(
			DrawScheduleBean drawScheduleBean) throws Exception {
<span class="nc" id="L1140">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L1141">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L1142">		sReq.setServiceName(ServiceName.DRAW_RESULT_MGMT);</span>
<span class="nc" id="L1143">		sReq</span>
				.setServiceMethod(ServiceMethodName.DRAWGAME_FETCH_MANUAL_ENTRY_DATA);
<span class="nc" id="L1145">		sReq.setServiceData(drawScheduleBean);</span>
<span class="nc" id="L1146">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L1147">		sRes = delegate.getResponse(sReq);</span>
		
<span class="nc" id="L1149">		String responseString=sRes.getResponseData().toString();</span>
<span class="nc" id="L1150">		Type elementType = new TypeToken&lt;ArrayList&lt;DrawScheduleBeanResult&gt;&gt;() {}.getType();</span>
<span class="nc" id="L1151">		ArrayList&lt;DrawScheduleBeanResult&gt; resultSubmitBeanList = new Gson().fromJson(responseString, elementType);</span>
		
<span class="nc" id="L1153">		return resultSubmitBeanList;</span>
	}
	public ArrayList&lt;DrawScheduleBeanResult&gt; getManualMachineNumberEntryData(
			DrawScheduleBean drawScheduleBean) throws Exception {
<span class="nc" id="L1157">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L1158">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L1159">		sReq.setServiceName(ServiceName.DRAW_RESULT_MGMT);</span>
<span class="nc" id="L1160">		sReq</span>
				.setServiceMethod(ServiceMethodName.DRAWGAME_FETCH_MANUAL_MACHINE_ENTRY_DATA);
<span class="nc" id="L1162">		sReq.setServiceData(drawScheduleBean);</span>
<span class="nc" id="L1163">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L1164">		sRes = delegate.getResponse(sReq);</span>
<span class="nc" id="L1165">		Type type = new TypeToken&lt;ArrayList&lt;DrawScheduleBeanResult&gt;&gt;(){}.getType();</span>
<span class="nc" id="L1166">		ArrayList&lt;DrawScheduleBeanResult&gt; drawScheduleBeanResults= (ArrayList&lt;DrawScheduleBeanResult&gt;)new Gson().fromJson(sRes.getResponseData().toString(), type);</span>
<span class="nc" id="L1167">		return drawScheduleBeanResults;</span>
//		return (ArrayList&lt;DrawScheduleBeanResult&gt;) sRes.getResponseData();
	}
	public SchedulerBean holdDraw(DrawScheduleBean drawScheduleBean)
			throws Exception {
<span class="nc" id="L1172">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L1173">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L1174">		sReq.setServiceName(ServiceName.DRAW_MGMT);</span>
<span class="nc" id="L1175">		sReq.setServiceMethod(ServiceMethodName.DRAWGAME_HOLD_DRAW);</span>
<span class="nc" id="L1176">		sReq.setServiceData(drawScheduleBean);</span>
<span class="nc" id="L1177">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L1178">		sRes = delegate.getResponse(sReq);</span>
<span class="nc bnc" id="L1179" title="All 2 branches missed.">		if (sRes.getIsSuccess()) {</span>
			//rescheduleJob(drawScheduleBean.getGameNo());
		}
		
<span class="nc" id="L1183">		String responseString=sRes.getResponseData().toString();</span>
<span class="nc" id="L1184">		Type elementType = new TypeToken&lt;SchedulerBean&gt;() {}.getType();</span>
<span class="nc" id="L1185">		SchedulerBean schedulerBean = new Gson().fromJson(responseString, elementType);</span>
<span class="nc" id="L1186">		return schedulerBean;</span>
	}

	public String initiateDrawSchdule(DrawScheduleBean drawScheduleBean)
			throws Exception {
<span class="nc" id="L1191">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L1192">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L1193">		sReq.setServiceName(ServiceName.DRAWGAME);</span>
<span class="nc" id="L1194">		sReq.setServiceMethod(ServiceMethodName.DRAWGAME_INITIATE_DRAWSCHEDULE);</span>
<span class="nc" id="L1195">		sReq.setServiceData(drawScheduleBean);</span>
<span class="nc" id="L1196">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L1197">		sRes = delegate.getResponse(sReq);</span>
<span class="nc" id="L1198">		return (String) sRes.getResponseData();</span>

	}

	/**
	 * This method sets the perform_status of a selected ACTIVE draws to 'PMEP'
	 * so that they are not selected for scheduling by scheduler in DrawGameWeb.
	 * 
	 * @return
	 * @throws Exception
	 */
	public String performManualDeclareEntry(DrawScheduleBean drawScheduleBean)
			throws Exception {
<span class="nc" id="L1211">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L1212">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L1213">		sReq.setServiceName(ServiceName.DRAWGAME);</span>
<span class="nc" id="L1214">		sReq</span>
				.setServiceMethod(ServiceMethodName.DRAWGAME_PERFORM_MANUAL_DECLARE_ENTRY);
<span class="nc" id="L1216">		sReq.setServiceData(drawScheduleBean);</span>
<span class="nc" id="L1217">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L1218">		sRes = delegate.getResponse(sReq);</span>
<span class="nc bnc" id="L1219" title="All 2 branches missed.">		if (sRes.getIsSuccess()) {</span>
			//rescheduleJob(drawScheduleBean.getGameNo());
		}
<span class="nc" id="L1222">		return sRes.getResponseData().toString();</span>

	}

	/**
	 * This method invokes the game respective PerformDraw class of
	 * DrawGameEngine to perform the manual draw.
	 * 
	 * @return
	 * @throws Exception
	 */
	public String performManualWinningEntry(ManualWinningBean mwBean)
			throws Exception {
<span class="nc bnc" id="L1235" title="All 2 branches missed.">		if(validateResultData(mwBean)) {</span>
<span class="nc" id="L1236">			System.out.println(&quot;performManualWinningEntry&quot;);</span>
<span class="nc" id="L1237">			ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L1238">			ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L1239">			sReq.setServiceName(ServiceName.DRAW_RESULT_MGMT);</span>
<span class="nc" id="L1240">			sReq</span>
					.setServiceMethod(ServiceMethodName.DRAWGAME_PERFORM_MANUAL_WINNING_ENTRY);
<span class="nc" id="L1242">			sReq.setServiceData(mwBean);</span>
<span class="nc" id="L1243">			IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L1244">			Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L1245">			int userId = mwBean.getUserId();</span>
			try {
<span class="nc" id="L1247">				Statement stmt = con.createStatement();</span>
<span class="nc" id="L1248">				StringBuilder qryBuilder = new StringBuilder(&quot;select id from st_dg_result_sub_master where game_id = &quot; + mwBean.getGameId()+ &quot; and (&quot;);</span>
<span class="nc bnc" id="L1249" title="All 2 branches missed.">				for(int i=0; i&lt;10; i++){</span>
<span class="nc" id="L1250">					qryBuilder.append(&quot;user&quot;+(i+1)+&quot;_id=&quot; + userId + &quot; OR &quot;);</span>
				}
<span class="nc" id="L1252">				qryBuilder.delete(qryBuilder.length() - 4, qryBuilder.length());</span>
<span class="nc" id="L1253">				qryBuilder.append(&quot;)&quot;);</span>
<span class="nc" id="L1254">				System.out.println(&quot;performManualWinningEntry result sub_master query:&quot; + qryBuilder.toString());</span>
<span class="nc" id="L1255">				ResultSet rs = stmt.executeQuery(qryBuilder.toString());</span>
<span class="nc bnc" id="L1256" title="All 2 branches missed.">				if (rs.next()) {</span>
<span class="nc" id="L1257">					sRes = delegate.getResponse(sReq);</span>
<span class="nc" id="L1258">					String response = sRes.getResponseData().toString();</span>
<span class="nc bnc" id="L1259" title="All 2 branches missed.">					if (response.contains(&quot;:&quot;)) {</span>
<span class="nc bnc" id="L1260" title="All 2 branches missed.">				if (response.split(&quot;:&quot;)[1].equalsIgnoreCase(&quot;MATCHED&quot;)) {</span>
<span class="nc" id="L1261">					System.out.println(&quot;SENDING EMAIL TO USERS.....&quot;);</span>
<span class="nc" id="L1262">					MailSenderAfterPerformDraw mailSenderAfterDrawPerform=new MailSenderAfterPerformDraw(mwBean);</span>
<span class="nc" id="L1263">					mailSenderAfterDrawPerform.setDaemon(true);</span>
<span class="nc" id="L1264">					mailSenderAfterDrawPerform.start();</span>
					
				}
<span class="nc" id="L1267">				response = response.split(&quot;:&quot;)[0];</span>
			}
<span class="nc" id="L1269">			return response;</span>

		} else {
<span class="nc" id="L1272">			return findDefaultText(&quot;msg.you.are.not.auth&quot;, locale);</span>
		}
<span class="nc" id="L1274">	} catch (Exception e) {</span>
<span class="nc" id="L1275">		e.printStackTrace();</span>
<span class="nc" id="L1276">		return findDefaultText(&quot;error.in.perform.draw&quot;, locale);</span>
	} finally {
<span class="nc" id="L1278">		DBConnect.closeCon(con);</span>
	}
} else {
<span class="nc" id="L1281">	return findDefaultText(&quot;error.inv.res.data&quot;, locale);</span>
}
}

		// Method For Mailing Users Draw Wise
		public List&lt;ReportDrawBean&gt; fetchDrawDateForMail(ManualWinningBean mwBean) throws LMSException {
<span class="nc" id="L1287">				System.out.println(&quot;Fetching Draw result Results &quot;);</span>
<span class="nc" id="L1288">				ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L1289">				ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L1290">				sReq.setServiceName(ServiceName.DRAWGAME);</span>
<span class="nc" id="L1291">				sReq.setServiceMethod(ServiceMethodName.FETCH_DRAW_RESULT_FOR_MAILING_USERS);</span>
<span class="nc" id="L1292">				sReq.setServiceData(mwBean);</span>
<span class="nc" id="L1293">				IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L1294">				sRes = delegate.getResponse(sReq);</span>
<span class="nc" id="L1295">				List&lt;ReportDrawBean&gt; mailPerformedDrawList = (ArrayList&lt;ReportDrawBean&gt;) sRes</span>
				.getResponseData();
<span class="nc" id="L1297">				return mailPerformedDrawList;</span>
}
	public String performManualWinningMachineNumberEntry(ManualWinningBean mwBean)
			throws Exception {
<span class="nc" id="L1301">		System.out.println(&quot;performManualWinnindghdgEntry&quot;);</span>
<span class="nc" id="L1302">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L1303">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L1304">		sReq.setServiceName(ServiceName.DRAW_RESULT_MGMT);</span>
<span class="nc" id="L1305">		sReq</span>
				.setServiceMethod(ServiceMethodName.DRAWGAME_PERFORM_MANUAL_WINNING_MACHINE_NUMBER_ENTRY);
<span class="nc" id="L1307">		sReq.setServiceData(mwBean);</span>
<span class="nc" id="L1308">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L1309">		sRes = delegate.getResponse(sReq);</span>
<span class="nc" id="L1310">		return sRes.getResponseData().toString();</span>
		//Connection con = DBConnect.getConnection();
		/*int userId = mwBean.getUserId();
		try {
			Statement stmt = con.createStatement();
			String fetchUser = &quot;select id from st_dg_result_sub_master where game_no = &quot;
					+ mwBean.getGameNumber()
					+ &quot; and (user1_id=&quot;
					+ userId
					+ &quot; OR user2_id=&quot; + userId + &quot;)&quot;;
			ResultSet rs = stmt.executeQuery(fetchUser);
			if (rs.next()) {
				sRes = delegate.getResponse(sReq);
				return sRes.getResponseData().toString();

		} else {
			return &quot;You are not Authorized&quot;;
			}
		} catch (Exception e) {
			e.printStackTrace();
			return &quot;Error in Performing Manual Entry&quot;;
		}
		finally{
			DBConnect.closeCon(con);
		}*/

	} 


	public SchedulerBean postponeDraw(DrawScheduleBean drawScheduleBean, UserInfoBean userBean)
			throws Exception {
<span class="nc" id="L1341">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L1342">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L1343">		sReq.setServiceName(ServiceName.DRAW_MGMT);</span>
<span class="nc" id="L1344">		sReq.setServiceMethod(ServiceMethodName.DRAWGAME_POSTPONE_DRAW);</span>
<span class="nc" id="L1345">		sReq.setServiceData(drawScheduleBean);</span>
<span class="nc" id="L1346">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L1347">		sRes = delegate.getResponse(sReq);</span>
<span class="nc bnc" id="L1348" title="All 2 branches missed.">		if (sRes.getIsSuccess()) {</span>
			//rescheduleJob(drawScheduleBean.getGameNo());
<span class="nc" id="L1350">			Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L1351">			PreparedStatement ps = con.prepareStatement(&quot;insert into st_dg_draw_status_change_history (user_id, action, date, remarks) values (?,?,?,?)&quot;);</span>
<span class="nc" id="L1352">			ps.setInt(1, userBean.getUserId());</span>
<span class="nc" id="L1353">			ps.setString(2, &quot;CHANGE DRAW TIME&quot;);</span>
<span class="nc" id="L1354">			ps.setString(3, Util.getCurrentTimeString());</span>
<span class="nc" id="L1355">			ps.setString(4, &quot;Changed draw time of draws &quot;+drawScheduleBean.getDrawIdList());</span>
<span class="nc" id="L1356">			ps.executeUpdate();</span>
<span class="nc" id="L1357">			new DrawGameRPOS().newData();</span>
<span class="nc" id="L1358">			new SetResetUserPasswordAction().logOutAllRets();</span>
			
<span class="nc" id="L1360">			String drawStatus =drawScheduleBean.getStatus();</span>
<span class="nc" id="L1361">			String filename =&quot;&quot;;</span>
<span class="nc" id="L1362">			String subject =&quot; IMPORTANT DRAW POSTPONE ALERT &quot;;</span>
<span class="nc" id="L1363">			StringBuilder bodyText = new StringBuilder();</span>
<span class="nc" id="L1364">			bodyText.append(&quot;&lt;b&gt;Hello Support Team &lt;/b&gt; &lt;br&gt; &lt;/br&gt;  Draw Ids: &quot;).append(drawScheduleBean.getDrawIdList()).append(&quot;Has Been Postponeed  . Draw  Status: &quot;).append(drawStatus).append(&quot; In Game NO: &quot;).append(drawScheduleBean.getGameNo());</span>
<span class="nc" id="L1365">			List&lt;String&gt; to  =CommonFunctionsHelper.getEmailIdsForDrawMgmtNotification();</span>
<span class="nc bnc" id="L1366" title="All 4 branches missed.">			if(to!=null&amp;&amp;to.size()&gt;0){</span>
<span class="nc" id="L1367">				MailSender  sendMail = new MailSender(ConfigurationVariables.from,ConfigurationVariables.password,to,subject,bodyText.toString(), filename);</span>
<span class="nc" id="L1368">				sendMail.setDaemon(true);</span>
<span class="nc" id="L1369">				sendMail.start();</span>
<span class="nc" id="L1370">				logger.info(&quot;Mail Has Been Send&quot;);</span>
			}
			
			
		}
<span class="nc" id="L1375">		String responseString=sRes.getResponseData().toString();</span>
<span class="nc" id="L1376">		Type elementType = new TypeToken&lt;SchedulerBean&gt;() {}.getType();</span>
<span class="nc" id="L1377">		SchedulerBean schedulerBean = new Gson().fromJson(responseString, elementType);</span>
<span class="nc" id="L1378">		return schedulerBean;</span>
	}

	public SchedulerBean rankChkDraw(DrawScheduleBean drawScheduleBean, UserInfoBean userBean)
			throws Exception {
<span class="nc" id="L1383">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L1384">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L1385">		sReq.setServiceName(ServiceName.DRAW_MGMT);</span>
<span class="nc" id="L1386">		sReq.setServiceMethod(ServiceMethodName.DRAWGAME_RANK_CHK);</span>
<span class="nc" id="L1387">		sReq.setServiceData(drawScheduleBean);</span>
<span class="nc" id="L1388">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L1389">		sRes = delegate.getResponse(sReq);</span>
<span class="nc bnc" id="L1390" title="All 2 branches missed.">		if (sRes.getIsSuccess()) {</span>
			//rescheduleJob(drawScheduleBean.getGameNo());
<span class="nc" id="L1392">			Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L1393">			PreparedStatement ps = con.prepareStatement(&quot;insert into st_dg_draw_status_change_history (user_id, action, date, remarks) values (?,?,?,?)&quot;);</span>
<span class="nc" id="L1394">			ps.setInt(1, userBean.getUserId());</span>
<span class="nc bnc" id="L1395" title="All 2 branches missed.">			ps.setString(2, &quot;Claim Hold&quot;.equals(drawScheduleBean.getStatus())?&quot;CLAIM HOLD&quot;:&quot;CLAIM ALLOW&quot;);</span>
<span class="nc" id="L1396">			ps.setString(3, Util.getCurrentTimeString());</span>
<span class="nc" id="L1397">			ps.setString(4, &quot;Did &quot;+drawScheduleBean.getStatus()+&quot; for draws &quot;+drawScheduleBean.getDrawIdList());</span>
<span class="nc" id="L1398">			ps.executeUpdate();</span>
<span class="nc" id="L1399">			new DrawGameRPOS().newData();</span>
			//new SetResetUserPasswordAction().logOutAllRets();
		}
<span class="nc" id="L1402">		String responseString=sRes.getResponseData().toString();</span>
<span class="nc" id="L1403">		Type elementType = new TypeToken&lt;SchedulerBean&gt;() {}.getType();</span>
<span class="nc" id="L1404">		SchedulerBean schedulerBean = new Gson().fromJson(responseString, elementType);</span>
<span class="nc" id="L1405">		return schedulerBean;</span>
	}

	public void rescheduleJob(int gameNo) {
		try {
<span class="nc" id="L1410">			logger.debug(&quot; calling url for scheduler---in postpone&quot;);</span>
<span class="nc" id="L1411">			URL url = new URL(Util.getDGIP(&quot;DG_WEB_IP&quot;)</span>
					+ &quot;/DrawGameWeb/RescheduleJob?gameNo=&quot; + gameNo);
<span class="nc" id="L1413">			URLConnection conn = url.openConnection();</span>
<span class="nc" id="L1414">			conn.setDoOutput(true);</span>
<span class="nc" id="L1415">			BufferedReader in = new BufferedReader(new InputStreamReader(conn</span>
					.getInputStream()));
<span class="nc" id="L1417">			in.close();</span>
			/*url = new URL(Util.getDGIP(&quot;DG_SCH_IP&quot;)
					+ &quot;/DrawGameScheduler/RescheduleJob?gameNo=&quot; + gameNo);
			conn = url.openConnection();
			conn.setDoOutput(true);
			in = new BufferedReader(
					new InputStreamReader(conn.getInputStream()));
			in.close();*/
<span class="nc" id="L1425">		} catch (Exception e) {</span>
<span class="nc" id="L1426">			e.printStackTrace();</span>
<span class="nc" id="L1427">		}</span>
<span class="nc" id="L1428">	}</span>

	public String resultUserAssignEdit(int gameId, int[] user) {
<span class="nc" id="L1431">		Connection con = DBConnect.getConnection();</span>
		try {
<span class="nc" id="L1433">			con.setAutoCommit(false);</span>
<span class="nc" id="L1434">			StringBuilder qryBuilder = new StringBuilder(&quot;update st_dg_result_sub_master set &quot;);</span>
<span class="nc bnc" id="L1435" title="All 2 branches missed.">			for(int i=0; i&lt;user.length; i++){</span>
<span class="nc" id="L1436">				qryBuilder.append(&quot;user&quot;+(i+1)+&quot;_id=&quot; + user[i] + &quot;,&quot;);</span>
			}
<span class="nc" id="L1438">			qryBuilder.deleteCharAt(qryBuilder.length() - 1);</span>
<span class="nc" id="L1439">			qryBuilder.append(&quot; where game_id=&quot; + gameId);</span>
			
<span class="nc" id="L1441">			PreparedStatement pstmt = con.prepareStatement(qryBuilder.toString());</span>
<span class="nc" id="L1442">			System.out.println(&quot;resultUserAssignEdit query:&quot; + pstmt);</span>
<span class="nc" id="L1443">			int countUpdate = pstmt.executeUpdate();</span>
<span class="nc" id="L1444">			con.commit();</span>
<span class="nc" id="L1445">			int gameNo = Util.getGameNumberFromGameId(gameId);</span>
<span class="nc bnc" id="L1446" title="All 2 branches missed.">			if (countUpdate &lt;= 0) {</span>
<span class="nc" id="L1447">				return resultUserAssignSave(gameId, gameNo, user);</span>
			}
<span class="nc" id="L1449">			return &quot;SUCCESS&quot;;</span>
<span class="nc" id="L1450">		} catch (Exception ex) {</span>
<span class="nc" id="L1451">			ex.printStackTrace();</span>
			try {
<span class="nc" id="L1453">				con.rollback();</span>
<span class="nc" id="L1454">			} catch (SQLException e) {</span>
<span class="nc" id="L1455">				e.printStackTrace();</span>
<span class="nc" id="L1456">			}</span>
		} finally {
<span class="nc" id="L1458">			DBConnect.closeCon(con);</span>
<span class="nc" id="L1459">		}</span>
<span class="nc" id="L1460">		return &quot;ERROR&quot;;</span>
	}

	public ArrayList&lt;ResultSubmitBean&gt; resultUserAssignFetch() {
<span class="nc" id="L1464">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L1465">		ArrayList&lt;ResultSubmitBean&gt; list = new ArrayList&lt;ResultSubmitBean&gt;();</span>
		try {
<span class="nc" id="L1467">			con.setAutoCommit(false);</span>
<span class="nc" id="L1468">			String query = &quot;select game_name,sdgm.game_id,sdgm.game_nbr,ifnull(user1_id,-1) as user1_id,ifnull(user2_id,-1) as user2_id ,ifnull(user3_id,-1) as user3_id, ifnull(user4_id,-1) as user4_id, ifnull(user5_id,-1) as user5_id, ifnull(user6_id,-1) as user6_id, ifnull(user7_id,-1) as user7_id, ifnull(user8_id,-1) as user8_id, ifnull(user9_id,-1) as user9_id, ifnull(user10_id,-1) as user10_id from st_dg_result_sub_master sdrs right join st_dg_game_master sdgm on sdrs.game_id=sdgm.game_id where sdgm.game_status='OPEN'&quot;;</span>
<span class="nc" id="L1469">			PreparedStatement pstmt = con.prepareStatement(query);</span>
<span class="nc" id="L1470">			ResultSet rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L1472" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1473">				ResultSubmitBean rsb = new ResultSubmitBean();</span>
<span class="nc" id="L1474">				rsb.setGameName(rs.getString(&quot;game_name&quot;));</span>
<span class="nc" id="L1475">				rsb.setGameId(rs.getInt(&quot;game_id&quot;));</span>
<span class="nc" id="L1476">				rsb.setGameNo(rs.getInt(&quot;game_nbr&quot;));</span>
				
<span class="nc" id="L1478">				int[] userIdArr = new int[10]; </span>
<span class="nc bnc" id="L1479" title="All 2 branches missed.">				for (int i = 0; i &lt; userIdArr.length; i++) {</span>
<span class="nc" id="L1480">					userIdArr[i] = rs.getInt(&quot;user&quot;+(i+1)+&quot;_id&quot;);</span>
				}
				
<span class="nc" id="L1483">				rsb.setUserIdArr(userIdArr);</span>
<span class="nc" id="L1484">				list.add(rsb);</span>
<span class="nc" id="L1485">			}</span>

<span class="nc" id="L1487">			con.commit();</span>

<span class="nc" id="L1489">		} catch (Exception ex) {</span>
<span class="nc" id="L1490">			ex.printStackTrace();</span>
			try {
<span class="nc" id="L1492">				con.rollback();</span>
<span class="nc" id="L1493">			} catch (SQLException e) {</span>
<span class="nc" id="L1494">				e.printStackTrace();</span>
<span class="nc" id="L1495">			}</span>
		} finally {
<span class="nc" id="L1497">			try {</span>
<span class="nc" id="L1498">				con.close();</span>
<span class="nc" id="L1499">			} catch (SQLException e) {</span>
<span class="nc" id="L1500">				e.printStackTrace();</span>
<span class="nc" id="L1501">			}</span>
<span class="nc" id="L1502">		}</span>
<span class="nc" id="L1503">		return list;</span>
	}

	public String resultUserAssignSave(int gameId, int gameNo, int[] user) {
<span class="nc" id="L1507">		Connection con = DBConnect.getConnection();</span>
		try {
<span class="nc" id="L1509">			con.setAutoCommit(false);</span>
<span class="nc" id="L1510">			String query = &quot;select * from st_dg_result_sub_master where game_id = ?&quot;;</span>
<span class="nc" id="L1511">			PreparedStatement pstmt = con.prepareStatement(query);</span>
<span class="nc" id="L1512">			pstmt.setInt(1, gameId);</span>
<span class="nc" id="L1513">			ResultSet rs = pstmt.executeQuery();</span>

<span class="nc bnc" id="L1515" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L1516">				return &quot;ALREADY_EXIST&quot;;</span>
			}
			
<span class="nc" id="L1519">			StringBuilder qryFirst = new StringBuilder(&quot;insert into st_dg_result_sub_master (game_id, game_no&quot;);</span>
<span class="nc" id="L1520">			StringBuilder qryLast = new StringBuilder(&quot;) values(&quot;+gameId+&quot;,&quot;+gameNo);</span>
<span class="nc bnc" id="L1521" title="All 2 branches missed.">			for(int i=0; i&lt;user.length; i++){</span>
<span class="nc" id="L1522">				qryFirst.append(&quot;, user&quot;+(i+1)+&quot;_id&quot;);</span>
<span class="nc" id="L1523">				qryLast.append(&quot;,&quot; + user[i]);</span>
			}
			
<span class="nc" id="L1526">			qryFirst.append(qryLast + &quot;)&quot;);</span>
			
			//query = &quot;insert into st_dg_result_sub_master (game_id, game_no, user1_id, user2_id) values(?, ?, ?, ?)&quot;;
<span class="nc" id="L1529">			pstmt = con.prepareStatement(qryFirst.toString());</span>
			//pstmt.setInt(1, gameId);
			//pstmt.setInt(2, gameNo);
			//pstmt.setInt(3, user1Id);
			//pstmt.setInt(4, user2Id);

<span class="nc" id="L1535">			pstmt.executeUpdate();</span>

<span class="nc" id="L1537">			con.commit();</span>
<span class="nc" id="L1538">			return &quot;SUCCESS&quot;;</span>
<span class="nc" id="L1539">		} catch (Exception ex) {</span>
<span class="nc" id="L1540">			ex.printStackTrace();</span>
			try {
<span class="nc" id="L1542">				con.rollback();</span>
<span class="nc" id="L1543">			} catch (SQLException e) {</span>
<span class="nc" id="L1544">				e.printStackTrace();</span>
<span class="nc" id="L1545">			}</span>
		} finally {
<span class="nc" id="L1547">			try {</span>
<span class="nc" id="L1548">				con.close();</span>
<span class="nc" id="L1549">			} catch (SQLException e) {</span>
<span class="nc" id="L1550">				e.printStackTrace();</span>
<span class="nc" id="L1551">			}</span>
<span class="nc" id="L1552">		}</span>
<span class="nc" id="L1553">		return &quot;ERROR&quot;;</span>
	}

	/*public String saveAdvMessageData(String orgType, String[] gameNo,
			String[] retName, String message, int creatorUserId,
			String msgLocation, String activity, int serviceId) throws SQLException {
		
		int msgId = 0;
		String result=null;
		boolean isAllRet = false;
		//boolean isAllGame = false;
		Connection con = null;
		ResultSet rsMsgId = null;
		Statement drawStmt = null;
		StringBuilder tempRet = null;
		PreparedStatement pstmt = null;
		List&lt;String&gt; tempRetNameList = null;
		//List&lt;String&gt; tempGameList = null;
		//List&lt;String&gt; tempRetIdList = null;
		try{
		//int serviceId = ((HashMap&lt;String,Integer&gt;)LMSUtility.sc.getAttribute(&quot;SERVICES_CODE_ID_MAP&quot;)).get(serviceCode);
		if (gameNo == null || retName == null)
			throw new LMSException(LMSErrors.BO_ADD_MESSAGING_ERROR_CODE, LMSErrors.BO_ADD_MESSAGING_ERROR_MESSAGE);
			//return &quot;error&quot;;
		
		//tempGameList = Arrays.asList(gameNo);
		//tempRetIdList = new ArrayList&lt;String&gt;();
		/*if (tempGameList.contains(&quot;-1&quot;)) {
			isAllGame = true;
		}*/
		/*tempRetNameList = Arrays.asList(retName);
		if (tempRetNameList.contains(&quot;-1&quot;)) {
			isAllRet = true;
		}
		tempRet = new StringBuilder(&quot;&quot;);
		if (!isAllRet)
			for (String element : retName) {
				tempRet.append(&quot;'&quot; + element);
				tempRet.append(&quot;',&quot;);
			}
			/*tempRet.deleteCharAt(tempRet.length() - 1);
			String selRet = &quot;select organization_id from st_lms_organization_master where name in (&quot;
					+ tempRet + &quot;)&quot;;
			ResultSet retRs = drawStmt.executeQuery(selRet);
			while (retRs.next()) {
				tempRetIdList.add(retRs.getString(&quot;organization_id&quot;));
			}*/
		/*String query = &quot;insert into st_dg_adv_msg_master(date,creator_user_id,msg_text,status,msg_for,msg_location,activity) values('&quot;
				+ new Timestamp(new Date().getTime())
				+ &quot;',&quot;
				+ creatorUserId
				+ &quot;,'&quot;
				+ message
				+ &quot;','ACTIVE','&quot;
				+ orgType
				+ &quot;','&quot;
				+ msgLocation + &quot;','&quot; + activity + &quot;')&quot;;*/

		/*con = DBConnect.getConnection();
		con.setAutoCommit(false);
		String query = &quot;insert into st_dg_adv_msg_master(date,creator_user_id,msg_text,status,msg_for,msg_location,activity) values(?,?,?,?,?,?,?)&quot;;
		pstmt=con.prepareStatement(query);
		pstmt.setTimestamp(1, new Timestamp(new Date().getTime()));
		pstmt.setInt(2, creatorUserId);
		pstmt.setString(3, message);
		pstmt.setString(4, &quot;ACTIVE&quot;);
		pstmt.setString(5, orgType);
		pstmt.setString(6, msgLocation);
		pstmt.setString(7, activity);
		
		logger.info(&quot;***************-&quot; + query);
		pstmt.executeUpdate();
		rsMsgId = pstmt.getGeneratedKeys();
		//drawStmt.execute(query);
		if (rsMsgId.next()) 
			msgId = rsMsgId.getInt(1);
		
		drawStmt = con.createStatement();
		if (isAllRet) 
			for (String element : gameNo) {
				query = &quot;insert into st_dg_adv_msg_org_mapping(msg_id,org_id,service_id,game_id) values(&quot;
						+ msgId + &quot;,-1,&quot;+serviceId+&quot;,&quot; + element + &quot;)&quot;;
				drawStmt.addBatch(query);

			}
			//drawStmt.executeBatch();
		 else 
			for (String element : gameNo) {
				for (int j = 0; j &lt; retName.length; j++) {
					query = &quot;insert into st_dg_adv_msg_org_mapping(msg_id,org_id,service_id,game_id) values(&quot;
							+ msgId
							+ &quot;,&quot;
							+ retName[j].split(&quot;~&quot;)[0] + &quot;,&quot;+serviceId
							+ &quot;,&quot;	
							+ element + &quot;)&quot;;
					drawStmt.addBatch(query);
				}
			}
			//drawStmt.executeBatch();
		
		drawStmt.executeBatch();
		con.commit();
		//DBConnect.closeCon(con);
		result=&quot;success&quot;;
		//		ADD ADVERTISEMENT MESSAGES IN STATIC MAP IN CONTEXT
		Util.advMsgDataMap = new DrawGameRPOSHelper().getAdvMsgDataMap();
		}catch (LMSException e) {
			logger.error(e.getErrorMessage());
			logger.error(&quot;Exception in Adv Mssg &quot; + e);
			result=&quot;error&quot;;
		}catch (SQLException e) {
			logger.error(&quot;Exception in Adv Mssg &quot; + e);
			result=&quot;error&quot;;
		}catch (Exception e) {
			logger.error(&quot;Exception in Adv Mssg &quot; + e);
			result=&quot;error&quot;;
		}finally{
			DBConnect.closePstmt(pstmt);
			DBConnect.closeConnection(con, drawStmt, rsMsgId);
		}
		return result;
	}
	
	public String saveAdvMessageDataForRetailer(String orgType, String[] agtName,
			String[] retName, String message, int creatorUserId,
			String msgLocation, String activity1) throws SQLException {
		
		int msgId = 0;
		boolean isAllRet = false;
		
		String result = null;
		String status = null;
		String tempRetStr = &quot;&quot;;
		String tempAgtStr = &quot;&quot;;
		String tempOrgIdStr = &quot;&quot;;
		StringBuilder tempOrgStr = null;

		ResultSet rs = null;
		Connection con = null;
		Statement drawStmt = null;
		PreparedStatement pstmt = null;

		List&lt;Integer&gt; orgIdList = null;
		List&lt;String&gt; phoneNoList = null;
		List&lt;Integer&gt; userIdList = null;
		List&lt;String&gt; tempAgtNameList = null;
		List&lt;String&gt; tempRetNameList = null;
		try{

			if (retName == null &amp;&amp; agtName == null) 
			throw new LMSException(LMSErrors.BO_ADD_MESSAGING_ERROR_CODE, LMSErrors.BO_ADD_MESSAGING_ERROR_MESSAGE);

			if(agtName != null)
			tempAgtNameList = Arrays.asList(agtName);

			if(tempAgtNameList != null)
			tempAgtStr = tempAgtNameList.toString().replace(&quot;, &quot;, &quot;','&quot;).replace(&quot;[&quot;, &quot;'&quot;).replace(&quot;]&quot;, &quot;'&quot;);
		
			if(retName != null){
				String temp[] = new String[retName.length];
					for(int i=0; i&lt;retName.length; i++) 
							temp[i] = retName[i].split(&quot;~&quot;)[0];
					tempRetNameList = Arrays.asList(temp);
			}
			if(tempRetNameList != null)
			tempRetStr = tempRetNameList.toString().replace(&quot;, &quot;, &quot;','&quot;).replace(&quot;[&quot;, &quot;'&quot;).replace(&quot;]&quot;, &quot;'&quot;);

			if (tempRetNameList != null &amp;&amp; tempRetNameList.contains(&quot;-1&quot;)) 
			isAllRet = true;

			if (!isAllRet) {
				tempOrgStr = new StringBuilder(&quot;&quot;);
				if(tempAgtStr.length() == 0 &amp;&amp; tempRetStr.length() != 0)
					tempOrgStr.append(tempRetStr);
				else if(tempAgtStr.length() != 0 &amp;&amp; tempRetStr.length() == 0)
					tempOrgStr.append(tempAgtStr);
				else 
				tempOrgStr.append(tempAgtStr + &quot;,&quot; + tempRetStr);
			
			/*String orgIdQry = &quot;select organization_id from st_lms_organization_master where name in (&quot; + tempOrgStr.toString() + &quot;)&quot;;
			pstmt = con.prepareStatement(orgIdQry);
			System.out.println(&quot;orgIdQry:&quot; + pstmt);
			rs = pstmt.executeQuery();
			
			while (rs.next()) {
				orgIdList.add(rs.getInt(&quot;organization_id&quot;));
			}*/
			
			//tempOrgIdStr = orgIdList.toString().replace(&quot;[&quot;, &quot;(&quot;).replace(&quot;]&quot;, &quot;)&quot;).replace(&quot; &quot;, &quot;&quot;);
			/*tempOrgIdStr = &quot; and b.organization_id in (&quot; + tempRetStr + &quot;)&quot;;
		}
		
		//orgIdList = new ArrayList&lt;Integer&gt;();
		
		String qry = &quot;select a.user_id, b.organization_id, a.phone_nbr from st_lms_user_contact_details a, st_lms_user_master b, st_lms_role_master c where b.isrolehead='Y' and a.user_id=b.user_id and c.is_master = 'Y' and b.role_id=c.role_id&quot; + tempOrgIdStr;
		con = DBConnect.getConnection();
		con.setAutoCommit(false);
		pstmt = con.prepareStatement(qry);
		logger.info(&quot;phn no query:&quot; + pstmt);
		rs = pstmt.executeQuery();
		
		orgIdList = new ArrayList&lt;Integer&gt;();
		userIdList = new ArrayList&lt;Integer&gt;();
		phoneNoList = new ArrayList&lt;String&gt;();
		while (rs.next()) {
			userIdList.add(rs.getInt(&quot;user_id&quot;));
			orgIdList.add(rs.getInt(&quot;organization_id&quot;));
			phoneNoList.add(rs.getString(&quot;phone_nbr&quot;));
		}
		/*String query = &quot;insert into st_dg_adv_msg_master(date,creator_user_id,msg_text,status,msg_for,msg_location,activity) values('&quot;
				+ new Timestamp(new Date().getTime())
				+ &quot;',&quot;
				+ creatorUserId
				+ &quot;,'&quot;
				+ message
				+ &quot;','ACTIVE','&quot;
				+ orgType
				+ &quot;','&quot;
				+ msgLocation + &quot;','&quot; + activity1 + &quot;')&quot;;
		*/
		
		/*String query = &quot;insert into st_dg_adv_msg_master(date,creator_user_id,msg_text,status,msg_for,msg_location,activity) values(?,?,?,?,?,?,?)&quot;;
		pstmt=con.prepareStatement(query);
		pstmt.setTimestamp(1, new Timestamp(new Date().getTime()));
		pstmt.setInt(2, creatorUserId);
		pstmt.setString(3, message);
		pstmt.setString(4, &quot;ACTIVE&quot;);
		pstmt.setString(5, orgType);
		pstmt.setString(6, msgLocation);
		pstmt.setString(7, activity1);
		logger.info(&quot;***************-&quot; + query);
		pstmt.executeUpdate();
		rs = pstmt.getGeneratedKeys();

		if (rs.next()) 
			msgId = rs.getInt(1);
		//--
		//-- insert SMS details
		
		drawStmt=con.createStatement();
		for (int i = 0; i &lt; orgIdList.size(); i++) {
			status = &quot;Sent&quot;;
			Timestamp currTime = new Timestamp(new Date().getTime());
			if(&quot;Instant&quot;.equalsIgnoreCase(activity1)){
				try {
					Util.sendMsgToUsers(phoneNoList.get(i), message);
				} catch (Exception e) {
					e.printStackTrace();
				}
			} else if(&quot;Draw Perform&quot;.equalsIgnoreCase(activity1)){
				
			} else if (&quot;Scheduled&quot;.equalsIgnoreCase(activity1)){
				
			}
			query = &quot;insert into st_dg_adv_sms_details (user_id,org_id,phn_no,msg_id,status,time) values(&quot;+userIdList.get(i)+&quot;,&quot;+orgIdList.get(i)+&quot;,'&quot;+phoneNoList.get(i)+&quot;',&quot;+msgId+&quot;,'&quot;+status+&quot;','&quot;+currTime+&quot;')&quot;;
			drawStmt.addBatch(query);
		}
		
		drawStmt.executeBatch();
		con.commit();
		result=&quot;success&quot;;

		}catch (LMSException e) {
			logger.error(e.getErrorMessage());
			logger.error(&quot;Exception in Adv Mssg &quot; + e);
			result=&quot;error&quot;;
		}catch (SQLException e) {
			logger.error(&quot;Exception in Adv Mssg &quot; + e);
			result=&quot;error&quot;;
		}catch (Exception e) {
			logger.error(&quot;Exception in Adv Mssg &quot; + e);
			result=&quot;error&quot;;
		}finally{
			DBConnect.closeConnection(con, pstmt, drawStmt, rs);
		}

		return result;

	}*/


	public String saveDrawResult(ManualWinningBean mwBean) throws Exception {
<span class="nc" id="L1835">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L1836">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L1837">		sReq.setServiceName(ServiceName.DRAW_RESULT_MGMT);</span>
<span class="nc" id="L1838">		sReq.setServiceMethod(ServiceMethodName.SAVE_SUB_DRAW_RESULT);</span>
<span class="nc" id="L1839">		sReq.setServiceData(mwBean);</span>
<span class="nc" id="L1840">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L1841">		sRes = delegate.getResponse(sReq);</span>
<span class="nc" id="L1842">		return sRes.getResponseData().toString();</span>

	}

	
	public List&lt;TicketTracking&gt; ticketWinStatus(String ticketNum) throws Exception {
		
		int gameNbr;	
<span class="nc" id="L1850">		String orgCodeQry =null;</span>
<span class="nc" id="L1851">		String barCodeCount=&quot;-1&quot;;</span>
<span class="nc" id="L1852">		String ticketNumber=null;</span>
<span class="nc" id="L1853">		String saleTypeQuery =null;</span>
<span class="nc" id="L1854">		String fetchPwtTime = null;</span>
<span class="nc" id="L1855">		String fetchPartyName = null;</span>

<span class="nc" id="L1857">		ResultSet rs=null;</span>
<span class="nc" id="L1858">		Statement stmt =null;</span>
<span class="nc" id="L1859">		Connection con = null;</span>
<span class="nc" id="L1860">		PreparedStatement pstmt =null;</span>

<span class="nc" id="L1862">		ServiceResponse sRes = null;</span>
<span class="nc" id="L1863">		ServiceRequest sReq = null;</span>
	
<span class="nc" id="L1865">		TicketTracking tktTrack=null;</span>
<span class="nc" id="L1866">		ValidateTicketBean tktBean=null;</span>
<span class="nc" id="L1867">		List&lt;TicketTracking&gt; trackingList=null;	</span>

		try {

<span class="nc" id="L1871">			tktTrack = new TicketTracking();</span>
<span class="nc" id="L1872">			trackingList=new LinkedList&lt;TicketTracking&gt;();	</span>
<span class="nc bnc" id="L1873" title="All 6 branches missed.">			if( !CommonValidation.isNumericWithoutDot(ticketNum,false) || &quot;&quot;.equals(ticketNum) || &quot;0&quot;.equals(ticketNum)) // 0 , blank for track ticket transaction ticket</span>
<span class="nc" id="L1874">				throw new LMSException(LMSErrors.INVALID_TICKET_ERROR_CODE,LMSErrors.INVALID_TICKET_ERROR_MESSAGE);			</span>

<span class="nc" id="L1876">			ticketNumber=Util.getTicketNumber(ticketNum, 3); // ADDED FOR EITHER CASE</span>
<span class="nc bnc" id="L1877" title="All 2 branches missed.">			if(&quot;&quot;.equals(ticketNumber))</span>
<span class="nc" id="L1878">				throw new LMSException(LMSErrors.INVALID_TICKET_ERROR_CODE,LMSErrors.INVALID_TICKET_ERROR_MESSAGE);</span>
			
			// Get The BarCode From Ticket Number If Required  
<span class="nc bnc" id="L1881" title="All 2 branches missed.">			if (ticketNum.trim().length() == com.skilrock.lms.common.ConfigurationVariables.barcodeCount) </span>
<span class="nc" id="L1882">				barCodeCount = Util.getBarCodeCountFromTicketNumber(ticketNum);</span>
			
<span class="nc" id="L1884">			tktBean = new ValidateTicketBean();</span>
<span class="nc" id="L1885">			tktBean=Util.validateTkt(ticketNumber); </span>
<span class="nc bnc" id="L1886" title="All 2 branches missed.">			if(!(tktBean.isValid()))</span>
<span class="nc" id="L1887">				throw new LMSException(LMSErrors.INVALID_TICKET_ERROR_CODE,LMSErrors.INVALID_TICKET_ERROR_MESSAGE);</span>
			
<span class="nc" id="L1889">		con = DBConnect.getConnection();</span>
<span class="nc" id="L1890">		gameNbr=Util.getGamenoFromTktnumber(ticketNumber);</span>
<span class="nc" id="L1891">		sRes = new ServiceResponse();</span>
<span class="nc" id="L1892">		sReq = new ServiceRequest();</span>
<span class="nc" id="L1893">		sReq.setServiceName(ServiceName.REPORTS_MGMT);</span>
		
<span class="nc bnc" id="L1895" title="All 2 branches missed.">		if(Util.getGameType(Util.getGameIdFromGameNumber(gameNbr)).equals(&quot;RAFFLE&quot;)){</span>
<span class="nc" id="L1896">			sReq.setServiceMethod(ServiceMethodName.RAFFLE_TRACK_TICKET);</span>
<span class="nc" id="L1897">			trackingList.add((TicketTracking)trckRaffleTicket(ticketNumber,con));</span>
		}else{
<span class="nc" id="L1899">		sReq.setServiceMethod(ServiceMethodName.DRAWGAME_TRACK_TICKET);</span>
<span class="nc" id="L1900">		sReq.setServiceData(ticketNumber.concat(&quot;Nxt&quot;).concat(barCodeCount));</span>
<span class="nc" id="L1901">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L1902">		sRes = delegate.getResponse(sReq);</span>
<span class="nc bnc" id="L1903" title="All 2 branches missed.">		if (!sRes.getIsSuccess()) </span>
<span class="nc" id="L1904">			throw new LMSException(LMSErrors.INVALID_TICKET_ERROR_CODE,LMSErrors.INVALID_TICKET_ERROR_MESSAGE);</span>
		
<span class="nc bnc" id="L1906" title="All 2 branches missed.">		if (sRes.getIsSuccess()) {</span>
			
<span class="nc" id="L1908">			String responseString=sRes.getResponseData().toString();</span>
<span class="nc" id="L1909">			Type elementType = new TypeToken&lt;TicketTracking&gt;() {}.getType();</span>
<span class="nc" id="L1910">			tktTrack = new Gson().fromJson(responseString, elementType);</span>
			//tktTrack = (TicketTracking) sRes.getResponseData();
			
			// Rounding Done Based On the Requirement. Initially we used to do it in DGE.
<span class="nc" id="L1914">			List&lt;DrawIdBean&gt; drawWinList = null;</span>
<span class="nc bnc" id="L1915" title="All 2 branches missed.">			if(Boolean.parseBoolean((String)Utility.getPropertyValue(&quot;DO_MATH_ROUNDING_FOR_PWT_AMT&quot;))){</span>
<span class="nc" id="L1916">			drawWinList=tktTrack.getDrawWinList();</span>
<span class="nc" id="L1917">			Iterator&lt;DrawIdBean&gt; drawWiseiterator = drawWinList.iterator();</span>
<span class="nc bnc" id="L1918" title="All 2 branches missed.">			while(drawWiseiterator.hasNext()){</span>
<span class="nc" id="L1919">				DrawIdBean drawIdBean = drawWiseiterator.next();</span>
				//Draw Wise Rounding
<span class="nc" id="L1921">				drawIdBean.setWinningAmt(Math.round(Double.parseDouble(drawIdBean.getWinningAmt()))+&quot;&quot;);</span>
<span class="nc" id="L1922">				Iterator&lt;PanelIdBean&gt; panelWiseiterator = drawIdBean.getPanelWinList().iterator();</span>
<span class="nc bnc" id="L1923" title="All 2 branches missed.">					while(panelWiseiterator.hasNext()){</span>
<span class="nc" id="L1924">						PanelIdBean panelIdBean = panelWiseiterator.next();</span>
						//Panel Wise Rounding
<span class="nc" id="L1926">						panelIdBean.setWinningAmt(Math.round(panelIdBean.getWinningAmt()));</span>
<span class="nc" id="L1927">						panelIdBean.setPlayType(panelIdBean.getBetDispName());</span>
<span class="nc" id="L1928">					}</span>
<span class="nc" id="L1929">				}		</span>
			}
			
<span class="nc" id="L1932">			HashMap&lt;Integer, String&gt; partyIdMap = tktTrack.getPartyId();</span>
<span class="nc" id="L1933">			HashMap&lt;Integer, String&gt; pwtTimeMap = new HashMap&lt;Integer, String&gt;();</span>
			
<span class="nc" id="L1935">			int gameId = tktTrack.getGameId();</span>
<span class="nc" id="L1936">			String[] arr = new String[] { &quot;st_lms_bo_transaction_master&quot;,&quot;st_lms_retailer_transaction_master&quot;,&quot;st_lms_agent_transaction_master&quot; };</span>

<span class="nc" id="L1938">			orgCodeQry =QueryManager.getOrgCodeQuery();</span>
<span class="nc" id="L1939">			stmt = con.createStatement();</span>
<span class="nc" id="L1940">			fetchPartyName = &quot;select organization_id,&quot;+orgCodeQry+&quot; from st_lms_organization_master where organization_id in (&quot;+ partyIdMap.values().toString().replace(&quot;[&quot;, &quot;&quot;).replace(&quot;]&quot;, &quot;&quot;) + &quot;)&quot;;</span>
<span class="nc" id="L1941">				rs = stmt.executeQuery(fetchPartyName);</span>
<span class="nc bnc" id="L1942" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L1943">					partyIdMap.put(rs.getInt(&quot;organization_id&quot;), rs.getString(&quot;orgCode&quot;));</span>
				}

<span class="nc" id="L1946">				fetchPwtTime = &quot; slm,(select transaction_id,draw.draw_id from st_lms_transaction_master sltm,(select draw_id, if(retailer_transaction_id is null ,if(agent_transaction_id is null ,bo_transaction_id,agent_transaction_id ),retailer_transaction_id ) as trans_id from st_dg_pwt_inv_&quot;</span>
						+ gameId
						+ &quot; where ticket_nbr='&quot;
						+ Util.getTktWithoutRpcNBarCodeCount(ticketNumber, ticketNumber.length())
						+ &quot;') draw where sltm.transaction_id=draw.trans_id ) a where slm.transaction_id=a.transaction_id&quot;;

			
<span class="nc bnc" id="L1953" title="All 2 branches missed.">				for (String element : arr) {</span>
<span class="nc" id="L1954">					String qry = &quot;select transaction_date,draw_id from &quot;+ element + fetchPwtTime;</span>
<span class="nc" id="L1955">					logger.info(qry);</span>
<span class="nc" id="L1956">					rs = stmt.executeQuery(qry);</span>
<span class="nc bnc" id="L1957" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L1958">						pwtTimeMap.put(rs.getInt(&quot;draw_id&quot;), rs.getString(&quot;transaction_date&quot;).split(&quot;\\.&quot;)[0]);</span>
					}
				}
<span class="nc" id="L1961">				logger.info(pwtTimeMap + &quot;***Track Tick&quot; + partyIdMap);</span>
<span class="nc" id="L1962">				tktTrack.setPartyId(partyIdMap);</span>
<span class="nc" id="L1963">				tktTrack.setRetailerName(partyIdMap.get(tktTrack.getRetailerId()));</span>
<span class="nc" id="L1964">				tktTrack.setPwtTimeMap(pwtTimeMap);</span>

<span class="nc" id="L1966">				saleTypeQuery = &quot;select rt.transaction_type from st_lms_retailer_transaction_master rt, st_dg_ret_sale_? rs where rt.transaction_id = rs.transaction_id and rs.ticket_nbr = ?&quot;;</span>
<span class="nc" id="L1967">				pstmt = con.prepareStatement(saleTypeQuery);</span>
<span class="nc" id="L1968">				pstmt.setInt(1, tktTrack.getGameId());</span>
<span class="nc" id="L1969">				pstmt.setString(2,  Util.getTktWithoutRpcNBarCodeCount(ticketNumber, ticketNumber.length()));</span>

<span class="nc" id="L1971">				rs = pstmt.executeQuery();</span>
<span class="nc" id="L1972">				String trxnType = null;</span>
<span class="nc bnc" id="L1973" title="All 2 branches missed.">				if (rs.next()) {</span>
<span class="nc" id="L1974">					trxnType = rs.getString(&quot;transaction_type&quot;);</span>
				}
<span class="nc bnc" id="L1976" title="All 2 branches missed.">				if (trxnType != null) {</span>
<span class="nc bnc" id="L1977" title="All 2 branches missed.">					if (&quot;DG_SALE&quot;.equalsIgnoreCase(trxnType)) {</span>
<span class="nc" id="L1978">						tktTrack.setSaleMode(&quot;ONLINE&quot;);</span>
<span class="nc bnc" id="L1979" title="All 2 branches missed.">					} else if (&quot;DG_SALE_OFFLINE&quot;.equalsIgnoreCase(trxnType)) {</span>
<span class="nc" id="L1980">						tktTrack.setSaleMode(&quot;OFFLINE&quot;);</span>
					}
				}
<span class="nc" id="L1983">				trackingList.add(tktTrack);</span>
		}

<span class="nc" id="L1986">		logger.info(&quot;ticket tracking::&quot;+trackingList);</span>
<span class="nc" id="L1987">				List&lt;PromoGameBean&gt; raffleList = 	DGPromoScheme.getAvailablePromoGamesNew(Util.getGameName(tktTrack.getGameId()), tktTrack.getSaleAmt(), null);</span>
<span class="nc bnc" id="L1988" title="All 4 branches missed.">					if(raffleList != null &amp;&amp; raffleList.size()&gt;0){</span>
<span class="nc" id="L1989">						PromoGameBean promoBean = null;</span>
					//	DrawIdBean drawBean = new DrawIdBean();
<span class="nc" id="L1991">						String raffleTicketNum = null;</span>
<span class="nc bnc" id="L1992" title="All 2 branches missed.">						for(int i = 0 ; i &lt; raffleList.size();i++){</span>
<span class="nc" id="L1993">							promoBean = raffleList.get(i);</span>
<span class="nc bnc" id="L1994" title="All 2 branches missed.">							if(&quot;RAFFLE&quot;.equalsIgnoreCase(promoBean.getPromoGametype())){</span>
<span class="nc bnc" id="L1995" title="All 2 branches missed.">							if(&quot;ORIGINAL&quot;.equalsIgnoreCase(promoBean.getPromoTicketType())){</span>
<span class="nc" id="L1996">								PreparedStatement pstmt1 = con.prepareStatement(&quot;Select promo_ticket_nbr from ge_sale_promo_ticket_mapping where sale_ticket_nbr = '&quot;+ticketNumber.substring(0, ticketNumber.length() - 2)+&quot;'&quot;);</span>
<span class="nc" id="L1997">								ResultSet rs1 = pstmt1.executeQuery();								</span>
<span class="nc bnc" id="L1998" title="All 2 branches missed.">								if(rs1.next()){</span>
<span class="nc" id="L1999">									raffleTicketNum = rs1.getString(&quot;promo_ticket_nbr&quot;);</span>
								}
<span class="nc" id="L2001">								trackingList.add((TicketTracking)trckRaffleTicket(raffleTicketNum+&quot;00&quot;,con));</span>
							}
						}
					}
				}
			}
					
				//is there any promo ticket available
				//check it from st_lms_promo_mapping_table here you will get the ticket 14151415141514
<span class="nc" id="L2010">		}catch(LMSException e){</span>
<span class="nc" id="L2011">			logger.error(e.getErrorMessage());</span>
<span class="nc" id="L2012">			tktTrack.setStatus(e.getErrorMessage());</span>
<span class="nc" id="L2013">			trackingList.add(tktTrack);</span>
<span class="nc" id="L2014">		}catch (Exception e) {</span>
<span class="nc" id="L2015">			e.printStackTrace();</span>
		}finally {
<span class="nc" id="L2017">			DBConnect.closeConnection(con, pstmt,stmt, rs);</span>
<span class="nc" id="L2018">		}</span>
<span class="nc" id="L2019">		return trackingList;</span>
	}

	
	public TicketTracking trckRaffleTicket(String ticketNum,Connection con) throws Exception{
<span class="nc" id="L2024">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L2025">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L2026">		sReq.setServiceName(ServiceName.REPORTS_MGMT);</span>
<span class="nc" id="L2027">		sReq.setServiceMethod(ServiceMethodName.RAFFLE_TRACK_TICKET);</span>
<span class="nc" id="L2028">		sReq.setServiceData(ticketNum);</span>
		int gameNbr;
<span class="nc" id="L2030">		TicketTracking tktTrack1=new TicketTracking();</span>
		
		

<span class="nc" id="L2034">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
		//TicketTracking tktTrack = null;
		
<span class="nc" id="L2037">			PromoGameBean promoBean = null;</span>
<span class="nc" id="L2038">			DrawIdBean drawBean = new DrawIdBean();</span>
<span class="nc" id="L2039">			String raffleTicketNum = ticketNum.substring(0,ticketNum.length()-2);</span>
					
<span class="nc" id="L2041">						sRes = delegate.getResponse(sReq);</span>
<span class="nc bnc" id="L2042" title="All 2 branches missed.">						if(sRes.getIsSuccess()){</span>
<span class="nc" id="L2043">							String responseString=sRes.getResponseData().toString();</span>
<span class="nc" id="L2044">							Type elementType = new TypeToken&lt;TicketTracking&gt;() {}.getType();</span>
<span class="nc" id="L2045">							tktTrack1 = new Gson().fromJson(responseString, elementType);</span>
							//tktTrack1 = (TicketTracking) sRes.getResponseData();	
<span class="nc" id="L2047">						drawBean=tktTrack1.getDrawWinList().get(0);</span>
<span class="nc bnc" id="L2048" title="All 6 branches missed.">						if (drawBean.getWinResult() != null &amp;&amp; !&quot;NULL&quot;.equalsIgnoreCase(drawBean.getWinResult()) &amp;&amp; !&quot;0&quot;.equalsIgnoreCase(drawBean.getWinResult()))</span>
						{
<span class="nc" id="L2050">						String[] drawRsltArr = drawBean.getWinResult().split(&quot;,&quot;);</span>
<span class="nc" id="L2051">						StringBuilder tmpRslt = new StringBuilder(&quot;&quot;);</span>
<span class="nc bnc" id="L2052" title="All 2 branches missed.">						for(int k=0; k&lt;drawRsltArr.length; k++){</span>
<span class="nc" id="L2053">							drawRsltArr[k] = drawRsltArr[k].substring(0, drawRsltArr[k].length() - 4) + &quot;XXXX,&quot;;</span>
<span class="nc" id="L2054">							tmpRslt.append(drawRsltArr[k]);</span>
						}
<span class="nc bnc" id="L2056" title="All 2 branches missed.">						if(tmpRslt.length() &gt; 0){</span>
<span class="nc" id="L2057">							tmpRslt.deleteCharAt(tmpRslt.length() - 1);</span>
						}
<span class="nc" id="L2059">						drawBean.setWinResult(tmpRslt.toString());</span>
						}
<span class="nc" id="L2061">						HashMap&lt;Integer, String&gt; partyIdMap = tktTrack1.getPartyId();</span>
<span class="nc" id="L2062">						HashMap&lt;Integer, String&gt; pwtTimeMap = new HashMap&lt;Integer, String&gt;();</span>
						
<span class="nc" id="L2064">						int gameNo = tktTrack1.getGameNo();</span>
<span class="nc" id="L2065">						tktTrack1.setTktNumber(raffleTicketNum +&quot;00&quot;);</span>
<span class="nc" id="L2066">						String[] arr = new String[] { &quot;st_lms_bo_transaction_master&quot;,</span>
								&quot;st_lms_retailer_transaction_master&quot;,
								&quot;st_lms_agent_transaction_master&quot; };
						
<span class="nc" id="L2070">							Statement stmt = con.createStatement();</span>
<span class="nc" id="L2071">							String fetchPartyName = &quot;select organization_id,name from st_lms_organization_master where organization_id in (&quot;</span>
									+ partyIdMap.values().toString().replace(&quot;[&quot;, &quot;&quot;)
											.replace(&quot;]&quot;, &quot;&quot;) + &quot;)&quot;;
<span class="nc" id="L2074">							ResultSet partyRS = stmt.executeQuery(fetchPartyName);</span>
<span class="nc bnc" id="L2075" title="All 2 branches missed.">							while (partyRS.next()) {</span>
<span class="nc" id="L2076">								partyIdMap.put(partyRS.getInt(&quot;organization_id&quot;), partyRS</span>
										.getString(&quot;name&quot;));
							}

<span class="nc" id="L2080">							String fetchPwtTime = &quot; slm,(select transaction_id,draw.draw_id from st_lms_transaction_master sltm,(select draw_id, if(retailer_transaction_id is null ,if(agent_transaction_id is null ,bo_transaction_id,agent_transaction_id ),retailer_transaction_id ) as trans_id from st_dg_pwt_inv_&quot;</span>
									+ gameNo
									+ &quot; where ticket_nbr='&quot;
									+ raffleTicketNum
									+ &quot;') draw where sltm.transaction_id=draw.trans_id ) a where slm.transaction_id=a.transaction_id&quot;;

<span class="nc" id="L2086">							ResultSet pwtRS = null;</span>
<span class="nc bnc" id="L2087" title="All 2 branches missed.">							for (String element : arr) {</span>
<span class="nc" id="L2088">								String qry = &quot;select transaction_date,draw_id from &quot;</span>
										+ element + fetchPwtTime;
<span class="nc" id="L2090">								System.out.println(qry);</span>
<span class="nc" id="L2091">								pwtRS = stmt.executeQuery(qry);</span>
<span class="nc bnc" id="L2092" title="All 2 branches missed.">								while (pwtRS.next()) {</span>
<span class="nc" id="L2093">									pwtTimeMap.put(pwtRS.getInt(&quot;draw_id&quot;), pwtRS</span>
											.getString(&quot;transaction_date&quot;).split(&quot;\\.&quot;)[0]);
								}
							}

<span class="nc" id="L2098">							System.out.println(pwtTimeMap + &quot;***Track Tick&quot; + partyIdMap);</span>
<span class="nc" id="L2099">							tktTrack1.setPartyId(partyIdMap);</span>
<span class="nc" id="L2100">							tktTrack1.setRetailerName(partyIdMap.get(tktTrack1</span>
									.getRetailerId()));
<span class="nc" id="L2102">							tktTrack1.setPwtTimeMap(pwtTimeMap);</span>

<span class="nc" id="L2104">							String saleTypeQuery = &quot;select rt.transaction_type from st_lms_retailer_transaction_master rt, st_dg_ret_sale_? rs where rt.transaction_id = rs.transaction_id and rs.ticket_nbr = ?&quot;;</span>
<span class="nc" id="L2105">							PreparedStatement pstmt = con.prepareStatement(saleTypeQuery);</span>
<span class="nc" id="L2106">							pstmt.setInt(1, tktTrack1.getGameNo());</span>
<span class="nc" id="L2107">							pstmt.setString(2, raffleTicketNum);</span>

<span class="nc" id="L2109">							ResultSet rs = pstmt.executeQuery();</span>
<span class="nc" id="L2110">							String trxnType = null;</span>
<span class="nc bnc" id="L2111" title="All 2 branches missed.">							if (rs.next()) {</span>
<span class="nc" id="L2112">								trxnType = rs.getString(&quot;transaction_type&quot;);</span>
							}
<span class="nc bnc" id="L2114" title="All 2 branches missed.">							if (trxnType != null) {</span>
<span class="nc bnc" id="L2115" title="All 2 branches missed.">								if (&quot;DG_SALE&quot;.equalsIgnoreCase(trxnType)) {</span>
<span class="nc" id="L2116">									tktTrack1.setSaleMode(&quot;ONLINE&quot;);</span>
<span class="nc bnc" id="L2117" title="All 2 branches missed.">								} else if (&quot;DG_SALE_OFFLINE&quot;.equalsIgnoreCase(trxnType)) {</span>
<span class="nc" id="L2118">									tktTrack1.setSaleMode(&quot;OFFLINE&quot;);</span>
								}
							}
						
			
						}
<span class="nc" id="L2124">					return tktTrack1;</span>
				}
			
		
	
	
	
	public Map weeklyReport(ReportStatusBean reportStatusBean) {
<span class="nc" id="L2132">		Map utilMap = new HashMap();</span>
<span class="nc" id="L2133">		List&lt;DailyLedgerBean&gt; weeklyReport = new ArrayList&lt;DailyLedgerBean&gt;();</span>
<span class="nc" id="L2134">		Connection con = null;</span>

<span class="nc bnc" id="L2136" title="All 4 branches missed.">		if(&quot;NO&quot;.equals(Utility.getPropertyValue(&quot;IS_DATA_FROM_REPLICA&quot;)) || &quot;MAIN_DB&quot;.equals(reportStatusBean.getReportingFrom()))</span>
<span class="nc" id="L2137">			con = DBConnect.getConnection();</span>
		else
<span class="nc" id="L2139">			con = DBConnectReplica.getConnection();</span>

<span class="nc" id="L2141">		Calendar cal = Calendar.getInstance();</span>
<span class="nc" id="L2142">		cal.setTimeInMillis(new Date().getTime());</span>
		// cal.add(Calendar.DAY_OF_YEAR, 1);
<span class="nc" id="L2144">		System.out.println(&quot;**********&quot; + cal.getTime());</span>
<span class="nc" id="L2145">		java.sql.Date fromDate = null;</span>
<span class="nc" id="L2146">		java.sql.Date toDate = null;</span>
		try {
<span class="nc" id="L2148">			Statement stmt = con.createStatement();</span>
<span class="nc" id="L2149">			String fetchUser = &quot;select count(organization_id) as retNum from st_lms_organization_master where organization_type='RETAILER'&quot;;</span>
<span class="nc" id="L2150">			ResultSet rs = stmt.executeQuery(fetchUser);</span>
<span class="nc bnc" id="L2151" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L2152">				utilMap.put(&quot;RETAILER&quot;, rs.getInt(&quot;retNum&quot;));</span>
			}
			// PreparedStatement pstmt = con.prepareStatement(&quot;select
			// ii.dg_sale_amt 'dg_sale', kk.dg_refund 'dg_sale_refund',
			// jj.dg_pwt_amt 'dg_pwt' from (( select ifnull(sum(net_amt),0)
			// 'dg_sale_amt' from st_dg_bo_sale bo, st_lms_bo_transaction_master
			// btm where btm.transaction_id=bo.transaction_id and
			// btm.transaction_type ='DG_SALE' and (
			// date(btm.transaction_date)&gt;=? and
			// date(btm.transaction_date)&lt;?))ii, (select ifnull(sum(net_amt),0)
			// as 'dg_refund' from st_dg_bo_sale_refund bo,
			// st_lms_bo_transaction_master btm where
			// btm.transaction_id=bo.transaction_id and btm.transaction_type =
			// 'DG_REFUND_CANCEL' and ( date(btm.transaction_date)&gt;=? and
			// date(btm.transaction_date)&lt;?))kk,(select ifnull(sum(pwt_amt),0)
			// 'dg_pwt_amt' from st_dg_bo_pwt bo, st_lms_bo_transaction_master
			// btm where btm.transaction_id=bo.transaction_id and
			// (btm.transaction_type ='DG_PWT' or btm.transaction_type
			// ='DG_PWT_AUTO') and ( date(btm.transaction_date)&gt;=? and
			// date(btm.transaction_date)&lt;?))jj)&quot;);
<span class="nc" id="L2172">			PreparedStatement pstmt = con</span>
					.prepareStatement(&quot;select ii.dg_sale_amt 'dg_sale', kk.dg_refund 'dg_sale_refund', jj.dg_pwt_amt 'dg_pwt', mm.dp_pwt_bo_amt 'dg_dp_bo_pwt',nn.dp_pwt_agt_amt 'dg_dp_agt_pwt' from (( select ifnull(sum(net_amt),0) 'dg_sale_amt'  from st_dg_bo_sale bo, st_lms_bo_transaction_master btm where btm.transaction_id=bo.transaction_id and btm.transaction_type ='DG_SALE' and ( date(btm.transaction_date)&gt;=? and date(btm.transaction_date)&lt;?))ii, (select ifnull(sum(net_amt),0) as 'dg_refund' from st_dg_bo_sale_refund bo, st_lms_bo_transaction_master btm where btm.transaction_id=bo.transaction_id and btm.transaction_type in('DG_REFUND_CANCEL','DG_REFUND_FAILED') and ( date(btm.transaction_date)&gt;=? and date(btm.transaction_date)&lt;?))kk,(select ifnull(sum(pwt_amt),0) 'dg_pwt_amt'  from st_dg_bo_pwt bo, st_lms_bo_transaction_master btm where btm.transaction_id=bo.transaction_id and (btm.transaction_type ='DG_PWT' or btm.transaction_type ='DG_PWT_AUTO') and ( date(btm.transaction_date)&gt;=? and date(btm.transaction_date)&lt;?))jj, (select ifnull(sum(pwt_amt),0) 'dp_pwt_bo_amt' from st_dg_bo_direct_plr_pwt bo, st_lms_bo_transaction_master btm where btm.transaction_id=bo.transaction_id and (btm.transaction_type ='DG_PWT_PLR') and ( date(btm.transaction_date)&gt;=? and date(btm.transaction_date)&lt;?))mm, (select ifnull(sum(pwt_amt),0) 'dp_pwt_agt_amt' from st_dg_agt_direct_plr_pwt bo, st_lms_agent_transaction_master btm where btm.transaction_id=bo.transaction_id and (btm.transaction_type ='DG_PWT_PLR') and ( date(btm.transaction_date)&gt;=? and date(btm.transaction_date)&lt;?))nn)&quot;);
<span class="nc bnc" id="L2174" title="All 2 branches missed.">			for (int i = 0; i &lt; 7; i++) {</span>
<span class="nc" id="L2175">				cal.add(Calendar.DAY_OF_YEAR, -1);</span>
<span class="nc" id="L2176">				System.out.println(&quot;**********&quot; + cal.getTime());</span>
<span class="nc" id="L2177">				fromDate = new java.sql.Date(cal.getTimeInMillis());</span>
<span class="nc" id="L2178">				toDate = new java.sql.Date(cal.getTimeInMillis() + 24 * 60 * 60</span>
						* 1000);
<span class="nc" id="L2180">				pstmt.setDate(1, fromDate);</span>
<span class="nc" id="L2181">				pstmt.setDate(2, toDate);</span>
<span class="nc" id="L2182">				pstmt.setDate(3, fromDate);</span>
<span class="nc" id="L2183">				pstmt.setDate(4, toDate);</span>
<span class="nc" id="L2184">				pstmt.setDate(5, fromDate);</span>
<span class="nc" id="L2185">				pstmt.setDate(6, toDate);</span>
<span class="nc" id="L2186">				pstmt.setDate(7, fromDate);</span>
<span class="nc" id="L2187">				pstmt.setDate(8, toDate);</span>
<span class="nc" id="L2188">				pstmt.setDate(9, fromDate);</span>
<span class="nc" id="L2189">				pstmt.setDate(10, toDate);</span>
<span class="nc" id="L2190">				System.out.println(&quot;weeklyReport*******&quot; + pstmt);</span>
<span class="nc" id="L2191">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L2192" title="All 2 branches missed.">				if (rs.next()) {</span>
<span class="nc" id="L2193">					DailyLedgerBean dlbean = new DailyLedgerBean();</span>
<span class="nc" id="L2194">					dlbean.setDate(fromDate.toString());</span>
<span class="nc" id="L2195">					dlbean.setNetPwt(rs.getDouble(&quot;dg_pwt&quot;)</span>
							+ rs.getDouble(&quot;dg_dp_bo_pwt&quot;) + &quot;&quot;);
<span class="nc" id="L2197">					dlbean.setNetsale(rs.getString(&quot;dg_sale&quot;));</span>
<span class="nc" id="L2198">					dlbean.setNetSaleRefund(rs.getString(&quot;dg_sale_refund&quot;));</span>
<span class="nc" id="L2199">					dlbean.setNetsale(rs.getDouble(&quot;dg_sale&quot;)</span>
							- rs.getDouble(&quot;dg_sale_refund&quot;) + &quot;&quot;);
<span class="nc" id="L2201">					weeklyReport.add(dlbean);</span>
				}
			}
<span class="nc" id="L2204">			utilMap.put(&quot;REPORT&quot;, weeklyReport);</span>
<span class="nc" id="L2205">		} catch (Exception e) {</span>
<span class="nc" id="L2206">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L2208">			try {</span>
<span class="nc" id="L2209">				con.close();</span>
<span class="nc" id="L2210">			} catch (SQLException e) {</span>
				// TODO Auto-generated catch block
<span class="nc" id="L2212">				e.printStackTrace();</span>
<span class="nc" id="L2213">			}</span>
<span class="nc" id="L2214">		}</span>
<span class="nc" id="L2215">		return utilMap;</span>
	}
	
	public Map&lt;String, LinkedHashMap&lt;String, DrawDetailsBean&gt;&gt; fetchWinningResultDateWise(String fromDate, String toDate) throws Exception{
<span class="nc" id="L2219">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L2220">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L2221">		sReq.setServiceName(ServiceName.REPORTS_MGMT);</span>
<span class="nc" id="L2222">		sReq.setServiceMethod(ServiceMethodName.FETCH_WINNING_RESULT_DATE_WISE);</span>
<span class="nc" id="L2223">		boolean isMachineEnabled = LMSFilterDispatcher.isMachineEnabled;</span>
<span class="nc bnc" id="L2224" title="All 2 branches missed.">		if(toDate != null){</span>
<span class="nc" id="L2225">			sReq.setServiceData(isMachineEnabled + &quot;|&quot; + fromDate + &quot;|&quot; + toDate);</span>
		} else {
<span class="nc" id="L2227">			sReq.setServiceData(isMachineEnabled + &quot;|&quot; + fromDate);</span>
		}
<span class="nc" id="L2229">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L2230">		sRes = delegate.getResponse(sReq);</span>
		
<span class="nc" id="L2232">		Type type = new TypeToken&lt;Map&lt;String, LinkedHashMap&lt;String, DrawDetailsBean&gt;&gt;&gt;(){}.getType();</span>
		
<span class="nc" id="L2234">		return (Map&lt;String, LinkedHashMap&lt;String, DrawDetailsBean&gt;&gt;)new Gson().fromJson((JsonElement)sRes.getResponseData(), type);</span>
		
//		return (Map)sRes.getResponseData();
	}
	
	public boolean cancelRaffleTicket(CancelTicketBean cancelTicketBean,
			UserInfoBean retUserBean, String cancellationCharges,
			Connection con, int boUserId, String search_type) throws Exception {
<span class="nc" id="L2242">		int barCodeCount =-1;</span>
<span class="nc" id="L2243">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L2244">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L2245">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L2246">		List&lt;String&gt; promoTicketList = cancelTicketBean.getPromoTicketList();</span>
<span class="nc bnc" id="L2247" title="All 2 branches missed.">		if (cancelTicketBean.getTicketNo().length() == com.skilrock.lms.common.ConfigurationVariables.barcodeCount) </span>
<span class="nc" id="L2248">			barCodeCount = Integer.parseInt(Util.getBarCodeCountFromTicketNumber(cancelTicketBean.getTicketNo()));</span>
<span class="nc" id="L2249">		cancelTicketBean.setBarCodeCount(barCodeCount);</span>
<span class="nc" id="L2250">		int rafleGmeNo = getGamenoFromTktnumber(promoTicketList.get(0) + &quot;0&quot;);</span>
		// here cancel raffle ticket
<span class="nc" id="L2252">		long refTransid = orgOnLineSaleCreditUpdation.drawRaffleTicketCancel(</span>
				retUserBean, con, cancellationCharges, promoTicketList.get(0),
				rafleGmeNo);
<span class="nc" id="L2255">		cancelTicketBean.setRefTransId(refTransid + &quot;&quot;);</span>
<span class="nc" id="L2256">		cancelTicketBean.setTicketNo(promoTicketList.get(0) + &quot;0&quot;);</span>
<span class="nc" id="L2257">		cancelTicketBean.setGameId(rafleGmeNo);</span>
<span class="nc bnc" id="L2258" title="All 2 branches missed.">		if (refTransid &gt; 0) {</span>
<span class="nc" id="L2259">			sRes = new ServiceResponse();</span>
<span class="nc" id="L2260">			sReq = new ServiceRequest();</span>
<span class="nc" id="L2261">			sReq.setServiceName(ServiceName.RAFFLE);</span>
<span class="nc" id="L2262">			sReq.setServiceMethod(ServiceMethodName.RAFFLE_CANCEL_TICKET);</span>
<span class="nc" id="L2263">			sReq.setServiceData(cancelTicketBean);</span>
<span class="nc" id="L2264">			sRes = delegate.getResponse(sReq);</span>
<span class="nc bnc" id="L2265" title="All 2 branches missed.">			if (sRes.getIsSuccess()) {</span>
<span class="nc bnc" id="L2266" title="All 2 branches missed.">				if (cancelTicketBean.isValid()) {</span>
<span class="nc" id="L2267">					logger.info(&quot;---draw game ticket successfully cancelled at BO end&quot;);</span>
<span class="nc" id="L2268">					String insQry = &quot;insert into st_dg_bo_ticket_cancel(ret_trans_id, user_id, retailer_org_id,  game_no, ticket_no, cancel_type, ticket_amt) values (?,?,?,?,?,?,?)&quot;;</span>
<span class="nc" id="L2269">					PreparedStatement pstmt = con.prepareStatement(insQry);</span>
<span class="nc" id="L2270">					pstmt.setInt(1, Integer.parseInt(cancelTicketBean</span>
							.getRefTransId()));
<span class="nc" id="L2272">					pstmt.setInt(2, boUserId);</span>
<span class="nc" id="L2273">					pstmt.setInt(3, retUserBean.getUserId());</span>
<span class="nc" id="L2274">					pstmt.setInt(4, rafleGmeNo);</span>
<span class="nc" id="L2275">					pstmt.setString(5, cancelTicketBean.getTicketNo());</span>

<span class="nc bnc" id="L2277" title="All 2 branches missed.">					pstmt.setString(6,</span>
							search_type.equals(&quot;Enter_Ticket&quot;) ? &quot;BY_NUMBER&quot;
									: &quot;BY_TRANSACTION&quot;);
<span class="nc" id="L2280">					pstmt.setDouble(7, cancelTicketBean.getRefundAmount());</span>
<span class="nc" id="L2281">					int noOfRowsInserted = pstmt.executeUpdate();</span>
<span class="nc bnc" id="L2282" title="All 2 branches missed.">					if (noOfRowsInserted &lt;= 0) {</span>
<span class="nc" id="L2283">						throw new LMSException(</span>
								findDefaultText(&quot;error.insert.not.done.tkt.cancel.at.bo.tkt.cancel.table&quot;, locale));

					}
<span class="nc" id="L2287">					cancelTicketBean.setErrMsg(findDefaultText(&quot;msg.tkt.cancel.success&quot;, locale));</span>
					
<span class="nc" id="L2289">				} else {</span>
<span class="nc" id="L2290">					System.out</span>
							.println(&quot;---draw game ticket not cancelled at BO end&quot;);

<span class="nc" id="L2293">					cancelTicketBean</span>
							.setErrMsg(findDefaultText(&quot;error.tkt.cannt.cancel.invalid.tkt&quot;, locale));
				}
				
<span class="nc" id="L2297">				return true;</span>
			} else {
<span class="nc" id="L2299">				cancelTicketBean</span>
				.setErrMsg(findDefaultText(&quot;error.tkt.cannt.cancel&quot;, locale));
<span class="nc" id="L2301">				cancelTicketBean.setValid(false);</span>
<span class="nc" id="L2302">				return false;</span>
			}
		} else {
<span class="nc" id="L2305">			return false;</span>
		}
	}

	public boolean cancelStdTkt(UserInfoBean retUserBean,
			CancelTicketBean cancelTicketBean, Connection con,
			String cancellationCharges, int boUserId, String search_type) throws Exception {

<span class="nc" id="L2313">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L2314">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L2315">		sReq.setServiceName(ServiceName.PLAYGAME);</span>
<span class="nc" id="L2316">		sReq.setServiceMethod(ServiceMethodName.DRAWGAME_CANCEL_TICKET);</span>
<span class="nc" id="L2317">		sReq.setServiceData(cancelTicketBean);</span>
<span class="nc" id="L2318">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>

<span class="nc" id="L2320">		boolean isFraud = ResponsibleGaming.respGaming(retUserBean, &quot;DG_CANCEL&quot;,&quot;1&quot;, con);</span>
<span class="nc bnc" id="L2321" title="All 2 branches missed.">		if (!isFraud) {</span>
			
<span class="nc" id="L2323">			double tickRefundAmt = orgOnLineSaleCreditUpdation.drawTicketCancel(</span>
					retUserBean, cancelTicketBean, con, cancellationCharges);
<span class="nc" id="L2325">			logger.debug(tickRefundAmt + &quot;*tickRefundAmt&quot;);</span>
			
<span class="nc bnc" id="L2327" title="All 4 branches missed.">			if(cancelTicketBean.isPromo() == true &amp;&amp; tickRefundAmt == 0)</span>
			{
<span class="nc" id="L2329">				cancelTicketBean.setValid(false);</span>
<span class="nc" id="L2330">				cancelTicketBean.setErrMsg(findDefaultText(&quot;err.promo.tkt.no.cancel&quot;, locale));</span>
<span class="nc" id="L2331">				return false;</span>
			}
			
<span class="nc bnc" id="L2334" title="All 2 branches missed.">			if (tickRefundAmt &gt;= 0) {</span>

<span class="nc" id="L2336">				cancelTicketBean.setTicketNo(cancelTicketBean.getTicketNo()</span>
						+ cancelTicketBean.getReprintCount());
<span class="nc" id="L2338">				sRes = delegate.getResponse(sReq);</span>
<span class="nc" id="L2339">				String responseString = sRes.getResponseData().toString();</span>
<span class="nc" id="L2340">				Type elementType = new TypeToken&lt;CancelTicketBean&gt;() {}.getType();</span>
<span class="nc bnc" id="L2341" title="All 2 branches missed.">				if (sRes.getIsSuccess()) {</span>
<span class="nc" id="L2342">					logger.debug(&quot;*Inside Cancel Ticket Success&quot;);</span>
<span class="nc" id="L2343">					cancelTicketBean.setRefundAmount(tickRefundAmt);</span>
<span class="nc" id="L2344">					CancelTicketBean cancelTicketBean1 = new Gson().fromJson(responseString, elementType);				</span>
<span class="nc" id="L2345">					cancelTicketBean.setCancelTime(cancelTicketBean1.getCancelTime());					</span>
					
<span class="nc bnc" id="L2347" title="All 2 branches missed.">					if (cancelTicketBean.isValid()) {</span>

<span class="nc" id="L2349">						logger.debug(&quot;---draw game ticket successfully cancelled at BO end&quot;);</span>
<span class="nc" id="L2350">						String insQry = &quot;insert into st_dg_bo_ticket_cancel(ret_trans_id, user_id, retailer_org_id,  game_no, ticket_no, cancel_type, ticket_amt, reason) values (?,?,?,?,?,?,?,?)&quot;;</span>
<span class="nc" id="L2351">						PreparedStatement pstmt = con.prepareStatement(insQry);</span>
<span class="nc" id="L2352">						pstmt.setLong(1, Long.parseLong(cancelTicketBean</span>
								.getRefTransId()));
<span class="nc" id="L2354">						pstmt.setInt(2, boUserId);</span>
<span class="nc" id="L2355">						pstmt.setInt(3, retUserBean.getUserId());</span>
<span class="nc" id="L2356">						pstmt.setInt(4, cancelTicketBean.getGameId());</span>
<span class="nc" id="L2357">						pstmt.setString(5, cancelTicketBean.getTicketNo());</span>

<span class="nc bnc" id="L2359" title="All 2 branches missed.">						pstmt.setString(6,</span>
								search_type.equals(&quot;Enter_Ticket&quot;) ? &quot;BY_NUMBER&quot;
										: &quot;BY_TRANSACTION&quot;);
<span class="nc" id="L2362">						pstmt.setDouble(7, cancelTicketBean.getRefundAmount());</span>
<span class="nc" id="L2363">						pstmt.setString(8, cancelTicketBean.getReason());</span>
<span class="nc" id="L2364">						int noOfRowsInserted = pstmt.executeUpdate();</span>
<span class="nc bnc" id="L2365" title="All 2 branches missed.">						if (noOfRowsInserted &lt;= 0) {</span>
<span class="nc" id="L2366">							throw new LMSException(</span>
									findDefaultText(&quot;error.insert.not.done.tkt.cancel.at.bo.tkt.cancel.table&quot;, locale));

						}
<span class="nc" id="L2370">						cancelTicketBean.setErrMsg(findDefaultText(&quot;msg.tkt.cancel.success&quot;, locale));</span>
						
<span class="nc" id="L2372">					} else {</span>
<span class="nc" id="L2373">						logger.debug(&quot;---draw game ticket not cancelled at BO end&quot;);</span>

<span class="nc" id="L2375">						cancelTicketBean</span>
								.setErrMsg(findDefaultText(&quot;error.tkt.cannt.cancel.invalid.tkt&quot;, locale));
					}
					
					
					
<span class="nc" id="L2381">					return true;</span>
				} else {
<span class="nc" id="L2383">					cancelTicketBean.setErrMsg(((CancelTicketBean)new Gson().fromJson(responseString, elementType)).getErrMsg());</span>
<span class="nc" id="L2384">					return false;</span>
				}

			} else {
<span class="nc" id="L2388">				cancelTicketBean.setValid(false);</span>
<span class="nc" id="L2389">				cancelTicketBean.setErrMsg(findDefaultText(&quot;error.tkt.already.cancel.or.claim&quot;, locale));</span>
<span class="nc" id="L2390">				return false;</span>
			}
		}else {
<span class="nc" id="L2393">			cancelTicketBean.setValid(false);</span>
<span class="nc" id="L2394">			cancelTicketBean.setError(true);</span>
<span class="nc" id="L2395">			cancelTicketBean.setErrMsg(findDefaultText(&quot;error.cancel.tkt.limit.exceed&quot;, locale));</span>
<span class="nc" id="L2396">			return false;</span>
			
		}
		
		
	}
	
	public int getGamenoFromTktnumber(String tktNum) {

<span class="nc" id="L2405">		int retIdLen = 0;</span>
<span class="nc" id="L2406">		int gameNo = 0;</span>
<span class="nc" id="L2407">		int tktLen = 0;</span>
<span class="nc" id="L2408">		String tktBuf = null;</span>

<span class="nc bnc" id="L2410" title="All 6 branches missed.">		if (tktNum != null</span>
				&amp;&amp; (tktNum.length() == ConfigurationVariables.tktLenA || tktNum
						.length() == ConfigurationVariables.tktLenB)) {
<span class="nc bnc" id="L2413" title="All 2 branches missed.">			if (tktNum.length() == ConfigurationVariables.tktLenA) {</span>
<span class="nc" id="L2414">				tktLen = ConfigurationVariables.tktLenA;</span>
<span class="nc" id="L2415">				retIdLen = ConfigurationVariables.retIdLenA;</span>
<span class="nc" id="L2416">				tktBuf = tktNum.substring(retIdLen, retIdLen</span>
						+ ConfigurationVariables.gameNoLenA);
<span class="nc bnc" id="L2418" title="All 2 branches missed.">			} else if (tktNum.length() == ConfigurationVariables.tktLenB) {</span>
<span class="nc" id="L2419">				tktLen = ConfigurationVariables.tktLenB;</span>
<span class="nc" id="L2420">				retIdLen = ConfigurationVariables.retIdLenB;</span>
<span class="nc" id="L2421">				tktBuf = tktNum.substring(retIdLen, retIdLen</span>
						+ ConfigurationVariables.gameNoLenB);
			}
<span class="nc" id="L2424">			gameNo = Integer.parseInt(tktBuf);</span>
		}
<span class="nc" id="L2426">		return gameNo;</span>

	}
	
	public boolean validateTktForRelativeRetailer(String tktNo, int agtUserId){
<span class="nc bnc" id="L2431" title="All 2 branches missed.">		if(tktNo != null){</span>
<span class="nc" id="L2432">			Connection con = DBConnect.getConnection();</span>
			try{
<span class="nc" id="L2434">				int retUserId = 0;</span>
<span class="nc bnc" id="L2435" title="All 2 branches missed.">				if(tktNo.length() == ConfigurationVariables.tktLenA){</span>
<span class="nc" id="L2436">					retUserId = Integer.parseInt(tktNo.substring(0, ConfigurationVariables.retIdLenA));</span>
<span class="nc bnc" id="L2437" title="All 2 branches missed.">				} else if(tktNo.length() == ConfigurationVariables.tktLenB){</span>
<span class="nc" id="L2438">					retUserId = Integer.parseInt(tktNo.substring(0, ConfigurationVariables.retIdLenB));</span>
				} else {
<span class="nc" id="L2440">					return false;</span>
				}
<span class="nc" id="L2442">				PreparedStatement pstmt = con.prepareStatement(&quot;SELECT user_id FROM st_lms_user_master WHERE organization_type = 'RETAILER' AND user_id = ? AND parent_user_id = ?&quot;);</span>
<span class="nc" id="L2443">				pstmt.setInt(1, retUserId);</span>
<span class="nc" id="L2444">				pstmt.setInt(2, agtUserId);</span>
<span class="nc" id="L2445">				logger.debug(&quot;**query***&quot;+pstmt+&quot;**&quot;);</span>
<span class="nc" id="L2446">				ResultSet rs = pstmt.executeQuery();</span>
				
<span class="nc bnc" id="L2448" title="All 2 branches missed.">				if(rs.next()){</span>
<span class="nc" id="L2449">					return true;</span>
				}
<span class="nc" id="L2451">			} catch(Exception ex){</span>
<span class="nc" id="L2452">				ex.printStackTrace();</span>
<span class="nc" id="L2453">				logger.debug(ex);</span>
			} finally{
<span class="nc" id="L2455">				try {</span>
<span class="nc bnc" id="L2456" title="All 20 branches missed.">					if(con != null &amp;&amp; !con.isClosed()){</span>
<span class="nc" id="L2457">						DBConnect.closeCon(con);</span>
					}
<span class="nc" id="L2459">				} catch (SQLException e) {</span>
<span class="nc" id="L2460">					e.printStackTrace();</span>
<span class="nc" id="L2461">				}</span>
<span class="nc" id="L2462">			}</span>
		}
<span class="nc" id="L2464">		return false;</span>
	}
	
	public static boolean validateResultData(ManualWinningBean mwBean){
<span class="nc" id="L2468">		String gameName = Util.getGameName(mwBean.getGameId());</span>
<span class="nc bnc" id="L2469" title="All 8 branches missed.">		String fmlyType = (mwBean.getGameId() == 6 || mwBean.getGameId() == 7 || &quot;MiniRoulette&quot;.equalsIgnoreCase(gameName) || &quot;FullRoulette&quot;.equalsIgnoreCase(gameName)) ? &quot;Fortune&quot; : Util.getGameType(mwBean.getGameId());</span>
	
<span class="nc bnc" id="L2471" title="All 2 branches missed.">		if(fmlyType != null){</span>
<span class="nc bnc" id="L2472" title="All 2 branches missed.">				if(&quot;Fortune&quot;.equalsIgnoreCase(fmlyType)){</span>
<span class="nc" id="L2473">					return fortuneFmlyValidateData(mwBean);</span>
<span class="nc bnc" id="L2474" title="All 2 branches missed.">				} else if(&quot;Lotto&quot;.equalsIgnoreCase(fmlyType)){</span>
<span class="nc" id="L2475">					return lottoFmlyValidateData(mwBean);</span>
<span class="nc bnc" id="L2476" title="All 2 branches missed.">				} else if(&quot;Keno&quot;.equalsIgnoreCase(fmlyType)){</span>
<span class="nc" id="L2477">					return kenoFmlyValidateData(mwBean);</span>
<span class="nc bnc" id="L2478" title="All 2 branches missed.">				} else if(&quot;ForTuneTwo&quot;.equalsIgnoreCase(fmlyType)){</span>
<span class="nc" id="L2479">					return fortuneTwoFmlyValidateData(mwBean);</span>
<span class="nc bnc" id="L2480" title="All 2 branches missed.">				}else if(&quot;FourDigit&quot;.equalsIgnoreCase(fmlyType)){</span>
<span class="nc" id="L2481">					return fourDigitValidateData(mwBean);</span>
<span class="nc bnc" id="L2482" title="All 2 branches missed.">				} else if(&quot;Rainbow&quot;.equalsIgnoreCase(fmlyType)){</span>
<span class="nc" id="L2483">					return rainbowValidateData(mwBean);</span>
				}
			
		} else {
<span class="nc" id="L2487">			return false;</span>
		}
<span class="nc" id="L2489">		return true;</span>
	}
	
	public static boolean fortuneFmlyValidateData(ManualWinningBean mwBean){
<span class="nc" id="L2493">		String gameName = Util.getGameName(mwBean.getGameId());</span>
<span class="nc bnc" id="L2494" title="All 2 branches missed.">		if(gameName != null){</span>
<span class="nc" id="L2495">			int startRange = 0;</span>
<span class="nc" id="L2496">			int endRange = 0;</span>
<span class="nc" id="L2497">			boolean isDuplicate = false;</span>
			
<span class="nc bnc" id="L2499" title="All 2 branches missed.">			if(&quot;Fortune&quot;.equalsIgnoreCase(gameName)){</span>
<span class="nc" id="L2500">				startRange = 1;</span>
<span class="nc" id="L2501">				endRange = 12;</span>
<span class="nc" id="L2502">				isDuplicate = true;</span>
<span class="nc bnc" id="L2503" title="All 2 branches missed.">			} else if(&quot;Card12&quot;.equalsIgnoreCase(gameName)){</span>
<span class="nc" id="L2504">				startRange = 1;</span>
<span class="nc" id="L2505">				endRange = 12;</span>
<span class="nc" id="L2506">				isDuplicate = true;</span>
<span class="nc bnc" id="L2507" title="All 2 branches missed.">			} else if(&quot;Card16&quot;.equalsIgnoreCase(gameName)){</span>
<span class="nc" id="L2508">				startRange = 1;</span>
<span class="nc" id="L2509">				endRange = 16;</span>
<span class="nc" id="L2510">				isDuplicate = true;</span>
<span class="nc bnc" id="L2511" title="All 2 branches missed.">			} else if(&quot;Zerotonine&quot;.equalsIgnoreCase(gameName)){</span>
<span class="nc" id="L2512">				startRange = 1;</span>
<span class="nc" id="L2513">				endRange = 10;</span>
<span class="nc" id="L2514">				isDuplicate = true;</span>
<span class="nc bnc" id="L2515" title="All 2 branches missed.">			} else if(&quot;OneToTwelve&quot;.equalsIgnoreCase(gameName)){</span>
<span class="nc" id="L2516">				startRange = 1;</span>
<span class="nc" id="L2517">				endRange = 12;</span>
<span class="nc" id="L2518">				isDuplicate = true;</span>
<span class="nc bnc" id="L2519" title="All 2 branches missed.">			}else if(&quot;MiniRoulette&quot;.equalsIgnoreCase(gameName)){</span>
<span class="nc" id="L2520">				startRange = 0;</span>
<span class="nc" id="L2521">				endRange = 13;</span>
<span class="nc" id="L2522">				isDuplicate = true;</span>
<span class="nc bnc" id="L2523" title="All 2 branches missed.">			}else if(&quot;FullRoulette&quot;.equalsIgnoreCase(gameName)){</span>
<span class="nc" id="L2524">				startRange = 0;</span>
<span class="nc" id="L2525">				endRange = 37;</span>
<span class="nc" id="L2526">				isDuplicate = true;</span>
			} else {
<span class="nc" id="L2528">				System.out.println(&quot;Fortune Family Result Data Validation: invalid game name&quot;);</span>
<span class="nc" id="L2529">				return false;</span>
			}
			
<span class="nc" id="L2532">			int[] cardType = mwBean.getCardType();</span>
<span class="nc" id="L2533">			StringBuilder data = new StringBuilder(&quot;&quot;);</span>
<span class="nc bnc" id="L2534" title="All 2 branches missed.">			for (int i = 0; i &lt; cardType.length; i++) {</span>
<span class="nc" id="L2535">				data.append(cardType[i] + &quot;,&quot;);</span>
			}
<span class="nc bnc" id="L2537" title="All 2 branches missed.">			if(data.length() &gt; 0){</span>
<span class="nc" id="L2538">				data.deleteCharAt(data.length() - 1);</span>
			}
			
<span class="nc" id="L2541">			System.out.println(&quot;Result Data Validation: data:&quot; + data.toString());</span>
<span class="nc bnc" id="L2542" title="All 2 branches missed.">			if(!Util.validateNumber(startRange, endRange, data.toString(), isDuplicate)){</span>
<span class="nc" id="L2543">				System.out.println(&quot;Fortune Family Result Data Validation: invalid result data&quot;);</span>
<span class="nc" id="L2544">				return false;</span>
			}
<span class="nc" id="L2546">		} else{</span>
<span class="nc" id="L2547">			System.out.println(&quot;Fortune Family Result Data Validation: game name is null&quot;);</span>
<span class="nc" id="L2548">			return false;</span>
		}
<span class="nc" id="L2550">		return true;</span>
	}
	
	public static boolean lottoFmlyValidateData(ManualWinningBean mwBean){
<span class="nc" id="L2554">		String gameName = Util.getGameName(mwBean.getGameId());</span>
<span class="nc bnc" id="L2555" title="All 2 branches missed.">		if(gameName != null){</span>
<span class="nc" id="L2556">			int startRange = 0;</span>
<span class="nc" id="L2557">			int endRange = 0;</span>
<span class="nc" id="L2558">			boolean isDuplicate = false;</span>
			
<span class="nc bnc" id="L2560" title="All 2 branches missed.">			if(&quot;Lotto&quot;.equalsIgnoreCase(gameName)){</span>
<span class="nc" id="L2561">				startRange = LottoConstants.START_RANGE;</span>
<span class="nc" id="L2562">				endRange = LottoConstants.END_RANGE;</span>
<span class="nc" id="L2563">				isDuplicate = LottoConstants.IS_DUPLICATE;</span>
<span class="nc bnc" id="L2564" title="All 2 branches missed.">			} else if(&quot;Zimlotto&quot;.equalsIgnoreCase(gameName)){</span>
<span class="nc" id="L2565">				startRange = ZimlottoConstants.START_RANGE;</span>
<span class="nc" id="L2566">				endRange = ZimlottoConstants.END_RANGE;</span>
<span class="nc" id="L2567">				isDuplicate = ZimlottoConstants.IS_DUPLICATE;</span>
<span class="nc bnc" id="L2568" title="All 2 branches missed.">			} else if(&quot;ZimlottoTwo&quot;.equalsIgnoreCase(gameName)){</span>
<span class="nc" id="L2569">				startRange = ZimlottotwoConstants.START_RANGE;</span>
<span class="nc" id="L2570">				endRange = ZimlottotwoConstants.END_RANGE;</span>
<span class="nc" id="L2571">				isDuplicate = ZimlottotwoConstants.IS_DUPLICATE;</span>
<span class="nc bnc" id="L2572" title="All 2 branches missed.">			} else if(&quot;ZimLottoBonus&quot;.equalsIgnoreCase(gameName)){</span>
<span class="nc" id="L2573">				startRange = ZimLottoBonusConstants.START_RANGE;</span>
<span class="nc" id="L2574">				endRange = ZimLottoBonusConstants.END_RANGE;</span>
<span class="nc" id="L2575">				isDuplicate = ZimLottoBonusConstants.IS_DUPLICATE;</span>
<span class="nc bnc" id="L2576" title="All 2 branches missed.">			} else if(&quot;ZimLottoBonusFree&quot;.equalsIgnoreCase(gameName)){</span>
<span class="nc" id="L2577">				startRange = ZimLottoBonusFreeConstants.START_RANGE;</span>
<span class="nc" id="L2578">				endRange = ZimLottoBonusFreeConstants.END_RANGE;</span>
<span class="nc" id="L2579">				isDuplicate = ZimLottoBonusFreeConstants.IS_DUPLICATE;</span>
<span class="nc bnc" id="L2580" title="All 2 branches missed.">			}else if(&quot;ZimLottoBonusTwo&quot;.equalsIgnoreCase(gameName)){</span>
<span class="nc" id="L2581">				startRange = ZimLottoBonusTwoConstants.START_RANGE;</span>
<span class="nc" id="L2582">				endRange = ZimLottoBonusTwoConstants.END_RANGE;</span>
<span class="nc" id="L2583">				isDuplicate = ZimLottoBonusTwoConstants.IS_DUPLICATE;</span>
<span class="nc bnc" id="L2584" title="All 2 branches missed.">			} else if(&quot;ZimLottoBonusTwoFree&quot;.equalsIgnoreCase(gameName)){</span>
<span class="nc" id="L2585">				startRange = ZimLottoBonusTwoFreeConstants.START_RANGE;</span>
<span class="nc" id="L2586">				endRange = ZimLottoBonusTwoFreeConstants.END_RANGE;</span>
<span class="nc" id="L2587">				isDuplicate = ZimLottoBonusTwoFreeConstants.IS_DUPLICATE;</span>
<span class="nc bnc" id="L2588" title="All 2 branches missed.">			}else if(&quot;ZimlottoThree&quot;.equalsIgnoreCase(gameName)){</span>
<span class="nc" id="L2589">				startRange = ZimlottothreeConstants.START_RANGE;</span>
<span class="nc" id="L2590">				endRange = ZimlottothreeConstants.END_RANGE;</span>
<span class="nc" id="L2591">				isDuplicate = ZimlottothreeConstants.IS_DUPLICATE;</span>
<span class="nc bnc" id="L2592" title="All 2 branches missed.">			} else if(&quot;Fastlotto&quot;.equalsIgnoreCase(gameName)){</span>
<span class="nc" id="L2593">				startRange = FastlottoConstants.START_RANGE;</span>
<span class="nc" id="L2594">				endRange = FastlottoConstants.END_RANGE;</span>
<span class="nc" id="L2595">				isDuplicate = FastlottoConstants.IS_DUPLICATE;</span>
<span class="nc bnc" id="L2596" title="All 2 branches missed.">			} else if(&quot;bonusballlotto&quot;.equalsIgnoreCase(gameName)){</span>
<span class="nc" id="L2597">				startRange = BonusBalllottoConstants.START_RANGE;</span>
<span class="nc" id="L2598">				endRange = BonusBalllottoConstants.END_RANGE;</span>
<span class="nc" id="L2599">				isDuplicate = BonusBalllottoConstants.IS_DUPLICATE;</span>
<span class="nc bnc" id="L2600" title="All 2 branches missed.">			}  else if(&quot;bonusballtwo&quot;.equalsIgnoreCase(gameName)){</span>
<span class="nc" id="L2601">				startRange = BonusBalltwoConstants.START_RANGE;</span>
<span class="nc" id="L2602">				endRange = BonusBalltwoConstants.END_RANGE;</span>
<span class="nc" id="L2603">				isDuplicate = BonusBalltwoConstants.IS_DUPLICATE;</span>
<span class="nc bnc" id="L2604" title="All 2 branches missed.">			}else if(&quot;tanzanialotto&quot;.equalsIgnoreCase(gameName)){</span>
<span class="nc" id="L2605">				startRange = TanzanialottoConstants.START_RANGE;</span>
<span class="nc" id="L2606">				endRange = TanzanialottoConstants.END_RANGE;</span>
<span class="nc" id="L2607">				isDuplicate = TanzanialottoConstants.IS_DUPLICATE;</span>
			} else {
<span class="nc" id="L2609">				System.out.println(&quot;Lotto Result Data Validation: invalid game name&quot;);</span>
<span class="nc" id="L2610">				return false;</span>
			}
			
<span class="nc bnc" id="L2613" title="All 2 branches missed.">			if(!validateRangeNdDuplicacy(mwBean, startRange, endRange, isDuplicate)){</span>
<span class="nc" id="L2614">				return false;</span>
			}
<span class="nc" id="L2616">		} else{</span>
<span class="nc" id="L2617">			System.out.println(&quot;Lotto Result Data Validation: game name is null&quot;);</span>
<span class="nc" id="L2618">			return false;</span>
		}
<span class="nc" id="L2620">		return true;</span>
	
	}
	
	public static boolean kenoFmlyValidateData(ManualWinningBean mwBean){
<span class="nc" id="L2625">		String gameName = Util.getGameName(mwBean.getGameId());</span>
<span class="nc bnc" id="L2626" title="All 2 branches missed.">		if(gameName != null){</span>
<span class="nc" id="L2627">			int startRange = 0;</span>
<span class="nc" id="L2628">			int endRange = 0;</span>
<span class="nc" id="L2629">			boolean isDuplicate = false;</span>
			
<span class="nc bnc" id="L2631" title="All 2 branches missed.">			if(&quot;KenoSix&quot;.equalsIgnoreCase(gameName)){</span>
<span class="nc" id="L2632">				startRange = KenoSixConstants.START_RANGE;</span>
<span class="nc" id="L2633">				endRange = KenoSixConstants.END_RANGE;</span>
<span class="nc" id="L2634">				isDuplicate = KenoSixConstants.IS_DUPLICATE;</span>
<span class="nc bnc" id="L2635" title="All 4 branches missed.">			}else if(&quot;Keno&quot;.equalsIgnoreCase(gameName) || &quot;KenoFive&quot;.equalsIgnoreCase(gameName)){</span>
<span class="nc" id="L2636">				startRange = KenoConstants.START_RANGE;</span>
<span class="nc" id="L2637">				endRange = KenoConstants.END_RANGE;</span>
<span class="nc" id="L2638">				isDuplicate = KenoConstants.IS_DUPLICATE;</span>
<span class="nc bnc" id="L2639" title="All 2 branches missed.">			} else if(&quot;KenoTwo&quot;.equalsIgnoreCase(gameName)){</span>
<span class="nc" id="L2640">				startRange = KenoTwoConstants.START_RANGE;</span>
<span class="nc" id="L2641">				endRange = KenoTwoConstants.END_RANGE;</span>
<span class="nc" id="L2642">				isDuplicate = KenoTwoConstants.IS_DUPLICATE;</span>
<span class="nc bnc" id="L2643" title="All 2 branches missed.">			}else if(&quot;KenoFour&quot;.equalsIgnoreCase(gameName)){</span>
<span class="nc" id="L2644">				startRange = KenoFourConstants.START_RANGE;</span>
<span class="nc" id="L2645">				endRange = KenoFourConstants.END_RANGE;</span>
<span class="nc" id="L2646">				isDuplicate = KenoFourConstants.IS_DUPLICATE;</span>
<span class="nc bnc" id="L2647" title="All 2 branches missed.">			}else if(&quot;KenoSeven&quot;.equalsIgnoreCase(gameName)){</span>
<span class="nc" id="L2648">				startRange = KenoSevenConstants.START_RANGE;</span>
<span class="nc" id="L2649">				endRange = KenoSevenConstants.END_RANGE;</span>
<span class="nc" id="L2650">				isDuplicate = KenoSevenConstants.IS_DUPLICATE;</span>
<span class="nc bnc" id="L2651" title="All 2 branches missed.">			}else if(&quot;KenoEight&quot;.equalsIgnoreCase(gameName)){</span>
<span class="nc" id="L2652">				startRange = KenoEightConstants.START_RANGE;</span>
<span class="nc" id="L2653">				endRange = KenoEightConstants.END_RANGE;</span>
<span class="nc" id="L2654">				isDuplicate = KenoEightConstants.IS_DUPLICATE;</span>
<span class="nc bnc" id="L2655" title="All 2 branches missed.">			}else if(&quot;superTwo&quot;.equalsIgnoreCase(gameName)){</span>
<span class="nc" id="L2656">				startRange = SuperTwoConstants.START_RANGE;</span>
<span class="nc" id="L2657">				endRange = SuperTwoConstants.END_RANGE;</span>
<span class="nc" id="L2658">				isDuplicate = SuperTwoConstants.IS_DUPLICATE;</span>
<span class="nc bnc" id="L2659" title="All 2 branches missed.">			} else if(&quot;TwelveByTwentyFour&quot;.equalsIgnoreCase(gameName)){</span>
<span class="nc" id="L2660">				startRange = TwelveByTwentyFourConstants.START_RANGE;</span>
<span class="nc" id="L2661">				endRange = TwelveByTwentyFourConstants.END_RANGE;</span>
<span class="nc" id="L2662">				isDuplicate = TwelveByTwentyFourConstants.IS_DUPLICATE;</span>
<span class="nc bnc" id="L2663" title="All 2 branches missed.">			} else if(&quot;TenByTwenty&quot;.equalsIgnoreCase(gameName)){</span>
<span class="nc" id="L2664">				startRange = TenByTwentyConstants.START_RANGE;</span>
<span class="nc" id="L2665">				endRange = TenByTwentyConstants.END_RANGE;</span>
<span class="nc" id="L2666">				isDuplicate = TenByTwentyConstants.IS_DUPLICATE;</span>
<span class="nc bnc" id="L2667" title="All 2 branches missed.">			}  else if(&quot;KenoNine&quot;.equalsIgnoreCase(gameName)){</span>
<span class="nc" id="L2668">				startRange = KenoNineConstants.START_RANGE;</span>
<span class="nc" id="L2669">				endRange = KenoNineConstants.END_RANGE;</span>
<span class="nc" id="L2670">				isDuplicate = KenoNineConstants.IS_DUPLICATE;</span>
			}else {
<span class="nc" id="L2672">				System.out.println(&quot;Keno Result Data Validation: invalid game name&quot;);</span>
<span class="nc" id="L2673">				return false;</span>
			}
			
<span class="nc bnc" id="L2676" title="All 2 branches missed.">			if(!validateRangeNdDuplicacy(mwBean, startRange, endRange, isDuplicate)){</span>
<span class="nc" id="L2677">				return false;</span>
			}
<span class="nc" id="L2679">		} else{</span>
<span class="nc" id="L2680">			System.out.println(&quot;Keno Result Data Validation: game name is null&quot;);</span>
<span class="nc" id="L2681">			return false;</span>
		}
<span class="nc" id="L2683">		return true;</span>
	}

	public static boolean rainbowValidateData(ManualWinningBean mwBean) {
<span class="nc" id="L2687">		String gameName = Util.getGameName(mwBean.getGameId());</span>
<span class="nc bnc" id="L2688" title="All 2 branches missed.">		if(gameName != null) {</span>
<span class="nc" id="L2689">			int startRange = 0;</span>
<span class="nc" id="L2690">			int endRange = 0;</span>
<span class="nc" id="L2691">			boolean isDuplicate = false;</span>
			
<span class="nc bnc" id="L2693" title="All 2 branches missed.">			if(&quot;RainbowGame&quot;.equalsIgnoreCase(gameName)){</span>
<span class="nc" id="L2694">				startRange = RainbowConstants.START_RANGE;</span>
<span class="nc" id="L2695">				endRange = RainbowConstants.END_RANGE;</span>
<span class="nc" id="L2696">				isDuplicate = RainbowConstants.IS_DUPLICATE;</span>
<span class="nc bnc" id="L2697" title="All 2 branches missed.">			}else if(&quot;PickFour&quot;.equalsIgnoreCase(gameName)){</span>
<span class="nc" id="L2698">				startRange = PickFourConstants.START_RANGE;</span>
<span class="nc" id="L2699">				endRange = PickFourConstants.END_RANGE;</span>
<span class="nc" id="L2700">				isDuplicate = PickFourConstants.IS_DUPLICATE;</span>
<span class="nc bnc" id="L2701" title="All 2 branches missed.">			} else if(&quot;PickThree&quot;.equalsIgnoreCase(gameName)){</span>
<span class="nc" id="L2702">				startRange = PickThreeConstants.START_RANGE;</span>
<span class="nc" id="L2703">				endRange = PickThreeConstants.END_RANGE;</span>
<span class="nc" id="L2704">				isDuplicate = PickThreeConstants.IS_DUPLICATE;</span>
			} else {
<span class="nc" id="L2706">				logger.info(&quot;Rainbow Data Validation - Invalid Game Name&quot;);</span>
<span class="nc" id="L2707">				return false;</span>
			}

<span class="nc bnc" id="L2710" title="All 2 branches missed.">			if(!validateRangeNdDuplicacy(mwBean, startRange, endRange, isDuplicate)){</span>
<span class="nc" id="L2711">				return false;</span>
			}
<span class="nc" id="L2713">		} else {</span>
<span class="nc" id="L2714">			logger.info(&quot;Rainbow Data Validation - Game Name is NULL&quot;);</span>
<span class="nc" id="L2715">			return false;</span>
		}

<span class="nc" id="L2718">		return true;</span>
	}

	public static boolean fortuneTwoFmlyValidateData(ManualWinningBean mwBean){
<span class="nc" id="L2722">		String gameName = Util.getGameName(mwBean.getGameId());</span>
<span class="nc bnc" id="L2723" title="All 2 branches missed.">		if(gameName != null){</span>
<span class="nc" id="L2724">			int startRange = 0;</span>
<span class="nc" id="L2725">			int endRange = 0;</span>
<span class="nc" id="L2726">			boolean isDuplicate = false;</span>
			
<span class="nc bnc" id="L2728" title="All 2 branches missed.">			if(&quot;FortuneTwo&quot;.equalsIgnoreCase(gameName)){</span>
<span class="nc" id="L2729">				startRange = 1;</span>
<span class="nc" id="L2730">				endRange = 12;</span>
<span class="nc" id="L2731">				isDuplicate = true;</span>
<span class="nc bnc" id="L2732" title="All 2 branches missed.">			} else if(&quot;FortuneThree&quot;.equalsIgnoreCase(gameName)){</span>
<span class="nc" id="L2733">				startRange = 1;</span>
<span class="nc" id="L2734">				endRange = 12;</span>
<span class="nc" id="L2735">				isDuplicate = true;</span>
			}
				else {
			
<span class="nc" id="L2739">				System.out.println(&quot;FortuneTwo Family Result Data Validation: invalid game name&quot;);</span>
<span class="nc" id="L2740">				return false;</span>
			}
			
<span class="nc" id="L2743">			Integer[] cardType = mwBean.getWinningNumbers();</span>
<span class="nc" id="L2744">			StringBuilder data = new StringBuilder(&quot;&quot;);</span>
<span class="nc bnc" id="L2745" title="All 2 branches missed.">			for (int i = 0; i &lt; cardType.length; i++) {</span>
<span class="nc" id="L2746">				data.append(cardType[i] + &quot;,&quot;);</span>
			}
<span class="nc bnc" id="L2748" title="All 2 branches missed.">			if(data.length() &gt; 0){</span>
<span class="nc" id="L2749">				data.deleteCharAt(data.length() - 1);</span>
			}
			
<span class="nc" id="L2752">			System.out.println(&quot;Result Data Validation: data:&quot; + data.toString());</span>
<span class="nc bnc" id="L2753" title="All 2 branches missed.">			if(!Util.validateNumber(startRange, endRange, data.toString(), isDuplicate)){</span>
<span class="nc" id="L2754">				System.out.println(&quot;FortuneTwo Family Result Data Validation: invalid result data&quot;);</span>
<span class="nc" id="L2755">				return false;</span>
			}
<span class="nc" id="L2757">		} else{</span>
<span class="nc" id="L2758">			System.out.println(&quot;FortuneTwo Family Result Data Validation: game name is null&quot;);</span>
<span class="nc" id="L2759">			return false;</span>
		}
<span class="nc" id="L2761">		return true;</span>
	}
	
	public static boolean fourDigitValidateData(ManualWinningBean mwBean){
<span class="nc" id="L2765">		String gameName = Util.getGameName(mwBean.getGameId());</span>
<span class="nc bnc" id="L2766" title="All 2 branches missed.">		if(gameName != null){</span>
<span class="nc" id="L2767">			int startRange = 0;</span>
<span class="nc" id="L2768">			int endRange = 0;</span>
<span class="nc" id="L2769">			boolean isDuplicate = false;</span>
			
<span class="nc bnc" id="L2771" title="All 2 branches missed.">			if(&quot;FourDigit&quot;.equalsIgnoreCase(gameName)){</span>
<span class="nc" id="L2772">				startRange = 0000;</span>
<span class="nc" id="L2773">				endRange = 9999;</span>
<span class="nc" id="L2774">				isDuplicate = true;</span>
			} 
			else {			
<span class="nc" id="L2777">				System.out.println(&quot;FourDigit Family Result Data Validation: invalid game name&quot;);</span>
<span class="nc" id="L2778">				return false;</span>
			}
			
<span class="nc" id="L2781">			Integer[] cardType = mwBean.getWinningNumbers();</span>
<span class="nc" id="L2782">			StringBuilder data = new StringBuilder(&quot;&quot;);</span>
<span class="nc bnc" id="L2783" title="All 2 branches missed.">			for (int i = 0; i &lt; cardType.length; i++) {</span>
<span class="nc" id="L2784">				data.append(cardType[i] + &quot;,&quot;);</span>
			}
<span class="nc bnc" id="L2786" title="All 2 branches missed.">			if(data.length() &gt; 0){</span>
<span class="nc" id="L2787">				data.deleteCharAt(data.length() - 1);</span>
			}
			
<span class="nc" id="L2790">			System.out.println(&quot;Result Data Validation: data:&quot; + data.toString());</span>
<span class="nc bnc" id="L2791" title="All 2 branches missed.">			if(!Util.validateNumber(startRange, endRange, data.toString(), isDuplicate)){</span>
<span class="nc" id="L2792">				System.out.println(&quot;FourDigit Family Result Data Validation: invalid result data&quot;);</span>
<span class="nc" id="L2793">				return false;</span>
			}
<span class="nc" id="L2795">		} else{</span>
<span class="nc" id="L2796">			System.out.println(&quot;FourDigit Family Result Data Validation: game name is null&quot;);</span>
<span class="nc" id="L2797">			return false;</span>
		}
<span class="nc" id="L2799">		return true;</span>
	}
	
	private static boolean validateRangeNdDuplicacy(ManualWinningBean mwBean, int startRange, int endRange, boolean isDuplicate) {
<span class="nc" id="L2803">		Integer[] winNumbers = mwBean.getWinningNumbers();</span>
<span class="nc" id="L2804">		int winNumSize = mwBean.getWinNumSize();</span>
<span class="nc bnc" id="L2805" title="All 4 branches missed.">		if(winNumbers.length == winNumSize || validateKenoOrKenoEight(mwBean, winNumbers)){</span>
<span class="nc" id="L2806">			StringBuilder data = null;</span>
			
<span class="nc bnc" id="L2808" title="All 2 branches missed.">			for(int i=0; i&lt;winNumbers.length/winNumSize; i++){</span>
<span class="nc" id="L2809">				data = new StringBuilder(&quot;&quot;);</span>
<span class="nc bnc" id="L2810" title="All 2 branches missed.">				for(int j=i*winNumSize; j&lt;i*winNumSize+winNumSize; j++){</span>
<span class="nc" id="L2811">					data.append(winNumbers[j] + &quot;,&quot;);</span>
				}
<span class="nc bnc" id="L2813" title="All 2 branches missed.">				if(data.length() &gt; 0){</span>
<span class="nc" id="L2814">					data.deleteCharAt(data.length()-1);</span>
				}
				
<span class="nc" id="L2817">				System.out.println(&quot;Result Data Validation: data:&quot; + data.toString());</span>
<span class="nc bnc" id="L2818" title="All 2 branches missed.">				if(!Util.validateNumber(startRange, endRange, data.toString(), isDuplicate)){</span>
<span class="nc" id="L2819">					System.out.println(&quot;Result Data Validation: invalid result data&quot;);</span>
<span class="nc" id="L2820">					return false;</span>
				}
			}
<span class="nc" id="L2823">		} else {</span>
<span class="nc" id="L2824">			System.out.println(&quot;Result Data Validation: incomplete result data&quot;);</span>
<span class="nc" id="L2825">			return false;</span>
		}
<span class="nc" id="L2827">		return true;</span>
	}


	static boolean validateKenoOrKenoEight(ManualWinningBean mwBean, Integer[] winNumbers) {
<span class="nc" id="L2832">		boolean isValid=false;</span>
<span class="nc bnc" id="L2833" title="All 4 branches missed.">		if( &quot;Keno&quot;.equalsIgnoreCase(Util.getGameName(mwBean.getGameId())) || &quot;KenoEight&quot;.equalsIgnoreCase(Util.getGameName(mwBean.getGameId()))){</span>
<span class="nc bnc" id="L2834" title="All 4 branches missed.">			isValid = (winNumbers.length == 5 || winNumbers.length == 6); </span>
<span class="nc" id="L2835">			mwBean.setWinNumSize(mwBean.getWinNumSize());</span>
			
		}
<span class="nc" id="L2838">		return isValid;</span>
	}
	
	/*public Map&lt;Integer,String&gt; fetchServices(){
		Map&lt;Integer, String&gt; serviceMap = new HashMap&lt;Integer, String&gt;();
		Connection con = DBConnect.getConnection();
		try{
			PreparedStatement pstmt = con.prepareStatement(&quot;select service_id, service_display_name from st_lms_service_master where status='ACTIVE' and service_display_name &lt;&gt; 'HOME' AND service_display_name &lt;&gt; 'SCRATCH'&quot;);
			System.out.println(&quot;Service Query:&quot; + pstmt + &quot;***&quot;);
			ResultSet rs = pstmt.executeQuery();
			while (rs.next()) {
				int servId = rs.getInt(&quot;service_id&quot;);
				String servDispName = rs.getString(&quot;service_display_name&quot;);
				serviceMap.put(servId, servDispName);
			}
		} catch(SQLException se){
			se.printStackTrace();
		} finally{
			DBConnect.closeCon(con);
		}
		return serviceMap;
	}*/
	
	public Map&lt;String,String&gt; fetchServices(){
<span class="nc" id="L2862">		Map&lt;String, String&gt; serviceMap = new HashMap&lt;String, String&gt;();</span>
<span class="nc" id="L2863">		Connection con = DBConnect.getConnection();</span>
		try{
<span class="nc" id="L2865">			PreparedStatement pstmt = con.prepareStatement(&quot;select service_id, service_code, service_display_name from st_lms_service_master where status='ACTIVE' and service_display_name &lt;&gt; 'HOME' AND service_display_name &lt;&gt; 'SCRATCH'&quot;);</span>
<span class="nc" id="L2866">			System.out.println(&quot;Service Query:&quot; + pstmt + &quot;***&quot;);</span>
<span class="nc" id="L2867">			ResultSet rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L2868" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L2869">				serviceMap.put(rs.getString(&quot;service_code&quot;), rs.getString(&quot;service_display_name&quot;));</span>
			}
<span class="nc" id="L2871">		} catch(SQLException se){</span>
<span class="nc" id="L2872">			se.printStackTrace();</span>
		} finally{
<span class="nc" id="L2874">			DBConnect.closeCon(con);</span>
<span class="nc" id="L2875">		}</span>
<span class="nc" id="L2876">		return serviceMap;</span>
	}
	
	public Map&lt;Integer,String&gt; fetchCategories(){
<span class="nc" id="L2880">		Map&lt;Integer, String&gt; categoryMap = new HashMap&lt;Integer, String&gt;();</span>
<span class="nc" id="L2881">		Connection con = DBConnect.getConnection();</span>
		try{
<span class="nc" id="L2883">			PreparedStatement pstmt = con.prepareStatement(&quot;select category_id, category_code from  st_cs_product_category_master where status='ACTIVE'&quot;);</span>
<span class="nc" id="L2884">			System.out.println(&quot;Category Query:&quot; + pstmt + &quot;***&quot;);</span>
<span class="nc" id="L2885">			ResultSet rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L2886" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L2887">				categoryMap.put(rs.getInt(&quot;category_id&quot;), rs.getString(&quot;category_code&quot;));</span>
			}
<span class="nc" id="L2889">		} catch(SQLException se){</span>
<span class="nc" id="L2890">			se.printStackTrace();</span>
		} finally{
<span class="nc" id="L2892">			DBConnect.closeCon(con);</span>
<span class="nc" id="L2893">		}</span>
<span class="nc" id="L2894">		return categoryMap;</span>
	}
	

	
	public String fetchCancelDrawData(DrawScheduleBean drawScheduleBean){
<span class="nc" id="L2900">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L2901">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L2902">		sReq.setServiceName(ServiceName.DRAW_MGMT);</span>
<span class="nc" id="L2903">		sReq.setServiceMethod(ServiceMethodName.DRAWGAME_FETCH_CANCEL_DRAW_DATA);</span>
<span class="nc" id="L2904">		sReq.setServiceData(drawScheduleBean);</span>
<span class="nc" id="L2905">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
		try{
<span class="nc" id="L2907">		sRes = delegate.getResponse(sReq);</span>
<span class="nc" id="L2908">		}catch (Exception e) {</span>
<span class="nc" id="L2909">			logger.error(e);</span>
<span class="nc" id="L2910">		}</span>
		
<span class="nc" id="L2912">		String responseString=sRes.getResponseData().toString();</span>
<span class="nc" id="L2913">		Type elementType = new TypeToken&lt;TreeMap&lt;String, String&gt;&gt;() {}.getType();</span>
<span class="nc" id="L2914">		TreeMap&lt;String, String&gt; drawMap = new Gson().fromJson(responseString, elementType);</span>
<span class="nc" id="L2915">		StringBuilder respBuilder = new StringBuilder();</span>
<span class="nc bnc" id="L2916" title="All 2 branches missed.">		for(String key: drawMap.keySet()){</span>
<span class="nc" id="L2917">			respBuilder.append(&quot;&lt;td align=\&quot;center\&quot; width=\&quot;25%\&quot;&gt;&quot; + drawMap.get(key) + &quot;&lt;/td&gt;,&quot;);</span>
<span class="nc" id="L2918">		}</span>
<span class="nc" id="L2919">		respBuilder.deleteCharAt(respBuilder.length()-1);</span>
<span class="nc" id="L2920">		return respBuilder.toString();</span>
	}
/**
 * 	
 * @param drawDataBean
 * @param raffleTktType
 * @return
 */
	public DGConsolidateGameDataBean fetchDrawGameDataForLMS(DrawDataBean drawDataBean,String raffleTktType, String stateCode, String cityCode){
<span class="nc" id="L2929">		DGConsolidateGameDataBean consolidateBean = new DGConsolidateGameDataBean();</span>
<span class="nc" id="L2930">		ArrayList&lt;Integer&gt; retUserIdList=new ArrayList&lt;Integer&gt;();</span>
<span class="nc" id="L2931">		Connection con=null;</span>
//		PreparedStatement pstmt =null;
<span class="nc" id="L2933">		Statement stmt = null;</span>
<span class="nc" id="L2934">		ResultSet  rs =null;</span>
		//StringBuilder query = new StringBuilder(&quot;SELECT user_id FROM st_lms_user_master WHERE organization_id IN (SELECT organization_id FROM st_lms_organization_master om INNER JOIN st_lms_state_master sm ON om.state_code = sm.state_code INNER JOIN st_lms_city_master cm ON om.city = cm.city_name &quot;);
<span class="nc" id="L2936">		StringBuilder query = new StringBuilder(&quot;select user_id from st_lms_user_master a inner join st_lms_organization_master b on a.organization_id=b.organization_id where a.organization_type='RETAILER'&quot;);</span>
//		String stateQuery = null;
//		String cityQuery = null;
//		String retQuery = null;
		try {
<span class="nc" id="L2941">				con =DBConnect.getConnection();</span>
<span class="nc bnc" id="L2942" title="All 2 branches missed.">			if(drawDataBean.getAgentOrgId() &gt; 0) {</span>
<span class="nc" id="L2943">				query.append(&quot; and &quot;);</span>
<span class="nc" id="L2944">				query.append(&quot; parent_id = &quot;+drawDataBean.getAgentOrgId()+&quot;;&quot;);</span>
			}
<span class="nc" id="L2946">				stmt = con.createStatement();</span>
<span class="nc" id="L2947">				rs = stmt.executeQuery(query.toString());</span>
<span class="nc bnc" id="L2948" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L2949">					retUserIdList.add(rs.getInt(&quot;user_id&quot;));</span>
				}
<span class="nc" id="L2951">				logger.info(&quot;Retailers For Agent: &quot; + drawDataBean.getAgentOrgId() + &quot;:- &quot; + retUserIdList);</span>
			
			/* if(!&quot;ALL&quot;.equals(stateCode) || (drawDataBean.getAgentOrgId() &gt; 0)) {
				con =DBConnect.getConnection();
				query.append(&quot; WHERE &quot;);
				if(!&quot;ALL&quot;.equals(stateCode)) {
					query.append(&quot;sm.state_code = '&quot;+stateCode+&quot;'&quot;);
				}
				if(!&quot;ALL&quot;.equals(cityCode)) {
					if(!&quot;ALL&quot;.equals(stateCode)) {
						query.append(&quot;AND&quot;);
					}
					query.append(&quot; cm.city_name = '&quot;+cityCode+&quot;'&quot;);
				}
				if (drawDataBean.getAgentOrgId() &gt; 0) {
					   if(!&quot;ALL&quot;.equals(cityCode)||!&quot;ALL&quot;.equals(stateCode))
					      query.append(&quot;AND&quot;);
						query.append(&quot; parent_id = &quot;+drawDataBean.getAgentOrgId()+&quot; AND organization_type='RETAILER'&quot;);
				}
				query.append(&quot;)&quot;);

				stmt = con.createStatement();
				rs = stmt.executeQuery(query.toString());
				while (rs.next()) {
					retUserIdList.add(rs.getInt(&quot;user_id&quot;));
				}
				logger.info(&quot;Retailers For Agent: &quot; + drawDataBean.getAgentOrgId() + &quot;:- &quot; + retUserIdList);
			}
			
			/*if(drawDataBean.getAgentOrgId() &gt; 0){

				con =DBConnect.getConnection();
				pstmt=con.prepareStatement(&quot;select user_id from st_lms_user_master where organization_id in (select organization_id from st_lms_organization_master where parent_id =? and organization_type=?)&quot;);
				pstmt.setInt(1,drawDataBean.getAgentOrgId());
				pstmt.setString(2,&quot;RETAILER&quot;);
				rs=pstmt.executeQuery();
				while(rs.next()){
					
					retUserIdList.add(rs.getInt(&quot;user_id&quot;));
				}
				logger.info(&quot;Retailers For Agent: &quot;+drawDataBean.getAgentOrgId()+&quot;:- &quot;+retUserIdList);
			
				}	*/
<span class="nc" id="L2994">		drawDataBean.setRetailerUserIdList(retUserIdList);</span>
		// get Data For LMS ;
		
<span class="nc" id="L2997">		ServiceRequest serReq = new ServiceRequest();</span>
<span class="nc" id="L2998">		ServiceResponse serResp = new ServiceResponse();</span>
<span class="nc" id="L2999">		serReq.setServiceName(ServiceName.REPORTS_MGMT);</span>
<span class="nc" id="L3000">		serReq.setServiceMethod(ServiceMethodName.FETCH_DRAW_GAME_CONSOLIDATE_DATA);</span>
<span class="nc" id="L3001">		serReq.setServiceData(drawDataBean);</span>
<span class="nc" id="L3002">		IServiceDelegate  delegate =ServiceDelegate.getInstance(); </span>
<span class="nc" id="L3003">		serResp=delegate.getResponse(serReq);</span>
<span class="nc bnc" id="L3004" title="All 2 branches missed.">		if(serResp.getIsSuccess()){</span>
//			consolidateBean=(DGConsolidateGameDataBean)serResp.getResponseData();
<span class="nc" id="L3006">			Type type = new TypeToken&lt;DGConsolidateGameDataBean&gt;(){}.getType();</span>
<span class="nc" id="L3007">			consolidateBean = (DGConsolidateGameDataBean)new Gson().fromJson((JsonElement)serResp.getResponseData(), type);</span>
<span class="nc" id="L3008">			logger.info(&quot;Got Draw Game Consolidate Data &quot;+consolidateBean);</span>
			
			
			
			 /* String gameType = Util.getGameType(drawDataBean.getGameNo());
			  * commented for bug  20391 
			  * 
			  * if(&quot;RAFFLE&quot;.equalsIgnoreCase(gameType)){				    
			     //to cut last four digit in case of raffle GAME			  
				  if(&quot;ORIGINAL&quot;.equalsIgnoreCase(raffleTktType)){	
					  DGConsolidateDrawBean reportDrawBean=null;
					     for(int i=0;i&lt;consolidateBean.getDrawDataBeanList().size();i++){
					    	 	reportDrawBean = consolidateBean.getDrawDataBeanList().get(i); 
								String  winRes = reportDrawBean.getWinningResult();
								if(winRes!=null){	
								String[] winResultArr = winRes.split(&quot;,&quot;);
								StringBuilder finalresult= new StringBuilder(&quot;&quot;);
									for(int j=0;j&lt;winResultArr.length;j++){
										String winResWithRpCnt = winResultArr[j];
										if(winResWithRpCnt != null &amp;&amp; !&quot;null&quot;.equalsIgnoreCase(winResWithRpCnt)){
											int length = winResWithRpCnt.length();
												if(length == ConfigurationVariables.tktLenA || length == ConfigurationVariables.tktLenB){ 
													finalresult.append(winResWithRpCnt.substring(0, length-4));
													finalresult.append(&quot;xxxx&quot;);
													finalresult.append(&quot;,&quot;);							 
												} 
										 } 
									}
								if(finalresult!=null &amp;&amp; !&quot;&quot;.equals(finalresult.toString()) &amp;&amp; !&quot;0&quot;.equals(finalresult.toString())){
									finalresult.deleteCharAt(finalresult.length()-1);
								}
								reportDrawBean.setWinningResult(finalresult.toString());
					     } 
					}
			  }else{
				//for swap result with sale ticket number in case of reference ticket 
			      getDisplayTktNumber(consolidateBean); //in case of reference ticket
			  }
			    }*/
			
		}
<span class="nc" id="L3049">		}catch(Exception e){</span>
<span class="nc" id="L3050">			e.printStackTrace();</span>
			
		}finally{
			
<span class="nc" id="L3054">			try{</span>
<span class="nc bnc" id="L3055" title="All 6 branches missed.">				if(con!=null){</span>
<span class="nc" id="L3056">					con.close();</span>
				}
//				if(stmt!=null){
//					stmt.close();
//				}
<span class="nc bnc" id="L3061" title="All 6 branches missed.">				if(rs!=null){</span>
<span class="nc" id="L3062">					rs.close();</span>
				}
<span class="nc" id="L3064">			}catch(Exception e){</span>
				
<span class="nc" id="L3066">				e.printStackTrace();</span>
<span class="nc" id="L3067">			}</span>
			
<span class="nc" id="L3069">		}</span>
		
		
<span class="nc" id="L3072">		return consolidateBean ;</span>
	}	
/**
 *  This Method APPEND &quot;XXXX&quot; To Winning Ticket Numbers For RAFFLE Game Result
 * @overload ReportBeanDrawModule getDisplayTktNumber(ReportBeanDrawModule reportBeanDrawModule) 
 * @param consolidateBean
 * @return
 */
	public DGConsolidateGameDataBean getDisplayTktNumber(DGConsolidateGameDataBean consolidateBean){
		//List&lt;ReportDrawBean&gt; reportGameBeanList = reportBeanDrawModule.getRepGameBean().getRepDrawBean();
<span class="nc" id="L3082">		  DGConsolidateDrawBean reportDrawBean=null;</span>
		
<span class="nc" id="L3084">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L3085">		Statement drawStmt =null;</span>
<span class="nc" id="L3086">		ResultSet drawRs =null;</span>
	try{	
<span class="nc bnc" id="L3088" title="All 2 branches missed.">		for(int i=0;i&lt;consolidateBean.getDrawDataBeanList().size();i++){</span>
<span class="nc" id="L3089">			reportDrawBean = consolidateBean.getDrawDataBeanList().get(i);		</span>
<span class="nc" id="L3090">			drawStmt = con.createStatement();</span>
<span class="nc" id="L3091">			String  winresWithRpCnt = reportDrawBean.getWinningResult();</span>
			
<span class="nc bnc" id="L3093" title="All 4 branches missed.">		if(winresWithRpCnt != null &amp;&amp; !&quot;null&quot;.equalsIgnoreCase(winresWithRpCnt)){</span>
<span class="nc" id="L3094">			String[] winResultArr = winresWithRpCnt.split(&quot;,&quot;);</span>
<span class="nc" id="L3095">			StringBuilder finalresult= new StringBuilder(&quot;&quot;);</span>
<span class="nc bnc" id="L3096" title="All 2 branches missed.">				for(int j=0;j&lt;winResultArr.length;j++){</span>
<span class="nc" id="L3097">					String winResWithRpCnt = winResultArr[j];</span>
<span class="nc bnc" id="L3098" title="All 4 branches missed.">					if(winResWithRpCnt != null &amp;&amp; !&quot;null&quot;.equalsIgnoreCase(winResWithRpCnt)){</span>
<span class="nc" id="L3099">						int length = winResWithRpCnt.length();</span>
<span class="nc bnc" id="L3100" title="All 4 branches missed.">							if(length == ConfigurationVariables.tktLenA || length == ConfigurationVariables.tktLenB){</span>
<span class="nc" id="L3101">								String rpCnt = winResWithRpCnt.substring(length-2, length);</span>
<span class="nc" id="L3102">								String query =&quot;select sale_ticket_nbr from ge_sale_promo_ticket_mapping where promo_ticket_nbr='&quot;+winResWithRpCnt.substring(0, length-2)+&quot;'&quot;;</span>
<span class="nc" id="L3103">								drawRs = drawStmt.executeQuery(query);</span>
<span class="nc bnc" id="L3104" title="All 2 branches missed.">								if(drawRs.next()){</span>
<span class="nc" id="L3105">									finalresult.append(drawRs.getString(1)+rpCnt);</span>
<span class="nc" id="L3106">									finalresult.append(&quot;,&quot;);</span>
								}
															 
<span class="nc bnc" id="L3109" title="All 2 branches missed.">							} else if(length==1){</span>
<span class="nc" id="L3110">								finalresult.append(winResWithRpCnt);</span>
<span class="nc" id="L3111">								finalresult.append(&quot;,&quot;);</span>
							}
					 } 
				}
<span class="nc bnc" id="L3115" title="All 6 branches missed.">			if(finalresult!=null &amp;&amp; !&quot;&quot;.equals(finalresult.toString()) &amp;&amp; !&quot;0&quot;.equals(finalresult.toString())){</span>
<span class="nc" id="L3116">				finalresult.deleteCharAt(finalresult.length()-1);</span>
			}
<span class="nc" id="L3118">			reportDrawBean.setWinningResult(finalresult.toString());</span>
			
			/*
			int length = winresWithRpCnt.length();
			if(length == ConfigurationVariables.tktLenA || length == ConfigurationVariables.tktLenB){			
			String  winresWithoutRpCnt = winresWithRpCnt.substring(0, length-2);
			
			String rpCnt = winresWithRpCnt.substring(length-2, length);
			drawRs = drawStmt.executeQuery(&quot;select sale_ticket_nbr from ge_sale_promo_ticket_mapping where promo_ticket_nbr='&quot;+winresWithoutRpCnt+&quot;'&quot;);
			while(drawRs.next()){
				reportGameBean.setWinningResult(drawRs.getString(1)+rpCnt);
			}
			}	
		*/}	
		
		}	
<span class="nc" id="L3134">		DBConnect.closeCon(con);</span>
<span class="nc" id="L3135">		} catch (SQLException e) {			</span>
<span class="nc" id="L3136">			e.printStackTrace();</span>
<span class="nc" id="L3137">		}		</span>
<span class="nc" id="L3138">		return consolidateBean;</span>
	}
	
	public static boolean updateFreeTicket(UserInfoBean userInfoBean,int gameId,int promoGameId,int promoTicekts){
<span class="nc" id="L3142">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L3143">		Connection con = null;</span>
<span class="nc" id="L3144">		boolean isUdpated =false;</span>
		try{
<span class="nc" id="L3146">			con =DBConnect.getConnection();</span>
<span class="nc" id="L3147">			con.setAutoCommit(false);</span>
<span class="nc" id="L3148">			String query = &quot; update st_dg_promo_scheme set no_of_free_tickets=? where sale_game_id=? and scheme_id=?&quot;;</span>
<span class="nc" id="L3149">			pstmt =con.prepareStatement(query);</span>
<span class="nc" id="L3150">			pstmt.setInt(1, promoTicekts);</span>
<span class="nc" id="L3151">			pstmt.setInt(2, gameId);</span>
<span class="nc" id="L3152">			pstmt.setInt(3, promoGameId);</span>
<span class="nc" id="L3153">			logger.info(&quot;query for free ticket update&quot;+pstmt);</span>
<span class="nc" id="L3154">			int i=	pstmt.executeUpdate();</span>
<span class="nc" id="L3155">			logger.info(&quot; record updated&quot;+i);</span>
<span class="nc" id="L3156">			DBConnect.closePstmt(pstmt);</span>
<span class="nc" id="L3157">			String insertQry =&quot; insert into st_dg_promo_scheme_history(scheme_id,sale_game_id,no_of_free_tickets,doneBy_user_id,updation_time) select scheme_id,sale_game_id,no_of_free_tickets,&quot;+userInfoBean.getUserId()+&quot; userId, now() dateTime from st_dg_promo_scheme where sale_game_id=? and scheme_id=? &quot;;</span>
<span class="nc" id="L3158">			pstmt =con.prepareStatement(insertQry);</span>
<span class="nc" id="L3159">			pstmt.setInt(1, gameId);</span>
<span class="nc" id="L3160">			pstmt.setInt(2, promoGameId);</span>
<span class="nc" id="L3161">			logger.info(&quot;query for insert ticket history&quot;+pstmt);</span>
<span class="nc" id="L3162">			pstmt.executeUpdate();</span>
<span class="nc bnc" id="L3163" title="All 2 branches missed.">			if(i==1){</span>
<span class="nc" id="L3164">				con.commit();</span>
<span class="nc" id="L3165">				isUdpated=true;</span>
<span class="nc" id="L3166">			Util.promoGameBeanMap =DrawGameRPOSHelper.getPromoGameBeanMap(con);</span>
			}
			
					
<span class="nc" id="L3170">		}catch(Exception e){</span>
<span class="nc" id="L3171">			logger.error(&quot;Excetion e&quot;,e);</span>
		}finally{
<span class="nc" id="L3173">			DBConnect.closePstmt(pstmt);</span>
<span class="nc" id="L3174">			DBConnect.closeCon(con);</span>
			
<span class="nc" id="L3176">		}</span>
<span class="nc" id="L3177">		return isUdpated;</span>
		
	}

	public TicketWiseDataBean getConsolidatedTicketsForDraw(int gameId,int agentOrgId,String drawName,String dateTimeOfDraw,Timestamp uIdChangeDate,AnalysisBean anaBean,String status){
		
<span class="nc" id="L3183">		int userId  = 0;</span>
<span class="nc" id="L3184">		ServiceRequest serReq = null;</span>
<span class="nc" id="L3185">		ServiceResponse serResp = null;</span>
<span class="nc" id="L3186">		List&lt;AnalysisReportDrawBean&gt; anaList = null;</span>
<span class="nc" id="L3187">		TicketWiseDataBean ticketBean = null;</span>
		try {
<span class="nc" id="L3189">			logger.info(&quot;inside getConsolidatedTicketsForDraw()&quot;);</span>
<span class="nc bnc" id="L3190" title="All 2 branches missed.">			userId  = agentOrgId != -1 ? Util.fetchUserIdFormOrgId(agentOrgId): agentOrgId;</span>
<span class="nc bnc" id="L3191" title="All 2 branches missed.">			Map&lt;String, String&gt; orgInfoMap = AjaxRequestHelper.getUserIdOgrCodeMap((userId == -1) , agentOrgId);</span>
<span class="nc bnc" id="L3192" title="All 2 branches missed.">			List&lt;String&gt; partyIdList = (agentOrgId != -1) ? new ArrayList&lt;String&gt;(orgInfoMap.keySet()) : null;</span>
<span class="nc" id="L3193">			anaBean.setGameId(gameId);</span>
<span class="nc" id="L3194">			anaBean.setPartyId(userId+&quot;&quot;);</span>
<span class="nc" id="L3195">			anaBean.setDrawName(drawName);</span>
<span class="nc" id="L3196">			anaBean.setDrawTime(dateTimeOfDraw);</span>
<span class="nc" id="L3197">			anaBean.setPartyIdList(partyIdList);</span>
<span class="nc" id="L3198">			anaBean.setDrawStatus(status);</span>
<span class="nc" id="L3199">			serReq = new ServiceRequest();</span>
<span class="nc" id="L3200">			serResp = new ServiceResponse();</span>
<span class="nc" id="L3201">			serReq.setServiceName(ServiceName.REPORTS_MGMT);</span>
<span class="nc" id="L3202">			serReq.setServiceMethod(ServiceMethodName.FETCH_DRAW_GAME_CONSOLIDATE_DATA_EXPAND);</span>
<span class="nc" id="L3203">			serReq.setServiceData(anaBean);</span>
<span class="nc" id="L3204">			IServiceDelegate  delegate =ServiceDelegate.getInstance(); </span>
<span class="nc" id="L3205">			serResp=delegate.getResponse(serReq);</span>

<span class="nc" id="L3207">			String responseString = serResp.getResponseData().toString();</span>
<span class="nc" id="L3208">			Type elementType = new TypeToken&lt;TicketWiseDataBean&gt;() {}.getType();</span>
<span class="nc" id="L3209">			ticketBean = new Gson().fromJson(responseString, elementType);</span>
<span class="nc bnc" id="L3210" title="All 2 branches missed.">			if (serResp.getIsSuccess()) {</span>
<span class="nc" id="L3211">				logger.info(&quot;response of getConsolidatedTicketsForDraw() came &quot;+serResp.getIsSuccess()); </span>
<span class="nc" id="L3212">				anaList =  ticketBean.getAnaBeanList();</span>
<span class="nc bnc" id="L3213" title="All 4 branches missed.">				if(anaList != null &amp;&amp; anaList.size() &gt; 0){</span>
<span class="nc" id="L3214">				Iterator&lt;AnalysisReportDrawBean&gt; iterator = anaList.iterator();</span>
<span class="nc bnc" id="L3215" title="All 2 branches missed.">					while (iterator.hasNext()) {</span>
<span class="nc" id="L3216">						boolean isOld = false;</span>
<span class="nc" id="L3217">						AnalysisReportDrawBean tempBean = iterator.next();</span>
<span class="nc" id="L3218">						String drawStatus = tempBean.getTicketStatus();</span>
<span class="nc" id="L3219">						String ticketNumber = tempBean.getTicketNumber();</span>
						
<span class="nc" id="L3221">						Timestamp purchaseTime = new Timestamp(new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;).parse(tempBean.getTktPurchaseTime()).getTime());;</span>

<span class="nc bnc" id="L3223" title="All 2 branches missed.">						if(uIdChangeDate.after(purchaseTime)){</span>
<span class="nc" id="L3224">							isOld =  true;</span>
						}
<span class="nc bnc" id="L3226" title="All 4 branches missed.">						tempBean.setTicketNumber((&quot;UNCLAIMED&quot;.equals(drawStatus)) ? </span>
																			((!isOld) ? 
																					(&quot;XXXX&quot;.concat(ticketNumber.substring(4, 18)))
																					: ticketNumber.substring(0, 14).concat(&quot;XXXX&quot;))
																			: ticketNumber);
<span class="nc" id="L3231">						tempBean.setPartyName(orgInfoMap.get(tempBean.getPartyId()));</span>
<span class="nc" id="L3232">					}</span>
<span class="nc" id="L3233">				}</span>
			}else{
<span class="nc bnc" id="L3235" title="All 2 branches missed.">				if(ticketBean.getErrorCode() == LMSErrors.DRAW_DOES_NOT_EXISTS_ERROR_CODE){</span>
<span class="nc" id="L3236">					ticketBean.setErrorMessage(LMSErrors.DRAW_DOES_NOT_EXISTS_ERROR_MESSAGE);</span>
<span class="nc bnc" id="L3237" title="All 2 branches missed.">				}else if(ticketBean.getErrorCode() == LMSErrors.DATA_ARCHIEVED_ERROR_CODE){</span>
<span class="nc" id="L3238">					ticketBean.setErrorMessage(LMSErrors.DATA_ARCHIEVED_ERROR_MESSAGE+ticketBean.getArchData());</span>
				}else{
<span class="nc" id="L3240">					ticketBean.setErrorMessage(LMSErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
				}
<span class="nc" id="L3242">				logger.info(&quot;response of getConsolidatedTicketsForDraw() came &quot;+serResp.getIsSuccess());</span>
			}
<span class="nc" id="L3244">		} catch (Exception e) {</span>
<span class="nc" id="L3245">			e.printStackTrace();</span>
<span class="nc bnc" id="L3246" title="All 2 branches missed.">			if(ticketBean == null){</span>
<span class="nc" id="L3247">				ticketBean = new TicketWiseDataBean();</span>
<span class="nc" id="L3248">				ticketBean.setErrorCode(LMSErrors.GENERAL_EXCEPTION_ERROR_CODE);</span>
<span class="nc" id="L3249">				ticketBean.setErrorMessage(LMSErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
			}
<span class="nc" id="L3251">		}</span>
<span class="nc" id="L3252">		return ticketBean;</span>
	}
	
	
	public List&lt;BlockTicketUserBean&gt; blockBunchTicket(int doneByUserId, String[] ticketNumberArray ,Timestamp updatedTime, String purpose , String[] status, String countryName){
<span class="nc" id="L3257">		ServiceRequest serReq = null;</span>
<span class="nc" id="L3258">		ServiceResponse serResp = null;</span>
<span class="nc" id="L3259">		ArrayList&lt;BlockTicketUserBean&gt; blockTicketList = null;</span>
<span class="nc" id="L3260">		boolean isValid = true;</span>
		try {
<span class="nc" id="L3262">			logger.info(&quot;inside blockBunchTicket()&quot;);</span>
<span class="nc" id="L3263">			blockTicketList = new ArrayList&lt;BlockTicketUserBean&gt;();</span>
<span class="nc bnc" id="L3264" title="All 2 branches missed.">			for(int i = 0;i &lt; ticketNumberArray.length ; i++){</span>
<span class="nc" id="L3265">				String responseMessage = &quot;&quot;;</span>
<span class="nc" id="L3266">				int barCodeCount = -1;</span>
<span class="nc" id="L3267">				String ticketNumber = ticketNumberArray[i];</span>
				
<span class="nc bnc" id="L3269" title="All 2 branches missed.">				if(ticketNumber.length() == ConfigurationVariables.barcodeCount){</span>
<span class="nc" id="L3270">					barCodeCount = Integer.parseInt(Util.getBarCodeCountFromTicketNumber(ticketNumber));</span>
<span class="nc" id="L3271">					ticketNumber = Util.getTicketNumberForBarCode(ticketNumber);</span>
				}
<span class="nc" id="L3273">				int gameId = Util.getGameIdFromGameNumber(Util.getGamenoFromTktnumber(ticketNumber));</span>
<span class="nc bnc" id="L3274" title="All 2 branches missed.">				if(gameId == 0){</span>
<span class="nc" id="L3275">					isValid = false;</span>
<span class="nc" id="L3276">					responseMessage = &quot;Invalid Ticket&quot;;</span>
				}
<span class="nc" id="L3278">				int retUserId = Util.getUserIdFromTicket(ticketNumber);</span>
<span class="nc bnc" id="L3279" title="All 2 branches missed.">				if(retUserId == 0){</span>
<span class="nc" id="L3280">					isValid = false;</span>
<span class="nc" id="L3281">					responseMessage = &quot;Invalid Ticket&quot;;</span>
				}
<span class="nc bnc" id="L3283" title="All 2 branches missed.">				if(!ticketNumber.isEmpty()){</span>
<span class="nc" id="L3284">					BlockTicketUserBean blockTicketUserBean = new BlockTicketUserBeanBuilder(ticketNumber).gameId(gameId).doneByUserId(doneByUserId).countryName(countryName)</span>
					.barCodeCount(barCodeCount).status(status[i]).updatedTime(updatedTime).purpose(purpose).retUserId(retUserId).responseMessage(responseMessage).build();
<span class="nc" id="L3286">					blockTicketList.add(blockTicketUserBean);</span>
				}
			}
<span class="nc bnc" id="L3289" title="All 2 branches missed.">			if(isValid){</span>
<span class="nc" id="L3290">			blockTicketList.trimToSize();</span>
<span class="nc" id="L3291">			serReq = new ServiceRequest();</span>
<span class="nc" id="L3292">			serResp = new ServiceResponse();			</span>
<span class="nc" id="L3293">			serReq.setServiceName(ServiceName.DRAW_MGMT);</span>
<span class="nc" id="L3294">			serReq.setServiceMethod(ServiceMethodName.BLOCK_BUNCH_TICKET_IN_DGE);</span>
<span class="nc" id="L3295">			serReq.setServiceData(blockTicketList);</span>
<span class="nc" id="L3296">			IServiceDelegate  delegate =ServiceDelegate.getInstance(); </span>
<span class="nc" id="L3297">			serResp=delegate.getResponse(serReq);</span>
<span class="nc bnc" id="L3298" title="All 2 branches missed.">			if(serResp.getIsSuccess()){</span>
<span class="nc" id="L3299">				String responseString = serResp.getResponseData().toString();</span>
<span class="nc" id="L3300">				Type elementType = new TypeToken&lt;List&lt;BlockTicketUserBean&gt;&gt;() {}.getType();</span>
<span class="nc" id="L3301">				return new Gson().fromJson(responseString, elementType);	</span>
				}
			}
<span class="nc" id="L3304">		}catch (Exception e) {</span>
<span class="nc" id="L3305">			e.printStackTrace();</span>
<span class="nc" id="L3306">		}</span>
<span class="nc" id="L3307">		return blockTicketList;</span>
	}	
	
	public List&lt;BlockTicketUserBean&gt; getTicketsToBlockUnblock(String criteria ,String ticketNo , int agentOrgId , int retOrgId ,int gameId , String status){
<span class="nc" id="L3311">		ServiceRequest serReq = null;</span>
<span class="nc" id="L3312">		ServiceResponse serResp = null;</span>
<span class="nc" id="L3313">		ArrayList&lt;Integer&gt; userIdList = null;</span>
<span class="nc" id="L3314">		TicketSearchCriteriaBean bean =  null;</span>
<span class="nc" id="L3315">		Statement st=null;</span>
<span class="nc" id="L3316">		ResultSet rs=null;</span>
<span class="nc" id="L3317">		Map&lt;Integer,String&gt; map=null;</span>
<span class="nc" id="L3318">		Connection con=null;</span>
		try {
<span class="nc" id="L3320">			con=DBConnect.getConnection();</span>
<span class="nc" id="L3321">			logger.info(&quot;inside getTicketsToBlockUnblock()&quot;);</span>
<span class="nc" id="L3322">			bean =  new TicketSearchCriteriaBean();</span>
<span class="nc bnc" id="L3323" title="All 2 branches missed.">			if (&quot;2&quot;.equals(criteria)) {</span>
<span class="nc bnc" id="L3324" title="All 4 branches missed.">				if (agentOrgId == -1 &amp;&amp; retOrgId == -1) {</span>
<span class="nc" id="L3325">					userIdList = new ArrayList&lt;Integer&gt;();</span>
<span class="nc bnc" id="L3326" title="All 2 branches missed.">				} else if (retOrgId == -1) {</span>
<span class="nc" id="L3327">					userIdList = AjaxRequestHelper.getUserIdList(agentOrgId,false);</span>
				} else {
<span class="nc" id="L3329">					userIdList = AjaxRequestHelper.getUserIdList(retOrgId, true);</span>
				}
			}
<span class="nc" id="L3332">			bean.setGameId(gameId);</span>
<span class="nc" id="L3333">			bean.setStatus(status);</span>
<span class="nc" id="L3334">			bean.setCriteria(criteria);</span>
<span class="nc" id="L3335">			bean.setUserIdList(userIdList);</span>
<span class="nc" id="L3336">			bean.setTicketNumber(ticketNo);</span>
<span class="nc" id="L3337">			serReq = new ServiceRequest();</span>
<span class="nc" id="L3338">			serResp = new ServiceResponse();</span>
<span class="nc" id="L3339">			serReq.setServiceName(ServiceName.DRAW_MGMT);</span>
<span class="nc" id="L3340">			serReq.setServiceMethod(ServiceMethodName.FETCH_TICKETS_TO_BLOCK_UNBLOCK_IN_DGE);</span>
<span class="nc" id="L3341">			serReq.setServiceData(bean);</span>
<span class="nc" id="L3342">			IServiceDelegate  delegate =ServiceDelegate.getInstance(); </span>
<span class="nc" id="L3343">			serResp=delegate.getResponse(serReq);</span>
<span class="nc bnc" id="L3344" title="All 2 branches missed.">			if(serResp.getIsSuccess()){</span>
<span class="nc" id="L3345">				String responseString = serResp.getResponseData().toString();</span>
<span class="nc" id="L3346">				Type elementType = new TypeToken&lt;List&lt;BlockTicketUserBean&gt;&gt;() {}.getType();</span>
<span class="nc" id="L3347">				List&lt;BlockTicketUserBean&gt;list = new Gson().fromJson(responseString, elementType);</span>
				
<span class="nc" id="L3349">			 st=con.createStatement();	</span>
<span class="nc" id="L3350">		     rs=st.executeQuery(&quot;select user_id,user_name from st_lms_user_master where  organization_type ='BO'&quot;);</span>
<span class="nc" id="L3351">			 map=new HashMap&lt;Integer,String&gt;();</span>
<span class="nc bnc" id="L3352" title="All 2 branches missed.">				while(rs.next()){</span>
<span class="nc" id="L3353">				   map.put(rs.getInt(&quot;user_id&quot;),rs.getString(&quot;user_name&quot;));</span>
				}
<span class="nc bnc" id="L3355" title="All 2 branches missed.">				for(BlockTicketUserBean temp:list){</span>
<span class="nc" id="L3356">					temp.setUserName(map.get(temp.getDoneByUserId()));</span>
<span class="nc" id="L3357">				}</span>
<span class="nc" id="L3358">				return list;</span>
			}
			
			
			
<span class="nc" id="L3363">		}catch (Exception e) {</span>
<span class="nc" id="L3364">			e.printStackTrace();</span>
<span class="nc" id="L3365">		}</span>
<span class="nc" id="L3366">		return null;</span>
	}
	
	public ArrayList&lt;BlockTicketUserBean&gt; unblockBunchTicket(int doneByUserId, String[] ticketNumberArray ,Timestamp updatedTime, String[] purpose,String countryName){
<span class="nc" id="L3370">		ServiceRequest serReq = null;</span>
<span class="nc" id="L3371">		ServiceResponse serResp = null;</span>
<span class="nc" id="L3372">		ArrayList&lt;BlockTicketUserBean&gt; blockTicketList = null;</span>
		try {
<span class="nc" id="L3374">			logger.info(&quot;inside unblockSpecificTicket()&quot;);</span>
<span class="nc" id="L3375">			blockTicketList = new ArrayList&lt;BlockTicketUserBean&gt;();</span>
<span class="nc" id="L3376">			ArrayList&lt;String&gt; purposeList =  new ArrayList&lt;String&gt;(Arrays.asList(purpose));</span>
<span class="nc" id="L3377">			List&lt;String&gt; a = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L3378">			a.add(&quot;-1&quot;);</span>
<span class="nc" id="L3379">			purposeList.removeAll(a);</span>
<span class="nc" id="L3380">			purposeList.trimToSize();</span>
<span class="nc bnc" id="L3381" title="All 2 branches missed.">			for(int i = 0;i &lt; ticketNumberArray.length ; i++){</span>
<span class="nc" id="L3382">				int barCodeCount = -1;</span>
<span class="nc" id="L3383">				String ticketNumber = ticketNumberArray[i];</span>
				
<span class="nc bnc" id="L3385" title="All 2 branches missed.">				if(ticketNumber.length() == ConfigurationVariables.barcodeCount){</span>
<span class="nc" id="L3386">					barCodeCount = Integer.parseInt(Util.getBarCodeCountFromTicketNumber(ticketNumber));</span>
<span class="nc" id="L3387">					ticketNumber = Util.getTicketNumberForBarCode(ticketNumber);</span>
				}
<span class="nc" id="L3389">				int gameId = Util.getGameIdFromGameNumber(Util.getGamenoFromTktnumber(ticketNumber));</span>
<span class="nc bnc" id="L3390" title="All 2 branches missed.">				if(gameId == 0){</span>
<span class="nc" id="L3391">					throw new LMSException(LMSErrors.INVALID_TICKET_ERROR_CODE , LMSErrors.INVALID_TICKET_ERROR_MESSAGE);</span>
				}
<span class="nc" id="L3393">				int retUserId = Util.getUserIdFromTicket(ticketNumber);</span>
<span class="nc" id="L3394">				BlockTicketUserBean blockTicketUserBean = new BlockTicketUserBeanBuilder(ticketNumber).gameId(gameId).doneByUserId(doneByUserId).countryName(countryName)</span>
				.barCodeCount(barCodeCount).purpose(purposeList.get(i)).updatedTime(updatedTime).retUserId(retUserId).build();
<span class="nc" id="L3396">				blockTicketList.add(blockTicketUserBean);</span>
			}
<span class="nc" id="L3398">			blockTicketList.trimToSize();</span>
<span class="nc" id="L3399">			serReq = new ServiceRequest();</span>
<span class="nc" id="L3400">			serResp = new ServiceResponse();			</span>
<span class="nc" id="L3401">			serReq.setServiceName(ServiceName.DRAW_MGMT);</span>
<span class="nc" id="L3402">			serReq.setServiceMethod(ServiceMethodName.BLOCK_UNBLOCK_TICKET_IN_DGE);</span>
<span class="nc" id="L3403">			serReq.setServiceData(blockTicketList);</span>
<span class="nc" id="L3404">			IServiceDelegate  delegate =ServiceDelegate.getInstance(); </span>
<span class="nc" id="L3405">			serResp=delegate.getResponse(serReq);</span>
<span class="nc bnc" id="L3406" title="All 2 branches missed.">			if(serResp.getIsSuccess()){</span>
<span class="nc" id="L3407">				String responseString = serResp.getResponseData().toString();</span>
<span class="nc" id="L3408">				Type elementType = new TypeToken&lt;List&lt;BlockTicketUserBean&gt;&gt;() {}.getType();</span>
<span class="nc" id="L3409">				return new Gson().fromJson(responseString, elementType);	</span>
			}
<span class="nc" id="L3411">		}catch (LMSException e) {</span>
<span class="nc" id="L3412">			e.printStackTrace();</span>
<span class="nc" id="L3413">		}catch (Exception e) {</span>
<span class="nc" id="L3414">			e.printStackTrace();</span>
<span class="nc" id="L3415">		}</span>
<span class="nc" id="L3416">		return null;</span>
	}
	
	public DGConsolidateGameDataBean fetchPromoDrawGameDataForLMS(DrawDataBean drawDataBean, String raffleTktType) {
<span class="nc" id="L3420">		DGConsolidateGameDataBean consolidateBean = new DGConsolidateGameDataBean();</span>
<span class="nc" id="L3421">		ArrayList&lt;Integer&gt; retUserIdList = new ArrayList&lt;Integer&gt;();</span>
<span class="nc" id="L3422">		Connection con = null;</span>
<span class="nc" id="L3423">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L3424">		ResultSet rs = null;</span>
		try {
<span class="nc bnc" id="L3426" title="All 2 branches missed.">			if (drawDataBean.getAgentOrgId() &gt; 0) {</span>
<span class="nc" id="L3427">				con = DBConnect.getConnection();</span>
<span class="nc" id="L3428">				pstmt = con.prepareStatement(&quot;select user_id from st_lms_user_master where organization_id in (select organization_id from st_lms_organization_master where parent_id =? and organization_type=?)&quot;);</span>
<span class="nc" id="L3429">				pstmt.setInt(1, drawDataBean.getAgentOrgId());</span>
<span class="nc" id="L3430">				pstmt.setString(2, &quot;RETAILER&quot;);</span>
<span class="nc" id="L3431">				rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L3432" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L3433">					retUserIdList.add(rs.getInt(&quot;user_id&quot;));</span>
				}
<span class="nc" id="L3435">				logger.info(&quot;Retailers For Agent: &quot; + drawDataBean.getAgentOrgId() + &quot;:- &quot; + retUserIdList);</span>
			}
<span class="nc" id="L3437">			drawDataBean.setRetailerUserIdList(retUserIdList);</span>
			// get Data For LMS ;

<span class="nc" id="L3440">			ServiceRequest serReq = new ServiceRequest();</span>
<span class="nc" id="L3441">			ServiceResponse serResp = new ServiceResponse();</span>
<span class="nc" id="L3442">			serReq.setServiceName(ServiceName.REPORTS_MGMT);</span>
<span class="nc" id="L3443">			serReq.setServiceMethod(ServiceMethodName.FETCH_PROMO_DRAW_GAME_CONSOLIDATE_DATA);</span>
<span class="nc" id="L3444">			serReq.setServiceData(drawDataBean);</span>
<span class="nc" id="L3445">			IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L3446">			serResp = delegate.getResponse(serReq);</span>
<span class="nc bnc" id="L3447" title="All 2 branches missed.">			if (serResp.getIsSuccess()) {</span>
				// consolidateBean=(DGConsolidateGameDataBean)serResp.getResponseData();
<span class="nc" id="L3449">				Type type = new TypeToken&lt;DGConsolidateGameDataBean&gt;() {}.getType();</span>
<span class="nc" id="L3450">				consolidateBean = (DGConsolidateGameDataBean) new Gson().fromJson((JsonElement) serResp.getResponseData(), type);</span>
<span class="nc" id="L3451">				logger.info(&quot;Got Draw Game Consolidate Data &quot; + consolidateBean);</span>

<span class="nc" id="L3453">				String gameType = Util.getGameType(drawDataBean.getGameNo());</span>
<span class="nc bnc" id="L3454" title="All 2 branches missed.">				if (&quot;RAFFLE&quot;.equalsIgnoreCase(gameType)) {</span>
					// to cut last four digit in case of raffle GAME
<span class="nc bnc" id="L3456" title="All 2 branches missed.">					if (&quot;ORIGINAL&quot;.equalsIgnoreCase(raffleTktType)) {</span>
<span class="nc" id="L3457">						DGConsolidateDrawBean reportDrawBean = null;</span>
<span class="nc bnc" id="L3458" title="All 2 branches missed.">						for (int i = 0; i &lt; consolidateBean.getDrawDataBeanList().size(); i++) {</span>
<span class="nc" id="L3459">							reportDrawBean = consolidateBean.getDrawDataBeanList().get(i);</span>
<span class="nc" id="L3460">							String winRes = reportDrawBean.getWinningResult();</span>
<span class="nc bnc" id="L3461" title="All 2 branches missed.">							if (winRes != null) {</span>
<span class="nc" id="L3462">								String[] winResultArr = winRes.split(&quot;,&quot;);</span>
<span class="nc" id="L3463">								StringBuilder finalresult = new StringBuilder(&quot;&quot;);</span>
<span class="nc bnc" id="L3464" title="All 2 branches missed.">								for (int j = 0; j &lt; winResultArr.length; j++) {</span>
<span class="nc" id="L3465">									String winResWithRpCnt = winResultArr[j];</span>
<span class="nc bnc" id="L3466" title="All 4 branches missed.">									if (winResWithRpCnt != null &amp;&amp; !&quot;null&quot;.equalsIgnoreCase(winResWithRpCnt)) {</span>
<span class="nc" id="L3467">										int length = winResWithRpCnt.length();</span>
<span class="nc bnc" id="L3468" title="All 4 branches missed.">										if (length == ConfigurationVariables.tktLenA || length == ConfigurationVariables.tktLenB) {</span>
<span class="nc" id="L3469">											finalresult.append(winResWithRpCnt.substring(0, length - 4));</span>
<span class="nc" id="L3470">											finalresult.append(&quot;xxxx&quot;);</span>
<span class="nc" id="L3471">											finalresult.append(&quot;,&quot;);</span>
										}
									}
								}
<span class="nc bnc" id="L3475" title="All 6 branches missed.">								if (finalresult != null &amp;&amp; !&quot;&quot;.equals(finalresult.toString()) &amp;&amp; !&quot;0&quot;.equals(finalresult.toString())) {</span>
<span class="nc" id="L3476">									finalresult.deleteCharAt(finalresult.length() - 1);</span>
								}
<span class="nc" id="L3478">								reportDrawBean.setWinningResult(finalresult.toString());</span>
							}
						}
<span class="nc" id="L3481">					} else {</span>
						// for swap result with sale ticket number in case of reference ticket
<span class="nc" id="L3483">						getDisplayTktNumber(consolidateBean); // in case of reference ticket</span>
					}
				}
			}
<span class="nc" id="L3487">		} catch (Exception e) {</span>
<span class="nc" id="L3488">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L3490">			try {</span>
<span class="nc bnc" id="L3491" title="All 6 branches missed.">				if (con != null) {</span>
<span class="nc" id="L3492">					con.close();</span>
				}
<span class="nc bnc" id="L3494" title="All 6 branches missed.">				if (pstmt != null) {</span>
<span class="nc" id="L3495">					pstmt.close();</span>
				}
<span class="nc bnc" id="L3497" title="All 6 branches missed.">				if (rs != null) {</span>
<span class="nc" id="L3498">					rs.close();</span>
				}
<span class="nc" id="L3500">			} catch (Exception e) {</span>

<span class="nc" id="L3502">				e.printStackTrace();</span>
<span class="nc" id="L3503">			}</span>
<span class="nc" id="L3504">		}</span>
<span class="nc" id="L3505">		return consolidateBean;</span>
	}
	
	public Map&lt;Integer, RankWiseWinningReportBean&gt; fetchRankWiseWinningData(DrawDataBean drawDataBean){
<span class="nc" id="L3509">		Map&lt;Integer,RankWiseWinningReportBean&gt; dataMap = null;</span>
<span class="nc" id="L3510">		Set&lt;Integer&gt; removableKeys = new HashSet&lt;Integer&gt;();</span>
		
		try{
<span class="nc" id="L3513">				Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L3514">				ServiceRequest serReq = new ServiceRequest();</span>
<span class="nc" id="L3515">				ServiceResponse serResp = new ServiceResponse();</span>
<span class="nc" id="L3516">				serReq.setServiceName(ServiceName.REPORTS_MGMT);</span>
<span class="nc" id="L3517">				serReq.setServiceMethod(ServiceMethodName.FETCH_RANK_WISE_WINNING_DATA);</span>
<span class="nc" id="L3518">				serReq.setServiceData(drawDataBean);</span>
<span class="nc" id="L3519">				IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L3520">				serResp = delegate.getResponse(serReq);</span>
				
<span class="nc bnc" id="L3522" title="All 2 branches missed.">				if (serResp.getIsSuccess()) {</span>
<span class="nc" id="L3523">					Type type = new TypeToken&lt;Map&lt;Integer, RankWiseWinningReportBean&gt;&gt;() {}.getType();</span>
<span class="nc" id="L3524">					dataMap =  new Gson().fromJson((JsonElement) serResp.getResponseData(), type);</span>
<span class="nc" id="L3525">					logger.info(&quot;Got Rank wise Consolidate Data &quot; + dataMap);</span>
					
<span class="nc bnc" id="L3527" title="All 2 branches missed.">					for(Map.Entry&lt;Integer, RankWiseWinningReportBean&gt; itr : dataMap.entrySet()) {</span>
<span class="nc" id="L3528">							int sum = 0;</span>
<span class="nc bnc" id="L3529" title="All 2 branches missed.">							for(Map.Entry&lt;Integer, Integer&gt; itrInner : itr.getValue().getWinningTktMap().entrySet()){</span>
<span class="nc" id="L3530">								sum += itrInner.getValue();</span>
<span class="nc" id="L3531">							}</span>
<span class="nc" id="L3532">							itr.getValue().setSum(sum);</span>
							
<span class="nc bnc" id="L3534" title="All 2 branches missed.">							if(sum &gt; 0){</span>
						
<span class="nc" id="L3536">								String names[] = fetchName(itr.getValue().getRetailerOrgId(),con).split(&quot;#&quot;);							</span>
<span class="nc" id="L3537">								itr.getValue().setRetailerName(names[0].toUpperCase());</span>
<span class="nc" id="L3538">								itr.getValue().setAgentName(fetchAgentName(Integer.parseInt(names[1]),con).toUpperCase());</span>
<span class="nc" id="L3539">							}else{</span>
<span class="nc" id="L3540">								removableKeys.add(itr.getKey());</span>
							}
											
<span class="nc" id="L3543">					}</span>
					
<span class="nc" id="L3545">					dataMap.keySet().removeAll(removableKeys);</span>
				}
			
<span class="nc" id="L3548">		}catch(Exception e){</span>
<span class="nc" id="L3549">			e.printStackTrace();</span>
<span class="nc" id="L3550">		}</span>
		
<span class="nc" id="L3552">		return dataMap;</span>
	}
	
	public String fetchName(int id,Connection con) throws SQLException{
<span class="nc" id="L3556">		String orgName = null;</span>
<span class="nc" id="L3557">		String qry = &quot;select a.name, parent_id from st_lms_organization_master  a inner join st_lms_user_master b on a.organization_id = b.organization_id where b.user_id = &quot;+id;</span>
<span class="nc" id="L3558">		Statement stmt = con.createStatement();</span>
<span class="nc" id="L3559">		ResultSet rs = stmt.executeQuery(qry);</span>
<span class="nc bnc" id="L3560" title="All 2 branches missed.">		if(rs.next()){</span>
<span class="nc" id="L3561">			orgName =  rs.getString(&quot;name&quot;)+&quot;#&quot;+rs.getString(&quot;parent_id&quot;);</span>
		}
<span class="nc" id="L3563">		return orgName;</span>
	}
	
	public String fetchAgentName(int id,Connection con) throws SQLException{
<span class="nc" id="L3567">		String orgName = null;</span>
<span class="nc" id="L3568">		String qry = &quot;select name from st_lms_organization_master where organization_id = &quot;+id;</span>
<span class="nc" id="L3569">		Statement stmt = con.createStatement();</span>
<span class="nc" id="L3570">		ResultSet rs = stmt.executeQuery(qry);</span>
<span class="nc bnc" id="L3571" title="All 2 branches missed.">		if(rs.next()){</span>
<span class="nc" id="L3572">			orgName =  rs.getString(&quot;name&quot;);</span>
		}
<span class="nc" id="L3574">		return orgName;</span>
	}
	
	public List&lt;MtnCustomerCenterBean&gt; fetchMerchantWiseTxns(String merchantName, String mobileNbr, String startDate, String endDate) throws Exception {
<span class="nc" id="L3578">		List&lt;MtnCustomerCenterBean&gt; mtnCustomerCenterBeans= null;</span>
<span class="nc" id="L3579">		JsonObject reqObj = new JsonObject();</span>
<span class="nc" id="L3580">		ServiceResponse sRes = new ServiceResponse();</span>
<span class="nc" id="L3581">		ServiceRequest sReq = new ServiceRequest();</span>
<span class="nc" id="L3582">		sReq.setServiceName(ServiceName.REPORTS_MGMT);</span>
<span class="nc" id="L3583">		sReq.setServiceMethod(ServiceMethodName.FETCH_MERCHANT_WISE_TRANSACTION_DATA);</span>

<span class="nc" id="L3585">		reqObj.addProperty(&quot;merchantName&quot;, merchantName);</span>
<span class="nc" id="L3586">		reqObj.addProperty(&quot;mobileNbr&quot;, mobileNbr);</span>
<span class="nc" id="L3587">		reqObj.addProperty(&quot;startDate&quot;, startDate);</span>
<span class="nc" id="L3588">		reqObj.addProperty(&quot;endDate&quot;, endDate);</span>

<span class="nc" id="L3590">		sReq.setServiceData(reqObj);</span>
<span class="nc" id="L3591">		IServiceDelegate delegate = ServiceDelegate.getInstance();</span>
<span class="nc" id="L3592">		sRes = delegate.getResponse(sReq);</span>

<span class="nc bnc" id="L3594" title="All 2 branches missed.">		if(sRes.getIsSuccess()) {</span>
<span class="nc" id="L3595">			Type type = new TypeToken&lt;List&lt;MtnCustomerCenterBean&gt;&gt;(){}.getType();</span>
<span class="nc" id="L3596">			mtnCustomerCenterBeans= new Gson().fromJson((JsonElement) sRes.getResponseData(), type);</span>
		}
<span class="nc" id="L3598">		return mtnCustomerCenterBeans;</span>
	}
	
	
	 public StringBuilder getAutumaticResultSubmissionResponse(DrawDataBean drawDataBean){
	  
<span class="nc" id="L3604">		 StringBuilder submissionResp=new StringBuilder();</span>
<span class="nc" id="L3605">		 HttpURLConnection connection = null;</span>
		 try{
<span class="nc" id="L3607">		 URL url = new URL(Utility.serverDGWURL+&quot;/com/skilrock/drawManager/drawResultSubmit.action?gameName=&quot;+drawDataBean.getGameName()+&quot;&amp;drawId=&quot;+drawDataBean.getDrawId()+&quot;&quot;);</span>
<span class="nc" id="L3608">		 connection = (HttpURLConnection)url.openConnection();</span>
<span class="nc" id="L3609">		 connection.setRequestMethod(&quot;POST&quot;);  </span>
<span class="nc" id="L3610">		 connection.setUseCaches(false);</span>
<span class="nc" id="L3611">	     connection.setDoOutput(true);</span>
	      //Send request
<span class="nc" id="L3613">	        DataOutputStream wr = new DataOutputStream (connection.getOutputStream());</span>
<span class="nc" id="L3614">	        wr.close();</span>
	     
<span class="nc" id="L3616">	        InputStream is = connection.getInputStream();</span>
<span class="nc" id="L3617">	        BufferedReader rd = new BufferedReader(new InputStreamReader(is));</span>
	        String line;
<span class="nc bnc" id="L3619" title="All 2 branches missed.">	        while((line = rd.readLine()) != null) {</span>
<span class="nc" id="L3620">	        	submissionResp.append(line);</span>
<span class="nc" id="L3621">	        	submissionResp.append('\r');</span>
	        }
<span class="nc" id="L3623">	        rd.close();</span>
		 }
<span class="nc" id="L3625">		 catch(Exception e){</span>
<span class="nc" id="L3626">			 JSONObject jsonResponse = new JSONObject();</span>
<span class="nc" id="L3627">			 jsonResponse.put(&quot;isSuccess&quot;,false);</span>
<span class="nc" id="L3628">			 jsonResponse.put(&quot;responseMessage&quot;,&quot;Internal system error !!!&quot;);</span>
<span class="nc" id="L3629">			 submissionResp.append(jsonResponse);</span>
		 }
		 finally
		 {
<span class="nc bnc" id="L3633" title="All 6 branches missed.">			 if(connection != null) {</span>
<span class="nc" id="L3634">			      connection.disconnect(); </span>
			    }
		 }
<span class="nc" id="L3637">		 return submissionResp;  </span>
	 }
}

   
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>