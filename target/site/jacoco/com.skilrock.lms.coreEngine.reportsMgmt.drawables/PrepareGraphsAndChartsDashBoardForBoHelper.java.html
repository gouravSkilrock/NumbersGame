<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PrepareGraphsAndChartsDashBoardForBoHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lms</a> &gt; <a href="index.source.html" class="el_package">com.skilrock.lms.coreEngine.reportsMgmt.drawables</a> &gt; <span class="el_source">PrepareGraphsAndChartsDashBoardForBoHelper.java</span></div><h1>PrepareGraphsAndChartsDashBoardForBoHelper.java</h1><pre class="source lang-java linenums">package com.skilrock.lms.coreEngine.reportsMgmt.drawables;

import java.lang.reflect.Type;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.LinkedHashMap;
import java.util.List;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import com.google.gson.Gson;
import com.google.gson.reflect.TypeToken;
import com.skilrock.lms.beans.ServiceRequest;
import com.skilrock.lms.beans.ServiceResponse;
import com.skilrock.lms.common.Utility;
import com.skilrock.lms.common.db.DBConnect;
import com.skilrock.lms.common.utility.CommonMethods;
import com.skilrock.lms.coreEngine.service.IServiceDelegate;
import com.skilrock.lms.coreEngine.service.ServiceDelegate;
import com.skilrock.lms.coreEngine.service.dge.ServiceMethodName;
import com.skilrock.lms.coreEngine.service.dge.ServiceName;
import com.skilrock.lms.dge.beans.DGConsolidateDrawBean;
import com.skilrock.lms.dge.beans.DGConsolidateGameDataBean;
import com.skilrock.lms.dge.beans.DrawDataBean;

public class PrepareGraphsAndChartsDashBoardForBoHelper/* implements Runnable */{

<span class="nc" id="L35">	Log logger = LogFactory</span>
			.getLog(PrepareGraphsAndChartsDashBoardForBoHelper.class);

	//private int type;
<span class="nc" id="L39">	private ResultSet rs = null;</span>
<span class="nc" id="L40">	private Statement stmt = null;</span>
<span class="nc" id="L41">	private Connection con = null;</span>
<span class="nc" id="L42">	private PreparedStatement pstmt = null;</span>

<span class="nc" id="L44">	public PrepareGraphsAndChartsDashBoardForBoHelper(/*int type*/) {</span>
<span class="nc" id="L45">		String filePath = System.getProperty(&quot;jboss.server.home.dir&quot;)+&quot;/deploy&quot;+com.skilrock.lms.web.common.drawables.CommonMethods.path;</span>
<span class="nc" id="L46">		com.skilrock.lms.web.common.drawables.CommonMethods.DeleteFiles(filePath, false, &quot;&quot;);</span>
<span class="nc" id="L47">		prepDataForUserGraphForRendering(filePath);</span>
<span class="nc" id="L48">		prepDataForSalesGraphForRendering(filePath);</span>
<span class="nc" id="L49">		prepDataForDrawWiseGraphForRendering(filePath);</span>
<span class="nc" id="L50">		prepDataForRetailerStatusGraphForRendering(filePath);</span>
<span class="nc" id="L51">		prepDataForCshColChartForRendering(filePath);</span>
<span class="nc" id="L52">	}</span>

	private void prepDataForCshColChartForRendering(String filePath) {

<span class="nc" id="L56">		String graphsDates = null;</span>
<span class="nc" id="L57">		String[] dateArray = null;</span>
<span class="nc" id="L58">		boolean isArchTablesReq = false;</span>
<span class="nc" id="L59">		LinkedHashMap&lt;String, String&gt; gameMap = null;</span>
<span class="nc" id="L60">		String fileName = &quot;DASHBOARDCASHCOLLECTIONDRILLDOWN&quot;;</span>
		try {
<span class="nc" id="L62">			graphsDates = com.skilrock.lms.web.common.drawables.CommonMethods.perpDateForDashBoardChartsAndGraphs(true, false, -1, 7,false);</span>
<span class="nc" id="L63">			dateArray = graphsDates.split(&quot;#&quot;);</span>
<span class="nc" id="L64">			isArchTablesReq = com.skilrock.lms.web.common.drawables.CommonMethods.isArchTablesRequired(dateArray[dateArray.length - 1].substring(0, 10), CommonMethods.getLastArchDate());</span>
<span class="nc" id="L65">			gameMap = new LinkedHashMap&lt;String, String&gt;();</span>
<span class="nc" id="L66">			gameMap.put(&quot;&quot;, com.skilrock.lms.web.common.drawables.CommonMethods.perpareCaptionsForDrawables(&quot;Cash Collection Analytics&quot;,&quot;&quot;,&quot;Last 7 Days&quot;, &quot;Collection (In &quot; +Utility.getPropertyValue(&quot;CURRENCY_SYMBOL&quot;) + &quot;)&quot;));</span>
<span class="nc" id="L67">			prepareCashCollectionWeekly(dateArray,isArchTablesReq, gameMap);</span>
<span class="nc" id="L68">			com.skilrock.lms.web.common.drawables.CommonMethods.prepareCSVFile(fileName, gameMap, filePath);</span>
<span class="nc" id="L69">		} catch (Exception e) {</span>
<span class="nc" id="L70">			logger.error(&quot;EXCEPTION :- &quot;, e);</span>
<span class="nc" id="L71">		}</span>
<span class="nc" id="L72">	}</span>

	private void prepDataForSalesGraphForRendering(String filePath) {
<span class="nc" id="L75">		String graphsDates = null;</span>
<span class="nc" id="L76">		String[] dateArray = null;</span>
<span class="nc" id="L77">		boolean isArchTablesReq = false;</span>
<span class="nc" id="L78">		LinkedHashMap&lt;String, String&gt; gameMap = null;</span>
<span class="nc" id="L79">		String fileName = &quot;DASHBOARDSALESCOLLECTIONCOLUMNSTACKED&quot;;</span>
		try {
<span class="nc" id="L81">			graphsDates = com.skilrock.lms.web.common.drawables.CommonMethods.perpDateForDashBoardChartsAndGraphs(true, false, -1, 7,false);</span>
<span class="nc" id="L82">			dateArray = graphsDates.split(&quot;#&quot;);</span>
<span class="nc" id="L83">			isArchTablesReq = com.skilrock.lms.web.common.drawables.CommonMethods.isArchTablesRequired(dateArray[dateArray.length - 1].substring(0, 10), CommonMethods.getLastArchDate());</span>
<span class="nc" id="L84">			List&lt;String&gt; list = Arrays.asList(dateArray);</span>
<span class="nc" id="L85">			Collections.reverse(list);</span>
<span class="nc" id="L86">			dateArray = (String[]) list.toArray();</span>
<span class="nc" id="L87">			gameMap = new LinkedHashMap&lt;String, String&gt;();</span>
<span class="nc" id="L88">			gameMap.put(&quot;&quot;, com.skilrock.lms.web.common.drawables.CommonMethods.perpareCaptionsForDrawables(&quot;Game Wise Analytics&quot;, &quot;&quot;,&quot;Last 7 Days&quot;,&quot;Amount (In &quot; +Utility.getPropertyValue(&quot;CURRENCY_SYMBOL&quot;) + &quot;)&quot;));</span>
<span class="nc" id="L89">			prepareSalesDailyString(dateArray[0],dateArray[dateArray.length - 1].substring(0, 10).concat(&quot; 23:59:59&quot;), isArchTablesReq, dateArray, gameMap);</span>
<span class="nc" id="L90">			com.skilrock.lms.web.common.drawables.CommonMethods.prepareCSVFile(fileName, gameMap, filePath);</span>
<span class="nc" id="L91">		} catch (Exception e) {</span>
<span class="nc" id="L92">			logger.error(&quot;EXCEPTION :- &quot;, e);</span>
<span class="nc" id="L93">		}</span>
<span class="nc" id="L94">	}</span>

	private void prepDataForUserGraphForRendering(String filePath) {

<span class="nc" id="L98">		LinkedHashMap&lt;String, String&gt; gameMap = null;</span>
<span class="nc" id="L99">		String fileName = &quot;DASHBOARDUSERPIE&quot;;</span>
		try {
<span class="nc" id="L101">			gameMap = new LinkedHashMap&lt;String, String&gt;();</span>
<span class="nc" id="L102">			gameMap.put(&quot;&quot;, com.skilrock.lms.web.common.drawables.CommonMethods.perpareCaptionsForDrawables(&quot;LMS Tier Users Analytics&quot;, &quot;&quot;, &quot;&quot;,&quot;Count&quot;));</span>
<span class="nc" id="L103">			prepareUserWiseAnalytics(gameMap);</span>
<span class="nc" id="L104">			com.skilrock.lms.web.common.drawables.CommonMethods.prepareCSVFile(fileName, gameMap, filePath);</span>
<span class="nc" id="L105">		} catch (Exception e) {</span>
<span class="nc" id="L106">			logger.error(&quot;EXCEPTION :- &quot;, e);</span>
<span class="nc" id="L107">		}</span>
<span class="nc" id="L108">	}</span>

	private void prepDataForDrawWiseGraphForRendering(String filePath) {
		
<span class="nc" id="L112">		LinkedHashMap&lt;String, String&gt; gameMap = null;</span>
<span class="nc" id="L113">		String fileName = &quot;DASHBOARDDRAWWISECOLLECTIONLINECHART&quot;;</span>
		try {
<span class="nc" id="L115">			gameMap = new LinkedHashMap&lt;String, String&gt;();</span>
<span class="nc" id="L116">			gameMap.put(&quot;&quot;, com.skilrock.lms.web.common.drawables.CommonMethods.perpareCaptionsForDrawables(&quot;Draw Wise Analytics&quot;, &quot;&quot;, &quot;Last 7 Draws&quot;,&quot;Amount (In &quot; +Utility.getPropertyValue(&quot;CURRENCY_SYMBOL&quot;) + &quot;)&quot;));</span>
<span class="nc" id="L117">			prepareDrawWiseAnalyticsString(7, gameMap);</span>
<span class="nc" id="L118">			com.skilrock.lms.web.common.drawables.CommonMethods.prepareCSVFile(fileName, gameMap, filePath);</span>
<span class="nc" id="L119">		} catch (Exception e) {</span>
<span class="nc" id="L120">			logger.error(&quot;EXCEPTION :- &quot;, e);</span>
<span class="nc" id="L121">		}</span>
<span class="nc" id="L122">	}</span>

	private void prepDataForRetailerStatusGraphForRendering(String filePath) {
<span class="nc" id="L125">		String graphsDates = null;</span>
<span class="nc" id="L126">		String[] dateArray = null;</span>
<span class="nc" id="L127">		LinkedHashMap&lt;String, String&gt; gameMap = null;</span>
<span class="nc" id="L128">		String fileName = &quot;DASHBOARDRETSTATUSCOLUMNSTACKED&quot;;</span>
		try {
<span class="nc" id="L130">			graphsDates = com.skilrock.lms.web.common.drawables.CommonMethods.perpDateForDashBoardChartsAndGraphs(true, false, -7, 7,true);</span>
<span class="nc" id="L131">			List&lt;String&gt; list = Arrays.asList(graphsDates.split(&quot;#&quot;));</span>
<span class="nc" id="L132">			Collections.reverse(list);</span>
<span class="nc" id="L133">			dateArray = (String[]) list.toArray();</span>
<span class="nc" id="L134">			gameMap = new LinkedHashMap&lt;String, String&gt;();</span>
<span class="nc" id="L135">			gameMap.put(&quot;&quot;, com.skilrock.lms.web.common.drawables.CommonMethods.perpareCaptionsForDrawables(&quot;Retailer Status Analytics&quot;,&quot;&quot;, &quot;Last 7 Saturdays&quot;, &quot;Count&quot;));</span>
<span class="nc" id="L136">			prepareRetailerStatusGraphString(dateArray, gameMap);</span>
<span class="nc" id="L137">			com.skilrock.lms.web.common.drawables.CommonMethods.prepareCSVFile(fileName, gameMap, filePath);</span>
<span class="nc" id="L138">		} catch (Exception e) {</span>
<span class="nc" id="L139">			logger.error(&quot;EXCEPTION :- &quot;, e);</span>
<span class="nc" id="L140">		}</span>
<span class="nc" id="L141">	}</span>

	private void prepareCashCollectionWeekly(String[] dateArray, boolean isArchTablesReq,LinkedHashMap&lt;String, String&gt; gameMap) {

		
<span class="nc" id="L146">		String endDate = null;</span>
<span class="nc" id="L147">		String startDate = null;</span>
<span class="nc" id="L148">		StringBuilder mainQuery = null;</span>
<span class="nc" id="L149">		StringBuilder cashBuilder = new StringBuilder();</span>
<span class="nc" id="L150">		StringBuilder chequeBuilder = new StringBuilder();</span>
<span class="nc" id="L151">		StringBuilder cheqBounceBuilder = new StringBuilder();</span>
<span class="nc" id="L152">		StringBuilder debitBuilder = new StringBuilder();</span>
<span class="nc" id="L153">		StringBuilder creditBuilder = new StringBuilder();</span>
<span class="nc" id="L154">		StringBuilder bankBuilder = new StringBuilder();</span>
<span class="nc" id="L155">		StringBuilder categoryBuilder = new StringBuilder();</span>
		try {
<span class="nc" id="L157">			mainQuery = new StringBuilder(</span>
					&quot;select  ifnull(sum(cash) ,0.0) cash, ifnull(sum(cheque),0.0) cheque, ifnull(sum(bounce),0.0) bounce, ifnull(sum(debit),0.0) debit, ifnull(sum(credit),0.0) credit,ifnull(sum(bank),0.0) bank ,ifnull(sum(((cash+cheque+credit+bank)-(bounce+debit))),0.0)  netAmount from ( select ifnull(sum(cash.amount),0) cash, 0 cheque, 0 bounce, 0 debit, 0 credit,0 bank from st_lms_bo_cash_transaction cash, st_lms_bo_transaction_master btm where ( btm.transaction_date &gt;=? and btm.transaction_date &lt;=?) and cash.transaction_id=btm.transaction_id  union all  select 0 cash, ifnull(sum(chq.cheque_amt),0) cheque, 0 bounce, 0 debit, 0 credit,0 bank from  st_lms_bo_sale_chq chq, st_lms_bo_transaction_master btm where  ( btm.transaction_date &gt;=? and btm.transaction_date &lt;=?) and chq.transaction_type IN ('CHEQUE','CLOSED')and chq.transaction_id=btm.transaction_id  union all select 0 cash,0 cheque,ifnull(sum(chq.cheque_amt),0) bounce, 0 debit, 0 credit,0 bank from  st_lms_bo_sale_chq chq, st_lms_bo_transaction_master btm where chq.transaction_type='CHQ_BOUNCE' and ( btm.transaction_date &gt;=? and btm.transaction_date &lt;=?) and chq.transaction_id=btm.transaction_id  union all select 0 cash , 0 cheque, 0 bounce, ifnull(sum(bo.amount),0) debit, 0 credit,0 bank  from st_lms_bo_debit_note bo, st_lms_bo_transaction_master btm where btm.transaction_id=bo.transaction_id and (bo.transaction_type ='DR_NOTE_CASH' or bo.transaction_type ='DR_NOTE') and ( btm.transaction_date &gt;=? and btm.transaction_date &lt;=?)  union all select 0 cash , 0 cheque, 0 bounce, 0 debit,ifnull(sum(bo.amount),0) credit,0 bank  from st_lms_bo_credit_note bo, st_lms_bo_transaction_master btm where btm.transaction_id=bo.transaction_id and (bo.transaction_type ='CR_NOTE_CASH') and ( btm.transaction_date &gt;=? and btm.transaction_date &lt;=?)  union all select 0 cash , 0 cheque, 0 bounce, 0 debit, 0 credit,ifnull(sum(bank.amount),0) bank from st_lms_bo_bank_deposit_transaction bank, st_lms_bo_transaction_master btm where btm.transaction_id=bank.transaction_id and  ( btm.transaction_date &gt;=? and btm.transaction_date &lt;=?))  bank &quot;);
<span class="nc" id="L159">			con = DBConnect.getConnection();</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">			if (isArchTablesReq)</span>
<span class="nc" id="L161">				pstmt = con</span>
						.prepareStatement(&quot;select sum(cash) cash,sum(cheque) cheque, sum(bounce) bounce, sum(debit) debit, sum(credit) credit,sum(bank) bank ,sum(((cash+cheque+credit+bank)-(bounce+debit)))  netAmount  from (&quot;
								.concat(mainQuery.toString())
								.concat(
										&quot; union all select  ifnull(sum(cash_amt),0.0) cash,  ifnull(sum(cheque_amt),0.0) cheque,  ifnull(sum(cheque_bounce_amt),0.0) bounce,  ifnull(sum(debit_note),0.0) debit,   ifnull(sum(credit_note),0.0) credit,  ifnull(sum(bank_deposit),0.0) bank, ifnull(sum(((cash_amt+cheque_amt+credit_note+bank_deposit)-(cheque_bounce_amt+debit_note))),0.0)  netAmount from st_rep_bo_payments where finaldate &gt;=? and finaldate &lt;=? ) cash&quot;));
			else
<span class="nc" id="L167">				pstmt = con.prepareStatement(mainQuery.toString());</span>
			
<span class="nc" id="L169">			int count = dateArray.length;</span>
<span class="nc" id="L170">			gameMap.put(&quot;&quot;,gameMap.get(&quot;&quot;).replace(&quot;7&quot;,count+&quot;&quot;));</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">			while (count != 0) {</span>
<span class="nc" id="L172">				count--;</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">				if (count == 0) {</span>
<span class="nc" id="L174">					startDate = dateArray[count];</span>
<span class="nc" id="L175">					endDate = dateArray[count].substring(0, 11).concat(</span>
							&quot;23:59:59&quot;);
				} else {
<span class="nc" id="L178">					startDate = dateArray[count];</span>
<span class="nc" id="L179">					endDate = dateArray[count].substring(0, 11).concat(</span>
							&quot;23:59:59&quot;);
				}

<span class="nc" id="L183">				pstmt.setString(1, startDate);</span>
<span class="nc" id="L184">				pstmt.setString(2, endDate);</span>
<span class="nc" id="L185">				pstmt.setString(3, startDate);</span>
<span class="nc" id="L186">				pstmt.setString(4, endDate);</span>
<span class="nc" id="L187">				pstmt.setString(5, startDate);</span>
<span class="nc" id="L188">				pstmt.setString(6, endDate);</span>
<span class="nc" id="L189">				pstmt.setString(7, startDate);</span>
<span class="nc" id="L190">				pstmt.setString(8, endDate);</span>
<span class="nc" id="L191">				pstmt.setString(9, startDate);</span>
<span class="nc" id="L192">				pstmt.setString(10, endDate);</span>
<span class="nc" id="L193">				pstmt.setString(11, startDate);</span>
<span class="nc" id="L194">				pstmt.setString(12, endDate);</span>

<span class="nc bnc" id="L196" title="All 2 branches missed.">				if (isArchTablesReq) {</span>
<span class="nc" id="L197">					pstmt.setString(13, startDate);</span>
<span class="nc" id="L198">					pstmt.setString(14, endDate);</span>
				}

<span class="nc" id="L201">				rs = pstmt.executeQuery();</span>

				
<span class="nc bnc" id="L204" title="All 2 branches missed.">				if (rs.next()) {</span>
<span class="nc" id="L205">					cashBuilder.append(rs.getString(&quot;cash&quot;)).append(&quot;,&quot;);</span>
<span class="nc" id="L206">					chequeBuilder.append(rs.getString(&quot;cheque&quot;)).append(&quot;,&quot;);</span>
<span class="nc" id="L207">					cheqBounceBuilder.append(rs.getString(&quot;bounce&quot;)).append(&quot;,&quot;);</span>
<span class="nc" id="L208">					debitBuilder.append(rs.getString(&quot;debit&quot;)).append(&quot;,&quot;);</span>
<span class="nc" id="L209">					creditBuilder.append(rs.getString(&quot;credit&quot;)).append(&quot;,&quot;);</span>
<span class="nc" id="L210">					bankBuilder.append(rs.getString(&quot;bank&quot;)).append(&quot;,&quot;);</span>
				} else {
<span class="nc" id="L212">					cashBuilder.append(0.0).append(&quot;,&quot;);</span>
<span class="nc" id="L213">					chequeBuilder.append(0.0).append(&quot;,&quot;);</span>
<span class="nc" id="L214">					cheqBounceBuilder.append(0.0).append(&quot;,&quot;);</span>
<span class="nc" id="L215">					debitBuilder.append(0.0).append(&quot;,&quot;);</span>
<span class="nc" id="L216">					creditBuilder.append(0.0).append(&quot;,&quot;);</span>
<span class="nc" id="L217">					bankBuilder.append(0.0).append(&quot;,&quot;);</span>

				}
				
<span class="nc" id="L221">				categoryBuilder.append(com.skilrock.lms.web.common.drawables.CommonMethods.getDateForDrawables(startDate)).append(&quot;,&quot;);</span>
			}
			
			
<span class="nc" id="L225">			gameMap.put(&quot;categories&quot;, categoryBuilder.toString());</span>
<span class="nc" id="L226">			gameMap.put(&quot;CASH&quot;, cashBuilder.toString());</span>
<span class="nc" id="L227">			gameMap.put(&quot;CASH&quot;, cashBuilder.toString());</span>
<span class="nc" id="L228">			gameMap.put(&quot;CHEQUE&quot;, chequeBuilder.toString());</span>
<span class="nc" id="L229">			gameMap.put(&quot;BOUNCE&quot;, cheqBounceBuilder.toString());</span>
<span class="nc" id="L230">			gameMap.put(&quot;DEBIT&quot;, debitBuilder.toString());</span>
<span class="nc" id="L231">			gameMap.put(&quot;CREDIT&quot;, creditBuilder.toString());</span>
<span class="nc" id="L232">			gameMap.put(&quot;BANK&quot;, bankBuilder.toString());</span>
<span class="nc" id="L233">		} catch (Exception e) {</span>
<span class="nc" id="L234">			logger.error(&quot;EXCEPTION :- &quot;, e);</span>
		} finally {
<span class="nc" id="L236">			DBConnect.closeConnection(con, pstmt, rs);</span>
<span class="nc" id="L237">		}</span>
		

<span class="nc" id="L240">	}</span>


	private void prepareRetailerStatusGraphString(String datesArray[],
			LinkedHashMap&lt;String, String&gt; weeklyMap) {

<span class="nc" id="L246">		StringBuilder categoryBuilder = new StringBuilder();</span>
<span class="nc" id="L247">		StringBuilder liveRetBuilder = new StringBuilder();</span>
<span class="nc" id="L248">		StringBuilder noSaleRetBuilder = new StringBuilder();</span>
<span class="nc" id="L249">		StringBuilder inactiveRetBuilder = new StringBuilder();</span>
<span class="nc" id="L250">		StringBuilder terminatedRetBuilder = new StringBuilder();</span>

<span class="nc" id="L252">		int totalActiveRets = 0;</span>
<span class="nc" id="L253">		int totalInActiveRets = 0;</span>
<span class="nc" id="L254">		int totalNoSaleRets = 0;</span>

		try {
<span class="nc" id="L257">			con = DBConnect.getConnection();</span>
<span class="nc" id="L258">			stmt = con.createStatement();</span>
<span class="nc" id="L259">			rs = stmt</span>
					.executeQuery(&quot; select date, live_retailers, noSale_retailers, inactive_retailers, terminated_retailers  from st_lms_ret_activity_history where date in (&quot;
							+ com.skilrock.lms.web.common.drawables.CommonMethods
									.getListFromData(Arrays.asList(datesArray))
									.replace(&quot;]&quot;, &quot;&quot;).replace(&quot;[&quot;, &quot;&quot;)
							+ &quot;) order by date&quot;);
<span class="nc" id="L265">			int count = 0;</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L267">				int LiveRet = 0;</span>
<span class="nc" id="L268">				int NoSaleRet = 0;</span>
<span class="nc" id="L269">				int InactiveRet = 0;</span>
<span class="nc" id="L270">				int TerminatedRet = 0;</span>
<span class="nc bnc" id="L271" title="All 2 branches missed.">				if (datesArray[count].equals(rs.getString(&quot;date&quot;).replace(&quot;.0&quot;,</span>
						&quot;&quot;))) {
<span class="nc" id="L273">					LiveRet = rs.getInt(&quot;live_retailers&quot;);</span>
<span class="nc" id="L274">					NoSaleRet = rs.getInt(&quot;noSale_retailers&quot;);</span>
<span class="nc" id="L275">					InactiveRet = rs.getInt(&quot;inactive_retailers&quot;);</span>
<span class="nc" id="L276">					TerminatedRet = rs.getInt(&quot;terminated_retailers&quot;);</span>
				}

<span class="nc" id="L279">				totalActiveRets += LiveRet;</span>
<span class="nc" id="L280">				totalNoSaleRets += NoSaleRet;</span>
<span class="nc" id="L281">				totalInActiveRets += InactiveRet;</span>

<span class="nc" id="L283">				categoryBuilder.append(com.skilrock.lms.web.common.drawables.CommonMethods.getDateForDrawables(datesArray[count])).append(&quot;,&quot;);</span>
<span class="nc" id="L284">				liveRetBuilder.append(LiveRet).append(&quot;,&quot;);</span>
<span class="nc" id="L285">				noSaleRetBuilder.append(NoSaleRet).append(&quot;,&quot;);</span>
<span class="nc" id="L286">				inactiveRetBuilder.append(InactiveRet).append(&quot;,&quot;);</span>
<span class="nc" id="L287">				terminatedRetBuilder.append(TerminatedRet).append(&quot;,&quot;);</span>
<span class="nc" id="L288">				count++;</span>
<span class="nc" id="L289">			}</span>
<span class="nc" id="L290">			weeklyMap.put(&quot;&quot;,weeklyMap.get(&quot;&quot;).replace(&quot;7&quot;,count+&quot;&quot;));</span>
<span class="nc" id="L291">			weeklyMap.put(&quot;categories&quot;, categoryBuilder.toString());</span>
<span class="nc" id="L292">			weeklyMap.put(&quot;LIVE&quot;, liveRetBuilder.toString());</span>
<span class="nc" id="L293">			weeklyMap.put(&quot;IDLE&quot;, noSaleRetBuilder.toString());</span>
<span class="nc" id="L294">			weeklyMap.put(&quot;INACTIVE&quot;, inactiveRetBuilder.toString());</span>
<span class="nc" id="L295">			weeklyMap.put(&quot;TERMINATED&quot;, terminatedRetBuilder.toString());</span>
<span class="nc" id="L296">			weeklyMap.put(&quot;SUMMARY&quot;, &quot;&quot;);</span>
<span class="nc" id="L297">			weeklyMap.put(&quot;Avg Live Ret&quot;,</span>
					com.skilrock.lms.web.drawGames.common.Util
							.getBalInString(totalActiveRets / count)
							+ &quot;,&quot;);
<span class="nc" id="L301">			weeklyMap.put(&quot;Avg Idle Ret&quot;,</span>
					com.skilrock.lms.web.drawGames.common.Util
							.getBalInString(totalNoSaleRets / count)
							+ &quot;,&quot;);
<span class="nc" id="L305">			weeklyMap.put(&quot;Avg Inactive Ret&quot;,</span>
					com.skilrock.lms.web.drawGames.common.Util
							.getBalInString(totalInActiveRets / count)
							+ &quot;,&quot;);

<span class="nc" id="L310">		} catch (Exception e) {</span>
<span class="nc" id="L311">			logger.error(&quot;EXCEPTION :- &quot;, e);</span>
		} finally {
<span class="nc" id="L313">			DBConnect.closeConnection(con, stmt, rs);</span>
<span class="nc" id="L314">		}</span>

<span class="nc" id="L316">	}</span>

	private void prepareDrawWiseAnalyticsString(int noOfDaysForReport,
			LinkedHashMap&lt;String, String&gt; gameMap) throws SQLException {

<span class="nc" id="L321">		ServiceRequest serReq = null;</span>
<span class="nc" id="L322">		ServiceResponse serResp = null;</span>
<span class="nc" id="L323">		DrawDataBean drawDataBean = null;</span>
<span class="nc" id="L324">		DGConsolidateGameDataBean consolidateBean = null;</span>

<span class="nc" id="L326">		int totalPwt = 0;</span>
<span class="nc" id="L327">		int totalSale = 0;</span>
<span class="nc" id="L328">		int totalClmd = 0;</span>
<span class="nc" id="L329">		double pprAppender = 0.0;</span>
<span class="nc" id="L330">		StringBuilder pwtBuilder = new StringBuilder();</span>
<span class="nc" id="L331">		StringBuilder saleBuilder = new StringBuilder();</span>
<span class="nc" id="L332">		StringBuilder clmdBuilder = new StringBuilder();</span>
<span class="nc" id="L333">		StringBuilder categoryBuilder = new StringBuilder();</span>

		try {
<span class="nc" id="L336">			drawDataBean = new DrawDataBean();</span>
<span class="nc" id="L337">			drawDataBean.setMerchantId(&quot;ALL&quot;);</span>
<span class="nc" id="L338">			drawDataBean.setDrawId(noOfDaysForReport);</span>
<span class="nc" id="L339">			drawDataBean.setGameDevName(Utility.getPropertyValue(&quot;GAME_DEV_NAME_FOR_DRAW_WISE_GRAPH&quot;));</span>
<span class="nc" id="L340">			serReq = new ServiceRequest();</span>
<span class="nc" id="L341">			serReq.setServiceName(ServiceName.REPORTS_MGMT);</span>
<span class="nc" id="L342">			serReq</span>
					.setServiceMethod(ServiceMethodName.FETCH_DRAW_GAME_CONSOLIDATE_DATA_FOR_GRAPHS);
<span class="nc" id="L344">			serReq.setServiceData(drawDataBean);</span>
<span class="nc" id="L345">			IServiceDelegate delegate = ServiceDelegate.getInstance();</span>

<span class="nc" id="L347">			serResp = new ServiceResponse();</span>
<span class="nc" id="L348">			serResp = delegate.getResponse(serReq);</span>
<span class="nc" id="L349">			consolidateBean = new DGConsolidateGameDataBean();</span>
<span class="nc bnc" id="L350" title="All 2 branches missed.">			if (serResp.getIsSuccess()){</span>
<span class="nc" id="L351">				String respString = serResp.getResponseData().toString();</span>
<span class="nc" id="L352">				Type elementType = new TypeToken&lt;DGConsolidateGameDataBean&gt;(){}.getType();</span>
<span class="nc" id="L353">			    consolidateBean = new Gson().fromJson(respString, elementType);</span>
			
<span class="nc" id="L355">			 List&lt;DGConsolidateDrawBean&gt; drawDataBeanList = consolidateBean.getDrawDataBeanList();</span>
			// Collections.reverse(drawDataBeanList);
			 
<span class="nc" id="L358">			int count = 0;</span>
<span class="nc bnc" id="L359" title="All 2 branches missed.">			for (DGConsolidateDrawBean dgConsolidateDrawBean : drawDataBeanList) {</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">				if(noOfDaysForReport == count)</span>
<span class="nc" id="L361">					break;</span>
				
<span class="nc" id="L363">				count++;</span>
<span class="nc" id="L364">				double sale = dgConsolidateDrawBean.getLmsSaleBean()</span>
						.getTotalSaleValue();
<span class="nc" id="L366">				double pwt = dgConsolidateDrawBean.getLmsSaleBean()</span>
						.getTotalWinningAmount();
<span class="nc" id="L368">				double clmd = dgConsolidateDrawBean.getLmsSaleBean()</span>
						.getClaimedAmount();

<span class="nc" id="L371">				totalSale += sale;</span>
<span class="nc" id="L372">				totalPwt += pwt;</span>
<span class="nc" id="L373">				totalClmd += clmd;</span>

<span class="nc" id="L375">				categoryBuilder.append(</span>
						com.skilrock.lms.web.common.drawables.CommonMethods
								.getDateForDrawables(dgConsolidateDrawBean
										.getDrawDateTime())).append(&quot;,&quot;);
<span class="nc" id="L379">				saleBuilder.append(sale).append(&quot;,&quot;);</span>
<span class="nc" id="L380">				pprAppender = Math.floor((pwt * 100) / sale);</span>
<span class="nc bnc" id="L381" title="All 2 branches missed.">				pwtBuilder.append((Double.isNaN(pprAppender) ? 0.0 : pprAppender)).append(&quot;,&quot;);</span>
<span class="nc" id="L382">				clmdBuilder.append(clmd).append(&quot;,&quot;);</span>
<span class="nc" id="L383">			}</span>

<span class="nc" id="L385">			int noOfDays = count;</span>
			
<span class="nc" id="L387">			gameMap.put(&quot;&quot;,gameMap.get(&quot;&quot;).replace(&quot;7&quot;,count+&quot;&quot;));</span>
<span class="nc" id="L388">			gameMap.put(&quot;categories&quot;, categoryBuilder.toString());</span>
<span class="nc" id="L389">			gameMap.put(&quot;SALE&quot;, saleBuilder.toString());</span>
<span class="nc" id="L390">			gameMap.put(&quot;PPR&quot;, pwtBuilder.toString());</span>
<span class="nc" id="L391">			gameMap.put(&quot;CLAIMED&quot;, clmdBuilder.toString());</span>
<span class="nc" id="L392">			gameMap.put(&quot;SUMMARY&quot;, &quot;&quot;);</span>
<span class="nc" id="L393">			gameMap.put(&quot;Avg Sales&quot;, com.skilrock.lms.web.drawGames.common.Util</span>
					.getBalInString(totalSale / noOfDays)
					+ &quot;,&quot;);
<span class="nc bnc" id="L396" title="All 2 branches missed.">			pprAppender = totalSale==0.0 ? 0.0:(totalPwt * 100) / totalSale;</span>
<span class="nc bnc" id="L397" title="All 2 branches missed.">			gameMap.put(&quot;Avg PPR (%)&quot;, com.skilrock.lms.web.drawGames.common.Util</span>
					.getBalInString((Double.isNaN(pprAppender) ? 0.0 : totalPwt))
					+ &quot;%,&quot;);
<span class="nc" id="L400">			gameMap.put(&quot;Avg Claimed&quot;,</span>
					com.skilrock.lms.web.drawGames.common.Util
							.getBalInString(totalClmd / noOfDays)
							+ &quot;,&quot;);

<span class="nc" id="L405">		} }catch (Exception e) {</span>
<span class="nc" id="L406">			logger.error(&quot;EXCEPTION :- &quot;, e);</span>
<span class="nc" id="L407">		}</span>
<span class="nc" id="L408">	}</span>

	private void prepareSalesDailyString(String startDate, String endDate,
			boolean isArchTablesReq, String[] graphsDates,
			LinkedHashMap&lt;String, String&gt; gameMap) throws SQLException {

<span class="nc" id="L414">		int gameId = 0;</span>
<span class="nc" id="L415">		boolean found = false;</span>
<span class="nc" id="L416">		String groupBy = null;</span>
<span class="nc" id="L417">		String outerQuery = null;</span>
<span class="nc" id="L418">		String unionQuery = null;</span>
<span class="nc" id="L419">		StringBuilder mainQuery = null;</span>
<span class="nc" id="L420">		StringBuilder dataBuilder = new StringBuilder();</span>
<span class="nc" id="L421">		StringBuilder categoryBuilder = new StringBuilder();</span>

<span class="nc" id="L423">		List&lt;String&gt; gameList = null;</span>
		try {
<span class="nc" id="L425">			con = DBConnect.getConnection();</span>
<span class="nc" id="L426">			stmt = con.createStatement();</span>
<span class="nc" id="L427">			rs = stmt</span>
					.executeQuery(&quot;select game_id,game_name from st_dg_game_master where game_status &lt;&gt; 'SALE_CLOSE' &quot;);
<span class="nc" id="L429">			mainQuery = new StringBuilder(</span>
					&quot;select sum(mrp_amt) sale_mrp , game_id , substring(transaction_date ,1,10) transaction_date from (&quot;);
<span class="nc" id="L431">			gameList = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L432" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L433">				gameId = rs.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L434">				gameList.add(rs.getString(&quot;game_name&quot;));</span>
<span class="nc" id="L435">				unionQuery = &quot;select status,transaction_id,game_id,ticket_nbr,mrp_amt,retailer_org_id,transaction_date from (select 'cancel 'status, rs.ref_transaction_id transaction_id,rs.game_id,ticket_nbr,mrp_amt,rs.retailer_org_id,rtm.transaction_date from st_dg_ret_sale_refund_&quot;</span>
						+ gameId
						+ &quot; rs,st_lms_retailer_transaction_master rtm where rs.transaction_id=rtm.transaction_id and rtm.transaction_date&gt;='&quot;
						+ startDate
						+ &quot;' and rtm.transaction_date&lt;='&quot;
						+ endDate
						+ &quot;' union all select 'sale' status ,rs.transaction_id,rs.game_id,ticket_nbr,mrp_amt,rs.retailer_org_id ,rtm.transaction_date from st_dg_ret_sale_&quot;
						+ gameId
						+ &quot; rs,st_lms_retailer_transaction_master rtm where rs.transaction_id=rtm.transaction_id and rtm.transaction_date&gt;='&quot;
						+ startDate
						+ &quot;' and rtm.transaction_date&lt;='&quot;
						+ endDate
						+ &quot;') a group by transaction_id having count(transaction_id)=1 and status='sale' union all select saleRef.status,ref.transaction_id,saleRef.game_id,ref.ticket_nbr,-ref.mrp_amt mrp_amt,saleRef.retailer_org_id,saleRef.transaction_date from st_dg_ret_sale_refund_&quot;
						+ gameId
						+ &quot; ref inner join (select status,transaction_id,game_id,ticket_nbr,-mrp_amt mrp_amt,retailer_org_id,transaction_date from (select 'cancel 'status, rs.ref_transaction_id transaction_id,rs.game_id,ticket_nbr,mrp_amt,rs.retailer_org_id,rtm.transaction_date from st_dg_ret_sale_refund_&quot;
						+ gameId
						+ &quot; rs,st_lms_retailer_transaction_master rtm where rs.transaction_id=rtm.transaction_id and rtm.transaction_date&gt;='&quot;
						+ startDate
						+ &quot;' and rtm.transaction_date&lt;='&quot;
						+ endDate
						+ &quot;' union all select 'sale' status ,rs.transaction_id,rs.game_id,ticket_nbr,mrp_amt,rs.retailer_org_id ,rtm.transaction_date from st_dg_ret_sale_&quot;
						+ gameId
						+ &quot; rs,st_lms_retailer_transaction_master rtm where rs.transaction_id=rtm.transaction_id and rtm.transaction_date&gt;='&quot;
						+ startDate
						+ &quot;' and rtm.transaction_date&lt;='&quot;
						+ endDate
						+ &quot;' ) a group by transaction_id having count(transaction_id)=1 and status='cancel') saleRef on saleRef.transaction_id=ref.ref_transaction_id union all &quot;;
<span class="nc" id="L462">				mainQuery.append(unionQuery);</span>
			}
<span class="nc" id="L464">			groupBy = &quot;a1 inner join st_dg_game_master gm on gm.game_id=a1.game_id group by day(transaction_date),a1.game_id order  by transaction_date DESC&quot;;</span>
<span class="nc" id="L465">			outerQuery = &quot; select sum(sale_mrp) sale_mrp, game_name , transaction_date from ( &quot;;</span>
<span class="nc" id="L466">			stmt = null;</span>
<span class="nc" id="L467">			stmt = con.createStatement();</span>

<span class="nc bnc" id="L469" title="All 2 branches missed.">			if (isArchTablesReq)</span>
<span class="nc" id="L470">				rs = stmt</span>
						.executeQuery(outerQuery
								.concat(mainQuery
										.substring(
												0,
												mainQuery
														.lastIndexOf(&quot; union all&quot;))
										.concat(
												&quot;) a group by day(transaction_date),game_id&quot;)
										.concat(
												&quot; union all select (sum(sale_mrp)-sum(ref_sale_mrp))sale_mrp,game_id,substring(finaldate ,1,10) from st_rep_dg_retailer  where finaldate&gt;='&quot;
														+ startDate
														+ &quot;' and  finaldate&lt;='&quot;
														+ endDate
														+ &quot;'  group by day(finaldate),game_id )&quot;
														+ groupBy)));
			else
<span class="nc" id="L487">				rs = stmt</span>
						.executeQuery(outerQuery
								+ mainQuery
										.substring(
												0,
												mainQuery
														.lastIndexOf(&quot;union all&quot;))
										.concat(&quot;) &quot;)
										.concat(
												&quot; a1 group by day(transaction_date),game_id  )&quot;)
								+ groupBy);

<span class="nc bnc" id="L499" title="All 2 branches missed.">			for (String date : graphsDates) {</span>
<span class="nc" id="L500">				categoryBuilder.append(</span>
						com.skilrock.lms.web.common.drawables.CommonMethods
								.getDateForDrawables(date)).append(&quot;,&quot;);
			}
<span class="nc" id="L504">			gameMap.put(&quot;categories&quot;, categoryBuilder.toString());</span>

<span class="nc bnc" id="L506" title="All 2 branches missed.">			for (String gameName : gameList) {</span>
<span class="nc" id="L507">				dataBuilder = new StringBuilder();</span>
<span class="nc bnc" id="L508" title="All 2 branches missed.">				for (String date : graphsDates) {</span>
<span class="nc" id="L509">					String tempDate = date.substring(0, 10);</span>
<span class="nc bnc" id="L510" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc bnc" id="L511" title="All 2 branches missed.">						if (tempDate.equals(rs.getString(&quot;transaction_date&quot;))</span>
								&amp; gameName.equals(rs.getString(&quot;game_name&quot;))) {
<span class="nc" id="L513">							dataBuilder.append(rs.getDouble(&quot;sale_mrp&quot;))</span>
									.append(&quot;,&quot;);
<span class="nc" id="L515">							found = true;</span>
<span class="nc" id="L516">							break;</span>
						}
					}
<span class="nc bnc" id="L519" title="All 2 branches missed.">					if (!found) {</span>
<span class="nc" id="L520">						dataBuilder.append(0.0).append(&quot;,&quot;);</span>
					}
<span class="nc" id="L522">					found = false;</span>
<span class="nc" id="L523">					rs.beforeFirst();</span>
				}
<span class="nc" id="L525">				gameMap.put(gameName.toUpperCase(), dataBuilder.toString());</span>
<span class="nc" id="L526">			}</span>
<span class="nc" id="L527">			logger.info(gameMap);</span>
<span class="nc" id="L528">		} catch (Exception e) {</span>
<span class="nc" id="L529">			logger.error(&quot;EXCEPTION :- &quot;, e);</span>
		} finally {
<span class="nc" id="L531">			DBConnect.closeConnection(con, stmt, rs);</span>
<span class="nc" id="L532">		}</span>
<span class="nc" id="L533">	}</span>

	private void prepareUserWiseAnalytics(LinkedHashMap&lt;String, String&gt; gameMap) {

		try {
<span class="nc" id="L538">			con = DBConnect.getConnection();</span>
<span class="nc" id="L539">			stmt = con.createStatement();</span>
<span class="nc" id="L540">			rs = stmt</span>
					.executeQuery(&quot;select organization_type ,  count(*) total from st_lms_user_master where organization_type = 'BO'	union all select organization_type , count(*) total from st_lms_user_master where organization_type = 'RETAILER' union all select organization_type, count(*) total from st_lms_user_master where organization_type = 'AGENT'&quot;);
<span class="nc bnc" id="L542" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L543">				gameMap.put(rs.getString(&quot;organization_type&quot;), rs</span>
						.getString(&quot;total&quot;)
						+ &quot;,&quot;);
			}
<span class="nc" id="L547">			logger.info(gameMap);</span>
<span class="nc" id="L548">		} catch (Exception e) {</span>
<span class="nc" id="L549">			logger.error(&quot;EXCEPTION :- &quot;, e);</span>
		} finally {
<span class="nc" id="L551">			DBConnect.closeConnection(con, stmt, rs);</span>
<span class="nc" id="L552">		}</span>
<span class="nc" id="L553">	}</span>

	

	
	/*@Override
	public void run() {
		String filePath = com.skilrock.lms.web.common.drawables.CommonMethods.path;
		com.skilrock.lms.web.common.drawables.CommonMethods.DeleteFiles(filePath, false, &quot;&quot;);
		if (type == 1) {
			prepDataForUserGraphForRendering(filePath);
		}
		if (type == 2) {
			prepDataForSalesGraphForRendering(filePath);
		}
		if (type == 3) {
			prepDataForDrawWiseGraphForRendering(filePath);
		}
		if (type == 4) {
			prepDataForRetailerStatusGraphForRendering(filePath);
		}
		if(type == 5){
			prepDataForCshColChartForRendering(filePath);
		}

	}*/

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>