<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PayWorldHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lms</a> &gt; <a href="index.source.html" class="el_package">com.skilrock.lms.coreEngine.payWorld.common</a> &gt; <span class="el_source">PayWorldHelper.java</span></div><h1>PayWorldHelper.java</h1><pre class="source lang-java linenums">package com.skilrock.lms.coreEngine.payWorld.common;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.io.OutputStreamWriter;
import java.net.HttpURLConnection;
import java.net.URL;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.TreeMap;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import com.skilrock.lms.beans.PWSaleDataBean;
import com.skilrock.lms.beans.PWSaleRespBean;
import com.skilrock.lms.common.db.DBConnect;
import com.skilrock.lms.common.exception.LMSException;
import com.skilrock.lms.common.filter.LMSFilterDispatcher;
import com.skilrock.lms.common.utility.LMSUtility;
import com.skilrock.lms.coreEngine.commercialService.common.CSPWSaleHelper;
import com.skilrock.lms.web.drawGames.common.Util;

<span class="nc" id="L35">public class PayWorldHelper {</span>
<span class="nc" id="L36">	static Log logger = LogFactory.getLog(CSPWSaleHelper.class);</span>
	
	public String transactionRequest(String agentid,int transId, String retailerid,  String operatorcode,String circode,String product,double denomination,int bulkqty, String narration, String agentpwd, String loginstatus,  String appver){
<span class="nc" id="L39">		logger.debug(&quot;PayWorld Sale Request:  agentid:&quot;+agentid+&quot;,transId:&quot;+transId+&quot;,retailerid:&quot;+retailerid+&quot;,operatorCode:&quot;+operatorcode+&quot;,circleCode:&quot;+circode+&quot;,productCode:&quot;+product+&quot;,denomination:&quot;+denomination+&quot;,bulkqty:&quot;+bulkqty+&quot;,narration:&quot;+narration+&quot;,agentpwd:&quot;+agentpwd+&quot;,loginstatus:&quot;+loginstatus+&quot;,appver:&quot;+appver);</span>
<span class="nc" id="L40">		Map&lt;String,String&gt; paramMap = new HashMap&lt;String,String&gt;();</span>
<span class="nc" id="L41">		paramMap.put(&quot;agentid&quot;, agentid);</span>
<span class="nc" id="L42">		paramMap.put(&quot;transid&quot;,transId+&quot;&quot;);</span>
<span class="nc" id="L43">		paramMap.put(&quot;retailerid&quot;, retailerid);</span>
<span class="nc" id="L44">		paramMap.put(&quot;operatorcode&quot;, operatorcode);</span>
<span class="nc" id="L45">		paramMap.put(&quot;product&quot;,product);</span>
<span class="nc" id="L46">		paramMap.put(&quot;circode&quot;, circode);</span>
<span class="nc" id="L47">		paramMap.put(&quot;denomination&quot;, denomination+&quot;&quot;);</span>
<span class="nc" id="L48">		paramMap.put(&quot;bulkqty&quot;,bulkqty+&quot;&quot;);</span>
<span class="nc" id="L49">		paramMap.put(&quot;narration&quot;,narration);</span>
<span class="nc" id="L50">		paramMap.put(&quot;loginstatus&quot;,loginstatus);</span>
<span class="nc" id="L51">		paramMap.put(&quot;agentpwd&quot;,agentpwd);</span>
<span class="nc" id="L52">		paramMap.put(&quot;appver&quot;, appver);</span>
<span class="nc" id="L53">		String respData = callPayWorld(&quot;pw_trans.php3&quot;, paramMap);</span>
<span class="nc" id="L54">		logger.debug(&quot;PayWorld Sale Response: &quot;+respData); </span>
<span class="nc" id="L55">		return respData;//&quot;845%$2011-07-28 00:00:00%$32452452%$48767864%$2011-12-31 00:00:00&lt;br&gt;%$32452423%$48734534%$2011-12-31 00:00:00&lt;br&gt;%$32457556%$4873245321%$2011-12-31 00:00:00&lt;br&gt;%$3223452123%$482345232213%$2011-12-31 00:00:00$$$&quot;;</span>
	}
	
	public PWSaleDataBean parseSaleResponseData(String respData, PWSaleDataBean termResp)throws Exception{
<span class="nc" id="L59">		List&lt;PWSaleRespBean&gt; dataList = new ArrayList&lt;PWSaleRespBean&gt;();</span>
<span class="nc" id="L60">		SimpleDateFormat sf = new SimpleDateFormat(&quot;yyyy-mm-dd hh:mm:ss&quot;);</span>
<span class="nc" id="L61">		String[] strArr = respData.split(&quot;&lt;BR&gt;&quot;);</span>
<span class="nc bnc" id="L62" title="All 2 branches missed.">		if(strArr.length &lt; dataList.size()){</span>
<span class="nc" id="L63">			termResp.setNarration(respData);</span>
<span class="nc" id="L64">			return termResp;</span>
		}
<span class="nc bnc" id="L66" title="All 2 branches missed.">		if(respData.indexOf(&quot;#ERROR&quot;)!=-1){</span>
<span class="nc" id="L67">			termResp.setNarration(respData);</span>
<span class="nc" id="L68">			return termResp;</span>
		}
<span class="nc bnc" id="L70" title="All 2 branches missed.">		  for(int i=0 ;i&lt;strArr.length; i++){</span>
<span class="nc" id="L71">			  PWSaleRespBean data = new PWSaleRespBean();</span>
<span class="nc" id="L72">			  String[] prodDataArr = strArr[i].split(&quot;%\\$&quot;);</span>
<span class="nc" id="L73">			  logger.debug(prodDataArr[i]+&quot;,&quot;);</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">			  if(i==0){</span>
<span class="nc" id="L75">				  termResp.setPWtransId(prodDataArr[0]);</span>
<span class="nc" id="L76">				  termResp.setTransDateTime(sf.parse(prodDataArr[1]));</span>
<span class="nc" id="L77">				  data.setCardSerialNum(prodDataArr[2]);</span>
<span class="nc" id="L78">				  data.setCardPinNum(prodDataArr[3]);</span>
<span class="nc" id="L79">				  data.setExpiryDate(sf.parse(prodDataArr[4]));</span>
			  }else{
<span class="nc" id="L81">				  data.setCardSerialNum(prodDataArr[0]);</span>
<span class="nc" id="L82">				  data.setCardPinNum(prodDataArr[1]);</span>
<span class="nc" id="L83">				  data.setExpiryDate(sf.parse(prodDataArr[2]));</span>
			  }
<span class="nc" id="L85">			  dataList.add(data);</span>
		  }
<span class="nc" id="L87">		  logger.debug(dataList.size());</span>
<span class="nc" id="L88">		  termResp.setRespDataList(dataList);</span>
<span class="nc" id="L89">		  boolean success = updatePWTransId(termResp.getRMStransId(),termResp.getPWtransId(), termResp.getProdId(), termResp.getCategoryId()  );</span>
<span class="nc" id="L90">		  return termResp;</span>
	}
	
	public String getTerminalFormatSaleData(PWSaleDataBean dataBean){
<span class="nc bnc" id="L94" title="All 2 branches missed.">		if(dataBean.getRespDataList() == null){</span>
<span class="nc" id="L95">			return dataBean.getNarration();</span>
		}else{
<span class="nc" id="L97">			StringBuilder st = new StringBuilder();</span>
<span class="nc" id="L98">			st.append(&quot;TrnId:&quot;+dataBean.getPWtransId());</span>
<span class="nc" id="L99">			st.append(&quot;|TrnDateTime:&quot;+new java.sql.Date(dataBean.getTransDateTime().getTime())+&quot;$&quot;);</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">			for(PWSaleRespBean temp : dataBean.getRespDataList() ){</span>
<span class="nc" id="L101">				st.append(&quot;|CardSrNum:&quot;+temp.getCardSerialNum());</span>
<span class="nc" id="L102">				st.append(&quot;|CardPin:&quot;+temp.getCardPinNum());</span>
<span class="nc" id="L103">				st.append(&quot;|CardExp:&quot;+new java.sql.Date(temp.getExpiryDate().getTime()));</span>
<span class="nc" id="L104">			}</span>
<span class="nc" id="L105">			return st.toString();</span>
		}
	}
	
	public String parseAndFormatTransStatusData(String data){
<span class="nc" id="L110">		return data.toString().substring(0,data.toString().length()-3);</span>
	}
												//operator -&gt; circle -&gt; product -&gt; denomination -&gt; detailsMap[Keys]('talktime', 'validity', 'adminFee', 'serviceTax')
	public String getTerminalFormatServiceData(Map&lt;String, Map&lt;String, Map&lt;String, Map&lt;String, Map&lt;String, String&gt;&gt;&gt;&gt;&gt; dataMap, String cs_isVoucherPrintON){
<span class="nc" id="L114">		StringBuilder termData = new StringBuilder();</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">		if(dataMap.size() == 0){</span>
<span class="nc" id="L116">			return &quot;#Error:No Products on Server|&quot;;</span>
		}else{
<span class="nc" id="L118">			termData.append(&quot;cs_isShowCircle:&quot;+LMSFilterDispatcher.cs_isShowCircle+&quot;|cs_isVoucherPrintOn:&quot;+cs_isVoucherPrintON+&quot;|PINServiceData:&quot;);</span>
<span class="nc" id="L119">			Iterator&lt;Map.Entry&lt;String, Map&lt;String, Map&lt;String, Map&lt;String, Map&lt;String, String&gt;&gt;&gt;&gt;&gt;&gt; dataIt = dataMap.entrySet().iterator();</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">			while(dataIt.hasNext()){</span>
<span class="nc" id="L121">				Map.Entry&lt;String, Map&lt;String, Map&lt;String, Map&lt;String, Map&lt;String, String&gt;&gt;&gt;&gt;&gt; dataPair = (Map.Entry&lt;String, Map&lt;String, Map&lt;String, Map&lt;String, Map&lt;String, String&gt;&gt;&gt;&gt;&gt;)dataIt.next();</span>
<span class="nc" id="L122">				termData.append(dataPair.getKey().replace(&quot;_&quot;, &quot;,&quot;));</span>
<span class="nc" id="L123">				Iterator&lt;Map.Entry&lt;String, Map&lt;String, Map&lt;String, Map&lt;String, String&gt;&gt;&gt;&gt;&gt; cirIt = dataPair.getValue().entrySet().iterator();</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">				while(cirIt.hasNext()){</span>
<span class="nc" id="L125">					Map.Entry&lt;String, Map&lt;String, Map&lt;String, Map&lt;String, String&gt;&gt;&gt;&gt; cirPair = (Map.Entry&lt;String, Map&lt;String, Map&lt;String, Map&lt;String, String&gt;&gt;&gt;&gt;)cirIt.next();</span>
<span class="nc" id="L126">					termData.append(&quot;%$&quot;+cirPair.getKey().replace(&quot;_&quot;, &quot;,&quot;));</span>
<span class="nc" id="L127">					Iterator&lt;Map.Entry&lt;String, Map&lt;String, Map&lt;String, String&gt;&gt;&gt;&gt; prodIt = cirPair.getValue().entrySet().iterator();</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">					while(prodIt.hasNext()){</span>
<span class="nc" id="L129">						Map.Entry&lt;String, Map&lt;String, Map&lt;String, String&gt;&gt;&gt; prodPair = (Map.Entry&lt;String, Map&lt;String, Map&lt;String, String&gt;&gt;&gt;)prodIt.next();</span>
<span class="nc" id="L130">						termData.append(&quot;%:&quot;+prodPair.getKey().replace(&quot;_&quot;, &quot;,&quot;));</span>
<span class="nc" id="L131">						Iterator&lt;Map.Entry&lt;String, Map&lt;String, String&gt;&gt;&gt; denoIt = prodPair.getValue().entrySet().iterator();</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">						while(denoIt.hasNext()){</span>
<span class="nc" id="L133">							Map.Entry&lt;String, Map&lt;String, String&gt;&gt; denoPair = (Map.Entry&lt;String, Map&lt;String, String&gt;&gt;)denoIt.next();</span>
<span class="nc" id="L134">							termData.append(&quot;:&quot;+denoPair.getKey()+&quot;,&quot;);</span>
<span class="nc" id="L135">							Iterator&lt;Map.Entry&lt;String, String&gt;&gt; detIt = denoPair.getValue().entrySet().iterator();</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">							while(detIt.hasNext()){</span>
<span class="nc" id="L137">								Map.Entry&lt;String, String&gt; detPair = detIt.next();</span>
<span class="nc" id="L138">								termData.append(detPair.getValue()+&quot;,&quot;);</span>
<span class="nc" id="L139">							}</span>
<span class="nc" id="L140">							termData.replace(termData.length()-1, termData.length(), &quot;&quot;);</span>
<span class="nc" id="L141">						}</span>
<span class="nc" id="L142">					}</span>
<span class="nc" id="L143">				}</span>
<span class="nc" id="L144">				termData.append(&quot;%#&quot;);</span>
<span class="nc" id="L145">			}</span>
<span class="nc" id="L146">			termData.delete(termData.length()-2, termData.length());</span>
<span class="nc" id="L147">			termData.append(&quot;|&quot;);</span>
		}
<span class="nc" id="L149">		return termData.toString();</span>
	}
	
	
	public String getTerminalFormatServiceDataNew(String cs_isVoucherPrintON){
<span class="nc" id="L154">		StringBuilder termData = new StringBuilder();</span>
<span class="nc" id="L155">		termData.append(&quot;cs_isShowCircle:&quot;+(String)LMSUtility.sc.getAttribute(&quot;IS_CS_SHOW_CIRCLE&quot;)+&quot;|cs_isVoucherPrintOn:&quot;+cs_isVoucherPrintON+&quot;|PINServiceData:&quot;);</span>
	try {
<span class="nc" id="L157">			Connection con=DBConnect.getConnection();</span>
<span class="nc" id="L158">			String operatorQuery=&quot;select  * from st_cs_operator_master where status ='ACTIVE'&quot;;</span>
<span class="nc" id="L159">			PreparedStatement pstmt = con.prepareStatement(operatorQuery);</span>
<span class="nc" id="L160">			ResultSet rsOp = pstmt.executeQuery();</span>
			
<span class="nc bnc" id="L162" title="All 2 branches missed.">				while(rsOp.next()){					</span>
<span class="nc" id="L163">					String operatorCode=rsOp.getString(&quot;operator_code&quot;);</span>
					
<span class="nc" id="L165">					termData.append(operatorCode+&quot;,&quot;);					</span>
<span class="nc" id="L166">					termData.append(rsOp.getString(&quot;operator_name&quot;)+&quot;%$&quot;);</span>
				
					
<span class="nc" id="L169">					String circleQuery=&quot;select distinct(a.circle_code),a.circle_name from st_cs_circle_master a,st_cs_product_master b where  b.operator_code='&quot;+operatorCode+&quot;' and b.status='ACTIVE' and a.circle_code=b.circle_code&quot;;</span>
<span class="nc" id="L170">					PreparedStatement pstmtCircle = con.prepareStatement(circleQuery);</span>
<span class="nc" id="L171">					ResultSet rsCircle = pstmtCircle.executeQuery();</span>
					
<span class="nc bnc" id="L173" title="All 2 branches missed.">					while(rsCircle.next()){</span>
<span class="nc" id="L174">					  String circleCode=rsCircle.getString(&quot;circle_code&quot;);</span>
<span class="nc" id="L175">					  termData.append(circleCode+&quot;,&quot;+rsCircle.getString(&quot;circle_name&quot;)+&quot;%:&quot;);					  </span>
					  
<span class="nc" id="L177">					    String categoryQuery=&quot;select distinct(a.category_id),b.category_code,b.description  from st_cs_product_master a, st_cs_product_category_master b  where circle_code='&quot;+circleCode+&quot;' and operator_code='&quot;+operatorCode+&quot;' and a.category_id=b.category_id and a.status='ACTIVE'&quot;;</span>
<span class="nc" id="L178">						PreparedStatement pstmtcategory = con.prepareStatement(categoryQuery);</span>
<span class="nc" id="L179">						ResultSet rscategory = pstmtcategory.executeQuery();</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">					    while(rscategory.next()){					    	</span>
<span class="nc" id="L181">						    	int categoryId=rscategory.getInt(&quot;category_id&quot;);</span>
<span class="nc" id="L182">						    	termData.append(rscategory.getString(&quot;category_code&quot;)+&quot;,&quot;);</span>
<span class="nc" id="L183">						    	termData.append(rscategory.getString(&quot;description&quot;)+&quot;:&quot;);  </span>
<span class="nc" id="L184">							    String productQuery=&quot;select cpm.product_id,cpm.denomination, cpm.product_code, cpm.description, cpm.operator_code, cpm.circle_code,cpd.talktime, cpd.validity, cpd.admin_fee, cpd.service_tax,cpd.recharge_instructions from st_cs_product_master cpm, st_cs_product_details cpd where cpm.status='ACTIVE' and cpm.product_id=cpd.product_id and cpm.operator_code='&quot;+operatorCode+&quot;' and cpm.circle_code='&quot;+circleCode+&quot;' and cpm.category_id=&quot;+categoryId;</span>
<span class="nc" id="L185">								PreparedStatement pstmtProduct = con.prepareStatement(productQuery);</span>
<span class="nc" id="L186">								ResultSet rsproduct = pstmtProduct.executeQuery();</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">								while(rsproduct.next()){									</span>
<span class="nc" id="L188">									termData.append(rsproduct.getString(&quot;denomination&quot;)+&quot;,&quot;);</span>
<span class="nc" id="L189">									termData.append(rsproduct.getString(&quot;talktime&quot;)+&quot;,&quot;);</span>
<span class="nc" id="L190">									termData.append(rsproduct.getString(&quot;validity&quot;)+&quot;,&quot;);</span>
<span class="nc" id="L191">									termData.append(rsproduct.getString(&quot;admin_fee&quot;)+&quot;,&quot;);</span>
<span class="nc" id="L192">									termData.append(rsproduct.getString(&quot;service_tax&quot;)+&quot;,&quot;);									</span>
<span class="nc" id="L193">									termData.append(rsproduct.getString(&quot;product_code&quot;)+&quot;,&quot;);</span>
<span class="nc" id="L194">									termData.append(rsproduct.getString(&quot;recharge_instructions&quot;));</span>
<span class="nc" id="L195">									termData.append(&quot;:&quot;);</span>
								}
<span class="nc" id="L197">								termData.deleteCharAt(termData.length()-1);</span>
<span class="nc" id="L198">								termData.append(&quot;%:&quot;);</span>
<span class="nc" id="L199">					    }</span>
<span class="nc" id="L200">					    termData.delete(termData.length()-2, termData.length()); </span>
<span class="nc" id="L201">					    termData.append(&quot;%$&quot;);</span>
<span class="nc" id="L202">					}</span>
<span class="nc" id="L203">					termData.delete(termData.length()-2, termData.length()); </span>
<span class="nc" id="L204">					termData.append(&quot;%#&quot;);</span>
<span class="nc" id="L205">				}</span>
<span class="nc" id="L206">				termData.delete(termData.length()-2, termData.length());</span>
<span class="nc" id="L207">				termData.append(&quot;|&quot;);</span>
				
<span class="nc" id="L209">		} catch (SQLException e) {</span>
			// TODO Auto-generated catch block
<span class="nc" id="L211">			e.printStackTrace();</span>
<span class="nc" id="L212">		}</span>
		
<span class="nc" id="L214">		System.out.println(termData.toString());</span>
		
<span class="nc" id="L216">		return termData.toString();</span>
	}
	
	
	
	public boolean updatePWTransId(String RMSTxId, String PWTxId, int prodId, int categoryId)throws LMSException{
<span class="nc" id="L222">		boolean status = false;</span>
<span class="nc" id="L223">		Connection con = DBConnect.getConnection();</span>
		try{
<span class="nc" id="L225">			Statement stmt = con.createStatement();</span>
<span class="nc" id="L226">			String query = &quot;update st_cs_sale_&quot;+categoryId+&quot; set cs_ref_transaction_id='&quot;+PWTxId+&quot;' where transaction_id=&quot;+RMSTxId;</span>
<span class="nc" id="L227">			logger.debug(&quot;update transaction id got from payworld: &quot;+query);</span>
<span class="nc" id="L228">			int rows = stmt.executeUpdate(query);</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">			if(rows == 1){</span>
<span class="nc" id="L230">				status = true;</span>
			}
<span class="nc" id="L232">		}catch (SQLException e) {</span>
<span class="nc" id="L233">			logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L234">			e.printStackTrace();</span>
<span class="nc" id="L235">			throw new LMSException(e);</span>
		} finally {
<span class="nc" id="L237">			try {</span>
<span class="nc bnc" id="L238" title="All 8 branches missed.">				if (con != null &amp;&amp; !con.isClosed()) {</span>
<span class="nc" id="L239">					con.close();</span>
				}
<span class="nc" id="L241">			} catch (SQLException e) {</span>
<span class="nc" id="L242">				logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L243">				e.printStackTrace();</span>
<span class="nc" id="L244">				throw new LMSException(e);</span>
<span class="nc" id="L245">			}</span>
		}
<span class="nc" id="L247">		return status;</span>
	}
	
	public String serviceDataRequest(String merchantid, String data, String circode, String loginstatus, String appver){
<span class="nc" id="L251">		Map&lt;String,String&gt; paramMap = new HashMap&lt;String,String&gt;();</span>
		
<span class="nc" id="L253">		paramMap.put(&quot;agentid&quot;,merchantid);</span>
<span class="nc" id="L254">		paramMap.put(&quot;data&quot;,data);</span>
<span class="nc" id="L255">		paramMap.put(&quot;circode&quot;,circode);</span>
<span class="nc" id="L256">		paramMap.put(&quot;loginstatus&quot;,loginstatus);</span>
<span class="nc" id="L257">		paramMap.put(&quot;appver&quot;,appver);</span>
<span class="nc" id="L258">		String respData = callPayWorld(&quot;pw_servicedata.php3&quot;, paramMap);</span>
<span class="nc" id="L259">		return respData;</span>
	}
	
	public String transStatusRequest(String spId, String clientId, String agentid, String agentPwd, String loginstatus, String service, String appver){
<span class="nc" id="L263">		Map&lt;String,String&gt; paramMap = new HashMap&lt;String,String&gt;();</span>
<span class="nc" id="L264">		paramMap.put(&quot;agentid&quot;, agentid);</span>
<span class="nc" id="L265">		paramMap.put(&quot;sp_transid&quot;, spId);</span>
<span class="nc" id="L266">		paramMap.put(&quot;client_transid&quot;, clientId);</span>
<span class="nc" id="L267">		paramMap.put(&quot;loginstatus&quot;, loginstatus);</span>
<span class="nc" id="L268">		paramMap.put(&quot;service&quot;, service);</span>
<span class="nc" id="L269">		paramMap.put(&quot;appver&quot;, appver);</span>
<span class="nc" id="L270">		paramMap.put(&quot;sp_transid&quot;, spId+&quot;&quot;);</span>
<span class="nc" id="L271">		String respData = callPayWorld(&quot;pw_gettransstatus.php3&quot;, paramMap);</span>
<span class="nc" id="L272">		logger.debug(&quot;PayWorld Sale status Response: &quot;+respData);</span>
<span class="nc" id="L273">		return respData;</span>
	}
	
	/*public Map&lt;String, Map&lt;String, Map&lt;String, Map&lt;String, Map&lt;String, Double&gt;&gt;&gt;&gt;&gt; fetchServiceDataForTerminal()throws LMSException{
		Connection con = DBConnect.getConnection();
		//operator -&gt; circle -&gt; product -&gt; denomination -&gt; detailsMap[Keys]('talktime', 'validity', 'adminFee', 'serviceTax')
		Map&lt;String, Map&lt;String, Map&lt;String, Map&lt;String, Map&lt;String, Double&gt;&gt;&gt;&gt;&gt; dataMap = new HashMap&lt;String, Map&lt;String, Map&lt;String, Map&lt;String, Map&lt;String, Double&gt;&gt;&gt;&gt;&gt;();
		String prodQuery = &quot;select cpm.product_id, cpm.product_code, cpm.description, cpm.operator_code, com.operator_name, cpm.circle_code, ccm.circle_name, cpm.denomination, cpd.talktime, cpd.validity, cpd.admin_fee, cpd.service_tax from st_cs_product_master cpm, st_cs_operator_master com , st_cs_circle_master ccm, st_cs_product_category_master ccatm, st_cs_product_details cpd where com.operator_code = cpm.operator_code and ccm.circle_code = cpm.circle_code and cpm.category_id = ccatm.category_id and cpd.product_id = cpm.product_id and cpm.status = 'ACTIVE' and cpm.product_code not like '%0%'&quot;;
		try{
			PreparedStatement pstmt = con.prepareStatement(prodQuery);
			ResultSet rs = pstmt.executeQuery();
			Map&lt;String, Map&lt;String, Map&lt;String, Map&lt;String, Double&gt;&gt;&gt;&gt; cirMap = new HashMap&lt;String, Map&lt;String, Map&lt;String, Map&lt;String, Double&gt;&gt;&gt;&gt;();
			Map&lt;String, Map&lt;String, Map&lt;String, Double&gt;&gt;&gt; prodMap = new HashMap&lt;String, Map&lt;String, Map&lt;String, Double&gt;&gt;&gt;();
			Map&lt;String, Map&lt;String, Double&gt;&gt; denoMap = new HashMap&lt;String, Map&lt;String, Double&gt;&gt;();
			Map&lt;String, Double&gt; detailMap = new HashMap&lt;String, Double&gt;();
			Map&lt;String, Map&lt;String, Map&lt;String, Map&lt;String, Double&gt;&gt;&gt;&gt; cirMap = null;
			Map&lt;String, Map&lt;String, Map&lt;String, Double&gt;&gt;&gt; prodMap = null;
			Map&lt;String, Map&lt;String, Double&gt;&gt; denoMap = null;
			Map&lt;String, Double&gt; detailMap = null;
			while(rs.next()){
				detailMap.put(&quot;talktime&quot;, rs.getDouble(&quot;talktime&quot;));
				detailMap.put(&quot;validity&quot;, rs.getDouble(&quot;validity&quot;));
				detailMap.put(&quot;adminFee&quot;, rs.getDouble(&quot;admin_fee&quot;));
				detailMap.put(&quot;serviceTax&quot;, rs.getDouble(&quot;service_tax&quot;));
				denoMap.put(rs.getString(&quot;denomination&quot;), detailMap);
				prodMap.put(rs.getString(&quot;product_code&quot;)+&quot;_&quot;+rs.getString(&quot;description&quot;), denoMap);
				cirMap.put(rs.getString(&quot;circle_code&quot;)+&quot;_&quot;+rs.getString(&quot;circle_name&quot;),prodMap);
				dataMap.put(rs.getString(&quot;operator_code&quot;)+&quot;_&quot;+rs.getString(&quot;operator_name&quot;), cirMap);
				detailMap = new HashMap&lt;String, Double&gt;();
				detailMap.put(&quot;talktime&quot;, rs.getDouble(&quot;talktime&quot;));
				detailMap.put(&quot;validity&quot;, rs.getDouble(&quot;validity&quot;));
				detailMap.put(&quot;adminFee&quot;, rs.getDouble(&quot;admin_fee&quot;));
				detailMap.put(&quot;serviceTax&quot;, rs.getDouble(&quot;service_tax&quot;));
				if(dataMap.get(rs.getString(&quot;operator_code&quot;)+&quot;_&quot;+rs.getString(&quot;operator_name&quot;)) == null){
					denoMap = new HashMap&lt;String, Map&lt;String, Double&gt;&gt;();
					prodMap = new HashMap&lt;String, Map&lt;String, Map&lt;String, Double&gt;&gt;&gt;();
					cirMap = new HashMap&lt;String, Map&lt;String, Map&lt;String, Map&lt;String, Double&gt;&gt;&gt;&gt;();
					
					denoMap.put(rs.getString(&quot;denomination&quot;), detailMap);
					prodMap.put(rs.getString(&quot;product_code&quot;)+&quot;_&quot;+rs.getString(&quot;description&quot;), denoMap);
					cirMap.put(rs.getString(&quot;circle_code&quot;)+&quot;_&quot;+rs.getString(&quot;circle_name&quot;), prodMap);
					dataMap.put(rs.getString(&quot;operator_code&quot;)+&quot;_&quot;+rs.getString(&quot;operator_name&quot;), cirMap);
				}else{
						denoMap = new HashMap&lt;String, Map&lt;String, Double&gt;&gt;();
					if(cirMap.get(rs.getString(&quot;circle_code&quot;)+&quot;_&quot;+rs.getString(&quot;circle_name&quot;)) == null){
						prodMap = new HashMap&lt;String, Map&lt;String, Map&lt;String, Double&gt;&gt;&gt;();
						
						denoMap.put(rs.getString(&quot;denomination&quot;), detailMap);
						prodMap.put(rs.getString(&quot;product_code&quot;)+&quot;_&quot;+rs.getString(&quot;description&quot;), denoMap);
						cirMap.put(rs.getString(&quot;circle_code&quot;)+&quot;_&quot;+rs.getString(&quot;circle_name&quot;), prodMap);
						dataMap.put(rs.getString(&quot;operator_code&quot;)+&quot;_&quot;+rs.getString(&quot;operator_name&quot;), cirMap);
					}else{
						prodMap = new HashMap&lt;String, Map&lt;String, Map&lt;String, Double&gt;&gt;&gt;();
						if(prodMap.get(rs.getString(&quot;product_code&quot;)+&quot;_&quot;+rs.getString(&quot;description&quot;)) == null){
							
							denoMap.put(rs.getString(&quot;denomination&quot;), detailMap);
							prodMap.put(rs.getString(&quot;product_code&quot;)+&quot;_&quot;+rs.getString(&quot;description&quot;), denoMap);
							cirMap.put(rs.getString(&quot;circle_code&quot;)+&quot;_&quot;+rs.getString(&quot;circle_name&quot;), prodMap);
							dataMap.put(rs.getString(&quot;operator_code&quot;)+&quot;_&quot;+rs.getString(&quot;operator_name&quot;), cirMap);
						}else{
							
							cirMap = new HashMap&lt;String, Map&lt;String, Map&lt;String, Map&lt;String, Double&gt;&gt;&gt;&gt;();
							if(denoMap.get(rs.getString(&quot;denomination&quot;)) == null){
								
								denoMap.put(rs.getString(&quot;denomination&quot;), detailMap);
								prodMap.put(rs.getString(&quot;product_code&quot;)+&quot;_&quot;+rs.getString(&quot;description&quot;), denoMap);
								cirMap.put(rs.getString(&quot;circle_code&quot;)+&quot;_&quot;+rs.getString(&quot;circle_name&quot;), prodMap);
								dataMap.put(rs.getString(&quot;operator_code&quot;)+&quot;_&quot;+rs.getString(&quot;operator_name&quot;), cirMap);
							}
						}
					}
					
				}
			}
		}catch (SQLException e) {
			logger.error(&quot;Exception: &quot; + e);
			e.printStackTrace();
			throw new LMSException(e);
		} finally {
			try {
				if (con != null &amp;&amp; !con.isClosed()) {
					con.close();
				}
			} catch (SQLException e) {
				logger.error(&quot;Exception: &quot; + e);
				e.printStackTrace();
				throw new LMSException(e);
			}
		}
		logger.debug(&quot;the service data map: &quot;+dataMap);
		return dataMap;
	}*/
	
	public Map&lt;String, Map&lt;String, Map&lt;String, Map&lt;String, Map&lt;String, String&gt;&gt;&gt;&gt;&gt; fetchServiceDataForTerminal()throws LMSException{
<span class="nc" id="L367">		Connection con = DBConnect.getConnection();</span>
		//operator -&gt; circle -&gt; product -&gt; denomination -&gt; detailsMap[Keys]('talktime', 'validity', 'adminFee', 'serviceTax')
<span class="nc" id="L369">		Map&lt;String, Map&lt;String, Map&lt;String, Map&lt;String, Map&lt;String, String&gt;&gt;&gt;&gt;&gt; dataMap = new HashMap&lt;String, Map&lt;String, Map&lt;String, Map&lt;String, Map&lt;String, String&gt;&gt;&gt;&gt;&gt;();</span>
<span class="nc" id="L370">		String prodQuery = &quot;select cpm.product_id, cpm.product_code, cpm.description, cpm.operator_code, com.operator_name, cpm.circle_code, ccm.circle_name, cpm.denomination, cpd.talktime, cpd.validity, cpd.admin_fee, cpd.service_tax from st_cs_product_master cpm, st_cs_operator_master com , st_cs_circle_master ccm, st_cs_product_category_master ccatm, st_cs_product_details cpd where com.operator_code = cpm.operator_code and ccm.circle_code = cpm.circle_code and cpm.category_id = ccatm.category_id and cpd.product_id = cpm.product_id and cpm.status = 'ACTIVE'&quot;;</span>
		try{
<span class="nc" id="L372">			PreparedStatement pstmt = con.prepareStatement(prodQuery);</span>
<span class="nc" id="L373">			ResultSet rs = pstmt.executeQuery();</span>
<span class="nc" id="L374">			Map&lt;String, Map&lt;String, Map&lt;String, Map&lt;String, String&gt;&gt;&gt;&gt; cirMap = null;</span>
<span class="nc" id="L375">			Map&lt;String, Map&lt;String, Map&lt;String, String&gt;&gt;&gt; prodMap = null;</span>
<span class="nc" id="L376">			Map&lt;String, Map&lt;String, String&gt;&gt; denoMap = null;</span>
<span class="nc" id="L377">			Map&lt;String, String&gt; detailMap = null;</span>
<span class="nc bnc" id="L378" title="All 2 branches missed.">			while(rs.next()){</span>
<span class="nc" id="L379">				detailMap = new LinkedHashMap&lt;String, String&gt;();</span>
<span class="nc" id="L380">				detailMap.put(&quot;talktime&quot;, rs.getString(&quot;talktime&quot;));</span>
<span class="nc" id="L381">				detailMap.put(&quot;validity&quot;, rs.getString(&quot;validity&quot;));</span>
<span class="nc" id="L382">				detailMap.put(&quot;adminFee&quot;, rs.getString(&quot;admin_fee&quot;));</span>
<span class="nc" id="L383">				detailMap.put(&quot;serviceTax&quot;, rs.getString(&quot;service_tax&quot;));</span>
<span class="nc bnc" id="L384" title="All 2 branches missed.">				if((cirMap = dataMap.get(rs.getString(&quot;operator_code&quot;)+&quot;_&quot;+rs.getString(&quot;operator_name&quot;))) == null){</span>
<span class="nc" id="L385">					denoMap = new HashMap&lt;String, Map&lt;String, String&gt;&gt;();</span>
<span class="nc" id="L386">					prodMap = new HashMap&lt;String, Map&lt;String, Map&lt;String, String&gt;&gt;&gt;();</span>
<span class="nc" id="L387">					cirMap = new HashMap&lt;String, Map&lt;String, Map&lt;String, Map&lt;String, String&gt;&gt;&gt;&gt;();</span>
					
<span class="nc" id="L389">					dataMap.put(rs.getString(&quot;operator_code&quot;)+&quot;_&quot;+rs.getString(&quot;operator_name&quot;), cirMap);</span>
<span class="nc" id="L390">					cirMap.put(rs.getString(&quot;circle_code&quot;)+&quot;_&quot;+rs.getString(&quot;circle_name&quot;), prodMap);</span>
<span class="nc" id="L391">					prodMap.put(rs.getString(&quot;product_code&quot;)+&quot;_&quot;+rs.getString(&quot;description&quot;), denoMap);</span>
<span class="nc" id="L392">					denoMap.put(rs.getString(&quot;denomination&quot;), detailMap);</span>
				}else{					
<span class="nc bnc" id="L394" title="All 2 branches missed.">					if((prodMap = cirMap.get(rs.getString(&quot;circle_code&quot;)+&quot;_&quot;+rs.getString(&quot;circle_name&quot;))) == null){</span>
<span class="nc" id="L395">						denoMap = new HashMap&lt;String, Map&lt;String, String&gt;&gt;();</span>
<span class="nc" id="L396">						prodMap = new HashMap&lt;String, Map&lt;String, Map&lt;String, String&gt;&gt;&gt;();</span>
						
<span class="nc" id="L398">						cirMap.put(rs.getString(&quot;circle_code&quot;)+&quot;_&quot;+rs.getString(&quot;circle_name&quot;), prodMap);</span>
<span class="nc" id="L399">						prodMap.put(rs.getString(&quot;product_code&quot;)+&quot;_&quot;+rs.getString(&quot;description&quot;), denoMap);</span>
<span class="nc" id="L400">						denoMap.put(rs.getString(&quot;denomination&quot;), detailMap);				</span>
												
					}else{
						
<span class="nc bnc" id="L404" title="All 2 branches missed.">						if((denoMap = prodMap.get(rs.getString(&quot;product_code&quot;)+&quot;_&quot;+rs.getString(&quot;description&quot;))) == null){</span>
<span class="nc" id="L405">							denoMap = new HashMap&lt;String, Map&lt;String, String&gt;&gt;();</span>
							
<span class="nc" id="L407">							prodMap.put(rs.getString(&quot;product_code&quot;)+&quot;_&quot;+rs.getString(&quot;description&quot;), denoMap);</span>
<span class="nc" id="L408">							denoMap.put(rs.getString(&quot;denomination&quot;), detailMap);</span>
						}else{
<span class="nc bnc" id="L410" title="All 2 branches missed.">							if(denoMap.get(rs.getString(&quot;denomination&quot;)) == null){								</span>
<span class="nc" id="L411">								denoMap.put(rs.getString(&quot;denomination&quot;), detailMap);								</span>
							}
						}
					}
					
				}
			}
<span class="nc" id="L418">		}catch (SQLException e) {</span>
<span class="nc" id="L419">			logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L420">			e.printStackTrace();</span>
<span class="nc" id="L421">			throw new LMSException(e);</span>
		} finally {
<span class="nc" id="L423">			try {</span>
<span class="nc bnc" id="L424" title="All 8 branches missed.">				if (con != null &amp;&amp; !con.isClosed()) {</span>
<span class="nc" id="L425">					con.close();</span>
				}
<span class="nc" id="L427">			} catch (SQLException e) {</span>
<span class="nc" id="L428">				logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L429">				e.printStackTrace();</span>
<span class="nc" id="L430">				throw new LMSException(e);</span>
<span class="nc" id="L431">			}</span>
		}
<span class="nc" id="L433">		logger.debug(&quot;the service data map: &quot;+dataMap);</span>
<span class="nc" id="L434">		return dataMap;</span>
	}
	
	public static void serviceDataScheduler(String merchantId, String loginStatus, String appVer)throws LMSException{
<span class="nc" id="L438">		Connection con = DBConnect.getConnection();</span>
		//To Fill Operator Table and Circle Table
<span class="nc" id="L440">		PayWorldHelper pwhelper = new PayWorldHelper();</span>
<span class="nc" id="L441">		Map&lt;String, String&gt; operatorMap = new TreeMap&lt;String, String&gt;();</span>
<span class="nc" id="L442">		Map&lt;String, String&gt; circleMap = new TreeMap&lt;String, String&gt;();</span>
<span class="nc" id="L443">		Map&lt;String ,String&gt; prodMap = new TreeMap&lt;String, String&gt;();</span>
<span class="nc" id="L444">		Map&lt;String, Map&lt;String, String&gt;&gt; allMap = new TreeMap&lt;String, Map&lt;String, String&gt;&gt;();</span>
		
<span class="nc" id="L446">		String operatorData = pwhelper.serviceDataRequest(merchantId, &quot;operator&quot;, &quot;*&quot;, loginStatus, appVer);</span>
<span class="nc" id="L447">		String circleData = pwhelper.serviceDataRequest(merchantId, &quot;circle&quot;, &quot;*&quot;, loginStatus, appVer);</span>
<span class="nc" id="L448">		String prodData = pwhelper.serviceDataRequest(merchantId, &quot;product&quot;, &quot;*&quot;, loginStatus, appVer);</span>
<span class="nc" id="L449">		String allData = pwhelper.serviceDataRequest(merchantId, &quot;all&quot;, &quot;*&quot;, loginStatus, appVer);</span>
<span class="nc bnc" id="L450" title="All 8 branches missed.">		if((operatorData.indexOf(&quot;ERROR&quot;)!= -1)||(circleData.indexOf(&quot;ERROR&quot;)!= -1)||(prodData.indexOf(&quot;ERROR&quot;)!= -1)||(allData.indexOf(&quot;ERROR&quot;)!= -1)){</span>
<span class="nc" id="L451">			return;</span>
		}
<span class="nc" id="L453">		String[] strArr = operatorData.split(&quot;&lt;BR&gt;&quot;);</span>
<span class="nc bnc" id="L454" title="All 2 branches missed.">		  for(int i=0 ;i&lt;strArr.length; i++){</span>
<span class="nc" id="L455">			  String[] optrDataArr = strArr[i].split(&quot;%\\$&quot;);</span>
<span class="nc bnc" id="L456" title="All 2 branches missed.">			  if(i==strArr.length-1){</span>
<span class="nc" id="L457">				  operatorMap.put(optrDataArr[0],optrDataArr[1].substring(0, optrDataArr[1].length()-3));</span>
			  }else{
<span class="nc" id="L459">				  operatorMap.put(optrDataArr[0],optrDataArr[1]);</span>
			  }
		  }
<span class="nc bnc" id="L462" title="All 2 branches missed.">		  if(&quot;Y&quot;.equalsIgnoreCase(circleData.split(&quot;\\*!&quot;)[0])){</span>
<span class="nc" id="L463">			  LMSFilterDispatcher.cs_isShowCircle = &quot;YES&quot;;</span>
		  }
<span class="nc bnc" id="L465" title="All 2 branches missed.">		  else if(&quot;N&quot;.equalsIgnoreCase(circleData.split(&quot;\\*!&quot;)[0])){</span>
<span class="nc" id="L466">			  LMSFilterDispatcher.cs_isShowCircle = &quot;NO&quot;;</span>
		  }
<span class="nc" id="L468">		strArr = circleData.split(&quot;\\*!&quot;)[1].split(&quot;&lt;BR&gt;&quot;);</span>
<span class="nc bnc" id="L469" title="All 2 branches missed.">		  for(int i=0 ;i&lt;strArr.length; i++){</span>
<span class="nc" id="L470">			  String[] cirDataArr = strArr[i].split(&quot;%\\$&quot;);</span>
<span class="nc bnc" id="L471" title="All 2 branches missed.">			  if(i==strArr.length-1){</span>
<span class="nc" id="L472">				  circleMap.put(cirDataArr[0],cirDataArr[1].substring(0, cirDataArr[1].length()-3));</span>
			  }else{
<span class="nc" id="L474">				  circleMap.put(cirDataArr[0],cirDataArr[1]);</span>
			  }
		  }
<span class="nc" id="L477">		  strArr = prodData.split(&quot;&lt;BR&gt;&quot;);</span>
<span class="nc bnc" id="L478" title="All 2 branches missed.">		  for(int i=0 ;i&lt;strArr.length; i++){</span>
<span class="nc" id="L479">			  String[] prodDataArr = strArr[i].split(&quot;%\\$&quot;);</span>
<span class="nc bnc" id="L480" title="All 2 branches missed.">			  if(i==strArr.length-1){</span>
<span class="nc" id="L481">				  prodMap.put(prodDataArr[1],prodDataArr[2]);</span>
			  }else{
<span class="nc" id="L483">				  prodMap.put(prodDataArr[1],prodDataArr[2]);</span>
			  }
		  }
<span class="nc" id="L486">		  strArr = allData.split(&quot;&lt;BR&gt;&quot;);</span>
<span class="nc bnc" id="L487" title="All 2 branches missed.">		  for(int i=0 ;i&lt;strArr.length; i++){</span>
<span class="nc" id="L488">			  String[] allDataArr = strArr[i].split(&quot;%\\$&quot;);</span>
<span class="nc" id="L489">			  Map&lt;String, String&gt; tempMap = new HashMap&lt;String, String&gt;();</span>
<span class="nc" id="L490">			  tempMap.put(&quot;talktime&quot;, allDataArr[4]);</span>
<span class="nc" id="L491">			  tempMap.put(&quot;validity&quot;, allDataArr[5]);</span>
<span class="nc" id="L492">			  tempMap.put(&quot;adminfee&quot;, allDataArr[6]);</span>
<span class="nc bnc" id="L493" title="All 2 branches missed.">			  if(i==strArr.length-1){</span>
<span class="nc" id="L494">				  tempMap.put(&quot;servicetax&quot;, allDataArr[7].substring(0, allDataArr[7].length()-3));</span>
			  }else{
<span class="nc" id="L496">				  tempMap.put(&quot;servicetax&quot;, allDataArr[7]);</span>
			  }
<span class="nc" id="L498">			  allMap.put(allDataArr[0]+&quot;_&quot;+allDataArr[1]+&quot;_&quot;+allDataArr[2]+&quot;_&quot;+allDataArr[3],tempMap);</span>
			  //operatorcode_circode_product_denomination
		  }
		  try{
<span class="nc" id="L502">			  con.setAutoCommit(false);</span>
			  //update circle master
<span class="nc" id="L504">			  Statement stmt = con.createStatement();</span>
<span class="nc" id="L505">			  stmt.executeUpdate(new StringBuilder(&quot;update st_cs_circle_master set status = 'INACTIVE' where circle_code not in (&quot;+ Util.convertCollToStr(circleMap.keySet()) +&quot;)&quot;).toString().replaceAll(&quot;\\*&quot;, &quot;'*'&quot;));</span>
			  //select from circle master
<span class="nc" id="L507">			  PreparedStatement pstmt = con.prepareStatement(&quot;select circle_code from st_cs_circle_master where status = 'ACTIVE'&quot;);</span>
<span class="nc" id="L508">			  ResultSet rs = pstmt.executeQuery();</span>
<span class="nc" id="L509">			  List&lt;String&gt; cirCodeList = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L510" title="All 2 branches missed.">			  while(rs.next()){</span>
<span class="nc" id="L511">				  cirCodeList.add(rs.getString(&quot;circle_code&quot;));</span>
			  }
<span class="nc" id="L513">			  pstmt.close();</span>
<span class="nc" id="L514">			  rs.close();</span>
			  //insert into circle master
<span class="nc" id="L516">			  StringBuilder insCircleMaster =  new StringBuilder(&quot;insert into st_cs_circle_master values&quot;);</span>
<span class="nc" id="L517">			  int i = 0;</span>
<span class="nc bnc" id="L518" title="All 2 branches missed.">			  for(String cirCode : circleMap.keySet()){</span>
<span class="nc bnc" id="L519" title="All 2 branches missed.">				  if(!cirCodeList.contains(cirCode) ){</span>
<span class="nc" id="L520">					  i++;</span>
<span class="nc" id="L521">					  insCircleMaster.append(&quot;('&quot;+cirCode+&quot;','&quot;+circleMap.get(cirCode)+&quot;','ACTIVE'),&quot;);</span>
				  }
<span class="nc" id="L523">			  }</span>
<span class="nc bnc" id="L524" title="All 2 branches missed.">			  if(i&gt;0){</span>
<span class="nc" id="L525">				  stmt.executeUpdate(insCircleMaster.substring(0, insCircleMaster.length()-1));</span>
			  }
			  
			  //update operator master
<span class="nc" id="L529">			  stmt.executeUpdate(new StringBuilder(&quot;update st_cs_operator_master set status = 'INACTIVE' where operator_code not in(&quot;+ Util.convertCollToStr(operatorMap.keySet()) +&quot;)&quot;).toString().replaceAll(&quot;\\*&quot;, &quot;'*'&quot;));</span>
			  //select from operator master
<span class="nc" id="L531">			  pstmt = con.prepareStatement(&quot;select operator_code from st_cs_operator_master where status = 'ACTIVE'&quot;);</span>
<span class="nc" id="L532">			  rs = pstmt.executeQuery();</span>
<span class="nc" id="L533">			  List&lt;String&gt; optrCodeList = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L534" title="All 2 branches missed.">			  while(rs.next()){</span>
<span class="nc" id="L535">				  optrCodeList.add(rs.getString(&quot;operator_code&quot;));</span>
			  }
<span class="nc" id="L537">			  pstmt.close();</span>
<span class="nc" id="L538">			  rs.close();</span>
			  //insert into circle master
<span class="nc" id="L540">			  StringBuilder insOptrMaster =  new StringBuilder(&quot;insert into st_cs_operator_master values&quot;);</span>
<span class="nc" id="L541">			  i = 0;</span>
<span class="nc bnc" id="L542" title="All 2 branches missed.">			  for(String optrCode : operatorMap.keySet()){</span>
<span class="nc bnc" id="L543" title="All 2 branches missed.">				  if(!optrCodeList.contains(optrCode) ){</span>
<span class="nc" id="L544">					  i++;</span>
<span class="nc" id="L545">					  insOptrMaster.append(&quot;('&quot;+optrCode+&quot;','&quot;+operatorMap.get(optrCode)+&quot;','ACTIVE'),&quot;);</span>
				  }
<span class="nc" id="L547">			  }</span>
<span class="nc bnc" id="L548" title="All 2 branches missed.">			  if(i&gt;0){</span>
<span class="nc" id="L549">				  stmt.executeUpdate(insOptrMaster.substring(0, insOptrMaster.length()-1));</span>
			  }
			  //This code below is for filling st_cs_product_master automatically from payworld 
			/*//update product name master
			  stmt = con.createStatement();
			  StringBuilder temp = new StringBuilder(&quot;update st_cs_product_name_master set status = 'INACTIVE' where product_code not in (&quot;);
			  for(String tt : prodMap.keySet()){
				  temp.append(&quot;'&quot;+ tt +&quot;',&quot;);
			  }
			  stmt.executeUpdate(temp.toString().substring(0,temp.toString().length()-1)+&quot;)&quot;);
			  //select from product name master
			  pstmt = con.prepareStatement(&quot;select product_code from st_cs_product_name_master where status = 'ACTIVE'&quot;);
			  rs = pstmt.executeQuery();
			  List&lt;String&gt; prodCodeList = new ArrayList&lt;String&gt;();
			  while(rs.next()){
				  prodCodeList.add(rs.getString(&quot;product_code&quot;));
			  }
			  pstmt.close();
			  rs.close();
			  //insert into product name master
			  StringBuilder insProdNameMaster =  new StringBuilder(&quot;insert into st_cs_product_name_master values &quot;);
			  i = 0;
			  for(String prodCode : prodMap.keySet()){
				  if(!prodCodeList.contains(prodCode) ){
					  i++;
					  insProdNameMaster.append(&quot;('&quot;+prodCode+&quot;','&quot;+prodMap.get(prodCode)+&quot;','ACTIVE'),&quot;);
				  }
			  }
			  if(i&gt;0){
				  stmt.executeUpdate(insProdNameMaster.substring(0, insProdNameMaster.length()-1));
			  }
			  
			  //update product master
			 StringBuilder updtProdMaster = new StringBuilder(&quot;update st_cs_product_master set status='INACTIVE' where &quot;);
			  Set&lt;String&gt; prCd = new TreeSet&lt;String&gt;();
			  Set&lt;String&gt; optrCd = new TreeSet&lt;String&gt;();
			  Set&lt;String&gt; cirCd = new TreeSet&lt;String&gt;();
			  Set&lt;String&gt; deno = new TreeSet&lt;String&gt;();
			  StringBuilder prCdStr = new StringBuilder();
			  StringBuilder denoStr = new StringBuilder();
			  StringBuilder cirCdStr = new StringBuilder();
			  for(String prodCandidKey : allMap.keySet()){
				  String arr[] = prodCandidKey.split(&quot;_&quot;);
				  optrCd.add(arr[0]);
				  cirCd.add(arr[1]);
				  prCd.add(arr[2]);
				  deno.add(arr[3]);
			  }
			  for(String cirCode: cirCd){
				  cirCdStr.append(&quot;'&quot;+ cirCode +&quot;',&quot;);
			  }
			  for(String prcdCode: prCd){
				  prCdStr.append(&quot;'&quot;+ prcdCode +&quot;',&quot;);
			  }
			  for(String denoCode: deno){
				  denoStr.append(&quot;'&quot;+ denoCode +&quot;',&quot;);
			  }
			  updtProdMaster.append(&quot;product_code not in (&quot;+ prCdStr.substring(0, prCdStr.length()-1) +&quot;)&quot;);
			  updtProdMaster.append(&quot; and &quot;);
			  updtProdMaster.append(&quot;operator_code not in (&quot;+ Util.convertCollToStr(optrCd) +&quot;)&quot;);
			  updtProdMaster.append(&quot; and &quot;);
			  updtProdMaster.append(&quot;circle_code not in (&quot;+ cirCdStr.substring(0, cirCdStr.length()-1) +&quot;)&quot;);
			  updtProdMaster.append(&quot; and &quot;);
			  updtProdMaster.append(&quot;denomination not in (&quot;+ denoStr.substring(0, denoStr.length()-1) +&quot;)&quot;);
			  System.out.println(&quot;update product status query: &quot;+updtProdMaster.toString());
			  stmt.executeUpdate(updtProdMaster.toString());
			  
			  //select product master
			  pstmt = con.prepareStatement(&quot;select product_id, operator_code, circle_code, product_code, denomination from st_cs_product_master where status = 'ACTIVE'&quot;);
			  rs = pstmt.executeQuery();
			  List&lt;String&gt; tempProdList = new ArrayList&lt;String&gt;();
			  while(rs.next()){
				  tempProdList.add(rs.getString(&quot;operator_code&quot;)+&quot;_&quot;+rs.getString(&quot;circle_code&quot;)+&quot;_&quot;+rs.getString(&quot;product_code&quot;)+&quot;_&quot;+rs.getString(&quot;denomination&quot;));
			  }
			  pstmt.close();
			  rs.close();
			  System.out.println(&quot;All Map is: &quot;+allMap.size());
			//insert into product master
			  StringBuilder insProdMaster =  new StringBuilder(&quot;insert into st_cs_product_master (product_code,category_id,description,operator_code,circle_code,denomination,country_code,supplier_name,unit_price,retailer_comm,agent_comm,jv_comm,good_cause_comm,vat_comm,status) values&quot;);
			  StringBuilder insProdDetails = new StringBuilder(&quot;insert into st_cs_product_details (product_id,talktime,validity,admin_fee,service_tax) values &quot;);
			  i = 0;
			  int j=0;
			  for(String prodCandidKey : allMap.keySet()){
				  if(!tempProdList.contains(prodCandidKey) ){
					  i++;
					  insProdMaster.append(&quot;('&quot;+prodCandidKey.split(&quot;_&quot;)[2]+&quot;',7,'&quot;+ prodMap.get(prodCandidKey.split(&quot;_&quot;)[2]) +&quot;','&quot;+ prodCandidKey.split(&quot;_&quot;)[0] +&quot;','&quot;+ prodCandidKey.split(&quot;_&quot;)[1] +&quot;','&quot;+ prodCandidKey.split(&quot;_&quot;)[3] +&quot;','KEN','PW','&quot;+ prodCandidKey.split(&quot;_&quot;)[3] +&quot;',0,0,0,0,0,'ACTIVE'),&quot;);
				  }
			  }
			  insOptrMaster.length();
			  if(i&gt;0){
				  System.out.println(&quot;product master insert query: &quot;+insProdMaster.substring(0, insProdMaster.length()-1));
				  stmt.executeUpdate(insProdMaster.substring(0, insProdMaster.length()-1));
				  rs = stmt.getGeneratedKeys();
				  Set&lt;String&gt; s = allMap.keySet();
				  Iterator&lt;String&gt; it = s.iterator();
				  while(rs.next() &amp;&amp; it.hasNext()){
					  j++;
					  String oldKey = it.next(); 
					  insProdDetails.append(&quot;(&quot;+ rs.getInt(1) +&quot;,&quot;+ allMap.get(oldKey).get(&quot;talktime&quot;) +&quot;,&quot;+ allMap.get(oldKey).get(&quot;validity&quot;) +&quot;,&quot;+ allMap.get(oldKey).get(&quot;adminfee&quot;) +&quot;,&quot;+ allMap.get(oldKey).get(&quot;servicetax&quot;) +&quot;),&quot;);
				  }
				  System.out.println(&quot;product details query: &quot;+insProdDetails.substring(0, insProdDetails.length()-1));
				  stmt.executeUpdate(insProdDetails.substring(0, insProdDetails.length()-1));
			  }*/
<span class="nc" id="L652">			  con.commit();</span>
			  
<span class="nc" id="L654">		  }catch (SQLException e) {</span>
<span class="nc" id="L655">				logger.error(&quot;Exception: &quot; + e);</span>
				try{
<span class="nc" id="L657">					con.rollback();</span>
<span class="nc" id="L658">				}catch(SQLException er){</span>
<span class="nc" id="L659">					er.printStackTrace();</span>
<span class="nc" id="L660">				}</span>
<span class="nc" id="L661">				e.printStackTrace();</span>
<span class="nc" id="L662">				throw new LMSException(e);</span>
			} finally {
<span class="nc" id="L664">				try {</span>
<span class="nc bnc" id="L665" title="All 8 branches missed.">					if (con != null &amp;&amp; !con.isClosed()) {</span>
<span class="nc" id="L666">						con.close();</span>
					}
<span class="nc" id="L668">				} catch (SQLException e) {</span>
<span class="nc" id="L669">					logger.error(&quot;Exception: &quot; + e);</span>
<span class="nc" id="L670">					e.printStackTrace();</span>
<span class="nc" id="L671">					throw new LMSException(e);</span>
<span class="nc" id="L672">				}</span>
			}
<span class="nc" id="L674">	}</span>
	
	public static String callPayWorld(String phpName,Map&lt;String,String&gt; paramMap)
    {
	 try {					
		
<span class="nc" id="L680">		 StringBuilder urlStr = new StringBuilder(&quot;&quot;);</span>
<span class="nc" id="L681">		 Set&lt;String&gt; paramSet =paramMap.keySet();</span>
<span class="nc bnc" id="L682" title="All 2 branches missed.">		 for (String paramName : paramSet) {</span>
<span class="nc" id="L683">			 urlStr.append(paramName+&quot;=&quot;+paramMap.get(paramName)+&quot;&amp;&quot;);</span>
<span class="nc" id="L684">		}</span>
<span class="nc" id="L685">		 urlStr.deleteCharAt(urlStr.length()-1);</span>
<span class="nc" id="L686">		 	String address = (String)LMSUtility.sc.getAttribute(&quot;PW_PAYWORLD_SERVER_PATH&quot;);</span>
		 	//String address = &quot;http://192.168.126.7:8181/zim/mainlinkpos/purchase/&quot;;
			//String encodedAsdress = URLEncoder.encode(address, &quot;UTF-8&quot;);
<span class="nc" id="L689">			 address = address+phpName;</span>
<span class="nc" id="L690">			 URL url = new URL(address);</span>
<span class="nc" id="L691">			logger.debug(&quot;Calling Payword URL: &quot;+url); 			</span>
<span class="nc" id="L692">			HttpURLConnection conn = (HttpURLConnection)url.openConnection();</span>
			//URLConnection conn = url.openConnection();
<span class="nc" id="L694">			conn.setRequestMethod(&quot;POST&quot;);</span>
<span class="nc" id="L695">			conn.setDoOutput(true);</span>
<span class="nc" id="L696">			OutputStreamWriter wr = new OutputStreamWriter(conn</span>
					.getOutputStream());
<span class="nc" id="L698">			wr.write(urlStr.toString());</span>
<span class="nc" id="L699">			wr.flush();</span>
			
<span class="nc bnc" id="L701" title="All 4 branches missed.">			if(conn.getResponseCode() == 408 || conn.getResponseCode() == 404){</span>
<span class="nc" id="L702">				return &quot;#ERROR:No Response From Host&quot;;</span>
			}
						
<span class="nc" id="L705">			BufferedReader in = new BufferedReader(new InputStreamReader(conn.getInputStream()));</span>
			
			// Get the response				
<span class="nc" id="L708">			StringBuffer result = new StringBuffer();</span>
			String line;
<span class="nc bnc" id="L710" title="All 2 branches missed.">			while ((line = in.readLine()) != null)</span>
			{
<span class="nc" id="L712">				result.append(line);</span>
			}		
<span class="nc" id="L714">			in.close();			</span>
<span class="nc" id="L715">			return result.toString();</span>

<span class="nc" id="L717">		} catch (Exception e) {</span>
<span class="nc" id="L718">			System.out.println(&quot;inside exception &quot;);</span>
<span class="nc" id="L719">			e.printStackTrace();</span>
<span class="nc" id="L720">			return &quot;ERROR&quot;;</span>
		}
    }
	
	public String formatRespForSMS(String rawResp){
<span class="nc" id="L725">		String formatedResp = rawResp;</span>
<span class="nc" id="L726">		return formatedResp;</span>
	}
	
	public static void main(String[] agrs)throws LMSException{
		/*String str = new PayWorldHelper().serviceDataRequest(&quot;1&quot;, &quot;all&quot;, &quot;3&quot;, &quot;LIVE&quot;, &quot;3.33&quot;);
		String[] strArr = str.split(&quot;&lt;BR&gt;&quot;);
		  for(int i=0 ;i&lt;strArr.length; i++){
			  String[] prodDataArr = strArr[i].split(&quot;%\\$&quot;);
			  for(int j=0; j&lt;prodDataArr.length; j++){
				  System.out.print(&quot; &quot;+ prodDataArr[j]+ &quot; &quot;);
			  }
			  System.out.println(&quot;&quot;);
		  }*/
		//System.out.println((new PayWorldHelper()).transStatusRequest(&quot;&quot;, &quot;62&quot;, &quot;1&quot;, &quot;&quot;, &quot;LIVE&quot;, &quot;PIN&quot;, &quot;3.33&quot;));
<span class="nc" id="L740">		serviceDataScheduler(&quot;1&quot;, &quot;LIVE&quot;, &quot;3.34&quot;);</span>
<span class="nc" id="L741">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>