<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AgentOrderProcessHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lms</a> &gt; <a href="index.source.html" class="el_package">com.skilrock.lms.coreEngine.scratchService.inventoryMgmt.common</a> &gt; <span class="el_source">AgentOrderProcessHelper.java</span></div><h1>AgentOrderProcessHelper.java</h1><pre class="source lang-java linenums">/*
 * ï¿½ copyright 2007, SkilRock Technologies, A division of Sugal &amp; Damani Lottery Agency Pvt. Ltd.
 * All Rights Reserved
 * The contents of this file are the property of Sugal &amp; Damani Lottery Agency Pvt. Ltd.
 * and are subject to a License agreement with Sugal &amp; Damani Lottery Agency Pvt. Ltd.; you may
 * not use this file except in compliance with that License.  You may obtain a
 * copy of that license from:
 * Legal Department
 * Sugal &amp; Damani Lottery Agency Pvt. Ltd.
 * 6/35,WEA, Karol Bagh,
 * New Delhi
 * India - 110005
 * This software is distributed under the License and is provided on an ï¿½AS ISï¿½
 * basis, without warranty of any kind, either express or implied, unless
 * otherwise provided in the License.  See the License for governing rights and
 * limitations under the License.
 */

package com.skilrock.lms.coreEngine.scratchService.inventoryMgmt.common;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.text.DateFormat;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Set;

import com.skilrock.lms.GameContants;
import com.skilrock.lms.beans.AgentOrderBean;
import com.skilrock.lms.beans.BookBean;
import com.skilrock.lms.beans.BookSaleBean;
import com.skilrock.lms.beans.InvOrderBean;
import com.skilrock.lms.beans.OrderBean;
import com.skilrock.lms.beans.OrderedGameBean;
import com.skilrock.lms.beans.OrgAddressBean;
import com.skilrock.lms.beans.PackBean;
import com.skilrock.lms.common.db.DBConnect;
import com.skilrock.lms.common.db.QueryManager;
import com.skilrock.lms.common.db.TableConstants;
import com.skilrock.lms.common.exception.LMSException;
import com.skilrock.lms.common.utility.CommonMethods;
import com.skilrock.lms.common.utility.GenerateRecieptNo;
import com.skilrock.lms.scratchService.dataMgmt.daoImpl.ScratchGameDataDaoImpl;
import com.skilrock.lms.web.drawGames.common.Util;

/**
 * This is a helper class providing methods handling the order process at Agent
 * end
 * 
 * @author Skilrock Technologies
 * 
 */

<span class="nc" id="L63">public class AgentOrderProcessHelper {</span>
	private int gameID;
	private int totalOrderedBooks;

	/**
	 * This method is used for dispatching the retailer order
	 * 
	 * @param invOrderList
	 * @param orderId
	 * @param retOrgId
	 * @param agtId
	 * @param rootPath
	 * @param loggedInUserOrgName
	 * @throws LMSException
	 */
	/*public void dispatchOrder(List&lt;InvOrderBean&gt; invOrderList, int total,
			int orderId, int retOrgId, int agtId, String rootPath,
			String loggedInUserOrgName, int userOrgID, HttpSession session)
			throws LMSException {

		InvOrderBean invOrderBean = null;
		OrderedGameBean gameBean = null;

		// check if retailer online

		// String
		// isretOnline=(String)ServletActionContext.getServletContext().getAttribute(&quot;RET_ONLINE&quot;);
		Connection connection = null;
		PreparedStatement govtCommChangeHistoryPstmt = null;
		String govtCommChangeHistoryQuery = &quot;select count(*) from st_se_game_govt_comm_history where &quot;;

		if (invOrderList != null) {

			PreparedStatement agtMasterStmt = null;
			PreparedStatement LMSMasterStmt = null;
			PreparedStatement agtAgentStmt = null;
			PreparedStatement agtOrdGameStmt = null;
			PreparedStatement agtReceiptStmt = null;
			PreparedStatement agtReceiptNoGenStmt = null;
			PreparedStatement agtReceiptMappingStmt = null;
			PreparedStatement agtOrderStmt = null;
			PreparedStatement agtInvoiceDCMappingStmt = null;

			PreparedStatement gameInvStatusStmt = null;
			PreparedStatement gameInvDetailStmt = null;
			PreparedStatement orderInvoicesPrtSt = null;

			PreparedStatement getBookFromPackPstmt = null;
			PreparedStatement isGovtCommChngdPstmt = null;

			ResultSet rsMaster = null;
			Statement totalDispatch = null;
			ResultSet totalDispatchResult = null;
			String orderInvoicesQuery = null;
			String agtMasterQuery = null;
			String LMSMasterQuery = null;
			String agtAgentQuery = null;
			String agtOrdGamesQuery = null;
			String agtReceiptMappingQuery = null;
			String agtOrderQuery = null;
			String gameInvStatusQuery = null;
			String invQuery = null;

			String gameInvDetailQuery = null;
			String getBookfromPackQuery = null;
			String isGovtCommChangedQuery = null;

			String countDispatchedTotal = &quot;select nbr_of_books_dlvrd from st_se_agent_ordered_games where order_id=&quot;
					+ orderId;
			List&lt;Integer&gt; trnIdList = new ArrayList&lt;Integer&gt;();
			int masterTrnId = -1;
			int totalDispatchedForOrder = 0;

			try {

				 
				connection = DBConnect.getConnection();
				connection.setAutoCommit(false);

				agtMasterQuery = QueryManager.insertInAgentTransactionMaster();
				agtMasterStmt = connection.prepareStatement(agtMasterQuery);

				LMSMasterQuery = QueryManager.insertInLMSTransactionMaster();
				LMSMasterStmt = connection.prepareStatement(LMSMasterQuery);

				agtAgentQuery = QueryManager.getST1AgentRetQuery();
				agtAgentStmt = connection.prepareStatement(agtAgentQuery);

				agtOrdGamesQuery = QueryManager.getST1AgtOrdGamesUpdQuery();
				agtOrdGameStmt = connection.prepareStatement(agtOrdGamesQuery);

				java.sql.Timestamp currentDate = new java.sql.Timestamp(
						new Date().getTime());

				// agtReceiptQuery = QueryManager.getST1AgtReceiptsQuery();
				// agtReceiptStmt =
				// connection.prepareStatement(agtReceiptQuery);

				agtReceiptMappingQuery = QueryManager
						.insertAgentReceiptTrnMapping();
				agtReceiptMappingStmt = connection
						.prepareStatement(agtReceiptMappingQuery);

				agtOrderQuery = QueryManager.getST1AgtOrdUpdQuery();
				agtOrderStmt = connection.prepareStatement(agtOrderQuery);

				gameInvStatusQuery = QueryManager
						.getST1AgtUpdGameInvStatusQuery();

				gameInvDetailQuery = QueryManager.getST1InvDetailInsertQuery();
				gameInvDetailStmt = connection
						.prepareStatement(gameInvDetailQuery);

				orderInvoicesQuery = QueryManager
						.getST1AgentOrderInInsertQuery();
				orderInvoicesPrtSt = connection
						.prepareStatement(orderInvoicesQuery);

				getBookfromPackQuery = &quot;select book_nbr from st_se_game_inv_status where pack_nbr=?&quot;;
				getBookFromPackPstmt = connection
						.prepareStatement(getBookfromPackQuery);

				isGovtCommChangedQuery = &quot;select count(*) from st_se_game_govt_comm_history where game_id=?&quot;;
				isGovtCommChngdPstmt = connection
						.prepareStatement(isGovtCommChangedQuery);

				// added by arun
				String fetchPurRateQuery = &quot;select transacrion_sale_comm_rate from st_se_game_inv_detail where &quot;
						+ &quot;book_nbr=? and transaction_at='BO' order by transaction_date desc limit 1&quot;;
				PreparedStatement fetchPurRatePstmt = connection
						.prepareStatement(fetchPurRateQuery);
				ResultSet fetchPurRateRs = null;
				double purRate = 0.0;

				String detHistoryInsQuery = &quot;insert into st_se_game_ticket_inv_history(game_id, book_nbr, &quot;
						+ &quot; current_owner, current_owner_id, date, done_by_oid, done_by_uid, cur_rem_tickets, &quot;
						+ &quot; active_tickets_upto, sold_tickets, status) values (?,?,?,?,?,?,?,?,?,?,?)&quot;;
				PreparedStatement detHistoryInsPstmt = connection
						.prepareStatement(detHistoryInsQuery);

				// check book Status on dispatch
				String newBookStatus = &quot;ACTIVE&quot;;

				double mrpAmt = 0.0;
				double commAmt = 0.0;
				double netAmt = 0.0;
				double vatAmt = 0.0;
				double taxableSale = 0.0;
				double retSaleCommRate = 0.0;
				double creditAmt = 0.0;
				int nbrOfbooksApp = 0;
				int nbrBooksalreadyDispatched = 0;
				int nbrOfBooksDispatched = 0;

				totalDispatch = connection.createStatement();
				totalDispatchResult = totalDispatch
						.executeQuery(countDispatchedTotal);
				while (totalDispatchResult.next()) {
					totalDispatchedForOrder = totalDispatchedForOrder
							+ totalDispatchResult.getInt(&quot;nbr_of_books_dlvrd&quot;);

				}
				System.out.println(&quot;--------totalDispatchedForOrder&quot;
						+ totalDispatchedForOrder + &quot;-------&quot;);

				int gameId = -1;
				List&lt;PackBean&gt; packList = null;
				List&lt;BookBean&gt; bookList = null;
				PackBean packBean = null;
				BookBean bookBean = null;

				// insert in receipt master for invoice

				agtReceiptStmt = connection.prepareStatement(QueryManager
						.insertInReceiptMaster());
				agtReceiptStmt.setString(1, &quot;AGENT&quot;);
				agtReceiptStmt.executeUpdate();

				ResultSet rs = agtReceiptStmt.getGeneratedKeys();
				int invoiceId = -1;
				while (rs.next()) {
					invoiceId = rs.getInt(1);
				}

				// insert in receipt master for delevery challan
				agtReceiptStmt = connection.prepareStatement(QueryManager
						.insertInReceiptMaster());
				agtReceiptStmt.setString(1, &quot;AGENT&quot;);
				agtReceiptStmt.executeUpdate();

				ResultSet DCrs = agtReceiptStmt.getGeneratedKeys();
				int DCId = -1;
				while (DCrs.next()) {
					DCId = DCrs.getInt(1);
				}

				for (int i = 0; i &lt; invOrderList.size(); i++) {

					boolean isGovtCommChanged = false;
					invOrderBean = invOrderList.get(i);

					gameBean = invOrderBean.getOrderedGameBean();
					gameId = gameBean.getGameId();

					// fetch game details from game master
					String fetchGameDetQuery = &quot;select nbr_of_tickets_per_book from st_se_game_master where game_id =&quot;
							+ gameId;
					Statement fetchGameDetStmt = connection.createStatement();
					ResultSet fetchGameDetRs = fetchGameDetStmt
							.executeQuery(fetchGameDetQuery);
					int noOfTktPerBooks = -1;
					if (fetchGameDetRs.next()) {
						noOfTktPerBooks = fetchGameDetRs
								.getInt(&quot;nbr_of_tickets_per_book&quot;);
					}

					// check if govt comm of this game is changed or not in govt
					// comm history table
					isGovtCommChngdPstmt.setInt(1, gameId);
					ResultSet isGovtCommChngdRs = isGovtCommChngdPstmt
							.executeQuery();
					if (isGovtCommChngdRs.next()) {
						if (isGovtCommChngdRs.getInt(1) &gt; 1) {
							isGovtCommChanged = true;
						}
					}
					if (isGovtCommChanged == false) {

						System.out
								.println(&quot; &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;  :: inside false &quot;);

						nbrOfbooksApp = gameBean.getNbrOfBooksApp();
						nbrBooksalreadyDispatched = gameBean
								.getNbrOfBooksDlvrd();
						int nbrOfBooksPerPack = gameBean.getNbrOfBooksPerPack();

						nbrOfBooksDispatched = nbrBooksalreadyDispatched
								+ getDispatchedNbrOfBooks(invOrderBean,
										nbrOfBooksPerPack);
						totalDispatchedForOrder = totalDispatchedForOrder
								+ getDispatchedNbrOfBooks(invOrderBean,
										nbrOfBooksPerPack);
						int currentlyDispatched = getDispatchedNbrOfBooks(
								invOrderBean, nbrOfBooksPerPack);
						System.out
								.println(&quot;No of book already dispatched at the time of dispatch for this game&quot;
										+ nbrBooksalreadyDispatched
										+ &quot;------------&quot;);
						System.out
								.println(&quot;No of book just dispatched at the time of dispatch&quot;
										+ nbrOfBooksDispatched + &quot;------------&quot;);
						// System.out.println(&quot;tital diapatcehd
						// now&quot;+totalDispatched+&quot;------------&quot;);
						System.out.println(&quot;total approved books&quot; + total
								+ &quot;------------&quot;);

						// insert in LMS transaction master
						LMSMasterStmt.setString(1, &quot;AGENT&quot;);
						LMSMasterStmt.executeUpdate();
						rsMaster = null;
						rsMaster = LMSMasterStmt.getGeneratedKeys();

						while (rsMaster.next()) {
							masterTrnId = rsMaster.getInt(1);
							trnIdList.add(masterTrnId);
						}

						// insert in agent transaction master

						agtMasterStmt.setInt(1, masterTrnId);
						agtMasterStmt.setInt(2, agtId);
						agtMasterStmt.setInt(3, userOrgID);
						agtMasterStmt.setString(4, &quot;RETAILER&quot;);
						agtMasterStmt.setInt(5, retOrgId);
						agtMasterStmt.setString(6, &quot;SALE&quot;);
						agtMasterStmt.setTimestamp(7, currentDate);

						
						 * agtMasterStmt.setInt(1,agtId);
						 * agtMasterStmt.setInt(2,retOrgId);
						 * agtMasterStmt.setString(3,&quot;SALE&quot;);
						 * agtMasterStmt.setTimestamp(4,currentDate);
						 

						agtMasterStmt.execute();

						agtAgentStmt.setInt(1, masterTrnId);
						agtAgentStmt.setInt(2, gameId);
						agtAgentStmt.setInt(3, agtId);
						agtAgentStmt.setInt(4, retOrgId);

						mrpAmt = currentlyDispatched * gameBean.getBookPrice();
						agtAgentStmt.setDouble(5, mrpAmt);

						retSaleCommRate = gameBean.getRetSaleCommRate()
								+ gameBean.getRetGameCommVariance();
						commAmt = mrpAmt * retSaleCommRate * 0.01;
						agtAgentStmt.setDouble(6, commAmt);

						netAmt = mrpAmt - commAmt;
						creditAmt += netAmt;

						// added by yogehs to calculate vat amount

						vatAmt = CommonMethods.calculateVat(mrpAmt,
								retSaleCommRate,
								gameBean.getPrizePayOutRatio(), gameBean
										.getGovtComm(), gameBean.getVat(),
								gameBean.getGovtCommRule(), gameBean
										.getFixedAmt(), gameBean
										.getTicketsInScheme());
						// taxableSale=(((mrpAmt*(100-(retSaleCommRate +
						// gameBean.getPrizePayOutRatio()
						// +gameBean.getGovtComm())))/100)*100)/(100+gameBean.getVat());
						// taxableSale=vatAmt/(gameBean.getVat() * 0.01);
						taxableSale = CommonMethods.calTaxableSale(mrpAmt,
								retSaleCommRate,
								gameBean.getPrizePayOutRatio(), gameBean
										.getGovtComm(), gameBean.getVat());

						agtAgentStmt.setDouble(7, netAmt);
						agtAgentStmt.setString(8, &quot;SALE&quot;);
						agtAgentStmt.setInt(9, currentlyDispatched);
						agtAgentStmt.setDouble(10, vatAmt);
						agtAgentStmt.setDouble(11, taxableSale);
						agtAgentStmt.setInt(12, userOrgID);
						agtAgentStmt.execute();

						agtOrdGameStmt.setInt(1, nbrOfBooksDispatched);
						agtOrdGameStmt.setInt(2, orderId);
						agtOrdGameStmt.setInt(3, gameId);

						agtOrdGameStmt.execute();

						packList = invOrderBean.getPackList();
						if (packList != null) {
							invQuery = gameInvStatusQuery
									+ &quot; and pack_nbr = ? &quot;;
							gameInvStatusStmt = connection
									.prepareStatement(invQuery);
							String packNbr = null;

							for (int j = 0; j &lt; packList.size(); j++) {
								packBean = packList.get(j);
								packNbr = packBean.getPackNumber();

								gameInvStatusStmt.setString(1, &quot;RETAILER&quot;);
								gameInvStatusStmt.setInt(2, retOrgId);

								// if(isretOnline.equals(&quot;YES&quot;))
								// {
								// gameInvStatusStmt.setString(3,&quot;ACTIVE&quot;);
								
								 * } else {
								 * gameInvStatusStmt.setString(3,&quot;ACTIVE&quot;); }
								 

								gameInvStatusStmt.setString(3, newBookStatus);

								// Added by arun on update status table

								gameInvStatusStmt.setInt(4, noOfTktPerBooks);
								if (&quot;ACTIVE&quot;.equalsIgnoreCase(newBookStatus
										.trim())) {
									gameInvStatusStmt
											.setInt(5, noOfTktPerBooks);
								} else {
									gameInvStatusStmt.setInt(5, 0);
								}
								// ----------------

								gameInvStatusStmt.setInt(6, gameId);
								gameInvStatusStmt.setString(7, packNbr);
								gameInvStatusStmt.execute();

								List&lt;String&gt; books = getBooksForPack(
										connection, gameId, packNbr);

								for (int k = 0; k &lt; books.size(); k++) {
									gameInvDetailStmt.setInt(1, masterTrnId);
									gameInvDetailStmt.setInt(2, gameId);
									gameInvDetailStmt.setString(3, packNbr);
									gameInvDetailStmt
											.setString(4, books.get(k));
									gameInvDetailStmt.setString(5, &quot;RETAILER&quot;);
									gameInvDetailStmt.setInt(6, retOrgId);
									gameInvDetailStmt.setTimestamp(7,
											currentDate);
									gameInvDetailStmt.setString(8, &quot;AGENT&quot;);
									gameInvDetailStmt.setDouble(9,
											retSaleCommRate);
									gameInvDetailStmt.setDouble(10, gameBean
											.getGovtComm());
									gameInvDetailStmt.setObject(11, purRate);
									gameInvDetailStmt.execute();

									// insert into detail history table Added by
									// arun
									detHistoryInsPstmt.setInt(1, gameId);
									detHistoryInsPstmt.setString(2, books
											.get(k));
									detHistoryInsPstmt.setString(3, &quot;RETAILER&quot;);
									detHistoryInsPstmt.setInt(4, retOrgId);
									detHistoryInsPstmt.setTimestamp(5,
											currentDate);
									detHistoryInsPstmt.setInt(6, userOrgID);
									detHistoryInsPstmt.setInt(7, agtId);
									detHistoryInsPstmt.setInt(8,
											noOfTktPerBooks);
									if (&quot;ACTIVE&quot;.equalsIgnoreCase(newBookStatus
											.trim())) {
										detHistoryInsPstmt.setInt(9,
												noOfTktPerBooks);
									} else {
										detHistoryInsPstmt.setInt(9, 0);
									}
									detHistoryInsPstmt.setInt(10, 0);
									detHistoryInsPstmt.setString(11,
											newBookStatus);
									detHistoryInsPstmt.execute();

								}

							}
						}

						bookList = invOrderBean.getBookList();
						if (bookList != null) {
							invQuery = gameInvStatusQuery + &quot; and book_nbr = ?&quot;;
							gameInvStatusStmt = connection
									.prepareStatement(invQuery);
							String bookNbr = null;
							String packNbr = null;
							for (int j = 0; j &lt; bookList.size(); j++) {
								bookBean = bookList.get(j);
								bookNbr = bookBean.getBookNumber();
								gameInvStatusStmt.setString(1, &quot;RETAILER&quot;);
								gameInvStatusStmt.setInt(2, retOrgId);
								gameInvStatusStmt.setString(3, newBookStatus);

								// Added by arun on update status table
								gameInvStatusStmt.setInt(4, noOfTktPerBooks);
								if (&quot;ACTIVE&quot;.equalsIgnoreCase(newBookStatus
										.trim())) {
									gameInvStatusStmt
											.setInt(5, noOfTktPerBooks);
								} else {
									gameInvStatusStmt.setInt(5, 0);
								}
								// ----------------

								gameInvStatusStmt.setInt(6, gameId);
								gameInvStatusStmt.setString(7, bookNbr);
								gameInvStatusStmt.execute();

								// added by arun
								fetchPurRatePstmt.setString(1, bookNbr);
								fetchPurRateRs = fetchPurRatePstmt
										.executeQuery();

								if (fetchPurRateRs.next()) {
									purRate = fetchPurRateRs
											.getDouble(&quot;transacrion_sale_comm_rate&quot;);
								}

								packNbr = getPackNbrForBook(connection, gameId,
										bookNbr);

								gameInvDetailStmt.setInt(1, masterTrnId);
								gameInvDetailStmt.setInt(2, gameId);
								gameInvDetailStmt.setString(3, packNbr);
								gameInvDetailStmt.setString(4, bookNbr);
								gameInvDetailStmt.setString(5, &quot;RETAILER&quot;);
								gameInvDetailStmt.setInt(6, retOrgId);
								gameInvDetailStmt.setTimestamp(7, currentDate);
								gameInvDetailStmt.setString(8, &quot;AGENT&quot;);
								gameInvDetailStmt.setDouble(9, retSaleCommRate);
								gameInvDetailStmt.setDouble(10, gameBean
										.getGovtComm());
								gameInvDetailStmt.setObject(11, purRate);
								gameInvDetailStmt.execute();

								// insert into detail history table Added by
								// arun
								detHistoryInsPstmt.setInt(1, gameId);
								detHistoryInsPstmt.setString(2, bookNbr);
								detHistoryInsPstmt.setString(3, &quot;RETAILER&quot;);
								detHistoryInsPstmt.setInt(4, retOrgId);
								detHistoryInsPstmt.setTimestamp(5, currentDate);
								detHistoryInsPstmt.setInt(6, userOrgID);
								detHistoryInsPstmt.setInt(7, agtId);
								detHistoryInsPstmt.setInt(8, noOfTktPerBooks);
								if (&quot;ACTIVE&quot;.equalsIgnoreCase(newBookStatus
										.trim())) {
									detHistoryInsPstmt.setInt(9,
											noOfTktPerBooks);
								} else {
									detHistoryInsPstmt.setInt(9, 0);
								}
								detHistoryInsPstmt.setInt(10, 0);
								detHistoryInsPstmt.setString(11, newBookStatus);
								detHistoryInsPstmt.execute();

							}
						}

						if (total == totalDispatchedForOrder) {

							agtOrderStmt.setString(1, &quot;PROCESSED&quot;);
							agtOrderStmt.setInt(2, orderId);

							agtOrderStmt.executeUpdate();
							orderInvoicesPrtSt.setInt(1, orderId);
							orderInvoicesPrtSt.setInt(2, invoiceId);
							orderInvoicesPrtSt.setInt(3, retOrgId);
							orderInvoicesPrtSt.setInt(4, gameId);
							orderInvoicesPrtSt.setString(5, &quot;PROCESSED&quot;);
							orderInvoicesPrtSt.setInt(6, nbrOfBooksDispatched);
							orderInvoicesPrtSt.setInt(7, agtId);
							orderInvoicesPrtSt.setInt(8, userOrgID);
							orderInvoicesPrtSt.executeUpdate();
							System.out
									.println(&quot;Total aaproved and total dispatched are equal----PROCESSED&quot;);
						} else {
							agtOrderStmt.setString(1, &quot;SEMI_PROCESSED&quot;);
							agtOrderStmt.setInt(2, orderId);
							agtOrderStmt.executeUpdate();
							System.out.println(&quot;In the Semi processed block&quot;);
							orderInvoicesPrtSt.setInt(1, orderId);
							orderInvoicesPrtSt.setInt(2, invoiceId);
							orderInvoicesPrtSt.setInt(3, retOrgId);
							orderInvoicesPrtSt.setInt(4, gameId);
							orderInvoicesPrtSt.setString(5, &quot;SEMI_PROCESSED&quot;);
							orderInvoicesPrtSt.setInt(6, nbrOfBooksDispatched);
							orderInvoicesPrtSt.setInt(7, agtId);
							orderInvoicesPrtSt.setInt(8, userOrgID);
							orderInvoicesPrtSt.executeUpdate();
						}

					}

					else {
						System.out
								.println(&quot; &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;  :: inside true &quot;);

						nbrOfbooksApp = gameBean.getNbrOfBooksApp();
						nbrBooksalreadyDispatched = gameBean
								.getNbrOfBooksDlvrd();
						int nbrOfBooksPerPack = gameBean.getNbrOfBooksPerPack();

						nbrOfBooksDispatched = nbrBooksalreadyDispatched
								+ getDispatchedNbrOfBooks(invOrderBean,
										nbrOfBooksPerPack);
						totalDispatchedForOrder = totalDispatchedForOrder
								+ getDispatchedNbrOfBooks(invOrderBean,
										nbrOfBooksPerPack);
						int currentlyDispatched = getDispatchedNbrOfBooks(
								invOrderBean, nbrOfBooksPerPack);

						mrpAmt = currentlyDispatched * gameBean.getBookPrice();
						retSaleCommRate = gameBean.getRetSaleCommRate()
								+ gameBean.getRetGameCommVariance();
						commAmt = mrpAmt * retSaleCommRate * 0.01;
						netAmt = mrpAmt - commAmt;
						creditAmt += netAmt;

						packList = invOrderBean.getPackList();
						bookList = invOrderBean.getBookList();

						if (packList != null) {
							String packNbr = null;

							for (int j = 0; j &lt; packList.size(); j++) {
								packBean = packList.get(j);
								packNbr = packBean.getPackNumber();
								getBookFromPackPstmt.setString(1, packNbr);
								ResultSet rsBookFrmPack = getBookFromPackPstmt
										.executeQuery();
								while (rsBookFrmPack.next()) {
									bookBean = new BookBean();
									String bookNbrfromPack = rsBookFrmPack
											.getString(&quot;book_nbr&quot;);
									bookBean.setBookNumber(bookNbrfromPack);
									// here u have to set book status also
									// in book bean
									bookList.add(bookBean);
								}

							}

						}
						ResultSet rsCommVar;
						ArrayList&lt;BookSaleBean&gt; bookSaleBeanList = new ArrayList&lt;BookSaleBean&gt;();
						BookSaleBean bookSaleBean;
						for (int bookListSize = 0; bookListSize &lt; bookList
								.size(); bookListSize++) {
							bookSaleBean = new BookSaleBean();
							double govtCommRate = 0.0;
							double vatAmtForBook = 0.0;
							double taxableSaleForbook = 0.0;
							bookBean = bookList.get(bookListSize);
							String bookfromBookList = bookBean.getBookNumber();
							String govtCommVarianceQuery = &quot;select transaction_gov_comm_rate,transaction_date from st_se_game_inv_detail where current_owner=? and current_owner_id=? and game_id=? and book_nbr=? and transaction_at=? order by transaction_date desc limit 1 &quot;;
							PreparedStatement govtCommVariaceStmt = connection
									.prepareStatement(govtCommVarianceQuery);
							govtCommVariaceStmt.setString(1, &quot;AGENT&quot;);
							govtCommVariaceStmt.setInt(2, userOrgID);
							govtCommVariaceStmt.setInt(3, gameId);
							govtCommVariaceStmt.setString(4, bookfromBookList);
							govtCommVariaceStmt.setString(5, &quot;BO&quot;);
							rsCommVar = govtCommVariaceStmt.executeQuery();
							while (rsCommVar.next()) {
								govtCommRate = rsCommVar
										.getDouble(&quot;transaction_gov_comm_rate&quot;);
							}

							vatAmtForBook = CommonMethods.calculateVat(gameBean
									.getBookPrice(), retSaleCommRate, gameBean
									.getPrizePayOutRatio(), govtCommRate,
									gameBean.getVat(), gameBean
											.getGovtCommRule(), gameBean
											.getFixedAmt(), gameBean
											.getTicketsInScheme());
							// taxableSaleForbook=(((gameBean.getBookPrice()*(100-(retSaleCommRate
							// + gameBean.getPrizePayOutRatio()
							// +govtCommRate)))/100)*100)/(100+gameBean.getVat());
							// taxableSaleForbook=vatAmtForBook/(gameBean.getVat()
							// * 0.01);
							taxableSaleForbook = CommonMethods.calTaxableSale(
									gameBean.getBookPrice(), retSaleCommRate,
									gameBean.getPrizePayOutRatio(),
									govtCommRate, gameBean.getVat());

							bookSaleBean.setBookNumber(bookfromBookList);
							bookSaleBean.setBookTaxableSale(taxableSaleForbook);
							bookSaleBean.setBookVatAmt(vatAmtForBook);
							bookSaleBean.setTotalSaleGovtComm(govtCommRate);
							bookSaleBeanList.add(bookSaleBean);
						}

						Set&lt;Double&gt; GovtCommVarianceSet = new HashSet&lt;Double&gt;();
						String queryGovtCommVarHistory = &quot;select DISTINCT govt_comm_rate from st_se_game_govt_comm_history where game_id=&quot;
								+ gameId;
						PreparedStatement stmtGovtCommVarHistory = connection
								.prepareStatement(queryGovtCommVarHistory);
						ResultSet rsGovtCommVarHistory = stmtGovtCommVarHistory
								.executeQuery();
						while (rsGovtCommVarHistory.next()) {
							GovtCommVarianceSet.add(rsGovtCommVarHistory
									.getDouble(&quot;govt_comm_rate&quot;));
						}

						Iterator govtCommSetItr;
						Iterator bookSaleBeanItr;
						govtCommSetItr = GovtCommVarianceSet.iterator();

						while (govtCommSetItr.hasNext()) {
							boolean bookGovtCommVarMatch = false;
							bookSaleBeanItr = bookSaleBeanList.iterator();
							List bookListforSingleTrn = null;
							bookListforSingleTrn = new ArrayList&lt;String&gt;();

							double totVatAmt = 0.0;
							double totTaxableSale = 0.0;
							double totMrpAmt = 0.0;
							double totalCommAmt = 0.0;
							double totalNetAmt = 0.0;

							Double govtCommFormSet = (Double) govtCommSetItr
									.next();

							while (bookSaleBeanItr.hasNext()) {
								bookSaleBean = (BookSaleBean) bookSaleBeanItr
										.next();
								// System.out.println(&quot;compare comm ::: &quot; +
								// bookSaleBean.getTotalSaleGovtComm() + &quot; :: &quot;
								// + govtCommFormSet);
								if (bookSaleBean.getTotalSaleGovtComm() == govtCommFormSet) {
									bookGovtCommVarMatch = true;
									totVatAmt = totVatAmt
											+ bookSaleBean.getBookVatAmt();
									totTaxableSale = totTaxableSale
											+ bookSaleBean.getBookTaxableSale();
									totMrpAmt = totMrpAmt
											+ gameBean.getBookPrice();
									bookListforSingleTrn.add(bookSaleBean
											.getBookNumber());
								}

							}

							totalCommAmt = totMrpAmt * retSaleCommRate * 0.01;
							totalNetAmt = totMrpAmt - totalCommAmt;
							if (bookGovtCommVarMatch) {

								// insert in LMS transaction master
								LMSMasterStmt.setString(1, &quot;AGENT&quot;);
								LMSMasterStmt.executeUpdate();

								rsMaster = null;
								rsMaster = LMSMasterStmt.getGeneratedKeys();

								while (rsMaster.next()) {
									masterTrnId = rsMaster.getInt(1);
									trnIdList.add(masterTrnId);
								}

								// insert in agent transaction master

								agtMasterStmt.setInt(1, masterTrnId);
								agtMasterStmt.setInt(2, agtId);
								agtMasterStmt.setInt(3, userOrgID);
								agtMasterStmt.setString(4, &quot;RETAILER&quot;);
								agtMasterStmt.setInt(5, retOrgId);
								agtMasterStmt.setString(6, &quot;SALE&quot;);
								agtMasterStmt.setTimestamp(7, currentDate);
								agtMasterStmt.execute();

								agtAgentStmt.setInt(1, masterTrnId);
								agtAgentStmt.setInt(2, gameId);
								agtAgentStmt.setInt(3, agtId);
								agtAgentStmt.setInt(4, retOrgId);

								// mrpAmt = currentlyDispatched *
								// gameBean.getBookPrice();
								agtAgentStmt.setDouble(5, totMrpAmt);

								// retSaleCommRate=gameBean.getRetSaleCommRate()+gameBean.getRetGameCommVariance();
								// commAmt = mrpAmt * retSaleCommRate * 0.01 ;
								agtAgentStmt.setDouble(6, totalCommAmt);
								agtAgentStmt.setDouble(7, totalNetAmt);
								agtAgentStmt.setString(8, &quot;SALE&quot;);
								agtAgentStmt.setInt(9, bookListforSingleTrn
										.size());
								agtAgentStmt.setDouble(10, totVatAmt);
								agtAgentStmt.setDouble(11, totTaxableSale);
								agtAgentStmt.setInt(12, userOrgID);

								agtAgentStmt.execute();

								for (int j = 0; j &lt; bookListforSingleTrn.size(); j++) {
									String bknbr = (String) bookListforSingleTrn
											.get(j);
									String pkNbr = getPackNbrForBook(
											connection, gameId, bknbr);

									// added by arun
									fetchPurRatePstmt.setString(1, bknbr);
									fetchPurRateRs = fetchPurRatePstmt
											.executeQuery();

									if (fetchPurRateRs.next()) {
										purRate = fetchPurRateRs
												.getDouble(&quot;transacrion_sale_comm_rate&quot;);
									}

									gameInvDetailStmt.setInt(1, masterTrnId);
									gameInvDetailStmt.setInt(2, gameId);
									gameInvDetailStmt.setString(3, pkNbr);
									gameInvDetailStmt.setString(4, bknbr);
									gameInvDetailStmt.setString(5, &quot;RETAILER&quot;);
									gameInvDetailStmt.setInt(6, retOrgId);
									gameInvDetailStmt.setTimestamp(7,
											currentDate);
									gameInvDetailStmt.setString(8, &quot;AGENT&quot;);
									gameInvDetailStmt.setDouble(9,
											retSaleCommRate);
									gameInvDetailStmt.setDouble(10,
											govtCommFormSet);
									gameInvDetailStmt.setObject(11, purRate);
									gameInvDetailStmt.execute();

									// insert into detail history table Added by
									// arun
									detHistoryInsPstmt.setInt(1, gameId);
									detHistoryInsPstmt.setString(2, bknbr);
									detHistoryInsPstmt.setString(3, &quot;RETAILER&quot;);
									detHistoryInsPstmt.setInt(4, retOrgId);
									detHistoryInsPstmt.setTimestamp(5,
											currentDate);
									detHistoryInsPstmt.setInt(6, userOrgID);
									detHistoryInsPstmt.setInt(7, agtId);
									detHistoryInsPstmt.setInt(8,
											noOfTktPerBooks);
									if (&quot;ACTIVE&quot;.equalsIgnoreCase(newBookStatus
											.trim())) {
										detHistoryInsPstmt.setInt(9,
												noOfTktPerBooks);
									} else {
										detHistoryInsPstmt.setInt(9, 0);
									}
									detHistoryInsPstmt.setInt(10, 0);
									detHistoryInsPstmt.setString(11,
											newBookStatus);
									detHistoryInsPstmt.execute();

								}
							}
						}

						agtOrdGameStmt.setInt(1, nbrOfBooksDispatched);
						agtOrdGameStmt.setInt(2, orderId);
						agtOrdGameStmt.setInt(3, gameId);

						agtOrdGameStmt.execute();

						if (bookList != null) {
							invQuery = gameInvStatusQuery + &quot; and book_nbr = ?&quot;;
							gameInvStatusStmt = connection
									.prepareStatement(invQuery);
							String bookNbr = null;
							String packNbr = null;
							for (int j = 0; j &lt; bookList.size(); j++) {
								bookBean = bookList.get(j);
								bookNbr = bookBean.getBookNumber();
								gameInvStatusStmt.setString(1, &quot;RETAILER&quot;);
								gameInvStatusStmt.setInt(2, retOrgId);// Added
								// by
								// arun on
								// update
								// status
								// table
								gameInvStatusStmt.setString(3, newBookStatus);
								gameInvStatusStmt.setInt(4, noOfTktPerBooks);
								if (&quot;ACTIVE&quot;.equalsIgnoreCase(newBookStatus
										.trim())) {
									gameInvStatusStmt
											.setInt(5, noOfTktPerBooks);
								} else {
									gameInvStatusStmt.setInt(5, 0);
								}
								// ----------------

								gameInvStatusStmt.setInt(6, gameId);
								gameInvStatusStmt.setString(7, bookNbr);
								gameInvStatusStmt.execute();

								
								 * packNbr =
								 * getPackNbrForBook(connection,gameId,bookNbr);
								 * 
								 * gameInvDetailStmt.setInt(1,masterTrnId);
								 * gameInvDetailStmt.setInt(2,gameId);
								 * gameInvDetailStmt.setString(3,packNbr);
								 * gameInvDetailStmt.setString(4,bookNbr);
								 * gameInvDetailStmt.setString(5,&quot;RETAILER&quot;);
								 * gameInvDetailStmt.setInt(6,retOrgId);
								 * gameInvDetailStmt.setTimestamp(7,currentDate);
								 * gameInvDetailStmt.setString(8,&quot;AGENT&quot;);
								 * gameInvDetailStmt.setDouble(9,retSaleCommRate);
								 * gameInvDetailStmt.setDouble(10,
								 * gameBean.getGovtComm());
								 * 
								 * gameInvDetailStmt.execute();
								 

							}
						}

						if (total == totalDispatchedForOrder) {

							agtOrderStmt.setString(1, &quot;PROCESSED&quot;);
							agtOrderStmt.setInt(2, orderId);

							agtOrderStmt.executeUpdate();
							orderInvoicesPrtSt.setInt(1, orderId);
							orderInvoicesPrtSt.setInt(2, invoiceId);
							orderInvoicesPrtSt.setInt(3, retOrgId);
							orderInvoicesPrtSt.setInt(4, gameId);
							orderInvoicesPrtSt.setString(5, &quot;PROCESSED&quot;);
							orderInvoicesPrtSt.setInt(6, nbrOfBooksDispatched);
							orderInvoicesPrtSt.setInt(7, agtId);
							orderInvoicesPrtSt.setInt(8, userOrgID);
							orderInvoicesPrtSt.executeUpdate();
							System.out
									.println(&quot;Total aaproved and total dispatched are equal----PROCESSED&quot;);
						} else {
							agtOrderStmt.setString(1, &quot;SEMI_PROCESSED&quot;);
							agtOrderStmt.setInt(2, orderId);
							agtOrderStmt.executeUpdate();
							System.out.println(&quot;In the Semi processed block&quot;);
							orderInvoicesPrtSt.setInt(1, orderId);
							orderInvoicesPrtSt.setInt(2, invoiceId);
							orderInvoicesPrtSt.setInt(3, retOrgId);
							orderInvoicesPrtSt.setInt(4, gameId);
							orderInvoicesPrtSt.setString(5, &quot;SEMI_PROCESSED&quot;);
							orderInvoicesPrtSt.setInt(6, nbrOfBooksDispatched);
							orderInvoicesPrtSt.setInt(7, agtId);
							orderInvoicesPrtSt.setInt(8, userOrgID);
							orderInvoicesPrtSt.executeUpdate();
						}

					}

				}

				// get auto generated treciept number
				// String getLatestRecieptNumber=&quot;SELECT * from
				// st_lms_agent_receipts_gen_mapping where receipt_type=? and
				// agt_org_id=? ORDER BY generated_id DESC LIMIT 1 &quot;;
				agtReceiptNoGenStmt = connection.prepareStatement(QueryManager
						.getAGENTLatestReceiptNb());
				agtReceiptNoGenStmt.setString(1, &quot;INVOICE&quot;);
				agtReceiptNoGenStmt.setInt(2, userOrgID);
				ResultSet recieptRs = agtReceiptNoGenStmt.executeQuery();
				String lastRecieptNoGenerated = null;
				// System.out.println(&quot;queryyyyyyyyyy:::::: &quot; +
				// agtReceiptNoGenStmt);
				while (recieptRs.next()) {
					lastRecieptNoGenerated = recieptRs
							.getString(&quot;generated_id&quot;);
				}

				String autoGeneRecieptNo = null;
				autoGeneRecieptNo = GenerateRecieptNo.getRecieptNoAgt(
						&quot;INVOICE&quot;, lastRecieptNoGenerated, &quot;AGENT&quot;, userOrgID);

				// get auto generated delivery Challan number
				// String getLatestDCNumber=&quot;SELECT * from
				// st_lms_agent_receipts_gen_mapping where receipt_type=? and
				// agt_org_id=? ORDER BY generated_id DESC LIMIT 1 &quot;;
				agtReceiptNoGenStmt = connection.prepareStatement(QueryManager
						.getAGENTLatestReceiptNb());
				agtReceiptNoGenStmt.setString(1, &quot;DLCHALLAN&quot;);
				agtReceiptNoGenStmt.setInt(2, userOrgID);
				ResultSet DCRs = agtReceiptNoGenStmt.executeQuery();
				String lastDCNoGenerated = null;

				while (DCRs.next()) {
					lastDCNoGenerated = DCRs.getString(&quot;generated_id&quot;);
				}

				String autoGeneDCNo = null;
				autoGeneDCNo = GenerateRecieptNo.getRecieptNoAgt(&quot;DLCHALLAN&quot;,
						lastDCNoGenerated, &quot;AGENT&quot;, userOrgID);

				// insert into agent receipt table

				agtReceiptStmt = connection.prepareStatement(QueryManager
						.insertInAgentReceipts());

				agtReceiptStmt.setInt(1, invoiceId);
				agtReceiptStmt.setString(2, &quot;INVOICE&quot;);
				agtReceiptStmt.setInt(3, userOrgID);
				agtReceiptStmt.setInt(4, retOrgId);
				agtReceiptStmt.setString(5, &quot;RETAILER&quot;);
				agtReceiptStmt.setString(6, autoGeneRecieptNo);
				agtReceiptStmt.setTimestamp(7, Util.getCurrentTimeStamp());

				
				 * agtReceiptStmt.setString(1,&quot;INVOICE&quot;);
				 * agtReceiptStmt.setInt(2,agtId);
				 * agtReceiptStmt.setInt(3,retOrgId);
				 

				agtReceiptStmt.execute();

				// insert into agent receipt table for dl challan
				agtReceiptStmt = connection.prepareStatement(QueryManager
						.insertInAgentReceipts());
				agtReceiptStmt.setInt(1, DCId);
				agtReceiptStmt.setString(2, &quot;DLCHALLAN&quot;);
				agtReceiptStmt.setInt(3, userOrgID);
				agtReceiptStmt.setInt(4, retOrgId);
				agtReceiptStmt.setString(5, &quot;RETAILER&quot;);
				agtReceiptStmt.setString(6, autoGeneDCNo);
				agtReceiptStmt.setTimestamp(7, Util.getCurrentTimeStamp());
				
				 * agtReceiptStmt.setString(1,&quot;DLCHALLAN&quot;);
				 * agtReceiptStmt.setInt(2,agtId);
				 * agtReceiptStmt.setInt(3,retOrgId);
				 

				agtReceiptStmt.execute();

				for (int i = 0; i &lt; trnIdList.size(); i++) {
					agtReceiptMappingStmt.setInt(1, invoiceId);
					agtReceiptMappingStmt.setInt(2, trnIdList.get(i));
					agtReceiptMappingStmt.execute();

				}

				for (int i = 0; i &lt; trnIdList.size(); i++) {
					agtReceiptMappingStmt.setInt(1, DCId);
					agtReceiptMappingStmt.setInt(2, trnIdList.get(i));
					agtReceiptMappingStmt.execute();

				}

				// insert into invoice and delivery challan mapping table

				String insertInvoiceDCMapping = &quot;insert into st_se_agent_invoice_delchallan_mapping(id,generated_invoice_id,generated_del_challan_id) values(?,?,?)&quot;;
				agtInvoiceDCMappingStmt = connection
						.prepareStatement(insertInvoiceDCMapping);
				agtInvoiceDCMappingStmt.setInt(1, invoiceId);
				agtInvoiceDCMappingStmt.setString(2, autoGeneRecieptNo);
				agtInvoiceDCMappingStmt.setString(3, autoGeneDCNo);
				agtInvoiceDCMappingStmt.executeUpdate();

				// for org credit updation
				System.out.println(&quot;Org Id For Credit Update:&quot; + retOrgId + &quot;:&quot;
						+ creditAmt);
				
				boolean isValid=OrgCreditUpdation.updateOrganizationBalWithValidate(creditAmt, &quot;TRANSACTION&quot;, &quot;SALE&quot;, retOrgId,
						userOrgID, &quot;RETAILER&quot;, 0, connection);
				
				if(!isValid)
					throw new LMSException();
				
				
				boolean isUpdateDone = OrgCreditUpdation
						.updateCreditLimitForRetailer(retOrgId, &quot;SALE&quot;,
								creditAmt, connection);

				connection.commit();
				session.setAttribute(&quot;DEL_CHALLAN_ID&quot;, DCId);
				if (invoiceId &gt; -1) {
					GraphReportHelper graphReportHelper = new GraphReportHelper();
					graphReportHelper.createTextReportAgent(invoiceId,
							rootPath, userOrgID, loggedInUserOrgName);
				}
			} catch (SQLException se) {
				try {
					connection.rollback();

				} catch (SQLException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
					throw new LMSException(&quot;Error During Rollback&quot;, e);
				}
				System.out
						.println(&quot;*************************Printing stack trace***************************&quot;);
				se.printStackTrace();
				throw new LMSException(se);
			} finally {
				try {
					if (connection != null) {
						connection.close();
					}
				} catch (SQLException se) {
					se.printStackTrace();
				}
			}

		}

	}*/

	public int assignOrder(List&lt;InvOrderBean&gt; invOrderList, int total, int orderId, int retOrgId, int agtId, String rootPath, String loggedInUserOrgName, int userOrgID) throws LMSException {
<span class="nc" id="L1112">		int DCId = -1;</span>
<span class="nc" id="L1113">		int warehouseId = -1;</span>
<span class="nc" id="L1114">		Connection connection = null;</span>
<span class="nc" id="L1115">		InvOrderBean invOrderBean = null;</span>
<span class="nc" id="L1116">		OrderedGameBean gameBean = null;</span>
<span class="nc bnc" id="L1117" title="All 2 branches missed.">		if (invOrderList != null) {</span>
			//PreparedStatement agtMasterStmt = null;
			//PreparedStatement LMSMasterStmt = null;
			//PreparedStatement agtAgentStmt = null;
<span class="nc" id="L1121">			PreparedStatement agtOrdGameStmt = null;</span>
<span class="nc" id="L1122">			PreparedStatement agtReceiptStmt = null;</span>
<span class="nc" id="L1123">			PreparedStatement agtReceiptNoGenStmt = null;</span>
<span class="nc" id="L1124">			PreparedStatement agtReceiptMappingStmt = null;</span>
<span class="nc" id="L1125">			PreparedStatement agtOrderStmt = null;</span>
<span class="nc" id="L1126">			PreparedStatement gameInvStatusStmt = null;</span>
<span class="nc" id="L1127">			PreparedStatement gameInvDetailStmt = null;</span>
<span class="nc" id="L1128">			PreparedStatement orderInvoicesPrtSt = null;</span>
<span class="nc" id="L1129">			PreparedStatement getBookFromPackPstmt = null;</span>
<span class="nc" id="L1130">			PreparedStatement isGovtCommChngdPstmt = null;</span>

<span class="nc" id="L1132">			ResultSet rsMaster = null;</span>
<span class="nc" id="L1133">			Statement totalDispatch = null;</span>
<span class="nc" id="L1134">			ResultSet totalDispatchResult = null;</span>
<span class="nc" id="L1135">			String orderInvoicesQuery = null;</span>
			//String agtMasterQuery = null;
			//String LMSMasterQuery = null;
			//String agtAgentQuery = null;
<span class="nc" id="L1139">			String agtOrdGamesQuery = null;</span>
<span class="nc" id="L1140">			String agtReceiptMappingQuery = null;</span>
<span class="nc" id="L1141">			String agtOrderQuery = null;</span>
<span class="nc" id="L1142">			String gameInvStatusQuery = null;</span>
<span class="nc" id="L1143">			String invQuery = null;</span>

<span class="nc" id="L1145">			String gameInvDetailQuery = null;</span>
<span class="nc" id="L1146">			String getBookfromPackQuery = null;</span>
<span class="nc" id="L1147">			String isGovtCommChangedQuery = null;</span>

<span class="nc" id="L1149">			String countDispatchedTotal = &quot;select nbr_of_books_dlvrd from st_se_agent_ordered_games where order_id=&quot; + orderId;</span>
<span class="nc" id="L1150">			List&lt;Integer&gt; trnIdList = new ArrayList&lt;Integer&gt;();</span>
<span class="nc" id="L1151">			int masterTrnId = -1;</span>
<span class="nc" id="L1152">			int totalDispatchedForOrder = 0;</span>
			try {
<span class="nc" id="L1154">				connection = DBConnect.getConnection();</span>
<span class="nc" id="L1155">				connection.setAutoCommit(false);</span>

				//agtMasterQuery = QueryManager.insertInAgentTransactionMaster();
				//agtMasterStmt = connection.prepareStatement(agtMasterQuery);

				//LMSMasterQuery = QueryManager.insertInLMSTransactionMaster();
				//LMSMasterStmt = connection.prepareStatement(LMSMasterQuery);

				//agtAgentQuery = QueryManager.getST1AgentRetQuery();
				//agtAgentStmt = connection.prepareStatement(agtAgentQuery);

<span class="nc" id="L1166">				agtOrdGamesQuery = QueryManager.getST1AgtOrdGamesUpdQuery();</span>
<span class="nc" id="L1167">				agtOrdGameStmt = connection.prepareStatement(agtOrdGamesQuery);</span>

<span class="nc" id="L1169">				java.sql.Timestamp currentDate = new java.sql.Timestamp(new Date().getTime());</span>

<span class="nc" id="L1171">				agtReceiptMappingQuery = QueryManager.insertAgentReceiptTrnMapping();</span>
<span class="nc" id="L1172">				agtReceiptMappingStmt = connection.prepareStatement(agtReceiptMappingQuery);</span>

<span class="nc" id="L1174">				agtOrderQuery = QueryManager.getST1AgtOrdUpdQuery();</span>
<span class="nc" id="L1175">				agtOrderStmt = connection.prepareStatement(agtOrderQuery);</span>

<span class="nc" id="L1177">				gameInvStatusQuery = QueryManager.getST1AgtUpdGameInvStatusQuery();</span>

<span class="nc" id="L1179">				gameInvDetailQuery = QueryManager.getST1InvDetailWithWarehouseInsertQuery();</span>
<span class="nc" id="L1180">				gameInvDetailStmt = connection.prepareStatement(gameInvDetailQuery);</span>

<span class="nc" id="L1182">				orderInvoicesQuery = QueryManager.getST1AgentOrderInInsertQuery();</span>
<span class="nc" id="L1183">				orderInvoicesPrtSt = connection.prepareStatement(orderInvoicesQuery);</span>

<span class="nc" id="L1185">				getBookfromPackQuery = &quot;select book_nbr from st_se_game_inv_status where pack_nbr=?&quot;;</span>
<span class="nc" id="L1186">				getBookFromPackPstmt = connection.prepareStatement(getBookfromPackQuery);</span>

<span class="nc" id="L1188">				isGovtCommChangedQuery = &quot;select count(*) from st_se_game_govt_comm_history where game_id=?&quot;;</span>
<span class="nc" id="L1189">				isGovtCommChngdPstmt = connection.prepareStatement(isGovtCommChangedQuery);</span>

<span class="nc" id="L1191">				String fetchPurRateQuery = &quot;select transacrion_sale_comm_rate from st_se_game_inv_detail where &quot; + &quot;book_nbr=? and transaction_at='BO' order by transaction_date desc limit 1&quot;;</span>
<span class="nc" id="L1192">				PreparedStatement fetchPurRatePstmt = connection.prepareStatement(fetchPurRateQuery);</span>
<span class="nc" id="L1193">				ResultSet fetchPurRateRs = null;</span>

<span class="nc" id="L1195">				String detHistoryInsQuery = &quot;insert into st_se_game_ticket_inv_history(game_id, book_nbr, &quot;</span>
						+ &quot; current_owner, current_owner_id, date, done_by_oid, done_by_uid, cur_rem_tickets, &quot;
						+ &quot; active_tickets_upto, sold_tickets, status) values (?,?,?,?,?,?,?,?,?,?,?)&quot;;
<span class="nc" id="L1198">				PreparedStatement detHistoryInsPstmt = connection</span>
						.prepareStatement(detHistoryInsQuery);

<span class="nc" id="L1201">				double mrpAmt = 0.0;</span>
<span class="nc" id="L1202">				double commAmt = 0.0;</span>
<span class="nc" id="L1203">				double netAmt = 0.0;</span>
<span class="nc" id="L1204">				double vatAmt = 0.0;</span>
<span class="nc" id="L1205">				double taxableSale = 0.0;</span>
<span class="nc" id="L1206">				double retSaleCommRate = 0.0;</span>
<span class="nc" id="L1207">				double creditAmt = 0.0;</span>
<span class="nc" id="L1208">				int nbrOfbooksApp = 0;</span>
<span class="nc" id="L1209">				int nbrBooksalreadyDispatched = 0;</span>
<span class="nc" id="L1210">				int nbrOfBooksDispatched = 0;</span>

<span class="nc" id="L1212">				totalDispatch = connection.createStatement();</span>
<span class="nc" id="L1213">				totalDispatchResult = totalDispatch.executeQuery(countDispatchedTotal);</span>
<span class="nc bnc" id="L1214" title="All 2 branches missed.">				while (totalDispatchResult.next()) {</span>
<span class="nc" id="L1215">					totalDispatchedForOrder = totalDispatchedForOrder + totalDispatchResult.getInt(&quot;nbr_of_books_dlvrd&quot;);</span>

				}

<span class="nc" id="L1219">				int gameId = -1;</span>
<span class="nc" id="L1220">				List&lt;PackBean&gt; packList = null;</span>
<span class="nc" id="L1221">				List&lt;BookBean&gt; bookList = null;</span>
<span class="nc" id="L1222">				PackBean packBean = null;</span>
<span class="nc" id="L1223">				BookBean bookBean = null;</span>

				/*agtReceiptStmt = connection.prepareStatement(QueryManager.insertInReceiptMaster());
				agtReceiptStmt.setString(1, &quot;AGENT&quot;);
				agtReceiptStmt.executeUpdate();

				ResultSet rs = agtReceiptStmt.getGeneratedKeys();
				int invoiceId = -1;
				while (rs.next()) {
					invoiceId = rs.getInt(1);
				}*/

<span class="nc" id="L1235">				agtReceiptStmt = connection.prepareStatement(QueryManager.insertInReceiptMaster());</span>
<span class="nc" id="L1236">				agtReceiptStmt.setString(1, &quot;AGENT&quot;);</span>
<span class="nc" id="L1237">				agtReceiptStmt.executeUpdate();</span>

<span class="nc" id="L1239">				ResultSet DCrs = agtReceiptStmt.getGeneratedKeys();</span>
<span class="nc bnc" id="L1240" title="All 2 branches missed.">				while (DCrs.next()) {</span>
<span class="nc" id="L1241">					DCId = DCrs.getInt(1);</span>
				}

<span class="nc bnc" id="L1244" title="All 2 branches missed.">				for (int i = 0; i &lt; invOrderList.size(); i++) {</span>
<span class="nc" id="L1245">					boolean isGovtCommChanged = false;</span>
<span class="nc" id="L1246">					invOrderBean = invOrderList.get(i);</span>
<span class="nc" id="L1247">					gameBean = invOrderBean.getOrderedGameBean();</span>
<span class="nc" id="L1248">					gameId = gameBean.getGameId();</span>

<span class="nc" id="L1250">					String fetchGameDetQuery = &quot;select nbr_of_tickets_per_book from st_se_game_master where game_id =&quot; + gameId;</span>
<span class="nc" id="L1251">					Statement fetchGameDetStmt = connection.createStatement();</span>
<span class="nc" id="L1252">					ResultSet fetchGameDetRs = fetchGameDetStmt.executeQuery(fetchGameDetQuery);</span>
<span class="nc" id="L1253">					int noOfTktPerBooks = -1;</span>
<span class="nc bnc" id="L1254" title="All 2 branches missed.">					if (fetchGameDetRs.next()) {</span>
<span class="nc" id="L1255">						noOfTktPerBooks = fetchGameDetRs.getInt(&quot;nbr_of_tickets_per_book&quot;);</span>
					}

<span class="nc" id="L1258">					isGovtCommChngdPstmt.setInt(1, gameId);</span>
<span class="nc" id="L1259">					ResultSet isGovtCommChngdRs = isGovtCommChngdPstmt.executeQuery();</span>
<span class="nc bnc" id="L1260" title="All 2 branches missed.">					if (isGovtCommChngdRs.next()) {</span>
<span class="nc bnc" id="L1261" title="All 2 branches missed.">						if (isGovtCommChngdRs.getInt(1) &gt; 1) {</span>
<span class="nc" id="L1262">							isGovtCommChanged = true;</span>
						}
					}

<span class="nc" id="L1266">					String newBookStatus = &quot;ASSIGNED&quot;;</span>
<span class="nc bnc" id="L1267" title="All 2 branches missed.">					if (isGovtCommChanged == false) {</span>
<span class="nc" id="L1268">						nbrOfbooksApp = gameBean.getNbrOfBooksApp();</span>
<span class="nc" id="L1269">						nbrBooksalreadyDispatched = gameBean.getNbrOfBooksDlvrd();</span>
<span class="nc" id="L1270">						int nbrOfBooksPerPack = gameBean.getNbrOfBooksPerPack();</span>
<span class="nc" id="L1271">						nbrOfBooksDispatched = nbrBooksalreadyDispatched + getDispatchedNbrOfBooks(invOrderBean, nbrOfBooksPerPack);</span>
<span class="nc" id="L1272">						totalDispatchedForOrder = totalDispatchedForOrder + getDispatchedNbrOfBooks(invOrderBean, nbrOfBooksPerPack);</span>
<span class="nc" id="L1273">						int currentlyDispatched = getDispatchedNbrOfBooks(invOrderBean, nbrOfBooksPerPack);</span>

						// insert in LMS transaction master
						/*LMSMasterStmt.setString(1, &quot;AGENT&quot;);
						LMSMasterStmt.executeUpdate();
						rsMaster = null;
						rsMaster = LMSMasterStmt.getGeneratedKeys();
						while (rsMaster.next()) {
							masterTrnId = rsMaster.getInt(1);
							trnIdList.add(masterTrnId);
						}

						agtMasterStmt.setInt(1, masterTrnId);
						agtMasterStmt.setInt(2, agtId);
						agtMasterStmt.setInt(3, userOrgID);
						agtMasterStmt.setString(4, &quot;RETAILER&quot;);
						agtMasterStmt.setInt(5, retOrgId);
						agtMasterStmt.setString(6, &quot;SALE&quot;);
						agtMasterStmt.setTimestamp(7, currentDate);
						agtMasterStmt.execute();

						agtAgentStmt.setInt(1, masterTrnId);
						agtAgentStmt.setInt(2, gameId);
						agtAgentStmt.setInt(3, agtId);
						agtAgentStmt.setInt(4, retOrgId);

						mrpAmt = currentlyDispatched * gameBean.getBookPrice();
						agtAgentStmt.setDouble(5, mrpAmt);

						retSaleCommRate = gameBean.getRetSaleCommRate() + gameBean.getRetGameCommVariance();
						commAmt = mrpAmt * retSaleCommRate * 0.01;
						agtAgentStmt.setDouble(6, commAmt);

						netAmt = mrpAmt - commAmt;
						creditAmt += netAmt;

						vatAmt = CommonMethods.calculateVat(mrpAmt, retSaleCommRate, gameBean.getPrizePayOutRatio(), gameBean.getGovtComm(), gameBean.getVat(), gameBean.getGovtCommRule(), gameBean.getFixedAmt(), gameBean.getTicketsInScheme());
						taxableSale = CommonMethods.calTaxableSale(mrpAmt, retSaleCommRate, gameBean.getPrizePayOutRatio(), gameBean.getGovtComm(), gameBean.getVat());

						agtAgentStmt.setDouble(7, netAmt);
						agtAgentStmt.setString(8, &quot;SALE&quot;);
						agtAgentStmt.setInt(9, currentlyDispatched);
						agtAgentStmt.setDouble(10, vatAmt);
						agtAgentStmt.setDouble(11, taxableSale);
						agtAgentStmt.setInt(12, userOrgID);
						agtAgentStmt.execute();*/
<span class="nc" id="L1319">						agtOrdGameStmt.setInt(1, nbrOfBooksDispatched);</span>
<span class="nc" id="L1320">						agtOrdGameStmt.setInt(2, orderId);</span>
<span class="nc" id="L1321">						agtOrdGameStmt.setInt(3, gameId);</span>
<span class="nc" id="L1322">						agtOrdGameStmt.execute();</span>

<span class="nc bnc" id="L1324" title="All 2 branches missed.">						if (total == totalDispatchedForOrder) {</span>
<span class="nc" id="L1325">							agtOrderStmt.setString(1, &quot;ASSIGNED&quot;);</span>
<span class="nc" id="L1326">							agtOrderStmt.setInt(2, orderId);</span>
<span class="nc" id="L1327">							agtOrderStmt.executeUpdate();</span>

<span class="nc" id="L1329">							orderInvoicesPrtSt.setInt(1, orderId);</span>
<span class="nc" id="L1330">							orderInvoicesPrtSt.setString(2, null);</span>
<span class="nc" id="L1331">							orderInvoicesPrtSt.setInt(3, retOrgId);</span>
<span class="nc" id="L1332">							orderInvoicesPrtSt.setInt(4, gameId);</span>
<span class="nc" id="L1333">							orderInvoicesPrtSt.setString(5, &quot;ASSIGNED&quot;);</span>
<span class="nc" id="L1334">							orderInvoicesPrtSt.setInt(6, nbrOfBooksDispatched);</span>
<span class="nc" id="L1335">							orderInvoicesPrtSt.setInt(7, agtId);</span>
<span class="nc" id="L1336">							orderInvoicesPrtSt.setInt(8, userOrgID);</span>
<span class="nc" id="L1337">							orderInvoicesPrtSt.setInt(9, DCId);</span>
<span class="nc" id="L1338">							orderInvoicesPrtSt.executeUpdate();</span>
						} else {
<span class="nc" id="L1340">							agtOrderStmt.setString(1, &quot;SEMI_ASSIGNED&quot;);</span>
<span class="nc" id="L1341">							agtOrderStmt.setInt(2, orderId);</span>
<span class="nc" id="L1342">							agtOrderStmt.executeUpdate();</span>

<span class="nc" id="L1344">							orderInvoicesPrtSt.setInt(1, orderId);</span>
<span class="nc" id="L1345">							orderInvoicesPrtSt.setString(2, null);</span>
<span class="nc" id="L1346">							orderInvoicesPrtSt.setInt(3, retOrgId);</span>
<span class="nc" id="L1347">							orderInvoicesPrtSt.setInt(4, gameId);</span>
<span class="nc" id="L1348">							orderInvoicesPrtSt.setString(5, &quot;SEMI_ASSIGNED&quot;);</span>
<span class="nc" id="L1349">							orderInvoicesPrtSt.setInt(6, nbrOfBooksDispatched);</span>
<span class="nc" id="L1350">							orderInvoicesPrtSt.setInt(7, agtId);</span>
<span class="nc" id="L1351">							orderInvoicesPrtSt.setInt(8, userOrgID);</span>
<span class="nc" id="L1352">							orderInvoicesPrtSt.setInt(9, DCId);</span>
<span class="nc" id="L1353">							orderInvoicesPrtSt.executeUpdate();</span>
						}

<span class="nc" id="L1356">						ResultSet rs = orderInvoicesPrtSt.getGeneratedKeys();</span>
<span class="nc" id="L1357">						int orderInvoiceDCId = -1;</span>
<span class="nc bnc" id="L1358" title="All 2 branches missed.">						while (rs.next()) {</span>
<span class="nc" id="L1359">							orderInvoiceDCId = rs.getInt(1);</span>
						}

<span class="nc" id="L1362">						packList = invOrderBean.getPackList();</span>
<span class="nc bnc" id="L1363" title="All 2 branches missed.">						if (packList != null) {</span>
<span class="nc" id="L1364">							invQuery = gameInvStatusQuery + &quot; and pack_nbr = ? &quot;;</span>
<span class="nc" id="L1365">							gameInvStatusStmt = connection.prepareStatement(invQuery);</span>
<span class="nc" id="L1366">							String packNbr = null;</span>

<span class="nc bnc" id="L1368" title="All 2 branches missed.">							for (int j = 0; j &lt; packList.size(); j++) {</span>
<span class="nc" id="L1369">								packBean = packList.get(j);</span>
<span class="nc" id="L1370">								packNbr = packBean.getPackNumber();</span>

<span class="nc" id="L1372">								gameInvStatusStmt.setString(1, &quot;RETAILER&quot;);</span>
<span class="nc" id="L1373">								gameInvStatusStmt.setInt(2, retOrgId);</span>
<span class="nc" id="L1374">								gameInvStatusStmt.setString(3, newBookStatus);</span>

								// Added by arun on update status table

<span class="nc" id="L1378">								gameInvStatusStmt.setInt(4, noOfTktPerBooks);</span>
<span class="nc bnc" id="L1379" title="All 2 branches missed.">								if (&quot;ACTIVE&quot;.equalsIgnoreCase(newBookStatus.trim())) {</span>
<span class="nc" id="L1380">									gameInvStatusStmt</span>
											.setInt(5, noOfTktPerBooks);
								} else {
<span class="nc" id="L1383">									gameInvStatusStmt.setInt(5, 0);</span>
								}
<span class="nc" id="L1385">								gameInvStatusStmt.setString(6, String.valueOf(DCId));</span>
<span class="nc" id="L1386">								gameInvStatusStmt.setInt(7, gameId);</span>
<span class="nc" id="L1387">								gameInvStatusStmt.setString(8, packNbr);</span>
<span class="nc" id="L1388">								gameInvStatusStmt.execute();</span>

<span class="nc" id="L1390">								List&lt;String&gt; books = getBooksForPack(connection, gameId, packNbr);</span>

<span class="nc bnc" id="L1392" title="All 2 branches missed.">								for (int k = 0; k &lt; books.size(); k++) {</span>
<span class="nc" id="L1393">									warehouseId = ScratchGameDataDaoImpl.getSingleInstance().getWarehouseNbrForBook(connection, gameId, books.get(k));</span>
<span class="nc" id="L1394">									gameInvDetailStmt.setString(1, null);</span>
<span class="nc" id="L1395">									gameInvDetailStmt.setInt(2, gameId);</span>
<span class="nc" id="L1396">									gameInvDetailStmt.setString(3, packNbr);</span>
<span class="nc" id="L1397">									gameInvDetailStmt.setString(4, books.get(k));</span>
<span class="nc" id="L1398">									gameInvDetailStmt.setString(5, &quot;RETAILER&quot;);</span>
<span class="nc" id="L1399">									gameInvDetailStmt.setInt(6, retOrgId);</span>
<span class="nc" id="L1400">									gameInvDetailStmt.setTimestamp(7, currentDate);</span>
<span class="nc" id="L1401">									gameInvDetailStmt.setString(8, &quot;AGENT&quot;);</span>
<span class="nc" id="L1402">									gameInvDetailStmt.setString(9, newBookStatus);</span>
<span class="nc" id="L1403">									gameInvDetailStmt.setInt(10, orderInvoiceDCId);</span>
<span class="nc" id="L1404">									gameInvDetailStmt.setInt(11, warehouseId);</span>
<span class="nc" id="L1405">									gameInvDetailStmt.execute();</span>

<span class="nc" id="L1407">									detHistoryInsPstmt.setInt(1, gameId);</span>
<span class="nc" id="L1408">									detHistoryInsPstmt.setString(2, books.get(k));</span>
<span class="nc" id="L1409">									detHistoryInsPstmt.setString(3, &quot;RETAILER&quot;);</span>
<span class="nc" id="L1410">									detHistoryInsPstmt.setInt(4, retOrgId);</span>
<span class="nc" id="L1411">									detHistoryInsPstmt.setTimestamp(5,</span>
											currentDate);
<span class="nc" id="L1413">									detHistoryInsPstmt.setInt(6, userOrgID);</span>
<span class="nc" id="L1414">									detHistoryInsPstmt.setInt(7, agtId);</span>
<span class="nc" id="L1415">									detHistoryInsPstmt.setInt(8,</span>
											noOfTktPerBooks);
<span class="nc bnc" id="L1417" title="All 2 branches missed.">									if (&quot;ACTIVE&quot;.equalsIgnoreCase(newBookStatus</span>
											.trim())) {
<span class="nc" id="L1419">										detHistoryInsPstmt.setInt(9,</span>
												noOfTktPerBooks);
									} else {
<span class="nc" id="L1422">										detHistoryInsPstmt.setInt(9, 0);</span>
									}
<span class="nc" id="L1424">									detHistoryInsPstmt.setInt(10, 0);</span>
<span class="nc" id="L1425">									detHistoryInsPstmt.setString(11,</span>
											newBookStatus);
<span class="nc" id="L1427">									detHistoryInsPstmt.execute();</span>

								}

							}
						}

<span class="nc" id="L1434">						bookList = invOrderBean.getBookList();</span>
<span class="nc bnc" id="L1435" title="All 2 branches missed.">						if (bookList != null) {</span>
<span class="nc" id="L1436">							invQuery = gameInvStatusQuery + &quot; and book_nbr = ?&quot;;</span>
<span class="nc" id="L1437">							gameInvStatusStmt = connection</span>
									.prepareStatement(invQuery);
<span class="nc" id="L1439">							String bookNbr = null;</span>
<span class="nc" id="L1440">							String packNbr = null;</span>
<span class="nc bnc" id="L1441" title="All 2 branches missed.">							for (int j = 0; j &lt; bookList.size(); j++) {</span>
<span class="nc" id="L1442">								bookBean = bookList.get(j);</span>
<span class="nc" id="L1443">								bookNbr = bookBean.getBookNumber();</span>
<span class="nc" id="L1444">								gameInvStatusStmt.setString(1, &quot;RETAILER&quot;);</span>
<span class="nc" id="L1445">								gameInvStatusStmt.setInt(2, retOrgId);</span>
<span class="nc" id="L1446">								gameInvStatusStmt.setString(3, newBookStatus);</span>
<span class="nc" id="L1447">								gameInvStatusStmt.setInt(4, noOfTktPerBooks);</span>
<span class="nc bnc" id="L1448" title="All 2 branches missed.">								if (&quot;ACTIVE&quot;.equalsIgnoreCase(newBookStatus.trim())) {</span>
<span class="nc" id="L1449">									gameInvStatusStmt.setInt(5, noOfTktPerBooks);</span>
								} else {
<span class="nc" id="L1451">									gameInvStatusStmt.setInt(5, 0);</span>
								}
<span class="nc" id="L1453">								gameInvStatusStmt.setString(6, String.valueOf(DCId));</span>
<span class="nc" id="L1454">								gameInvStatusStmt.setInt(7, gameId);</span>
<span class="nc" id="L1455">								gameInvStatusStmt.setString(8, bookNbr);</span>
<span class="nc" id="L1456">								gameInvStatusStmt.execute();</span>

								/*fetchPurRatePstmt.setString(1, bookNbr);
								fetchPurRateRs = fetchPurRatePstmt.executeQuery();
								if (fetchPurRateRs.next()) {
									purRate = fetchPurRateRs.getDouble(&quot;transacrion_sale_comm_rate&quot;);
								}*/

<span class="nc" id="L1464">								packNbr = getPackNbrForBook(connection, gameId, bookNbr);</span>
<span class="nc" id="L1465">								warehouseId = ScratchGameDataDaoImpl.getSingleInstance().getWarehouseNbrForBook(connection, gameId, bookNbr);</span>
<span class="nc" id="L1466">								gameInvDetailStmt.setString(1, null);</span>
<span class="nc" id="L1467">								gameInvDetailStmt.setInt(2, gameId);</span>
<span class="nc" id="L1468">								gameInvDetailStmt.setString(3, packNbr);</span>
<span class="nc" id="L1469">								gameInvDetailStmt.setString(4, bookNbr);</span>
<span class="nc" id="L1470">								gameInvDetailStmt.setString(5, &quot;RETAILER&quot;);</span>
<span class="nc" id="L1471">								gameInvDetailStmt.setInt(6, retOrgId);</span>
<span class="nc" id="L1472">								gameInvDetailStmt.setTimestamp(7, currentDate);</span>
<span class="nc" id="L1473">								gameInvDetailStmt.setString(8, &quot;AGENT&quot;);</span>
<span class="nc" id="L1474">								gameInvDetailStmt.setString(9, newBookStatus);</span>
<span class="nc" id="L1475">								gameInvDetailStmt.setInt(10, orderInvoiceDCId);</span>
<span class="nc" id="L1476">								gameInvDetailStmt.setInt(11, warehouseId);</span>
<span class="nc" id="L1477">								gameInvDetailStmt.execute();</span>

<span class="nc" id="L1479">								detHistoryInsPstmt.setInt(1, gameId);</span>
<span class="nc" id="L1480">								detHistoryInsPstmt.setString(2, bookNbr);</span>
<span class="nc" id="L1481">								detHistoryInsPstmt.setString(3, &quot;RETAILER&quot;);</span>
<span class="nc" id="L1482">								detHistoryInsPstmt.setInt(4, retOrgId);</span>
<span class="nc" id="L1483">								detHistoryInsPstmt.setTimestamp(5, currentDate);</span>
<span class="nc" id="L1484">								detHistoryInsPstmt.setInt(6, userOrgID);</span>
<span class="nc" id="L1485">								detHistoryInsPstmt.setInt(7, agtId);</span>
<span class="nc" id="L1486">								detHistoryInsPstmt.setInt(8, noOfTktPerBooks);</span>
<span class="nc bnc" id="L1487" title="All 2 branches missed.">								if (&quot;ACTIVE&quot;.equalsIgnoreCase(newBookStatus.trim())) {</span>
<span class="nc" id="L1488">									detHistoryInsPstmt.setInt(9, noOfTktPerBooks);</span>
								} else {
<span class="nc" id="L1490">									detHistoryInsPstmt.setInt(9, 0);</span>
								}
<span class="nc" id="L1492">								detHistoryInsPstmt.setInt(10, 0);</span>
<span class="nc" id="L1493">								detHistoryInsPstmt.setString(11, newBookStatus);</span>
<span class="nc" id="L1494">								detHistoryInsPstmt.execute();</span>
							}
						}
<span class="nc" id="L1497">					} else {</span>
<span class="nc" id="L1498">						nbrOfbooksApp = gameBean.getNbrOfBooksApp();</span>
<span class="nc" id="L1499">						nbrBooksalreadyDispatched = gameBean.getNbrOfBooksDlvrd();</span>
<span class="nc" id="L1500">						int nbrOfBooksPerPack = gameBean.getNbrOfBooksPerPack();</span>

<span class="nc" id="L1502">						nbrOfBooksDispatched = nbrBooksalreadyDispatched + getDispatchedNbrOfBooks(invOrderBean, nbrOfBooksPerPack);</span>
<span class="nc" id="L1503">						totalDispatchedForOrder = totalDispatchedForOrder + getDispatchedNbrOfBooks(invOrderBean, nbrOfBooksPerPack);</span>
<span class="nc" id="L1504">						int currentlyDispatched = getDispatchedNbrOfBooks(invOrderBean, nbrOfBooksPerPack);</span>

<span class="nc" id="L1506">						mrpAmt = currentlyDispatched * gameBean.getBookPrice();</span>
<span class="nc" id="L1507">						retSaleCommRate = gameBean.getRetSaleCommRate() + gameBean.getRetGameCommVariance();</span>
<span class="nc" id="L1508">						commAmt = mrpAmt * retSaleCommRate * 0.01;</span>
<span class="nc" id="L1509">						netAmt = mrpAmt - commAmt;</span>
<span class="nc" id="L1510">						creditAmt += netAmt;</span>

<span class="nc" id="L1512">						packList = invOrderBean.getPackList();</span>
<span class="nc" id="L1513">						bookList = invOrderBean.getBookList();</span>

<span class="nc bnc" id="L1515" title="All 2 branches missed.">						if (packList != null) {</span>
<span class="nc" id="L1516">							String packNbr = null;</span>
<span class="nc bnc" id="L1517" title="All 2 branches missed.">							for (int j = 0; j &lt; packList.size(); j++) {</span>
<span class="nc" id="L1518">								packBean = packList.get(j);</span>
<span class="nc" id="L1519">								packNbr = packBean.getPackNumber();</span>
<span class="nc" id="L1520">								getBookFromPackPstmt.setString(1, packNbr);</span>
<span class="nc" id="L1521">								ResultSet rsBookFrmPack = getBookFromPackPstmt.executeQuery();</span>
<span class="nc bnc" id="L1522" title="All 2 branches missed.">								while (rsBookFrmPack.next()) {</span>
<span class="nc" id="L1523">									bookBean = new BookBean();</span>
<span class="nc" id="L1524">									String bookNbrfromPack = rsBookFrmPack.getString(&quot;book_nbr&quot;);</span>
<span class="nc" id="L1525">									bookBean.setBookNumber(bookNbrfromPack);</span>
<span class="nc" id="L1526">									bookList.add(bookBean);</span>
<span class="nc" id="L1527">								}</span>
							}
						}

						ResultSet rsCommVar;
<span class="nc" id="L1532">						ArrayList&lt;BookSaleBean&gt; bookSaleBeanList = new ArrayList&lt;BookSaleBean&gt;();</span>
						BookSaleBean bookSaleBean;
<span class="nc bnc" id="L1534" title="All 2 branches missed.">						for (int bookListSize = 0; bookListSize &lt; bookList.size(); bookListSize++) {</span>
<span class="nc" id="L1535">							bookSaleBean = new BookSaleBean();</span>
<span class="nc" id="L1536">							double govtCommRate = 0.0;</span>
<span class="nc" id="L1537">							double vatAmtForBook = 0.0;</span>
<span class="nc" id="L1538">							double taxableSaleForbook = 0.0;</span>
<span class="nc" id="L1539">							bookBean = bookList.get(bookListSize);</span>
<span class="nc" id="L1540">							String bookfromBookList = bookBean.getBookNumber();</span>
<span class="nc" id="L1541">							String govtCommVarianceQuery = &quot;select transaction_gov_comm_rate,transaction_date from st_se_game_inv_detail where current_owner=? and current_owner_id=? and game_id=? and book_nbr=? and transaction_at=? order by transaction_date desc limit 1 &quot;;</span>
<span class="nc" id="L1542">							PreparedStatement govtCommVariaceStmt = connection.prepareStatement(govtCommVarianceQuery);</span>
<span class="nc" id="L1543">							govtCommVariaceStmt.setString(1, &quot;AGENT&quot;);</span>
<span class="nc" id="L1544">							govtCommVariaceStmt.setInt(2, userOrgID);</span>
<span class="nc" id="L1545">							govtCommVariaceStmt.setInt(3, gameId);</span>
<span class="nc" id="L1546">							govtCommVariaceStmt.setString(4, bookfromBookList);</span>
<span class="nc" id="L1547">							govtCommVariaceStmt.setString(5, &quot;BO&quot;);</span>
<span class="nc" id="L1548">							rsCommVar = govtCommVariaceStmt.executeQuery();</span>
<span class="nc bnc" id="L1549" title="All 2 branches missed.">							while (rsCommVar.next()) {</span>
<span class="nc" id="L1550">								govtCommRate = rsCommVar.getDouble(&quot;transaction_gov_comm_rate&quot;);</span>
							}

<span class="nc" id="L1553">							vatAmtForBook = CommonMethods.calculateVat(gameBean.getBookPrice(), retSaleCommRate, gameBean.getPrizePayOutRatio(), govtCommRate, gameBean.getVat(), gameBean.getGovtCommRule(), gameBean.getFixedAmt(), gameBean.getTicketsInScheme());</span>
<span class="nc" id="L1554">							taxableSaleForbook = CommonMethods.calTaxableSale(gameBean.getBookPrice(), retSaleCommRate, gameBean.getPrizePayOutRatio(), govtCommRate, gameBean.getVat());</span>

<span class="nc" id="L1556">							bookSaleBean.setBookNumber(bookfromBookList);</span>
<span class="nc" id="L1557">							bookSaleBean.setBookTaxableSale(taxableSaleForbook);</span>
<span class="nc" id="L1558">							bookSaleBean.setBookVatAmt(vatAmtForBook);</span>
<span class="nc" id="L1559">							bookSaleBean.setTotalSaleGovtComm(govtCommRate);</span>
<span class="nc" id="L1560">							bookSaleBeanList.add(bookSaleBean);</span>
						}

<span class="nc" id="L1563">						Set&lt;Double&gt; GovtCommVarianceSet = new HashSet&lt;Double&gt;();</span>
<span class="nc" id="L1564">						String queryGovtCommVarHistory = &quot;select DISTINCT govt_comm_rate from st_se_game_govt_comm_history where game_id=&quot; + gameId;</span>
<span class="nc" id="L1565">						PreparedStatement stmtGovtCommVarHistory = connection.prepareStatement(queryGovtCommVarHistory);</span>
<span class="nc" id="L1566">						ResultSet rsGovtCommVarHistory = stmtGovtCommVarHistory.executeQuery();</span>
<span class="nc bnc" id="L1567" title="All 2 branches missed.">						while (rsGovtCommVarHistory.next()) {</span>
<span class="nc" id="L1568">							GovtCommVarianceSet.add(rsGovtCommVarHistory.getDouble(&quot;govt_comm_rate&quot;));</span>
						}

						Iterator&lt;Double&gt; govtCommSetItr;
						Iterator&lt;BookSaleBean&gt; bookSaleBeanItr;
<span class="nc" id="L1573">						govtCommSetItr = GovtCommVarianceSet.iterator();</span>

<span class="nc bnc" id="L1575" title="All 2 branches missed.">						while (govtCommSetItr.hasNext()) {</span>
<span class="nc" id="L1576">							boolean bookGovtCommVarMatch = false;</span>
<span class="nc" id="L1577">							bookSaleBeanItr = bookSaleBeanList.iterator();</span>
<span class="nc" id="L1578">							List&lt;String&gt; bookListforSingleTrn = null;</span>
<span class="nc" id="L1579">							bookListforSingleTrn = new ArrayList&lt;String&gt;();</span>

<span class="nc" id="L1581">							double totVatAmt = 0.0;</span>
<span class="nc" id="L1582">							double totTaxableSale = 0.0;</span>
<span class="nc" id="L1583">							double totMrpAmt = 0.0;</span>
<span class="nc" id="L1584">							double totalCommAmt = 0.0;</span>
<span class="nc" id="L1585">							double totalNetAmt = 0.0;</span>

<span class="nc" id="L1587">							Double govtCommFormSet = (Double) govtCommSetItr.next();</span>
<span class="nc bnc" id="L1588" title="All 2 branches missed.">							while (bookSaleBeanItr.hasNext()) {</span>
<span class="nc" id="L1589">								bookSaleBean = (BookSaleBean) bookSaleBeanItr.next();</span>
<span class="nc bnc" id="L1590" title="All 2 branches missed.">								if (bookSaleBean.getTotalSaleGovtComm() == govtCommFormSet) {</span>
<span class="nc" id="L1591">									bookGovtCommVarMatch = true;</span>
<span class="nc" id="L1592">									totVatAmt = totVatAmt + bookSaleBean.getBookVatAmt();</span>
<span class="nc" id="L1593">									totTaxableSale = totTaxableSale + bookSaleBean.getBookTaxableSale();</span>
<span class="nc" id="L1594">									totMrpAmt = totMrpAmt + gameBean.getBookPrice();</span>
<span class="nc" id="L1595">									bookListforSingleTrn.add(bookSaleBean.getBookNumber());</span>
								}
							}

<span class="nc bnc" id="L1599" title="All 2 branches missed.">							if (total == totalDispatchedForOrder) {</span>
<span class="nc" id="L1600">								agtOrderStmt.setString(1, &quot;ASSIGNED&quot;);</span>
<span class="nc" id="L1601">								agtOrderStmt.setInt(2, orderId);</span>
<span class="nc" id="L1602">								agtOrderStmt.executeUpdate();</span>

<span class="nc" id="L1604">								orderInvoicesPrtSt.setInt(1, orderId);</span>
<span class="nc" id="L1605">								orderInvoicesPrtSt.setString(2, null);</span>
<span class="nc" id="L1606">								orderInvoicesPrtSt.setInt(3, retOrgId);</span>
<span class="nc" id="L1607">								orderInvoicesPrtSt.setInt(4, gameId);</span>
<span class="nc" id="L1608">								orderInvoicesPrtSt.setString(5, &quot;ASSIGNED&quot;);</span>
<span class="nc" id="L1609">								orderInvoicesPrtSt.setInt(6, nbrOfBooksDispatched);</span>
<span class="nc" id="L1610">								orderInvoicesPrtSt.setInt(7, agtId);</span>
<span class="nc" id="L1611">								orderInvoicesPrtSt.setInt(8, userOrgID);</span>
<span class="nc" id="L1612">								orderInvoicesPrtSt.setInt(9, DCId);</span>
<span class="nc" id="L1613">								orderInvoicesPrtSt.executeUpdate();</span>
							} else {
<span class="nc" id="L1615">								agtOrderStmt.setString(1, &quot;SEMI_ASSIGNED&quot;);</span>
<span class="nc" id="L1616">								agtOrderStmt.setInt(2, orderId);</span>
<span class="nc" id="L1617">								agtOrderStmt.executeUpdate();</span>

<span class="nc" id="L1619">								orderInvoicesPrtSt.setInt(1, orderId);</span>
<span class="nc" id="L1620">								orderInvoicesPrtSt.setString(2, null);</span>
<span class="nc" id="L1621">								orderInvoicesPrtSt.setInt(3, retOrgId);</span>
<span class="nc" id="L1622">								orderInvoicesPrtSt.setInt(4, gameId);</span>
<span class="nc" id="L1623">								orderInvoicesPrtSt.setString(5, &quot;SEMI_ASSIGNED&quot;);</span>
<span class="nc" id="L1624">								orderInvoicesPrtSt.setInt(6, nbrOfBooksDispatched);</span>
<span class="nc" id="L1625">								orderInvoicesPrtSt.setInt(7, agtId);</span>
<span class="nc" id="L1626">								orderInvoicesPrtSt.setInt(8, userOrgID);</span>
<span class="nc" id="L1627">								orderInvoicesPrtSt.setInt(9, DCId);</span>
<span class="nc" id="L1628">								orderInvoicesPrtSt.executeUpdate();</span>
							}

<span class="nc" id="L1631">							ResultSet rs = orderInvoicesPrtSt.getGeneratedKeys();</span>
<span class="nc" id="L1632">							int orderInvoiceDCId = -1;</span>
<span class="nc bnc" id="L1633" title="All 2 branches missed.">							while (rs.next()) {</span>
<span class="nc" id="L1634">								orderInvoiceDCId = rs.getInt(1);</span>
							}

<span class="nc" id="L1637">							totalCommAmt = totMrpAmt * retSaleCommRate * 0.01;</span>
<span class="nc" id="L1638">							totalNetAmt = totMrpAmt - totalCommAmt;</span>
<span class="nc bnc" id="L1639" title="All 2 branches missed.">							if (bookGovtCommVarMatch) {</span>
								/*LMSMasterStmt.setString(1, &quot;AGENT&quot;);
								LMSMasterStmt.executeUpdate();

								rsMaster = null;
								rsMaster = LMSMasterStmt.getGeneratedKeys();
								while (rsMaster.next()) {
									masterTrnId = rsMaster.getInt(1);
									trnIdList.add(masterTrnId);
								}

								agtMasterStmt.setInt(1, masterTrnId);
								agtMasterStmt.setInt(2, agtId);
								agtMasterStmt.setInt(3, userOrgID);
								agtMasterStmt.setString(4, &quot;RETAILER&quot;);
								agtMasterStmt.setInt(5, retOrgId);
								agtMasterStmt.setString(6, &quot;SALE&quot;);
								agtMasterStmt.setTimestamp(7, currentDate);
								agtMasterStmt.execute();

								agtAgentStmt.setInt(1, masterTrnId);
								agtAgentStmt.setInt(2, gameId);
								agtAgentStmt.setInt(3, agtId);
								agtAgentStmt.setInt(4, retOrgId);
								agtAgentStmt.setDouble(5, totMrpAmt);
								agtAgentStmt.setDouble(6, totalCommAmt);
								agtAgentStmt.setDouble(7, totalNetAmt);
								agtAgentStmt.setString(8, &quot;SALE&quot;);
								agtAgentStmt.setInt(9, bookListforSingleTrn.size());
								agtAgentStmt.setDouble(10, totVatAmt);
								agtAgentStmt.setDouble(11, totTaxableSale);
								agtAgentStmt.setInt(12, userOrgID);
								agtAgentStmt.execute();*/

<span class="nc bnc" id="L1673" title="All 2 branches missed.">								for (int j = 0; j &lt; bookListforSingleTrn.size(); j++) {</span>
<span class="nc" id="L1674">									String bknbr = (String) bookListforSingleTrn.get(j);</span>
<span class="nc" id="L1675">									String pkNbr = getPackNbrForBook(connection, gameId, bknbr);</span>
<span class="nc" id="L1676">									warehouseId = ScratchGameDataDaoImpl.getSingleInstance().getWarehouseNbrForBook(connection, gameId, bknbr);</span>
									/*fetchPurRatePstmt.setString(1, bknbr);
									fetchPurRateRs = fetchPurRatePstmt.executeQuery();
									if (fetchPurRateRs.next()) {
										purRate = fetchPurRateRs.getDouble(&quot;transacrion_sale_comm_rate&quot;);
									}*/

<span class="nc" id="L1683">									gameInvDetailStmt.setString(1, null);</span>
<span class="nc" id="L1684">									gameInvDetailStmt.setInt(2, gameId);</span>
<span class="nc" id="L1685">									gameInvDetailStmt.setString(3, pkNbr);</span>
<span class="nc" id="L1686">									gameInvDetailStmt.setString(4, bknbr);</span>
<span class="nc" id="L1687">									gameInvDetailStmt.setString(5, &quot;RETAILER&quot;);</span>
<span class="nc" id="L1688">									gameInvDetailStmt.setInt(6, retOrgId);</span>
<span class="nc" id="L1689">									gameInvDetailStmt.setTimestamp(7, currentDate);</span>
<span class="nc" id="L1690">									gameInvDetailStmt.setString(8, &quot;AGENT&quot;);</span>
<span class="nc" id="L1691">									gameInvDetailStmt.setString(9, newBookStatus);</span>
<span class="nc" id="L1692">									gameInvDetailStmt.setInt(10, orderInvoiceDCId);</span>
<span class="nc" id="L1693">									gameInvDetailStmt.setInt(11, warehouseId);</span>
<span class="nc" id="L1694">									gameInvDetailStmt.execute();</span>

<span class="nc" id="L1696">									detHistoryInsPstmt.setInt(1, gameId);</span>
<span class="nc" id="L1697">									detHistoryInsPstmt.setString(2, bknbr);</span>
<span class="nc" id="L1698">									detHistoryInsPstmt.setString(3, &quot;RETAILER&quot;);</span>
<span class="nc" id="L1699">									detHistoryInsPstmt.setInt(4, retOrgId);</span>
<span class="nc" id="L1700">									detHistoryInsPstmt.setTimestamp(5, currentDate);</span>
<span class="nc" id="L1701">									detHistoryInsPstmt.setInt(6, userOrgID);</span>
<span class="nc" id="L1702">									detHistoryInsPstmt.setInt(7, agtId);</span>
<span class="nc" id="L1703">									detHistoryInsPstmt.setInt(8, noOfTktPerBooks);</span>
<span class="nc bnc" id="L1704" title="All 2 branches missed.">									if (&quot;ACTIVE&quot;.equalsIgnoreCase(newBookStatus.trim())) {</span>
<span class="nc" id="L1705">										detHistoryInsPstmt.setInt(9, noOfTktPerBooks);</span>
									} else {
<span class="nc" id="L1707">										detHistoryInsPstmt.setInt(9, 0);</span>
									}
<span class="nc" id="L1709">									detHistoryInsPstmt.setInt(10, 0);</span>
<span class="nc" id="L1710">									detHistoryInsPstmt.setString(11, newBookStatus);</span>
<span class="nc" id="L1711">									detHistoryInsPstmt.execute();</span>
								}
							}
<span class="nc" id="L1714">						}</span>

<span class="nc" id="L1716">						agtOrdGameStmt.setInt(1, nbrOfBooksDispatched);</span>
<span class="nc" id="L1717">						agtOrdGameStmt.setInt(2, orderId);</span>
<span class="nc" id="L1718">						agtOrdGameStmt.setInt(3, gameId);</span>
<span class="nc" id="L1719">						agtOrdGameStmt.execute();</span>

<span class="nc bnc" id="L1721" title="All 2 branches missed.">						if (bookList != null) {</span>
<span class="nc" id="L1722">							invQuery = gameInvStatusQuery + &quot; and book_nbr = ?&quot;;</span>
<span class="nc" id="L1723">							gameInvStatusStmt = connection.prepareStatement(invQuery);</span>
<span class="nc" id="L1724">							String bookNbr = null;</span>
<span class="nc bnc" id="L1725" title="All 2 branches missed.">							for (int j = 0; j &lt; bookList.size(); j++) {</span>
<span class="nc" id="L1726">								bookBean = bookList.get(j);</span>
<span class="nc" id="L1727">								bookNbr = bookBean.getBookNumber();</span>
<span class="nc" id="L1728">								gameInvStatusStmt.setString(1, &quot;RETAILER&quot;);</span>
<span class="nc" id="L1729">								gameInvStatusStmt.setInt(2, retOrgId);</span>
<span class="nc" id="L1730">								gameInvStatusStmt.setString(3, newBookStatus);</span>
<span class="nc" id="L1731">								gameInvStatusStmt.setInt(4, noOfTktPerBooks);</span>
<span class="nc bnc" id="L1732" title="All 2 branches missed.">								if (&quot;ACTIVE&quot;.equalsIgnoreCase(newBookStatus.trim())) {</span>
<span class="nc" id="L1733">									gameInvStatusStmt.setInt(5, noOfTktPerBooks);</span>
								} else {
<span class="nc" id="L1735">									gameInvStatusStmt.setInt(5, 0);</span>
								}
<span class="nc" id="L1737">								gameInvStatusStmt.setString(6, String.valueOf(DCId));</span>
<span class="nc" id="L1738">								gameInvStatusStmt.setInt(7, gameId);</span>
<span class="nc" id="L1739">								gameInvStatusStmt.setString(8, bookNbr);</span>
<span class="nc" id="L1740">								gameInvStatusStmt.execute();</span>
							}
						}

						
					}
				}

				/*agtReceiptNoGenStmt = connection.prepareStatement(QueryManager.getAGENTLatestReceiptNb());
				agtReceiptNoGenStmt.setString(1, &quot;INVOICE&quot;);
				agtReceiptNoGenStmt.setInt(2, userOrgID);
				ResultSet recieptRs = agtReceiptNoGenStmt.executeQuery();
				String lastRecieptNoGenerated = null;
				while (recieptRs.next()) {
					lastRecieptNoGenerated = recieptRs.getString(&quot;generated_id&quot;);
				}
				String autoGeneRecieptNo = GenerateRecieptNo.getRecieptNoAgt(&quot;INVOICE&quot;, lastRecieptNoGenerated, &quot;AGENT&quot;, userOrgID);*/

<span class="nc" id="L1758">				agtReceiptNoGenStmt = connection.prepareStatement(QueryManager.getAGENTLatestReceiptNb());</span>
<span class="nc" id="L1759">				agtReceiptNoGenStmt.setString(1, &quot;DLCHALLAN&quot;);</span>
<span class="nc" id="L1760">				agtReceiptNoGenStmt.setInt(2, userOrgID);</span>
<span class="nc" id="L1761">				ResultSet DCRs = agtReceiptNoGenStmt.executeQuery();</span>
<span class="nc" id="L1762">				String lastDCNoGenerated = null;</span>
<span class="nc bnc" id="L1763" title="All 2 branches missed.">				while (DCRs.next()) {</span>
<span class="nc" id="L1764">					lastDCNoGenerated = DCRs.getString(&quot;generated_id&quot;);</span>
				}
<span class="nc" id="L1766">				String autoGeneDCNo = GenerateRecieptNo.getRecieptNoAgt(&quot;DLCHALLAN&quot;, lastDCNoGenerated, &quot;AGENT&quot;, userOrgID);</span>

				/*agtReceiptStmt = connection.prepareStatement(QueryManager.insertInAgentReceipts());
				agtReceiptStmt.setInt(1, invoiceId);
				agtReceiptStmt.setString(2, &quot;INVOICE&quot;);
				agtReceiptStmt.setInt(3, userOrgID);
				agtReceiptStmt.setInt(4, retOrgId);
				agtReceiptStmt.setString(5, &quot;RETAILER&quot;);
				agtReceiptStmt.setString(6, autoGeneRecieptNo);
				agtReceiptStmt.setTimestamp(7, Util.getCurrentTimeStamp());
				agtReceiptStmt.execute();*/

<span class="nc" id="L1778">				agtReceiptStmt = connection.prepareStatement(QueryManager.insertInAgentReceipts());</span>
<span class="nc" id="L1779">				agtReceiptStmt.setInt(1, DCId);</span>
<span class="nc" id="L1780">				agtReceiptStmt.setString(2, &quot;DLCHALLAN&quot;);</span>
<span class="nc" id="L1781">				agtReceiptStmt.setInt(3, userOrgID);</span>
<span class="nc" id="L1782">				agtReceiptStmt.setInt(4, retOrgId);</span>
<span class="nc" id="L1783">				agtReceiptStmt.setString(5, &quot;RETAILER&quot;);</span>
<span class="nc" id="L1784">				agtReceiptStmt.setString(6, autoGeneDCNo);</span>
<span class="nc" id="L1785">				agtReceiptStmt.setTimestamp(7, Util.getCurrentTimeStamp());</span>
<span class="nc" id="L1786">				agtReceiptStmt.execute();</span>

				/*for (int i = 0; i &lt; trnIdList.size(); i++) {
					agtReceiptMappingStmt.setInt(1, invoiceId);
					agtReceiptMappingStmt.setInt(2, trnIdList.get(i));
					agtReceiptMappingStmt.execute();
				}*/

<span class="nc bnc" id="L1794" title="All 2 branches missed.">				for (int i = 0; i &lt; trnIdList.size(); i++) {</span>
<span class="nc" id="L1795">					agtReceiptMappingStmt.setInt(1, DCId);</span>
<span class="nc" id="L1796">					agtReceiptMappingStmt.setInt(2, trnIdList.get(i));</span>
<span class="nc" id="L1797">					agtReceiptMappingStmt.execute();</span>
				}

				/*String insertInvoiceDCMapping = &quot;insert into st_se_agent_invoice_delchallan_mapping(id,generated_invoice_id,generated_del_challan_id) values(?,?,?)&quot;;
				agtInvoiceDCMappingStmt = connection.prepareStatement(insertInvoiceDCMapping);
				agtInvoiceDCMappingStmt.setInt(1, invoiceId);
				agtInvoiceDCMappingStmt.setString(2, autoGeneRecieptNo);
				agtInvoiceDCMappingStmt.setString(3, autoGeneDCNo);
				agtInvoiceDCMappingStmt.executeUpdate();*/

				/*boolean isValid = OrgCreditUpdation.updateOrganizationBalWithValidate(creditAmt, &quot;TRANSACTION&quot;, &quot;SALE&quot;, retOrgId, userOrgID, &quot;RETAILER&quot;, 0, connection);
				if (!isValid)
					throw new LMSException();*/

<span class="nc" id="L1811">				connection.commit();</span>
				//session.setAttribute(&quot;DEL_CHALLAN_ID&quot;, DCId);
				/*if (invoiceId &gt; -1) {
					GraphReportHelper graphReportHelper = new GraphReportHelper();
					graphReportHelper.createTextReportAgent(invoiceId, rootPath, userOrgID, loggedInUserOrgName);
				}*/
<span class="nc" id="L1817">			} catch (SQLException se) {</span>
				try {
<span class="nc" id="L1819">					connection.rollback();</span>

<span class="nc" id="L1821">				} catch (SQLException e) {</span>
<span class="nc" id="L1822">					e.printStackTrace();</span>
<span class="nc" id="L1823">					throw new LMSException(&quot;Error During Rollback&quot;, e);</span>
<span class="nc" id="L1824">				}</span>
<span class="nc" id="L1825">				se.printStackTrace();</span>
<span class="nc" id="L1826">				throw new LMSException(se);</span>
			} finally {
<span class="nc" id="L1828">				try {</span>
<span class="nc bnc" id="L1829" title="All 4 branches missed.">					if (connection != null) {</span>
<span class="nc" id="L1830">						connection.close();</span>
					}
<span class="nc" id="L1832">				} catch (SQLException se) {</span>
<span class="nc" id="L1833">					se.printStackTrace();</span>
<span class="nc" id="L1834">				}</span>
<span class="nc" id="L1835">			}</span>
		}

<span class="nc" id="L1838">		return DCId;</span>
	}

	/**
	 * This method returns the address of the passed organization
	 * 
	 * @param orgId
	 * @return OrgAddressBean
	 * @throws LMSException
	 */
	public OrgAddressBean fetchAddress(int orgId) throws LMSException {

<span class="nc" id="L1850">		Connection connection = null;</span>
<span class="nc" id="L1851">		PreparedStatement statement = null;</span>
<span class="nc" id="L1852">		ResultSet resultSet = null;</span>

		try {

<span class="nc" id="L1856">			OrgAddressBean orgAddrBean = null;</span>

			 
<span class="nc" id="L1859">			connection = DBConnect.getConnection();</span>

<span class="nc" id="L1861">			String query = QueryManager.getST1OrgAddrQuery();</span>
<span class="nc" id="L1862">			statement = connection.prepareStatement(query);</span>

<span class="nc" id="L1864">			statement.setInt(1, orgId);</span>

<span class="nc" id="L1866">			System.out.println(&quot;-----Query----::&quot; + query);</span>

<span class="nc" id="L1868">			resultSet = statement.executeQuery();</span>

<span class="nc bnc" id="L1870" title="All 2 branches missed.">			while (resultSet.next()) {</span>
<span class="nc" id="L1871">				orgAddrBean = new OrgAddressBean();</span>

<span class="nc" id="L1873">				orgAddrBean.setOrgId(orgId);</span>
<span class="nc" id="L1874">				orgAddrBean.setAddrLine1(resultSet</span>
						.getString(TableConstants.SOM_ADDR_LINE1));
<span class="nc" id="L1876">				orgAddrBean.setAddrLine2(resultSet</span>
						.getString(TableConstants.SOM_ADDR_LINE2));
<span class="nc" id="L1878">				orgAddrBean.setCity(resultSet</span>
						.getString(TableConstants.SOM_CITY));
<span class="nc" id="L1880">				orgAddrBean.setState(resultSet.getString(TableConstants.STATE));</span>
<span class="nc" id="L1881">				orgAddrBean.setCountry(resultSet</span>
						.getString(TableConstants.COUNTRY));

			}

<span class="nc" id="L1886">			return orgAddrBean;</span>

<span class="nc" id="L1888">		} catch (SQLException e) {</span>

<span class="nc" id="L1890">			e.printStackTrace();</span>
<span class="nc" id="L1891">			throw new LMSException(e);</span>
		} finally {

<span class="nc" id="L1894">			try {</span>

<span class="nc bnc" id="L1896" title="All 4 branches missed.">				if (statement != null) {</span>
<span class="nc" id="L1897">					statement.close();</span>
				}
<span class="nc bnc" id="L1899" title="All 4 branches missed.">				if (connection != null) {</span>
<span class="nc" id="L1900">					connection.close();</span>
				}
<span class="nc" id="L1902">			} catch (SQLException se) {</span>
<span class="nc" id="L1903">				se.printStackTrace();</span>
<span class="nc" id="L1904">			}</span>
		}

		// return null;

	}

	/**
	 * This method returns the list of games for the passed order number
	 * 
	 * @param orderId
	 * @return List
	 * @throws LMSException
	 */
	public List fetchOrderDetails(int orderId, int retOrgId)
			throws LMSException {
<span class="nc" id="L1920">		int totalApprovedBooks = 0;</span>
<span class="nc" id="L1921">		Connection connection = null;</span>
<span class="nc" id="L1922">		Statement statement = null;</span>
<span class="nc" id="L1923">		Statement statementCommVariance = null;</span>
<span class="nc" id="L1924">		ResultSet resultSet = null;</span>
<span class="nc" id="L1925">		ResultSet resultSetCommVariance = null;</span>
		try {

<span class="nc" id="L1928">			OrderedGameBean orderedGameBean = null;</span>
<span class="nc" id="L1929">			List&lt;OrderedGameBean&gt; searchResults = new ArrayList&lt;OrderedGameBean&gt;();</span>

			 
<span class="nc" id="L1932">			connection = DBConnect.getConnection();</span>
<span class="nc" id="L1933">			statement = connection.createStatement();</span>

<span class="nc" id="L1935">			String query = QueryManager.getST1AgentAppOrderGamesQuery();</span>
<span class="nc" id="L1936">			query = query + orderId;</span>

<span class="nc" id="L1938">			System.out.println(&quot;-----Query----::&quot; + query);</span>

<span class="nc" id="L1940">			resultSet = statement.executeQuery(query);</span>
<span class="nc" id="L1941">			int nbrBooksToDispatch = 0;</span>
<span class="nc" id="L1942">			double bookPrice = 0.0;</span>
<span class="nc bnc" id="L1943" title="All 2 branches missed.">			while (resultSet.next()) {</span>

<span class="nc" id="L1945">				System.out.println(&quot;-------------------------------&quot;);</span>
<span class="nc" id="L1946">				orderedGameBean = new OrderedGameBean();</span>
<span class="nc" id="L1947">				orderedGameBean.setOrderId(resultSet</span>
						.getInt(TableConstants.SAOG_ORDER_ID));
<span class="nc" id="L1949">				orderedGameBean.setGameId(resultSet</span>
						.getInt(TableConstants.SAOG_GAME_ID));
<span class="nc" id="L1951">				orderedGameBean.setGameName(resultSet</span>
						.getString(TableConstants.SGM_GAME_NAME));
<span class="nc" id="L1953">				orderedGameBean.setGameNbr(resultSet</span>
						.getInt(TableConstants.SGM_GAME_NBR));
<span class="nc" id="L1955">				orderedGameBean.setNbrOfBooksApp(resultSet</span>
						.getInt(TableConstants.SAOG_NBR_OF_BOOKS_APP));

				// here added by yogesh
				// added by yogesh to get retailer commission variance for every
				// game
<span class="nc" id="L1961">				double retGameCommVariace = 0.0;</span>
<span class="nc" id="L1962">				String getAgtCommVariance = &quot;select sale_comm_variance from st_se_agent_retailer_sale_pwt_comm_variance where retailer_org_id=&quot;</span>
						+ retOrgId
						+ &quot; and game_id=&quot;
						+ resultSet.getInt(TableConstants.SAOG_GAME_ID);
<span class="nc" id="L1966">				statementCommVariance = connection.createStatement();</span>
<span class="nc" id="L1967">				resultSetCommVariance = statementCommVariance</span>
						.executeQuery(getAgtCommVariance);
<span class="nc bnc" id="L1969" title="All 2 branches missed.">				while (resultSetCommVariance.next()) {</span>
<span class="nc" id="L1970">					retGameCommVariace = resultSetCommVariance</span>
							.getDouble(&quot;sale_comm_variance&quot;);

				}

<span class="nc" id="L1975">				orderedGameBean.setRetGameCommVariance(retGameCommVariace);</span>
				// added by yogesh to implement vat

<span class="nc" id="L1978">				orderedGameBean.setPrizePayOutRatio(resultSet</span>
						.getDouble(&quot;prize_payout_ratio&quot;));
<span class="nc" id="L1980">				orderedGameBean.setVat(resultSet.getDouble(&quot;vat_amt&quot;));</span>
<span class="nc" id="L1981">				orderedGameBean.setGovtComm(resultSet</span>
						.getDouble(&quot;govt_comm_rate&quot;));
<span class="nc" id="L1983">				orderedGameBean.setVatBalance(resultSet</span>
						.getDouble(&quot;vat_balance&quot;));
<span class="nc" id="L1985">				orderedGameBean.setGovtCommRule(resultSet</span>
						.getString(&quot;govt_comm_type&quot;));
<span class="nc" id="L1987">				orderedGameBean.setFixedAmt(resultSet.getDouble(&quot;fixed_amt&quot;));</span>
<span class="nc" id="L1988">				orderedGameBean.setTicketsInScheme(resultSet</span>
						.getLong(&quot;tickets_in_scheme&quot;));

<span class="nc" id="L1991">				orderedGameBean.setGameNbrDigits(resultSet</span>
						.getInt(TableConstants.SGTNF_GAME_NBR_DIGITS));
<span class="nc" id="L1993">				orderedGameBean.setPackDigits(resultSet</span>
						.getInt(TableConstants.SGTNF_PACK_DIGITS));
<span class="nc" id="L1995">				orderedGameBean.setBookDigits(resultSet</span>
						.getInt(TableConstants.SGTNF_BOOK_DIGITS));

<span class="nc" id="L1998">				totalApprovedBooks = totalApprovedBooks</span>
						+ resultSet
								.getInt(TableConstants.SBOG_NBR_OF_BOOKS_APP);
<span class="nc" id="L2001">				orderedGameBean.setNbrOfBooksDlvrd(resultSet</span>
						.getInt(TableConstants.SBOG_NBR_OF_BOOKS_DLVRD));

<span class="nc" id="L2004">				nbrBooksToDispatch = resultSet</span>
						.getInt(TableConstants.SBOG_NBR_OF_BOOKS_APP)
						- resultSet
								.getInt(TableConstants.SBOG_NBR_OF_BOOKS_DLVRD);

<span class="nc" id="L2009">				orderedGameBean.setRemainingBooksToDispatch(nbrBooksToDispatch);</span>

<span class="nc" id="L2011">				orderedGameBean.setNbrOfBooksPerPack(resultSet</span>
						.getInt(TableConstants.SGM_NBR_OF_BOOKS_PER_PACK));
<span class="nc" id="L2013">				bookPrice = resultSet</span>
						.getInt(TableConstants.SGM_NBR_OF_TICKETS_PER_BOOK)
						* resultSet.getDouble(TableConstants.SGM_TICKET_PRICE);
<span class="nc" id="L2016">				orderedGameBean.setBookPrice(bookPrice);</span>
<span class="nc" id="L2017">				orderedGameBean.setRetSaleCommRate(resultSet</span>
						.getDouble(TableConstants.SGM_RET_SALE_RATE));
<span class="nc bnc" id="L2019" title="All 2 branches missed.">				if (!(nbrBooksToDispatch == 0)) {</span>
<span class="nc" id="L2020">					searchResults.add(orderedGameBean);</span>
				}

<span class="nc" id="L2023">			}</span>
<span class="nc" id="L2024">			this.setTotalOrderedBooks(totalApprovedBooks);</span>
<span class="nc" id="L2025">			System.out.println(&quot;----total approved for order : &quot;</span>
					+ totalApprovedBooks + &quot;&quot;);
<span class="nc" id="L2027">			return searchResults;</span>

<span class="nc" id="L2029">		} catch (SQLException e) {</span>

<span class="nc" id="L2031">			e.printStackTrace();</span>
<span class="nc" id="L2032">			throw new LMSException(e);</span>

		} finally {

<span class="nc" id="L2036">			try {</span>

<span class="nc bnc" id="L2038" title="All 4 branches missed.">				if (statement != null) {</span>
<span class="nc" id="L2039">					statement.close();</span>
				}
<span class="nc bnc" id="L2041" title="All 4 branches missed.">				if (connection != null) {</span>
<span class="nc" id="L2042">					connection.close();</span>
				}
<span class="nc" id="L2044">			} catch (SQLException se) {</span>
<span class="nc" id="L2045">				se.printStackTrace();</span>
<span class="nc" id="L2046">			}</span>
		}

		// return null;

	}

	private List&lt;String&gt; getBooksForPack(Connection connection, int gameId,
			String packNbr) throws SQLException {

<span class="nc" id="L2056">		String packQuery = null;</span>
<span class="nc" id="L2057">		PreparedStatement packStmt = null;</span>
<span class="nc" id="L2058">		List&lt;String&gt; bookList = new ArrayList&lt;String&gt;();</span>

<span class="nc" id="L2060">		packQuery = QueryManager.getST1BooksForPack();</span>
<span class="nc" id="L2061">		packStmt = connection.prepareStatement(packQuery);</span>

<span class="nc" id="L2063">		packStmt.setInt(1, gameId);</span>
<span class="nc" id="L2064">		packStmt.setString(2, packNbr);</span>

<span class="nc" id="L2066">		ResultSet rs = packStmt.executeQuery();</span>
<span class="nc bnc" id="L2067" title="All 2 branches missed.">		while (rs.next()) {</span>
<span class="nc" id="L2068">			bookList.add(rs.getString(TableConstants.SGIS_BOOK_NBR));</span>
		}

<span class="nc" id="L2071">		return bookList;</span>
	}

	/**
	 * This method returns a list of approved orders for the passed agent
	 * 
	 * @param agtOrgId
	 * @return List
	 * @throws LMSException
	 */
	/*
	 * public List getApprovedOrders(int agtOrgId) throws LMSException {
	 * 
	 * Connection connection = null; PreparedStatement statement = null;
	 * ResultSet resultSet = null; try {
	 * 
	 * AgentOrderBean orderBean = null; List&lt;AgentOrderBean&gt; searchResults =
	 * new ArrayList&lt;AgentOrderBean&gt;();
	 * 
	 *   connection =
	 * dbConnect.getConnection();
	 * 
	 * 
	 * String query = QueryManager.getST1AgentAppOrderQuery(); statement =
	 * connection.prepareStatement(query); statement.setInt(1,agtOrgId);
	 * 
	 * System.out.println(&quot;-----Query----::&quot; + query);
	 * 
	 * resultSet = statement.executeQuery();
	 * 
	 * while (resultSet.next()) {
	 * 
	 * orderBean = new AgentOrderBean(); orderBean.setOrderId(resultSet
	 * .getInt(TableConstants.SAO_ORDER_ID)); orderBean.setAgentId(resultSet
	 * .getInt(TableConstants.SAO_AGENT_ID)); orderBean.setRetailerId(resultSet
	 * .getInt(TableConstants.SAO_RETAILER_ID));
	 * orderBean.setRetailerOrgId(resultSet
	 * .getInt(TableConstants.SAO_RETAILER_ORG_ID));
	 * System.out.println(&quot;====Organisation Id :
	 * &quot;+orderBean.getRetailerOrgId()); orderBean.setRetOrgName(resultSet
	 * .getString(TableConstants.SOM_ORG_NAME));
	 * System.out.println(&quot;====Organisation NAme : &quot;+orderBean.getRetOrgName());
	 * orderBean.setOrderDate(resultSet
	 * .getDate(TableConstants.SAO_ORDER_DATE));
	 * 
	 * searchResults.add(orderBean); }
	 * 
	 * return searchResults; } catch (SQLException e) {
	 * 
	 * e.printStackTrace(); throw new LMSException(e); } finally {
	 * 
	 * try {
	 * 
	 * if (statement != null) { statement.close(); } if (connection != null) {
	 * connection.close(); } } catch (SQLException se) { se.printStackTrace(); } }
	 * 
	 * //return null; }
	 */

	private java.sql.Date getDate(String date) {

<span class="nc" id="L2132">		System.out.println(&quot;Passed date::&quot; + date);</span>
<span class="nc" id="L2133">		String format = &quot;yyyy-MM-dd&quot;;</span>
<span class="nc" id="L2134">		DateFormat dateFormat = new SimpleDateFormat(format);</span>
		try {

<span class="nc" id="L2137">			Date parsedDate = dateFormat.parse(date);</span>
<span class="nc" id="L2138">			System.out.println(&quot;Parsed date::&quot; + parsedDate);</span>
<span class="nc" id="L2139">			System.out.println(new java.sql.Date(parsedDate.getTime()));</span>
<span class="nc" id="L2140">			return new java.sql.Date(parsedDate.getTime());</span>

<span class="nc" id="L2142">		} catch (ParseException e) {</span>

<span class="nc" id="L2144">			e.printStackTrace();</span>
		}
<span class="nc" id="L2146">		return null;</span>
	}

	private int getDispatchedNbrOfBooks(InvOrderBean invOrderBean,
			int nbrOfBooksPerPack) {

<span class="nc" id="L2152">		List&lt;PackBean&gt; packList = invOrderBean.getPackList();</span>
<span class="nc" id="L2153">		List&lt;BookBean&gt; bookList = invOrderBean.getBookList();</span>

<span class="nc" id="L2155">		PackBean packBean = null;</span>
<span class="nc" id="L2156">		BookBean bookBean = null;</span>

<span class="nc" id="L2158">		int packCount = 0;</span>
<span class="nc" id="L2159">		int bookCount = 0;</span>

<span class="nc bnc" id="L2161" title="All 2 branches missed.">		if (packList != null) {</span>
<span class="nc bnc" id="L2162" title="All 2 branches missed.">			for (int i = 0; i &lt; packList.size(); i++) {</span>
<span class="nc" id="L2163">				packBean = packList.get(i);</span>
<span class="nc bnc" id="L2164" title="All 2 branches missed.">				if (packBean.getIsValid()) {</span>
<span class="nc" id="L2165">					packCount++;</span>
				}
			}
		}
<span class="nc bnc" id="L2169" title="All 2 branches missed.">		if (bookList != null) {</span>
<span class="nc bnc" id="L2170" title="All 2 branches missed.">			for (int i = 0; i &lt; bookList.size(); i++) {</span>
<span class="nc" id="L2171">				bookBean = bookList.get(i);</span>
<span class="nc bnc" id="L2172" title="All 2 branches missed.">				if (bookBean.getIsValid()) {</span>
<span class="nc" id="L2173">					bookCount++;</span>
				}
			}
		}

<span class="nc" id="L2178">		int totalBooks = bookCount + packCount * nbrOfBooksPerPack;</span>
<span class="nc" id="L2179">		return totalBooks;</span>
	}

	public int getGameID() {
<span class="nc" id="L2183">		return gameID;</span>
	}

	private String getPackNbrForBook(Connection connection, int gameId,
			String bookNbr) throws SQLException {

<span class="nc" id="L2189">		String bookQuery = null;</span>
<span class="nc" id="L2190">		PreparedStatement bookStmt = null;</span>
<span class="nc" id="L2191">		String packNbr = null;</span>

<span class="nc" id="L2193">		bookQuery = QueryManager.getST1PackForBook();</span>
<span class="nc" id="L2194">		bookStmt = connection.prepareStatement(bookQuery);</span>

<span class="nc" id="L2196">		bookStmt.setInt(1, gameId);</span>
<span class="nc" id="L2197">		bookStmt.setString(2, bookNbr);</span>

<span class="nc" id="L2199">		ResultSet rs = bookStmt.executeQuery();</span>
<span class="nc bnc" id="L2200" title="All 2 branches missed.">		while (rs.next()) {</span>
<span class="nc" id="L2201">			packNbr = rs.getString(TableConstants.SGIS_PACK_NBR);</span>
		}
<span class="nc" id="L2203">		return packNbr;</span>

	}

	public int getTotalOrderedBooks() {
<span class="nc" id="L2208">		return totalOrderedBooks;</span>
	}

	private String getWhereClause(Map searchMap) {
<span class="nc" id="L2212">		Set keySet = null;</span>
<span class="nc" id="L2213">		StringBuffer whereClause = new StringBuffer();</span>

<span class="nc bnc" id="L2215" title="All 2 branches missed.">		if (searchMap != null) {</span>
<span class="nc" id="L2216">			keySet = searchMap.keySet();</span>

<span class="nc" id="L2218">			Iterator itr = keySet.iterator();</span>
<span class="nc" id="L2219">			String key = null;</span>
			String strValue;

<span class="nc" id="L2222">			int fieldAdded = 1;</span>

<span class="nc bnc" id="L2224" title="All 2 branches missed.">			while (itr.hasNext()) {</span>
<span class="nc" id="L2225">				key = (String) itr.next();</span>
<span class="nc bnc" id="L2226" title="All 2 branches missed.">				if (key.equals(GameContants.GAME_NAME)) {</span>
<span class="nc" id="L2227">					strValue = (String) searchMap.get(key);</span>

<span class="nc bnc" id="L2229" title="All 4 branches missed.">					if (strValue != null &amp;&amp; !strValue.equals(&quot;&quot;)) {</span>
<span class="nc bnc" id="L2230" title="All 2 branches missed.">						if (fieldAdded &gt; 0) {</span>
<span class="nc" id="L2231">							whereClause.append(&quot; And &quot;);</span>
						}

<span class="nc" id="L2234">						whereClause.append(TableConstants.SGM_GAME_NAME);</span>
<span class="nc" id="L2235">						whereClause.append(&quot; like '&quot;);</span>
<span class="nc" id="L2236">						whereClause.append(strValue.trim());</span>
<span class="nc" id="L2237">						whereClause.append(&quot;%' &quot;);</span>

<span class="nc" id="L2239">						fieldAdded++;</span>
					}
				}

<span class="nc bnc" id="L2243" title="All 2 branches missed.">				else if (key.equals(GameContants.GAME_NBR)) {</span>

<span class="nc" id="L2245">					strValue = (String) searchMap.get(key);</span>
<span class="nc bnc" id="L2246" title="All 4 branches missed.">					if (strValue != null &amp;&amp; !strValue.equals(&quot;&quot;)) {</span>

<span class="nc bnc" id="L2248" title="All 2 branches missed.">						if (fieldAdded &gt; 0) {</span>
<span class="nc" id="L2249">							whereClause.append(&quot; And &quot;);</span>
						}

<span class="nc" id="L2252">						whereClause.append(TableConstants.SGM_GAME_NBR);</span>
<span class="nc" id="L2253">						whereClause.append(&quot; = '&quot;);</span>
<span class="nc" id="L2254">						whereClause.append(strValue.trim());</span>
<span class="nc" id="L2255">						whereClause.append(&quot;'&quot;);</span>
<span class="nc" id="L2256">						fieldAdded++;</span>

					}

<span class="nc bnc" id="L2260" title="All 2 branches missed.">				} else if (key.equals(TableConstants.ORG_NAME)) {</span>

<span class="nc" id="L2262">					strValue = (String) searchMap.get(key);</span>
<span class="nc" id="L2263">					System.out.println(strValue + &quot;...............Status&quot;);</span>
<span class="nc bnc" id="L2264" title="All 4 branches missed.">					if (strValue != null &amp;&amp; !strValue.equals(&quot;&quot;)) {</span>

<span class="nc bnc" id="L2266" title="All 2 branches missed.">						if (fieldAdded &gt; 0) {</span>
<span class="nc" id="L2267">							whereClause.append(&quot; And &quot;);</span>
						}

<span class="nc" id="L2270">						whereClause.append(TableConstants.ORG_NAME);</span>
<span class="nc" id="L2271">						whereClause.append(&quot; like '&quot;);</span>
<span class="nc" id="L2272">						whereClause.append(strValue.trim());</span>
<span class="nc" id="L2273">						whereClause.append(&quot;%'&quot;);</span>

<span class="nc" id="L2275">						fieldAdded++;</span>

					}
				}

<span class="nc bnc" id="L2280" title="All 2 branches missed.">				else if (key.equals(TableConstants.SBO_ORDER_STATUS)) {</span>

<span class="nc" id="L2282">					strValue = (String) searchMap.get(key);</span>

<span class="nc bnc" id="L2284" title="All 4 branches missed.">					if (strValue != null &amp;&amp; !strValue.equals(&quot;&quot;)) {</span>

<span class="nc bnc" id="L2286" title="All 2 branches missed.">						if (fieldAdded &gt; 0) {</span>
<span class="nc" id="L2287">							whereClause.append(&quot; And &quot;);</span>
						}

<span class="nc" id="L2290">						whereClause.append(TableConstants.SBO_ORDER_STATUS);</span>
<span class="nc" id="L2291">						whereClause.append(&quot; = '&quot;);</span>
<span class="nc" id="L2292">						whereClause.append(strValue.trim());</span>
<span class="nc" id="L2293">						whereClause.append(&quot;' &quot;);</span>

<span class="nc" id="L2295">						fieldAdded++;</span>
					}
				}

<span class="nc bnc" id="L2299" title="All 2 branches missed.">				else if (key.equals(GameContants.ORDER_ID)) {</span>
<span class="nc" id="L2300">					String str1 = &quot;-1&quot;;</span>
<span class="nc" id="L2301">					str1 = (String) searchMap.get(key);</span>

<span class="nc bnc" id="L2303" title="All 4 branches missed.">					if (str1 != null &amp;&amp; !str1.equals(&quot;&quot;)) {</span>

<span class="nc bnc" id="L2305" title="All 2 branches missed.">						if (fieldAdded &gt; 0) {</span>
<span class="nc" id="L2306">							whereClause.append(&quot; And &quot;);</span>
						}

<span class="nc" id="L2309">						whereClause.append(&quot;sbo.&quot; + GameContants.ORDER_ID);</span>
<span class="nc" id="L2310">						whereClause.append(&quot; = '&quot;);</span>
<span class="nc" id="L2311">						whereClause.append(str1.trim());</span>
<span class="nc" id="L2312">						whereClause.append(&quot;' &quot;);</span>

<span class="nc" id="L2314">						fieldAdded++;</span>
					}
<span class="nc" id="L2316">				}</span>

			}
<span class="nc bnc" id="L2319" title="All 2 branches missed.">			if (fieldAdded == 1) {</span>
<span class="nc" id="L2320">				whereClause.append(&quot; and 1=1 &quot;);</span>
			}

		}

<span class="nc" id="L2325">		return whereClause.toString();</span>
	}

	/**
	 * This method returns the list of order based on the search parameters
	 * passed
	 * 
	 * @param searchMap
	 * @return List
	 * @throws LMSException
	 */
	public List SearchOrder(Map searchMap, int agentOrgId) throws LMSException {

<span class="nc" id="L2338">		Connection connection = null;</span>
<span class="nc" id="L2339">		Statement statement = null;</span>
<span class="nc" id="L2340">		ResultSet resultSet = null;</span>
<span class="nc" id="L2341">		Statement statement1 = null;</span>
<span class="nc" id="L2342">		ResultSet resultSet1 = null;</span>
		try {

<span class="nc" id="L2345">			AgentOrderBean orderBean = null;</span>
<span class="nc" id="L2346">			List&lt;AgentOrderBean&gt; searchResults = new ArrayList&lt;AgentOrderBean&gt;();</span>
			 
<span class="nc" id="L2348">			connection = DBConnect.getConnection();</span>
<span class="nc" id="L2349">			statement = connection.createStatement();</span>
<span class="nc" id="L2350">			statement1 = connection.createStatement();</span>

<span class="nc" id="L2352">			String query = QueryManager.getST1AgentAppOrderQuery() + agentOrgId</span>
					+ getWhereClause(searchMap) + &quot; group by order_id&quot;;

<span class="nc" id="L2355">			System.out.println(&quot;-----Query----::&quot; + query);</span>

<span class="nc" id="L2357">			resultSet = statement.executeQuery(query);</span>

<span class="nc bnc" id="L2359" title="All 2 branches missed.">			while (resultSet.next()) {</span>

<span class="nc" id="L2361">				orderBean = new AgentOrderBean();</span>
<span class="nc" id="L2362">				orderBean.setOrderId(resultSet</span>
						.getInt(TableConstants.SAO_ORDER_ID));
				/*
				 * orderBean.setAgentId(resultSet
				 * .getInt(TableConstants.SAO_AGENT_ID));
				 */
<span class="nc" id="L2368">				orderBean.setRetailerId(resultSet</span>
						.getInt(TableConstants.SAO_RETAILER_ID));
<span class="nc" id="L2370">				orderBean.setRetailerOrgId(resultSet</span>
						.getInt(TableConstants.SAO_RETAILER_ORG_ID));
<span class="nc" id="L2372">				orderBean.setRetOrgName(resultSet</span>
						.getString(TableConstants.SOM_ORG_NAME));
<span class="nc" id="L2374">				orderBean.setOrderDate(resultSet</span>
						.getDate(TableConstants.SAO_ORDER_DATE));

<span class="nc bnc" id="L2377" title="All 2 branches missed.">				if (resultSet.getString(TableConstants.SBO_ORDER_STATUS)</span>
						.equalsIgnoreCase(&quot;APPROVED&quot;)) {
<span class="nc" id="L2379">					orderBean.setOrderStatus(&quot;Approved&quot;);</span>

				}
<span class="nc bnc" id="L2382" title="All 2 branches missed.">				if (resultSet.getString(TableConstants.SBO_ORDER_STATUS)</span>
						.equalsIgnoreCase(&quot;PROCESSED&quot;)) {
<span class="nc" id="L2384">					orderBean.setOrderStatus(&quot;Processed&quot;);</span>

				}
<span class="nc bnc" id="L2387" title="All 2 branches missed.">				if (resultSet.getString(TableConstants.SBO_ORDER_STATUS)</span>
						.equalsIgnoreCase(&quot;SEMI_PROCESSED&quot;)) {
<span class="nc" id="L2389">					orderBean.setOrderStatus(&quot;Semi Processed&quot;);</span>

				}
<span class="nc bnc" id="L2392" title="All 2 branches missed.">				if (resultSet.getString(TableConstants.SBO_ORDER_STATUS)</span>
						.equalsIgnoreCase(&quot;ASSIGNED&quot;)) {
<span class="nc" id="L2394">					orderBean.setOrderStatus(&quot;Assigned&quot;);</span>

				}

<span class="nc" id="L2398">				searchResults.add(orderBean);</span>

			}

<span class="nc" id="L2402">			return searchResults;</span>

<span class="nc" id="L2404">		} catch (SQLException e) {</span>

<span class="nc" id="L2406">			e.printStackTrace();</span>
<span class="nc" id="L2407">			throw new LMSException(e);</span>

		} finally {

<span class="nc" id="L2411">			try {</span>

<span class="nc bnc" id="L2413" title="All 4 branches missed.">				if (statement != null) {</span>
<span class="nc" id="L2414">					statement.close();</span>
				}
<span class="nc bnc" id="L2416" title="All 4 branches missed.">				if (connection != null) {</span>
<span class="nc" id="L2417">					connection.close();</span>
				}
<span class="nc" id="L2419">			} catch (SQLException se) {</span>
<span class="nc" id="L2420">				se.printStackTrace();</span>
<span class="nc" id="L2421">			}</span>
		}

		// return null;

	}

	public void setGameID(int gameID) {
<span class="nc" id="L2429">		this.gameID = gameID;</span>
<span class="nc" id="L2430">	}</span>

	public void setTotalOrderedBooks(int totalOrderedBooks) {
<span class="nc" id="L2433">		this.totalOrderedBooks = totalOrderedBooks;</span>
<span class="nc" id="L2434">	}</span>

	public boolean SuccessStatusUpdate(int oderId, String status)
			throws LMSException {

<span class="nc" id="L2439">		Connection connection = null;</span>
<span class="nc" id="L2440">		PreparedStatement statement = null;</span>
<span class="nc" id="L2441">		PreparedStatement statement1 = null;</span>
<span class="nc" id="L2442">		ResultSet resultSet = null;</span>
		try {

<span class="nc" id="L2445">			OrderBean orderBean = null;</span>
<span class="nc" id="L2446">			List&lt;OrderBean&gt; searchResults = new ArrayList&lt;OrderBean&gt;();</span>

			 
<span class="nc" id="L2449">			connection = DBConnect.getConnection();</span>
<span class="nc" id="L2450">			String query = QueryManager.getST1AppOrderQuery();</span>
<span class="nc" id="L2451">			String query1 = &quot;update st_se_agent_order set order_status=? where order_id=?&quot;;</span>
<span class="nc" id="L2452">			String query2 = &quot;update st_se_agent_order_invoices set order_status=? where order_id=?&quot;;</span>
<span class="nc" id="L2453">			System.out.println(&quot;-----Query----::&quot; + query);</span>
<span class="nc" id="L2454">			statement = connection.prepareStatement(query1);</span>
<span class="nc" id="L2455">			statement1 = connection.prepareStatement(query2);</span>

<span class="nc" id="L2457">			statement.setString(1, status);</span>
<span class="nc" id="L2458">			statement.setInt(2, oderId);</span>
<span class="nc" id="L2459">			int ii = statement.executeUpdate();</span>

<span class="nc" id="L2461">			statement1.setString(1, status);</span>
<span class="nc" id="L2462">			statement1.setInt(2, oderId);</span>
<span class="nc" id="L2463">			int i = statement1.executeUpdate();</span>
<span class="nc bnc" id="L2464" title="All 4 branches missed.">			if (i &gt; 0 || ii &gt; 0) {</span>

<span class="nc" id="L2466">				return true;</span>
			} else {
<span class="nc" id="L2468">				return false;</span>
			}

<span class="nc" id="L2471">		} catch (SQLException e) {</span>

<span class="nc" id="L2473">			e.printStackTrace();</span>
<span class="nc" id="L2474">			throw new LMSException(e);</span>
		} finally {

<span class="nc" id="L2477">			try {</span>

<span class="nc bnc" id="L2479" title="All 6 branches missed.">				if (statement != null) {</span>
<span class="nc" id="L2480">					statement.close();</span>
				}
<span class="nc bnc" id="L2482" title="All 6 branches missed.">				if (connection != null) {</span>
<span class="nc" id="L2483">					connection.close();</span>
				}
<span class="nc" id="L2485">			} catch (SQLException se) {</span>
<span class="nc" id="L2486">				se.printStackTrace();</span>
<span class="nc" id="L2487">			}</span>
		}

		// return null;

	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>