<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GameInventoryStatusForBOHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lms</a> &gt; <a href="index.source.html" class="el_package">com.skilrock.lms.coreEngine.scratchService.inventoryMgmt.common</a> &gt; <span class="el_source">GameInventoryStatusForBOHelper.java</span></div><h1>GameInventoryStatusForBOHelper.java</h1><pre class="source lang-java linenums">package com.skilrock.lms.coreEngine.scratchService.inventoryMgmt.common;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.TreeMap;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import com.google.gson.Gson;
import com.skilrock.lms.common.db.DBConnect;
import com.skilrock.lms.common.exception.LMSException;
import com.skilrock.lms.coreEngine.scratchService.common.ScratchErrors;
import com.skilrock.lms.coreEngine.scratchService.common.ScratchException;
import com.skilrock.lms.coreEngine.scratchService.common.beans.WarehouseInventoryDetailBean;
import com.skilrock.lms.coreEngine.scratchService.common.beans.WarehouseWiseGameInventoryDetailBean;

<span class="nc" id="L26">public class GameInventoryStatusForBOHelper {</span>
<span class="nc" id="L27">	private Log logger = LogFactory.getLog(GameInventoryStatusForBOHelper.class);</span>
	public static void main(String[] args) {
<span class="nc" id="L29">		new GameInventoryStatusForBOHelper().getGameInvetoryWithBO(55);</span>
<span class="nc" id="L30">	}</span>

<span class="nc" id="L32">	StringBuilder resString = null;</span>

	private Map&lt;String, List&lt;String&gt;&gt; CreateSeriesOfBooks(
			Map&lt;String, List&lt;String&gt;&gt; map, int booksPerPack) {
<span class="nc" id="L36">		Map&lt;String, List&lt;String&gt;&gt; seriesPackWiseMap = new TreeMap&lt;String, List&lt;String&gt;&gt;();</span>
<span class="nc" id="L37">		String firstBook = &quot;&quot;;</span>
<span class="nc" id="L38">		String lastBook = &quot;&quot;;</span>
<span class="nc" id="L39">		List&lt;String&gt; bookSeriesList = null;</span>
<span class="nc" id="L40">		List&lt;String&gt; bookList = null;</span>
<span class="nc" id="L41">		int totalbooks = 0;</span>
<span class="nc" id="L42">		Set&lt;String&gt; packSet = map.keySet();</span>

<span class="nc bnc" id="L44" title="All 2 branches missed.">		for (String pack : packSet) {</span>
<span class="nc" id="L45">			bookList = map.get(pack);</span>
<span class="nc" id="L46">			firstBook = bookList.get(0);</span>
<span class="nc" id="L47">			bookSeriesList = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L48">			int compTicket = Integer.parseInt(firstBook.substring(firstBook</span>
					.indexOf(&quot;-&quot;) + 1)) + 1;
<span class="nc" id="L50">			int length = bookList.size();</span>
<span class="nc" id="L51">			totalbooks = totalbooks + length;</span>
<span class="nc bnc" id="L52" title="All 2 branches missed.">			if (length == 1) {</span>
<span class="nc" id="L53">				bookSeriesList.add(firstBook + &quot;TO&quot; + bookList.get(length - 1));</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">			} else if (length == booksPerPack) {</span>
<span class="nc" id="L55">				bookSeriesList.add(firstBook + &quot;TO&quot; + bookList.get(length - 1));</span>
			} else {
<span class="nc bnc" id="L57" title="All 2 branches missed.">				for (int i = 0; i &lt; length - 1; i++) {</span>
<span class="nc" id="L58">					int newTicket = Integer.parseInt(bookList.get(i + 1)</span>
							.substring(firstBook.indexOf(&quot;-&quot;) + 1));
<span class="nc bnc" id="L60" title="All 2 branches missed.">					if (newTicket != compTicket) {</span>
<span class="nc" id="L61">						lastBook = bookList.get(i);</span>
<span class="nc" id="L62">						bookSeriesList.add(firstBook + &quot;TO&quot; + lastBook);</span>

<span class="nc" id="L64">						firstBook = bookList.get(i + 1);</span>
<span class="nc" id="L65">						compTicket = Integer.parseInt(firstBook</span>
								.substring(firstBook.indexOf(&quot;-&quot;) + 1));
					}
<span class="nc" id="L68">					compTicket += 1;</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">					if (!(i + 1 &lt; length - 1)) {</span>
<span class="nc" id="L70">						lastBook = bookList.get(i + 1);</span>
<span class="nc" id="L71">						bookSeriesList.add(firstBook + &quot;TO&quot; + lastBook);</span>
					}
				}
			}
<span class="nc" id="L75">			seriesPackWiseMap.put(pack, bookSeriesList);</span>
<span class="nc" id="L76">		}</span>
		// logger.info(&quot;Total no of books === &quot;+totalbooks);
<span class="nc" id="L78">		return seriesPackWiseMap;</span>
	}

	/*
	 * public Map getGameInvetoryTotal(int gameid) { Set&lt;String&gt; packSet=new
	 * TreeSet&lt;String&gt;(); Set&lt;String&gt; bookSet=new TreeSet&lt;String&gt;(); List&lt;String&gt;
	 * list=new ArrayList&lt;String&gt;(); Connection con=new
	 * DBConnect().getConnection(); PreparedStatement pstmt=null; try {
	 * pstmt=con.prepareStatement(&quot;select game_id, pack_nbr, book_nbr,
	 * current_owner from st_se_game_inv_status where game_id = &quot;+gameid+&quot; order
	 * by book_nbr&quot;); ResultSet rs=pstmt.executeQuery(); String bookNbr=&quot;&quot;;
	 * boolean first=true; String packNbr=&quot;&quot;; String newPackNbr=&quot;&quot;;
	 * 
	 * while(rs.next()) { newPackNbr=rs.getString(&quot;pack_nbr&quot;);
	 * bookNbr=rs.getString(&quot;book_nbr&quot;); if(packNbr.equals(newPackNbr)){
	 * list.add(bookNbr); }else{ if(!first){ packSet.add(newPackNbr); } list=new
	 * ArrayList&lt;String&gt;(); packNbr=newPackNbr; list.add(bookNbr); }
	 * first=false; } bookSet.addAll(list);
	 * 
	 * rs.close(); } catch (SQLException e) { e.printStackTrace(); } finally {
	 * try { if(pstmt!=null) pstmt.close(); if(con!=null &amp;&amp; (!con.isClosed()))
	 * con.close(); } catch (SQLException e) { e.printStackTrace(); } }
	 * 
	 * return null; }
	 * 
	 * 
	 * 
	 * public Map getBoTotalActiveBooks(int gameid) { Map map=new TreeMap();
	 * List&lt;String&gt; list=new ArrayList&lt;String&gt;(); Connection con=new
	 * DBConnect().getConnection(); PreparedStatement pstmt=null; String
	 * name=&quot;&quot;; String newName=null; String parent_name=null; boolean
	 * first=true; try { pstmt=con.prepareStatement(&quot; select game_id, pack_nbr,
	 * book_nbr, book_status, (select name from st_lms_organization_master where
	 * organization_id=current_owner_id)'ret_name', (select name from
	 * st_lms_organization_master where
	 * organization_id=om.parent_id)'agent_name' from st_se_game_inv_status,
	 * st_lms_organization_master om where organization_id=current_owner_id and
	 * book_status ='ACTIVE' and game_id = ? order by current_owner_id,
	 * book_nbr&quot;); pstmt.setInt(1, gameid); ResultSet rs=pstmt.executeQuery();
	 * String bookNbr=null; while(rs.next()) {
	 * parent_name=rs.getString(&quot;parent_name&quot;);
	 * newName=rs.getString(&quot;ret_name&quot;); bookNbr=rs.getString(&quot;book_nbr&quot;);
	 * if(name.equals(newName)){ list.add(bookNbr); }else{ if(!first){
	 * map.put(name+&quot; &lt;i&gt;Parent Name:- &quot;+parent_name, list); } list=new
	 * ArrayList&lt;String&gt;(); name=newName; list.add(bookNbr); } first=false; }
	 * map.put(name, list); rs.close(); } catch (SQLException e) {
	 * e.printStackTrace(); } finally { try { if(pstmt!=null) pstmt.close();
	 * if(con!=null &amp;&amp; (!con.isClosed())) con.close(); } catch (SQLException e) {
	 * e.printStackTrace(); } } return map; }
	 */

	public List&lt;String&gt; getAgentList() {
<span class="nc" id="L130">		List&lt;String&gt; agentList = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L131">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L132">		PreparedStatement pstmt = null;</span>
		try {
<span class="nc" id="L134">			pstmt = con</span>
					.prepareStatement(&quot;select name 'agent_name' from st_lms_organization_master where organization_type='AGENT' order by name&quot;);
<span class="nc" id="L136">			ResultSet rs = pstmt.executeQuery();</span>
<span class="nc" id="L137">			String agentName = null;</span>
			// logger.info(&quot;getAgentList&quot;);
<span class="nc bnc" id="L139" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L140">				agentName = rs.getString(&quot;agent_name&quot;);</span>
				// logger.info(agentName);
<span class="nc" id="L142">				agentList.add(agentName);</span>
			}
<span class="nc" id="L144">			rs.close();</span>
<span class="nc" id="L145">		} catch (SQLException e) {</span>
<span class="nc" id="L146">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L148">			try {</span>
<span class="nc bnc" id="L149" title="All 6 branches missed.">				if (pstmt != null) {</span>
<span class="nc" id="L150">					pstmt.close();</span>
				}
<span class="nc bnc" id="L152" title="All 12 branches missed.">				if (con != null &amp;&amp; !con.isClosed()) {</span>
<span class="nc" id="L153">					con.close();</span>
				}
<span class="nc" id="L155">			} catch (SQLException e) {</span>
<span class="nc" id="L156">				e.printStackTrace();</span>
<span class="nc" id="L157">			}</span>
<span class="nc" id="L158">		}</span>
<span class="nc" id="L159">		return agentList;</span>
	}
/**
 * @changed agentName to agtId for orgCode Implementation 
 * @param gameid
 * @param agtId
 * @return
 */
	public String getBoTotalBooksWithAgent(int gameid, int agtId) {
<span class="nc" id="L168">		logger.info(&quot;agent called&quot;);</span>
<span class="nc" id="L169">		resString = new StringBuilder(&quot;NONE&quot;);</span>
<span class="nc" id="L170">		Map&lt;String, List&lt;String&gt;&gt; packWiseBookSeriesMap = null;</span>
<span class="nc" id="L171">		Map&lt;String, List&lt;String&gt;&gt; packBooksMap = new TreeMap&lt;String, List&lt;String&gt;&gt;();</span>
<span class="nc" id="L172">		List&lt;String&gt; list = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L173">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L174">		PreparedStatement pstmt = null;</span>
		try {
<span class="nc" id="L176">			String agentBooksDet = &quot;select gm.nbr_of_books_per_pack, gis.pack_nbr, gis.book_nbr, om.name 'agent_name' from  st_se_game_inv_status gis, st_se_game_master gm, st_lms_organization_master om where  gis.current_owner_id=om.organization_id  and gm.game_id=gis.game_id and gis.current_owner = 'AGENT' and om.organization_id=? and gis.game_id  = ? order by gis.book_nbr&quot;;</span>
			// String agentBooksDet = &quot;select gm.nbr_of_books_per_pack,
			// gis.pack_nbr, gis.book_nbr, om.name 'agent_name' from
			// st_se_game_inv_status gis, st_se_game_master gm,
			// st_lms_organization_master om where
			// gis.current_owner_id=om.organization_id and
			// gm.game_id=gis.game_id and gis.current_owner = 'AGENT' and
			// (gis.book_status = 'ACTIVE' or gis.book_status = 'INACTIVE' ) and
			// om.name like ? and gis.game_id = ? order by gis.book_nbr&quot;;
<span class="nc" id="L185">			pstmt = con.prepareStatement(agentBooksDet);</span>
<span class="nc" id="L186">			pstmt.setInt(1, agtId);</span>
<span class="nc" id="L187">			pstmt.setInt(2, gameid);</span>
<span class="nc" id="L188">			ResultSet rs = pstmt.executeQuery();</span>
<span class="nc" id="L189">			logger.info(&quot;QUERY IS ===&quot; + pstmt + &quot;\n\n\n&quot;);</span>
<span class="nc" id="L190">			String bookNbr = &quot;&quot;;</span>
<span class="nc" id="L191">			boolean first = true;</span>
<span class="nc" id="L192">			String packNbr = &quot;&quot;;</span>
<span class="nc" id="L193">			String newPackNbr = &quot;&quot;;</span>
<span class="nc" id="L194">			int booksPerPack = -1;</span>

<span class="nc bnc" id="L196" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L197">				booksPerPack = rs.getInt(&quot;nbr_of_books_per_pack&quot;);</span>
<span class="nc" id="L198">				newPackNbr = rs.getString(&quot;pack_nbr&quot;);</span>
<span class="nc" id="L199">				bookNbr = rs.getString(&quot;book_nbr&quot;);</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">				if (packNbr.equals(newPackNbr)) {</span>
<span class="nc" id="L201">					list.add(bookNbr);</span>
				} else {
<span class="nc bnc" id="L203" title="All 2 branches missed.">					if (!first) {</span>
<span class="nc" id="L204">						packBooksMap.put(packNbr, list);</span>
					}
<span class="nc" id="L206">					list = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L207">					packNbr = newPackNbr;</span>
<span class="nc" id="L208">					list.add(bookNbr);</span>
				}
<span class="nc" id="L210">				first = false;</span>
			}
<span class="nc" id="L212">			packBooksMap.put(packNbr, list);</span>
<span class="nc" id="L213">			rs.close();</span>

<span class="nc" id="L215">			packBooksMap.remove(&quot;&quot;);</span>

			// this method return the series of books on based of packs
<span class="nc" id="L218">			packWiseBookSeriesMap = CreateSeriesOfBooks(packBooksMap,</span>
					booksPerPack);

<span class="nc" id="L221">			first = true;</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">			if (packWiseBookSeriesMap.size() &gt; 0) {</span>
<span class="nc" id="L223">				resString = new StringBuilder(&quot;&quot;);</span>
<span class="nc" id="L224">				Set&lt;String&gt; packs = packWiseBookSeriesMap.keySet();</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">				for (String pack : packs) {</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">					if (first) {</span>
<span class="nc" id="L227">						first = false;</span>
					} else {
<span class="nc" id="L229">						resString.append(&quot;pack&quot;);</span>
					}
<span class="nc" id="L231">					resString.append(pack);</span>
<span class="nc" id="L232">					resString.append(&quot;book&quot;);</span>
					// logger.info(pack+&quot;, No of books
					// =&quot;+(packBooksMap.get(pack)).size());
<span class="nc" id="L235">					List&lt;String&gt; bookSeriesList = packWiseBookSeriesMap</span>
							.get(pack);
<span class="nc" id="L237">					String books = bookSeriesList.toString().replace(&quot;[&quot;, &quot;&quot;)</span>
							.replace(&quot;]&quot;, &quot;&quot;);
					// logger.info(&quot;books === &quot;+books);
<span class="nc" id="L240">					resString.append(books);</span>

<span class="nc" id="L242">				}</span>
				// logger.info(&quot;========================================&quot;);

			}
<span class="nc" id="L246">			logger.info(&quot; response  String  === &quot; + resString);</span>
			// generate the book_nbr from series
			// generateSeries(packWiseBookSeriesMap);

<span class="nc" id="L250">		} catch (SQLException e) {</span>
<span class="nc" id="L251">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L253">			try {</span>
<span class="nc bnc" id="L254" title="All 6 branches missed.">				if (pstmt != null) {</span>
<span class="nc" id="L255">					pstmt.close();</span>
				}
<span class="nc bnc" id="L257" title="All 12 branches missed.">				if (con != null &amp;&amp; !con.isClosed()) {</span>
<span class="nc" id="L258">					con.close();</span>
				}
<span class="nc" id="L260">			} catch (SQLException e) {</span>
<span class="nc" id="L261">				e.printStackTrace();</span>
<span class="nc" id="L262">			}</span>
<span class="nc" id="L263">		}</span>

<span class="nc" id="L265">		return resString.toString();</span>
	}

	public String getBoTotalBooksWithRetailer(int gameid, int retId) {
<span class="nc" id="L269">		logger.info(&quot;ret called&quot;);</span>
<span class="nc" id="L270">		resString = new StringBuilder(&quot;NONE&quot;);</span>
<span class="nc" id="L271">		Map&lt;String, List&lt;String&gt;&gt; packWiseBookSeriesMap = null;</span>
<span class="nc" id="L272">		Map&lt;String, List&lt;String&gt;&gt; packBooksMap = new TreeMap&lt;String, List&lt;String&gt;&gt;();</span>
<span class="nc" id="L273">		List&lt;String&gt; list = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L274">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L275">		PreparedStatement pstmt = null;</span>
		try {

			// when we required All books
<span class="nc" id="L279">			String booksWithRet = &quot;select gm.nbr_of_books_per_pack, gis.pack_nbr, gis.book_nbr, om.name 'agent_name' from  st_se_game_inv_status gis, st_se_game_master gm, st_lms_organization_master om where  gis.current_owner_id=om.organization_id  and gm.game_id=gis.game_id and gis.current_owner = 'RETAILER'  and om.organization_id= ? and gis.game_id  = ? order by gis.book_nbr&quot;;</span>

			// when we only required non claimable books
			// String booksWithRet = &quot;select gm.nbr_of_books_per_pack,
			// gis.pack_nbr, gis.book_nbr, om.name 'agent_name' from
			// st_se_game_inv_status gis, st_se_game_master gm,
			// st_lms_organization_master om where
			// gis.current_owner_id=om.organization_id and
			// gm.game_id=gis.game_id and gis.current_owner = 'RETAILER' and
			// (gis.book_status = 'ACTIVE' or gis.book_status = 'INACTIVE' ) and
			// om.name like ? and gis.game_id = ? order by gis.book_nbr&quot;;
<span class="nc" id="L290">			pstmt = con.prepareStatement(booksWithRet);</span>
<span class="nc" id="L291">			pstmt.setInt(1,retId);</span>
<span class="nc" id="L292">			pstmt.setInt(2, gameid);</span>
<span class="nc" id="L293">			ResultSet rs = pstmt.executeQuery();</span>
<span class="nc" id="L294">			logger.info(&quot;QUERY IS ===&quot; + pstmt + &quot;\n\n\n&quot;);</span>
<span class="nc" id="L295">			String bookNbr = &quot;&quot;;</span>
<span class="nc" id="L296">			boolean first = true;</span>
<span class="nc" id="L297">			String packNbr = &quot;&quot;;</span>
<span class="nc" id="L298">			String newPackNbr = &quot;&quot;;</span>
<span class="nc" id="L299">			int booksPerPack = -1;</span>

<span class="nc bnc" id="L301" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L302">				booksPerPack = rs.getInt(&quot;nbr_of_books_per_pack&quot;);</span>
<span class="nc" id="L303">				newPackNbr = rs.getString(&quot;pack_nbr&quot;);</span>
<span class="nc" id="L304">				bookNbr = rs.getString(&quot;book_nbr&quot;);</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">				if (packNbr.equals(newPackNbr)) {</span>
<span class="nc" id="L306">					list.add(bookNbr);</span>
				} else {
<span class="nc bnc" id="L308" title="All 2 branches missed.">					if (!first) {</span>
<span class="nc" id="L309">						packBooksMap.put(packNbr, list);</span>
					}
<span class="nc" id="L311">					list = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L312">					packNbr = newPackNbr;</span>
<span class="nc" id="L313">					list.add(bookNbr);</span>
				}
<span class="nc" id="L315">				first = false;</span>
			}
<span class="nc" id="L317">			packBooksMap.put(packNbr, list);</span>
<span class="nc" id="L318">			rs.close();</span>

<span class="nc" id="L320">			packBooksMap.remove(&quot;&quot;);</span>

			// this method return the series of books on based of packs
<span class="nc" id="L323">			packWiseBookSeriesMap = CreateSeriesOfBooks(packBooksMap,</span>
					booksPerPack);

<span class="nc" id="L326">			first = true;</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">			if (packWiseBookSeriesMap.size() &gt; 0) {</span>
<span class="nc" id="L328">				resString = new StringBuilder(&quot;&quot;);</span>
<span class="nc" id="L329">				Set&lt;String&gt; packs = packWiseBookSeriesMap.keySet();</span>
<span class="nc bnc" id="L330" title="All 2 branches missed.">				for (String pack : packs) {</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">					if (first) {</span>
<span class="nc" id="L332">						first = false;</span>
					} else {
<span class="nc" id="L334">						resString.append(&quot;pack&quot;);</span>
					}
<span class="nc" id="L336">					resString.append(pack);</span>
<span class="nc" id="L337">					resString.append(&quot;book&quot;);</span>
					// logger.info(pack+&quot;, No of books
					// =&quot;+(packBooksMap.get(pack)).size());
<span class="nc" id="L340">					List&lt;String&gt; bookSeriesList = packWiseBookSeriesMap</span>
							.get(pack);
<span class="nc" id="L342">					String books = bookSeriesList.toString().replace(&quot;[&quot;, &quot;&quot;)</span>
							.replace(&quot;]&quot;, &quot;&quot;);
					// logger.info(&quot;books === &quot;+books);
<span class="nc" id="L345">					resString.append(books);</span>

<span class="nc" id="L347">				}</span>
				// logger.info(&quot;========================================&quot;);
			}

<span class="nc" id="L351">			logger.info(&quot; response  String  === &quot; + resString);</span>
			// generate the book_nbr from series
			// generateSeries(packWiseBookSeriesMap);

<span class="nc" id="L355">		} catch (SQLException e) {</span>
<span class="nc" id="L356">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L358">			try {</span>
<span class="nc bnc" id="L359" title="All 6 branches missed.">				if (pstmt != null) {</span>
<span class="nc" id="L360">					pstmt.close();</span>
				}
<span class="nc bnc" id="L362" title="All 12 branches missed.">				if (con != null &amp;&amp; !con.isClosed()) {</span>
<span class="nc" id="L363">					con.close();</span>
				}
<span class="nc" id="L365">			} catch (SQLException e) {</span>
<span class="nc" id="L366">				e.printStackTrace();</span>
<span class="nc" id="L367">			}</span>
<span class="nc" id="L368">		}</span>

<span class="nc" id="L370">		return resString.toString();</span>
	}

	public String getGameInvetoryWithBO(int gameid) {
<span class="nc" id="L374">		resString = new StringBuilder(&quot;NONE&quot;);</span>
<span class="nc" id="L375">		logger.info(&quot;bo called&quot;);</span>
<span class="nc" id="L376">		Map&lt;String, List&lt;String&gt;&gt; packWiseBookSeriesMap = null;</span>
<span class="nc" id="L377">		Map&lt;String, List&lt;String&gt;&gt; packBooksMap = new TreeMap&lt;String, List&lt;String&gt;&gt;();</span>
<span class="nc" id="L378">		List&lt;String&gt; list = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L379">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L380">		PreparedStatement pstmt = null;</span>
		try {
<span class="nc" id="L382">			pstmt = con</span>
					.prepareStatement(&quot;select gm.nbr_of_books_per_pack, gis.pack_nbr, gis.book_nbr from  st_se_game_inv_status gis, st_se_game_master gm where  gm.game_id=gis.game_id and gis.current_owner = 'BO' and gis.game_id  = ? order by gis.book_nbr&quot;);
<span class="nc" id="L384">			pstmt.setInt(1, gameid);</span>
<span class="nc" id="L385">			ResultSet rs = pstmt.executeQuery();</span>
<span class="nc" id="L386">			logger.info(&quot;QUERY IS ===&quot; + pstmt + &quot;\n\n\n&quot;);</span>
<span class="nc" id="L387">			String bookNbr = &quot;&quot;;</span>
<span class="nc" id="L388">			boolean first = true;</span>
<span class="nc" id="L389">			String packNbr = &quot;&quot;;</span>
<span class="nc" id="L390">			String newPackNbr = &quot;&quot;;</span>
<span class="nc" id="L391">			int booksPerPack = -1;</span>

<span class="nc bnc" id="L393" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L394">				booksPerPack = rs.getInt(&quot;nbr_of_books_per_pack&quot;);</span>
<span class="nc" id="L395">				newPackNbr = rs.getString(&quot;pack_nbr&quot;);</span>
<span class="nc" id="L396">				bookNbr = rs.getString(&quot;book_nbr&quot;);</span>
<span class="nc bnc" id="L397" title="All 2 branches missed.">				if (packNbr.equals(newPackNbr)) {</span>
<span class="nc" id="L398">					list.add(bookNbr);</span>
				} else {
<span class="nc bnc" id="L400" title="All 2 branches missed.">					if (!first) {</span>
<span class="nc" id="L401">						packBooksMap.put(packNbr, list);</span>
					}
<span class="nc" id="L403">					list = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L404">					packNbr = newPackNbr;</span>
<span class="nc" id="L405">					list.add(bookNbr);</span>
				}
<span class="nc" id="L407">				first = false;</span>
			}
<span class="nc" id="L409">			packBooksMap.put(packNbr, list);</span>
<span class="nc" id="L410">			rs.close();</span>

<span class="nc" id="L412">			packBooksMap.remove(&quot;&quot;);</span>
			// this method return the series of books on based of packs
<span class="nc" id="L414">			packWiseBookSeriesMap = CreateSeriesOfBooks(packBooksMap,</span>
					booksPerPack);

<span class="nc bnc" id="L417" title="All 2 branches missed.">			if (packWiseBookSeriesMap.size() &gt; 0) {</span>
<span class="nc" id="L418">				resString = new StringBuilder(&quot;&quot;);</span>
<span class="nc" id="L419">				first = true;</span>
<span class="nc" id="L420">				Set&lt;String&gt; packs = packWiseBookSeriesMap.keySet();</span>
<span class="nc bnc" id="L421" title="All 2 branches missed.">				for (String pack : packs) {</span>
<span class="nc bnc" id="L422" title="All 2 branches missed.">					if (first) {</span>
<span class="nc" id="L423">						first = false;</span>
					} else {
<span class="nc" id="L425">						resString.append(&quot;pack&quot;);</span>
					}
<span class="nc" id="L427">					resString.append(pack);</span>
<span class="nc" id="L428">					resString.append(&quot;book&quot;);</span>
					// logger.info(pack+&quot;, No of books
					// =&quot;+(packBooksMap.get(pack)).size());
<span class="nc" id="L431">					List&lt;String&gt; bookSeriesList = packWiseBookSeriesMap</span>
							.get(pack);
<span class="nc" id="L433">					String books = bookSeriesList.toString().replace(&quot;[&quot;, &quot;&quot;)</span>
							.replace(&quot;]&quot;, &quot;&quot;);
					// logger.info(&quot;books === &quot;+books);
<span class="nc" id="L436">					resString.append(books);</span>

<span class="nc" id="L438">				}</span>
				// logger.info(&quot;========================================&quot;);
			}

<span class="nc" id="L442">			logger.info(&quot; response  String  === &quot; + resString);</span>

			// generateSeries(packWiseBookSeriesMap);

<span class="nc" id="L446">		} catch (SQLException e) {</span>
<span class="nc" id="L447">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L449">			try {</span>
<span class="nc bnc" id="L450" title="All 6 branches missed.">				if (pstmt != null) {</span>
<span class="nc" id="L451">					pstmt.close();</span>
				}
<span class="nc bnc" id="L453" title="All 12 branches missed.">				if (con != null &amp;&amp; !con.isClosed()) {</span>
<span class="nc" id="L454">					con.close();</span>
				}
<span class="nc" id="L456">			} catch (SQLException e) {</span>
<span class="nc" id="L457">				e.printStackTrace();</span>
<span class="nc" id="L458">			}</span>
<span class="nc" id="L459">		}</span>

<span class="nc" id="L461">		return resString.toString();</span>
	}

	public Map&lt;String, String&gt; getGameMap() {
<span class="nc" id="L465">		Map&lt;String, String&gt; gameMap = new HashMap&lt;String, String&gt;();</span>
<span class="nc" id="L466">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L467">		PreparedStatement pstmt = null;</span>
		try {
<span class="nc" id="L469">			pstmt = con</span>
					.prepareStatement(&quot;select game_id, game_nbr, concat(game_nbr, concat('-',game_name)) 'game_name'  from st_se_game_master order by game_nbr&quot;);
<span class="nc" id="L471">			ResultSet rs = pstmt.executeQuery();</span>
<span class="nc" id="L472">			logger.info(&quot;getgameList&quot;);</span>
<span class="nc bnc" id="L473" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L474">				String gameId = rs.getInt(&quot;game_id&quot;) + &quot;&quot;;</span>
<span class="nc" id="L475">				String gameName = rs.getString(&quot;game_name&quot;);</span>
<span class="nc" id="L476">				gameMap.put(gameId, gameName);</span>
<span class="nc" id="L477">			}</span>
<span class="nc" id="L478">			rs.close();</span>
<span class="nc" id="L479">		} catch (SQLException e) {</span>
<span class="nc" id="L480">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L482">			try {</span>
<span class="nc bnc" id="L483" title="All 6 branches missed.">				if (pstmt != null) {</span>
<span class="nc" id="L484">					pstmt.close();</span>
				}
<span class="nc bnc" id="L486" title="All 12 branches missed.">				if (con != null &amp;&amp; !con.isClosed()) {</span>
<span class="nc" id="L487">					con.close();</span>
				}
<span class="nc" id="L489">			} catch (SQLException e) {</span>
<span class="nc" id="L490">				e.printStackTrace();</span>
<span class="nc" id="L491">			}</span>
<span class="nc" id="L492">		}</span>
<span class="nc" id="L493">		return gameMap;</span>
	}

	public List&lt;String&gt; getRetailerList(String agentOrgName)
			throws LMSException {
<span class="nc" id="L498">		List&lt;String&gt; retOrgNameList = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L499">		Connection con = null;</span>
<span class="nc" id="L500">		PreparedStatement pstmt = null;</span>
<span class="nc" id="L501">		ResultSet rs = null;</span>
<span class="nc" id="L502">		con = DBConnect.getConnection();</span>
		try {
<span class="nc" id="L504">			pstmt = con</span>
					.prepareStatement(&quot;select o.name, o.organization_type  from st_lms_organization_master o, st_lms_organization_master om where o.organization_type='RETAILER' and o.parent_id=om.organization_id and  om.name like ? order by o.name&quot;);
<span class="nc bnc" id="L506" title="All 2 branches missed.">			if (&quot;-1&quot;.equalsIgnoreCase(agentOrgName.trim())) {</span>
<span class="nc" id="L507">				pstmt.setString(1, &quot;%&quot;);</span>
			} else {
<span class="nc" id="L509">				pstmt.setString(1, agentOrgName.replace(&quot;amp&quot;, &quot;&amp;&quot;).trim());</span>
			}
<span class="nc" id="L511">			rs = pstmt.executeQuery();</span>
<span class="nc" id="L512">			logger.info(&quot;retailer list  query ==== &quot; + pstmt);</span>

<span class="nc bnc" id="L514" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L515">				String retName = rs.getString(&quot;name&quot;);</span>
<span class="nc" id="L516">				retOrgNameList.add(retName);</span>
<span class="nc" id="L517">			}</span>

<span class="nc" id="L519">		} catch (SQLException e) {</span>
<span class="nc" id="L520">			e.printStackTrace();</span>
<span class="nc" id="L521">			throw new LMSException(e);</span>
		} finally {
<span class="nc" id="L523">			try {</span>
<span class="nc bnc" id="L524" title="All 4 branches missed.">				if (rs != null) {</span>
<span class="nc" id="L525">					rs.close();</span>
				}
<span class="nc bnc" id="L527" title="All 4 branches missed.">				if (pstmt != null) {</span>
<span class="nc" id="L528">					pstmt.close();</span>
				}
<span class="nc bnc" id="L530" title="All 8 branches missed.">				if (con != null &amp;&amp; !con.isClosed()) {</span>
<span class="nc" id="L531">					con.close();</span>
				}
<span class="nc" id="L533">			} catch (SQLException e) {</span>
<span class="nc" id="L534">				e.printStackTrace();</span>
<span class="nc" id="L535">			}</span>
<span class="nc" id="L536">		}</span>
<span class="nc" id="L537">		return retOrgNameList;</span>
	}
	
	public String fetchWarehouseWiseInventory(int warehouse, int gameId) {
<span class="nc" id="L541">		resString = new StringBuilder(&quot;NONE&quot;);</span>
<span class="nc" id="L542">		Connection con = DBConnect.getConnection();</span>
		
<span class="nc" id="L544">		Map&lt;Integer, WarehouseInventoryDetailBean&gt; warehouseInventoryMap = new HashMap&lt;Integer, WarehouseInventoryDetailBean&gt;();</span>
<span class="nc" id="L545">		WarehouseInventoryDetailBean warehouseInventoryDetailBean = null;</span>
<span class="nc" id="L546">		Map&lt;Integer, WarehouseWiseGameInventoryDetailBean&gt; warehouseGameMap = null;</span>
<span class="nc" id="L547">		WarehouseWiseGameInventoryDetailBean warehouseWiseGameInventoryDetailBean = null;</span>
<span class="nc" id="L548">		Map&lt;String, List&lt;String&gt;&gt; packBookList = null;</span>
<span class="nc" id="L549">		List&lt;String&gt; bookList = null;</span>
		
<span class="nc" id="L551">		Statement stmt = null;</span>
<span class="nc" id="L552">		ResultSet rs = null; </span>
		
<span class="nc" id="L554">		String jsonValue = null;</span>
		
<span class="nc" id="L556">		String query = &quot;select wm.warehouse_id, wm.warehouse_name, gm.game_id, gm.game_name, gm.nbr_of_books_per_pack, gis.pack_nbr, gis.book_nbr from st_se_game_inv_status gis inner join st_se_game_master gm on gis.game_id = gm.game_id inner join st_se_warehouse_master wm on gis.warehouse_id = wm.warehouse_id where gm.game_id = gis.game_id and gis.current_owner = 'BO' &quot;;</span>
		try {
<span class="nc bnc" id="L558" title="All 2 branches missed.">			if (warehouse != -1) {</span>
<span class="nc" id="L559">				query = query + &quot; and wm.warehouse_id = &quot; + warehouse;</span>
			}

<span class="nc bnc" id="L562" title="All 2 branches missed.">			if (gameId != -1) {</span>
<span class="nc" id="L563">				query = query + &quot; and gm.game_id = &quot; + gameId;</span>
			}
			
<span class="nc" id="L566">			query += &quot; order by gis.book_nbr;&quot;;</span>

<span class="nc" id="L568">			stmt = con.createStatement();</span>
<span class="nc" id="L569">			rs = stmt.executeQuery(query);</span>
			
<span class="nc bnc" id="L571" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc bnc" id="L572" title="All 2 branches missed.">				if (warehouseInventoryMap.containsKey(rs.getInt(&quot;warehouse_id&quot;))) {</span>
<span class="nc bnc" id="L573" title="All 2 branches missed.">					if (warehouseInventoryMap.get(rs.getInt(&quot;warehouse_id&quot;)).getWarehouseGameMap().containsKey(rs.getInt(&quot;game_id&quot;))) {</span>
<span class="nc bnc" id="L574" title="All 2 branches missed.">						if(warehouseInventoryMap.get(rs.getInt(&quot;warehouse_id&quot;)).getWarehouseGameMap().get(rs.getInt(&quot;game_id&quot;)).getPackBookList().containsKey(rs.getString(&quot;pack_nbr&quot;))) {</span>
<span class="nc" id="L575">							warehouseInventoryMap.get(rs.getInt(&quot;warehouse_id&quot;)).getWarehouseGameMap().get(rs.getInt(&quot;game_id&quot;)).getPackBookList().get(rs.getString(&quot;pack_nbr&quot;)).add(rs.getString(&quot;book_nbr&quot;));</span>
						} else {
<span class="nc" id="L577">							bookList = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L578">							bookList.add(rs.getString(&quot;book_nbr&quot;));</span>
<span class="nc" id="L579">							warehouseInventoryMap.get(rs.getInt(&quot;warehouse_id&quot;)).getWarehouseGameMap().get(rs.getInt(&quot;game_id&quot;)).getPackBookList().put(rs.getString(&quot;pack_nbr&quot;), bookList);</span>
						}
					} else {
<span class="nc" id="L582">						packBookList = new HashMap&lt;String, List&lt;String&gt;&gt;();</span>
<span class="nc" id="L583">						bookList = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L584">						bookList.add(rs.getString(&quot;book_nbr&quot;));</span>
<span class="nc" id="L585">						packBookList.put(rs.getString(&quot;pack_nbr&quot;), bookList);</span>

<span class="nc" id="L587">						warehouseWiseGameInventoryDetailBean = new WarehouseWiseGameInventoryDetailBean();</span>
<span class="nc" id="L588">						warehouseWiseGameInventoryDetailBean.setGameName(rs.getString(&quot;game_name&quot;));</span>
<span class="nc" id="L589">						warehouseWiseGameInventoryDetailBean.setPackBookList(packBookList);</span>
						
<span class="nc" id="L591">						warehouseInventoryMap.get(rs.getInt(&quot;warehouse_id&quot;)).getWarehouseGameMap().put(rs.getInt(&quot;game_id&quot;), warehouseWiseGameInventoryDetailBean);</span>
					}
				} else {
<span class="nc" id="L594">					packBookList = new HashMap&lt;String, List&lt;String&gt;&gt;();</span>
<span class="nc" id="L595">					bookList = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L596">					bookList.add(rs.getString(&quot;book_nbr&quot;));</span>
<span class="nc" id="L597">					packBookList.put(rs.getString(&quot;pack_nbr&quot;), bookList);</span>

<span class="nc" id="L599">					warehouseWiseGameInventoryDetailBean = new WarehouseWiseGameInventoryDetailBean();</span>
<span class="nc" id="L600">					warehouseWiseGameInventoryDetailBean.setGameName(rs.getString(&quot;game_name&quot;));</span>
<span class="nc" id="L601">					warehouseWiseGameInventoryDetailBean.setPackBookList(packBookList);</span>

<span class="nc" id="L603">					warehouseGameMap = new HashMap&lt;Integer, WarehouseWiseGameInventoryDetailBean&gt;();</span>
<span class="nc" id="L604">					warehouseGameMap.put(rs.getInt(&quot;game_id&quot;), warehouseWiseGameInventoryDetailBean);</span>

<span class="nc" id="L606">					warehouseInventoryDetailBean = new WarehouseInventoryDetailBean();</span>
<span class="nc" id="L607">					warehouseInventoryDetailBean.setWarehouseName(rs.getString(&quot;warehouse_name&quot;));</span>
<span class="nc" id="L608">					warehouseInventoryDetailBean.setWarehouseGameMap(warehouseGameMap);</span>

<span class="nc" id="L610">					warehouseInventoryMap.put(rs.getInt(&quot;warehouse_id&quot;), warehouseInventoryDetailBean);</span>
				}
			}
			
<span class="nc" id="L614">			jsonValue = new Gson().toJson(warehouseInventoryMap);</span>
			
<span class="nc" id="L616">			logger.info(&quot;Warehouse Wise Inventory Map &quot; + warehouseInventoryMap);</span>
<span class="nc" id="L617">		} catch (SQLException e) {</span>
<span class="nc" id="L618">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L620">			try {</span>
<span class="nc bnc" id="L621" title="All 6 branches missed.">				if (stmt != null) {</span>
<span class="nc" id="L622">					stmt.close();</span>
				}
<span class="nc bnc" id="L624" title="All 12 branches missed.">				if (con != null &amp;&amp; !con.isClosed()) {</span>
<span class="nc" id="L625">					con.close();</span>
				}
<span class="nc" id="L627">			} catch (SQLException e) {</span>
<span class="nc" id="L628">				e.printStackTrace();</span>
<span class="nc" id="L629">			}</span>
<span class="nc" id="L630">		}</span>
<span class="nc" id="L631">		return jsonValue;</span>
	}

	public Map&lt;Integer, String&gt; fetchWareHouseMap() throws ScratchException {
<span class="nc" id="L635">		Statement stmt = null;</span>
<span class="nc" id="L636">		ResultSet rs = null;</span>
<span class="nc" id="L637">		Connection con = null;</span>
<span class="nc" id="L638">		Map&lt;Integer, String&gt; warehouseMap = new HashMap&lt;Integer, String&gt;();</span>
		try {
<span class="nc" id="L640">			con = DBConnect.getConnection();</span>
<span class="nc" id="L641">			stmt = con.createStatement();</span>
<span class="nc" id="L642">			rs = stmt.executeQuery(&quot;select warehouse_id, warehouse_name from st_se_warehouse_master;&quot;);</span>
<span class="nc bnc" id="L643" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L644">				warehouseMap.put(rs.getInt(&quot;warehouse_id&quot;), rs.getString(&quot;warehouse_name&quot;));</span>
			}
<span class="nc" id="L646">		} catch (SQLException e) {</span>
<span class="nc" id="L647">			e.printStackTrace();</span>
<span class="nc" id="L648">			throw new ScratchException(ScratchErrors.SQL_EXCEPTION_ERROR_CODE, ScratchErrors.SQL_EXCEPTION_ERROR_MESSAGE);</span>
<span class="nc" id="L649">		} catch (Exception e) {</span>
<span class="nc" id="L650">			e.printStackTrace();</span>
<span class="nc" id="L651">			throw new ScratchException(ScratchErrors.GENERAL_EXCEPTION_ERROR_CODE, ScratchErrors.GENERAL_EXCEPTION_ERROR_MESSAGE);</span>
		} finally {
<span class="nc" id="L653">			DBConnect.closeCon(con);</span>
<span class="nc" id="L654">		}</span>
<span class="nc" id="L655">		return warehouseMap;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>