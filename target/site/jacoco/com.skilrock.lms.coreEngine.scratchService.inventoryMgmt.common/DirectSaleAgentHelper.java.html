<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DirectSaleAgentHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lms</a> &gt; <a href="index.source.html" class="el_package">com.skilrock.lms.coreEngine.scratchService.inventoryMgmt.common</a> &gt; <span class="el_source">DirectSaleAgentHelper.java</span></div><h1>DirectSaleAgentHelper.java</h1><pre class="source lang-java linenums">package com.skilrock.lms.coreEngine.scratchService.inventoryMgmt.common;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Set;

import com.skilrock.lms.beans.BookBean;
import com.skilrock.lms.beans.BookSaleBean;
import com.skilrock.lms.common.db.DBConnect;
import com.skilrock.lms.common.db.QueryManager;
import com.skilrock.lms.common.db.TableConstants;
import com.skilrock.lms.common.exception.LMSException;
import com.skilrock.lms.common.utility.CommonMethods;
import com.skilrock.lms.common.utility.GenerateRecieptNo;
import com.skilrock.lms.common.utility.OrgCreditUpdation;
import com.skilrock.lms.coreEngine.reportsMgmt.common.GraphReportHelper;
import com.skilrock.lms.web.drawGames.common.Util;

<span class="nc" id="L29">public class DirectSaleAgentHelper {</span>

	public static void main(String[] args) throws LMSException {
<span class="nc" id="L32">		List&lt;String&gt; l1 = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L33">		List&lt;String&gt; l2 = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L34">		Map&lt;Integer, List&lt;String&gt;&gt; gameBookMap = new HashMap&lt;Integer, List&lt;String&gt;&gt;();</span>
<span class="nc" id="L35">		l1.add(&quot;111-001011&quot;);</span>
		// l1.add(&quot;111-001010&quot;);

<span class="nc" id="L38">		l2.add(&quot;500-002036&quot;);</span>
		// l2.add(&quot;500-002084&quot;);
<span class="nc" id="L40">		gameBookMap.put(52, l1);</span>
<span class="nc" id="L41">		gameBookMap.put(57, l2);</span>
<span class="nc" id="L42">		DirectSaleAgentHelper gg = new DirectSaleAgentHelper();</span>
		// gg.dispatchOrderDirectSale(gameBookMap,486,114,&quot;ANONYMOUS&quot;);

<span class="nc" id="L45">	}</span>
	
	public String dispatchOrderDirectSale(Map&lt;Integer, List&lt;String&gt;&gt; gameBookMap,
			int agtId, int userOrgID, int retailerName, String rootPath,
			String loggedInUserOrgName, String newBookStatus, Connection connection)
			throws LMSException {

<span class="nc" id="L52">		int DCId = -1;</span>
<span class="nc" id="L53">		int invoiceId = -1;</span>
<span class="nc" id="L54">		int warehouseId = -1;</span>
<span class="nc bnc" id="L55" title="All 2 branches missed.">		if (gameBookMap != null) {</span>

<span class="nc" id="L57">			PreparedStatement agtMasterStmt = null;</span>
<span class="nc" id="L58">			PreparedStatement LMSMasterStmt = null;</span>
<span class="nc" id="L59">			PreparedStatement agtAgentStmt = null;</span>
<span class="nc" id="L60">			PreparedStatement agtOrdGameStmt = null;</span>
<span class="nc" id="L61">			PreparedStatement agtReceiptStmt = null;</span>
<span class="nc" id="L62">			PreparedStatement agtReceiptNoGenStmt = null;</span>
<span class="nc" id="L63">			PreparedStatement agtReceiptMappingStmt = null;</span>
<span class="nc" id="L64">			PreparedStatement agtOrderStmt = null;</span>

<span class="nc" id="L66">			PreparedStatement agtInvoiceDCMappingStmt = null;</span>

<span class="nc" id="L68">			PreparedStatement gameInvStatusStmt = null;</span>
<span class="nc" id="L69">			PreparedStatement gameInvDetailStmt = null;</span>
<span class="nc" id="L70">			PreparedStatement orderInvoicesPrtSt = null;</span>

<span class="nc" id="L72">			PreparedStatement getBookFromPackPstmt = null;</span>
<span class="nc" id="L73">			PreparedStatement isGovtCommChngdPstmt = null;</span>

<span class="nc" id="L75">			PreparedStatement orderPstmt = null;</span>
<span class="nc" id="L76">			PreparedStatement gamePstmt = null;</span>

<span class="nc" id="L78">			ResultSet rsMaster = null;</span>
<span class="nc" id="L79">			String orderInvoicesQuery = null;</span>
<span class="nc" id="L80">			String agtMasterQuery = null;</span>
<span class="nc" id="L81">			String LMSMasterQuery = null;</span>
<span class="nc" id="L82">			String agtAgentQuery = null;</span>
<span class="nc" id="L83">			String agtOrdGamesQuery = null;</span>
<span class="nc" id="L84">			String agtReceiptMappingQuery = null;</span>
<span class="nc" id="L85">			String agtOrderQuery = null;</span>
<span class="nc" id="L86">			String gameInvStatusQuery = null;</span>
<span class="nc" id="L87">			String invQuery = null;</span>
<span class="nc" id="L88">			String gameInvDetailQuery = null;</span>
<span class="nc" id="L89">			String getBookfromPackQuery = null;</span>
<span class="nc" id="L90">			String isGovtCommChangedQuery = null;</span>
<span class="nc" id="L91">			String orderQuery = null;</span>
<span class="nc" id="L92">			String gameQuery = null;</span>

<span class="nc" id="L94">			List&lt;Integer&gt; trnIdList = new ArrayList&lt;Integer&gt;();</span>
<span class="nc" id="L95">			int masterTrnId = -1;</span>
			try {

<span class="nc" id="L98">				agtMasterQuery = QueryManager.insertInAgentTransactionMaster();</span>
<span class="nc" id="L99">				agtMasterStmt = connection.prepareStatement(agtMasterQuery);</span>

<span class="nc" id="L101">				LMSMasterQuery = QueryManager.insertInLMSTransactionMaster();</span>
<span class="nc" id="L102">				LMSMasterStmt = connection.prepareStatement(LMSMasterQuery);</span>

<span class="nc" id="L104">				agtAgentQuery = QueryManager.getST1AgentRetQuery();</span>
<span class="nc" id="L105">				agtAgentStmt = connection.prepareStatement(agtAgentQuery);</span>

<span class="nc" id="L107">				agtOrdGamesQuery = QueryManager.getST1AgtOrdGamesUpdQuery();</span>
<span class="nc" id="L108">				agtOrdGameStmt = connection.prepareStatement(agtOrdGamesQuery);</span>

<span class="nc" id="L110">				java.sql.Timestamp currentDate = new java.sql.Timestamp(</span>
						new Date().getTime());

<span class="nc" id="L113">				agtReceiptMappingQuery = QueryManager</span>
						.insertAgentReceiptTrnMapping();
<span class="nc" id="L115">				agtReceiptMappingStmt = connection</span>
						.prepareStatement(agtReceiptMappingQuery);

<span class="nc" id="L118">				agtOrderQuery = QueryManager.getST1AgtOrdUpdQuery();</span>
<span class="nc" id="L119">				agtOrderStmt = connection.prepareStatement(agtOrderQuery);</span>

<span class="nc" id="L121">				gameInvStatusQuery = QueryManager</span>
						.getST1AgtUpdGameInvStatusQuery();

<span class="nc" id="L124">				gameInvDetailQuery = QueryManager.getST1InvDetailWithWarehouseInsertQuery();</span>
<span class="nc" id="L125">				gameInvDetailStmt = connection</span>
						.prepareStatement(gameInvDetailQuery);

<span class="nc" id="L128">				orderInvoicesQuery = QueryManager</span>
						.getST1AgentOrderInInsertQuery();
<span class="nc" id="L130">				orderInvoicesPrtSt = connection</span>
						.prepareStatement(orderInvoicesQuery);

<span class="nc" id="L133">				getBookfromPackQuery = &quot;select book_nbr from st_se_game_inv_status where pack_nbr=?&quot;;</span>
<span class="nc" id="L134">				getBookFromPackPstmt = connection</span>
						.prepareStatement(getBookfromPackQuery);

<span class="nc" id="L137">				isGovtCommChangedQuery = &quot;select count(*) from st_se_game_govt_comm_history where game_id=?&quot;;</span>
<span class="nc" id="L138">				isGovtCommChngdPstmt = connection</span>
						.prepareStatement(isGovtCommChangedQuery);

				// added by arun
<span class="nc" id="L142">				String fetchPurRateQuery = &quot;select transacrion_sale_comm_rate from st_se_game_inv_detail where &quot;</span>
						+ &quot;book_nbr=? and transaction_at='BO' order by transaction_date desc limit 1&quot;;
<span class="nc" id="L144">				PreparedStatement fetchPurRatePstmt = connection</span>
						.prepareStatement(fetchPurRateQuery);
<span class="nc" id="L146">				ResultSet fetchPurRateRs = null;</span>

<span class="nc" id="L148">				String detHistoryInsQuery = &quot;insert into st_se_game_ticket_inv_history(game_id, book_nbr, &quot;</span>
						+ &quot; current_owner, current_owner_id, date, done_by_oid, done_by_uid, cur_rem_tickets, &quot;
						+ &quot; active_tickets_upto, sold_tickets, status) values (?,?,?,?,?,?,?,?,?,?,?)&quot;;
<span class="nc" id="L151">				PreparedStatement detHistoryInsPstmt = connection</span>
						.prepareStatement(detHistoryInsQuery);

<span class="nc" id="L154">				double purRate = 0.0;</span>

<span class="nc" id="L156">				double mrpAmt = 0.0;</span>
<span class="nc" id="L157">				double commAmt = 0.0;</span>
<span class="nc" id="L158">				double netAmt = 0.0;</span>
<span class="nc" id="L159">				double vatAmt = 0.0;</span>
<span class="nc" id="L160">				double taxableSale = 0.0;</span>
<span class="nc" id="L161">				double retSaleCommRate = 0.0;</span>
<span class="nc" id="L162">				double creditAmt = 0.0;</span>

<span class="nc" id="L164">				Statement stmt = connection.createStatement();</span>
				// ResultSet rsRet=stmt.executeQuery(&quot;select
				// organization_id,user_id from st_lms_user_master where
				// organization_id=(select organization_id from
				// st_lms_organization_master where
				// name='&quot;+retailerName.trim()+&quot;')&quot;);
<span class="nc" id="L170">				ResultSet rsRet = stmt</span>
						.executeQuery(&quot;select organization_id,user_id from st_lms_user_master &quot;
								+ &quot; where organization_id = &quot;+ retailerName
								+ &quot; and isrolehead = 'Y' and role_id = &quot;
								+ &quot; (select role_id from st_lms_role_master where is_master = 'Y' and tier_id = &quot;
								+ &quot; (select tier_id from st_lms_tier_master where tier_code = 'RETAILER'))&quot;);
<span class="nc" id="L176">				int retId = -1;</span>
<span class="nc" id="L177">				int retOrgId = -1;</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">				while (rsRet.next()) {</span>
<span class="nc" id="L179">					retId = rsRet.getInt(&quot;user_id&quot;);</span>
<span class="nc" id="L180">					retOrgId = rsRet.getInt(&quot;organization_id&quot;);</span>

				}

<span class="nc" id="L184">				int gameId = -1;</span>
<span class="nc" id="L185">				int orderId = -1;</span>
				// get order query

<span class="nc" id="L188">				orderQuery = QueryManager.getST1InsertAgtOrderQuery();</span>
<span class="nc" id="L189">				orderPstmt = connection.prepareStatement(orderQuery);</span>

				// get ordered game query
<span class="nc" id="L192">				gameQuery = QueryManager.getST1InsertAgtOrderedGamesQuery();</span>
<span class="nc" id="L193">				gamePstmt = connection.prepareStatement(gameQuery);</span>

				// set parameters for insert into order table

<span class="nc" id="L197">				orderPstmt.setInt(1, agtId);</span>
<span class="nc" id="L198">				orderPstmt.setInt(2, retId);</span>
<span class="nc" id="L199">				orderPstmt.setInt(3, retOrgId);</span>
<span class="nc" id="L200">				orderPstmt.setDate(4, new java.sql.Date(new Date().getTime()));</span>
<span class="nc" id="L201">				orderPstmt.setString(5, &quot;AUTO_APPROVED&quot;);</span>
<span class="nc" id="L202">				orderPstmt.setString(6, &quot;Y&quot;);</span>
<span class="nc" id="L203">				orderPstmt.setInt(7, userOrgID);</span>
<span class="nc" id="L204">				orderPstmt.execute();</span>
<span class="nc" id="L205">				ResultSet resultSet = orderPstmt.getGeneratedKeys();</span>

<span class="nc bnc" id="L207" title="All 2 branches missed.">				while (resultSet.next()) {</span>
<span class="nc" id="L208">					orderId = resultSet.getInt(1);</span>
				}

<span class="nc" id="L211">				System.out.println(&quot;OrderId::&quot; + orderId);</span>

				// now we have to iterate for all games to enter orederd games
				// set parameters for insert into ordered games table
<span class="nc" id="L215">				Set&lt;Integer&gt; keySet = gameBookMap.keySet();</span>
				// insert in receipt master for invoice

<span class="nc" id="L218">				agtReceiptStmt = connection.prepareStatement(QueryManager</span>
						.insertInReceiptMaster());
<span class="nc" id="L220">				agtReceiptStmt.setString(1, &quot;AGENT&quot;);</span>
<span class="nc" id="L221">				agtReceiptStmt.executeUpdate();</span>

<span class="nc" id="L223">				ResultSet rs = agtReceiptStmt.getGeneratedKeys();</span>
				
<span class="nc bnc" id="L225" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L226">					invoiceId = rs.getInt(1);</span>
				}

				// insert in receipt master for delevery challan
<span class="nc" id="L230">				agtReceiptStmt = connection.prepareStatement(QueryManager</span>
						.insertInReceiptMaster());
<span class="nc" id="L232">				agtReceiptStmt.setString(1, &quot;AGENT&quot;);</span>
<span class="nc" id="L233">				agtReceiptStmt.executeUpdate();</span>

<span class="nc" id="L235">				ResultSet DCrs = agtReceiptStmt.getGeneratedKeys();</span>
<span class="nc" id="L236">				DCId = -1;</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">				while (DCrs.next()) {</span>
<span class="nc" id="L238">					DCId = DCrs.getInt(1);</span>
				}

				// check book Status on dispatch
				// String newBookStatus = &quot;ACTIVE&quot;;

<span class="nc bnc" id="L244" title="All 2 branches missed.">				for (int gameNbr : keySet) {</span>
<span class="nc" id="L245">					List&lt;String&gt; bookList = gameBookMap.get(gameNbr);</span>
<span class="nc" id="L246">					double bookPrice = 0.0;</span>
<span class="nc" id="L247">					double retailer_sale_comm_rate = 0.0;</span>
<span class="nc" id="L248">					double retGameCommVariance = 0.0;</span>
<span class="nc" id="L249">					double prizepayoutRatio = 0.0;</span>
<span class="nc" id="L250">					double vat = 0.0;</span>
<span class="nc" id="L251">					double fixed_amt = 0.0;</span>
<span class="nc" id="L252">					long tickets_in_scheme = 0l;</span>
<span class="nc" id="L253">					String govtCommRule = null;</span>
<span class="nc" id="L254">					double govt_comm_rate = 0.0;</span>
<span class="nc" id="L255">					boolean isGovtCommChanged = false;</span>
<span class="nc" id="L256">					int noOfTktPerBooks = -1;</span>
					// now get the game information from game ID

<span class="nc" id="L259">					ResultSet rsGame = stmt</span>
							.executeQuery(&quot;select * from st_se_game_master where game_nbr=&quot;
									+ gameNbr);
<span class="nc bnc" id="L262" title="All 2 branches missed.">					while (rsGame.next()) {</span>
<span class="nc" id="L263">						gameId = rsGame.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L264">						bookPrice = rsGame.getDouble(&quot;ticket_price&quot;)</span>
								* rsGame.getInt(&quot;nbr_of_tickets_per_book&quot;);
<span class="nc" id="L266">						noOfTktPerBooks = rsGame</span>
								.getInt(&quot;nbr_of_tickets_per_book&quot;);
<span class="nc" id="L268">						retailer_sale_comm_rate = rsGame</span>
								.getDouble(&quot;retailer_sale_comm_rate&quot;);
<span class="nc" id="L270">						prizepayoutRatio = rsGame</span>
								.getDouble(&quot;prize_payout_ratio&quot;);
<span class="nc" id="L272">						vat = rsGame.getDouble(&quot;vat_amt&quot;);</span>
<span class="nc" id="L273">						fixed_amt = rsGame.getDouble(&quot;fixed_amt&quot;);</span>
<span class="nc" id="L274">						tickets_in_scheme = rsGame.getLong(&quot;tickets_in_scheme&quot;);</span>
<span class="nc" id="L275">						govtCommRule = rsGame.getString(&quot;govt_comm_type&quot;);</span>
<span class="nc" id="L276">						govt_comm_rate = rsGame.getDouble(&quot;govt_comm_rate&quot;);</span>
					}

<span class="nc" id="L279">					rsGame = stmt</span>
							.executeQuery(&quot;select sale_comm_variance  from st_se_agent_retailer_sale_pwt_comm_variance where retailer_org_id=&quot;
									+ retOrgId + &quot; and game_id=&quot; + gameId);
					// System.out.println(&quot;comm var query :: &quot; + &quot;select
					// sale_comm_variance from
					// st_se_agent_retailer_sale_pwt_comm_variance where
					// ret_org_id=&quot;+retOrgId+&quot; and game_id=&quot;+gameId);
<span class="nc bnc" id="L286" title="All 2 branches missed.">					if (rsGame.next()) {</span>
<span class="nc" id="L287">						retGameCommVariance = rsGame</span>
								.getDouble(&quot;sale_comm_variance&quot;);
						// retailer_sale_comm_rate=rsGame.getDouble(&quot;default_sale_comm_rate&quot;);

					}
<span class="nc" id="L292">					gamePstmt.setInt(1, orderId);</span>
<span class="nc" id="L293">					gamePstmt.setInt(2, gameId);</span>
<span class="nc" id="L294">					gamePstmt.setInt(3, bookList.size());</span>
<span class="nc" id="L295">					gamePstmt.setInt(4, bookList.size());</span>
<span class="nc" id="L296">					gamePstmt.execute();</span>
					;

					// check if govt comm of this game is changed or not in govt
					// comm history table
<span class="nc" id="L301">					isGovtCommChngdPstmt.setInt(1, gameId);</span>
<span class="nc" id="L302">					ResultSet isGovtCommChngdRs = isGovtCommChngdPstmt</span>
							.executeQuery();
<span class="nc bnc" id="L304" title="All 2 branches missed.">					if (isGovtCommChngdRs.next()) {</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">						if (isGovtCommChngdRs.getInt(1) &gt; 1) {</span>
<span class="nc" id="L306">							isGovtCommChanged = true;</span>
						}
					}

<span class="nc bnc" id="L310" title="All 2 branches missed.">					if (isGovtCommChanged == false) {</span>
<span class="nc" id="L311">						System.out</span>
								.println(&quot; &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;  :: inside false &quot;);

						// insert in LMS transaction master
<span class="nc" id="L315">						LMSMasterStmt.setString(1, &quot;AGENT&quot;);</span>
<span class="nc" id="L316">						LMSMasterStmt.executeUpdate();</span>
<span class="nc" id="L317">						rsMaster = null;</span>
<span class="nc" id="L318">						rsMaster = LMSMasterStmt.getGeneratedKeys();</span>

<span class="nc bnc" id="L320" title="All 2 branches missed.">						while (rsMaster.next()) {</span>
<span class="nc" id="L321">							masterTrnId = rsMaster.getInt(1);</span>
<span class="nc" id="L322">							trnIdList.add(masterTrnId);</span>
						}

						// insert in agent transaction master

<span class="nc" id="L327">						agtMasterStmt.setInt(1, masterTrnId);</span>
<span class="nc" id="L328">						agtMasterStmt.setInt(2, agtId);</span>
<span class="nc" id="L329">						agtMasterStmt.setInt(3, userOrgID);</span>
<span class="nc" id="L330">						agtMasterStmt.setString(4, &quot;RETAILER&quot;);</span>
<span class="nc" id="L331">						agtMasterStmt.setInt(5, retOrgId);</span>
<span class="nc" id="L332">						agtMasterStmt.setString(6, &quot;SALE&quot;);</span>
<span class="nc" id="L333">						agtMasterStmt.setTimestamp(7, currentDate);</span>
<span class="nc" id="L334">						agtMasterStmt.execute();</span>

						// Agent - Retailer Trn Master

<span class="nc" id="L338">						agtAgentStmt.setInt(1, masterTrnId);</span>
<span class="nc" id="L339">						agtAgentStmt.setInt(2, gameId);</span>
<span class="nc" id="L340">						agtAgentStmt.setInt(3, agtId);</span>
<span class="nc" id="L341">						agtAgentStmt.setInt(4, retOrgId);</span>

<span class="nc" id="L343">						mrpAmt = bookList.size() * bookPrice;</span>
<span class="nc" id="L344">						agtAgentStmt.setDouble(5, mrpAmt);</span>

<span class="nc" id="L346">						retSaleCommRate = retailer_sale_comm_rate</span>
								+ retGameCommVariance;
<span class="nc" id="L348">						commAmt = mrpAmt * retSaleCommRate * 0.01;</span>
<span class="nc" id="L349">						agtAgentStmt.setDouble(6, commAmt);</span>

<span class="nc" id="L351">						netAmt = mrpAmt - commAmt;</span>
<span class="nc" id="L352">						creditAmt += netAmt;</span>

						// added by yogesh to calculate vat amount
<span class="nc" id="L355">						System.out.println(&quot;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp;&amp; &quot; + govtCommRule);</span>
<span class="nc" id="L356">						vatAmt = CommonMethods.calculateVat(mrpAmt,</span>
								retSaleCommRate, prizepayoutRatio,
								govt_comm_rate, vat, govtCommRule, fixed_amt,
								tickets_in_scheme);
						// taxableSale=(((mrpAmt*(100-(retSaleCommRate +
						// prizepayoutRatio
						// +govt_comm_rate)))/100)*100)/(100+vat);
						// taxableSale=vatAmt/(gameBean.getVat() * 0.01);
<span class="nc" id="L364">						taxableSale = CommonMethods.calTaxableSale(mrpAmt,</span>
								retSaleCommRate, prizepayoutRatio,
								govt_comm_rate, vat);

<span class="nc" id="L368">						agtAgentStmt.setDouble(7, netAmt);</span>
<span class="nc" id="L369">						agtAgentStmt.setString(8, &quot;SALE&quot;);</span>
<span class="nc" id="L370">						agtAgentStmt.setInt(9, bookList.size());</span>
<span class="nc" id="L371">						agtAgentStmt.setDouble(10, vatAmt);</span>
<span class="nc" id="L372">						agtAgentStmt.setDouble(11, taxableSale);</span>
<span class="nc" id="L373">						agtAgentStmt.setInt(12, userOrgID);</span>
<span class="nc" id="L374">						agtAgentStmt.execute();</span>

<span class="nc" id="L376">						agtOrdGameStmt.setInt(1, bookList.size());</span>
<span class="nc" id="L377">						agtOrdGameStmt.setInt(2, orderId);</span>
<span class="nc" id="L378">						agtOrdGameStmt.setInt(3, gameId);</span>

<span class="nc" id="L380">						agtOrdGameStmt.execute();</span>

<span class="nc" id="L382">						int orderInvoiceDCId = 0;</span>
<span class="nc" id="L383">						orderInvoicesPrtSt.setInt(1, orderId);</span>
<span class="nc" id="L384">						orderInvoicesPrtSt.setInt(2, invoiceId);</span>
<span class="nc" id="L385">						orderInvoicesPrtSt.setInt(3, retOrgId);</span>
<span class="nc" id="L386">						orderInvoicesPrtSt.setInt(4, gameId);</span>
<span class="nc" id="L387">						orderInvoicesPrtSt.setString(5, &quot;AUTO_PROCESSED&quot;);</span>
<span class="nc" id="L388">						orderInvoicesPrtSt.setInt(6, bookList.size());</span>
<span class="nc" id="L389">						orderInvoicesPrtSt.setInt(7, agtId);</span>
<span class="nc" id="L390">						orderInvoicesPrtSt.setInt(8, userOrgID);</span>
<span class="nc" id="L391">						orderInvoicesPrtSt.setInt(9, DCId);</span>
<span class="nc" id="L392">						orderInvoicesPrtSt.executeUpdate();</span>
<span class="nc" id="L393">						rs = orderInvoicesPrtSt.getGeneratedKeys();</span>
<span class="nc bnc" id="L394" title="All 2 branches missed.">						while (rs.next()) {</span>
<span class="nc" id="L395">							orderInvoiceDCId = rs.getInt(1);</span>
						}

<span class="nc bnc" id="L398" title="All 2 branches missed.">						if (bookList != null) {</span>
<span class="nc" id="L399">							invQuery = gameInvStatusQuery + &quot; and book_nbr = ?&quot;;</span>
<span class="nc" id="L400">							gameInvStatusStmt = connection</span>
									.prepareStatement(invQuery);
<span class="nc" id="L402">							String bookNbr = null;</span>
<span class="nc" id="L403">							String packNbr = null;</span>
<span class="nc bnc" id="L404" title="All 2 branches missed.">							for (int j = 0; j &lt; bookList.size(); j++) {</span>
								// bookBean = bookList.get(j);

<span class="nc" id="L407">								bookNbr = bookList.get(j);</span>
<span class="nc" id="L408">								gameInvStatusStmt.setString(1, &quot;RETAILER&quot;);</span>
<span class="nc" id="L409">								gameInvStatusStmt.setInt(2, retOrgId);</span>
<span class="nc" id="L410">								gameInvStatusStmt.setString(3, newBookStatus);</span>
								// Added by arun on update status table
<span class="nc" id="L412">								gameInvStatusStmt.setInt(4, noOfTktPerBooks);</span>
<span class="nc bnc" id="L413" title="All 2 branches missed.">								if (&quot;ACTIVE&quot;.equalsIgnoreCase(newBookStatus</span>
										.trim())) {
<span class="nc" id="L415">									gameInvStatusStmt</span>
											.setInt(5, noOfTktPerBooks);
								} else {
<span class="nc" id="L418">									gameInvStatusStmt.setInt(5, 0);</span>
								}
<span class="nc" id="L420">								gameInvStatusStmt.setString(6, String.valueOf(DCId));</span>
<span class="nc" id="L421">								gameInvStatusStmt.setInt(7, gameId);</span>
<span class="nc" id="L422">								gameInvStatusStmt.setString(8, bookNbr);</span>
<span class="nc" id="L423">								gameInvStatusStmt.execute();</span>

<span class="nc" id="L425">								packNbr = getPackNbrForBook(connection, gameId,</span>
										bookNbr);
								
<span class="nc" id="L428">								warehouseId = com.skilrock.lms.scratchService.dataMgmt.daoImpl.ScratchGameDataDaoImpl.getSingleInstance().getWarehouseNbrForBook(connection, gameId, bookNbr);</span>

								// added by arun
<span class="nc" id="L431">								fetchPurRatePstmt.setString(1, bookNbr);</span>
<span class="nc" id="L432">								fetchPurRateRs = fetchPurRatePstmt</span>
										.executeQuery();

<span class="nc bnc" id="L435" title="All 2 branches missed.">								if (fetchPurRateRs.next()) {</span>
<span class="nc" id="L436">									purRate = fetchPurRateRs</span>
											.getDouble(&quot;transacrion_sale_comm_rate&quot;);

								}

<span class="nc" id="L441">								gameInvDetailStmt.setInt(1, masterTrnId);</span>
<span class="nc" id="L442">								gameInvDetailStmt.setInt(2, gameId);</span>
<span class="nc" id="L443">								gameInvDetailStmt.setString(3, packNbr);</span>
<span class="nc" id="L444">								gameInvDetailStmt.setString(4, bookNbr);</span>
<span class="nc" id="L445">								gameInvDetailStmt.setString(5, &quot;RETAILER&quot;);</span>
<span class="nc" id="L446">								gameInvDetailStmt.setInt(6, retOrgId);</span>
<span class="nc" id="L447">								gameInvDetailStmt.setTimestamp(7, currentDate);</span>
<span class="nc" id="L448">								gameInvDetailStmt.setString(8, &quot;AGENT&quot;);</span>
<span class="nc" id="L449">								gameInvDetailStmt.setString(9, newBookStatus);</span>
								//gameInvDetailStmt.setDouble(9, retSaleCommRate);
								//gameInvDetailStmt.setDouble(10, govt_comm_rate);
<span class="nc" id="L452">								gameInvDetailStmt.setInt(10, orderInvoiceDCId);</span>
<span class="nc" id="L453">								gameInvDetailStmt.setInt(11, warehouseId);</span>
<span class="nc" id="L454">								gameInvDetailStmt.execute();</span>

								// insert into detail history table Added by
								// arun
<span class="nc" id="L458">								detHistoryInsPstmt.setInt(1, gameId);</span>
<span class="nc" id="L459">								detHistoryInsPstmt.setString(2, bookNbr);</span>
<span class="nc" id="L460">								detHistoryInsPstmt.setString(3, &quot;RETAILER&quot;);</span>
<span class="nc" id="L461">								detHistoryInsPstmt.setInt(4, retOrgId);</span>
<span class="nc" id="L462">								detHistoryInsPstmt.setTimestamp(5, currentDate);</span>
<span class="nc" id="L463">								detHistoryInsPstmt.setInt(6, userOrgID);</span>
<span class="nc" id="L464">								detHistoryInsPstmt.setInt(7, agtId);</span>
<span class="nc" id="L465">								detHistoryInsPstmt.setInt(8, noOfTktPerBooks);</span>
<span class="nc bnc" id="L466" title="All 2 branches missed.">								if (&quot;ACTIVE&quot;.equalsIgnoreCase(newBookStatus</span>
										.trim())) {
<span class="nc" id="L468">									detHistoryInsPstmt.setInt(9,</span>
											noOfTktPerBooks);
								} else {
<span class="nc" id="L471">									detHistoryInsPstmt.setInt(9, 0);</span>
								}
<span class="nc" id="L473">								detHistoryInsPstmt.setInt(10, 0);</span>
<span class="nc" id="L474">								detHistoryInsPstmt.setString(11, newBookStatus);</span>
<span class="nc" id="L475">								detHistoryInsPstmt.execute();</span>
							}
						}
<span class="nc" id="L478">					}</span>

					else {

<span class="nc" id="L482">						mrpAmt = bookList.size() * bookPrice;</span>
<span class="nc" id="L483">						retSaleCommRate = retailer_sale_comm_rate</span>
								+ retGameCommVariance;
<span class="nc" id="L485">						commAmt = mrpAmt * retSaleCommRate * 0.01;</span>
<span class="nc" id="L486">						netAmt = mrpAmt - commAmt;</span>
<span class="nc" id="L487">						creditAmt += netAmt;</span>

						ResultSet rsCommVar;
<span class="nc" id="L490">						ArrayList&lt;BookSaleBean&gt; bookSaleBeanList = new ArrayList&lt;BookSaleBean&gt;();</span>
						BookSaleBean bookSaleBean;

<span class="nc" id="L493">						int orderInvoiceDCId = 0;</span>
<span class="nc" id="L494">						orderInvoicesPrtSt.setInt(1, orderId);</span>
<span class="nc" id="L495">						orderInvoicesPrtSt.setInt(2, invoiceId);</span>
<span class="nc" id="L496">						orderInvoicesPrtSt.setInt(3, retOrgId);</span>
<span class="nc" id="L497">						orderInvoicesPrtSt.setInt(4, gameId);</span>
<span class="nc" id="L498">						orderInvoicesPrtSt.setString(5, &quot;AUTO_PROCESSED&quot;);</span>
<span class="nc" id="L499">						orderInvoicesPrtSt.setInt(6, bookList.size());</span>
<span class="nc" id="L500">						orderInvoicesPrtSt.setInt(7, agtId);</span>
<span class="nc" id="L501">						orderInvoicesPrtSt.setInt(8, userOrgID);</span>
<span class="nc" id="L502">						orderInvoicesPrtSt.executeUpdate();</span>
<span class="nc" id="L503">						rs = orderInvoicesPrtSt.getGeneratedKeys();</span>
<span class="nc bnc" id="L504" title="All 2 branches missed.">						while (rs.next()) {</span>
<span class="nc" id="L505">							orderInvoiceDCId = rs.getInt(1);</span>
						}

<span class="nc bnc" id="L508" title="All 2 branches missed.">						for (int bookListSize = 0; bookListSize &lt; bookList</span>
<span class="nc" id="L509">								.size(); bookListSize++) {</span>
<span class="nc" id="L510">							bookSaleBean = new BookSaleBean();</span>
<span class="nc" id="L511">							double govtCommRate = 0.0;</span>
<span class="nc" id="L512">							double vatAmtForBook = 0.0;</span>
<span class="nc" id="L513">							double taxableSaleForbook = 0.0;</span>
							// bookBean=bookList.get(bookListSize);
							// String bookfromBookList=bookBean.getBookNumber();
<span class="nc" id="L516">							String govtCommVarianceQuery = &quot;select transaction_gov_comm_rate,transaction_date from st_se_game_inv_detail where current_owner=? and current_owner_id=? and game_id=? and book_nbr=? and transaction_at=? order by transaction_date desc limit 1 &quot;;</span>
<span class="nc" id="L517">							PreparedStatement govtCommVariaceStmt = connection</span>
									.prepareStatement(govtCommVarianceQuery);
<span class="nc" id="L519">							govtCommVariaceStmt.setString(1, &quot;AGENT&quot;);</span>
<span class="nc" id="L520">							govtCommVariaceStmt.setInt(2, userOrgID);</span>
<span class="nc" id="L521">							govtCommVariaceStmt.setInt(3, gameId);</span>
<span class="nc" id="L522">							govtCommVariaceStmt.setString(4, bookList</span>
									.get(bookListSize));
<span class="nc" id="L524">							govtCommVariaceStmt.setString(5, &quot;BO&quot;);</span>
<span class="nc" id="L525">							rsCommVar = govtCommVariaceStmt.executeQuery();</span>
<span class="nc bnc" id="L526" title="All 2 branches missed.">							while (rsCommVar.next()) {</span>
<span class="nc" id="L527">								govtCommRate = rsCommVar</span>
										.getDouble(&quot;transaction_gov_comm_rate&quot;);
							}

<span class="nc" id="L531">							vatAmtForBook = CommonMethods.calculateVat(</span>
									bookPrice, retSaleCommRate,
									prizepayoutRatio, govtCommRate, vat,
									govtCommRule, fixed_amt, tickets_in_scheme);
							// taxableSaleForbook=(((bookPrice*(100-(retSaleCommRate
							// + prizepayoutRatio
							// +govtCommRate)))/100)*100)/(100+vat);
							// taxableSaleForbook=vatAmtForBook/(gameBean.getVat()
							// * 0.01);
<span class="nc" id="L540">							taxableSaleForbook = CommonMethods.calTaxableSale(</span>
									bookPrice, retSaleCommRate,
									prizepayoutRatio, govtCommRate, vat);

<span class="nc" id="L544">							bookSaleBean.setBookNumber(bookList</span>
									.get(bookListSize));
<span class="nc" id="L546">							bookSaleBean.setBookTaxableSale(taxableSaleForbook);</span>
<span class="nc" id="L547">							bookSaleBean.setBookVatAmt(vatAmtForBook);</span>
<span class="nc" id="L548">							bookSaleBean.setTotalSaleGovtComm(govtCommRate);</span>
<span class="nc" id="L549">							bookSaleBeanList.add(bookSaleBean);</span>
						}

<span class="nc" id="L552">						Set&lt;Double&gt; GovtCommVarianceSet = new HashSet&lt;Double&gt;();</span>
<span class="nc" id="L553">						String queryGovtCommVarHistory = &quot;select DISTINCT govt_comm_rate from st_se_game_govt_comm_history where game_id=&quot;</span>
								+ gameId;
<span class="nc" id="L555">						PreparedStatement stmtGovtCommVarHistory = connection</span>
								.prepareStatement(queryGovtCommVarHistory);
<span class="nc" id="L557">						ResultSet rsGovtCommVarHistory = stmtGovtCommVarHistory</span>
								.executeQuery();
<span class="nc bnc" id="L559" title="All 2 branches missed.">						while (rsGovtCommVarHistory.next()) {</span>
<span class="nc" id="L560">							GovtCommVarianceSet.add(rsGovtCommVarHistory</span>
									.getDouble(&quot;govt_comm_rate&quot;));
						}

						Iterator govtCommSetItr;
						Iterator bookSaleBeanItr;
<span class="nc" id="L566">						govtCommSetItr = GovtCommVarianceSet.iterator();</span>

<span class="nc bnc" id="L568" title="All 2 branches missed.">						while (govtCommSetItr.hasNext()) {</span>
<span class="nc" id="L569">							boolean bookGovtCommVarMatch = false;</span>
<span class="nc" id="L570">							bookSaleBeanItr = bookSaleBeanList.iterator();</span>
<span class="nc" id="L571">							List bookListforSingleTrn = null;</span>
<span class="nc" id="L572">							bookListforSingleTrn = new ArrayList&lt;String&gt;();</span>

<span class="nc" id="L574">							double totVatAmt = 0.0;</span>
<span class="nc" id="L575">							double totTaxableSale = 0.0;</span>
<span class="nc" id="L576">							double totMrpAmt = 0.0;</span>
<span class="nc" id="L577">							double totalCommAmt = 0.0;</span>
<span class="nc" id="L578">							double totalNetAmt = 0.0;</span>

<span class="nc" id="L580">							Double govtCommFormSet = (Double) govtCommSetItr</span>
									.next();

<span class="nc bnc" id="L583" title="All 2 branches missed.">							while (bookSaleBeanItr.hasNext()) {</span>
<span class="nc" id="L584">								bookSaleBean = (BookSaleBean) bookSaleBeanItr</span>
										.next();
								// System.out.println(&quot;compare comm ::: &quot; +
								// bookSaleBean.getTotalSaleGovtComm() + &quot; :: &quot;
								// + govtCommFormSet);
<span class="nc bnc" id="L589" title="All 2 branches missed.">								if (bookSaleBean.getTotalSaleGovtComm() == govtCommFormSet) {</span>
<span class="nc" id="L590">									bookGovtCommVarMatch = true;</span>
<span class="nc" id="L591">									totVatAmt = totVatAmt</span>
											+ bookSaleBean.getBookVatAmt();
<span class="nc" id="L593">									totTaxableSale = totTaxableSale</span>
											+ bookSaleBean.getBookTaxableSale();
<span class="nc" id="L595">									totMrpAmt = totMrpAmt + bookPrice;</span>
<span class="nc" id="L596">									bookListforSingleTrn.add(bookSaleBean</span>
											.getBookNumber());
								}

							}

<span class="nc" id="L602">							totalCommAmt = totMrpAmt * retSaleCommRate * 0.01;</span>
<span class="nc" id="L603">							totalNetAmt = totMrpAmt - totalCommAmt;</span>
<span class="nc bnc" id="L604" title="All 2 branches missed.">							if (bookGovtCommVarMatch) {</span>
								// insert in LMS transaction master
<span class="nc" id="L606">								LMSMasterStmt.setString(1, &quot;AGENT&quot;);</span>
<span class="nc" id="L607">								LMSMasterStmt.executeUpdate();</span>

<span class="nc" id="L609">								rsMaster = null;</span>
<span class="nc" id="L610">								rsMaster = LMSMasterStmt.getGeneratedKeys();</span>

<span class="nc bnc" id="L612" title="All 2 branches missed.">								while (rsMaster.next()) {</span>
<span class="nc" id="L613">									masterTrnId = rsMaster.getInt(1);</span>
<span class="nc" id="L614">									trnIdList.add(masterTrnId);</span>
								}
								// insert in agent transaction master

<span class="nc" id="L618">								agtMasterStmt.setInt(1, masterTrnId);</span>
<span class="nc" id="L619">								agtMasterStmt.setInt(2, agtId);</span>
<span class="nc" id="L620">								agtMasterStmt.setInt(3, userOrgID);</span>
<span class="nc" id="L621">								agtMasterStmt.setString(4, &quot;RETAILER&quot;);</span>
<span class="nc" id="L622">								agtMasterStmt.setInt(5, retOrgId);</span>
<span class="nc" id="L623">								agtMasterStmt.setString(6, &quot;SALE&quot;);</span>
<span class="nc" id="L624">								agtMasterStmt.setTimestamp(7, currentDate);</span>
<span class="nc" id="L625">								agtMasterStmt.execute();</span>

<span class="nc" id="L627">								agtAgentStmt.setInt(1, masterTrnId);</span>
<span class="nc" id="L628">								agtAgentStmt.setInt(2, gameId);</span>
<span class="nc" id="L629">								agtAgentStmt.setInt(3, agtId);</span>
<span class="nc" id="L630">								agtAgentStmt.setInt(4, retOrgId);</span>

								// mrpAmt = currentlyDispatched *
								// gameBean.getBookPrice();
<span class="nc" id="L634">								agtAgentStmt.setDouble(5, totMrpAmt);</span>

								// retSaleCommRate=gameBean.getRetSaleCommRate()+gameBean.getRetGameCommVariance();
								// commAmt = mrpAmt * retSaleCommRate * 0.01 ;
<span class="nc" id="L638">								agtAgentStmt.setDouble(6, totalCommAmt);</span>
<span class="nc" id="L639">								agtAgentStmt.setDouble(7, totalNetAmt);</span>
<span class="nc" id="L640">								agtAgentStmt.setString(8, &quot;SALE&quot;);</span>
<span class="nc" id="L641">								agtAgentStmt.setInt(9, bookListforSingleTrn</span>
										.size());
<span class="nc" id="L643">								agtAgentStmt.setDouble(10, totVatAmt);</span>
<span class="nc" id="L644">								agtAgentStmt.setDouble(11, totTaxableSale);</span>
<span class="nc" id="L645">								agtAgentStmt.setInt(12, userOrgID);</span>
<span class="nc" id="L646">								agtAgentStmt.execute();</span>

<span class="nc bnc" id="L648" title="All 2 branches missed.">								for (int j = 0; j &lt; bookListforSingleTrn.size(); j++) {</span>
<span class="nc" id="L649">									String bknbr = (String) bookListforSingleTrn</span>
											.get(j);
<span class="nc" id="L651">									String pkNbr = getPackNbrForBook(</span>
											connection, gameId, bknbr);
									
<span class="nc" id="L654">									warehouseId = com.skilrock.lms.scratchService.dataMgmt.daoImpl.ScratchGameDataDaoImpl.getSingleInstance().getWarehouseNbrForBook(connection, gameId, bknbr);</span>

									// added by arun
<span class="nc" id="L657">									fetchPurRatePstmt.setString(1, bknbr);</span>
<span class="nc" id="L658">									fetchPurRateRs = fetchPurRatePstmt</span>
											.executeQuery();

<span class="nc bnc" id="L661" title="All 2 branches missed.">									if (fetchPurRateRs.next()) {</span>
<span class="nc" id="L662">										purRate = fetchPurRateRs</span>
												.getDouble(&quot;transacrion_sale_comm_rate&quot;);
									}

<span class="nc" id="L666">									gameInvDetailStmt.setInt(1, masterTrnId);</span>
<span class="nc" id="L667">									gameInvDetailStmt.setInt(2, gameId);</span>
<span class="nc" id="L668">									gameInvDetailStmt.setString(3, pkNbr);</span>
<span class="nc" id="L669">									gameInvDetailStmt.setString(4, bknbr);</span>
<span class="nc" id="L670">									gameInvDetailStmt.setString(5, &quot;RETAILER&quot;);</span>
<span class="nc" id="L671">									gameInvDetailStmt.setInt(6, retOrgId);</span>
<span class="nc" id="L672">									gameInvDetailStmt.setTimestamp(7, currentDate);</span>
<span class="nc" id="L673">									gameInvDetailStmt.setString(8, &quot;AGENT&quot;);</span>
<span class="nc" id="L674">									gameInvDetailStmt.setString(9, newBookStatus);</span>
									//gameInvDetailStmt.setDouble(9, retSaleCommRate);
									//gameInvDetailStmt.setDouble(10, govtCommFormSet);
<span class="nc" id="L677">									gameInvDetailStmt.setInt(10, orderInvoiceDCId);</span>
<span class="nc" id="L678">									gameInvDetailStmt.setInt(11, warehouseId);</span>
									//gameInvDetailStmt.setObject(11, purRate);
<span class="nc" id="L680">									gameInvDetailStmt.execute();</span>

									// insert into detail history table Added by
									// arun
<span class="nc" id="L684">									detHistoryInsPstmt.setInt(1, gameId);</span>
<span class="nc" id="L685">									detHistoryInsPstmt.setString(2, bknbr);</span>
<span class="nc" id="L686">									detHistoryInsPstmt.setString(3, &quot;RETAILER&quot;);</span>
<span class="nc" id="L687">									detHistoryInsPstmt.setInt(4, retOrgId);</span>
<span class="nc" id="L688">									detHistoryInsPstmt.setTimestamp(5,</span>
											currentDate);
<span class="nc" id="L690">									detHistoryInsPstmt.setInt(6, userOrgID);</span>
<span class="nc" id="L691">									detHistoryInsPstmt.setInt(7, agtId);</span>
<span class="nc" id="L692">									detHistoryInsPstmt.setInt(8,</span>
											noOfTktPerBooks);
<span class="nc bnc" id="L694" title="All 2 branches missed.">									if (&quot;ACTIVE&quot;.equalsIgnoreCase(newBookStatus</span>
											.trim())) {
<span class="nc" id="L696">										detHistoryInsPstmt.setInt(9,</span>
												noOfTktPerBooks);
									} else {
<span class="nc" id="L699">										detHistoryInsPstmt.setInt(9, 0);</span>
									}
<span class="nc" id="L701">									detHistoryInsPstmt.setInt(10, 0);</span>
<span class="nc" id="L702">									detHistoryInsPstmt.setString(11,</span>
											newBookStatus);
<span class="nc" id="L704">									detHistoryInsPstmt.execute();</span>

								}
							}
<span class="nc" id="L708">						}</span>

<span class="nc" id="L710">						agtOrdGameStmt.setInt(1, bookList.size());</span>
<span class="nc" id="L711">						agtOrdGameStmt.setInt(2, orderId);</span>
<span class="nc" id="L712">						agtOrdGameStmt.setInt(3, gameId);</span>
<span class="nc" id="L713">						agtOrdGameStmt.execute();</span>

<span class="nc bnc" id="L715" title="All 2 branches missed.">						if (bookList != null) {</span>
<span class="nc" id="L716">							invQuery = gameInvStatusQuery + &quot; and book_nbr = ?&quot;;</span>
<span class="nc" id="L717">							gameInvStatusStmt = connection</span>
									.prepareStatement(invQuery);
<span class="nc" id="L719">							String bookNbr = null;</span>
<span class="nc" id="L720">							String packNbr = null;</span>
<span class="nc bnc" id="L721" title="All 2 branches missed.">							for (int j = 0; j &lt; bookList.size(); j++) {</span>

<span class="nc" id="L723">								gameInvStatusStmt.setString(1, &quot;RETAILER&quot;);</span>
<span class="nc" id="L724">								gameInvStatusStmt.setInt(2, retOrgId);</span>
<span class="nc" id="L725">								gameInvStatusStmt.setString(3, newBookStatus);</span>

								// Added by arun on update status table
<span class="nc" id="L728">								gameInvStatusStmt.setInt(4, noOfTktPerBooks);</span>
<span class="nc bnc" id="L729" title="All 2 branches missed.">								if (&quot;ACTIVE&quot;.equalsIgnoreCase(newBookStatus</span>
										.trim())) {
<span class="nc" id="L731">									gameInvStatusStmt</span>
											.setInt(5, noOfTktPerBooks);
								} else {
<span class="nc" id="L734">									gameInvStatusStmt.setInt(5, 0);</span>
								}
<span class="nc" id="L736">								gameInvStatusStmt.setString(6, String.valueOf(DCId));</span>
<span class="nc" id="L737">								gameInvStatusStmt.setInt(7, gameId);</span>
<span class="nc" id="L738">								gameInvStatusStmt.setString(8, bookList.get(j));</span>
<span class="nc" id="L739">								gameInvStatusStmt.execute();</span>

							}
						}
					}
<span class="nc" id="L744">				}</span>
<span class="nc" id="L745">				agtOrderStmt.setString(1, &quot;AUTO_PROCESSED&quot;);</span>
<span class="nc" id="L746">				agtOrderStmt.setInt(2, orderId);</span>
<span class="nc" id="L747">				agtOrderStmt.executeUpdate();</span>

<span class="nc" id="L749">				agtReceiptNoGenStmt = connection.prepareStatement(QueryManager</span>
						.getAGENTLatestReceiptNb());
<span class="nc" id="L751">				agtReceiptNoGenStmt.setString(1, &quot;INVOICE&quot;);</span>
<span class="nc" id="L752">				agtReceiptNoGenStmt.setInt(2, userOrgID);</span>
<span class="nc" id="L753">				ResultSet recieptRs = agtReceiptNoGenStmt.executeQuery();</span>
<span class="nc" id="L754">				String lastRecieptNoGenerated = null;</span>
<span class="nc bnc" id="L755" title="All 2 branches missed.">				while (recieptRs.next()) {</span>
<span class="nc" id="L756">					lastRecieptNoGenerated = recieptRs</span>
							.getString(&quot;generated_id&quot;);
				}

<span class="nc" id="L760">				String autoGeneRecieptNo = null;</span>
<span class="nc" id="L761">				autoGeneRecieptNo = GenerateRecieptNo.getRecieptNoAgt(</span>
						&quot;INVOICE&quot;, lastRecieptNoGenerated, &quot;AGENT&quot;, userOrgID);

<span class="nc" id="L764">				agtReceiptNoGenStmt = connection.prepareStatement(QueryManager</span>
						.getAGENTLatestReceiptNb());
<span class="nc" id="L766">				agtReceiptNoGenStmt.setString(1, &quot;DLCHALLAN&quot;);</span>
<span class="nc" id="L767">				agtReceiptNoGenStmt.setInt(2, userOrgID);</span>
<span class="nc" id="L768">				ResultSet DCRs = agtReceiptNoGenStmt.executeQuery();</span>
<span class="nc" id="L769">				String lastDCNoGenerated = null;</span>

<span class="nc bnc" id="L771" title="All 2 branches missed.">				while (DCRs.next()) {</span>
<span class="nc" id="L772">					lastDCNoGenerated = DCRs.getString(&quot;generated_id&quot;);</span>
				}

<span class="nc" id="L775">				String autoGeneDCNo = null;</span>
<span class="nc" id="L776">				autoGeneDCNo = GenerateRecieptNo.getRecieptNoAgt(&quot;DLCHALLAN&quot;,</span>
						lastDCNoGenerated, &quot;AGENT&quot;, userOrgID);

				// insert into agent receipt table

<span class="nc" id="L781">				agtReceiptStmt = connection.prepareStatement(QueryManager</span>
						.insertInAgentReceipts());
<span class="nc" id="L783">				agtReceiptStmt.setInt(1, invoiceId);</span>
<span class="nc" id="L784">				agtReceiptStmt.setString(2, &quot;INVOICE&quot;);</span>
<span class="nc" id="L785">				agtReceiptStmt.setInt(3, userOrgID);</span>
<span class="nc" id="L786">				agtReceiptStmt.setInt(4, retOrgId);</span>
<span class="nc" id="L787">				agtReceiptStmt.setString(5, &quot;RETAILER&quot;);</span>
<span class="nc" id="L788">				agtReceiptStmt.setString(6, autoGeneRecieptNo);</span>
<span class="nc" id="L789">				agtReceiptStmt.setTimestamp(7, Util.getCurrentTimeStamp());</span>
<span class="nc" id="L790">				agtReceiptStmt.execute();</span>

				// insert into agent receipt table for dl challan
<span class="nc" id="L793">				agtReceiptStmt = connection.prepareStatement(QueryManager</span>
						.insertInAgentReceipts());
<span class="nc" id="L795">				agtReceiptStmt.setInt(1, DCId);</span>
<span class="nc" id="L796">				agtReceiptStmt.setString(2, &quot;DLCHALLAN&quot;);</span>
<span class="nc" id="L797">				agtReceiptStmt.setInt(3, userOrgID);</span>
<span class="nc" id="L798">				agtReceiptStmt.setInt(4, retOrgId);</span>
<span class="nc" id="L799">				agtReceiptStmt.setString(5, &quot;RETAILER&quot;);</span>
<span class="nc" id="L800">				agtReceiptStmt.setString(6, autoGeneDCNo);</span>
<span class="nc" id="L801">				agtReceiptStmt.setTimestamp(7, Util.getCurrentTimeStamp());</span>
<span class="nc" id="L802">				agtReceiptStmt.execute();</span>

<span class="nc bnc" id="L804" title="All 2 branches missed.">				for (int i = 0; i &lt; trnIdList.size(); i++) {</span>
<span class="nc" id="L805">					agtReceiptMappingStmt.setInt(1, invoiceId);</span>
<span class="nc" id="L806">					agtReceiptMappingStmt.setInt(2, trnIdList.get(i));</span>
<span class="nc" id="L807">					agtReceiptMappingStmt.execute();</span>

				}

<span class="nc bnc" id="L811" title="All 2 branches missed.">				for (int i = 0; i &lt; trnIdList.size(); i++) {</span>
<span class="nc" id="L812">					agtReceiptMappingStmt.setInt(1, DCId);</span>
<span class="nc" id="L813">					agtReceiptMappingStmt.setInt(2, trnIdList.get(i));</span>
<span class="nc" id="L814">					agtReceiptMappingStmt.execute();</span>

				}

				// insert into invoice and delivery challan mapping table
<span class="nc" id="L819">				String insertInvoiceDCMapping = &quot;insert into st_se_agent_invoice_delchallan_mapping(id,generated_invoice_id,generated_del_challan_id) values(?,?,?)&quot;;</span>
<span class="nc" id="L820">				agtInvoiceDCMappingStmt = connection</span>
						.prepareStatement(insertInvoiceDCMapping);
<span class="nc" id="L822">				agtInvoiceDCMappingStmt.setInt(1, invoiceId);</span>
<span class="nc" id="L823">				agtInvoiceDCMappingStmt.setString(2, autoGeneRecieptNo);</span>
<span class="nc" id="L824">				agtInvoiceDCMappingStmt.setString(3, autoGeneDCNo);</span>
<span class="nc" id="L825">				agtInvoiceDCMappingStmt.executeUpdate();</span>

				// for org credit updation
<span class="nc" id="L828">				System.out.println(&quot;Org Id For Credit Update:&quot; + retOrgId + &quot;:&quot;</span>
						+ creditAmt);
				
<span class="nc" id="L831">				boolean isValid=OrgCreditUpdation.updateOrganizationBalWithValidate(creditAmt, &quot;TRANSACTION&quot;, &quot;SALE&quot;, retOrgId,</span>
						userOrgID, &quot;RETAILER&quot;, 0, connection);
				
<span class="nc bnc" id="L834" title="All 2 branches missed.">				if(!isValid)</span>
<span class="nc" id="L835">					throw new LMSException();</span>
				
				/*OrgCreditUpdation.updateCreditLimitForRetailer(retOrgId,
						&quot;SALE&quot;, creditAmt, connection);*/

//				connection.commit();
				// session.setAttribute(&quot;DEL_CHALLAN_ID&quot;, DCId);
//				if (invoiceId &gt; -1) {
//					GraphReportHelper graphReportHelper = new GraphReportHelper();
//					graphReportHelper.createTextReportAgent(invoiceId,
//							rootPath, userOrgID, loggedInUserOrgName);
//				}
				// return DCId;
<span class="nc" id="L848">			} catch (SQLException se) {</span>
				try {
<span class="nc" id="L850">					connection.rollback();</span>

<span class="nc" id="L852">				} catch (SQLException e) {</span>
<span class="nc" id="L853">					e.printStackTrace();</span>
<span class="nc" id="L854">					throw new LMSException(&quot;Error During Rollback&quot;, e);</span>
<span class="nc" id="L855">				}</span>
<span class="nc" id="L856">				se.printStackTrace();</span>
<span class="nc" id="L857">				throw new LMSException(se);</span>
<span class="nc" id="L858">			}</span>

		}
<span class="nc" id="L861">		return String.valueOf(DCId) + &quot;Nxt&quot; + String.valueOf(invoiceId);</span>
	}

	public int dispatchOrderDirectSale(Map&lt;Integer, List&lt;String&gt;&gt; gameBookMap,
			int agtId, int userOrgID, int retailerName, String rootPath,
			String loggedInUserOrgName, String newBookStatus)
			throws LMSException {
<span class="nc" id="L868">		Connection connection = null;</span>
<span class="nc" id="L869">		String returnValue = null;</span>

<span class="nc" id="L871">		int DCId = -1;</span>
<span class="nc" id="L872">		int invoiceId = -1;</span>
<span class="nc bnc" id="L873" title="All 2 branches missed.">		if (gameBookMap != null) {</span>
			try {
<span class="nc" id="L875">				connection = DBConnect.getConnection();</span>
<span class="nc" id="L876">				connection.setAutoCommit(false);</span>
				
<span class="nc" id="L878">				returnValue = dispatchOrderDirectSale(gameBookMap,</span>
						agtId, userOrgID, retailerName, rootPath,
						loggedInUserOrgName, newBookStatus, connection);

<span class="nc" id="L882">				connection.commit();</span>
				
<span class="nc" id="L884">				DCId = Integer.parseInt(returnValue.split(&quot;Nxt&quot;)[0]);</span>
<span class="nc" id="L885">				invoiceId = Integer.parseInt(returnValue.split(&quot;Nxt&quot;)[1]);</span>
<span class="nc bnc" id="L886" title="All 2 branches missed.">				if (invoiceId &gt; -1) {</span>
<span class="nc" id="L887">					GraphReportHelper graphReportHelper = new GraphReportHelper();</span>
<span class="nc" id="L888">					graphReportHelper.createTextReportAgent(invoiceId,</span>
							rootPath, userOrgID, loggedInUserOrgName);
				}
<span class="nc" id="L891">			} catch (SQLException se) {</span>
				try {
<span class="nc" id="L893">					connection.rollback();</span>

<span class="nc" id="L895">				} catch (SQLException e) {</span>
<span class="nc" id="L896">					e.printStackTrace();</span>
<span class="nc" id="L897">					throw new LMSException(&quot;Error During Rollback&quot;, e);</span>
<span class="nc" id="L898">				}</span>
<span class="nc" id="L899">				se.printStackTrace();</span>
<span class="nc" id="L900">				throw new LMSException(se);</span>
			} finally {
<span class="nc" id="L902">				try {</span>
<span class="nc bnc" id="L903" title="All 4 branches missed.">					if (connection != null) {</span>
<span class="nc" id="L904">						connection.close();</span>
					}
<span class="nc" id="L906">				} catch (SQLException se) {</span>
<span class="nc" id="L907">					se.printStackTrace();</span>
<span class="nc" id="L908">					throw new LMSException(se);</span>
<span class="nc" id="L909">				}</span>
			}
		}
<span class="nc" id="L912">		return DCId;</span>
	}

	public List&lt;String&gt; getGames() throws LMSException {
<span class="nc" id="L916">		List&lt;String&gt; gameList = new ArrayList&lt;String&gt;();</span>
		 
<span class="nc" id="L918">		Connection con = null;</span>
<span class="nc" id="L919">		Statement stmt = null;</span>
		try {
<span class="nc" id="L921">			con = DBConnect.getConnection();</span>
<span class="nc" id="L922">			stmt = con.createStatement();</span>

<span class="nc" id="L924">			ResultSet rsGame = stmt</span>
					.executeQuery(&quot;select game_name,game_nbr from st_se_game_master where game_status='OPEN'&quot;);
<span class="nc bnc" id="L926" title="All 2 branches missed.">			while (rsGame.next()) {</span>
<span class="nc" id="L927">				gameList.add(rsGame.getString(&quot;game_name&quot;) + &quot;-&quot;</span>
						+ rsGame.getString(&quot;game_nbr&quot;));
			}
<span class="nc" id="L930">			return gameList;</span>
<span class="nc" id="L931">		} catch (SQLException e) {</span>
<span class="nc" id="L932">			e.printStackTrace();</span>
<span class="nc" id="L933">			throw new LMSException(&quot;sql exception&quot;, e);</span>
		}
	}

	public String getPackNbrForBook(Connection connection, int gameId,
			String bookNbr) throws SQLException {

<span class="nc" id="L940">		String bookQuery = null;</span>
<span class="nc" id="L941">		PreparedStatement bookStmt = null;</span>
<span class="nc" id="L942">		String packNbr = null;</span>

<span class="nc" id="L944">		bookQuery = QueryManager.getST1PackForBook();</span>
<span class="nc" id="L945">		bookStmt = connection.prepareStatement(bookQuery);</span>

<span class="nc" id="L947">		bookStmt.setInt(1, gameId);</span>
<span class="nc" id="L948">		bookStmt.setString(2, bookNbr);</span>

<span class="nc" id="L950">		ResultSet rs = bookStmt.executeQuery();</span>
<span class="nc bnc" id="L951" title="All 2 branches missed.">		while (rs.next()) {</span>
<span class="nc" id="L952">			packNbr = rs.getString(TableConstants.SGIS_PACK_NBR);</span>
		}
<span class="nc" id="L954">		return packNbr;</span>

	}

	public List&lt;String&gt; getRetailers(int parent_id) throws LMSException {
<span class="nc" id="L959">		List&lt;String&gt; retailerList = new ArrayList&lt;String&gt;();</span>
		 
<span class="nc" id="L961">		Connection con = null;</span>
<span class="nc" id="L962">		Statement stmt = null;</span>
		try {
<span class="nc" id="L964">			con = DBConnect.getConnection();</span>
<span class="nc" id="L965">			stmt = con.createStatement();</span>
<span class="nc" id="L966">			ResultSet rsRet = stmt</span>
					.executeQuery(&quot;select name from st_lms_organization_master where organization_type='RETAILER' and parent_id=&quot;
							+ parent_id);
			// ResultSet rsGame=stmt.executeQuery(&quot;select game_name from
			// st_se_game_master where game_status='OPEN'&quot;);
<span class="nc bnc" id="L971" title="All 2 branches missed.">			while (rsRet.next()) {</span>
<span class="nc" id="L972">				retailerList.add(rsRet.getString(&quot;name&quot;));</span>
			}
<span class="nc" id="L974">			return retailerList;</span>
<span class="nc" id="L975">		} catch (SQLException e) {</span>
<span class="nc" id="L976">			e.printStackTrace();</span>
<span class="nc" id="L977">			throw new LMSException(&quot;sql exception&quot;, e);</span>
		}
	}

	public boolean getSalePrice(Map&lt;Integer, List&lt;String&gt;&gt; dispatchMap,
			int organizationId) throws LMSException {

		// boolean isDispatch=false;
		 
<span class="nc" id="L986">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L987">		Statement stmt = null;</span>
<span class="nc" id="L988">		Statement stmt1 = null;</span>
<span class="nc" id="L989">		ResultSet rs = null;</span>
<span class="nc" id="L990">		ResultSet rs1 = null;</span>
<span class="nc" id="L991">		double totalGamebooksAmount = 0.0;</span>
		try {

<span class="nc" id="L994">			stmt = con.createStatement();</span>
<span class="nc" id="L995">			rs = stmt</span>
					.executeQuery(&quot;select organization_id,available_credit from st_lms_organization_master where organization_id=&quot;
							+ organizationId);
<span class="nc" id="L998">			double availableCredit = 0.0;</span>
<span class="nc bnc" id="L999" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L1000">				availableCredit = rs.getDouble(&quot;available_credit&quot;);</span>
			}

<span class="nc" id="L1003">			Set&lt;Integer&gt; keyset = dispatchMap.keySet();</span>
<span class="nc bnc" id="L1004" title="All 2 branches missed.">			for (Integer gameNbr : keyset) {</span>
<span class="nc" id="L1005">				int nbrOfbooks = dispatchMap.get(gameNbr).size();</span>
<span class="nc" id="L1006">				stmt = con.createStatement();</span>
<span class="nc" id="L1007">				stmt1 = con.createStatement();</span>
<span class="nc" id="L1008">				rs1 = stmt1</span>
						.executeQuery(&quot;select sale_comm_variance from st_se_agent_retailer_sale_pwt_comm_variance where game_id=(select game_id from st_se_game_master where game_nbr=&quot;
								+ gameNbr + &quot;) and retailer_org_id=&quot; + organizationId);
<span class="nc" id="L1011">				double sale_comm_variance = 0.0;</span>
<span class="nc bnc" id="L1012" title="All 2 branches missed.">				while (rs1.next()) {</span>
<span class="nc" id="L1013">					sale_comm_variance = rs1.getDouble(&quot;sale_comm_variance&quot;);</span>
				}
<span class="nc" id="L1015">				rs = stmt</span>
						.executeQuery(&quot;select ticket_price,nbr_of_tickets_per_book,retailer_sale_comm_rate from st_se_game_master  where game_id=(select game_id from st_se_game_master where game_nbr=&quot;
								+ gameNbr + &quot;)&quot;);
				// System.out.println(&quot;11111111112222222222 &quot; + &quot;select
				// aa.sale_comm_variance,bb.pwt_scrap,cc.ticket_price,cc.nbr_of_tickets_per_book,cc.retailer_sale_comm_rate
				// from st_se_agent_retailer_sale_pwt_comm_variance
				// aa,st_lms_organization_master bb ,st_se_game_master cc where
				// aa.game_id=(select game_id from st_se_game_master where
				// game_nbr=&quot;+gameNbr+&quot;) and aa.ret_org_id=(select
				// organization_id from st_lms_organization_master where
				// name='&quot;+organizationName+&quot;') and bb.organization_id=(select
				// organization_id from st_lms_organization_master where
				// name='&quot;+organizationName+&quot;') and cc.game_id=(select game_id
				// from st_se_game_master where game_nbr=&quot;+gameNbr+&quot;)&quot;);
<span class="nc bnc" id="L1029" title="All 2 branches missed.">				if (rs.next()) {</span>
<span class="nc" id="L1030">					double netCommRate = rs</span>
							.getDouble(&quot;retailer_sale_comm_rate&quot;)
							+ sale_comm_variance;
<span class="nc" id="L1033">					double bookPrice = rs.getDouble(&quot;ticket_price&quot;)</span>
							* rs.getInt(&quot;nbr_of_tickets_per_book&quot;);
<span class="nc" id="L1035">					double netSaleAmountAllBooks = (bookPrice - bookPrice</span>
							* 0.01 * netCommRate)
							* nbrOfbooks;
<span class="nc" id="L1038">					totalGamebooksAmount = totalGamebooksAmount</span>
							+ netSaleAmountAllBooks;
				}

<span class="nc" id="L1042">			}</span>

<span class="nc bnc" id="L1044" title="All 2 branches missed.">			if (totalGamebooksAmount &lt;= availableCredit) {</span>
<span class="nc" id="L1045">				return true;</span>
			} else {
<span class="nc" id="L1047">				return false;</span>
			}

<span class="nc" id="L1050">		} catch (SQLException e) {</span>
<span class="nc" id="L1051">			e.printStackTrace();</span>
<span class="nc" id="L1052">			throw new LMSException(e);</span>
		} finally {
<span class="nc" id="L1054">			try {</span>
<span class="nc bnc" id="L1055" title="All 6 branches missed.">				if (con != null) {</span>
<span class="nc" id="L1056">					con.close();</span>
				}
<span class="nc" id="L1058">			} catch (SQLException se) {</span>
<span class="nc" id="L1059">				se.printStackTrace();</span>
<span class="nc" id="L1060">				throw new LMSException(se);</span>
<span class="nc" id="L1061">			}</span>
		}
	}

	public boolean verifyBook(int agtOrgId, String bookToVerify, int gameId,
			int gameNbr, Connection connection) throws LMSException {

		// System.out.println(&quot;Agent Org Id::&quot; + agtOrgId);
<span class="nc" id="L1069">		boolean isValid = false;</span>
<span class="nc" id="L1070">		boolean ownercheck = false;</span>
<span class="nc" id="L1071">		boolean pwtCheck = false;</span>
<span class="nc" id="L1072">		boolean pwtCheckTemp = false;</span>

		try {
<span class="nc" id="L1075">			PreparedStatement pstmt = null;</span>
<span class="nc" id="L1076">			ResultSet resultSet = null;</span>
<span class="nc" id="L1077">			String query = null;</span>
			// get the game id from game number
<span class="nc" id="L1079">			query = QueryManager.getST1AgentVerifyQuery()</span>
					+ &quot;  and (book_status!='MISSING' and book_status!='CLAIMED')&quot;;
<span class="nc" id="L1081">			pstmt = connection.prepareStatement(query);</span>

<span class="nc" id="L1083">			pstmt.setInt(1, gameId);</span>
<span class="nc" id="L1084">			pstmt.setString(2, bookToVerify);</span>

<span class="nc" id="L1086">			resultSet = pstmt.executeQuery();</span>

<span class="nc" id="L1088">			String currOwner = null;</span>
<span class="nc" id="L1089">			int currOwnerId = -1;</span>
<span class="nc bnc" id="L1090" title="All 2 branches missed.">			while (resultSet.next()) {</span>
<span class="nc" id="L1091">				currOwner = resultSet.getString(TableConstants.SGIS_CURR_OWNER);</span>
<span class="nc" id="L1092">				currOwnerId = resultSet</span>
						.getInt(TableConstants.SGIS_CURR_OWNER_ID);
<span class="nc bnc" id="L1094" title="All 6 branches missed.">				if (currOwner != null &amp;&amp; currOwner.equals(&quot;AGENT&quot;)</span>
						&amp;&amp; currOwnerId == agtOrgId) {
<span class="nc" id="L1096">					ownercheck = true;</span>
				}
			}

			// ckeck for ticket of this book in main ticket table
<span class="nc" id="L1101">			pwtCheck = verifyBookValidityWithPWT(gameId, bookToVerify,</span>
					connection, gameNbr);
<span class="nc" id="L1103">			pwtCheckTemp = verifyBookValidityWithPWTTempTable(gameId,</span>
					bookToVerify, connection);
<span class="nc bnc" id="L1105" title="All 6 branches missed.">			if (ownercheck == true &amp;&amp; pwtCheck == true &amp;&amp; pwtCheckTemp == true) {</span>
<span class="nc" id="L1106">				isValid = true;</span>
<span class="nc" id="L1107">				System.out.println(isValid + &quot;********&quot; + bookToVerify);</span>
			}

<span class="nc" id="L1110">		} catch (SQLException e) {</span>

<span class="nc" id="L1112">			e.printStackTrace();</span>
<span class="nc" id="L1113">			throw new LMSException(e);</span>
<span class="nc" id="L1114">		}</span>

<span class="nc" id="L1116">		return isValid;</span>
	}

	// direct dispatch new

	private boolean verifyBooks(int gameId, String books,
			List&lt;BookBean&gt; bookList, int agtOrgId, Connection connection)
			throws LMSException {

		// Connection connection = null;
<span class="nc" id="L1126">		Statement statement = null;</span>
<span class="nc" id="L1127">		ResultSet resultSet = null;</span>
<span class="nc" id="L1128">		boolean isBookValid = true;</span>
		try {
<span class="nc" id="L1130">			statement = connection.createStatement();</span>
<span class="nc" id="L1131">			String query = QueryManager.getST1AgentBookInvVerifyQuery();</span>
<span class="nc" id="L1132">			query = query + gameId + &quot; and book_nbr in ( &quot; + books + &quot; )&quot;;</span>

<span class="nc" id="L1134">			resultSet = statement.executeQuery(query);</span>

<span class="nc" id="L1136">			String currOwner = null;</span>
<span class="nc" id="L1137">			String bookNbr = null;</span>
<span class="nc" id="L1138">			BookBean bean = null;</span>
<span class="nc" id="L1139">			int currOwnerId = -1;</span>
<span class="nc bnc" id="L1140" title="All 2 branches missed.">			while (resultSet.next()) {</span>
<span class="nc" id="L1141">				currOwner = resultSet.getString(TableConstants.SGIS_CURR_OWNER);</span>
<span class="nc" id="L1142">				currOwnerId = resultSet</span>
						.getInt(TableConstants.SGIS_CURR_OWNER_ID);
<span class="nc" id="L1144">				bookNbr = resultSet.getString(TableConstants.SGIS_BOOK_NBR);</span>

<span class="nc bnc" id="L1146" title="All 2 branches missed.">				for (int i = 0; i &lt; bookList.size(); i++) {</span>
<span class="nc" id="L1147">					bean = bookList.get(i);</span>
<span class="nc bnc" id="L1148" title="All 2 branches missed.">					if (bookNbr.equals(bean.getBookNumber())) {</span>

<span class="nc bnc" id="L1150" title="All 6 branches missed.">						if (currOwner != null &amp;&amp; currOwner.equals(&quot;AGENT&quot;)</span>
								&amp;&amp; currOwnerId == agtOrgId) {
<span class="nc" id="L1152">							bean.setValid(true);</span>
<span class="nc" id="L1153">							bean.setStatus(null);</span>
						} else {
<span class="nc" id="L1155">							isBookValid = false;</span>
<span class="nc" id="L1156">							bean.setValid(false);</span>
<span class="nc" id="L1157">							bean.setStatus(&quot;Wrong Book Number&quot;);</span>
						}
					}
					// isBookValid = isBookValid &amp;&amp; bean.getIsValid();
				}

			}

<span class="nc bnc" id="L1165" title="All 2 branches missed.">			for (int i = 0; i &lt; bookList.size(); i++) {</span>
<span class="nc" id="L1166">				bean = bookList.get(i);</span>
<span class="nc bnc" id="L1167" title="All 4 branches missed.">				isBookValid = isBookValid &amp;&amp; bean.getIsValid();</span>
			}

<span class="nc bnc" id="L1170" title="All 4 branches missed.">			if (resultSet != null &amp;&amp; !resultSet.previous()) {</span>
<span class="nc" id="L1171">				isBookValid = false;</span>
			}

<span class="nc" id="L1174">		} catch (SQLException e) {</span>

<span class="nc" id="L1176">			e.printStackTrace();</span>
<span class="nc" id="L1177">			throw new LMSException(e);</span>
		} finally {

<span class="nc" id="L1180">			try {</span>

<span class="nc bnc" id="L1182" title="All 4 branches missed.">				if (statement != null) {</span>
<span class="nc" id="L1183">					statement.close();</span>
				}
				/*
				 * if (connection != null) { connection.close(); }
				 */
<span class="nc" id="L1188">			} catch (SQLException se) {</span>
<span class="nc" id="L1189">				se.printStackTrace();</span>
<span class="nc" id="L1190">			}</span>
<span class="nc" id="L1191">		}</span>

<span class="nc" id="L1193">		System.out.println(&quot;isBookValid::&quot; + isBookValid);</span>
<span class="nc" id="L1194">		return isBookValid;</span>
	}

	// Check Book Verification For PWT Tickets in main ticket table.
	public boolean verifyBookValidityWithPWT(int game_id, String bknbr,
			Connection conn, int gameNbr) {
<span class="nc" id="L1200">		boolean bookPwtFlag = true;</span>
<span class="nc" id="L1201">		String query6 = QueryManager.getST4BookOfTicketsOfPwt();</span>
		PreparedStatement stmt6;
		try {
<span class="nc" id="L1204">			stmt6 = conn.prepareStatement(query6);</span>
<span class="nc" id="L1205">			stmt6.setInt(1, gameNbr);</span>
<span class="nc" id="L1206">			stmt6.setInt(2, game_id);</span>
<span class="nc" id="L1207">			stmt6.setString(3, bknbr);</span>
<span class="nc" id="L1208">			ResultSet rs = stmt6.executeQuery();</span>
<span class="nc bnc" id="L1209" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1210">				bookPwtFlag = false;</span>
			}
<span class="nc" id="L1212">			return bookPwtFlag;</span>
<span class="nc" id="L1213">		} catch (SQLException e) {</span>
			// TODO Auto-generated catch block
<span class="nc" id="L1215">			e.printStackTrace();</span>
		}
<span class="nc" id="L1217">		return bookPwtFlag;</span>
	}

	// Check Book Verification For PWT Tickets in temp ticket table.
	public boolean verifyBookValidityWithPWTTempTable(int game_id,
			String bknbr, Connection conn) {

<span class="nc" id="L1224">		boolean bookPwtFlag = true;</span>
<span class="nc" id="L1225">		String query6 = QueryManager.getST4BookOfTicketsOfPwtTmpTable();</span>
		PreparedStatement stmt6;
		try {
<span class="nc" id="L1228">			stmt6 = conn.prepareStatement(query6);</span>
<span class="nc" id="L1229">			stmt6.setInt(1, game_id);</span>
<span class="nc" id="L1230">			stmt6.setString(2, bknbr);</span>
<span class="nc" id="L1231">			ResultSet rs = stmt6.executeQuery();</span>
<span class="nc bnc" id="L1232" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1233">				bookPwtFlag = false;</span>
			}
<span class="nc" id="L1235">			return bookPwtFlag;</span>
<span class="nc" id="L1236">		} catch (SQLException e) {</span>
			// TODO Auto-generated catch block
<span class="nc" id="L1238">			e.printStackTrace();</span>
		}
<span class="nc" id="L1240">		return bookPwtFlag;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>