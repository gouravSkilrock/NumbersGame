<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BODispatchGameHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lms</a> &gt; <a href="index.source.html" class="el_package">com.skilrock.lms.coreEngine.scratchService.inventoryMgmt.common</a> &gt; <span class="el_source">BODispatchGameHelper.java</span></div><h1>BODispatchGameHelper.java</h1><pre class="source lang-java linenums">/*
 * ï¿½ copyright 2007, SkilRock Technologies, A division of Sugal &amp; Damani Lottery Agency Pvt. Ltd.
 * All Rights Reserved
 * The contents of this file are the property of Sugal &amp; Damani Lottery Agency Pvt. Ltd.
 * and are subject to a License agreement with Sugal &amp; Damani Lottery Agency Pvt. Ltd.; you may
 * not use this file except in compliance with that License.  You may obtain a
 * copy of that license from:
 * Legal Department
 * Sugal &amp; Damani Lottery Agency Pvt. Ltd.
 * 6/35,WEA, Karol Bagh,
 * New Delhi
 * India - 110005
 * This software is distributed under the License and is provided on an ï¿½AS ISï¿½
 * basis, without warranty of any kind, either express or implied, unless
 * otherwise provided in the License.  See the License for governing rights and
 * limitations under the License.
 */

package com.skilrock.lms.coreEngine.scratchService.inventoryMgmt.common;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.skilrock.lms.beans.BookBean;
import com.skilrock.lms.beans.DispatchOrderResponse;
import com.skilrock.lms.beans.OrderBean;
import com.skilrock.lms.beans.OrderedGameBean;
import com.skilrock.lms.beans.PackBean;
import com.skilrock.lms.common.db.DBConnect;
import com.skilrock.lms.common.db.QueryManager;
import com.skilrock.lms.common.db.TableConstants;
import com.skilrock.lms.common.exception.LMSException;
import com.skilrock.lms.common.utility.CommonMethods;
import com.skilrock.lms.web.drawGames.common.Util;

/**
 * This is a helper class providing methods for handling the order dispatch at
 * BO's end
 * 
 * @author Skilrock Technologies
 * 
 */
<span class="nc" id="L53">public class BODispatchGameHelper {</span>

	private boolean checkDuplicatePackBook(int gameId, List&lt;PackBean&gt; packList,
			List&lt;BookBean&gt; bookList, Connection connection) throws LMSException {
<span class="nc" id="L57">		boolean isValid = true;</span>
<span class="nc" id="L58">		String packs = null;</span>
<span class="nc bnc" id="L59" title="All 2 branches missed.">		if (packList != null) {</span>
<span class="nc" id="L60">			packs = getPacks(packList);</span>
<span class="nc bnc" id="L61" title="All 2 branches missed.">			if (packs != null) {</span>
<span class="nc" id="L62">				isValid = verifyPackBook(gameId, packs, bookList, connection);</span>

			}
		}

<span class="nc" id="L67">		System.out.println(&quot;---Duplicate Pack Book::&quot; + isValid);</span>
<span class="nc" id="L68">		return isValid;</span>
	}

	private String getBooks(List&lt;BookBean&gt; bookList) {
<span class="nc" id="L72">		BookBean bookBean = null;</span>
<span class="nc" id="L73">		StringBuffer books = new StringBuffer();</span>

<span class="nc bnc" id="L75" title="All 2 branches missed.">		if (bookList != null) {</span>

			// int size = bookList.size();
<span class="nc bnc" id="L78" title="All 2 branches missed.">			for (int i = 0; i &lt; bookList.size(); i++) {</span>
				// System.out.println(&quot;Loop Itr:&quot; + i);
<span class="nc" id="L80">				bookBean = bookList.get(i);</span>
<span class="nc" id="L81">				String bookNbr = bookBean.getBookNumber();</span>
				// System.out.println(&quot;BookNbr:&quot; + bookNbr);
<span class="nc bnc" id="L83" title="All 6 branches missed.">				if (bookNbr == null || bookNbr != null</span>
						&amp;&amp; bookNbr.trim().equals(&quot;&quot;)) {
<span class="nc" id="L85">					bookList.remove(i);</span>
<span class="nc" id="L86">					i = -1;</span>
				}
			}

<span class="nc" id="L90">			int size = bookList.size();</span>
<span class="nc" id="L91">			boolean isValidBookPresent = false;</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">			for (int i = 0; i &lt; size; i++) {</span>
				// System.out.println(&quot;Loop Itr:&quot; + i);
<span class="nc" id="L94">				bookBean = bookList.get(i);</span>
<span class="nc" id="L95">				String bookNbr = bookBean.getBookNumber();</span>
				// System.out.println(&quot;BookNbr:&quot; + bookNbr);
<span class="nc bnc" id="L97" title="All 4 branches missed.">				if (bookNbr != null &amp;&amp; !bookNbr.trim().equals(&quot;&quot;)) {</span>
<span class="nc" id="L98">					isValidBookPresent = true;</span>
<span class="nc" id="L99">					books.append(&quot;'&quot;);</span>
<span class="nc" id="L100">					books.append(bookNbr);</span>
<span class="nc" id="L101">					books.append(&quot;'&quot;);</span>
<span class="nc" id="L102">					books.append(&quot;,&quot;);</span>
				}

			}

<span class="nc bnc" id="L107" title="All 2 branches missed.">			if (isValidBookPresent) {</span>

<span class="nc" id="L109">				int length = books.length();</span>
<span class="nc" id="L110">				books.deleteCharAt(length - 1);</span>
<span class="nc" id="L111">				return books.toString();</span>
			}

		}

<span class="nc" id="L116">		return null;</span>
	}

	private String getPacks(List&lt;PackBean&gt; packList) {
<span class="nc" id="L120">		PackBean packBean = null;</span>
<span class="nc" id="L121">		StringBuffer packs = new StringBuffer();</span>

<span class="nc bnc" id="L123" title="All 2 branches missed.">		if (packList != null) {</span>

			// int size = packList.size();
<span class="nc bnc" id="L126" title="All 2 branches missed.">			for (int i = 0; i &lt; packList.size(); i++) {</span>
				// System.out.println(&quot;Loop Itr:&quot; + i);
<span class="nc" id="L128">				packBean = packList.get(i);</span>
<span class="nc" id="L129">				String packNbr = packBean.getPackNumber();</span>
				// System.out.println(&quot;PackNbr:&quot; + packNbr);
<span class="nc bnc" id="L131" title="All 6 branches missed.">				if (packNbr == null || packNbr != null</span>
						&amp;&amp; packNbr.trim().equals(&quot;&quot;)) {
<span class="nc" id="L133">					packList.remove(i);</span>
<span class="nc" id="L134">					i = -1;</span>
				}
			}

<span class="nc" id="L138">			int size = packList.size();</span>
<span class="nc" id="L139">			boolean isValidPackPresent = false;</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">			for (int i = 0; i &lt; size; i++) {</span>
				// System.out.println(&quot;Loop Itr:&quot; + i);
<span class="nc" id="L142">				packBean = packList.get(i);</span>
<span class="nc" id="L143">				String packNbr = packBean.getPackNumber();</span>
				// System.out.println(&quot;PackNbr:&quot; + packNbr);
<span class="nc bnc" id="L145" title="All 4 branches missed.">				if (packNbr != null &amp;&amp; !packNbr.trim().equals(&quot;&quot;)) {</span>
<span class="nc" id="L146">					isValidPackPresent = true;</span>
<span class="nc" id="L147">					packs.append(&quot;'&quot;);</span>
<span class="nc" id="L148">					packs.append(packNbr);</span>
<span class="nc" id="L149">					packs.append(&quot;'&quot;);</span>
<span class="nc" id="L150">					packs.append(&quot;,&quot;);</span>
				}

			}

<span class="nc bnc" id="L155" title="All 2 branches missed.">			if (isValidPackPresent) {</span>

<span class="nc" id="L157">				int length = packs.length();</span>
<span class="nc" id="L158">				packs.deleteCharAt(length - 1);</span>
<span class="nc" id="L159">				return packs.toString();</span>
			}

		}

<span class="nc" id="L164">		return null;</span>
	}

	/**
	 * This method verifies the book and pack entries
	 * 
	 * @param packList
	 * @param bookList
	 * @param bookSeriesList
	 * @return boolean
	 */
	public boolean isBookAndPackValid(List&lt;PackBean&gt; packList,
			List&lt;BookBean&gt; bookList, List&lt;BookBean&gt; bookSeriesList) {

<span class="nc bnc" id="L178" title="All 2 branches missed.">		if (bookList != null) {</span>
<span class="nc" id="L179">			System.out.println(&quot;Size of books ::&quot; + bookList.size());</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">			for (BookBean bean : bookList) {</span>
				// System.out.println(&quot;::&quot; + bean.getIsValid());
<span class="nc bnc" id="L182" title="All 2 branches missed.">				if (!bean.getIsValid()) {</span>
<span class="nc" id="L183">					return false;</span>
				}
<span class="nc" id="L185">			}</span>
		}

<span class="nc bnc" id="L188" title="All 2 branches missed.">		if (packList != null) {</span>
<span class="nc" id="L189">			System.out.println(&quot;Size of packs ::&quot; + packList.size());</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">			for (PackBean bean : packList) {</span>
				// System.out.println(&quot;::&quot; + bean.getIsValid());
<span class="nc bnc" id="L192" title="All 2 branches missed.">				if (!bean.getIsValid()) {</span>
<span class="nc" id="L193">					return false;</span>
				}
<span class="nc" id="L195">			}</span>
		}

<span class="nc bnc" id="L198" title="All 2 branches missed.">		if (bookSeriesList != null) {</span>
<span class="nc" id="L199">			System.out.println(&quot;Size in series::&quot; + bookSeriesList.size());</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">			for (BookBean bean : bookSeriesList) {</span>
				// System.out.println(&quot;::&quot; + bean.getIsValid());
<span class="nc bnc" id="L202" title="All 2 branches missed.">				if (!bean.getIsValid()) {</span>
<span class="nc" id="L203">					return false;</span>
				}
<span class="nc" id="L205">			}</span>
		}

<span class="nc" id="L208">		return true;</span>
	}

	/**
	 * This method is used for calculating the dispatch books
	 * 
	 * @param packList
	 * @param bookList
	 * @param bookSeriesList
	 * @param nbrOfBooksPerPack
	 * @return int
	 */
	public int recalculateDispatchBooks(List&lt;PackBean&gt; packList,
			List&lt;BookBean&gt; bookList, List&lt;BookBean&gt; bookSeriesList,
			int nbrOfBooksPerPack) {

<span class="nc" id="L224">		int validBookCount = 0;</span>

		// for books

<span class="nc" id="L228">		String bookNbr = null;</span>
<span class="nc" id="L229">		String packNbr = null;</span>

<span class="nc bnc" id="L231" title="All 2 branches missed.">		if (bookList != null) {</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">			for (BookBean bean : bookList) {</span>
<span class="nc" id="L233">				bookNbr = bean.getBookNumber();</span>

<span class="nc bnc" id="L235" title="All 4 branches missed.">				if (bookNbr != null &amp;&amp; !bookNbr.trim().equals(&quot;&quot;)) {</span>

<span class="nc bnc" id="L237" title="All 2 branches missed.">					if (bean.getIsValid()) {</span>
<span class="nc" id="L238">						validBookCount++;</span>
					}
				}

<span class="nc" id="L242">			}</span>
		}

<span class="nc bnc" id="L245" title="All 2 branches missed.">		if (packList != null) {</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">			for (PackBean bean : packList) {</span>
<span class="nc" id="L247">				packNbr = bean.getPackNumber();</span>

<span class="nc bnc" id="L249" title="All 4 branches missed.">				if (packNbr != null &amp;&amp; !packNbr.trim().equals(&quot;&quot;)) {</span>

<span class="nc bnc" id="L251" title="All 2 branches missed.">					if (bean.getIsValid()) {</span>
<span class="nc" id="L252">						validBookCount += nbrOfBooksPerPack;</span>
					}
				}

<span class="nc" id="L256">			}</span>
		}

<span class="nc bnc" id="L259" title="All 2 branches missed.">		if (bookSeriesList != null) {</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">			for (BookBean bean : bookSeriesList) {</span>
<span class="nc" id="L261">				bookNbr = bean.getBookNumber();</span>

<span class="nc bnc" id="L263" title="All 4 branches missed.">				if (bookNbr != null &amp;&amp; !bookNbr.trim().equals(&quot;&quot;)) {</span>

<span class="nc bnc" id="L265" title="All 2 branches missed.">					if (bean.getIsValid()) {</span>
<span class="nc" id="L266">						validBookCount++;</span>
					}
				}

<span class="nc" id="L270">			}</span>
		}
<span class="nc" id="L272">		return validBookCount;</span>
	}

	private void removeBlanksFromPackList(List&lt;PackBean&gt; packList) {

<span class="nc" id="L277">		PackBean bean = null;</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">		if (packList != null) {</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">			for (int i = 0; i &lt; packList.size(); i++) {</span>
<span class="nc" id="L280">				bean = packList.get(i);</span>

<span class="nc" id="L282">				String packNbr = bean.getPackNumber();</span>
<span class="nc bnc" id="L283" title="All 6 branches missed.">				if (packNbr == null || packNbr != null</span>
						&amp;&amp; packNbr.trim().equals(&quot;&quot;)) {
<span class="nc" id="L285">					packList.remove(i);</span>
<span class="nc" id="L286">					i = -1;</span>
				}
			}
		}

<span class="nc" id="L291">	}</span>

	/**
	 * This method verifies if the passed book is a valid book
	 * 
	 * @param gameId
	 * @param bookToVerify
	 * @return boolean
	 * @throws LMSException
	 */
	public boolean verifyBook(int gameId, String bookToVerify,
			Connection connection, int roleId) throws LMSException {
		// Connection connection = null;
<span class="nc" id="L304">		boolean isValid = false;</span>
		try {

<span class="nc" id="L307">			PreparedStatement pstmt = null;</span>
<span class="nc" id="L308">			ResultSet resultSet = null;</span>
<span class="nc" id="L309">			String query = null;</span>

			//  
			// connection = DBConnect.getConnection();

<span class="nc" id="L314">			query = QueryManager.getST1BOVerifyQuery()</span>
					+ &quot;  and (book_status!='MISSING' and  book_status NOT IN ('CLAIMED','ASSIGNED')  and warehouse_id=(&quot;+QueryManager.getWarehouseIdFromRoleId(roleId)+&quot;))&quot;;
<span class="nc" id="L316">			pstmt = connection.prepareStatement(query);</span>
<span class="nc" id="L317">			System.out.println(&quot;book verifyyyyyyyy:::&quot; + bookToVerify);</span>

<span class="nc" id="L319">			pstmt.setInt(1, gameId);</span>
<span class="nc" id="L320">			pstmt.setString(2, bookToVerify);</span>

<span class="nc" id="L322">			resultSet = pstmt.executeQuery();</span>

<span class="nc" id="L324">			String currOwner = null;</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">			while (resultSet.next()) {</span>
<span class="nc" id="L326">				currOwner = resultSet.getString(TableConstants.SGIS_CURR_OWNER);</span>
<span class="nc bnc" id="L327" title="All 4 branches missed.">				if (currOwner != null &amp;&amp; currOwner.equals(&quot;BO&quot;)) {</span>
					// System.out.println(&quot;----is valid
					// trueeeeeeeeeeeee----------------&quot;);
<span class="nc" id="L330">					isValid = true;</span>
				}
			}

<span class="nc" id="L334">		} catch (Exception e) {</span>

			// e.printStackTrace();
<span class="nc" id="L337">			throw new LMSException(e);</span>

<span class="nc" id="L339">		}/*</span>
			 * finally{ try{ if(connection!=null) connection.close();
			 * }catch(SQLException se){ se.printStackTrace(); } }
			 */

<span class="nc" id="L344">		System.out.println(&quot;IsValid:::::&quot; + isValid);</span>
<span class="nc" id="L345">		return isValid;</span>
	}

	private boolean verifyBooks(int gameId, String books,
			List&lt;BookBean&gt; bookList, Connection connection) throws LMSException {

		// Connection connection = null;
<span class="nc" id="L352">		Statement statement = null;</span>
<span class="nc" id="L353">		ResultSet resultSet = null;</span>
<span class="nc" id="L354">		boolean isBookValid = true;</span>
		try {

			//  
			// connection = DBConnect.getConnection();
<span class="nc" id="L359">			statement = connection.createStatement();</span>

<span class="nc" id="L361">			String query = QueryManager.getST1BOBookInvVerifyQuery();</span>

<span class="nc" id="L363">			query = query + gameId + &quot; and book_nbr in ( &quot; + books + &quot; )&quot;;</span>

<span class="nc" id="L365">			resultSet = statement.executeQuery(query);</span>

<span class="nc" id="L367">			String currOwner = null;</span>
<span class="nc" id="L368">			String bookNbr = null;</span>
<span class="nc" id="L369">			BookBean bean = null;</span>
<span class="nc bnc" id="L370" title="All 2 branches missed.">			while (resultSet.next()) {</span>
<span class="nc" id="L371">				currOwner = resultSet.getString(TableConstants.SGIS_CURR_OWNER);</span>

<span class="nc" id="L373">				bookNbr = resultSet.getString(TableConstants.SGIS_BOOK_NBR);</span>

				// System.out.println(&quot;BookList size &quot; + bookList.size());
<span class="nc bnc" id="L376" title="All 2 branches missed.">				for (int i = 0; i &lt; bookList.size(); i++) {</span>
<span class="nc" id="L377">					bean = bookList.get(i);</span>
<span class="nc bnc" id="L378" title="All 2 branches missed.">					if (bookNbr.equals(bean.getBookNumber())) {</span>
						// System.out.println(&quot;Current Owner::&quot; + currOwner);
<span class="nc bnc" id="L380" title="All 4 branches missed.">						if (currOwner != null &amp;&amp; currOwner.equals(&quot;BO&quot;)) {</span>
<span class="nc" id="L381">							bean.setValid(true);</span>
<span class="nc" id="L382">							bean.setStatus(null);</span>
						} else {
<span class="nc" id="L384">							isBookValid = false;</span>
<span class="nc" id="L385">							bean.setValid(false);</span>
<span class="nc" id="L386">							bean.setStatus(&quot;Wrong Book Number&quot;);</span>
						}

					}

					// System.out.println(&quot;Iter&quot; + i + &quot; &quot; + isBookValid);
				}

			}

<span class="nc bnc" id="L396" title="All 2 branches missed.">			for (int i = 0; i &lt; bookList.size(); i++) {</span>
<span class="nc" id="L397">				bean = bookList.get(i);</span>
<span class="nc bnc" id="L398" title="All 4 branches missed.">				isBookValid = isBookValid &amp;&amp; bean.getIsValid();</span>
			}

<span class="nc bnc" id="L401" title="All 4 branches missed.">			if (resultSet != null &amp;&amp; !resultSet.previous()) {</span>

<span class="nc" id="L403">				System.out.println(&quot;--making false---&quot;);</span>
<span class="nc" id="L404">				isBookValid = false;</span>
			}

<span class="nc" id="L407">		} catch (SQLException e) {</span>

<span class="nc" id="L409">			e.printStackTrace();</span>
<span class="nc" id="L410">			throw new LMSException(e);</span>

		} finally {

<span class="nc" id="L414">			try {</span>

<span class="nc bnc" id="L416" title="All 4 branches missed.">				if (statement != null) {</span>
<span class="nc" id="L417">					statement.close();</span>
				}
				/*
				 * if (connection != null) { connection.close(); }
				 */
<span class="nc" id="L422">			} catch (SQLException se) {</span>
<span class="nc" id="L423">				se.printStackTrace();</span>
<span class="nc" id="L424">			}</span>
<span class="nc" id="L425">		}</span>

<span class="nc" id="L427">		System.out.println(&quot;isBookValid::&quot; + isBookValid);</span>
<span class="nc" id="L428">		return isBookValid;</span>
	}

	/**
	 * This method verifies the book and pack entries entered by the user
	 * 
	 * @param orderedGameBean
	 * @param packList
	 * @param bookList
	 * @param bookSeriesList
	 * @return
	 * @throws LMSException
	 */
	public boolean verifyDispatchEntry(OrderedGameBean orderedGameBean,
			List&lt;PackBean&gt; packList, List&lt;BookBean&gt; bookList,
			List&lt;BookBean&gt; bookSeriesList) throws LMSException {

		// create one connectin only for all book and pack verification

<span class="nc" id="L447">		Connection connection = null;</span>
		try {
			 
<span class="nc" id="L450">			connection = DBConnect.getConnection();</span>

<span class="nc" id="L452">			int gameId = orderedGameBean.getGameId();</span>
			String books;
<span class="nc" id="L454">			boolean isPackValid = true;</span>
<span class="nc" id="L455">			boolean isBookValid = true;</span>

<span class="nc bnc" id="L457" title="All 2 branches missed.">			if (packList != null) {</span>
<span class="nc" id="L458">				removeBlanksFromPackList(packList);</span>
<span class="nc" id="L459">				isPackValid = verifyPacks(gameId, packList, connection);</span>
			}

<span class="nc bnc" id="L462" title="All 2 branches missed.">			if (bookList != null) {</span>
<span class="nc" id="L463">				books = getBooks(bookList);</span>
<span class="nc" id="L464">				System.out.println(&quot;Books::&quot; + books);</span>

<span class="nc bnc" id="L466" title="All 2 branches missed.">				if (books != null) {</span>
<span class="nc" id="L467">					isBookValid = verifyBooks(gameId, books, bookList,</span>
							connection);
				}
			}

<span class="nc" id="L472">			boolean isDuplicateBook = checkDuplicatePackBook(gameId, packList,</span>
					bookList, connection);
<span class="nc" id="L474">			boolean isDuplicateBookSeries = checkDuplicatePackBook(gameId,</span>
					packList, bookSeriesList, connection);

<span class="nc bnc" id="L477" title="All 8 branches missed.">			return isPackValid &amp;&amp; isBookValid &amp;&amp; isDuplicateBook</span>
					&amp;&amp; isDuplicateBookSeries;
		} finally {
<span class="nc" id="L480">			try {</span>
<span class="nc" id="L481">				connection.close();</span>
<span class="nc" id="L482">			} catch (SQLException e) {</span>
<span class="nc" id="L483">				e.printStackTrace();</span>
<span class="nc" id="L484">				throw new LMSException();</span>
<span class="nc" id="L485">			}</span>
		}
	}

	/**
	 * This method verifies if the passed pack is a valid pack
	 * 
	 * @param gameId
	 * @param packToVerify
	 * @return
	 * @throws LMSException
	 */
	public boolean verifyPack(int gameId, String packToVerify)
			throws LMSException {

<span class="nc" id="L500">		boolean isValid = false;</span>
<span class="nc" id="L501">		Connection connection = null;</span>
		try {

<span class="nc" id="L504">			PreparedStatement pstmt = null;</span>
<span class="nc" id="L505">			ResultSet resultSet = null;</span>
			 
<span class="nc" id="L507">			connection = DBConnect.getConnection();</span>

			// query = QueryManager.getST1BOPackInvVerifyQuery()+&quot; and
			// book_status!='MISSING'&quot;;
<span class="nc" id="L511">			String sqlQuery = &quot;select current_owner,current_owner_id, nbr_of_books_per_pack &quot;</span>
					+ &quot;from st_se_game_inv_status aa,  st_se_game_master bb where &quot;
					+ &quot; aa.game_id = bb.game_id and aa.game_id = ? and &quot;
					+ &quot; aa.pack_nbr = ? and (book_status!='MISSING' and book_status!='CLAIMED')&quot;;
<span class="nc" id="L515">			pstmt = connection.prepareStatement(sqlQuery);</span>

<span class="nc" id="L517">			pstmt.setInt(1, gameId);</span>
<span class="nc" id="L518">			pstmt.setString(2, packToVerify);</span>

<span class="nc" id="L520">			resultSet = pstmt.executeQuery();</span>

<span class="nc" id="L522">			String currOwner = null;</span>
<span class="nc" id="L523">			int noOfBooksPerPack = -1, count = 0;</span>
<span class="nc bnc" id="L524" title="All 2 branches missed.">			while (resultSet.next()) {</span>
<span class="nc" id="L525">				currOwner = resultSet.getString(TableConstants.SGIS_CURR_OWNER);</span>
<span class="nc" id="L526">				noOfBooksPerPack = resultSet.getInt(&quot;nbr_of_books_per_pack&quot;);</span>
<span class="nc bnc" id="L527" title="All 4 branches missed.">				if (currOwner != null &amp;&amp; currOwner.equals(&quot;BO&quot;)) {</span>
<span class="nc" id="L528">					isValid = true;</span>
<span class="nc" id="L529">					count += 1;</span>
				} else {
<span class="nc" id="L531">					isValid = false;</span>
<span class="nc" id="L532">					break;</span>
				}
			}
			// check for no of valid books is equal to noOfBooksPerPack
<span class="nc bnc" id="L536" title="All 4 branches missed.">			if (isValid &amp;&amp; noOfBooksPerPack != count) {</span>
<span class="nc" id="L537">				isValid = false;</span>
			}

<span class="nc" id="L540">		} catch (Exception e) {</span>

<span class="nc" id="L542">			e.printStackTrace();</span>
<span class="nc" id="L543">			throw new LMSException(e);</span>

		} finally {
<span class="nc" id="L546">			try {</span>
<span class="nc bnc" id="L547" title="All 4 branches missed.">				if (connection != null) {</span>
<span class="nc" id="L548">					connection.close();</span>
				}
<span class="nc" id="L550">			} catch (SQLException se) {</span>
<span class="nc" id="L551">				se.printStackTrace();</span>
<span class="nc" id="L552">			}</span>
<span class="nc" id="L553">		}</span>

<span class="nc" id="L555">		return isValid;</span>
	}

	private boolean verifyPackBook(int gameId, String packs,
			List&lt;BookBean&gt; bookList, Connection connection) throws LMSException {

		// Connection connection = null;
<span class="nc" id="L562">		Statement statement = null;</span>
<span class="nc" id="L563">		ResultSet resultSet = null;</span>
<span class="nc" id="L564">		boolean isBookValid = true;</span>
		try {

			//  
			// connection = DBConnect.getConnection();
<span class="nc" id="L569">			statement = connection.createStatement();</span>

<span class="nc" id="L571">			String query = QueryManager.getST1BOBookInvVerifyQuery();</span>

<span class="nc" id="L573">			query = query + gameId + &quot; and pack_nbr in ( &quot; + packs + &quot; )&quot;;</span>

<span class="nc" id="L575">			resultSet = statement.executeQuery(query);</span>

<span class="nc" id="L577">			String bookNbr = null;</span>
<span class="nc" id="L578">			BookBean bean = null;</span>
<span class="nc bnc" id="L579" title="All 2 branches missed.">			while (resultSet.next()) {</span>

<span class="nc" id="L581">				bookNbr = resultSet.getString(TableConstants.SGIS_BOOK_NBR);</span>

				// System.out.println(&quot;BookList size &quot; + bookList.size());
<span class="nc bnc" id="L584" title="All 2 branches missed.">				for (int i = 0; i &lt; bookList.size(); i++) {</span>
<span class="nc" id="L585">					bean = bookList.get(i);</span>
<span class="nc bnc" id="L586" title="All 2 branches missed.">					if (bookNbr.equals(bean.getBookNumber())) {</span>

<span class="nc" id="L588">						isBookValid = false;</span>
<span class="nc" id="L589">						bean.setValid(false);</span>
<span class="nc" id="L590">						bean</span>
								.setStatus(&quot;Duplicate Book.This book is already part of the pack chosen above&quot;);

					} /*
						 * else { bean.setValid(true); bean.setStatus(null); }
						 */

				}

				// System.out.println(&quot;Iter&quot; + i + &quot; &quot; + isBookValid);
			}

<span class="nc bnc" id="L602" title="All 2 branches missed.">			for (int i = 0; i &lt; bookList.size(); i++) {</span>
<span class="nc" id="L603">				bean = bookList.get(i);</span>
<span class="nc bnc" id="L604" title="All 4 branches missed.">				isBookValid = isBookValid &amp;&amp; bean.getIsValid();</span>
			}

<span class="nc bnc" id="L607" title="All 4 branches missed.">			if (resultSet != null &amp;&amp; !resultSet.previous()) {</span>

<span class="nc" id="L609">				System.out.println(&quot;--making false---&quot;);</span>
<span class="nc" id="L610">				isBookValid = false;</span>
			}

<span class="nc" id="L613">		} catch (SQLException e) {</span>

<span class="nc" id="L615">			e.printStackTrace();</span>
<span class="nc" id="L616">			throw new LMSException(e);</span>

		} finally {

<span class="nc" id="L620">			try {</span>

<span class="nc bnc" id="L622" title="All 4 branches missed.">				if (statement != null) {</span>
<span class="nc" id="L623">					statement.close();</span>
				}
				/*
				 * if (connection != null) { connection.close(); }
				 */
<span class="nc" id="L628">			} catch (SQLException se) {</span>
<span class="nc" id="L629">				se.printStackTrace();</span>
<span class="nc" id="L630">			}</span>
<span class="nc" id="L631">		}</span>

<span class="nc" id="L633">		System.out.println(&quot;isBookValid::&quot; + isBookValid);</span>
<span class="nc" id="L634">		return isBookValid;</span>

	}

	private boolean verifyPacks(int gameId, List&lt;PackBean&gt; packList,
			Connection connection) throws LMSException {

<span class="nc" id="L641">		boolean isPackValid = true;</span>
<span class="nc bnc" id="L642" title="All 4 branches missed.">		if (packList != null &amp;&amp; packList.size() &gt; 0) {</span>

<span class="nc" id="L644">			PackBean bean = null;</span>

			// Connection connection = null;
<span class="nc" id="L647">			PreparedStatement pstmt = null;</span>
<span class="nc" id="L648">			ResultSet resultSet = null;</span>

			try {

				//  
				// connection = DBConnect.getConnection();

<span class="nc" id="L655">				String query = QueryManager.getST1BOPackInvVerifyQuery();</span>

<span class="nc" id="L657">				pstmt = connection.prepareStatement(query);</span>

<span class="nc bnc" id="L659" title="All 2 branches missed.">				for (int i = 0; i &lt; packList.size(); i++) {</span>
<span class="nc" id="L660">					bean = packList.get(i);</span>
<span class="nc" id="L661">					pstmt.setInt(1, gameId);</span>
<span class="nc" id="L662">					pstmt.setString(2, bean.getPackNumber());</span>

<span class="nc" id="L664">					resultSet = null;</span>
<span class="nc" id="L665">					resultSet = pstmt.executeQuery();</span>

					// System.out.println(&quot;Rs::----------------------------&quot; +
					// resultSet);
<span class="nc bnc" id="L669" title="All 2 branches missed.">					if (resultSet == null) {</span>
<span class="nc" id="L670">						isPackValid = false;</span>
					}

<span class="nc" id="L673">					String currOwner = null;</span>
<span class="nc bnc" id="L674" title="All 2 branches missed.">					while (resultSet.next()) {</span>
<span class="nc" id="L675">						currOwner = resultSet</span>
								.getString(TableConstants.SGIS_CURR_OWNER);

						// System.out.println(&quot;PackNbr::&quot; +
						// bean.getPackNumber());
						// System.out.println(&quot;CurrOwner::&quot; + currOwner);
<span class="nc bnc" id="L681" title="All 4 branches missed.">						if (currOwner != null &amp;&amp; currOwner.equals(&quot;BO&quot;)) {</span>

<span class="nc" id="L683">							bean.setValid(true);</span>

						} else {
<span class="nc" id="L686">							isPackValid = false;</span>
<span class="nc" id="L687">							bean.setValid(false);</span>
<span class="nc" id="L688">							bean.setStatus(&quot;Wrong Pack Number&quot;);</span>
<span class="nc" id="L689">							break;</span>
						}
					}

<span class="nc bnc" id="L693" title="All 4 branches missed.">					if (resultSet != null &amp;&amp; !resultSet.previous()) {</span>

<span class="nc" id="L695">						isPackValid = false;</span>
					}

				}
<span class="nc" id="L699">			} catch (SQLException se) {</span>
<span class="nc" id="L700">				se.printStackTrace();</span>
<span class="nc" id="L701">				throw new LMSException(se);</span>

			} finally {

<span class="nc" id="L705">				try {</span>

<span class="nc bnc" id="L707" title="All 4 branches missed.">					if (pstmt != null) {</span>
<span class="nc" id="L708">						pstmt.close();</span>
					}
					/*
					 * if (connection != null) { connection.close(); }
					 */
<span class="nc" id="L713">				} catch (SQLException se) {</span>
<span class="nc" id="L714">					se.printStackTrace();</span>
<span class="nc" id="L715">				}</span>
<span class="nc" id="L716">			}</span>

		}
<span class="nc" id="L719">		System.out.println(&quot;isPackValid::&quot; + isPackValid);</span>
<span class="nc" id="L720">		return isPackValid;</span>
	}

	public List&lt;OrderBean&gt; dispatchOrderSearch(String gameName, String gameNumber, String agtOrgName, String orderNumber,String challanId,int roleId) throws LMSException {
<span class="nc" id="L724">		Connection connection = null;</span>
<span class="nc" id="L725">		Statement statement = null;</span>
<span class="nc" id="L726">		ResultSet resultSet = null;</span>
<span class="nc" id="L727">		List&lt;OrderBean&gt; searchResults = new ArrayList&lt;OrderBean&gt;();</span>
<span class="nc" id="L728">		OrderBean orderBean = null;</span>
		try {
<span class="nc" id="L730">			connection = DBConnect.getConnection();</span>
<span class="nc" id="L731">			statement = connection.createStatement();</span>
			
<span class="nc" id="L733">			StringBuilder queryBuilder = new StringBuilder();</span>
<span class="nc" id="L734">			String query = &quot;SELECT sbo.order_id, sbo.agent_org_id, som.name, sbo.order_date, sbo.order_status,generated_id FROM st_se_bo_order sbo,st_se_bo_order_invoices sboi, st_se_bo_ordered_games sog,st_lms_bo_receipts lbc, st_lms_organization_master som, st_se_game_master gm WHERE sbo.agent_org_id=som.organization_id AND sbo.order_status IN('ASSIGNED','SEMI_ASSIGNED') AND sog.game_id=gm.game_id AND sbo.order_id=sog.order_id and sboi.order_id=sbo.order_id and lbc.receipt_id=sboi.dc_id&quot;;</span>
<span class="nc" id="L735">			query = CommonMethods.appendRoleAgentMappingQuery(query,&quot;sbo.agent_org_id&quot;,roleId);// +&quot; group by</span>
<span class="nc" id="L736">			queryBuilder.append(query);</span>
<span class="nc bnc" id="L737" title="All 4 branches missed.">			if(gameName!=null &amp;&amp; gameName.length()&gt;0)</span>
<span class="nc" id="L738">				queryBuilder.append(&quot; AND game_name LIKE '%&quot;).append(gameName).append(&quot;%'&quot;);</span>
<span class="nc bnc" id="L739" title="All 4 branches missed.">			if(gameNumber!=null &amp;&amp; gameNumber.length()&gt;0)</span>
<span class="nc" id="L740">				queryBuilder.append(&quot; AND game_nbr LIKE '%&quot;).append(gameNumber).append(&quot;%'&quot;);</span>
<span class="nc bnc" id="L741" title="All 4 branches missed.">			if(agtOrgName!=null &amp;&amp; agtOrgName.length()&gt;0)</span>
<span class="nc" id="L742">				queryBuilder.append(&quot; AND name LIKE '%&quot;).append(agtOrgName).append(&quot;%'&quot;);</span>
<span class="nc bnc" id="L743" title="All 4 branches missed.">			if(orderNumber!=null &amp;&amp; orderNumber.length()&gt;0)</span>
<span class="nc" id="L744">				queryBuilder.append(&quot; AND sbo.order_id LIKE '%&quot;).append(orderNumber).append(&quot;%'&quot;);</span>
<span class="nc bnc" id="L745" title="All 4 branches missed.">			if(challanId!=null &amp;&amp; challanId.length()&gt;0)</span>
<span class="nc" id="L746">				queryBuilder.append(&quot; AND generated_id LIKE '%&quot;).append(challanId).append(&quot;%'&quot;);</span>
<span class="nc" id="L747">			queryBuilder.append(&quot; GROUP BY order_id;&quot;);</span>

<span class="nc" id="L749">			System.out.println(&quot;dispatchOrderSearch - &quot;+queryBuilder.toString());</span>
<span class="nc" id="L750">			resultSet = statement.executeQuery(queryBuilder.toString());</span>
<span class="nc bnc" id="L751" title="All 2 branches missed.">			while (resultSet.next()) {</span>
<span class="nc" id="L752">				orderBean = new OrderBean();</span>
<span class="nc" id="L753">				orderBean.setOrderId(resultSet.getInt(&quot;order_id&quot;));</span>
<span class="nc" id="L754">				orderBean.setAgentOrgId(resultSet.getInt(&quot;agent_org_id&quot;));</span>
<span class="nc" id="L755">				orderBean.setAgentOrgName(resultSet.getString(&quot;name&quot;));</span>
<span class="nc" id="L756">				orderBean.setOrderDate(resultSet.getDate(&quot;order_date&quot;));</span>
<span class="nc" id="L757">				orderBean.setChallanId(resultSet.getString(&quot;generated_id&quot;));</span>
<span class="nc bnc" id="L758" title="All 2 branches missed.">				if (resultSet.getString(&quot;order_status&quot;).equalsIgnoreCase(&quot;APPROVED&quot;))</span>
<span class="nc" id="L759">					orderBean.setOrderStatus(&quot;Approved&quot;);</span>
<span class="nc bnc" id="L760" title="All 2 branches missed.">				if (resultSet.getString(&quot;order_status&quot;).equalsIgnoreCase(&quot;PROCESSED&quot;))</span>
<span class="nc" id="L761">					orderBean.setOrderStatus(&quot;Processed&quot;);</span>
<span class="nc bnc" id="L762" title="All 2 branches missed.">				if (resultSet.getString(&quot;order_status&quot;).equalsIgnoreCase(&quot;SEMI_PROCESSED&quot;))</span>
<span class="nc" id="L763">					orderBean.setOrderStatus(&quot;Semi Processed&quot;);</span>
<span class="nc bnc" id="L764" title="All 2 branches missed.">				if (resultSet.getString(&quot;order_status&quot;).equalsIgnoreCase(&quot;ASSIGNED&quot;))</span>
<span class="nc" id="L765">					orderBean.setOrderStatus(&quot;Assigned&quot;);</span>
<span class="nc bnc" id="L766" title="All 2 branches missed.">				if (resultSet.getString(&quot;order_status&quot;).equalsIgnoreCase(&quot;SEMI_ASSIGNED&quot;))</span>
<span class="nc" id="L767">					orderBean.setOrderStatus(&quot;Semi Assigned&quot;);</span>

<span class="nc" id="L769">				searchResults.add(orderBean);</span>
			}
<span class="nc" id="L771">		} catch (SQLException e) {</span>
<span class="nc" id="L772">			e.printStackTrace();</span>
<span class="nc" id="L773">			throw new LMSException(e);</span>
		} finally {
<span class="nc" id="L775">			DBConnect.closeCon(connection);</span>
<span class="nc" id="L776">			DBConnect.closeStmt(statement);</span>
<span class="nc" id="L777">			DBConnect.closeRs(resultSet);</span>
<span class="nc" id="L778">		}</span>

<span class="nc" id="L780">		return searchResults;</span>
	}

	public DispatchOrderResponse getBookListFromOrderId(int orderId) {
<span class="nc" id="L784">		Connection connection = null;</span>
<span class="nc" id="L785">		Statement statement = null;</span>
<span class="nc" id="L786">		ResultSet resultSet = null;</span>
<span class="nc" id="L787">		DispatchOrderResponse dispatchOrderResponse = null ;</span>
<span class="nc" id="L788">		Map&lt;String, Map&lt;String, List&lt;String&gt;&gt;&gt; gameMap = new HashMap&lt;String, Map&lt;String,List&lt;String&gt;&gt;&gt;();</span>
<span class="nc" id="L789">		Map&lt;String, List&lt;String&gt;&gt; packMap = null;</span>
<span class="nc" id="L790">		List&lt;String&gt; bookList = null;</span>
		try {
<span class="nc" id="L792">			connection = DBConnect.getConnection();</span>
<span class="nc" id="L793">			statement = connection.createStatement();</span>
<span class="nc" id="L794">			String query = &quot;SELECT gm.game_id, game_name, pack_nbr, gid.book_status, book_nbr FROM st_se_game_inv_detail gid INNER JOIN st_se_bo_order_invoices boi ON gid.order_invoice_dc_id=boi.order_invoice_dc_id INNER JOIN st_se_game_master gm ON gid.game_id=gm.game_id WHERE boi.order_id=&quot;+orderId+&quot;;&quot;;</span>
<span class="nc" id="L795">			System.out.println(&quot;getBookListFromOrderId - &quot;+query);</span>
<span class="nc" id="L796">			resultSet = statement.executeQuery(query);</span>
<span class="nc bnc" id="L797" title="All 2 branches missed.">			while (resultSet.next()) {</span>
<span class="nc bnc" id="L798" title="All 2 branches missed.">				if(!&quot;ASSIGNED&quot;.equalsIgnoreCase(resultSet.getString(&quot;book_status&quot;))){</span>
<span class="nc" id="L799">					return new DispatchOrderResponse(500);</span>
				}
<span class="nc bnc" id="L801" title="All 2 branches missed.">				if(!gameMap.containsKey(resultSet.getString(&quot;game_name&quot;)))</span>
<span class="nc" id="L802">					gameMap.put(resultSet.getString(&quot;game_name&quot;), new HashMap&lt;String, List&lt;String&gt;&gt;());</span>
<span class="nc" id="L803">				packMap = gameMap.get(resultSet.getString(&quot;game_name&quot;));</span>

<span class="nc bnc" id="L805" title="All 2 branches missed.">				if(!packMap.containsKey(resultSet.getString(&quot;pack_nbr&quot;)))</span>
<span class="nc" id="L806">					packMap.put(resultSet.getString(&quot;pack_nbr&quot;), new ArrayList&lt;String&gt;());</span>
<span class="nc" id="L807">				bookList = packMap.get(resultSet.getString(&quot;pack_nbr&quot;));</span>

<span class="nc" id="L809">				bookList.add(resultSet.getString(&quot;book_nbr&quot;));</span>
			}
<span class="nc" id="L811">			dispatchOrderResponse = new DispatchOrderResponse(200, gameMap);</span>
<span class="nc" id="L812">		} catch (SQLException e) {</span>
<span class="nc" id="L813">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L815">			DBConnect.closeCon(connection);</span>
<span class="nc" id="L816">			DBConnect.closeStmt(statement);</span>
<span class="nc" id="L817">			DBConnect.closeRs(resultSet);</span>
<span class="nc" id="L818">		}</span>

<span class="nc" id="L820">		return dispatchOrderResponse;</span>
	}

	public void dispatchOrder(int orderId, int userOrgId, String userType,int userId, Map&lt;String, Map&lt;String, List&lt;String&gt;&gt;&gt; gameMap) {
<span class="nc" id="L824">		Connection connection = null;</span>
<span class="nc" id="L825">		Statement stmt = null;</span>
		try {
<span class="nc" id="L827">			connection = DBConnect.getConnection();</span>
<span class="nc" id="L828">			connection.setAutoCommit(false);</span>

<span class="nc" id="L830">			stmt = connection.createStatement();</span>
<span class="nc" id="L831">			stmt.executeUpdate(&quot;UPDATE st_se_bo_order SET order_status=(IF(order_status='SEMI_ASSIGNED','SEMI_PROCESSED','PROCESSED')) WHERE order_id=&quot;+orderId+&quot;;&quot;);</span>
<span class="nc" id="L832">			stmt.executeUpdate(&quot;UPDATE st_se_bo_order_invoices SET order_status=(IF(order_status='SEMI_ASSIGNED','SEMI_PROCESSED','PROCESSED')) WHERE order_id=&quot;+orderId+&quot;;&quot;);</span>
<span class="nc bnc" id="L833" title="All 2 branches missed.">			for(Map.Entry&lt;String, Map&lt;String, List&lt;String&gt;&gt;&gt; gameEntry : gameMap.entrySet())</span>
<span class="nc bnc" id="L834" title="All 2 branches missed.">				for(Map.Entry&lt;String, List&lt;String&gt;&gt; packEntry : gameEntry.getValue().entrySet())</span>
<span class="nc bnc" id="L835" title="All 2 branches missed.">					for(String book : packEntry.getValue()) {</span>
<span class="nc" id="L836">						stmt.executeUpdate(&quot;UPDATE st_se_game_inv_status SET book_status='IN_TRANSIT' WHERE book_nbr='&quot;+book+&quot;';&quot;);</span>
<span class="nc" id="L837">						stmt.executeUpdate(&quot;insert into st_se_game_inv_detail(game_id, pack_nbr, book_nbr, current_owner, current_owner_id, transaction_date, transaction_at, changed_by_user_id, book_status, warehouse_id, agent_invoice_id, ret_invoice_id) select game_id, pack_nbr, book_nbr, current_owner, current_owner_id, '&quot;+Util.getCurrentTimeString()+&quot;' transaction_date, '&quot;+userType+&quot;' transaction_at, &quot;+userId+&quot; changed_by_user_id, 'IN_TRANSIT' book_status, warehouse_id, agent_invoice_id, ret_invoice_id from st_se_game_inv_status where  book_nbr='&quot;+book+&quot;'&quot;);</span>
<span class="nc" id="L838">					}</span>
<span class="nc" id="L839">			connection.commit();</span>
<span class="nc" id="L840">		} catch (Exception ex) {</span>
<span class="nc" id="L841">			ex.printStackTrace();</span>
		} finally {
<span class="nc" id="L843">			DBConnect.closeCon(connection);</span>
<span class="nc" id="L844">			DBConnect.closeStmt(stmt);</span>
<span class="nc" id="L845">		}</span>
<span class="nc" id="L846">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>