<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AgentDispatchGameHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lms</a> &gt; <a href="index.source.html" class="el_package">com.skilrock.lms.coreEngine.scratchService.inventoryMgmt.common</a> &gt; <span class="el_source">AgentDispatchGameHelper.java</span></div><h1>AgentDispatchGameHelper.java</h1><pre class="source lang-java linenums">/*
 * ï¿½ copyright 2007, SkilRock Technologies, A division of Sugal &amp; Damani Lottery Agency Pvt. Ltd.
 * All Rights Reserved
 * The contents of this file are the property of Sugal &amp; Damani Lottery Agency Pvt. Ltd.
 * and are subject to a License agreement with Sugal &amp; Damani Lottery Agency Pvt. Ltd.; you may
 * not use this file except in compliance with that License.  You may obtain a
 * copy of that license from:
 * Legal Department
 * Sugal &amp; Damani Lottery Agency Pvt. Ltd.
 * 6/35,WEA, Karol Bagh,
 * New Delhi
 * India - 110005
 * This software is distributed under the License and is provided on an ï¿½AS ISï¿½
 * basis, without warranty of any kind, either express or implied, unless
 * otherwise provided in the License.  See the License for governing rights and
 * limitations under the License.
 */

package com.skilrock.lms.coreEngine.scratchService.inventoryMgmt.common;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.skilrock.lms.beans.BookBean;
import com.skilrock.lms.beans.DispatchOrderResponse;
import com.skilrock.lms.beans.OrderBean;
import com.skilrock.lms.beans.OrderedGameBean;
import com.skilrock.lms.beans.PackBean;
import com.skilrock.lms.common.db.DBConnect;
import com.skilrock.lms.common.db.QueryManager;
import com.skilrock.lms.common.db.TableConstants;
import com.skilrock.lms.common.exception.LMSException;
import com.skilrock.lms.web.drawGames.common.Util;

/**
 * This is a helper class providing methods for handling the order dispatch at
 * Agent end
 * 
 * @author Skilrock Technologies
 * 
 */
<span class="nc" id="L52">public class AgentDispatchGameHelper {</span>
<span class="nc" id="L53">	private static final Logger logger = LoggerFactory.getLogger(AgentDispatchGameHelper.class);</span>
	private boolean checkDuplicatePackBook(int gameId, List&lt;PackBean&gt; packList,
			List&lt;BookBean&gt; bookList, int agtOrgId, Connection connection)
			throws LMSException {
<span class="nc" id="L57">		boolean isValid = true;</span>
<span class="nc" id="L58">		String packs = null;</span>
<span class="nc bnc" id="L59" title="All 2 branches missed.">		if (packList != null) {</span>
<span class="nc" id="L60">			packs = getPacks(packList);</span>
<span class="nc bnc" id="L61" title="All 2 branches missed.">			if (packs != null) {</span>
<span class="nc" id="L62">				isValid = verifyPackBook(gameId, packs, bookList, connection);</span>

			}
		}

<span class="nc" id="L67">		System.out.println(&quot;---Duplicate Pack Book::&quot; + isValid);</span>
<span class="nc" id="L68">		return isValid;</span>
	}

	private String getBooks(List&lt;BookBean&gt; bookList) {
<span class="nc" id="L72">		BookBean bookBean = null;</span>
<span class="nc" id="L73">		StringBuffer books = new StringBuffer();</span>

<span class="nc bnc" id="L75" title="All 2 branches missed.">		if (bookList != null) {</span>

			// int size = bookList.size();
<span class="nc bnc" id="L78" title="All 2 branches missed.">			for (int i = 0; i &lt; bookList.size(); i++) {</span>
				// System.out.println(&quot;Loop Itr:&quot; + i);
<span class="nc" id="L80">				bookBean = bookList.get(i);</span>
<span class="nc" id="L81">				String bookNbr = bookBean.getBookNumber();</span>
				// System.out.println(&quot;BookNbr:&quot; + bookNbr);
<span class="nc bnc" id="L83" title="All 6 branches missed.">				if (bookNbr == null || bookNbr != null</span>
						&amp;&amp; bookNbr.trim().equals(&quot;&quot;)) {
<span class="nc" id="L85">					bookList.remove(i);</span>
<span class="nc" id="L86">					i = -1;</span>
				}
			}

<span class="nc" id="L90">			int size = bookList.size();</span>
<span class="nc" id="L91">			boolean isValidBookPresent = false;</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">			for (int i = 0; i &lt; size; i++) {</span>
				// System.out.println(&quot;Loop Itr:&quot; + i);
<span class="nc" id="L94">				bookBean = bookList.get(i);</span>
<span class="nc" id="L95">				String bookNbr = bookBean.getBookNumber();</span>
				// System.out.println(&quot;BookNbr:&quot; + bookNbr);
<span class="nc bnc" id="L97" title="All 4 branches missed.">				if (bookNbr != null &amp;&amp; !bookNbr.trim().equals(&quot;&quot;)) {</span>
<span class="nc" id="L98">					isValidBookPresent = true;</span>
<span class="nc" id="L99">					books.append(&quot;'&quot;);</span>
<span class="nc" id="L100">					books.append(bookNbr);</span>
<span class="nc" id="L101">					books.append(&quot;'&quot;);</span>
<span class="nc" id="L102">					books.append(&quot;,&quot;);</span>
				}

			}

<span class="nc bnc" id="L107" title="All 2 branches missed.">			if (isValidBookPresent) {</span>

<span class="nc" id="L109">				int length = books.length();</span>
<span class="nc" id="L110">				books.deleteCharAt(length - 1);</span>
<span class="nc" id="L111">				return books.toString();</span>
			}

		}

<span class="nc" id="L116">		return null;</span>
	}

	private String getPacks(List&lt;PackBean&gt; packList) {
<span class="nc" id="L120">		PackBean packBean = null;</span>
<span class="nc" id="L121">		StringBuffer packs = new StringBuffer();</span>

<span class="nc bnc" id="L123" title="All 2 branches missed.">		if (packList != null) {</span>

			// int size = packList.size();
<span class="nc bnc" id="L126" title="All 2 branches missed.">			for (int i = 0; i &lt; packList.size(); i++) {</span>
				// System.out.println(&quot;Loop Itr:&quot; + i);
<span class="nc" id="L128">				packBean = packList.get(i);</span>
<span class="nc" id="L129">				String packNbr = packBean.getPackNumber();</span>
				// System.out.println(&quot;PackNbr:&quot; + packNbr);
<span class="nc bnc" id="L131" title="All 6 branches missed.">				if (packNbr == null || packNbr != null</span>
						&amp;&amp; packNbr.trim().equals(&quot;&quot;)) {
<span class="nc" id="L133">					packList.remove(i);</span>
<span class="nc" id="L134">					i = -1;</span>
				}
			}

			// prepare a comma-separated pack list

<span class="nc" id="L140">			int size = packList.size();</span>
<span class="nc" id="L141">			boolean isValidPackPresent = false;</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">			for (int i = 0; i &lt; size; i++) {</span>
				// System.out.println(&quot;Loop Itr:&quot; + i);
<span class="nc" id="L144">				packBean = packList.get(i);</span>
<span class="nc" id="L145">				String packNbr = packBean.getPackNumber();</span>
				// System.out.println(&quot;PackNbr:&quot; + packNbr);
<span class="nc bnc" id="L147" title="All 4 branches missed.">				if (packNbr != null &amp;&amp; !packNbr.trim().equals(&quot;&quot;)) {</span>
<span class="nc" id="L148">					isValidPackPresent = true;</span>
<span class="nc" id="L149">					packs.append(&quot;'&quot;);</span>
<span class="nc" id="L150">					packs.append(packNbr);</span>
<span class="nc" id="L151">					packs.append(&quot;'&quot;);</span>
<span class="nc" id="L152">					packs.append(&quot;,&quot;);</span>
				}

			}

<span class="nc bnc" id="L157" title="All 2 branches missed.">			if (isValidPackPresent) {</span>

<span class="nc" id="L159">				int length = packs.length();</span>
<span class="nc" id="L160">				packs.deleteCharAt(length - 1);</span>
<span class="nc" id="L161">				return packs.toString();</span>
			}

		}

<span class="nc" id="L166">		return null;</span>
	}

	/**
	 * This method verifies the book and pack entries
	 * 
	 * @param packList
	 * @param bookList
	 * @return boolean
	 */
	public boolean isBookAndPackValid(List&lt;PackBean&gt; packList,
			List&lt;BookBean&gt; bookList, List&lt;BookBean&gt; bookSeriesList) {

<span class="nc bnc" id="L179" title="All 2 branches missed.">		if (bookList != null) {</span>
<span class="nc" id="L180">			System.out.println(&quot;Size::&quot; + bookList.size());</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">			for (BookBean bean : bookList) {</span>
<span class="nc" id="L182">				System.out.println(&quot;::&quot; + bean.getIsValid());</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">				if (!bean.getIsValid()) {</span>
<span class="nc" id="L184">					return false;</span>
				}
<span class="nc" id="L186">			}</span>
		}

<span class="nc bnc" id="L189" title="All 2 branches missed.">		if (packList != null) {</span>
<span class="nc" id="L190">			System.out.println(&quot;Size::&quot; + packList.size());</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">			for (PackBean bean : packList) {</span>
<span class="nc" id="L192">				System.out.println(&quot;::&quot; + bean.getIsValid());</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">				if (!bean.getIsValid()) {</span>
<span class="nc" id="L194">					return false;</span>
				}
<span class="nc" id="L196">			}</span>
		}

<span class="nc bnc" id="L199" title="All 2 branches missed.">		if (bookSeriesList != null) {</span>
<span class="nc" id="L200">			System.out.println(&quot;Size::&quot; + bookSeriesList.size());</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">			for (BookBean bean : bookSeriesList) {</span>
<span class="nc" id="L202">				System.out.println(&quot;::&quot; + bean.getIsValid());</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">				if (!bean.getIsValid()) {</span>
<span class="nc" id="L204">					return false;</span>
				}
<span class="nc" id="L206">			}</span>
		}

<span class="nc" id="L209">		return true;</span>
	}

	/**
	 * This method is used for calculating the dispatch books
	 * 
	 * @param packList
	 * @param bookList
	 * @param nbrOfBooksPerPack
	 * @return int
	 */
	public int recalculateDispatchBooks(List&lt;PackBean&gt; packList,
			List&lt;BookBean&gt; bookList, List&lt;BookBean&gt; bookSeriesList,
			int nbrOfBooksPerPack) {

<span class="nc" id="L224">		int validBookCount = 0;</span>

		// for books

<span class="nc" id="L228">		String bookNbr = null;</span>
<span class="nc" id="L229">		String packNbr = null;</span>

<span class="nc bnc" id="L231" title="All 2 branches missed.">		if (bookList != null) {</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">			for (BookBean bean : bookList) {</span>
<span class="nc" id="L233">				bookNbr = bean.getBookNumber();</span>

<span class="nc bnc" id="L235" title="All 4 branches missed.">				if (bookNbr != null &amp;&amp; !bookNbr.trim().equals(&quot;&quot;)) {</span>

<span class="nc bnc" id="L237" title="All 2 branches missed.">					if (bean.getIsValid()) {</span>
<span class="nc" id="L238">						validBookCount++;</span>
					}
				}

<span class="nc" id="L242">			}</span>
		}

<span class="nc bnc" id="L245" title="All 2 branches missed.">		if (packList != null) {</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">			for (PackBean bean : packList) {</span>
<span class="nc" id="L247">				packNbr = bean.getPackNumber();</span>

<span class="nc bnc" id="L249" title="All 4 branches missed.">				if (packNbr != null &amp;&amp; !packNbr.trim().equals(&quot;&quot;)) {</span>

<span class="nc bnc" id="L251" title="All 2 branches missed.">					if (bean.getIsValid()) {</span>
<span class="nc" id="L252">						validBookCount += nbrOfBooksPerPack;</span>
					}
				}

<span class="nc" id="L256">			}</span>
		}

<span class="nc bnc" id="L259" title="All 2 branches missed.">		if (bookSeriesList != null) {</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">			for (BookBean bean : bookSeriesList) {</span>
<span class="nc" id="L261">				bookNbr = bean.getBookNumber();</span>

<span class="nc bnc" id="L263" title="All 4 branches missed.">				if (bookNbr != null &amp;&amp; !bookNbr.trim().equals(&quot;&quot;)) {</span>

<span class="nc bnc" id="L265" title="All 2 branches missed.">					if (bean.getIsValid()) {</span>
<span class="nc" id="L266">						validBookCount++;</span>
					}
				}

<span class="nc" id="L270">			}</span>
		}

<span class="nc" id="L273">		return validBookCount;</span>
	}

	private void removeBlanksFromPackList(List&lt;PackBean&gt; packList) {

<span class="nc" id="L278">		PackBean bean = null;</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">		if (packList != null) {</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">			for (int i = 0; i &lt; packList.size(); i++) {</span>
<span class="nc" id="L281">				bean = packList.get(i);</span>

<span class="nc" id="L283">				String packNbr = bean.getPackNumber();</span>
<span class="nc bnc" id="L284" title="All 6 branches missed.">				if (packNbr == null || packNbr != null</span>
						&amp;&amp; packNbr.trim().equals(&quot;&quot;)) {
<span class="nc" id="L286">					packList.remove(i);</span>
<span class="nc" id="L287">					i = -1;</span>
				}
			}
		}

<span class="nc" id="L292">	}</span>

	/**
	 * This method verifies if the passed book is a valid book
	 * 
	 * @param gameId
	 * @param agtOrgId
	 * @param bookToVerify
	 * @return boolean
	 * @throws LMSException
	 */
	public boolean verifyBook(int gameId, int agtOrgId, String bookToVerify,
			Connection conn, int gameNbr) throws LMSException {

		// System.out.println(&quot;Agent Org Id::&quot; + agtOrgId);
<span class="nc" id="L307">		boolean isValid = false;</span>
<span class="nc" id="L308">		boolean ownercheck = false;</span>
<span class="nc" id="L309">		boolean pwtCheck = false;</span>
<span class="nc" id="L310">		boolean pwtCheckTemp = false;</span>
<span class="nc" id="L311">		Connection connection = conn;</span>
		try {

<span class="nc" id="L314">			PreparedStatement pstmt = null;</span>
<span class="nc" id="L315">			ResultSet resultSet = null;</span>
<span class="nc" id="L316">			String query = null;</span>

			/*
			 *   connection =
			 * dbConnect.getConnection();
			 */

<span class="nc" id="L323">			query = QueryManager.getST1AgentVerifyQuery()</span>
					+ &quot;  and (book_status='INACTIVE')&quot;;
<span class="nc" id="L325">			pstmt = connection.prepareStatement(query);</span>

<span class="nc" id="L327">			pstmt.setInt(1, gameId);</span>
<span class="nc" id="L328">			pstmt.setString(2, bookToVerify);</span>

<span class="nc" id="L330">			resultSet = pstmt.executeQuery();</span>

<span class="nc" id="L332">			String currOwner = null;</span>
<span class="nc" id="L333">			int currOwnerId = -1;</span>
<span class="nc bnc" id="L334" title="All 2 branches missed.">			while (resultSet.next()) {</span>
<span class="nc" id="L335">				currOwner = resultSet.getString(TableConstants.SGIS_CURR_OWNER);</span>
<span class="nc" id="L336">				currOwnerId = resultSet</span>
						.getInt(TableConstants.SGIS_CURR_OWNER_ID);
<span class="nc bnc" id="L338" title="All 6 branches missed.">				if (currOwner != null &amp;&amp; currOwner.equals(&quot;AGENT&quot;)</span>
						&amp;&amp; currOwnerId == agtOrgId) {
<span class="nc" id="L340">					ownercheck = true;</span>
				}
			}

			// ckeck for ticket of this book in main ticket table
<span class="nc" id="L345">			pwtCheck = verifyBookValidityWithPWT(gameId, bookToVerify,</span>
					connection, gameNbr);
<span class="nc" id="L347">			pwtCheckTemp = verifyBookValidityWithPWTTempTable(gameId,</span>
					bookToVerify, connection);
<span class="nc bnc" id="L349" title="All 6 branches missed.">			if (ownercheck == true &amp;&amp; pwtCheck == true &amp;&amp; pwtCheckTemp == true) {</span>
<span class="nc" id="L350">				isValid = true;</span>
			}

<span class="nc" id="L353">		} catch (SQLException e) {</span>

<span class="nc" id="L355">			e.printStackTrace();</span>
<span class="nc" id="L356">			throw new LMSException(e);</span>
<span class="nc" id="L357">		}</span>
		/*
		 * finally{ try{ if(connection!=null) connection.close();
		 * }catch(SQLException se){ se.printStackTrace(); } }
		 */

<span class="nc" id="L363">		return isValid;</span>
	}

	private boolean verifyBooks(int gameId, String books,
			List&lt;BookBean&gt; bookList, int agtOrgId, Connection connection)
			throws LMSException {

		// Connection connection = null;
<span class="nc" id="L371">		Statement statement = null;</span>
<span class="nc" id="L372">		ResultSet resultSet = null;</span>
<span class="nc" id="L373">		boolean isBookValid = true;</span>
		try {

			//  
			// connection = DBConnect.getConnection();
<span class="nc" id="L378">			statement = connection.createStatement();</span>

<span class="nc" id="L380">			String query = QueryManager.getST1AgentBookInvVerifyQuery();</span>

<span class="nc" id="L382">			query = query + gameId + &quot; and book_nbr in ( &quot; + books + &quot; )&quot;;</span>

<span class="nc" id="L384">			resultSet = statement.executeQuery(query);</span>

<span class="nc" id="L386">			String currOwner = null;</span>
<span class="nc" id="L387">			String bookNbr = null;</span>
<span class="nc" id="L388">			BookBean bean = null;</span>
<span class="nc" id="L389">			int currOwnerId = -1;</span>
<span class="nc bnc" id="L390" title="All 2 branches missed.">			while (resultSet.next()) {</span>
<span class="nc" id="L391">				currOwner = resultSet.getString(TableConstants.SGIS_CURR_OWNER);</span>
<span class="nc" id="L392">				currOwnerId = resultSet</span>
						.getInt(TableConstants.SGIS_CURR_OWNER_ID);
<span class="nc" id="L394">				bookNbr = resultSet.getString(TableConstants.SGIS_BOOK_NBR);</span>

<span class="nc bnc" id="L396" title="All 2 branches missed.">				for (int i = 0; i &lt; bookList.size(); i++) {</span>
<span class="nc" id="L397">					bean = bookList.get(i);</span>
<span class="nc bnc" id="L398" title="All 2 branches missed.">					if (bookNbr.equals(bean.getBookNumber())) {</span>

<span class="nc bnc" id="L400" title="All 6 branches missed.">						if (currOwner != null &amp;&amp; currOwner.equals(&quot;AGENT&quot;)</span>
								&amp;&amp; currOwnerId == agtOrgId) {
<span class="nc" id="L402">							bean.setValid(true);</span>
<span class="nc" id="L403">							bean.setStatus(null);</span>
						} else {
<span class="nc" id="L405">							isBookValid = false;</span>
<span class="nc" id="L406">							bean.setValid(false);</span>
<span class="nc" id="L407">							bean.setStatus(&quot;Wrong Book Number&quot;);</span>
						}
					}
					// isBookValid = isBookValid &amp;&amp; bean.getIsValid();
				}

			}

<span class="nc bnc" id="L415" title="All 2 branches missed.">			for (int i = 0; i &lt; bookList.size(); i++) {</span>
<span class="nc" id="L416">				bean = bookList.get(i);</span>
<span class="nc bnc" id="L417" title="All 4 branches missed.">				isBookValid = isBookValid &amp;&amp; bean.getIsValid();</span>
			}

<span class="nc bnc" id="L420" title="All 4 branches missed.">			if (resultSet != null &amp;&amp; !resultSet.previous()) {</span>

<span class="nc" id="L422">				isBookValid = false;</span>
			}

<span class="nc" id="L425">		} catch (SQLException e) {</span>

<span class="nc" id="L427">			e.printStackTrace();</span>
<span class="nc" id="L428">			throw new LMSException(e);</span>
		} finally {

<span class="nc" id="L431">			try {</span>

<span class="nc bnc" id="L433" title="All 4 branches missed.">				if (statement != null) {</span>
<span class="nc" id="L434">					statement.close();</span>
				}
				/*
				 * if (connection != null) { connection.close(); }
				 */
<span class="nc" id="L439">			} catch (SQLException se) {</span>
<span class="nc" id="L440">				se.printStackTrace();</span>
<span class="nc" id="L441">			}</span>
<span class="nc" id="L442">		}</span>

<span class="nc" id="L444">		System.out.println(&quot;isBookValid::&quot; + isBookValid);</span>
<span class="nc" id="L445">		return isBookValid;</span>
	}

	// Check Book Verification For PWT Tickets in main ticket table.
	public boolean verifyBookValidityWithPWT(int game_id, String bknbr,
			Connection conn, int gameNbr) {

<span class="nc" id="L452">		System.out</span>
				.println(&quot;Enter In To verify book with PWT ^^^^^^^^^^^^^^^^^^^^^^^&quot;);

<span class="nc" id="L455">		boolean bookPwtFlag = true;</span>
		//  
		// Connection conn=null;
		// conn= DBConnect.getConnection();
<span class="nc" id="L459">		String query6 = QueryManager.getST4BookOfTicketsOfPwt();</span>
		PreparedStatement stmt6;
		try {
<span class="nc" id="L462">			stmt6 = conn.prepareStatement(query6);</span>
<span class="nc" id="L463">			stmt6.setInt(1, gameNbr);</span>
<span class="nc" id="L464">			stmt6.setInt(2, game_id);</span>
<span class="nc" id="L465">			stmt6.setString(3, bknbr);</span>
<span class="nc" id="L466">			ResultSet rs = stmt6.executeQuery();</span>
<span class="nc bnc" id="L467" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L468">				bookPwtFlag = false;</span>
			}

<span class="nc bnc" id="L471" title="All 2 branches missed.">			if (bookPwtFlag == false) {</span>
<span class="nc" id="L472">				System.out.println(&quot;bookPwtFlag is not valid: &quot; + bookPwtFlag);</span>
			} else {
<span class="nc" id="L474">				System.out.println(&quot;bookPwtFlag is valid: &quot; + bookPwtFlag);</span>
			}

<span class="nc" id="L477">			System.out</span>
					.println(&quot;^^^^^^^^^^^^^^^^^^^^^^^^book verify for PWT is complete&quot;);
<span class="nc" id="L479">			return bookPwtFlag;</span>
<span class="nc" id="L480">		} catch (SQLException e) {</span>
			// TODO Auto-generated catch block
<span class="nc" id="L482">			e.printStackTrace();</span>
		}/*
			 * finally{ try{ if(conn!=null) conn.close(); }catch(SQLException
			 * se){ se.printStackTrace(); } }
			 */
<span class="nc" id="L487">		return bookPwtFlag;</span>
	}

	// Check Book Verification For PWT Tickets in temp ticket table.
	public boolean verifyBookValidityWithPWTTempTable(int game_id,
			String bknbr, Connection conn) {

<span class="nc" id="L494">		System.out</span>
				.println(&quot;Enter In To verify book with PWT ^^^^^^^^^^^^^^^^^^^^^^^&quot;);

<span class="nc" id="L497">		boolean bookPwtFlag = true;</span>
		//  
		// Connection conn=null;
		// conn= DBConnect.getConnection();
<span class="nc" id="L501">		String query6 = QueryManager.getST4BookOfTicketsOfPwtTmpTable();</span>
		PreparedStatement stmt6;
		try {
<span class="nc" id="L504">			stmt6 = conn.prepareStatement(query6);</span>
<span class="nc" id="L505">			stmt6.setInt(1, game_id);</span>
<span class="nc" id="L506">			stmt6.setString(2, bknbr);</span>
<span class="nc" id="L507">			ResultSet rs = stmt6.executeQuery();</span>
<span class="nc bnc" id="L508" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L509">				bookPwtFlag = false;</span>
			}

<span class="nc bnc" id="L512" title="All 2 branches missed.">			if (bookPwtFlag == false) {</span>
<span class="nc" id="L513">				System.out.println(&quot;bookPwtFlag is not valid: &quot; + bookPwtFlag);</span>
			} else {
<span class="nc" id="L515">				System.out.println(&quot;bookPwtFlag is valid: &quot; + bookPwtFlag);</span>
			}

<span class="nc" id="L518">			System.out</span>
					.println(&quot;^^^^^^^^^^^^^^^^^^^^^^^^book verify for PWT in temporary ticket table  is complete&quot;);
<span class="nc" id="L520">			return bookPwtFlag;</span>
<span class="nc" id="L521">		} catch (SQLException e) {</span>
			// TODO Auto-generated catch block
<span class="nc" id="L523">			e.printStackTrace();</span>
		}/*
			 * finally{ try{ if(conn!=null) conn.close(); }catch(SQLException
			 * se){ se.printStackTrace(); } }
			 */
<span class="nc" id="L528">		return bookPwtFlag;</span>
	}

	/**
	 * This method verifies the book and pack entries entered by the user
	 * 
	 * @param orderedGameBean
	 * @param packList
	 * @param bookList
	 * @param agtOrgId
	 * @return
	 * @throws LMSException
	 */
	public boolean verifyDispatchEntry(OrderedGameBean orderedGameBean,
			List&lt;PackBean&gt; packList, List&lt;BookBean&gt; bookList, int agtOrgId,
			List&lt;BookBean&gt; bookSeriesList) throws LMSException {

<span class="nc" id="L545">		int gameId = orderedGameBean.getGameId();</span>
		String books;
<span class="nc" id="L547">		boolean isPackValid = true;</span>
<span class="nc" id="L548">		boolean isBookValid = true;</span>

		// global connection to use for all verification

<span class="nc" id="L552">		Connection connection = null;</span>
		 
<span class="nc" id="L554">		connection = DBConnect.getConnection();</span>
		// verify entered packs
<span class="nc bnc" id="L556" title="All 2 branches missed.">		if (packList != null) {</span>
<span class="nc" id="L557">			removeBlanksFromPackList(packList);</span>
<span class="nc" id="L558">			isPackValid = verifyPacks(gameId, packList, agtOrgId, connection);</span>
		}

		// verify entered books
<span class="nc bnc" id="L562" title="All 2 branches missed.">		if (bookList != null) {</span>
<span class="nc" id="L563">			books = getBooks(bookList);</span>
<span class="nc" id="L564">			System.out.println(&quot;Books::&quot; + books);</span>

<span class="nc bnc" id="L566" title="All 2 branches missed.">			if (books != null) {</span>
<span class="nc" id="L567">				isBookValid = verifyBooks(gameId, books, bookList, agtOrgId,</span>
						connection);
			}
		}

		// check for duplicate books
<span class="nc" id="L573">		boolean isDuplicateBook = checkDuplicatePackBook(gameId, packList,</span>
				bookList, agtOrgId, connection);
<span class="nc" id="L575">		boolean isDuplicateBookSeries = checkDuplicatePackBook(gameId,</span>
				packList, bookSeriesList, agtOrgId, connection);
<span class="nc" id="L577">		System.out.println(&quot;nh^^^^^^^^^^^^^^^^&quot;);</span>
<span class="nc bnc" id="L578" title="All 2 branches missed.">		if (connection != null) {</span>
			try {
<span class="nc" id="L580">				connection.close();</span>
<span class="nc" id="L581">			} catch (SQLException e) {</span>
				// TODO Auto-generated catch block
<span class="nc" id="L583">				e.printStackTrace();</span>
<span class="nc" id="L584">			}</span>
		}
<span class="nc bnc" id="L586" title="All 6 branches missed.">		return isPackValid &amp;&amp; isBookValid &amp;&amp; isDuplicateBook;</span>
	}

	/**
	 * This method verifies if the passed pack is a valid pack
	 * 
	 * @param gameId
	 * @param agtOrgId
	 * @param packToVerify
	 * @return boolean
	 * @throws LMSException
	 */
	public boolean verifyPack(int gameId, int agtOrgId, String packToVerify,
			int gameNbr) throws LMSException {

<span class="nc" id="L601">		boolean isValid = false;</span>
<span class="nc" id="L602">		boolean ownercheck = false;</span>
<span class="nc" id="L603">		boolean pwtCheck = false;</span>
<span class="nc" id="L604">		boolean pwtCheckTemp = false;</span>
<span class="nc" id="L605">		Connection connection = null;</span>
		try {

<span class="nc" id="L608">			PreparedStatement pstmt = null;</span>
<span class="nc" id="L609">			ResultSet resultSet = null;</span>
			 
<span class="nc" id="L611">			connection = DBConnect.getConnection();</span>

			// query = QueryManager.getST1AgentPackInvVerifyQuery()+&quot; and
			// book_status!='MISSING'&quot;;
			// pstmt = connection.prepareStatement(query);

<span class="nc" id="L617">			String sqlQuery = &quot;select current_owner,current_owner_id, nbr_of_books_per_pack &quot;</span>
					+ &quot;from st_se_game_inv_status aa,  st_se_game_master bb where &quot;
					+ &quot; aa.game_id = bb.game_id and aa.game_id = ? and &quot;
					+ &quot; aa.pack_nbr = ? and (book_status!='MISSING' and book_status!='CLAIMED')&quot;;
<span class="nc" id="L621">			pstmt = connection.prepareStatement(sqlQuery);</span>

<span class="nc" id="L623">			pstmt.setInt(1, gameId);</span>
<span class="nc" id="L624">			pstmt.setString(2, packToVerify);</span>
<span class="nc" id="L625">			System.out.println(&quot;Arun === changed query &quot; + pstmt);</span>
<span class="nc" id="L626">			resultSet = pstmt.executeQuery();</span>

<span class="nc" id="L628">			String currOwner = null;</span>
<span class="nc" id="L629">			int currOwnerId = -1;</span>
<span class="nc" id="L630">			int noOfBooksPerPack = -1, count = 0;</span>
<span class="nc bnc" id="L631" title="All 2 branches missed.">			while (resultSet.next()) {</span>
<span class="nc" id="L632">				noOfBooksPerPack = resultSet.getInt(&quot;nbr_of_books_per_pack&quot;);</span>
<span class="nc" id="L633">				currOwner = resultSet.getString(TableConstants.SGIS_CURR_OWNER);</span>
<span class="nc" id="L634">				currOwnerId = resultSet</span>
						.getInt(TableConstants.SGIS_CURR_OWNER_ID);

<span class="nc bnc" id="L637" title="All 6 branches missed.">				if (currOwner != null &amp;&amp; currOwner.equals(&quot;AGENT&quot;)</span>
						&amp;&amp; currOwnerId == agtOrgId) {
<span class="nc" id="L639">					ownercheck = true;</span>
<span class="nc" id="L640">					count += 1;</span>
				} else {
<span class="nc" id="L642">					ownercheck = false;</span>
<span class="nc" id="L643">					break;</span>
				}
			}
<span class="nc" id="L646">			pwtCheck = verifyPackValidityWithPWT(gameId, packToVerify, gameNbr);</span>
<span class="nc" id="L647">			pwtCheckTemp = verifyPackValidityWithPWTTempTable(gameId,</span>
					packToVerify);

<span class="nc bnc" id="L650" title="All 6 branches missed.">			if (ownercheck == true &amp;&amp; pwtCheck == true &amp;&amp; pwtCheckTemp == true) {</span>
<span class="nc" id="L651">				isValid = true;</span>
			}
			// check for no of valid books is equal to noOfBooksPerPack
<span class="nc bnc" id="L654" title="All 4 branches missed.">			if (isValid &amp;&amp; noOfBooksPerPack != count) {</span>
<span class="nc" id="L655">				isValid = false;</span>
			}

<span class="nc" id="L658">		} catch (SQLException e) {</span>

<span class="nc" id="L660">			e.printStackTrace();</span>
<span class="nc" id="L661">			throw new LMSException(e);</span>
		} finally {
<span class="nc" id="L663">			try {</span>
<span class="nc bnc" id="L664" title="All 4 branches missed.">				if (connection != null) {</span>
<span class="nc" id="L665">					connection.close();</span>
				}
<span class="nc" id="L667">			} catch (SQLException se) {</span>
<span class="nc" id="L668">				se.printStackTrace();</span>
<span class="nc" id="L669">				throw new LMSException(se);</span>
<span class="nc" id="L670">			}</span>
		}

<span class="nc" id="L673">		return isValid;</span>
	}

	private boolean verifyPackBook(int gameId, String packs,
			List&lt;BookBean&gt; bookList, Connection connection) throws LMSException {

		// Connection connection = null;
<span class="nc" id="L680">		Statement statement = null;</span>
<span class="nc" id="L681">		ResultSet resultSet = null;</span>
<span class="nc" id="L682">		boolean isBookValid = true;</span>
		try {

			//  
			// connection = DBConnect.getConnection();
<span class="nc" id="L687">			statement = connection.createStatement();</span>

<span class="nc" id="L689">			String query = QueryManager.getST1AgentBookInvVerifyQuery();</span>

<span class="nc" id="L691">			query = query + gameId + &quot; and pack_nbr in ( &quot; + packs + &quot; )&quot;;</span>

<span class="nc" id="L693">			resultSet = statement.executeQuery(query);</span>

<span class="nc" id="L695">			String bookNbr = null;</span>
<span class="nc" id="L696">			BookBean bean = null;</span>
<span class="nc bnc" id="L697" title="All 2 branches missed.">			while (resultSet.next()) {</span>

<span class="nc" id="L699">				bookNbr = resultSet.getString(TableConstants.SGIS_BOOK_NBR);</span>

<span class="nc" id="L701">				System.out.println(&quot;Agent BookList size &quot; + bookList.size());</span>
<span class="nc bnc" id="L702" title="All 2 branches missed.">				for (int i = 0; i &lt; bookList.size(); i++) {</span>
<span class="nc" id="L703">					bean = bookList.get(i);</span>
<span class="nc bnc" id="L704" title="All 2 branches missed.">					if (bookNbr.equals(bean.getBookNumber())) {</span>

<span class="nc" id="L706">						isBookValid = false;</span>
<span class="nc" id="L707">						bean.setValid(false);</span>
<span class="nc" id="L708">						bean</span>
								.setStatus(&quot;Duplicate Book.This book is already part of the pack chosen above&quot;);

					} /*
						 * else { bean.setValid(true); bean.setStatus(null); }
						 */

				}

				// System.out.println(&quot;Iter&quot; + i + &quot; &quot; + isBookValid);
			}

<span class="nc bnc" id="L720" title="All 2 branches missed.">			for (int i = 0; i &lt; bookList.size(); i++) {</span>
<span class="nc" id="L721">				bean = bookList.get(i);</span>
<span class="nc bnc" id="L722" title="All 4 branches missed.">				isBookValid = isBookValid &amp;&amp; bean.getIsValid();</span>
			}

<span class="nc bnc" id="L725" title="All 4 branches missed.">			if (resultSet != null &amp;&amp; !resultSet.previous()) {</span>

<span class="nc" id="L727">				System.out.println(&quot;--making false---&quot;);</span>
<span class="nc" id="L728">				isBookValid = false;</span>
			}

<span class="nc" id="L731">		} catch (SQLException e) {</span>

<span class="nc" id="L733">			e.printStackTrace();</span>
<span class="nc" id="L734">			throw new LMSException(e);</span>

		} finally {

<span class="nc" id="L738">			try {</span>

<span class="nc bnc" id="L740" title="All 4 branches missed.">				if (statement != null) {</span>
<span class="nc" id="L741">					statement.close();</span>
				}
				/*
				 * if (connection != null) { connection.close(); }
				 */
<span class="nc" id="L746">			} catch (SQLException se) {</span>
<span class="nc" id="L747">				se.printStackTrace();</span>
<span class="nc" id="L748">			}</span>
<span class="nc" id="L749">		}</span>

<span class="nc" id="L751">		System.out.println(&quot;Agent isBookValid::&quot; + isBookValid);</span>
<span class="nc" id="L752">		return isBookValid;</span>

	}

	private boolean verifyPacks(int gameId, List&lt;PackBean&gt; packList,
			int agtOrgId, Connection connection) throws LMSException {

<span class="nc" id="L759">		boolean isPackValid = true;</span>
<span class="nc bnc" id="L760" title="All 4 branches missed.">		if (packList != null &amp;&amp; packList.size() &gt; 0) {</span>

<span class="nc" id="L762">			PackBean bean = null;</span>

			// Connection connection = null;
<span class="nc" id="L765">			PreparedStatement pstmt = null;</span>
<span class="nc" id="L766">			ResultSet resultSet = null;</span>

			try {

				//  
				// connection = DBConnect.getConnection();

				// String query = QueryManager.getST1AgentPackInvVerifyQuery()+&quot;
				// and book_status!='MISSING'&quot;;;
				// pstmt = connection.prepareStatement(query);
<span class="nc" id="L776">				String sqlQuery = &quot;select current_owner,current_owner_id, nbr_of_books_per_pack &quot;</span>
						+ &quot;from st_se_game_inv_status aa,  st_se_game_master bb where &quot;
						+ &quot; aa.game_id = bb.game_id and aa.game_id = ? and &quot;
						+ &quot; aa.pack_nbr = ? and (book_status!='MISSING' and book_status!='CLAIMED')&quot;;
<span class="nc" id="L780">				pstmt = connection.prepareStatement(sqlQuery);</span>

<span class="nc bnc" id="L782" title="All 2 branches missed.">				for (int i = 0; i &lt; packList.size(); i++) {</span>
<span class="nc" id="L783">					bean = packList.get(i);</span>
<span class="nc" id="L784">					pstmt.setInt(1, gameId);</span>
<span class="nc" id="L785">					pstmt.setString(2, bean.getPackNumber());</span>

<span class="nc" id="L787">					resultSet = null;</span>
<span class="nc" id="L788">					resultSet = pstmt.executeQuery();</span>

<span class="nc" id="L790">					System.out.println(&quot;Rs::----------------------------&quot;</span>
							+ resultSet);
<span class="nc bnc" id="L792" title="All 2 branches missed.">					if (resultSet == null) {</span>
<span class="nc" id="L793">						isPackValid = false;</span>
<span class="nc" id="L794">						System.out.println(&quot;ResultSet::&quot;</span>
								+ resultSet.getFetchSize());
					}

<span class="nc" id="L798">					String currOwner = null;</span>
<span class="nc" id="L799">					int currOwnerId = -1;</span>
<span class="nc" id="L800">					int noOfBooksPerPack = -1, count = 0;</span>
<span class="nc bnc" id="L801" title="All 2 branches missed.">					while (resultSet.next()) {</span>
<span class="nc" id="L802">						currOwner = resultSet</span>
								.getString(TableConstants.SGIS_CURR_OWNER);
<span class="nc" id="L804">						currOwnerId = resultSet</span>
								.getInt(TableConstants.SGIS_CURR_OWNER_ID);
<span class="nc" id="L806">						noOfBooksPerPack = resultSet</span>
								.getInt(&quot;nbr_of_books_per_pack&quot;);

<span class="nc" id="L809">						System.out.println(&quot;PackNbr::&quot; + bean.getPackNumber());</span>
<span class="nc" id="L810">						System.out.println(&quot;CurrOwner::&quot; + currOwner);</span>
<span class="nc bnc" id="L811" title="All 6 branches missed.">						if (currOwner != null &amp;&amp; currOwner.equals(&quot;AGENT&quot;)</span>
								&amp;&amp; currOwnerId == agtOrgId) {
<span class="nc" id="L813">							bean.setValid(true);</span>
<span class="nc" id="L814">							count += 1;</span>

						} else {
<span class="nc" id="L817">							isPackValid = false;</span>
<span class="nc" id="L818">							bean.setValid(false);</span>
<span class="nc" id="L819">							bean.setStatus(&quot;Wrong Pack Number&quot;);</span>
<span class="nc" id="L820">							break;</span>
						}
					}
					// check for no of valid books is equal to noOfBooksPerPack
<span class="nc bnc" id="L824" title="All 4 branches missed.">					if (bean.getIsValid() &amp;&amp; noOfBooksPerPack != count) {</span>
<span class="nc" id="L825">						bean.setValid(false);</span>
					}
<span class="nc bnc" id="L827" title="All 4 branches missed.">					if (resultSet != null &amp;&amp; !resultSet.previous()) {</span>

<span class="nc" id="L829">						isPackValid = false;</span>
					}

				}
<span class="nc" id="L833">			} catch (SQLException e) {</span>
<span class="nc" id="L834">				e.printStackTrace();</span>
<span class="nc" id="L835">				throw new LMSException(e);</span>
			} finally {

<span class="nc" id="L838">				try {</span>

<span class="nc bnc" id="L840" title="All 4 branches missed.">					if (pstmt != null) {</span>
<span class="nc" id="L841">						pstmt.close();</span>
					}
					/*
					 * if (connection != null) { connection.close(); }
					 */
<span class="nc" id="L846">				} catch (SQLException se) {</span>
<span class="nc" id="L847">					se.printStackTrace();</span>
<span class="nc" id="L848">				}</span>
<span class="nc" id="L849">			}</span>

		}
<span class="nc" id="L852">		System.out.println(&quot;isPackValid::&quot; + isPackValid);</span>
<span class="nc" id="L853">		return isPackValid;</span>
	}

	// Check Pack Verification For PWT tickets.
	public boolean verifyPackValidityWithPWT(int game_id, String pknbr,
			int gameNbr) throws LMSException {

<span class="nc" id="L860">		System.out</span>
				.println(&quot;Enter In To verify pack with PWT +++++++++++++++++++++++++++++&quot;);

<span class="nc" id="L863">		boolean packPwtFlag = true;</span>
		 
<span class="nc" id="L865">		Connection conn = null;</span>
<span class="nc" id="L866">		conn = DBConnect.getConnection();</span>
<span class="nc" id="L867">		String query6 = QueryManager</span>
				.getST4PWTDetailsForBookNbrUsingGamePackNbr();
		PreparedStatement stmt6;
		try {
<span class="nc" id="L871">			stmt6 = conn.prepareStatement(query6);</span>
<span class="nc" id="L872">			stmt6.setInt(1, gameNbr);</span>
<span class="nc" id="L873">			stmt6.setInt(2, game_id);</span>
<span class="nc" id="L874">			stmt6.setInt(3, game_id);</span>
<span class="nc" id="L875">			stmt6.setString(4, pknbr);</span>
<span class="nc" id="L876">			ResultSet rs = stmt6.executeQuery();</span>
<span class="nc bnc" id="L877" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L878">				packPwtFlag = false;</span>
			}
<span class="nc bnc" id="L880" title="All 2 branches missed.">			if (packPwtFlag == false) {</span>
<span class="nc" id="L881">				System.out.println(&quot;packPwtFlag is not valid: &quot; + packPwtFlag);</span>
			} else {
<span class="nc" id="L883">				System.out.println(&quot;packPwtFlag is valid: &quot; + packPwtFlag);</span>
			}

<span class="nc" id="L886">			System.out</span>
					.println(&quot;+++++++++++++++++++++ verify pack with PWT is complete&quot;);
<span class="nc" id="L888">			return packPwtFlag;</span>
<span class="nc" id="L889">		} catch (SQLException e) {</span>
			// TODO Auto-generated catch block
<span class="nc" id="L891">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L893">			try {</span>
<span class="nc bnc" id="L894" title="All 6 branches missed.">				if (conn != null) {</span>
<span class="nc" id="L895">					conn.close();</span>
				}
<span class="nc" id="L897">			} catch (SQLException se) {</span>
<span class="nc" id="L898">				se.printStackTrace();</span>
<span class="nc" id="L899">				throw new LMSException(se);</span>
<span class="nc" id="L900">			}</span>
		}

<span class="nc" id="L903">		return packPwtFlag;</span>
	}

	// Check Pack Verification For PWT tickets in temporary ticket table.
	public boolean verifyPackValidityWithPWTTempTable(int game_id, String pknbr) {

<span class="nc" id="L909">		System.out</span>
				.println(&quot;Enter In To verify pack with PWT +++++++++++++++++++++++++++++&quot;);

<span class="nc" id="L912">		boolean packPwtFlag = true;</span>
		 
<span class="nc" id="L914">		Connection conn = null;</span>
<span class="nc" id="L915">		conn = DBConnect.getConnection();</span>
<span class="nc" id="L916">		String query6 = QueryManager</span>
				.getST4PWTDetailsForBookNbrUsingGamePackNbrTempTable();
		PreparedStatement stmt6;
		try {
<span class="nc" id="L920">			stmt6 = conn.prepareStatement(query6);</span>
<span class="nc" id="L921">			stmt6.setInt(1, game_id);</span>
<span class="nc" id="L922">			stmt6.setInt(2, game_id);</span>
<span class="nc" id="L923">			stmt6.setString(3, pknbr);</span>
<span class="nc" id="L924">			ResultSet rs = stmt6.executeQuery();</span>
<span class="nc bnc" id="L925" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L926">				packPwtFlag = false;</span>
			}
<span class="nc bnc" id="L928" title="All 2 branches missed.">			if (packPwtFlag == false) {</span>
<span class="nc" id="L929">				System.out.println(&quot;packPwtFlag is not valid: &quot; + packPwtFlag);</span>
			} else {
<span class="nc" id="L931">				System.out.println(&quot;packPwtFlag is valid: &quot; + packPwtFlag);</span>
			}

<span class="nc" id="L934">			System.out</span>
					.println(&quot;+++++++++++++++++++++ verify pack with PWT is complete in temp ticket table &quot;);
<span class="nc" id="L936">			return packPwtFlag;</span>
<span class="nc" id="L937">		} catch (SQLException e) {</span>
			// TODO Auto-generated catch block
<span class="nc" id="L939">			e.printStackTrace();</span>
		} finally {

<span class="nc" id="L942">			try {</span>
<span class="nc bnc" id="L943" title="All 6 branches missed.">				if (conn != null) {</span>
<span class="nc" id="L944">					conn.close();</span>
				}
<span class="nc" id="L946">			} catch (SQLException e) {</span>
<span class="nc" id="L947">				e.printStackTrace();</span>
<span class="nc" id="L948">			}</span>
<span class="nc" id="L949">		}</span>

<span class="nc" id="L951">		return packPwtFlag;</span>
	}

	public List&lt;OrderBean&gt; dispatchOrderSearch(String gameName, String gameNumber, String agtOrgName, String orderNumber, int orgId,String challanId) throws LMSException {
<span class="nc" id="L955">		Connection connection = null;</span>
<span class="nc" id="L956">		Statement statement = null;</span>
<span class="nc" id="L957">		ResultSet resultSet = null;</span>
<span class="nc" id="L958">		List&lt;OrderBean&gt; searchResults = new ArrayList&lt;OrderBean&gt;();</span>
<span class="nc" id="L959">		OrderBean orderBean = null;</span>
		try {
<span class="nc" id="L961">			StringBuilder queryBuilder = new StringBuilder();</span>
<span class="nc" id="L962">			queryBuilder.append(&quot;SELECT sao.order_id, sao.retailer_org_id, som.name, sao.order_date, sao.order_status,generated_id FROM st_se_agent_order sao, st_se_agent_order_invoices saoi,st_se_agent_ordered_games sog, st_lms_agent_receipts lac,st_lms_organization_master som, st_se_game_master gm WHERE sao.retailer_org_id=som.organization_id AND sao.order_status IN('ASSIGNED','SEMI_ASSIGNED') AND sog.game_id=gm.game_id AND sao.order_id=sog.order_id and saoi.order_id=sao.order_id and lac.receipt_id=saoi.dc_id and sao.agent_org_id = &quot;+ orgId + &quot; &quot;);</span>
<span class="nc bnc" id="L963" title="All 4 branches missed.">			if(gameName!=null &amp;&amp; gameName.length()&gt;0)</span>
<span class="nc" id="L964">				queryBuilder.append(&quot; AND game_name LIKE '%&quot;).append(gameName).append(&quot;%'&quot;);</span>
<span class="nc bnc" id="L965" title="All 4 branches missed.">			if(gameNumber!=null &amp;&amp; gameNumber.length()&gt;0)</span>
<span class="nc" id="L966">				queryBuilder.append(&quot; AND game_nbr LIKE '%&quot;).append(gameNumber).append(&quot;%'&quot;);</span>
<span class="nc bnc" id="L967" title="All 4 branches missed.">			if(agtOrgName!=null &amp;&amp; agtOrgName.length()&gt;0)</span>
<span class="nc" id="L968">				queryBuilder.append(&quot; AND name LIKE '%&quot;).append(agtOrgName).append(&quot;%'&quot;);</span>
<span class="nc bnc" id="L969" title="All 4 branches missed.">			if(orderNumber!=null &amp;&amp; orderNumber.length()&gt;0)</span>
<span class="nc" id="L970">				queryBuilder.append(&quot; AND sao.order_id LIKE '%&quot;).append(orderNumber).append(&quot;%'&quot;);</span>
<span class="nc bnc" id="L971" title="All 4 branches missed.">			if(challanId!=null &amp;&amp; challanId.length()&gt;0)</span>
<span class="nc" id="L972">				queryBuilder.append(&quot; AND generated_id LIKE '%&quot;).append(challanId).append(&quot;%'&quot;);</span>
<span class="nc" id="L973">			queryBuilder.append(&quot; GROUP BY order_id;&quot;);</span>

<span class="nc" id="L975">			connection = DBConnect.getConnection();</span>
<span class="nc" id="L976">			statement = connection.createStatement();</span>
<span class="nc" id="L977">			logger.info(&quot;dispatchOrderSearch - &quot;+queryBuilder.toString());</span>
<span class="nc" id="L978">			resultSet = statement.executeQuery(queryBuilder.toString());</span>
<span class="nc bnc" id="L979" title="All 2 branches missed.">			while (resultSet.next()) {</span>
<span class="nc" id="L980">				orderBean = new OrderBean();</span>
<span class="nc" id="L981">				orderBean.setOrderId(resultSet.getInt(&quot;order_id&quot;));</span>
<span class="nc" id="L982">				orderBean.setAgentOrgId(resultSet.getInt(&quot;retailer_org_id&quot;));</span>
<span class="nc" id="L983">				orderBean.setAgentOrgName(resultSet.getString(&quot;name&quot;));</span>
<span class="nc" id="L984">				orderBean.setOrderDate(resultSet.getDate(&quot;order_date&quot;));</span>
<span class="nc" id="L985">				orderBean.setChallanId(resultSet.getString(&quot;generated_id&quot;));</span>
<span class="nc bnc" id="L986" title="All 2 branches missed.">				if (resultSet.getString(&quot;order_status&quot;).equalsIgnoreCase(&quot;APPROVED&quot;))</span>
<span class="nc" id="L987">					orderBean.setOrderStatus(&quot;Approved&quot;);</span>
<span class="nc bnc" id="L988" title="All 2 branches missed.">				if (resultSet.getString(&quot;order_status&quot;).equalsIgnoreCase(&quot;PROCESSED&quot;))</span>
<span class="nc" id="L989">					orderBean.setOrderStatus(&quot;Processed&quot;);</span>
<span class="nc bnc" id="L990" title="All 2 branches missed.">				if (resultSet.getString(&quot;order_status&quot;).equalsIgnoreCase(&quot;SEMI_PROCESSED&quot;))</span>
<span class="nc" id="L991">					orderBean.setOrderStatus(&quot;Semi Processed&quot;);</span>
<span class="nc bnc" id="L992" title="All 2 branches missed.">				if (resultSet.getString(&quot;order_status&quot;).equalsIgnoreCase(&quot;ASSIGNED&quot;))</span>
<span class="nc" id="L993">					orderBean.setOrderStatus(&quot;Assigned&quot;);</span>
<span class="nc bnc" id="L994" title="All 2 branches missed.">				if (resultSet.getString(&quot;order_status&quot;).equalsIgnoreCase(&quot;SEMI_ASSIGNED&quot;))</span>
<span class="nc" id="L995">					orderBean.setOrderStatus(&quot;Semi Assigned&quot;);</span>

<span class="nc" id="L997">				searchResults.add(orderBean);</span>
			}
<span class="nc" id="L999">		} catch (SQLException e) {</span>
<span class="nc" id="L1000">			e.printStackTrace();</span>
<span class="nc" id="L1001">			throw new LMSException(e);</span>
		} finally {
<span class="nc" id="L1003">			DBConnect.closeCon(connection);</span>
<span class="nc" id="L1004">			DBConnect.closeStmt(statement);</span>
<span class="nc" id="L1005">			DBConnect.closeRs(resultSet);</span>
<span class="nc" id="L1006">		}</span>

<span class="nc" id="L1008">		return searchResults;</span>
	}

	public DispatchOrderResponse getBookListFromOrderId(int orderId) {
<span class="nc" id="L1012">		Connection connection = null;</span>
<span class="nc" id="L1013">		Statement statement = null;</span>
<span class="nc" id="L1014">		ResultSet resultSet = null;</span>
<span class="nc" id="L1015">		DispatchOrderResponse dispatchOrderResponse = null ;</span>
<span class="nc" id="L1016">		Map&lt;String, Map&lt;String, List&lt;String&gt;&gt;&gt; gameMap = new HashMap&lt;String, Map&lt;String,List&lt;String&gt;&gt;&gt;();</span>
<span class="nc" id="L1017">		Map&lt;String, List&lt;String&gt;&gt; packMap = null;</span>
<span class="nc" id="L1018">		List&lt;String&gt; bookList = null;</span>
		try { 
<span class="nc" id="L1020">			connection = DBConnect.getConnection();</span>
<span class="nc" id="L1021">			statement = connection.createStatement();</span>
<span class="nc" id="L1022">			String query = &quot;SELECT gm.game_id, game_name, pack_nbr, book_nbr, gid.book_status FROM st_se_game_inv_detail gid INNER JOIN st_se_agent_order_invoices aoi ON gid.order_invoice_dc_id=aoi.order_invoice_dc_id INNER JOIN st_se_game_master gm ON gid.game_id=gm.game_id WHERE aoi.order_id=&quot;+orderId+&quot;;&quot;;</span>
<span class="nc" id="L1023">			System.out.println(&quot;getBookListFromOrderId - &quot;+query);</span>
<span class="nc" id="L1024">			resultSet = statement.executeQuery(query);</span>
<span class="nc bnc" id="L1025" title="All 2 branches missed.">			while (resultSet.next()) {</span>
<span class="nc bnc" id="L1026" title="All 2 branches missed.">				if(!&quot;ASSIGNED&quot;.equalsIgnoreCase(resultSet.getString(&quot;book_status&quot;))){</span>
<span class="nc" id="L1027">					return new DispatchOrderResponse(500);</span>
				}
<span class="nc bnc" id="L1029" title="All 2 branches missed.">				if(!gameMap.containsKey(resultSet.getString(&quot;game_name&quot;)))</span>
<span class="nc" id="L1030">					gameMap.put(resultSet.getString(&quot;game_name&quot;), new HashMap&lt;String, List&lt;String&gt;&gt;());</span>
<span class="nc" id="L1031">				packMap = gameMap.get(resultSet.getString(&quot;game_name&quot;));</span>

<span class="nc bnc" id="L1033" title="All 2 branches missed.">				if(!packMap.containsKey(resultSet.getString(&quot;pack_nbr&quot;)))</span>
<span class="nc" id="L1034">					packMap.put(resultSet.getString(&quot;pack_nbr&quot;), new ArrayList&lt;String&gt;());</span>
<span class="nc" id="L1035">				bookList = packMap.get(resultSet.getString(&quot;pack_nbr&quot;));</span>

<span class="nc" id="L1037">				bookList.add(resultSet.getString(&quot;book_nbr&quot;));</span>
<span class="nc" id="L1038">				dispatchOrderResponse = new DispatchOrderResponse(200, gameMap);</span>
			}
<span class="nc" id="L1040">		} catch (SQLException e) {</span>
<span class="nc" id="L1041">			e.printStackTrace();</span>
		} finally {
<span class="nc" id="L1043">			DBConnect.closeCon(connection);</span>
<span class="nc" id="L1044">			DBConnect.closeStmt(statement);</span>
<span class="nc" id="L1045">			DBConnect.closeRs(resultSet);</span>
<span class="nc" id="L1046">		}</span>

<span class="nc" id="L1048">		return dispatchOrderResponse;</span>
	}

	public void dispatchOrder(int orderId, int userOrgId, String userType, Map&lt;String, Map&lt;String, List&lt;String&gt;&gt;&gt; gameMap) {
<span class="nc" id="L1052">		Connection connection = null;</span>
<span class="nc" id="L1053">		Statement stmt = null;</span>
		try {
<span class="nc" id="L1055">			connection = DBConnect.getConnection();</span>
<span class="nc" id="L1056">			connection.setAutoCommit(false);</span>

<span class="nc" id="L1058">			stmt = connection.createStatement();</span>
<span class="nc" id="L1059">			stmt.executeUpdate(&quot;UPDATE st_se_agent_order SET order_status=(IF(order_status='SEMI_ASSIGNED','SEMI_PROCESSED','PROCESSED')) WHERE order_id=&quot;+orderId+&quot;;&quot;);</span>
<span class="nc" id="L1060">			stmt.executeUpdate(&quot;UPDATE st_se_agent_order_invoices SET order_status=(IF(order_status='SEMI_ASSIGNED','SEMI_PROCESSED','PROCESSED')) WHERE order_id=&quot;+orderId+&quot;;&quot;);</span>
<span class="nc bnc" id="L1061" title="All 2 branches missed.">			for(Map.Entry&lt;String, Map&lt;String, List&lt;String&gt;&gt;&gt; gameEntry : gameMap.entrySet())</span>
<span class="nc bnc" id="L1062" title="All 2 branches missed.">				for(Map.Entry&lt;String, List&lt;String&gt;&gt; packEntry : gameEntry.getValue().entrySet())</span>
<span class="nc bnc" id="L1063" title="All 2 branches missed.">					for(String book : packEntry.getValue()) {</span>
<span class="nc" id="L1064">						stmt.executeUpdate(&quot;UPDATE st_se_game_inv_status SET book_status='IN_TRANSIT' WHERE book_nbr='&quot;+book+&quot;';&quot;);</span>
<span class="nc" id="L1065">						stmt.executeUpdate(&quot;insert into st_se_game_inv_detail(game_id, pack_nbr, book_nbr, current_owner, current_owner_id, transaction_date, transaction_at, changed_by_user_id, book_status, warehouse_id, agent_invoice_id, ret_invoice_id) select game_id, pack_nbr, book_nbr, current_owner, current_owner_id, '&quot;+Util.getCurrentTimeString()+&quot;' transaction_date, '&quot;+userType+&quot;' transaction_at, &quot;+userOrgId+&quot; changed_by_user_id, 'IN_TRANSIT' book_status, warehouse_id, agent_invoice_id, ret_invoice_id from st_se_game_inv_status where  book_nbr='&quot;+book+&quot;'&quot;);</span>
<span class="nc" id="L1066">					}</span>
<span class="nc" id="L1067">			connection.commit();</span>
<span class="nc" id="L1068">		} catch (Exception ex) {</span>
<span class="nc" id="L1069">			ex.printStackTrace();</span>
		} finally {
<span class="nc" id="L1071">			DBConnect.closeCon(connection);</span>
<span class="nc" id="L1072">			DBConnect.closeStmt(stmt);</span>
<span class="nc" id="L1073">		}</span>
<span class="nc" id="L1074">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>