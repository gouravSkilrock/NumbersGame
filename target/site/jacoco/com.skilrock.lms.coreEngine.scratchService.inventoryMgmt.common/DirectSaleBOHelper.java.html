<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DirectSaleBOHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lms</a> &gt; <a href="index.source.html" class="el_package">com.skilrock.lms.coreEngine.scratchService.inventoryMgmt.common</a> &gt; <span class="el_source">DirectSaleBOHelper.java</span></div><h1>DirectSaleBOHelper.java</h1><pre class="source lang-java linenums">package com.skilrock.lms.coreEngine.scratchService.inventoryMgmt.common;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Set;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import com.skilrock.lms.beans.BookBean;
import com.skilrock.lms.common.db.DBConnect;
import com.skilrock.lms.common.db.QueryManager;
import com.skilrock.lms.common.db.TableConstants;
import com.skilrock.lms.common.exception.LMSException;
import com.skilrock.lms.common.utility.CommonMethods;
import com.skilrock.lms.common.utility.GenerateRecieptNo;
import com.skilrock.lms.common.utility.OrgCreditUpdation;
import com.skilrock.lms.coreEngine.reportsMgmt.common.GraphReportHelper;
import com.skilrock.lms.web.drawGames.common.Util;

<span class="nc" id="L29">public class DirectSaleBOHelper {</span>
<span class="nc" id="L30">private static Log logger = LogFactory.getLog(DirectSaleBOHelper.class);</span>
	public static void main(String[] args) throws LMSException {
<span class="nc" id="L32">		List&lt;String&gt; l1 = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L33">		List&lt;String&gt; l2 = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L34">		Map&lt;Integer, List&lt;String&gt;&gt; gameBookMap = new HashMap&lt;Integer, List&lt;String&gt;&gt;();</span>
<span class="nc" id="L35">		l1.add(&quot;111-001011&quot;);</span>
		// l1.add(&quot;111-001010&quot;);

<span class="nc" id="L38">		l2.add(&quot;500-002036&quot;);</span>
		// l2.add(&quot;500-002084&quot;);
<span class="nc" id="L40">		gameBookMap.put(52, l1);</span>
<span class="nc" id="L41">		gameBookMap.put(57, l2);</span>
<span class="nc" id="L42">		DirectSaleAgentHelper gg = new DirectSaleAgentHelper();</span>
		// gg.dispatchOrderDirectSale(gameBookMap,486,114,&quot;ANONYMOUS&quot;);

<span class="nc" id="L45">	}</span>
	
	public String dispatchOrderDirectSale(Map&lt;Integer, List&lt;String&gt;&gt; gameBookMap,
			int userId, int userOrgID, int orgId, String rootPath,
			String loggedInUserOrgName, String newBookStatus, Connection connection)
			throws LMSException {

<span class="nc" id="L52">		int DCId = -1;</span>
<span class="nc" id="L53">		int invoiceId = -1;</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">		if (gameBookMap != null) {</span>
<span class="nc" id="L55">			PreparedStatement agtOrdGameStmt = null;</span>
<span class="nc" id="L56">			PreparedStatement agtReceiptStmt = null;</span>
<span class="nc" id="L57">			PreparedStatement agtReceiptNoGenStmt = null;</span>
<span class="nc" id="L58">			PreparedStatement agtReceiptMappingStmt = null;</span>
<span class="nc" id="L59">			PreparedStatement agtOrderStmt = null;</span>

<span class="nc" id="L61">			PreparedStatement agtInvoiceDCMappingStmt = null;</span>

<span class="nc" id="L63">			PreparedStatement gameInvStatusStmt = null;</span>
<span class="nc" id="L64">			PreparedStatement gameInvDetailStmt = null;</span>
<span class="nc" id="L65">			PreparedStatement orderInvoicesPrtSt = null;</span>

<span class="nc" id="L67">			PreparedStatement getBookFromPackPstmt = null;</span>
<span class="nc" id="L68">			PreparedStatement isGovtCommChngdPstmt = null;</span>

<span class="nc" id="L70">			PreparedStatement orderPstmt = null;</span>

<span class="nc" id="L72">			ResultSet rsMaster = null;</span>
<span class="nc" id="L73">			String orderInvoicesQuery = null;</span>

<span class="nc" id="L75">			String agtAgentQuery = null;</span>
<span class="nc" id="L76">			String agtOrdGamesQuery = null;</span>
<span class="nc" id="L77">			String agtReceiptMappingQuery = null;</span>
<span class="nc" id="L78">			String agtOrderQuery = null;</span>

<span class="nc" id="L80">			String invQuery = null;</span>
<span class="nc" id="L81">			String gameInvDetailQuery = null;</span>
<span class="nc" id="L82">			String getBookfromPackQuery = null;</span>
<span class="nc" id="L83">			String isGovtCommChangedQuery = null;</span>
<span class="nc" id="L84">			String orderQuery = null;</span>

<span class="nc" id="L86">			List&lt;Integer&gt; trnIdList = new ArrayList&lt;Integer&gt;();</span>
<span class="nc" id="L87">			int masterTrnId = -1;</span>
			try {

<span class="nc" id="L90">				String boMasterQuery = QueryManager</span>
						.insertInBOTransactionMaster();
<span class="nc" id="L92">				PreparedStatement boMasterStmt = connection</span>
						.prepareStatement(boMasterQuery);

<span class="nc" id="L95">				String LMSMasterQuery = QueryManager</span>
						.insertInLMSTransactionMaster();
<span class="nc" id="L97">				PreparedStatement LMSMasterStmt = connection</span>
						.prepareStatement(LMSMasterQuery);

<span class="nc" id="L100">				String boAgentQuery = QueryManager.getST1BOAgentQuery();</span>
<span class="nc" id="L101">				PreparedStatement boAgentStmt = connection</span>
						.prepareStatement(boAgentQuery);

<span class="nc" id="L104">				String boOrdGamesQuery = QueryManager</span>
						.getST1BOOrdGamesUpdQuery();
<span class="nc" id="L106">				PreparedStatement boOrdGameStmt = connection</span>
						.prepareStatement(boOrdGamesQuery);

<span class="nc" id="L109">				String gameInvStatusQuery = QueryManager</span>
						.getST1BOUpdGameInvStatusQuery();

<span class="nc" id="L112">				agtOrdGamesQuery = QueryManager.getST1AgtOrdGamesUpdQuery();</span>
<span class="nc" id="L113">				agtOrdGameStmt = connection.prepareStatement(agtOrdGamesQuery);</span>

<span class="nc" id="L115">				java.sql.Timestamp currentDate = new java.sql.Timestamp(</span>
						new Date().getTime());

<span class="nc" id="L118">				agtReceiptMappingQuery = QueryManager</span>
						.insertAgentReceiptTrnMapping();
<span class="nc" id="L120">				agtReceiptMappingStmt = connection</span>
						.prepareStatement(agtReceiptMappingQuery);

<span class="nc" id="L123">				agtOrderQuery = QueryManager.getST1AgtOrdUpdQuery();</span>
<span class="nc" id="L124">				agtOrderStmt = connection.prepareStatement(agtOrderQuery);</span>

<span class="nc" id="L126">				gameInvDetailQuery = QueryManager.getST1InvDetailInsertQuery();</span>
<span class="nc" id="L127">				gameInvDetailStmt = connection</span>
						.prepareStatement(gameInvDetailQuery);

<span class="nc" id="L130">				orderInvoicesQuery = QueryManager.getST1OrderInInsertQuery();</span>
<span class="nc" id="L131">				orderInvoicesPrtSt = connection</span>
						.prepareStatement(orderInvoicesQuery);

<span class="nc" id="L134">				getBookfromPackQuery = &quot;select book_nbr from st_se_game_inv_status where pack_nbr=?&quot;;</span>
<span class="nc" id="L135">				getBookFromPackPstmt = connection</span>
						.prepareStatement(getBookfromPackQuery);

<span class="nc" id="L138">				isGovtCommChangedQuery = &quot;select count(*) from st_se_game_govt_comm_history where game_id=?&quot;;</span>
<span class="nc" id="L139">				isGovtCommChngdPstmt = connection</span>
						.prepareStatement(isGovtCommChangedQuery);

				// added by arun
<span class="nc" id="L143">				String fetchPurRateQuery = &quot;select transacrion_sale_comm_rate from st_se_game_inv_detail where &quot;</span>
						+ &quot;book_nbr=? and transaction_at='BO' order by transaction_date desc limit 1&quot;;
<span class="nc" id="L145">				PreparedStatement fetchPurRatePstmt = connection</span>
						.prepareStatement(fetchPurRateQuery);
<span class="nc" id="L147">				ResultSet fetchPurRateRs = null;</span>

<span class="nc" id="L149">				String detHistoryInsQuery = &quot;insert into st_se_game_ticket_inv_history(game_id, book_nbr, &quot;</span>
						+ &quot; current_owner, current_owner_id, date, done_by_oid, done_by_uid, cur_rem_tickets, &quot;
						+ &quot; active_tickets_upto, sold_tickets, status) values (?,?,?,?,?,?,?,?,?,?,?)&quot;;
<span class="nc" id="L152">				PreparedStatement detHistoryInsPstmt = connection</span>
						.prepareStatement(detHistoryInsQuery);

<span class="nc" id="L155">				double purRate = 0.0;</span>

<span class="nc" id="L157">				double mrpAmt = 0.0;</span>
				// double commAmt = 0.0;
<span class="nc" id="L159">				double netAmt = 0.0;</span>
<span class="nc" id="L160">				double vatAmt = 0.0;</span>
<span class="nc" id="L161">				double taxableSale = 0.0;</span>
				// double retSaleCommRate=0.0;
<span class="nc" id="L163">				double creditAmt = 0.0;</span>

<span class="nc" id="L165">				Statement stmt = connection.createStatement();</span>
<span class="nc" id="L166">				ResultSet rsRet = stmt.executeQuery(&quot;select organization_id,user_id from st_lms_user_master where organization_id=&quot;+orgId);</span>
<span class="nc" id="L167">				int agtUserId = -1;</span>
<span class="nc" id="L168">				int agtOrgId = -1;</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">				while (rsRet.next()) {</span>
<span class="nc" id="L170">					agtUserId = rsRet.getInt(&quot;user_id&quot;);</span>
<span class="nc" id="L171">					agtOrgId = rsRet.getInt(&quot;organization_id&quot;);</span>

				}

<span class="nc" id="L175">				int gameId = -1;</span>
<span class="nc" id="L176">				int orderId = -1;</span>
				// get order query

				// insert in receipt master for invoice
<span class="nc" id="L180">				agtReceiptStmt = connection.prepareStatement(QueryManager</span>
						.insertInReceiptMaster());
<span class="nc" id="L182">				agtReceiptStmt.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L183">				agtReceiptStmt.executeUpdate();</span>

<span class="nc" id="L185">				ResultSet rs = agtReceiptStmt.getGeneratedKeys();</span>
				
<span class="nc bnc" id="L187" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L188">					invoiceId = rs.getInt(1);</span>
				}
				// insert in receipt master for delivery challan
<span class="nc" id="L191">				agtReceiptStmt = connection.prepareStatement(QueryManager</span>
						.insertInReceiptMaster());
<span class="nc" id="L193">				agtReceiptStmt.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L194">				agtReceiptStmt.executeUpdate();</span>
<span class="nc" id="L195">				ResultSet DCrs = agtReceiptStmt.getGeneratedKeys();</span>
<span class="nc" id="L196">				DCId = -1;</span>
<span class="nc bnc" id="L197" title="All 2 branches missed.">				while (DCrs.next()) {</span>
<span class="nc" id="L198">					DCId = DCrs.getInt(1);</span>
				}

				// set parameters for insert into order table
<span class="nc" id="L202">				orderQuery = QueryManager.getST1InsertBOOrderQuery();</span>
<span class="nc" id="L203">				orderPstmt = connection.prepareStatement(orderQuery);</span>
<span class="nc" id="L204">				orderPstmt.setInt(1, agtUserId);</span>
<span class="nc" id="L205">				orderPstmt.setInt(2, agtOrgId);</span>
<span class="nc" id="L206">				orderPstmt.setDate(3, new java.sql.Date(new Date().getTime()));</span>
<span class="nc" id="L207">				orderPstmt.setString(4, &quot;AUTO_PROCESSED&quot;);</span>
<span class="nc" id="L208">				orderPstmt.setString(5, &quot;Y&quot;);</span>
<span class="nc" id="L209">				orderPstmt.execute();</span>
<span class="nc" id="L210">				ResultSet resultSet = orderPstmt.getGeneratedKeys();</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">				while (resultSet.next()) {</span>
<span class="nc" id="L212">					orderId = resultSet.getInt(1);</span>
				}
<span class="nc" id="L214">				logger.info(&quot;OrderId::&quot; + orderId);</span>

				// String newBookStatus = &quot;ACTIVE&quot;;

				// now we have to iterate for all games to enter ordered games
				// set parameters for insert into ordered games table
				// get ordered game query
<span class="nc" id="L221">				String gameQuery = QueryManager</span>
						.getST1AutoInsertBOOrderedGamesQuery();
<span class="nc" id="L223">				PreparedStatement gamePstmt = connection</span>
						.prepareStatement(gameQuery);
<span class="nc" id="L225">				Set&lt;Integer&gt; keySet = gameBookMap.keySet();</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">				for (int gameNbr : keySet) {</span>

<span class="nc" id="L228">					double bookPrice = 0.0;</span>
<span class="nc" id="L229">					double agt_sale_comm_rate = 0.0;</span>
<span class="nc" id="L230">					double agtGameCommVariance = 0.0;</span>
<span class="nc" id="L231">					double prizepayoutRatio = 0.0;</span>
<span class="nc" id="L232">					double vat = 0.0;</span>
<span class="nc" id="L233">					double fixed_amt = 0.0;</span>
<span class="nc" id="L234">					long tickets_in_scheme = 0l;</span>
<span class="nc" id="L235">					String govtCommRule = null;</span>
<span class="nc" id="L236">					double govt_comm_rate = 0.0;</span>
<span class="nc" id="L237">					boolean isGovtCommChanged = false;</span>
<span class="nc" id="L238">					int noOfTktPerBooks = -1;</span>
					// now get the game information from game ID

<span class="nc" id="L241">					ResultSet rsGame = stmt</span>
							.executeQuery(&quot;select * from st_se_game_master where game_nbr=&quot;
									+ gameNbr);
<span class="nc bnc" id="L244" title="All 2 branches missed.">					if (rsGame.next()) {</span>
<span class="nc" id="L245">						gameId = rsGame.getInt(&quot;game_id&quot;);</span>
<span class="nc" id="L246">						bookPrice = rsGame.getDouble(&quot;ticket_price&quot;)</span>
								* rsGame.getInt(&quot;nbr_of_tickets_per_book&quot;);
<span class="nc" id="L248">						noOfTktPerBooks = rsGame</span>
								.getInt(&quot;nbr_of_tickets_per_book&quot;);
<span class="nc" id="L250">						agt_sale_comm_rate = rsGame</span>
								.getDouble(&quot;agent_sale_comm_rate&quot;);
<span class="nc" id="L252">						prizepayoutRatio = rsGame</span>
								.getDouble(&quot;prize_payout_ratio&quot;);
<span class="nc" id="L254">						vat = rsGame.getDouble(&quot;vat_amt&quot;);</span>
<span class="nc" id="L255">						fixed_amt = rsGame.getDouble(&quot;fixed_amt&quot;);</span>
<span class="nc" id="L256">						tickets_in_scheme = rsGame.getLong(&quot;tickets_in_scheme&quot;);</span>
<span class="nc" id="L257">						govtCommRule = rsGame.getString(&quot;govt_comm_type&quot;);</span>
<span class="nc" id="L258">						govt_comm_rate = rsGame.getDouble(&quot;govt_comm_rate&quot;);</span>
					}

					// Insert the ordered game details into
<span class="nc" id="L262">					List&lt;String&gt; bookList = gameBookMap.get(gameNbr);</span>
<span class="nc" id="L263">					gamePstmt.setInt(1, orderId);</span>
<span class="nc" id="L264">					gamePstmt.setInt(2, gameId);</span>
<span class="nc" id="L265">					gamePstmt.setInt(3, bookList.size());</span>
<span class="nc" id="L266">					gamePstmt.setInt(4, bookList.size());</span>
<span class="nc" id="L267">					gamePstmt.execute();</span>

					// update delivered book list
<span class="nc" id="L270">					boOrdGameStmt.setInt(1, bookList.size());</span>
<span class="nc" id="L271">					boOrdGameStmt.setInt(2, orderId);</span>
<span class="nc" id="L272">					boOrdGameStmt.setInt(3, gameId);</span>
<span class="nc" id="L273">					boOrdGameStmt.execute();</span>

					// Fetch Commission variance of agent
<span class="nc" id="L276">					rsGame = stmt</span>
							.executeQuery(&quot;select sale_comm_variance from st_se_bo_agent_sale_pwt_comm_variance where agent_org_id=&quot;
									+ agtOrgId + &quot; and game_id=&quot; + gameId);
<span class="nc" id="L279">					System.out</span>
							.println(&quot;comm var query :: &quot;
									+ &quot;select sale_comm_variance from st_se_bo_agent_sale_pwt_comm_variance where agent_org_id=&quot;
									+ agtOrgId + &quot; and game_id=&quot; + gameId);
<span class="nc bnc" id="L283" title="All 2 branches missed.">					if (rsGame.next()) {</span>
<span class="nc" id="L284">						agtGameCommVariance = rsGame</span>
								.getDouble(&quot;sale_comm_variance&quot;);
					}
<span class="nc" id="L287">					logger.info(&quot;agtGameCommVariance==&quot;</span>
							+ agtGameCommVariance + &quot;  agt_sale_comm_rate==&quot;
							+ agt_sale_comm_rate);

					// insert in transaction master
<span class="nc" id="L292">					LMSMasterStmt.setString(1, &quot;BO&quot;);</span>
<span class="nc" id="L293">					LMSMasterStmt.executeUpdate();</span>
<span class="nc" id="L294">					rsMaster = null;</span>
<span class="nc" id="L295">					rsMaster = LMSMasterStmt.getGeneratedKeys();</span>

<span class="nc bnc" id="L297" title="All 2 branches missed.">					while (rsMaster.next()) {</span>
<span class="nc" id="L298">						masterTrnId = rsMaster.getInt(1);</span>
<span class="nc" id="L299">						trnIdList.add(masterTrnId);</span>
					}

					// insert in BO transaction master
<span class="nc" id="L303">					boMasterStmt.setInt(1, masterTrnId);</span>
<span class="nc" id="L304">					boMasterStmt.setInt(2, userId);</span>
<span class="nc" id="L305">					boMasterStmt.setInt(3, userOrgID);</span>
<span class="nc" id="L306">					boMasterStmt.setString(4, &quot;AGENT&quot;);</span>
<span class="nc" id="L307">					boMasterStmt.setInt(5, agtOrgId);</span>
<span class="nc" id="L308">					boMasterStmt.setTimestamp(6, currentDate);</span>
<span class="nc" id="L309">					boMasterStmt.setString(7, &quot;SALE&quot;);</span>
<span class="nc" id="L310">					boMasterStmt.execute();</span>

					// Insert into st_bo_agt_transaction_master
<span class="nc" id="L313">					boAgentStmt.setInt(1, masterTrnId);</span>
<span class="nc" id="L314">					boAgentStmt.setInt(2, bookList.size());</span>
<span class="nc" id="L315">					boAgentStmt.setInt(3, gameId);</span>
<span class="nc" id="L316">					boAgentStmt.setInt(4, agtOrgId);</span>
<span class="nc" id="L317">					mrpAmt = bookList.size() * bookPrice;</span>
<span class="nc" id="L318">					boAgentStmt.setDouble(5, mrpAmt);</span>

<span class="nc" id="L320">					double govtCommAmt = mrpAmt * govt_comm_rate * .01;</span>
<span class="nc" id="L321">					double agtSaleCommRate = agt_sale_comm_rate</span>
							+ agtGameCommVariance;
<span class="nc" id="L323">					double agtcommAmt = mrpAmt * agtSaleCommRate * 0.01;</span>
<span class="nc" id="L324">					logger.info(&quot;agtcommAmt===&quot; + agtcommAmt);</span>
<span class="nc" id="L325">					netAmt = mrpAmt - agtcommAmt;</span>
<span class="nc" id="L326">					creditAmt += netAmt;</span>

					// added by Arun to calculate vat amount
<span class="nc" id="L329">					vatAmt = CommonMethods.calculateVat(mrpAmt,</span>
							agtSaleCommRate, prizepayoutRatio, govt_comm_rate,
							vat, govtCommRule, fixed_amt, tickets_in_scheme);
<span class="nc" id="L332">					logger.info(&quot;mrp :&quot; + mrpAmt + &quot;ppr :&quot;</span>
							+ prizepayoutRatio + &quot;gov comm :&quot; + govt_comm_rate
							+ &quot;agt net comm :&quot; + agtSaleCommRate);

					/*
					 * taxableSale = (((mrpAmt * (100 - (agtSaleCommRate +
					 * prizepayoutRatio + govt_comm_rate))) / 100) * 100) / (100 +
					 * vat);
<span class="nc" id="L340">					 */taxableSale = CommonMethods.calTaxableSale(mrpAmt,</span>
							agtSaleCommRate, prizepayoutRatio, govt_comm_rate,
							vat);

<span class="nc" id="L344">					logger.info(&quot;vat amount is :  &quot; + vatAmt</span>
							+ &quot;\ntaxable sale is  : &quot; + taxableSale);

<span class="nc" id="L347">					boAgentStmt.setDouble(6, agtcommAmt);</span>
<span class="nc" id="L348">					boAgentStmt.setDouble(7, netAmt);</span>
<span class="nc" id="L349">					boAgentStmt.setString(8, &quot;SALE&quot;);</span>

<span class="nc" id="L351">					boAgentStmt.setDouble(9, vatAmt);</span>
<span class="nc" id="L352">					boAgentStmt.setDouble(10, taxableSale);</span>
<span class="nc" id="L353">					boAgentStmt.setDouble(11, govtCommAmt);</span>
<span class="nc" id="L354">					boAgentStmt.execute();</span>

<span class="nc" id="L356">					int orderInvoiceDCId = 0;</span>
<span class="nc" id="L357">					orderInvoicesPrtSt.setInt(1, orderId);</span>
<span class="nc" id="L358">					orderInvoicesPrtSt.setInt(2, invoiceId);</span>
<span class="nc" id="L359">					orderInvoicesPrtSt.setInt(3, agtOrgId);</span>
<span class="nc" id="L360">					orderInvoicesPrtSt.setInt(4, gameId);</span>
<span class="nc" id="L361">					orderInvoicesPrtSt.setString(5, &quot;AUTO_PROCESSED&quot;);</span>
<span class="nc" id="L362">					orderInvoicesPrtSt.setInt(6, bookList.size());</span>
<span class="nc" id="L363">					orderInvoicesPrtSt.setInt(7, DCId);</span>
<span class="nc" id="L364">					orderInvoicesPrtSt.execute();</span>
<span class="nc" id="L365">					rs = orderInvoicesPrtSt.getGeneratedKeys();</span>
<span class="nc bnc" id="L366" title="All 2 branches missed.">					while (rs.next()) {</span>
<span class="nc" id="L367">						orderInvoiceDCId = rs.getInt(1);</span>
					}

<span class="nc bnc" id="L370" title="All 2 branches missed.">					if (bookList != null) {</span>
<span class="nc" id="L371">						invQuery = gameInvStatusQuery + &quot; and book_nbr = ? &quot;;</span>
<span class="nc" id="L372">						gameInvStatusStmt = connection</span>
								.prepareStatement(invQuery);
<span class="nc" id="L374">						String bookNbr = null;</span>
<span class="nc" id="L375">						String packNbr = null;</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">						for (int j = 0; j &lt; bookList.size(); j++) {</span>
<span class="nc" id="L377">							bookNbr = bookList.get(j);</span>
<span class="nc" id="L378">							gameInvStatusStmt.setString(1, &quot;AGENT&quot;);</span>
<span class="nc" id="L379">							gameInvStatusStmt.setInt(2, agtOrgId);</span>
<span class="nc" id="L380">							gameInvStatusStmt.setString(3, newBookStatus);</span>

							// Added by arun on update status table
<span class="nc" id="L383">							gameInvStatusStmt.setInt(4, noOfTktPerBooks);</span>
<span class="nc bnc" id="L384" title="All 2 branches missed.">							if (&quot;ACTIVE&quot;.equalsIgnoreCase(newBookStatus.trim())) {</span>
<span class="nc" id="L385">								gameInvStatusStmt.setInt(5, noOfTktPerBooks);</span>
							} else {
<span class="nc" id="L387">								gameInvStatusStmt.setInt(5, 0);</span>
							}
<span class="nc" id="L389">							gameInvStatusStmt.setString(6, String.valueOf(DCId));</span>
<span class="nc" id="L390">							gameInvStatusStmt.setInt(7, gameId);</span>
<span class="nc" id="L391">							gameInvStatusStmt.setString(8, bookNbr);</span>
<span class="nc" id="L392">							gameInvStatusStmt.execute();</span>

<span class="nc" id="L394">							packNbr = getPackNbrForBook(connection, gameId,</span>
									bookNbr);

<span class="nc" id="L397">							gameInvDetailStmt.setInt(1, masterTrnId);</span>
<span class="nc" id="L398">							gameInvDetailStmt.setInt(2, gameId);</span>
<span class="nc" id="L399">							gameInvDetailStmt.setString(3, packNbr);</span>
<span class="nc" id="L400">							gameInvDetailStmt.setString(4, bookNbr);</span>
<span class="nc" id="L401">							gameInvDetailStmt.setString(5, &quot;AGENT&quot;);</span>
<span class="nc" id="L402">							gameInvDetailStmt.setInt(6, agtOrgId);</span>
<span class="nc" id="L403">							gameInvDetailStmt.setTimestamp(7, currentDate);</span>
<span class="nc" id="L404">							gameInvDetailStmt.setString(8, &quot;BO&quot;);</span>
<span class="nc" id="L405">							gameInvDetailStmt.setString(9, newBookStatus);</span>
							//gameInvDetailStmt.setDouble(9, agtSaleCommRate);
							//gameInvDetailStmt.setDouble(10, govt_comm_rate);
<span class="nc" id="L408">							gameInvDetailStmt.setInt(10, orderInvoiceDCId);</span>
<span class="nc" id="L409">							gameInvDetailStmt.setInt(11, fetchWarehouseId(bookNbr, connection));</span>
<span class="nc" id="L410">							gameInvDetailStmt.execute();</span>

							// insert into detail history table Added by arun
<span class="nc" id="L413">							detHistoryInsPstmt.setInt(1, gameId);</span>
<span class="nc" id="L414">							detHistoryInsPstmt.setString(2, bookNbr);</span>
<span class="nc" id="L415">							detHistoryInsPstmt.setString(3, &quot;AGENT&quot;);</span>
<span class="nc" id="L416">							detHistoryInsPstmt.setInt(4, agtOrgId);</span>
<span class="nc" id="L417">							detHistoryInsPstmt.setTimestamp(5, currentDate);</span>
<span class="nc" id="L418">							detHistoryInsPstmt.setInt(6, userOrgID);</span>
<span class="nc" id="L419">							detHistoryInsPstmt.setInt(7, userId);</span>
<span class="nc" id="L420">							detHistoryInsPstmt.setInt(8, noOfTktPerBooks);</span>
<span class="nc bnc" id="L421" title="All 2 branches missed.">							if (&quot;ACTIVE&quot;.equalsIgnoreCase(newBookStatus.trim())) {</span>
<span class="nc" id="L422">								detHistoryInsPstmt.setInt(9, noOfTktPerBooks);</span>
							} else {
<span class="nc" id="L424">								detHistoryInsPstmt.setInt(9, 0);</span>
							}
<span class="nc" id="L426">							detHistoryInsPstmt.setInt(10, 0);</span>
<span class="nc" id="L427">							detHistoryInsPstmt.setString(11, newBookStatus);</span>
							// logger.info(&quot;detHistoryInsPstmt ==
							// &quot;+detHistoryInsPstmt);
<span class="nc" id="L430">							detHistoryInsPstmt.execute();</span>
							// ---------------------

						}
					}

<span class="nc" id="L436">					System.out</span>
							.println(&quot;Total aaproved and total dispatched are equal----PROCESSED&quot;);

<span class="nc" id="L439">				}</span>

<span class="nc" id="L441">				String lastRecieptNoGenerated = null, autoGeneRecieptNo = null;</span>

<span class="nc" id="L443">				PreparedStatement boReceiptNoGenStmt = connection</span>
						.prepareStatement(QueryManager.getBOLatestReceiptNb());
<span class="nc" id="L445">				boReceiptNoGenStmt.setString(1, &quot;INVOICE&quot;);</span>
<span class="nc" id="L446">				ResultSet recieptRs = boReceiptNoGenStmt.executeQuery();</span>
<span class="nc bnc" id="L447" title="All 2 branches missed.">				while (recieptRs.next()) {</span>
<span class="nc" id="L448">					lastRecieptNoGenerated = recieptRs</span>
							.getString(&quot;generated_id&quot;);
				}
<span class="nc" id="L451">				autoGeneRecieptNo = GenerateRecieptNo.getRecieptNo(&quot;INVOICE&quot;,</span>
						lastRecieptNoGenerated, &quot;BO&quot;);

<span class="nc" id="L454">				String lastDCNoGenerated = null, autoGeneDCNo = null;</span>
<span class="nc" id="L455">				boReceiptNoGenStmt = connection.prepareStatement(QueryManager</span>
						.getBOLatestReceiptNb());
<span class="nc" id="L457">				boReceiptNoGenStmt.setString(1, &quot;DLCHALLAN&quot;);</span>
<span class="nc" id="L458">				ResultSet DCRs = boReceiptNoGenStmt.executeQuery();</span>

<span class="nc bnc" id="L460" title="All 2 branches missed.">				while (DCRs.next()) {</span>
<span class="nc" id="L461">					lastDCNoGenerated = DCRs.getString(&quot;generated_id&quot;);</span>
				}
<span class="nc" id="L463">				autoGeneDCNo = GenerateRecieptNo.getRecieptNo(&quot;DLCHALLAN&quot;,</span>
						lastDCNoGenerated, &quot;BO&quot;);
<span class="nc" id="L465">				logger.info(&quot;lastDCNoGenerated &quot; + lastDCNoGenerated</span>
						+ &quot;autoGeneDCNo &quot; + autoGeneDCNo);

				// insert into BO receipt table
<span class="nc" id="L469">				PreparedStatement boReceiptStmt = connection</span>
						.prepareStatement(QueryManager.insertInBOReceipts());
<span class="nc" id="L471">				boReceiptStmt.setInt(1, invoiceId);</span>
<span class="nc" id="L472">				boReceiptStmt.setString(2, &quot;INVOICE&quot;);</span>
<span class="nc" id="L473">				boReceiptStmt.setInt(3, agtOrgId);</span>
<span class="nc" id="L474">				boReceiptStmt.setString(4, &quot;AGENT&quot;);</span>
<span class="nc" id="L475">				boReceiptStmt.setString(5, autoGeneRecieptNo);</span>
<span class="nc" id="L476">				boReceiptStmt.setTimestamp(6, Util.getCurrentTimeStamp());</span>
<span class="nc" id="L477">				logger.info(&quot;bo invoice receipt = &quot; + boReceiptStmt);</span>
<span class="nc" id="L478">				boReceiptStmt.execute();</span>

				// insert into BO receipt table for delivery challan
<span class="nc" id="L481">				boReceiptStmt = connection.prepareStatement(QueryManager</span>
						.insertInBOReceipts());
<span class="nc" id="L483">				boReceiptStmt.setInt(1, DCId);</span>
<span class="nc" id="L484">				boReceiptStmt.setString(2, &quot;DLCHALLAN&quot;);</span>
<span class="nc" id="L485">				boReceiptStmt.setInt(3, agtOrgId);</span>
<span class="nc" id="L486">				boReceiptStmt.setString(4, &quot;AGENT&quot;);</span>
<span class="nc" id="L487">				boReceiptStmt.setString(5, autoGeneDCNo);</span>
<span class="nc" id="L488">				boReceiptStmt.setTimestamp(6, Util.getCurrentTimeStamp());</span>
<span class="nc" id="L489">				logger.info(&quot;bo DL receipt = &quot; + boReceiptStmt);</span>
<span class="nc" id="L490">				boReceiptStmt.execute();</span>

<span class="nc" id="L492">				String boReceiptMappingQuery = QueryManager</span>
						.insertBOReceiptTrnMapping();
<span class="nc" id="L494">				PreparedStatement boReceiptMappingStmt = connection</span>
						.prepareStatement(boReceiptMappingQuery);
				// insert for receipt and transaction mapping table for Invoice
<span class="nc bnc" id="L497" title="All 2 branches missed.">				for (int i = 0; i &lt; trnIdList.size(); i++) {</span>
<span class="nc" id="L498">					boReceiptMappingStmt.setInt(1, invoiceId);</span>
<span class="nc" id="L499">					boReceiptMappingStmt.setInt(2, trnIdList.get(i));</span>
<span class="nc" id="L500">					boReceiptMappingStmt.execute();</span>
				}
				// insert for receipt and transaction mapping table for delivery
				// challan
<span class="nc bnc" id="L504" title="All 2 branches missed.">				for (int i = 0; i &lt; trnIdList.size(); i++) {</span>
<span class="nc" id="L505">					boReceiptMappingStmt.setInt(1, DCId);</span>
<span class="nc" id="L506">					boReceiptMappingStmt.setInt(2, trnIdList.get(i));</span>
<span class="nc" id="L507">					boReceiptMappingStmt.execute();</span>
				}

				// insert into invoice and delivery challan mapping table
<span class="nc" id="L511">				String insertInvoiceDCMapping = &quot;insert into st_se_bo_invoice_delchallan_mapping(id,generated_invoice_id,generated_del_challan_id) values(?,?,?)&quot;;</span>
<span class="nc" id="L512">				PreparedStatement boInvoiceDCMappingStmt = connection</span>
						.prepareStatement(insertInvoiceDCMapping);
<span class="nc" id="L514">				boInvoiceDCMappingStmt.setInt(1, invoiceId);</span>
<span class="nc" id="L515">				boInvoiceDCMappingStmt.setString(2, autoGeneRecieptNo);</span>
<span class="nc" id="L516">				boInvoiceDCMappingStmt.setString(3, autoGeneDCNo);</span>
<span class="nc" id="L517">				boInvoiceDCMappingStmt.executeUpdate();</span>

				// for org credit updation
<span class="nc" id="L520">				logger.info(&quot;Org Id For Credit Update:&quot; + agtOrgId + &quot;:&quot;</span>
						+ creditAmt);
				
<span class="nc" id="L523">				boolean isValid=OrgCreditUpdation.updateOrganizationBalWithValidate(creditAmt, &quot;TRANSACTION&quot;, &quot;SALE&quot;, agtOrgId,</span>
						0, &quot;AGENT&quot;, 0, connection);
				
<span class="nc bnc" id="L526" title="All 2 branches missed.">				if(!isValid)</span>
<span class="nc" id="L527">					throw new LMSException();</span>
				
				/*boolean isUpdateDone = OrgCreditUpdation
						.updateCreditLimitForAgent(agtOrgId, &quot;SALE&quot;, creditAmt,
								connection);*/

//				connection.commit();
				// session.setAttribute(&quot;DEL_CHALLAN_ID&quot;, DCId);
//				if (invoiceId &gt; -1) {
//					GraphReportHelper graphReportHelper = new GraphReportHelper();
//					graphReportHelper.createTextReportBO(invoiceId,
//							loggedInUserOrgName, userOrgID, rootPath);
//				}
				// return DCId;
<span class="nc" id="L541">			} catch (SQLException se) {</span>
				try {
<span class="nc" id="L543">					connection.rollback();</span>

<span class="nc" id="L545">				} catch (SQLException e) {</span>
<span class="nc" id="L546">					e.printStackTrace();</span>
<span class="nc" id="L547">					throw new LMSException(&quot;Error During Rollback&quot;, e);</span>
<span class="nc" id="L548">				}</span>
<span class="nc" id="L549">				se.printStackTrace();</span>
<span class="nc" id="L550">				throw new LMSException(se);</span>
<span class="nc" id="L551">			}</span>
		}
<span class="nc" id="L553">		return String.valueOf(DCId) + &quot;Nxt&quot; + String.valueOf(invoiceId);</span>
	}
	
	
private int fetchWarehouseId(String bookNbr, Connection conn) {
<span class="nc" id="L558">	Statement statement = null;</span>
<span class="nc" id="L559">	ResultSet rs = null;</span>
<span class="nc" id="L560">	int warehouseId=0;</span>
	try {
<span class="nc" id="L562">		String query = &quot;select warehouse_id from st_se_game_inv_status where book_nbr = '&quot;+bookNbr+&quot;';&quot; ;</span>
<span class="nc" id="L563">		statement = conn.createStatement();</span>
<span class="nc" id="L564">		rs = statement.executeQuery(query);</span>
<span class="nc bnc" id="L565" title="All 2 branches missed.">		if(rs.next())</span>
<span class="nc" id="L566">			warehouseId = rs.getInt(&quot;warehouse_id&quot;);</span>
<span class="nc" id="L567">	} catch (Exception e) {</span>
<span class="nc" id="L568">		logger.info(&quot;Exception occurred due to : &quot;+e.getMessage());</span>
	} finally{
<span class="nc" id="L570">		DBConnect.closeResource(statement, rs);</span>
<span class="nc" id="L571">	}</span>
<span class="nc" id="L572">		return warehouseId;</span>
	}

/**
 * @changed agentOrgName to orgId during orgCode implementation
 * @param gameBookMap
 * @param userId
 * @param userOrgID
 * @param orgId
 * @param rootPath
 * @param loggedInUserOrgName
 * @param newBookStatus
 * @return
 * @throws LMSException
 */
	public int dispatchOrderDirectSale(Map&lt;Integer, List&lt;String&gt;&gt; gameBookMap,
			int userId, int userOrgID, int orgId, String rootPath,
			String loggedInUserOrgName, String newBookStatus)
			throws LMSException {
<span class="nc" id="L591">		int invoiceId = 0;</span>
<span class="nc" id="L592">		Connection connection = null;</span>
<span class="nc" id="L593">		String returnValue = null;</span>
<span class="nc" id="L594">		int DCId = -1;</span>
<span class="nc bnc" id="L595" title="All 2 branches missed.">		if (gameBookMap != null) {			</span>
			try {
<span class="nc" id="L597">				connection = DBConnect.getConnection();</span>
<span class="nc" id="L598">				connection.setAutoCommit(false);</span>
<span class="nc" id="L599">				returnValue = dispatchOrderDirectSale(gameBookMap, userId, userOrgID, orgId, rootPath,</span>
						loggedInUserOrgName, newBookStatus, connection);
<span class="nc" id="L601">				connection.commit();</span>
<span class="nc" id="L602">				DCId = Integer.parseInt(returnValue.split(&quot;Nxt&quot;)[0]);</span>
<span class="nc" id="L603">				invoiceId = Integer.parseInt(returnValue.split(&quot;Nxt&quot;)[1]);</span>
<span class="nc bnc" id="L604" title="All 2 branches missed.">				if (invoiceId &gt; -1) {</span>
<span class="nc" id="L605">					GraphReportHelper graphReportHelper = new GraphReportHelper();</span>
<span class="nc" id="L606">					graphReportHelper.createTextReportBO(invoiceId,</span>
							loggedInUserOrgName, userOrgID, rootPath);
				}
<span class="nc" id="L609">			} catch (SQLException se) {</span>
				try {
<span class="nc" id="L611">					connection.rollback();</span>

<span class="nc" id="L613">				} catch (SQLException e) {</span>
<span class="nc" id="L614">					e.printStackTrace();</span>
<span class="nc" id="L615">					throw new LMSException(&quot;Error During Rollback&quot;, e);</span>
<span class="nc" id="L616">				}</span>
<span class="nc" id="L617">				se.printStackTrace();</span>
<span class="nc" id="L618">				throw new LMSException(se);</span>
			} finally {
<span class="nc" id="L620">				try {</span>
<span class="nc bnc" id="L621" title="All 4 branches missed.">					if (connection != null) {</span>
<span class="nc" id="L622">						connection.close();</span>
					}
<span class="nc" id="L624">				} catch (SQLException se) {</span>
<span class="nc" id="L625">					se.printStackTrace();</span>
<span class="nc" id="L626">					throw new LMSException(se);</span>
<span class="nc" id="L627">				}</span>
			}
		}
<span class="nc" id="L630">		return DCId;</span>
	}

	public List&lt;String&gt; getGames() throws LMSException {
<span class="nc" id="L634">		List&lt;String&gt; gameList = new ArrayList&lt;String&gt;();</span>
		 
<span class="nc" id="L636">		Connection con = null;</span>
<span class="nc" id="L637">		Statement stmt = null;</span>
		try {
<span class="nc" id="L639">			con = DBConnect.getConnection();</span>
<span class="nc" id="L640">			stmt = con.createStatement();</span>

<span class="nc" id="L642">			ResultSet rsGame = stmt</span>
					.executeQuery(&quot;select game_name,game_nbr from st_se_game_master where game_status='OPEN'&quot;);
<span class="nc bnc" id="L644" title="All 2 branches missed.">			while (rsGame.next()) {</span>
<span class="nc" id="L645">				gameList.add(rsGame.getString(&quot;game_name&quot;) + &quot;-&quot;</span>
						+ rsGame.getString(&quot;game_nbr&quot;));
			}
<span class="nc" id="L648">			return gameList;</span>
<span class="nc" id="L649">		} catch (SQLException e) {</span>
<span class="nc" id="L650">			e.printStackTrace();</span>
<span class="nc" id="L651">			throw new LMSException(&quot;sql exception&quot;, e);</span>
		}
	}

	public String getPackNbrForBook(Connection connection, int gameId,
			String bookNbr) throws SQLException {

<span class="nc" id="L658">		String bookQuery = null;</span>
<span class="nc" id="L659">		PreparedStatement bookStmt = null;</span>
<span class="nc" id="L660">		String packNbr = null;</span>

<span class="nc" id="L662">		bookQuery = QueryManager.getST1PackForBook();</span>
<span class="nc" id="L663">		bookStmt = connection.prepareStatement(bookQuery);</span>

<span class="nc" id="L665">		bookStmt.setInt(1, gameId);</span>
<span class="nc" id="L666">		bookStmt.setString(2, bookNbr);</span>

<span class="nc" id="L668">		ResultSet rs = bookStmt.executeQuery();</span>
<span class="nc bnc" id="L669" title="All 2 branches missed.">		while (rs.next()) {</span>
<span class="nc" id="L670">			packNbr = rs.getString(TableConstants.SGIS_PACK_NBR);</span>
		}
<span class="nc" id="L672">		return packNbr;</span>

	}

	public List&lt;String&gt; getRetailers(int parent_id) throws LMSException {
<span class="nc" id="L677">		List&lt;String&gt; retailerList = new ArrayList&lt;String&gt;();</span>
		 
<span class="nc" id="L679">		Connection con = null;</span>
<span class="nc" id="L680">		Statement stmt = null;</span>
		try {
<span class="nc" id="L682">			con = DBConnect.getConnection();</span>
<span class="nc" id="L683">			stmt = con.createStatement();</span>
<span class="nc" id="L684">			ResultSet rsRet = stmt</span>
					.executeQuery(&quot;select name from st_lms_organization_master where organization_type='RETAILER' and parent_id=&quot;
							+ parent_id);
			// ResultSet rsGame=stmt.executeQuery(&quot;select game_name from
			// st_se_game_master where game_status='OPEN'&quot;);
<span class="nc bnc" id="L689" title="All 2 branches missed.">			while (rsRet.next()) {</span>
<span class="nc" id="L690">				retailerList.add(rsRet.getString(&quot;name&quot;));</span>
			}
<span class="nc" id="L692">			return retailerList;</span>
<span class="nc" id="L693">		} catch (SQLException e) {</span>
<span class="nc" id="L694">			e.printStackTrace();</span>
<span class="nc" id="L695">			throw new LMSException(&quot;sql exception&quot;, e);</span>
		}
	}

	public boolean getSalePrice(Map&lt;Integer, List&lt;String&gt;&gt; dispatchMap,
			int organizationId) throws LMSException {

		// boolean isDispatch=false;
		 
<span class="nc" id="L704">		Connection con = DBConnect.getConnection();</span>
<span class="nc" id="L705">		Statement stmt = null;</span>
<span class="nc" id="L706">		Statement stmt1 = null;</span>
<span class="nc" id="L707">		ResultSet rs = null;</span>
<span class="nc" id="L708">		ResultSet rs1 = null;</span>
<span class="nc" id="L709">		double totalGamebooksAmount = 0.0;</span>
		try {

<span class="nc" id="L712">			stmt = con.createStatement();</span>
<span class="nc" id="L713">			rs = stmt</span>
					.executeQuery(&quot;select organization_id,available_credit from st_lms_organization_master where organization_id=&quot;
							+ organizationId);
<span class="nc" id="L716">			double availableCredit = 0.0;</span>
<span class="nc bnc" id="L717" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L718">				availableCredit = rs.getDouble(&quot;available_credit&quot;);</span>
			}

<span class="nc" id="L721">			Set&lt;Integer&gt; keyset = dispatchMap.keySet();</span>
<span class="nc bnc" id="L722" title="All 2 branches missed.">			for (Integer gameNbr : keyset) {</span>
<span class="nc" id="L723">				int nbrOfbooks = dispatchMap.get(gameNbr).size();</span>
<span class="nc" id="L724">				stmt = con.createStatement();</span>
<span class="nc" id="L725">				stmt1 = con.createStatement();</span>

<span class="nc" id="L727">				rs1 = stmt1</span>
						.executeQuery(&quot;select sale_comm_variance from st_se_bo_agent_sale_pwt_comm_variance where agent_org_id=&quot;
								+ organizationId
								+ &quot; and game_id=(select game_id from st_se_game_master where game_nbr=&quot;
								+ gameNbr + &quot;)&quot;);
<span class="nc" id="L732">				double sale_comm_variance = 0.0;</span>
<span class="nc bnc" id="L733" title="All 2 branches missed.">				while (rs1.next()) {</span>
<span class="nc" id="L734">					sale_comm_variance = rs1.getDouble(&quot;sale_comm_variance&quot;);</span>
				}
<span class="nc" id="L736">				rs = stmt</span>
						.executeQuery(&quot;select ticket_price, nbr_of_tickets_per_book, agent_sale_comm_rate from st_se_game_master  where game_id=(select game_id from st_se_game_master where game_nbr=&quot;
								+ gameNbr + &quot;)&quot;);
				// logger.info(&quot;11111111112222222222 &quot; + &quot;select
				// aa.sale_comm_variance,bb.pwt_scrap,cc.ticket_price,cc.nbr_of_tickets_per_book,cc.retailer_sale_comm_rate
				// from st_se_agent_retailer_sale_pwt_comm_variance
				// aa,st_lms_organization_master bb ,st_se_game_master cc where
				// aa.game_id=(select game_id from st_se_game_master where
				// game_nbr=&quot;+gameNbr+&quot;) and aa.ret_org_id=(select
				// organization_id from st_lms_organization_master where
				// name='&quot;+organizationName+&quot;') and bb.organization_id=(select
				// organization_id from st_lms_organization_master where
				// name='&quot;+organizationName+&quot;') and cc.game_id=(select game_id
				// from st_se_game_master where game_nbr=&quot;+gameNbr+&quot;)&quot;);
<span class="nc bnc" id="L750" title="All 2 branches missed.">				if (rs.next()) {</span>
<span class="nc" id="L751">					double netCommRate = rs.getDouble(&quot;agent_sale_comm_rate&quot;)</span>
							+ sale_comm_variance;
<span class="nc" id="L753">					double bookPrice = rs.getDouble(&quot;ticket_price&quot;)</span>
							* rs.getInt(&quot;nbr_of_tickets_per_book&quot;);
<span class="nc" id="L755">					double netSaleAmountAllBooks = (bookPrice - bookPrice</span>
							* 0.01 * netCommRate)
							* nbrOfbooks;
<span class="nc" id="L758">					totalGamebooksAmount = totalGamebooksAmount</span>
							+ netSaleAmountAllBooks;
				}

<span class="nc" id="L762">			}</span>

<span class="nc bnc" id="L764" title="All 2 branches missed.">			if (totalGamebooksAmount &lt;= availableCredit) {</span>
<span class="nc" id="L765">				return true;</span>
			} else {
<span class="nc" id="L767">				return false;</span>
			}

<span class="nc" id="L770">		} catch (SQLException e) {</span>
<span class="nc" id="L771">			e.printStackTrace();</span>
<span class="nc" id="L772">			throw new LMSException(e);</span>
		} finally {
<span class="nc" id="L774">			try {</span>
<span class="nc bnc" id="L775" title="All 6 branches missed.">				if (con != null) {</span>
<span class="nc" id="L776">					con.close();</span>
				}
<span class="nc" id="L778">			} catch (SQLException se) {</span>
<span class="nc" id="L779">				se.printStackTrace();</span>
<span class="nc" id="L780">				throw new LMSException(se);</span>
<span class="nc" id="L781">			}</span>
		}
	}

	public boolean verifyBook(int boOrgId, String bookToVerify, int gameId,
			int gameNbr, Connection connection) throws LMSException {

		// logger.info(&quot;Agent Org Id::&quot; + agtOrgId);
<span class="nc" id="L789">		boolean isValid = false;</span>
<span class="nc" id="L790">		boolean ownercheck = false;</span>
<span class="nc" id="L791">		boolean pwtCheck = false;</span>
<span class="nc" id="L792">		boolean pwtCheckTemp = false;</span>

		try {
<span class="nc" id="L795">			PreparedStatement pstmt = null;</span>
<span class="nc" id="L796">			ResultSet resultSet = null;</span>
<span class="nc" id="L797">			String query = null;</span>
			// get the game id from game number
<span class="nc" id="L799">			query = QueryManager.getST1AgentVerifyQuery()</span>
					+ &quot;  and (book_status!='MISSING' and book_status!='CLAIMED')&quot;;
<span class="nc" id="L801">			pstmt = connection.prepareStatement(query);</span>

<span class="nc" id="L803">			pstmt.setInt(1, gameId);</span>
<span class="nc" id="L804">			pstmt.setString(2, bookToVerify);</span>

<span class="nc" id="L806">			resultSet = pstmt.executeQuery();</span>

<span class="nc" id="L808">			String currOwner = null;</span>
<span class="nc" id="L809">			int currOwnerId = -1;</span>
<span class="nc bnc" id="L810" title="All 2 branches missed.">			while (resultSet.next()) {</span>
<span class="nc" id="L811">				currOwner = resultSet.getString(TableConstants.SGIS_CURR_OWNER);</span>
<span class="nc" id="L812">				currOwnerId = resultSet</span>
						.getInt(TableConstants.SGIS_CURR_OWNER_ID);
<span class="nc bnc" id="L814" title="All 6 branches missed.">				if (currOwner != null &amp;&amp; currOwner.equals(&quot;BO&quot;)</span>
						&amp;&amp; currOwnerId == boOrgId) {
<span class="nc" id="L816">					ownercheck = true;</span>
				}
			}

			// ckeck for ticket of this book in main ticket table
<span class="nc" id="L821">			pwtCheck = verifyBookValidityWithPWT(gameId, bookToVerify,</span>
					connection, gameNbr);
<span class="nc" id="L823">			pwtCheckTemp = verifyBookValidityWithPWTTempTable(gameId,</span>
					bookToVerify, connection);
<span class="nc bnc" id="L825" title="All 6 branches missed.">			if (ownercheck == true &amp;&amp; pwtCheck == true &amp;&amp; pwtCheckTemp == true) {</span>
<span class="nc" id="L826">				isValid = true;</span>
<span class="nc" id="L827">				logger.info(isValid + &quot;********&quot; + bookToVerify);</span>
			}

<span class="nc" id="L830">		} catch (SQLException e) {</span>

<span class="nc" id="L832">			e.printStackTrace();</span>
<span class="nc" id="L833">			throw new LMSException(e);</span>
<span class="nc" id="L834">		}</span>

<span class="nc" id="L836">		return isValid;</span>
	}

	// direct dispatch new

	private boolean verifyBooks(int gameId, String books,
			List&lt;BookBean&gt; bookList, int agtOrgId, Connection connection)
			throws LMSException {

		// Connection connection = null;
<span class="nc" id="L846">		Statement statement = null;</span>
<span class="nc" id="L847">		ResultSet resultSet = null;</span>
<span class="nc" id="L848">		boolean isBookValid = true;</span>
		try {
<span class="nc" id="L850">			statement = connection.createStatement();</span>
<span class="nc" id="L851">			String query = QueryManager.getST1AgentBookInvVerifyQuery();</span>
<span class="nc" id="L852">			query = query + gameId + &quot; and book_nbr in ( &quot; + books + &quot; )&quot;;</span>

<span class="nc" id="L854">			resultSet = statement.executeQuery(query);</span>

<span class="nc" id="L856">			String currOwner = null;</span>
<span class="nc" id="L857">			String bookNbr = null;</span>
<span class="nc" id="L858">			BookBean bean = null;</span>
<span class="nc" id="L859">			int currOwnerId = -1;</span>
<span class="nc bnc" id="L860" title="All 2 branches missed.">			while (resultSet.next()) {</span>
<span class="nc" id="L861">				currOwner = resultSet.getString(TableConstants.SGIS_CURR_OWNER);</span>
<span class="nc" id="L862">				currOwnerId = resultSet</span>
						.getInt(TableConstants.SGIS_CURR_OWNER_ID);
<span class="nc" id="L864">				bookNbr = resultSet.getString(TableConstants.SGIS_BOOK_NBR);</span>

<span class="nc bnc" id="L866" title="All 2 branches missed.">				for (int i = 0; i &lt; bookList.size(); i++) {</span>
<span class="nc" id="L867">					bean = bookList.get(i);</span>
<span class="nc bnc" id="L868" title="All 2 branches missed.">					if (bookNbr.equals(bean.getBookNumber())) {</span>

<span class="nc bnc" id="L870" title="All 6 branches missed.">						if (currOwner != null &amp;&amp; currOwner.equals(&quot;AGENT&quot;)</span>
								&amp;&amp; currOwnerId == agtOrgId) {
<span class="nc" id="L872">							bean.setValid(true);</span>
<span class="nc" id="L873">							bean.setStatus(null);</span>
						} else {
<span class="nc" id="L875">							isBookValid = false;</span>
<span class="nc" id="L876">							bean.setValid(false);</span>
<span class="nc" id="L877">							bean.setStatus(&quot;Wrong Book Number&quot;);</span>
						}
					}
					// isBookValid = isBookValid &amp;&amp; bean.getIsValid();
				}

			}

<span class="nc bnc" id="L885" title="All 2 branches missed.">			for (int i = 0; i &lt; bookList.size(); i++) {</span>
<span class="nc" id="L886">				bean = bookList.get(i);</span>
<span class="nc bnc" id="L887" title="All 4 branches missed.">				isBookValid = isBookValid &amp;&amp; bean.getIsValid();</span>
			}

<span class="nc bnc" id="L890" title="All 4 branches missed.">			if (resultSet != null &amp;&amp; !resultSet.previous()) {</span>
<span class="nc" id="L891">				isBookValid = false;</span>
			}

<span class="nc" id="L894">		} catch (SQLException e) {</span>

<span class="nc" id="L896">			e.printStackTrace();</span>
<span class="nc" id="L897">			throw new LMSException(e);</span>
		} finally {

<span class="nc" id="L900">			try {</span>

<span class="nc bnc" id="L902" title="All 4 branches missed.">				if (statement != null) {</span>
<span class="nc" id="L903">					statement.close();</span>
				}
				/*
				 * if (connection != null) { connection.close(); }
				 */
<span class="nc" id="L908">			} catch (SQLException se) {</span>
<span class="nc" id="L909">				se.printStackTrace();</span>
<span class="nc" id="L910">			}</span>
<span class="nc" id="L911">		}</span>

<span class="nc" id="L913">		logger.info(&quot;isBookValid::&quot; + isBookValid);</span>
<span class="nc" id="L914">		return isBookValid;</span>
	}

	// Check Book Verification For PWT Tickets in main ticket table.
	public boolean verifyBookValidityWithPWT(int game_id, String bknbr,
			Connection conn, int gameNbr) {
<span class="nc" id="L920">		boolean bookPwtFlag = true;</span>
<span class="nc" id="L921">		String query6 = QueryManager.getST4BookOfTicketsOfPwt();</span>
		PreparedStatement stmt6;
		try {
<span class="nc" id="L924">			stmt6 = conn.prepareStatement(query6);</span>
<span class="nc" id="L925">			stmt6.setInt(1, gameNbr);</span>
<span class="nc" id="L926">			stmt6.setInt(2, game_id);</span>
<span class="nc" id="L927">			stmt6.setString(3, bknbr);</span>
<span class="nc" id="L928">			ResultSet rs = stmt6.executeQuery();</span>
<span class="nc bnc" id="L929" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L930">				bookPwtFlag = false;</span>
			}
<span class="nc" id="L932">			return bookPwtFlag;</span>
<span class="nc" id="L933">		} catch (SQLException e) {</span>
			// TODO Auto-generated catch block
<span class="nc" id="L935">			e.printStackTrace();</span>
		}
<span class="nc" id="L937">		return bookPwtFlag;</span>
	}

	// Check Book Verification For PWT Tickets in temp ticket table.
	public boolean verifyBookValidityWithPWTTempTable(int game_id,
			String bknbr, Connection conn) {

<span class="nc" id="L944">		boolean bookPwtFlag = true;</span>
<span class="nc" id="L945">		String query6 = QueryManager.getST4BookOfTicketsOfPwtTmpTable();</span>
		PreparedStatement stmt6;
		try {
<span class="nc" id="L948">			stmt6 = conn.prepareStatement(query6);</span>
<span class="nc" id="L949">			stmt6.setInt(1, game_id);</span>
<span class="nc" id="L950">			stmt6.setString(2, bknbr);</span>
<span class="nc" id="L951">			ResultSet rs = stmt6.executeQuery();</span>
<span class="nc bnc" id="L952" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L953">				bookPwtFlag = false;</span>
			}
<span class="nc" id="L955">			return bookPwtFlag;</span>
<span class="nc" id="L956">		} catch (SQLException e) {</span>
			// TODO Auto-generated catch block
<span class="nc" id="L958">			e.printStackTrace();</span>
		}
<span class="nc" id="L960">		return bookPwtFlag;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>