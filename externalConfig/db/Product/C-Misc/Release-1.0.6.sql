-- liquibase formatted sql

-- changeset Ishu:1 endDelimiter:#
DROP PROCEDURE IF EXISTS `creditDebitPaymentDateWiseOverAll`#
#
CREATE DEFINER=`root`@`localhost` PROCEDURE `creditDebitPaymentDateWiseOverAll`(startDate timestamp,endDate timestamp,agtOrgId int)
BEGIN
set @mainQry=concat("select ifnull(credit.date,debit.date) date,ifnull(debit,0.0) debit,ifnull(credit,0.0) credit,ifnull(training,0.0) training,ifnull(incentive,0.0) incentive,ifnull(others,0.0) others  from ((select agent_org_id,sum(amount) debit,date(transaction_date) date from st_lms_bo_debit_note debit,st_lms_bo_transaction_master btm where debit.transaction_id=btm.transaction_id and debit.transaction_type IN ('DR_NOTE_CASH','DR_NOTE') and transaction_date>='",startDate,"' and transaction_date<='", endDate, "' and agent_org_id= ",agtOrgId," group by date(transaction_date))  debit left join (select agent_org_id,sum(credit) credit,sum(training) training,sum(incentive) incentive,sum(others) others,date from (select agent_org_id, sum(amount) credit,0 training, 0 incentive, 0 others,date(transaction_date) date from st_lms_bo_credit_note credit,st_lms_bo_transaction_master btm where credit.transaction_id=btm.transaction_id and credit.transaction_type IN ('CR_NOTE_CASH','CR_NOTE') and transaction_date>='",startDate,"' and transaction_date<='", endDate, "'and agent_org_id= ",agtOrgId," group by date(transaction_date) union all select agent_org_id,0 credit, sum(amount) training, 0 incentive, 0 others,date(transaction_date) date from st_lms_bo_credit_note credit,st_lms_bo_transaction_master btm where credit.transaction_id=btm.transaction_id and credit.transaction_type IN ('CR_NOTE_CASH','CR_NOTE') and credit.reason IN ('CR_WEEKLY_EXP','CR_DAILY_EXP') and transaction_date>='",startDate,"' and transaction_date<='", endDate, "'and agent_org_id= ",agtOrgId," group by date(transaction_date) union all select agent_org_id,0 credit, 0 training, sum(amount) incentive,0 others,date(transaction_date) date from st_lms_bo_credit_note credit,st_lms_bo_transaction_master btm where credit.transaction_id=btm.transaction_id and credit.transaction_type IN ('CR_NOTE_CASH','CR_NOTE') and credit.reason IN ('CR_DAILY_INCENTIVE','CR_WEEKLY_INCENTIVE') and transaction_date>='",startDate,"' and transaction_date<='", endDate, "'and agent_org_id= ",agtOrgId," group by date(transaction_date) union all select agent_org_id,0 credit, 0 training, 0 incentive, sum(amount) others,date(transaction_date) date from st_lms_bo_credit_note credit,st_lms_bo_transaction_master btm where credit.transaction_id=btm.transaction_id and credit.transaction_type IN ('CR_NOTE_CASH','CR_NOTE') and credit.reason NOT IN ('CR_DAILY_INCENTIVE','CR_WEEKLY_INCENTIVE','CR_WEEKLY_EXP','CR_DAILY_EXP') and transaction_date>='",startDate,"' and transaction_date<='", endDate, "'and agent_org_id= ",agtOrgId," group by date(transaction_date) ) ab group by date) credit on debit.date=credit.date ) union select ifnull(credit.date,debit.date) date,ifnull(debit,0.0) debit,ifnull(credit,0.0) credit,ifnull(training,0.0) training,ifnull(incentive,0.0) incentive,ifnull(others,0.0) others from ((select agent_org_id,sum(amount) debit,date(transaction_date) date from st_lms_bo_debit_note debit,st_lms_bo_transaction_master btm where debit.transaction_id=btm.transaction_id and debit.transaction_type IN ('DR_NOTE_CASH','DR_NOTE') and transaction_date>='",startDate,"' and transaction_date<='", endDate, "' and agent_org_id= ",agtOrgId," group by date(transaction_date))  debit right join (select agent_org_id,sum(credit) credit,sum(training) training,sum(incentive) incentive,sum(others) others,date from (select agent_org_id, sum(amount) credit,0 training, 0 incentive, 0 others,date(transaction_date) date from st_lms_bo_credit_note credit,st_lms_bo_transaction_master btm where credit.transaction_id=btm.transaction_id and credit.transaction_type IN ('CR_NOTE_CASH','CR_NOTE') and transaction_date>='",startDate,"' and transaction_date<='", endDate, "'and agent_org_id= ",agtOrgId," group by date(transaction_date) union all select agent_org_id,0 credit, sum(amount) training, 0 incentive, 0 others,date(transaction_date) date from st_lms_bo_credit_note credit,st_lms_bo_transaction_master btm where credit.transaction_id=btm.transaction_id and credit.transaction_type IN ('CR_NOTE_CASH','CR_NOTE') and credit.reason IN ('CR_WEEKLY_EXP','CR_DAILY_EXP') and transaction_date>='",startDate,"' and transaction_date<='", endDate, "'and agent_org_id= ",agtOrgId," group by date(transaction_date) union all select agent_org_id,0 credit, 0 training, sum(amount) incentive,0 others,date(transaction_date) date from st_lms_bo_credit_note credit,st_lms_bo_transaction_master btm where credit.transaction_id=btm.transaction_id and credit.transaction_type IN ('CR_NOTE_CASH','CR_NOTE') and credit.reason IN ('CR_DAILY_INCENTIVE','CR_WEEKLY_INCENTIVE') and transaction_date>='",startDate,"' and transaction_date<='", endDate, "'and agent_org_id= ",agtOrgId," group by date(transaction_date) union all select agent_org_id,0 credit, 0 training, 0 incentive, sum(amount) others,date(transaction_date) date from st_lms_bo_credit_note credit,st_lms_bo_transaction_master btm where credit.transaction_id=btm.transaction_id and credit.transaction_type IN ('CR_NOTE_CASH','CR_NOTE') and credit.reason NOT IN ('CR_DAILY_INCENTIVE','CR_WEEKLY_INCENTIVE','CR_WEEKLY_EXP','CR_DAILY_EXP') and transaction_date>='",startDate,"' and transaction_date<='", endDate, "'and agent_org_id= ",agtOrgId," group by date(transaction_date) ) ab group by date) credit on debit.date=credit.date ) union all select finaldate,sum(debit_note) as debit,sum(credit_note) as credit, 0 training, 0 incentive, sum(credit_note) others from st_rep_bo_payments where finaldate>='",startDate,"' and finaldate<='", endDate, "' and agent_org_id=",agtOrgId," group by finaldate");
	PREPARE stmt FROM @mainQry;
	EXECUTE stmt;
	DEALLOCATE PREPARE stmt;    
END
#
